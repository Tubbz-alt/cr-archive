<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WTF/wtf/ThreadSafeRefCounted.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2007, 2008, 2010, 2013, 2014 Apple Inc. All rights reserved.
  3  * Copyright (C) 2007 Justin Haygood (jhaygood@reaktix.com)
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  * 1.  Redistributions of source code must retain the above copyright
  9  *     notice, this list of conditions and the following disclaimer.
 10  * 2.  Redistributions in binary form must reproduce the above copyright
 11  *     notice, this list of conditions and the following disclaimer in the
 12  *     documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 16  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 17  * DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 18  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 19  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 20  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 21  * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 23  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
 28 #include &lt;atomic&gt;
 29 #include &lt;wtf/FastMalloc.h&gt;
 30 #include &lt;wtf/MainThread.h&gt;
 31 #include &lt;wtf/Noncopyable.h&gt;
 32 
 33 namespace WTF {
 34 
<a name="1" id="anc1"></a><span class="line-added"> 35 #if defined(NDEBUG) &amp;&amp; !ENABLE(SECURITY_ASSERTIONS)</span>
<span class="line-added"> 36 #define CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE 0</span>
<span class="line-added"> 37 #else</span>
<span class="line-added"> 38 #define CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE 1</span>
<span class="line-added"> 39 #endif</span>
<span class="line-added"> 40 </span>
 41 class ThreadSafeRefCountedBase {
 42     WTF_MAKE_NONCOPYABLE(ThreadSafeRefCountedBase);
 43     WTF_MAKE_FAST_ALLOCATED;
 44 public:
 45     ThreadSafeRefCountedBase() = default;
 46 
<a name="2" id="anc2"></a><span class="line-added"> 47 #if CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE</span>
<span class="line-added"> 48     ~ThreadSafeRefCountedBase()</span>
<span class="line-added"> 49     {</span>
<span class="line-added"> 50         // When this ThreadSafeRefCounted object is a part of another object, derefBase() is never called on this object.</span>
<span class="line-added"> 51         m_deletionHasBegun = true;</span>
<span class="line-added"> 52     }</span>
<span class="line-added"> 53 #endif</span>
<span class="line-added"> 54 </span>
 55     void ref() const
 56     {
<a name="3" id="anc3"></a><span class="line-added"> 57 #if CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE</span>
<span class="line-added"> 58         ASSERT_WITH_SECURITY_IMPLICATION(!m_deletionHasBegun);</span>
<span class="line-added"> 59 #endif</span>
 60         ++m_refCount;
 61     }
 62 
 63     bool hasOneRef() const
 64     {
<a name="4" id="anc4"></a><span class="line-added"> 65 #if CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE</span>
<span class="line-added"> 66         ASSERT(!m_deletionHasBegun);</span>
<span class="line-added"> 67 #endif</span>
 68         return refCount() == 1;
 69     }
 70 
 71     unsigned refCount() const
 72     {
 73         return m_refCount;
 74     }
 75 
 76 protected:
 77     // Returns whether the pointer should be freed or not.
 78     bool derefBase() const
 79     {
<a name="5" id="anc5"></a><span class="line-modified"> 80         ASSERT(m_refCount);</span>
<span class="line-added"> 81 </span>
<span class="line-added"> 82 #if CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE</span>
<span class="line-added"> 83         ASSERT_WITH_SECURITY_IMPLICATION(!m_deletionHasBegun);</span>
<span class="line-added"> 84 #endif</span>
<span class="line-added"> 85 </span>
<span class="line-added"> 86         if (UNLIKELY(!--m_refCount)) {</span>
<span class="line-added"> 87             // Setting m_refCount to 1 here prevents double delete within the destructor but not from another thread</span>
<span class="line-added"> 88             // since such a thread could have ref&#39;ed this object long after it had been deleted. See webkit.org/b/201576.</span>
<span class="line-added"> 89             m_refCount = 1;</span>
<span class="line-added"> 90 #if CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE</span>
<span class="line-added"> 91             m_deletionHasBegun = true;</span>
<span class="line-added"> 92 #endif</span>
<span class="line-added"> 93             return true;</span>
<span class="line-added"> 94         }</span>
<span class="line-added"> 95 </span>
<span class="line-added"> 96         return false;</span>
 97     }
 98 
 99 private:
100     mutable std::atomic&lt;unsigned&gt; m_refCount { 1 };
<a name="6" id="anc6"></a><span class="line-added">101 </span>
<span class="line-added">102 #if CHECK_THREAD_SAFE_REF_COUNTED_LIFECYCLE</span>
<span class="line-added">103     mutable std::atomic&lt;bool&gt; m_deletionHasBegun { false };</span>
<span class="line-added">104 #endif</span>
105 };
106 
107 enum class DestructionThread { Any, Main, MainRunLoop };
108 
109 template&lt;class T, DestructionThread destructionThread = DestructionThread::Any&gt; class ThreadSafeRefCounted : public ThreadSafeRefCountedBase {
110 public:
111     void deref() const
112     {
113         if (!derefBase())
114             return;
115 
116         auto deleteThis = [this] {
117             delete static_cast&lt;const T*&gt;(this);
118         };
119         switch (destructionThread) {
120         case DestructionThread::Any:
121             break;
122         case DestructionThread::Main:
123             if (!isMainThread()) {
124                 callOnMainThread(WTFMove(deleteThis));
125                 return;
126             }
127             break;
128         case DestructionThread::MainRunLoop:
129             if (!isMainRunLoop()) {
130                 callOnMainRunLoop(WTFMove(deleteThis));
131                 return;
132             }
133             break;
134         }
135         deleteThis();
136     }
137 
138 protected:
139     ThreadSafeRefCounted() = default;
140 };
141 
142 } // namespace WTF
143 
144 using WTF::ThreadSafeRefCounted;
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>