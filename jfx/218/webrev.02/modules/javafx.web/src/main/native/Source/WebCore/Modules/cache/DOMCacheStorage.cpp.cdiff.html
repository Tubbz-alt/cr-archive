<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/cache/DOMCacheStorage.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DOMCacheEngine.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="DOMCacheStorage.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/cache/DOMCacheStorage.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 26,25 ***</span>
  #include &quot;config.h&quot;
  #include &quot;DOMCacheStorage.h&quot;
  
  #include &quot;CacheQueryOptions.h&quot;
  #include &quot;ClientOrigin.h&quot;
  #include &quot;JSDOMCache.h&quot;
  #include &quot;JSFetchResponse.h&quot;
  #include &quot;ScriptExecutionContext.h&quot;
  
<span class="line-removed">- </span>
  namespace WebCore {
  using namespace WebCore::DOMCacheEngine;
  
  DOMCacheStorage::DOMCacheStorage(ScriptExecutionContext&amp; context, Ref&lt;CacheStorageConnection&gt;&amp;&amp; connection)
      : ActiveDOMObject(&amp;context)
      , m_connection(WTFMove(connection))
  {
      suspendIfNeeded();
  }
  
  Optional&lt;ClientOrigin&gt; DOMCacheStorage::origin() const
  {
      auto* origin = scriptExecutionContext() ? scriptExecutionContext()-&gt;securityOrigin() : nullptr;
      if (!origin)
          return WTF::nullopt;
<span class="line-new-header">--- 26,27 ---</span>
  #include &quot;config.h&quot;
  #include &quot;DOMCacheStorage.h&quot;
  
  #include &quot;CacheQueryOptions.h&quot;
  #include &quot;ClientOrigin.h&quot;
<span class="line-added">+ #include &quot;EventLoop.h&quot;</span>
  #include &quot;JSDOMCache.h&quot;
  #include &quot;JSFetchResponse.h&quot;
  #include &quot;ScriptExecutionContext.h&quot;
  
  namespace WebCore {
  using namespace WebCore::DOMCacheEngine;
  
  DOMCacheStorage::DOMCacheStorage(ScriptExecutionContext&amp; context, Ref&lt;CacheStorageConnection&gt;&amp;&amp; connection)
      : ActiveDOMObject(&amp;context)
      , m_connection(WTFMove(connection))
  {
      suspendIfNeeded();
  }
  
<span class="line-added">+ DOMCacheStorage::~DOMCacheStorage() = default;</span>
<span class="line-added">+ </span>
  Optional&lt;ClientOrigin&gt; DOMCacheStorage::origin() const
  {
      auto* origin = scriptExecutionContext() ? scriptExecutionContext()-&gt;securityOrigin() : nullptr;
      if (!origin)
          return WTF::nullopt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 58,17 ***</span>
          completionHandler(nullptr);
          return;
      }
  
      auto&amp; cache = caches[index].get();
<span class="line-modified">!     cache.doMatch(WTFMove(info), WTFMove(options), [caches = WTFMove(caches), info, options, completionHandler = WTFMove(completionHandler), index](ExceptionOr&lt;FetchResponse*&gt;&amp;&amp; result) mutable {</span>
          if (result.hasException()) {
              completionHandler(result.releaseException());
              return;
          }
          if (result.returnValue()) {
<span class="line-modified">!             completionHandler(result.returnValue());</span>
              return;
          }
          doSequentialMatch(++index, WTFMove(caches), WTFMove(info), WTFMove(options), WTFMove(completionHandler));
      });
  }
<span class="line-new-header">--- 60,17 ---</span>
          completionHandler(nullptr);
          return;
      }
  
      auto&amp; cache = caches[index].get();
<span class="line-modified">!     cache.doMatch(WTFMove(info), WTFMove(options), [caches = WTFMove(caches), info, options, completionHandler = WTFMove(completionHandler), index](auto&amp;&amp; result) mutable {</span>
          if (result.hasException()) {
              completionHandler(result.releaseException());
              return;
          }
          if (result.returnValue()) {
<span class="line-modified">!             completionHandler(result.releaseReturnValue());</span>
              return;
          }
          doSequentialMatch(++index, WTFMove(caches), WTFMove(info), WTFMove(options), WTFMove(completionHandler));
      });
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 83,13 ***</span>
      return cache.copyRef();
  }
  
  void DOMCacheStorage::doSequentialMatch(DOMCache::RequestInfo&amp;&amp; info, CacheQueryOptions&amp;&amp; options, Ref&lt;DeferredPromise&gt;&amp;&amp; promise)
  {
<span class="line-modified">!     startSequentialMatch(WTF::map(m_caches, copyCache), WTFMove(info), WTFMove(options), [this, pendingActivity = makePendingActivity(*this), promise = WTFMove(promise)](ExceptionOr&lt;FetchResponse*&gt;&amp;&amp; result) mutable {</span>
<span class="line-removed">-         if (m_isStopped)</span>
<span class="line-removed">-             return;</span>
          if (result.hasException()) {
              promise-&gt;reject(result.releaseException());
              return;
          }
          if (!result.returnValue()) {
<span class="line-new-header">--- 85,11 ---</span>
      return cache.copyRef();
  }
  
  void DOMCacheStorage::doSequentialMatch(DOMCache::RequestInfo&amp;&amp; info, CacheQueryOptions&amp;&amp; options, Ref&lt;DeferredPromise&gt;&amp;&amp; promise)
  {
<span class="line-modified">!     startSequentialMatch(WTF::map(m_caches, copyCache), WTFMove(info), WTFMove(options), [pendingActivity = makePendingActivity(*this), promise = WTFMove(promise)](auto&amp;&amp; result) mutable {</span>
          if (result.hasException()) {
              promise-&gt;reject(result.releaseException());
              return;
          }
          if (!result.returnValue()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 102,11 ***</span>
  
  void DOMCacheStorage::match(DOMCache::RequestInfo&amp;&amp; info, CacheQueryOptions&amp;&amp; options, Ref&lt;DeferredPromise&gt;&amp;&amp; promise)
  {
      retrieveCaches([this, info = WTFMove(info), options = WTFMove(options), promise = WTFMove(promise)](Optional&lt;Exception&gt;&amp;&amp; exception) mutable {
          if (exception) {
<span class="line-modified">!             promise-&gt;reject(WTFMove(exception.value()));</span>
              return;
          }
  
          if (!options.cacheName.isNull()) {
              auto position = m_caches.findMatching([&amp;](auto&amp; item) { return item-&gt;name() == options.cacheName; });
<span class="line-new-header">--- 102,11 ---</span>
  
  void DOMCacheStorage::match(DOMCache::RequestInfo&amp;&amp; info, CacheQueryOptions&amp;&amp; options, Ref&lt;DeferredPromise&gt;&amp;&amp; promise)
  {
      retrieveCaches([this, info = WTFMove(info), options = WTFMove(options), promise = WTFMove(promise)](Optional&lt;Exception&gt;&amp;&amp; exception) mutable {
          if (exception) {
<span class="line-modified">!             promise-&gt;reject(WTFMove(*exception));</span>
              return;
          }
  
          if (!options.cacheName.isNull()) {
              auto position = m_caches.findMatching([&amp;](auto&amp; item) { return item-&gt;name() == options.cacheName; });
</pre>
<hr />
<pre>
<span class="line-old-header">*** 139,34 ***</span>
     if (position != notFound)
         return m_caches[position].copyRef();
     return DOMCache::create(*scriptExecutionContext(), WTFMove(info.name), info.identifier, m_connection.copyRef());
  }
  
<span class="line-modified">! void DOMCacheStorage::retrieveCaches(WTF::Function&lt;void(Optional&lt;Exception&gt;&amp;&amp;)&gt;&amp;&amp; callback)</span>
  {
      auto origin = this-&gt;origin();
<span class="line-modified">!     if (!origin)</span>
          return;
  
      m_connection-&gt;retrieveCaches(*origin, m_updateCounter, [this, callback = WTFMove(callback), pendingActivity = makePendingActivity(*this)](CacheInfosOrError&amp;&amp; result) mutable {
<span class="line-modified">!         if (!m_isStopped) {</span>
<span class="line-modified">!             if (!result.has_value()) {</span>
<span class="line-modified">!                 callback(DOMCacheEngine::convertToExceptionAndLog(scriptExecutionContext(), result.error()));</span>
<span class="line-modified">!                 return;</span>
<span class="line-modified">!             }</span>
  
<span class="line-modified">!             auto&amp; cachesInfo = result.value();</span>
  
<span class="line-modified">!             if (m_updateCounter != cachesInfo.updateCounter) {</span>
<span class="line-modified">!                 m_updateCounter = cachesInfo.updateCounter;</span>
  
<span class="line-modified">!                 m_caches = WTF::map(WTFMove(cachesInfo.infos), [this] (CacheInfo&amp;&amp; info) {</span>
<span class="line-modified">!                     return findCacheOrCreate(WTFMove(info));</span>
<span class="line-modified">!                 });</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             callback(WTF::nullopt);</span>
          }
      });
  }
  
  static void logConsolePersistencyError(ScriptExecutionContext* context, const String&amp; cacheName)
  {
<span class="line-new-header">--- 139,38 ---</span>
     if (position != notFound)
         return m_caches[position].copyRef();
     return DOMCache::create(*scriptExecutionContext(), WTFMove(info.name), info.identifier, m_connection.copyRef());
  }
  
<span class="line-modified">! void DOMCacheStorage::retrieveCaches(CompletionHandler&lt;void(Optional&lt;Exception&gt;&amp;&amp;)&gt;&amp;&amp; callback)</span>
  {
      auto origin = this-&gt;origin();
<span class="line-modified">!     if (!origin) {</span>
<span class="line-added">+         callback(convertToExceptionAndLog(scriptExecutionContext(), DOMCacheEngine::Error::Stopped));</span>
          return;
<span class="line-added">+     }</span>
  
      m_connection-&gt;retrieveCaches(*origin, m_updateCounter, [this, callback = WTFMove(callback), pendingActivity = makePendingActivity(*this)](CacheInfosOrError&amp;&amp; result) mutable {
<span class="line-modified">!         if (m_isStopped) {</span>
<span class="line-modified">!             callback(DOMCacheEngine::convertToException(DOMCacheEngine::Error::Stopped));</span>
<span class="line-modified">!             return;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         if (!result.has_value()) {</span>
<span class="line-added">+             callback(DOMCacheEngine::convertToExceptionAndLog(scriptExecutionContext(), result.error()));</span>
<span class="line-added">+             return;</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         auto&amp; cachesInfo = result.value();</span>
  
<span class="line-modified">!         if (m_updateCounter != cachesInfo.updateCounter) {</span>
<span class="line-modified">!             m_updateCounter = cachesInfo.updateCounter;</span>
  
<span class="line-modified">!             m_caches = WTF::map(WTFMove(cachesInfo.infos), [this] (CacheInfo&amp;&amp; info) {</span>
<span class="line-modified">!                 return findCacheOrCreate(WTFMove(info));</span>
<span class="line-modified">!             });</span>
          }
<span class="line-added">+         callback(WTF::nullopt);</span>
      });
  }
  
  static void logConsolePersistencyError(ScriptExecutionContext* context, const String&amp; cacheName)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 178,47 ***</span>
  
  void DOMCacheStorage::open(const String&amp; name, DOMPromiseDeferred&lt;IDLInterface&lt;DOMCache&gt;&gt;&amp;&amp; promise)
  {
      retrieveCaches([this, name, promise = WTFMove(promise)](Optional&lt;Exception&gt;&amp;&amp; exception) mutable {
          if (exception) {
<span class="line-modified">!             promise.reject(WTFMove(exception.value()));</span>
              return;
          }
          doOpen(name, WTFMove(promise));
      });
  }
  
  void DOMCacheStorage::doOpen(const String&amp; name, DOMPromiseDeferred&lt;IDLInterface&lt;DOMCache&gt;&gt;&amp;&amp; promise)
  {
      auto position = m_caches.findMatching([&amp;](auto&amp; item) { return item-&gt;name() == name; });
      if (position != notFound) {
<span class="line-modified">!         auto&amp; cache = m_caches[position];</span>
<span class="line-removed">-         promise.resolve(DOMCache::create(*scriptExecutionContext(), String { cache-&gt;name() }, cache-&gt;identifier(), m_connection.copyRef()));</span>
          return;
      }
  
      m_connection-&gt;open(*origin(), name, [this, name, promise = WTFMove(promise), pendingActivity = makePendingActivity(*this)](const CacheIdentifierOrError&amp; result) mutable {
<span class="line-modified">!         if (!m_isStopped) {</span>
<span class="line-modified">!             if (!result.has_value())</span>
<span class="line-modified">!                 promise.reject(DOMCacheEngine::convertToExceptionAndLog(scriptExecutionContext(), result.error()));</span>
<span class="line-modified">!             else {</span>
<span class="line-modified">!                 if (result.value().hadStorageError)</span>
<span class="line-modified">!                     logConsolePersistencyError(scriptExecutionContext(), name);</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 auto cache = DOMCache::create(*scriptExecutionContext(), String { name }, result.value().identifier, m_connection.copyRef());</span>
<span class="line-modified">!                 promise.resolve(cache);</span>
<span class="line-removed">-                 m_caches.append(WTFMove(cache));</span>
<span class="line-removed">-             }</span>
          }
      });
  }
  
  void DOMCacheStorage::remove(const String&amp; name, DOMPromiseDeferred&lt;IDLBoolean&gt;&amp;&amp; promise)
  {
      retrieveCaches([this, name, promise = WTFMove(promise)](Optional&lt;Exception&gt;&amp;&amp; exception) mutable {
          if (exception) {
<span class="line-modified">!             promise.reject(WTFMove(exception.value()));</span>
              return;
          }
          doRemove(name, WTFMove(promise));
      });
  }
<span class="line-new-header">--- 182,44 ---</span>
  
  void DOMCacheStorage::open(const String&amp; name, DOMPromiseDeferred&lt;IDLInterface&lt;DOMCache&gt;&gt;&amp;&amp; promise)
  {
      retrieveCaches([this, name, promise = WTFMove(promise)](Optional&lt;Exception&gt;&amp;&amp; exception) mutable {
          if (exception) {
<span class="line-modified">!             promise.reject(WTFMove(*exception));</span>
              return;
          }
          doOpen(name, WTFMove(promise));
      });
  }
  
  void DOMCacheStorage::doOpen(const String&amp; name, DOMPromiseDeferred&lt;IDLInterface&lt;DOMCache&gt;&gt;&amp;&amp; promise)
  {
      auto position = m_caches.findMatching([&amp;](auto&amp; item) { return item-&gt;name() == name; });
      if (position != notFound) {
<span class="line-modified">!         promise.resolve(DOMCache::create(*scriptExecutionContext(), String { m_caches[position]-&gt;name() }, m_caches[position]-&gt;identifier(), m_connection.copyRef()));</span>
          return;
      }
  
      m_connection-&gt;open(*origin(), name, [this, name, promise = WTFMove(promise), pendingActivity = makePendingActivity(*this)](const CacheIdentifierOrError&amp; result) mutable {
<span class="line-modified">!         if (!result.has_value())</span>
<span class="line-modified">!             promise.reject(DOMCacheEngine::convertToExceptionAndLog(scriptExecutionContext(), result.error()));</span>
<span class="line-modified">!         else {</span>
<span class="line-modified">!             if (result.value().hadStorageError)</span>
<span class="line-modified">!                 logConsolePersistencyError(scriptExecutionContext(), name);</span>
<span class="line-modified">! </span>
<span class="line-modified">!             auto cache = DOMCache::create(*scriptExecutionContext(), String { name }, result.value().identifier, m_connection.copyRef());</span>
<span class="line-modified">!             promise.resolve(cache);</span>
<span class="line-modified">!             m_caches.append(WTFMove(cache));</span>
          }
      });
  }
  
  void DOMCacheStorage::remove(const String&amp; name, DOMPromiseDeferred&lt;IDLBoolean&gt;&amp;&amp; promise)
  {
      retrieveCaches([this, name, promise = WTFMove(promise)](Optional&lt;Exception&gt;&amp;&amp; exception) mutable {
          if (exception) {
<span class="line-modified">!             promise.reject(WTFMove(*exception));</span>
              return;
          }
          doRemove(name, WTFMove(promise));
      });
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 230,18 ***</span>
          promise.resolve(false);
          return;
      }
  
      m_connection-&gt;remove(m_caches[position]-&gt;identifier(), [this, name, promise = WTFMove(promise), pendingActivity = makePendingActivity(*this)](const CacheIdentifierOrError&amp; result) mutable {
<span class="line-modified">!         if (!m_isStopped) {</span>
<span class="line-modified">!             if (!result.has_value())</span>
<span class="line-modified">!                 promise.reject(DOMCacheEngine::convertToExceptionAndLog(scriptExecutionContext(), result.error()));</span>
<span class="line-modified">!             else {</span>
<span class="line-modified">!                 if (result.value().hadStorageError)</span>
<span class="line-modified">!                     logConsolePersistencyError(scriptExecutionContext(), name);</span>
<span class="line-removed">-                 promise.resolve(!!result.value().identifier);</span>
<span class="line-removed">-             }</span>
          }
      });
  }
  
  void DOMCacheStorage::keys(KeysPromise&amp;&amp; promise)
<span class="line-new-header">--- 231,16 ---</span>
          promise.resolve(false);
          return;
      }
  
      m_connection-&gt;remove(m_caches[position]-&gt;identifier(), [this, name, promise = WTFMove(promise), pendingActivity = makePendingActivity(*this)](const CacheIdentifierOrError&amp; result) mutable {
<span class="line-modified">!         if (!result.has_value())</span>
<span class="line-modified">!             promise.reject(DOMCacheEngine::convertToExceptionAndLog(scriptExecutionContext(), result.error()));</span>
<span class="line-modified">!         else {</span>
<span class="line-modified">!             if (result.value().hadStorageError)</span>
<span class="line-modified">!                 logConsolePersistencyError(scriptExecutionContext(), name);</span>
<span class="line-modified">!             promise.resolve(!!result.value().identifier);</span>
          }
      });
  }
  
  void DOMCacheStorage::keys(KeysPromise&amp;&amp; promise)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 266,11 ***</span>
  const char* DOMCacheStorage::activeDOMObjectName() const
  {
      return &quot;CacheStorage&quot;;
  }
  
<span class="line-removed">- bool DOMCacheStorage::canSuspendForDocumentSuspension() const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     return !hasPendingActivity();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  } // namespace WebCore
<span class="line-new-header">--- 265,6 ---</span>
</pre>
<center><a href="DOMCacheEngine.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="DOMCacheStorage.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>