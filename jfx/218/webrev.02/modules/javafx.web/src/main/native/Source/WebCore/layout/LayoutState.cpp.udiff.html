<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/layout/LayoutState.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="LayoutPhase.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="LayoutState.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/layout/LayoutState.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,196 +26,189 @@</span>
  #include &quot;config.h&quot;
  #include &quot;LayoutState.h&quot;
  
  #if ENABLE(LAYOUT_FORMATTING_CONTEXT)
  
<span class="udiff-line-removed">- #include &quot;BlockFormattingContext.h&quot;</span>
  #include &quot;BlockFormattingState.h&quot;
<span class="udiff-line-removed">- #include &quot;BlockInvalidation.h&quot;</span>
  #include &quot;DisplayBox.h&quot;
<span class="udiff-line-modified-removed">- #include &quot;InlineFormattingContext.h&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;FloatingState.h&quot;</span>
  #include &quot;InlineFormattingState.h&quot;
<span class="udiff-line-removed">- #include &quot;InlineInvalidation.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;Invalidation.h&quot;</span>
  #include &quot;LayoutBox.h&quot;
  #include &quot;LayoutContainer.h&quot;
<span class="udiff-line-modified-removed">- #include &quot;LayoutPhase.h&quot;</span>
<span class="udiff-line-modified-removed">- #include &quot;LayoutTreeBuilder.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;RenderView.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;TableFormattingContext.h&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;RenderBox.h&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;RuntimeEnabledFeatures.h&quot;</span>
  #include &quot;TableFormattingState.h&quot;
  #include &lt;wtf/IsoMallocInlines.h&gt;
  
  namespace WebCore {
  namespace Layout {
  
  WTF_MAKE_ISO_ALLOCATED_IMPL(LayoutState);
  
<span class="udiff-line-modified-removed">- LayoutState::LayoutState(const Container&amp; initialContainingBlock)</span>
<span class="udiff-line-modified-removed">-     : m_initialContainingBlock(makeWeakPtr(initialContainingBlock))</span>
<span class="udiff-line-modified-added">+ LayoutState::LayoutState(const Document&amp; document, const Container&amp; rootContainer)</span>
<span class="udiff-line-modified-added">+     : m_rootContainer(makeWeakPtr(rootContainer))</span>
  {
<span class="udiff-line-modified-removed">-     // LayoutState is always initiated with the ICB.</span>
<span class="udiff-line-modified-removed">-     ASSERT(!initialContainingBlock.parent());</span>
<span class="udiff-line-removed">-     ASSERT(initialContainingBlock.establishesBlockFormattingContext());</span>
<span class="udiff-line-modified-added">+     // It makes absolutely no sense to construct a dedicated layout state for a non-formatting context root (layout would be a no-op).</span>
<span class="udiff-line-modified-added">+     ASSERT(root().establishesFormattingContext());</span>
  
<span class="udiff-line-modified-removed">-     auto&amp; displayBox = displayBoxForLayoutBox(initialContainingBlock);</span>
<span class="udiff-line-modified-removed">-     displayBox.setHorizontalMargin({ });</span>
<span class="udiff-line-modified-removed">-     displayBox.setHorizontalComputedMargin({ });</span>
<span class="udiff-line-modified-removed">-     displayBox.setVerticalMargin({ });</span>
<span class="udiff-line-modified-removed">-     displayBox.setBorder({ });</span>
<span class="udiff-line-modified-removed">-     displayBox.setPadding({ });</span>
<span class="udiff-line-modified-removed">-     displayBox.setTopLeft({ });</span>
<span class="udiff-line-modified-removed">-     displayBox.setContentBoxHeight(LayoutUnit(initialContainingBlock.style().logicalHeight().value()));</span>
<span class="udiff-line-modified-removed">-     displayBox.setContentBoxWidth(LayoutUnit(initialContainingBlock.style().logicalWidth().value()));</span>
<span class="udiff-line-modified-added">+     auto quirksMode = [&amp;] {</span>
<span class="udiff-line-modified-added">+         if (document.inLimitedQuirksMode())</span>
<span class="udiff-line-modified-added">+             return LayoutState::QuirksMode::Limited;</span>
<span class="udiff-line-modified-added">+         if (document.inQuirksMode())</span>
<span class="udiff-line-modified-added">+             return LayoutState::QuirksMode::Yes;</span>
<span class="udiff-line-modified-added">+         return LayoutState::QuirksMode::No;</span>
<span class="udiff-line-modified-added">+     };</span>
<span class="udiff-line-modified-added">+     setQuirksMode(quirksMode());</span>
<span class="udiff-line-modified-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ LayoutState::~LayoutState() = default;</span>
  
<span class="udiff-line-modified-removed">-     m_formattingContextRootListForLayout.add(&amp;initialContainingBlock);</span>
<span class="udiff-line-modified-added">+ Display::Box&amp; LayoutState::displayBoxForRootLayoutBox()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return ensureDisplayBoxForLayoutBox(root());</span>
  }
  
<span class="udiff-line-modified-removed">- void LayoutState::updateLayout()</span>
<span class="udiff-line-modified-added">+ Display::Box&amp; LayoutState::ensureDisplayBoxForLayoutBoxSlow(const Box&amp; layoutBox)</span>
  {
<span class="udiff-line-modified-removed">-     PhaseScope scope(Phase::Type::Layout);</span>
<span class="udiff-line-modified-added">+     if (layoutBox.canCacheForLayoutState(*this)) {</span>
<span class="udiff-line-added">+         ASSERT(!layoutBox.cachedDisplayBoxForLayoutState(*this));</span>
<span class="udiff-line-added">+         auto newBox = makeUnique&lt;Display::Box&gt;();</span>
<span class="udiff-line-added">+         auto&amp; newBoxPtr = *newBox;</span>
<span class="udiff-line-added">+         layoutBox.setCachedDisplayBoxForLayoutState(*this, WTFMove(newBox));</span>
<span class="udiff-line-added">+         return newBoxPtr;</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-     ASSERT(!m_formattingContextRootListForLayout.isEmpty());</span>
<span class="udiff-line-modified-removed">-     for (auto* layoutRoot : m_formattingContextRootListForLayout)</span>
<span class="udiff-line-modified-removed">-         layoutFormattingContextSubtree(*layoutRoot);</span>
<span class="udiff-line-removed">-     m_formattingContextRootListForLayout.clear();</span>
<span class="udiff-line-modified-added">+     return *m_layoutToDisplayBox.ensure(&amp;layoutBox, [] {</span>
<span class="udiff-line-modified-added">+         return makeUnique&lt;Display::Box&gt;();</span>
<span class="udiff-line-modified-added">+     }).iterator-&gt;value;</span>
  }
  
<span class="udiff-line-modified-removed">- void LayoutState::layoutFormattingContextSubtree(const Box&amp; layoutRoot)</span>
<span class="udiff-line-modified-added">+ FormattingState&amp; LayoutState::formattingStateForBox(const Box&amp; layoutBox) const</span>
  {
<span class="udiff-line-modified-removed">-     RELEASE_ASSERT(layoutRoot.establishesFormattingContext());</span>
<span class="udiff-line-removed">-     auto formattingContext = createFormattingContext(layoutRoot);</span>
<span class="udiff-line-removed">-     formattingContext-&gt;layout();</span>
<span class="udiff-line-removed">-     formattingContext-&gt;layoutOutOfFlowContent();</span>
<span class="udiff-line-modified-added">+     return establishedFormattingState(layoutBox.formattingContextRoot());</span>
  }
  
<span class="udiff-line-modified-removed">- Display::Box&amp; LayoutState::displayBoxForLayoutBox(const Box&amp; layoutBox) const</span>
<span class="udiff-line-modified-added">+ FormattingState&amp; LayoutState::establishedFormattingState(const Container&amp; formattingContextRoot) const</span>
  {
<span class="udiff-line-modified-removed">-     return *m_layoutToDisplayBox.ensure(&amp;layoutBox, [&amp;layoutBox] {</span>
<span class="udiff-line-modified-removed">-         return makeUnique&lt;Display::Box&gt;(layoutBox.style());</span>
<span class="udiff-line-modified-removed">-     }).iterator-&gt;value;</span>
<span class="udiff-line-modified-added">+     if (RuntimeEnabledFeatures::sharedFeatures().layoutFormattingContextIntegrationEnabled()) {</span>
<span class="udiff-line-modified-added">+         ASSERT(&amp;formattingContextRoot == m_rootContainer.get());</span>
<span class="udiff-line-modified-added">+         return *m_rootInlineFormattingStateForIntegration;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (auto* formattingState = m_inlineFormattingStates.get(&amp;formattingContextRoot))</span>
<span class="udiff-line-added">+         return *formattingState;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (auto* formattingState = m_blockFormattingStates.get(&amp;formattingContextRoot))</span>
<span class="udiff-line-added">+         return *formattingState;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ASSERT(m_tableFormattingStates.contains(&amp;formattingContextRoot));</span>
<span class="udiff-line-added">+     return *m_tableFormattingStates.get(&amp;formattingContextRoot);</span>
  }
  
<span class="udiff-line-modified-removed">- void LayoutState::styleChanged(const Box&amp; layoutBox, StyleDiff styleDiff)</span>
<span class="udiff-line-modified-added">+ InlineFormattingState&amp; LayoutState::establishedInlineFormattingState(const Container&amp; formattingContextRoot) const</span>
  {
<span class="udiff-line-modified-removed">-     PhaseScope scope(Phase::Type::Invalidation);</span>
<span class="udiff-line-modified-added">+     ASSERT(formattingContextRoot.establishesInlineFormattingContext());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (RuntimeEnabledFeatures::sharedFeatures().layoutFormattingContextIntegrationEnabled()) {</span>
<span class="udiff-line-added">+         ASSERT(&amp;formattingContextRoot == m_rootContainer.get());</span>
<span class="udiff-line-added">+         return *m_rootInlineFormattingStateForIntegration;</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-     auto&amp; formattingState = formattingStateForBox(layoutBox);</span>
<span class="udiff-line-removed">-     const Container* invalidationRoot = nullptr;</span>
<span class="udiff-line-removed">-     if (is&lt;BlockFormattingState&gt;(formattingState))</span>
<span class="udiff-line-removed">-         invalidationRoot = BlockInvalidation::invalidate(layoutBox, styleDiff, *this, downcast&lt;BlockFormattingState&gt;(formattingState)).root;</span>
<span class="udiff-line-removed">-     else if (is&lt;InlineFormattingState&gt;(formattingState))</span>
<span class="udiff-line-removed">-         invalidationRoot = InlineInvalidation::invalidate(layoutBox, styleDiff, *this, downcast&lt;InlineFormattingState&gt;(formattingState)).root;</span>
<span class="udiff-line-removed">-     else</span>
<span class="udiff-line-removed">-         ASSERT_NOT_IMPLEMENTED_YET();</span>
<span class="udiff-line-removed">-     ASSERT(invalidationRoot);</span>
<span class="udiff-line-removed">-     m_formattingContextRootListForLayout.addVoid(invalidationRoot);</span>
<span class="udiff-line-modified-added">+     return *m_inlineFormattingStates.get(&amp;formattingContextRoot);</span>
  }
  
<span class="udiff-line-modified-removed">- void LayoutState::markNeedsUpdate(const Box&amp;, OptionSet&lt;UpdateType&gt;)</span>
<span class="udiff-line-modified-added">+ BlockFormattingState&amp; LayoutState::establishedBlockFormattingState(const Container&amp; formattingContextRoot) const</span>
  {
<span class="udiff-line-added">+     ASSERT(formattingContextRoot.establishesBlockFormattingContext());</span>
<span class="udiff-line-added">+     return *m_blockFormattingStates.get(&amp;formattingContextRoot);</span>
  }
  
<span class="udiff-line-modified-removed">- FormattingState&amp; LayoutState::formattingStateForBox(const Box&amp; layoutBox) const</span>
<span class="udiff-line-modified-added">+ TableFormattingState&amp; LayoutState::establishedTableFormattingState(const Container&amp; formattingContextRoot) const</span>
  {
<span class="udiff-line-modified-removed">-     auto&amp; root = layoutBox.formattingContextRoot();</span>
<span class="udiff-line-modified-removed">-     RELEASE_ASSERT(m_formattingStates.contains(&amp;root));</span>
<span class="udiff-line-removed">-     return *m_formattingStates.get(&amp;root);</span>
<span class="udiff-line-modified-added">+     ASSERT(formattingContextRoot.establishesTableFormattingContext());</span>
<span class="udiff-line-modified-added">+     return *m_tableFormattingStates.get(&amp;formattingContextRoot);</span>
  }
  
<span class="udiff-line-modified-removed">- FormattingState&amp; LayoutState::establishedFormattingState(const Box&amp; formattingRoot) const</span>
<span class="udiff-line-modified-added">+ FormattingState&amp; LayoutState::ensureFormattingState(const Container&amp; formattingContextRoot)</span>
  {
<span class="udiff-line-modified-removed">-     ASSERT(formattingRoot.establishesFormattingContext());</span>
<span class="udiff-line-modified-removed">-     RELEASE_ASSERT(m_formattingStates.contains(&amp;formattingRoot));</span>
<span class="udiff-line-modified-removed">-     return *m_formattingStates.get(&amp;formattingRoot);</span>
<span class="udiff-line-modified-added">+     if (formattingContextRoot.establishesInlineFormattingContext())</span>
<span class="udiff-line-modified-added">+         return ensureInlineFormattingState(formattingContextRoot);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     if (formattingContextRoot.establishesBlockFormattingContext())</span>
<span class="udiff-line-added">+         return ensureBlockFormattingState(formattingContextRoot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return ensureTableFormattingState(formattingContextRoot);</span>
  }
  
<span class="udiff-line-modified-removed">- FormattingState&amp; LayoutState::createFormattingStateForFormattingRootIfNeeded(const Box&amp; formattingRoot)</span>
<span class="udiff-line-modified-added">+ InlineFormattingState&amp; LayoutState::ensureInlineFormattingState(const Container&amp; formattingContextRoot)</span>
  {
<span class="udiff-line-modified-removed">-     ASSERT(formattingRoot.establishesFormattingContext());</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     if (formattingRoot.establishesInlineFormattingContext()) {</span>
<span class="udiff-line-modified-removed">-         return *m_formattingStates.ensure(&amp;formattingRoot, [&amp;] {</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-             // If the block container box that initiates this inline formatting context also establishes a block context, the floats outside of the formatting root</span>
<span class="udiff-line-modified-removed">-             // should not interfere with the content inside.</span>
<span class="udiff-line-modified-removed">-             // &lt;div style=&quot;float: left&quot;&gt;&lt;/div&gt;&lt;div style=&quot;overflow: hidden&quot;&gt; &lt;- is a non-intrusive float, because overflow: hidden triggers new block formatting context.&lt;/div&gt;</span>
<span class="udiff-line-modified-removed">-             if (formattingRoot.establishesBlockFormattingContext())</span>
<span class="udiff-line-modified-removed">-                 return makeUnique&lt;InlineFormattingState&gt;(FloatingState::create(*this, formattingRoot), *this);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-             // Otherwise, the formatting context inherits the floats from the parent formatting context.</span>
<span class="udiff-line-modified-removed">-             // Find the formatting state in which this formatting root lives, not the one it creates and use its floating state.</span>
<span class="udiff-line-modified-removed">-             auto&amp; parentFormattingState = createFormattingStateForFormattingRootIfNeeded(formattingRoot.formattingContextRoot());</span>
<span class="udiff-line-modified-removed">-             auto&amp; parentFloatingState = parentFormattingState.floatingState();</span>
<span class="udiff-line-removed">-             return makeUnique&lt;InlineFormattingState&gt;(parentFloatingState, *this);</span>
<span class="udiff-line-removed">-         }).iterator-&gt;value;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (formattingRoot.establishesBlockFormattingContext()) {</span>
<span class="udiff-line-removed">-         return *m_formattingStates.ensure(&amp;formattingRoot, [&amp;] {</span>
<span class="udiff-line-modified-added">+     ASSERT(formattingContextRoot.establishesInlineFormattingContext());</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     auto create = [&amp;] {</span>
<span class="udiff-line-modified-added">+         // If the block container box that initiates this inline formatting context also establishes a block context, the floats outside of the formatting root</span>
<span class="udiff-line-modified-added">+         // should not interfere with the content inside.</span>
<span class="udiff-line-modified-added">+         // &lt;div style=&quot;float: left&quot;&gt;&lt;/div&gt;&lt;div style=&quot;overflow: hidden&quot;&gt; &lt;- is a non-intrusive float, because overflow: hidden triggers new block formatting context.&lt;/div&gt;</span>
<span class="udiff-line-modified-added">+         if (formattingContextRoot.establishesBlockFormattingContext())</span>
<span class="udiff-line-modified-added">+             return makeUnique&lt;InlineFormattingState&gt;(FloatingState::create(*this, formattingContextRoot), *this);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         // Otherwise, the formatting context inherits the floats from the parent formatting context.</span>
<span class="udiff-line-modified-added">+         // Find the formatting state in which this formatting root lives, not the one it creates and use its floating state.</span>
<span class="udiff-line-modified-added">+         auto&amp; parentFormattingState = ensureFormattingState(formattingContextRoot.formattingContextRoot());</span>
<span class="udiff-line-modified-added">+         auto&amp; parentFloatingState = parentFormattingState.floatingState();</span>
<span class="udiff-line-modified-added">+         return makeUnique&lt;InlineFormattingState&gt;(parentFloatingState, *this);</span>
<span class="udiff-line-modified-added">+     };</span>
  
<span class="udiff-line-modified-removed">-             // Block formatting context always establishes a new floating state.</span>
<span class="udiff-line-modified-removed">-             return makeUnique&lt;BlockFormattingState&gt;(FloatingState::create(*this, formattingRoot), *this);</span>
<span class="udiff-line-modified-removed">-         }).iterator-&gt;value;</span>
<span class="udiff-line-modified-added">+     if (RuntimeEnabledFeatures::sharedFeatures().layoutFormattingContextIntegrationEnabled()) {</span>
<span class="udiff-line-modified-added">+         if (!m_rootInlineFormattingStateForIntegration) {</span>
<span class="udiff-line-modified-added">+             ASSERT(&amp;formattingContextRoot == m_rootContainer.get());</span>
<span class="udiff-line-added">+             m_rootInlineFormattingStateForIntegration = create();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return *m_rootInlineFormattingStateForIntegration;</span>
      }
  
<span class="udiff-line-modified-removed">-     if (formattingRoot.establishesTableFormattingContext()) {</span>
<span class="udiff-line-modified-removed">-         return *m_formattingStates.ensure(&amp;formattingRoot, [&amp;] {</span>
<span class="udiff-line-modified-added">+     return *m_inlineFormattingStates.ensure(&amp;formattingContextRoot, create).iterator-&gt;value;</span>
<span class="udiff-line-modified-added">+ }</span>
  
<span class="udiff-line-modified-removed">-             // Table formatting context always establishes a new floating state -and it stays empty.</span>
<span class="udiff-line-modified-removed">-             return makeUnique&lt;TableFormattingState&gt;(FloatingState::create(*this, formattingRoot), *this);</span>
<span class="udiff-line-modified-removed">-         }).iterator-&gt;value;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+ BlockFormattingState&amp; LayoutState::ensureBlockFormattingState(const Container&amp; formattingContextRoot)</span>
<span class="udiff-line-modified-added">+ {</span>
<span class="udiff-line-modified-added">+     ASSERT(formattingContextRoot.establishesBlockFormattingContext());</span>
  
<span class="udiff-line-modified-removed">-     CRASH();</span>
<span class="udiff-line-modified-added">+     auto create = [&amp;] {</span>
<span class="udiff-line-added">+         return makeUnique&lt;BlockFormattingState&gt;(FloatingState::create(*this, formattingContextRoot), *this);</span>
<span class="udiff-line-added">+     };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return *m_blockFormattingStates.ensure(&amp;formattingContextRoot, create).iterator-&gt;value;</span>
  }
  
<span class="udiff-line-modified-removed">- std::unique_ptr&lt;FormattingContext&gt; LayoutState::createFormattingContext(const Box&amp; formattingContextRoot)</span>
<span class="udiff-line-modified-added">+ TableFormattingState&amp; LayoutState::ensureTableFormattingState(const Container&amp; formattingContextRoot)</span>
  {
<span class="udiff-line-modified-removed">-     ASSERT(formattingContextRoot.establishesFormattingContext());</span>
<span class="udiff-line-removed">-     if (formattingContextRoot.establishesInlineFormattingContext()) {</span>
<span class="udiff-line-removed">-         auto&amp; inlineFormattingState = downcast&lt;InlineFormattingState&gt;(createFormattingStateForFormattingRootIfNeeded(formattingContextRoot));</span>
<span class="udiff-line-removed">-         return makeUnique&lt;InlineFormattingContext&gt;(formattingContextRoot, inlineFormattingState);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     ASSERT(formattingContextRoot.establishesTableFormattingContext());</span>
  
<span class="udiff-line-modified-removed">-     if (formattingContextRoot.establishesBlockFormattingContext()) {</span>
<span class="udiff-line-modified-removed">-         ASSERT(formattingContextRoot.establishesBlockFormattingContextOnly());</span>
<span class="udiff-line-modified-removed">-         auto&amp; blockFormattingState = downcast&lt;BlockFormattingState&gt;(createFormattingStateForFormattingRootIfNeeded(formattingContextRoot));</span>
<span class="udiff-line-modified-removed">-         return makeUnique&lt;BlockFormattingContext&gt;(formattingContextRoot, blockFormattingState);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     auto create = [&amp;] {</span>
<span class="udiff-line-modified-added">+         // Table formatting context always establishes a new floating state -and it stays empty.</span>
<span class="udiff-line-modified-added">+         return makeUnique&lt;TableFormattingState&gt;(FloatingState::create(*this, formattingContextRoot), *this);</span>
<span class="udiff-line-modified-added">+     };</span>
  
<span class="udiff-line-modified-removed">-     if (formattingContextRoot.establishesTableFormattingContext()) {</span>
<span class="udiff-line-modified-removed">-         auto&amp; tableFormattingState = downcast&lt;TableFormattingState&gt;(createFormattingStateForFormattingRootIfNeeded(formattingContextRoot));</span>
<span class="udiff-line-removed">-         return makeUnique&lt;TableFormattingContext&gt;(formattingContextRoot, tableFormattingState);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     return *m_tableFormattingStates.ensure(&amp;formattingContextRoot, create).iterator-&gt;value;</span>
<span class="udiff-line-modified-added">+ }</span>
  
<span class="udiff-line-modified-removed">-     CRASH();</span>
<span class="udiff-line-modified-added">+ void LayoutState::setViewportSize(const LayoutSize&amp; viewportSize)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(RuntimeEnabledFeatures::sharedFeatures().layoutFormattingContextIntegrationEnabled());</span>
<span class="udiff-line-added">+     m_viewportSize = viewportSize;</span>
  }
  
<span class="udiff-line-modified-removed">- void LayoutState::run(const RenderView&amp; renderView)</span>
<span class="udiff-line-modified-added">+ LayoutSize LayoutState::viewportSize() const</span>
  {
<span class="udiff-line-modified-removed">-     auto initialContainingBlock = TreeBuilder::createLayoutTree(renderView);</span>
<span class="udiff-line-modified-removed">-     auto layoutState = LayoutState(*initialContainingBlock);</span>
<span class="udiff-line-modified-removed">-     // Not efficient, but this is temporary anyway.</span>
<span class="udiff-line-modified-removed">-     // Collect the out-of-flow descendants at the formatting root level (as opposed to at the containing block level, though they might be the same).</span>
<span class="udiff-line-modified-removed">-     for (auto&amp; descendant : descendantsOfType&lt;Box&gt;(*initialContainingBlock)) {</span>
<span class="udiff-line-modified-removed">-         if (!descendant.isOutOfFlowPositioned())</span>
<span class="udiff-line-modified-removed">-             continue;</span>
<span class="udiff-line-modified-removed">-         auto&amp; formattingState = layoutState.createFormattingStateForFormattingRootIfNeeded(descendant.formattingContextRoot());</span>
<span class="udiff-line-removed">-         formattingState.addOutOfFlowBox(descendant);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     auto quirksMode = [&amp;] {</span>
<span class="udiff-line-removed">-         auto&amp; document = renderView.document();</span>
<span class="udiff-line-removed">-         if (document.inLimitedQuirksMode())</span>
<span class="udiff-line-removed">-             return QuirksMode::Limited;</span>
<span class="udiff-line-removed">-         if (document.inQuirksMode())</span>
<span class="udiff-line-removed">-             return QuirksMode::Yes;</span>
<span class="udiff-line-removed">-         return QuirksMode::No;</span>
<span class="udiff-line-removed">-     };</span>
<span class="udiff-line-removed">-     layoutState.setQuirksMode(quirksMode());</span>
<span class="udiff-line-removed">-     layoutState.updateLayout();</span>
<span class="udiff-line-removed">-     layoutState.verifyAndOutputMismatchingLayoutTree(renderView);</span>
<span class="udiff-line-modified-added">+     ASSERT(RuntimeEnabledFeatures::sharedFeatures().layoutFormattingContextIntegrationEnabled());</span>
<span class="udiff-line-modified-added">+     return m_viewportSize;</span>
<span class="udiff-line-modified-added">+ }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ void LayoutState::setIsIntegratedRootBoxFirstChild(bool value)</span>
<span class="udiff-line-modified-added">+ {</span>
<span class="udiff-line-modified-added">+     ASSERT(RuntimeEnabledFeatures::sharedFeatures().layoutFormattingContextIntegrationEnabled());</span>
<span class="udiff-line-modified-added">+     m_isIntegratedRootBoxFirstChild = value;</span>
  }
  
  }
  }
  
</pre>
<center><a href="LayoutPhase.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="LayoutState.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>