<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/webauthn/fido/U2fResponseConverter.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="U2fCommandConstructor.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="U2fResponseConverter.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/webauthn/fido/U2fResponseConverter.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 145,50 ***</span>
      return attestationStatementMap;
  }
  
  } // namespace
  
<span class="line-modified">! Optional&lt;PublicKeyCredentialData&gt; readU2fRegisterResponse(const String&amp; rpId, const Vector&lt;uint8_t&gt;&amp; u2fData, const AttestationConveyancePreference&amp; attestation)</span>
  {
      auto publicKey = extractECPublicKeyFromU2fRegistrationResponse(u2fData);
      if (publicKey.isEmpty())
<span class="line-modified">!         return WTF::nullopt;</span>
  
      auto attestedCredentialData = createAttestedCredentialDataFromU2fRegisterResponse(u2fData, publicKey);
      if (attestedCredentialData.isEmpty())
<span class="line-modified">!         return WTF::nullopt;</span>
  
      // Extract the credentialId for packing into the response data.
      auto credentialId = extractCredentialIdFromU2fRegistrationResponse(u2fData);
      ASSERT(!credentialId.isEmpty());
  
      // The counter is zeroed out for Register requests.
      auto authData = buildAuthData(rpId, makeCredentialFlags, 0, attestedCredentialData);
  
      auto fidoAttestationStatement = createFidoAttestationStatementFromU2fRegisterResponse(u2fData, kU2fKeyHandleOffset + credentialId.size());
      if (fidoAttestationStatement.empty())
<span class="line-modified">!         return WTF::nullopt;</span>
  
      auto attestationObject = buildAttestationObject(WTFMove(authData), &quot;fido-u2f&quot;, WTFMove(fidoAttestationStatement), attestation);
  
<span class="line-modified">!     return PublicKeyCredentialData { ArrayBuffer::create(credentialId.data(), credentialId.size()), true, nullptr, ArrayBuffer::create(attestationObject.data(), attestationObject.size()), nullptr, nullptr, nullptr, WTF::nullopt };</span>
  }
  
<span class="line-modified">! Optional&lt;PublicKeyCredentialData&gt; readU2fSignResponse(const String&amp; rpId, const Vector&lt;uint8_t&gt;&amp; keyHandle, const Vector&lt;uint8_t&gt;&amp; u2fData)</span>
  {
      if (keyHandle.isEmpty() || u2fData.size() &lt;= signatureIndex)
<span class="line-modified">!         return WTF::nullopt;</span>
  
      // 1 byte flags, 4 bytes counter
      auto flags = u2fData[flagIndex];
      uint32_t counter = u2fData[counterIndex] &lt;&lt; 24;
      counter += u2fData[counterIndex + 1] &lt;&lt; 16;
      counter += u2fData[counterIndex + 2] &lt;&lt; 8;
      counter += u2fData[counterIndex + 3];
      auto authData = buildAuthData(rpId, flags, counter, { });
  
<span class="line-modified">!     return PublicKeyCredentialData { ArrayBuffer::create(keyHandle.data(), keyHandle.size()), false, nullptr, nullptr, ArrayBuffer::create(authData.data(), authData.size()), ArrayBuffer::create(u2fData.data() + signatureIndex, u2fData.size() - signatureIndex), nullptr, WTF::nullopt };</span>
  }
  
  } // namespace fido
  
  #endif // ENABLE(WEB_AUTHN)
<span class="line-new-header">--- 145,54 ---</span>
      return attestationStatementMap;
  }
  
  } // namespace
  
<span class="line-modified">! RefPtr&lt;AuthenticatorAttestationResponse&gt; readU2fRegisterResponse(const String&amp; rpId, const Vector&lt;uint8_t&gt;&amp; u2fData, const AttestationConveyancePreference&amp; attestation)</span>
  {
      auto publicKey = extractECPublicKeyFromU2fRegistrationResponse(u2fData);
      if (publicKey.isEmpty())
<span class="line-modified">!         return nullptr;</span>
  
      auto attestedCredentialData = createAttestedCredentialDataFromU2fRegisterResponse(u2fData, publicKey);
      if (attestedCredentialData.isEmpty())
<span class="line-modified">!         return nullptr;</span>
  
      // Extract the credentialId for packing into the response data.
      auto credentialId = extractCredentialIdFromU2fRegistrationResponse(u2fData);
      ASSERT(!credentialId.isEmpty());
  
      // The counter is zeroed out for Register requests.
      auto authData = buildAuthData(rpId, makeCredentialFlags, 0, attestedCredentialData);
  
      auto fidoAttestationStatement = createFidoAttestationStatementFromU2fRegisterResponse(u2fData, kU2fKeyHandleOffset + credentialId.size());
      if (fidoAttestationStatement.empty())
<span class="line-modified">!         return nullptr;</span>
  
      auto attestationObject = buildAttestationObject(WTFMove(authData), &quot;fido-u2f&quot;, WTFMove(fidoAttestationStatement), attestation);
  
<span class="line-modified">!     return AuthenticatorAttestationResponse::create(credentialId, attestationObject);</span>
  }
  
<span class="line-modified">! RefPtr&lt;AuthenticatorAssertionResponse&gt; readU2fSignResponse(const String&amp; rpId, const Vector&lt;uint8_t&gt;&amp; keyHandle, const Vector&lt;uint8_t&gt;&amp; u2fData)</span>
  {
      if (keyHandle.isEmpty() || u2fData.size() &lt;= signatureIndex)
<span class="line-modified">!         return nullptr;</span>
  
      // 1 byte flags, 4 bytes counter
      auto flags = u2fData[flagIndex];
      uint32_t counter = u2fData[counterIndex] &lt;&lt; 24;
      counter += u2fData[counterIndex + 1] &lt;&lt; 16;
      counter += u2fData[counterIndex + 2] &lt;&lt; 8;
      counter += u2fData[counterIndex + 3];
      auto authData = buildAuthData(rpId, flags, counter, { });
  
<span class="line-modified">!     // FIXME: Find a way to remove the need of constructing a vector here.</span>
<span class="line-added">+     Vector&lt;uint8_t&gt; signature;</span>
<span class="line-added">+     signature.append(u2fData.data() + signatureIndex, u2fData.size() - signatureIndex);</span>
<span class="line-added">+ </span>
<span class="line-added">+     return AuthenticatorAssertionResponse::create(keyHandle, authData, signature, { });</span>
  }
  
  } // namespace fido
  
  #endif // ENABLE(WEB_AUTHN)
</pre>
<center><a href="U2fCommandConstructor.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="U2fResponseConverter.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>