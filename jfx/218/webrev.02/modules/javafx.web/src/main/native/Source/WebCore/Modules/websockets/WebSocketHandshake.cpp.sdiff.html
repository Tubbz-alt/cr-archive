<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/websockets/WebSocketHandshake.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WebSocketDeflater.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WorkerThreadableWebSocketChannel.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/websockets/WebSocketHandshake.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 20  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 21  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 22  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 23  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 24  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 25  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 26  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 27  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 28  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 29  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 30  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 31  */
 32 
 33 #include &quot;config.h&quot;
 34 #include &quot;WebSocketHandshake.h&quot;
 35 
 36 #include &quot;Cookie.h&quot;
 37 #include &quot;CookieJar.h&quot;
 38 #include &quot;HTTPHeaderMap.h&quot;
 39 #include &quot;HTTPHeaderNames.h&quot;

 40 #include &quot;HTTPParsers.h&quot;
 41 #include &quot;InspectorInstrumentation.h&quot;
 42 #include &quot;Logging.h&quot;
 43 #include &quot;ResourceRequest.h&quot;
 44 #include &quot;ScriptExecutionContext.h&quot;
 45 #include &quot;SecurityOrigin.h&quot;
 46 #include &lt;wtf/URL.h&gt;
 47 #include &quot;WebSocket.h&quot;
 48 #include &lt;wtf/ASCIICType.h&gt;
 49 #include &lt;wtf/CryptographicallyRandomNumber.h&gt;
 50 #include &lt;wtf/MD5.h&gt;
 51 #include &lt;wtf/SHA1.h&gt;
 52 #include &lt;wtf/StdLibExtras.h&gt;
 53 #include &lt;wtf/StringExtras.h&gt;
 54 #include &lt;wtf/Vector.h&gt;
 55 #include &lt;wtf/text/Base64.h&gt;
 56 #include &lt;wtf/text/CString.h&gt;
 57 #include &lt;wtf/text/StringBuilder.h&gt;
 58 #include &lt;wtf/text/StringView.h&gt;
 59 #include &lt;wtf/text/WTFString.h&gt;
</pre>
<hr />
<pre>
221 
222 ResourceRequest WebSocketHandshake::clientHandshakeRequest(Function&lt;String(const URL&amp;)&gt;&amp;&amp; cookieRequestHeaderFieldValue) const
223 {
224     // Keep the following consistent with clientHandshakeMessage().
225     ResourceRequest request(m_url);
226     request.setHTTPMethod(&quot;GET&quot;);
227 
228     request.setHTTPHeaderField(HTTPHeaderName::Connection, &quot;Upgrade&quot;);
229     request.setHTTPHeaderField(HTTPHeaderName::Host, hostName(m_url, m_secure));
230     request.setHTTPHeaderField(HTTPHeaderName::Origin, m_clientOrigin);
231     if (!m_clientProtocol.isEmpty())
232         request.setHTTPHeaderField(HTTPHeaderName::SecWebSocketProtocol, m_clientProtocol);
233 
234     URL url = httpURLForAuthenticationAndCookies();
235     if (m_allowCookies) {
236         String cookie = cookieRequestHeaderFieldValue(url);
237         if (!cookie.isEmpty())
238             request.setHTTPHeaderField(HTTPHeaderName::Cookie, cookie);
239     }
240 
<span class="line-modified">241     request.setHTTPHeaderField(HTTPHeaderName::Pragma, &quot;no-cache&quot;);</span>
<span class="line-modified">242     request.setHTTPHeaderField(HTTPHeaderName::CacheControl, &quot;no-cache&quot;);</span>
243 
244     request.setHTTPHeaderField(HTTPHeaderName::SecWebSocketKey, m_secWebSocketKey);
245     request.setHTTPHeaderField(HTTPHeaderName::SecWebSocketVersion, &quot;13&quot;);
246     const String extensionValue = m_extensionDispatcher.createHeaderValue();
247     if (extensionValue.length())
248         request.setHTTPHeaderField(HTTPHeaderName::SecWebSocketExtensions, extensionValue);
249 
250     // Add a User-Agent header.
251     request.setHTTPUserAgent(m_userAgent);
252 
253     return request;
254 }
255 
256 void WebSocketHandshake::reset()
257 {
258     m_mode = Incomplete;
259     m_extensionDispatcher.reset();
260 }
261 
262 int WebSocketHandshake::readServerHandshake(const char* header, size_t len)
</pre>
</td>
<td>
<hr />
<pre>
 20  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 21  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 22  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 23  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 24  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 25  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 26  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 27  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 28  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 29  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 30  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 31  */
 32 
 33 #include &quot;config.h&quot;
 34 #include &quot;WebSocketHandshake.h&quot;
 35 
 36 #include &quot;Cookie.h&quot;
 37 #include &quot;CookieJar.h&quot;
 38 #include &quot;HTTPHeaderMap.h&quot;
 39 #include &quot;HTTPHeaderNames.h&quot;
<span class="line-added"> 40 #include &quot;HTTPHeaderValues.h&quot;</span>
 41 #include &quot;HTTPParsers.h&quot;
 42 #include &quot;InspectorInstrumentation.h&quot;
 43 #include &quot;Logging.h&quot;
 44 #include &quot;ResourceRequest.h&quot;
 45 #include &quot;ScriptExecutionContext.h&quot;
 46 #include &quot;SecurityOrigin.h&quot;
 47 #include &lt;wtf/URL.h&gt;
 48 #include &quot;WebSocket.h&quot;
 49 #include &lt;wtf/ASCIICType.h&gt;
 50 #include &lt;wtf/CryptographicallyRandomNumber.h&gt;
 51 #include &lt;wtf/MD5.h&gt;
 52 #include &lt;wtf/SHA1.h&gt;
 53 #include &lt;wtf/StdLibExtras.h&gt;
 54 #include &lt;wtf/StringExtras.h&gt;
 55 #include &lt;wtf/Vector.h&gt;
 56 #include &lt;wtf/text/Base64.h&gt;
 57 #include &lt;wtf/text/CString.h&gt;
 58 #include &lt;wtf/text/StringBuilder.h&gt;
 59 #include &lt;wtf/text/StringView.h&gt;
 60 #include &lt;wtf/text/WTFString.h&gt;
</pre>
<hr />
<pre>
222 
223 ResourceRequest WebSocketHandshake::clientHandshakeRequest(Function&lt;String(const URL&amp;)&gt;&amp;&amp; cookieRequestHeaderFieldValue) const
224 {
225     // Keep the following consistent with clientHandshakeMessage().
226     ResourceRequest request(m_url);
227     request.setHTTPMethod(&quot;GET&quot;);
228 
229     request.setHTTPHeaderField(HTTPHeaderName::Connection, &quot;Upgrade&quot;);
230     request.setHTTPHeaderField(HTTPHeaderName::Host, hostName(m_url, m_secure));
231     request.setHTTPHeaderField(HTTPHeaderName::Origin, m_clientOrigin);
232     if (!m_clientProtocol.isEmpty())
233         request.setHTTPHeaderField(HTTPHeaderName::SecWebSocketProtocol, m_clientProtocol);
234 
235     URL url = httpURLForAuthenticationAndCookies();
236     if (m_allowCookies) {
237         String cookie = cookieRequestHeaderFieldValue(url);
238         if (!cookie.isEmpty())
239             request.setHTTPHeaderField(HTTPHeaderName::Cookie, cookie);
240     }
241 
<span class="line-modified">242     request.setHTTPHeaderField(HTTPHeaderName::Pragma, HTTPHeaderValues::noCache());</span>
<span class="line-modified">243     request.setHTTPHeaderField(HTTPHeaderName::CacheControl, HTTPHeaderValues::noCache());</span>
244 
245     request.setHTTPHeaderField(HTTPHeaderName::SecWebSocketKey, m_secWebSocketKey);
246     request.setHTTPHeaderField(HTTPHeaderName::SecWebSocketVersion, &quot;13&quot;);
247     const String extensionValue = m_extensionDispatcher.createHeaderValue();
248     if (extensionValue.length())
249         request.setHTTPHeaderField(HTTPHeaderName::SecWebSocketExtensions, extensionValue);
250 
251     // Add a User-Agent header.
252     request.setHTTPUserAgent(m_userAgent);
253 
254     return request;
255 }
256 
257 void WebSocketHandshake::reset()
258 {
259     m_mode = Incomplete;
260     m_extensionDispatcher.reset();
261 }
262 
263 int WebSocketHandshake::readServerHandshake(const char* header, size_t len)
</pre>
</td>
</tr>
</table>
<center><a href="WebSocketDeflater.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WorkerThreadableWebSocketChannel.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>