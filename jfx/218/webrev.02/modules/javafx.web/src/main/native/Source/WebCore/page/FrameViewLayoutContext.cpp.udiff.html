<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/page/FrameViewLayoutContext.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="FrameView.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FrameViewLayoutContext.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/FrameViewLayoutContext.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -38,25 +38,68 @@</span>
  #include &quot;RenderView.h&quot;
  #include &quot;RuntimeEnabledFeatures.h&quot;
  #include &quot;ScriptDisallowedScope.h&quot;
  #include &quot;Settings.h&quot;
  #if ENABLE(LAYOUT_FORMATTING_CONTEXT)
<span class="udiff-line-added">+ #include &quot;DisplayBox.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;InvalidationContext.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;InvalidationState.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;LayoutContext.h&quot;</span>
  #include &quot;LayoutState.h&quot;
<span class="udiff-line-added">+ #include &quot;LayoutTreeBuilder.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;RenderDescendantIterator.h&quot;</span>
  #endif
  
  #include &lt;wtf/SetForScope.h&gt;
  #include &lt;wtf/SystemTracing.h&gt;
  #include &lt;wtf/text/TextStream.h&gt;
  
  namespace WebCore {
  
  #if ENABLE(LAYOUT_FORMATTING_CONTEXT)
<span class="udiff-line-modified-removed">- static void layoutUsingFormattingContext(const RenderView&amp; renderView)</span>
<span class="udiff-line-modified-added">+ void FrameViewLayoutContext::layoutUsingFormattingContext()</span>
  {
      if (!RuntimeEnabledFeatures::sharedFeatures().layoutFormattingContextEnabled())
          return;
<span class="udiff-line-modified-removed">-     Layout::LayoutState::run(renderView);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     // FrameView::setContentsSize temporary disables layout.</span>
<span class="udiff-line-added">+     if (m_disableSetNeedsLayoutCount)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto&amp; renderView = *this-&gt;renderView();</span>
<span class="udiff-line-added">+     if (!m_layoutTreeContent) {</span>
<span class="udiff-line-added">+         m_layoutTreeContent = Layout::TreeBuilder::buildLayoutTree(renderView);</span>
<span class="udiff-line-added">+         // FIXME: New layout tree requires a new state for now.</span>
<span class="udiff-line-added">+         m_layoutState = nullptr;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     if (!m_layoutState)</span>
<span class="udiff-line-added">+         m_layoutState = makeUnique&lt;Layout::LayoutState&gt;(*document(), m_layoutTreeContent-&gt;rootLayoutBox());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // FIXME: This is not the real invalidation yet.</span>
<span class="udiff-line-added">+     auto invalidationState = Layout::InvalidationState { };</span>
<span class="udiff-line-added">+     auto layoutContext = Layout::LayoutContext { *m_layoutState };</span>
<span class="udiff-line-added">+     layoutContext.layout(view().layoutSize(), invalidationState);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Clean up the render tree state when we don&#39;t run RenderView::layout.</span>
<span class="udiff-line-added">+     if (renderView.needsLayout()) {</span>
<span class="udiff-line-added">+         auto contentSize = m_layoutState-&gt;displayBoxForLayoutBox(*m_layoutState-&gt;root().firstChild()).size();</span>
<span class="udiff-line-added">+         renderView.setSize(contentSize);</span>
<span class="udiff-line-added">+         renderView.repaintViewRectangle({ 0, 0, contentSize.width(), contentSize.height() });</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         for (auto&amp; descendant : descendantsOfType&lt;RenderObject&gt;(renderView))</span>
<span class="udiff-line-added">+             descendant.clearNeedsLayout();</span>
<span class="udiff-line-added">+         renderView.clearNeedsLayout();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #ifndef NDEBUG</span>
<span class="udiff-line-added">+     Layout::LayoutContext::verifyAndOutputMismatchingLayoutTree(*m_layoutState, renderView);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void FrameViewLayoutContext::invalidateLayoutTreeContent()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_layoutTreeContent = nullptr;</span>
  }
  #endif
  
  static bool isObjectAncestorContainerOf(RenderElement&amp; ancestor, RenderElement&amp; descendant)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -143,21 +186,21 @@</span>
      RELEASE_ASSERT_WITH_SECURITY_IMPLICATION(!frame().document()-&gt;inRenderTreeUpdate());
      ASSERT(LayoutDisallowedScope::isLayoutAllowed());
      ASSERT(!view().isPainting());
      ASSERT(frame().view() == &amp;view());
      ASSERT(frame().document());
<span class="udiff-line-modified-removed">-     ASSERT(frame().document()-&gt;pageCacheState() == Document::NotInPageCache</span>
<span class="udiff-line-modified-removed">-         || frame().document()-&gt;pageCacheState() == Document::AboutToEnterPageCache);</span>
<span class="udiff-line-modified-added">+     ASSERT(frame().document()-&gt;backForwardCacheState() == Document::NotInBackForwardCache</span>
<span class="udiff-line-modified-added">+         || frame().document()-&gt;backForwardCacheState() == Document::AboutToEnterBackForwardCache);</span>
      if (!canPerformLayout()) {
          LOG(Layout, &quot;  is not allowed, bailing&quot;);
          return;
      }
  
      Ref&lt;FrameView&gt; protectView(view());
      LayoutScope layoutScope(*this);
      TraceScope tracingScope(LayoutStart, LayoutEnd);
<span class="udiff-line-modified-removed">-     InspectorInstrumentationCookie inspectorLayoutScope(InspectorInstrumentation::willLayout(view().frame()));</span>
<span class="udiff-line-modified-added">+     InspectorInstrumentation::willLayout(view().frame());</span>
      AnimationUpdateBlock animationUpdateBlock(&amp;view().frame().animation());
      WeakPtr&lt;RenderElement&gt; layoutRoot;
  
      m_layoutTimer.stop();
      m_delayedLayout = false;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -202,11 +245,11 @@</span>
  #ifndef NDEBUG
          RenderTreeNeedsLayoutChecker checker(*layoutRoot);
  #endif
          layoutRoot-&gt;layout();
  #if ENABLE(LAYOUT_FORMATTING_CONTEXT)
<span class="udiff-line-modified-removed">-         layoutUsingFormattingContext(*renderView());</span>
<span class="udiff-line-modified-added">+         layoutUsingFormattingContext();</span>
  #endif
          ++m_layoutCount;
  #if ENABLE(TEXT_AUTOSIZING)
          applyTextSizingIfNeeded(*layoutRoot.get());
  #endif
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -230,11 +273,11 @@</span>
              renderView()-&gt;repaintRootContents();
          ASSERT(!layoutRoot-&gt;needsLayout());
          view().didLayout(layoutRoot);
          runOrScheduleAsynchronousTasks();
      }
<span class="udiff-line-modified-removed">-     InspectorInstrumentation::didLayout(inspectorLayoutScope, *layoutRoot);</span>
<span class="udiff-line-modified-added">+     InspectorInstrumentation::didLayout(view().frame(), *layoutRoot);</span>
      DebugPageOverlays::didLayout(view().frame());
  }
  
  void FrameViewLayoutContext::runOrScheduleAsynchronousTasks()
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -332,11 +375,11 @@</span>
      ++m_disableSetNeedsLayoutCount;
  }
  
  void FrameViewLayoutContext::scheduleLayout()
  {
<span class="udiff-line-modified-removed">-     // FIXME: We should assert the page is not in the page cache, but that is causing</span>
<span class="udiff-line-modified-added">+     // FIXME: We should assert the page is not in the back/forward cache, but that is causing</span>
      // too many false assertions. See &lt;rdar://problem/7218118&gt;.
      ASSERT(frame().view() == &amp;view());
  
      if (subtreeLayoutRoot())
          convertSubtreeLayoutToFullLayout();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -517,11 +560,11 @@</span>
          document.styleScope().didChangeStyleSheetEnvironment();
  
      // Viewport-dependent media queries may cause us to need completely different style information.
      document.styleScope().evaluateMediaQueriesForViewportChange();
  
<span class="udiff-line-modified-removed">-     document.evaluateMediaQueryList();</span>
<span class="udiff-line-modified-added">+     document.updateElementsAffectedByMediaQueries();</span>
      // If there is any pagination to apply, it will affect the RenderView&#39;s style, so we should
      // take care of that now.
      view().applyPaginationToViewport();
      // Always ensure our style info is up-to-date. This can happen in situations where
      // the layout beats any sort of style recalc update that needs to occur.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -573,11 +616,11 @@</span>
  {
      if (auto* layoutState = this-&gt;layoutState())
          layoutState-&gt;addLayoutDelta(delta);
  }
  
<span class="udiff-line-modified-removed">- #if !ASSERT_DISABLED</span>
<span class="udiff-line-modified-added">+ #if ASSERT_ENABLED</span>
  bool FrameViewLayoutContext::layoutDeltaMatches(const LayoutSize&amp; delta)
  {
      if (auto* layoutState = this-&gt;layoutState())
          return layoutState-&gt;layoutDeltaMatches(delta);
      return false;
</pre>
<center><a href="FrameView.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FrameViewLayoutContext.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>