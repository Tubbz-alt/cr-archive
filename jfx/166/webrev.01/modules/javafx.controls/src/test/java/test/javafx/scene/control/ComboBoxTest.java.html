<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.controls/src/test/java/test/javafx/scene/control/ComboBoxTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package test.javafx.scene.control;
  27 
  28 import test.com.sun.javafx.scene.control.infrastructure.KeyModifier;
  29 import test.com.sun.javafx.scene.control.infrastructure.MouseEventFirer;
  30 import com.sun.javafx.tk.Toolkit;
  31 import javafx.css.PseudoClass;
  32 
  33 import test.com.sun.javafx.scene.control.infrastructure.KeyEventFirer;
  34 import test.com.sun.javafx.scene.control.infrastructure.StageLoader;
  35 import test.com.sun.javafx.scene.control.infrastructure.VirtualFlowTestUtils;
  36 
  37 import javafx.scene.control.skin.ComboBoxListViewSkin;
  38 
  39 import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.assertStyleClassContains;
  40 import static org.junit.Assert.*;
  41 import static org.junit.Assert.assertEquals;
  42 
  43 import java.util.*;
  44 import java.util.concurrent.atomic.AtomicInteger;
  45 
  46 import javafx.beans.property.ObjectProperty;
  47 import javafx.beans.property.SimpleObjectProperty;
  48 import javafx.beans.property.SimpleStringProperty;
  49 import javafx.beans.property.StringProperty;
  50 import javafx.collections.FXCollections;
  51 import javafx.collections.ObservableList;
  52 import javafx.event.ActionEvent;
  53 import javafx.event.EventHandler;
  54 import javafx.scene.Node;
  55 import javafx.scene.Scene;
  56 import javafx.scene.control.Button;
  57 import javafx.scene.control.ComboBox;
  58 import javafx.scene.control.ComboBoxShim;
  59 import javafx.scene.control.IndexedCell;
  60 import javafx.scene.control.Label;
  61 import javafx.scene.control.ListCell;
  62 import javafx.scene.control.ListCellShim;
  63 import javafx.scene.control.ListView;
  64 import javafx.scene.control.SelectionModel;
  65 import javafx.scene.control.SelectionModelShim;
  66 import javafx.scene.control.SingleSelectionModel;
  67 import javafx.scene.control.Tab;
  68 import javafx.scene.control.TabPane;
  69 import javafx.scene.control.TextField;
  70 import javafx.scene.control.Tooltip;
  71 import javafx.scene.control.skin.VirtualFlow;
  72 import javafx.scene.input.KeyCode;
  73 import javafx.scene.layout.BorderPane;
  74 import javafx.scene.layout.FlowPane;
  75 import javafx.scene.layout.VBox;
  76 import javafx.scene.paint.Color;
  77 import javafx.scene.shape.Circle;
  78 import javafx.stage.Stage;
  79 import javafx.util.Callback;
  80 import javafx.util.StringConverter;
  81 
  82 import org.junit.After;
  83 import org.junit.Before;
  84 import org.junit.Ignore;
  85 import org.junit.Test;
  86 
  87 public class ComboBoxTest {
  88     private ComboBox&lt;String&gt; comboBox;
  89     private SingleSelectionModel&lt;String&gt; sm;
  90 
  91     /*********************************************************************
  92      *                                                                   *
  93      * Utility methods                                                   *
  94      *                                                                   *
  95      ********************************************************************/
  96 
  97     public ListView getListView() {
  98         return (ListView) ((ComboBoxListViewSkin)comboBox.getSkin()).getPopupContent();
  99     }
 100 
 101     public Node getDisplayNode() {
 102         return ((ComboBoxListViewSkin)comboBox.getSkin()).getDisplayNode();
 103     }
 104 
 105 
 106 
 107     /*********************************************************************
 108      *                                                                   *
 109      * Setup                                                             *
 110      *                                                                   *
 111      ********************************************************************/
 112 
 113     @Before public void setup() {
 114         Thread.currentThread().setUncaughtExceptionHandler((thread, throwable) -&gt; {
 115             if (throwable instanceof RuntimeException) {
 116                 throw (RuntimeException)throwable;
 117             } else {
 118                 Thread.currentThread().getThreadGroup().uncaughtException(thread, throwable);
 119             }
 120         });
 121 
 122         comboBox = new ComboBox&lt;String&gt;();
 123         comboBox.setSkin(new ComboBoxListViewSkin&lt;&gt;(comboBox));
 124         sm = comboBox.getSelectionModel();
 125     }
 126 
 127     @After public void cleanup() {
 128         Thread.currentThread().setUncaughtExceptionHandler(null);
 129     }
 130 
 131     /*********************************************************************
 132      *                                                                   *
 133      * Tests for the constructors                                        *
 134      *                                                                   *
 135      ********************************************************************/
 136 
 137     @Test public void noArgConstructorSetsTheStyleClass() {
 138         assertStyleClassContains(comboBox, &quot;combo-box&quot;);
 139     }
 140 
 141     @Test public void noArgConstructorSetsNonNullSelectionModel() {
 142         assertNotNull(sm);
 143     }
 144 
 145     @Test public void noArgConstructorSetsNonNullItems() {
 146         assertNotNull(comboBox.getItems());
 147     }
 148 
 149     @Test public void noArgConstructor_selectedItemIsNull() {
 150         assertNull(sm.getSelectedItem());
 151     }
 152 
 153     @Test public void noArgConstructor_selectedIndexIsNegativeOne() {
 154         assertEquals(-1, sm.getSelectedIndex());
 155     }
 156 
 157     @Test public void noArgConstructor_valueIsNull() {
 158         assertNull(comboBox.getValue());
 159     }
 160 
 161     @Test public void noArgConstructor_editableIsFalse() {
 162         assertFalse(comboBox.isEditable());
 163     }
 164 
 165     @Test public void noArgConstructor_showingIsFalse() {
 166         assertFalse(comboBox.isShowing());
 167     }
 168 
 169     @Test public void noArgConstructor_promptTextIsEmptyString() {
 170         assertNull(comboBox.getPromptText());
 171     }
 172 
 173     @Test public void noArgConstructor_placeholderIsNull() {
 174         assertNull(comboBox.getPlaceholder());
 175     }
 176 
 177     @Test public void noArgConstructor_armedIsFalse() {
 178         assertFalse(comboBox.isArmed());
 179     }
 180 
 181     @Test public void noArgConstructor_converterIsNotNull() {
 182         assertNotNull(comboBox.getConverter());
 183     }
 184 
 185     @Test public void noArgConstructor_cellFactoryIsNull() {
 186         assertNull(comboBox.getCellFactory());
 187     }
 188 
 189     @Test public void noArgConstructor_visibleRowFactoryIs10() {
 190         assertEquals(10, comboBox.getVisibleRowCount());
 191     }
 192 
 193     @Test public void singleArgConstructorSetsTheStyleClass() {
 194         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 195         assertStyleClassContains(b2, &quot;combo-box&quot;);
 196     }
 197 
 198     @Test public void singleArgConstructorSetsNonNullSelectionModel() {
 199         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 200         assertNotNull(b2.getSelectionModel());
 201     }
 202 
 203     @Test public void singleArgConstructorAllowsNullItems() {
 204         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(null);
 205         assertNull(b2.getItems());
 206     }
 207 
 208     @Test public void singleArgConstructorTakesItems() {
 209         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;Hi&quot;);
 210         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(items);
 211         assertSame(items, b2.getItems());
 212     }
 213 
 214     @Test public void singleArgConstructor_selectedItemIsNull() {
 215         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 216         assertNull(b2.getSelectionModel().getSelectedItem());
 217     }
 218 
 219     @Test public void singleArgConstructor_selectedIndexIsNegativeOne() {
 220         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 221         assertEquals(-1, b2.getSelectionModel().getSelectedIndex());
 222     }
 223 
 224     @Test public void singleArgConstructor_valueIsNull() {
 225         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 226         assertNull(b2.getValue());
 227     }
 228 
 229     @Test public void singleArgConstructor_editableIsFalse() {
 230         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 231         assertFalse(b2.isEditable());
 232     }
 233 
 234     @Test public void singleArgConstructor_showingIsFalse() {
 235         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 236         assertFalse(b2.isShowing());
 237     }
 238 
 239     @Test public void singleArgConstructor_promptTextIsEmptyString() {
 240         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 241         assertNull(b2.getPromptText());
 242     }
 243 
 244     @Test public void singleArgConstructor_placeholderIsNull() {
 245         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 246         assertNull(b2.getPlaceholder());
 247     }
 248 
 249     @Test public void singleArgConstructor_armedIsFalse() {
 250         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 251         assertEquals(false, b2.isArmed());
 252     }
 253 
 254     @Test public void singleArgConstructor_converterIsNotNull() {
 255         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 256         assertNotNull(b2.getConverter());
 257     }
 258 
 259     @Test public void singleArgConstructor_cellFactoryIsNull() {
 260         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 261         assertNull(b2.getCellFactory());
 262     }
 263 
 264     @Test public void singleArgConstructor_visibleRowFactoryIs10() {
 265         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 266         assertEquals(10, b2.getVisibleRowCount());
 267     }
 268 
 269     /*********************************************************************
 270      * Tests for selection model                                         *
 271      ********************************************************************/
 272 
 273     @Test public void selectionModelCanBeNull() {
 274         comboBox.setSelectionModel(null);
 275         assertNull(comboBox.getSelectionModel());
 276     }
 277 
 278     @Test public void selectionModelCanBeBound() {
 279         SingleSelectionModel&lt;String&gt; sm = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 280         ObjectProperty&lt;SingleSelectionModel&lt;String&gt;&gt; other = new SimpleObjectProperty&lt;SingleSelectionModel&lt;String&gt;&gt;(sm);
 281         comboBox.selectionModelProperty().bind(other);
 282         assertSame(sm, sm);
 283     }
 284 
 285     @Test public void selectionModelCanBeChanged() {
 286         SingleSelectionModel&lt;String&gt; sm = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 287         comboBox.setSelectionModel(sm);
 288         assertSame(sm, sm);
 289     }
 290 
 291     @Test public void canSetSelectedItemToAnItemEvenWhenThereAreNoItems() {
 292         final String randomString = new String(&quot;I AM A CRAZY RANDOM STRING&quot;);
 293         sm.select(randomString);
 294         assertEquals(-1, sm.getSelectedIndex());
 295         assertSame(randomString, sm.getSelectedItem());
 296     }
 297 
 298     @Test public void canSetSelectedItemToAnItemNotInTheDataModel() {
 299         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 300         final String randomString = new String(&quot;I AM A CRAZY RANDOM STRING&quot;);
 301         sm.select(randomString);
 302         assertEquals(-1, sm.getSelectedIndex());
 303         assertSame(randomString, sm.getSelectedItem());
 304     }
 305 
 306     @Test public void settingTheSelectedItemToAnItemInItemsResultsInTheCorrectSelectedIndex() {
 307         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 308         sm.select(&quot;Orange&quot;);
 309         assertEquals(1, sm.getSelectedIndex());
 310         assertSame(&quot;Orange&quot;, sm.getSelectedItem());
 311     }
 312 
 313     @Test public void settingTheSelectedItemToANonexistantItemAndThenSettingItemsWhichContainsItResultsInCorrectSelectedIndex() {
 314         sm.select(&quot;Orange&quot;);
 315         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 316         assertEquals(1, sm.getSelectedIndex());
 317         assertSame(&quot;Orange&quot;, sm.getSelectedItem());
 318     }
 319 
 320     @Test public void ensureSelectionClearsWhenAllItemsAreRemoved_selectIndex0() {
 321         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 322         sm.select(0);
 323         comboBox.getItems().clear();
 324         assertEquals(-1, sm.getSelectedIndex());
 325         assertEquals(null, sm.getSelectedItem());
 326     }
 327 
 328     @Test public void ensureSelectionClearsWhenAllItemsAreRemoved_selectIndex2() {
 329         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 330         sm.select(2);
 331         comboBox.getItems().clear();
 332         assertEquals(-1, sm.getSelectedIndex());
 333         assertEquals(null, sm.getSelectedItem());
 334     }
 335 
 336     @Test public void ensureSelectedItemRemainsAccurateWhenItemsAreCleared() {
 337         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 338         sm.select(2);
 339         comboBox.getItems().clear();
 340         assertNull(sm.getSelectedItem());
 341         assertEquals(-1, sm.getSelectedIndex());
 342 
 343         comboBox.getItems().addAll(&quot;Kiwifruit&quot;, &quot;Mandarin&quot;, &quot;Pineapple&quot;);
 344         sm.select(2);
 345         assertEquals(&quot;Pineapple&quot;, sm.getSelectedItem());
 346     }
 347 
 348     @Test public void ensureSelectionShiftsDownWhenOneNewItemIsAdded() {
 349         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 350         sm.select(1);
 351         assertEquals(1, sm.getSelectedIndex());
 352         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 353 
 354         comboBox.getItems().add(0, &quot;Kiwifruit&quot;);
 355         assertEquals(2, sm.getSelectedIndex());
 356         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 357     }
 358 
 359     @Test public void ensureSelectionShiftsDownWhenMultipleNewItemAreAdded() {
 360         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 361         sm.select(1);
 362         assertEquals(1, sm.getSelectedIndex());
 363         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 364 
 365         comboBox.getItems().addAll(0, Arrays.asList(&quot;Kiwifruit&quot;, &quot;Pineapple&quot;, &quot;Mandarin&quot;));
 366         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 367         assertEquals(4, sm.getSelectedIndex());
 368     }
 369 
 370     @Test public void ensureSelectionShiftsUpWhenOneItemIsRemoved() {
 371         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 372         sm.select(1);
 373         assertEquals(1, sm.getSelectedIndex());
 374         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 375 
 376         comboBox.getItems().remove(&quot;Apple&quot;);
 377         assertEquals(0, sm.getSelectedIndex());
 378         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 379     }
 380 
 381     @Test public void ensureSelectionShiftsUpWheMultipleItemsAreRemoved() {
 382         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 383         sm.select(2);
 384         assertEquals(2, sm.getSelectedIndex());
 385         assertEquals(&quot;Banana&quot;, sm.getSelectedItem());
 386 
 387         comboBox.getItems().removeAll(Arrays.asList(&quot;Apple&quot;, &quot;Orange&quot;));
 388         assertEquals(0, sm.getSelectedIndex());
 389         assertEquals(&quot;Banana&quot;, sm.getSelectedItem());
 390     }
 391 
 392     @Test public void ensureSelectionIsCorrectWhenItemsChange() {
 393         comboBox.setItems(FXCollections.observableArrayList(&quot;Item 1&quot;));
 394         sm.select(0);
 395         assertEquals(&quot;Item 1&quot;, sm.getSelectedItem());
 396 
 397         comboBox.setItems(FXCollections.observableArrayList(&quot;Item 2&quot;));
 398         assertEquals(-1, sm.getSelectedIndex());
 399         assertEquals(null, sm.getSelectedItem());
 400     }
 401 
 402     @Test(expected=NullPointerException.class)
 403     public void selectionModelComboBoxReferenceCanNotBeNull() {
 404         ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(null);
 405     }
 406 
 407     @Test public void ensureGetModelItemOutOfBoundsWorks_1() {
 408         ComboBox cb = new ComboBox(null);
 409         cb.getSelectionModel().select(-1);
 410         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
 411     }
 412 
 413     @Test public void ensureGetModelItemOutOfBoundsWorks_2() {
 414         ComboBox cb = new ComboBox(null);
 415         cb.getSelectionModel().select(0);
 416         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
 417     }
 418 
 419     @Test public void test_rt15793() {
 420         // ComboBox selectedIndex is 0 although the items list is empty
 421         final ComboBox lv = new ComboBox();
 422         final ObservableList list = FXCollections.observableArrayList();
 423         lv.setItems(list);
 424         list.add(&quot;toto&quot;);
 425         lv.getSelectionModel().select(0);
 426         assertEquals(0, lv.getSelectionModel().getSelectedIndex());
 427         list.remove(0);
 428         assertEquals(-1, lv.getSelectionModel().getSelectedIndex());
 429     }
 430 
 431     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectIndex() {
 432         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 433         assertNull(comboBox.getValue());
 434         sm.select(0);
 435         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 436     }
 437 
 438     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectItem() {
 439         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 440         assertNull(comboBox.getValue());
 441         sm.select(&quot;Apple&quot;);
 442         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 443     }
 444 
 445     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectPrevious() {
 446         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 447         assertNull(comboBox.getValue());
 448         sm.select(2);
 449         sm.selectPrevious();
 450         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 451     }
 452 
 453     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectNext() {
 454         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 455         assertNull(comboBox.getValue());
 456         sm.select(&quot;Apple&quot;);
 457         sm.selectNext();
 458         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 459     }
 460 
 461     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectFirst() {
 462         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 463         assertNull(comboBox.getValue());
 464         sm.selectFirst();
 465         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 466     }
 467 
 468     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectLast() {
 469         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 470         assertNull(comboBox.getValue());
 471         sm.selectLast();
 472         assertEquals(&quot;Banana&quot;, comboBox.getValue());
 473     }
 474 
 475     @Test public void ensureSelectionModelClearsValueProperty() {
 476         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 477         assertNull(comboBox.getValue());
 478         sm.select(0);
 479         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 480 
 481         sm.clearSelection();
 482         assertNull(comboBox.getValue());
 483     }
 484 
 485     @Test public void ensureSelectionModelClearsValuePropertyWhenNegativeOneSelected() {
 486         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 487         assertNull(comboBox.getValue());
 488         sm.select(0);
 489         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 490 
 491         sm.select(-1);
 492         assertNull(&quot;Expected null, actual value: &quot; + comboBox.getValue(), comboBox.getValue());
 493     }
 494 
 495     @Test public void ensureValueIsCorrectWhenItemsIsAddedToWithExistingSelection() {
 496         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 497         sm.select(1);
 498 
 499         comboBox.getItems().add(0, &quot;Kiwifruit&quot;);
 500 
 501         assertEquals(2, sm.getSelectedIndex());
 502         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 503         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 504     }
 505 
 506     @Test public void ensureValueIsCorrectWhenItemsAreRemovedWithExistingSelection() {
 507         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 508         sm.select(1);
 509 
 510         comboBox.getItems().remove(&quot;Apple&quot;);
 511 
 512         assertEquals(0, sm.getSelectedIndex());
 513         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 514         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 515     }
 516 
 517     @Test public void ensureValueIsUpdatedByCorrectSelectionModelWhenSelectionModelIsChanged() {
 518         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 519         SingleSelectionModel sm1 = sm;
 520         sm1.select(1);
 521         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 522 
 523         SingleSelectionModel sm2 = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 524         comboBox.setSelectionModel(sm2);
 525 
 526         sm1.select(2);  // value should not change as we are using old SM
 527         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 528 
 529         sm2.select(0);  // value should change, as we are using new SM
 530         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 531     }
 532 
 533     @Test public void ensureValueDoesNotChangeWhenBoundAndNoExceptions() {
 534         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 535 
 536         StringProperty sp = new SimpleStringProperty(&quot;empty&quot;);
 537         comboBox.valueProperty().bind(sp);
 538 
 539         sm.select(1);
 540         assertEquals(&quot;empty&quot;, comboBox.getValue());
 541     }
 542 
 543     @Test public void ensureSelectionModelUpdatesWhenValueChanges() {
 544         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 545         assertNull(sm.getSelectedItem());
 546         comboBox.setValue(&quot;Orange&quot;);
 547         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 548     }
 549 
 550     @Test public void ensureSelectionModelUpdatesWhenValueChangesToNull() {
 551         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 552         comboBox.setValue(&quot;Kiwifruit&quot;);
 553         assertEquals(&quot;Kiwifruit&quot;, sm.getSelectedItem());
 554         assertEquals(&quot;Kiwifruit&quot;, comboBox.getValue());
 555         comboBox.setValue(null);
 556         assertEquals(null, sm.getSelectedItem());
 557         assertEquals(-1, sm.getSelectedIndex());
 558         assertEquals(null, comboBox.getValue());
 559     }
 560 
 561     @Test public void ensureValueEqualsSelectedItemWhenNotInItemsList() {
 562         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 563         SelectionModelShim.setSelectedItem(sm, &quot;pineapple&quot;);
 564         assertEquals(&quot;pineapple&quot;, sm.getSelectedItem());
 565         assertEquals(&quot;pineapple&quot;, comboBox.getValue());
 566     }
 567 
 568     /*********************************************************************
 569      * Tests for default values                                         *
 570      ********************************************************************/
 571 
 572     @Test public void checkPromptTextPropertyName() {
 573         assertTrue(comboBox.promptTextProperty().getName().equals(&quot;promptText&quot;));
 574     }
 575 
 576     @Test public void checkPlaceholderPropertyName() {
 577         assertTrue(comboBox.placeholderProperty().getName().equals(&quot;placeholder&quot;));
 578     }
 579 
 580     @Test public void checkValuePropertyName() {
 581         assertTrue(comboBox.valueProperty().getName().equals(&quot;value&quot;));
 582     }
 583 
 584     @Test public void checkItemsPropertyName() {
 585         assertTrue(comboBox.itemsProperty().getName().equals(&quot;items&quot;));
 586     }
 587 
 588     @Test public void checkConverterPropertyName() {
 589         assertTrue(comboBox.converterProperty().getName().equals(&quot;converter&quot;));
 590     }
 591 
 592     @Test public void checkSelectionModelPropertyName() {
 593         assertTrue(comboBox.selectionModelProperty().getName().equals(&quot;selectionModel&quot;));
 594     }
 595 
 596     @Test public void checkVisibleRowCountPropertyName() {
 597         assertTrue(comboBox.visibleRowCountProperty().getName().equals(&quot;visibleRowCount&quot;));
 598     }
 599 
 600     @Test public void checkOnActionPropertyName() {
 601         assertTrue(comboBox.onActionProperty().getName().equals(&quot;onAction&quot;));
 602     }
 603 
 604     @Test public void checkArmedPropertyName() {
 605         assertTrue(comboBox.armedProperty().getName().equals(&quot;armed&quot;));
 606     }
 607 
 608     @Test public void checkShowingPropertyName() {
 609         assertTrue(comboBox.showingProperty().getName().equals(&quot;showing&quot;));
 610     }
 611 
 612     @Test public void checkEditablePropertyName() {
 613         assertTrue(comboBox.editableProperty().getName().equals(&quot;editable&quot;));
 614     }
 615 
 616     @Test public void checkCellFactoryPropertyName() {
 617         assertTrue(comboBox.cellFactoryProperty().getName().equals(&quot;cellFactory&quot;));
 618     }
 619 
 620     @Test public void defaultActionHandlerIsNotDefined() {
 621         assertNull(comboBox.getOnAction());
 622     }
 623 
 624     @Test public void defaultConverterCanHandleStringValues() {
 625         StringConverter&lt;String&gt; sc = comboBox.getConverter();
 626         assertEquals(&quot;input&quot;, sc.fromString(&quot;input&quot;));
 627         assertEquals(&quot;input&quot;, sc.toString(&quot;input&quot;));
 628     }
 629 
 630     @Test public void defaultConverterCanHandleIncorrectType_1() {
 631         ComboBox cb = new ComboBox();
 632         StringConverter sc = cb.getConverter();
 633         assertEquals(&quot;42&quot;, sc.toString(new Integer(42)));
 634     }
 635 
 636     @Test(expected=ClassCastException.class)
 637     public void defaultConverterCanHandleIncorrectType_2() {
 638         ComboBox&lt;Integer&gt; cb = new ComboBox&lt;Integer&gt;();
 639         StringConverter&lt;Integer&gt; sc = cb.getConverter();
 640         Integer value = sc.fromString(&quot;42&quot;);
 641     }
 642 
 643     @Test public void defaultConverterCanHandleNullValues() {
 644         StringConverter&lt;String&gt; sc = comboBox.getConverter();
 645         assertEquals(null, sc.fromString(null));
 646         assertEquals(null, sc.toString(null));
 647     }
 648 
 649     @Test public void ensureImpl_getPseudoClassStateReturnsValidValue() {
 650         Stage stage = new Stage();
 651         Scene scene = new Scene(comboBox);
 652         stage.setScene(scene);
 653 
 654         Set&lt;PseudoClass&gt; pseudoClassStates = comboBox.getPseudoClassStates();
 655         assertFalse(comboBox.isEditable());
 656         assertTrue(pseudoClassStates.size() &gt;= 0);
 657 
 658         comboBox.setEditable(true);
 659         pseudoClassStates = comboBox.getPseudoClassStates();
 660         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;editable&quot;)));
 661 
 662         comboBox.setEditable(false);
 663         pseudoClassStates = comboBox.getPseudoClassStates();
 664         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;editable&quot;)) == false);
 665 
 666         comboBox.show();
 667         pseudoClassStates = comboBox.getPseudoClassStates();
 668         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;showing&quot;)));
 669 
 670         comboBox.hide();
 671         pseudoClassStates = comboBox.getPseudoClassStates();
 672         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;showing&quot;)) == false);
 673 
 674         comboBox.arm();
 675         pseudoClassStates = comboBox.getPseudoClassStates();
 676         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;armed&quot;)));
 677 
 678     }
 679 
 680     /*********************************************************************
 681      * Tests for properties                                              *
 682      ********************************************************************/
 683 
 684     @Test public void ensureAllowsNullConverter() {
 685         comboBox.setConverter(null);
 686         assertNull(comboBox.getConverter());
 687     }
 688 
 689     @Test public void ensureCanSetNonNullCellFactory() {
 690         Callback&lt;ListView&lt;String&gt;, ListCell&lt;String&gt;&gt; cf = p -&gt; null;
 691         comboBox.setCellFactory(cf);
 692         assertEquals(cf, comboBox.getCellFactory());
 693     }
 694 
 695     @Test public void ensureEditorIsNonNullWhenComboBoxIsNotEditable() {
 696         assertNotNull(comboBox.getEditor());
 697     }
 698 
 699     @Test public void ensureEditorIsNonNullWhenComboBoxIsEditable() {
 700         comboBox.setEditable(true);
 701         assertNotNull(comboBox.getEditor());
 702     }
 703 
 704     @Test public void ensureEditorDoesNotChangeWhenEditableToggles() {
 705         comboBox.setEditable(true);
 706         assertNotNull(comboBox.getEditor());
 707         comboBox.setEditable(false);
 708         assertNotNull(comboBox.getEditor());
 709         comboBox.setEditable(true);
 710         assertNotNull(comboBox.getEditor());
 711     }
 712 
 713     @Test public void ensureCanSetValueToNonNullStringAndBackAgain() {
 714         comboBox.setValue(&quot;Test 123&quot;);
 715         assertEquals(&quot;Test 123&quot;, comboBox.getValue());
 716         comboBox.setValue(null);
 717         assertNull(comboBox.getValue());
 718     }
 719 
 720     @Test public void ensureCanToggleEditable() {
 721         comboBox.setEditable(true);
 722         assertTrue(comboBox.isEditable());
 723         comboBox.setEditable(false);
 724         assertFalse(comboBox.isEditable());
 725     }
 726 
 727     @Test public void ensureCanToggleShowing() {
 728         Stage stage = new Stage();
 729         Scene scene = new Scene(comboBox);
 730         stage.setScene(scene);
 731 
 732         comboBox.show();
 733         assertTrue(comboBox.isShowing());
 734         comboBox.hide();
 735         assertFalse(comboBox.isShowing());
 736     }
 737 
 738     @Test public void ensureCanNotToggleShowingWhenDisabled() {
 739         Stage stage = new Stage();
 740         Scene scene = new Scene(comboBox);
 741         stage.setScene(scene);
 742 
 743         comboBox.setDisable(true);
 744         comboBox.show();
 745         assertFalse(comboBox.isShowing());
 746         comboBox.setDisable(false);
 747         comboBox.show();
 748         assertTrue(comboBox.isShowing());
 749     }
 750 
 751     @Test public void ensureCanSetPromptText() {
 752         comboBox.setPromptText(&quot;Test 1 2 3&quot;);
 753         assertEquals(&quot;Test 1 2 3&quot;, comboBox.getPromptText());
 754     }
 755 
 756     @Test public void ensureCanSetPromptTextToNull() {
 757         comboBox.setPromptText(&quot;&quot;);
 758         assertEquals(&quot;&quot;, comboBox.getPromptText());
 759         comboBox.setPromptText(null);
 760         assertEquals(null, comboBox.getPromptText());
 761     }
 762 
 763     @Test public void ensurePromptTextStripsNewlines() {
 764         comboBox.setPromptText(&quot;Test\n1\n2\n3&quot;);
 765         assertEquals(&quot;Test123&quot;, comboBox.getPromptText());
 766     }
 767 
 768     @Test public void ensureCanSetPlaceholder() {
 769         Label label = new javafx.scene.control.Label(&quot;Test 1 2 3&quot;);
 770         comboBox.setPlaceholder(label);
 771         assertEquals(label, comboBox.getPlaceholder());
 772     }
 773 
 774     @Test public void ensureCanToggleArmed() {
 775         assertFalse(comboBox.isArmed());
 776         comboBox.arm();
 777         assertTrue(comboBox.isArmed());
 778         comboBox.disarm();
 779         assertFalse(comboBox.isArmed());
 780     }
 781 
 782     @Test public void ensureCanSetVisibleRowCount() {
 783         comboBox.setVisibleRowCount(13);
 784         assertEquals(13, comboBox.getVisibleRowCount());
 785     }
 786 
 787     @Test public void ensureCanSetVisibleRowCountToNegativeValues() {
 788         comboBox.setVisibleRowCount(-10);
 789         assertEquals(-10, comboBox.getVisibleRowCount());
 790     }
 791 
 792     @Test public void ensureCanSetOnAction() {
 793         EventHandler&lt;ActionEvent&gt; onAction = t -&gt; { };
 794         comboBox.setOnAction(onAction);
 795         assertEquals(onAction, comboBox.getOnAction());
 796     }
 797 
 798     @Test public void ensureOnActionPropertyReferencesBean() {
 799         assertEquals(comboBox, comboBox.onActionProperty().getBean());
 800     }
 801 
 802     /*********************************************************************
 803      * Tests for property binding                                        *
 804      ********************************************************************/
 805     @Test public void checkPromptTextPropertyBind() {
 806         StringProperty strPr = new SimpleStringProperty(&quot;value&quot;);
 807         comboBox.promptTextProperty().bind(strPr);
 808         assertTrue(&quot;PromptText cannot be bound&quot;, comboBox.getPromptText().equals(&quot;value&quot;));
 809         strPr.setValue(&quot;newvalue&quot;);
 810         assertTrue(&quot;PromptText cannot be bound&quot;, comboBox.getPromptText().equals(&quot;newvalue&quot;));
 811     }
 812 
 813     @Test public void checkValuePropertyBind() {
 814         StringProperty strPr = new SimpleStringProperty(&quot;value&quot;);
 815         comboBox.valueProperty().bind(strPr);
 816         assertTrue(&quot;value cannot be bound&quot;, comboBox.getValue().equals(&quot;value&quot;));
 817         strPr.setValue(&quot;newvalue&quot;);
 818         assertTrue(&quot;value cannot be bound&quot;, comboBox.getValue().equals(&quot;newvalue&quot;));
 819     }
 820 
 821 
 822 
 823     /*********************************************************************
 824      * Tests for bug reports                                             *
 825      ********************************************************************/
 826 
 827     @Test public void test_rt18972() {
 828         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 829         sm.select(1);
 830         assertTrue(sm.isSelected(1));
 831 
 832         comboBox.setEditable(true);
 833         comboBox.setValue(&quot;New Value&quot;);
 834 
 835         // there should be no selection in the selection model, as &quot;New Value&quot;
 836         // isn&#39;t an item in the list, however, it is a totally valid value for
 837         // the value property
 838         assertFalse(sm.isSelected(1));
 839         assertEquals(&quot;New Value&quot;, sm.getSelectedItem());
 840         assertEquals(&quot;New Value&quot;, comboBox.getValue());
 841 
 842         comboBox.setEditable(false);
 843         assertEquals(-1, sm.getSelectedIndex());
 844         assertEquals(&quot;New Value&quot;, sm.getSelectedItem());
 845         assertEquals(&quot;New Value&quot;, comboBox.getValue());
 846     }
 847 
 848     @Test public void test_rt18941() {
 849         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 850         comboBox.setValue(&quot;Orange&quot;);
 851         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 852         assertEquals(&quot;Orange&quot;, comboBox.getSelectionModel().getSelectedItem());
 853         assertTrue(&quot;Selected Index: &quot; + sm.getSelectedIndex(), sm.isSelected(1));
 854     }
 855 
 856     @Test public void test_rt19227() {
 857         comboBox.getItems().addAll(&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;);
 858         comboBox.getSelectionModel().select(2);
 859         assertEquals(&quot;0&quot;, comboBox.getValue());
 860         assertEquals(&quot;0&quot;, comboBox.getSelectionModel().getSelectedItem());
 861         assertTrue(sm.isSelected(2));
 862     }
 863 
 864     @Ignore(&quot;JDK-8091127 Test not working as the heights being returned are not accurate&quot;)
 865     @Test public void test_rt20106() {
 866         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 867 
 868         Stage stage = new Stage();
 869         Scene scene = new Scene(comboBox);
 870         stage.setScene(scene);
 871         comboBox.applyCss();
 872         comboBox.show();
 873 
 874         comboBox.setVisibleRowCount(5);
 875         double initialHeight = getListView().getHeight();
 876         assertFalse(&quot;initialHeight: &quot; + initialHeight, Double.compare(0.0, initialHeight) == 0);
 877 
 878         comboBox.setVisibleRowCount(0);
 879         double smallHeight =    getListView().getHeight();
 880         assertTrue(&quot;smallHeight: &quot; + smallHeight + &quot;, initialHeight: &quot; + initialHeight,
 881                 smallHeight != initialHeight &amp;&amp; smallHeight &lt; initialHeight);
 882 
 883         comboBox.setVisibleRowCount(7);
 884         double biggerHeight = getListView().getHeight();
 885         assertTrue(biggerHeight != smallHeight &amp;&amp; smallHeight &lt; biggerHeight);
 886     }
 887 
 888     private int count = 0;
 889     @Test public void test_rt20103() {
 890         final TextField tf = new TextField();
 891 
 892         comboBox.setOnAction(t -&gt; {
 893             count++;
 894         });
 895 
 896         assertTrue(count == 0);
 897 
 898         comboBox.valueProperty().bind(tf.textProperty());   // count++ here
 899         assertTrue(&quot;count: &quot; + count, count == 1);
 900 
 901         tf.setText(&quot;Text1&quot;);                                // count++ here
 902         assertTrue(&quot;count: &quot; + count, count == 2);
 903 
 904         comboBox.valueProperty().unbind();                  // no count++ here
 905         assertTrue(&quot;count: &quot; + count, count == 2);
 906 
 907         comboBox.valueProperty().bindBidirectional(tf.textProperty());  // count++ here
 908         tf.setText(&quot;Text2&quot;);
 909         assertTrue(&quot;count: &quot; + count, count == 3);
 910     }
 911 
 912     @Ignore(&quot;Test not working as the skin is not being properly instantiated&quot;)
 913     @Test public void test_rt20100() {
 914         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 915 
 916         Stage stage = new Stage();
 917         Scene scene = new Scene(comboBox);
 918         stage.setScene(scene);
 919         comboBox.applyCss();
 920         comboBox.show();
 921 
 922         comboBox.setConverter(new StringConverter() {
 923             int toStringCounter = 0;
 924             int fromStringCounter = 0;
 925 
 926             @Override public String toString(Object t) {
 927                 return &quot;TO_STRING&quot;;
 928             }
 929 
 930             @Override public Object fromString(String string) {
 931                 return &quot;FROM_STRING&quot;;
 932             }
 933         });
 934 
 935         comboBox.getSelectionModel().select(2);
 936         assertEquals(&quot;2&quot;, comboBox.getValue());
 937 
 938         ListView listView = getListView();
 939 //        listView.applyCss();
 940 
 941         assertEquals(&quot;2&quot;, listView.getSelectionModel().getSelectedItem());
 942 
 943         System.out.println(listView.getSkin());
 944 
 945         VirtualFlow flow = (VirtualFlow)listView.lookup(&quot;#virtual-flow&quot;);
 946         assertNotNull(flow);
 947 
 948         IndexedCell cell = flow.getVisibleCell(2);
 949         System.out.println(&quot;cell: &quot; + cell);
 950         assertEquals(&quot;TO_STRING&quot;, cell.getText());
 951     }
 952 
 953     @Test public void test_rt20189() {
 954         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 955 
 956         Stage stage = new Stage();
 957         Scene scene = new Scene(comboBox);
 958         stage.setScene(scene);
 959         comboBox.applyCss();
 960         comboBox.show();
 961 
 962         comboBox.getSelectionModel().select(2);
 963         Object item = sm.getSelectedItem();
 964         assertEquals(&quot;2&quot;, item);
 965         assertEquals(2, sm.getSelectedIndex());
 966 
 967         comboBox.setValue(&quot;test&quot;);
 968         item = sm.getSelectedItem();
 969         assertEquals(&quot;test&quot;,item);
 970         assertEquals(-1, sm.getSelectedIndex());
 971 
 972         comboBox.getSelectionModel().select(2);
 973         item = sm.getSelectedItem();
 974         assertEquals(&quot;2&quot;, item);
 975         assertEquals(2, sm.getSelectedIndex());
 976     }
 977 
 978     @Test public void test_rt27654() {
 979         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 980 
 981         SingleSelectionModel sm = comboBox.getSelectionModel();
 982 
 983         Stage stage = new Stage();
 984         Scene scene = new Scene(comboBox);
 985         stage.setScene(scene);
 986         comboBox.applyCss();
 987         comboBox.show();
 988         ListCell&lt;String&gt; buttonCell = (ListCell&lt;String&gt;) getDisplayNode();
 989 
 990         sm.select(2);
 991         assertEquals(&quot;2&quot;, sm.getSelectedItem());
 992         assertEquals(&quot;2&quot;, comboBox.getValue());
 993         assertEquals(&quot;2&quot;, buttonCell.getText());
 994         assertEquals(2, sm.getSelectedIndex());
 995 
 996         sm.clearSelection();
 997         assertNull(sm.getSelectedItem());
 998         assertNull(comboBox.getValue());
 999         assertNull(buttonCell.getText());
1000         assertEquals(-1, sm.getSelectedIndex());
1001 
1002         sm.select(2);
1003         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1004         assertEquals(&quot;2&quot;, comboBox.getValue());
1005         assertEquals(&quot;2&quot;, buttonCell.getText());
1006         assertEquals(2, sm.getSelectedIndex());
1007     }
1008 
1009     @Test public void test_rt24412() {
1010         SingleSelectionModel sm = comboBox.getSelectionModel();
1011 
1012         Stage stage = new Stage();
1013         Scene scene = new Scene(comboBox);
1014         stage.setScene(scene);
1015         comboBox.applyCss();
1016         comboBox.show();
1017         ListCell&lt;String&gt; buttonCell = (ListCell&lt;String&gt;) getDisplayNode();
1018 
1019         comboBox.getItems().setAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
1020 
1021         sm.select(&quot;2&quot;);
1022         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1023         assertEquals(&quot;2&quot;, comboBox.getValue());
1024         assertEquals(&quot;2&quot;, buttonCell.getText());
1025         assertEquals(2, sm.getSelectedIndex());
1026 
1027         sm.clearSelection();
1028         assertNull(sm.getSelectedItem());
1029         assertNull(comboBox.getValue());
1030         assertNull(buttonCell.getText());
1031         assertEquals(-1, sm.getSelectedIndex());
1032 
1033         sm.select(&quot;2&quot;);
1034         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1035         assertEquals(&quot;2&quot;, comboBox.getValue());
1036         assertEquals(&quot;2&quot;, buttonCell.getText());
1037         assertEquals(2, sm.getSelectedIndex());
1038     }
1039 
1040     @Test public void test_rt28245() {
1041         final ObservableList&lt;String&gt; strings = FXCollections.observableArrayList(
1042             &quot;Option 1&quot;, &quot;Option 2&quot;, &quot;Option 3&quot;
1043         );
1044 
1045         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;String&gt;();
1046         comboBox.setItems(strings);
1047         comboBox.setEditable(true);
1048         comboBox.valueProperty().addListener((ov, t, t1) -&gt; {
1049             if (t == null &amp;&amp; t1.isEmpty()) {
1050                 fail(&quot;Old value is &#39;&quot; + t + &quot;&#39; and new value is &#39;&quot; + t1 + &quot;&#39;.&quot;);
1051             }
1052         });
1053 
1054         StageLoader sl = new StageLoader(comboBox);
1055 
1056         assertNull(comboBox.getValue());
1057         assertTrue(comboBox.getEditor().getText().isEmpty());
1058 
1059         comboBox.requestFocus();
1060 
1061         new KeyEventFirer(comboBox).doKeyPress(KeyCode.ENTER);
1062 
1063         sl.dispose();
1064     }
1065 
1066     @Test public void test_rt31479() {
1067         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;String&gt;();
1068 
1069         StageLoader sl = new StageLoader(comboBox);
1070 
1071         final double widthBefore = comboBox.getWidth();
1072 
1073         // add item
1074         comboBox.getItems().add(&quot;Option 1&quot;);
1075 
1076         // open and close combobox
1077         comboBox.show();
1078         comboBox.hide();
1079 
1080         // set a placeholder
1081         comboBox.setPlaceholder(new Circle(12, Color.RED));
1082 
1083         // remove item
1084         comboBox.getItems().clear();
1085 
1086         // fire pulse (this allows layout to cause the size to grow)
1087         Toolkit.getToolkit().firePulse();
1088 
1089         // test size
1090         assertEquals(widthBefore, comboBox.getWidth(), 0.00);
1091 
1092         sl.dispose();
1093     }
1094 
1095     @Test public void test_rt32139() {
1096         final ObservableList&lt;String&gt; items =
1097                 FXCollections.observableArrayList(&quot;Good value&quot;, &quot;Bad value&quot;);
1098 
1099         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1100         comboBox.getSelectionModel().select(0);
1101 
1102         comboBox.getSelectionModel().selectedIndexProperty().addListener((ov, oldIdx, newIdx) -&gt; {
1103             if (newIdx.intValue() != 0) {
1104                 comboBox.getSelectionModel().select(0);
1105             }
1106         });
1107 
1108         StageLoader sl = new StageLoader(comboBox);
1109 
1110         try {
1111             comboBox.getSelectionModel().select(1);
1112         } catch (StackOverflowError e) {
1113             fail(&quot;Stack overflow should not happen here&quot;);
1114         }
1115 
1116         sl.dispose();
1117     }
1118 
1119     @Test public void test_rt21186() {
1120         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1121         comboBox.setEditable(true);
1122 
1123         StageLoader sl = new StageLoader(comboBox);
1124 
1125         assertNull(comboBox.getTooltip());
1126         assertNull(comboBox.getEditor().getTooltip());
1127 
1128         Tooltip tooltip = new Tooltip(&quot;Tooltip&quot;);
1129         comboBox.setTooltip(tooltip);
1130         assertEquals(tooltip, comboBox.getTooltip());
1131         assertEquals(tooltip, comboBox.getEditor().getTooltip());
1132 
1133         comboBox.setTooltip(null);
1134         assertNull(comboBox.getTooltip());
1135         assertNull(comboBox.getEditor().getTooltip());
1136 
1137         sl.dispose();
1138     }
1139 
1140     @Test public void test_rt34573() {
1141         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1142 
1143         final ListCell&lt;String&gt; customCell = new ListCellShim&lt;String&gt;() {
1144             @Override public void updateItem(String item, boolean empty) {
1145                 super.updateItem(item, empty);
1146                 setText(item);
1147             }
1148         };
1149         comboBox.setButtonCell(customCell);
1150 
1151         StageLoader sl = new StageLoader(comboBox);
1152 
1153         comboBox.setItems(FXCollections.observableArrayList(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;));
1154         comboBox.setValue(&quot;B&quot;);
1155         assertEquals(&quot;B&quot;, comboBox.getButtonCell().getText());
1156         assertEquals(1, comboBox.getButtonCell().getIndex());
1157 
1158         comboBox.setItems(FXCollections.observableArrayList(&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;));
1159         assertNull(comboBox.getButtonCell().getText());
1160         assertEquals(-1, comboBox.getButtonCell().getIndex());
1161 
1162         sl.dispose();
1163     }
1164 
1165     @Test public void test_rt34566() {
1166         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1167 
1168         final ListCell&lt;String&gt; customCell = new ListCellShim&lt;String&gt;() {
1169             @Override public void updateItem(String item, boolean empty) {
1170                 super.updateItem(item, empty);
1171                 setText(item);
1172             }
1173         };
1174         comboBox.setButtonCell(customCell);
1175 
1176         StageLoader sl = new StageLoader(comboBox);
1177 
1178         comboBox.setItems(FXCollections.observableArrayList(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;));
1179 
1180         PseudoClass empty = PseudoClass.getPseudoClass(&quot;empty&quot;);
1181 
1182         comboBox.setValue(&quot;B&quot;);
1183         assertEquals(&quot;B&quot;, comboBox.getButtonCell().getText());
1184         assertEquals(1, comboBox.getButtonCell().getIndex());
1185         assertFalse(customCell.getPseudoClassStates().contains(empty));
1186 
1187         comboBox.setValue(null);
1188         Toolkit.getToolkit().firePulse();
1189         assertNull(comboBox.getButtonCell().getText());
1190         assertEquals(-1, comboBox.getButtonCell().getIndex());
1191         assertTrue(customCell.getPseudoClassStates().contains(empty));
1192 
1193         comboBox.setValue(&quot;A&quot;);
1194         assertEquals(&quot;A&quot;, comboBox.getButtonCell().getText());
1195         assertEquals(0, comboBox.getButtonCell().getIndex());
1196         assertFalse(customCell.getPseudoClassStates().contains(empty));
1197 
1198         sl.dispose();
1199     }
1200 
1201     private int test_rt34603_count = 0;
1202     @Test public void test_rt34603() {
1203         assertEquals(0, test_rt34603_count);
1204 
1205         VBox hbox = new VBox(10);
1206 
1207         ComboBox&lt;String&gt; box = new ComboBox&lt;&gt;();
1208         box.getItems().add(&quot;test&quot;);
1209         box.setEditable(true);
1210         box.getSelectionModel().selectFirst();
1211 
1212         Button defaultButton = new Button(&quot;press&quot;);
1213         defaultButton.setOnAction(arg0 -&gt; {
1214             test_rt34603_count++;
1215         });
1216         defaultButton.setDefaultButton(true);
1217 
1218         hbox.getChildren().addAll(box, defaultButton);
1219 
1220         StageLoader sl = new StageLoader(hbox);
1221 
1222         box.getEditor().requestFocus();
1223         KeyEventFirer keyboard = new KeyEventFirer(box);
1224         keyboard.doKeyPress(KeyCode.ENTER);
1225 
1226         assertEquals(1, test_rt34603_count);
1227 
1228         sl.dispose();
1229     }
1230 
1231     private int test_rt35586_count = 0;
1232     @Test public void test_rt35586() {
1233         assertEquals(0, test_rt35586_count);
1234 
1235         final ComboBox&lt;String&gt; cb = new ComboBox&lt;String&gt;();
1236         cb.setEditable(true);
1237         cb.setOnAction(event -&gt; {
1238             test_rt35586_count++;
1239             assertEquals(&quot;Test&quot;, cb.getEditor().getText());
1240         });
1241 
1242         StageLoader sl = new StageLoader(cb);
1243 
1244         cb.requestFocus();
1245         cb.getEditor().setText(&quot;Test&quot;);
1246         KeyEventFirer keyboard = new KeyEventFirer(cb);
1247         keyboard.doKeyPress(KeyCode.ENTER);
1248 
1249         assertEquals(1, test_rt35586_count);
1250 
1251         sl.dispose();
1252     }
1253 
1254     @Test public void test_rt35039() {
1255         final List&lt;String&gt; data = new ArrayList&lt;&gt;();
1256         data.add(&quot;aabbaa&quot;);
1257         data.add(&quot;bbc&quot;);
1258 
1259         final ComboBox&lt;String&gt; combo = new ComboBox&lt;&gt;();
1260         combo.setEditable(true);
1261         combo.setItems(FXCollections.observableArrayList(data));
1262 
1263         StageLoader sl = new StageLoader(combo);
1264 
1265         // everything should be null to start with
1266         assertNull(combo.getValue());
1267         assertTrue(combo.getEditor().getText().isEmpty());
1268         assertNull(combo.getSelectionModel().getSelectedItem());
1269 
1270         // select &quot;bbc&quot; and ensure everything is set to that
1271         combo.getSelectionModel().select(1);
1272         assertEquals(&quot;bbc&quot;, combo.getValue());
1273         assertEquals(&quot;bbc&quot;, combo.getEditor().getText());
1274         assertEquals(&quot;bbc&quot;, combo.getSelectionModel().getSelectedItem());
1275 
1276         // change the items list - but retain the same content. We expect
1277         // that &quot;bbc&quot; remains selected as it is still in the list
1278         combo.setItems(FXCollections.observableArrayList(data));
1279         assertEquals(&quot;bbc&quot;, combo.getValue());
1280         assertEquals(&quot;bbc&quot;, combo.getEditor().getText());
1281         assertEquals(&quot;bbc&quot;, combo.getSelectionModel().getSelectedItem());
1282 
1283         sl.dispose();
1284     }
1285 
1286     @Test public void test_rt35840() {
1287         final ComboBox&lt;String&gt; cb = new ComboBox&lt;String&gt;();
1288         cb.setEditable(true);
1289         StageLoader sl = new StageLoader(cb);
1290         cb.requestFocus();
1291 
1292         KeyEventFirer keyboard = new KeyEventFirer(cb);
1293         keyboard.doKeyTyped(KeyCode.T);
1294         keyboard.doKeyTyped(KeyCode.E);
1295         keyboard.doKeyTyped(KeyCode.S);
1296         keyboard.doKeyTyped(KeyCode.T);
1297         assertEquals(&quot;TEST&quot;, cb.getEditor().getText());
1298 
1299         assertNull(cb.getValue());
1300         keyboard.doKeyPress(KeyCode.ENTER);
1301         assertEquals(&quot;TEST&quot;, cb.getValue());
1302 
1303         sl.dispose();
1304     }
1305 
1306     @Test public void test_rt36280_nonEditable_F4ShowsPopup() {
1307         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1308         StageLoader sl = new StageLoader(cb);
1309         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1310 
1311         assertFalse(cb.isShowing());
1312         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1313         assertTrue(cb.isShowing());
1314 
1315         sl.dispose();
1316     }
1317 
1318     @Test public void test_rt36280_nonEditable_altUpShowsPopup() {
1319         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1320         StageLoader sl = new StageLoader(cb);
1321         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1322 
1323         assertFalse(cb.isShowing());
1324         cbKeyboard.doKeyPress(KeyCode.UP, KeyModifier.ALT);  // show the popup
1325         assertTrue(cb.isShowing());
1326 
1327         sl.dispose();
1328     }
1329 
1330     @Test public void test_rt36280_nonEditable_altDownShowsPopup() {
1331         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1332         StageLoader sl = new StageLoader(cb);
1333         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1334 
1335         new StageLoader(cb);
1336 
1337         assertFalse(cb.isShowing());
1338         cbKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1339         assertTrue(cb.isShowing());
1340 
1341         sl.dispose();
1342     }
1343 
1344     @Test public void test_rt36280_nonEditable_enterHidesShowingPopup() {
1345         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1346         StageLoader sl = new StageLoader(cb);
1347         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1348 
1349         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1350         assertNotNull(listView);
1351 
1352         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1353 
1354         assertFalse(cb.isShowing());
1355         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1356         assertTrue(cb.isShowing());
1357         lvKeyboard.doKeyPress(KeyCode.ENTER);  // hide the popup
1358         assertFalse(cb.isShowing());
1359 
1360         sl.dispose();
1361     }
1362 
1363     @Test public void test_rt36280_nonEditable_spaceHidesShowingPopup() {
1364         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1365         StageLoader sl = new StageLoader(cb);
1366         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1367 
1368         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1369         assertNotNull(listView);
1370 
1371         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1372 
1373         assertFalse(cb.isShowing());
1374         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1375         assertTrue(cb.isShowing());
1376         lvKeyboard.doKeyPress(KeyCode.SPACE);  // hide the popup
1377         assertFalse(cb.isShowing());
1378 
1379         sl.dispose();
1380     }
1381 
1382     @Test public void test_rt36280_nonEditable_escapeHidesShowingPopup() {
1383         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1384         StageLoader sl = new StageLoader(cb);
1385         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1386 
1387         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1388         assertNotNull(listView);
1389 
1390         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1391 
1392         assertFalse(cb.isShowing());
1393         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1394         assertTrue(cb.isShowing());
1395         lvKeyboard.doKeyPress(KeyCode.ESCAPE);  // hide the popup
1396         assertFalse(cb.isShowing());
1397 
1398         sl.dispose();
1399     }
1400 
1401     @Test public void test_rt36280_nonEditable_F4HidesShowingPopup() {
1402         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1403         StageLoader sl = new StageLoader(cb);
1404         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1405 
1406         assertFalse(cb.isShowing());
1407         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1408         assertTrue(cb.isShowing());
1409         cbKeyboard.doKeyPress(KeyCode.F4);  // hide the popup
1410         assertFalse(cb.isShowing());
1411 
1412         sl.dispose();
1413     }
1414 
1415     @Test public void test_rt36280_nonEditable_arrowKeysChangeSelection() {
1416         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1417         StageLoader sl = new StageLoader(cb);
1418         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1419 
1420         assertFalse(cb.isShowing());
1421         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1422         assertTrue(cb.isShowing());
1423 
1424         assertNull(cb.getSelectionModel().getSelectedItem());
1425 
1426         cbKeyboard.doDownArrowPress();
1427         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1428 
1429         cbKeyboard.doDownArrowPress();
1430         assertEquals(&quot;b&quot;, cb.getSelectionModel().getSelectedItem());
1431 
1432         cbKeyboard.doUpArrowPress();
1433         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1434 
1435         sl.dispose();
1436     }
1437 
1438     @Test public void test_rt36280_editable_F4ShowsPopup() {
1439         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1440         cb.setEditable(true);
1441         StageLoader sl = new StageLoader(cb);
1442         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1443 
1444         assertFalse(cb.isShowing());
1445         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1446         assertTrue(cb.isShowing());
1447 
1448         sl.dispose();
1449     }
1450 
1451     @Test public void test_rt36280_editable_altUpShowsPopup() {
1452         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1453         cb.setEditable(true);
1454         StageLoader sl = new StageLoader(cb);
1455         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1456 
1457         assertFalse(cb.isShowing());
1458         cbKeyboard.doKeyPress(KeyCode.UP, KeyModifier.ALT);  // show the popup
1459         assertTrue(cb.isShowing());
1460 
1461         sl.dispose();
1462     }
1463 
1464     @Test public void test_rt36280_editable_altDownShowsPopup_onComboBox() {
1465         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1466         cb.setEditable(true);
1467         StageLoader sl = new StageLoader(cb);
1468         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1469 
1470         assertFalse(cb.isShowing());
1471         assertTrue(cb.getEditor().getText().isEmpty());
1472         cbKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1473         assertTrue(cb.isShowing());
1474         assertTrue(cb.getEditor().getText().isEmpty());
1475 
1476         sl.dispose();
1477     }
1478 
1479     @Test public void test_rt36280_editable_altDownShowsPopup_onTextField() {
1480         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1481         cb.setEditable(true);
1482         StageLoader sl = new StageLoader(cb);
1483 
1484         KeyEventFirer tfKeyboard = new KeyEventFirer(cb.getEditor());
1485         assertFalse(cb.isShowing());
1486         assertTrue(cb.getEditor().getText().isEmpty());
1487         tfKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1488         assertTrue(cb.isShowing());
1489         assertTrue(cb.getEditor().getText().isEmpty());
1490 
1491         sl.dispose();
1492     }
1493 
1494     @Test public void test_rt36280_editable_enterHidesShowingPopup() {
1495         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1496         cb.setEditable(true);
1497         StageLoader sl = new StageLoader(cb);
1498         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1499 
1500         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1501         assertNotNull(listView);
1502 
1503         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1504 
1505         assertFalse(cb.isShowing());
1506         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1507         assertTrue(cb.isShowing());
1508         lvKeyboard.doKeyPress(KeyCode.ENTER);  // hide the popup
1509         assertFalse(cb.isShowing());
1510 
1511         sl.dispose();
1512     }
1513 
1514     @Test public void test_rt36280_editable_spaceHidesShowingPopup() {
1515         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1516         cb.setEditable(true);
1517         StageLoader sl = new StageLoader(cb);
1518         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1519 
1520         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1521         assertNotNull(listView);
1522 
1523         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1524 
1525         assertFalse(cb.isShowing());
1526         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1527         assertTrue(cb.isShowing());
1528         lvKeyboard.doKeyPress(KeyCode.SPACE);  // hide the popup
1529         assertFalse(cb.isShowing());
1530 
1531         sl.dispose();
1532     }
1533 
1534     @Test public void test_rt36280_editable_escapeHidesShowingPopup() {
1535         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1536         cb.setEditable(true);
1537         StageLoader sl = new StageLoader(cb);
1538         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1539 
1540         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1541         assertNotNull(listView);
1542 
1543         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1544 
1545         assertFalse(cb.isShowing());
1546         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1547         assertTrue(cb.isShowing());
1548         lvKeyboard.doKeyPress(KeyCode.ESCAPE);  // hide the popup
1549         assertFalse(cb.isShowing());
1550 
1551         sl.dispose();
1552     }
1553 
1554     @Test public void test_rt36280_editable_F4HidesShowingPopup() {
1555         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1556         cb.setEditable(true);
1557         StageLoader sl = new StageLoader(cb);
1558         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1559 
1560         assertFalse(cb.isShowing());
1561         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1562         assertTrue(cb.isShowing());
1563         cbKeyboard.doKeyPress(KeyCode.F4);  // hide the popup
1564         assertFalse(cb.isShowing());
1565 
1566         sl.dispose();
1567     }
1568 
1569     @Test public void test_rt36280_editable_arrowKeysChangeSelection() {
1570         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1571         cb.setEditable(true);
1572         StageLoader sl = new StageLoader(cb);
1573         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1574 
1575         assertFalse(cb.isShowing());
1576         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1577         assertTrue(cb.isShowing());
1578 
1579         assertNull(cb.getSelectionModel().getSelectedItem());
1580 
1581         cbKeyboard.doDownArrowPress();
1582         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1583 
1584         cbKeyboard.doDownArrowPress();
1585         assertEquals(&quot;b&quot;, cb.getSelectionModel().getSelectedItem());
1586 
1587         cbKeyboard.doUpArrowPress();
1588         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1589 
1590         sl.dispose();
1591     }
1592 
1593     @Test public void test_rt36651() {
1594         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1595         cb.setEditable(true);
1596         StageLoader sl = new StageLoader(cb);
1597 
1598         assertNull(cb.getValue());
1599         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1600         assertNull(cb.getSelectionModel().getSelectedItem());
1601 
1602         sl.getStage().requestFocus();
1603         cb.show();
1604         Toolkit.getToolkit().firePulse();
1605 
1606         // selection should not change just by showing the popup
1607         assertNull(cb.getValue());
1608         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1609         assertNull(cb.getSelectionModel().getSelectedItem());
1610 
1611         sl.dispose();
1612     }
1613 
1614     @Test public void test_rt36717() {
1615         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1616         StageLoader sl = new StageLoader(cb);
1617 
1618         // the stack overflow only occurs when a ComboBox changes from non-editable to editable
1619         cb.setEditable(false);
1620         cb.setEditable(true);
1621         assertNotNull(cb.getEditor());
1622         KeyEventFirer tfKeyboard = new KeyEventFirer(cb.getEditor());
1623         tfKeyboard.doKeyPress(KeyCode.ENTER);   // Stack overflow here
1624 
1625         sl.dispose();
1626     }
1627 
1628     @Test public void test_rt36827() {
1629         final Button btn = new Button(&quot;focus owner&quot;);
1630         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1631         VBox vbox = new VBox(btn, cb);
1632 
1633         StageLoader sl = new StageLoader(vbox);
1634         sl.getStage().requestFocus();
1635         btn.requestFocus();
1636         Toolkit.getToolkit().firePulse();
1637         Scene scene = sl.getStage().getScene();
1638 
1639         assertTrue(btn.isFocused());
1640         assertEquals(btn, scene.getFocusOwner());
1641 
1642         MouseEventFirer mouse = new MouseEventFirer(cb);
1643         mouse.fireMousePressAndRelease();
1644 
1645         assertTrue(cb.isShowing());
1646         assertTrue(cb.isFocused());
1647         assertEquals(cb, scene.getFocusOwner());
1648 
1649         sl.dispose();
1650     }
1651 
1652     @Test public void test_rt36902() {
1653         final ComboBox&lt;String&gt; cb1 = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1654         final ComboBox&lt;String&gt; cb2 = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1655         cb2.setEditable(true);
1656         VBox vbox = new VBox(cb1, cb2);
1657 
1658         // lame - I would rather have one keyboard here but I couldn&#39;t get it to
1659         // work, so watch out for which keyboard is used below
1660         KeyEventFirer cb1Keyboard = new KeyEventFirer(cb1);
1661         KeyEventFirer cb2Keyboard = new KeyEventFirer(cb2);
1662 
1663         StageLoader sl = new StageLoader(vbox);
1664         sl.getStage().requestFocus();
1665         cb1.requestFocus();
1666         Toolkit.getToolkit().firePulse();
1667         Scene scene = sl.getStage().getScene();
1668 
1669         assertTrue(cb1.isFocused());
1670         assertEquals(cb1, scene.getFocusOwner());
1671 
1672         // move focus forward to cb2
1673         cb1Keyboard.doKeyPress(KeyCode.TAB);
1674         assertTrue(cb2.isFocused());
1675         assertEquals(cb2, scene.getFocusOwner());
1676 
1677         // move focus forward again to cb1
1678         cb2Keyboard.doKeyPress(KeyCode.TAB);
1679         assertTrue(cb1.isFocused());
1680         assertEquals(cb1, scene.getFocusOwner());
1681 
1682         // now start going backwards with shift-tab.
1683         // The first half of the bug is here - when we shift-tab into cb2, we
1684         // actually go into the FakeFocusTextField subcomponent, so whilst the
1685         // cb2.isFocused() returns true as expected, the scene focus owner is
1686         // not the ComboBox, but the FakeFocusTextField inside it
1687         cb1Keyboard.doKeyPress(KeyCode.TAB, KeyModifier.SHIFT);
1688         assertTrue(&quot;Expect cb2 to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1689                 cb2.isFocused());
1690         // Updated with fix for RT-34602: The TextField now never gets
1691         // focus (it&#39;s just faking it).
1692         // assertEquals(&quot;Expect cb2 TextField to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1693         //         cb2.getEditor(), scene.getFocusOwner());
1694         assertEquals(&quot;Expect cb2 to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1695                      cb2, scene.getFocusOwner());
1696 
1697         // This is where the second half of the bug appears, as we are stuck in
1698         // the FakeFocusTextField of cb2, we never make it to cb1
1699         cb2Keyboard.doKeyPress(KeyCode.TAB, KeyModifier.SHIFT);
1700         assertTrue(cb1.isFocused());
1701         assertEquals(cb1, scene.getFocusOwner());
1702 
1703         sl.dispose();
1704     }
1705 
1706     private int rt_38901_counter;
1707     @Test public void test_rt_38901_selectNull() {
1708         test_rt_38901(true);
1709     }
1710 
1711     @Test public void test_rt_38901_selectNegativeOne() {
1712         test_rt_38901(false);
1713     }
1714 
1715     private void test_rt_38901(boolean selectNull) {
1716         rt_38901_counter = 0;
1717 
1718         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1719         cb.setOnShowing((e) -&gt; {
1720             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_38901_counter++));
1721         });
1722 
1723         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1724         assertNull(cb.getSelectionModel().getSelectedItem());
1725         assertNull(cb.getValue());
1726         assertEquals(0, cb.getItems().size());
1727 
1728         // round one
1729         cb.show();
1730         assertEquals(1, cb.getItems().size());
1731         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1732         cb.hide();
1733 
1734         cb.getSelectionModel().select(0);
1735         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1736         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1737         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1738 
1739         if (selectNull) cb.getSelectionModel().select(null);
1740         else cb.getSelectionModel().select(-1);
1741 
1742         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1743         assertNull(cb.getSelectionModel().getSelectedItem());
1744         assertNull(cb.getValue());
1745 
1746 
1747         // round two
1748         cb.show();
1749         assertEquals(1, cb.getItems().size());
1750         assertEquals(&quot;DUMMY 1&quot;, cb.getItems().get(0));
1751         cb.hide();
1752 
1753         cb.getSelectionModel().select(0);
1754         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1755         assertEquals(&quot;DUMMY 1&quot;, cb.getSelectionModel().getSelectedItem());
1756         assertEquals(&quot;DUMMY 1&quot;, cb.getValue());
1757 
1758         if (selectNull) cb.getSelectionModel().select(null);
1759         else cb.getSelectionModel().select(-1);
1760 
1761         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1762         assertNull(cb.getSelectionModel().getSelectedItem());
1763         assertNull(cb.getValue());
1764     }
1765 
1766     private int rt_22572_counter;
1767     @Test public void test_rt_22572() {
1768         rt_22572_counter = 0;
1769 
1770         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1771         cb.setOnShowing((e) -&gt; {
1772             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_22572_counter++));
1773         });
1774 
1775         StageLoader sl = new StageLoader(cb);
1776 
1777         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1778         assertNull(cb.getSelectionModel().getSelectedItem());
1779         assertNull(cb.getValue());
1780         assertEquals(0, cb.getItems().size());
1781 
1782         // round one
1783         cb.show();
1784         assertEquals(1, cb.getItems().size());
1785         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1786         cb.hide();
1787 
1788         cb.getSelectionModel().select(0);
1789         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1790         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1791         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1792 
1793 
1794         // round two - even though the items change, the value should still be
1795         // the old value (even though it doesn&#39;t exist in the items list any longer).
1796         // The selectedIndex and selectedItem do get reset however.
1797         cb.show();
1798         assertEquals(1, cb.getItems().size());
1799         assertEquals(&quot;DUMMY 1&quot;, cb.getItems().get(0));
1800         cb.hide();
1801 
1802         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1803         assertNull(cb.getSelectionModel().getSelectedItem());
1804         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1805 
1806         sl.dispose();
1807     }
1808 
1809     private int rt_22937_counter;
1810     @Test public void test_rt_22937() {
1811         rt_22937_counter = 0;
1812 
1813         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1814         cb.setOnShowing((e) -&gt; {
1815             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_22937_counter++));
1816         });
1817 
1818         cb.getItems().add(&quot;Toto&quot;);
1819         cb.setEditable(true);
1820         cb.setValue(&quot;Tata&quot;);
1821 
1822         StageLoader sl = new StageLoader(cb);
1823 
1824         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1825         assertEquals(&quot;Tata&quot;, cb.getSelectionModel().getSelectedItem());
1826         assertEquals(&quot;Tata&quot;, cb.getValue());
1827         assertEquals(1, cb.getItems().size());
1828 
1829         cb.show();
1830         assertEquals(1, cb.getItems().size());
1831         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1832         cb.hide();
1833 
1834         cb.getSelectionModel().select(0);
1835         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1836         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1837         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1838 
1839         sl.dispose();
1840     }
1841 
1842     @Test public void test_rt_39809() {
1843         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1844         comboBox.getItems().setAll(null, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
1845 
1846         StageLoader sl = new StageLoader(comboBox);
1847 
1848         comboBox.getSelectionModel().clearAndSelect(1);
1849         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
1850         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
1851 
1852         comboBox.getSelectionModel().clearAndSelect(0);
1853         assertEquals(null, comboBox.getSelectionModel().getSelectedItem());
1854         assertEquals(0, comboBox.getSelectionModel().getSelectedIndex());
1855 
1856         sl.dispose();
1857     }
1858 
1859     @Test public void test_rt_39908() {
1860         ObservableList&lt;String&gt; model = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
1861         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(model);
1862 
1863         StageLoader sl = new StageLoader(comboBox);
1864 
1865         comboBox.getSelectionModel().clearAndSelect(1);
1866         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
1867         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
1868 
1869         model.set(0, &quot;a&quot;);
1870         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
1871         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
1872 
1873         sl.dispose();
1874     }
1875 
1876     /**
1877      * Bullet 1: selected index must be updated
1878      * Corner case: last selected. Fails for core
1879      */
1880     @Test public void test_rt_40012_selectedAtLastOnDisjointRemoveItemsAbove() {
1881         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
1882         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1883         SelectionModel sm = comboBox.getSelectionModel();
1884 
1885         int last = items.size() - 1;
1886 
1887         // selecting item &quot;5&quot;
1888         sm.select(last);
1889 
1890         // disjoint remove of 2 elements above the last selected
1891         // Removing &quot;1&quot; and &quot;3&quot;
1892         items.removeAll(items.get(1), items.get(3));
1893 
1894         // selection should move up two places such that it remains on item &quot;5&quot;,
1895         // but in index (last - 2).
1896         int expected = last - 2;
1897         assertEquals(&quot;5&quot;, sm.getSelectedItem());
1898         assertEquals(&quot;selected index after disjoint removes above&quot;, expected, sm.getSelectedIndex());
1899     }
1900 
1901     /**
1902      * Variant of 1: if selectedIndex is not updated,
1903      * the old index is no longer valid
1904      * for accessing the items.
1905      */
1906     @Test public void test_rt_40012_accessSelectedAtLastOnDisjointRemoveItemsAbove() {
1907         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
1908         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1909         SelectionModel sm = comboBox.getSelectionModel();
1910 
1911         int last = items.size() - 1;
1912 
1913         // selecting item &quot;5&quot;
1914         sm.select(last);
1915 
1916         // disjoint remove of 2 elements above the last selected
1917         items.removeAll(items.get(1), items.get(3));
1918         int selected = sm.getSelectedIndex();
1919         if (selected &gt; -1) {
1920             items.get(selected);
1921         }
1922     }
1923 
1924     /**
1925      * Bullet 2: selectedIndex notification count
1926      *
1927      * Note that we don&#39;t use the corner case of having the last index selected
1928      * (which fails already on updating the index)
1929      */
1930     private int rt_40012_count = 0;
1931     @Test public void test_rt_40012_selectedIndexNotificationOnDisjointRemovesAbove() {
1932         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
1933         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1934         SelectionModel sm = comboBox.getSelectionModel();
1935 
1936         int last = items.size() - 2;
1937         sm.select(last);
1938         assertEquals(last, sm.getSelectedIndex());
1939 
1940         rt_40012_count = 0;
1941         sm.selectedIndexProperty().addListener(o -&gt; rt_40012_count++);
1942 
1943         // disjoint remove of 2 elements above the last selected
1944         items.removeAll(items.get(1), items.get(3));
1945         assertEquals(&quot;sanity: selectedIndex must be shifted by -2&quot;, last - 2, sm.getSelectedIndex());
1946         assertEquals(&quot;must fire single event on removes above&quot;, 1, rt_40012_count);
1947     }
1948 
1949     /**
1950      * Bullet 3: unchanged selectedItem must not fire change
1951      */
1952     @Test
1953     public void test_rt_40012_selectedItemNotificationOnDisjointRemovesAbove() {
1954         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
1955         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1956         SelectionModel sm = comboBox.getSelectionModel();
1957 
1958         int last = items.size() - 2;
1959         Object lastItem = items.get(last);
1960         sm.select(last);
1961         assertEquals(lastItem, sm.getSelectedItem());
1962 
1963         rt_40012_count = 0;
1964         sm.selectedItemProperty().addListener(o -&gt; rt_40012_count++);
1965 
1966         // disjoint remove of 2 elements above the last selected
1967         items.removeAll(items.get(1), items.get(3));
1968         assertEquals(&quot;sanity: selectedItem unchanged&quot;, lastItem, sm.getSelectedItem());
1969         assertEquals(&quot;must not fire on unchanged selected item&quot;, 0, rt_40012_count);
1970     }
1971 
1972     @Test public void test_jdk_8150946_testCommit_valid() {
1973         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1974         comboBox.setEditable(true);
1975         assertEquals(null, comboBox.getValue());
1976         comboBox.getEditor().setText(&quot;ABC&quot;);
1977         comboBox.commitValue();
1978         assertEquals(&quot;ABC&quot;, comboBox.getValue());
1979     }
1980 
1981     @Test public void test_jdk_8150946_testCancel_toNull() {
1982         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1983         comboBox.setEditable(true);
1984         assertNull(comboBox.getValue());
1985         assertEquals(&quot;&quot;, comboBox.getEditor().getText());
1986         comboBox.getEditor().setText(&quot;ABC&quot;);
1987         assertNull(comboBox.getValue());
1988         comboBox.cancelEdit();
1989         assertNull(comboBox.getValue());
1990         assertNull(comboBox.getEditor().getText());
1991     }
1992 
1993     @Test public void test_jdk_8150946_testCancel_toNonNull() {
1994         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1995         comboBox.setEditable(true);
1996         comboBox.getEditor().setText(&quot;ABC&quot;);
1997         comboBox.commitValue();
1998         assertEquals(&quot;ABC&quot;, comboBox.getValue());
1999         assertEquals(&quot;ABC&quot;, comboBox.getEditor().getText());
2000         comboBox.getEditor().setText(&quot;DEF&quot;);
2001         assertEquals(&quot;DEF&quot;, comboBox.getEditor().getText());
2002         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2003         comboBox.cancelEdit();
2004         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2005         assertEquals(&quot;ABC&quot;, comboBox.getEditor().getText());
2006     }
2007 
2008     @Test public void test_jdk_8160493() {
2009         AtomicInteger count = new AtomicInteger();
2010         comboBox.valueProperty().addListener(o -&gt; count.incrementAndGet());
2011         assertEquals(0, count.get());
2012 
2013         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
2014         sm.select(1);
2015         assertTrue(sm.isSelected(1));
2016         assertEquals(1, count.get());
2017         assertEquals(&quot;Orange&quot;, comboBox.getValue());
2018 
2019         comboBox.setValue(&quot;New Value&quot;);
2020         assertEquals(2, count.get());
2021         assertEquals(&quot;New Value&quot;, comboBox.getValue());
2022     }
2023 
2024     private int skinChangedCount = 0;
2025     @Test public void test_JDK_8185854() {
2026         final FlowPane comboPane = new FlowPane(10, 10);
2027         ComboBox combo = new ComboBox&lt;String&gt;();
2028 
2029         combo.skinProperty().addListener((o, oldSkin, newSkin) -&gt; {
2030             skinChangedCount++;
2031         });
2032 
2033         combo.setDisable(false);
2034         combo.setEditable(false);
2035 
2036         comboPane.getChildren().add(combo);
2037 
2038         TabPane tabPane = new TabPane();
2039         Tab tab = new Tab();
2040         tab.setText(&quot;ComboBox&quot;);
2041         tab.setContent(comboPane);
2042         tabPane.getTabs().add(tab);
2043 
2044         BorderPane p = new BorderPane();
2045         p.setCenter(tabPane);
2046 
2047         Scene scene = new Scene(p);
2048         scene.getStylesheets().add(ComboBoxTest.class.getResource(&quot;JDK_8185854.css&quot;).toExternalForm());
2049 
2050         Toolkit tk = Toolkit.getToolkit();
2051 
2052         Stage stage = new Stage();
2053         stage.setScene(scene);
2054         stage.setWidth(500);
2055         stage.setHeight(400);
2056 
2057         stage.show();
2058 
2059         tk.firePulse();
2060 
2061         assertEquals(&quot;ComboBox skinProperty changed more than once, which is not expected.&quot;, 1, skinChangedCount);
2062     }
2063 
2064     @Test public void test_JDK_8129123() {
2065         final int LIST_SIZE = 50;
2066 
2067         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2068 
2069         BorderPane p = new BorderPane();
2070         p.setCenter(comboBox);
2071 
2072         Scene scene = new Scene(p);
2073 
2074         Stage stage = new Stage();
2075         stage.setScene(scene);
2076         stage.setWidth(500);
2077         stage.setHeight(400);
2078         stage.show();
2079 
2080         Toolkit.getToolkit().firePulse();
2081 
2082         for (int i = 0; i &lt; LIST_SIZE; i++) {
2083             comboBox.getItems().add(String.valueOf(i));
2084         }
2085         comboBox.show();
2086 
2087         VirtualFlow&lt;IndexedCell&lt;?&gt;&gt; virtualFlow = (VirtualFlow&lt;IndexedCell&lt;?&gt;&gt;) VirtualFlowTestUtils.getVirtualFlow(comboBox);
2088 
2089         int index = 0;
2090         comboBox.getSelectionModel().select(index);
2091         Toolkit.getToolkit().firePulse();
2092 
2093         int first = virtualFlow.getFirstVisibleCell().getIndex();
2094         int last = virtualFlow.getLastVisibleCell().getIndex();
2095         assertTrue(&quot; visible range [&quot; + first + &quot;, &quot; + last + &quot;] must include &quot; + index,
2096                 first &lt;= index  &amp;&amp; index &lt;= last);
2097 
2098         index = LIST_SIZE / 2;
2099         comboBox.getSelectionModel().select(index);
2100         Toolkit.getToolkit().firePulse();
2101 
2102         first = virtualFlow.getFirstVisibleCell().getIndex();
2103         last = virtualFlow.getLastVisibleCell().getIndex();
2104         assertTrue(&quot; visible range [&quot; + first + &quot;, &quot; + last + &quot;] must include &quot; + index,
2105                 first &lt;= index  &amp;&amp; index &lt;= last);
2106 
2107         index = LIST_SIZE - 1;
2108         comboBox.getSelectionModel().select(index);
2109         Toolkit.getToolkit().firePulse();
2110 
2111         first = virtualFlow.getFirstVisibleCell().getIndex();
2112         last = virtualFlow.getLastVisibleCell().getIndex();
2113         assertTrue(&quot; visible range [&quot; + first + &quot;, &quot; + last + &quot;] must include &quot; + index,
2114                 first &lt;= index  &amp;&amp; index &lt;= last);
2115     }
2116 }
    </pre>
  </body>
</html>