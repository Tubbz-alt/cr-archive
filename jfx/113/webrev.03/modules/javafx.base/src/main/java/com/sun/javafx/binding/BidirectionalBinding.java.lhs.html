<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.base/src/main/java/com/sun/javafx/binding/BidirectionalBinding.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2011, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package com.sun.javafx.binding;
 27 
 28 import javafx.beans.Observable;
 29 import javafx.beans.WeakListener;
 30 import javafx.beans.property.*;
 31 import javafx.beans.value.ChangeListener;
 32 import javafx.beans.value.ObservableValue;
 33 import javafx.util.StringConverter;
 34 
 35 import java.lang.ref.WeakReference;
 36 import java.text.Format;
 37 import java.text.ParseException;
 38 
 39 public abstract class BidirectionalBinding&lt;T&gt; implements ChangeListener&lt;T&gt;, WeakListener {
 40 
 41     private static void checkParameters(Object property1, Object property2) {
 42         if ((property1 == null) || (property2 == null)) {
 43             throw new NullPointerException(&quot;Both properties must be specified.&quot;);
 44         }
 45         if (property1 == property2) {
 46             throw new IllegalArgumentException(&quot;Cannot bind property to itself&quot;);
 47         }
 48     }
 49 
 50     public static &lt;T&gt; BidirectionalBinding bind(Property&lt;T&gt; property1, Property&lt;T&gt; property2) {
 51         checkParameters(property1, property2);
 52         final BidirectionalBinding binding =
 53                 ((property1 instanceof DoubleProperty) &amp;&amp; (property2 instanceof DoubleProperty)) ?
 54                         new BidirectionalDoubleBinding((DoubleProperty) property1, (DoubleProperty) property2)
 55                 : ((property1 instanceof FloatProperty) &amp;&amp; (property2 instanceof FloatProperty)) ?
 56                         new BidirectionalFloatBinding((FloatProperty) property1, (FloatProperty) property2)
 57                 : ((property1 instanceof IntegerProperty) &amp;&amp; (property2 instanceof IntegerProperty)) ?
 58                         new BidirectionalIntegerBinding((IntegerProperty) property1, (IntegerProperty) property2)
 59                 : ((property1 instanceof LongProperty) &amp;&amp; (property2 instanceof LongProperty)) ?
 60                         new BidirectionalLongBinding((LongProperty) property1, (LongProperty) property2)
 61                 : ((property1 instanceof BooleanProperty) &amp;&amp; (property2 instanceof BooleanProperty)) ?
 62                         new BidirectionalBooleanBinding((BooleanProperty) property1, (BooleanProperty) property2)
 63                 : new TypedGenericBidirectionalBinding&lt;T&gt;(property1, property2);
 64         property1.setValue(property2.getValue());
 65         property1.addListener(binding);
 66         property2.addListener(binding);
 67         return binding;
 68     }
 69 
 70     public static Object bind(Property&lt;String&gt; stringProperty, Property&lt;?&gt; otherProperty, Format format) {
 71         checkParameters(stringProperty, otherProperty);
 72         if (format == null) {
 73             throw new NullPointerException(&quot;Format cannot be null&quot;);
 74         }
 75         final StringConversionBidirectionalBinding&lt;?&gt; binding = new StringFormatBidirectionalBinding(stringProperty, otherProperty, format);
 76         stringProperty.setValue(format.format(otherProperty.getValue()));
 77         stringProperty.addListener(binding);
 78         otherProperty.addListener(binding);
 79         return binding;
 80     }
 81 
 82     public static &lt;T&gt; Object bind(Property&lt;String&gt; stringProperty, Property&lt;T&gt; otherProperty, StringConverter&lt;T&gt; converter) {
 83         checkParameters(stringProperty, otherProperty);
 84         if (converter == null) {
 85             throw new NullPointerException(&quot;Converter cannot be null&quot;);
 86         }
 87         final StringConversionBidirectionalBinding&lt;T&gt; binding = new StringConverterBidirectionalBinding&lt;T&gt;(stringProperty, otherProperty, converter);
 88         stringProperty.setValue(converter.toString(otherProperty.getValue()));
 89         stringProperty.addListener(binding);
 90         otherProperty.addListener(binding);
 91         return binding;
 92     }
 93 
 94     public static &lt;T&gt; void unbind(Property&lt;T&gt; property1, Property&lt;T&gt; property2) {
 95         checkParameters(property1, property2);
 96         final BidirectionalBinding binding = new UntypedGenericBidirectionalBinding(property1, property2);
 97         property1.removeListener(binding);
 98         property2.removeListener(binding);
 99     }
100 
101     public static void unbind(Object property1, Object property2) {
102         checkParameters(property1, property2);
103         final BidirectionalBinding binding = new UntypedGenericBidirectionalBinding(property1, property2);
104         if (property1 instanceof ObservableValue) {
105             ((ObservableValue) property1).removeListener(binding);
106         }
107         if (property2 instanceof ObservableValue) {
108             ((ObservableValue) property2).removeListener(binding);
109         }
110     }
111 
112     public static BidirectionalBinding bindNumber(Property&lt;Integer&gt; property1, IntegerProperty property2) {
113         return bindNumber(property1, (Property&lt;Number&gt;)property2);
114     }
115 
116     public static BidirectionalBinding bindNumber(Property&lt;Long&gt; property1, LongProperty property2) {
117         return bindNumber(property1, (Property&lt;Number&gt;)property2);
118     }
119 
120     public static BidirectionalBinding bindNumber(Property&lt;Float&gt; property1, FloatProperty property2) {
121         return bindNumber(property1, (Property&lt;Number&gt;)property2);
122     }
123 
124     public static BidirectionalBinding bindNumber(Property&lt;Double&gt; property1, DoubleProperty property2) {
125         return bindNumber(property1, (Property&lt;Number&gt;)property2);
126     }
127 
128     public static BidirectionalBinding bindNumber(IntegerProperty property1, Property&lt;Integer&gt; property2) {
129         return bindNumberObject(property1, property2);
130     }
131 
132     public static BidirectionalBinding bindNumber(LongProperty property1, Property&lt;Long&gt; property2) {
133         return bindNumberObject(property1, property2);
134     }
135 
136     public static BidirectionalBinding bindNumber(FloatProperty property1, Property&lt;Float&gt; property2) {
137         return bindNumberObject(property1, property2);
138     }
139 
140     public static BidirectionalBinding bindNumber(DoubleProperty property1, Property&lt;Double&gt; property2) {
141         return bindNumberObject(property1, property2);
142     }
143 
144     private static &lt;T extends Number&gt; BidirectionalBinding bindNumberObject(Property&lt;Number&gt; property1, Property&lt;T&gt; property2) {
145         checkParameters(property1, property2);
146 
147         final BidirectionalBinding&lt;Number&gt; binding = new TypedNumberBidirectionalBinding&lt;T&gt;(property2, property1);
148 
149         property1.setValue(property2.getValue());
150         property1.addListener(binding);
151         property2.addListener(binding);
152         return binding;
153     }
154 
155     private static &lt;T extends Number&gt; BidirectionalBinding bindNumber(Property&lt;T&gt; property1, Property&lt;Number&gt; property2) {
156         checkParameters(property1, property2);
157 
158         final BidirectionalBinding&lt;Number&gt; binding = new TypedNumberBidirectionalBinding&lt;T&gt;(property1, property2);
159 
160         property1.setValue((T)property2.getValue());
161         property1.addListener(binding);
162         property2.addListener(binding);
163         return binding;
164     }
165 
<a name="1" id="anc1"></a><span class="line-removed">166     public static &lt;T extends Number&gt; void unbindNumber(Property&lt;T&gt; property1, Property&lt;Number&gt; property2) {</span>
<span class="line-removed">167         checkParameters(property1, property2);</span>
<span class="line-removed">168         final BidirectionalBinding binding = new UntypedGenericBidirectionalBinding(property1, property2);</span>
<span class="line-removed">169         if (property1 instanceof ObservableValue) {</span>
<span class="line-removed">170             ((ObservableValue) property1).removeListener(binding);</span>
<span class="line-removed">171         }</span>
<span class="line-removed">172         if (property2 instanceof Observable) {</span>
<span class="line-removed">173             ((ObservableValue) property2).removeListener(binding);</span>
<span class="line-removed">174         }</span>
<span class="line-removed">175     }</span>
<span class="line-removed">176 </span>
177     private final int cachedHashCode;
178 
179     private BidirectionalBinding(Object property1, Object property2) {
180         cachedHashCode = property1.hashCode() * property2.hashCode();
181     }
182 
183     protected abstract Object getProperty1();
184 
185     protected abstract Object getProperty2();
186 
187     @Override
188     public int hashCode() {
189         return cachedHashCode;
190     }
191 
192     @Override
193     public boolean wasGarbageCollected() {
194         return (getProperty1() == null) || (getProperty2() == null);
195     }
196 
197     @Override
198     public boolean equals(Object obj) {
199         if (this == obj) {
200             return true;
201         }
202 
203         final Object propertyA1 = getProperty1();
204         final Object propertyA2 = getProperty2();
205         if ((propertyA1 == null) || (propertyA2 == null)) {
206             return false;
207         }
208 
209         if (obj instanceof BidirectionalBinding) {
210             final BidirectionalBinding otherBinding = (BidirectionalBinding) obj;
211             final Object propertyB1 = otherBinding.getProperty1();
212             final Object propertyB2 = otherBinding.getProperty2();
213             if ((propertyB1 == null) || (propertyB2 == null)) {
214                 return false;
215             }
216 
217             if (propertyA1 == propertyB1 &amp;&amp; propertyA2 == propertyB2) {
218                 return true;
219             }
220             if (propertyA1 == propertyB2 &amp;&amp; propertyA2 == propertyB1) {
221                 return true;
222             }
223         }
224         return false;
225     }
226 
227     private static class BidirectionalBooleanBinding extends BidirectionalBinding&lt;Boolean&gt; {
228         private final WeakReference&lt;BooleanProperty&gt; propertyRef1;
229         private final WeakReference&lt;BooleanProperty&gt; propertyRef2;
230         private boolean updating = false;
231 
232         private BidirectionalBooleanBinding(BooleanProperty property1, BooleanProperty property2) {
233             super(property1, property2);
234             propertyRef1 = new WeakReference&lt;BooleanProperty&gt;(property1);
235             propertyRef2 = new WeakReference&lt;BooleanProperty&gt;(property2);
236         }
237 
238         @Override
239         protected Property&lt;Boolean&gt; getProperty1() {
240             return propertyRef1.get();
241         }
242 
243         @Override
244         protected Property&lt;Boolean&gt; getProperty2() {
245             return propertyRef2.get();
246         }
247 
248         @Override
249         public void changed(ObservableValue&lt;? extends Boolean&gt; sourceProperty, Boolean oldValue, Boolean newValue) {
250             if (!updating) {
251                 final BooleanProperty property1 = propertyRef1.get();
252                 final BooleanProperty property2 = propertyRef2.get();
253                 if ((property1 == null) || (property2 == null)) {
254                     if (property1 != null) {
255                         property1.removeListener(this);
256                     }
257                     if (property2 != null) {
258                         property2.removeListener(this);
259                     }
260                 } else {
261                     try {
262                         updating = true;
263                         if (property1 == sourceProperty) {
264                             property2.set(newValue);
265                         } else {
266                             property1.set(newValue);
267                         }
268                     } catch (RuntimeException e) {
269                         try {
270                             if (property1 == sourceProperty) {
271                                 property1.set(oldValue);
272                             } else {
273                                 property2.set(oldValue);
274                             }
275                         } catch (Exception e2) {
276                             e2.addSuppressed(e);
277                             unbind(property1, property2);
278                             throw new RuntimeException(
279                                 &quot;Bidirectional binding failed together with an attempt&quot;
280                                         + &quot; to restore the source property to the previous value.&quot;
281                                         + &quot; Removing the bidirectional binding from properties &quot; +
282                                         property1 + &quot; and &quot; + property2, e2);
283                         }
284                         throw new RuntimeException(
285                                 &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
286                     } finally {
287                         updating = false;
288                     }
289                 }
290             }
291         }
292     }
293 
294     private static class BidirectionalDoubleBinding extends BidirectionalBinding&lt;Number&gt; {
295         private final WeakReference&lt;DoubleProperty&gt; propertyRef1;
296         private final WeakReference&lt;DoubleProperty&gt; propertyRef2;
297         private boolean updating = false;
298 
299         private BidirectionalDoubleBinding(DoubleProperty property1, DoubleProperty property2) {
300             super(property1, property2);
301             propertyRef1 = new WeakReference&lt;DoubleProperty&gt;(property1);
302             propertyRef2 = new WeakReference&lt;DoubleProperty&gt;(property2);
303         }
304 
305         @Override
306         protected Property&lt;Number&gt; getProperty1() {
307             return propertyRef1.get();
308         }
309 
310         @Override
311         protected Property&lt;Number&gt; getProperty2() {
312             return propertyRef2.get();
313         }
314 
315         @Override
316         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
317             if (!updating) {
318                 final DoubleProperty property1 = propertyRef1.get();
319                 final DoubleProperty property2 = propertyRef2.get();
320                 if ((property1 == null) || (property2 == null)) {
321                     if (property1 != null) {
322                         property1.removeListener(this);
323                     }
324                     if (property2 != null) {
325                         property2.removeListener(this);
326                     }
327                 } else {
328                     try {
329                         updating = true;
330                         if (property1 == sourceProperty) {
331                             property2.set(newValue.doubleValue());
332                         } else {
333                             property1.set(newValue.doubleValue());
334                         }
335                     } catch (RuntimeException e) {
336                         try {
337                             if (property1 == sourceProperty) {
338                                 property1.set(oldValue.doubleValue());
339                             } else {
340                                 property2.set(oldValue.doubleValue());
341                             }
342                         } catch (Exception e2) {
343                             e2.addSuppressed(e);
344                             unbind(property1, property2);
345                             throw new RuntimeException(
346                                 &quot;Bidirectional binding failed together with an attempt&quot;
347                                         + &quot; to restore the source property to the previous value.&quot;
348                                         + &quot; Removing the bidirectional binding from properties &quot; +
349                                         property1 + &quot; and &quot; + property2, e2);
350                         }
351                         throw new RuntimeException(
352                                         &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
353                     } finally {
354                         updating = false;
355                     }
356                 }
357             }
358         }
359     }
360 
361     private static class BidirectionalFloatBinding extends BidirectionalBinding&lt;Number&gt; {
362         private final WeakReference&lt;FloatProperty&gt; propertyRef1;
363         private final WeakReference&lt;FloatProperty&gt; propertyRef2;
364         private boolean updating = false;
365 
366         private BidirectionalFloatBinding(FloatProperty property1, FloatProperty property2) {
367             super(property1, property2);
368             propertyRef1 = new WeakReference&lt;FloatProperty&gt;(property1);
369             propertyRef2 = new WeakReference&lt;FloatProperty&gt;(property2);
370         }
371 
372         @Override
373         protected Property&lt;Number&gt; getProperty1() {
374             return propertyRef1.get();
375         }
376 
377         @Override
378         protected Property&lt;Number&gt; getProperty2() {
379             return propertyRef2.get();
380         }
381 
382         @Override
383         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
384             if (!updating) {
385                 final FloatProperty property1 = propertyRef1.get();
386                 final FloatProperty property2 = propertyRef2.get();
387                 if ((property1 == null) || (property2 == null)) {
388                     if (property1 != null) {
389                         property1.removeListener(this);
390                     }
391                     if (property2 != null) {
392                         property2.removeListener(this);
393                     }
394                 } else {
395                     try {
396                         updating = true;
397                         if (property1 == sourceProperty) {
398                             property2.set(newValue.floatValue());
399                         } else {
400                             property1.set(newValue.floatValue());
401                         }
402                     } catch (RuntimeException e) {
403                         try {
404                             if (property1 == sourceProperty) {
405                                 property1.set(oldValue.floatValue());
406                             } else {
407                                 property2.set(oldValue.floatValue());
408                             }
409                         } catch (Exception e2) {
410                             e2.addSuppressed(e);
411                             unbind(property1, property2);
412                             throw new RuntimeException(
413                                 &quot;Bidirectional binding failed together with an attempt&quot;
414                                         + &quot; to restore the source property to the previous value.&quot;
415                                         + &quot; Removing the bidirectional binding from properties &quot; +
416                                         property1 + &quot; and &quot; + property2, e2);
417                         }
418                         throw new RuntimeException(
419                                 &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
420                     } finally {
421                         updating = false;
422                     }
423                 }
424             }
425         }
426     }
427 
428     private static class BidirectionalIntegerBinding extends BidirectionalBinding&lt;Number&gt;{
429         private final WeakReference&lt;IntegerProperty&gt; propertyRef1;
430         private final WeakReference&lt;IntegerProperty&gt; propertyRef2;
431         private boolean updating = false;
432 
433         private BidirectionalIntegerBinding(IntegerProperty property1, IntegerProperty property2) {
434             super(property1, property2);
435             propertyRef1 = new WeakReference&lt;IntegerProperty&gt;(property1);
436             propertyRef2 = new WeakReference&lt;IntegerProperty&gt;(property2);
437         }
438 
439         @Override
440         protected Property&lt;Number&gt; getProperty1() {
441             return propertyRef1.get();
442         }
443 
444         @Override
445         protected Property&lt;Number&gt; getProperty2() {
446             return propertyRef2.get();
447         }
448 
449         @Override
450         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
451             if (!updating) {
452                 final IntegerProperty property1 = propertyRef1.get();
453                 final IntegerProperty property2 = propertyRef2.get();
454                 if ((property1 == null) || (property2 == null)) {
455                     if (property1 != null) {
456                         property1.removeListener(this);
457                     }
458                     if (property2 != null) {
459                         property2.removeListener(this);
460                     }
461                 } else {
462                     try {
463                         updating = true;
464                         if (property1 == sourceProperty) {
465                             property2.set(newValue.intValue());
466                         } else {
467                             property1.set(newValue.intValue());
468                         }
469                     } catch (RuntimeException e) {
470                         try {
471                             if (property1 == sourceProperty) {
472                                 property1.set(oldValue.intValue());
473                             } else {
474                                 property2.set(oldValue.intValue());
475                             }
476                         } catch (Exception e2) {
477                             e2.addSuppressed(e);
478                             unbind(property1, property2);
479                             throw new RuntimeException(
480                                 &quot;Bidirectional binding failed together with an attempt&quot;
481                                         + &quot; to restore the source property to the previous value.&quot;
482                                         + &quot; Removing the bidirectional binding from properties &quot; +
483                                         property1 + &quot; and &quot; + property2, e2);
484                         }
485                         throw new RuntimeException(
486                                         &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
487                     } finally {
488                         updating = false;
489                     }
490                 }
491             }
492         }
493     }
494 
495     private static class BidirectionalLongBinding extends BidirectionalBinding&lt;Number&gt; {
496         private final WeakReference&lt;LongProperty&gt; propertyRef1;
497         private final WeakReference&lt;LongProperty&gt; propertyRef2;
498         private boolean updating = false;
499 
500         private BidirectionalLongBinding(LongProperty property1, LongProperty property2) {
501             super(property1, property2);
502             propertyRef1 = new WeakReference&lt;LongProperty&gt;(property1);
503             propertyRef2 = new WeakReference&lt;LongProperty&gt;(property2);
504         }
505 
506         @Override
507         protected Property&lt;Number&gt; getProperty1() {
508             return propertyRef1.get();
509         }
510 
511         @Override
512         protected Property&lt;Number&gt; getProperty2() {
513             return propertyRef2.get();
514         }
515 
516         @Override
517         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
518             if (!updating) {
519                 final LongProperty property1 = propertyRef1.get();
520                 final LongProperty property2 = propertyRef2.get();
521                 if ((property1 == null) || (property2 == null)) {
522                     if (property1 != null) {
523                         property1.removeListener(this);
524                     }
525                     if (property2 != null) {
526                         property2.removeListener(this);
527                     }
528                 } else {
529                     try {
530                         updating = true;
531                         if (property1 == sourceProperty) {
532                             property2.set(newValue.longValue());
533                         } else {
534                             property1.set(newValue.longValue());
535                         }
536                     } catch (RuntimeException e) {
537                         try {
538                             if (property1 == sourceProperty) {
539                                 property1.set(oldValue.longValue());
540                             } else {
541                                 property2.set(oldValue.longValue());
542                             }
543                         } catch (Exception e2) {
544                             e2.addSuppressed(e);
545                             unbind(property1, property2);
546                             throw new RuntimeException(
547                                 &quot;Bidirectional binding failed together with an attempt&quot;
548                                         + &quot; to restore the source property to the previous value.&quot;
549                                         + &quot; Removing the bidirectional binding from properties &quot; +
550                                         property1 + &quot; and &quot; + property2, e2);
551                         }
552                         throw new RuntimeException(
553                                 &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
554                     } finally {
555                         updating = false;
556                     }
557                 }
558             }
559         }
560     }
561 
562     private static class TypedGenericBidirectionalBinding&lt;T&gt; extends BidirectionalBinding&lt;T&gt; {
563         private final WeakReference&lt;Property&lt;T&gt;&gt; propertyRef1;
564         private final WeakReference&lt;Property&lt;T&gt;&gt; propertyRef2;
565         private boolean updating = false;
566 
567         private TypedGenericBidirectionalBinding(Property&lt;T&gt; property1, Property&lt;T&gt; property2) {
568             super(property1, property2);
569             propertyRef1 = new WeakReference&lt;Property&lt;T&gt;&gt;(property1);
570             propertyRef2 = new WeakReference&lt;Property&lt;T&gt;&gt;(property2);
571         }
572 
573         @Override
574         protected Property&lt;T&gt; getProperty1() {
575             return propertyRef1.get();
576         }
577 
578         @Override
579         protected Property&lt;T&gt; getProperty2() {
580             return propertyRef2.get();
581         }
582 
583         @Override
584         public void changed(ObservableValue&lt;? extends T&gt; sourceProperty, T oldValue, T newValue) {
585             if (!updating) {
586                 final Property&lt;T&gt; property1 = propertyRef1.get();
587                 final Property&lt;T&gt; property2 = propertyRef2.get();
588                 if ((property1 == null) || (property2 == null)) {
589                     if (property1 != null) {
590                         property1.removeListener(this);
591                     }
592                     if (property2 != null) {
593                         property2.removeListener(this);
594                     }
595                 } else {
596                     try {
597                         updating = true;
598                         if (property1 == sourceProperty) {
599                             property2.setValue(newValue);
600                         } else {
601                             property1.setValue(newValue);
602                         }
603                     } catch (RuntimeException e) {
604                         try {
605                             if (property1 == sourceProperty) {
606                                 property1.setValue(oldValue);
607                             } else {
608                                 property2.setValue(oldValue);
609                             }
610                         } catch (Exception e2) {
611                             e2.addSuppressed(e);
612                             unbind(property1, property2);
613                             throw new RuntimeException(
614                                 &quot;Bidirectional binding failed together with an attempt&quot;
615                                         + &quot; to restore the source property to the previous value.&quot;
616                                         + &quot; Removing the bidirectional binding from properties &quot; +
617                                         property1 + &quot; and &quot; + property2, e2);
618                         }
619                         throw new RuntimeException(
620                                 &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
621                     } finally {
622                         updating = false;
623                     }
624                 }
625             }
626         }
627     }
628 
629     private static class TypedNumberBidirectionalBinding&lt;T extends Number&gt; extends BidirectionalBinding&lt;Number&gt; {
630         private final WeakReference&lt;Property&lt;T&gt;&gt; propertyRef1;
631         private final WeakReference&lt;Property&lt;Number&gt;&gt; propertyRef2;
632         private boolean updating = false;
633 
634         private TypedNumberBidirectionalBinding(Property&lt;T&gt; property1, Property&lt;Number&gt; property2) {
635             super(property1, property2);
636             propertyRef1 = new WeakReference&lt;Property&lt;T&gt;&gt;(property1);
637             propertyRef2 = new WeakReference&lt;Property&lt;Number&gt;&gt;(property2);
638         }
639 
640         @Override
641         protected Property&lt;T&gt; getProperty1() {
642             return propertyRef1.get();
643         }
644 
645         @Override
646         protected Property&lt;Number&gt; getProperty2() {
647             return propertyRef2.get();
648         }
649 
650         @Override
651         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
652             if (!updating) {
653                 final Property&lt;T&gt; property1 = propertyRef1.get();
654                 final Property&lt;Number&gt; property2 = propertyRef2.get();
655                 if ((property1 == null) || (property2 == null)) {
656                     if (property1 != null) {
657                         property1.removeListener(this);
658                     }
659                     if (property2 != null) {
660                         property2.removeListener(this);
661                     }
662                 } else {
663                     try {
664                         updating = true;
665                         if (property1 == sourceProperty) {
666                             property2.setValue(newValue);
667                         } else {
668                             property1.setValue((T)newValue);
669                         }
670                     } catch (RuntimeException e) {
671                         try {
672                             if (property1 == sourceProperty) {
673                                 property1.setValue((T)oldValue);
674                             } else {
675                                 property2.setValue(oldValue);
676                             }
677                         } catch (Exception e2) {
678                             e2.addSuppressed(e);
679                             unbind(property1, property2);
680                             throw new RuntimeException(
681                                 &quot;Bidirectional binding failed together with an attempt&quot;
682                                         + &quot; to restore the source property to the previous value.&quot;
683                                         + &quot; Removing the bidirectional binding from properties &quot; +
684                                         property1 + &quot; and &quot; + property2, e2);
685                         }
686                         throw new RuntimeException(
687                                         &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
688                     } finally {
689                         updating = false;
690                     }
691                 }
692             }
693         }
694     }
695 
696     private static class UntypedGenericBidirectionalBinding extends BidirectionalBinding&lt;Object&gt; {
697 
698         private final Object property1;
699         private final Object property2;
700 
701         public UntypedGenericBidirectionalBinding(Object property1, Object property2) {
702             super(property1, property2);
703             this.property1 = property1;
704             this.property2 = property2;
705         }
706 
707         @Override
708         protected Object getProperty1() {
709             return property1;
710         }
711 
712         @Override
713         protected Object getProperty2() {
714             return property2;
715         }
716 
717         @Override
718         public void changed(ObservableValue&lt;? extends Object&gt; sourceProperty, Object oldValue, Object newValue) {
719             throw new RuntimeException(&quot;Should not reach here&quot;);
720         }
721     }
722 
723     public abstract static class StringConversionBidirectionalBinding&lt;T&gt; extends BidirectionalBinding&lt;Object&gt; {
724 
725         private final WeakReference&lt;Property&lt;String&gt;&gt; stringPropertyRef;
726         private final WeakReference&lt;Property&lt;T&gt;&gt; otherPropertyRef;
727         private boolean updating;
728 
729         public StringConversionBidirectionalBinding(Property&lt;String&gt; stringProperty, Property&lt;T&gt; otherProperty) {
730             super(stringProperty, otherProperty);
731             stringPropertyRef = new WeakReference&lt;Property&lt;String&gt;&gt;(stringProperty);
732             otherPropertyRef = new WeakReference&lt;Property&lt;T&gt;&gt;(otherProperty);
733         }
734 
735         protected abstract String toString(T value);
736 
737         protected abstract T fromString(String value) throws ParseException;
738 
739         @Override
740         protected Object getProperty1() {
741             return stringPropertyRef.get();
742         }
743 
744         @Override
745         protected Object getProperty2() {
746             return otherPropertyRef.get();
747         }
748 
749         @Override
750         public void changed(ObservableValue&lt;? extends Object&gt; observable, Object oldValue, Object newValue) {
751             if (!updating) {
752                 final Property&lt;String&gt; property1 = stringPropertyRef.get();
753                 final Property&lt;T&gt; property2 = otherPropertyRef.get();
754                 if ((property1 == null) || (property2 == null)) {
755                     if (property1 != null) {
756                         property1.removeListener(this);
757                     }
758                     if (property2 != null) {
759                         property2.removeListener(this);
760                     }
761                 } else {
762                     try {
763                         updating = true;
764                         if (property1 == observable) {
765                             try {
766                                 property2.setValue(fromString(property1.getValue()));
767                             } catch (Exception e) {
768                                 Logging.getLogger().warning(&quot;Exception while parsing String in bidirectional binding&quot;, e);
769                                 property2.setValue(null);
770                             }
771                         } else {
772                             try {
773                                 property1.setValue(toString(property2.getValue()));
774                             } catch (Exception e) {
775                                 Logging.getLogger().warning(&quot;Exception while converting Object to String in bidirectional binding&quot;, e);
776                                 property1.setValue(&quot;&quot;);
777                             }
778                         }
779                     } finally {
780                         updating = false;
781                     }
782                 }
783             }
784         }
785     }
786 
787     private static class StringFormatBidirectionalBinding extends StringConversionBidirectionalBinding {
788 
789         private final Format format;
790 
791         @SuppressWarnings(&quot;unchecked&quot;)
792         public StringFormatBidirectionalBinding(Property&lt;String&gt; stringProperty, Property&lt;?&gt; otherProperty, Format format) {
793             super(stringProperty, otherProperty);
794             this.format = format;
795         }
796 
797         @Override
798         protected String toString(Object value) {
799             return format.format(value);
800         }
801 
802         @Override
803         protected Object fromString(String value) throws ParseException {
804             return format.parseObject(value);
805         }
806     }
807 
808     private static class StringConverterBidirectionalBinding&lt;T&gt; extends StringConversionBidirectionalBinding&lt;T&gt; {
809 
810         private final StringConverter&lt;T&gt; converter;
811 
812         public StringConverterBidirectionalBinding(Property&lt;String&gt; stringProperty, Property&lt;T&gt; otherProperty, StringConverter&lt;T&gt; converter) {
813             super(stringProperty, otherProperty);
814             this.converter = converter;
815         }
816 
817         @Override
818         protected String toString(T value) {
819             return converter.toString(value);
820         }
821 
822         @Override
823         protected T fromString(String value) throws ParseException {
824             return converter.fromString(value);
825         }
826     }
827 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>