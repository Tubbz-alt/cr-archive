<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.base/src/main/java/com/sun/javafx/binding/BidirectionalBinding.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2011, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package com.sun.javafx.binding;
 27 
 28 import javafx.beans.Observable;
 29 import javafx.beans.WeakListener;
 30 import javafx.beans.property.*;
 31 import javafx.beans.value.ChangeListener;
 32 import javafx.beans.value.ObservableValue;
 33 import javafx.util.StringConverter;
 34 
 35 import java.lang.ref.WeakReference;
 36 import java.text.Format;
 37 import java.text.ParseException;
 38 
 39 public abstract class BidirectionalBinding&lt;T&gt; implements ChangeListener&lt;T&gt;, WeakListener {
 40 
 41     private static void checkParameters(Object property1, Object property2) {
 42         if ((property1 == null) || (property2 == null)) {
 43             throw new NullPointerException(&quot;Both properties must be specified.&quot;);
 44         }
 45         if (property1 == property2) {
 46             throw new IllegalArgumentException(&quot;Cannot bind property to itself&quot;);
 47         }
 48     }
 49 
 50     public static &lt;T&gt; BidirectionalBinding bind(Property&lt;T&gt; property1, Property&lt;T&gt; property2) {
 51         checkParameters(property1, property2);
 52         final BidirectionalBinding binding =
 53                 ((property1 instanceof DoubleProperty) &amp;&amp; (property2 instanceof DoubleProperty)) ?
 54                         new BidirectionalDoubleBinding((DoubleProperty) property1, (DoubleProperty) property2)
 55                 : ((property1 instanceof FloatProperty) &amp;&amp; (property2 instanceof FloatProperty)) ?
 56                         new BidirectionalFloatBinding((FloatProperty) property1, (FloatProperty) property2)
 57                 : ((property1 instanceof IntegerProperty) &amp;&amp; (property2 instanceof IntegerProperty)) ?
 58                         new BidirectionalIntegerBinding((IntegerProperty) property1, (IntegerProperty) property2)
 59                 : ((property1 instanceof LongProperty) &amp;&amp; (property2 instanceof LongProperty)) ?
 60                         new BidirectionalLongBinding((LongProperty) property1, (LongProperty) property2)
 61                 : ((property1 instanceof BooleanProperty) &amp;&amp; (property2 instanceof BooleanProperty)) ?
 62                         new BidirectionalBooleanBinding((BooleanProperty) property1, (BooleanProperty) property2)
 63                 : new TypedGenericBidirectionalBinding&lt;T&gt;(property1, property2);
 64         property1.setValue(property2.getValue());
 65         property1.addListener(binding);
 66         property2.addListener(binding);
 67         return binding;
 68     }
 69 
 70     public static Object bind(Property&lt;String&gt; stringProperty, Property&lt;?&gt; otherProperty, Format format) {
 71         checkParameters(stringProperty, otherProperty);
 72         if (format == null) {
 73             throw new NullPointerException(&quot;Format cannot be null&quot;);
 74         }
 75         final StringConversionBidirectionalBinding&lt;?&gt; binding = new StringFormatBidirectionalBinding(stringProperty, otherProperty, format);
 76         stringProperty.setValue(format.format(otherProperty.getValue()));
 77         stringProperty.addListener(binding);
 78         otherProperty.addListener(binding);
 79         return binding;
 80     }
 81 
 82     public static &lt;T&gt; Object bind(Property&lt;String&gt; stringProperty, Property&lt;T&gt; otherProperty, StringConverter&lt;T&gt; converter) {
 83         checkParameters(stringProperty, otherProperty);
 84         if (converter == null) {
 85             throw new NullPointerException(&quot;Converter cannot be null&quot;);
 86         }
 87         final StringConversionBidirectionalBinding&lt;T&gt; binding = new StringConverterBidirectionalBinding&lt;T&gt;(stringProperty, otherProperty, converter);
 88         stringProperty.setValue(converter.toString(otherProperty.getValue()));
 89         stringProperty.addListener(binding);
 90         otherProperty.addListener(binding);
 91         return binding;
 92     }
 93 
 94     public static &lt;T&gt; void unbind(Property&lt;T&gt; property1, Property&lt;T&gt; property2) {
 95         checkParameters(property1, property2);
 96         final BidirectionalBinding binding = new UntypedGenericBidirectionalBinding(property1, property2);
 97         property1.removeListener(binding);
 98         property2.removeListener(binding);
 99     }
100 
101     public static void unbind(Object property1, Object property2) {
102         checkParameters(property1, property2);
103         final BidirectionalBinding binding = new UntypedGenericBidirectionalBinding(property1, property2);
104         if (property1 instanceof ObservableValue) {
105             ((ObservableValue) property1).removeListener(binding);
106         }
107         if (property2 instanceof ObservableValue) {
108             ((ObservableValue) property2).removeListener(binding);
109         }
110     }
111 
112     public static BidirectionalBinding bindNumber(Property&lt;Integer&gt; property1, IntegerProperty property2) {
113         return bindNumber(property1, (Property&lt;Number&gt;)property2);
114     }
115 
116     public static BidirectionalBinding bindNumber(Property&lt;Long&gt; property1, LongProperty property2) {
117         return bindNumber(property1, (Property&lt;Number&gt;)property2);
118     }
119 
120     public static BidirectionalBinding bindNumber(Property&lt;Float&gt; property1, FloatProperty property2) {
121         return bindNumber(property1, (Property&lt;Number&gt;)property2);
122     }
123 
124     public static BidirectionalBinding bindNumber(Property&lt;Double&gt; property1, DoubleProperty property2) {
125         return bindNumber(property1, (Property&lt;Number&gt;)property2);
126     }
127 
128     public static BidirectionalBinding bindNumber(IntegerProperty property1, Property&lt;Integer&gt; property2) {
129         return bindNumberObject(property1, property2);
130     }
131 
132     public static BidirectionalBinding bindNumber(LongProperty property1, Property&lt;Long&gt; property2) {
133         return bindNumberObject(property1, property2);
134     }
135 
136     public static BidirectionalBinding bindNumber(FloatProperty property1, Property&lt;Float&gt; property2) {
137         return bindNumberObject(property1, property2);
138     }
139 
140     public static BidirectionalBinding bindNumber(DoubleProperty property1, Property&lt;Double&gt; property2) {
141         return bindNumberObject(property1, property2);
142     }
143 
144     private static &lt;T extends Number&gt; BidirectionalBinding bindNumberObject(Property&lt;Number&gt; property1, Property&lt;T&gt; property2) {
145         checkParameters(property1, property2);
146 
147         final BidirectionalBinding&lt;Number&gt; binding = new TypedNumberBidirectionalBinding&lt;T&gt;(property2, property1);
148 
149         property1.setValue(property2.getValue());
150         property1.addListener(binding);
151         property2.addListener(binding);
152         return binding;
153     }
154 
155     private static &lt;T extends Number&gt; BidirectionalBinding bindNumber(Property&lt;T&gt; property1, Property&lt;Number&gt; property2) {
156         checkParameters(property1, property2);
157 
158         final BidirectionalBinding&lt;Number&gt; binding = new TypedNumberBidirectionalBinding&lt;T&gt;(property1, property2);
159 
160         property1.setValue((T)property2.getValue());
161         property1.addListener(binding);
162         property2.addListener(binding);
163         return binding;
164     }
165 
<a name="1" id="anc1"></a>










166     private final int cachedHashCode;
167 
168     private BidirectionalBinding(Object property1, Object property2) {
169         cachedHashCode = property1.hashCode() * property2.hashCode();
170     }
171 
172     protected abstract Object getProperty1();
173 
174     protected abstract Object getProperty2();
175 
176     @Override
177     public int hashCode() {
178         return cachedHashCode;
179     }
180 
181     @Override
182     public boolean wasGarbageCollected() {
183         return (getProperty1() == null) || (getProperty2() == null);
184     }
185 
186     @Override
187     public boolean equals(Object obj) {
188         if (this == obj) {
189             return true;
190         }
191 
192         final Object propertyA1 = getProperty1();
193         final Object propertyA2 = getProperty2();
194         if ((propertyA1 == null) || (propertyA2 == null)) {
195             return false;
196         }
197 
198         if (obj instanceof BidirectionalBinding) {
199             final BidirectionalBinding otherBinding = (BidirectionalBinding) obj;
200             final Object propertyB1 = otherBinding.getProperty1();
201             final Object propertyB2 = otherBinding.getProperty2();
202             if ((propertyB1 == null) || (propertyB2 == null)) {
203                 return false;
204             }
205 
206             if (propertyA1 == propertyB1 &amp;&amp; propertyA2 == propertyB2) {
207                 return true;
208             }
209             if (propertyA1 == propertyB2 &amp;&amp; propertyA2 == propertyB1) {
210                 return true;
211             }
212         }
213         return false;
214     }
215 
216     private static class BidirectionalBooleanBinding extends BidirectionalBinding&lt;Boolean&gt; {
217         private final WeakReference&lt;BooleanProperty&gt; propertyRef1;
218         private final WeakReference&lt;BooleanProperty&gt; propertyRef2;
219         private boolean updating = false;
220 
221         private BidirectionalBooleanBinding(BooleanProperty property1, BooleanProperty property2) {
222             super(property1, property2);
223             propertyRef1 = new WeakReference&lt;BooleanProperty&gt;(property1);
224             propertyRef2 = new WeakReference&lt;BooleanProperty&gt;(property2);
225         }
226 
227         @Override
228         protected Property&lt;Boolean&gt; getProperty1() {
229             return propertyRef1.get();
230         }
231 
232         @Override
233         protected Property&lt;Boolean&gt; getProperty2() {
234             return propertyRef2.get();
235         }
236 
237         @Override
238         public void changed(ObservableValue&lt;? extends Boolean&gt; sourceProperty, Boolean oldValue, Boolean newValue) {
239             if (!updating) {
240                 final BooleanProperty property1 = propertyRef1.get();
241                 final BooleanProperty property2 = propertyRef2.get();
242                 if ((property1 == null) || (property2 == null)) {
243                     if (property1 != null) {
244                         property1.removeListener(this);
245                     }
246                     if (property2 != null) {
247                         property2.removeListener(this);
248                     }
249                 } else {
250                     try {
251                         updating = true;
252                         if (property1 == sourceProperty) {
253                             property2.set(newValue);
254                         } else {
255                             property1.set(newValue);
256                         }
257                     } catch (RuntimeException e) {
258                         try {
259                             if (property1 == sourceProperty) {
260                                 property1.set(oldValue);
261                             } else {
262                                 property2.set(oldValue);
263                             }
264                         } catch (Exception e2) {
265                             e2.addSuppressed(e);
266                             unbind(property1, property2);
267                             throw new RuntimeException(
268                                 &quot;Bidirectional binding failed together with an attempt&quot;
269                                         + &quot; to restore the source property to the previous value.&quot;
270                                         + &quot; Removing the bidirectional binding from properties &quot; +
271                                         property1 + &quot; and &quot; + property2, e2);
272                         }
273                         throw new RuntimeException(
274                                 &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
275                     } finally {
276                         updating = false;
277                     }
278                 }
279             }
280         }
281     }
282 
283     private static class BidirectionalDoubleBinding extends BidirectionalBinding&lt;Number&gt; {
284         private final WeakReference&lt;DoubleProperty&gt; propertyRef1;
285         private final WeakReference&lt;DoubleProperty&gt; propertyRef2;
286         private boolean updating = false;
287 
288         private BidirectionalDoubleBinding(DoubleProperty property1, DoubleProperty property2) {
289             super(property1, property2);
290             propertyRef1 = new WeakReference&lt;DoubleProperty&gt;(property1);
291             propertyRef2 = new WeakReference&lt;DoubleProperty&gt;(property2);
292         }
293 
294         @Override
295         protected Property&lt;Number&gt; getProperty1() {
296             return propertyRef1.get();
297         }
298 
299         @Override
300         protected Property&lt;Number&gt; getProperty2() {
301             return propertyRef2.get();
302         }
303 
304         @Override
305         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
306             if (!updating) {
307                 final DoubleProperty property1 = propertyRef1.get();
308                 final DoubleProperty property2 = propertyRef2.get();
309                 if ((property1 == null) || (property2 == null)) {
310                     if (property1 != null) {
311                         property1.removeListener(this);
312                     }
313                     if (property2 != null) {
314                         property2.removeListener(this);
315                     }
316                 } else {
317                     try {
318                         updating = true;
319                         if (property1 == sourceProperty) {
320                             property2.set(newValue.doubleValue());
321                         } else {
322                             property1.set(newValue.doubleValue());
323                         }
324                     } catch (RuntimeException e) {
325                         try {
326                             if (property1 == sourceProperty) {
327                                 property1.set(oldValue.doubleValue());
328                             } else {
329                                 property2.set(oldValue.doubleValue());
330                             }
331                         } catch (Exception e2) {
332                             e2.addSuppressed(e);
333                             unbind(property1, property2);
334                             throw new RuntimeException(
335                                 &quot;Bidirectional binding failed together with an attempt&quot;
336                                         + &quot; to restore the source property to the previous value.&quot;
337                                         + &quot; Removing the bidirectional binding from properties &quot; +
338                                         property1 + &quot; and &quot; + property2, e2);
339                         }
340                         throw new RuntimeException(
341                                         &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
342                     } finally {
343                         updating = false;
344                     }
345                 }
346             }
347         }
348     }
349 
350     private static class BidirectionalFloatBinding extends BidirectionalBinding&lt;Number&gt; {
351         private final WeakReference&lt;FloatProperty&gt; propertyRef1;
352         private final WeakReference&lt;FloatProperty&gt; propertyRef2;
353         private boolean updating = false;
354 
355         private BidirectionalFloatBinding(FloatProperty property1, FloatProperty property2) {
356             super(property1, property2);
357             propertyRef1 = new WeakReference&lt;FloatProperty&gt;(property1);
358             propertyRef2 = new WeakReference&lt;FloatProperty&gt;(property2);
359         }
360 
361         @Override
362         protected Property&lt;Number&gt; getProperty1() {
363             return propertyRef1.get();
364         }
365 
366         @Override
367         protected Property&lt;Number&gt; getProperty2() {
368             return propertyRef2.get();
369         }
370 
371         @Override
372         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
373             if (!updating) {
374                 final FloatProperty property1 = propertyRef1.get();
375                 final FloatProperty property2 = propertyRef2.get();
376                 if ((property1 == null) || (property2 == null)) {
377                     if (property1 != null) {
378                         property1.removeListener(this);
379                     }
380                     if (property2 != null) {
381                         property2.removeListener(this);
382                     }
383                 } else {
384                     try {
385                         updating = true;
386                         if (property1 == sourceProperty) {
387                             property2.set(newValue.floatValue());
388                         } else {
389                             property1.set(newValue.floatValue());
390                         }
391                     } catch (RuntimeException e) {
392                         try {
393                             if (property1 == sourceProperty) {
394                                 property1.set(oldValue.floatValue());
395                             } else {
396                                 property2.set(oldValue.floatValue());
397                             }
398                         } catch (Exception e2) {
399                             e2.addSuppressed(e);
400                             unbind(property1, property2);
401                             throw new RuntimeException(
402                                 &quot;Bidirectional binding failed together with an attempt&quot;
403                                         + &quot; to restore the source property to the previous value.&quot;
404                                         + &quot; Removing the bidirectional binding from properties &quot; +
405                                         property1 + &quot; and &quot; + property2, e2);
406                         }
407                         throw new RuntimeException(
408                                 &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
409                     } finally {
410                         updating = false;
411                     }
412                 }
413             }
414         }
415     }
416 
417     private static class BidirectionalIntegerBinding extends BidirectionalBinding&lt;Number&gt;{
418         private final WeakReference&lt;IntegerProperty&gt; propertyRef1;
419         private final WeakReference&lt;IntegerProperty&gt; propertyRef2;
420         private boolean updating = false;
421 
422         private BidirectionalIntegerBinding(IntegerProperty property1, IntegerProperty property2) {
423             super(property1, property2);
424             propertyRef1 = new WeakReference&lt;IntegerProperty&gt;(property1);
425             propertyRef2 = new WeakReference&lt;IntegerProperty&gt;(property2);
426         }
427 
428         @Override
429         protected Property&lt;Number&gt; getProperty1() {
430             return propertyRef1.get();
431         }
432 
433         @Override
434         protected Property&lt;Number&gt; getProperty2() {
435             return propertyRef2.get();
436         }
437 
438         @Override
439         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
440             if (!updating) {
441                 final IntegerProperty property1 = propertyRef1.get();
442                 final IntegerProperty property2 = propertyRef2.get();
443                 if ((property1 == null) || (property2 == null)) {
444                     if (property1 != null) {
445                         property1.removeListener(this);
446                     }
447                     if (property2 != null) {
448                         property2.removeListener(this);
449                     }
450                 } else {
451                     try {
452                         updating = true;
453                         if (property1 == sourceProperty) {
454                             property2.set(newValue.intValue());
455                         } else {
456                             property1.set(newValue.intValue());
457                         }
458                     } catch (RuntimeException e) {
459                         try {
460                             if (property1 == sourceProperty) {
461                                 property1.set(oldValue.intValue());
462                             } else {
463                                 property2.set(oldValue.intValue());
464                             }
465                         } catch (Exception e2) {
466                             e2.addSuppressed(e);
467                             unbind(property1, property2);
468                             throw new RuntimeException(
469                                 &quot;Bidirectional binding failed together with an attempt&quot;
470                                         + &quot; to restore the source property to the previous value.&quot;
471                                         + &quot; Removing the bidirectional binding from properties &quot; +
472                                         property1 + &quot; and &quot; + property2, e2);
473                         }
474                         throw new RuntimeException(
475                                         &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
476                     } finally {
477                         updating = false;
478                     }
479                 }
480             }
481         }
482     }
483 
484     private static class BidirectionalLongBinding extends BidirectionalBinding&lt;Number&gt; {
485         private final WeakReference&lt;LongProperty&gt; propertyRef1;
486         private final WeakReference&lt;LongProperty&gt; propertyRef2;
487         private boolean updating = false;
488 
489         private BidirectionalLongBinding(LongProperty property1, LongProperty property2) {
490             super(property1, property2);
491             propertyRef1 = new WeakReference&lt;LongProperty&gt;(property1);
492             propertyRef2 = new WeakReference&lt;LongProperty&gt;(property2);
493         }
494 
495         @Override
496         protected Property&lt;Number&gt; getProperty1() {
497             return propertyRef1.get();
498         }
499 
500         @Override
501         protected Property&lt;Number&gt; getProperty2() {
502             return propertyRef2.get();
503         }
504 
505         @Override
506         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
507             if (!updating) {
508                 final LongProperty property1 = propertyRef1.get();
509                 final LongProperty property2 = propertyRef2.get();
510                 if ((property1 == null) || (property2 == null)) {
511                     if (property1 != null) {
512                         property1.removeListener(this);
513                     }
514                     if (property2 != null) {
515                         property2.removeListener(this);
516                     }
517                 } else {
518                     try {
519                         updating = true;
520                         if (property1 == sourceProperty) {
521                             property2.set(newValue.longValue());
522                         } else {
523                             property1.set(newValue.longValue());
524                         }
525                     } catch (RuntimeException e) {
526                         try {
527                             if (property1 == sourceProperty) {
528                                 property1.set(oldValue.longValue());
529                             } else {
530                                 property2.set(oldValue.longValue());
531                             }
532                         } catch (Exception e2) {
533                             e2.addSuppressed(e);
534                             unbind(property1, property2);
535                             throw new RuntimeException(
536                                 &quot;Bidirectional binding failed together with an attempt&quot;
537                                         + &quot; to restore the source property to the previous value.&quot;
538                                         + &quot; Removing the bidirectional binding from properties &quot; +
539                                         property1 + &quot; and &quot; + property2, e2);
540                         }
541                         throw new RuntimeException(
542                                 &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
543                     } finally {
544                         updating = false;
545                     }
546                 }
547             }
548         }
549     }
550 
551     private static class TypedGenericBidirectionalBinding&lt;T&gt; extends BidirectionalBinding&lt;T&gt; {
552         private final WeakReference&lt;Property&lt;T&gt;&gt; propertyRef1;
553         private final WeakReference&lt;Property&lt;T&gt;&gt; propertyRef2;
554         private boolean updating = false;
555 
556         private TypedGenericBidirectionalBinding(Property&lt;T&gt; property1, Property&lt;T&gt; property2) {
557             super(property1, property2);
558             propertyRef1 = new WeakReference&lt;Property&lt;T&gt;&gt;(property1);
559             propertyRef2 = new WeakReference&lt;Property&lt;T&gt;&gt;(property2);
560         }
561 
562         @Override
563         protected Property&lt;T&gt; getProperty1() {
564             return propertyRef1.get();
565         }
566 
567         @Override
568         protected Property&lt;T&gt; getProperty2() {
569             return propertyRef2.get();
570         }
571 
572         @Override
573         public void changed(ObservableValue&lt;? extends T&gt; sourceProperty, T oldValue, T newValue) {
574             if (!updating) {
575                 final Property&lt;T&gt; property1 = propertyRef1.get();
576                 final Property&lt;T&gt; property2 = propertyRef2.get();
577                 if ((property1 == null) || (property2 == null)) {
578                     if (property1 != null) {
579                         property1.removeListener(this);
580                     }
581                     if (property2 != null) {
582                         property2.removeListener(this);
583                     }
584                 } else {
585                     try {
586                         updating = true;
587                         if (property1 == sourceProperty) {
588                             property2.setValue(newValue);
589                         } else {
590                             property1.setValue(newValue);
591                         }
592                     } catch (RuntimeException e) {
593                         try {
594                             if (property1 == sourceProperty) {
595                                 property1.setValue(oldValue);
596                             } else {
597                                 property2.setValue(oldValue);
598                             }
599                         } catch (Exception e2) {
600                             e2.addSuppressed(e);
601                             unbind(property1, property2);
602                             throw new RuntimeException(
603                                 &quot;Bidirectional binding failed together with an attempt&quot;
604                                         + &quot; to restore the source property to the previous value.&quot;
605                                         + &quot; Removing the bidirectional binding from properties &quot; +
606                                         property1 + &quot; and &quot; + property2, e2);
607                         }
608                         throw new RuntimeException(
609                                 &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
610                     } finally {
611                         updating = false;
612                     }
613                 }
614             }
615         }
616     }
617 
618     private static class TypedNumberBidirectionalBinding&lt;T extends Number&gt; extends BidirectionalBinding&lt;Number&gt; {
619         private final WeakReference&lt;Property&lt;T&gt;&gt; propertyRef1;
620         private final WeakReference&lt;Property&lt;Number&gt;&gt; propertyRef2;
621         private boolean updating = false;
622 
623         private TypedNumberBidirectionalBinding(Property&lt;T&gt; property1, Property&lt;Number&gt; property2) {
624             super(property1, property2);
625             propertyRef1 = new WeakReference&lt;Property&lt;T&gt;&gt;(property1);
626             propertyRef2 = new WeakReference&lt;Property&lt;Number&gt;&gt;(property2);
627         }
628 
629         @Override
630         protected Property&lt;T&gt; getProperty1() {
631             return propertyRef1.get();
632         }
633 
634         @Override
635         protected Property&lt;Number&gt; getProperty2() {
636             return propertyRef2.get();
637         }
638 
639         @Override
640         public void changed(ObservableValue&lt;? extends Number&gt; sourceProperty, Number oldValue, Number newValue) {
641             if (!updating) {
642                 final Property&lt;T&gt; property1 = propertyRef1.get();
643                 final Property&lt;Number&gt; property2 = propertyRef2.get();
644                 if ((property1 == null) || (property2 == null)) {
645                     if (property1 != null) {
646                         property1.removeListener(this);
647                     }
648                     if (property2 != null) {
649                         property2.removeListener(this);
650                     }
651                 } else {
652                     try {
653                         updating = true;
654                         if (property1 == sourceProperty) {
655                             property2.setValue(newValue);
656                         } else {
657                             property1.setValue((T)newValue);
658                         }
659                     } catch (RuntimeException e) {
660                         try {
661                             if (property1 == sourceProperty) {
662                                 property1.setValue((T)oldValue);
663                             } else {
664                                 property2.setValue(oldValue);
665                             }
666                         } catch (Exception e2) {
667                             e2.addSuppressed(e);
668                             unbind(property1, property2);
669                             throw new RuntimeException(
670                                 &quot;Bidirectional binding failed together with an attempt&quot;
671                                         + &quot; to restore the source property to the previous value.&quot;
672                                         + &quot; Removing the bidirectional binding from properties &quot; +
673                                         property1 + &quot; and &quot; + property2, e2);
674                         }
675                         throw new RuntimeException(
676                                         &quot;Bidirectional binding failed, setting to the previous value&quot;, e);
677                     } finally {
678                         updating = false;
679                     }
680                 }
681             }
682         }
683     }
684 
685     private static class UntypedGenericBidirectionalBinding extends BidirectionalBinding&lt;Object&gt; {
686 
687         private final Object property1;
688         private final Object property2;
689 
690         public UntypedGenericBidirectionalBinding(Object property1, Object property2) {
691             super(property1, property2);
692             this.property1 = property1;
693             this.property2 = property2;
694         }
695 
696         @Override
697         protected Object getProperty1() {
698             return property1;
699         }
700 
701         @Override
702         protected Object getProperty2() {
703             return property2;
704         }
705 
706         @Override
707         public void changed(ObservableValue&lt;? extends Object&gt; sourceProperty, Object oldValue, Object newValue) {
708             throw new RuntimeException(&quot;Should not reach here&quot;);
709         }
710     }
711 
712     public abstract static class StringConversionBidirectionalBinding&lt;T&gt; extends BidirectionalBinding&lt;Object&gt; {
713 
714         private final WeakReference&lt;Property&lt;String&gt;&gt; stringPropertyRef;
715         private final WeakReference&lt;Property&lt;T&gt;&gt; otherPropertyRef;
716         private boolean updating;
717 
718         public StringConversionBidirectionalBinding(Property&lt;String&gt; stringProperty, Property&lt;T&gt; otherProperty) {
719             super(stringProperty, otherProperty);
720             stringPropertyRef = new WeakReference&lt;Property&lt;String&gt;&gt;(stringProperty);
721             otherPropertyRef = new WeakReference&lt;Property&lt;T&gt;&gt;(otherProperty);
722         }
723 
724         protected abstract String toString(T value);
725 
726         protected abstract T fromString(String value) throws ParseException;
727 
728         @Override
729         protected Object getProperty1() {
730             return stringPropertyRef.get();
731         }
732 
733         @Override
734         protected Object getProperty2() {
735             return otherPropertyRef.get();
736         }
737 
738         @Override
739         public void changed(ObservableValue&lt;? extends Object&gt; observable, Object oldValue, Object newValue) {
740             if (!updating) {
741                 final Property&lt;String&gt; property1 = stringPropertyRef.get();
742                 final Property&lt;T&gt; property2 = otherPropertyRef.get();
743                 if ((property1 == null) || (property2 == null)) {
744                     if (property1 != null) {
745                         property1.removeListener(this);
746                     }
747                     if (property2 != null) {
748                         property2.removeListener(this);
749                     }
750                 } else {
751                     try {
752                         updating = true;
753                         if (property1 == observable) {
754                             try {
755                                 property2.setValue(fromString(property1.getValue()));
756                             } catch (Exception e) {
757                                 Logging.getLogger().warning(&quot;Exception while parsing String in bidirectional binding&quot;, e);
758                                 property2.setValue(null);
759                             }
760                         } else {
761                             try {
762                                 property1.setValue(toString(property2.getValue()));
763                             } catch (Exception e) {
764                                 Logging.getLogger().warning(&quot;Exception while converting Object to String in bidirectional binding&quot;, e);
765                                 property1.setValue(&quot;&quot;);
766                             }
767                         }
768                     } finally {
769                         updating = false;
770                     }
771                 }
772             }
773         }
774     }
775 
776     private static class StringFormatBidirectionalBinding extends StringConversionBidirectionalBinding {
777 
778         private final Format format;
779 
780         @SuppressWarnings(&quot;unchecked&quot;)
781         public StringFormatBidirectionalBinding(Property&lt;String&gt; stringProperty, Property&lt;?&gt; otherProperty, Format format) {
782             super(stringProperty, otherProperty);
783             this.format = format;
784         }
785 
786         @Override
787         protected String toString(Object value) {
788             return format.format(value);
789         }
790 
791         @Override
792         protected Object fromString(String value) throws ParseException {
793             return format.parseObject(value);
794         }
795     }
796 
797     private static class StringConverterBidirectionalBinding&lt;T&gt; extends StringConversionBidirectionalBinding&lt;T&gt; {
798 
799         private final StringConverter&lt;T&gt; converter;
800 
801         public StringConverterBidirectionalBinding(Property&lt;String&gt; stringProperty, Property&lt;T&gt; otherProperty, StringConverter&lt;T&gt; converter) {
802             super(stringProperty, otherProperty);
803             this.converter = converter;
804         }
805 
806         @Override
807         protected String toString(T value) {
808             return converter.toString(value);
809         }
810 
811         @Override
812         protected T fromString(String value) throws ParseException {
813             return converter.fromString(value);
814         }
815     }
816 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>