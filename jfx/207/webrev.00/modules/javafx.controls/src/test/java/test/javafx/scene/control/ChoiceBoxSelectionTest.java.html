<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.controls/src/test/java/test/javafx/scene/control/ChoiceBoxSelectionTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package test.javafx.scene.control;
 27 
 28 import java.util.List;
 29 
 30 import org.junit.After;
 31 import org.junit.Before;
 32 import org.junit.Test;
 33 
 34 import static org.junit.Assert.*;
 35 
 36 import javafx.beans.property.SimpleStringProperty;
 37 import javafx.beans.property.StringProperty;
 38 import javafx.collections.FXCollections;
 39 import javafx.scene.Node;
 40 import javafx.scene.Scene;
 41 import javafx.scene.control.ChoiceBox;
 42 import javafx.scene.control.ChoiceBoxShim;
 43 import javafx.scene.control.ContextMenu;
 44 import javafx.scene.control.Control;
 45 import javafx.scene.control.MenuItem;
 46 import javafx.scene.control.RadioMenuItem;
 47 import javafx.scene.control.Separator;
 48 import javafx.scene.control.SingleSelectionModel;
 49 import javafx.scene.control.skin.ChoiceBoxSkin;
 50 import javafx.scene.control.skin.ChoiceBoxSkinNodesShim;
 51 import javafx.scene.layout.Pane;
 52 import javafx.scene.layout.VBox;
 53 import javafx.stage.Stage;
 54 
 55 /**
 56  * Collection of tests around state related to selection.
 57  * &lt;p&gt;
 58  *
 59  * Tests that toggles are un/selected as required (JDK-8242489).
 60  *
 61  * Note that the selection should be correct even if the
 62  * popup has not yet been shown.
 63  *
 64  * &lt;p&gt;
 65  * Need to test (testBaseToggle):
 66  * a) initial sync of selection state: selected toggle must be that of selectedIndex or none
 67  * b) change selection state after skin: selected toggle must follow
 68  *
 69  * &lt;p&gt;
 70  *
 71  * Tests around selectedIndex and uncontained value (testSynced).
 72  *
 73  */
 74 public class ChoiceBoxSelectionTest {
 75     private Scene scene;
 76     private Stage stage;
 77     private Pane root;
 78 
 79     private ChoiceBox&lt;String&gt; box;
 80 
 81     private String uncontained;
 82 
 83     /**
 84      * selected index taken by toggle when popup open
 85      */
 86     @Test
 87     public void testBaseToggleInitialSelectOpenPopup() {
 88         SingleSelectionModel&lt;String&gt; sm = box.getSelectionModel();
 89         int selectedIndex = box.getItems().size() - 1;
 90         sm.select(selectedIndex);
 91         showChoiceBox();
 92         box.show();
 93         assertToggleSelected(selectedIndex);
 94     }
 95 
 96     /**
 97      * selected index taken by toggle
 98      */
 99     @Test
100     public void testBaseToggleInitialSelect() {
101         SingleSelectionModel&lt;String&gt; sm = box.getSelectionModel();
102         int selectedIndex = box.getItems().size() - 1;
103         sm.select(selectedIndex);
104         showChoiceBox();
105         assertToggleSelected(selectedIndex);
106     }
107 
108     /**
109      * Toggle must be unselected if separator is selected
110      */
111     @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })
112     @Test
113     public void testBaseToggleSeparator() {
114         ChoiceBox box = new ChoiceBox(FXCollections.observableArrayList(
115                 &quot;Apple&quot;, &quot;Banana&quot;, new Separator(), &quot;Orange&quot;));
116         int separatorIndex = 2;
117         showControl(box);
118         SingleSelectionModel&lt;?&gt; sm = box.getSelectionModel();
119         int selectedIndex = 1;
120         sm.select(selectedIndex);
121         sm.select(separatorIndex);
122         // implementation detail of current sm (openjfx14): it allows a Separator
123         // to be selected - skin must unselect its toggles
124         assertToggleSelected(box, -1);
125     }
126 
127     /**
128      * Not quite https://bugs.openjdk.java.net/browse/JDK-8089398
129      * (the issue there is setting value while selectionModel == null)
130      *
131      * This here throws NPE if selectionModel is null when the skin is attached.
132      * Base reason is JDK-8242489.
133      *
134      * @see ChoiceBoxTest#selectionModelCanBeNull()
135      */
136     @Test
137     public void testNullSelectionModel() {
138         box.setSelectionModel(null);
139         showChoiceBox();
140     }
141 
142 
143 //------------ toggle follows selection change: select -&gt; show -&gt; empty
144 
145     /**
146      * select -&gt; show -&gt; clear
147      */
148     @Test
149     public void testBaseToggleClearSelection() {
150         SingleSelectionModel&lt;String&gt; sm = box.getSelectionModel();
151         sm.select(2);
152         showChoiceBox();
153         sm.clearSelection();
154         assertToggleSelected(-1);
155     }
156 
157     /**
158      * select -&gt; show -&gt; select(-1)
159      */
160     @Test
161     public void testBaseToggleMinusIndex() {
162         SingleSelectionModel&lt;String&gt; sm = box.getSelectionModel();
163         sm.select(2);
164         showChoiceBox();
165         sm.select(-1);
166         assertToggleSelected(-1);
167     }
168 
169     /**
170      * select -&gt; show -&gt; select(null)
171      */
172     @Test
173     public void testBaseToggleNullItem() {
174         SingleSelectionModel&lt;String&gt; sm = box.getSelectionModel();
175         sm.select(2);
176         showChoiceBox();
177         sm.select(null);
178         assertToggleSelected(-1);
179     }
180 
181     /**
182      * select -&gt; show -&gt; null value
183      */
184     @Test
185     public void testBaseToggleNullValue() {
186         SingleSelectionModel&lt;String&gt; sm = box.getSelectionModel();
187         sm.select(2);
188         showChoiceBox();
189         box.setValue(null);
190         assertToggleSelected(-1);
191     }
192 
193     //------------ toggle follows selection change: select -&gt; show -&gt; other selection
194 
195     @Test
196     public void testBaseToggleChangeIndex() {
197         SingleSelectionModel&lt;String&gt; sm = box.getSelectionModel();
198         sm.select(2);
199         showChoiceBox();
200         int other = 1;
201         sm.select(other);
202         assertToggleSelected(other);
203     }
204 
205     @Test
206     public void testBaseToggleChangeItem() {
207         SingleSelectionModel&lt;String&gt; sm = box.getSelectionModel();
208         sm.select(2);
209         showChoiceBox();
210         int other = 1;
211         String otherItem = box.getItems().get(other);
212         sm.select(otherItem);
213         assertToggleSelected(other);
214     }
215 
216     @Test
217     public void testBaseToggleChangeValue() {
218         SingleSelectionModel&lt;String&gt; sm = box.getSelectionModel();
219         sm.select(2);
220         showChoiceBox();
221         int other = 1;
222         String otherItem = box.getItems().get(other);
223         box.setValue(otherItem);
224         assertToggleSelected(other);
225     }
226 
227 //------------ toggle follows selection change: empty -&gt; selected
228 
229     @Test
230     public void testBaseToggleSetValue() {
231         showChoiceBox();
232         int selectedIndex = box.getItems().size() - 1;
233         box.setValue(box.getItems().get(selectedIndex));
234         assertToggleSelected(selectedIndex);
235     }
236 
237     @Test
238     public void testBaseToggleSelectItem() {
239         showChoiceBox();
240         SingleSelectionModel&lt;String&gt; sm = box.getSelectionModel();
241         int selectedIndex = box.getItems().size() - 1;
242         sm.select(box.getItems().get(selectedIndex));
243         assertToggleSelected(selectedIndex);
244     }
245 
246     @Test
247     public void testBaseToggleSelectIndex() {
248         showChoiceBox();
249         SingleSelectionModel&lt;String&gt; sm = box.getSelectionModel();
250         int selectedIndex = box.getItems().size() - 1;
251         sm.select(selectedIndex);
252         assertToggleSelected(selectedIndex);
253     }
254 
255     //------------- assertion helper
256 
257     protected void assertToggleSelected(ChoiceBox&lt;?&gt; box, int selectedIndex) {
258         boolean isSelected = selectedIndex &gt;= 0;
259         ContextMenu popup = ChoiceBoxSkinNodesShim.getChoiceBoxPopup((ChoiceBoxSkin&lt;?&gt;) box.getSkin());
260         for (int i = 0; i &lt; popup.getItems().size(); i++) {
261             boolean shouldBeSelected = isSelected ? selectedIndex == i : false;
262             MenuItem item = popup.getItems().get(i);
263             if (item instanceof RadioMenuItem) {
264                 RadioMenuItem selectedToggle = (RadioMenuItem) popup.getItems().get(i);
265                 assertEquals(&quot;toggle &quot; + selectedToggle.getText() + &quot; at index: &quot; + i + &quot; must be selected: &quot; + shouldBeSelected,
266                         shouldBeSelected,
267                         selectedToggle.isSelected());
268             }
269         }
270     }
271 
272     protected void assertToggleSelected(int selectedIndex) {
273         assertToggleSelected(box, selectedIndex);
274     }
275 
276     //------------- tests for JDK-8241999
277 
278     @Test
279     public void testSyncedToggleUncontainedValue() {
280         SingleSelectionModel&lt;String&gt; sm = box.getSelectionModel();
281         sm.select(2);
282         showChoiceBox();
283         box.setValue(uncontained);
284         assertToggleSelected(-1);
285     }
286 
287     /**
288      * Base reason for &quot;8241999&quot;: selected index not sync&#39;ed.
289      */
290     @Test
291     public void testSyncedSelectedIndexUncontained() {
292         box.setValue(box.getItems().get(1));
293         box.setValue(uncontained);
294         assertEquals(&quot;selectedIndex for uncontained value &quot;, -1, box.getSelectionModel().getSelectedIndex());
295     }
296 
297     /**
298      * From review of JDK-8087555:
299      * select contained -&gt; select uncontained -&gt; clearselection -&gt; nulls value
300      */
301     @Test
302     public void testSyncedSelectedOnPreselectedThenUncontained() {
303         box.setValue(box.getItems().get(1));
304         box.setValue(uncontained);
305         box.getSelectionModel().clearSelection();
306         assertEquals(&quot;uncontained value must be unchanged after clearSelection&quot;, uncontained, box.getValue());
307     }
308 
309     /**
310      * From review of JDK-8087555:
311      * select uncontained -&gt; clearselection -&gt; nulls value
312      */
313     @Test
314     public void testSyncedClearSelectionUncontained() {
315         box.setValue(uncontained);
316         box.getSelectionModel().clearSelection();
317         assertEquals(uncontained, box.getValue());
318     }
319 
320     //------------- tests for JDK-8242001
321 
322     /**
323      * Testing JDK-8242001: box value not updated on replacing selection model.
324      *
325      * Happens if replacing.selectedItem == null
326      *
327      */
328     @Test
329     public void testSyncedContainedValueReplaceSMEmpty() {
330         box.setValue(box.getItems().get(1));
331         SingleSelectionModel&lt;String&gt; replaceSM = ChoiceBoxShim.get_ChoiceBoxSelectionModel(box);
332         assertNull(replaceSM.getSelectedItem());
333         box.setSelectionModel(replaceSM);
334         assertEquals(replaceSM.getSelectedItem(), box.getValue());
335     }
336 
337     @Test
338     public void testSyncedUncontainedValueReplaceSMEmpty() {
339         box.setValue(uncontained);
340         SingleSelectionModel&lt;String&gt; replaceSM = ChoiceBoxShim.get_ChoiceBoxSelectionModel(box);
341         assertNull(replaceSM.getSelectedItem());
342         box.setSelectionModel(replaceSM);
343         assertEquals(replaceSM.getSelectedItem(), box.getValue());
344     }
345 
346     @Test
347     public void testSyncedBoundValueReplaceSMEmpty() {
348         StringProperty valueSource = new SimpleStringProperty(&quot;stickyValue&quot;);
349         box.valueProperty().bind(valueSource);
350         SingleSelectionModel&lt;String&gt; replaceSM = ChoiceBoxShim.get_ChoiceBoxSelectionModel(box);
351         assertNull(replaceSM.getSelectedItem());
352         box.setSelectionModel(replaceSM);
353         assertEquals(valueSource.get(), box.getValue());
354     }
355 
356     //----------- setup and sanity test for initial state
357 
358     @Test
359     public void testSetupState() {
360         assertNotNull(box);
361         showChoiceBox();
362         List&lt;Node&gt; expected = List.of(box);
363         assertEquals(expected, root.getChildren());
364     }
365 
366     protected void showChoiceBox() {
367         showControl(box);
368     }
369 
370     protected void showControl(Control box) {
371         if (!root.getChildren().contains(box)) {
372             root.getChildren().add(box);
373         }
374         stage.show();
375         stage.requestFocus();
376         box.requestFocus();
377         assertTrue(box.isFocused());
378         assertSame(box, scene.getFocusOwner());
379     }
380 
381     @After
382     public void cleanup() {
383         stage.hide();
384     }
385 
386     @Before
387     public void setup() {
388         uncontained = &quot;uncontained&quot;;
389         root = new VBox();
390         scene = new Scene(root);
391         stage = new Stage();
392         stage.setScene(scene);
393         box = new ChoiceBox&lt;&gt;(FXCollections.observableArrayList(&quot;Apple&quot;, &quot;Banana&quot;, &quot;Orange&quot;));
394         root.getChildren().addAll(box);
395     }
396 
397 }
    </pre>
  </body>
</html>