<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.graphics/src/main/native-glass/monocle/android/nativeBridge.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../java/com/sun/glass/ui/monocle/AndroidInputProcessor.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>modules/javafx.graphics/src/main/native-glass/monocle/android/nativeBridge.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &lt;sys/types.h&gt;
 27 #include &lt;dlfcn.h&gt;
 28 #include &quot;nativeBridge.h&quot;
 29 #include &quot;Monocle.h&quot;
 30 
 31 JNIEnv* javaEnv = NULL;
 32 JavaVM *jVM = NULL;
 33 
 34 static jclass jAndroidInputDeviceRegistryClass;
 35 static jclass jMonocleWindowManagerClass;
 36 
 37 static jmethodID monocle_gotTouchEventFromNative;
<span class="line-modified"> 38 static jmethodID monocle_gotKeyEventFromNative;</span>
 39 static jmethodID monocle_repaintAll;
 40 static jmethodID monocle_registerDevice;
 41 
 42 ANativeWindow* androidWindow = NULL;
 43 jfloat androidDensity = 0.f;
 44 static int deviceRegistered = 0;
 45 
 46 void initializeFromJava (JNIEnv *env) {
 47     if (jVM != NULL) return; // already have a jVM
 48     (*env)-&gt;GetJavaVM(env, &amp;jVM);
 49     GLASS_LOG_FINE(&quot;Initializing native Android Bridge from Java code&quot;);
 50     jMonocleWindowManagerClass = (*env)-&gt;NewGlobalRef(env,
 51                                                  (*env)-&gt;FindClass(env, &quot;com/sun/glass/ui/monocle/MonocleWindowManager&quot;));
 52     jAndroidInputDeviceRegistryClass = (*env)-&gt;NewGlobalRef(env,
 53                                                  (*env)-&gt;FindClass(env, &quot;com/sun/glass/ui/monocle/AndroidInputDeviceRegistry&quot;));
 54     monocle_repaintAll = (*env)-&gt;GetStaticMethodID(
 55                                             env, jMonocleWindowManagerClass, &quot;repaintFromNative&quot;,
 56                                             &quot;()V&quot;);
 57     monocle_gotTouchEventFromNative = (*env)-&gt;GetStaticMethodID(
 58                                             env, jAndroidInputDeviceRegistryClass, &quot;gotTouchEventFromNative&quot;,
 59                                             &quot;(I[I[I[I[II)V&quot;);
<span class="line-modified"> 60     monocle_gotKeyEventFromNative = (*env)-&gt;GetStaticMethodID(</span>
<span class="line-modified"> 61                                             env, jAndroidInputDeviceRegistryClass, &quot;gotKeyEventFromNative&quot;,</span>
<span class="line-modified"> 62                                             &quot;(II)V&quot;);</span>
 63     monocle_registerDevice = (*env)-&gt;GetStaticMethodID(env, jAndroidInputDeviceRegistryClass, &quot;registerDevice&quot;,&quot;()V&quot;);
 64     GLASS_LOG_FINE(&quot;Initializing native Android Bridge done&quot;);
 65 }
 66 
 67 void initializeFromNative () {
 68     if (javaEnv != NULL) return; // already have a JNIEnv
 69     if (jVM == NULL) {
 70         GLASS_LOG_FINE(&quot;initialize from native can&#39;t be done without JVM&quot;);
 71         return; // can&#39;t initialize from native before we have a jVM
 72     }
 73     GLASS_LOG_FINE(&quot;Initializing native Android Bridge from Android/native code&quot;);
 74     jint error = (*jVM)-&gt;AttachCurrentThread(jVM, (void **)&amp;javaEnv, NULL);
 75     if (error != 0) {
 76         GLASS_LOG_FINE(&quot;initializeFromNative failed with error %d\n&quot;, error);
 77     }
 78 }
 79 
 80 /* ===== called from native ===== */
 81 
 82 void androidJfx_setNativeWindow(ANativeWindow* nativeWindow) {
</pre>
<hr />
<pre>
 99     }
100     if (deviceRegistered == 0) {
101         deviceRegistered = 1;
102         GLASS_LOG_FINE(&quot;This is the first time we have a touch even, register device now&quot;);
103         (*javaEnv)-&gt;CallStaticVoidMethod(javaEnv, jAndroidInputDeviceRegistryClass, monocle_registerDevice);
104     }
105     jint jcount = (jint)count;
106     jlong jlongids[jcount];
107 
108     jintArray jactions = (*javaEnv)-&gt;NewIntArray(javaEnv, count);
109     (*javaEnv)-&gt;SetIntArrayRegion(javaEnv, jactions, 0, count, actions);
110     jintArray jids = (*javaEnv)-&gt;NewIntArray(javaEnv, count);
111     (*javaEnv)-&gt;SetIntArrayRegion(javaEnv, jids, 0, count, ids);
112     jintArray jxs = (*javaEnv)-&gt;NewIntArray(javaEnv, count);
113     (*javaEnv)-&gt;SetIntArrayRegion(javaEnv, jxs, 0, count, xs);
114     jintArray jys = (*javaEnv)-&gt;NewIntArray(javaEnv, count);
115     (*javaEnv)-&gt;SetIntArrayRegion(javaEnv, jys, 0, count, ys);
116 
117     (*javaEnv)-&gt;CallStaticVoidMethod(javaEnv, jAndroidInputDeviceRegistryClass, monocle_gotTouchEventFromNative,
118             jcount, jactions, jids, jxs, jys, primary);

119 















120 }
121 
122 void androidJfx_requestGlassToRedraw() {
123     GLASS_LOG_FINEST(&quot;Native code is notified that surface needs to be redrawn (repaintall)&quot;);
124     if (jVM == NULL) {
125         GLASS_LOG_WARNING(&quot;we can&#39;t do this yet, no jVM\n&quot;);
126         return;
127     }
128     if (javaEnv == NULL) {
129         jint error = (*jVM)-&gt;AttachCurrentThread(jVM, (void **)&amp;javaEnv, NULL);
130         GLASS_LOG_WARNING(&quot;result of attach: %d\n&quot;,error);
131     }
132     if (jMonocleWindowManagerClass == NULL) {
133         GLASS_LOG_WARNING(&quot;we can&#39;t do this yet, no jMonocleWindowManagerClass\n&quot;);
134         return;
135     }
136     if (monocle_repaintAll == NULL) {
137         GLASS_LOG_WARNING(&quot;we can&#39;t do this yet, no monocle_repaintAll\n&quot;);
138         return;
139     }
</pre>
</td>
<td>
<hr />
<pre>
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &lt;sys/types.h&gt;
 27 #include &lt;dlfcn.h&gt;
 28 #include &quot;nativeBridge.h&quot;
 29 #include &quot;Monocle.h&quot;
 30 
 31 JNIEnv* javaEnv = NULL;
 32 JavaVM *jVM = NULL;
 33 
 34 static jclass jAndroidInputDeviceRegistryClass;
 35 static jclass jMonocleWindowManagerClass;
 36 
 37 static jmethodID monocle_gotTouchEventFromNative;
<span class="line-modified"> 38 static jmethodID monocle_dispatchKeyEventFromNative;</span>
 39 static jmethodID monocle_repaintAll;
 40 static jmethodID monocle_registerDevice;
 41 
 42 ANativeWindow* androidWindow = NULL;
 43 jfloat androidDensity = 0.f;
 44 static int deviceRegistered = 0;
 45 
 46 void initializeFromJava (JNIEnv *env) {
 47     if (jVM != NULL) return; // already have a jVM
 48     (*env)-&gt;GetJavaVM(env, &amp;jVM);
 49     GLASS_LOG_FINE(&quot;Initializing native Android Bridge from Java code&quot;);
 50     jMonocleWindowManagerClass = (*env)-&gt;NewGlobalRef(env,
 51                                                  (*env)-&gt;FindClass(env, &quot;com/sun/glass/ui/monocle/MonocleWindowManager&quot;));
 52     jAndroidInputDeviceRegistryClass = (*env)-&gt;NewGlobalRef(env,
 53                                                  (*env)-&gt;FindClass(env, &quot;com/sun/glass/ui/monocle/AndroidInputDeviceRegistry&quot;));
 54     monocle_repaintAll = (*env)-&gt;GetStaticMethodID(
 55                                             env, jMonocleWindowManagerClass, &quot;repaintFromNative&quot;,
 56                                             &quot;()V&quot;);
 57     monocle_gotTouchEventFromNative = (*env)-&gt;GetStaticMethodID(
 58                                             env, jAndroidInputDeviceRegistryClass, &quot;gotTouchEventFromNative&quot;,
 59                                             &quot;(I[I[I[I[II)V&quot;);
<span class="line-modified"> 60     monocle_dispatchKeyEventFromNative = (*env)-&gt;GetStaticMethodID(</span>
<span class="line-modified"> 61                                             env, jAndroidInputDeviceRegistryClass, &quot;dispatchKeyEventFromNative&quot;,</span>
<span class="line-modified"> 62                                             &quot;(II[CI)V&quot;);</span>
 63     monocle_registerDevice = (*env)-&gt;GetStaticMethodID(env, jAndroidInputDeviceRegistryClass, &quot;registerDevice&quot;,&quot;()V&quot;);
 64     GLASS_LOG_FINE(&quot;Initializing native Android Bridge done&quot;);
 65 }
 66 
 67 void initializeFromNative () {
 68     if (javaEnv != NULL) return; // already have a JNIEnv
 69     if (jVM == NULL) {
 70         GLASS_LOG_FINE(&quot;initialize from native can&#39;t be done without JVM&quot;);
 71         return; // can&#39;t initialize from native before we have a jVM
 72     }
 73     GLASS_LOG_FINE(&quot;Initializing native Android Bridge from Android/native code&quot;);
 74     jint error = (*jVM)-&gt;AttachCurrentThread(jVM, (void **)&amp;javaEnv, NULL);
 75     if (error != 0) {
 76         GLASS_LOG_FINE(&quot;initializeFromNative failed with error %d\n&quot;, error);
 77     }
 78 }
 79 
 80 /* ===== called from native ===== */
 81 
 82 void androidJfx_setNativeWindow(ANativeWindow* nativeWindow) {
</pre>
<hr />
<pre>
 99     }
100     if (deviceRegistered == 0) {
101         deviceRegistered = 1;
102         GLASS_LOG_FINE(&quot;This is the first time we have a touch even, register device now&quot;);
103         (*javaEnv)-&gt;CallStaticVoidMethod(javaEnv, jAndroidInputDeviceRegistryClass, monocle_registerDevice);
104     }
105     jint jcount = (jint)count;
106     jlong jlongids[jcount];
107 
108     jintArray jactions = (*javaEnv)-&gt;NewIntArray(javaEnv, count);
109     (*javaEnv)-&gt;SetIntArrayRegion(javaEnv, jactions, 0, count, actions);
110     jintArray jids = (*javaEnv)-&gt;NewIntArray(javaEnv, count);
111     (*javaEnv)-&gt;SetIntArrayRegion(javaEnv, jids, 0, count, ids);
112     jintArray jxs = (*javaEnv)-&gt;NewIntArray(javaEnv, count);
113     (*javaEnv)-&gt;SetIntArrayRegion(javaEnv, jxs, 0, count, xs);
114     jintArray jys = (*javaEnv)-&gt;NewIntArray(javaEnv, count);
115     (*javaEnv)-&gt;SetIntArrayRegion(javaEnv, jys, 0, count, ys);
116 
117     (*javaEnv)-&gt;CallStaticVoidMethod(javaEnv, jAndroidInputDeviceRegistryClass, monocle_gotTouchEventFromNative,
118             jcount, jactions, jids, jxs, jys, primary);
<span class="line-added">119 }</span>
120 
<span class="line-added">121 void androidJfx_gotKeyEvent (int action, int keyCode, jchar* chars, int count, int mods) {</span>
<span class="line-added">122     initializeFromNative();</span>
<span class="line-added">123     if (javaEnv == NULL) {</span>
<span class="line-added">124         GLASS_LOG_FINE(&quot;javaEnv still null, not ready to process touch events&quot;);</span>
<span class="line-added">125         return;</span>
<span class="line-added">126     }</span>
<span class="line-added">127     if (deviceRegistered == 0) {</span>
<span class="line-added">128         deviceRegistered = 1;</span>
<span class="line-added">129         GLASS_LOG_FINE(&quot;This is the first time we have a touch even, register device now&quot;);</span>
<span class="line-added">130         (*javaEnv)-&gt;CallStaticVoidMethod(javaEnv, jAndroidInputDeviceRegistryClass, monocle_registerDevice);</span>
<span class="line-added">131     }</span>
<span class="line-added">132     jcharArray jchars = (*javaEnv)-&gt;NewCharArray(javaEnv, count);</span>
<span class="line-added">133     (*javaEnv)-&gt;SetCharArrayRegion(javaEnv, jchars, 0, count, chars);</span>
<span class="line-added">134     (*javaEnv)-&gt;CallStaticVoidMethod(javaEnv, jAndroidInputDeviceRegistryClass, monocle_dispatchKeyEventFromNative,</span>
<span class="line-added">135                                      action, keyCode, jchars, mods);</span>
136 }
137 
138 void androidJfx_requestGlassToRedraw() {
139     GLASS_LOG_FINEST(&quot;Native code is notified that surface needs to be redrawn (repaintall)&quot;);
140     if (jVM == NULL) {
141         GLASS_LOG_WARNING(&quot;we can&#39;t do this yet, no jVM\n&quot;);
142         return;
143     }
144     if (javaEnv == NULL) {
145         jint error = (*jVM)-&gt;AttachCurrentThread(jVM, (void **)&amp;javaEnv, NULL);
146         GLASS_LOG_WARNING(&quot;result of attach: %d\n&quot;,error);
147     }
148     if (jMonocleWindowManagerClass == NULL) {
149         GLASS_LOG_WARNING(&quot;we can&#39;t do this yet, no jMonocleWindowManagerClass\n&quot;);
150         return;
151     }
152     if (monocle_repaintAll == NULL) {
153         GLASS_LOG_WARNING(&quot;we can&#39;t do this yet, no monocle_repaintAll\n&quot;);
154         return;
155     }
</pre>
</td>
</tr>
</table>
<center><a href="../../../java/com/sun/glass/ui/monocle/AndroidInputProcessor.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>