<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/platform/generic/ScrollAnimatorGeneric.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../ScrollAnimationKinetic.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollAnimatorGeneric.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/generic/ScrollAnimatorGeneric.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 38,28 ***</span>
  
  namespace WebCore {
  
  static const Seconds overflowScrollbarsAnimationDuration { 1_s };
  static const Seconds overflowScrollbarsAnimationHideDelay { 2_s };
<span class="line-removed">- static const Seconds scrollCaptureThreshold { 150_ms };</span>
  
  std::unique_ptr&lt;ScrollAnimator&gt; ScrollAnimator::create(ScrollableArea&amp; scrollableArea)
  {
      return makeUnique&lt;ScrollAnimatorGeneric&gt;(scrollableArea);
  }
  
  ScrollAnimatorGeneric::ScrollAnimatorGeneric(ScrollableArea&amp; scrollableArea)
      : ScrollAnimator(scrollableArea)
      , m_overlayScrollbarAnimationTimer(*this, &amp;ScrollAnimatorGeneric::overlayScrollbarAnimationTimerFired)
  {
<span class="line-modified">!     m_kineticAnimation = makeUnique&lt;ScrollAnimationKinetic&gt;(m_scrollableArea, [this](FloatPoint&amp;&amp; position) {</span>
  #if ENABLE(SMOOTH_SCROLLING)
<span class="line-modified">!         if (m_smoothAnimation)</span>
<span class="line-modified">!             m_smoothAnimation-&gt;setCurrentPosition(position);</span>
  #endif
<span class="line-modified">!         updatePosition(WTFMove(position));</span>
<span class="line-modified">!     });</span>
  
  #if ENABLE(SMOOTH_SCROLLING)
      if (scrollableArea.scrollAnimatorEnabled())
          ensureSmoothScrollingAnimation();
  #endif
<span class="line-new-header">--- 38,31 ---</span>
  
  namespace WebCore {
  
  static const Seconds overflowScrollbarsAnimationDuration { 1_s };
  static const Seconds overflowScrollbarsAnimationHideDelay { 2_s };
  
  std::unique_ptr&lt;ScrollAnimator&gt; ScrollAnimator::create(ScrollableArea&amp; scrollableArea)
  {
      return makeUnique&lt;ScrollAnimatorGeneric&gt;(scrollableArea);
  }
  
  ScrollAnimatorGeneric::ScrollAnimatorGeneric(ScrollableArea&amp; scrollableArea)
      : ScrollAnimator(scrollableArea)
      , m_overlayScrollbarAnimationTimer(*this, &amp;ScrollAnimatorGeneric::overlayScrollbarAnimationTimerFired)
  {
<span class="line-modified">!     m_kineticAnimation = makeUnique&lt;ScrollAnimationKinetic&gt;(</span>
<span class="line-added">+         [this]() -&gt; ScrollAnimationKinetic::ScrollExtents {</span>
<span class="line-added">+             return { m_scrollableArea.minimumScrollPosition(), m_scrollableArea.maximumScrollPosition() };</span>
<span class="line-added">+         },</span>
<span class="line-added">+         [this](FloatPoint&amp;&amp; position) {</span>
  #if ENABLE(SMOOTH_SCROLLING)
<span class="line-modified">!             if (m_smoothAnimation)</span>
<span class="line-modified">!                 m_smoothAnimation-&gt;setCurrentPosition(position);</span>
  #endif
<span class="line-modified">!             updatePosition(WTFMove(position));</span>
<span class="line-modified">!         });</span>
  
  #if ENABLE(SMOOTH_SCROLLING)
      if (scrollableArea.scrollAnimatorEnabled())
          ensureSmoothScrollingAnimation();
  #endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 92,70 ***</span>
  
  void ScrollAnimatorGeneric::scrollToOffsetWithoutAnimation(const FloatPoint&amp; offset, ScrollClamping)
  {
      FloatPoint position = ScrollableArea::scrollPositionFromOffset(offset, toFloatSize(m_scrollableArea.scrollOrigin()));
      m_kineticAnimation-&gt;stop();
<span class="line-modified">!     m_scrollHistory.clear();</span>
  
  #if ENABLE(SMOOTH_SCROLLING)
      if (m_smoothAnimation)
          m_smoothAnimation-&gt;setCurrentPosition(position);
  #endif
  
      updatePosition(WTFMove(position));
  }
  
<span class="line-removed">- FloatPoint ScrollAnimatorGeneric::computeVelocity()</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     if (m_scrollHistory.isEmpty())</span>
<span class="line-removed">-         return { };</span>
<span class="line-removed">- </span>
<span class="line-removed">-     auto first = m_scrollHistory[0].timestamp();</span>
<span class="line-removed">-     auto last = m_scrollHistory.rbegin()-&gt;timestamp();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (last == first)</span>
<span class="line-removed">-         return { };</span>
<span class="line-removed">- </span>
<span class="line-removed">-     FloatPoint accumDelta;</span>
<span class="line-removed">-     for (const auto&amp; scrollEvent : m_scrollHistory)</span>
<span class="line-removed">-         accumDelta += FloatPoint(scrollEvent.deltaX(), scrollEvent.deltaY());</span>
<span class="line-removed">- </span>
<span class="line-removed">-     m_scrollHistory.clear();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return FloatPoint(accumDelta.x() * -1 / (last - first).value(), accumDelta.y() * -1 / (last - first).value());</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  bool ScrollAnimatorGeneric::handleWheelEvent(const PlatformWheelEvent&amp; event)
  {
      m_kineticAnimation-&gt;stop();
  
<span class="line-removed">-     m_scrollHistory.removeAllMatching([&amp;event] (PlatformWheelEvent&amp; otherEvent) -&gt; bool {</span>
<span class="line-removed">-         return (event.timestamp() - otherEvent.timestamp()) &gt; scrollCaptureThreshold;</span>
<span class="line-removed">-     });</span>
<span class="line-removed">- </span>
  #if ENABLE(KINETIC_SCROLLING)
      if (event.isEndOfNonMomentumScroll()) {
<span class="line-modified">!         // We don&#39;t need to add the event to the history as its delta will be (0, 0).</span>
<span class="line-removed">-         static_cast&lt;ScrollAnimationKinetic*&gt;(m_kineticAnimation.get())-&gt;start(m_currentPosition, computeVelocity(), m_scrollableArea.horizontalScrollbar(), m_scrollableArea.verticalScrollbar());</span>
          return true;
      }
      if (event.isTransitioningToMomentumScroll()) {
<span class="line-modified">!         m_scrollHistory.clear();</span>
<span class="line-modified">!         static_cast&lt;ScrollAnimationKinetic*&gt;(m_kineticAnimation.get())-&gt;start(m_currentPosition, event.swipeVelocity(), m_scrollableArea.horizontalScrollbar(), m_scrollableArea.verticalScrollbar());</span>
          return true;
      }
  #endif
  
<span class="line-removed">-     m_scrollHistory.append(event);</span>
<span class="line-removed">- </span>
      return ScrollAnimator::handleWheelEvent(event);
  }
  
  void ScrollAnimatorGeneric::willEndLiveResize()
  {
<span class="line-removed">-     m_kineticAnimation-&gt;updateVisibleLengths();</span>
<span class="line-removed">- </span>
  #if ENABLE(SMOOTH_SCROLLING)
      if (m_smoothAnimation)
          m_smoothAnimation-&gt;updateVisibleLengths();
  #endif
  }
<span class="line-new-header">--- 95,43 ---</span>
  
  void ScrollAnimatorGeneric::scrollToOffsetWithoutAnimation(const FloatPoint&amp; offset, ScrollClamping)
  {
      FloatPoint position = ScrollableArea::scrollPositionFromOffset(offset, toFloatSize(m_scrollableArea.scrollOrigin()));
      m_kineticAnimation-&gt;stop();
<span class="line-modified">!     m_kineticAnimation-&gt;clearScrollHistory();</span>
  
  #if ENABLE(SMOOTH_SCROLLING)
      if (m_smoothAnimation)
          m_smoothAnimation-&gt;setCurrentPosition(position);
  #endif
  
      updatePosition(WTFMove(position));
  }
  
  bool ScrollAnimatorGeneric::handleWheelEvent(const PlatformWheelEvent&amp; event)
  {
      m_kineticAnimation-&gt;stop();
  
  #if ENABLE(KINETIC_SCROLLING)
<span class="line-added">+     m_kineticAnimation-&gt;appendToScrollHistory(event);</span>
<span class="line-added">+ </span>
      if (event.isEndOfNonMomentumScroll()) {
<span class="line-modified">!         m_kineticAnimation-&gt;start(m_currentPosition, m_kineticAnimation-&gt;computeVelocity(), m_scrollableArea.horizontalScrollbar(), m_scrollableArea.verticalScrollbar());</span>
          return true;
      }
      if (event.isTransitioningToMomentumScroll()) {
<span class="line-modified">!         m_kineticAnimation-&gt;clearScrollHistory();</span>
<span class="line-modified">!         m_kineticAnimation-&gt;start(m_currentPosition, event.swipeVelocity(), m_scrollableArea.horizontalScrollbar(), m_scrollableArea.verticalScrollbar());</span>
          return true;
      }
  #endif
  
      return ScrollAnimator::handleWheelEvent(event);
  }
  
  void ScrollAnimatorGeneric::willEndLiveResize()
  {
  #if ENABLE(SMOOTH_SCROLLING)
      if (m_smoothAnimation)
          m_smoothAnimation-&gt;updateVisibleLengths();
  #endif
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 167,12 ***</span>
      notifyPositionChanged(delta);
  }
  
  void ScrollAnimatorGeneric::didAddVerticalScrollbar(Scrollbar* scrollbar)
  {
<span class="line-removed">-     m_kineticAnimation-&gt;updateVisibleLengths();</span>
<span class="line-removed">- </span>
  #if ENABLE(SMOOTH_SCROLLING)
      if (m_smoothAnimation)
          m_smoothAnimation-&gt;updateVisibleLengths();
  #endif
      if (!scrollbar-&gt;isOverlayScrollbar())
<span class="line-new-header">--- 143,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 184,12 ***</span>
      hideOverlayScrollbars();
  }
  
  void ScrollAnimatorGeneric::didAddHorizontalScrollbar(Scrollbar* scrollbar)
  {
<span class="line-removed">-     m_kineticAnimation-&gt;updateVisibleLengths();</span>
<span class="line-removed">- </span>
  #if ENABLE(SMOOTH_SCROLLING)
      if (m_smoothAnimation)
          m_smoothAnimation-&gt;updateVisibleLengths();
  #endif
      if (!scrollbar-&gt;isOverlayScrollbar())
<span class="line-new-header">--- 158,10 ---</span>
</pre>
<center><a href="../ScrollAnimationKinetic.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollAnimatorGeneric.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>