<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff tests/system/src/test/java/test/javafx/scene/Snapshot2Test.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../modules/javafx.graphics/src/main/java/javafx/scene/Scene.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>tests/system/src/test/java/test/javafx/scene/Snapshot2Test.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package test.javafx.scene;
 27 
 28 import java.util.ArrayList;
 29 import java.util.Collection;


 30 import javafx.geometry.Rectangle2D;
 31 import javafx.scene.Group;
 32 import javafx.scene.Node;
 33 import javafx.scene.Scene;
 34 import javafx.scene.SnapshotParameters;
 35 import javafx.scene.SnapshotResult;


 36 import javafx.scene.image.WritableImage;

 37 import javafx.scene.shape.Rectangle;
 38 import javafx.scene.transform.Transform;
 39 import javafx.util.Callback;
 40 import org.junit.After;
 41 import org.junit.AfterClass;
 42 import org.junit.Before;
 43 import org.junit.BeforeClass;
 44 import org.junit.Test;
 45 import org.junit.runner.RunWith;
 46 import org.junit.runners.Parameterized;
 47 import org.junit.runners.Parameterized.Parameters;
 48 import test.util.Util;
 49 
 50 import static org.junit.Assert.*;
 51 
 52 /**
 53  * Test program for showAndWait functionality.
 54  */
 55 @RunWith(Parameterized.class)
 56 public class Snapshot2Test extends SnapshotCommon {
</pre>
<hr />
<pre>
226     private static final int SCENE_H = 100;
227     private static final int NODE_W = SCENE_W - 2*10;
228     private static final int NODE_H = SCENE_H - 2*5;
229 
230     private void setupSimpleScene() {
231         Util.runAndWait(() -&gt; {
232             tmpNode = new Rectangle(10, 5, NODE_W, NODE_H);
233             Group root = new Group();
234             tmpScene = new Scene(root, SCENE_W, SCENE_H);
235             root.getChildren().add(tmpNode);
236             if (live) {
237                 tmpStage = new TestStage(tmpScene);
238                 assertNotNull(tmpScene.getWindow());
239                 tmpStage.show();
240             } else {
241                 assertNull(tmpScene.getWindow());
242             }
243         });
244     }
245 





























246     // Test snapshot of a simple scene
247 
248     @Test
249     public void testSnapshotSimpleSceneImm() {
250         setupSimpleScene();
251 
252         final WritableImage img = useImage ? new WritableImage(SCENE_W, SCENE_H) : null;
253         Util.runAndWait(() -&gt; {
254             WritableImage wimg = tmpScene.snapshot(img);
255             assertNotNull(wimg);
256             if (img != null) {
257                 assertSame(img, wimg);
258             }
259 
260             assertEquals(SCENE_W, (int)wimg.getWidth());
261             assertEquals(SCENE_H, (int)wimg.getHeight());
262         });
263     }
264 
265     @Test
</pre>
<hr />
<pre>
302     @Test
303     public void testSnapshotSimpleNodeDefer() {
304         setupSimpleScene();
305         final SnapshotParameters snapshotParams = new SnapshotParameters();
306         final WritableImage img = useImage ? new WritableImage(NODE_W, NODE_H) : null;
307         runDeferredSnapshotWait(tmpScene.getRoot(), result -&gt; {
308             assertSame(tmpScene.getRoot(), result.getSource());
309             assertNotNull(result.getSnapshotParameters());
310             assertNotNull(result.getImage());
311             if (img != null) {
312                 assertSame(img, result.getImage());
313             }
314 
315             assertEquals(NODE_W, (int)result.getImage().getWidth());
316             assertEquals(NODE_H, (int)result.getImage().getHeight());
317 
318             return null;
319         }, snapshotParams, img);
320     }
321 













































































































































322     // Test node snapshot with a scale transform
323 
324     private void doTestSnapshotScaleNodeImm(int xScale, int yScale) {
325         setupSimpleScene();
326         final SnapshotParameters snapshotParams = new SnapshotParameters();
327         snapshotParams.setTransform(Transform.scale(xScale, yScale));
328         final int WIDTH = NODE_W * xScale;
329         final int HEIGHT = NODE_H * yScale;
330         final WritableImage img = useImage ? new WritableImage(WIDTH, HEIGHT) : null;
331         Util.runAndWait(() -&gt; {
332             WritableImage wimg = tmpScene.getRoot().snapshot(snapshotParams, img);
333             assertNotNull(wimg);
334             if (img != null) {
335                 assertSame(img, wimg);
336             }
337 
338             assertEquals(WIDTH, (int)wimg.getWidth());
339             assertEquals(HEIGHT, (int)wimg.getHeight());
340         });
341     }
</pre>
</td>
<td>
<hr />
<pre>
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package test.javafx.scene;
 27 
 28 import java.util.ArrayList;
 29 import java.util.Collection;
<span class="line-added"> 30 import java.util.concurrent.ThreadLocalRandom;</span>
<span class="line-added"> 31 import java.util.stream.IntStream;</span>
 32 import javafx.geometry.Rectangle2D;
 33 import javafx.scene.Group;
 34 import javafx.scene.Node;
 35 import javafx.scene.Scene;
 36 import javafx.scene.SnapshotParameters;
 37 import javafx.scene.SnapshotResult;
<span class="line-added"> 38 import javafx.scene.image.Image;</span>
<span class="line-added"> 39 import javafx.scene.image.ImageView;</span>
 40 import javafx.scene.image.WritableImage;
<span class="line-added"> 41 import javafx.scene.paint.Color;</span>
 42 import javafx.scene.shape.Rectangle;
 43 import javafx.scene.transform.Transform;
 44 import javafx.util.Callback;
 45 import org.junit.After;
 46 import org.junit.AfterClass;
 47 import org.junit.Before;
 48 import org.junit.BeforeClass;
 49 import org.junit.Test;
 50 import org.junit.runner.RunWith;
 51 import org.junit.runners.Parameterized;
 52 import org.junit.runners.Parameterized.Parameters;
 53 import test.util.Util;
 54 
 55 import static org.junit.Assert.*;
 56 
 57 /**
 58  * Test program for showAndWait functionality.
 59  */
 60 @RunWith(Parameterized.class)
 61 public class Snapshot2Test extends SnapshotCommon {
</pre>
<hr />
<pre>
231     private static final int SCENE_H = 100;
232     private static final int NODE_W = SCENE_W - 2*10;
233     private static final int NODE_H = SCENE_H - 2*5;
234 
235     private void setupSimpleScene() {
236         Util.runAndWait(() -&gt; {
237             tmpNode = new Rectangle(10, 5, NODE_W, NODE_H);
238             Group root = new Group();
239             tmpScene = new Scene(root, SCENE_W, SCENE_H);
240             root.getChildren().add(tmpNode);
241             if (live) {
242                 tmpStage = new TestStage(tmpScene);
243                 assertNotNull(tmpScene.getWindow());
244                 tmpStage.show();
245             } else {
246                 assertNull(tmpScene.getWindow());
247             }
248         });
249     }
250 
<span class="line-added">251     private void setupImageScene(int width, int height) {</span>
<span class="line-added">252         Util.runAndWait(() -&gt; {</span>
<span class="line-added">253             WritableImage image = new WritableImage(width, height);</span>
<span class="line-added">254             // Initialize image with noise</span>
<span class="line-added">255             var pixWriter = image.getPixelWriter();</span>
<span class="line-added">256             assertNotNull(pixWriter);</span>
<span class="line-added">257             for (int x = 0; x &lt; width; x++) {</span>
<span class="line-added">258                 for (int y = 0; y &lt; height; y++) {</span>
<span class="line-added">259                     pixWriter.setColor(x, y, Color.rgb(</span>
<span class="line-added">260                             ThreadLocalRandom.current().nextInt(0, 256),</span>
<span class="line-added">261                             ThreadLocalRandom.current().nextInt(0, 256),</span>
<span class="line-added">262                             ThreadLocalRandom.current().nextInt(0, 256)));</span>
<span class="line-added">263                 }</span>
<span class="line-added">264             }</span>
<span class="line-added">265             tmpNode = new ImageView(image);</span>
<span class="line-added">266             Group root = new Group();</span>
<span class="line-added">267             tmpScene = new Scene(root, width, height);</span>
<span class="line-added">268             root.getChildren().add(tmpNode);</span>
<span class="line-added">269             if (live) {</span>
<span class="line-added">270                 tmpStage = new TestStage(tmpScene);</span>
<span class="line-added">271                 assertNotNull(tmpScene.getWindow());</span>
<span class="line-added">272                 tmpStage.show();</span>
<span class="line-added">273             }</span>
<span class="line-added">274             else {</span>
<span class="line-added">275                 assertNull(tmpScene.getWindow());</span>
<span class="line-added">276             }</span>
<span class="line-added">277         });</span>
<span class="line-added">278     }</span>
<span class="line-added">279 </span>
280     // Test snapshot of a simple scene
281 
282     @Test
283     public void testSnapshotSimpleSceneImm() {
284         setupSimpleScene();
285 
286         final WritableImage img = useImage ? new WritableImage(SCENE_W, SCENE_H) : null;
287         Util.runAndWait(() -&gt; {
288             WritableImage wimg = tmpScene.snapshot(img);
289             assertNotNull(wimg);
290             if (img != null) {
291                 assertSame(img, wimg);
292             }
293 
294             assertEquals(SCENE_W, (int)wimg.getWidth());
295             assertEquals(SCENE_H, (int)wimg.getHeight());
296         });
297     }
298 
299     @Test
</pre>
<hr />
<pre>
336     @Test
337     public void testSnapshotSimpleNodeDefer() {
338         setupSimpleScene();
339         final SnapshotParameters snapshotParams = new SnapshotParameters();
340         final WritableImage img = useImage ? new WritableImage(NODE_W, NODE_H) : null;
341         runDeferredSnapshotWait(tmpScene.getRoot(), result -&gt; {
342             assertSame(tmpScene.getRoot(), result.getSource());
343             assertNotNull(result.getSnapshotParameters());
344             assertNotNull(result.getImage());
345             if (img != null) {
346                 assertSame(img, result.getImage());
347             }
348 
349             assertEquals(NODE_W, (int)result.getImage().getWidth());
350             assertEquals(NODE_H, (int)result.getImage().getHeight());
351 
352             return null;
353         }, snapshotParams, img);
354     }
355 
<span class="line-added">356     // Test tiled snapshots</span>
<span class="line-added">357 </span>
<span class="line-added">358     private void doTestTiledSnapshotImm(int w, int h) {</span>
<span class="line-added">359         setupImageScene(w, h);</span>
<span class="line-added">360         Image original = ((ImageView) tmpNode).getImage();</span>
<span class="line-added">361         assertNotNull(original);</span>
<span class="line-added">362         WritableImage buffer = useImage ? new WritableImage(w, h) : null;</span>
<span class="line-added">363         Util.runAndWait(() -&gt; {</span>
<span class="line-added">364             WritableImage snapshot = tmpNode.snapshot(null, buffer);</span>
<span class="line-added">365             assertNotNull(snapshot);</span>
<span class="line-added">366             if (buffer != null) {</span>
<span class="line-added">367                 assertSame(buffer, snapshot);</span>
<span class="line-added">368             }</span>
<span class="line-added">369             assertTrue(comparePixels(original, snapshot));</span>
<span class="line-added">370         });</span>
<span class="line-added">371     }</span>
<span class="line-added">372 </span>
<span class="line-added">373     private void doTestTiledSnapshotDefer(int w, int h) {</span>
<span class="line-added">374         setupImageScene(w, h);</span>
<span class="line-added">375         Image original = ((ImageView) tmpNode).getImage();</span>
<span class="line-added">376         assertNotNull(original);</span>
<span class="line-added">377         WritableImage buffer = useImage ? new WritableImage(w, h) : null;</span>
<span class="line-added">378         runDeferredSnapshotWait(tmpScene.getRoot(), result -&gt; {</span>
<span class="line-added">379             assertSame(tmpScene.getRoot(), result.getSource());</span>
<span class="line-added">380             assertNotNull(result.getSnapshotParameters());</span>
<span class="line-added">381             assertNotNull(result.getImage());</span>
<span class="line-added">382             if (buffer != null) {</span>
<span class="line-added">383                 assertSame(buffer, result.getImage());</span>
<span class="line-added">384             }</span>
<span class="line-added">385             assertTrue(comparePixels(original, result.getImage()));</span>
<span class="line-added">386             return null;</span>
<span class="line-added">387         }, null, buffer);</span>
<span class="line-added">388     }</span>
<span class="line-added">389 </span>
<span class="line-added">390     private boolean comparePixels(Image imageA, Image imageB) {</span>
<span class="line-added">391         if (imageA == null) {</span>
<span class="line-added">392             return false;</span>
<span class="line-added">393         }</span>
<span class="line-added">394         if (imageB == null) {</span>
<span class="line-added">395             return false;</span>
<span class="line-added">396         }</span>
<span class="line-added">397         int width = (int)imageA.getWidth();</span>
<span class="line-added">398         if (width != (int)imageB.getWidth()) {</span>
<span class="line-added">399             return false;</span>
<span class="line-added">400         }</span>
<span class="line-added">401         int height = (int)imageA.getHeight();</span>
<span class="line-added">402         if (height != (int)imageB.getHeight()) {</span>
<span class="line-added">403             return false;</span>
<span class="line-added">404         }</span>
<span class="line-added">405         var pixRdrA = imageA.getPixelReader();</span>
<span class="line-added">406         var pixRdrB = imageB.getPixelReader();</span>
<span class="line-added">407         for (int x = 0; x &lt; width; x++) {</span>
<span class="line-added">408             for (int y = 0; y &lt; height; y++) {</span>
<span class="line-added">409                 if (pixRdrA.getArgb(x, y) != pixRdrB.getArgb(x, y)) {</span>
<span class="line-added">410                     return false;</span>
<span class="line-added">411                 }</span>
<span class="line-added">412             }</span>
<span class="line-added">413         }</span>
<span class="line-added">414         return true;</span>
<span class="line-added">415     }</span>
<span class="line-added">416 </span>
<span class="line-added">417     @Test</span>
<span class="line-added">418     public void testSnapshot2x1TilesSameSizeImm() {</span>
<span class="line-added">419         doTestTiledSnapshotImm(4100, 10);</span>
<span class="line-added">420     }</span>
<span class="line-added">421 </span>
<span class="line-added">422     @Test</span>
<span class="line-added">423     public void testSnapshot2x1TilesDifferentSizeImm() {</span>
<span class="line-added">424         doTestTiledSnapshotImm(4099, 10);</span>
<span class="line-added">425     }</span>
<span class="line-added">426 </span>
<span class="line-added">427     @Test</span>
<span class="line-added">428     public void testSnapshot1x2TilesSameSizeImm() {</span>
<span class="line-added">429         doTestTiledSnapshotImm(10, 4100);</span>
<span class="line-added">430     }</span>
<span class="line-added">431 </span>
<span class="line-added">432     @Test</span>
<span class="line-added">433     public void testSnapshot1x2TilesDifferentSizeImm() {</span>
<span class="line-added">434         doTestTiledSnapshotImm(10, 4099);</span>
<span class="line-added">435     }</span>
<span class="line-added">436 </span>
<span class="line-added">437     @Test</span>
<span class="line-added">438     public void testSnapshot2x2TilesSameSizeImm() {</span>
<span class="line-added">439         doTestTiledSnapshotImm(4100, 4100);</span>
<span class="line-added">440     }</span>
<span class="line-added">441 </span>
<span class="line-added">442     @Test</span>
<span class="line-added">443     public void testSnapshot2x2TilesDifferentSizeImm() {</span>
<span class="line-added">444         doTestTiledSnapshotImm(4099, 4099);</span>
<span class="line-added">445     }</span>
<span class="line-added">446 </span>
<span class="line-added">447     @Test</span>
<span class="line-added">448     public void testSnapshot2x2TilesSameHeightImm() {</span>
<span class="line-added">449         doTestTiledSnapshotImm(4099, 4100);</span>
<span class="line-added">450     }</span>
<span class="line-added">451 </span>
<span class="line-added">452     @Test</span>
<span class="line-added">453     public void testSnapshot2x2TilesSameWidthImm() {</span>
<span class="line-added">454         doTestTiledSnapshotImm(4100, 4099);</span>
<span class="line-added">455     }</span>
<span class="line-added">456 </span>
<span class="line-added">457     @Test</span>
<span class="line-added">458     public void testSnapshot2x1TilesSameSizeDefer() {</span>
<span class="line-added">459         doTestTiledSnapshotDefer(4100, 10);</span>
<span class="line-added">460     }</span>
<span class="line-added">461 </span>
<span class="line-added">462     @Test</span>
<span class="line-added">463     public void testSnapshot2x1TilesDifferentSizeDefer() {</span>
<span class="line-added">464         doTestTiledSnapshotDefer(4099, 10);</span>
<span class="line-added">465     }</span>
<span class="line-added">466 </span>
<span class="line-added">467     @Test</span>
<span class="line-added">468     public void testSnapshot1x2TilesSameSizeDefer() {</span>
<span class="line-added">469         doTestTiledSnapshotDefer(10, 4100);</span>
<span class="line-added">470     }</span>
<span class="line-added">471 </span>
<span class="line-added">472     @Test</span>
<span class="line-added">473     public void testSnapshot1x2TilesDifferentSizeDefer() {</span>
<span class="line-added">474         doTestTiledSnapshotDefer(10, 4099);</span>
<span class="line-added">475     }</span>
<span class="line-added">476 </span>
<span class="line-added">477     @Test</span>
<span class="line-added">478     public void testSnapshot2x2TilesSameSizeDefer() {</span>
<span class="line-added">479         doTestTiledSnapshotDefer(4100, 4100);</span>
<span class="line-added">480     }</span>
<span class="line-added">481 </span>
<span class="line-added">482     @Test</span>
<span class="line-added">483     public void testSnapshot2x2TilesDifferentSizeDefer() {</span>
<span class="line-added">484         doTestTiledSnapshotDefer(4099, 4099);</span>
<span class="line-added">485     }</span>
<span class="line-added">486 </span>
<span class="line-added">487     @Test</span>
<span class="line-added">488     public void testSnapshot2x2TilesSameHeightDefer() {</span>
<span class="line-added">489         doTestTiledSnapshotDefer(4099, 4100);</span>
<span class="line-added">490     }</span>
<span class="line-added">491 </span>
<span class="line-added">492     @Test</span>
<span class="line-added">493     public void testSnapshot2x2TilesSameWidthDefer() {</span>
<span class="line-added">494         doTestTiledSnapshotDefer(4100, 4099);</span>
<span class="line-added">495     }</span>
<span class="line-added">496 </span>
497     // Test node snapshot with a scale transform
498 
499     private void doTestSnapshotScaleNodeImm(int xScale, int yScale) {
500         setupSimpleScene();
501         final SnapshotParameters snapshotParams = new SnapshotParameters();
502         snapshotParams.setTransform(Transform.scale(xScale, yScale));
503         final int WIDTH = NODE_W * xScale;
504         final int HEIGHT = NODE_H * yScale;
505         final WritableImage img = useImage ? new WritableImage(WIDTH, HEIGHT) : null;
506         Util.runAndWait(() -&gt; {
507             WritableImage wimg = tmpScene.getRoot().snapshot(snapshotParams, img);
508             assertNotNull(wimg);
509             if (img != null) {
510                 assertSame(img, wimg);
511             }
512 
513             assertEquals(WIDTH, (int)wimg.getWidth());
514             assertEquals(HEIGHT, (int)wimg.getHeight());
515         });
516     }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../modules/javafx.graphics/src/main/java/javafx/scene/Scene.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>