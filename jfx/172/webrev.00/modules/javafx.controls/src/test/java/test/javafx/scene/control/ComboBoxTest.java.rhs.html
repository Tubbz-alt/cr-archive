<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.controls/src/test/java/test/javafx/scene/control/ComboBoxTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package test.javafx.scene.control;
  27 
  28 import test.com.sun.javafx.scene.control.infrastructure.KeyModifier;
  29 import test.com.sun.javafx.scene.control.infrastructure.MouseEventFirer;
  30 import com.sun.javafx.tk.Toolkit;
  31 import javafx.css.PseudoClass;
  32 
  33 import test.com.sun.javafx.scene.control.infrastructure.KeyEventFirer;
  34 import test.com.sun.javafx.scene.control.infrastructure.StageLoader;
  35 import javafx.scene.control.skin.ComboBoxListViewSkin;
  36 
  37 import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.assertStyleClassContains;
  38 import static org.junit.Assert.*;
  39 import static org.junit.Assert.assertEquals;
  40 
  41 import java.util.*;
  42 import java.util.concurrent.atomic.AtomicInteger;
  43 
  44 import javafx.beans.property.ObjectProperty;
  45 import javafx.beans.property.SimpleObjectProperty;
  46 import javafx.beans.property.SimpleStringProperty;
  47 import javafx.beans.property.StringProperty;
  48 import javafx.collections.FXCollections;
  49 import javafx.collections.ObservableList;
  50 import javafx.event.ActionEvent;
  51 import javafx.event.EventHandler;
  52 import javafx.scene.Node;
  53 import javafx.scene.Scene;
  54 import javafx.scene.control.Button;
  55 import javafx.scene.control.ComboBox;
  56 import javafx.scene.control.ComboBoxShim;
  57 import javafx.scene.control.IndexedCell;
  58 import javafx.scene.control.Label;
  59 import javafx.scene.control.ListCell;
  60 import javafx.scene.control.ListCellShim;
  61 import javafx.scene.control.ListView;
  62 import javafx.scene.control.SelectionModel;
  63 import javafx.scene.control.SelectionModelShim;
  64 import javafx.scene.control.SingleSelectionModel;
  65 import javafx.scene.control.Tab;
  66 import javafx.scene.control.TabPane;
  67 import javafx.scene.control.TextField;
  68 import javafx.scene.control.Tooltip;
  69 import javafx.scene.control.skin.VirtualFlow;
  70 import javafx.scene.input.KeyCode;
  71 import javafx.scene.layout.BorderPane;
  72 import javafx.scene.layout.FlowPane;
  73 import javafx.scene.layout.VBox;
  74 import javafx.scene.paint.Color;
  75 import javafx.scene.shape.Circle;
  76 import javafx.stage.Stage;
  77 import javafx.util.Callback;
  78 import javafx.util.StringConverter;
  79 
  80 import org.junit.After;
  81 import org.junit.Before;
  82 import org.junit.Ignore;
  83 import org.junit.Test;
  84 
  85 public class ComboBoxTest {
  86     private ComboBox&lt;String&gt; comboBox;
  87     private SingleSelectionModel&lt;String&gt; sm;
  88 
  89     /*********************************************************************
  90      *                                                                   *
  91      * Utility methods                                                   *
  92      *                                                                   *
  93      ********************************************************************/
  94 
  95     public ListView getListView() {
  96         return (ListView) ((ComboBoxListViewSkin)comboBox.getSkin()).getPopupContent();
  97     }
  98 
  99     public Node getDisplayNode() {
 100         return ((ComboBoxListViewSkin)comboBox.getSkin()).getDisplayNode();
 101     }
 102 
 103 
 104 
 105     /*********************************************************************
 106      *                                                                   *
 107      * Setup                                                             *
 108      *                                                                   *
 109      ********************************************************************/
 110 
 111     @Before public void setup() {
 112         Thread.currentThread().setUncaughtExceptionHandler((thread, throwable) -&gt; {
 113             if (throwable instanceof RuntimeException) {
 114                 throw (RuntimeException)throwable;
 115             } else {
 116                 Thread.currentThread().getThreadGroup().uncaughtException(thread, throwable);
 117             }
 118         });
 119 
 120         comboBox = new ComboBox&lt;String&gt;();
 121         comboBox.setSkin(new ComboBoxListViewSkin&lt;&gt;(comboBox));
 122         sm = comboBox.getSelectionModel();
 123     }
 124 
 125     @After public void cleanup() {
 126         Thread.currentThread().setUncaughtExceptionHandler(null);
 127     }
 128 
 129     /*********************************************************************
 130      *                                                                   *
 131      * Tests for the constructors                                        *
 132      *                                                                   *
 133      ********************************************************************/
 134 
 135     @Test public void noArgConstructorSetsTheStyleClass() {
 136         assertStyleClassContains(comboBox, &quot;combo-box&quot;);
 137     }
 138 
 139     @Test public void noArgConstructorSetsNonNullSelectionModel() {
 140         assertNotNull(sm);
 141     }
 142 
 143     @Test public void noArgConstructorSetsNonNullItems() {
 144         assertNotNull(comboBox.getItems());
 145     }
 146 
 147     @Test public void noArgConstructor_selectedItemIsNull() {
 148         assertNull(sm.getSelectedItem());
 149     }
 150 
 151     @Test public void noArgConstructor_selectedIndexIsNegativeOne() {
 152         assertEquals(-1, sm.getSelectedIndex());
 153     }
 154 
 155     @Test public void noArgConstructor_valueIsNull() {
 156         assertNull(comboBox.getValue());
 157     }
 158 
 159     @Test public void noArgConstructor_editableIsFalse() {
 160         assertFalse(comboBox.isEditable());
 161     }
 162 
 163     @Test public void noArgConstructor_showingIsFalse() {
 164         assertFalse(comboBox.isShowing());
 165     }
 166 
 167     @Test public void noArgConstructor_promptTextIsEmptyString() {
 168         assertNull(comboBox.getPromptText());
 169     }
 170 
 171     @Test public void noArgConstructor_placeholderIsNull() {
 172         assertNull(comboBox.getPlaceholder());
 173     }
 174 
 175     @Test public void noArgConstructor_armedIsFalse() {
 176         assertFalse(comboBox.isArmed());
 177     }
 178 
 179     @Test public void noArgConstructor_converterIsNotNull() {
 180         assertNotNull(comboBox.getConverter());
 181     }
 182 
 183     @Test public void noArgConstructor_cellFactoryIsNull() {
 184         assertNull(comboBox.getCellFactory());
 185     }
 186 
 187     @Test public void noArgConstructor_visibleRowFactoryIs10() {
 188         assertEquals(10, comboBox.getVisibleRowCount());
 189     }
 190 
 191     @Test public void singleArgConstructorSetsTheStyleClass() {
 192         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 193         assertStyleClassContains(b2, &quot;combo-box&quot;);
 194     }
 195 
 196     @Test public void singleArgConstructorSetsNonNullSelectionModel() {
 197         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 198         assertNotNull(b2.getSelectionModel());
 199     }
 200 
 201     @Test public void singleArgConstructorAllowsNullItems() {
 202         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(null);
 203         assertNull(b2.getItems());
 204     }
 205 
 206     @Test public void singleArgConstructorTakesItems() {
 207         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;Hi&quot;);
 208         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(items);
 209         assertSame(items, b2.getItems());
 210     }
 211 
 212     @Test public void singleArgConstructor_selectedItemIsNull() {
 213         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 214         assertNull(b2.getSelectionModel().getSelectedItem());
 215     }
 216 
 217     @Test public void singleArgConstructor_selectedIndexIsNegativeOne() {
 218         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 219         assertEquals(-1, b2.getSelectionModel().getSelectedIndex());
 220     }
 221 
 222     @Test public void singleArgConstructor_valueIsNull() {
 223         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 224         assertNull(b2.getValue());
 225     }
 226 
 227     @Test public void singleArgConstructor_editableIsFalse() {
 228         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 229         assertFalse(b2.isEditable());
 230     }
 231 
 232     @Test public void singleArgConstructor_showingIsFalse() {
 233         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 234         assertFalse(b2.isShowing());
 235     }
 236 
 237     @Test public void singleArgConstructor_promptTextIsEmptyString() {
 238         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 239         assertNull(b2.getPromptText());
 240     }
 241 
 242     @Test public void singleArgConstructor_placeholderIsNull() {
 243         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 244         assertNull(b2.getPlaceholder());
 245     }
 246 
 247     @Test public void singleArgConstructor_armedIsFalse() {
 248         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 249         assertEquals(false, b2.isArmed());
 250     }
 251 
 252     @Test public void singleArgConstructor_converterIsNotNull() {
 253         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 254         assertNotNull(b2.getConverter());
 255     }
 256 
 257     @Test public void singleArgConstructor_cellFactoryIsNull() {
 258         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 259         assertNull(b2.getCellFactory());
 260     }
 261 
 262     @Test public void singleArgConstructor_visibleRowFactoryIs10() {
 263         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 264         assertEquals(10, b2.getVisibleRowCount());
 265     }
 266 
 267     /*********************************************************************
 268      * Tests for selection model                                         *
 269      ********************************************************************/
 270 
 271     @Test public void selectionModelCanBeNull() {
 272         comboBox.setSelectionModel(null);
 273         assertNull(comboBox.getSelectionModel());
 274     }
 275 
 276     @Test public void selectionModelCanBeBound() {
 277         SingleSelectionModel&lt;String&gt; sm = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 278         ObjectProperty&lt;SingleSelectionModel&lt;String&gt;&gt; other = new SimpleObjectProperty&lt;SingleSelectionModel&lt;String&gt;&gt;(sm);
 279         comboBox.selectionModelProperty().bind(other);
 280         assertSame(sm, sm);
 281     }
 282 
 283     @Test public void selectionModelCanBeChanged() {
 284         SingleSelectionModel&lt;String&gt; sm = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 285         comboBox.setSelectionModel(sm);
 286         assertSame(sm, sm);
 287     }
 288 
 289     @Test public void canSetSelectedItemToAnItemEvenWhenThereAreNoItems() {
 290         final String randomString = new String(&quot;I AM A CRAZY RANDOM STRING&quot;);
 291         sm.select(randomString);
 292         assertEquals(-1, sm.getSelectedIndex());
 293         assertSame(randomString, sm.getSelectedItem());
 294     }
 295 
 296     @Test public void canSetSelectedItemToAnItemNotInTheDataModel() {
 297         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 298         final String randomString = new String(&quot;I AM A CRAZY RANDOM STRING&quot;);
 299         sm.select(randomString);
 300         assertEquals(-1, sm.getSelectedIndex());
 301         assertSame(randomString, sm.getSelectedItem());
 302     }
 303 
 304     @Test public void settingTheSelectedItemToAnItemInItemsResultsInTheCorrectSelectedIndex() {
 305         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 306         sm.select(&quot;Orange&quot;);
 307         assertEquals(1, sm.getSelectedIndex());
 308         assertSame(&quot;Orange&quot;, sm.getSelectedItem());
 309     }
 310 
 311     @Test public void settingTheSelectedItemToANonexistantItemAndThenSettingItemsWhichContainsItResultsInCorrectSelectedIndex() {
 312         sm.select(&quot;Orange&quot;);
 313         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 314         assertEquals(1, sm.getSelectedIndex());
 315         assertSame(&quot;Orange&quot;, sm.getSelectedItem());
 316     }
 317 
 318     @Test public void ensureSelectionClearsWhenAllItemsAreRemoved_selectIndex0() {
 319         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 320         sm.select(0);
 321         comboBox.getItems().clear();
 322         assertEquals(-1, sm.getSelectedIndex());
 323         assertEquals(null, sm.getSelectedItem());
 324     }
 325 
 326     @Test public void ensureSelectionClearsWhenAllItemsAreRemoved_selectIndex2() {
 327         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 328         sm.select(2);
 329         comboBox.getItems().clear();
 330         assertEquals(-1, sm.getSelectedIndex());
 331         assertEquals(null, sm.getSelectedItem());
 332     }
 333 
 334     @Test public void ensureSelectedItemRemainsAccurateWhenItemsAreCleared() {
 335         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 336         sm.select(2);
 337         comboBox.getItems().clear();
 338         assertNull(sm.getSelectedItem());
 339         assertEquals(-1, sm.getSelectedIndex());
 340 
 341         comboBox.getItems().addAll(&quot;Kiwifruit&quot;, &quot;Mandarin&quot;, &quot;Pineapple&quot;);
 342         sm.select(2);
 343         assertEquals(&quot;Pineapple&quot;, sm.getSelectedItem());
 344     }
 345 
 346     @Test public void ensureSelectionShiftsDownWhenOneNewItemIsAdded() {
 347         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 348         sm.select(1);
 349         assertEquals(1, sm.getSelectedIndex());
 350         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 351 
 352         comboBox.getItems().add(0, &quot;Kiwifruit&quot;);
 353         assertEquals(2, sm.getSelectedIndex());
 354         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 355     }
 356 
 357     @Test public void ensureSelectionShiftsDownWhenMultipleNewItemAreAdded() {
 358         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 359         sm.select(1);
 360         assertEquals(1, sm.getSelectedIndex());
 361         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 362 
 363         comboBox.getItems().addAll(0, Arrays.asList(&quot;Kiwifruit&quot;, &quot;Pineapple&quot;, &quot;Mandarin&quot;));
 364         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 365         assertEquals(4, sm.getSelectedIndex());
 366     }
 367 
 368     @Test public void ensureSelectionShiftsUpWhenOneItemIsRemoved() {
 369         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 370         sm.select(1);
 371         assertEquals(1, sm.getSelectedIndex());
 372         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 373 
 374         comboBox.getItems().remove(&quot;Apple&quot;);
 375         assertEquals(0, sm.getSelectedIndex());
 376         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 377     }
 378 
 379     @Test public void ensureSelectionShiftsUpWheMultipleItemsAreRemoved() {
 380         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 381         sm.select(2);
 382         assertEquals(2, sm.getSelectedIndex());
 383         assertEquals(&quot;Banana&quot;, sm.getSelectedItem());
 384 
 385         comboBox.getItems().removeAll(Arrays.asList(&quot;Apple&quot;, &quot;Orange&quot;));
 386         assertEquals(0, sm.getSelectedIndex());
 387         assertEquals(&quot;Banana&quot;, sm.getSelectedItem());
 388     }
 389 
 390     @Test public void ensureSelectionIsCorrectWhenItemsChange() {
 391         comboBox.setItems(FXCollections.observableArrayList(&quot;Item 1&quot;));
 392         sm.select(0);
 393         assertEquals(&quot;Item 1&quot;, sm.getSelectedItem());
 394 
 395         comboBox.setItems(FXCollections.observableArrayList(&quot;Item 2&quot;));
 396         assertEquals(-1, sm.getSelectedIndex());
 397         assertEquals(null, sm.getSelectedItem());
 398     }
 399 
 400     @Test(expected=NullPointerException.class)
 401     public void selectionModelComboBoxReferenceCanNotBeNull() {
 402         ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(null);
 403     }
 404 
 405     @Test public void ensureGetModelItemOutOfBoundsWorks_1() {
 406         ComboBox cb = new ComboBox(null);
 407         cb.getSelectionModel().select(-1);
 408         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
 409     }
 410 
 411     @Test public void ensureGetModelItemOutOfBoundsWorks_2() {
 412         ComboBox cb = new ComboBox(null);
 413         cb.getSelectionModel().select(0);
 414         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
 415     }
 416 
 417     @Test public void test_rt15793() {
 418         // ComboBox selectedIndex is 0 although the items list is empty
 419         final ComboBox lv = new ComboBox();
 420         final ObservableList list = FXCollections.observableArrayList();
 421         lv.setItems(list);
 422         list.add(&quot;toto&quot;);
 423         lv.getSelectionModel().select(0);
 424         assertEquals(0, lv.getSelectionModel().getSelectedIndex());
 425         list.remove(0);
 426         assertEquals(-1, lv.getSelectionModel().getSelectedIndex());
 427     }
 428 
 429     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectIndex() {
 430         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 431         assertNull(comboBox.getValue());
 432         sm.select(0);
 433         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 434     }
 435 
 436     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectItem() {
 437         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 438         assertNull(comboBox.getValue());
 439         sm.select(&quot;Apple&quot;);
 440         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 441     }
 442 
 443     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectPrevious() {
 444         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 445         assertNull(comboBox.getValue());
 446         sm.select(2);
 447         sm.selectPrevious();
 448         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 449     }
 450 
 451     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectNext() {
 452         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 453         assertNull(comboBox.getValue());
 454         sm.select(&quot;Apple&quot;);
 455         sm.selectNext();
 456         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 457     }
 458 
 459     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectFirst() {
 460         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 461         assertNull(comboBox.getValue());
 462         sm.selectFirst();
 463         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 464     }
 465 
 466     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectLast() {
 467         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 468         assertNull(comboBox.getValue());
 469         sm.selectLast();
 470         assertEquals(&quot;Banana&quot;, comboBox.getValue());
 471     }
 472 
 473     @Test public void ensureSelectionModelClearsValueProperty() {
 474         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 475         assertNull(comboBox.getValue());
 476         sm.select(0);
 477         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 478 
 479         sm.clearSelection();
 480         assertNull(comboBox.getValue());
 481     }
 482 
 483     @Test public void ensureSelectionModelClearsValuePropertyWhenNegativeOneSelected() {
 484         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 485         assertNull(comboBox.getValue());
 486         sm.select(0);
 487         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 488 
 489         sm.select(-1);
 490         assertNull(&quot;Expected null, actual value: &quot; + comboBox.getValue(), comboBox.getValue());
 491     }
 492 
 493     @Test public void ensureValueIsCorrectWhenItemsIsAddedToWithExistingSelection() {
 494         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 495         sm.select(1);
 496 
 497         comboBox.getItems().add(0, &quot;Kiwifruit&quot;);
 498 
 499         assertEquals(2, sm.getSelectedIndex());
 500         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 501         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 502     }
 503 
 504     @Test public void ensureValueIsCorrectWhenItemsAreRemovedWithExistingSelection() {
 505         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 506         sm.select(1);
 507 
 508         comboBox.getItems().remove(&quot;Apple&quot;);
 509 
 510         assertEquals(0, sm.getSelectedIndex());
 511         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 512         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 513     }
 514 
 515     @Test public void ensureValueIsUpdatedByCorrectSelectionModelWhenSelectionModelIsChanged() {
 516         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 517         SingleSelectionModel sm1 = sm;
 518         sm1.select(1);
 519         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 520 
 521         SingleSelectionModel sm2 = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 522         comboBox.setSelectionModel(sm2);
 523 
 524         sm1.select(2);  // value should not change as we are using old SM
 525         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 526 
 527         sm2.select(0);  // value should change, as we are using new SM
 528         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 529     }
 530 
 531     @Test public void ensureValueDoesNotChangeWhenBoundAndNoExceptions() {
 532         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 533 
 534         StringProperty sp = new SimpleStringProperty(&quot;empty&quot;);
 535         comboBox.valueProperty().bind(sp);
 536 
 537         sm.select(1);
 538         assertEquals(&quot;empty&quot;, comboBox.getValue());
 539     }
 540 
 541     @Test public void ensureSelectionModelUpdatesWhenValueChanges() {
 542         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 543         assertNull(sm.getSelectedItem());
 544         comboBox.setValue(&quot;Orange&quot;);
 545         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 546     }
 547 
 548     @Test public void ensureSelectionModelUpdatesWhenValueChangesToNull() {
 549         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 550         comboBox.setValue(&quot;Kiwifruit&quot;);
 551         assertEquals(&quot;Kiwifruit&quot;, sm.getSelectedItem());
 552         assertEquals(&quot;Kiwifruit&quot;, comboBox.getValue());
 553         comboBox.setValue(null);
 554         assertEquals(null, sm.getSelectedItem());
 555         assertEquals(-1, sm.getSelectedIndex());
 556         assertEquals(null, comboBox.getValue());
 557     }
 558 
 559     @Test public void ensureValueEqualsSelectedItemWhenNotInItemsList() {
 560         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 561         SelectionModelShim.setSelectedItem(sm, &quot;pineapple&quot;);
 562         assertEquals(&quot;pineapple&quot;, sm.getSelectedItem());
 563         assertEquals(&quot;pineapple&quot;, comboBox.getValue());
 564     }
 565 
 566     /*********************************************************************
 567      * Tests for default values                                         *
 568      ********************************************************************/
 569 
 570     @Test public void checkPromptTextPropertyName() {
 571         assertTrue(comboBox.promptTextProperty().getName().equals(&quot;promptText&quot;));
 572     }
 573 
 574     @Test public void checkPlaceholderPropertyName() {
 575         assertTrue(comboBox.placeholderProperty().getName().equals(&quot;placeholder&quot;));
 576     }
 577 
 578     @Test public void checkValuePropertyName() {
 579         assertTrue(comboBox.valueProperty().getName().equals(&quot;value&quot;));
 580     }
 581 
 582     @Test public void checkItemsPropertyName() {
 583         assertTrue(comboBox.itemsProperty().getName().equals(&quot;items&quot;));
 584     }
 585 
 586     @Test public void checkConverterPropertyName() {
 587         assertTrue(comboBox.converterProperty().getName().equals(&quot;converter&quot;));
 588     }
 589 
 590     @Test public void checkSelectionModelPropertyName() {
 591         assertTrue(comboBox.selectionModelProperty().getName().equals(&quot;selectionModel&quot;));
 592     }
 593 
 594     @Test public void checkVisibleRowCountPropertyName() {
 595         assertTrue(comboBox.visibleRowCountProperty().getName().equals(&quot;visibleRowCount&quot;));
 596     }
 597 
 598     @Test public void checkOnActionPropertyName() {
 599         assertTrue(comboBox.onActionProperty().getName().equals(&quot;onAction&quot;));
 600     }
 601 
 602     @Test public void checkArmedPropertyName() {
 603         assertTrue(comboBox.armedProperty().getName().equals(&quot;armed&quot;));
 604     }
 605 
 606     @Test public void checkShowingPropertyName() {
 607         assertTrue(comboBox.showingProperty().getName().equals(&quot;showing&quot;));
 608     }
 609 
 610     @Test public void checkEditablePropertyName() {
 611         assertTrue(comboBox.editableProperty().getName().equals(&quot;editable&quot;));
 612     }
 613 
 614     @Test public void checkCellFactoryPropertyName() {
 615         assertTrue(comboBox.cellFactoryProperty().getName().equals(&quot;cellFactory&quot;));
 616     }
 617 
 618     @Test public void defaultActionHandlerIsNotDefined() {
 619         assertNull(comboBox.getOnAction());
 620     }
 621 
 622     @Test public void defaultConverterCanHandleStringValues() {
 623         StringConverter&lt;String&gt; sc = comboBox.getConverter();
 624         assertEquals(&quot;input&quot;, sc.fromString(&quot;input&quot;));
 625         assertEquals(&quot;input&quot;, sc.toString(&quot;input&quot;));
 626     }
 627 
 628     @Test public void defaultConverterCanHandleIncorrectType_1() {
 629         ComboBox cb = new ComboBox();
 630         StringConverter sc = cb.getConverter();
 631         assertEquals(&quot;42&quot;, sc.toString(new Integer(42)));
 632     }
 633 
 634     @Test(expected=ClassCastException.class)
 635     public void defaultConverterCanHandleIncorrectType_2() {
 636         ComboBox&lt;Integer&gt; cb = new ComboBox&lt;Integer&gt;();
 637         StringConverter&lt;Integer&gt; sc = cb.getConverter();
 638         Integer value = sc.fromString(&quot;42&quot;);
 639     }
 640 
 641     @Test public void defaultConverterCanHandleNullValues() {
 642         StringConverter&lt;String&gt; sc = comboBox.getConverter();
 643         assertEquals(null, sc.fromString(null));
 644         assertEquals(null, sc.toString(null));
 645     }
 646 
 647     @Test public void ensureImpl_getPseudoClassStateReturnsValidValue() {
 648         Stage stage = new Stage();
 649         Scene scene = new Scene(comboBox);
 650         stage.setScene(scene);
 651 
 652         Set&lt;PseudoClass&gt; pseudoClassStates = comboBox.getPseudoClassStates();
 653         assertFalse(comboBox.isEditable());
 654         assertTrue(pseudoClassStates.size() &gt;= 0);
 655 
 656         comboBox.setEditable(true);
 657         pseudoClassStates = comboBox.getPseudoClassStates();
 658         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;editable&quot;)));
 659 
 660         comboBox.setEditable(false);
 661         pseudoClassStates = comboBox.getPseudoClassStates();
 662         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;editable&quot;)) == false);
 663 
 664         comboBox.show();
 665         pseudoClassStates = comboBox.getPseudoClassStates();
 666         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;showing&quot;)));
 667 
 668         comboBox.hide();
 669         pseudoClassStates = comboBox.getPseudoClassStates();
 670         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;showing&quot;)) == false);
 671 
 672         comboBox.arm();
 673         pseudoClassStates = comboBox.getPseudoClassStates();
 674         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;armed&quot;)));
 675 
 676     }
 677 
 678     /*********************************************************************
 679      * Tests for properties                                              *
 680      ********************************************************************/
 681 
 682     @Test public void ensureAllowsNullConverter() {
 683         comboBox.setConverter(null);
 684         assertNull(comboBox.getConverter());
 685     }
 686 
 687     @Test public void ensureCanSetNonNullCellFactory() {
 688         Callback&lt;ListView&lt;String&gt;, ListCell&lt;String&gt;&gt; cf = p -&gt; null;
 689         comboBox.setCellFactory(cf);
 690         assertEquals(cf, comboBox.getCellFactory());
 691     }
 692 
 693     @Test public void ensureEditorIsNonNullWhenComboBoxIsNotEditable() {
 694         assertNotNull(comboBox.getEditor());
 695     }
 696 
 697     @Test public void ensureEditorIsNonNullWhenComboBoxIsEditable() {
 698         comboBox.setEditable(true);
 699         assertNotNull(comboBox.getEditor());
 700     }
 701 
 702     @Test public void ensureEditorDoesNotChangeWhenEditableToggles() {
 703         comboBox.setEditable(true);
 704         assertNotNull(comboBox.getEditor());
 705         comboBox.setEditable(false);
 706         assertNotNull(comboBox.getEditor());
 707         comboBox.setEditable(true);
 708         assertNotNull(comboBox.getEditor());
 709     }
 710 
 711     @Test public void ensureCanSetValueToNonNullStringAndBackAgain() {
 712         comboBox.setValue(&quot;Test 123&quot;);
 713         assertEquals(&quot;Test 123&quot;, comboBox.getValue());
 714         comboBox.setValue(null);
 715         assertNull(comboBox.getValue());
 716     }
 717 
 718     @Test public void ensureCanToggleEditable() {
 719         comboBox.setEditable(true);
 720         assertTrue(comboBox.isEditable());
 721         comboBox.setEditable(false);
 722         assertFalse(comboBox.isEditable());
 723     }
 724 
 725     @Test public void ensureCanToggleShowing() {
 726         Stage stage = new Stage();
 727         Scene scene = new Scene(comboBox);
 728         stage.setScene(scene);
 729 
 730         comboBox.show();
 731         assertTrue(comboBox.isShowing());
 732         comboBox.hide();
 733         assertFalse(comboBox.isShowing());
 734     }
 735 
 736     @Test public void ensureCanNotToggleShowingWhenDisabled() {
 737         Stage stage = new Stage();
 738         Scene scene = new Scene(comboBox);
 739         stage.setScene(scene);
 740 
 741         comboBox.setDisable(true);
 742         comboBox.show();
 743         assertFalse(comboBox.isShowing());
 744         comboBox.setDisable(false);
 745         comboBox.show();
 746         assertTrue(comboBox.isShowing());
 747     }
 748 
 749     @Test public void ensureCanSetPromptText() {
 750         comboBox.setPromptText(&quot;Test 1 2 3&quot;);
 751         assertEquals(&quot;Test 1 2 3&quot;, comboBox.getPromptText());
 752     }
 753 
 754     @Test public void ensureCanSetPromptTextToNull() {
 755         comboBox.setPromptText(&quot;&quot;);
 756         assertEquals(&quot;&quot;, comboBox.getPromptText());
 757         comboBox.setPromptText(null);
 758         assertEquals(null, comboBox.getPromptText());
 759     }
 760 
 761     @Test public void ensurePromptTextStripsNewlines() {
 762         comboBox.setPromptText(&quot;Test\n1\n2\n3&quot;);
 763         assertEquals(&quot;Test123&quot;, comboBox.getPromptText());
 764     }
 765 
 766     @Test public void ensureCanSetPlaceholder() {
 767         Label label = new javafx.scene.control.Label(&quot;Test 1 2 3&quot;);
 768         comboBox.setPlaceholder(label);
 769         assertEquals(label, comboBox.getPlaceholder());
 770     }
 771 
 772     @Test public void ensureCanToggleArmed() {
 773         assertFalse(comboBox.isArmed());
 774         comboBox.arm();
 775         assertTrue(comboBox.isArmed());
 776         comboBox.disarm();
 777         assertFalse(comboBox.isArmed());
 778     }
 779 
 780     @Test public void ensureCanSetVisibleRowCount() {
 781         comboBox.setVisibleRowCount(13);
 782         assertEquals(13, comboBox.getVisibleRowCount());
 783     }
 784 
 785     @Test public void ensureCanSetVisibleRowCountToNegativeValues() {
 786         comboBox.setVisibleRowCount(-10);
 787         assertEquals(-10, comboBox.getVisibleRowCount());
 788     }
 789 
 790     @Test public void ensureCanSetOnAction() {
 791         EventHandler&lt;ActionEvent&gt; onAction = t -&gt; { };
 792         comboBox.setOnAction(onAction);
 793         assertEquals(onAction, comboBox.getOnAction());
 794     }
 795 
 796     @Test public void ensureOnActionPropertyReferencesBean() {
 797         assertEquals(comboBox, comboBox.onActionProperty().getBean());
 798     }
 799 
 800     /*********************************************************************
 801      * Tests for property binding                                        *
 802      ********************************************************************/
 803     @Test public void checkPromptTextPropertyBind() {
 804         StringProperty strPr = new SimpleStringProperty(&quot;value&quot;);
 805         comboBox.promptTextProperty().bind(strPr);
 806         assertTrue(&quot;PromptText cannot be bound&quot;, comboBox.getPromptText().equals(&quot;value&quot;));
 807         strPr.setValue(&quot;newvalue&quot;);
 808         assertTrue(&quot;PromptText cannot be bound&quot;, comboBox.getPromptText().equals(&quot;newvalue&quot;));
 809     }
 810 
 811     @Test public void checkValuePropertyBind() {
 812         StringProperty strPr = new SimpleStringProperty(&quot;value&quot;);
 813         comboBox.valueProperty().bind(strPr);
 814         assertTrue(&quot;value cannot be bound&quot;, comboBox.getValue().equals(&quot;value&quot;));
 815         strPr.setValue(&quot;newvalue&quot;);
 816         assertTrue(&quot;value cannot be bound&quot;, comboBox.getValue().equals(&quot;newvalue&quot;));
 817     }
 818 
 819 
 820 
 821     /*********************************************************************
 822      * Tests for bug reports                                             *
 823      ********************************************************************/
 824 
 825     @Test public void test_rt18972() {
 826         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 827         sm.select(1);
 828         assertTrue(sm.isSelected(1));
 829 
 830         comboBox.setEditable(true);
 831         comboBox.setValue(&quot;New Value&quot;);
 832 
 833         // there should be no selection in the selection model, as &quot;New Value&quot;
 834         // isn&#39;t an item in the list, however, it is a totally valid value for
 835         // the value property
 836         assertFalse(sm.isSelected(1));
 837         assertEquals(&quot;New Value&quot;, sm.getSelectedItem());
 838         assertEquals(&quot;New Value&quot;, comboBox.getValue());
 839 
 840         comboBox.setEditable(false);
 841         assertEquals(-1, sm.getSelectedIndex());
 842         assertEquals(&quot;New Value&quot;, sm.getSelectedItem());
 843         assertEquals(&quot;New Value&quot;, comboBox.getValue());
 844     }
 845 
 846     @Test public void test_rt18941() {
 847         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 848         comboBox.setValue(&quot;Orange&quot;);
 849         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 850         assertEquals(&quot;Orange&quot;, comboBox.getSelectionModel().getSelectedItem());
 851         assertTrue(&quot;Selected Index: &quot; + sm.getSelectedIndex(), sm.isSelected(1));
 852     }
 853 
 854     @Test public void test_rt19227() {
 855         comboBox.getItems().addAll(&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;);
 856         comboBox.getSelectionModel().select(2);
 857         assertEquals(&quot;0&quot;, comboBox.getValue());
 858         assertEquals(&quot;0&quot;, comboBox.getSelectionModel().getSelectedItem());
 859         assertTrue(sm.isSelected(2));
 860     }
 861 
 862     @Ignore(&quot;JDK-8091127 Test not working as the heights being returned are not accurate&quot;)
 863     @Test public void test_rt20106() {
 864         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 865 
 866         Stage stage = new Stage();
 867         Scene scene = new Scene(comboBox);
 868         stage.setScene(scene);
 869         comboBox.applyCss();
 870         comboBox.show();
 871 
 872         comboBox.setVisibleRowCount(5);
 873         double initialHeight = getListView().getHeight();
 874         assertFalse(&quot;initialHeight: &quot; + initialHeight, Double.compare(0.0, initialHeight) == 0);
 875 
 876         comboBox.setVisibleRowCount(0);
 877         double smallHeight =    getListView().getHeight();
 878         assertTrue(&quot;smallHeight: &quot; + smallHeight + &quot;, initialHeight: &quot; + initialHeight,
 879                 smallHeight != initialHeight &amp;&amp; smallHeight &lt; initialHeight);
 880 
 881         comboBox.setVisibleRowCount(7);
 882         double biggerHeight = getListView().getHeight();
 883         assertTrue(biggerHeight != smallHeight &amp;&amp; smallHeight &lt; biggerHeight);
 884     }
 885 
 886     private int count = 0;
 887     @Test public void test_rt20103() {
 888         final TextField tf = new TextField();
 889 
 890         comboBox.setOnAction(t -&gt; {
 891             count++;
 892         });
 893 
 894         assertTrue(count == 0);
 895 
 896         comboBox.valueProperty().bind(tf.textProperty());   // count++ here
 897         assertTrue(&quot;count: &quot; + count, count == 1);
 898 
 899         tf.setText(&quot;Text1&quot;);                                // count++ here
 900         assertTrue(&quot;count: &quot; + count, count == 2);
 901 
 902         comboBox.valueProperty().unbind();                  // no count++ here
 903         assertTrue(&quot;count: &quot; + count, count == 2);
 904 
 905         comboBox.valueProperty().bindBidirectional(tf.textProperty());  // count++ here
 906         tf.setText(&quot;Text2&quot;);
 907         assertTrue(&quot;count: &quot; + count, count == 3);
 908     }
 909 
 910     @Ignore(&quot;Test not working as the skin is not being properly instantiated&quot;)
 911     @Test public void test_rt20100() {
 912         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 913 
 914         Stage stage = new Stage();
 915         Scene scene = new Scene(comboBox);
 916         stage.setScene(scene);
 917         comboBox.applyCss();
 918         comboBox.show();
 919 
 920         comboBox.setConverter(new StringConverter() {
 921             int toStringCounter = 0;
 922             int fromStringCounter = 0;
 923 
 924             @Override public String toString(Object t) {
 925                 return &quot;TO_STRING&quot;;
 926             }
 927 
 928             @Override public Object fromString(String string) {
 929                 return &quot;FROM_STRING&quot;;
 930             }
 931         });
 932 
 933         comboBox.getSelectionModel().select(2);
 934         assertEquals(&quot;2&quot;, comboBox.getValue());
 935 
 936         ListView listView = getListView();
 937 //        listView.applyCss();
 938 
 939         assertEquals(&quot;2&quot;, listView.getSelectionModel().getSelectedItem());
 940 
 941         System.out.println(listView.getSkin());
 942 
 943         VirtualFlow flow = (VirtualFlow)listView.lookup(&quot;#virtual-flow&quot;);
 944         assertNotNull(flow);
 945 
 946         IndexedCell cell = flow.getVisibleCell(2);
 947         System.out.println(&quot;cell: &quot; + cell);
 948         assertEquals(&quot;TO_STRING&quot;, cell.getText());
 949     }
 950 
 951     @Test public void test_rt20189() {
 952         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 953 
 954         Stage stage = new Stage();
 955         Scene scene = new Scene(comboBox);
 956         stage.setScene(scene);
 957         comboBox.applyCss();
 958         comboBox.show();
 959 
 960         comboBox.getSelectionModel().select(2);
 961         Object item = sm.getSelectedItem();
 962         assertEquals(&quot;2&quot;, item);
 963         assertEquals(2, sm.getSelectedIndex());
 964 
 965         comboBox.setValue(&quot;test&quot;);
 966         item = sm.getSelectedItem();
 967         assertEquals(&quot;test&quot;,item);
 968         assertEquals(-1, sm.getSelectedIndex());
 969 
 970         comboBox.getSelectionModel().select(2);
 971         item = sm.getSelectedItem();
 972         assertEquals(&quot;2&quot;, item);
 973         assertEquals(2, sm.getSelectedIndex());
 974     }
 975 
 976     @Test public void test_rt27654() {
 977         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 978 
 979         SingleSelectionModel sm = comboBox.getSelectionModel();
 980 
 981         Stage stage = new Stage();
 982         Scene scene = new Scene(comboBox);
 983         stage.setScene(scene);
 984         comboBox.applyCss();
 985         comboBox.show();
 986         ListCell&lt;String&gt; buttonCell = (ListCell&lt;String&gt;) getDisplayNode();
 987 
 988         sm.select(2);
 989         assertEquals(&quot;2&quot;, sm.getSelectedItem());
 990         assertEquals(&quot;2&quot;, comboBox.getValue());
 991         assertEquals(&quot;2&quot;, buttonCell.getText());
 992         assertEquals(2, sm.getSelectedIndex());
 993 
 994         sm.clearSelection();
 995         assertNull(sm.getSelectedItem());
 996         assertNull(comboBox.getValue());
 997         assertNull(buttonCell.getText());
 998         assertEquals(-1, sm.getSelectedIndex());
 999 
1000         sm.select(2);
1001         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1002         assertEquals(&quot;2&quot;, comboBox.getValue());
1003         assertEquals(&quot;2&quot;, buttonCell.getText());
1004         assertEquals(2, sm.getSelectedIndex());
1005     }
1006 
1007     @Test public void test_rt24412() {
1008         SingleSelectionModel sm = comboBox.getSelectionModel();
1009 
1010         Stage stage = new Stage();
1011         Scene scene = new Scene(comboBox);
1012         stage.setScene(scene);
1013         comboBox.applyCss();
1014         comboBox.show();
1015         ListCell&lt;String&gt; buttonCell = (ListCell&lt;String&gt;) getDisplayNode();
1016 
1017         comboBox.getItems().setAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
1018 
1019         sm.select(&quot;2&quot;);
1020         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1021         assertEquals(&quot;2&quot;, comboBox.getValue());
1022         assertEquals(&quot;2&quot;, buttonCell.getText());
1023         assertEquals(2, sm.getSelectedIndex());
1024 
1025         sm.clearSelection();
1026         assertNull(sm.getSelectedItem());
1027         assertNull(comboBox.getValue());
1028         assertNull(buttonCell.getText());
1029         assertEquals(-1, sm.getSelectedIndex());
1030 
1031         sm.select(&quot;2&quot;);
1032         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1033         assertEquals(&quot;2&quot;, comboBox.getValue());
1034         assertEquals(&quot;2&quot;, buttonCell.getText());
1035         assertEquals(2, sm.getSelectedIndex());
1036     }
1037 
1038     @Test public void test_rt28245() {
1039         final ObservableList&lt;String&gt; strings = FXCollections.observableArrayList(
1040             &quot;Option 1&quot;, &quot;Option 2&quot;, &quot;Option 3&quot;
1041         );
1042 
1043         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;String&gt;();
1044         comboBox.setItems(strings);
1045         comboBox.setEditable(true);
1046         comboBox.valueProperty().addListener((ov, t, t1) -&gt; {
1047             if (t == null &amp;&amp; t1.isEmpty()) {
1048                 fail(&quot;Old value is &#39;&quot; + t + &quot;&#39; and new value is &#39;&quot; + t1 + &quot;&#39;.&quot;);
1049             }
1050         });
1051 
1052         StageLoader sl = new StageLoader(comboBox);
1053 
1054         assertNull(comboBox.getValue());
1055         assertTrue(comboBox.getEditor().getText().isEmpty());
1056 
1057         comboBox.requestFocus();
1058 
1059         new KeyEventFirer(comboBox).doKeyPress(KeyCode.ENTER);
1060 
1061         sl.dispose();
1062     }
1063 
1064     @Test public void test_rt31479() {
1065         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;String&gt;();
1066 
1067         StageLoader sl = new StageLoader(comboBox);
1068 
1069         final double widthBefore = comboBox.getWidth();
1070 
1071         // add item
1072         comboBox.getItems().add(&quot;Option 1&quot;);
1073 
1074         // open and close combobox
1075         comboBox.show();
1076         comboBox.hide();
1077 
1078         // set a placeholder
1079         comboBox.setPlaceholder(new Circle(12, Color.RED));
1080 
1081         // remove item
1082         comboBox.getItems().clear();
1083 
1084         // fire pulse (this allows layout to cause the size to grow)
1085         Toolkit.getToolkit().firePulse();
1086 
1087         // test size
1088         assertEquals(widthBefore, comboBox.getWidth(), 0.00);
1089 
1090         sl.dispose();
1091     }
1092 
1093     @Test public void test_rt32139() {
1094         final ObservableList&lt;String&gt; items =
1095                 FXCollections.observableArrayList(&quot;Good value&quot;, &quot;Bad value&quot;);
1096 
1097         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1098         comboBox.getSelectionModel().select(0);
1099 
1100         comboBox.getSelectionModel().selectedIndexProperty().addListener((ov, oldIdx, newIdx) -&gt; {
1101             if (newIdx.intValue() != 0) {
1102                 comboBox.getSelectionModel().select(0);
1103             }
1104         });
1105 
1106         StageLoader sl = new StageLoader(comboBox);
1107 
1108         try {
1109             comboBox.getSelectionModel().select(1);
1110         } catch (StackOverflowError e) {
1111             fail(&quot;Stack overflow should not happen here&quot;);
1112         }
1113 
1114         sl.dispose();
1115     }
1116 
1117     @Test public void test_rt21186() {
1118         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1119         comboBox.setEditable(true);
1120 
1121         StageLoader sl = new StageLoader(comboBox);
1122 
1123         assertNull(comboBox.getTooltip());
1124         assertNull(comboBox.getEditor().getTooltip());
1125 
1126         Tooltip tooltip = new Tooltip(&quot;Tooltip&quot;);
1127         comboBox.setTooltip(tooltip);
1128         assertEquals(tooltip, comboBox.getTooltip());
1129         assertEquals(tooltip, comboBox.getEditor().getTooltip());
1130 
1131         comboBox.setTooltip(null);
1132         assertNull(comboBox.getTooltip());
1133         assertNull(comboBox.getEditor().getTooltip());
1134 
1135         sl.dispose();
1136     }
1137 
1138     @Test public void test_rt34573() {
1139         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1140 
1141         final ListCell&lt;String&gt; customCell = new ListCellShim&lt;String&gt;() {
1142             @Override public void updateItem(String item, boolean empty) {
1143                 super.updateItem(item, empty);
1144                 setText(item);
1145             }
1146         };
1147         comboBox.setButtonCell(customCell);
1148 
1149         StageLoader sl = new StageLoader(comboBox);
1150 
1151         comboBox.setItems(FXCollections.observableArrayList(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;));
1152         comboBox.setValue(&quot;B&quot;);
1153         assertEquals(&quot;B&quot;, comboBox.getButtonCell().getText());
1154         assertEquals(1, comboBox.getButtonCell().getIndex());
1155 
1156         comboBox.setItems(FXCollections.observableArrayList(&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;));
1157         assertNull(comboBox.getButtonCell().getText());
1158         assertEquals(-1, comboBox.getButtonCell().getIndex());
1159 
1160         sl.dispose();
1161     }
1162 
1163     @Test public void test_rt34566() {
1164         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1165 
1166         final ListCell&lt;String&gt; customCell = new ListCellShim&lt;String&gt;() {
1167             @Override public void updateItem(String item, boolean empty) {
1168                 super.updateItem(item, empty);
1169                 setText(item);
1170             }
1171         };
1172         comboBox.setButtonCell(customCell);
1173 
1174         StageLoader sl = new StageLoader(comboBox);
1175 
1176         comboBox.setItems(FXCollections.observableArrayList(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;));
1177 
1178         PseudoClass empty = PseudoClass.getPseudoClass(&quot;empty&quot;);
1179 
1180         comboBox.setValue(&quot;B&quot;);
1181         assertEquals(&quot;B&quot;, comboBox.getButtonCell().getText());
1182         assertEquals(1, comboBox.getButtonCell().getIndex());
1183         assertFalse(customCell.getPseudoClassStates().contains(empty));
1184 
1185         comboBox.setValue(null);
1186         Toolkit.getToolkit().firePulse();
1187         assertNull(comboBox.getButtonCell().getText());
1188         assertEquals(-1, comboBox.getButtonCell().getIndex());
1189         assertTrue(customCell.getPseudoClassStates().contains(empty));
1190 
1191         comboBox.setValue(&quot;A&quot;);
1192         assertEquals(&quot;A&quot;, comboBox.getButtonCell().getText());
1193         assertEquals(0, comboBox.getButtonCell().getIndex());
1194         assertFalse(customCell.getPseudoClassStates().contains(empty));
1195 
1196         sl.dispose();
1197     }
1198 
1199     private int test_rt34603_count = 0;
1200     @Test public void test_rt34603() {
1201         assertEquals(0, test_rt34603_count);
1202 
1203         VBox hbox = new VBox(10);
1204 
1205         ComboBox&lt;String&gt; box = new ComboBox&lt;&gt;();
1206         box.getItems().add(&quot;test&quot;);
1207         box.setEditable(true);
1208         box.getSelectionModel().selectFirst();
1209 
1210         Button defaultButton = new Button(&quot;press&quot;);
1211         defaultButton.setOnAction(arg0 -&gt; {
1212             test_rt34603_count++;
1213         });
1214         defaultButton.setDefaultButton(true);
1215 
1216         hbox.getChildren().addAll(box, defaultButton);
1217 
1218         StageLoader sl = new StageLoader(hbox);
1219 
1220         box.getEditor().requestFocus();
1221         KeyEventFirer keyboard = new KeyEventFirer(box);
1222         keyboard.doKeyPress(KeyCode.ENTER);
1223 
1224         assertEquals(1, test_rt34603_count);
1225 
1226         sl.dispose();
1227     }
1228 
1229     private int test_rt35586_count = 0;
1230     @Test public void test_rt35586() {
1231         assertEquals(0, test_rt35586_count);
1232 
1233         final ComboBox&lt;String&gt; cb = new ComboBox&lt;String&gt;();
1234         cb.setEditable(true);
1235         cb.setOnAction(event -&gt; {
1236             test_rt35586_count++;
1237             assertEquals(&quot;Test&quot;, cb.getEditor().getText());
1238         });
1239 
1240         StageLoader sl = new StageLoader(cb);
1241 
1242         cb.requestFocus();
1243         cb.getEditor().setText(&quot;Test&quot;);
1244         KeyEventFirer keyboard = new KeyEventFirer(cb);
1245         keyboard.doKeyPress(KeyCode.ENTER);
1246 
1247         assertEquals(1, test_rt35586_count);
1248 
1249         sl.dispose();
1250     }
1251 
1252     @Test public void test_rt35039() {
1253         final List&lt;String&gt; data = new ArrayList&lt;&gt;();
1254         data.add(&quot;aabbaa&quot;);
1255         data.add(&quot;bbc&quot;);
1256 
1257         final ComboBox&lt;String&gt; combo = new ComboBox&lt;&gt;();
1258         combo.setEditable(true);
1259         combo.setItems(FXCollections.observableArrayList(data));
1260 
1261         StageLoader sl = new StageLoader(combo);
1262 
1263         // everything should be null to start with
1264         assertNull(combo.getValue());
1265         assertTrue(combo.getEditor().getText().isEmpty());
1266         assertNull(combo.getSelectionModel().getSelectedItem());
1267 
1268         // select &quot;bbc&quot; and ensure everything is set to that
1269         combo.getSelectionModel().select(1);
1270         assertEquals(&quot;bbc&quot;, combo.getValue());
1271         assertEquals(&quot;bbc&quot;, combo.getEditor().getText());
1272         assertEquals(&quot;bbc&quot;, combo.getSelectionModel().getSelectedItem());
1273 
1274         // change the items list - but retain the same content. We expect
1275         // that &quot;bbc&quot; remains selected as it is still in the list
1276         combo.setItems(FXCollections.observableArrayList(data));
1277         assertEquals(&quot;bbc&quot;, combo.getValue());
1278         assertEquals(&quot;bbc&quot;, combo.getEditor().getText());
1279         assertEquals(&quot;bbc&quot;, combo.getSelectionModel().getSelectedItem());
1280 
1281         sl.dispose();
1282     }
1283 
1284     @Test public void test_rt35840() {
1285         final ComboBox&lt;String&gt; cb = new ComboBox&lt;String&gt;();
1286         cb.setEditable(true);
1287         StageLoader sl = new StageLoader(cb);
1288         cb.requestFocus();
1289 
1290         KeyEventFirer keyboard = new KeyEventFirer(cb);
1291         keyboard.doKeyTyped(KeyCode.T);
1292         keyboard.doKeyTyped(KeyCode.E);
1293         keyboard.doKeyTyped(KeyCode.S);
1294         keyboard.doKeyTyped(KeyCode.T);
1295         assertEquals(&quot;TEST&quot;, cb.getEditor().getText());
1296 
1297         assertNull(cb.getValue());
1298         keyboard.doKeyPress(KeyCode.ENTER);
1299         assertEquals(&quot;TEST&quot;, cb.getValue());
1300 
1301         sl.dispose();
1302     }
1303 
1304     @Test public void test_rt36280_nonEditable_F4ShowsPopup() {
1305         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1306         StageLoader sl = new StageLoader(cb);
1307         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1308 
1309         assertFalse(cb.isShowing());
1310         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1311         assertTrue(cb.isShowing());
1312 
1313         sl.dispose();
1314     }
1315 
1316     @Test public void test_rt36280_nonEditable_altUpShowsPopup() {
1317         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1318         StageLoader sl = new StageLoader(cb);
1319         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1320 
1321         assertFalse(cb.isShowing());
1322         cbKeyboard.doKeyPress(KeyCode.UP, KeyModifier.ALT);  // show the popup
1323         assertTrue(cb.isShowing());
1324 
1325         sl.dispose();
1326     }
1327 
1328     @Test public void test_rt36280_nonEditable_altDownShowsPopup() {
1329         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1330         StageLoader sl = new StageLoader(cb);
1331         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1332 
1333         new StageLoader(cb);
1334 
1335         assertFalse(cb.isShowing());
1336         cbKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1337         assertTrue(cb.isShowing());
1338 
1339         sl.dispose();
1340     }
1341 
<a name="1" id="anc1"></a><span class="line-added">1342     @Test public void test_ArrowKeysWhenPopupIsShowing() {</span>
<span class="line-added">1343         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));</span>
<span class="line-added">1344         cb.setEditable(true);</span>
<span class="line-added">1345         StageLoader sl = new StageLoader(cb);</span>
<span class="line-added">1346         KeyEventFirer keyboard = new KeyEventFirer(cb);</span>
<span class="line-added">1347 </span>
<span class="line-added">1348         new StageLoader(cb);</span>
<span class="line-added">1349 </span>
<span class="line-added">1350         assertFalse(cb.isShowing());</span>
<span class="line-added">1351         cb.requestFocus();</span>
<span class="line-added">1352         keyboard.doDownArrowPress(KeyModifier.ALT);  // show the popup</span>
<span class="line-added">1353         assertTrue(cb.isShowing());</span>
<span class="line-added">1354 </span>
<span class="line-added">1355         // Enter some text</span>
<span class="line-added">1356         keyboard.doKeyTyped(KeyCode.A);</span>
<span class="line-added">1357         keyboard.doKeyTyped(KeyCode.C);</span>
<span class="line-added">1358         assertEquals(&quot;AC&quot;, cb.getEditor().getText());</span>
<span class="line-added">1359 </span>
<span class="line-added">1360         // Test LEFT key</span>
<span class="line-added">1361         keyboard.doLeftArrowPress();</span>
<span class="line-added">1362         keyboard.doKeyTyped(KeyCode.B);</span>
<span class="line-added">1363         assertEquals(&quot;ABC&quot;, cb.getEditor().getText());</span>
<span class="line-added">1364 </span>
<span class="line-added">1365         // Test RIGHT key</span>
<span class="line-added">1366         keyboard.doRightArrowPress();</span>
<span class="line-added">1367         keyboard.doKeyTyped(KeyCode.D);</span>
<span class="line-added">1368         assertEquals(&quot;ABCD&quot;, cb.getEditor().getText());</span>
<span class="line-added">1369 </span>
<span class="line-added">1370         // Test CTRL + A key</span>
<span class="line-added">1371         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());</span>
<span class="line-added">1372         keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());</span>
<span class="line-added">1373         assertEquals(&quot;ABCD&quot;, cb.getEditor().getSelectedText());</span>
<span class="line-added">1374 </span>
<span class="line-added">1375         sl.dispose();</span>
<span class="line-added">1376     }</span>
<span class="line-added">1377 </span>
1378     @Test public void test_rt36280_nonEditable_enterHidesShowingPopup() {
1379         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1380         StageLoader sl = new StageLoader(cb);
1381         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1382 
1383         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1384         assertNotNull(listView);
1385 
1386         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1387 
1388         assertFalse(cb.isShowing());
1389         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1390         assertTrue(cb.isShowing());
1391         lvKeyboard.doKeyPress(KeyCode.ENTER);  // hide the popup
1392         assertFalse(cb.isShowing());
1393 
1394         sl.dispose();
1395     }
1396 
1397     @Test public void test_rt36280_nonEditable_spaceHidesShowingPopup() {
1398         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1399         StageLoader sl = new StageLoader(cb);
1400         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1401 
1402         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1403         assertNotNull(listView);
1404 
1405         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1406 
1407         assertFalse(cb.isShowing());
1408         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1409         assertTrue(cb.isShowing());
1410         lvKeyboard.doKeyPress(KeyCode.SPACE);  // hide the popup
1411         assertFalse(cb.isShowing());
1412 
1413         sl.dispose();
1414     }
1415 
1416     @Test public void test_rt36280_nonEditable_escapeHidesShowingPopup() {
1417         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1418         StageLoader sl = new StageLoader(cb);
1419         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1420 
1421         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1422         assertNotNull(listView);
1423 
1424         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1425 
1426         assertFalse(cb.isShowing());
1427         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1428         assertTrue(cb.isShowing());
1429         lvKeyboard.doKeyPress(KeyCode.ESCAPE);  // hide the popup
1430         assertFalse(cb.isShowing());
1431 
1432         sl.dispose();
1433     }
1434 
1435     @Test public void test_rt36280_nonEditable_F4HidesShowingPopup() {
1436         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1437         StageLoader sl = new StageLoader(cb);
1438         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1439 
1440         assertFalse(cb.isShowing());
1441         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1442         assertTrue(cb.isShowing());
1443         cbKeyboard.doKeyPress(KeyCode.F4);  // hide the popup
1444         assertFalse(cb.isShowing());
1445 
1446         sl.dispose();
1447     }
1448 
1449     @Test public void test_rt36280_nonEditable_arrowKeysChangeSelection() {
1450         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1451         StageLoader sl = new StageLoader(cb);
1452         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1453 
1454         assertFalse(cb.isShowing());
1455         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1456         assertTrue(cb.isShowing());
1457 
1458         assertNull(cb.getSelectionModel().getSelectedItem());
1459 
1460         cbKeyboard.doDownArrowPress();
1461         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1462 
1463         cbKeyboard.doDownArrowPress();
1464         assertEquals(&quot;b&quot;, cb.getSelectionModel().getSelectedItem());
1465 
1466         cbKeyboard.doUpArrowPress();
1467         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1468 
1469         sl.dispose();
1470     }
1471 
1472     @Test public void test_rt36280_editable_F4ShowsPopup() {
1473         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1474         cb.setEditable(true);
1475         StageLoader sl = new StageLoader(cb);
1476         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1477 
1478         assertFalse(cb.isShowing());
1479         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1480         assertTrue(cb.isShowing());
1481 
1482         sl.dispose();
1483     }
1484 
1485     @Test public void test_rt36280_editable_altUpShowsPopup() {
1486         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1487         cb.setEditable(true);
1488         StageLoader sl = new StageLoader(cb);
1489         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1490 
1491         assertFalse(cb.isShowing());
1492         cbKeyboard.doKeyPress(KeyCode.UP, KeyModifier.ALT);  // show the popup
1493         assertTrue(cb.isShowing());
1494 
1495         sl.dispose();
1496     }
1497 
1498     @Test public void test_rt36280_editable_altDownShowsPopup_onComboBox() {
1499         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1500         cb.setEditable(true);
1501         StageLoader sl = new StageLoader(cb);
1502         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1503 
1504         assertFalse(cb.isShowing());
1505         assertTrue(cb.getEditor().getText().isEmpty());
1506         cbKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1507         assertTrue(cb.isShowing());
1508         assertTrue(cb.getEditor().getText().isEmpty());
1509 
1510         sl.dispose();
1511     }
1512 
1513     @Test public void test_rt36280_editable_altDownShowsPopup_onTextField() {
1514         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1515         cb.setEditable(true);
1516         StageLoader sl = new StageLoader(cb);
1517 
1518         KeyEventFirer tfKeyboard = new KeyEventFirer(cb.getEditor());
1519         assertFalse(cb.isShowing());
1520         assertTrue(cb.getEditor().getText().isEmpty());
1521         tfKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1522         assertTrue(cb.isShowing());
1523         assertTrue(cb.getEditor().getText().isEmpty());
1524 
1525         sl.dispose();
1526     }
1527 
1528     @Test public void test_rt36280_editable_enterHidesShowingPopup() {
1529         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1530         cb.setEditable(true);
1531         StageLoader sl = new StageLoader(cb);
1532         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1533 
1534         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1535         assertNotNull(listView);
1536 
1537         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1538 
1539         assertFalse(cb.isShowing());
1540         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1541         assertTrue(cb.isShowing());
1542         lvKeyboard.doKeyPress(KeyCode.ENTER);  // hide the popup
1543         assertFalse(cb.isShowing());
1544 
1545         sl.dispose();
1546     }
1547 
1548     @Test public void test_rt36280_editable_spaceHidesShowingPopup() {
1549         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1550         cb.setEditable(true);
1551         StageLoader sl = new StageLoader(cb);
1552         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1553 
1554         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1555         assertNotNull(listView);
1556 
1557         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1558 
1559         assertFalse(cb.isShowing());
1560         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1561         assertTrue(cb.isShowing());
1562         lvKeyboard.doKeyPress(KeyCode.SPACE);  // hide the popup
1563         assertFalse(cb.isShowing());
1564 
1565         sl.dispose();
1566     }
1567 
1568     @Test public void test_rt36280_editable_escapeHidesShowingPopup() {
1569         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1570         cb.setEditable(true);
1571         StageLoader sl = new StageLoader(cb);
1572         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1573 
1574         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1575         assertNotNull(listView);
1576 
1577         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1578 
1579         assertFalse(cb.isShowing());
1580         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1581         assertTrue(cb.isShowing());
1582         lvKeyboard.doKeyPress(KeyCode.ESCAPE);  // hide the popup
1583         assertFalse(cb.isShowing());
1584 
1585         sl.dispose();
1586     }
1587 
1588     @Test public void test_rt36280_editable_F4HidesShowingPopup() {
1589         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1590         cb.setEditable(true);
1591         StageLoader sl = new StageLoader(cb);
1592         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1593 
1594         assertFalse(cb.isShowing());
1595         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1596         assertTrue(cb.isShowing());
1597         cbKeyboard.doKeyPress(KeyCode.F4);  // hide the popup
1598         assertFalse(cb.isShowing());
1599 
1600         sl.dispose();
1601     }
1602 
1603     @Test public void test_rt36280_editable_arrowKeysChangeSelection() {
1604         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1605         cb.setEditable(true);
1606         StageLoader sl = new StageLoader(cb);
1607         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1608 
1609         assertFalse(cb.isShowing());
1610         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1611         assertTrue(cb.isShowing());
1612 
1613         assertNull(cb.getSelectionModel().getSelectedItem());
1614 
1615         cbKeyboard.doDownArrowPress();
1616         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1617 
1618         cbKeyboard.doDownArrowPress();
1619         assertEquals(&quot;b&quot;, cb.getSelectionModel().getSelectedItem());
1620 
1621         cbKeyboard.doUpArrowPress();
1622         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1623 
1624         sl.dispose();
1625     }
1626 
1627     @Test public void test_rt36651() {
1628         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1629         cb.setEditable(true);
1630         StageLoader sl = new StageLoader(cb);
1631 
1632         assertNull(cb.getValue());
1633         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1634         assertNull(cb.getSelectionModel().getSelectedItem());
1635 
1636         sl.getStage().requestFocus();
1637         cb.show();
1638         Toolkit.getToolkit().firePulse();
1639 
1640         // selection should not change just by showing the popup
1641         assertNull(cb.getValue());
1642         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1643         assertNull(cb.getSelectionModel().getSelectedItem());
1644 
1645         sl.dispose();
1646     }
1647 
1648     @Test public void test_rt36717() {
1649         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1650         StageLoader sl = new StageLoader(cb);
1651 
1652         // the stack overflow only occurs when a ComboBox changes from non-editable to editable
1653         cb.setEditable(false);
1654         cb.setEditable(true);
1655         assertNotNull(cb.getEditor());
1656         KeyEventFirer tfKeyboard = new KeyEventFirer(cb.getEditor());
1657         tfKeyboard.doKeyPress(KeyCode.ENTER);   // Stack overflow here
1658 
1659         sl.dispose();
1660     }
1661 
1662     @Test public void test_rt36827() {
1663         final Button btn = new Button(&quot;focus owner&quot;);
1664         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1665         VBox vbox = new VBox(btn, cb);
1666 
1667         StageLoader sl = new StageLoader(vbox);
1668         sl.getStage().requestFocus();
1669         btn.requestFocus();
1670         Toolkit.getToolkit().firePulse();
1671         Scene scene = sl.getStage().getScene();
1672 
1673         assertTrue(btn.isFocused());
1674         assertEquals(btn, scene.getFocusOwner());
1675 
1676         MouseEventFirer mouse = new MouseEventFirer(cb);
1677         mouse.fireMousePressAndRelease();
1678 
1679         assertTrue(cb.isShowing());
1680         assertTrue(cb.isFocused());
1681         assertEquals(cb, scene.getFocusOwner());
1682 
1683         sl.dispose();
1684     }
1685 
1686     @Test public void test_rt36902() {
1687         final ComboBox&lt;String&gt; cb1 = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1688         final ComboBox&lt;String&gt; cb2 = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1689         cb2.setEditable(true);
1690         VBox vbox = new VBox(cb1, cb2);
1691 
1692         // lame - I would rather have one keyboard here but I couldn&#39;t get it to
1693         // work, so watch out for which keyboard is used below
1694         KeyEventFirer cb1Keyboard = new KeyEventFirer(cb1);
1695         KeyEventFirer cb2Keyboard = new KeyEventFirer(cb2);
1696 
1697         StageLoader sl = new StageLoader(vbox);
1698         sl.getStage().requestFocus();
1699         cb1.requestFocus();
1700         Toolkit.getToolkit().firePulse();
1701         Scene scene = sl.getStage().getScene();
1702 
1703         assertTrue(cb1.isFocused());
1704         assertEquals(cb1, scene.getFocusOwner());
1705 
1706         // move focus forward to cb2
1707         cb1Keyboard.doKeyPress(KeyCode.TAB);
1708         assertTrue(cb2.isFocused());
1709         assertEquals(cb2, scene.getFocusOwner());
1710 
1711         // move focus forward again to cb1
1712         cb2Keyboard.doKeyPress(KeyCode.TAB);
1713         assertTrue(cb1.isFocused());
1714         assertEquals(cb1, scene.getFocusOwner());
1715 
1716         // now start going backwards with shift-tab.
1717         // The first half of the bug is here - when we shift-tab into cb2, we
1718         // actually go into the FakeFocusTextField subcomponent, so whilst the
1719         // cb2.isFocused() returns true as expected, the scene focus owner is
1720         // not the ComboBox, but the FakeFocusTextField inside it
1721         cb1Keyboard.doKeyPress(KeyCode.TAB, KeyModifier.SHIFT);
1722         assertTrue(&quot;Expect cb2 to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1723                 cb2.isFocused());
1724         // Updated with fix for RT-34602: The TextField now never gets
1725         // focus (it&#39;s just faking it).
1726         // assertEquals(&quot;Expect cb2 TextField to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1727         //         cb2.getEditor(), scene.getFocusOwner());
1728         assertEquals(&quot;Expect cb2 to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1729                      cb2, scene.getFocusOwner());
1730 
1731         // This is where the second half of the bug appears, as we are stuck in
1732         // the FakeFocusTextField of cb2, we never make it to cb1
1733         cb2Keyboard.doKeyPress(KeyCode.TAB, KeyModifier.SHIFT);
1734         assertTrue(cb1.isFocused());
1735         assertEquals(cb1, scene.getFocusOwner());
1736 
1737         sl.dispose();
1738     }
1739 
1740     private int rt_38901_counter;
1741     @Test public void test_rt_38901_selectNull() {
1742         test_rt_38901(true);
1743     }
1744 
1745     @Test public void test_rt_38901_selectNegativeOne() {
1746         test_rt_38901(false);
1747     }
1748 
1749     private void test_rt_38901(boolean selectNull) {
1750         rt_38901_counter = 0;
1751 
1752         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1753         cb.setOnShowing((e) -&gt; {
1754             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_38901_counter++));
1755         });
1756 
1757         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1758         assertNull(cb.getSelectionModel().getSelectedItem());
1759         assertNull(cb.getValue());
1760         assertEquals(0, cb.getItems().size());
1761 
1762         // round one
1763         cb.show();
1764         assertEquals(1, cb.getItems().size());
1765         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1766         cb.hide();
1767 
1768         cb.getSelectionModel().select(0);
1769         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1770         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1771         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1772 
1773         if (selectNull) cb.getSelectionModel().select(null);
1774         else cb.getSelectionModel().select(-1);
1775 
1776         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1777         assertNull(cb.getSelectionModel().getSelectedItem());
1778         assertNull(cb.getValue());
1779 
1780 
1781         // round two
1782         cb.show();
1783         assertEquals(1, cb.getItems().size());
1784         assertEquals(&quot;DUMMY 1&quot;, cb.getItems().get(0));
1785         cb.hide();
1786 
1787         cb.getSelectionModel().select(0);
1788         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1789         assertEquals(&quot;DUMMY 1&quot;, cb.getSelectionModel().getSelectedItem());
1790         assertEquals(&quot;DUMMY 1&quot;, cb.getValue());
1791 
1792         if (selectNull) cb.getSelectionModel().select(null);
1793         else cb.getSelectionModel().select(-1);
1794 
1795         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1796         assertNull(cb.getSelectionModel().getSelectedItem());
1797         assertNull(cb.getValue());
1798     }
1799 
1800     private int rt_22572_counter;
1801     @Test public void test_rt_22572() {
1802         rt_22572_counter = 0;
1803 
1804         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1805         cb.setOnShowing((e) -&gt; {
1806             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_22572_counter++));
1807         });
1808 
1809         StageLoader sl = new StageLoader(cb);
1810 
1811         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1812         assertNull(cb.getSelectionModel().getSelectedItem());
1813         assertNull(cb.getValue());
1814         assertEquals(0, cb.getItems().size());
1815 
1816         // round one
1817         cb.show();
1818         assertEquals(1, cb.getItems().size());
1819         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1820         cb.hide();
1821 
1822         cb.getSelectionModel().select(0);
1823         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1824         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1825         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1826 
1827 
1828         // round two - even though the items change, the value should still be
1829         // the old value (even though it doesn&#39;t exist in the items list any longer).
1830         // The selectedIndex and selectedItem do get reset however.
1831         cb.show();
1832         assertEquals(1, cb.getItems().size());
1833         assertEquals(&quot;DUMMY 1&quot;, cb.getItems().get(0));
1834         cb.hide();
1835 
1836         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1837         assertNull(cb.getSelectionModel().getSelectedItem());
1838         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1839 
1840         sl.dispose();
1841     }
1842 
1843     private int rt_22937_counter;
1844     @Test public void test_rt_22937() {
1845         rt_22937_counter = 0;
1846 
1847         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1848         cb.setOnShowing((e) -&gt; {
1849             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_22937_counter++));
1850         });
1851 
1852         cb.getItems().add(&quot;Toto&quot;);
1853         cb.setEditable(true);
1854         cb.setValue(&quot;Tata&quot;);
1855 
1856         StageLoader sl = new StageLoader(cb);
1857 
1858         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1859         assertEquals(&quot;Tata&quot;, cb.getSelectionModel().getSelectedItem());
1860         assertEquals(&quot;Tata&quot;, cb.getValue());
1861         assertEquals(1, cb.getItems().size());
1862 
1863         cb.show();
1864         assertEquals(1, cb.getItems().size());
1865         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1866         cb.hide();
1867 
1868         cb.getSelectionModel().select(0);
1869         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1870         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1871         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1872 
1873         sl.dispose();
1874     }
1875 
1876     @Test public void test_rt_39809() {
1877         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1878         comboBox.getItems().setAll(null, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
1879 
1880         StageLoader sl = new StageLoader(comboBox);
1881 
1882         comboBox.getSelectionModel().clearAndSelect(1);
1883         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
1884         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
1885 
1886         comboBox.getSelectionModel().clearAndSelect(0);
1887         assertEquals(null, comboBox.getSelectionModel().getSelectedItem());
1888         assertEquals(0, comboBox.getSelectionModel().getSelectedIndex());
1889 
1890         sl.dispose();
1891     }
1892 
1893     @Test public void test_rt_39908() {
1894         ObservableList&lt;String&gt; model = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
1895         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(model);
1896 
1897         StageLoader sl = new StageLoader(comboBox);
1898 
1899         comboBox.getSelectionModel().clearAndSelect(1);
1900         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
1901         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
1902 
1903         model.set(0, &quot;a&quot;);
1904         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
1905         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
1906 
1907         sl.dispose();
1908     }
1909 
1910     /**
1911      * Bullet 1: selected index must be updated
1912      * Corner case: last selected. Fails for core
1913      */
1914     @Test public void test_rt_40012_selectedAtLastOnDisjointRemoveItemsAbove() {
1915         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
1916         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1917         SelectionModel sm = comboBox.getSelectionModel();
1918 
1919         int last = items.size() - 1;
1920 
1921         // selecting item &quot;5&quot;
1922         sm.select(last);
1923 
1924         // disjoint remove of 2 elements above the last selected
1925         // Removing &quot;1&quot; and &quot;3&quot;
1926         items.removeAll(items.get(1), items.get(3));
1927 
1928         // selection should move up two places such that it remains on item &quot;5&quot;,
1929         // but in index (last - 2).
1930         int expected = last - 2;
1931         assertEquals(&quot;5&quot;, sm.getSelectedItem());
1932         assertEquals(&quot;selected index after disjoint removes above&quot;, expected, sm.getSelectedIndex());
1933     }
1934 
1935     /**
1936      * Variant of 1: if selectedIndex is not updated,
1937      * the old index is no longer valid
1938      * for accessing the items.
1939      */
1940     @Test public void test_rt_40012_accessSelectedAtLastOnDisjointRemoveItemsAbove() {
1941         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
1942         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1943         SelectionModel sm = comboBox.getSelectionModel();
1944 
1945         int last = items.size() - 1;
1946 
1947         // selecting item &quot;5&quot;
1948         sm.select(last);
1949 
1950         // disjoint remove of 2 elements above the last selected
1951         items.removeAll(items.get(1), items.get(3));
1952         int selected = sm.getSelectedIndex();
1953         if (selected &gt; -1) {
1954             items.get(selected);
1955         }
1956     }
1957 
1958     /**
1959      * Bullet 2: selectedIndex notification count
1960      *
1961      * Note that we don&#39;t use the corner case of having the last index selected
1962      * (which fails already on updating the index)
1963      */
1964     private int rt_40012_count = 0;
1965     @Test public void test_rt_40012_selectedIndexNotificationOnDisjointRemovesAbove() {
1966         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
1967         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1968         SelectionModel sm = comboBox.getSelectionModel();
1969 
1970         int last = items.size() - 2;
1971         sm.select(last);
1972         assertEquals(last, sm.getSelectedIndex());
1973 
1974         rt_40012_count = 0;
1975         sm.selectedIndexProperty().addListener(o -&gt; rt_40012_count++);
1976 
1977         // disjoint remove of 2 elements above the last selected
1978         items.removeAll(items.get(1), items.get(3));
1979         assertEquals(&quot;sanity: selectedIndex must be shifted by -2&quot;, last - 2, sm.getSelectedIndex());
1980         assertEquals(&quot;must fire single event on removes above&quot;, 1, rt_40012_count);
1981     }
1982 
1983     /**
1984      * Bullet 3: unchanged selectedItem must not fire change
1985      */
1986     @Test
1987     public void test_rt_40012_selectedItemNotificationOnDisjointRemovesAbove() {
1988         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
1989         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1990         SelectionModel sm = comboBox.getSelectionModel();
1991 
1992         int last = items.size() - 2;
1993         Object lastItem = items.get(last);
1994         sm.select(last);
1995         assertEquals(lastItem, sm.getSelectedItem());
1996 
1997         rt_40012_count = 0;
1998         sm.selectedItemProperty().addListener(o -&gt; rt_40012_count++);
1999 
2000         // disjoint remove of 2 elements above the last selected
2001         items.removeAll(items.get(1), items.get(3));
2002         assertEquals(&quot;sanity: selectedItem unchanged&quot;, lastItem, sm.getSelectedItem());
2003         assertEquals(&quot;must not fire on unchanged selected item&quot;, 0, rt_40012_count);
2004     }
2005 
2006     @Test public void test_jdk_8150946_testCommit_valid() {
2007         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2008         comboBox.setEditable(true);
2009         assertEquals(null, comboBox.getValue());
2010         comboBox.getEditor().setText(&quot;ABC&quot;);
2011         comboBox.commitValue();
2012         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2013     }
2014 
2015     @Test public void test_jdk_8150946_testCancel_toNull() {
2016         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2017         comboBox.setEditable(true);
2018         assertNull(comboBox.getValue());
2019         assertEquals(&quot;&quot;, comboBox.getEditor().getText());
2020         comboBox.getEditor().setText(&quot;ABC&quot;);
2021         assertNull(comboBox.getValue());
2022         comboBox.cancelEdit();
2023         assertNull(comboBox.getValue());
2024         assertNull(comboBox.getEditor().getText());
2025     }
2026 
2027     @Test public void test_jdk_8150946_testCancel_toNonNull() {
2028         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2029         comboBox.setEditable(true);
2030         comboBox.getEditor().setText(&quot;ABC&quot;);
2031         comboBox.commitValue();
2032         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2033         assertEquals(&quot;ABC&quot;, comboBox.getEditor().getText());
2034         comboBox.getEditor().setText(&quot;DEF&quot;);
2035         assertEquals(&quot;DEF&quot;, comboBox.getEditor().getText());
2036         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2037         comboBox.cancelEdit();
2038         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2039         assertEquals(&quot;ABC&quot;, comboBox.getEditor().getText());
2040     }
2041 
2042     @Test public void test_jdk_8160493() {
2043         AtomicInteger count = new AtomicInteger();
2044         comboBox.valueProperty().addListener(o -&gt; count.incrementAndGet());
2045         assertEquals(0, count.get());
2046 
2047         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
2048         sm.select(1);
2049         assertTrue(sm.isSelected(1));
2050         assertEquals(1, count.get());
2051         assertEquals(&quot;Orange&quot;, comboBox.getValue());
2052 
2053         comboBox.setValue(&quot;New Value&quot;);
2054         assertEquals(2, count.get());
2055         assertEquals(&quot;New Value&quot;, comboBox.getValue());
2056     }
2057 
2058     private int skinChangedCount = 0;
2059     @Test public void test_JDK_8185854() {
2060         final FlowPane comboPane = new FlowPane(10, 10);
2061         ComboBox combo = new ComboBox&lt;String&gt;();
2062 
2063         combo.skinProperty().addListener((o, oldSkin, newSkin) -&gt; {
2064             skinChangedCount++;
2065         });
2066 
2067         combo.setDisable(false);
2068         combo.setEditable(false);
2069 
2070         comboPane.getChildren().add(combo);
2071 
2072         TabPane tabPane = new TabPane();
2073         Tab tab = new Tab();
2074         tab.setText(&quot;ComboBox&quot;);
2075         tab.setContent(comboPane);
2076         tabPane.getTabs().add(tab);
2077 
2078         BorderPane p = new BorderPane();
2079         p.setCenter(tabPane);
2080 
2081         Scene scene = new Scene(p);
2082         scene.getStylesheets().add(ComboBoxTest.class.getResource(&quot;JDK_8185854.css&quot;).toExternalForm());
2083 
2084         Toolkit tk = Toolkit.getToolkit();
2085 
2086         Stage stage = new Stage();
2087         stage.setScene(scene);
2088         stage.setWidth(500);
2089         stage.setHeight(400);
2090 
2091         stage.show();
2092 
2093         tk.firePulse();
2094 
2095         assertEquals(&quot;ComboBox skinProperty changed more than once, which is not expected.&quot;, 1, skinChangedCount);
2096     }
2097 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>