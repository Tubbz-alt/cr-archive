<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/java/com/sun/javafx/webkit/drt/DumpRenderTree.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="UIClientImpl.java.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/java/com/sun/javafx/webkit/drt/DumpRenderTree.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -43,10 +43,12 @@</span>
  import java.net.URL;
  import java.nio.ByteBuffer;
  import java.util.Date;
  import java.util.Map;
  import java.util.List;
<span class="udiff-line-added">+ import java.util.Timer;</span>
<span class="udiff-line-added">+ import java.util.TimerTask;</span>
  import java.util.concurrent.CountDownLatch;
  import javafx.scene.web.WebEngine;
  
  public final class DumpRenderTree {
      private final static PlatformLogger log = PlatformLogger.getLogger(&quot;DumpRenderTree&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -68,15 +70,31 @@</span>
      private final WebPage webPage;
      private final UIClientImpl uiClient;
      private EventSender eventSender;
  
      private CountDownLatch latch;
<span class="udiff-line-added">+     private Timer timer;</span>
      private String testPath;
      private boolean loaded;
      private boolean waiting;
      private boolean complete;
  
<span class="udiff-line-added">+     static class RenderUpdateHelper extends TimerTask {</span>
<span class="udiff-line-added">+         private WebPage webPage;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public RenderUpdateHelper(WebPage webPage) {</span>
<span class="udiff-line-added">+             this.webPage = webPage;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public void run() {</span>
<span class="udiff-line-added">+             Invoker.getInvoker().invokeOnEventThread(() -&gt; {</span>
<span class="udiff-line-added">+                     webPage.forceRepaint();</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     };</span>
<span class="udiff-line-added">+ </span>
      static class ThemeClientImplStub extends ThemeClient {
          @Override
          protected RenderTheme createRenderTheme() {
              return new RenderThemeStub();
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -151,11 +169,11 @@</span>
          if ((t &gt; 0) &amp;&amp; (t &lt; testString.length() - 1)) {
              pixelsHash = testString.substring(t + 1);
              testString = testString.substring(0, t);
          }
          this.testPath = testString;
<span class="udiff-line-modified-removed">-         init(testString, pixelsHash);</span>
<span class="udiff-line-modified-added">+         initTest(testString, pixelsHash);</span>
          return testString;
      }
  
      protected String getTestURL() {
          return testPath;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -179,12 +197,19 @@</span>
  
      private static void initPlatform() throws Exception {
          // initialize default toolkit
          final CountDownLatch latch = new CountDownLatch(1);
          PlatformImpl.startup(() -&gt; {
<span class="udiff-line-modified-removed">-             new WebEngine();    // initialize Webkit classes</span>
<span class="udiff-line-modified-added">+             // initialize Webkit classes</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 Class.forName(WebEngine.class.getName());</span>
<span class="udiff-line-added">+                 Class.forName(WebPage.class.getName());</span>
<span class="udiff-line-added">+             } catch (Exception e) {}</span>
<span class="udiff-line-added">+ </span>
              System.loadLibrary(&quot;DumpRenderTreeJava&quot;);
<span class="udiff-line-added">+             initDRT();</span>
<span class="udiff-line-added">+             new WebEngine();</span>
              drt = new DumpRenderTree();
              PageCache.setCapacity(1);
              latch.countDown();
          });
          // wait for libraries to load
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -192,20 +217,21 @@</span>
      }
  
      boolean complete() { return this.complete; }
  
      private void resetToConsistentStateBeforeTesting(final TestOptions options) {
<span class="udiff-line-added">+         // Reset native objects associated with WebPage</span>
<span class="udiff-line-added">+         webPage.resetToConsistentStateBeforeTesting();</span>
<span class="udiff-line-added">+ </span>
          // Assign default values for all supported TestOptions
          webPage.overridePreference(&quot;experimental:CSSCustomPropertiesAndValuesEnabled&quot;, &quot;false&quot;);
          webPage.overridePreference(&quot;enableColorFilter&quot;, &quot;false&quot;);
          webPage.overridePreference(&quot;enableIntersectionObserver&quot;, &quot;false&quot;);
          // Enable features based on TestOption
          for (Map.Entry&lt;String, String&gt; option : options.getOptions().entrySet()) {
              webPage.overridePreference(option.getKey(), option.getValue());
          }
<span class="udiff-line-removed">-         // Reset native objects associated with WebPage</span>
<span class="udiff-line-removed">-         webPage.resetToConsistentStateBeforeTesting();</span>
      }
  
      private void reset(final TestOptions options) {
          mlog(&quot;reset&quot;);
          // newly create EventSender for each test
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -243,17 +269,26 @@</span>
      private void runTest(final String testString) throws Exception {
          final CountDownLatch l = new CountDownLatch(1);
          Invoker.getInvoker().invokeOnEventThread(() -&gt; {
              run(testString, l);
          });
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         timer = new Timer();</span>
<span class="udiff-line-added">+         TimerTask task = new RenderUpdateHelper(webPage);</span>
<span class="udiff-line-added">+         timer.schedule(task, 1000/60, 1000/60);</span>
          // wait until test is finished
          l.await();
<span class="udiff-line-added">+         task.cancel();</span>
<span class="udiff-line-added">+         timer.cancel();</span>
<span class="udiff-line-added">+         final CountDownLatch latchForEvents = new CountDownLatch(1);</span>
          Invoker.getInvoker().invokeOnEventThread(() -&gt; {
              mlog(&quot;dispose&quot;);
              webPage.stop();
              dispose();
<span class="udiff-line-added">+             latchForEvents.countDown();</span>
          });
<span class="udiff-line-added">+         latchForEvents.await();</span>
      }
  
      // called from native
      private static void waitUntilDone() {
          mlog(&quot;waitUntilDone&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -332,11 +367,12 @@</span>
          complete = true;
          // notify main thread that test is finished
          this.latch.countDown();
      }
  
<span class="udiff-line-modified-removed">-     private static native void init(String testPath, String pixelsHash);</span>
<span class="udiff-line-modified-added">+     private static native void initDRT();</span>
<span class="udiff-line-added">+     private static native void initTest(String testPath, String pixelsHash);</span>
      private static native void didClearWindowObject(long pContext,
              long pWindowObject, EventSender eventSender);
      private static native void dispose();
  
      private static native boolean dumpAsText();
</pre>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="UIClientImpl.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>