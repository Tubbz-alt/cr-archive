<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/testing/MockPaymentCoordinator.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MockLibWebRTCPeerConnection.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MockPreviewLoaderClient.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/testing/MockPaymentCoordinator.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;MockPaymentCoordinator.h&quot;
 28 
 29 #if ENABLE(APPLE_PAY)
 30 
 31 #include &quot;ApplePaySessionPaymentRequest.h&quot;
 32 #include &quot;MockPayment.h&quot;
 33 #include &quot;MockPaymentContact.h&quot;
 34 #include &quot;MockPaymentMethod.h&quot;
 35 #include &quot;Page.h&quot;
 36 #include &quot;PaymentCoordinator.h&quot;


 37 #include &lt;wtf/CompletionHandler.h&gt;
 38 #include &lt;wtf/RunLoop.h&gt;
 39 #include &lt;wtf/URL.h&gt;
 40 
 41 namespace WebCore {
 42 
 43 MockPaymentCoordinator::MockPaymentCoordinator(Page&amp; page)
 44     : m_page { page }
 45 {
 46     m_availablePaymentNetworks.add(&quot;amex&quot;);
 47     m_availablePaymentNetworks.add(&quot;carteBancaire&quot;);
 48     m_availablePaymentNetworks.add(&quot;chinaUnionPay&quot;);
 49     m_availablePaymentNetworks.add(&quot;discover&quot;);
 50     m_availablePaymentNetworks.add(&quot;interac&quot;);
 51     m_availablePaymentNetworks.add(&quot;jcb&quot;);
 52     m_availablePaymentNetworks.add(&quot;masterCard&quot;);
 53     m_availablePaymentNetworks.add(&quot;privateLabel&quot;);
 54     m_availablePaymentNetworks.add(&quot;visa&quot;);
 55 }
 56 
</pre>
<hr />
<pre>
142 
143 void MockPaymentCoordinator::completeShippingMethodSelection(Optional&lt;ShippingMethodUpdate&gt;&amp;&amp; shippingMethodUpdate)
144 {
145     if (shippingMethodUpdate)
146         updateTotalAndLineItems(shippingMethodUpdate-&gt;newTotalAndLineItems);
147 }
148 
149 void MockPaymentCoordinator::completeShippingContactSelection(Optional&lt;ShippingContactUpdate&gt;&amp;&amp; shippingContactUpdate)
150 {
151     if (!shippingContactUpdate)
152         return;
153 
154     m_shippingMethods = convert(shippingContactUpdate-&gt;newShippingMethods);
155     updateTotalAndLineItems(shippingContactUpdate-&gt;newTotalAndLineItems);
156     m_errors = WTFMove(shippingContactUpdate-&gt;errors);
157 }
158 
159 void MockPaymentCoordinator::completePaymentMethodSelection(Optional&lt;PaymentMethodUpdate&gt;&amp;&amp; paymentMethodUpdate)
160 {
161     if (paymentMethodUpdate)
<span class="line-modified">162         updateTotalAndLineItems(paymentMethodUpdate-&gt;newTotalAndLineItems);</span>
163 }
164 
165 void MockPaymentCoordinator::changeShippingOption(String&amp;&amp; shippingOption)
166 {
167     dispatchIfShowing([page = &amp;m_page, shippingOption = WTFMove(shippingOption)]() mutable {
168         ApplePaySessionPaymentRequest::ShippingMethod shippingMethod;
169         shippingMethod.identifier = WTFMove(shippingOption);
170         page-&gt;paymentCoordinator().didSelectShippingMethod(shippingMethod);
171     });
172 }
173 
174 void MockPaymentCoordinator::changePaymentMethod(ApplePayPaymentMethod&amp;&amp; paymentMethod)
175 {
176     dispatchIfShowing([page = &amp;m_page, paymentMethod = WTFMove(paymentMethod)]() mutable {
177         page-&gt;paymentCoordinator().didSelectPaymentMethod(MockPaymentMethod { WTFMove(paymentMethod) });
178     });
179 }
180 
181 void MockPaymentCoordinator::acceptPayment()
182 {
183     dispatchIfShowing([page = &amp;m_page, shippingAddress = m_shippingAddress]() mutable {
184         ApplePayPayment payment;
185         payment.shippingContact = WTFMove(shippingAddress);
186         page-&gt;paymentCoordinator().didAuthorizePayment(MockPayment { WTFMove(payment) });
187     });
188 }
189 
190 void MockPaymentCoordinator::cancelPayment()
191 {
192     dispatchIfShowing([page = &amp;m_page] {
<span class="line-modified">193         page-&gt;paymentCoordinator().didCancelPaymentSession();</span>
194         ++hideCount;
195         ASSERT(showCount == hideCount);
196     });
197 }
198 
199 void MockPaymentCoordinator::completePaymentSession(Optional&lt;PaymentAuthorizationResult&gt;&amp;&amp; result)
200 {
201     auto isFinalState = isFinalStateResult(result);
202     m_errors = WTFMove(result-&gt;errors);
203 
204     if (!isFinalState)
205         return;
206 
207     ++hideCount;
208     ASSERT(showCount == hideCount);
209 }
210 
211 void MockPaymentCoordinator::abortPaymentSession()
212 {
213     ++hideCount;
</pre>
</td>
<td>
<hr />
<pre>
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;MockPaymentCoordinator.h&quot;
 28 
 29 #if ENABLE(APPLE_PAY)
 30 
 31 #include &quot;ApplePaySessionPaymentRequest.h&quot;
 32 #include &quot;MockPayment.h&quot;
 33 #include &quot;MockPaymentContact.h&quot;
 34 #include &quot;MockPaymentMethod.h&quot;
 35 #include &quot;Page.h&quot;
 36 #include &quot;PaymentCoordinator.h&quot;
<span class="line-added"> 37 #include &quot;PaymentMethodUpdate.h&quot;</span>
<span class="line-added"> 38 #include &quot;PaymentSessionError.h&quot;</span>
 39 #include &lt;wtf/CompletionHandler.h&gt;
 40 #include &lt;wtf/RunLoop.h&gt;
 41 #include &lt;wtf/URL.h&gt;
 42 
 43 namespace WebCore {
 44 
 45 MockPaymentCoordinator::MockPaymentCoordinator(Page&amp; page)
 46     : m_page { page }
 47 {
 48     m_availablePaymentNetworks.add(&quot;amex&quot;);
 49     m_availablePaymentNetworks.add(&quot;carteBancaire&quot;);
 50     m_availablePaymentNetworks.add(&quot;chinaUnionPay&quot;);
 51     m_availablePaymentNetworks.add(&quot;discover&quot;);
 52     m_availablePaymentNetworks.add(&quot;interac&quot;);
 53     m_availablePaymentNetworks.add(&quot;jcb&quot;);
 54     m_availablePaymentNetworks.add(&quot;masterCard&quot;);
 55     m_availablePaymentNetworks.add(&quot;privateLabel&quot;);
 56     m_availablePaymentNetworks.add(&quot;visa&quot;);
 57 }
 58 
</pre>
<hr />
<pre>
144 
145 void MockPaymentCoordinator::completeShippingMethodSelection(Optional&lt;ShippingMethodUpdate&gt;&amp;&amp; shippingMethodUpdate)
146 {
147     if (shippingMethodUpdate)
148         updateTotalAndLineItems(shippingMethodUpdate-&gt;newTotalAndLineItems);
149 }
150 
151 void MockPaymentCoordinator::completeShippingContactSelection(Optional&lt;ShippingContactUpdate&gt;&amp;&amp; shippingContactUpdate)
152 {
153     if (!shippingContactUpdate)
154         return;
155 
156     m_shippingMethods = convert(shippingContactUpdate-&gt;newShippingMethods);
157     updateTotalAndLineItems(shippingContactUpdate-&gt;newTotalAndLineItems);
158     m_errors = WTFMove(shippingContactUpdate-&gt;errors);
159 }
160 
161 void MockPaymentCoordinator::completePaymentMethodSelection(Optional&lt;PaymentMethodUpdate&gt;&amp;&amp; paymentMethodUpdate)
162 {
163     if (paymentMethodUpdate)
<span class="line-modified">164         updateTotalAndLineItems(paymentMethodUpdate-&gt;totalAndLineItems());</span>
165 }
166 
167 void MockPaymentCoordinator::changeShippingOption(String&amp;&amp; shippingOption)
168 {
169     dispatchIfShowing([page = &amp;m_page, shippingOption = WTFMove(shippingOption)]() mutable {
170         ApplePaySessionPaymentRequest::ShippingMethod shippingMethod;
171         shippingMethod.identifier = WTFMove(shippingOption);
172         page-&gt;paymentCoordinator().didSelectShippingMethod(shippingMethod);
173     });
174 }
175 
176 void MockPaymentCoordinator::changePaymentMethod(ApplePayPaymentMethod&amp;&amp; paymentMethod)
177 {
178     dispatchIfShowing([page = &amp;m_page, paymentMethod = WTFMove(paymentMethod)]() mutable {
179         page-&gt;paymentCoordinator().didSelectPaymentMethod(MockPaymentMethod { WTFMove(paymentMethod) });
180     });
181 }
182 
183 void MockPaymentCoordinator::acceptPayment()
184 {
185     dispatchIfShowing([page = &amp;m_page, shippingAddress = m_shippingAddress]() mutable {
186         ApplePayPayment payment;
187         payment.shippingContact = WTFMove(shippingAddress);
188         page-&gt;paymentCoordinator().didAuthorizePayment(MockPayment { WTFMove(payment) });
189     });
190 }
191 
192 void MockPaymentCoordinator::cancelPayment()
193 {
194     dispatchIfShowing([page = &amp;m_page] {
<span class="line-modified">195         page-&gt;paymentCoordinator().didCancelPaymentSession({ });</span>
196         ++hideCount;
197         ASSERT(showCount == hideCount);
198     });
199 }
200 
201 void MockPaymentCoordinator::completePaymentSession(Optional&lt;PaymentAuthorizationResult&gt;&amp;&amp; result)
202 {
203     auto isFinalState = isFinalStateResult(result);
204     m_errors = WTFMove(result-&gt;errors);
205 
206     if (!isFinalState)
207         return;
208 
209     ++hideCount;
210     ASSERT(showCount == hideCount);
211 }
212 
213 void MockPaymentCoordinator::abortPaymentSession()
214 {
215     ++hideCount;
</pre>
</td>
</tr>
</table>
<center><a href="MockLibWebRTCPeerConnection.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MockPreviewLoaderClient.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>