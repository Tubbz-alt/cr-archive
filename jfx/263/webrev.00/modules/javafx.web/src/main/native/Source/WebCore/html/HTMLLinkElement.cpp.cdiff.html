<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/html/HTMLLinkElement.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HTMLInputElement.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="HTMLLinkElement.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/html/HTMLLinkElement.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 48,10 ***</span>
<span class="line-new-header">--- 48,11 ---</span>
  #include &quot;Logging.h&quot;
  #include &quot;MediaList.h&quot;
  #include &quot;MediaQueryEvaluator.h&quot;
  #include &quot;MediaQueryParser.h&quot;
  #include &quot;MouseEvent.h&quot;
<span class="line-added">+ #include &quot;ParsedContentType.h&quot;</span>
  #include &quot;RenderStyle.h&quot;
  #include &quot;RuntimeEnabledFeatures.h&quot;
  #include &quot;SecurityOrigin.h&quot;
  #include &quot;Settings.h&quot;
  #include &quot;StyleInheritedData.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 59,11 ***</span>
  #include &quot;StyleScope.h&quot;
  #include &quot;StyleSheetContents.h&quot;
  #include &quot;SubresourceIntegrity.h&quot;
  #include &lt;wtf/IsoMallocInlines.h&gt;
  #include &lt;wtf/Ref.h&gt;
<span class="line-modified">! #include &lt;wtf/SetForScope.h&gt;</span>
  #include &lt;wtf/StdLibExtras.h&gt;
  
  namespace WebCore {
  
  WTF_MAKE_ISO_ALLOCATED_IMPL(HTMLLinkElement);
<span class="line-new-header">--- 60,11 ---</span>
  #include &quot;StyleScope.h&quot;
  #include &quot;StyleSheetContents.h&quot;
  #include &quot;SubresourceIntegrity.h&quot;
  #include &lt;wtf/IsoMallocInlines.h&gt;
  #include &lt;wtf/Ref.h&gt;
<span class="line-modified">! #include &lt;wtf/Scope.h&gt;</span>
  #include &lt;wtf/StdLibExtras.h&gt;
  
  namespace WebCore {
  
  WTF_MAKE_ISO_ALLOCATED_IMPL(HTMLLinkElement);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 88,10 ***</span>
<span class="line-new-header">--- 89,12 ---</span>
      , m_disabledState(Unset)
      , m_loading(false)
      , m_createdByParser(createdByParser)
      , m_firedLoad(false)
      , m_loadedResource(false)
<span class="line-added">+     , m_isHandlingBeforeLoad(false)</span>
<span class="line-added">+     , m_allowPrefetchLoadAndErrorForTesting(false)</span>
      , m_pendingSheetType(Unknown)
  {
      ASSERT(hasTagName(linkTag));
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 273,12 ***</span>
          attributeWithoutSynchronization(imagesizesAttr)
      };
  
      m_linkLoader.loadLink(params, document());
  
<span class="line-modified">!     bool treatAsStyleSheet = m_relAttribute.isStyleSheet</span>
<span class="line-modified">!         || (document().settings().treatsAnyTextCSSLinkAsStylesheet() &amp;&amp; m_type.containsIgnoringASCIICase(&quot;text/css&quot;));</span>
  
      if (m_disabledState != Disabled &amp;&amp; treatAsStyleSheet &amp;&amp; document().frame() &amp;&amp; url.isValid()) {
          String charset = attributeWithoutSynchronization(charsetAttr);
          if (charset.isEmpty())
              charset = document().charset();
<span class="line-new-header">--- 276,19 ---</span>
          attributeWithoutSynchronization(imagesizesAttr)
      };
  
      m_linkLoader.loadLink(params, document());
  
<span class="line-modified">!     bool treatAsStyleSheet = false;</span>
<span class="line-modified">!     if (m_relAttribute.isStyleSheet) {</span>
<span class="line-added">+         if (m_type.isNull())</span>
<span class="line-added">+             treatAsStyleSheet = true;</span>
<span class="line-added">+         else if (auto parsedContentType = ParsedContentType::create(m_type))</span>
<span class="line-added">+             treatAsStyleSheet = equalLettersIgnoringASCIICase(parsedContentType-&gt;mimeType(), &quot;text/css&quot;);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     if (!treatAsStyleSheet)</span>
<span class="line-added">+         treatAsStyleSheet = document().settings().treatsAnyTextCSSLinkAsStylesheet() &amp;&amp; m_type.containsIgnoringASCIICase(&quot;text/css&quot;);</span>
  
      if (m_disabledState != Disabled &amp;&amp; treatAsStyleSheet &amp;&amp; document().frame() &amp;&amp; url.isValid()) {
          String charset = attributeWithoutSynchronization(charsetAttr);
          if (charset.isEmpty())
              charset = document().charset();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 288,13 ***</span>
              m_cachedSheet-&gt;removeClient(*this);
              m_cachedSheet = nullptr;
          }
  
          {
<span class="line-modified">!         SetForScope&lt;bool&gt; change(m_isHandlingBeforeLoad, true);</span>
<span class="line-modified">!         if (!shouldLoadLink())</span>
<span class="line-modified">!             return;</span>
          }
  
          m_loading = true;
  
          bool mediaQueryMatches = true;
<span class="line-new-header">--- 298,15 ---</span>
              m_cachedSheet-&gt;removeClient(*this);
              m_cachedSheet = nullptr;
          }
  
          {
<span class="line-modified">!             bool previous = m_isHandlingBeforeLoad;</span>
<span class="line-modified">!             m_isHandlingBeforeLoad = true;</span>
<span class="line-modified">!             makeScopeExit([&amp;] { m_isHandlingBeforeLoad = previous; });</span>
<span class="line-added">+             if (!shouldLoadLink())</span>
<span class="line-added">+                 return;</span>
          }
  
          m_loading = true;
  
          bool mediaQueryMatches = true;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 324,11 ***</span>
          options.sameOriginDataURLFlag = SameOriginDataURLFlag::Set;
          if (document().contentSecurityPolicy()-&gt;allowStyleWithNonce(attributeWithoutSynchronization(HTMLNames::nonceAttr)))
              options.contentSecurityPolicyImposition = ContentSecurityPolicyImposition::SkipPolicyCheck;
          options.integrity = m_integrityMetadataForPendingSheetRequest;
  
<span class="line-modified">!         auto request = createPotentialAccessControlRequest(WTFMove(url), document(), crossOrigin(), WTFMove(options));</span>
          request.setPriority(WTFMove(priority));
          request.setCharset(WTFMove(charset));
          request.setInitiator(*this);
  
          ASSERT_WITH_SECURITY_IMPLICATION(!m_cachedSheet);
<span class="line-new-header">--- 336,11 ---</span>
          options.sameOriginDataURLFlag = SameOriginDataURLFlag::Set;
          if (document().contentSecurityPolicy()-&gt;allowStyleWithNonce(attributeWithoutSynchronization(HTMLNames::nonceAttr)))
              options.contentSecurityPolicyImposition = ContentSecurityPolicyImposition::SkipPolicyCheck;
          options.integrity = m_integrityMetadataForPendingSheetRequest;
  
<span class="line-modified">!         auto request = createPotentialAccessControlRequest(WTFMove(url), WTFMove(options), document(), crossOrigin());</span>
          request.setPriority(WTFMove(priority));
          request.setCharset(WTFMove(charset));
          request.setInitiator(*this);
  
          ASSERT_WITH_SECURITY_IMPLICATION(!m_cachedSheet);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 338,11 ***</span>
              m_cachedSheet-&gt;addClient(*this);
          else {
              // The request may have been denied if (for example) the stylesheet is local and the document is remote.
              m_loading = false;
              sheetLoaded();
<span class="line-modified">!             notifyLoadedSheetAndAllCriticalSubresources(false);</span>
          }
      } else if (m_sheet) {
          // we no longer contain a stylesheet, e.g. perhaps rel or type was changed
          clearSheet();
          m_styleScope-&gt;didChangeActiveStyleSheetCandidates();
<span class="line-new-header">--- 350,11 ---</span>
              m_cachedSheet-&gt;addClient(*this);
          else {
              // The request may have been denied if (for example) the stylesheet is local and the document is remote.
              m_loading = false;
              sheetLoaded();
<span class="line-modified">!             notifyLoadedSheetAndAllCriticalSubresources(true);</span>
          }
      } else if (m_sheet) {
          // we no longer contain a stylesheet, e.g. perhaps rel or type was changed
          clearSheet();
          m_styleScope-&gt;didChangeActiveStyleSheetCandidates();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 430,11 ***</span>
  
      // Completing the sheet load may cause scripts to execute.
      Ref&lt;HTMLLinkElement&gt; protectedThis(*this);
  
      if (!cachedStyleSheet-&gt;errorOccurred() &amp;&amp; !matchIntegrityMetadata(*cachedStyleSheet, m_integrityMetadataForPendingSheetRequest)) {
<span class="line-modified">!         document().addConsoleMessage(MessageSource::Security, MessageLevel::Error, makeString(&quot;Cannot load stylesheet &quot;, cachedStyleSheet-&gt;url().stringCenterEllipsizedToLength(), &quot;. Failed integrity metadata check.&quot;));</span>
  
          m_loading = false;
          sheetLoaded();
          notifyLoadedSheetAndAllCriticalSubresources(true);
          return;
<span class="line-new-header">--- 442,11 ---</span>
  
      // Completing the sheet load may cause scripts to execute.
      Ref&lt;HTMLLinkElement&gt; protectedThis(*this);
  
      if (!cachedStyleSheet-&gt;errorOccurred() &amp;&amp; !matchIntegrityMetadata(*cachedStyleSheet, m_integrityMetadataForPendingSheetRequest)) {
<span class="line-modified">!         document().addConsoleMessage(MessageSource::Security, MessageLevel::Error, makeString(&quot;Cannot load stylesheet &quot;, integrityMismatchDescription(*cachedStyleSheet, m_integrityMetadataForPendingSheetRequest)));</span>
  
          m_loading = false;
          sheetLoaded();
          notifyLoadedSheetAndAllCriticalSubresources(true);
          return;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 457,11 ***</span>
      auto styleSheet = StyleSheetContents::create(href, parserContext);
      initializeStyleSheet(styleSheet.copyRef(), *cachedStyleSheet, MediaQueryParserContext(document()));
  
      // FIXME: Set the visibility option based on m_sheet being clean or not.
      // Best approach might be to set it on the style sheet content itself or its context parser otherwise.
<span class="line-modified">!     styleSheet.get().parseAuthorStyleSheet(cachedStyleSheet, &amp;document().securityOrigin());</span>
  
      m_loading = false;
      styleSheet.get().notifyLoadedSheet(cachedStyleSheet);
      styleSheet.get().checkLoaded();
  
<span class="line-new-header">--- 469,16 ---</span>
      auto styleSheet = StyleSheetContents::create(href, parserContext);
      initializeStyleSheet(styleSheet.copyRef(), *cachedStyleSheet, MediaQueryParserContext(document()));
  
      // FIXME: Set the visibility option based on m_sheet being clean or not.
      // Best approach might be to set it on the style sheet content itself or its context parser otherwise.
<span class="line-modified">!     if (!styleSheet.get().parseAuthorStyleSheet(cachedStyleSheet, &amp;document().securityOrigin())) {</span>
<span class="line-added">+         m_loading = false;</span>
<span class="line-added">+         sheetLoaded();</span>
<span class="line-added">+         notifyLoadedSheetAndAllCriticalSubresources(true);</span>
<span class="line-added">+         return;</span>
<span class="line-added">+     }</span>
  
      m_loading = false;
      styleSheet.get().notifyLoadedSheet(cachedStyleSheet);
      styleSheet.get().checkLoaded();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 486,16 ***</span>
  }
  
  void HTMLLinkElement::linkLoaded()
  {
      m_loadedResource = true;
<span class="line-modified">!     linkLoadEventSender().dispatchEventSoon(*this);</span>
  }
  
  void HTMLLinkElement::linkLoadingErrored()
  {
<span class="line-modified">!     linkErrorEventSender().dispatchEventSoon(*this);</span>
  }
  
  bool HTMLLinkElement::sheetLoaded()
  {
      if (!styleSheetIsLoading()) {
<span class="line-new-header">--- 503,18 ---</span>
  }
  
  void HTMLLinkElement::linkLoaded()
  {
      m_loadedResource = true;
<span class="line-modified">!     if (!m_relAttribute.isLinkPrefetch || m_allowPrefetchLoadAndErrorForTesting)</span>
<span class="line-added">+         linkLoadEventSender().dispatchEventSoon(*this);</span>
  }
  
  void HTMLLinkElement::linkLoadingErrored()
  {
<span class="line-modified">!     if (!m_relAttribute.isLinkPrefetch || m_allowPrefetchLoadAndErrorForTesting)</span>
<span class="line-added">+         linkErrorEventSender().dispatchEventSoon(*this);</span>
  }
  
  bool HTMLLinkElement::sheetLoaded()
  {
      if (!styleSheetIsLoading()) {
</pre>
<center><a href="HTMLInputElement.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="HTMLLinkElement.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>