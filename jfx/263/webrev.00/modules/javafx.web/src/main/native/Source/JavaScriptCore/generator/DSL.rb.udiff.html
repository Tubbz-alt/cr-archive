<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/generator/DSL.rb</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Argument.rb.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="GeneratedFile.rb.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/generator/DSL.rb</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -20,17 +20,19 @@</span>
  # CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
  # ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
  # THE POSSIBILITY OF SUCH DAMAGE.
  
  require_relative &#39;Assertion&#39;
<span class="udiff-line-added">+ require_relative &#39;GeneratedFile&#39;</span>
  require_relative &#39;Section&#39;
  require_relative &#39;Template&#39;
  require_relative &#39;Type&#39;
<span class="udiff-line-modified-removed">- require_relative &#39;GeneratedFile&#39;</span>
<span class="udiff-line-modified-added">+ require_relative &#39;Wasm&#39;</span>
  
  module DSL
      @sections = []
<span class="udiff-line-added">+     @wasm_section = nil</span>
      @current_section = nil
      @context = binding()
      @namespaces = []
  
      def self.begin_section(name, config={})
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -40,10 +42,14 @@</span>
  
      def self.end_section(name)
          assert(&quot;current section&#39;s name is `#{@current_section.name}`, but end_section was called with `#{name}`&quot;) { @current_section.name == name }
          @current_section.sort!
          @sections &lt;&lt; @current_section
<span class="udiff-line-added">+         if @current_section.is_wasm?</span>
<span class="udiff-line-added">+           assert(&quot;Cannot have 2 wasm sections&quot;) { @wasm_section.nil? }</span>
<span class="udiff-line-added">+           @wasm_section = @current_section</span>
<span class="udiff-line-added">+         end</span>
          @current_section = nil
      end
  
      def self.op(name, config = {})
          assert(&quot;`op` can only be called in between `begin_section` and `end_section`&quot;) { not @current_section.nil? }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -83,73 +89,126 @@</span>
          yield
          @context = ctx
          @namespaces.pop
      end
  
<span class="udiff-line-added">+     def self.autogenerate_wasm_opcodes()</span>
<span class="udiff-line-added">+         assert(&quot;`autogenerate_wasm_opcodes` can only be called in between `begin_section` and `end_section`&quot;) { not @current_section.nil? }</span>
<span class="udiff-line-added">+         assert(&quot;`autogenerate_wasm_opcodes` can only be called from the `Wasm` section&quot;) { @current_section.name == :Wasm }</span>
<span class="udiff-line-added">+         Wasm::autogenerate_opcodes(@context, @wasm_json)</span>
<span class="udiff-line-added">+     end</span>
<span class="udiff-line-added">+ </span>
      def self.run(options)
<span class="udiff-line-modified-removed">-         bytecodeListPath = options[:bytecodeList]</span>
<span class="udiff-line-modified-removed">-         bytecodeList = File.open(bytecodeListPath)</span>
<span class="udiff-line-modified-removed">-         @context.eval(bytecodeList.read, bytecodeListPath)</span>
<span class="udiff-line-modified-added">+         bytecode_list_path = options[:bytecode_list]</span>
<span class="udiff-line-modified-added">+         bytecode_list = File.open(bytecode_list_path).read</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+         @wasm_json = File.open(options[:wasm_json_filename]).read</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @context.eval(bytecode_list, bytecode_list_path)</span>
          assert(&quot;must end last section&quot;) { @current_section.nil? }
  
<span class="udiff-line-modified-removed">-         write_bytecodes(bytecodeList, options[:bytecodesFilename])</span>
<span class="udiff-line-modified-removed">-         write_bytecode_structs(bytecodeList, options[:bytecodeStructsFilename])</span>
<span class="udiff-line-modified-removed">-         write_init_asm(bytecodeList, options[:initAsmFilename])</span>
<span class="udiff-line-modified-removed">-         write_indices(bytecodeList, options[:bytecodeIndicesFilename])</span>
<span class="udiff-line-modified-added">+         write_bytecodes(bytecode_list, options[:bytecodes_filename])</span>
<span class="udiff-line-modified-added">+         write_bytecode_structs(bytecode_list, options[:bytecode_structs_filename])</span>
<span class="udiff-line-modified-added">+         write_bytecode_dumper(bytecode_list, options[:bytecode_dumper_filename])</span>
<span class="udiff-line-modified-added">+         write_bytecodes_init(options[:init_asm_filename], bytecode_list)</span>
<span class="udiff-line-added">+         write_indices(bytecode_list, options[:bytecode_indices_filename])</span>
<span class="udiff-line-added">+         write_llint_generator(options[:wasm_llint_generator_filename], bytecode_list, @wasm_json)</span>
<span class="udiff-line-added">+         write_wasm_init(options[:wasm_init_filename], bytecode_list, @wasm_json)</span>
      end
  
      def self.write_bytecodes(bytecode_list, bytecodes_filename)
          GeneratedFile::create(bytecodes_filename, bytecode_list) do |template|
              template.prefix = &quot;#pragma once\n&quot;
              num_opcodes = @sections.map(&amp;:opcodes).flatten.size
<span class="udiff-line-modified-removed">-             template.body = &lt;&lt;-EOF</span>
<span class="udiff-line-modified-removed">- #{@sections.map { |s| s.header_helpers(num_opcodes) }.join(&quot;\n&quot;)}</span>
<span class="udiff-line-modified-removed">- #define FOR_EACH_BYTECODE_STRUCT(macro) \\</span>
<span class="udiff-line-modified-removed">- #{opcodes_for(:emit_in_structs_file).map { |op| &quot;    macro(#{op.capitalized_name}) \\&quot; }.join(&quot;\n&quot;)}</span>
<span class="udiff-line-removed">-             EOF</span>
<span class="udiff-line-modified-added">+             template.body = [</span>
<span class="udiff-line-modified-added">+                 @sections.map { |s| s.header_helpers(num_opcodes) },</span>
<span class="udiff-line-modified-added">+                 @sections.select { |s| s.config[:emit_in_structs_file] }.map(&amp;:for_each_struct)</span>
<span class="udiff-line-modified-added">+             ].flatten.join(&quot;\n&quot;)</span>
          end
      end
  
      def self.write_bytecode_structs(bytecode_list, bytecode_structs_filename)
          GeneratedFile::create(bytecode_structs_filename, bytecode_list) do |template|
<span class="udiff-line-removed">-             opcodes = opcodes_for(:emit_in_structs_file)</span>
<span class="udiff-line-removed">- </span>
              template.prefix = &lt;&lt;-EOF
  #pragma once
  
  #include &quot;ArithProfile.h&quot;
  #include &quot;BytecodeDumper.h&quot;
<span class="udiff-line-removed">- #include &quot;BytecodeGenerator.h&quot;</span>
  #include &quot;Fits.h&quot;
  #include &quot;GetByIdMetadata.h&quot;
<span class="udiff-line-added">+ #include &quot;GetByValHistory.h&quot;</span>
  #include &quot;Instruction.h&quot;
  #include &quot;Opcode.h&quot;
  #include &quot;PutByIdStatus.h&quot;
  #include &quot;PutByIdFlags.h&quot;
  #include &quot;ToThisStatus.h&quot;
  
  namespace JSC {
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void dumpBytecode(BytecodeDumperBase* dumper, InstructionStream::Offset, const Instruction*);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(WEBASSEMBLY)</span>
<span class="udiff-line-added">+ void dumpWasm(BytecodeDumperBase* dumper, InstructionStream::Offset, const Instruction*);</span>
<span class="udiff-line-added">+ #endif // ENABLE(WEBASSEMBLY)</span>
<span class="udiff-line-added">+ </span>
  EOF
  
              template.body = &lt;&lt;-EOF
<span class="udiff-line-modified-removed">- #{opcodes.map(&amp;:struct).join(&quot;\n&quot;)}</span>
<span class="udiff-line-modified-removed">- #{Opcode.dump_bytecode(opcodes)}</span>
<span class="udiff-line-modified-added">+ #{opcodes_filter { |s| s.config[:emit_in_structs_file] &amp;&amp; !s.is_wasm? }.map(&amp;:struct).join(&quot;\n&quot;)}</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(WEBASSEMBLY)</span>
<span class="udiff-line-added">+ #{opcodes_filter { |s| s.config[:emit_in_structs_file] &amp;&amp; s.is_wasm? }.map(&amp;:struct).join(&quot;\n&quot;)}</span>
<span class="udiff-line-added">+ #endif // ENABLE(WEBASSEMBLY)</span>
  EOF
              template.suffix = &quot;} // namespace JSC&quot;
          end
      end
  
<span class="udiff-line-modified-removed">-     def self.write_init_asm(bytecode_list, init_asm_filename)</span>
<span class="udiff-line-modified-removed">-         opcodes = opcodes_for(:emit_in_asm_file)</span>
<span class="udiff-line-modified-added">+     def self.write_bytecode_dumper(bytecode_list, bytecode_dumper_filename)</span>
<span class="udiff-line-modified-added">+         GeneratedFile::create(bytecode_dumper_filename, bytecode_list) do |template|</span>
<span class="udiff-line-added">+             template.prefix = &lt;&lt;-EOF</span>
<span class="udiff-line-added">+ #include &quot;config.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;BytecodeDumper.h&quot;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #include &quot;BytecodeStructs.h&quot;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ namespace JSC {</span>
<span class="udiff-line-added">+ EOF</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             template.body = &lt;&lt;-EOF</span>
<span class="udiff-line-added">+ #{Opcode.dump_bytecode(:Bytecode, :JSOpcodeTraits, opcodes_filter { |s| s.config[:emit_in_structs_file] &amp;&amp; !s.is_wasm? })}</span>
  
<span class="udiff-line-modified-removed">-         GeneratedFile::create(init_asm_filename, bytecode_list) do |template|</span>
<span class="udiff-line-modified-added">+ #if ENABLE(WEBASSEMBLY)</span>
<span class="udiff-line-added">+ #{Opcode.dump_bytecode(:Wasm, :WasmOpcodeTraits, opcodes_filter { |s| s.is_wasm? })}</span>
<span class="udiff-line-added">+ #endif // ENABLE(WEBASSEMBLY)</span>
<span class="udiff-line-added">+ EOF</span>
<span class="udiff-line-added">+             template.suffix = &quot;} // namespace JSC&quot;</span>
<span class="udiff-line-added">+         end</span>
<span class="udiff-line-added">+     end</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     def self.write_init_asm(opcodes, filename, *dependencies)</span>
<span class="udiff-line-added">+         GeneratedFile::create(filename, *dependencies) do |template|</span>
              template.multiline_comment = nil
              template.line_comment = &quot;#&quot;
              template.body = (opcodes.map.with_index(&amp;:set_entry_address) + opcodes.map.with_index(&amp;:set_entry_address_wide16) + opcodes.map.with_index(&amp;:set_entry_address_wide32)) .join(&quot;\n&quot;)
          end
      end
  
<span class="udiff-line-added">+     def self.write_bytecodes_init(bytecodes_init_filename, *dependencies)</span>
<span class="udiff-line-added">+         write_init_asm(opcodes_for(:emit_in_asm_file), bytecodes_init_filename, *dependencies)</span>
<span class="udiff-line-added">+     end</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     def self.write_wasm_init(wasm_init_filename, *dependencies)</span>
<span class="udiff-line-added">+         write_init_asm(@wasm_section.opcodes, wasm_init_filename, *dependencies)</span>
<span class="udiff-line-added">+     end</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     def self.write_llint_generator(generator_filename, *dependencies)</span>
<span class="udiff-line-added">+         GeneratedFile::create(generator_filename, *dependencies) do |template|</span>
<span class="udiff-line-added">+             template.body = Wasm::generate_llint_generator(@wasm_section)</span>
<span class="udiff-line-added">+         end</span>
<span class="udiff-line-added">+     end</span>
<span class="udiff-line-added">+ </span>
      def self.write_indices(bytecode_list, indices_filename)
          opcodes = opcodes_for(:emit_in_structs_file)
  
          GeneratedFile::create(indices_filename, bytecode_list) do |template|
              template.prefix = &quot;namespace JSC {\n&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -160,6 +219,11 @@</span>
  
      def self.opcodes_for(file)
          sections = @sections.select { |s| s.config[file] }
          sections.map(&amp;:opcodes).flatten
      end
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     def self.opcodes_filter</span>
<span class="udiff-line-added">+         sections = @sections.select { |s| yield s }</span>
<span class="udiff-line-added">+         sections.map(&amp;:opcodes).flatten</span>
<span class="udiff-line-added">+     end</span>
  end
</pre>
<center><a href="Argument.rb.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="GeneratedFile.rb.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>