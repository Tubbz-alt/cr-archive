<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/bridge/jni/jsc/JNIUtilityPrivate.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="BridgeUtils.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JNIUtilityPrivate.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bridge/jni/jsc/JNIUtilityPrivate.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 33 #include &quot;runtime_array.h&quot;
 34 #include &quot;runtime_object.h&quot;
 35 #include &quot;runtime_root.h&quot;
 36 #include &lt;JavaScriptCore/JSArray.h&gt;
 37 #include &lt;JavaScriptCore/JSLock.h&gt;
 38 
 39 #include &quot;JavaArrayJSC.h&quot;
 40 #include &quot;JavaInstanceJSC.h&quot;
 41 #include &quot;JavaRuntimeObject.h&quot;
 42 
 43 #include &quot;JSNode.h&quot;
 44 #include &quot;Node.h&quot;
 45 
 46 #include &quot;com_sun_webkit_dom_JSObject.h&quot;
 47 #define JSOBJECT_CLASSNAME &quot;com/sun/webkit/dom/JSObject&quot;
 48 
 49 namespace JSC {
 50 
 51 namespace Bindings {
 52 
<span class="line-modified"> 53 static jchar toJCharValue(const JSValue&amp; value, ExecState* exec)</span>
 54 {
 55     // If JS type is string and target Java type is char, then
 56     // return the first unicode character.
 57     if (value.isString()) {
<span class="line-modified"> 58         String stringValue = value.toString(exec)-&gt;value(exec);</span>
 59         return (jchar)stringValue[0];
 60     }
<span class="line-modified"> 61     return (jchar)value.toNumber(exec);</span>
 62 }
 63 
 64 jobject convertUndefinedToJObject()
 65 {
 66     static JGObject jgoUndefined;
 67     if (!jgoUndefined) {
 68         JNIEnv* env = getJNIEnv();
 69         jclass clazz = env-&gt;FindClass(JSOBJECT_CLASSNAME);
 70         jgoUndefined = JLObject(env-&gt;GetStaticObjectField(
 71             clazz,
 72             env-&gt;GetStaticFieldID(clazz, &quot;UNDEFINED&quot;, &quot;Ljava/lang/String;&quot;)));
 73     }
 74     return jgoUndefined;
 75 }
 76 
<span class="line-modified"> 77 jvalue convertValueToJValue(ExecState* exec, RootObject* rootObject, JSValue value, JavaType javaType, const char* javaClassName)</span>
 78 {
<span class="line-modified"> 79     JSLockHolder lock(exec);</span>
 80 
<span class="line-modified"> 81     VM&amp; vm = exec-&gt;vm();</span>
 82 
 83     jvalue result;
 84     memset(&amp;result, 0, sizeof(jvalue));
 85 
 86     switch (javaType) {
 87     case JavaTypeArray:
 88     case JavaTypeObject:
 89         {
 90             // FIXME: JavaJSObject::convertValueToJObject functionality is almost exactly the same,
 91             // these functions should use common code.
 92 
 93             if (value.isObject()) {
 94                 JSObject* object = asObject(value);
 95                 if (object-&gt;inherits(vm, JavaRuntimeObject::info())) {
 96                     // Unwrap a Java instance.
 97                     JavaRuntimeObject* runtimeObject = static_cast&lt;JavaRuntimeObject*&gt;(object);
 98                     JavaInstance* instance = runtimeObject-&gt;getInternalJavaInstance();
 99                     if (instance) {
100                         // Since instance-&gt;javaInstance() is WeakGlobalRef, creating a localref to safeguard javaInstance() from GC
101                         JLObject jlinstance(instance-&gt;javaInstance(), true);
</pre>
<hr />
<pre>
132                             nodeImplClass,
133                             getImplID,
134                             ptr_to_jlong(peer));
135                     } else {
136                         static JGClass jsObjectClass = env-&gt;FindClass(JSOBJECT_CLASSNAME);
137                         static jmethodID constructorID = env-&gt;GetMethodID(jsObjectClass, &quot;&lt;init&gt;&quot;, &quot;(JI)V&quot;);
138                         if (constructorID) {
139                             rootObject-&gt;gcProtect(object);
140                             jlong nativeHandle = ptr_to_jlong(object);
141                             result.l = env-&gt;NewObject(jsObjectClass, constructorID,
142                                 nativeHandle,
143                                 com_sun_webkit_dom_JSObject_JS_CONTEXT_OBJECT);
144                         }
145                     }
146                 }
147             }
148 
149             // Create an appropriate Java object if target type is java.lang.Object or other wrapper Objects {Integer, Double, Boolean}.
150             if (!result.l) {
151                 if (value.isString() &amp;&amp; !strcmp(javaClassName, &quot;java.lang.Object&quot;)) {
<span class="line-modified">152                     String stringValue = asString(value)-&gt;value(exec);</span>
153                     JNIEnv* env = getJNIEnv();
154                     jobject javaString = stringValue.toJavaString(env).releaseLocal();
155                     result.l = javaString;
156                 } else if (value.isString() &amp;&amp; !strcmp(javaClassName, &quot;java.lang.Character&quot;)) {
157                     JNIEnv* env = getJNIEnv();
158                     static JGClass clazz(env-&gt;FindClass(&quot;java/lang/Character&quot;));
159                     jmethodID meth = env-&gt;GetStaticMethodID(clazz, &quot;valueOf&quot;, &quot;(C)Ljava/lang/Character;&quot;);
<span class="line-modified">160                     jchar charValue = toJCharValue(value, exec);</span>
161                     jobject javaChar = env-&gt;CallStaticObjectMethod(clazz, meth, charValue);
162                     result.l = javaChar;
163                 } else if (value.isNumber()) {
164                     JNIEnv* env = getJNIEnv();
165                     if (value.isInt32() &amp;&amp; (!strcmp(javaClassName, &quot;java.lang.Number&quot;) || !strcmp(javaClassName, &quot;java.lang.Integer&quot;) || !strcmp(javaClassName, &quot;java.lang.Object&quot;))) {
166                         static JGClass clazz(env-&gt;FindClass(&quot;java/lang/Integer&quot;));
167                         jmethodID meth = env-&gt;GetStaticMethodID(clazz, &quot;valueOf&quot;, &quot;(I)Ljava/lang/Integer;&quot;);
168                         result.l = env-&gt;CallStaticObjectMethod(clazz, meth, (jint) value.asInt32());
169                     } else if (!strcmp(javaClassName, &quot;java.lang.Number&quot;) || !strcmp(javaClassName, &quot;java.lang.Double&quot;) || !strcmp(javaClassName, &quot;java.lang.Object&quot;)) {
170                         jdouble doubleValue = (jdouble) value.asNumber();
171                         static JGClass clazz = env-&gt;FindClass(&quot;java/lang/Double&quot;);
172                         jmethodID meth = env-&gt;GetStaticMethodID(clazz, &quot;valueOf&quot;, &quot;(D)Ljava/lang/Double;&quot;);
173                         jobject javaDouble = env-&gt;CallStaticObjectMethod(clazz, meth, doubleValue);
174                         result.l = javaDouble;
175                     }
176                 } else if (value.isBoolean() &amp;&amp; (!strcmp(javaClassName, &quot;java.lang.Boolean&quot;) || !strcmp(javaClassName, &quot;java.lang.Object&quot;))) {
177                     bool boolValue = value.asBoolean();
178                     JNIEnv* env = getJNIEnv();
179                     static JGClass clazz(env-&gt;FindClass(&quot;java/lang/Boolean&quot;));
180                     jmethodID meth = env-&gt;GetStaticMethodID(clazz, &quot;valueOf&quot;, &quot;(Z)Ljava/lang/Boolean;&quot;);
181                     jobject javaBoolean = env-&gt;CallStaticObjectMethod(clazz, meth, boolValue);
182                     result.l = javaBoolean;
183                 } else if (value.isUndefined()) {
184                     result.l = convertUndefinedToJObject();
185                 }
186             }
187 
188             // Convert value to a string if the target type is a java.lang.String, and we&#39;re not
189             // converting from a null.
190             if (!result.l &amp;&amp; !strcmp(javaClassName, &quot;java.lang.String&quot;)) {
191                 if (!value.isNull()) {
<span class="line-modified">192                     String stringValue = value.toString(exec)-&gt;value(exec);</span>
193                     JNIEnv* env = getJNIEnv();
194                     jobject javaString = stringValue.toJavaString(env).releaseLocal();
195                     result.l = javaString;
196                 }
197             }
198         }
199         break;
200 
201     case JavaTypeBoolean:
202         {
<span class="line-modified">203             result.z = (jboolean)value.toNumber(exec);</span>
204         }
205         break;
206 
207     case JavaTypeByte:
208         {
<span class="line-modified">209             result.b = (jbyte)value.toNumber(exec);</span>
210         }
211         break;
212 
213     case JavaTypeChar:
214         {
<span class="line-modified">215             result.c = toJCharValue(value, exec);</span>
216         }
217         break;
218 
219     case JavaTypeShort:
220         {
<span class="line-modified">221             result.s = (jshort)value.toNumber(exec);</span>
222         }
223         break;
224 
225     case JavaTypeInt:
226         {
<span class="line-modified">227             result.i = (jint)value.toNumber(exec);</span>
228         }
229         break;
230 
231     case JavaTypeLong:
232         {
<span class="line-modified">233             result.j = (jlong)value.toNumber(exec);</span>
234         }
235         break;
236 
237     case JavaTypeFloat:
238         {
<span class="line-modified">239             result.f = (jfloat)value.toNumber(exec);</span>
240         }
241         break;
242 
243     case JavaTypeDouble:
244         {
<span class="line-modified">245             result.d = (jdouble)value.toNumber(exec);</span>
246         }
247         break;
248 
249     case JavaTypeInvalid:
250     case JavaTypeVoid:
251         break;
252     }
253     return result;
254 }
255 
256 jobject jvalueToJObject(jvalue value, JavaType jtype) {
257     JNIEnv* env = getJNIEnv();
258     jmethodID meth;
259     switch (jtype) {
260     case JavaTypeObject:
261     case JavaTypeArray:
262         return value.l;
263     case JavaTypeBoolean: {
264       static JGClass clsZ(env-&gt;FindClass(&quot;java/lang/Boolean&quot;));
265       meth = env-&gt;GetStaticMethodID(clsZ, &quot;valueOf&quot;, &quot;(Z)Ljava/lang/Boolean;&quot;);
</pre>
</td>
<td>
<hr />
<pre>
 33 #include &quot;runtime_array.h&quot;
 34 #include &quot;runtime_object.h&quot;
 35 #include &quot;runtime_root.h&quot;
 36 #include &lt;JavaScriptCore/JSArray.h&gt;
 37 #include &lt;JavaScriptCore/JSLock.h&gt;
 38 
 39 #include &quot;JavaArrayJSC.h&quot;
 40 #include &quot;JavaInstanceJSC.h&quot;
 41 #include &quot;JavaRuntimeObject.h&quot;
 42 
 43 #include &quot;JSNode.h&quot;
 44 #include &quot;Node.h&quot;
 45 
 46 #include &quot;com_sun_webkit_dom_JSObject.h&quot;
 47 #define JSOBJECT_CLASSNAME &quot;com/sun/webkit/dom/JSObject&quot;
 48 
 49 namespace JSC {
 50 
 51 namespace Bindings {
 52 
<span class="line-modified"> 53 static jchar toJCharValue(const JSValue&amp; value, JSGlobalObject* globalObject)</span>
 54 {
 55     // If JS type is string and target Java type is char, then
 56     // return the first unicode character.
 57     if (value.isString()) {
<span class="line-modified"> 58         String stringValue = value.toString(globalObject)-&gt;value(globalObject);</span>
 59         return (jchar)stringValue[0];
 60     }
<span class="line-modified"> 61     return (jchar)value.toNumber(globalObject);</span>
 62 }
 63 
 64 jobject convertUndefinedToJObject()
 65 {
 66     static JGObject jgoUndefined;
 67     if (!jgoUndefined) {
 68         JNIEnv* env = getJNIEnv();
 69         jclass clazz = env-&gt;FindClass(JSOBJECT_CLASSNAME);
 70         jgoUndefined = JLObject(env-&gt;GetStaticObjectField(
 71             clazz,
 72             env-&gt;GetStaticFieldID(clazz, &quot;UNDEFINED&quot;, &quot;Ljava/lang/String;&quot;)));
 73     }
 74     return jgoUndefined;
 75 }
 76 
<span class="line-modified"> 77 jvalue convertValueToJValue(JSGlobalObject* globalObject, RootObject* rootObject, JSValue value, JavaType javaType, const char* javaClassName)</span>
 78 {
<span class="line-modified"> 79     JSLockHolder lock(globalObject);</span>
 80 
<span class="line-modified"> 81     VM&amp; vm = globalObject-&gt;vm();</span>
 82 
 83     jvalue result;
 84     memset(&amp;result, 0, sizeof(jvalue));
 85 
 86     switch (javaType) {
 87     case JavaTypeArray:
 88     case JavaTypeObject:
 89         {
 90             // FIXME: JavaJSObject::convertValueToJObject functionality is almost exactly the same,
 91             // these functions should use common code.
 92 
 93             if (value.isObject()) {
 94                 JSObject* object = asObject(value);
 95                 if (object-&gt;inherits(vm, JavaRuntimeObject::info())) {
 96                     // Unwrap a Java instance.
 97                     JavaRuntimeObject* runtimeObject = static_cast&lt;JavaRuntimeObject*&gt;(object);
 98                     JavaInstance* instance = runtimeObject-&gt;getInternalJavaInstance();
 99                     if (instance) {
100                         // Since instance-&gt;javaInstance() is WeakGlobalRef, creating a localref to safeguard javaInstance() from GC
101                         JLObject jlinstance(instance-&gt;javaInstance(), true);
</pre>
<hr />
<pre>
132                             nodeImplClass,
133                             getImplID,
134                             ptr_to_jlong(peer));
135                     } else {
136                         static JGClass jsObjectClass = env-&gt;FindClass(JSOBJECT_CLASSNAME);
137                         static jmethodID constructorID = env-&gt;GetMethodID(jsObjectClass, &quot;&lt;init&gt;&quot;, &quot;(JI)V&quot;);
138                         if (constructorID) {
139                             rootObject-&gt;gcProtect(object);
140                             jlong nativeHandle = ptr_to_jlong(object);
141                             result.l = env-&gt;NewObject(jsObjectClass, constructorID,
142                                 nativeHandle,
143                                 com_sun_webkit_dom_JSObject_JS_CONTEXT_OBJECT);
144                         }
145                     }
146                 }
147             }
148 
149             // Create an appropriate Java object if target type is java.lang.Object or other wrapper Objects {Integer, Double, Boolean}.
150             if (!result.l) {
151                 if (value.isString() &amp;&amp; !strcmp(javaClassName, &quot;java.lang.Object&quot;)) {
<span class="line-modified">152                     String stringValue = asString(value)-&gt;value(globalObject);</span>
153                     JNIEnv* env = getJNIEnv();
154                     jobject javaString = stringValue.toJavaString(env).releaseLocal();
155                     result.l = javaString;
156                 } else if (value.isString() &amp;&amp; !strcmp(javaClassName, &quot;java.lang.Character&quot;)) {
157                     JNIEnv* env = getJNIEnv();
158                     static JGClass clazz(env-&gt;FindClass(&quot;java/lang/Character&quot;));
159                     jmethodID meth = env-&gt;GetStaticMethodID(clazz, &quot;valueOf&quot;, &quot;(C)Ljava/lang/Character;&quot;);
<span class="line-modified">160                     jchar charValue = toJCharValue(value, globalObject);</span>
161                     jobject javaChar = env-&gt;CallStaticObjectMethod(clazz, meth, charValue);
162                     result.l = javaChar;
163                 } else if (value.isNumber()) {
164                     JNIEnv* env = getJNIEnv();
165                     if (value.isInt32() &amp;&amp; (!strcmp(javaClassName, &quot;java.lang.Number&quot;) || !strcmp(javaClassName, &quot;java.lang.Integer&quot;) || !strcmp(javaClassName, &quot;java.lang.Object&quot;))) {
166                         static JGClass clazz(env-&gt;FindClass(&quot;java/lang/Integer&quot;));
167                         jmethodID meth = env-&gt;GetStaticMethodID(clazz, &quot;valueOf&quot;, &quot;(I)Ljava/lang/Integer;&quot;);
168                         result.l = env-&gt;CallStaticObjectMethod(clazz, meth, (jint) value.asInt32());
169                     } else if (!strcmp(javaClassName, &quot;java.lang.Number&quot;) || !strcmp(javaClassName, &quot;java.lang.Double&quot;) || !strcmp(javaClassName, &quot;java.lang.Object&quot;)) {
170                         jdouble doubleValue = (jdouble) value.asNumber();
171                         static JGClass clazz = env-&gt;FindClass(&quot;java/lang/Double&quot;);
172                         jmethodID meth = env-&gt;GetStaticMethodID(clazz, &quot;valueOf&quot;, &quot;(D)Ljava/lang/Double;&quot;);
173                         jobject javaDouble = env-&gt;CallStaticObjectMethod(clazz, meth, doubleValue);
174                         result.l = javaDouble;
175                     }
176                 } else if (value.isBoolean() &amp;&amp; (!strcmp(javaClassName, &quot;java.lang.Boolean&quot;) || !strcmp(javaClassName, &quot;java.lang.Object&quot;))) {
177                     bool boolValue = value.asBoolean();
178                     JNIEnv* env = getJNIEnv();
179                     static JGClass clazz(env-&gt;FindClass(&quot;java/lang/Boolean&quot;));
180                     jmethodID meth = env-&gt;GetStaticMethodID(clazz, &quot;valueOf&quot;, &quot;(Z)Ljava/lang/Boolean;&quot;);
181                     jobject javaBoolean = env-&gt;CallStaticObjectMethod(clazz, meth, boolValue);
182                     result.l = javaBoolean;
183                 } else if (value.isUndefined()) {
184                     result.l = convertUndefinedToJObject();
185                 }
186             }
187 
188             // Convert value to a string if the target type is a java.lang.String, and we&#39;re not
189             // converting from a null.
190             if (!result.l &amp;&amp; !strcmp(javaClassName, &quot;java.lang.String&quot;)) {
191                 if (!value.isNull()) {
<span class="line-modified">192                     String stringValue = value.toString(globalObject)-&gt;value(globalObject);</span>
193                     JNIEnv* env = getJNIEnv();
194                     jobject javaString = stringValue.toJavaString(env).releaseLocal();
195                     result.l = javaString;
196                 }
197             }
198         }
199         break;
200 
201     case JavaTypeBoolean:
202         {
<span class="line-modified">203             result.z = (jboolean)value.toNumber(globalObject);</span>
204         }
205         break;
206 
207     case JavaTypeByte:
208         {
<span class="line-modified">209             result.b = (jbyte)value.toNumber(globalObject);</span>
210         }
211         break;
212 
213     case JavaTypeChar:
214         {
<span class="line-modified">215             result.c = toJCharValue(value, globalObject);</span>
216         }
217         break;
218 
219     case JavaTypeShort:
220         {
<span class="line-modified">221             result.s = (jshort)value.toNumber(globalObject);</span>
222         }
223         break;
224 
225     case JavaTypeInt:
226         {
<span class="line-modified">227             result.i = (jint)value.toNumber(globalObject);</span>
228         }
229         break;
230 
231     case JavaTypeLong:
232         {
<span class="line-modified">233             result.j = (jlong)value.toNumber(globalObject);</span>
234         }
235         break;
236 
237     case JavaTypeFloat:
238         {
<span class="line-modified">239             result.f = (jfloat)value.toNumber(globalObject);</span>
240         }
241         break;
242 
243     case JavaTypeDouble:
244         {
<span class="line-modified">245             result.d = (jdouble)value.toNumber(globalObject);</span>
246         }
247         break;
248 
249     case JavaTypeInvalid:
250     case JavaTypeVoid:
251         break;
252     }
253     return result;
254 }
255 
256 jobject jvalueToJObject(jvalue value, JavaType jtype) {
257     JNIEnv* env = getJNIEnv();
258     jmethodID meth;
259     switch (jtype) {
260     case JavaTypeObject:
261     case JavaTypeArray:
262         return value.l;
263     case JavaTypeBoolean: {
264       static JGClass clsZ(env-&gt;FindClass(&quot;java/lang/Boolean&quot;));
265       meth = env-&gt;GetStaticMethodID(clsZ, &quot;valueOf&quot;, &quot;(Z)Ljava/lang/Boolean;&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="BridgeUtils.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JNIUtilityPrivate.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>