<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/page/scrolling/ScrollingTreeScrollingNode.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ScrollingTreeNode.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollingTreeScrollingNode.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/scrolling/ScrollingTreeScrollingNode.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 45 
 46 void ScrollingTreeScrollingNode::commitStateBeforeChildren(const ScrollingStateNode&amp; stateNode)
 47 {
 48     const ScrollingStateScrollingNode&amp; state = downcast&lt;ScrollingStateScrollingNode&gt;(stateNode);
 49 
 50     if (state.hasChangedProperty(ScrollingStateScrollingNode::ScrollableAreaSize))
 51         m_scrollableAreaSize = state.scrollableAreaSize();
 52 
 53     if (state.hasChangedProperty(ScrollingStateScrollingNode::TotalContentsSize)) {
 54         if (scrollingTree().isRubberBandInProgress())
 55             m_totalContentsSizeForRubberBand = m_totalContentsSize;
 56         else
 57             m_totalContentsSizeForRubberBand = state.totalContentsSize();
 58 
 59         m_totalContentsSize = state.totalContentsSize();
 60     }
 61 
 62     if (state.hasChangedProperty(ScrollingStateScrollingNode::ReachableContentsSize))
 63         m_reachableContentsSize = state.reachableContentsSize();
 64 
<span class="line-modified"> 65     if (state.hasChangedProperty(ScrollingStateScrollingNode::ScrollPosition))</span>
 66         m_lastCommittedScrollPosition = state.scrollPosition();



 67 
 68     if (state.hasChangedProperty(ScrollingStateScrollingNode::ParentRelativeScrollableRect))
 69         m_parentRelativeScrollableRect = state.parentRelativeScrollableRect();
 70 
 71     if (state.hasChangedProperty(ScrollingStateScrollingNode::ScrollOrigin))
 72         m_scrollOrigin = state.scrollOrigin();
 73 
 74 #if ENABLE(CSS_SCROLL_SNAP)
 75     if (state.hasChangedProperty(ScrollingStateScrollingNode::HorizontalSnapOffsets))
 76         m_snapOffsetsInfo.horizontalSnapOffsets = state.horizontalSnapOffsets();
 77 
 78     if (state.hasChangedProperty(ScrollingStateScrollingNode::VerticalSnapOffsets))
 79         m_snapOffsetsInfo.verticalSnapOffsets = state.verticalSnapOffsets();
 80 
 81     if (state.hasChangedProperty(ScrollingStateScrollingNode::HorizontalSnapOffsetRanges))
 82         m_snapOffsetsInfo.horizontalSnapOffsetRanges = state.horizontalSnapOffsetRanges();
 83 
 84     if (state.hasChangedProperty(ScrollingStateScrollingNode::VerticalSnapOffsetRanges))
 85         m_snapOffsetsInfo.verticalSnapOffsetRanges = state.verticalSnapOffsetRanges();
 86 
 87     if (state.hasChangedProperty(ScrollingStateScrollingNode::CurrentHorizontalSnapOffsetIndex))
 88         m_currentHorizontalSnapPointIndex = state.currentHorizontalSnapPointIndex();
 89 
 90     if (state.hasChangedProperty(ScrollingStateScrollingNode::CurrentVerticalSnapOffsetIndex))
 91         m_currentVerticalSnapPointIndex = state.currentVerticalSnapPointIndex();
 92 #endif
 93 
 94     if (state.hasChangedProperty(ScrollingStateScrollingNode::ScrollableAreaParams))
 95         m_scrollableAreaParameters = state.scrollableAreaParameters();
 96 
<span class="line-removed"> 97     if (state.hasChangedProperty(ScrollingStateScrollingNode::ExpectsWheelEventTestTrigger))</span>
<span class="line-removed"> 98         m_expectsWheelEventTestTrigger = state.expectsWheelEventTestTrigger();</span>
<span class="line-removed"> 99 </span>
<span class="line-removed">100 #if PLATFORM(COCOA)</span>
101     if (state.hasChangedProperty(ScrollingStateScrollingNode::ScrollContainerLayer))
102         m_scrollContainerLayer = state.scrollContainerLayer();
103 
104     if (state.hasChangedProperty(ScrollingStateScrollingNode::ScrolledContentsLayer))
105         m_scrolledContentsLayer = state.scrolledContentsLayer();
<span class="line-removed">106 #endif</span>
107 }
108 
109 void ScrollingTreeScrollingNode::commitStateAfterChildren(const ScrollingStateNode&amp; stateNode)
110 {
111     const ScrollingStateScrollingNode&amp; scrollingStateNode = downcast&lt;ScrollingStateScrollingNode&gt;(stateNode);
<span class="line-modified">112     if (scrollingStateNode.hasChangedProperty(ScrollingStateScrollingNode::RequestedScrollPosition))</span>
<span class="line-modified">113         scrollingTree().scrollingTreeNodeRequestsScroll(scrollingNodeID(), scrollingStateNode.requestedScrollPosition(), scrollingStateNode.requestedScrollPositionRepresentsProgrammaticScroll());</span>




114 }
115 
116 ScrollingEventResult ScrollingTreeScrollingNode::handleWheelEvent(const PlatformWheelEvent&amp;)
117 {
118     return ScrollingEventResult::DidNotHandleEvent;
119 }
120 
121 FloatPoint ScrollingTreeScrollingNode::clampScrollPosition(const FloatPoint&amp; scrollPosition) const
122 {
123     return scrollPosition.constrainedBetween(minimumScrollPosition(), maximumScrollPosition());
124 }
125 
126 FloatPoint ScrollingTreeScrollingNode::minimumScrollPosition() const
127 {
128     auto minimumScrollOffset = FloatPoint { };
129     return ScrollableArea::scrollPositionFromOffset(minimumScrollOffset, toFloatSize(scrollOrigin()));
130 }
131 
132 FloatPoint ScrollingTreeScrollingNode::maximumScrollPosition() const
133 {
134     FloatPoint contentSizePoint(totalContentsSize());
135     auto maximumScrollOffset = FloatPoint(contentSizePoint - scrollableAreaSize()).expandedTo(FloatPoint());
136     return ScrollableArea::scrollPositionFromOffset(maximumScrollOffset, toFloatSize(scrollOrigin()));
137 }
138 
139 bool ScrollingTreeScrollingNode::scrollLimitReached(const PlatformWheelEvent&amp; wheelEvent) const
140 {
141     FloatPoint oldScrollPosition = currentScrollPosition();
142     FloatPoint newScrollPosition = oldScrollPosition + FloatSize(wheelEvent.deltaX(), -wheelEvent.deltaY());
143     newScrollPosition = newScrollPosition.constrainedBetween(minimumScrollPosition(), maximumScrollPosition());
144     return newScrollPosition == oldScrollPosition;
145 }
146 
<span class="line-modified">147 FloatPoint ScrollingTreeScrollingNode::adjustedScrollPosition(const FloatPoint&amp; scrollPosition, ScrollPositionClamp clamp) const</span>
148 {
<span class="line-modified">149     if (clamp == ScrollPositionClamp::ToContentEdges)</span>
150         return clampScrollPosition(scrollPosition);
151 
152     return scrollPosition;
153 }
154 
<span class="line-modified">155 void ScrollingTreeScrollingNode::scrollBy(const FloatSize&amp; delta, ScrollPositionClamp clamp)</span>
156 {
157     scrollTo(currentScrollPosition() + delta, ScrollType::User, clamp);
158 }
159 
<span class="line-modified">160 void ScrollingTreeScrollingNode::scrollTo(const FloatPoint&amp; position, ScrollType scrollType, ScrollPositionClamp clamp)</span>
161 {
162     if (position == m_currentScrollPosition)
163         return;
164 
165     scrollingTree().setIsHandlingProgrammaticScroll(scrollType == ScrollType::Programmatic);
166 
167     m_currentScrollPosition = adjustedScrollPosition(position, clamp);
168 
169     LOG_WITH_STREAM(Scrolling, stream &lt;&lt; &quot;ScrollingTreeScrollingNode &quot; &lt;&lt; scrollingNodeID() &lt;&lt; &quot; scrollTo &quot; &lt;&lt; position &lt;&lt; &quot; (delta from last committed position &quot; &lt;&lt; (m_lastCommittedScrollPosition - m_currentScrollPosition) &lt;&lt; &quot;)&quot;);
170 
171     updateViewportForCurrentScrollPosition();
172     currentScrollPositionChanged();
173 
174     scrollingTree().setIsHandlingProgrammaticScroll(false);
175 }
176 
177 void ScrollingTreeScrollingNode::currentScrollPositionChanged()
178 {
179     repositionScrollingLayers();
180     repositionRelatedLayers();
</pre>
<hr />
<pre>
183     scrollingTree().scrollingTreeNodeDidScroll(*this);
184 }
185 
186 bool ScrollingTreeScrollingNode::scrollPositionAndLayoutViewportMatch(const FloatPoint&amp; position, Optional&lt;FloatRect&gt;)
187 {
188     return position == m_currentScrollPosition;
189 }
190 
191 void ScrollingTreeScrollingNode::applyLayerPositions()
192 {
193     repositionScrollingLayers();
194     repositionRelatedLayers();
195 }
196 
197 void ScrollingTreeScrollingNode::wasScrolledByDelegatedScrolling(const FloatPoint&amp; position, Optional&lt;FloatRect&gt; overrideLayoutViewport, ScrollingLayerPositionAction scrollingLayerPositionAction)
198 {
199     bool scrollPositionChanged = !scrollPositionAndLayoutViewportMatch(position, overrideLayoutViewport);
200     if (!scrollPositionChanged &amp;&amp; scrollingLayerPositionAction != ScrollingLayerPositionAction::Set)
201         return;
202 
<span class="line-modified">203     m_currentScrollPosition = adjustedScrollPosition(position, ScrollPositionClamp::None);</span>
204     updateViewportForCurrentScrollPosition(overrideLayoutViewport);
205 
206     repositionRelatedLayers();
207 
208     scrollingTree().notifyRelatedNodesAfterScrollPositionChange(*this);
209     scrollingTree().scrollingTreeNodeDidScroll(*this, scrollingLayerPositionAction);
210     scrollingTree().didScrollByDelegatedScrolling();
211 }
212 
213 LayoutPoint ScrollingTreeScrollingNode::parentToLocalPoint(LayoutPoint point) const
214 {
215     return point - toLayoutSize(parentRelativeScrollableRect().location());
216 }
217 
218 LayoutPoint ScrollingTreeScrollingNode::localToContentsPoint(LayoutPoint point) const
219 {
220     return point + LayoutPoint(currentScrollPosition());
221 }
222 
223 ScrollingTreeScrollingNode* ScrollingTreeScrollingNode::scrollingNodeForPoint(LayoutPoint parentPoint) const
</pre>
</td>
<td>
<hr />
<pre>
 45 
 46 void ScrollingTreeScrollingNode::commitStateBeforeChildren(const ScrollingStateNode&amp; stateNode)
 47 {
 48     const ScrollingStateScrollingNode&amp; state = downcast&lt;ScrollingStateScrollingNode&gt;(stateNode);
 49 
 50     if (state.hasChangedProperty(ScrollingStateScrollingNode::ScrollableAreaSize))
 51         m_scrollableAreaSize = state.scrollableAreaSize();
 52 
 53     if (state.hasChangedProperty(ScrollingStateScrollingNode::TotalContentsSize)) {
 54         if (scrollingTree().isRubberBandInProgress())
 55             m_totalContentsSizeForRubberBand = m_totalContentsSize;
 56         else
 57             m_totalContentsSizeForRubberBand = state.totalContentsSize();
 58 
 59         m_totalContentsSize = state.totalContentsSize();
 60     }
 61 
 62     if (state.hasChangedProperty(ScrollingStateScrollingNode::ReachableContentsSize))
 63         m_reachableContentsSize = state.reachableContentsSize();
 64 
<span class="line-modified"> 65     if (state.hasChangedProperty(ScrollingStateScrollingNode::ScrollPosition)) {</span>
 66         m_lastCommittedScrollPosition = state.scrollPosition();
<span class="line-added"> 67         if (m_isFirstCommit &amp;&amp; !state.hasChangedProperty(ScrollingStateScrollingNode::RequestedScrollPosition))</span>
<span class="line-added"> 68             m_currentScrollPosition = m_lastCommittedScrollPosition;</span>
<span class="line-added"> 69     }</span>
 70 
 71     if (state.hasChangedProperty(ScrollingStateScrollingNode::ParentRelativeScrollableRect))
 72         m_parentRelativeScrollableRect = state.parentRelativeScrollableRect();
 73 
 74     if (state.hasChangedProperty(ScrollingStateScrollingNode::ScrollOrigin))
 75         m_scrollOrigin = state.scrollOrigin();
 76 
 77 #if ENABLE(CSS_SCROLL_SNAP)
 78     if (state.hasChangedProperty(ScrollingStateScrollingNode::HorizontalSnapOffsets))
 79         m_snapOffsetsInfo.horizontalSnapOffsets = state.horizontalSnapOffsets();
 80 
 81     if (state.hasChangedProperty(ScrollingStateScrollingNode::VerticalSnapOffsets))
 82         m_snapOffsetsInfo.verticalSnapOffsets = state.verticalSnapOffsets();
 83 
 84     if (state.hasChangedProperty(ScrollingStateScrollingNode::HorizontalSnapOffsetRanges))
 85         m_snapOffsetsInfo.horizontalSnapOffsetRanges = state.horizontalSnapOffsetRanges();
 86 
 87     if (state.hasChangedProperty(ScrollingStateScrollingNode::VerticalSnapOffsetRanges))
 88         m_snapOffsetsInfo.verticalSnapOffsetRanges = state.verticalSnapOffsetRanges();
 89 
 90     if (state.hasChangedProperty(ScrollingStateScrollingNode::CurrentHorizontalSnapOffsetIndex))
 91         m_currentHorizontalSnapPointIndex = state.currentHorizontalSnapPointIndex();
 92 
 93     if (state.hasChangedProperty(ScrollingStateScrollingNode::CurrentVerticalSnapOffsetIndex))
 94         m_currentVerticalSnapPointIndex = state.currentVerticalSnapPointIndex();
 95 #endif
 96 
 97     if (state.hasChangedProperty(ScrollingStateScrollingNode::ScrollableAreaParams))
 98         m_scrollableAreaParameters = state.scrollableAreaParameters();
 99 




100     if (state.hasChangedProperty(ScrollingStateScrollingNode::ScrollContainerLayer))
101         m_scrollContainerLayer = state.scrollContainerLayer();
102 
103     if (state.hasChangedProperty(ScrollingStateScrollingNode::ScrolledContentsLayer))
104         m_scrolledContentsLayer = state.scrolledContentsLayer();

105 }
106 
107 void ScrollingTreeScrollingNode::commitStateAfterChildren(const ScrollingStateNode&amp; stateNode)
108 {
109     const ScrollingStateScrollingNode&amp; scrollingStateNode = downcast&lt;ScrollingStateScrollingNode&gt;(stateNode);
<span class="line-modified">110     if (scrollingStateNode.hasChangedProperty(ScrollingStateScrollingNode::RequestedScrollPosition)) {</span>
<span class="line-modified">111         const auto&amp; requestedScrollData = scrollingStateNode.requestedScrollData();</span>
<span class="line-added">112         scrollingTree().scrollingTreeNodeRequestsScroll(scrollingNodeID(), requestedScrollData.scrollPosition, requestedScrollData.scrollType, requestedScrollData.clamping);</span>
<span class="line-added">113     }</span>
<span class="line-added">114 </span>
<span class="line-added">115     m_isFirstCommit = false;</span>
116 }
117 
118 ScrollingEventResult ScrollingTreeScrollingNode::handleWheelEvent(const PlatformWheelEvent&amp;)
119 {
120     return ScrollingEventResult::DidNotHandleEvent;
121 }
122 
123 FloatPoint ScrollingTreeScrollingNode::clampScrollPosition(const FloatPoint&amp; scrollPosition) const
124 {
125     return scrollPosition.constrainedBetween(minimumScrollPosition(), maximumScrollPosition());
126 }
127 
128 FloatPoint ScrollingTreeScrollingNode::minimumScrollPosition() const
129 {
130     auto minimumScrollOffset = FloatPoint { };
131     return ScrollableArea::scrollPositionFromOffset(minimumScrollOffset, toFloatSize(scrollOrigin()));
132 }
133 
134 FloatPoint ScrollingTreeScrollingNode::maximumScrollPosition() const
135 {
136     FloatPoint contentSizePoint(totalContentsSize());
137     auto maximumScrollOffset = FloatPoint(contentSizePoint - scrollableAreaSize()).expandedTo(FloatPoint());
138     return ScrollableArea::scrollPositionFromOffset(maximumScrollOffset, toFloatSize(scrollOrigin()));
139 }
140 
141 bool ScrollingTreeScrollingNode::scrollLimitReached(const PlatformWheelEvent&amp; wheelEvent) const
142 {
143     FloatPoint oldScrollPosition = currentScrollPosition();
144     FloatPoint newScrollPosition = oldScrollPosition + FloatSize(wheelEvent.deltaX(), -wheelEvent.deltaY());
145     newScrollPosition = newScrollPosition.constrainedBetween(minimumScrollPosition(), maximumScrollPosition());
146     return newScrollPosition == oldScrollPosition;
147 }
148 
<span class="line-modified">149 FloatPoint ScrollingTreeScrollingNode::adjustedScrollPosition(const FloatPoint&amp; scrollPosition, ScrollClamping clamping) const</span>
150 {
<span class="line-modified">151     if (clamping == ScrollClamping::Clamped)</span>
152         return clampScrollPosition(scrollPosition);
153 
154     return scrollPosition;
155 }
156 
<span class="line-modified">157 void ScrollingTreeScrollingNode::scrollBy(const FloatSize&amp; delta, ScrollClamping clamp)</span>
158 {
159     scrollTo(currentScrollPosition() + delta, ScrollType::User, clamp);
160 }
161 
<span class="line-modified">162 void ScrollingTreeScrollingNode::scrollTo(const FloatPoint&amp; position, ScrollType scrollType, ScrollClamping clamp)</span>
163 {
164     if (position == m_currentScrollPosition)
165         return;
166 
167     scrollingTree().setIsHandlingProgrammaticScroll(scrollType == ScrollType::Programmatic);
168 
169     m_currentScrollPosition = adjustedScrollPosition(position, clamp);
170 
171     LOG_WITH_STREAM(Scrolling, stream &lt;&lt; &quot;ScrollingTreeScrollingNode &quot; &lt;&lt; scrollingNodeID() &lt;&lt; &quot; scrollTo &quot; &lt;&lt; position &lt;&lt; &quot; (delta from last committed position &quot; &lt;&lt; (m_lastCommittedScrollPosition - m_currentScrollPosition) &lt;&lt; &quot;)&quot;);
172 
173     updateViewportForCurrentScrollPosition();
174     currentScrollPositionChanged();
175 
176     scrollingTree().setIsHandlingProgrammaticScroll(false);
177 }
178 
179 void ScrollingTreeScrollingNode::currentScrollPositionChanged()
180 {
181     repositionScrollingLayers();
182     repositionRelatedLayers();
</pre>
<hr />
<pre>
185     scrollingTree().scrollingTreeNodeDidScroll(*this);
186 }
187 
188 bool ScrollingTreeScrollingNode::scrollPositionAndLayoutViewportMatch(const FloatPoint&amp; position, Optional&lt;FloatRect&gt;)
189 {
190     return position == m_currentScrollPosition;
191 }
192 
193 void ScrollingTreeScrollingNode::applyLayerPositions()
194 {
195     repositionScrollingLayers();
196     repositionRelatedLayers();
197 }
198 
199 void ScrollingTreeScrollingNode::wasScrolledByDelegatedScrolling(const FloatPoint&amp; position, Optional&lt;FloatRect&gt; overrideLayoutViewport, ScrollingLayerPositionAction scrollingLayerPositionAction)
200 {
201     bool scrollPositionChanged = !scrollPositionAndLayoutViewportMatch(position, overrideLayoutViewport);
202     if (!scrollPositionChanged &amp;&amp; scrollingLayerPositionAction != ScrollingLayerPositionAction::Set)
203         return;
204 
<span class="line-modified">205     m_currentScrollPosition = adjustedScrollPosition(position, ScrollClamping::Unclamped);</span>
206     updateViewportForCurrentScrollPosition(overrideLayoutViewport);
207 
208     repositionRelatedLayers();
209 
210     scrollingTree().notifyRelatedNodesAfterScrollPositionChange(*this);
211     scrollingTree().scrollingTreeNodeDidScroll(*this, scrollingLayerPositionAction);
212     scrollingTree().didScrollByDelegatedScrolling();
213 }
214 
215 LayoutPoint ScrollingTreeScrollingNode::parentToLocalPoint(LayoutPoint point) const
216 {
217     return point - toLayoutSize(parentRelativeScrollableRect().location());
218 }
219 
220 LayoutPoint ScrollingTreeScrollingNode::localToContentsPoint(LayoutPoint point) const
221 {
222     return point + LayoutPoint(currentScrollPosition());
223 }
224 
225 ScrollingTreeScrollingNode* ScrollingTreeScrollingNode::scrollingNodeForPoint(LayoutPoint parentPoint) const
</pre>
</td>
</tr>
</table>
<center><a href="ScrollingTreeNode.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollingTreeScrollingNode.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>