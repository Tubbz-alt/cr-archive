<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/bindings/js/WebCoreJSClientData.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WebCoreBuiltinNames.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebCoreJSClientData.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bindings/js/WebCoreJSClientData.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 26,28 ***</span>
  #include &quot;config.h&quot;
  #include &quot;WebCoreJSClientData.h&quot;
  
  #include &quot;DOMGCOutputConstraint.h&quot;
  #include &quot;JSDOMBinding.h&quot;
  #include &lt;JavaScriptCore/FastMallocAlignedMemoryAllocator.h&gt;
  #include &lt;JavaScriptCore/HeapInlines.h&gt;
  #include &lt;JavaScriptCore/JSDestructibleObjectHeapCellType.h&gt;
  #include &lt;JavaScriptCore/MarkingConstraint.h&gt;
  #include &lt;JavaScriptCore/SubspaceInlines.h&gt;
  #include &lt;JavaScriptCore/VM.h&gt;
  #include &quot;runtime_method.h&quot;
  #include &lt;wtf/MainThread.h&gt;
  
  namespace WebCore {
  using namespace JSC;
  
  JSVMClientData::JSVMClientData(VM&amp; vm)
      : m_builtinFunctions(vm)
      , m_builtinNames(vm)
<span class="line-modified">!     , m_runtimeMethodSpace ISO_SUBSPACE_INIT(vm.heap, vm.destructibleObjectHeapCellType.get(), RuntimeMethod) // Hash:0xf70c4a85</span>
      , m_outputConstraintSpace(&quot;WebCore Wrapper w/ Output Constraint&quot;, vm.heap, vm.destructibleObjectHeapCellType.get(), vm.fastMallocAllocator.get()) // Hash:0x7724c2e4
<span class="line-removed">-     , m_globalObjectOutputConstraintSpace(&quot;WebCore Global Object w/ Output Constraint&quot;, vm.heap, vm.cellHeapCellType.get(), vm.fastMallocAllocator.get()) // Hash:0x522d6ec9</span>
  {
  }
  
  JSVMClientData::~JSVMClientData()
  {
<span class="line-new-header">--- 26,71 ---</span>
  #include &quot;config.h&quot;
  #include &quot;WebCoreJSClientData.h&quot;
  
  #include &quot;DOMGCOutputConstraint.h&quot;
  #include &quot;JSDOMBinding.h&quot;
<span class="line-added">+ #include &quot;JSDOMBuiltinConstructorBase.h&quot;</span>
<span class="line-added">+ #include &quot;JSDOMWindow.h&quot;</span>
<span class="line-added">+ #include &quot;JSDOMWindowProperties.h&quot;</span>
<span class="line-added">+ #include &quot;JSDedicatedWorkerGlobalScope.h&quot;</span>
<span class="line-added">+ #include &quot;JSPaintWorkletGlobalScope.h&quot;</span>
<span class="line-added">+ #include &quot;JSRemoteDOMWindow.h&quot;</span>
<span class="line-added">+ #include &quot;JSServiceWorkerGlobalScope.h&quot;</span>
<span class="line-added">+ #include &quot;JSWindowProxy.h&quot;</span>
<span class="line-added">+ #include &quot;JSWorkerGlobalScope.h&quot;</span>
<span class="line-added">+ #include &quot;JSWorkletGlobalScope.h&quot;</span>
  #include &lt;JavaScriptCore/FastMallocAlignedMemoryAllocator.h&gt;
  #include &lt;JavaScriptCore/HeapInlines.h&gt;
<span class="line-added">+ #include &lt;JavaScriptCore/IsoHeapCellType.h&gt;</span>
  #include &lt;JavaScriptCore/JSDestructibleObjectHeapCellType.h&gt;
  #include &lt;JavaScriptCore/MarkingConstraint.h&gt;
  #include &lt;JavaScriptCore/SubspaceInlines.h&gt;
  #include &lt;JavaScriptCore/VM.h&gt;
<span class="line-added">+ #include &quot;runtime_array.h&quot;</span>
  #include &quot;runtime_method.h&quot;
<span class="line-added">+ #include &quot;runtime_object.h&quot;</span>
  #include &lt;wtf/MainThread.h&gt;
  
  namespace WebCore {
  using namespace JSC;
  
  JSVMClientData::JSVMClientData(VM&amp; vm)
      : m_builtinFunctions(vm)
      , m_builtinNames(vm)
<span class="line-modified">!     , m_runtimeArrayHeapCellType(JSC::IsoHeapCellType::create&lt;RuntimeArray&gt;())</span>
<span class="line-added">+     , m_runtimeObjectHeapCellType(JSC::IsoHeapCellType::create&lt;JSC::Bindings::RuntimeObject&gt;())</span>
<span class="line-added">+     , m_windowProxyHeapCellType(JSC::IsoHeapCellType::create&lt;JSWindowProxy&gt;())</span>
<span class="line-added">+     , m_heapCellTypeForJSDOMWindow(JSC::IsoHeapCellType::create&lt;JSDOMWindow&gt;())</span>
<span class="line-added">+     , m_heapCellTypeForJSDedicatedWorkerGlobalScope(JSC::IsoHeapCellType::create&lt;JSDedicatedWorkerGlobalScope&gt;())</span>
<span class="line-added">+     , m_heapCellTypeForJSRemoteDOMWindow(JSC::IsoHeapCellType::create&lt;JSRemoteDOMWindow&gt;())</span>
<span class="line-added">+     , m_heapCellTypeForJSWorkerGlobalScope(JSC::IsoHeapCellType::create&lt;JSWorkerGlobalScope&gt;())</span>
<span class="line-added">+ #if ENABLE(SERVICE_WORKER)</span>
<span class="line-added">+     , m_heapCellTypeForJSServiceWorkerGlobalScope(JSC::IsoHeapCellType::create&lt;JSServiceWorkerGlobalScope&gt;())</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ #if ENABLE(CSS_PAINTING_API)</span>
<span class="line-added">+     , m_heapCellTypeForJSPaintWorkletGlobalScope(JSC::IsoHeapCellType::create&lt;JSPaintWorkletGlobalScope&gt;())</span>
<span class="line-added">+     , m_heapCellTypeForJSWorkletGlobalScope(JSC::IsoHeapCellType::create&lt;JSWorkletGlobalScope&gt;())</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+     , m_domBuiltinConstructorSpace ISO_SUBSPACE_INIT(vm.heap, vm.cellHeapCellType.get(), JSDOMBuiltinConstructorBase)</span>
<span class="line-added">+     , m_domConstructorSpace ISO_SUBSPACE_INIT(vm.heap, vm.cellHeapCellType.get(), JSDOMConstructorBase)</span>
<span class="line-added">+     , m_domWindowPropertiesSpace ISO_SUBSPACE_INIT(vm.heap, vm.cellHeapCellType.get(), JSDOMWindowProperties)</span>
<span class="line-added">+     , m_runtimeArraySpace ISO_SUBSPACE_INIT(vm.heap, m_runtimeArrayHeapCellType.get(), RuntimeArray)</span>
<span class="line-added">+     , m_runtimeMethodSpace ISO_SUBSPACE_INIT(vm.heap, vm.cellHeapCellType.get(), RuntimeMethod) // Hash:0xf70c4a85</span>
<span class="line-added">+     , m_runtimeObjectSpace ISO_SUBSPACE_INIT(vm.heap, m_runtimeObjectHeapCellType.get(), JSC::Bindings::RuntimeObject)</span>
<span class="line-added">+     , m_windowProxySpace ISO_SUBSPACE_INIT(vm.heap, m_windowProxyHeapCellType.get(), JSWindowProxy)</span>
<span class="line-added">+     , m_subspaceForJSDOMWindow ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSDOMWindow.get(), JSDOMWindow)</span>
<span class="line-added">+     , m_subspaceForJSDedicatedWorkerGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSDedicatedWorkerGlobalScope.get(), JSDedicatedWorkerGlobalScope)</span>
<span class="line-added">+     , m_subspaceForJSRemoteDOMWindow ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSRemoteDOMWindow.get(), JSRemoteDOMWindow)</span>
<span class="line-added">+     , m_subspaceForJSWorkerGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSWorkerGlobalScope.get(), JSWorkerGlobalScope)</span>
<span class="line-added">+ #if ENABLE(SERVICE_WORKER)</span>
<span class="line-added">+     , m_subspaceForJSServiceWorkerGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSServiceWorkerGlobalScope.get(), JSServiceWorkerGlobalScope)</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ #if ENABLE(CSS_PAINTING_API)</span>
<span class="line-added">+     , m_subspaceForJSPaintWorkletGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSPaintWorkletGlobalScope.get(), JSPaintWorkletGlobalScope)</span>
<span class="line-added">+     , m_subspaceForJSWorkletGlobalScope ISO_SUBSPACE_INIT(vm.heap, m_heapCellTypeForJSWorkletGlobalScope.get(), JSWorkletGlobalScope)</span>
<span class="line-added">+ #endif</span>
      , m_outputConstraintSpace(&quot;WebCore Wrapper w/ Output Constraint&quot;, vm.heap, vm.destructibleObjectHeapCellType.get(), vm.fastMallocAllocator.get()) // Hash:0x7724c2e4
  {
  }
  
  JSVMClientData::~JSVMClientData()
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 61,22 ***</span>
  void JSVMClientData::getAllWorlds(Vector&lt;Ref&lt;DOMWrapperWorld&gt;&gt;&amp; worlds)
  {
      ASSERT(worlds.isEmpty());
  
      worlds.reserveInitialCapacity(m_worldSet.size());
<span class="line-modified">!     for (auto it = m_worldSet.begin(), end = m_worldSet.end(); it != end; ++it)</span>
<span class="line-modified">!         worlds.uncheckedAppend(*(*it));</span>
  }
  
  void JSVMClientData::initNormalWorld(VM* vm)
  {
      JSVMClientData* clientData = new JSVMClientData(*vm);
      vm-&gt;clientData = clientData; // ~VM deletes this pointer.
  
      vm-&gt;heap.addMarkingConstraint(makeUnique&lt;DOMGCOutputConstraint&gt;(*vm, *clientData));
  
<span class="line-modified">!     clientData-&gt;m_normalWorld = DOMWrapperWorld::create(*vm, true);</span>
      vm-&gt;m_typedArrayController = adoptRef(new WebCoreTypedArrayController());
  }
  
  } // namespace WebCore
  
<span class="line-new-header">--- 104,47 ---</span>
  void JSVMClientData::getAllWorlds(Vector&lt;Ref&lt;DOMWrapperWorld&gt;&gt;&amp; worlds)
  {
      ASSERT(worlds.isEmpty());
  
      worlds.reserveInitialCapacity(m_worldSet.size());
<span class="line-modified">! </span>
<span class="line-modified">!     // It is necessary to order the `DOMWrapperWorld`s because certain callers expect the main world</span>
<span class="line-added">+     // to be the first item in the list, as they use the main world as an indicator of when the page</span>
<span class="line-added">+     // is ready to start evaluating JavaScript. For example, Web Inspector waits for the main world</span>
<span class="line-added">+     // change to clear any injected scripts and debugger/breakpoint state.</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto&amp; mainNormalWorld = mainThreadNormalWorld();</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Add main normal world.</span>
<span class="line-added">+     if (m_worldSet.contains(&amp;mainNormalWorld))</span>
<span class="line-added">+         worlds.uncheckedAppend(mainNormalWorld);</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Add other normal worlds.</span>
<span class="line-added">+     for (auto* world : m_worldSet) {</span>
<span class="line-added">+         if (world-&gt;type() != DOMWrapperWorld::Type::Normal)</span>
<span class="line-added">+             continue;</span>
<span class="line-added">+         if (world == &amp;mainNormalWorld)</span>
<span class="line-added">+             continue;</span>
<span class="line-added">+         worlds.uncheckedAppend(*world);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Add non-normal worlds.</span>
<span class="line-added">+     for (auto* world : m_worldSet) {</span>
<span class="line-added">+         if (world-&gt;type() == DOMWrapperWorld::Type::Normal)</span>
<span class="line-added">+             continue;</span>
<span class="line-added">+         worlds.uncheckedAppend(*world);</span>
<span class="line-added">+     }</span>
  }
  
  void JSVMClientData::initNormalWorld(VM* vm)
  {
      JSVMClientData* clientData = new JSVMClientData(*vm);
      vm-&gt;clientData = clientData; // ~VM deletes this pointer.
  
      vm-&gt;heap.addMarkingConstraint(makeUnique&lt;DOMGCOutputConstraint&gt;(*vm, *clientData));
  
<span class="line-modified">!     clientData-&gt;m_normalWorld = DOMWrapperWorld::create(*vm, DOMWrapperWorld::Type::Normal);</span>
      vm-&gt;m_typedArrayController = adoptRef(new WebCoreTypedArrayController());
  }
  
  } // namespace WebCore
  
</pre>
<center><a href="WebCoreBuiltinNames.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebCoreJSClientData.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>