<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/loader/DocumentLoader.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DocumentLoader.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DocumentThreadableLoader.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/DocumentLoader.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (C) 2006-2017 Apple Inc. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 2006-2020 Apple Inc. All rights reserved.</span>
   * Copyright (C) 2011 Google Inc. All rights reserved.
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -29,10 +29,11 @@</span>
  
  #pragma once
  
  #include &quot;CachedRawResourceClient.h&quot;
  #include &quot;CachedResourceHandle.h&quot;
<span class="udiff-line-added">+ #include &quot;ContentFilterClient.h&quot;</span>
  #include &quot;ContentSecurityPolicyClient.h&quot;
  #include &quot;DeviceOrientationOrMotionPermissionState.h&quot;
  #include &quot;DocumentIdentifier.h&quot;
  #include &quot;DocumentWriter.h&quot;
  #include &quot;FrameDestructionObserver.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -135,22 +136,29 @@</span>
      Default,
      Disable,
      Enable,
  };
  
<span class="udiff-line-added">+ DECLARE_ALLOCATOR_WITH_HEAP_IDENTIFIER(DocumentLoader);</span>
  class DocumentLoader
      : public RefCounted&lt;DocumentLoader&gt;
      , public FrameDestructionObserver
      , public ContentSecurityPolicyClient
<span class="udiff-line-added">+ #if ENABLE(CONTENT_FILTERING)</span>
<span class="udiff-line-added">+     , public ContentFilterClient</span>
<span class="udiff-line-added">+ #endif</span>
      , private CachedRawResourceClient {
<span class="udiff-line-modified-removed">-     WTF_MAKE_FAST_ALLOCATED;</span>
<span class="udiff-line-modified-added">+     WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER(DocumentLoader);</span>
      friend class ContentFilter;
  public:
      static Ref&lt;DocumentLoader&gt; create(const ResourceRequest&amp; request, const SubstituteData&amp; data)
      {
          return adoptRef(*new DocumentLoader(request, data));
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     WEBCORE_EXPORT static DocumentLoader* fromTemporaryDocumentIdentifier(DocumentIdentifier);</span>
<span class="udiff-line-added">+ </span>
      WEBCORE_EXPORT virtual ~DocumentLoader();
  
      void attachToFrame(Frame&amp;);
  
      WEBCORE_EXPORT virtual void detachFromFrame();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -231,11 +239,11 @@</span>
      // pulling from the ArchiveResourceCollection.
      WEBCORE_EXPORT RefPtr&lt;ArchiveResource&gt; subresource(const URL&amp;) const;
  
      WEBCORE_EXPORT Vector&lt;Ref&lt;ArchiveResource&gt;&gt; subresources() const;
  
<span class="udiff-line-modified-removed">- #ifndef NDEBUG</span>
<span class="udiff-line-modified-added">+ #if ASSERT_ENABLED</span>
      bool isSubstituteLoadPending(ResourceLoader*) const;
  #endif
      void cancelPendingSubstituteLoad(ResourceLoader*);
  
      void addResponse(const ResourceResponse&amp;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -266,12 +274,10 @@</span>
      String serverRedirectDestinationForHistory() const { return url(); }
  
      bool didCreateGlobalHistoryEntry() const { return m_didCreateGlobalHistoryEntry; }
      void setDidCreateGlobalHistoryEntry(bool didCreateGlobalHistoryEntry) { m_didCreateGlobalHistoryEntry = didCreateGlobalHistoryEntry; }
  
<span class="udiff-line-removed">-     bool subresourceLoadersArePageCacheAcceptable() const { return m_subresourceLoadersArePageCacheAcceptable; }</span>
<span class="udiff-line-removed">- </span>
      void setDefersLoading(bool);
      void setMainResourceDataBufferingPolicy(DataBufferingPolicy);
  
      void startLoadingMainResource();
      WEBCORE_EXPORT void cancelMainResourceLoad(const ResourceError&amp;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -296,12 +302,12 @@</span>
      void setAutoplayPolicy(AutoplayPolicy policy) { m_autoplayPolicy = policy; }
  
      void setCustomUserAgent(const String&amp; customUserAgent) { m_customUserAgent = customUserAgent; }
      const String&amp; customUserAgent() const { return m_customUserAgent; }
  
<span class="udiff-line-modified-removed">-     void setCustomJavaScriptUserAgentAsSiteSpecificQuirks(const String&amp; customUserAgent) { m_customJavaScriptUserAgentAsSiteSpecificQuirks = customUserAgent; }</span>
<span class="udiff-line-modified-removed">-     const String&amp; customJavaScriptUserAgentAsSiteSpecificQuirks() const { return m_customJavaScriptUserAgentAsSiteSpecificQuirks; }</span>
<span class="udiff-line-modified-added">+     void setCustomUserAgentAsSiteSpecificQuirks(const String&amp; customUserAgent) { m_customUserAgentAsSiteSpecificQuirks = customUserAgent; }</span>
<span class="udiff-line-modified-added">+     const String&amp; customUserAgentAsSiteSpecificQuirks() const { return m_customUserAgentAsSiteSpecificQuirks; }</span>
  
      void setCustomNavigatorPlatform(const String&amp; customNavigatorPlatform) { m_customNavigatorPlatform = customNavigatorPlatform; }
      const String&amp; customNavigatorPlatform() const { return m_customNavigatorPlatform; }
  
      OptionSet&lt;AutoplayQuirk&gt; allowedAutoplayQuirks() const { return m_allowedAutoplayQuirks; }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -349,11 +355,11 @@</span>
  
      // The URL of the document resulting from this DocumentLoader.
      URL documentURL() const;
  
  #if USE(QUICK_LOOK)
<span class="udiff-line-modified-removed">-     void setPreviewConverter(std::unique_ptr&lt;PreviewConverter&gt;&amp;&amp;);</span>
<span class="udiff-line-modified-added">+     void setPreviewConverter(RefPtr&lt;PreviewConverter&gt;&amp;&amp;);</span>
      PreviewConverter* previewConverter() const;
  #endif
  
  #if ENABLE(CONTENT_EXTENSIONS)
      void addPendingContentExtensionSheet(const String&amp; identifier, StyleSheetContents&amp;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -362,11 +368,13 @@</span>
  
      void setShouldOpenExternalURLsPolicy(ShouldOpenExternalURLsPolicy shouldOpenExternalURLsPolicy) { m_shouldOpenExternalURLsPolicy = shouldOpenExternalURLsPolicy; }
      ShouldOpenExternalURLsPolicy shouldOpenExternalURLsPolicyToPropagate() const;
  
  #if ENABLE(CONTENT_FILTERING)
<span class="udiff-line-modified-removed">-     ContentFilter* contentFilter() const;</span>
<span class="udiff-line-modified-added">+     ContentFilter* contentFilter() const { return m_contentFilter.get(); }</span>
<span class="udiff-line-added">+     void ref() const final { RefCounted&lt;DocumentLoader&gt;::ref(); }</span>
<span class="udiff-line-added">+     void deref() const final { RefCounted&lt;DocumentLoader&gt;::deref(); }</span>
  #endif
  
      bool isAlwaysOnLoggingAllowed() const;
  
      void startIconLoading();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -384,18 +392,25 @@</span>
      const Vector&lt;CustomHeaderFields&gt;&amp; customHeaderFields() const { return m_customHeaderFields; }
  
      void setAllowsWebArchiveForMainFrame(bool allowsWebArchiveForMainFrame) { m_allowsWebArchiveForMainFrame = allowsWebArchiveForMainFrame; }
      bool allowsWebArchiveForMainFrame() const { return m_allowsWebArchiveForMainFrame; }
  
<span class="udiff-line-added">+     void setAllowsDataURLsForMainFrame(bool allowsDataURLsForMainFrame) { m_allowsDataURLsForMainFrame = allowsDataURLsForMainFrame; }</span>
<span class="udiff-line-added">+     bool allowsDataURLsForMainFrame() const { return m_allowsDataURLsForMainFrame; }</span>
<span class="udiff-line-added">+ </span>
      void setDownloadAttribute(const String&amp; attribute) { m_downloadAttribute = attribute; }
      const String&amp; downloadAttribute() const { return m_downloadAttribute; }
  
      WEBCORE_EXPORT void applyPoliciesToSettings();
  
      void setAllowContentChangeObserverQuirk(bool allow) { m_allowContentChangeObserverQuirk = allow; }
      bool allowContentChangeObserverQuirk() const { return m_allowContentChangeObserverQuirk; }
  
<span class="udiff-line-added">+ #if ENABLE(SERVICE_WORKER)</span>
<span class="udiff-line-added">+     WEBCORE_EXPORT bool setControllingServiceWorkerRegistration(ServiceWorkerRegistrationData&amp;&amp;);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  protected:
      WEBCORE_EXPORT DocumentLoader(const ResourceRequest&amp;, const SubstituteData&amp;);
  
      WEBCORE_EXPORT virtual void attachToFrame();
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -405,11 +420,10 @@</span>
      Document* document() const;
  
  #if ENABLE(SERVICE_WORKER)
      void matchRegistration(const URL&amp;, CompletionHandler&lt;void(Optional&lt;ServiceWorkerRegistrationData&gt;&amp;&amp;)&gt;&amp;&amp;);
  #endif
<span class="udiff-line-removed">-     void registerTemporaryServiceWorkerClient(const URL&amp;);</span>
      void unregisterTemporaryServiceWorkerClient();
  
      void loadMainResource(ResourceRequest&amp;&amp;);
  
      void setRequest(const ResourceRequest&amp;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -432,25 +446,34 @@</span>
      void mainReceivedError(const ResourceError&amp;);
      WEBCORE_EXPORT void redirectReceived(CachedResource&amp;, ResourceRequest&amp;&amp;, const ResourceResponse&amp;, CompletionHandler&lt;void(ResourceRequest&amp;&amp;)&gt;&amp;&amp;) override;
      WEBCORE_EXPORT void responseReceived(CachedResource&amp;, const ResourceResponse&amp;, CompletionHandler&lt;void()&gt;&amp;&amp;) override;
      WEBCORE_EXPORT void dataReceived(CachedResource&amp;, const char* data, int length) override;
      WEBCORE_EXPORT void notifyFinished(CachedResource&amp;) override;
<span class="udiff-line-added">+ #if USE(QUICK_LOOK)</span>
<span class="udiff-line-added">+     WEBCORE_EXPORT void previewResponseReceived(CachedResource&amp;, const ResourceResponse&amp;) override;</span>
<span class="udiff-line-added">+ #endif</span>
  
      void responseReceived(const ResourceResponse&amp;, CompletionHandler&lt;void()&gt;&amp;&amp;);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(CONTENT_FILTERING)</span>
<span class="udiff-line-added">+     // ContentFilterClient</span>
<span class="udiff-line-added">+     WEBCORE_EXPORT void dataReceivedThroughContentFilter(const char*, int) final;</span>
<span class="udiff-line-added">+     WEBCORE_EXPORT ResourceError contentFilterDidBlock(ContentFilterUnblockHandler, String&amp;&amp; unblockRequestDeniedScript) final;</span>
<span class="udiff-line-added">+     WEBCORE_EXPORT void cancelMainResourceLoadForContentFilter(const ResourceError&amp;) final;</span>
<span class="udiff-line-added">+     WEBCORE_EXPORT void handleProvisionalLoadFailureFromContentFilter(const URL&amp; blockedPageURL, SubstituteData&amp;) final;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
      void dataReceived(const char* data, int length);
  
      bool maybeLoadEmpty();
  
      bool isMultipartReplacingLoad() const;
      bool isPostOrRedirectAfterPost(const ResourceRequest&amp;, const ResourceResponse&amp;);
  
      bool tryLoadingRequestFromApplicationCache();
      bool tryLoadingSubstituteData();
      bool tryLoadingRedirectRequestFromApplicationCache(const ResourceRequest&amp;);
<span class="udiff-line-removed">- #if ENABLE(SERVICE_WORKER)</span>
<span class="udiff-line-removed">-     void restartLoadingDueToServiceWorkerRegistrationChange(ResourceRequest&amp;&amp;, Optional&lt;ServiceWorkerRegistrationData&gt;&amp;&amp;);</span>
<span class="udiff-line-removed">- #endif</span>
      void continueAfterContentPolicy(PolicyAction);
  
      void stopLoadingForPolicyChange();
      ResourceError interruptedForPolicyChangeError() const;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -480,10 +503,11 @@</span>
      WEBCORE_EXPORT void addConsoleMessage(MessageSource, MessageLevel, const String&amp;, unsigned long requestIdentifier) final;
      WEBCORE_EXPORT void sendCSPViolationReport(URL&amp;&amp;, Ref&lt;FormData&gt;&amp;&amp;) final;
      WEBCORE_EXPORT void enqueueSecurityPolicyViolationEvent(SecurityPolicyViolationEvent::Init&amp;&amp;) final;
  
      bool disallowWebArchive() const;
<span class="udiff-line-added">+     bool disallowDataRequest() const;</span>
  
      Ref&lt;CachedResourceLoader&gt; m_cachedResourceLoader;
  
      CachedResourceHandle&lt;CachedRawResource&gt; m_mainResource;
      ResourceLoaderMap m_subresourceLoaders;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -536,11 +560,11 @@</span>
      // so we can avoid asking again needlessly.
      ResourceRequest m_lastCheckedRequest;
  
      // We retain all the received responses so we can play back the
      // WebResourceLoadDelegate messages if the item is loaded from the
<span class="udiff-line-modified-removed">-     // page cache.</span>
<span class="udiff-line-modified-added">+     // back/forward cache.</span>
      Vector&lt;ResourceResponse&gt; m_responses;
      bool m_stopRecordingResponses { false };
  
      typedef HashMap&lt;RefPtr&lt;ResourceLoader&gt;, RefPtr&lt;SubstituteResource&gt;&gt; SubstituteResourceMap;
      SubstituteResourceMap m_pendingSubstituteResources;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -576,29 +600,28 @@</span>
      HashMap&lt;std::unique_ptr&lt;ApplicationManifestLoader&gt;, uint64_t&gt; m_applicationManifestLoaders;
  #endif
  
      Vector&lt;CustomHeaderFields&gt; m_customHeaderFields;
  
<span class="udiff-line-removed">-     bool m_subresourceLoadersArePageCacheAcceptable { false };</span>
      ShouldOpenExternalURLsPolicy m_shouldOpenExternalURLsPolicy { ShouldOpenExternalURLsPolicy::ShouldNotAllow };
  
      std::unique_ptr&lt;ApplicationCacheHost&gt; m_applicationCacheHost;
  
  #if ENABLE(CONTENT_FILTERING)
      std::unique_ptr&lt;ContentFilter&gt; m_contentFilter;
  #endif
  
  #if USE(QUICK_LOOK)
<span class="udiff-line-modified-removed">-     std::unique_ptr&lt;PreviewConverter&gt; m_previewConverter;</span>
<span class="udiff-line-modified-added">+     RefPtr&lt;PreviewConverter&gt; m_previewConverter;</span>
  #endif
  
  #if ENABLE(CONTENT_EXTENSIONS)
      HashMap&lt;String, RefPtr&lt;StyleSheetContents&gt;&gt; m_pendingNamedContentExtensionStyleSheets;
      HashMap&lt;String, Vector&lt;std::pair&lt;String, uint32_t&gt;&gt;&gt; m_pendingContentExtensionDisplayNoneSelectors;
  #endif
      String m_customUserAgent;
<span class="udiff-line-modified-removed">-     String m_customJavaScriptUserAgentAsSiteSpecificQuirks;</span>
<span class="udiff-line-modified-added">+     String m_customUserAgentAsSiteSpecificQuirks;</span>
      bool m_allowContentChangeObserverQuirk { false };
      String m_customNavigatorPlatform;
      bool m_userContentExtensionsEnabled { true };
  #if ENABLE(DEVICE_ORIENTATION)
      DeviceOrientationOrMotionPermissionState m_deviceOrientationAndMotionAccessState { DeviceOrientationOrMotionPermissionState::Prompt };
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -611,22 +634,19 @@</span>
      SimulatedMouseEventsDispatchPolicy m_simulatedMouseEventsDispatchPolicy { SimulatedMouseEventsDispatchPolicy::Default };
      LegacyOverflowScrollingTouchPolicy m_legacyOverflowScrollingTouchPolicy { LegacyOverflowScrollingTouchPolicy::Default };
  
  #if ENABLE(SERVICE_WORKER)
      Optional&lt;ServiceWorkerRegistrationData&gt; m_serviceWorkerRegistrationData;
<span class="udiff-line-modified-removed">-     struct TemporaryServiceWorkerClient {</span>
<span class="udiff-line-removed">-         DocumentIdentifier documentIdentifier;</span>
<span class="udiff-line-removed">-         PAL::SessionID sessionID;</span>
<span class="udiff-line-removed">-     };</span>
<span class="udiff-line-removed">-     Optional&lt;TemporaryServiceWorkerClient&gt; m_temporaryServiceWorkerClient;</span>
<span class="udiff-line-modified-added">+     Optional&lt;DocumentIdentifier&gt; m_temporaryServiceWorkerClient;</span>
  #endif
  
<span class="udiff-line-modified-removed">- #ifndef NDEBUG</span>
<span class="udiff-line-modified-added">+ #if ASSERT_ENABLED</span>
      bool m_hasEverBeenAttached { false };
  #endif
  
      bool m_allowsWebArchiveForMainFrame { false };
<span class="udiff-line-added">+     bool m_allowsDataURLsForMainFrame { false };</span>
      String m_downloadAttribute;
  };
  
  inline void DocumentLoader::recordMemoryCacheLoadForFutureClientNotification(const ResourceRequest&amp; request)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -700,19 +720,10 @@</span>
  inline ApplicationCacheHost* DocumentLoader::applicationCacheHostUnlessBeingDestroyed() const
  {
      return m_applicationCacheHost.get();
  }
  
<span class="udiff-line-removed">- #if ENABLE(CONTENT_FILTERING)</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- inline ContentFilter* DocumentLoader::contentFilter() const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     return m_contentFilter.get();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
  inline void DocumentLoader::didTellClientAboutLoad(const String&amp; url)
  {
  #if !PLATFORM(COCOA)
      // Don&#39;t include data URLs here, as if a lot of data is loaded that way, we hold on to the (large) URL string for too long.
      if (protocolIs(url, &quot;data&quot;))
</pre>
<center><a href="DocumentLoader.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DocumentThreadableLoader.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>