<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/html/track/WebVTTParser.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="VideoTrackList.idl.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebVTTParser.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/html/track/WebVTTParser.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
  2  * Copyright (C) 2011, 2013 Google Inc.  All rights reserved.
  3  * Copyright (C) 2013 Cable Television Labs, Inc.
<span class="line-modified">  4  * Copyright (C) 2011-2014 Apple Inc.  All rights reserved.</span>
  5  *
  6  * Redistribution and use in source and binary forms, with or without
  7  * modification, are permitted provided that the following conditions are
  8  * met:
  9  *
 10  *     * Redistributions of source code must retain the above copyright
 11  * notice, this list of conditions and the following disclaimer.
 12  *     * Redistributions in binary form must reproduce the above
 13  * copyright notice, this list of conditions and the following disclaimer
 14  * in the documentation and/or other materials provided with the
 15  * distribution.
 16  *     * Neither the name of Google Inc. nor the names of its
 17  * contributors may be used to endorse or promote products derived from
 18  * this software without specific prior written permission.
 19  *
 20  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 21  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 22  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 23  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 24  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
</pre>
<hr />
<pre>
298     return state;
299 }
300 
301 WebVTTParser::ParseState WebVTTParser::checkAndRecoverCue(const String&amp; line)
302 {
303     // parse cue timings and settings
304     if (line.contains(&quot;--&gt;&quot;)) {
305         ParseState state = recoverCue(line);
306         if (state != BadCue)
307             return state;
308     }
309     return Header;
310 }
311 
312 WebVTTParser::ParseState WebVTTParser::collectStyleSheet(const String&amp; line)
313 {
314     // End of style block
315     if (checkAndStoreStyleSheet(line))
316         return checkAndRecoverCue(line);
317 
<span class="line-modified">318     m_currentStyleSheet.append(line);</span>
319     return Style;
320 }
321 
322 bool WebVTTParser::checkAndCreateRegion(const String&amp; line)
323 {
324     if (m_previousLine.contains(&quot;--&gt;&quot;))
325         return false;
326     // line starts with the substring &quot;REGION&quot; and remaining characters
327     // zero or more U+0020 SPACE characters or U+0009 CHARACTER TABULATION
328     // (tab) characters expected other than these charecters it is invalid.
329     if (line.startsWith(&quot;REGION&quot;) &amp;&amp; line.substring(regionIdentifierLength).isAllSpecialCharacters&lt;isASpace&gt;()) {
330         m_currentRegion = VTTRegion::create(*m_scriptExecutionContext);
331         return true;
332     }
333     return false;
334 }
335 
336 bool WebVTTParser::checkAndStoreRegion(const String&amp; line)
337 {
338     if (!line.isEmpty() &amp;&amp; !line.contains(&quot;--&gt;&quot;))
</pre>
<hr />
<pre>
354 }
355 
356 bool WebVTTParser::checkStyleSheet(const String&amp; line)
357 {
358     if (m_previousLine.contains(&quot;--&gt;&quot;))
359         return false;
360     // line starts with the substring &quot;STYLE&quot; and remaining characters
361     // zero or more U+0020 SPACE characters or U+0009 CHARACTER TABULATION
362     // (tab) characters expected other than these charecters it is invalid.
363     if (line.startsWith(&quot;STYLE&quot;) &amp;&amp; line.substring(styleIdentifierLength).isAllSpecialCharacters&lt;isASpace&gt;())
364         return true;
365 
366     return false;
367 }
368 
369 bool WebVTTParser::checkAndStoreStyleSheet(const String&amp; line)
370 {
371     if (!line.isEmpty() &amp;&amp; !line.contains(&quot;--&gt;&quot;))
372         return false;
373 
<span class="line-modified">374     auto styleSheet = WTFMove(m_currentStyleSheet);</span>
375 
<span class="line-modified">376     auto contents = StyleSheetContents::create();</span>
<span class="line-modified">377     if (!contents-&gt;parseString(styleSheet))</span>

378         return true;
379 
380     auto&amp; namespaceRules = contents-&gt;namespaceRules();
381     if (namespaceRules.size())
382         return true;
383 
384     auto&amp; importRules = contents-&gt;importRules();
385     if (importRules.size())
386         return true;
387 
388     auto&amp; childRules = contents-&gt;childRules();
389     if (!childRules.size())
390         return true;
391 
<span class="line-modified">392     for (auto rule : childRules) {</span>


393         if (!rule-&gt;isStyleRule())
394             return true;
<span class="line-modified">395         const auto&amp; styleRule = downcast&lt;StyleRule&gt;(rule.get());</span>
396 
<span class="line-modified">397         const auto&amp; selectorList = styleRule-&gt;selectorList();</span>
398         if (selectorList.listSize() != 1)
399             return true;
400         auto selector = selectorList.selectorAt(0);
<span class="line-modified">401         if (selector-&gt;selectorText() != &quot;::cue&quot;)</span>



402             return true;





403     }
404 
<span class="line-modified">405     m_styleSheets.append(styleSheet);</span>



406     return true;
407 }
408 
409 WebVTTParser::ParseState WebVTTParser::collectCueId(const String&amp; line)
410 {
411     if (line.contains(&quot;--&gt;&quot;))
412         return collectTimingsAndSettings(line);
413     m_currentId = line;
414     return TimingsAndSettings;
415 }
416 
417 WebVTTParser::ParseState WebVTTParser::collectTimingsAndSettings(const String&amp; line)
418 {
419     if (line.isEmpty())
420         return BadCue;
421 
422     VTTScanner input(line);
423 
424     // Collect WebVTT cue timings and settings. (5.3 WebVTT cue timings and settings parsing.)
425     // Steps 1 - 3 - Let input be the string being parsed and position be a pointer into input
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
  2  * Copyright (C) 2011, 2013 Google Inc.  All rights reserved.
  3  * Copyright (C) 2013 Cable Television Labs, Inc.
<span class="line-modified">  4  * Copyright (C) 2011-2020 Apple Inc.  All rights reserved.</span>
  5  *
  6  * Redistribution and use in source and binary forms, with or without
  7  * modification, are permitted provided that the following conditions are
  8  * met:
  9  *
 10  *     * Redistributions of source code must retain the above copyright
 11  * notice, this list of conditions and the following disclaimer.
 12  *     * Redistributions in binary form must reproduce the above
 13  * copyright notice, this list of conditions and the following disclaimer
 14  * in the documentation and/or other materials provided with the
 15  * distribution.
 16  *     * Neither the name of Google Inc. nor the names of its
 17  * contributors may be used to endorse or promote products derived from
 18  * this software without specific prior written permission.
 19  *
 20  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 21  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 22  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 23  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 24  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
</pre>
<hr />
<pre>
298     return state;
299 }
300 
301 WebVTTParser::ParseState WebVTTParser::checkAndRecoverCue(const String&amp; line)
302 {
303     // parse cue timings and settings
304     if (line.contains(&quot;--&gt;&quot;)) {
305         ParseState state = recoverCue(line);
306         if (state != BadCue)
307             return state;
308     }
309     return Header;
310 }
311 
312 WebVTTParser::ParseState WebVTTParser::collectStyleSheet(const String&amp; line)
313 {
314     // End of style block
315     if (checkAndStoreStyleSheet(line))
316         return checkAndRecoverCue(line);
317 
<span class="line-modified">318     m_currentSourceStyleSheet.append(line);</span>
319     return Style;
320 }
321 
322 bool WebVTTParser::checkAndCreateRegion(const String&amp; line)
323 {
324     if (m_previousLine.contains(&quot;--&gt;&quot;))
325         return false;
326     // line starts with the substring &quot;REGION&quot; and remaining characters
327     // zero or more U+0020 SPACE characters or U+0009 CHARACTER TABULATION
328     // (tab) characters expected other than these charecters it is invalid.
329     if (line.startsWith(&quot;REGION&quot;) &amp;&amp; line.substring(regionIdentifierLength).isAllSpecialCharacters&lt;isASpace&gt;()) {
330         m_currentRegion = VTTRegion::create(*m_scriptExecutionContext);
331         return true;
332     }
333     return false;
334 }
335 
336 bool WebVTTParser::checkAndStoreRegion(const String&amp; line)
337 {
338     if (!line.isEmpty() &amp;&amp; !line.contains(&quot;--&gt;&quot;))
</pre>
<hr />
<pre>
354 }
355 
356 bool WebVTTParser::checkStyleSheet(const String&amp; line)
357 {
358     if (m_previousLine.contains(&quot;--&gt;&quot;))
359         return false;
360     // line starts with the substring &quot;STYLE&quot; and remaining characters
361     // zero or more U+0020 SPACE characters or U+0009 CHARACTER TABULATION
362     // (tab) characters expected other than these charecters it is invalid.
363     if (line.startsWith(&quot;STYLE&quot;) &amp;&amp; line.substring(styleIdentifierLength).isAllSpecialCharacters&lt;isASpace&gt;())
364         return true;
365 
366     return false;
367 }
368 
369 bool WebVTTParser::checkAndStoreStyleSheet(const String&amp; line)
370 {
371     if (!line.isEmpty() &amp;&amp; !line.contains(&quot;--&gt;&quot;))
372         return false;
373 
<span class="line-modified">374     auto styleSheetText = WTFMove(m_currentSourceStyleSheet);</span>
375 
<span class="line-modified">376     // WebVTTMode disallows non-data URLs.</span>
<span class="line-modified">377     auto contents = StyleSheetContents::create(CSSParserContext(WebVTTMode));</span>
<span class="line-added">378     if (!contents-&gt;parseString(styleSheetText))</span>
379         return true;
380 
381     auto&amp; namespaceRules = contents-&gt;namespaceRules();
382     if (namespaceRules.size())
383         return true;
384 
385     auto&amp; importRules = contents-&gt;importRules();
386     if (importRules.size())
387         return true;
388 
389     auto&amp; childRules = contents-&gt;childRules();
390     if (!childRules.size())
391         return true;
392 
<span class="line-modified">393     StringBuilder sanitizedStyleSheetBuilder;</span>
<span class="line-added">394 </span>
<span class="line-added">395     for (const auto&amp; rule : childRules) {</span>
396         if (!rule-&gt;isStyleRule())
397             return true;
<span class="line-modified">398         const auto&amp; styleRule = downcast&lt;StyleRule&gt;(*rule);</span>
399 
<span class="line-modified">400         const auto&amp; selectorList = styleRule.selectorList();</span>
401         if (selectorList.listSize() != 1)
402             return true;
403         auto selector = selectorList.selectorAt(0);
<span class="line-modified">404         auto selectorText = selector-&gt;selectorText();</span>
<span class="line-added">405 </span>
<span class="line-added">406         bool isCue = selectorText == &quot;::cue&quot; || selectorText.startsWith(&quot;::cue(&quot;);</span>
<span class="line-added">407         if (!isCue)</span>
408             return true;
<span class="line-added">409 </span>
<span class="line-added">410         if (styleRule.properties().isEmpty())</span>
<span class="line-added">411             continue;</span>
<span class="line-added">412 </span>
<span class="line-added">413         sanitizedStyleSheetBuilder.append(selectorText, &quot; { &quot;, styleRule.properties().asText(), &quot;  }\n&quot;);</span>
414     }
415 
<span class="line-modified">416     // It would be more stylish to parse the stylesheet only once instead of serializing a sanitized version.</span>
<span class="line-added">417     if (!sanitizedStyleSheetBuilder.isEmpty())</span>
<span class="line-added">418         m_styleSheets.append(sanitizedStyleSheetBuilder.toString());</span>
<span class="line-added">419 </span>
420     return true;
421 }
422 
423 WebVTTParser::ParseState WebVTTParser::collectCueId(const String&amp; line)
424 {
425     if (line.contains(&quot;--&gt;&quot;))
426         return collectTimingsAndSettings(line);
427     m_currentId = line;
428     return TimingsAndSettings;
429 }
430 
431 WebVTTParser::ParseState WebVTTParser::collectTimingsAndSettings(const String&amp; line)
432 {
433     if (line.isEmpty())
434         return BadCue;
435 
436     VTTScanner input(line);
437 
438     // Collect WebVTT cue timings and settings. (5.3 WebVTT cue timings and settings parsing.)
439     // Steps 1 - 3 - Let input be the string being parsed and position be a pointer into input
</pre>
</td>
</tr>
</table>
<center><a href="VideoTrackList.idl.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebVTTParser.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>