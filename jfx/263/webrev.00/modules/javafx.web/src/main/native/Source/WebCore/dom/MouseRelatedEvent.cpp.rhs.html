<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/dom/MouseRelatedEvent.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2001 Peter Kelly (pmk@post.com)
  3  * Copyright (C) 2001 Tobias Anton (anton@stud.fbi.fh-darmstadt.de)
  4  * Copyright (C) 2006 Samuel Weinig (sam.weinig@gmail.com)
  5  * Copyright (C) 2003, 2005, 2006, 2008, 2013 Apple Inc. All rights reserved.
  6  *
  7  * This library is free software; you can redistribute it and/or
  8  * modify it under the terms of the GNU Library General Public
  9  * License as published by the Free Software Foundation; either
 10  * version 2 of the License, or (at your option) any later version.
 11  *
 12  * This library is distributed in the hope that it will be useful,
 13  * but WITHOUT ANY WARRANTY; without even the implied warranty of
 14  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 15  * Library General Public License for more details.
 16  *
 17  * You should have received a copy of the GNU Library General Public License
 18  * along with this library; see the file COPYING.LIB.  If not, write to
 19  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 20  * Boston, MA 02110-1301, USA.
 21  */
 22 
 23 #include &quot;config.h&quot;
 24 #include &quot;MouseRelatedEvent.h&quot;
 25 
 26 #include &quot;DOMWindow.h&quot;
 27 #include &quot;Document.h&quot;
 28 #include &quot;Frame.h&quot;
 29 #include &quot;FrameView.h&quot;
 30 #include &quot;LayoutPoint.h&quot;
 31 #include &quot;RenderLayer.h&quot;
 32 #include &quot;RenderObject.h&quot;
<a name="1" id="anc1"></a><span class="line-added"> 33 #include &lt;wtf/IsoMallocInlines.h&gt;</span>
 34 
 35 namespace WebCore {
 36 
<a name="2" id="anc2"></a><span class="line-added"> 37 WTF_MAKE_ISO_ALLOCATED_IMPL(MouseRelatedEvent);</span>
<span class="line-added"> 38 </span>
 39 MouseRelatedEvent::MouseRelatedEvent(const AtomString&amp; eventType, CanBubble canBubble, IsCancelable isCancelable, IsComposed isComposed,
 40     MonotonicTime timestamp, RefPtr&lt;WindowProxy&gt;&amp;&amp; view, int detail,
 41     const IntPoint&amp; screenLocation, const IntPoint&amp; windowLocation, const IntPoint&amp; movementDelta, OptionSet&lt;Modifier&gt; modifiers, IsSimulated isSimulated, IsTrusted isTrusted)
 42     : UIEventWithKeyState(eventType, canBubble, isCancelable, isComposed, timestamp, WTFMove(view), detail, modifiers, isTrusted)
 43     , m_screenLocation(screenLocation)
 44 #if ENABLE(POINTER_LOCK)
 45     , m_movementDelta(movementDelta)
 46 #endif
 47     , m_isSimulated(isSimulated == IsSimulated::Yes)
 48 {
 49 #if !ENABLE(POINTER_LOCK)
 50     UNUSED_PARAM(movementDelta);
 51 #endif
 52     init(m_isSimulated, windowLocation);
 53 }
 54 
 55 MouseRelatedEvent::MouseRelatedEvent(const AtomString&amp; type, IsCancelable isCancelable, MonotonicTime timestamp, RefPtr&lt;WindowProxy&gt;&amp;&amp; view, const IntPoint&amp; globalLocation, OptionSet&lt;Modifier&gt; modifiers)
 56     : MouseRelatedEvent(type, CanBubble::Yes, isCancelable, IsComposed::Yes, timestamp,
 57         WTFMove(view), 0, globalLocation, globalLocation /* Converted in init */, { }, modifiers, IsSimulated::No)
 58 {
 59 }
 60 
 61 MouseRelatedEvent::MouseRelatedEvent(const AtomString&amp; eventType, const MouseRelatedEventInit&amp; initializer, IsTrusted isTrusted)
 62     : UIEventWithKeyState(eventType, initializer)
 63     , m_screenLocation(IntPoint(initializer.screenX, initializer.screenY))
 64 #if ENABLE(POINTER_LOCK)
 65     , m_movementDelta(IntPoint(0, 0))
 66 #endif
 67 {
 68     ASSERT_UNUSED(isTrusted, isTrusted == IsTrusted::No);
 69     init(false, IntPoint(0, 0));
 70 }
 71 
 72 void MouseRelatedEvent::init(bool isSimulated, const IntPoint&amp; windowLocation)
 73 {
 74     if (!isSimulated) {
 75         if (auto* frameView = frameViewFromWindowProxy(view())) {
 76             FloatPoint absolutePoint = frameView-&gt;windowToContents(windowLocation);
 77             FloatPoint documentPoint = frameView-&gt;absoluteToDocumentPoint(absolutePoint);
 78             m_pageLocation = flooredLayoutPoint(documentPoint);
 79             m_clientLocation = pagePointToClientPoint(m_pageLocation, frameView);
 80         }
 81     }
 82 
 83     initCoordinates();
 84 }
 85 
 86 void MouseRelatedEvent::initCoordinates()
 87 {
 88     // Set up initial values for coordinates.
 89     // Correct values are computed lazily, see computeRelativePosition.
 90     m_layerLocation = m_pageLocation;
 91     m_offsetLocation = m_pageLocation;
 92 
 93     computePageLocation();
 94     m_hasCachedRelativePosition = false;
 95 }
 96 
 97 FrameView* MouseRelatedEvent::frameViewFromWindowProxy(WindowProxy* windowProxy)
 98 {
 99     if (!windowProxy || !is&lt;DOMWindow&gt;(windowProxy-&gt;window()))
100         return nullptr;
101 
102     auto* frame = downcast&lt;DOMWindow&gt;(*windowProxy-&gt;window()).frame();
103     return frame ? frame-&gt;view() : nullptr;
104 }
105 
106 LayoutPoint MouseRelatedEvent::pagePointToClientPoint(LayoutPoint pagePoint, FrameView* frameView)
107 {
108     if (!frameView)
109         return pagePoint;
110 
111     return flooredLayoutPoint(frameView-&gt;documentToClientPoint(pagePoint));
112 }
113 
114 LayoutPoint MouseRelatedEvent::pagePointToAbsolutePoint(LayoutPoint pagePoint, FrameView* frameView)
115 {
116     if (!frameView)
117         return pagePoint;
118 
119     return pagePoint.scaled(frameView-&gt;documentToAbsoluteScaleFactor());
120 }
121 
122 void MouseRelatedEvent::initCoordinates(const LayoutPoint&amp; clientLocation)
123 {
124     // Set up initial values for coordinates.
125     // Correct values are computed lazily, see computeRelativePosition.
126     FloatSize documentToClientOffset;
127     if (auto* frameView = frameViewFromWindowProxy(view()))
128         documentToClientOffset = frameView-&gt;documentToClientOffset();
129 
130     m_clientLocation = clientLocation;
131     m_pageLocation = clientLocation - LayoutSize(documentToClientOffset);
132 
133     m_layerLocation = m_pageLocation;
134     m_offsetLocation = m_pageLocation;
135 
136     computePageLocation();
137     m_hasCachedRelativePosition = false;
138 }
139 
140 float MouseRelatedEvent::documentToAbsoluteScaleFactor() const
141 {
142     if (auto* frameView = frameViewFromWindowProxy(view()))
143         return frameView-&gt;documentToAbsoluteScaleFactor();
144 
145     return 1;
146 }
147 
148 void MouseRelatedEvent::computePageLocation()
149 {
150     m_absoluteLocation = pagePointToAbsolutePoint(m_pageLocation, frameViewFromWindowProxy(view()));
151 }
152 
153 void MouseRelatedEvent::receivedTarget()
154 {
155     m_hasCachedRelativePosition = false;
156 }
157 
158 void MouseRelatedEvent::computeRelativePosition()
159 {
160     if (!is&lt;Node&gt;(target()))
161         return;
162     auto&amp; targetNode = downcast&lt;Node&gt;(*target());
163 
164     // Compute coordinates that are based on the target.
165     m_layerLocation = m_pageLocation;
166     m_offsetLocation = m_pageLocation;
167 
168     // Must have an updated render tree for this math to work correctly.
169     targetNode.document().updateLayoutIgnorePendingStylesheets();
170 
171     // Adjust offsetLocation to be relative to the target&#39;s position.
172     if (RenderObject* r = targetNode.renderer()) {
173         m_offsetLocation = LayoutPoint(r-&gt;absoluteToLocal(absoluteLocation(), UseTransforms));
174         float scaleFactor = 1 / documentToAbsoluteScaleFactor();
175         if (scaleFactor != 1.0f)
176             m_offsetLocation.scale(scaleFactor);
177     }
178 
179     // Adjust layerLocation to be relative to the layer.
180     // FIXME: event.layerX and event.layerY are poorly defined,
181     // and probably don&#39;t always correspond to RenderLayer offsets.
182     // https://bugs.webkit.org/show_bug.cgi?id=21868
183     Node* n = &amp;targetNode;
184     while (n &amp;&amp; !n-&gt;renderer())
185         n = n-&gt;parentNode();
186 
187     RenderLayer* layer;
188     if (n &amp;&amp; (layer = n-&gt;renderer()-&gt;enclosingLayer())) {
189         for (; layer; layer = layer-&gt;parent()) {
190             m_layerLocation -= toLayoutSize(layer-&gt;location());
191         }
192     }
193 
194     m_hasCachedRelativePosition = true;
195 }
196 
197 FloatPoint MouseRelatedEvent::locationInRootViewCoordinates() const
198 {
199     if (auto* frameView = frameViewFromWindowProxy(view()))
200         return frameView-&gt;contentsToRootView(roundedIntPoint(m_absoluteLocation));
201 
202     return m_absoluteLocation;
203 }
204 
205 int MouseRelatedEvent::layerX()
206 {
207     if (!m_hasCachedRelativePosition)
208         computeRelativePosition();
209     return m_layerLocation.x();
210 }
211 
212 int MouseRelatedEvent::layerY()
213 {
214     if (!m_hasCachedRelativePosition)
215         computeRelativePosition();
216     return m_layerLocation.y();
217 }
218 
219 int MouseRelatedEvent::offsetX()
220 {
221     if (isSimulated())
222         return 0;
223     if (!m_hasCachedRelativePosition)
224         computeRelativePosition();
225     return roundToInt(m_offsetLocation.x());
226 }
227 
228 int MouseRelatedEvent::offsetY()
229 {
230     if (isSimulated())
231         return 0;
232     if (!m_hasCachedRelativePosition)
233         computeRelativePosition();
234     return roundToInt(m_offsetLocation.y());
235 }
236 
237 int MouseRelatedEvent::pageX() const
238 {
239     return m_pageLocation.x();
240 }
241 
242 int MouseRelatedEvent::pageY() const
243 {
244     return m_pageLocation.y();
245 }
246 
247 const LayoutPoint&amp; MouseRelatedEvent::pageLocation() const
248 {
249     return m_pageLocation;
250 }
251 
252 int MouseRelatedEvent::x() const
253 {
254     // FIXME: This is not correct.
255     // See Microsoft documentation and &lt;http://www.quirksmode.org/dom/w3c_events.html&gt;.
256     return m_clientLocation.x();
257 }
258 
259 int MouseRelatedEvent::y() const
260 {
261     // FIXME: This is not correct.
262     // See Microsoft documentation and &lt;http://www.quirksmode.org/dom/w3c_events.html&gt;.
263     return m_clientLocation.y();
264 }
265 
266 } // namespace WebCore
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>