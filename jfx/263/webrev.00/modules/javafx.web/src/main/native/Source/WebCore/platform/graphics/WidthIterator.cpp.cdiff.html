<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/WidthIterator.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="VideoTrackPrivate.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WidthIterator.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/WidthIterator.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 96,11 ***</span>
      ASSERT_UNUSED(previousCharacter, shouldApplyFontTransforms(glyphBuffer, lastGlyphCount, previousCharacter) != WidthIterator::TransformsType::None);
  
      if (!glyphBuffer)
          return 0;
  
<span class="line-modified">!     unsigned glyphBufferSize = glyphBuffer-&gt;size();</span>
      if (!force &amp;&amp; glyphBufferSize &lt;= lastGlyphCount + 1) {
          lastGlyphCount = glyphBufferSize;
          return 0;
      }
  
<span class="line-new-header">--- 96,11 ---</span>
      ASSERT_UNUSED(previousCharacter, shouldApplyFontTransforms(glyphBuffer, lastGlyphCount, previousCharacter) != WidthIterator::TransformsType::None);
  
      if (!glyphBuffer)
          return 0;
  
<span class="line-modified">!     auto glyphBufferSize = glyphBuffer-&gt;size();</span>
      if (!force &amp;&amp; glyphBufferSize &lt;= lastGlyphCount + 1) {
          lastGlyphCount = glyphBufferSize;
          return 0;
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 111,20 ***</span>
  
      ASSERT(lastGlyphCount &lt;= glyphBufferSize);
      if (!ltr)
          glyphBuffer-&gt;reverse(lastGlyphCount, glyphBufferSize - lastGlyphCount);
  
<span class="line-modified">!     font-&gt;applyTransforms(glyphBuffer-&gt;glyphs(lastGlyphCount), advances + lastGlyphCount, glyphBufferSize - lastGlyphCount, m_enableKerning, m_requiresShaping);</span>
  
      for (unsigned i = lastGlyphCount; i &lt; glyphBufferSize; ++i)
          advances[i].setHeight(-advances[i].height());
  
      if (!ltr)
          glyphBuffer-&gt;reverse(lastGlyphCount, glyphBufferSize - lastGlyphCount);
  
      for (size_t i = 0; i &lt; charactersTreatedAsSpace.size(); ++i) {
<span class="line-modified">!         int spaceOffset = charactersTreatedAsSpace[i].first;</span>
          const OriginalAdvancesForCharacterTreatedAsSpace&amp; originalAdvances = charactersTreatedAsSpace[i].second;
          if (spaceOffset &amp;&amp; !originalAdvances.characterIsSpace)
              glyphBuffer-&gt;advances(spaceOffset - 1)-&gt;setWidth(originalAdvances.advanceBeforeCharacter);
          glyphBuffer-&gt;advances(spaceOffset)-&gt;setWidth(originalAdvances.advanceAtCharacter);
      }
<span class="line-new-header">--- 111,27 ---</span>
  
      ASSERT(lastGlyphCount &lt;= glyphBufferSize);
      if (!ltr)
          glyphBuffer-&gt;reverse(lastGlyphCount, glyphBufferSize - lastGlyphCount);
  
<span class="line-modified">!     font-&gt;applyTransforms(*glyphBuffer, lastGlyphCount, m_enableKerning, m_requiresShaping, m_font-&gt;fontDescription().locale());</span>
<span class="line-added">+     glyphBufferSize = glyphBuffer-&gt;size();</span>
  
      for (unsigned i = lastGlyphCount; i &lt; glyphBufferSize; ++i)
          advances[i].setHeight(-advances[i].height());
  
      if (!ltr)
          glyphBuffer-&gt;reverse(lastGlyphCount, glyphBufferSize - lastGlyphCount);
  
<span class="line-added">+     // https://bugs.webkit.org/show_bug.cgi?id=206208: This is totally, 100%, furiously, utterly, frustratingly bogus.</span>
<span class="line-added">+     // There is absolutely no guarantee that glyph indices before shaping have any relation at all with glyph indices after shaping.</span>
<span class="line-added">+     // One of the fundamental things that shaping does is insert glyph all over the place.</span>
      for (size_t i = 0; i &lt; charactersTreatedAsSpace.size(); ++i) {
<span class="line-modified">!         auto spaceOffset = charactersTreatedAsSpace[i].first;</span>
<span class="line-added">+         // Shaping may have deleted the glyph.</span>
<span class="line-added">+         if (spaceOffset &gt;= glyphBufferSize)</span>
<span class="line-added">+             continue;</span>
          const OriginalAdvancesForCharacterTreatedAsSpace&amp; originalAdvances = charactersTreatedAsSpace[i].second;
          if (spaceOffset &amp;&amp; !originalAdvances.characterIsSpace)
              glyphBuffer-&gt;advances(spaceOffset - 1)-&gt;setWidth(originalAdvances.advanceBeforeCharacter);
          glyphBuffer-&gt;advances(spaceOffset)-&gt;setWidth(originalAdvances.advanceAtCharacter);
      }
</pre>
<center><a href="VideoTrackPrivate.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WidthIterator.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>