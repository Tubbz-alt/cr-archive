<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/storage/StorageEventDispatcher.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2008 Apple Inc. All Rights Reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;StorageEventDispatcher.h&quot;
 28 
 29 #include &quot;Document.h&quot;
 30 #include &quot;DOMWindow.h&quot;
 31 #include &quot;EventNames.h&quot;
 32 #include &quot;Frame.h&quot;
 33 #include &quot;InspectorInstrumentation.h&quot;
 34 #include &quot;Page.h&quot;
 35 #include &quot;PageGroup.h&quot;
 36 #include &quot;SecurityOrigin.h&quot;
 37 #include &quot;SecurityOriginData.h&quot;
 38 #include &quot;StorageEvent.h&quot;
 39 #include &quot;StorageType.h&quot;
 40 
 41 namespace WebCore {
 42 
 43 void StorageEventDispatcher::dispatchSessionStorageEvents(const String&amp; key, const String&amp; oldValue, const String&amp; newValue, const SecurityOriginData&amp; securityOrigin, Frame* sourceFrame)
 44 {
 45     Page* page = sourceFrame-&gt;page();
 46     if (!page)
 47         return;
 48 
 49     Vector&lt;RefPtr&lt;Frame&gt;&gt; frames;
 50 
 51     // Send events only to our page.
 52     for (Frame* frame = &amp;page-&gt;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {
 53         if (!frame-&gt;document())
 54             continue;
 55         if (sourceFrame != frame &amp;&amp; frame-&gt;document()-&gt;securityOrigin().equal(securityOrigin.securityOrigin().ptr()))
 56             frames.append(frame);
 57     }
 58 
 59     dispatchSessionStorageEventsToFrames(*page, frames, key, oldValue, newValue, sourceFrame-&gt;document()-&gt;url(), securityOrigin);
 60 }
 61 
 62 void StorageEventDispatcher::dispatchLocalStorageEvents(const String&amp; key, const String&amp; oldValue, const String&amp; newValue, const SecurityOriginData&amp; securityOrigin, Frame* sourceFrame)
 63 {
 64     Page* page = sourceFrame-&gt;page();
 65     if (!page)
 66         return;
 67 
 68     Vector&lt;RefPtr&lt;Frame&gt;&gt; frames;
 69 
 70     // Send events to every page.
 71     for (auto&amp; pageInGroup : page-&gt;group().pages()) {
 72         for (Frame* frame = &amp;pageInGroup-&gt;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {
 73             if (!frame-&gt;document())
 74                 continue;
 75             if (sourceFrame != frame &amp;&amp; frame-&gt;document()-&gt;securityOrigin().equal(securityOrigin.securityOrigin().ptr()))
 76                 frames.append(frame);
 77         }
 78     }
 79 
 80     dispatchLocalStorageEventsToFrames(page-&gt;group(), frames, key, oldValue, newValue, sourceFrame-&gt;document()-&gt;url(), securityOrigin);
 81 }
 82 
 83 void StorageEventDispatcher::dispatchSessionStorageEventsToFrames(Page&amp; page, const Vector&lt;RefPtr&lt;Frame&gt;&gt;&amp; frames, const String&amp; key, const String&amp; oldValue, const String&amp; newValue, const String&amp; url, const SecurityOriginData&amp; securityOrigin)
 84 {
 85     InspectorInstrumentation::didDispatchDOMStorageEvent(page, key, oldValue, newValue, StorageType::Session, securityOrigin.securityOrigin().ptr());
 86 
 87     for (auto&amp; frame : frames) {
<a name="1" id="anc1"></a><span class="line-modified"> 88         auto document = makeRefPtr(frame-&gt;document());</span>
<span class="line-modified"> 89         auto result = document-&gt;domWindow()-&gt;sessionStorage();</span>
<span class="line-modified"> 90         if (!result.hasException()) // https://html.spec.whatwg.org/multipage/webstorage.html#the-storage-event:event-storage</span>
<span class="line-modified"> 91             document-&gt;queueTaskToDispatchEventOnWindow(TaskSource::DOMManipulation, StorageEvent::create(eventNames().storageEvent, key, oldValue, newValue, url, result.releaseReturnValue()));</span>

 92     }
 93 }
 94 
 95 void StorageEventDispatcher::dispatchLocalStorageEventsToFrames(PageGroup&amp; pageGroup, const Vector&lt;RefPtr&lt;Frame&gt;&gt;&amp; frames, const String&amp; key, const String&amp; oldValue, const String&amp; newValue, const String&amp; url, const SecurityOriginData&amp; securityOrigin)
 96 {
 97     for (auto&amp; page : pageGroup.pages())
 98         InspectorInstrumentation::didDispatchDOMStorageEvent(*page, key, oldValue, newValue, StorageType::Local, securityOrigin.securityOrigin().ptr());
 99 
100     for (auto&amp; frame : frames) {
<a name="2" id="anc2"></a><span class="line-modified">101         auto document = makeRefPtr(frame-&gt;document());</span>
<span class="line-modified">102         auto result = document-&gt;domWindow()-&gt;localStorage();</span>
<span class="line-modified">103         if (!result.hasException()) // https://html.spec.whatwg.org/multipage/webstorage.html#the-storage-event:event-storage</span>
<span class="line-modified">104             document-&gt;queueTaskToDispatchEventOnWindow(TaskSource::DOMManipulation, StorageEvent::create(eventNames().storageEvent, key, oldValue, newValue, url, result.releaseReturnValue()));</span>

105     }
106 }
107 
108 } // namespace WebCore
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>