<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/WidthIterator.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="VideoTrackPrivate.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WidthIterator.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/WidthIterator.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 81 {
 82     return codepoint &gt;= 0xE001 &amp;&amp; codepoint &lt;= 0xE537;
 83 }
 84 
 85 inline auto WidthIterator::shouldApplyFontTransforms(const GlyphBuffer* glyphBuffer, unsigned lastGlyphCount, UChar32 previousCharacter) const -&gt; TransformsType
 86 {
 87     if (glyphBuffer &amp;&amp; glyphBuffer-&gt;size() == (lastGlyphCount + 1) &amp;&amp; isSoftBankEmoji(previousCharacter))
 88         return TransformsType::Forced;
 89     if (m_run.length() &lt;= 1 || !(m_enableKerning || m_requiresShaping))
 90         return TransformsType::None;
 91     return TransformsType::NotForced;
 92 }
 93 
 94 inline float WidthIterator::applyFontTransforms(GlyphBuffer* glyphBuffer, bool ltr, unsigned&amp; lastGlyphCount, const Font* font, UChar32 previousCharacter, bool force, CharactersTreatedAsSpace&amp; charactersTreatedAsSpace)
 95 {
 96     ASSERT_UNUSED(previousCharacter, shouldApplyFontTransforms(glyphBuffer, lastGlyphCount, previousCharacter) != WidthIterator::TransformsType::None);
 97 
 98     if (!glyphBuffer)
 99         return 0;
100 
<span class="line-modified">101     unsigned glyphBufferSize = glyphBuffer-&gt;size();</span>
102     if (!force &amp;&amp; glyphBufferSize &lt;= lastGlyphCount + 1) {
103         lastGlyphCount = glyphBufferSize;
104         return 0;
105     }
106 
107     GlyphBufferAdvance* advances = glyphBuffer-&gt;advances(0);
108     float widthDifference = 0;
109     for (unsigned i = lastGlyphCount; i &lt; glyphBufferSize; ++i)
110         widthDifference -= advances[i].width();
111 
112     ASSERT(lastGlyphCount &lt;= glyphBufferSize);
113     if (!ltr)
114         glyphBuffer-&gt;reverse(lastGlyphCount, glyphBufferSize - lastGlyphCount);
115 
<span class="line-modified">116     font-&gt;applyTransforms(glyphBuffer-&gt;glyphs(lastGlyphCount), advances + lastGlyphCount, glyphBufferSize - lastGlyphCount, m_enableKerning, m_requiresShaping);</span>

117 
118     for (unsigned i = lastGlyphCount; i &lt; glyphBufferSize; ++i)
119         advances[i].setHeight(-advances[i].height());
120 
121     if (!ltr)
122         glyphBuffer-&gt;reverse(lastGlyphCount, glyphBufferSize - lastGlyphCount);
123 



124     for (size_t i = 0; i &lt; charactersTreatedAsSpace.size(); ++i) {
<span class="line-modified">125         int spaceOffset = charactersTreatedAsSpace[i].first;</span>



126         const OriginalAdvancesForCharacterTreatedAsSpace&amp; originalAdvances = charactersTreatedAsSpace[i].second;
127         if (spaceOffset &amp;&amp; !originalAdvances.characterIsSpace)
128             glyphBuffer-&gt;advances(spaceOffset - 1)-&gt;setWidth(originalAdvances.advanceBeforeCharacter);
129         glyphBuffer-&gt;advances(spaceOffset)-&gt;setWidth(originalAdvances.advanceAtCharacter);
130     }
131     charactersTreatedAsSpace.clear();
132 
133     for (unsigned i = lastGlyphCount; i &lt; glyphBufferSize; ++i)
134         widthDifference += advances[i].width();
135 
136     lastGlyphCount = glyphBufferSize;
137     return widthDifference;
138 }
139 
140 static inline std::pair&lt;bool, bool&gt; expansionLocation(bool ideograph, bool treatAsSpace, bool ltr, bool isAfterExpansion, bool forbidLeadingExpansion, bool forbidTrailingExpansion, bool forceLeadingExpansion, bool forceTrailingExpansion)
141 {
142     bool expandLeft = ideograph;
143     bool expandRight = ideograph;
144     if (treatAsSpace) {
145         if (ltr)
</pre>
</td>
<td>
<hr />
<pre>
 81 {
 82     return codepoint &gt;= 0xE001 &amp;&amp; codepoint &lt;= 0xE537;
 83 }
 84 
 85 inline auto WidthIterator::shouldApplyFontTransforms(const GlyphBuffer* glyphBuffer, unsigned lastGlyphCount, UChar32 previousCharacter) const -&gt; TransformsType
 86 {
 87     if (glyphBuffer &amp;&amp; glyphBuffer-&gt;size() == (lastGlyphCount + 1) &amp;&amp; isSoftBankEmoji(previousCharacter))
 88         return TransformsType::Forced;
 89     if (m_run.length() &lt;= 1 || !(m_enableKerning || m_requiresShaping))
 90         return TransformsType::None;
 91     return TransformsType::NotForced;
 92 }
 93 
 94 inline float WidthIterator::applyFontTransforms(GlyphBuffer* glyphBuffer, bool ltr, unsigned&amp; lastGlyphCount, const Font* font, UChar32 previousCharacter, bool force, CharactersTreatedAsSpace&amp; charactersTreatedAsSpace)
 95 {
 96     ASSERT_UNUSED(previousCharacter, shouldApplyFontTransforms(glyphBuffer, lastGlyphCount, previousCharacter) != WidthIterator::TransformsType::None);
 97 
 98     if (!glyphBuffer)
 99         return 0;
100 
<span class="line-modified">101     auto glyphBufferSize = glyphBuffer-&gt;size();</span>
102     if (!force &amp;&amp; glyphBufferSize &lt;= lastGlyphCount + 1) {
103         lastGlyphCount = glyphBufferSize;
104         return 0;
105     }
106 
107     GlyphBufferAdvance* advances = glyphBuffer-&gt;advances(0);
108     float widthDifference = 0;
109     for (unsigned i = lastGlyphCount; i &lt; glyphBufferSize; ++i)
110         widthDifference -= advances[i].width();
111 
112     ASSERT(lastGlyphCount &lt;= glyphBufferSize);
113     if (!ltr)
114         glyphBuffer-&gt;reverse(lastGlyphCount, glyphBufferSize - lastGlyphCount);
115 
<span class="line-modified">116     font-&gt;applyTransforms(*glyphBuffer, lastGlyphCount, m_enableKerning, m_requiresShaping, m_font-&gt;fontDescription().locale());</span>
<span class="line-added">117     glyphBufferSize = glyphBuffer-&gt;size();</span>
118 
119     for (unsigned i = lastGlyphCount; i &lt; glyphBufferSize; ++i)
120         advances[i].setHeight(-advances[i].height());
121 
122     if (!ltr)
123         glyphBuffer-&gt;reverse(lastGlyphCount, glyphBufferSize - lastGlyphCount);
124 
<span class="line-added">125     // https://bugs.webkit.org/show_bug.cgi?id=206208: This is totally, 100%, furiously, utterly, frustratingly bogus.</span>
<span class="line-added">126     // There is absolutely no guarantee that glyph indices before shaping have any relation at all with glyph indices after shaping.</span>
<span class="line-added">127     // One of the fundamental things that shaping does is insert glyph all over the place.</span>
128     for (size_t i = 0; i &lt; charactersTreatedAsSpace.size(); ++i) {
<span class="line-modified">129         auto spaceOffset = charactersTreatedAsSpace[i].first;</span>
<span class="line-added">130         // Shaping may have deleted the glyph.</span>
<span class="line-added">131         if (spaceOffset &gt;= glyphBufferSize)</span>
<span class="line-added">132             continue;</span>
133         const OriginalAdvancesForCharacterTreatedAsSpace&amp; originalAdvances = charactersTreatedAsSpace[i].second;
134         if (spaceOffset &amp;&amp; !originalAdvances.characterIsSpace)
135             glyphBuffer-&gt;advances(spaceOffset - 1)-&gt;setWidth(originalAdvances.advanceBeforeCharacter);
136         glyphBuffer-&gt;advances(spaceOffset)-&gt;setWidth(originalAdvances.advanceAtCharacter);
137     }
138     charactersTreatedAsSpace.clear();
139 
140     for (unsigned i = lastGlyphCount; i &lt; glyphBufferSize; ++i)
141         widthDifference += advances[i].width();
142 
143     lastGlyphCount = glyphBufferSize;
144     return widthDifference;
145 }
146 
147 static inline std::pair&lt;bool, bool&gt; expansionLocation(bool ideograph, bool treatAsSpace, bool ltr, bool isAfterExpansion, bool forbidLeadingExpansion, bool forbidTrailingExpansion, bool forceLeadingExpansion, bool forceTrailingExpansion)
148 {
149     bool expandLeft = ideograph;
150     bool expandRight = ideograph;
151     if (treatAsSpace) {
152         if (ltr)
</pre>
</td>
</tr>
</table>
<center><a href="VideoTrackPrivate.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WidthIterator.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>