<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/dom/ScriptElement.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ScriptDisallowedScope.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ScriptElement.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/dom/ScriptElement.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 49 #include &quot;ScriptRunner.h&quot;
 50 #include &quot;ScriptSourceCode.h&quot;
 51 #include &quot;ScriptableDocumentParser.h&quot;
 52 #include &quot;Settings.h&quot;
 53 #include &quot;TextNodeTraversal.h&quot;
 54 #include &lt;wtf/StdLibExtras.h&gt;
 55 #include &lt;wtf/text/StringBuilder.h&gt;
 56 #include &lt;wtf/text/StringHash.h&gt;
 57 
 58 namespace WebCore {
 59 
 60 static const auto maxUserGesturePropagationTime = 1_s;
 61 
 62 ScriptElement::ScriptElement(Element&amp; element, bool parserInserted, bool alreadyStarted)
 63     : m_element(element)
 64     , m_startLineNumber(WTF::OrdinalNumber::beforeFirst())
 65     , m_parserInserted(parserInserted)
 66     , m_isExternalScript(false)
 67     , m_alreadyStarted(alreadyStarted)
 68     , m_haveFiredLoad(false)

 69     , m_willBeParserExecuted(false)
 70     , m_readyToBeParserExecuted(false)
 71     , m_willExecuteWhenDocumentFinishedParsing(false)
 72     , m_forceAsync(!parserInserted)
 73     , m_willExecuteInOrder(false)
 74     , m_isModuleScript(false)
 75     , m_creationTime(MonotonicTime::now())
 76     , m_userGestureToken(UserGestureIndicator::currentUserGesture())
 77 {
 78     if (parserInserted &amp;&amp; m_element.document().scriptableDocumentParser() &amp;&amp; !m_element.document().isInDocumentWrite())
 79         m_startLineNumber = m_element.document().scriptableDocumentParser()-&gt;textPosition().m_line;
 80 }
 81 
 82 void ScriptElement::didFinishInsertingNode()
 83 {
 84     ASSERT(!m_parserInserted);
 85     prepareScript(); // FIXME: Provide a real starting line number here.
 86 }
 87 
 88 void ScriptElement::childrenChanged(const ContainerNode::ChildChange&amp; childChange)
</pre>
<hr />
<pre>
272 
273 bool ScriptElement::requestClassicScript(const String&amp; sourceURL)
274 {
275     Ref&lt;Document&gt; originalDocument(m_element.document());
276     if (!m_element.dispatchBeforeLoadEvent(sourceURL))
277         return false;
278     bool didEventListenerDisconnectThisElement = !m_element.isConnected() || &amp;m_element.document() != originalDocument.ptr();
279     if (didEventListenerDisconnectThisElement)
280         return false;
281 
282     ASSERT(!m_loadableScript);
283     if (!stripLeadingAndTrailingHTMLSpaces(sourceURL).isEmpty()) {
284         auto script = LoadableClassicScript::create(
285             m_element.attributeWithoutSynchronization(HTMLNames::nonceAttr),
286             m_element.document().settings().subresourceIntegrityEnabled() ? m_element.attributeWithoutSynchronization(HTMLNames::integrityAttr).string() : emptyString(),
287             referrerPolicy(),
288             m_element.attributeWithoutSynchronization(HTMLNames::crossoriginAttr),
289             scriptCharset(),
290             m_element.localName(),
291             m_element.isInUserAgentShadowTree());
<span class="line-modified">292         if (script-&gt;load(m_element.document(), m_element.document().completeURL(sourceURL))) {</span>



293             m_loadableScript = WTFMove(script);
294             m_isExternalScript = true;
295         }
296     }
297 
298     if (m_loadableScript)
299         return true;
300 
301     callOnMainThread([this, element = Ref&lt;Element&gt;(m_element)] {
302         dispatchErrorEvent();
303     });
304     return false;
305 }
306 
307 bool ScriptElement::requestModuleScript(const TextPosition&amp; scriptStartPosition)
308 {
309     String nonce = m_element.attributeWithoutSynchronization(HTMLNames::nonceAttr);
310     String crossOriginMode = m_element.attributeWithoutSynchronization(HTMLNames::crossoriginAttr);
311     if (crossOriginMode.isNull())
312         crossOriginMode = &quot;omit&quot;_s;
</pre>
<hr />
<pre>
369 
370     if (sourceCode.isEmpty())
371         return;
372 
373     if (!m_isExternalScript) {
374         ASSERT(m_element.document().contentSecurityPolicy());
375         const ContentSecurityPolicy&amp; contentSecurityPolicy = *m_element.document().contentSecurityPolicy();
376         bool hasKnownNonce = contentSecurityPolicy.allowScriptWithNonce(m_element.attributeWithoutSynchronization(HTMLNames::nonceAttr), m_element.isInUserAgentShadowTree());
377         if (!contentSecurityPolicy.allowInlineScript(m_element.document().url(), m_startLineNumber, sourceCode.source().toStringWithoutCopying(), hasKnownNonce))
378             return;
379     }
380 
381     auto&amp; document = m_element.document();
382     auto* frame = document.frame();
383     if (!frame)
384         return;
385 
386     IgnoreDestructiveWriteCountIncrementer ignoreDesctructiveWriteCountIncrementer(m_isExternalScript ? &amp;document : nullptr);
387     CurrentScriptIncrementer currentScriptIncrementer(document, m_element);
388 
<span class="line-modified">389     frame-&gt;script().evaluate(sourceCode);</span>
390 }
391 
392 void ScriptElement::executeModuleScript(LoadableModuleScript&amp; loadableModuleScript)
393 {
394     // https://html.spec.whatwg.org/multipage/scripting.html#execute-the-script-block
395 
396     ASSERT(!loadableModuleScript.error());
397 
398     auto&amp; document = m_element.document();
399     auto* frame = document.frame();
400     if (!frame)
401         return;
402 
403     IgnoreDestructiveWriteCountIncrementer ignoreDesctructiveWriteCountIncrementer(&amp;document);
404     CurrentScriptIncrementer currentScriptIncrementer(document, m_element);
405 
406     frame-&gt;script().linkAndEvaluateModuleScript(loadableModuleScript);
407 }
408 
409 void ScriptElement::dispatchLoadEventRespectingUserGestureIndicator()
</pre>
</td>
<td>
<hr />
<pre>
 49 #include &quot;ScriptRunner.h&quot;
 50 #include &quot;ScriptSourceCode.h&quot;
 51 #include &quot;ScriptableDocumentParser.h&quot;
 52 #include &quot;Settings.h&quot;
 53 #include &quot;TextNodeTraversal.h&quot;
 54 #include &lt;wtf/StdLibExtras.h&gt;
 55 #include &lt;wtf/text/StringBuilder.h&gt;
 56 #include &lt;wtf/text/StringHash.h&gt;
 57 
 58 namespace WebCore {
 59 
 60 static const auto maxUserGesturePropagationTime = 1_s;
 61 
 62 ScriptElement::ScriptElement(Element&amp; element, bool parserInserted, bool alreadyStarted)
 63     : m_element(element)
 64     , m_startLineNumber(WTF::OrdinalNumber::beforeFirst())
 65     , m_parserInserted(parserInserted)
 66     , m_isExternalScript(false)
 67     , m_alreadyStarted(alreadyStarted)
 68     , m_haveFiredLoad(false)
<span class="line-added"> 69     , m_errorOccurred(false)</span>
 70     , m_willBeParserExecuted(false)
 71     , m_readyToBeParserExecuted(false)
 72     , m_willExecuteWhenDocumentFinishedParsing(false)
 73     , m_forceAsync(!parserInserted)
 74     , m_willExecuteInOrder(false)
 75     , m_isModuleScript(false)
 76     , m_creationTime(MonotonicTime::now())
 77     , m_userGestureToken(UserGestureIndicator::currentUserGesture())
 78 {
 79     if (parserInserted &amp;&amp; m_element.document().scriptableDocumentParser() &amp;&amp; !m_element.document().isInDocumentWrite())
 80         m_startLineNumber = m_element.document().scriptableDocumentParser()-&gt;textPosition().m_line;
 81 }
 82 
 83 void ScriptElement::didFinishInsertingNode()
 84 {
 85     ASSERT(!m_parserInserted);
 86     prepareScript(); // FIXME: Provide a real starting line number here.
 87 }
 88 
 89 void ScriptElement::childrenChanged(const ContainerNode::ChildChange&amp; childChange)
</pre>
<hr />
<pre>
273 
274 bool ScriptElement::requestClassicScript(const String&amp; sourceURL)
275 {
276     Ref&lt;Document&gt; originalDocument(m_element.document());
277     if (!m_element.dispatchBeforeLoadEvent(sourceURL))
278         return false;
279     bool didEventListenerDisconnectThisElement = !m_element.isConnected() || &amp;m_element.document() != originalDocument.ptr();
280     if (didEventListenerDisconnectThisElement)
281         return false;
282 
283     ASSERT(!m_loadableScript);
284     if (!stripLeadingAndTrailingHTMLSpaces(sourceURL).isEmpty()) {
285         auto script = LoadableClassicScript::create(
286             m_element.attributeWithoutSynchronization(HTMLNames::nonceAttr),
287             m_element.document().settings().subresourceIntegrityEnabled() ? m_element.attributeWithoutSynchronization(HTMLNames::integrityAttr).string() : emptyString(),
288             referrerPolicy(),
289             m_element.attributeWithoutSynchronization(HTMLNames::crossoriginAttr),
290             scriptCharset(),
291             m_element.localName(),
292             m_element.isInUserAgentShadowTree());
<span class="line-modified">293 </span>
<span class="line-added">294         auto scriptURL = m_element.document().completeURL(sourceURL);</span>
<span class="line-added">295         m_element.document().willLoadScriptElement(scriptURL);</span>
<span class="line-added">296         if (script-&gt;load(m_element.document(), scriptURL)) {</span>
297             m_loadableScript = WTFMove(script);
298             m_isExternalScript = true;
299         }
300     }
301 
302     if (m_loadableScript)
303         return true;
304 
305     callOnMainThread([this, element = Ref&lt;Element&gt;(m_element)] {
306         dispatchErrorEvent();
307     });
308     return false;
309 }
310 
311 bool ScriptElement::requestModuleScript(const TextPosition&amp; scriptStartPosition)
312 {
313     String nonce = m_element.attributeWithoutSynchronization(HTMLNames::nonceAttr);
314     String crossOriginMode = m_element.attributeWithoutSynchronization(HTMLNames::crossoriginAttr);
315     if (crossOriginMode.isNull())
316         crossOriginMode = &quot;omit&quot;_s;
</pre>
<hr />
<pre>
373 
374     if (sourceCode.isEmpty())
375         return;
376 
377     if (!m_isExternalScript) {
378         ASSERT(m_element.document().contentSecurityPolicy());
379         const ContentSecurityPolicy&amp; contentSecurityPolicy = *m_element.document().contentSecurityPolicy();
380         bool hasKnownNonce = contentSecurityPolicy.allowScriptWithNonce(m_element.attributeWithoutSynchronization(HTMLNames::nonceAttr), m_element.isInUserAgentShadowTree());
381         if (!contentSecurityPolicy.allowInlineScript(m_element.document().url(), m_startLineNumber, sourceCode.source().toStringWithoutCopying(), hasKnownNonce))
382             return;
383     }
384 
385     auto&amp; document = m_element.document();
386     auto* frame = document.frame();
387     if (!frame)
388         return;
389 
390     IgnoreDestructiveWriteCountIncrementer ignoreDesctructiveWriteCountIncrementer(m_isExternalScript ? &amp;document : nullptr);
391     CurrentScriptIncrementer currentScriptIncrementer(document, m_element);
392 
<span class="line-modified">393     frame-&gt;script().evaluateIgnoringException(sourceCode);</span>
394 }
395 
396 void ScriptElement::executeModuleScript(LoadableModuleScript&amp; loadableModuleScript)
397 {
398     // https://html.spec.whatwg.org/multipage/scripting.html#execute-the-script-block
399 
400     ASSERT(!loadableModuleScript.error());
401 
402     auto&amp; document = m_element.document();
403     auto* frame = document.frame();
404     if (!frame)
405         return;
406 
407     IgnoreDestructiveWriteCountIncrementer ignoreDesctructiveWriteCountIncrementer(&amp;document);
408     CurrentScriptIncrementer currentScriptIncrementer(document, m_element);
409 
410     frame-&gt;script().linkAndEvaluateModuleScript(loadableModuleScript);
411 }
412 
413 void ScriptElement::dispatchLoadEventRespectingUserGestureIndicator()
</pre>
</td>
</tr>
</table>
<center><a href="ScriptDisallowedScope.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ScriptElement.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>