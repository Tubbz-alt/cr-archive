<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/inspector/scripts/codegen/generate_objc_backend_dispatcher_implementation.py</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 #!/usr/bin/env python
  2 #
  3 # Copyright (c) 2014-2018 Apple Inc. All rights reserved.
  4 # Copyright (c) 2014 University of Washington. All rights reserved.
  5 #
  6 # Redistribution and use in source and binary forms, with or without
  7 # modification, are permitted provided that the following conditions
  8 # are met:
  9 # 1. Redistributions of source code must retain the above copyright
 10 #    notice, this list of conditions and the following disclaimer.
 11 # 2. Redistributions in binary form must reproduce the above copyright
 12 #    notice, this list of conditions and the following disclaimer in the
 13 #    documentation and/or other materials provided with the distribution.
 14 #
 15 # THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 16 # AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 17 # THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 18 # PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 19 # BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 20 # CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 21 # SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 22 # INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 23 # CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 24 # ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 25 # THE POSSIBILITY OF SUCH DAMAGE.
 26 
 27 
 28 import logging
 29 import string
 30 import re
 31 from string import Template
 32 
 33 try:
 34     from .cpp_generator import CppGenerator
 35     from .generator import Generator
 36     from .models import PrimitiveType, EnumType, AliasedType, Frameworks
 37     from .objc_generator import ObjCTypeCategory, ObjCGenerator, join_type_and_name
 38     from .objc_generator_templates import ObjCGeneratorTemplates as ObjCTemplates
 39 except ValueError:
 40     from cpp_generator import CppGenerator
 41     from generator import Generator
 42     from models import PrimitiveType, EnumType, AliasedType, Frameworks
 43     from objc_generator import ObjCTypeCategory, ObjCGenerator, join_type_and_name
 44     from objc_generator_templates import ObjCGeneratorTemplates as ObjCTemplates
 45 
 46 log = logging.getLogger(&#39;global&#39;)
 47 
 48 
 49 class ObjCBackendDispatcherImplementationGenerator(ObjCGenerator):
 50     def __init__(self, *args, **kwargs):
 51         ObjCGenerator.__init__(self, *args, **kwargs)
 52 
 53     def output_filename(self):
 54         return &#39;%sBackendDispatchers.mm&#39; % self.protocol_name()
 55 
 56     def domains_to_generate(self):
 57         return list(filter(self.should_generate_commands_for_domain, Generator.domains_to_generate(self)))
 58 
 59     def generate_output(self):
 60         secondary_headers = [
 61             &#39;&quot;%sInternal.h&quot;&#39; % self.protocol_name(),
 62             &#39;&quot;%sTypeConversions.h&quot;&#39; % self.protocol_name(),
 63             &#39;&lt;wtf/JSONValues.h&gt;&#39;,
 64         ]
 65 
 66         header_args = {
 67             &#39;primaryInclude&#39;: &#39;&quot;%sBackendDispatchers.h&quot;&#39; % self.protocol_name(),
 68             &#39;secondaryIncludes&#39;: &#39;\n&#39;.join([&#39;#include %s&#39; % header for header in secondary_headers]),
 69         }
 70 
 71         domains = self.domains_to_generate()
 72         sections = []
 73         sections.append(self.generate_license())
 74         sections.append(Template(ObjCTemplates.BackendDispatcherImplementationPrelude).substitute(None, **header_args))
 75         sections.extend(list(map(self._generate_handler_implementation_for_domain, domains)))
 76         sections.append(Template(ObjCTemplates.BackendDispatcherImplementationPostlude).substitute(None, **header_args))
 77         return &#39;\n\n&#39;.join(sections)
 78 
 79     def _generate_handler_implementation_for_domain(self, domain):
 80         commands = self.commands_for_domain(domain)
 81 
 82         if not commands:
 83             return &#39;&#39;
 84 
 85         command_declarations = []
 86         for command in commands:
 87             command_declarations.append(self._generate_handler_implementation_for_command(domain, command))
 88 
 89         return &#39;\n&#39;.join(command_declarations)
 90 
 91     def _generate_handler_implementation_for_command(self, domain, command):
 92         lines = []
 93         parameters = [&#39;long requestId&#39;]
 94         for parameter in command.call_parameters:
 95             parameters.append(&#39;%s in_%s&#39; % (CppGenerator.cpp_type_for_unchecked_formal_in_parameter(parameter), parameter.parameter_name))
 96 
 97         command_args = {
 98             &#39;domainName&#39;: domain.domain_name,
 99             &#39;commandName&#39;: command.command_name,
100             &#39;parameters&#39;: &#39;, &#39;.join(parameters),
<a name="1" id="anc1"></a>
101             &#39;successCallback&#39;: self._generate_success_block_for_command(domain, command),
102             &#39;conversions&#39;: self._generate_conversions_for_command(domain, command),
103             &#39;invocation&#39;: self._generate_invocation_for_command(domain, command),
104         }
105 
106         return self.wrap_with_guard_for_domain(domain, Template(ObjCTemplates.BackendDispatcherHeaderDomainHandlerImplementation).substitute(None, **command_args))
107 
<a name="2" id="anc2"></a>


108     def _generate_success_block_for_command(self, domain, command):
109         lines = []
110 
111         if command.return_parameters:
112             success_block_parameters = []
113             for parameter in command.return_parameters:
114                 objc_type = self.objc_type_for_param(domain, command.command_name, parameter)
115                 var_name = ObjCGenerator.identifier_to_objc_identifier(parameter.parameter_name)
116                 success_block_parameters.append(join_type_and_name(objc_type, var_name))
117             lines.append(&#39;    id successCallback = ^(%s) {&#39; % &#39;, &#39;.join(success_block_parameters))
118         else:
119             lines.append(&#39;    id successCallback = ^{&#39;)
120 
121         if command.return_parameters:
122             lines.append(&#39;        Ref&lt;JSON::Object&gt; resultObject = JSON::Object::create();&#39;)
123 
124             required_pointer_parameters = [parameter for parameter in command.return_parameters if not parameter.is_optional and ObjCGenerator.is_type_objc_pointer_type(parameter.type)]
125             for parameter in required_pointer_parameters:
126                 var_name = ObjCGenerator.identifier_to_objc_identifier(parameter.parameter_name)
127                 lines.append(&#39;        THROW_EXCEPTION_FOR_REQUIRED_PARAMETER(%s, @&quot;%s&quot;);&#39; % (var_name, var_name))
128                 objc_array_class = self.objc_class_for_array_type(parameter.type)
129                 if objc_array_class and objc_array_class.startswith(self.objc_prefix()):
130                     lines.append(&#39;        THROW_EXCEPTION_FOR_BAD_TYPE_IN_ARRAY(%s, [%s class]);&#39; % (var_name, objc_array_class))
131 
132             optional_pointer_parameters = [parameter for parameter in command.return_parameters if parameter.is_optional and ObjCGenerator.is_type_objc_pointer_type(parameter.type)]
133             for parameter in optional_pointer_parameters:
134                 var_name = ObjCGenerator.identifier_to_objc_identifier(parameter.parameter_name)
135                 lines.append(&#39;        THROW_EXCEPTION_FOR_BAD_OPTIONAL_PARAMETER(%s, @&quot;%s&quot;);&#39; % (var_name, var_name))
136                 objc_array_class = self.objc_class_for_array_type(parameter.type)
137                 if objc_array_class and objc_array_class.startswith(self.objc_prefix()):
138                     lines.append(&#39;        THROW_EXCEPTION_FOR_BAD_TYPE_IN_OPTIONAL_ARRAY(%s, [%s class]);&#39; % (var_name, objc_array_class))
139 
140             for parameter in command.return_parameters:
141                 keyed_set_method = CppGenerator.cpp_setter_method_for_type(parameter.type)
142                 var_name = ObjCGenerator.identifier_to_objc_identifier(parameter.parameter_name)
143                 var_expression = &#39;*%s&#39; % var_name if parameter.is_optional else var_name
144                 export_expression = self.objc_protocol_export_expression_for_variable(parameter.type, var_expression)
145                 if not parameter.is_optional:
146                     lines.append(&#39;        resultObject-&gt;%s(&quot;%s&quot;_s, %s);&#39; % (keyed_set_method, parameter.parameter_name, export_expression))
147                 else:
148                     lines.append(&#39;        if (%s)&#39; % var_name)
149                     lines.append(&#39;            resultObject-&gt;%s(&quot;%s&quot;_s, %s);&#39; % (keyed_set_method, parameter.parameter_name, export_expression))
150             lines.append(&#39;        backendDispatcher()-&gt;sendResponse(requestId, WTFMove(resultObject), false);&#39;)
151         else:
152             lines.append(&#39;        backendDispatcher()-&gt;sendResponse(requestId, JSON::Object::create(), false);&#39;)
153 
154         lines.append(&#39;    };&#39;)
155         return &#39;\n&#39;.join(lines)
156 
157     def _generate_conversions_for_command(self, domain, command):
158         lines = []
159         if command.call_parameters:
160             lines.append(&#39;&#39;)
161 
162         def in_param_expression(param_name, parameter):
163             _type = parameter.type
164             if isinstance(_type, AliasedType):
165                 _type = _type.aliased_type  # Fall through to enum or primitive.
166             if isinstance(_type, EnumType):
167                 _type = _type.primitive_type  # Fall through to primitive.
168             if isinstance(_type, PrimitiveType):
169                 if _type.raw_name() in [&#39;array&#39;, &#39;any&#39;, &#39;object&#39;]:
170                     return &#39;&amp;%s&#39; % param_name if not parameter.is_optional else param_name
171                 return &#39;*%s&#39; % param_name if parameter.is_optional else param_name
172             return &#39;&amp;%s&#39; % param_name if not parameter.is_optional else param_name
173 
174         for parameter in command.call_parameters:
175             in_param_name = &#39;in_%s&#39; % parameter.parameter_name
176             objc_in_param_name = &#39;o_%s&#39; % in_param_name
177             objc_type = self.objc_type_for_param(domain, command.command_name, parameter, False)
178             if isinstance(parameter.type, EnumType):
179                 objc_type = &#39;Optional&lt;%s&gt;&#39; % objc_type
180             param_expression = in_param_expression(in_param_name, parameter)
181             import_expression = self.objc_protocol_import_expression_for_parameter(param_expression, domain, command.command_name, parameter)
182             if not parameter.is_optional:
183                 lines.append(&#39;    %s = %s;&#39; % (join_type_and_name(objc_type, objc_in_param_name), import_expression))
184 
185                 if isinstance(parameter.type, EnumType):
186                     lines.append(&#39;    if (!%s) {&#39; % objc_in_param_name)
187                     lines.append(&#39;        backendDispatcher()-&gt;reportProtocolError(BackendDispatcher::InvalidParams, &quot;Parameter \&#39;%s\&#39; of method \&#39;%s.%s\&#39; cannot be processed&quot;_s);&#39; % (parameter.parameter_name, domain.domain_name, command.command_name))
188                     lines.append(&#39;        return;&#39;)
189                     lines.append(&#39;    }&#39;)
190 
191             else:
192                 lines.append(&#39;    %s;&#39; % join_type_and_name(objc_type, objc_in_param_name))
193                 lines.append(&#39;    if (%s)&#39; % in_param_name)
194                 lines.append(&#39;        %s = %s;&#39; % (objc_in_param_name, import_expression))
195 
196         if lines:
197             lines.append(&#39;&#39;)
198         return &#39;\n&#39;.join(lines)
199 
200     def _generate_invocation_for_command(self, domain, command):
201         pairs = []
202         pairs.append(&#39;WithErrorCallback:errorCallback&#39;)
203         pairs.append(&#39;successCallback:successCallback&#39;)
204         for parameter in command.call_parameters:
205             in_param_name = &#39;in_%s&#39; % parameter.parameter_name
206             objc_in_param_expression = &#39;o_%s&#39; % in_param_name
207             if not parameter.is_optional:
<a name="3" id="anc3"></a><span class="line-removed">208                 # FIXME: we don&#39;t handle optional enum values in commands here because it isn&#39;t used anywhere yet.</span>
<span class="line-removed">209                 # We&#39;d need to change the delegate&#39;s signature to take Optional for optional enum values.</span>
210                 if isinstance(parameter.type, EnumType):
211                     objc_in_param_expression = &#39;%s.value()&#39; % objc_in_param_expression
212 
213                 pairs.append(&#39;%s:%s&#39; % (parameter.parameter_name, objc_in_param_expression))
214             else:
<a name="4" id="anc4"></a>


215                 optional_expression = &#39;(%s ? &amp;%s : nil)&#39; % (in_param_name, objc_in_param_expression)
216                 pairs.append(&#39;%s:%s&#39; % (parameter.parameter_name, optional_expression))
217         return &#39;    [m_delegate %s%s];&#39; % (command.command_name, &#39; &#39;.join(pairs))
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>