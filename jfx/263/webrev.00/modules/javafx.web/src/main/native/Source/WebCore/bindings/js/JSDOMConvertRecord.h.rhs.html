<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSDOMConvertRecord.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2016-2019 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
 28 #include &quot;IDLTypes.h&quot;
 29 #include &quot;JSDOMConvertStrings.h&quot;
<a name="1" id="anc1"></a><span class="line-added"> 30 #include &quot;JSDOMGlobalObject.h&quot;</span>
 31 #include &lt;JavaScriptCore/ObjectConstructor.h&gt;
 32 
 33 namespace WebCore {
 34 
 35 namespace Detail {
 36 
 37 template&lt;typename IDLStringType&gt;
 38 struct IdentifierConverter;
 39 
 40 template&lt;&gt; struct IdentifierConverter&lt;IDLDOMString&gt; {
<a name="2" id="anc2"></a><span class="line-modified"> 41     static String convert(JSC::JSGlobalObject&amp;, const JSC::Identifier&amp; identifier)</span>
 42     {
 43         return identifier.string();
 44     }
 45 };
 46 
 47 template&lt;&gt; struct IdentifierConverter&lt;IDLByteString&gt; {
<a name="3" id="anc3"></a><span class="line-modified"> 48     static String convert(JSC::JSGlobalObject&amp; lexicalGlobalObject, const JSC::Identifier&amp; identifier)</span>
 49     {
<a name="4" id="anc4"></a><span class="line-modified"> 50         return identifierToByteString(lexicalGlobalObject, identifier);</span>
 51     }
 52 };
 53 
 54 template&lt;&gt; struct IdentifierConverter&lt;IDLUSVString&gt; {
<a name="5" id="anc5"></a><span class="line-modified"> 55     static String convert(JSC::JSGlobalObject&amp; lexicalGlobalObject, const JSC::Identifier&amp; identifier)</span>
 56     {
<a name="6" id="anc6"></a><span class="line-modified"> 57         return identifierToUSVString(lexicalGlobalObject, identifier);</span>
 58     }
 59 };
 60 
 61 }
 62 
 63 template&lt;typename K, typename V&gt; struct Converter&lt;IDLRecord&lt;K, V&gt;&gt; : DefaultConverter&lt;IDLRecord&lt;K, V&gt;&gt; {
 64     using ReturnType = typename IDLRecord&lt;K, V&gt;::ImplementationType;
 65     using KeyType = typename K::ImplementationType;
 66     using ValueType = typename V::ImplementationType;
 67 
<a name="7" id="anc7"></a><span class="line-modified"> 68     static ReturnType convert(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::JSValue value, JSDOMGlobalObject&amp; globalObject)</span>
 69     {
<a name="8" id="anc8"></a><span class="line-modified"> 70         return convertRecord&lt;JSDOMGlobalObject&amp;&gt;(lexicalGlobalObject, value, globalObject);</span>
<span class="line-added"> 71     }</span>
<span class="line-added"> 72 </span>
<span class="line-added"> 73     static ReturnType convert(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::JSValue value)</span>
<span class="line-added"> 74     {</span>
<span class="line-added"> 75         return convertRecord(lexicalGlobalObject, value);</span>
<span class="line-added"> 76     }</span>
<span class="line-added"> 77 </span>
<span class="line-added"> 78 private:</span>
<span class="line-added"> 79     template&lt;class...Args&gt;</span>
<span class="line-added"> 80     static ReturnType convertRecord(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::JSValue value, Args ... args)</span>
<span class="line-added"> 81     {</span>
<span class="line-added"> 82         auto&amp; vm = JSC::getVM(&amp;lexicalGlobalObject);</span>
 83         auto scope = DECLARE_THROW_SCOPE(vm);
 84 
 85         // 1. Let result be a new empty instance of record&lt;K, V&gt;.
 86         // 2. If Type(O) is Undefined or Null, return result.
 87         if (value.isUndefinedOrNull())
 88             return { };
 89 
 90         // 3. If Type(O) is not Object, throw a TypeError.
 91         if (!value.isObject()) {
<a name="9" id="anc9"></a><span class="line-modified"> 92             throwTypeError(&amp;lexicalGlobalObject, scope);</span>
 93             return { };
 94         }
 95 
 96         JSC::JSObject* object = JSC::asObject(value);
 97 
 98         ReturnType result;
 99 
100         // 4. Let keys be ? O.[[OwnPropertyKeys]]().
101         JSC::PropertyNameArray keys(vm, JSC::PropertyNameMode::Strings, JSC::PrivateSymbolMode::Exclude);
<a name="10" id="anc10"></a><span class="line-modified">102         object-&gt;methodTable(vm)-&gt;getOwnPropertyNames(object, &amp;lexicalGlobalObject, keys, JSC::EnumerationMode(JSC::DontEnumPropertiesMode::Include));</span>
103 
104         RETURN_IF_EXCEPTION(scope, { });
105 
106         // 5. Repeat, for each element key of keys in List order:
107         for (auto&amp; key : keys) {
108             // 1. Let desc be ? O.[[GetOwnProperty]](key).
109             JSC::PropertyDescriptor descriptor;
<a name="11" id="anc11"></a><span class="line-modified">110             bool didGetDescriptor = object-&gt;getOwnPropertyDescriptor(&amp;lexicalGlobalObject, key, descriptor);</span>
111             RETURN_IF_EXCEPTION(scope, { });
112 
113             // 2. If desc is not undefined and desc.[[Enumerable]] is true:
114 
115             // It&#39;s necessary to filter enumerable here rather than using the default EnumerationMode,
116             // to prevent an observable extra [[GetOwnProperty]] operation in the case of ProxyObject records.
117             if (didGetDescriptor &amp;&amp; descriptor.enumerable()) {
118                 // 1. Let typedKey be key converted to an IDL value of type K.
<a name="12" id="anc12"></a><span class="line-modified">119                 auto typedKey = Detail::IdentifierConverter&lt;K&gt;::convert(lexicalGlobalObject, key);</span>
120                 RETURN_IF_EXCEPTION(scope, { });
121 
122                 // 2. Let value be ? Get(O, key).
<a name="13" id="anc13"></a><span class="line-modified">123                 auto subValue = object-&gt;get(&amp;lexicalGlobalObject, key);</span>
124                 RETURN_IF_EXCEPTION(scope, { });
125 
126                 // 3. Let typedValue be value converted to an IDL value of type V.
<a name="14" id="anc14"></a><span class="line-modified">127                 auto typedValue = Converter&lt;V&gt;::convert(lexicalGlobalObject, subValue, args...);</span>
128                 RETURN_IF_EXCEPTION(scope, { });
129 
130                 // 4. If typedKey is already a key in result, set its value to typedValue.
131                 // Note: This can happen when O is a proxy object.
132                 // FIXME: Handle this case.
133 
134                 // 5. Otherwise, append to result a mapping (typedKey, typedValue).
135                 result.append({ typedKey, typedValue });
136             }
137         }
138 
139         // 6. Return result.
140         return result;
141     }
142 };
143 
144 template&lt;typename K, typename V&gt; struct JSConverter&lt;IDLRecord&lt;K, V&gt;&gt; {
145     static constexpr bool needsState = true;
146     static constexpr bool needsGlobalObject = true;
147 
148     template&lt;typename MapType&gt;
<a name="15" id="anc15"></a><span class="line-modified">149     static JSC::JSValue convert(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSDOMGlobalObject&amp; globalObject, const MapType&amp; map)</span>
150     {
<a name="16" id="anc16"></a><span class="line-modified">151         auto&amp; vm = JSC::getVM(&amp;lexicalGlobalObject);</span>
152 
153         // 1. Let result be ! ObjectCreate(%ObjectPrototype%).
<a name="17" id="anc17"></a><span class="line-modified">154         auto result = constructEmptyObject(&amp;lexicalGlobalObject, globalObject.objectPrototype());</span>
155 
156         // 2. Repeat, for each mapping (key, value) in D:
157         for (const auto&amp; keyValuePair : map) {
158             // 1. Let esKey be key converted to an ECMAScript value.
159             // Note, this step is not required, as we need the key to be
160             // an Identifier, not a JSValue.
161 
162             // 2. Let esValue be value converted to an ECMAScript value.
<a name="18" id="anc18"></a><span class="line-modified">163             auto esValue = toJS&lt;V&gt;(lexicalGlobalObject, globalObject, keyValuePair.value);</span>
164 
165             // 3. Let created be ! CreateDataProperty(result, esKey, esValue).
166             bool created = result-&gt;putDirect(vm, JSC::Identifier::fromString(vm, keyValuePair.key), esValue);
167 
168             // 4. Assert: created is true.
169             ASSERT_UNUSED(created, created);
170         }
171 
172         // 3. Return result.
173         return result;
174     }
175 };
176 
177 } // namespace WebCore
<a name="19" id="anc19"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="19" type="hidden" />
</body>
</html>