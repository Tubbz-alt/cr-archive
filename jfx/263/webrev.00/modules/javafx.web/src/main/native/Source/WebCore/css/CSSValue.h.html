<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/css/CSSValue.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * (C) 1999-2003 Lars Knoll (knoll@kde.org)
  3  * Copyright (C) 2004, 2005, 2006, 2007, 2008 Apple Inc. All rights reserved.
  4  *
  5  * This library is free software; you can redistribute it and/or
  6  * modify it under the terms of the GNU Library General Public
  7  * License as published by the Free Software Foundation; either
  8  * version 2 of the License, or (at your option) any later version.
  9  *
 10  * This library is distributed in the hope that it will be useful,
 11  * but WITHOUT ANY WARRANTY; without even the implied warranty of
 12  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 13  * Library General Public License for more details.
 14  *
 15  * You should have received a copy of the GNU Library General Public License
 16  * along with this library; see the file COPYING.LIB.  If not, write to
 17  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 18  * Boston, MA 02110-1301, USA.
 19  */
 20 
 21 #pragma once
 22 
 23 #include &quot;CSSPropertyNames.h&quot;
 24 #include &lt;wtf/Function.h&gt;
 25 #include &lt;wtf/HashMap.h&gt;
 26 #include &lt;wtf/RefCounted.h&gt;
 27 #include &lt;wtf/RefPtr.h&gt;
 28 #include &lt;wtf/TypeCasts.h&gt;
 29 #include &lt;wtf/URLHash.h&gt;
 30 
 31 namespace WebCore {
 32 
 33 class CSSCustomPropertyValue;
 34 class CSSStyleDeclaration;
 35 class CachedResource;
 36 class DeprecatedCSSOMValue;
 37 class StyleSheetContents;
 38 
 39 enum CSSPropertyID : uint16_t;
 40 
 41 DECLARE_ALLOCATOR_WITH_HEAP_IDENTIFIER(CSSValue);
 42 class CSSValue {
 43     WTF_MAKE_NONCOPYABLE(CSSValue);
 44     WTF_MAKE_FAST_ALLOCATED_WITH_HEAP_IDENTIFIER(CSSValue);
 45 public:
 46     enum Type {
 47         CSS_INHERIT = 0,
 48         CSS_PRIMITIVE_VALUE = 1,
 49         CSS_VALUE_LIST = 2,
 50         CSS_CUSTOM = 3,
 51         CSS_INITIAL = 4,
 52         CSS_UNSET = 5,
 53         CSS_REVERT = 6
 54     };
 55 
 56     static constexpr unsigned refCountFlagIsStatic = 0x1;
 57     static constexpr unsigned refCountIncrement = 0x2; // This allows us to ref / deref without disturbing the static CSSValue flag.
 58     void ref() const
 59     {
 60         m_refCount += refCountIncrement;
 61     }
 62     bool hasOneRef() const { return m_refCount == refCountIncrement; }
 63     unsigned refCount() const { return m_refCount / refCountIncrement; }
 64     bool hasAtLeastOneRef() const { return m_refCount; }
 65 
 66     void deref()
 67     {
 68         // Customized deref() to ensure operator delete is called on
 69         // the appropriate subclass type.
 70         unsigned tempRefCount = m_refCount - refCountIncrement;
 71         if (!tempRefCount) {
 72             destroy();
 73             return;
 74         }
 75         m_refCount = tempRefCount;
 76     }
 77 
 78     Type cssValueType() const;
 79     String cssText() const;
 80 
 81     bool isPrimitiveValue() const { return m_classType == PrimitiveClass; }
 82     bool isValueList() const { return m_classType &gt;= ValueListClass; }
 83 
 84     bool isBaseValueList() const { return m_classType == ValueListClass; }
 85 
 86 
 87     bool isAspectRatioValue() const { return m_classType == AspectRatioClass; }
 88     bool isBorderImageSliceValue() const { return m_classType == BorderImageSliceClass; }
 89     bool isCanvasValue() const { return m_classType == CanvasClass; }
 90     bool isCrossfadeValue() const { return m_classType == CrossfadeClass; }
 91     bool isCursorImageValue() const { return m_classType == CursorImageClass; }
 92     bool isCustomPropertyValue() const { return m_classType == CustomPropertyClass; }
 93     bool isFunctionValue() const { return m_classType == FunctionClass; }
 94     bool isFontFeatureValue() const { return m_classType == FontFeatureClass; }
 95 #if ENABLE(VARIATION_FONTS)
 96     bool isFontVariationValue() const { return m_classType == FontVariationClass; }
 97 #endif
 98     bool isFontFaceSrcValue() const { return m_classType == FontFaceSrcClass; }
 99     bool isFontValue() const { return m_classType == FontClass; }
100     bool isFontStyleValue() const { return m_classType == FontStyleClass; }
101     bool isFontStyleRangeValue() const { return m_classType == FontStyleRangeClass; }
102     bool isImageGeneratorValue() const { return m_classType &gt;= CanvasClass &amp;&amp; m_classType &lt;= ConicGradientClass; }
103     bool isGradientValue() const { return m_classType &gt;= LinearGradientClass &amp;&amp; m_classType &lt;= ConicGradientClass; }
104     bool isNamedImageValue() const { return m_classType == NamedImageClass; }
105     bool isImageSetValue() const { return m_classType == ImageSetClass; }
106     bool isImageValue() const { return m_classType == ImageClass; }
107     bool isImplicitInitialValue() const;
108     bool isInheritedValue() const { return m_classType == InheritedClass; }
109     bool isInitialValue() const { return m_classType == InitialClass; }
110     bool isUnsetValue() const { return m_classType == UnsetClass; }
111     bool isRevertValue() const { return m_classType == RevertClass; }
112     bool isGlobalKeyword() const { return isInheritedValue() || isInitialValue() || isUnsetValue() || isRevertValue(); }
113     bool treatAsInitialValue(CSSPropertyID) const;
114     bool treatAsInheritedValue(CSSPropertyID) const;
115     bool isLinearGradientValue() const { return m_classType == LinearGradientClass; }
116     bool isRadialGradientValue() const { return m_classType == RadialGradientClass; }
117     bool isConicGradientValue() const { return m_classType == ConicGradientClass; }
118     bool isReflectValue() const { return m_classType == ReflectClass; }
119     bool isShadowValue() const { return m_classType == ShadowClass; }
120     bool isCubicBezierTimingFunctionValue() const { return m_classType == CubicBezierTimingFunctionClass; }
121     bool isStepsTimingFunctionValue() const { return m_classType == StepsTimingFunctionClass; }
122     bool isSpringTimingFunctionValue() const { return m_classType == SpringTimingFunctionClass; }
123     bool isLineBoxContainValue() const { return m_classType == LineBoxContainClass; }
124     bool isCalcValue() const {return m_classType == CalculationClass; }
125     bool isFilterImageValue() const { return m_classType == FilterImageClass; }
126 #if ENABLE(CSS_PAINTING_API)
127     bool isPaintImageValue() const { return m_classType == PaintImageClass; }
128 #endif
129     bool isContentDistributionValue() const { return m_classType == CSSContentDistributionClass; }
130     bool isGridAutoRepeatValue() const { return m_classType == GridAutoRepeatClass; }
131     bool isGridIntegerRepeatValue() const { return m_classType == GridIntegerRepeatClass; }
132     bool isGridTemplateAreasValue() const { return m_classType == GridTemplateAreasClass; }
133     bool isGridLineNamesValue() const { return m_classType == GridLineNamesClass; }
134     bool isUnicodeRangeValue() const { return m_classType == UnicodeRangeClass; }
135 
136     bool isCustomIdentValue() const { return m_classType == CustomIdentClass; }
137     bool isVariableReferenceValue() const { return m_classType == VariableReferenceClass; }
138     bool isPendingSubstitutionValue() const { return m_classType == PendingSubstitutionValueClass; }
139 
140     bool hasVariableReferences() const { return isVariableReferenceValue() || isPendingSubstitutionValue(); }
141 
142     Ref&lt;DeprecatedCSSOMValue&gt; createDeprecatedCSSOMWrapper(CSSStyleDeclaration&amp;) const;
143 
144     bool traverseSubresources(const WTF::Function&lt;bool (const CachedResource&amp;)&gt;&amp; handler) const;
145 
146     // What properties does this value rely on (eg, font-size for em units)
147     void collectDirectComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp;) const;
148     // What properties in the root element does this value rely on (eg. font-size for rem units)
149     void collectDirectRootComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp;) const;
150 
151     bool equals(const CSSValue&amp;) const;
152     bool operator==(const CSSValue&amp; other) const { return equals(other); }
153 
154 protected:
155 
156     static const size_t ClassTypeBits = 6;
157     enum ClassType {
158         PrimitiveClass,
159 
160         // Image classes.
161         ImageClass,
162         CursorImageClass,
163 
164         // Image generator classes.
165         CanvasClass,
166 #if ENABLE(CSS_PAINTING_API)
167         PaintImageClass,
168 #endif
169         NamedImageClass,
170         CrossfadeClass,
171         FilterImageClass,
172         LinearGradientClass,
173         RadialGradientClass,
174         ConicGradientClass,
175 
176         // Timing function classes.
177         CubicBezierTimingFunctionClass,
178         StepsTimingFunctionClass,
179         SpringTimingFunctionClass,
180 
181         // Other class types.
182         AspectRatioClass,
183         BorderImageSliceClass,
184         FontFeatureClass,
185 #if ENABLE(VARIATION_FONTS)
186         FontVariationClass,
187 #endif
188         FontClass,
189         FontStyleClass,
190         FontStyleRangeClass,
191         FontFaceSrcClass,
192         FunctionClass,
193 
194         InheritedClass,
195         InitialClass,
196         UnsetClass,
197         RevertClass,
198 
199         ReflectClass,
200         ShadowClass,
201         UnicodeRangeClass,
202         LineBoxContainClass,
203         CalculationClass,
204         GridTemplateAreasClass,
205 
206         CSSContentDistributionClass,
207 
208         CustomIdentClass,
209 
210         CustomPropertyClass,
211         VariableReferenceClass,
212         PendingSubstitutionValueClass,
213 
214         // List class types must appear after ValueListClass. Note CSSFunctionValue
215         // is deliberately excluded, since we don&#39;t want it exposed to the CSS OM
216         // as a list.
217         ValueListClass,
218         ImageSetClass,
219         GridLineNamesClass,
220         GridAutoRepeatClass,
221         GridIntegerRepeatClass,
222         // Do not append non-list class types here.
223     };
224 
225 public:
226     static const size_t ValueListSeparatorBits = 2;
227     enum ValueListSeparator {
228         SpaceSeparator,
229         CommaSeparator,
230         SlashSeparator
231     };
232     enum StaticCSSValueTag { StaticCSSValue };
233 
234 protected:
235     ClassType classType() const { return static_cast&lt;ClassType&gt;(m_classType); }
236 
237     explicit CSSValue(ClassType classType)
238         : m_primitiveUnitType(0)
239         , m_hasCachedCSSText(false)
240         , m_isQuirkValue(false)
241         , m_valueListSeparator(SpaceSeparator)
242         , m_classType(classType)
243     {
244     }
245 
246     void makeStatic()
247     {
248         m_refCount |= refCountFlagIsStatic;
249     }
250 
251     // NOTE: This class is non-virtual for memory and performance reasons.
252     // Don&#39;t go making it virtual again unless you know exactly what you&#39;re doing!
253 
254     ~CSSValue() = default;
255 
256 private:
257     WEBCORE_EXPORT void destroy();
258 
259     mutable unsigned m_refCount { refCountIncrement };
260 protected:
261     // The bits in this section are only used by specific subclasses but kept here
262     // to maximize struct packing.
263     // CSSPrimitiveValue bits:
264     unsigned m_primitiveUnitType : 7; // CSSUnitType
265     mutable unsigned m_hasCachedCSSText : 1;
266     unsigned m_isQuirkValue : 1;
267 
268     unsigned m_valueListSeparator : ValueListSeparatorBits;
269 
270 private:
271     unsigned m_classType : ClassTypeBits; // ClassType
272 
273 friend class CSSValueList;
274 };
275 
276 template&lt;typename CSSValueType&gt;
277 inline bool compareCSSValueVector(const Vector&lt;Ref&lt;CSSValueType&gt;&gt;&amp; firstVector, const Vector&lt;Ref&lt;CSSValueType&gt;&gt;&amp; secondVector)
278 {
279     size_t size = firstVector.size();
280     if (size != secondVector.size())
281         return false;
282 
283     for (size_t i = 0; i &lt; size; ++i) {
284         auto&amp; firstPtr = firstVector[i];
285         auto&amp; secondPtr = secondVector[i];
286         if (firstPtr.ptr() == secondPtr.ptr() || firstPtr-&gt;equals(secondPtr))
287             continue;
288         return false;
289     }
290     return true;
291 }
292 
293 template&lt;typename CSSValueType&gt;
294 inline bool compareCSSValuePtr(const RefPtr&lt;CSSValueType&gt;&amp; first, const RefPtr&lt;CSSValueType&gt;&amp; second)
295 {
296     return first ? second &amp;&amp; first-&gt;equals(*second) : !second;
297 }
298 
299 template&lt;typename CSSValueType&gt;
300 inline bool compareCSSValue(const Ref&lt;CSSValueType&gt;&amp; first, const Ref&lt;CSSValueType&gt;&amp; second)
301 {
302     return first.get().equals(second);
303 }
304 
305 typedef HashMap&lt;AtomString, RefPtr&lt;CSSCustomPropertyValue&gt;&gt; CustomPropertyValueMap;
306 
307 } // namespace WebCore
308 
309 #define SPECIALIZE_TYPE_TRAITS_CSS_VALUE(ToValueTypeName, predicate) \
310 SPECIALIZE_TYPE_TRAITS_BEGIN(WebCore::ToValueTypeName) \
311     static bool isType(const WebCore::CSSValue&amp; value) { return value.predicate; } \
312 SPECIALIZE_TYPE_TRAITS_END()
    </pre>
  </body>
</html>