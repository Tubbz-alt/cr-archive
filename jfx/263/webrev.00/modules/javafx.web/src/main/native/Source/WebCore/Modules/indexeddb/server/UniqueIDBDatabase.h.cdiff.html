<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/server/UniqueIDBDatabase.h</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="UniqueIDBDatabase.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="UniqueIDBDatabaseConnection.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/server/UniqueIDBDatabase.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 30,11 ***</span>
  #include &quot;IDBBackingStore.h&quot;
  #include &quot;IDBDatabaseIdentifier.h&quot;
  #include &quot;IDBDatabaseInfo.h&quot;
  #include &quot;IDBGetResult.h&quot;
  #include &quot;ServerOpenDBRequest.h&quot;
<span class="line-removed">- #include &quot;Timer.h&quot;</span>
  #include &quot;UniqueIDBDatabaseTransaction.h&quot;
  #include &lt;wtf/CrossThreadQueue.h&gt;
  #include &lt;wtf/CrossThreadTask.h&gt;
  #include &lt;wtf/Deque.h&gt;
  #include &lt;wtf/Function.h&gt;
<span class="line-new-header">--- 30,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 42,10 ***</span>
<span class="line-new-header">--- 41,11 ---</span>
  #include &lt;wtf/HashSet.h&gt;
  #include &lt;wtf/ListHashSet.h&gt;
  
  namespace WebCore {
  
<span class="line-added">+ struct ClientOrigin;</span>
  class IDBError;
  class IDBGetAllResult;
  struct IDBGetRecordData;
  class IDBRequestData;
  class IDBTransactionInfo;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 77,11 ***</span>
      WEBCORE_EXPORT ~UniqueIDBDatabase();
  
      void openDatabaseConnection(IDBConnectionToClient&amp;, const IDBRequestData&amp;);
  
      const IDBDatabaseInfo&amp; info() const;
<span class="line-modified">!     IDBServer&amp; server() { return m_server.get(); }</span>
      const IDBDatabaseIdentifier&amp; identifier() const { return m_identifier; }
  
      void createObjectStore(UniqueIDBDatabaseTransaction&amp;, const IDBObjectStoreInfo&amp;, ErrorCallback);
      void deleteObjectStore(UniqueIDBDatabaseTransaction&amp;, const String&amp; objectStoreName, ErrorCallback);
      void renameObjectStore(UniqueIDBDatabaseTransaction&amp;, uint64_t objectStoreIdentifier, const String&amp; newName, ErrorCallback);
<span class="line-new-header">--- 77,11 ---</span>
      WEBCORE_EXPORT ~UniqueIDBDatabase();
  
      void openDatabaseConnection(IDBConnectionToClient&amp;, const IDBRequestData&amp;);
  
      const IDBDatabaseInfo&amp; info() const;
<span class="line-modified">!     IDBServer&amp; server() { return m_server; }</span>
      const IDBDatabaseIdentifier&amp; identifier() const { return m_identifier; }
  
      void createObjectStore(UniqueIDBDatabaseTransaction&amp;, const IDBObjectStoreInfo&amp;, ErrorCallback);
      void deleteObjectStore(UniqueIDBDatabaseTransaction&amp;, const String&amp; objectStoreName, ErrorCallback);
      void renameObjectStore(UniqueIDBDatabaseTransaction&amp;, uint64_t objectStoreIdentifier, const String&amp; newName, ErrorCallback);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 95,218 ***</span>
      void getCount(const IDBRequestData&amp;, const IDBKeyRangeData&amp;, CountCallback);
      void deleteRecord(const IDBRequestData&amp;, const IDBKeyRangeData&amp;, ErrorCallback);
      void openCursor(const IDBRequestData&amp;, const IDBCursorInfo&amp;, GetResultCallback);
      void iterateCursor(const IDBRequestData&amp;, const IDBIterateCursorData&amp;, GetResultCallback);
      void commitTransaction(UniqueIDBDatabaseTransaction&amp;, ErrorCallback);
<span class="line-modified">! </span>
<span class="line-removed">-     enum class WaitForPendingTasks { No, Yes };</span>
<span class="line-removed">-     void abortTransaction(UniqueIDBDatabaseTransaction&amp;, WaitForPendingTasks, ErrorCallback);</span>
  
      void didFinishHandlingVersionChange(UniqueIDBDatabaseConnection&amp;, const IDBResourceIdentifier&amp; transactionIdentifier);
<span class="line-removed">-     void transactionDestroyed(UniqueIDBDatabaseTransaction&amp;);</span>
      void connectionClosedFromClient(UniqueIDBDatabaseConnection&amp;);
<span class="line-modified">!     void confirmConnectionClosedOnServer(UniqueIDBDatabaseConnection&amp;);</span>
<span class="line-removed">-     void didFireVersionChangeEvent(UniqueIDBDatabaseConnection&amp;, const IDBResourceIdentifier&amp; requestIdentifier);</span>
      void openDBRequestCancelled(const IDBResourceIdentifier&amp; requestIdentifier);
<span class="line-removed">-     void confirmDidCloseFromServer(UniqueIDBDatabaseConnection&amp;);</span>
  
      void enqueueTransaction(Ref&lt;UniqueIDBDatabaseTransaction&gt;&amp;&amp;);
  
      void handleDelete(IDBConnectionToClient&amp;, const IDBRequestData&amp;);
      void immediateCloseForUserDelete();
  
<span class="line-modified">!     bool hardClosedForUserDelete() const { return m_hardClosedForUserDelete; }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     uint64_t spaceUsed() const;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     void finishActiveTransactions();</span>
  
  private:
      void handleDatabaseOperations();
      void handleCurrentOperation();
      void performCurrentOpenOperation();
      void performCurrentDeleteOperation();
      void addOpenDatabaseConnection(Ref&lt;UniqueIDBDatabaseConnection&gt;&amp;&amp;);
      bool hasAnyOpenConnections() const;
      bool allConnectionsAreClosedOrClosing() const;
  
      void startVersionChangeTransaction();
      void maybeNotifyConnectionsOfVersionChange();
      void notifyCurrentRequestConnectionClosedOrFiredVersionChangeEvent(uint64_t connectionIdentifier);
<span class="line-modified">!     bool isVersionChangeInProgress();</span>
  
      void activateTransactionInBackingStore(UniqueIDBDatabaseTransaction&amp;);
      void transactionCompleted(RefPtr&lt;UniqueIDBDatabaseTransaction&gt;&amp;&amp;);
  
      void connectionClosedFromServer(UniqueIDBDatabaseConnection&amp;);
<span class="line-modified">! </span>
<span class="line-removed">-     void scheduleShutdownForClose();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     void createObjectStoreAfterQuotaCheck(uint64_t taskSize, UniqueIDBDatabaseTransaction&amp;, const IDBObjectStoreInfo&amp;, ErrorCallback);</span>
<span class="line-removed">-     void renameObjectStoreAfterQuotaCheck(uint64_t taskSize, UniqueIDBDatabaseTransaction&amp;, uint64_t objectStoreIdentifier, const String&amp; newName, ErrorCallback);</span>
<span class="line-removed">-     void createIndexAfterQuotaCheck(uint64_t taskSize, UniqueIDBDatabaseTransaction&amp;, const IDBIndexInfo&amp;, ErrorCallback);</span>
<span class="line-removed">-     void renameIndexAfterQuotaCheck(uint64_t taskSize, UniqueIDBDatabaseTransaction&amp;, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const String&amp; newName, ErrorCallback);</span>
<span class="line-removed">-     void putOrAddAfterQuotaCheck(uint64_t taskSize, const IDBRequestData&amp;, const IDBKeyData&amp;, const IDBValue&amp;, IndexedDB::ObjectStoreOverwriteMode, KeyDataCallback);</span>
<span class="line-removed">-     void deleteRecordAfterQuotaCheck(const IDBRequestData&amp;, const IDBKeyRangeData&amp;, ErrorCallback);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     void deleteObjectStoreAfterQuotaCheck(UniqueIDBDatabaseTransaction&amp;, const String&amp; objectStoreName, ErrorCallback);</span>
<span class="line-removed">-     void clearObjectStoreAfetQuotaCheck(UniqueIDBDatabaseTransaction&amp;, uint64_t objectStoreIdentifier, ErrorCallback);</span>
<span class="line-removed">-     void deleteIndexAfterQuotaCheck(UniqueIDBDatabaseTransaction&amp;, uint64_t objectStoreIdentifier, const String&amp;, ErrorCallback);</span>
<span class="line-removed">-     void getRecordAfterQuotaCheck(const IDBRequestData&amp;, const IDBGetRecordData&amp;, GetResultCallback);</span>
<span class="line-removed">-     void getAllRecordsAfterQuotaCheck(const IDBRequestData&amp;, const IDBGetAllRecordsData&amp;, GetAllResultsCallback);</span>
<span class="line-removed">-     void getCountAfterQuotaCheck(const IDBRequestData&amp;, const IDBKeyRangeData&amp;, CountCallback);</span>
<span class="line-removed">-     void openCursorAfterQuotaCheck(const IDBRequestData&amp;, const IDBCursorInfo&amp;, GetResultCallback);</span>
<span class="line-removed">-     void iterateCursorAfterQuotaCheck(const IDBRequestData&amp;, const IDBIterateCursorData&amp;, GetResultCallback);</span>
<span class="line-removed">-     void commitTransactionAfterQuotaCheck(UniqueIDBDatabaseTransaction&amp;, ErrorCallback);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     // Database thread operations</span>
<span class="line-removed">-     void deleteBackingStore(const IDBDatabaseIdentifier&amp;);</span>
<span class="line-removed">-     void openBackingStore(const IDBDatabaseIdentifier&amp;);</span>
<span class="line-removed">-     void performCommitTransaction(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier);</span>
<span class="line-removed">-     void performAbortTransaction(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier);</span>
<span class="line-removed">-     void beginTransactionInBackingStore(const IDBTransactionInfo&amp;);</span>
<span class="line-removed">-     void performCreateObjectStore(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, const IDBObjectStoreInfo&amp;);</span>
<span class="line-removed">-     void performDeleteObjectStore(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier);</span>
<span class="line-removed">-     void performRenameObjectStore(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, const String&amp; newName);</span>
<span class="line-removed">-     void performClearObjectStore(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier);</span>
<span class="line-removed">-     void performCreateIndex(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, const IDBIndexInfo&amp;);</span>
<span class="line-removed">-     void performDeleteIndex(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t indexIdentifier);</span>
<span class="line-removed">-     void performRenameIndex(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const String&amp; newName);</span>
<span class="line-removed">-     void performPutOrAdd(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, const IDBKeyData&amp;, const IDBValue&amp;, IndexedDB::ObjectStoreOverwriteMode);</span>
<span class="line-removed">-     void performGetRecord(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, const IDBKeyRangeData&amp;, IDBGetRecordDataType);</span>
<span class="line-removed">-     void performGetAllRecords(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, const IDBGetAllRecordsData&amp;);</span>
<span class="line-removed">-     void performGetIndexRecord(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, IndexedDB::IndexRecordType, const IDBKeyRangeData&amp;);</span>
<span class="line-removed">-     void performGetCount(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const IDBKeyRangeData&amp;);</span>
<span class="line-removed">-     void performDeleteRecord(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, const IDBKeyRangeData&amp;);</span>
<span class="line-removed">-     void performOpenCursor(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, const IDBCursorInfo&amp;);</span>
<span class="line-removed">-     void performIterateCursor(uint64_t callbackIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier, const IDBResourceIdentifier&amp; cursorIdentifier, const IDBIterateCursorData&amp;);</span>
<span class="line-removed">-     void performPrefetchCursor(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBResourceIdentifier&amp; cursorIdentifier);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     void performStartVersionChangeTransaction(const IDBTransactionInfo&amp;);</span>
<span class="line-removed">-     void performActivateTransactionInBackingStore(uint64_t callbackIdentifier, const IDBTransactionInfo&amp;);</span>
<span class="line-removed">-     void performUnconditionalDeleteBackingStore();</span>
<span class="line-removed">-     void shutdownForClose();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     // Main thread callbacks</span>
      void didDeleteBackingStore(uint64_t deletedVersion);
<span class="line-modified">!     void didOpenBackingStore(const IDBDatabaseInfo&amp;, const IDBError&amp;);</span>
<span class="line-removed">-     void didPerformCreateObjectStore(uint64_t callbackIdentifier, const IDBError&amp;, const IDBObjectStoreInfo&amp;);</span>
<span class="line-removed">-     void didPerformDeleteObjectStore(uint64_t callbackIdentifier, const IDBError&amp;, uint64_t objectStoreIdentifier);</span>
<span class="line-removed">-     void didPerformRenameObjectStore(uint64_t callbackIdentifier, const IDBError&amp;, uint64_t objectStoreIdentifier, const String&amp; newName);</span>
<span class="line-removed">-     void didPerformClearObjectStore(uint64_t callbackIdentifier, const IDBError&amp;);</span>
<span class="line-removed">-     void didPerformCreateIndex(uint64_t callbackIdentifier, const IDBError&amp;, const IDBIndexInfo&amp;);</span>
<span class="line-removed">-     void didPerformDeleteIndex(uint64_t callbackIdentifier, const IDBError&amp;, uint64_t objectStoreIdentifier, uint64_t indexIdentifier);</span>
<span class="line-removed">-     void didPerformRenameIndex(uint64_t callbackIdentifier, const IDBError&amp;, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const String&amp; newName);</span>
<span class="line-removed">-     void didPerformPutOrAdd(uint64_t callbackIdentifier, const IDBError&amp;, const IDBKeyData&amp;);</span>
<span class="line-removed">-     void didPerformGetRecord(uint64_t callbackIdentifier, const IDBError&amp;, const IDBGetResult&amp;);</span>
<span class="line-removed">-     void didPerformGetAllRecords(uint64_t callbackIdentifier, const IDBError&amp;, const IDBGetAllResult&amp;);</span>
<span class="line-removed">-     void didPerformGetCount(uint64_t callbackIdentifier, const IDBError&amp;, uint64_t);</span>
<span class="line-removed">-     void didPerformDeleteRecord(uint64_t callbackIdentifier, const IDBError&amp;);</span>
<span class="line-removed">-     void didPerformOpenCursor(uint64_t callbackIdentifier, const IDBError&amp;, const IDBGetResult&amp;);</span>
<span class="line-removed">-     void didPerformIterateCursor(uint64_t callbackIdentifier, const IDBError&amp;, const IDBGetResult&amp;);</span>
<span class="line-removed">-     void didPerformCommitTransaction(uint64_t callbackIdentifier, const IDBError&amp;, const IDBResourceIdentifier&amp; transactionIdentifier);</span>
<span class="line-removed">-     void didPerformAbortTransaction(uint64_t callbackIdentifier, const IDBError&amp;, const IDBResourceIdentifier&amp; transactionIdentifier);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     void didPerformStartVersionChangeTransaction(const IDBError&amp;);</span>
<span class="line-removed">-     void didPerformActivateTransactionInBackingStore(uint64_t callbackIdentifier, const IDBError&amp;);</span>
<span class="line-removed">-     void didPerformUnconditionalDeleteBackingStore();</span>
<span class="line-removed">-     void didShutdownForClose();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     uint64_t storeCallbackOrFireError(ErrorCallback&amp;&amp;, uint64_t taskSize = 0);</span>
<span class="line-removed">-     uint64_t storeCallbackOrFireError(KeyDataCallback&amp;&amp;, uint64_t taskSize = 0);</span>
<span class="line-removed">-     uint64_t storeCallbackOrFireError(GetAllResultsCallback&amp;&amp;);</span>
<span class="line-removed">-     uint64_t storeCallbackOrFireError(GetResultCallback&amp;&amp;);</span>
<span class="line-removed">-     uint64_t storeCallbackOrFireError(CountCallback&amp;&amp;);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     void performErrorCallback(uint64_t callbackIdentifier, const IDBError&amp;);</span>
<span class="line-removed">-     void performKeyDataCallback(uint64_t callbackIdentifier, const IDBError&amp;, const IDBKeyData&amp;);</span>
<span class="line-removed">-     void performGetResultCallback(uint64_t callbackIdentifier, const IDBError&amp;, const IDBGetResult&amp;);</span>
<span class="line-removed">-     void performGetAllResultsCallback(uint64_t callbackIdentifier, const IDBError&amp;, const IDBGetAllResult&amp;);</span>
<span class="line-removed">-     void performCountCallback(uint64_t callbackIdentifier, const IDBError&amp;, uint64_t);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     void forgetErrorCallback(uint64_t callbackIdentifier);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     bool hasAnyPendingCallbacks() const;</span>
<span class="line-removed">-     bool isCurrentlyInUse() const;</span>
<span class="line-removed">-     bool hasUnfinishedTransactions() const;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     void invokeOperationAndTransactionTimer();</span>
<span class="line-removed">-     void operationAndTransactionTimerFired();</span>
<span class="line-removed">-     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; takeNextRunnableTransaction(bool&amp; hadDeferredTransactions);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     bool prepareToFinishTransaction(UniqueIDBDatabaseTransaction&amp;, UniqueIDBDatabaseTransaction::State);</span>
<span class="line-removed">-     void abortTransactionOnMainThread(UniqueIDBDatabaseTransaction&amp;);</span>
<span class="line-removed">-     void commitTransactionOnMainThread(UniqueIDBDatabaseTransaction&amp;);</span>
  
      void clearStalePendingOpenDBRequests();
  
<span class="line-modified">!     void postDatabaseTask(CrossThreadTask&amp;&amp;);</span>
<span class="line-removed">-     void postDatabaseTaskReply(CrossThreadTask&amp;&amp;);</span>
<span class="line-removed">-     void executeNextDatabaseTask();</span>
<span class="line-removed">-     void executeNextDatabaseTaskReply();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     void maybeFinishHardClose();</span>
<span class="line-removed">-     bool isDoneWithHardClose();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     void requestSpace(uint64_t taskSize, const char* errorMessage, CompletionHandler&lt;void(Optional&lt;IDBError&gt;&amp;&amp;)&gt;&amp;&amp;);</span>
<span class="line-removed">-     void waitForRequestSpaceCompletion(CompletionHandler&lt;void(Optional&lt;IDBError&gt;&amp;&amp;)&gt;&amp;&amp;);</span>
<span class="line-removed">-     void updateSpaceUsedIfNeeded(Optional&lt;uint64_t&gt; optionalCallbackIdentifier = WTF::nullopt);</span>
  
<span class="line-modified">!     Ref&lt;IDBServer&gt; m_server;</span>
      IDBDatabaseIdentifier m_identifier;
  
      ListHashSet&lt;RefPtr&lt;ServerOpenDBRequest&gt;&gt; m_pendingOpenDBRequests;
      RefPtr&lt;ServerOpenDBRequest&gt; m_currentOpenDBRequest;
  
      ListHashSet&lt;RefPtr&lt;UniqueIDBDatabaseConnection&gt;&gt; m_openDatabaseConnections;
<span class="line-removed">-     HashSet&lt;RefPtr&lt;UniqueIDBDatabaseConnection&gt;&gt; m_clientClosePendingDatabaseConnections;</span>
<span class="line-removed">-     HashSet&lt;RefPtr&lt;UniqueIDBDatabaseConnection&gt;&gt; m_serverClosePendingDatabaseConnections;</span>
  
      RefPtr&lt;UniqueIDBDatabaseConnection&gt; m_versionChangeDatabaseConnection;
      RefPtr&lt;UniqueIDBDatabaseTransaction&gt; m_versionChangeTransaction;
  
<span class="line-removed">-     bool m_isOpeningBackingStore { false };</span>
<span class="line-removed">-     IDBError m_backingStoreOpenError;</span>
      std::unique_ptr&lt;IDBBackingStore&gt; m_backingStore;
      std::unique_ptr&lt;IDBDatabaseInfo&gt; m_databaseInfo;
      std::unique_ptr&lt;IDBDatabaseInfo&gt; m_mostRecentDeletedDatabaseInfo;
  
<span class="line-removed">-     bool m_backingStoreSupportsSimultaneousTransactions { false };</span>
<span class="line-removed">-     bool m_backingStoreIsEphemeral { false };</span>
<span class="line-removed">- </span>
<span class="line-removed">-     HashMap&lt;uint64_t, ErrorCallback&gt; m_errorCallbacks;</span>
<span class="line-removed">-     HashMap&lt;uint64_t, KeyDataCallback&gt; m_keyDataCallbacks;</span>
<span class="line-removed">-     HashMap&lt;uint64_t, GetResultCallback&gt; m_getResultCallbacks;</span>
<span class="line-removed">-     HashMap&lt;uint64_t, GetAllResultsCallback&gt; m_getAllResultsCallbacks;</span>
<span class="line-removed">-     HashMap&lt;uint64_t, CountCallback&gt; m_countCallbacks;</span>
<span class="line-removed">-     Deque&lt;uint64_t&gt; m_callbackQueue;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     Timer m_operationAndTransactionTimer;</span>
<span class="line-removed">- </span>
      Deque&lt;RefPtr&lt;UniqueIDBDatabaseTransaction&gt;&gt; m_pendingTransactions;
      HashMap&lt;IDBResourceIdentifier, RefPtr&lt;UniqueIDBDatabaseTransaction&gt;&gt; m_inProgressTransactions;
<span class="line-removed">-     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;UniqueIDBDatabaseTransaction&gt;&gt; m_finishingTransactions;</span>
  
      // The keys into these sets are the object store ID.
      // These sets help to decide which transactions can be started and which must be deferred.
      HashCountedSet&lt;uint64_t&gt; m_objectStoreTransactionCounts;
      HashSet&lt;uint64_t&gt; m_objectStoreWriteTransactions;
  
<span class="line-removed">-     bool m_deleteBackingStoreInProgress { false };</span>
<span class="line-removed">- </span>
<span class="line-removed">-     CrossThreadQueue&lt;CrossThreadTask&gt; m_databaseQueue;</span>
<span class="line-removed">-     CrossThreadQueue&lt;CrossThreadTask&gt; m_databaseReplyQueue;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     bool m_hardClosedForUserDelete { false };</span>
<span class="line-removed">-     bool m_owningPointerReleaseScheduled { false };</span>
<span class="line-removed">-     std::unique_ptr&lt;UniqueIDBDatabase&gt; m_owningPointerForClose;</span>
<span class="line-removed">- </span>
      HashSet&lt;IDBResourceIdentifier&gt; m_cursorPrefetches;
<span class="line-removed">- </span>
<span class="line-removed">-     HashMap&lt;uint64_t, uint64_t&gt; m_pendingSpaceIncreasingTasks;</span>
<span class="line-removed">-     uint64_t m_currentDatabaseSize { 0 };</span>
<span class="line-removed">-     uint64_t m_newDatabaseSize { 0 };</span>
  };
  
  } // namespace IDBServer
  } // namespace WebCore
  
<span class="line-new-header">--- 95,79 ---</span>
      void getCount(const IDBRequestData&amp;, const IDBKeyRangeData&amp;, CountCallback);
      void deleteRecord(const IDBRequestData&amp;, const IDBKeyRangeData&amp;, ErrorCallback);
      void openCursor(const IDBRequestData&amp;, const IDBCursorInfo&amp;, GetResultCallback);
      void iterateCursor(const IDBRequestData&amp;, const IDBIterateCursorData&amp;, GetResultCallback);
      void commitTransaction(UniqueIDBDatabaseTransaction&amp;, ErrorCallback);
<span class="line-modified">!     void abortTransaction(UniqueIDBDatabaseTransaction&amp;, ErrorCallback);</span>
  
      void didFinishHandlingVersionChange(UniqueIDBDatabaseConnection&amp;, const IDBResourceIdentifier&amp; transactionIdentifier);
      void connectionClosedFromClient(UniqueIDBDatabaseConnection&amp;);
<span class="line-modified">!     void didFireVersionChangeEvent(UniqueIDBDatabaseConnection&amp;, const IDBResourceIdentifier&amp; requestIdentifier, IndexedDB::ConnectionClosedOnBehalfOfServer);</span>
      void openDBRequestCancelled(const IDBResourceIdentifier&amp; requestIdentifier);
  
      void enqueueTransaction(Ref&lt;UniqueIDBDatabaseTransaction&gt;&amp;&amp;);
  
      void handleDelete(IDBConnectionToClient&amp;, const IDBRequestData&amp;);
      void immediateCloseForUserDelete();
  
<span class="line-modified">!     void abortActiveTransactions();</span>
  
  private:
      void handleDatabaseOperations();
      void handleCurrentOperation();
      void performCurrentOpenOperation();
      void performCurrentDeleteOperation();
<span class="line-added">+     enum class RequestType { Delete, Any };</span>
<span class="line-added">+     RefPtr&lt;ServerOpenDBRequest&gt; takeNextRunnableRequest(RequestType = RequestType::Any);</span>
      void addOpenDatabaseConnection(Ref&lt;UniqueIDBDatabaseConnection&gt;&amp;&amp;);
      bool hasAnyOpenConnections() const;
      bool allConnectionsAreClosedOrClosing() const;
  
      void startVersionChangeTransaction();
      void maybeNotifyConnectionsOfVersionChange();
      void notifyCurrentRequestConnectionClosedOrFiredVersionChangeEvent(uint64_t connectionIdentifier);
<span class="line-modified">! </span>
<span class="line-added">+     void handleTransactions();</span>
<span class="line-added">+     RefPtr&lt;UniqueIDBDatabaseTransaction&gt; takeNextRunnableTransaction(bool&amp; hadDeferredTransactions);</span>
  
      void activateTransactionInBackingStore(UniqueIDBDatabaseTransaction&amp;);
      void transactionCompleted(RefPtr&lt;UniqueIDBDatabaseTransaction&gt;&amp;&amp;);
  
      void connectionClosedFromServer(UniqueIDBDatabaseConnection&amp;);
<span class="line-modified">!     void deleteBackingStore();</span>
      void didDeleteBackingStore(uint64_t deletedVersion);
<span class="line-modified">!     void close();</span>
  
<span class="line-added">+     bool isCurrentlyInUse() const;</span>
      void clearStalePendingOpenDBRequests();
  
<span class="line-modified">!     void clearTransactionsOnConnection(UniqueIDBDatabaseConnection&amp;);</span>
  
<span class="line-modified">!     IDBServer&amp; m_server;</span>
      IDBDatabaseIdentifier m_identifier;
  
      ListHashSet&lt;RefPtr&lt;ServerOpenDBRequest&gt;&gt; m_pendingOpenDBRequests;
      RefPtr&lt;ServerOpenDBRequest&gt; m_currentOpenDBRequest;
  
      ListHashSet&lt;RefPtr&lt;UniqueIDBDatabaseConnection&gt;&gt; m_openDatabaseConnections;
  
      RefPtr&lt;UniqueIDBDatabaseConnection&gt; m_versionChangeDatabaseConnection;
      RefPtr&lt;UniqueIDBDatabaseTransaction&gt; m_versionChangeTransaction;
  
      std::unique_ptr&lt;IDBBackingStore&gt; m_backingStore;
      std::unique_ptr&lt;IDBDatabaseInfo&gt; m_databaseInfo;
      std::unique_ptr&lt;IDBDatabaseInfo&gt; m_mostRecentDeletedDatabaseInfo;
  
      Deque&lt;RefPtr&lt;UniqueIDBDatabaseTransaction&gt;&gt; m_pendingTransactions;
      HashMap&lt;IDBResourceIdentifier, RefPtr&lt;UniqueIDBDatabaseTransaction&gt;&gt; m_inProgressTransactions;
  
      // The keys into these sets are the object store ID.
      // These sets help to decide which transactions can be started and which must be deferred.
      HashCountedSet&lt;uint64_t&gt; m_objectStoreTransactionCounts;
      HashSet&lt;uint64_t&gt; m_objectStoreWriteTransactions;
  
      HashSet&lt;IDBResourceIdentifier&gt; m_cursorPrefetches;
  };
  
  } // namespace IDBServer
  } // namespace WebCore
  
</pre>
<center><a href="UniqueIDBDatabase.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="UniqueIDBDatabaseConnection.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>