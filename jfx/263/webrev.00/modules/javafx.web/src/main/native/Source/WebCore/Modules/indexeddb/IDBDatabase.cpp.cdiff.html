<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/IDBDatabase.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IDBCursor.idl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IDBDatabase.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/IDBDatabase.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 65,21 ***</span>
      m_connectionProxy-&gt;registerDatabaseConnection(*this);
  }
  
  IDBDatabase::~IDBDatabase()
  {
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      if (!m_closedInServer)
          m_connectionProxy-&gt;databaseConnectionClosed(*this);
  
      m_connectionProxy-&gt;unregisterDatabaseConnection(*this);
  }
  
  bool IDBDatabase::hasPendingActivity() const
  {
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current() || Thread::mayBeGCThread());</span>
  
      if (m_closedInServer || isContextStopped())
          return false;
  
      if (!m_activeTransactions.isEmpty() || !m_committingTransactions.isEmpty() || !m_abortingTransactions.isEmpty())
<span class="line-new-header">--- 65,21 ---</span>
      m_connectionProxy-&gt;registerDatabaseConnection(*this);
  }
  
  IDBDatabase::~IDBDatabase()
  {
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (!m_closedInServer)
          m_connectionProxy-&gt;databaseConnectionClosed(*this);
  
      m_connectionProxy-&gt;unregisterDatabaseConnection(*this);
  }
  
  bool IDBDatabase::hasPendingActivity() const
  {
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()) || Thread::mayBeGCThread());</span>
  
      if (m_closedInServer || isContextStopped())
          return false;
  
      if (!m_activeTransactions.isEmpty() || !m_committingTransactions.isEmpty() || !m_abortingTransactions.isEmpty())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 88,45 ***</span>
      return hasEventListeners(m_eventNames.abortEvent) || hasEventListeners(m_eventNames.errorEvent) || hasEventListeners(m_eventNames.versionchangeEvent);
  }
  
  const String IDBDatabase::name() const
  {
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
      return m_info.name();
  }
  
  uint64_t IDBDatabase::version() const
  {
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
      return m_info.version();
  }
  
  Ref&lt;DOMStringList&gt; IDBDatabase::objectStoreNames() const
  {
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      auto objectStoreNames = DOMStringList::create();
      for (auto&amp; name : m_info.objectStoreNames())
          objectStoreNames-&gt;append(name);
      objectStoreNames-&gt;sort();
      return objectStoreNames;
  }
  
  void IDBDatabase::renameObjectStore(IDBObjectStore&amp; objectStore, const String&amp; newName)
  {
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
      ASSERT(m_versionChangeTransaction);
      ASSERT(m_info.hasObjectStore(objectStore.info().name()));
  
      m_info.renameObjectStore(objectStore.info().identifier(), newName);
  
      m_versionChangeTransaction-&gt;renameObjectStore(objectStore, newName);
  }
  
  void IDBDatabase::renameIndex(IDBIndex&amp; index, const String&amp; newName)
  {
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
      ASSERT(m_versionChangeTransaction);
      ASSERT(m_info.hasObjectStore(index.objectStore().info().name()));
      ASSERT(m_info.infoForExistingObjectStore(index.objectStore().info().name())-&gt;hasIndex(index.info().name()));
  
      m_info.infoForExistingObjectStore(index.objectStore().info().name())-&gt;infoForExistingIndex(index.info().identifier())-&gt;rename(newName);
<span class="line-new-header">--- 88,45 ---</span>
      return hasEventListeners(m_eventNames.abortEvent) || hasEventListeners(m_eventNames.errorEvent) || hasEventListeners(m_eventNames.versionchangeEvent);
  }
  
  const String IDBDatabase::name() const
  {
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      return m_info.name();
  }
  
  uint64_t IDBDatabase::version() const
  {
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      return m_info.version();
  }
  
  Ref&lt;DOMStringList&gt; IDBDatabase::objectStoreNames() const
  {
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto objectStoreNames = DOMStringList::create();
      for (auto&amp; name : m_info.objectStoreNames())
          objectStoreNames-&gt;append(name);
      objectStoreNames-&gt;sort();
      return objectStoreNames;
  }
  
  void IDBDatabase::renameObjectStore(IDBObjectStore&amp; objectStore, const String&amp; newName)
  {
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(m_versionChangeTransaction);
      ASSERT(m_info.hasObjectStore(objectStore.info().name()));
  
      m_info.renameObjectStore(objectStore.info().identifier(), newName);
  
      m_versionChangeTransaction-&gt;renameObjectStore(objectStore, newName);
  }
  
  void IDBDatabase::renameIndex(IDBIndex&amp; index, const String&amp; newName)
  {
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(m_versionChangeTransaction);
      ASSERT(m_info.hasObjectStore(index.objectStore().info().name()));
      ASSERT(m_info.infoForExistingObjectStore(index.objectStore().info().name())-&gt;hasIndex(index.info().name()));
  
      m_info.infoForExistingObjectStore(index.objectStore().info().name())-&gt;infoForExistingIndex(index.info().identifier())-&gt;rename(newName);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 136,11 ***</span>
  
  ExceptionOr&lt;Ref&lt;IDBObjectStore&gt;&gt; IDBDatabase::createObjectStore(const String&amp; name, ObjectStoreParameters&amp;&amp; parameters)
  {
      LOG(IndexedDB, &quot;IDBDatabase::createObjectStore - (%s %s)&quot;, m_info.name().utf8().data(), name.utf8().data());
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
      ASSERT(!m_versionChangeTransaction || m_versionChangeTransaction-&gt;isVersionChange());
  
      if (!m_versionChangeTransaction)
          return Exception { InvalidStateError, &quot;Failed to execute &#39;createObjectStore&#39; on &#39;IDBDatabase&#39;: The database is not running a version change transaction.&quot;_s };
  
<span class="line-new-header">--- 136,11 ---</span>
  
  ExceptionOr&lt;Ref&lt;IDBObjectStore&gt;&gt; IDBDatabase::createObjectStore(const String&amp; name, ObjectStoreParameters&amp;&amp; parameters)
  {
      LOG(IndexedDB, &quot;IDBDatabase::createObjectStore - (%s %s)&quot;, m_info.name().utf8().data(), name.utf8().data());
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(!m_versionChangeTransaction || m_versionChangeTransaction-&gt;isVersionChange());
  
      if (!m_versionChangeTransaction)
          return Exception { InvalidStateError, &quot;Failed to execute &#39;createObjectStore&#39; on &#39;IDBDatabase&#39;: The database is not running a version change transaction.&quot;_s };
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 166,11 ***</span>
  
  ExceptionOr&lt;Ref&lt;IDBTransaction&gt;&gt; IDBDatabase::transaction(StringOrVectorOfStrings&amp;&amp; storeNames, IDBTransactionMode mode)
  {
      LOG(IndexedDB, &quot;IDBDatabase::transaction&quot;);
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      if (m_versionChangeTransaction &amp;&amp; !m_versionChangeTransaction-&gt;isFinishedOrFinishing())
          return Exception { InvalidStateError, &quot;Failed to execute &#39;transaction&#39; on &#39;IDBDatabase&#39;: A version change transaction is running.&quot;_s };
  
      if (m_closePending)
<span class="line-new-header">--- 166,11 ---</span>
  
  ExceptionOr&lt;Ref&lt;IDBTransaction&gt;&gt; IDBDatabase::transaction(StringOrVectorOfStrings&amp;&amp; storeNames, IDBTransactionMode mode)
  {
      LOG(IndexedDB, &quot;IDBDatabase::transaction&quot;);
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (m_versionChangeTransaction &amp;&amp; !m_versionChangeTransaction-&gt;isFinishedOrFinishing())
          return Exception { InvalidStateError, &quot;Failed to execute &#39;transaction&#39; on &#39;IDBDatabase&#39;: A version change transaction is running.&quot;_s };
  
      if (m_closePending)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 216,11 ***</span>
  
  ExceptionOr&lt;void&gt; IDBDatabase::deleteObjectStore(const String&amp; objectStoreName)
  {
      LOG(IndexedDB, &quot;IDBDatabase::deleteObjectStore&quot;);
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      if (!m_versionChangeTransaction)
          return Exception { InvalidStateError, &quot;Failed to execute &#39;deleteObjectStore&#39; on &#39;IDBDatabase&#39;: The database is not running a version change transaction.&quot;_s };
  
      if (!m_versionChangeTransaction-&gt;isActive())
<span class="line-new-header">--- 216,11 ---</span>
  
  ExceptionOr&lt;void&gt; IDBDatabase::deleteObjectStore(const String&amp; objectStoreName)
  {
      LOG(IndexedDB, &quot;IDBDatabase::deleteObjectStore&quot;);
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (!m_versionChangeTransaction)
          return Exception { InvalidStateError, &quot;Failed to execute &#39;deleteObjectStore&#39; on &#39;IDBDatabase&#39;: The database is not running a version change transaction.&quot;_s };
  
      if (!m_versionChangeTransaction-&gt;isActive())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 237,11 ***</span>
  
  void IDBDatabase::close()
  {
      LOG(IndexedDB, &quot;IDBDatabase::close - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      if (!m_closePending) {
          m_closePending = true;
          m_connectionProxy-&gt;databaseConnectionPendingClose(*this);
      }
<span class="line-new-header">--- 237,11 ---</span>
  
  void IDBDatabase::close()
  {
      LOG(IndexedDB, &quot;IDBDatabase::close - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (!m_closePending) {
          m_closePending = true;
          m_connectionProxy-&gt;databaseConnectionPendingClose(*this);
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 252,19 ***</span>
  void IDBDatabase::didCloseFromServer(const IDBError&amp; error)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didCloseFromServer - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
      connectionToServerLost(error);
<span class="line-removed">- </span>
<span class="line-removed">-     m_connectionProxy-&gt;confirmDidCloseFromServer(*this);</span>
  }
  
  void IDBDatabase::connectionToServerLost(const IDBError&amp; error)
  {
      LOG(IndexedDB, &quot;IDBDatabase::connectionToServerLost - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      m_closePending = true;
      m_closedInServer = true;
  
      auto activeTransactions = copyToVector(m_activeTransactions.values());
<span class="line-new-header">--- 252,17 ---</span>
  void IDBDatabase::didCloseFromServer(const IDBError&amp; error)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didCloseFromServer - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
      connectionToServerLost(error);
  }
  
  void IDBDatabase::connectionToServerLost(const IDBError&amp; error)
  {
      LOG(IndexedDB, &quot;IDBDatabase::connectionToServerLost - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      m_closePending = true;
      m_closedInServer = true;
  
      auto activeTransactions = copyToVector(m_activeTransactions.values());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 276,25 ***</span>
          transaction-&gt;connectionClosedFromServer(error);
  
      auto errorEvent = Event::create(m_eventNames.errorEvent, Event::CanBubble::Yes, Event::IsCancelable::No);
      errorEvent-&gt;setTarget(this);
  
<span class="line-modified">!     if (auto* context = scriptExecutionContext())</span>
<span class="line-modified">!         context-&gt;eventQueue().enqueueEvent(WTFMove(errorEvent));</span>
  
      auto closeEvent = Event::create(m_eventNames.closeEvent, Event::CanBubble::Yes, Event::IsCancelable::No);
      closeEvent-&gt;setTarget(this);
  
<span class="line-modified">!     if (auto* context = scriptExecutionContext())</span>
<span class="line-modified">!         context-&gt;eventQueue().enqueueEvent(WTFMove(closeEvent));</span>
  }
  
  void IDBDatabase::maybeCloseInServer()
  {
      LOG(IndexedDB, &quot;IDBDatabase::maybeCloseInServer - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      if (m_closedInServer)
          return;
  
      // 3.3.9 Database closing steps
<span class="line-new-header">--- 274,25 ---</span>
          transaction-&gt;connectionClosedFromServer(error);
  
      auto errorEvent = Event::create(m_eventNames.errorEvent, Event::CanBubble::Yes, Event::IsCancelable::No);
      errorEvent-&gt;setTarget(this);
  
<span class="line-modified">!     if (scriptExecutionContext())</span>
<span class="line-modified">!         queueTaskToDispatchEvent(*this, TaskSource::DatabaseAccess, WTFMove(errorEvent));</span>
  
      auto closeEvent = Event::create(m_eventNames.closeEvent, Event::CanBubble::Yes, Event::IsCancelable::No);
      closeEvent-&gt;setTarget(this);
  
<span class="line-modified">!     if (scriptExecutionContext())</span>
<span class="line-modified">!         queueTaskToDispatchEvent(*this, TaskSource::DatabaseAccess, WTFMove(closeEvent));</span>
  }
  
  void IDBDatabase::maybeCloseInServer()
  {
      LOG(IndexedDB, &quot;IDBDatabase::maybeCloseInServer - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (m_closedInServer)
          return;
  
      // 3.3.9 Database closing steps
</pre>
<hr />
<pre>
<span class="line-old-header">*** 307,28 ***</span>
      m_connectionProxy-&gt;databaseConnectionClosed(*this);
  }
  
  const char* IDBDatabase::activeDOMObjectName() const
  {
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
      return &quot;IDBDatabase&quot;;
  }
  
<span class="line-removed">- bool IDBDatabase::canSuspendForDocumentSuspension() const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="line-removed">- </span>
<span class="line-removed">-     // FIXME: This value will sometimes be false when database operations are actually in progress.</span>
<span class="line-removed">-     // Such database operations do not yet exist.</span>
<span class="line-removed">-     return true;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void IDBDatabase::stop()
  {
      LOG(IndexedDB, &quot;IDBDatabase::stop - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      removeAllEventListeners();
  
      Vector&lt;IDBResourceIdentifier&gt; transactionIdentifiers;
      transactionIdentifiers.reserveInitialCapacity(m_activeTransactions.size());
<span class="line-new-header">--- 305,19 ---</span>
      m_connectionProxy-&gt;databaseConnectionClosed(*this);
  }
  
  const char* IDBDatabase::activeDOMObjectName() const
  {
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      return &quot;IDBDatabase&quot;;
  }
  
  void IDBDatabase::stop()
  {
      LOG(IndexedDB, &quot;IDBDatabase::stop - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      removeAllEventListeners();
  
      Vector&lt;IDBResourceIdentifier&gt; transactionIdentifiers;
      transactionIdentifiers.reserveInitialCapacity(m_activeTransactions.size());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 347,11 ***</span>
  
  Ref&lt;IDBTransaction&gt; IDBDatabase::startVersionChangeTransaction(const IDBTransactionInfo&amp; info, IDBOpenDBRequest&amp; request)
  {
      LOG(IndexedDB, &quot;IDBDatabase::startVersionChangeTransaction %s&quot;, info.identifier().loggingString().utf8().data());
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
      ASSERT(!m_versionChangeTransaction);
      ASSERT(info.mode() == IDBTransactionMode::Versionchange);
      ASSERT(!m_closePending);
      ASSERT(scriptExecutionContext());
  
<span class="line-new-header">--- 336,11 ---</span>
  
  Ref&lt;IDBTransaction&gt; IDBDatabase::startVersionChangeTransaction(const IDBTransactionInfo&amp; info, IDBOpenDBRequest&amp; request)
  {
      LOG(IndexedDB, &quot;IDBDatabase::startVersionChangeTransaction %s&quot;, info.identifier().loggingString().utf8().data());
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(!m_versionChangeTransaction);
      ASSERT(info.mode() == IDBTransactionMode::Versionchange);
      ASSERT(!m_closePending);
      ASSERT(scriptExecutionContext());
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 365,11 ***</span>
  
  void IDBDatabase::didStartTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didStartTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
      ASSERT(!m_versionChangeTransaction);
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      // It is possible for the client to have aborted a transaction before the server replies back that it has started.
      if (m_abortingTransactions.contains(transaction.info().identifier()))
          return;
  
<span class="line-new-header">--- 354,11 ---</span>
  
  void IDBDatabase::didStartTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didStartTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
      ASSERT(!m_versionChangeTransaction);
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      // It is possible for the client to have aborted a transaction before the server replies back that it has started.
      if (m_abortingTransactions.contains(transaction.info().identifier()))
          return;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 378,22 ***</span>
  
  void IDBDatabase::willCommitTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::willCommitTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      auto refTransaction = m_activeTransactions.take(transaction.info().identifier());
      ASSERT(refTransaction);
      m_committingTransactions.set(transaction.info().identifier(), WTFMove(refTransaction));
  }
  
  void IDBDatabase::didCommitTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didCommitTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      if (m_versionChangeTransaction == &amp;transaction)
          m_info.setVersion(transaction.info().newVersion());
  
      didCommitOrAbortTransaction(transaction);
<span class="line-new-header">--- 367,22 ---</span>
  
  void IDBDatabase::willCommitTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::willCommitTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto refTransaction = m_activeTransactions.take(transaction.info().identifier());
      ASSERT(refTransaction);
      m_committingTransactions.set(transaction.info().identifier(), WTFMove(refTransaction));
  }
  
  void IDBDatabase::didCommitTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didCommitTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (m_versionChangeTransaction == &amp;transaction)
          m_info.setVersion(transaction.info().newVersion());
  
      didCommitOrAbortTransaction(transaction);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 401,11 ***</span>
  
  void IDBDatabase::willAbortTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::willAbortTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      auto refTransaction = m_activeTransactions.take(transaction.info().identifier());
      if (!refTransaction)
          refTransaction = m_committingTransactions.take(transaction.info().identifier());
  
<span class="line-new-header">--- 390,11 ---</span>
  
  void IDBDatabase::willAbortTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::willAbortTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto refTransaction = m_activeTransactions.take(transaction.info().identifier());
      if (!refTransaction)
          refTransaction = m_committingTransactions.take(transaction.info().identifier());
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 421,11 ***</span>
  
  void IDBDatabase::didAbortTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didAbortTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      if (transaction.isVersionChange()) {
          ASSERT(transaction.originalDatabaseInfo());
          ASSERT(m_info.version() == transaction.originalDatabaseInfo()-&gt;version());
          m_closePending = true;
<span class="line-new-header">--- 410,11 ---</span>
  
  void IDBDatabase::didAbortTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didAbortTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (transaction.isVersionChange()) {
          ASSERT(transaction.originalDatabaseInfo());
          ASSERT(m_info.version() == transaction.originalDatabaseInfo()-&gt;version());
          m_closePending = true;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 437,11 ***</span>
  
  void IDBDatabase::didCommitOrAbortTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didCommitOrAbortTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      if (m_versionChangeTransaction == &amp;transaction)
          m_versionChangeTransaction = nullptr;
  
  #ifndef NDBEBUG
<span class="line-new-header">--- 426,11 ---</span>
  
  void IDBDatabase::didCommitOrAbortTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didCommitOrAbortTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (m_versionChangeTransaction == &amp;transaction)
          m_versionChangeTransaction = nullptr;
  
  #ifndef NDBEBUG
</pre>
<hr />
<pre>
<span class="line-old-header">*** 467,26 ***</span>
  void IDBDatabase::fireVersionChangeEvent(const IDBResourceIdentifier&amp; requestIdentifier, uint64_t requestedVersion)
  {
      uint64_t currentVersion = m_info.version();
      LOG(IndexedDB, &quot;IDBDatabase::fireVersionChangeEvent - current version %&quot; PRIu64 &quot;, requested version %&quot; PRIu64 &quot;, connection %&quot; PRIu64 &quot; (%p)&quot;, currentVersion, requestedVersion, m_databaseConnectionIdentifier, this);
  
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      if (!scriptExecutionContext() || m_closePending) {
          connectionProxy().didFireVersionChangeEvent(m_databaseConnectionIdentifier, requestIdentifier);
          return;
      }
  
      Ref&lt;Event&gt; event = IDBVersionChangeEvent::create(requestIdentifier, currentVersion, requestedVersion, m_eventNames.versionchangeEvent);
<span class="line-modified">!     event-&gt;setTarget(this);</span>
<span class="line-removed">-     scriptExecutionContext()-&gt;eventQueue().enqueueEvent(WTFMove(event));</span>
  }
  
  void IDBDatabase::dispatchEvent(Event&amp; event)
  {
      LOG(IndexedDB, &quot;IDBDatabase::dispatchEvent (%&quot; PRIu64 &quot;) (%p)&quot;, m_databaseConnectionIdentifier, this);
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      auto protectedThis = makeRef(*this);
  
      EventTargetWithInlineData::dispatchEvent(event);
  
<span class="line-new-header">--- 456,25 ---</span>
  void IDBDatabase::fireVersionChangeEvent(const IDBResourceIdentifier&amp; requestIdentifier, uint64_t requestedVersion)
  {
      uint64_t currentVersion = m_info.version();
      LOG(IndexedDB, &quot;IDBDatabase::fireVersionChangeEvent - current version %&quot; PRIu64 &quot;, requested version %&quot; PRIu64 &quot;, connection %&quot; PRIu64 &quot; (%p)&quot;, currentVersion, requestedVersion, m_databaseConnectionIdentifier, this);
  
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (!scriptExecutionContext() || m_closePending) {
          connectionProxy().didFireVersionChangeEvent(m_databaseConnectionIdentifier, requestIdentifier);
          return;
      }
  
      Ref&lt;Event&gt; event = IDBVersionChangeEvent::create(requestIdentifier, currentVersion, requestedVersion, m_eventNames.versionchangeEvent);
<span class="line-modified">!     queueTaskToDispatchEvent(*this, TaskSource::DatabaseAccess, WTFMove(event));</span>
  }
  
  void IDBDatabase::dispatchEvent(Event&amp; event)
  {
      LOG(IndexedDB, &quot;IDBDatabase::dispatchEvent (%&quot; PRIu64 &quot;) (%p)&quot;, m_databaseConnectionIdentifier, this);
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto protectedThis = makeRef(*this);
  
      EventTargetWithInlineData::dispatchEvent(event);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 494,20 ***</span>
          m_connectionProxy-&gt;didFireVersionChangeEvent(m_databaseConnectionIdentifier, downcast&lt;IDBVersionChangeEvent&gt;(event).requestIdentifier());
  }
  
  void IDBDatabase::didCreateIndexInfo(const IDBIndexInfo&amp; info)
  {
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      auto* objectStore = m_info.infoForExistingObjectStore(info.objectStoreIdentifier());
      ASSERT(objectStore);
      objectStore-&gt;addExistingIndex(info);
  }
  
  void IDBDatabase::didDeleteIndexInfo(const IDBIndexInfo&amp; info)
  {
<span class="line-modified">!     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
  
      auto* objectStore = m_info.infoForExistingObjectStore(info.objectStoreIdentifier());
      ASSERT(objectStore);
      objectStore-&gt;deleteIndex(info.name());
  }
<span class="line-new-header">--- 482,20 ---</span>
          m_connectionProxy-&gt;didFireVersionChangeEvent(m_databaseConnectionIdentifier, downcast&lt;IDBVersionChangeEvent&gt;(event).requestIdentifier());
  }
  
  void IDBDatabase::didCreateIndexInfo(const IDBIndexInfo&amp; info)
  {
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto* objectStore = m_info.infoForExistingObjectStore(info.objectStoreIdentifier());
      ASSERT(objectStore);
      objectStore-&gt;addExistingIndex(info);
  }
  
  void IDBDatabase::didDeleteIndexInfo(const IDBIndexInfo&amp; info)
  {
<span class="line-modified">!     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto* objectStore = m_info.infoForExistingObjectStore(info.objectStoreIdentifier());
      ASSERT(objectStore);
      objectStore-&gt;deleteIndex(info.name());
  }
</pre>
<center><a href="IDBCursor.idl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IDBDatabase.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>