<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/FontCache.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Font.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="FontCache.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/FontCache.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 71,15 ***</span>
  
  struct FontPlatformDataCacheKey {
      WTF_MAKE_FAST_ALLOCATED;
  public:
      FontPlatformDataCacheKey() { }
<span class="line-modified">!     FontPlatformDataCacheKey(const AtomString&amp; family, const FontDescription&amp; description, const FontFeatureSettings* fontFaceFeatures, const FontVariantSettings* fontFaceVariantSettings, FontSelectionSpecifiedCapabilities fontFaceCapabilities)</span>
          : m_fontDescriptionKey(description)
          , m_family(family)
          , m_fontFaceFeatures(fontFaceFeatures ? *fontFaceFeatures : FontFeatureSettings())
<span class="line-removed">-         , m_fontFaceVariantSettings(fontFaceVariantSettings ? *fontFaceVariantSettings : FontVariantSettings())</span>
          , m_fontFaceCapabilities(fontFaceCapabilities)
      { }
  
      explicit FontPlatformDataCacheKey(HashTableDeletedValueType t)
          : m_fontDescriptionKey(t)
<span class="line-new-header">--- 71,14 ---</span>
  
  struct FontPlatformDataCacheKey {
      WTF_MAKE_FAST_ALLOCATED;
  public:
      FontPlatformDataCacheKey() { }
<span class="line-modified">!     FontPlatformDataCacheKey(const AtomString&amp; family, const FontDescription&amp; description, const FontFeatureSettings* fontFaceFeatures, FontSelectionSpecifiedCapabilities fontFaceCapabilities)</span>
          : m_fontDescriptionKey(description)
          , m_family(family)
          , m_fontFaceFeatures(fontFaceFeatures ? *fontFaceFeatures : FontFeatureSettings())
          , m_fontFaceCapabilities(fontFaceCapabilities)
      { }
  
      explicit FontPlatformDataCacheKey(HashTableDeletedValueType t)
          : m_fontDescriptionKey(t)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 89,11 ***</span>
  
      bool operator==(const FontPlatformDataCacheKey&amp; other) const
      {
          if (m_fontDescriptionKey != other.m_fontDescriptionKey
              || m_fontFaceFeatures != other.m_fontFaceFeatures
<span class="line-removed">-             || m_fontFaceVariantSettings != other.m_fontFaceVariantSettings</span>
              || m_fontFaceCapabilities != other.m_fontFaceCapabilities)
              return false;
          if (m_family.impl() == other.m_family.impl())
              return true;
          if (m_family.isNull() || other.m_family.isNull())
<span class="line-new-header">--- 88,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 102,22 ***</span>
      }
  
      FontDescriptionKey m_fontDescriptionKey;
      AtomString m_family;
      FontFeatureSettings m_fontFaceFeatures;
<span class="line-removed">-     FontVariantSettings m_fontFaceVariantSettings;</span>
      FontSelectionSpecifiedCapabilities m_fontFaceCapabilities;
  };
  
  struct FontPlatformDataCacheKeyHash {
      static unsigned hash(const FontPlatformDataCacheKey&amp; fontKey)
      {
          IntegerHasher hasher;
          hasher.add(FontCascadeDescription::familyNameHash(fontKey.m_family));
          hasher.add(fontKey.m_fontDescriptionKey.computeHash());
          hasher.add(fontKey.m_fontFaceFeatures.hash());
<span class="line-removed">-         hasher.add(fontKey.m_fontFaceVariantSettings.uniqueValue());</span>
          if (auto weight = fontKey.m_fontFaceCapabilities.weight)
              hasher.add(weight-&gt;uniqueValue());
          else
              hasher.add(std::numeric_limits&lt;unsigned&gt;::max());
          if (auto width = fontKey.m_fontFaceCapabilities.weight)
<span class="line-new-header">--- 100,20 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 198,11 ***</span>
  
      return nullAtom();
  }
  
  FontPlatformData* FontCache::getCachedFontPlatformData(const FontDescription&amp; fontDescription, const AtomString&amp; passedFamilyName,
<span class="line-modified">!     const FontFeatureSettings* fontFaceFeatures, const FontVariantSettings* fontFaceVariantSettings, FontSelectionSpecifiedCapabilities fontFaceCapabilities, bool checkingAlternateName)</span>
  {
  #if PLATFORM(IOS_FAMILY)
      auto locker = holdLock(fontLock);
  #endif
  
<span class="line-new-header">--- 194,11 ---</span>
  
      return nullAtom();
  }
  
  FontPlatformData* FontCache::getCachedFontPlatformData(const FontDescription&amp; fontDescription, const AtomString&amp; passedFamilyName,
<span class="line-modified">!     const FontFeatureSettings* fontFaceFeatures, FontSelectionSpecifiedCapabilities fontFaceCapabilities, bool checkingAlternateName)</span>
  {
  #if PLATFORM(IOS_FAMILY)
      auto locker = holdLock(fontLock);
  #endif
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 220,23 ***</span>
      if (!initialized) {
          platformInit();
          initialized = true;
      }
  
<span class="line-modified">!     FontPlatformDataCacheKey key(familyName, fontDescription, fontFaceFeatures, fontFaceVariantSettings, fontFaceCapabilities);</span>
  
      auto addResult = fontPlatformDataCache().add(key, nullptr);
      FontPlatformDataCache::iterator it = addResult.iterator;
      if (addResult.isNewEntry) {
<span class="line-modified">!         it-&gt;value = createFontPlatformData(fontDescription, familyName, fontFaceFeatures, fontFaceVariantSettings, fontFaceCapabilities);</span>
  
          if (!it-&gt;value &amp;&amp; !checkingAlternateName) {
              // We were unable to find a font.  We have a small set of fonts that we alias to other names,
              // e.g., Arial/Helvetica, Courier/Courier New, etc.  Try looking up the font under the aliased name.
              const AtomString&amp; alternateName = alternateFamilyName(familyName);
              if (!alternateName.isNull()) {
<span class="line-modified">!                 FontPlatformData* fontPlatformDataForAlternateName = getCachedFontPlatformData(fontDescription, alternateName, fontFaceFeatures, fontFaceVariantSettings, fontFaceCapabilities, true);</span>
                  // Lookup the key in the hash table again as the previous iterator may have
                  // been invalidated by the recursive call to getCachedFontPlatformData().
                  it = fontPlatformDataCache().find(key);
                  ASSERT(it != fontPlatformDataCache().end());
                  if (fontPlatformDataForAlternateName)
<span class="line-new-header">--- 216,23 ---</span>
      if (!initialized) {
          platformInit();
          initialized = true;
      }
  
<span class="line-modified">!     FontPlatformDataCacheKey key(familyName, fontDescription, fontFaceFeatures, fontFaceCapabilities);</span>
  
      auto addResult = fontPlatformDataCache().add(key, nullptr);
      FontPlatformDataCache::iterator it = addResult.iterator;
      if (addResult.isNewEntry) {
<span class="line-modified">!         it-&gt;value = createFontPlatformData(fontDescription, familyName, fontFaceFeatures, fontFaceCapabilities);</span>
  
          if (!it-&gt;value &amp;&amp; !checkingAlternateName) {
              // We were unable to find a font.  We have a small set of fonts that we alias to other names,
              // e.g., Arial/Helvetica, Courier/Courier New, etc.  Try looking up the font under the aliased name.
              const AtomString&amp; alternateName = alternateFamilyName(familyName);
              if (!alternateName.isNull()) {
<span class="line-modified">!                 FontPlatformData* fontPlatformDataForAlternateName = getCachedFontPlatformData(fontDescription, alternateName, fontFaceFeatures, fontFaceCapabilities, true);</span>
                  // Lookup the key in the hash table again as the previous iterator may have
                  // been invalidated by the recursive call to getCachedFontPlatformData().
                  it = fontPlatformDataCache().find(key);
                  ASSERT(it != fontPlatformDataCache().end());
                  if (fontPlatformDataForAlternateName)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 314,16 ***</span>
  #endif
  
  const unsigned cMaxUnderMemoryPressureInactiveFontData = 50;
  const unsigned cTargetUnderMemoryPressureInactiveFontData = 30;
  
<span class="line-modified">! RefPtr&lt;Font&gt; FontCache::fontForFamily(const FontDescription&amp; fontDescription, const AtomString&amp; family, const FontFeatureSettings* fontFaceFeatures, const FontVariantSettings* fontFaceVariantSettings, FontSelectionSpecifiedCapabilities fontFaceCapabilities, bool checkingAlternateName)</span>
  {
      if (!m_purgeTimer.isActive())
          m_purgeTimer.startOneShot(0_s);
  
<span class="line-modified">!     if (auto* platformData = getCachedFontPlatformData(fontDescription, family, fontFaceFeatures, fontFaceVariantSettings, fontFaceCapabilities, checkingAlternateName))</span>
          return fontForPlatformData(*platformData);
  
      return nullptr;
  }
  
<span class="line-new-header">--- 310,16 ---</span>
  #endif
  
  const unsigned cMaxUnderMemoryPressureInactiveFontData = 50;
  const unsigned cTargetUnderMemoryPressureInactiveFontData = 30;
  
<span class="line-modified">! RefPtr&lt;Font&gt; FontCache::fontForFamily(const FontDescription&amp; fontDescription, const AtomString&amp; family, const FontFeatureSettings* fontFaceFeatures, FontSelectionSpecifiedCapabilities fontFaceCapabilities, bool checkingAlternateName)</span>
  {
      if (!m_purgeTimer.isActive())
          m_purgeTimer.startOneShot(0_s);
  
<span class="line-modified">!     if (auto* platformData = getCachedFontPlatformData(fontDescription, family, fontFaceFeatures, fontFaceCapabilities, checkingAlternateName))</span>
          return fontForPlatformData(*platformData);
  
      return nullptr;
  }
  
</pre>
<center><a href="Font.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="FontCache.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>