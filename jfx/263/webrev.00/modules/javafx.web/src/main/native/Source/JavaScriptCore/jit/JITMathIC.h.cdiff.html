<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/jit/JITMathIC.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JITLeftShiftGenerator.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JITMulGenerator.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/jit/JITMathIC.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 50,15 ***</span>
      bool shouldSlowPathRepatch;
  };
  
  #define ENABLE_MATH_IC_STATS 0
  
<span class="line-modified">! template &lt;typename GeneratorType, bool(*isProfileEmpty)(ArithProfile&amp;)&gt;</span>
  class JITMathIC {
      WTF_MAKE_FAST_ALLOCATED;
  public:
<span class="line-modified">!     JITMathIC(ArithProfile* arithProfile)</span>
          : m_arithProfile(arithProfile)
      {
      }
  
      CodeLocationLabel&lt;JSInternalPtrTag&gt; doneLocation() { return m_inlineEnd; }
<span class="line-new-header">--- 50,15 ---</span>
      bool shouldSlowPathRepatch;
  };
  
  #define ENABLE_MATH_IC_STATS 0
  
<span class="line-modified">! template &lt;typename GeneratorType, typename ArithProfileType&gt;</span>
  class JITMathIC {
      WTF_MAKE_FAST_ALLOCATED;
  public:
<span class="line-modified">!     JITMathIC(ArithProfileType* arithProfile)</span>
          : m_arithProfile(arithProfile)
      {
      }
  
      CodeLocationLabel&lt;JSInternalPtrTag&gt; doneLocation() { return m_inlineEnd; }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 68,25 ***</span>
      bool generateInline(CCallHelpers&amp; jit, MathICGenerationState&amp; state, bool shouldEmitProfiling = true)
      {
          state.fastPathStart = jit.label();
          size_t startSize = jit.m_assembler.buffer().codeSize();
  
<span class="line-modified">!         if (m_arithProfile) {</span>
<span class="line-modified">!             if (isProfileEmpty(*m_arithProfile)) {</span>
<span class="line-modified">!                 // It looks like the MathIC has yet to execute. We don&#39;t want to emit code in this</span>
<span class="line-modified">!                 // case for a couple reasons. First, the operation may never execute, so if we don&#39;t emit</span>
<span class="line-modified">!                 // code, it&#39;s a win. Second, if the operation does execute, we can emit better code</span>
<span class="line-modified">!                 // once we have an idea about the types.</span>
<span class="line-modified">!                 state.slowPathJumps.append(jit.patchableJump());</span>
<span class="line-modified">!                 size_t inlineSize = jit.m_assembler.buffer().codeSize() - startSize;</span>
<span class="line-modified">!                 ASSERT_UNUSED(inlineSize, static_cast&lt;ptrdiff_t&gt;(inlineSize) &lt;= MacroAssembler::patchableJumpSize());</span>
<span class="line-modified">!                 state.shouldSlowPathRepatch = true;</span>
<span class="line-modified">!                 state.fastPathEnd = jit.label();</span>
<span class="line-modified">!                 ASSERT(!m_generateFastPathOnRepatch); // We should have gathered some observed type info about the types before trying to regenerate again.</span>
<span class="line-modified">!                 m_generateFastPathOnRepatch = true;</span>
<span class="line-removed">-                 return true;</span>
<span class="line-removed">-             }</span>
          }
  
          JITMathICInlineResult result = m_generator.generateInline(jit, state, m_arithProfile);
  
          switch (result) {
<span class="line-new-header">--- 68,23 ---</span>
      bool generateInline(CCallHelpers&amp; jit, MathICGenerationState&amp; state, bool shouldEmitProfiling = true)
      {
          state.fastPathStart = jit.label();
          size_t startSize = jit.m_assembler.buffer().codeSize();
  
<span class="line-modified">!         if (m_arithProfile &amp;&amp; m_arithProfile-&gt;isObservedTypeEmpty()) {</span>
<span class="line-modified">!             // It looks like the MathIC has yet to execute. We don&#39;t want to emit code in this</span>
<span class="line-modified">!             // case for a couple reasons. First, the operation may never execute, so if we don&#39;t emit</span>
<span class="line-modified">!             // code, it&#39;s a win. Second, if the operation does execute, we can emit better code</span>
<span class="line-modified">!             // once we have an idea about the types.</span>
<span class="line-modified">!             state.slowPathJumps.append(jit.patchableJump());</span>
<span class="line-modified">!             size_t inlineSize = jit.m_assembler.buffer().codeSize() - startSize;</span>
<span class="line-modified">!             ASSERT_UNUSED(inlineSize, static_cast&lt;ptrdiff_t&gt;(inlineSize) &lt;= MacroAssembler::patchableJumpSize());</span>
<span class="line-modified">!             state.shouldSlowPathRepatch = true;</span>
<span class="line-modified">!             state.fastPathEnd = jit.label();</span>
<span class="line-modified">!             ASSERT(!m_generateFastPathOnRepatch); // We should have gathered some observed type info about the types before trying to regenerate again.</span>
<span class="line-modified">!             m_generateFastPathOnRepatch = true;</span>
<span class="line-modified">!             return true;</span>
          }
  
          JITMathICInlineResult result = m_generator.generateInline(jit, state, m_arithProfile);
  
          switch (result) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 221,11 ***</span>
  
          m_slowPathCallLocation = linkBuffer.locationOf&lt;JSInternalPtrTag&gt;(state.slowPathCall);
          m_slowPathStartLocation = linkBuffer.locationOf&lt;JSInternalPtrTag&gt;(state.slowPathStart);
      }
  
<span class="line-modified">!     ArithProfile* arithProfile() const { return m_arithProfile; }</span>
  
  #if ENABLE(MATH_IC_STATS)
      size_t m_generatedCodeSize { 0 };
      size_t codeSize() const
      {
<span class="line-new-header">--- 219,11 ---</span>
  
          m_slowPathCallLocation = linkBuffer.locationOf&lt;JSInternalPtrTag&gt;(state.slowPathCall);
          m_slowPathStartLocation = linkBuffer.locationOf&lt;JSInternalPtrTag&gt;(state.slowPathStart);
      }
  
<span class="line-modified">!     ArithProfileType* arithProfile() const { return m_arithProfile; }</span>
  
  #if ENABLE(MATH_IC_STATS)
      size_t m_generatedCodeSize { 0 };
      size_t codeSize() const
      {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 234,47 ***</span>
              result += m_code.size();
          return result;
      }
  #endif
  
<span class="line-modified">!     ArithProfile* m_arithProfile;</span>
      MacroAssemblerCodeRef&lt;JITStubRoutinePtrTag&gt; m_code;
      CodeLocationLabel&lt;JSInternalPtrTag&gt; m_inlineStart;
      CodeLocationLabel&lt;JSInternalPtrTag&gt; m_inlineEnd;
      CodeLocationLabel&lt;JSInternalPtrTag&gt; m_slowPathCallLocation;
      CodeLocationLabel&lt;JSInternalPtrTag&gt; m_slowPathStartLocation;
      bool m_generateFastPathOnRepatch { false };
      GeneratorType m_generator;
  };
  
<span class="line-removed">- inline bool isBinaryProfileEmpty(ArithProfile&amp; arithProfile)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     return arithProfile.lhsObservedType().isEmpty() || arithProfile.rhsObservedType().isEmpty();</span>
<span class="line-removed">- }</span>
  template &lt;typename GeneratorType&gt;
<span class="line-modified">! class JITBinaryMathIC : public JITMathIC&lt;GeneratorType, isBinaryProfileEmpty&gt; {</span>
  public:
<span class="line-modified">!     JITBinaryMathIC(ArithProfile* arithProfile)</span>
<span class="line-modified">!         : JITMathIC&lt;GeneratorType, isBinaryProfileEmpty&gt;(arithProfile)</span>
      {
      }
  };
  
  typedef JITBinaryMathIC&lt;JITAddGenerator&gt; JITAddIC;
  typedef JITBinaryMathIC&lt;JITMulGenerator&gt; JITMulIC;
  typedef JITBinaryMathIC&lt;JITSubGenerator&gt; JITSubIC;
  
<span class="line-removed">- </span>
<span class="line-removed">- inline bool isUnaryProfileEmpty(ArithProfile&amp; arithProfile)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     return arithProfile.lhsObservedType().isEmpty();</span>
<span class="line-removed">- }</span>
  template &lt;typename GeneratorType&gt;
<span class="line-modified">! class JITUnaryMathIC : public JITMathIC&lt;GeneratorType, isUnaryProfileEmpty&gt; {</span>
  public:
<span class="line-modified">!     JITUnaryMathIC(ArithProfile* arithProfile)</span>
<span class="line-modified">!         : JITMathIC&lt;GeneratorType, isUnaryProfileEmpty&gt;(arithProfile)</span>
      {
      }
  };
  
  typedef JITUnaryMathIC&lt;JITNegGenerator&gt; JITNegIC;
<span class="line-new-header">--- 232,38 ---</span>
              result += m_code.size();
          return result;
      }
  #endif
  
<span class="line-modified">!     ArithProfileType* m_arithProfile;</span>
      MacroAssemblerCodeRef&lt;JITStubRoutinePtrTag&gt; m_code;
      CodeLocationLabel&lt;JSInternalPtrTag&gt; m_inlineStart;
      CodeLocationLabel&lt;JSInternalPtrTag&gt; m_inlineEnd;
      CodeLocationLabel&lt;JSInternalPtrTag&gt; m_slowPathCallLocation;
      CodeLocationLabel&lt;JSInternalPtrTag&gt; m_slowPathStartLocation;
      bool m_generateFastPathOnRepatch { false };
      GeneratorType m_generator;
  };
  
  template &lt;typename GeneratorType&gt;
<span class="line-modified">! class JITBinaryMathIC : public JITMathIC&lt;GeneratorType, BinaryArithProfile&gt; {</span>
  public:
<span class="line-modified">!     JITBinaryMathIC(BinaryArithProfile* arithProfile)</span>
<span class="line-modified">!         : JITMathIC&lt;GeneratorType, BinaryArithProfile&gt;(arithProfile)</span>
      {
      }
  };
  
  typedef JITBinaryMathIC&lt;JITAddGenerator&gt; JITAddIC;
  typedef JITBinaryMathIC&lt;JITMulGenerator&gt; JITMulIC;
  typedef JITBinaryMathIC&lt;JITSubGenerator&gt; JITSubIC;
  
  template &lt;typename GeneratorType&gt;
<span class="line-modified">! class JITUnaryMathIC : public JITMathIC&lt;GeneratorType, UnaryArithProfile&gt; {</span>
  public:
<span class="line-modified">!     JITUnaryMathIC(UnaryArithProfile* arithProfile)</span>
<span class="line-modified">!         : JITMathIC&lt;GeneratorType, UnaryArithProfile&gt;(arithProfile)</span>
      {
      }
  };
  
  typedef JITUnaryMathIC&lt;JITNegGenerator&gt; JITNegIC;
</pre>
<center><a href="JITLeftShiftGenerator.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JITMulGenerator.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>