<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/InspectorNetworkAgent.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InspectorMemoryAgent.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="InspectorNetworkAgent.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/InspectorNetworkAgent.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,8 +1,8 @@</span>
  /*
   * Copyright (C) 2011 Google Inc. All rights reserved.
<span class="udiff-line-modified-removed">-  * Copyright (C) 2015-2018 Apple Inc. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 2015-2019 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions are
   * met:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -61,11 +61,10 @@</span>
  #include &quot;ProgressTracker.h&quot;
  #include &quot;ResourceError.h&quot;
  #include &quot;ResourceLoader.h&quot;
  #include &quot;ResourceRequest.h&quot;
  #include &quot;ResourceResponse.h&quot;
<span class="udiff-line-removed">- #include &quot;RuntimeEnabledFeatures.h&quot;</span>
  #include &quot;ScriptState.h&quot;
  #include &quot;ScriptableDocumentParser.h&quot;
  #include &quot;SubresourceLoader.h&quot;
  #include &quot;TextResourceDecoder.h&quot;
  #include &quot;ThreadableLoaderClient.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -75,20 +74,24 @@</span>
  #include &quot;WebSocketFrame.h&quot;
  #include &lt;JavaScriptCore/ContentSearchUtilities.h&gt;
  #include &lt;JavaScriptCore/IdentifiersFactory.h&gt;
  #include &lt;JavaScriptCore/InjectedScript.h&gt;
  #include &lt;JavaScriptCore/InjectedScriptManager.h&gt;
<span class="udiff-line-added">+ #include &lt;JavaScriptCore/InspectorProtocolObjects.h&gt;</span>
  #include &lt;JavaScriptCore/JSCInlines.h&gt;
  #include &lt;JavaScriptCore/ScriptCallStack.h&gt;
  #include &lt;JavaScriptCore/ScriptCallStackFactory.h&gt;
<span class="udiff-line-added">+ #include &lt;wtf/HashMap.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/HashSet.h&gt;</span>
  #include &lt;wtf/JSONValues.h&gt;
  #include &lt;wtf/Lock.h&gt;
  #include &lt;wtf/RefPtr.h&gt;
  #include &lt;wtf/Stopwatch.h&gt;
  #include &lt;wtf/persistence/PersistentEncoder.h&gt;
  #include &lt;wtf/text/Base64.h&gt;
  #include &lt;wtf/text/StringBuilder.h&gt;
<span class="udiff-line-added">+ #include &lt;wtf/text/WTFString.h&gt;</span>
  
  typedef Inspector::NetworkBackendDispatcherHandler::LoadResourceCallback LoadResourceCallback;
  
  namespace WebCore {
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -102,11 +105,11 @@</span>
      InspectorThreadableLoaderClient(RefPtr&lt;LoadResourceCallback&gt;&amp;&amp; callback)
          : m_callback(WTFMove(callback))
      {
      }
  
<span class="udiff-line-modified-removed">-     virtual ~InspectorThreadableLoaderClient() = default;</span>
<span class="udiff-line-modified-added">+     ~InspectorThreadableLoaderClient() override = default;</span>
  
      void didReceiveResponse(unsigned long, const ResourceResponse&amp; response) override
      {
          m_mimeType = response.mimeType();
          m_statusCode = response.httpStatusCode();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -296,10 +299,11 @@</span>
  }
  
  static Inspector::Protocol::Network::Response::Source responseSource(ResourceResponse::Source source)
  {
      switch (source) {
<span class="udiff-line-added">+     case ResourceResponse::Source::DOMCache:</span>
      case ResourceResponse::Source::ApplicationCache:
          // FIXME: Add support for ApplicationCache in inspector.
      case ResourceResponse::Source::Unknown:
          return Inspector::Protocol::Network::Response::Source::Unknown;
      case ResourceResponse::Source::Network:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -310,10 +314,12 @@</span>
      case ResourceResponse::Source::DiskCache:
      case ResourceResponse::Source::DiskCacheAfterValidation:
          return Inspector::Protocol::Network::Response::Source::DiskCache;
      case ResourceResponse::Source::ServiceWorker:
          return Inspector::Protocol::Network::Response::Source::ServiceWorker;
<span class="udiff-line-added">+     case ResourceResponse::Source::InspectorOverride:</span>
<span class="udiff-line-added">+         return Inspector::Protocol::Network::Response::Source::InspectorOverride;</span>
      }
  
      ASSERT_NOT_REACHED();
      return Inspector::Protocol::Network::Response::Source::Unknown;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -825,17 +831,46 @@</span>
  }
  
  void InspectorNetworkAgent::disable(ErrorString&amp;)
  {
      m_enabled = false;
<span class="udiff-line-added">+     m_interceptionEnabled = false;</span>
<span class="udiff-line-added">+     m_intercepts.clear();</span>
      m_instrumentingAgents.setInspectorNetworkAgent(nullptr);
      m_resourcesData-&gt;clear();
      m_extraRequestHeaders.clear();
  
<span class="udiff-line-added">+     continuePendingResponses();</span>
<span class="udiff-line-added">+ </span>
      setResourceCachingDisabled(false);
  }
  
<span class="udiff-line-added">+ bool InspectorNetworkAgent::shouldIntercept(URL url)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     url.removeFragmentIdentifier();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     String urlString = url.string();</span>
<span class="udiff-line-added">+     if (urlString.isEmpty())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for (auto&amp; intercept : m_intercepts) {</span>
<span class="udiff-line-added">+         auto searchStringType = intercept.isRegex ? ContentSearchUtilities::SearchStringType::Regex : ContentSearchUtilities::SearchStringType::ExactString;</span>
<span class="udiff-line-added">+         auto regex = ContentSearchUtilities::createRegularExpressionForSearchString(intercept.url, intercept.caseSensitive, searchStringType);</span>
<span class="udiff-line-added">+         if (regex.match(urlString) != -1)</span>
<span class="udiff-line-added">+             return true;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return false;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void InspectorNetworkAgent::continuePendingResponses()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     for (auto&amp; pendingInterceptResponse : m_pendingInterceptResponses.values())</span>
<span class="udiff-line-added">+         pendingInterceptResponse-&gt;respondWithOriginalResponse();</span>
<span class="udiff-line-added">+     m_pendingInterceptResponses.clear();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void InspectorNetworkAgent::setExtraHTTPHeaders(ErrorString&amp;, const JSON::Object&amp; headers)
  {
      for (auto&amp; entry : headers) {
          String stringValue;
          if (entry.value-&gt;asString(stringValue))
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -948,11 +983,11 @@</span>
      }
  
      return nullptr;
  }
  
<span class="udiff-line-modified-removed">- static JSC::JSValue webSocketAsScriptValue(JSC::ExecState&amp; state, WebSocket* webSocket)</span>
<span class="udiff-line-modified-added">+ static JSC::JSValue webSocketAsScriptValue(JSC::JSGlobalObject&amp; state, WebSocket* webSocket)</span>
  {
      JSC::JSLockHolder lock(&amp;state);
      return toJS(&amp;state, deprecatedGlobalObjectForPrototype(&amp;state), webSocket);
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -981,10 +1016,156 @@</span>
  
      String objectGroupName = objectGroup ? *objectGroup : String();
      result = injectedScript.wrapObject(webSocketAsScriptValue(state, webSocket), objectGroupName);
  }
  
<span class="udiff-line-added">+ void InspectorNetworkAgent::setInterceptionEnabled(ErrorString&amp; errorString, bool enabled)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (m_interceptionEnabled == enabled) {</span>
<span class="udiff-line-added">+         errorString = m_interceptionEnabled ? &quot;Interception already enabled&quot;_s : &quot;Interception already disabled&quot;_s;</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_interceptionEnabled = enabled;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!m_interceptionEnabled)</span>
<span class="udiff-line-added">+         continuePendingResponses();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void InspectorNetworkAgent::addInterception(ErrorString&amp; errorString, const String&amp; url, const bool* optionalCaseSensitive, const bool* optionalIsRegex, const String* networkStageString)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (networkStageString) {</span>
<span class="udiff-line-added">+         auto networkStage = Inspector::Protocol::InspectorHelpers::parseEnumValueFromString&lt;Inspector::Protocol::Network::NetworkStage&gt;(*networkStageString);</span>
<span class="udiff-line-added">+         if (!networkStage) {</span>
<span class="udiff-line-added">+             errorString = makeString(&quot;Unknown networkStage: &quot;_s, *networkStageString);</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     Intercept intercept;</span>
<span class="udiff-line-added">+     intercept.url = url;</span>
<span class="udiff-line-added">+     if (optionalCaseSensitive)</span>
<span class="udiff-line-added">+         intercept.caseSensitive = *optionalCaseSensitive;</span>
<span class="udiff-line-added">+     if (optionalIsRegex)</span>
<span class="udiff-line-added">+         intercept.isRegex = *optionalIsRegex;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // FIXME: Support intercepting requests.</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!m_intercepts.appendIfNotContains(intercept))</span>
<span class="udiff-line-added">+         errorString = &quot;Intercept for given url and given isRegex already exists&quot;_s;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void InspectorNetworkAgent::removeInterception(ErrorString&amp; errorString, const String&amp; url, const bool* optionalCaseSensitive, const bool* optionalIsRegex, const String* networkStageString)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (networkStageString) {</span>
<span class="udiff-line-added">+         auto networkStage = Inspector::Protocol::InspectorHelpers::parseEnumValueFromString&lt;Inspector::Protocol::Network::NetworkStage&gt;(*networkStageString);</span>
<span class="udiff-line-added">+         if (!networkStage) {</span>
<span class="udiff-line-added">+             errorString = makeString(&quot;Unknown networkStage: &quot;_s, *networkStageString);</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     Intercept intercept;</span>
<span class="udiff-line-added">+     intercept.url = url;</span>
<span class="udiff-line-added">+     if (optionalCaseSensitive)</span>
<span class="udiff-line-added">+         intercept.caseSensitive = *optionalCaseSensitive;</span>
<span class="udiff-line-added">+     if (optionalIsRegex)</span>
<span class="udiff-line-added">+         intercept.isRegex = *optionalIsRegex;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // FIXME: Support intercepting requests.</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!m_intercepts.removeAll(intercept))</span>
<span class="udiff-line-added">+         errorString = &quot;Missing intercept for given url and given isRegex&quot;_s;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool InspectorNetworkAgent::willInterceptRequest(const ResourceRequest&amp; request)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!m_interceptionEnabled)</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return shouldIntercept(request.url());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool InspectorNetworkAgent::shouldInterceptResponse(const ResourceResponse&amp; response)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!m_interceptionEnabled)</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return shouldIntercept(response.url());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void InspectorNetworkAgent::interceptResponse(const ResourceResponse&amp; response, unsigned long identifier, CompletionHandler&lt;void(const ResourceResponse&amp;, RefPtr&lt;SharedBuffer&gt;)&gt;&amp;&amp; handler)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(m_enabled);</span>
<span class="udiff-line-added">+     ASSERT(m_interceptionEnabled);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     String requestId = IdentifiersFactory::requestId(identifier);</span>
<span class="udiff-line-added">+     if (m_pendingInterceptResponses.contains(requestId)) {</span>
<span class="udiff-line-added">+         ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+         handler(response, nullptr);</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_pendingInterceptResponses.set(requestId, makeUnique&lt;PendingInterceptResponse&gt;(response, WTFMove(handler)));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_frontendDispatcher-&gt;responseIntercepted(requestId, buildObjectForResourceResponse(response, nullptr));</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void InspectorNetworkAgent::interceptContinue(ErrorString&amp; errorString, const String&amp; requestId)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto pendingInterceptResponse = m_pendingInterceptResponses.take(requestId);</span>
<span class="udiff-line-added">+     if (!pendingInterceptResponse) {</span>
<span class="udiff-line-added">+         errorString = &quot;Missing pending intercept response for given requestId&quot;_s;</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     pendingInterceptResponse-&gt;respondWithOriginalResponse();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void InspectorNetworkAgent::interceptWithResponse(ErrorString&amp; errorString, const String&amp; requestId, const String&amp; content, bool base64Encoded, const String* mimeType, const int* status, const String* statusText, const JSON::Object* headers)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto pendingInterceptResponse = m_pendingInterceptResponses.take(requestId);</span>
<span class="udiff-line-added">+     if (!pendingInterceptResponse) {</span>
<span class="udiff-line-added">+         errorString = &quot;Missing pending intercept response for given requestId&quot;_s;</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ResourceResponse overrideResponse(pendingInterceptResponse-&gt;originalResponse());</span>
<span class="udiff-line-added">+     overrideResponse.setSource(ResourceResponse::Source::InspectorOverride);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (status)</span>
<span class="udiff-line-added">+         overrideResponse.setHTTPStatusCode(*status);</span>
<span class="udiff-line-added">+     if (statusText)</span>
<span class="udiff-line-added">+         overrideResponse.setHTTPStatusText(*statusText);</span>
<span class="udiff-line-added">+     if (mimeType)</span>
<span class="udiff-line-added">+         overrideResponse.setMimeType(*mimeType);</span>
<span class="udiff-line-added">+     if (headers) {</span>
<span class="udiff-line-added">+         HTTPHeaderMap explicitHeaders;</span>
<span class="udiff-line-added">+         for (auto&amp; header : *headers) {</span>
<span class="udiff-line-added">+             String headerValue;</span>
<span class="udiff-line-added">+             if (header.value-&gt;asString(headerValue))</span>
<span class="udiff-line-added">+                 explicitHeaders.add(header.key, headerValue);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         overrideResponse.setHTTPHeaderFields(WTFMove(explicitHeaders));</span>
<span class="udiff-line-added">+         overrideResponse.setHTTPHeaderField(HTTPHeaderName::ContentType, overrideResponse.mimeType());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     RefPtr&lt;SharedBuffer&gt; overrideData;</span>
<span class="udiff-line-added">+     if (base64Encoded) {</span>
<span class="udiff-line-added">+         Vector&lt;uint8_t&gt; buffer;</span>
<span class="udiff-line-added">+         if (!base64Decode(content, buffer)) {</span>
<span class="udiff-line-added">+             errorString = &quot;Unable to decode given content&quot;_s;</span>
<span class="udiff-line-added">+             pendingInterceptResponse-&gt;respondWithOriginalResponse();</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         overrideData = SharedBuffer::create(WTFMove(buffer));</span>
<span class="udiff-line-added">+     } else</span>
<span class="udiff-line-added">+         overrideData = SharedBuffer::create(content.utf8().data(), content.utf8().length());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     pendingInterceptResponse-&gt;respond(overrideResponse, overrideData);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  bool InspectorNetworkAgent::shouldTreatAsText(const String&amp; mimeType)
  {
      return startsWithLettersIgnoringASCIICase(mimeType, &quot;text/&quot;)
          || MIMETypeRegistry::isSupportedJavaScriptMIMEType(mimeType)
          || MIMETypeRegistry::isSupportedJSONMIMEType(mimeType)
</pre>
<center><a href="InspectorMemoryAgent.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="InspectorNetworkAgent.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>