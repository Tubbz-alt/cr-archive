<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/inspector/InspectorCanvas.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InspectorAuditAccessibilityObject.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InspectorCanvas.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/inspector/InspectorCanvas.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -31,10 +31,11 @@</span>
  #include &quot;CanvasGradient.h&quot;
  #include &quot;CanvasPattern.h&quot;
  #include &quot;CanvasRenderingContext.h&quot;
  #include &quot;CanvasRenderingContext2D.h&quot;
  #include &quot;Document.h&quot;
<span class="udiff-line-added">+ #include &quot;Element.h&quot;</span>
  #include &quot;FloatPoint.h&quot;
  #include &quot;Gradient.h&quot;
  #include &quot;HTMLCanvasElement.h&quot;
  #include &quot;HTMLImageElement.h&quot;
  #include &quot;HTMLVideoElement.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -46,64 +47,244 @@</span>
  #include &quot;InspectorDOMAgent.h&quot;
  #include &quot;JSCanvasDirection.h&quot;
  #include &quot;JSCanvasFillRule.h&quot;
  #include &quot;JSCanvasLineCap.h&quot;
  #include &quot;JSCanvasLineJoin.h&quot;
<span class="udiff-line-added">+ #include &quot;JSCanvasRenderingContext2D.h&quot;</span>
  #include &quot;JSCanvasTextAlign.h&quot;
  #include &quot;JSCanvasTextBaseline.h&quot;
  #include &quot;JSExecState.h&quot;
<span class="udiff-line-added">+ #include &quot;JSImageBitmapRenderingContext.h&quot;</span>
  #include &quot;JSImageSmoothingQuality.h&quot;
  #include &quot;Path2D.h&quot;
  #include &quot;Pattern.h&quot;
  #include &quot;RecordingSwizzleTypes.h&quot;
  #include &quot;SVGPathUtilities.h&quot;
  #include &quot;StringAdaptors.h&quot;
<span class="udiff-line-added">+ #include &lt;JavaScriptCore/IdentifiersFactory.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;JavaScriptCore/ScriptCallStackFactory.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/Function.h&gt;</span>
<span class="udiff-line-added">+ </span>
  #if ENABLE(CSS_TYPED_OM)
  #include &quot;TypedOMCSSImageValue.h&quot;
  #endif
<span class="udiff-line-added">+ </span>
  #if ENABLE(WEBGL)
<span class="udiff-line-added">+ #include &quot;JSWebGLRenderingContext.h&quot;</span>
  #include &quot;WebGLRenderingContext.h&quot;
  #endif
<span class="udiff-line-added">+ </span>
  #if ENABLE(WEBGL2)
<span class="udiff-line-added">+ #include &quot;JSWebGL2RenderingContext.h&quot;</span>
  #include &quot;WebGL2RenderingContext.h&quot;
  #endif
<span class="udiff-line-added">+ </span>
  #if ENABLE(WEBGPU)
  #include &quot;GPUCanvasContext.h&quot;
<span class="udiff-line-added">+ #include &quot;JSWebGPUDevice.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;WebGPUDevice.h&quot;</span>
  #endif
<span class="udiff-line-removed">- #include &lt;JavaScriptCore/IdentifiersFactory.h&gt;</span>
<span class="udiff-line-removed">- #include &lt;JavaScriptCore/ScriptCallStackFactory.h&gt;</span>
<span class="udiff-line-removed">- #include &lt;wtf/Function.h&gt;</span>
  
  namespace WebCore {
  
  using namespace Inspector;
  
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+ static HTMLCanvasElement* canvasIfContextMatchesDevice(CanvasRenderingContext&amp; context, WebGPUDevice&amp; device)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (is&lt;GPUCanvasContext&gt;(context)) {</span>
<span class="udiff-line-added">+         auto&amp; contextGPU = downcast&lt;GPUCanvasContext&gt;(context);</span>
<span class="udiff-line-added">+         if (auto* webGPUSwapChain = contextGPU.swapChain()) {</span>
<span class="udiff-line-added">+             if (auto* gpuSwapChain = webGPUSwapChain-&gt;swapChain()) {</span>
<span class="udiff-line-added">+                 if (gpuSwapChain == device.device().swapChain()) {</span>
<span class="udiff-line-added">+                     if (is&lt;HTMLCanvasElement&gt;(contextGPU.canvasBase()))</span>
<span class="udiff-line-added">+                         return &amp;downcast&lt;HTMLCanvasElement&gt;(contextGPU.canvasBase());</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     return nullptr;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  Ref&lt;InspectorCanvas&gt; InspectorCanvas::create(CanvasRenderingContext&amp; context)
  {
      return adoptRef(*new InspectorCanvas(context));
  }
  
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+ Ref&lt;InspectorCanvas&gt; InspectorCanvas::create(WebGPUDevice&amp; device)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return adoptRef(*new InspectorCanvas(device));</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  InspectorCanvas::InspectorCanvas(CanvasRenderingContext&amp; context)
      : m_identifier(&quot;canvas:&quot; + IdentifiersFactory::createIdentifier())
      , m_context(context)
  {
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+     // The actual &quot;context&quot; for WebGPU is the `WebGPUDevice`, not the &lt;canvas&gt;.</span>
<span class="udiff-line-added">+     ASSERT(!is&lt;GPUCanvasContext&gt;(context));</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+ InspectorCanvas::InspectorCanvas(WebGPUDevice&amp; device)</span>
<span class="udiff-line-added">+     : m_identifier(&quot;canvas:&quot; + IdentifiersFactory::createIdentifier())</span>
<span class="udiff-line-added">+     , m_context(device)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ CanvasRenderingContext* InspectorCanvas::canvasContext() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (auto* contextWrapper = WTF::get_if&lt;std::reference_wrapper&lt;CanvasRenderingContext&gt;&gt;(m_context))</span>
<span class="udiff-line-added">+         return &amp;contextWrapper-&gt;get();</span>
<span class="udiff-line-added">+     return nullptr;</span>
  }
  
<span class="udiff-line-modified-removed">- HTMLCanvasElement* InspectorCanvas::canvasElement()</span>
<span class="udiff-line-modified-added">+ HTMLCanvasElement* InspectorCanvas::canvasElement() const</span>
  {
<span class="udiff-line-modified-removed">-     if (is&lt;HTMLCanvasElement&gt;(m_context.canvasBase()))</span>
<span class="udiff-line-modified-removed">-         return &amp;downcast&lt;HTMLCanvasElement&gt;(m_context.canvasBase());</span>
<span class="udiff-line-modified-added">+     return WTF::switchOn(m_context,</span>
<span class="udiff-line-modified-added">+         [] (std::reference_wrapper&lt;CanvasRenderingContext&gt; contextWrapper) -&gt; HTMLCanvasElement* {</span>
<span class="udiff-line-added">+             auto&amp; context = contextWrapper.get();</span>
<span class="udiff-line-added">+             if (is&lt;HTMLCanvasElement&gt;(context.canvasBase()))</span>
<span class="udiff-line-added">+                 return &amp;downcast&lt;HTMLCanvasElement&gt;(context.canvasBase());</span>
<span class="udiff-line-added">+             return nullptr;</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+         [&amp;] (std::reference_wrapper&lt;WebGPUDevice&gt; deviceWrapper) -&gt; HTMLCanvasElement* {</span>
<span class="udiff-line-added">+             auto&amp; device = deviceWrapper.get();</span>
<span class="udiff-line-added">+             {</span>
<span class="udiff-line-added">+                 LockHolder lock(CanvasRenderingContext::instancesMutex());</span>
<span class="udiff-line-added">+                 for (auto* canvasRenderingContext : CanvasRenderingContext::instances(lock)) {</span>
<span class="udiff-line-added">+                     if (auto* canvasElement = canvasIfContextMatchesDevice(*canvasRenderingContext, device))</span>
<span class="udiff-line-added">+                         return canvasElement;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return nullptr;</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+         [] (Monostate) {</span>
<span class="udiff-line-added">+             ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+             return nullptr;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     );</span>
<span class="udiff-line-added">+     return nullptr;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+ WebGPUDevice* InspectorCanvas::deviceContext() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (auto* deviceWrapper = WTF::get_if&lt;std::reference_wrapper&lt;WebGPUDevice&gt;&gt;(m_context))</span>
<span class="udiff-line-added">+         return &amp;deviceWrapper-&gt;get();</span>
      return nullptr;
  }
  
<span class="udiff-line-added">+ bool InspectorCanvas::isDeviceForCanvasContext(CanvasRenderingContext&amp; context) const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (auto* device = deviceContext())</span>
<span class="udiff-line-added">+         return canvasIfContextMatchesDevice(context, *device);</span>
<span class="udiff-line-added">+     return false;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ScriptExecutionContext* InspectorCanvas::scriptExecutionContext() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return WTF::switchOn(m_context,</span>
<span class="udiff-line-added">+         [] (std::reference_wrapper&lt;CanvasRenderingContext&gt; contextWrapper) {</span>
<span class="udiff-line-added">+             auto&amp; context = contextWrapper.get();</span>
<span class="udiff-line-added">+             return context.canvasBase().scriptExecutionContext();</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+         [] (std::reference_wrapper&lt;WebGPUDevice&gt; deviceWrapper) {</span>
<span class="udiff-line-added">+             auto&amp; device = deviceWrapper.get();</span>
<span class="udiff-line-added">+             return device.scriptExecutionContext();</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+         [] (Monostate) {</span>
<span class="udiff-line-added">+             ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+             return nullptr;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     );</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ JSC::JSValue InspectorCanvas::resolveContext(JSC::JSGlobalObject* exec) const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     JSC::JSLockHolder lock(exec);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto* globalObject = deprecatedGlobalObjectForPrototype(exec);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return WTF::switchOn(m_context,</span>
<span class="udiff-line-added">+         [&amp;] (std::reference_wrapper&lt;CanvasRenderingContext&gt; contextWrapper) {</span>
<span class="udiff-line-added">+             auto&amp; context = contextWrapper.get();</span>
<span class="udiff-line-added">+             if (is&lt;CanvasRenderingContext2D&gt;(context))</span>
<span class="udiff-line-added">+                 return toJS(exec, globalObject, downcast&lt;CanvasRenderingContext2D&gt;(context));</span>
<span class="udiff-line-added">+             if (is&lt;ImageBitmapRenderingContext&gt;(context))</span>
<span class="udiff-line-added">+                 return toJS(exec, globalObject, downcast&lt;ImageBitmapRenderingContext&gt;(context));</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGL)</span>
<span class="udiff-line-added">+             if (is&lt;WebGLRenderingContext&gt;(context))</span>
<span class="udiff-line-added">+                 return toJS(exec, globalObject, downcast&lt;WebGLRenderingContext&gt;(context));</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGL2)</span>
<span class="udiff-line-added">+             if (is&lt;WebGL2RenderingContext&gt;(context))</span>
<span class="udiff-line-added">+                 return toJS(exec, globalObject, downcast&lt;WebGL2RenderingContext&gt;(context));</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+             return JSC::JSValue();</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+         [&amp;] (std::reference_wrapper&lt;WebGPUDevice&gt; deviceWrapper) {</span>
<span class="udiff-line-added">+             return toJS(exec, globalObject, deviceWrapper.get());</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+         [] (Monostate) {</span>
<span class="udiff-line-added">+             ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+             return JSC::JSValue();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     );</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ HashSet&lt;Element*&gt; InspectorCanvas::clientNodes() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return WTF::switchOn(m_context,</span>
<span class="udiff-line-added">+         [] (std::reference_wrapper&lt;CanvasRenderingContext&gt; contextWrapper) {</span>
<span class="udiff-line-added">+             auto&amp; context = contextWrapper.get();</span>
<span class="udiff-line-added">+             return context.canvasBase().cssCanvasClients();</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+         [&amp;] (std::reference_wrapper&lt;WebGPUDevice&gt; deviceWrapper) {</span>
<span class="udiff-line-added">+             auto&amp; device = deviceWrapper.get();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             HashSet&lt;Element*&gt; canvasElementClients;</span>
<span class="udiff-line-added">+             {</span>
<span class="udiff-line-added">+                 LockHolder lock(CanvasRenderingContext::instancesMutex());</span>
<span class="udiff-line-added">+                 for (auto* canvasRenderingContext : CanvasRenderingContext::instances(lock)) {</span>
<span class="udiff-line-added">+                     if (auto* canvasElement = canvasIfContextMatchesDevice(*canvasRenderingContext, device))</span>
<span class="udiff-line-added">+                         canvasElementClients.add(canvasElement);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return canvasElementClients;</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+         [] (Monostate) {</span>
<span class="udiff-line-added">+             ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+             return HashSet&lt;Element*&gt;();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     );</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void InspectorCanvas::canvasChanged()
  {
<span class="udiff-line-modified-removed">-     if (!m_context.callTracingActive())</span>
<span class="udiff-line-modified-added">+     auto* context = canvasContext();</span>
<span class="udiff-line-added">+     ASSERT(context);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!context-&gt;callTracingActive())</span>
          return;
  
      // Since 2D contexts are able to be fully reproduced in the frontend, we don&#39;t need snapshots.
<span class="udiff-line-modified-removed">-     if (is&lt;CanvasRenderingContext2D&gt;(m_context))</span>
<span class="udiff-line-modified-added">+     if (is&lt;CanvasRenderingContext2D&gt;(context))</span>
          return;
  
      m_contentChanged = true;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -119,11 +300,15 @@</span>
      m_bufferUsed = 0;
      m_frameCount = WTF::nullopt;
      m_framesCaptured = 0;
      m_contentChanged = false;
  
<span class="udiff-line-modified-removed">-     m_context.setCallTracingActive(false);</span>
<span class="udiff-line-modified-added">+     auto* context = canvasContext();</span>
<span class="udiff-line-added">+     ASSERT(context);</span>
<span class="udiff-line-added">+     // FIXME: &lt;https://webkit.org/b/201651&gt; Web Inspector: Canvas: support canvas recordings for WebGPUDevice</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     context-&gt;setCallTracingActive(false);</span>
  }
  
  bool InspectorCanvas::hasRecordingData() const
  {
      return m_bufferUsed &gt; 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -189,18 +374,22 @@</span>
  
      m_lastRecordedAction = buildAction(name, WTFMove(parameters));
      m_bufferUsed += m_lastRecordedAction-&gt;memoryCost();
      m_currentActions-&gt;addItem(m_lastRecordedAction.get());
  
<span class="udiff-line-modified-removed">-     if (is&lt;ImageBitmapRenderingContext&gt;(m_context) &amp;&amp; shouldSnapshotBitmapRendererAction(name))</span>
<span class="udiff-line-modified-added">+     auto* context = canvasContext();</span>
<span class="udiff-line-added">+     ASSERT(context);</span>
<span class="udiff-line-added">+     // FIXME: &lt;https://webkit.org/b/201651&gt; Web Inspector: Canvas: support canvas recordings for WebGPUDevice</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (is&lt;ImageBitmapRenderingContext&gt;(context) &amp;&amp; shouldSnapshotBitmapRendererAction(name))</span>
          m_contentChanged = true;
  #if ENABLE(WEBGL)
<span class="udiff-line-modified-removed">-     else if (is&lt;WebGLRenderingContext&gt;(m_context) &amp;&amp; shouldSnapshotWebGLAction(name))</span>
<span class="udiff-line-modified-added">+     else if (is&lt;WebGLRenderingContext&gt;(context) &amp;&amp; shouldSnapshotWebGLAction(name))</span>
          m_contentChanged = true;
  #endif
  #if ENABLE(WEBGL2)
<span class="udiff-line-modified-removed">-     else if (is&lt;WebGL2RenderingContext&gt;(m_context) &amp;&amp; shouldSnapshotWebGL2Action(name))</span>
<span class="udiff-line-modified-added">+     else if (is&lt;WebGL2RenderingContext&gt;(context) &amp;&amp; shouldSnapshotWebGL2Action(name))</span>
          m_contentChanged = true;
  #endif
  }
  
  void InspectorCanvas::finalizeFrame()
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -248,67 +437,125 @@</span>
      return m_frameCount &amp;&amp; m_framesCaptured &gt;= m_frameCount.value();
  }
  
  Ref&lt;Inspector::Protocol::Canvas::Canvas&gt; InspectorCanvas::buildObjectForCanvas(bool captureBacktrace)
  {
<span class="udiff-line-modified-removed">-     Inspector::Protocol::Canvas::ContextType contextType;</span>
<span class="udiff-line-modified-removed">-     if (is&lt;CanvasRenderingContext2D&gt;(m_context))</span>
<span class="udiff-line-modified-removed">-         contextType = Inspector::Protocol::Canvas::ContextType::Canvas2D;</span>
<span class="udiff-line-modified-removed">-     else if (is&lt;ImageBitmapRenderingContext&gt;(m_context))</span>
<span class="udiff-line-modified-removed">-         contextType = Inspector::Protocol::Canvas::ContextType::BitmapRenderer;</span>
<span class="udiff-line-modified-added">+     using ContextTypeType = Optional&lt;Inspector::Protocol::Canvas::ContextType&gt;;</span>
<span class="udiff-line-modified-added">+     auto contextType = WTF::switchOn(m_context,</span>
<span class="udiff-line-modified-added">+         [] (std::reference_wrapper&lt;CanvasRenderingContext&gt; contextWrapper) -&gt; ContextTypeType {</span>
<span class="udiff-line-modified-added">+             auto&amp; context = contextWrapper.get();</span>
<span class="udiff-line-modified-added">+             if (is&lt;CanvasRenderingContext2D&gt;(context))</span>
<span class="udiff-line-added">+                 return Inspector::Protocol::Canvas::ContextType::Canvas2D;</span>
<span class="udiff-line-added">+             if (is&lt;ImageBitmapRenderingContext&gt;(context))</span>
<span class="udiff-line-added">+                 return Inspector::Protocol::Canvas::ContextType::BitmapRenderer;</span>
  #if ENABLE(WEBGL)
<span class="udiff-line-modified-removed">-     else if (is&lt;WebGLRenderingContext&gt;(m_context))</span>
<span class="udiff-line-modified-removed">-         contextType = Inspector::Protocol::Canvas::ContextType::WebGL;</span>
<span class="udiff-line-modified-added">+             if (is&lt;WebGLRenderingContext&gt;(context))</span>
<span class="udiff-line-modified-added">+                 return Inspector::Protocol::Canvas::ContextType::WebGL;</span>
  #endif
  #if ENABLE(WEBGL2)
<span class="udiff-line-modified-removed">-     else if (is&lt;WebGL2RenderingContext&gt;(m_context))</span>
<span class="udiff-line-modified-removed">-         contextType = Inspector::Protocol::Canvas::ContextType::WebGL2;</span>
<span class="udiff-line-modified-added">+             if (is&lt;WebGL2RenderingContext&gt;(context))</span>
<span class="udiff-line-modified-added">+                 return Inspector::Protocol::Canvas::ContextType::WebGL2;</span>
  #endif
<span class="udiff-line-added">+             return WTF::nullopt;</span>
<span class="udiff-line-added">+         },</span>
  #if ENABLE(WEBGPU)
<span class="udiff-line-modified-removed">-     else if (is&lt;GPUCanvasContext&gt;(m_context))</span>
<span class="udiff-line-modified-removed">-         contextType = Inspector::Protocol::Canvas::ContextType::WebGPU;</span>
<span class="udiff-line-modified-added">+         [] (std::reference_wrapper&lt;WebGPUDevice&gt;) {</span>
<span class="udiff-line-modified-added">+             return Inspector::Protocol::Canvas::ContextType::WebGPU;</span>
<span class="udiff-line-added">+         },</span>
  #endif
<span class="udiff-line-modified-removed">-     else {</span>
<span class="udiff-line-modified-added">+         [] (Monostate) {</span>
<span class="udiff-line-added">+             ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+             return WTF::nullopt;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     );</span>
<span class="udiff-line-added">+     if (!contextType) {</span>
          ASSERT_NOT_REACHED();
          contextType = Inspector::Protocol::Canvas::ContextType::Canvas2D;
      }
  
      auto canvas = Inspector::Protocol::Canvas::Canvas::create()
          .setCanvasId(m_identifier)
<span class="udiff-line-modified-removed">-         .setContextType(contextType)</span>
<span class="udiff-line-modified-added">+         .setContextType(contextType.value())</span>
          .release();
  
      if (auto* node = canvasElement()) {
          String cssCanvasName = node-&gt;document().nameForCSSCanvasElement(*node);
          if (!cssCanvasName.isEmpty())
              canvas-&gt;setCssCanvasName(cssCanvasName);
  
          // FIXME: &lt;https://webkit.org/b/178282&gt; Web Inspector: send a DOM node with each Canvas payload and eliminate Canvas.requestNode
      }
  
<span class="udiff-line-modified-removed">-     if (is&lt;ImageBitmapRenderingContext&gt;(m_context)) {</span>
<span class="udiff-line-modified-removed">-         auto contextAttributes = Inspector::Protocol::Canvas::ContextAttributes::create()</span>
<span class="udiff-line-modified-removed">-             .release();</span>
<span class="udiff-line-modified-removed">-         contextAttributes-&gt;setAlpha(downcast&lt;ImageBitmapRenderingContext&gt;(m_context).hasAlpha());</span>
<span class="udiff-line-modified-removed">-         canvas-&gt;setContextAttributes(WTFMove(contextAttributes));</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     using ContextAttributesType = RefPtr&lt;Inspector::Protocol::Canvas::ContextAttributes&gt;;</span>
<span class="udiff-line-modified-added">+     auto contextAttributes = WTF::switchOn(m_context,</span>
<span class="udiff-line-modified-added">+         [] (std::reference_wrapper&lt;CanvasRenderingContext&gt; contextWrapper) -&gt; ContextAttributesType {</span>
<span class="udiff-line-modified-added">+             auto&amp; context = contextWrapper.get();</span>
<span class="udiff-line-modified-added">+             if (is&lt;ImageBitmapRenderingContext&gt;(context)) {</span>
<span class="udiff-line-modified-added">+                 auto contextAttributesPayload = Inspector::Protocol::Canvas::ContextAttributes::create()</span>
<span class="udiff-line-added">+                     .release();</span>
<span class="udiff-line-added">+                 contextAttributesPayload-&gt;setAlpha(downcast&lt;ImageBitmapRenderingContext&gt;(context).hasAlpha());</span>
<span class="udiff-line-added">+                 return contextAttributesPayload;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
  #if ENABLE(WEBGL)
<span class="udiff-line-modified-removed">-     else if (is&lt;WebGLRenderingContextBase&gt;(m_context)) {</span>
<span class="udiff-line-modified-removed">-         if (Optional&lt;WebGLContextAttributes&gt; attributes = downcast&lt;WebGLRenderingContextBase&gt;(m_context).getContextAttributes()) {</span>
<span class="udiff-line-modified-removed">-             auto contextAttributes = Inspector::Protocol::Canvas::ContextAttributes::create()</span>
<span class="udiff-line-modified-removed">-                 .release();</span>
<span class="udiff-line-modified-removed">-             contextAttributes-&gt;setAlpha(attributes-&gt;alpha);</span>
<span class="udiff-line-modified-removed">-             contextAttributes-&gt;setDepth(attributes-&gt;depth);</span>
<span class="udiff-line-modified-removed">-             contextAttributes-&gt;setStencil(attributes-&gt;stencil);</span>
<span class="udiff-line-modified-removed">-             contextAttributes-&gt;setAntialias(attributes-&gt;antialias);</span>
<span class="udiff-line-modified-removed">-             contextAttributes-&gt;setPremultipliedAlpha(attributes-&gt;premultipliedAlpha);</span>
<span class="udiff-line-modified-removed">-             contextAttributes-&gt;setPreserveDrawingBuffer(attributes-&gt;preserveDrawingBuffer);</span>
<span class="udiff-line-modified-removed">-             contextAttributes-&gt;setFailIfMajorPerformanceCaveat(attributes-&gt;failIfMajorPerformanceCaveat);</span>
<span class="udiff-line-modified-removed">-             canvas-&gt;setContextAttributes(WTFMove(contextAttributes));</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+             if (is&lt;WebGLRenderingContextBase&gt;(context)) {</span>
<span class="udiff-line-modified-added">+                 if (const auto&amp; attributes = downcast&lt;WebGLRenderingContextBase&gt;(context).getContextAttributes()) {</span>
<span class="udiff-line-modified-added">+                     auto contextAttributesPayload = Inspector::Protocol::Canvas::ContextAttributes::create()</span>
<span class="udiff-line-modified-added">+                         .release();</span>
<span class="udiff-line-modified-added">+                     contextAttributesPayload-&gt;setAlpha(attributes-&gt;alpha);</span>
<span class="udiff-line-modified-added">+                     contextAttributesPayload-&gt;setDepth(attributes-&gt;depth);</span>
<span class="udiff-line-modified-added">+                     contextAttributesPayload-&gt;setStencil(attributes-&gt;stencil);</span>
<span class="udiff-line-modified-added">+                     contextAttributesPayload-&gt;setAntialias(attributes-&gt;antialias);</span>
<span class="udiff-line-modified-added">+                     contextAttributesPayload-&gt;setPremultipliedAlpha(attributes-&gt;premultipliedAlpha);</span>
<span class="udiff-line-modified-added">+                     contextAttributesPayload-&gt;setPreserveDrawingBuffer(attributes-&gt;preserveDrawingBuffer);</span>
<span class="udiff-line-modified-added">+                     switch (attributes-&gt;powerPreference) {</span>
<span class="udiff-line-modified-added">+                     case WebGLPowerPreference::Default:</span>
<span class="udiff-line-modified-added">+                         contextAttributesPayload-&gt;setPowerPreference(&quot;default&quot;);</span>
<span class="udiff-line-modified-added">+                         break;</span>
<span class="udiff-line-added">+                     case WebGLPowerPreference::LowPower:</span>
<span class="udiff-line-added">+                         contextAttributesPayload-&gt;setPowerPreference(&quot;low-power&quot;);</span>
<span class="udiff-line-added">+                         break;</span>
<span class="udiff-line-added">+                     case WebGLPowerPreference::HighPerformance:</span>
<span class="udiff-line-added">+                         contextAttributesPayload-&gt;setPowerPreference(&quot;high-performance&quot;);</span>
<span class="udiff-line-added">+                         break;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     contextAttributesPayload-&gt;setFailIfMajorPerformanceCaveat(attributes-&gt;failIfMajorPerformanceCaveat);</span>
<span class="udiff-line-added">+                     return contextAttributesPayload;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
  #endif
<span class="udiff-line-added">+             return nullptr;</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #if ENABLE(WEBGPU)</span>
<span class="udiff-line-added">+         [] (std::reference_wrapper&lt;WebGPUDevice&gt; deviceWrapper) -&gt; ContextAttributesType {</span>
<span class="udiff-line-added">+             auto&amp; device = deviceWrapper.get();</span>
<span class="udiff-line-added">+             if (const auto&amp; options = device.adapter().options()) {</span>
<span class="udiff-line-added">+                 auto contextAttributesPayload = Inspector::Protocol::Canvas::ContextAttributes::create()</span>
<span class="udiff-line-added">+                     .release();</span>
<span class="udiff-line-added">+                 if (const auto&amp; powerPreference = options-&gt;powerPreference) {</span>
<span class="udiff-line-added">+                     switch (powerPreference.value()) {</span>
<span class="udiff-line-added">+                     case GPUPowerPreference::LowPower:</span>
<span class="udiff-line-added">+                         contextAttributesPayload-&gt;setPowerPreference(&quot;low-power&quot;);</span>
<span class="udiff-line-added">+                         break;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                     case GPUPowerPreference::HighPerformance:</span>
<span class="udiff-line-added">+                         contextAttributesPayload-&gt;setPowerPreference(&quot;high-performance&quot;);</span>
<span class="udiff-line-added">+                         break;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 return WTFMove(contextAttributesPayload);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return nullptr;</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+         [] (Monostate) {</span>
<span class="udiff-line-added">+             ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+             return nullptr;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     );</span>
<span class="udiff-line-added">+     if (contextAttributes)</span>
<span class="udiff-line-added">+         canvas-&gt;setContextAttributes(WTFMove(contextAttributes));</span>
  
      // FIXME: &lt;https://webkit.org/b/180833&gt; Web Inspector: support OffscreenCanvas for Canvas related operations
  
      if (auto* node = canvasElement()) {
          if (size_t memoryCost = node-&gt;memoryCost())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -327,21 +574,25 @@</span>
  {
      ASSERT(!m_currentActions);
      ASSERT(!m_lastRecordedAction);
      ASSERT(!m_frames);
  
<span class="udiff-line-added">+     auto* context = canvasContext();</span>
<span class="udiff-line-added">+     ASSERT(context);</span>
<span class="udiff-line-added">+     // FIXME: &lt;https://webkit.org/b/201651&gt; Web Inspector: Canvas: support canvas recordings for WebGPUDevice</span>
<span class="udiff-line-added">+ </span>
      Inspector::Protocol::Recording::Type type;
<span class="udiff-line-modified-removed">-     if (is&lt;CanvasRenderingContext2D&gt;(m_context))</span>
<span class="udiff-line-modified-added">+     if (is&lt;CanvasRenderingContext2D&gt;(context))</span>
          type = Inspector::Protocol::Recording::Type::Canvas2D;
<span class="udiff-line-modified-removed">-     else if (is&lt;ImageBitmapRenderingContext&gt;(m_context))</span>
<span class="udiff-line-modified-added">+     else if (is&lt;ImageBitmapRenderingContext&gt;(context))</span>
          type = Inspector::Protocol::Recording::Type::CanvasBitmapRenderer;
  #if ENABLE(WEBGL)
<span class="udiff-line-modified-removed">-     else if (is&lt;WebGLRenderingContext&gt;(m_context))</span>
<span class="udiff-line-modified-added">+     else if (is&lt;WebGLRenderingContext&gt;(context))</span>
          type = Inspector::Protocol::Recording::Type::CanvasWebGL;
  #endif
  #if ENABLE(WEBGL2)
<span class="udiff-line-modified-removed">-     else if (is&lt;WebGL2RenderingContext&gt;(m_context))</span>
<span class="udiff-line-modified-added">+     else if (is&lt;WebGL2RenderingContext&gt;(context))</span>
          type = Inspector::Protocol::Recording::Type::CanvasWebGL2;
  #endif
      else {
          ASSERT_NOT_REACHED();
          type = Inspector::Protocol::Recording::Type::Canvas2D;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -362,37 +613,27 @@</span>
      return recording;
  }
  
  String InspectorCanvas::getCanvasContentAsDataURL(ErrorString&amp; errorString)
  {
<span class="udiff-line-removed">-     // FIXME: &lt;https://webkit.org/b/173621&gt; Web Inspector: Support getting the content of WebMetal context;</span>
<span class="udiff-line-removed">-     if (!is&lt;CanvasRenderingContext2D&gt;(m_context)</span>
<span class="udiff-line-removed">- #if ENABLE(WEBGL)</span>
<span class="udiff-line-removed">-         &amp;&amp; !is&lt;WebGLRenderingContextBase&gt;(m_context)</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">-         &amp;&amp; !is&lt;ImageBitmapRenderingContext&gt;(m_context)) {</span>
<span class="udiff-line-removed">-         errorString = &quot;Unsupported canvas context type&quot;_s;</span>
<span class="udiff-line-removed">-         return emptyString();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // FIXME: &lt;https://webkit.org/b/180833&gt; Web Inspector: support OffscreenCanvas for Canvas related operations</span>
      auto* node = canvasElement();
      if (!node) {
<span class="udiff-line-modified-removed">-         errorString = &quot;Context isn&#39;t related to an HTMLCanvasElement&quot;_s;</span>
<span class="udiff-line-modified-added">+         errorString = &quot;Missing HTMLCanvasElement of canvas for given canvasId&quot;_s;</span>
          return emptyString();
      }
  
  #if ENABLE(WEBGL)
<span class="udiff-line-modified-removed">-     if (is&lt;WebGLRenderingContextBase&gt;(m_context))</span>
<span class="udiff-line-modified-removed">-         downcast&lt;WebGLRenderingContextBase&gt;(m_context).setPreventBufferClearForInspector(true);</span>
<span class="udiff-line-modified-added">+     auto* context = node-&gt;renderingContext();</span>
<span class="udiff-line-modified-added">+     if (is&lt;WebGLRenderingContextBase&gt;(context))</span>
<span class="udiff-line-added">+         downcast&lt;WebGLRenderingContextBase&gt;(*context).setPreventBufferClearForInspector(true);</span>
  #endif
  
      ExceptionOr&lt;UncachedString&gt; result = node-&gt;toDataURL(&quot;image/png&quot;_s);
  
  #if ENABLE(WEBGL)
<span class="udiff-line-modified-removed">-     if (is&lt;WebGLRenderingContextBase&gt;(m_context))</span>
<span class="udiff-line-modified-removed">-         downcast&lt;WebGLRenderingContextBase&gt;(m_context).setPreventBufferClearForInspector(false);</span>
<span class="udiff-line-modified-added">+     if (is&lt;WebGLRenderingContextBase&gt;(context))</span>
<span class="udiff-line-modified-added">+         downcast&lt;WebGLRenderingContextBase&gt;(*context).setPreventBufferClearForInspector(false);</span>
  #endif
  
      if (result.hasException()) {
          errorString = result.releaseException().releaseMessage();
          return emptyString();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -514,10 +755,22 @@</span>
              array-&gt;addItem(indexForData(scriptCallFrame.sourceURL()));
              array-&gt;addItem(static_cast&lt;int&gt;(scriptCallFrame.lineNumber()));
              array-&gt;addItem(static_cast&lt;int&gt;(scriptCallFrame.columnNumber()));
              item = WTFMove(array);
          },
<span class="udiff-line-added">+ #if ENABLE(OFFSCREEN_CANVAS)</span>
<span class="udiff-line-added">+         [&amp;] (const RefPtr&lt;OffscreenCanvas&gt; offscreenCanvas) {</span>
<span class="udiff-line-added">+             String dataURL = &quot;data:,&quot;_s;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (offscreenCanvas-&gt;originClean() &amp;&amp; offscreenCanvas-&gt;hasCreatedImageBuffer()) {</span>
<span class="udiff-line-added">+                 if (auto *buffer = offscreenCanvas-&gt;buffer())</span>
<span class="udiff-line-added">+                     dataURL = buffer-&gt;toDataURL(&quot;image/png&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             index = indexForData(dataURL);</span>
<span class="udiff-line-added">+         },</span>
<span class="udiff-line-added">+ #endif</span>
          [&amp;] (const String&amp; value) { item = JSON::Value::create(value); }
      );
  
      if (item) {
          m_bufferUsed += item-&gt;memoryCost();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -556,22 +809,26 @@</span>
      return array;
  }
  
  Ref&lt;Inspector::Protocol::Recording::InitialState&gt; InspectorCanvas::buildInitialState()
  {
<span class="udiff-line-added">+     auto* context = canvasContext();</span>
<span class="udiff-line-added">+     ASSERT(context);</span>
<span class="udiff-line-added">+     // FIXME: &lt;https://webkit.org/b/201651&gt; Web Inspector: Canvas: support canvas recordings for WebGPUDevice</span>
<span class="udiff-line-added">+ </span>
      auto initialStatePayload = Inspector::Protocol::Recording::InitialState::create().release();
  
      auto attributesPayload = JSON::Object::create();
<span class="udiff-line-modified-removed">-     attributesPayload-&gt;setInteger(&quot;width&quot;_s, m_context.canvasBase().width());</span>
<span class="udiff-line-modified-removed">-     attributesPayload-&gt;setInteger(&quot;height&quot;_s, m_context.canvasBase().height());</span>
<span class="udiff-line-modified-added">+     attributesPayload-&gt;setInteger(&quot;width&quot;_s, context-&gt;canvasBase().width());</span>
<span class="udiff-line-modified-added">+     attributesPayload-&gt;setInteger(&quot;height&quot;_s, context-&gt;canvasBase().height());</span>
  
      auto statesPayload = JSON::ArrayOf&lt;JSON::Object&gt;::create();
  
      auto parametersPayload = JSON::ArrayOf&lt;JSON::Value&gt;::create();
  
<span class="udiff-line-modified-removed">-     if (is&lt;CanvasRenderingContext2D&gt;(m_context)) {</span>
<span class="udiff-line-modified-removed">-         auto&amp; context2d = downcast&lt;CanvasRenderingContext2D&gt;(m_context);</span>
<span class="udiff-line-modified-added">+     if (is&lt;CanvasRenderingContext2D&gt;(context)) {</span>
<span class="udiff-line-modified-added">+         auto&amp; context2d = downcast&lt;CanvasRenderingContext2D&gt;(*context);</span>
          for (auto&amp; state : context2d.stateStack()) {
              auto statePayload = JSON::Object::create();
  
              statePayload-&gt;setArray(stringIndexForKey(&quot;setTransform&quot;_s), buildArrayForAffineTransform(state.transform));
              statePayload-&gt;setDouble(stringIndexForKey(&quot;globalAlpha&quot;_s), context2d.globalAlpha());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -624,12 +881,12 @@</span>
  
              statesPayload-&gt;addItem(WTFMove(statePayload));
          }
      }
  #if ENABLE(WEBGL)
<span class="udiff-line-modified-removed">-     else if (is&lt;WebGLRenderingContextBase&gt;(m_context)) {</span>
<span class="udiff-line-modified-removed">-         WebGLRenderingContextBase&amp; contextWebGLBase = downcast&lt;WebGLRenderingContextBase&gt;(m_context);</span>
<span class="udiff-line-modified-added">+     else if (is&lt;WebGLRenderingContextBase&gt;(context)) {</span>
<span class="udiff-line-modified-added">+         auto&amp; contextWebGLBase = downcast&lt;WebGLRenderingContextBase&gt;(*context);</span>
          if (Optional&lt;WebGLContextAttributes&gt; webGLContextAttributes = contextWebGLBase.getContextAttributes()) {
              auto webGLContextAttributesPayload = JSON::Object::create();
              webGLContextAttributesPayload-&gt;setBoolean(&quot;alpha&quot;_s, webGLContextAttributes-&gt;alpha);
              webGLContextAttributesPayload-&gt;setBoolean(&quot;depth&quot;_s, webGLContextAttributes-&gt;depth);
              webGLContextAttributesPayload-&gt;setBoolean(&quot;stencil&quot;_s, webGLContextAttributes-&gt;stencil);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -786,10 +1043,16 @@</span>
              },
              [&amp;] (const RefPtr&lt;HTMLImageElement&gt;&amp; value) {
                  if (value)
                      addParameter(indexForData(value), RecordingSwizzleTypes::Image);
              },
<span class="udiff-line-added">+ #if ENABLE(OFFSCREEN_CANVAS)</span>
<span class="udiff-line-added">+             [&amp;] (const RefPtr&lt;OffscreenCanvas&gt;&amp; value) {</span>
<span class="udiff-line-added">+                 if (value)</span>
<span class="udiff-line-added">+                     addParameter(indexForData(value), RecordingSwizzleTypes::Image);</span>
<span class="udiff-line-added">+             },</span>
<span class="udiff-line-added">+ #endif</span>
  #if ENABLE(VIDEO)
              [&amp;] (const RefPtr&lt;HTMLVideoElement&gt;&amp; value) {
                  if (value)
                      addParameter(indexForData(value), RecordingSwizzleTypes::Image);
              },
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -817,11 +1080,11 @@</span>
                      addParameter(0, RecordingSwizzleTypes::TypedArray);
              },
              [&amp;] (const CanvasImageSource&amp; value) {
                  WTF::visit(parseParameter, value);
              },
<span class="udiff-line-modified-removed">-             [&amp;] (const CanvasRenderingContext2DBase::Style&amp; value) {</span>
<span class="udiff-line-modified-added">+             [&amp;] (const CanvasRenderingContext2DBase::StyleVariant&amp; value) {</span>
                  WTF::visit(parseParameter, value);
              },
  #if ENABLE(WEBGL)
              [&amp;] (const WebGLRenderingContextBase::BufferDataSource&amp; value) {
                  WTF::visit(parseParameter, value);
</pre>
<center><a href="InspectorAuditAccessibilityObject.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InspectorCanvas.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>