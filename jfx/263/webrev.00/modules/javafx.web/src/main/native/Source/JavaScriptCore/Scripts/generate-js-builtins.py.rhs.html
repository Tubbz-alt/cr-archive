<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/Scripts/generate-js-builtins.py</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 #!/usr/bin/env python
  2 #
  3 # Copyright (c) 2014, 2015 Apple Inc. All rights reserved.
  4 # Copyright (c) 2014 University of Washington. All rights reserved.
  5 #
  6 # Redistribution and use in source and binary forms, with or without
  7 # modification, are permitted provided that the following conditions
  8 # are met:
  9 # 1. Redistributions of source code must retain the above copyright
 10 #    notice, this list of conditions and the following disclaimer.
 11 # 2. Redistributions in binary form must reproduce the above copyright
 12 #    notice, this list of conditions and the following disclaimer in the
 13 #    documentation and/or other materials provided with the distribution.
 14 #
 15 # THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 16 # AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 17 # THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 18 # PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 19 # BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 20 # CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 21 # SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 22 # INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 23 # CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 24 # ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 25 # THE POSSIBILITY OF SUCH DAMAGE.
 26 
 27 # This script generates C++ bindings for JavaScript builtins.
 28 # Generators for individual files are located in the builtins/ directory.
 29 
 30 import fnmatch
 31 import logging
 32 import optparse
 33 import os
 34 import sys
 35 
 36 logging.basicConfig(format=&#39;%(levelname)s: %(message)s&#39;, level=logging.ERROR)
 37 log = logging.getLogger(&#39;global&#39;)
 38 
 39 from lazywriter import LazyFileWriter
 40 
 41 from wkbuiltins import *
 42 
 43 
 44 def concatenated_output_filename(builtins_files, framework_name, generate_only_wrapper_files):
 45     if generate_only_wrapper_files:
 46         return framework_name + &#39;JSBuiltins.h-result&#39;
 47     return os.path.basename(builtins_files[0]) + &#39;-result&#39;
 48 
 49 
 50 def do_open(file, mode):
 51     if sys.version_info.major == 2:
 52         return open(file, mode)
 53     else:
 54         return open(file, mode, encoding=&quot;UTF-8&quot;)
 55 
 56 def generate_bindings_for_builtins_files(builtins_files=[],
 57                                          output_path=None,
 58                                          concatenate_output=False,
 59                                          combined_output=False,
 60                                          generate_only_wrapper_files=False,
 61                                          framework_name=&quot;&quot;,
 62                                          force_output=False):
 63 
 64     generators = []
 65 
 66     model = BuiltinsCollection(framework_name=framework_name)
 67 
 68     for filepath in builtins_files:
 69         with do_open(filepath, &quot;r&quot;) as file:
 70             file_text = file.read()
 71             file_name = os.path.basename(filepath)
 72 
 73             # If this is a test file, then rewrite the filename to remove the
 74             # test running options encoded into the filename.
 75             if file_name.startswith(framework_name):
 76                 (_, object_name, _) = file_name.split(&#39;-&#39;)
 77                 file_name = object_name + &#39;.js&#39;
 78             model.parse_builtins_file(file_name, file_text)
 79 
 80     if combined_output:
 81         log.debug(&quot;Using generator style: combined files for all builtins.&quot;)
 82         generators.append(BuiltinsCombinedHeaderGenerator(model))
 83         generators.append(BuiltinsCombinedImplementationGenerator(model))
 84     else:
 85         log.debug(&quot;Using generator style: single files for each builtin.&quot;)
 86         if generate_only_wrapper_files:
 87             generators.append(BuiltinsWrapperHeaderGenerator(model))
 88             generators.append(BuiltinsWrapperImplementationGenerator(model))
 89 
 90             generators.append(BuiltinsInternalsWrapperHeaderGenerator(model))
 91             generators.append(BuiltinsInternalsWrapperImplementationGenerator(model))
 92         else:
 93             for object in model.objects:
 94                 generators.append(BuiltinsSeparateHeaderGenerator(model, object))
 95                 generators.append(BuiltinsSeparateImplementationGenerator(model, object))
 96 
 97     log.debug(&quot;&quot;)
 98     log.debug(&quot;Generating bindings for builtins.&quot;)
 99 
100     test_result_file_contents = []
101 
102     for generator in generators:
103         output_filepath = os.path.join(output_path, generator.output_filename())
104         log.debug(&quot;Generating output file: %s&quot; % generator.output_filename())
105         output = generator.generate_output()
106 
107         log.debug(&quot;---&quot;)
108         log.debug(&quot;\n&quot; + output)
109         log.debug(&quot;---&quot;)
110         if concatenate_output:
111             test_result_file_contents.append(&#39;### Begin File: %s&#39; % generator.output_filename())
112             test_result_file_contents.append(output)
113             test_result_file_contents.append(&#39;### End File: %s&#39; % generator.output_filename())
114             test_result_file_contents.append(&#39;&#39;)
115         else:
116             log.debug(&quot;Writing file: %s&quot; % output_filepath)
117             output_file = LazyFileWriter(output_filepath, force_output)
118             output_file.write(output)
119             output_file.close()
120 
121     if concatenate_output:
122         filename = concatenated_output_filename(builtins_files, framework_name, generate_only_wrapper_files)
123         output_filepath = os.path.join(output_path, filename)
124         log.debug(&quot;Writing file: %s&quot; % output_filepath)
125         output_file = LazyFileWriter(output_filepath, force_output)
126         output_file.write(&#39;\n&#39;.join(test_result_file_contents))
127         output_file.close()
128 
129 if __name__ == &#39;__main__&#39;:
130     allowed_framework_names = [&#39;JavaScriptCore&#39;, &#39;WebCore&#39;]
131     cli_parser = optparse.OptionParser(usage=&quot;usage: %prog [options] Builtin1.js [, Builtin2.js, ...]&quot;)
132     cli_parser.add_option(&quot;-i&quot;, &quot;--input-directory&quot;, help=&quot;If specified, generates builtins from all JavaScript files in the specified directory in addition to specific files passed as arguments.&quot;)
133     cli_parser.add_option(&quot;-o&quot;, &quot;--output-directory&quot;, help=&quot;Directory where generated files should be written.&quot;)
134     cli_parser.add_option(&quot;--framework&quot;, type=&quot;choice&quot;, choices=allowed_framework_names, help=&quot;Destination framework for generated files.&quot;)
135     cli_parser.add_option(&quot;--force&quot;, action=&quot;store_true&quot;, help=&quot;Force output of generated scripts, even if nothing changed.&quot;)
136     cli_parser.add_option(&quot;--combined&quot;, action=&quot;store_true&quot;, help=&quot;Produce one .h/.cpp file instead of producing one per builtin object.&quot;)
137     cli_parser.add_option(&quot;--wrappers-only&quot;, action=&quot;store_true&quot;, help=&quot;Produce .h/.cpp wrapper files to ease integration of the builtins.&quot;)
138     cli_parser.add_option(&quot;-v&quot;, &quot;--debug&quot;, action=&quot;store_true&quot;, help=&quot;Log extra output for debugging the generator itself.&quot;)
139     cli_parser.add_option(&quot;-t&quot;, &quot;--test&quot;, action=&quot;store_true&quot;, help=&quot;Enable test mode.&quot;)
140 
141     arg_options, arg_values = cli_parser.parse_args()
<a name="1" id="anc1"></a><span class="line-modified">142     if len(arg_values) == 0 and not arg_options.input_directory:</span>
143         raise ParseException(&quot;At least one input file or directory expected.&quot;)
144 
145     if not arg_options.output_directory:
146         raise ParseException(&quot;Missing output directory.&quot;)
147 
148     if arg_options.debug:
149         log.setLevel(logging.DEBUG)
150 
151     input_filepaths = arg_values[:]
152     if arg_options.input_directory:
153         for filepath in os.listdir(arg_options.input_directory):
154             input_filepaths.append(os.path.join(arg_options.input_directory, filepath))
155 
156     input_filepaths = sorted([name for name in input_filepaths if fnmatch.fnmatch(name, &#39;*.js&#39;)])
157 
158     options = {
159         &#39;output_path&#39;: arg_options.output_directory,
160         &#39;framework_name&#39;: arg_options.framework,
161         &#39;combined_output&#39;: arg_options.combined,
162         &#39;generate_only_wrapper_files&#39;: arg_options.wrappers_only,
163         &#39;force_output&#39;: arg_options.force,
164         &#39;concatenate_output&#39;: arg_options.test,
165     }
166 
167     log.debug(&quot;Generating code for builtins.&quot;)
168     log.debug(&quot;Parsed options:&quot;)
169     for option, value in list(options.items()):
170         log.debug(&quot;    %s: %s&quot; % (option, value))
171     log.debug(&quot;&quot;)
172     log.debug(&quot;Input files:&quot;)
173     for filepath in input_filepaths:
174         log.debug(&quot;    %s&quot; % filepath)
175     log.debug(&quot;&quot;)
176 
177     try:
178         generate_bindings_for_builtins_files(builtins_files=input_filepaths, **options)
179     except ParseException as e:
180         if arg_options.test:
181             log.error(e.message)
182         else:
183             raise  # Force the build to fail.
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>