<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/bmalloc/bmalloc/CryptoRandom.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Chunk.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Deallocator.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/bmalloc/bmalloc/CryptoRandom.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 44 #endif
 45 
 46 #if BOS(DARWIN)
 47 #include &lt;CommonCrypto/CommonCryptoError.h&gt;
 48 #include &lt;CommonCrypto/CommonRandom.h&gt;
 49 #endif
 50 
 51 namespace bmalloc {
 52 
 53 class ARC4Stream {
 54 public:
 55     ARC4Stream();
 56 
 57     uint8_t i;
 58     uint8_t j;
 59     uint8_t s[256];
 60 };
 61 
 62 class ARC4RandomNumberGenerator : public StaticPerProcess&lt;ARC4RandomNumberGenerator&gt; {
 63 public:
<span class="line-modified"> 64     ARC4RandomNumberGenerator(const std::lock_guard&lt;Mutex&gt;&amp;);</span>
 65 
 66     uint32_t randomNumber();
 67     void randomValues(void* buffer, size_t length);
 68 
 69 private:
 70     inline void addRandomData(unsigned char *data, int length);
 71     void stir();
 72     void stirIfNeeded();
 73     inline uint8_t getByte();
 74 
 75     ARC4Stream m_stream;
 76     int m_count;
 77 };
 78 DECLARE_STATIC_PER_PROCESS_STORAGE(ARC4RandomNumberGenerator);
 79 DEFINE_STATIC_PER_PROCESS_STORAGE(ARC4RandomNumberGenerator);
 80 
 81 ARC4Stream::ARC4Stream()
 82 {
 83     for (int n = 0; n &lt; 256; n++)
 84         s[n] = n;
 85     i = 0;
 86     j = 0;
 87 }
 88 
<span class="line-modified"> 89 ARC4RandomNumberGenerator::ARC4RandomNumberGenerator(const std::lock_guard&lt;Mutex&gt;&amp;)</span>
 90     : m_count(0)
 91 {
 92 }
 93 
 94 void ARC4RandomNumberGenerator::addRandomData(unsigned char* data, int length)
 95 {
 96     m_stream.i--;
 97     for (int n = 0; n &lt; 256; n++) {
 98         m_stream.i++;
 99         uint8_t si = m_stream.s[m_stream.i];
100         m_stream.j += si + data[n % length];
101         m_stream.s[m_stream.i] = m_stream.s[m_stream.j];
102         m_stream.s[m_stream.j] = si;
103     }
104     m_stream.j = m_stream.i;
105 }
106 
107 void ARC4RandomNumberGenerator::stir()
108 {
109     unsigned char randomness[128];
</pre>
<hr />
<pre>
147 
148 void ARC4RandomNumberGenerator::stirIfNeeded()
149 {
150     if (m_count &lt;= 0)
151         stir();
152 }
153 
154 uint8_t ARC4RandomNumberGenerator::getByte()
155 {
156     m_stream.i++;
157     uint8_t si = m_stream.s[m_stream.i];
158     m_stream.j += si;
159     uint8_t sj = m_stream.s[m_stream.j];
160     m_stream.s[m_stream.i] = sj;
161     m_stream.s[m_stream.j] = si;
162     return (m_stream.s[(si + sj) &amp; 0xff]);
163 }
164 
165 void ARC4RandomNumberGenerator::randomValues(void* buffer, size_t length)
166 {
<span class="line-modified">167     std::lock_guard&lt;Mutex&gt; lock(mutex());</span>
168 
169     unsigned char* result = reinterpret_cast&lt;unsigned char*&gt;(buffer);
170     stirIfNeeded();
171     while (length--) {
172         m_count--;
173         stirIfNeeded();
174         result[length] = getByte();
175     }
176 }
177 
178 void cryptoRandom(void* buffer, size_t length)
179 {
180     ARC4RandomNumberGenerator::get()-&gt;randomValues(buffer, length);
181 }
182 
183 } // namespace bmalloc
184 
</pre>
</td>
<td>
<hr />
<pre>
 44 #endif
 45 
 46 #if BOS(DARWIN)
 47 #include &lt;CommonCrypto/CommonCryptoError.h&gt;
 48 #include &lt;CommonCrypto/CommonRandom.h&gt;
 49 #endif
 50 
 51 namespace bmalloc {
 52 
 53 class ARC4Stream {
 54 public:
 55     ARC4Stream();
 56 
 57     uint8_t i;
 58     uint8_t j;
 59     uint8_t s[256];
 60 };
 61 
 62 class ARC4RandomNumberGenerator : public StaticPerProcess&lt;ARC4RandomNumberGenerator&gt; {
 63 public:
<span class="line-modified"> 64     ARC4RandomNumberGenerator(const LockHolder&amp;);</span>
 65 
 66     uint32_t randomNumber();
 67     void randomValues(void* buffer, size_t length);
 68 
 69 private:
 70     inline void addRandomData(unsigned char *data, int length);
 71     void stir();
 72     void stirIfNeeded();
 73     inline uint8_t getByte();
 74 
 75     ARC4Stream m_stream;
 76     int m_count;
 77 };
 78 DECLARE_STATIC_PER_PROCESS_STORAGE(ARC4RandomNumberGenerator);
 79 DEFINE_STATIC_PER_PROCESS_STORAGE(ARC4RandomNumberGenerator);
 80 
 81 ARC4Stream::ARC4Stream()
 82 {
 83     for (int n = 0; n &lt; 256; n++)
 84         s[n] = n;
 85     i = 0;
 86     j = 0;
 87 }
 88 
<span class="line-modified"> 89 ARC4RandomNumberGenerator::ARC4RandomNumberGenerator(const LockHolder&amp;)</span>
 90     : m_count(0)
 91 {
 92 }
 93 
 94 void ARC4RandomNumberGenerator::addRandomData(unsigned char* data, int length)
 95 {
 96     m_stream.i--;
 97     for (int n = 0; n &lt; 256; n++) {
 98         m_stream.i++;
 99         uint8_t si = m_stream.s[m_stream.i];
100         m_stream.j += si + data[n % length];
101         m_stream.s[m_stream.i] = m_stream.s[m_stream.j];
102         m_stream.s[m_stream.j] = si;
103     }
104     m_stream.j = m_stream.i;
105 }
106 
107 void ARC4RandomNumberGenerator::stir()
108 {
109     unsigned char randomness[128];
</pre>
<hr />
<pre>
147 
148 void ARC4RandomNumberGenerator::stirIfNeeded()
149 {
150     if (m_count &lt;= 0)
151         stir();
152 }
153 
154 uint8_t ARC4RandomNumberGenerator::getByte()
155 {
156     m_stream.i++;
157     uint8_t si = m_stream.s[m_stream.i];
158     m_stream.j += si;
159     uint8_t sj = m_stream.s[m_stream.j];
160     m_stream.s[m_stream.i] = sj;
161     m_stream.s[m_stream.j] = si;
162     return (m_stream.s[(si + sj) &amp; 0xff]);
163 }
164 
165 void ARC4RandomNumberGenerator::randomValues(void* buffer, size_t length)
166 {
<span class="line-modified">167     LockHolder lock(mutex());</span>
168 
169     unsigned char* result = reinterpret_cast&lt;unsigned char*&gt;(buffer);
170     stirIfNeeded();
171     while (length--) {
172         m_count--;
173         stirIfNeeded();
174         result[length] = getByte();
175     }
176 }
177 
178 void cryptoRandom(void* buffer, size_t length)
179 {
180     ARC4RandomNumberGenerator::get()-&gt;randomValues(buffer, length);
181 }
182 
183 } // namespace bmalloc
184 
</pre>
</td>
</tr>
</table>
<center><a href="Chunk.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Deallocator.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>