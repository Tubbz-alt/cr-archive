<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/webdatabase/DatabaseManager.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DatabaseDetails.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="DatabaseTask.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/webdatabase/DatabaseManager.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;DatabaseManager.h&quot;
 28 
 29 #include &quot;Database.h&quot;
 30 #include &quot;DatabaseCallback.h&quot;
 31 #include &quot;DatabaseContext.h&quot;
 32 #include &quot;DatabaseTask.h&quot;
 33 #include &quot;DatabaseTracker.h&quot;
 34 #include &quot;Document.h&quot;
 35 #include &quot;InspectorInstrumentation.h&quot;
 36 #include &quot;Logging.h&quot;
 37 #include &quot;PlatformStrategies.h&quot;
 38 #include &quot;ScriptController.h&quot;
 39 #include &quot;SecurityOrigin.h&quot;
 40 #include &quot;SecurityOriginData.h&quot;

 41 #include &lt;wtf/NeverDestroyed.h&gt;
 42 
 43 namespace WebCore {
 44 
 45 class DatabaseManager::ProposedDatabase {
 46 public:
 47     ProposedDatabase(DatabaseManager&amp;, SecurityOrigin&amp;, const String&amp; name, const String&amp; displayName, unsigned long estimatedSize);
 48     ~ProposedDatabase();
 49 
 50     SecurityOrigin&amp; origin() { return m_origin; }
 51     DatabaseDetails&amp; details() { return m_details; }
 52 
 53 private:
 54     DatabaseManager&amp; m_manager;
 55     Ref&lt;SecurityOrigin&gt; m_origin;
 56     DatabaseDetails m_details;
 57 };
 58 
 59 DatabaseManager::ProposedDatabase::ProposedDatabase(DatabaseManager&amp; manager, SecurityOrigin&amp; origin, const String&amp; name, const String&amp; displayName, unsigned long estimatedSize)
 60     : m_manager(manager)
</pre>
<hr />
<pre>
175 
176     // FIXME: What guarantees backendContext.securityOrigin() is non-null?
177     DatabaseTracker::singleton().setDatabaseDetails(backendContext-&gt;securityOrigin(), name, displayName, estimatedSize);
178     return database;
179 }
180 
181 void DatabaseManager::addProposedDatabase(ProposedDatabase&amp; database)
182 {
183     std::lock_guard&lt;Lock&gt; lock { m_proposedDatabasesMutex };
184     m_proposedDatabases.add(&amp;database);
185 }
186 
187 void DatabaseManager::removeProposedDatabase(ProposedDatabase&amp; database)
188 {
189     std::lock_guard&lt;Lock&gt; lock { m_proposedDatabasesMutex };
190     m_proposedDatabases.remove(&amp;database);
191 }
192 
193 ExceptionOr&lt;Ref&lt;Database&gt;&gt; DatabaseManager::openDatabase(Document&amp; document, const String&amp; name, const String&amp; expectedVersion, const String&amp; displayName, unsigned estimatedSize, RefPtr&lt;DatabaseCallback&gt;&amp;&amp; creationCallback)
194 {

195     ScriptController::initializeThreading();
196 
197     bool setVersionInNewDatabase = !creationCallback;
198     auto openResult = openDatabaseBackend(document, name, expectedVersion, displayName, estimatedSize, setVersionInNewDatabase);
199     if (openResult.hasException())
200         return openResult.releaseException();
201 
202     RefPtr&lt;Database&gt; database = openResult.releaseReturnValue();
203 
204     auto databaseContext = this-&gt;databaseContext(document);
205     databaseContext-&gt;setHasOpenDatabases();
206     InspectorInstrumentation::didOpenDatabase(*database);
207 
208     if (database-&gt;isNew() &amp;&amp; creationCallback.get()) {
209         LOG(StorageAPI, &quot;Scheduling DatabaseCreationCallbackTask for database %p\n&quot;, database.get());
210         database-&gt;setHasPendingCreationEvent(true);
<span class="line-modified">211         database-&gt;m_document-&gt;postTask([creationCallback, database] (ScriptExecutionContext&amp;) {</span>
212             creationCallback-&gt;handleEvent(*database);
213             database-&gt;setHasPendingCreationEvent(false);
214         });
215     }
216 
217     return database.releaseNonNull();
218 }
219 
220 bool DatabaseManager::hasOpenDatabases(Document&amp; document)
221 {
222     auto databaseContext = document.databaseContext();
223     return databaseContext &amp;&amp; databaseContext-&gt;hasOpenDatabases();
224 }
225 
226 void DatabaseManager::stopDatabases(Document&amp; document, DatabaseTaskSynchronizer* synchronizer)
227 {
228     auto databaseContext = document.databaseContext();
229     if (!databaseContext || !databaseContext-&gt;stopDatabases(synchronizer)) {
230         if (synchronizer)
231             synchronizer-&gt;taskCompleted();
</pre>
</td>
<td>
<hr />
<pre>
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;DatabaseManager.h&quot;
 28 
 29 #include &quot;Database.h&quot;
 30 #include &quot;DatabaseCallback.h&quot;
 31 #include &quot;DatabaseContext.h&quot;
 32 #include &quot;DatabaseTask.h&quot;
 33 #include &quot;DatabaseTracker.h&quot;
 34 #include &quot;Document.h&quot;
 35 #include &quot;InspectorInstrumentation.h&quot;
 36 #include &quot;Logging.h&quot;
 37 #include &quot;PlatformStrategies.h&quot;
 38 #include &quot;ScriptController.h&quot;
 39 #include &quot;SecurityOrigin.h&quot;
 40 #include &quot;SecurityOriginData.h&quot;
<span class="line-added"> 41 #include &quot;WindowEventLoop.h&quot;</span>
 42 #include &lt;wtf/NeverDestroyed.h&gt;
 43 
 44 namespace WebCore {
 45 
 46 class DatabaseManager::ProposedDatabase {
 47 public:
 48     ProposedDatabase(DatabaseManager&amp;, SecurityOrigin&amp;, const String&amp; name, const String&amp; displayName, unsigned long estimatedSize);
 49     ~ProposedDatabase();
 50 
 51     SecurityOrigin&amp; origin() { return m_origin; }
 52     DatabaseDetails&amp; details() { return m_details; }
 53 
 54 private:
 55     DatabaseManager&amp; m_manager;
 56     Ref&lt;SecurityOrigin&gt; m_origin;
 57     DatabaseDetails m_details;
 58 };
 59 
 60 DatabaseManager::ProposedDatabase::ProposedDatabase(DatabaseManager&amp; manager, SecurityOrigin&amp; origin, const String&amp; name, const String&amp; displayName, unsigned long estimatedSize)
 61     : m_manager(manager)
</pre>
<hr />
<pre>
176 
177     // FIXME: What guarantees backendContext.securityOrigin() is non-null?
178     DatabaseTracker::singleton().setDatabaseDetails(backendContext-&gt;securityOrigin(), name, displayName, estimatedSize);
179     return database;
180 }
181 
182 void DatabaseManager::addProposedDatabase(ProposedDatabase&amp; database)
183 {
184     std::lock_guard&lt;Lock&gt; lock { m_proposedDatabasesMutex };
185     m_proposedDatabases.add(&amp;database);
186 }
187 
188 void DatabaseManager::removeProposedDatabase(ProposedDatabase&amp; database)
189 {
190     std::lock_guard&lt;Lock&gt; lock { m_proposedDatabasesMutex };
191     m_proposedDatabases.remove(&amp;database);
192 }
193 
194 ExceptionOr&lt;Ref&lt;Database&gt;&gt; DatabaseManager::openDatabase(Document&amp; document, const String&amp; name, const String&amp; expectedVersion, const String&amp; displayName, unsigned estimatedSize, RefPtr&lt;DatabaseCallback&gt;&amp;&amp; creationCallback)
195 {
<span class="line-added">196     ASSERT(isMainThread());</span>
197     ScriptController::initializeThreading();
198 
199     bool setVersionInNewDatabase = !creationCallback;
200     auto openResult = openDatabaseBackend(document, name, expectedVersion, displayName, estimatedSize, setVersionInNewDatabase);
201     if (openResult.hasException())
202         return openResult.releaseException();
203 
204     RefPtr&lt;Database&gt; database = openResult.releaseReturnValue();
205 
206     auto databaseContext = this-&gt;databaseContext(document);
207     databaseContext-&gt;setHasOpenDatabases();
208     InspectorInstrumentation::didOpenDatabase(*database);
209 
210     if (database-&gt;isNew() &amp;&amp; creationCallback.get()) {
211         LOG(StorageAPI, &quot;Scheduling DatabaseCreationCallbackTask for database %p\n&quot;, database.get());
212         database-&gt;setHasPendingCreationEvent(true);
<span class="line-modified">213         database-&gt;m_document-&gt;eventLoop().queueTask(TaskSource::Networking, [creationCallback, database]() {</span>
214             creationCallback-&gt;handleEvent(*database);
215             database-&gt;setHasPendingCreationEvent(false);
216         });
217     }
218 
219     return database.releaseNonNull();
220 }
221 
222 bool DatabaseManager::hasOpenDatabases(Document&amp; document)
223 {
224     auto databaseContext = document.databaseContext();
225     return databaseContext &amp;&amp; databaseContext-&gt;hasOpenDatabases();
226 }
227 
228 void DatabaseManager::stopDatabases(Document&amp; document, DatabaseTaskSynchronizer* synchronizer)
229 {
230     auto databaseContext = document.databaseContext();
231     if (!databaseContext || !databaseContext-&gt;stopDatabases(synchronizer)) {
232         if (synchronizer)
233             synchronizer-&gt;taskCompleted();
</pre>
</td>
</tr>
</table>
<center><a href="DatabaseDetails.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="DatabaseTask.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>