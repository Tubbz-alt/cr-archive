<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/dom/DocumentStorageAccess.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DocumentOrShadowRoot.idl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DocumentStorageAccess.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/dom/DocumentStorageAccess.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 29,23 ***</span>
  #if ENABLE(RESOURCE_LOAD_STATISTICS)
  
  #include &quot;Chrome.h&quot;
  #include &quot;ChromeClient.h&quot;
  #include &quot;Document.h&quot;
  #include &quot;Frame.h&quot;
  #include &quot;FrameLoader.h&quot;
  #include &quot;FrameLoaderClient.h&quot;
  #include &quot;JSDOMPromiseDeferred.h&quot;
<span class="line-removed">- #include &quot;Microtasks.h&quot;</span>
  #include &quot;Page.h&quot;
  #include &quot;RegistrableDomain.h&quot;
  #include &quot;SecurityOrigin.h&quot;
  #include &quot;Settings.h&quot;
  #include &quot;UserGestureIndicator.h&quot;
  
  namespace WebCore {
  
  DocumentStorageAccess* DocumentStorageAccess::from(Document&amp; document)
  {
      auto* supplement = static_cast&lt;DocumentStorageAccess*&gt;(Supplement&lt;Document&gt;::from(&amp;document, supplementName()));
      if (!supplement) {
          auto newSupplement = makeUnique&lt;DocumentStorageAccess&gt;(document);
<span class="line-new-header">--- 29,30 ---</span>
  #if ENABLE(RESOURCE_LOAD_STATISTICS)
  
  #include &quot;Chrome.h&quot;
  #include &quot;ChromeClient.h&quot;
  #include &quot;Document.h&quot;
<span class="line-added">+ #include &quot;EventLoop.h&quot;</span>
  #include &quot;Frame.h&quot;
  #include &quot;FrameLoader.h&quot;
  #include &quot;FrameLoaderClient.h&quot;
  #include &quot;JSDOMPromiseDeferred.h&quot;
  #include &quot;Page.h&quot;
  #include &quot;RegistrableDomain.h&quot;
  #include &quot;SecurityOrigin.h&quot;
  #include &quot;Settings.h&quot;
  #include &quot;UserGestureIndicator.h&quot;
  
  namespace WebCore {
  
<span class="line-added">+ DocumentStorageAccess::DocumentStorageAccess(Document&amp; document)</span>
<span class="line-added">+     : m_document(document)</span>
<span class="line-added">+ {</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ DocumentStorageAccess::~DocumentStorageAccess() = default;</span>
<span class="line-added">+ </span>
  DocumentStorageAccess* DocumentStorageAccess::from(Document&amp; document)
  {
      auto* supplement = static_cast&lt;DocumentStorageAccess*&gt;(Supplement&lt;Document&gt;::from(&amp;document, supplementName()));
      if (!supplement) {
          auto newSupplement = makeUnique&lt;DocumentStorageAccess&gt;(document);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 72,21 ***</span>
  
  void DocumentStorageAccess::hasStorageAccess(Ref&lt;DeferredPromise&gt;&amp;&amp; promise)
  {
      ASSERT(m_document.settings().storageAccessAPIEnabled());
  
<span class="line-modified">!     if (m_document.frame() &amp;&amp; hasFrameSpecificStorageAccess()) {</span>
          promise-&gt;resolve&lt;IDLBoolean&gt;(true);
          return;
      }
  
<span class="line-modified">!     if (!m_document.frame() || m_document.securityOrigin().isUnique()) {</span>
          promise-&gt;resolve&lt;IDLBoolean&gt;(false);
          return;
      }
  
<span class="line-modified">!     if (m_document.frame()-&gt;isMainFrame()) {</span>
          promise-&gt;resolve&lt;IDLBoolean&gt;(true);
          return;
      }
  
      auto&amp; securityOrigin = m_document.securityOrigin();
<span class="line-new-header">--- 79,22 ---</span>
  
  void DocumentStorageAccess::hasStorageAccess(Ref&lt;DeferredPromise&gt;&amp;&amp; promise)
  {
      ASSERT(m_document.settings().storageAccessAPIEnabled());
  
<span class="line-modified">!     auto* frame = m_document.frame();</span>
<span class="line-added">+     if (frame &amp;&amp; hasFrameSpecificStorageAccess()) {</span>
          promise-&gt;resolve&lt;IDLBoolean&gt;(true);
          return;
      }
  
<span class="line-modified">!     if (!frame || m_document.securityOrigin().isUnique()) {</span>
          promise-&gt;resolve&lt;IDLBoolean&gt;(false);
          return;
      }
  
<span class="line-modified">!     if (frame-&gt;isMainFrame()) {</span>
          promise-&gt;resolve&lt;IDLBoolean&gt;(true);
          return;
      }
  
      auto&amp; securityOrigin = m_document.securityOrigin();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 94,48 ***</span>
      if (securityOrigin.equal(&amp;topSecurityOrigin)) {
          promise-&gt;resolve&lt;IDLBoolean&gt;(true);
          return;
      }
  
<span class="line-modified">!     auto frameID = m_document.frame()-&gt;loader().client().frameID();</span>
<span class="line-modified">!     auto pageID = m_document.frame()-&gt;loader().client().pageID();</span>
<span class="line-removed">-     if (!frameID || !pageID) {</span>
          promise-&gt;reject();
          return;
      }
  
<span class="line-modified">!     if (Page* page = m_document.page()) {</span>
<span class="line-modified">!         auto subFrameDomain = RegistrableDomain::uncheckedCreateFromHost(securityOrigin.host());</span>
<span class="line-modified">!         auto topFrameDomain = RegistrableDomain::uncheckedCreateFromHost(topSecurityOrigin.host());</span>
<span class="line-modified">!         page-&gt;chrome().client().hasStorageAccess(WTFMove(subFrameDomain), WTFMove(topFrameDomain), frameID.value(), pageID.value(), [weakThis = makeWeakPtr(*this), promise = WTFMove(promise)] (bool hasAccess) {</span>
<span class="line-modified">!             DocumentStorageAccess* document = weakThis.get();</span>
<span class="line-removed">-             if (!document)</span>
<span class="line-removed">-                 return;</span>
<span class="line-removed">- </span>
<span class="line-removed">-             promise-&gt;resolve&lt;IDLBoolean&gt;(hasAccess);</span>
<span class="line-removed">-         });</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
  
<span class="line-modified">!     promise-&gt;reject();</span>
  }
  
  void DocumentStorageAccess::requestStorageAccess(Ref&lt;DeferredPromise&gt;&amp;&amp; promise)
  {
      ASSERT(m_document.settings().storageAccessAPIEnabled());
  
<span class="line-modified">!     if (m_document.frame() &amp;&amp; hasFrameSpecificStorageAccess()) {</span>
          promise-&gt;resolve();
          return;
      }
  
<span class="line-modified">!     if (!m_document.frame() || m_document.securityOrigin().isUnique() || !isAllowedToRequestFrameSpecificStorageAccess()) {</span>
          promise-&gt;reject();
          return;
      }
  
<span class="line-modified">!     if (m_document.frame()-&gt;isMainFrame()) {</span>
          promise-&gt;resolve();
          return;
      }
  
      auto&amp; topDocument = m_document.topDocument();
<span class="line-new-header">--- 102,42 ---</span>
      if (securityOrigin.equal(&amp;topSecurityOrigin)) {
          promise-&gt;resolve&lt;IDLBoolean&gt;(true);
          return;
      }
  
<span class="line-modified">!     auto* page = frame-&gt;page();</span>
<span class="line-modified">!     if (!page) {</span>
          promise-&gt;reject();
          return;
      }
  
<span class="line-modified">!     auto subFrameDomain = RegistrableDomain::uncheckedCreateFromHost(securityOrigin.host());</span>
<span class="line-modified">!     auto topFrameDomain = RegistrableDomain::uncheckedCreateFromHost(topSecurityOrigin.host());</span>
<span class="line-modified">!     page-&gt;chrome().client().hasStorageAccess(WTFMove(subFrameDomain), WTFMove(topFrameDomain), *frame, [weakThis = makeWeakPtr(*this), promise = WTFMove(promise)] (bool hasAccess) {</span>
<span class="line-modified">!         if (!weakThis)</span>
<span class="line-modified">!             return;</span>
  
<span class="line-modified">!         promise-&gt;resolve&lt;IDLBoolean&gt;(hasAccess);</span>
<span class="line-added">+     });</span>
  }
  
  void DocumentStorageAccess::requestStorageAccess(Ref&lt;DeferredPromise&gt;&amp;&amp; promise)
  {
      ASSERT(m_document.settings().storageAccessAPIEnabled());
  
<span class="line-modified">!     auto* frame = m_document.frame();</span>
<span class="line-added">+     if (frame &amp;&amp; hasFrameSpecificStorageAccess()) {</span>
          promise-&gt;resolve();
          return;
      }
  
<span class="line-modified">!     if (!frame || m_document.securityOrigin().isUnique() || !isAllowedToRequestFrameSpecificStorageAccess()) {</span>
          promise-&gt;reject();
          return;
      }
  
<span class="line-modified">!     if (frame-&gt;isMainFrame()) {</span>
          promise-&gt;resolve();
          return;
      }
  
      auto&amp; topDocument = m_document.topDocument();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 161,50 ***</span>
      if (!UserGestureIndicator::processingUserGesture()) {
          promise-&gt;reject();
          return;
      }
  
<span class="line-modified">!     Page* page = m_document.page();</span>
<span class="line-modified">!     auto frameID = m_document.frame()-&gt;loader().client().frameID();</span>
<span class="line-removed">-     auto pageID = m_document.frame()-&gt;loader().client().pageID();</span>
<span class="line-removed">-     if (!page || !frameID || !pageID) {</span>
          promise-&gt;reject();
          return;
      }
  
      auto subFrameDomain = RegistrableDomain::uncheckedCreateFromHost(securityOrigin.host());
      auto topFrameDomain = RegistrableDomain::uncheckedCreateFromHost(topSecurityOrigin.host());
  
<span class="line-modified">!     page-&gt;chrome().client().requestStorageAccess(WTFMove(subFrameDomain), WTFMove(topFrameDomain), frameID.value(), pageID.value(), [documentReference = makeWeakPtr(*this), promise = WTFMove(promise)] (StorageAccessWasGranted wasGranted, StorageAccessPromptWasShown promptWasShown) mutable {</span>
<span class="line-modified">!         DocumentStorageAccess* document = documentReference.get();</span>
<span class="line-removed">-         if (!document)</span>
              return;
  
          // Consume the user gesture only if the user explicitly denied access.
          bool shouldPreserveUserGesture = wasGranted == StorageAccessWasGranted::Yes || promptWasShown == StorageAccessPromptWasShown::No;
  
          if (shouldPreserveUserGesture) {
<span class="line-modified">!             MicrotaskQueue::mainThreadQueue().append(makeUnique&lt;VoidMicrotask&gt;([documentReference = makeWeakPtr(*document)] () {</span>
<span class="line-modified">!                 if (auto* document = documentReference.get())</span>
<span class="line-modified">!                     document-&gt;enableTemporaryTimeUserGesture();</span>
<span class="line-modified">!             }));</span>
          }
  
<span class="line-modified">!         if (wasGranted == StorageAccessWasGranted::Yes) {</span>
<span class="line-removed">-             document-&gt;setHasFrameSpecificStorageAccess(true);</span>
              promise-&gt;resolve();
<span class="line-modified">!         } else {</span>
              if (promptWasShown == StorageAccessPromptWasShown::Yes)
<span class="line-modified">!                 document-&gt;setWasExplicitlyDeniedFrameSpecificStorageAccess();</span>
              promise-&gt;reject();
          }
  
          if (shouldPreserveUserGesture) {
<span class="line-modified">!             MicrotaskQueue::mainThreadQueue().append(makeUnique&lt;VoidMicrotask&gt;([documentReference = WTFMove(documentReference)] () {</span>
<span class="line-modified">!                 if (auto* document = documentReference.get())</span>
<span class="line-modified">!                     document-&gt;consumeTemporaryTimeUserGesture();</span>
<span class="line-modified">!             }));</span>
          }
      });
  }
  
  void DocumentStorageAccess::enableTemporaryTimeUserGesture()
<span class="line-new-header">--- 163,46 ---</span>
      if (!UserGestureIndicator::processingUserGesture()) {
          promise-&gt;reject();
          return;
      }
  
<span class="line-modified">!     auto* page = frame-&gt;page();</span>
<span class="line-modified">!     if (!page) {</span>
          promise-&gt;reject();
          return;
      }
  
      auto subFrameDomain = RegistrableDomain::uncheckedCreateFromHost(securityOrigin.host());
      auto topFrameDomain = RegistrableDomain::uncheckedCreateFromHost(topSecurityOrigin.host());
  
<span class="line-modified">!     page-&gt;chrome().client().requestStorageAccess(WTFMove(subFrameDomain), WTFMove(topFrameDomain), *frame, [this, weakThis = makeWeakPtr(*this), promise = WTFMove(promise)] (StorageAccessWasGranted wasGranted, StorageAccessPromptWasShown promptWasShown) mutable {</span>
<span class="line-modified">!         if (!weakThis)</span>
              return;
  
          // Consume the user gesture only if the user explicitly denied access.
          bool shouldPreserveUserGesture = wasGranted == StorageAccessWasGranted::Yes || promptWasShown == StorageAccessPromptWasShown::No;
  
          if (shouldPreserveUserGesture) {
<span class="line-modified">!             m_document.eventLoop().queueMicrotask([this, weakThis = makeWeakPtr(*this)] {</span>
<span class="line-modified">!                 if (weakThis)</span>
<span class="line-modified">!                     enableTemporaryTimeUserGesture();</span>
<span class="line-modified">!             });</span>
          }
  
<span class="line-modified">!         if (wasGranted == StorageAccessWasGranted::Yes)</span>
              promise-&gt;resolve();
<span class="line-modified">!         else {</span>
              if (promptWasShown == StorageAccessPromptWasShown::Yes)
<span class="line-modified">!                 setWasExplicitlyDeniedFrameSpecificStorageAccess();</span>
              promise-&gt;reject();
          }
  
          if (shouldPreserveUserGesture) {
<span class="line-modified">!             m_document.eventLoop().queueMicrotask([this, weakThis = makeWeakPtr(*this)] {</span>
<span class="line-modified">!                 if (weakThis)</span>
<span class="line-modified">!                     consumeTemporaryTimeUserGesture();</span>
<span class="line-modified">!             });</span>
          }
      });
  }
  
  void DocumentStorageAccess::enableTemporaryTimeUserGesture()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 221,14 ***</span>
  {
      auto* frame = m_document.frame();
      return frame &amp;&amp; frame-&gt;loader().client().hasFrameSpecificStorageAccess();
  }
  
<span class="line-removed">- void DocumentStorageAccess::setHasFrameSpecificStorageAccess(bool value)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     if (auto* frame = m_document.frame())</span>
<span class="line-removed">-         frame-&gt;loader().client().setHasFrameSpecificStorageAccess(value);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  } // namespace WebCore
  
  #endif // ENABLE(RESOURCE_LOAD_STATISTICS)
<span class="line-new-header">--- 219,8 ---</span>
</pre>
<center><a href="DocumentOrShadowRoot.idl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DocumentStorageAccess.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>