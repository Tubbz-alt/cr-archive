<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/tools/JSDollarVM.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (C) 2015-2019 Apple Inc. All rights reserved.
   3  *
   4  * Redistribution and use in source and binary forms, with or without
   5  * modification, are permitted provided that the following conditions
   6  * are met:
   7  * 1. Redistributions of source code must retain the above copyright
   8  *    notice, this list of conditions and the following disclaimer.
   9  * 2. Redistributions in binary form must reproduce the above copyright
  10  *    notice, this list of conditions and the following disclaimer in the
  11  *    documentation and/or other materials provided with the distribution.
  12  *
  13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
  14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
  16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
  17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
  18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
  19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
  20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
  21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
  23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  24  */
  25 
  26 #include &quot;config.h&quot;
  27 #include &quot;JSDollarVM.h&quot;
  28 
  29 #include &quot;BuiltinExecutableCreator.h&quot;
  30 #include &quot;CodeBlock.h&quot;
  31 #include &quot;DOMAttributeGetterSetter.h&quot;
  32 #include &quot;DOMJITGetterSetter.h&quot;
<a name="1" id="anc1"></a><span class="line-added">  33 #include &quot;Debugger.h&quot;</span>
<span class="line-added">  34 #include &quot;Error.h&quot;</span>
  35 #include &quot;FrameTracers.h&quot;
  36 #include &quot;FunctionCodeBlock.h&quot;
  37 #include &quot;GetterSetter.h&quot;
  38 #include &quot;JSArray.h&quot;
  39 #include &quot;JSArrayBuffer.h&quot;
  40 #include &quot;JSCInlines.h&quot;
  41 #include &quot;JSFunction.h&quot;
  42 #include &quot;JSONObject.h&quot;
  43 #include &quot;JSProxy.h&quot;
  44 #include &quot;JSString.h&quot;
<a name="2" id="anc2"></a><span class="line-added">  45 #include &quot;Options.h&quot;</span>
  46 #include &quot;Parser.h&quot;
<a name="3" id="anc3"></a><span class="line-added">  47 #include &quot;ProbeContext.h&quot;</span>
  48 #include &quot;ShadowChicken.h&quot;
  49 #include &quot;Snippet.h&quot;
  50 #include &quot;SnippetParams.h&quot;
  51 #include &quot;TypeProfiler.h&quot;
  52 #include &quot;TypeProfilerLog.h&quot;
  53 #include &quot;VMInspector.h&quot;
  54 #include &quot;WasmCapabilities.h&quot;
  55 #include &lt;wtf/Atomics.h&gt;
<a name="4" id="anc4"></a><span class="line-added">  56 #include &lt;wtf/CPUTime.h&gt;</span>
  57 #include &lt;wtf/DataLog.h&gt;
  58 #include &lt;wtf/ProcessID.h&gt;
  59 #include &lt;wtf/StringPrintStream.h&gt;
  60 
  61 #if ENABLE(WEBASSEMBLY)
  62 #include &quot;JSWebAssemblyHelpers.h&quot;
  63 #include &quot;WasmStreamingParser.h&quot;
  64 #endif
  65 
  66 using namespace JSC;
  67 
<a name="5" id="anc5"></a><span class="line-added">  68 IGNORE_WARNINGS_BEGIN(&quot;frame-address&quot;)</span>
<span class="line-added">  69 </span>
<span class="line-added">  70 extern &quot;C&quot; void ctiMasmProbeTrampoline();</span>
<span class="line-added">  71 </span>
<span class="line-added">  72 namespace JSC {</span>
<span class="line-added">  73 </span>
<span class="line-added">  74 // This class is only here as a simple way to grant JSDollarVM friend privileges</span>
<span class="line-added">  75 // to all the classes that it needs special access to.</span>
<span class="line-added">  76 class JSDollarVMHelper {</span>
<span class="line-added">  77 public:</span>
<span class="line-added">  78     JSDollarVMHelper(VM&amp; vm)</span>
<span class="line-added">  79         : m_vm(vm)</span>
<span class="line-added">  80     { }</span>
<span class="line-added">  81 </span>
<span class="line-added">  82     void updateVMStackLimits() { return m_vm.updateStackLimits(); };</span>
<span class="line-added">  83 </span>
<span class="line-added">  84     static EncodedJSValue JSC_HOST_CALL functionGetStructureTransitionList(JSGlobalObject*, CallFrame*);</span>
<span class="line-added">  85 </span>
<span class="line-added">  86 private:</span>
<span class="line-added">  87     VM&amp; m_vm;</span>
<span class="line-added">  88 };</span>
<span class="line-added">  89 </span>
<span class="line-added">  90 } // namespace JSC</span>
<span class="line-added">  91 </span>
  92 namespace {
  93 
<a name="6" id="anc6"></a><span class="line-modified">  94 // We must RELEASE_ASSERT(Options::useDollarVM()) in all JSDollarVM functions</span>
<span class="line-modified">  95 // that are non-trivial at an eye&#39;s glance. This includes (but is not limited to):</span>
<span class="line-added">  96 //      constructors</span>
<span class="line-added">  97 //      create() factory</span>
<span class="line-added">  98 //      createStructure() factory</span>
<span class="line-added">  99 //      finishCreation()</span>
<span class="line-added"> 100 //      HOST_CALL or operation functions</span>
<span class="line-added"> 101 //      Constructors and methods of utility and test classes</span>
<span class="line-added"> 102 //      lambda functions</span>
<span class="line-added"> 103 //</span>
<span class="line-added"> 104 // The way to do this RELEASE_ASSERT is with the DollarVMAssertScope below.</span>
<span class="line-added"> 105 //</span>
<span class="line-added"> 106 // The only exception are some constexpr constructors used for instantiating</span>
<span class="line-added"> 107 // globals (since these must have trivial constructors) e.g. DOMJITAttribute.</span>
<span class="line-added"> 108 // Instead, these constructors should always be ALWAYS_INLINE.</span>
<span class="line-added"> 109 </span>
<span class="line-added"> 110 class JSDollarVMCallFrame : public JSNonFinalObject {</span>
<span class="line-added"> 111     using Base = JSNonFinalObject;</span>
 112 public:
 113     JSDollarVMCallFrame(VM&amp; vm, Structure* structure)
 114         : Base(vm, structure)
<a name="7" id="anc7"></a><span class="line-modified"> 115     {</span>
<span class="line-added"> 116         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 117     }</span>
 118 
 119     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
 120     {
<a name="8" id="anc8"></a><span class="line-added"> 121         DollarVMAssertScope assertScope;</span>
 122         return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
 123     }
 124 
<a name="9" id="anc9"></a><span class="line-modified"> 125     static JSDollarVMCallFrame* create(JSGlobalObject* globalObject, CallFrame* callFrame, unsigned requestedFrameIndex)</span>
 126     {
<a name="10" id="anc10"></a><span class="line-modified"> 127         DollarVMAssertScope assertScope;</span>
<span class="line-modified"> 128         VM&amp; vm = globalObject-&gt;vm();</span>
 129         Structure* structure = createStructure(vm, globalObject, jsNull());
 130         JSDollarVMCallFrame* frame = new (NotNull, allocateCell&lt;JSDollarVMCallFrame&gt;(vm.heap)) JSDollarVMCallFrame(vm, structure);
<a name="11" id="anc11"></a><span class="line-modified"> 131         frame-&gt;finishCreation(vm, callFrame, requestedFrameIndex);</span>
 132         return frame;
 133     }
 134 
<a name="12" id="anc12"></a><span class="line-modified"> 135     void finishCreation(VM&amp; vm, CallFrame* callFrame, unsigned requestedFrameIndex)</span>
 136     {
<a name="13" id="anc13"></a><span class="line-added"> 137         DollarVMAssertScope assertScope;</span>
 138         Base::finishCreation(vm);
 139 
 140         auto addProperty = [&amp;] (VM&amp; vm, const char* name, JSValue value) {
<a name="14" id="anc14"></a><span class="line-added"> 141             DollarVMAssertScope assertScope;</span>
 142             JSDollarVMCallFrame::addProperty(vm, name, value);
 143         };
 144 
 145         unsigned frameIndex = 0;
 146         bool isValid = false;
<a name="15" id="anc15"></a><span class="line-modified"> 147         callFrame-&gt;iterate(vm, [&amp;] (StackVisitor&amp; visitor) {</span>
<span class="line-added"> 148             DollarVMAssertScope assertScope;</span>
 149 
 150             if (frameIndex++ != requestedFrameIndex)
 151                 return StackVisitor::Continue;
 152 
 153             addProperty(vm, &quot;name&quot;, jsString(vm, visitor-&gt;functionName()));
 154 
 155             if (visitor-&gt;callee().isCell())
 156                 addProperty(vm, &quot;callee&quot;, visitor-&gt;callee().asCell());
 157 
 158             CodeBlock* codeBlock = visitor-&gt;codeBlock();
 159             if (codeBlock) {
 160                 addProperty(vm, &quot;codeBlock&quot;, codeBlock);
 161                 addProperty(vm, &quot;unlinkedCodeBlock&quot;, codeBlock-&gt;unlinkedCodeBlock());
 162                 addProperty(vm, &quot;executable&quot;, codeBlock-&gt;ownerExecutable());
 163             }
 164             isValid = true;
 165 
 166             return StackVisitor::Done;
 167         });
 168 
 169         addProperty(vm, &quot;valid&quot;, jsBoolean(isValid));
 170     }
 171 
 172     DECLARE_INFO;
 173 
 174 private:
 175     void addProperty(VM&amp; vm, const char* name, JSValue value)
 176     {
<a name="16" id="anc16"></a><span class="line-added"> 177         DollarVMAssertScope assertScope;</span>
 178         Identifier identifier = Identifier::fromString(vm, name);
 179         putDirect(vm, identifier, value);
 180     }
 181 };
 182 
 183 const ClassInfo JSDollarVMCallFrame::s_info = { &quot;CallFrame&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSDollarVMCallFrame) };
 184 
 185 class ElementHandleOwner;
 186 class Root;
 187 
 188 class Element : public JSNonFinalObject {
 189 public:
 190     Element(VM&amp; vm, Structure* structure)
 191         : Base(vm, structure)
 192     {
<a name="17" id="anc17"></a><span class="line-added"> 193         DollarVMAssertScope assertScope;</span>
 194     }
 195 
 196     typedef JSNonFinalObject Base;
 197 
 198     Root* root() const { return m_root.get(); }
 199     void setRoot(VM&amp; vm, Root* root) { m_root.set(vm, this, root); }
 200 
 201     static Element* create(VM&amp; vm, JSGlobalObject* globalObject, Root* root)
 202     {
<a name="18" id="anc18"></a><span class="line-added"> 203         DollarVMAssertScope assertScope;</span>
 204         Structure* structure = createStructure(vm, globalObject, jsNull());
 205         Element* element = new (NotNull, allocateCell&lt;Element&gt;(vm.heap)) Element(vm, structure);
 206         element-&gt;finishCreation(vm, root);
 207         return element;
 208     }
 209 
 210     void finishCreation(VM&amp;, Root*);
 211 
 212     static void visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
 213     {
<a name="19" id="anc19"></a><span class="line-added"> 214         DollarVMAssertScope assertScope;</span>
 215         Element* thisObject = jsCast&lt;Element*&gt;(cell);
 216         ASSERT_GC_OBJECT_INHERITS(thisObject, info());
 217         Base::visitChildren(thisObject, visitor);
 218         visitor.append(thisObject-&gt;m_root);
 219     }
 220 
 221     static ElementHandleOwner* handleOwner();
 222 
 223     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
 224     {
<a name="20" id="anc20"></a><span class="line-added"> 225         DollarVMAssertScope assertScope;</span>
 226         return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
 227     }
 228 
 229     DECLARE_INFO;
 230 
 231 private:
 232     WriteBarrier&lt;Root&gt; m_root;
 233 };
 234 
 235 class ElementHandleOwner : public WeakHandleOwner {
 236     WTF_MAKE_FAST_ALLOCATED;
 237 public:
<a name="21" id="anc21"></a><span class="line-modified"> 238     bool isReachableFromOpaqueRoots(JSC::Handle&lt;JSC::Unknown&gt; handle, void*, SlotVisitor&amp; visitor, const char** reason) override</span>
 239     {
<a name="22" id="anc22"></a><span class="line-added"> 240         DollarVMAssertScope assertScope;</span>
 241         if (UNLIKELY(reason))
 242             *reason = &quot;JSC::Element is opaque root&quot;;
 243         Element* element = jsCast&lt;Element*&gt;(handle.slot()-&gt;asCell());
 244         return visitor.containsOpaqueRoot(element-&gt;root());
 245     }
 246 };
 247 
 248 class Root : public JSDestructibleObject {
 249 public:
 250     Root(VM&amp; vm, Structure* structure)
 251         : Base(vm, structure)
 252     {
<a name="23" id="anc23"></a><span class="line-added"> 253         DollarVMAssertScope assertScope;</span>
 254     }
 255 
 256     Element* element()
 257     {
 258         return m_element.get();
 259     }
 260 
 261     void setElement(Element* element)
 262     {
<a name="24" id="anc24"></a><span class="line-added"> 263         DollarVMAssertScope assertScope;</span>
 264         Weak&lt;Element&gt; newElement(element, Element::handleOwner());
 265         m_element.swap(newElement);
 266     }
 267 
 268     static Root* create(VM&amp; vm, JSGlobalObject* globalObject)
 269     {
<a name="25" id="anc25"></a><span class="line-added"> 270         DollarVMAssertScope assertScope;</span>
 271         Structure* structure = createStructure(vm, globalObject, jsNull());
 272         Root* root = new (NotNull, allocateCell&lt;Root&gt;(vm.heap)) Root(vm, structure);
 273         root-&gt;finishCreation(vm);
 274         return root;
 275     }
 276 
 277     typedef JSDestructibleObject Base;
 278 
 279     DECLARE_INFO;
 280 
 281     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
 282     {
<a name="26" id="anc26"></a><span class="line-added"> 283         DollarVMAssertScope assertScope;</span>
 284         return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
 285     }
 286 
 287     static void visitChildren(JSCell* thisObject, SlotVisitor&amp; visitor)
 288     {
<a name="27" id="anc27"></a><span class="line-added"> 289         DollarVMAssertScope assertScope;</span>
 290         ASSERT_GC_OBJECT_INHERITS(thisObject, info());
 291         Base::visitChildren(thisObject, visitor);
 292         visitor.addOpaqueRoot(thisObject);
 293     }
 294 
 295 private:
 296     Weak&lt;Element&gt; m_element;
 297 };
 298 
 299 class SimpleObject : public JSNonFinalObject {
 300 public:
 301     SimpleObject(VM&amp; vm, Structure* structure)
 302         : Base(vm, structure)
 303     {
<a name="28" id="anc28"></a><span class="line-added"> 304         DollarVMAssertScope assertScope;</span>
 305     }
 306 
 307     typedef JSNonFinalObject Base;
<a name="29" id="anc29"></a><span class="line-modified"> 308     static constexpr bool needsDestruction = false;</span>
 309 
 310     static SimpleObject* create(VM&amp; vm, JSGlobalObject* globalObject)
 311     {
<a name="30" id="anc30"></a><span class="line-added"> 312         DollarVMAssertScope assertScope;</span>
 313         Structure* structure = createStructure(vm, globalObject, jsNull());
 314         SimpleObject* simpleObject = new (NotNull, allocateCell&lt;SimpleObject&gt;(vm.heap)) SimpleObject(vm, structure);
 315         simpleObject-&gt;finishCreation(vm);
 316         return simpleObject;
 317     }
 318 
 319     static void visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
 320     {
<a name="31" id="anc31"></a><span class="line-added"> 321         DollarVMAssertScope assertScope;</span>
 322         SimpleObject* thisObject = jsCast&lt;SimpleObject*&gt;(cell);
 323         ASSERT_GC_OBJECT_INHERITS(thisObject, info());
 324         Base::visitChildren(thisObject, visitor);
 325         visitor.append(thisObject-&gt;m_hiddenValue);
 326     }
 327 
 328     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
 329     {
<a name="32" id="anc32"></a><span class="line-added"> 330         DollarVMAssertScope assertScope;</span>
 331         return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
 332     }
 333 
 334     JSValue hiddenValue()
 335     {
 336         return m_hiddenValue.get();
 337     }
 338 
 339     void setHiddenValue(VM&amp; vm, JSValue value)
 340     {
 341         ASSERT(value.isCell());
 342         m_hiddenValue.set(vm, this, value);
 343     }
 344 
 345     DECLARE_INFO;
 346 
 347 private:
 348     WriteBarrier&lt;JSC::Unknown&gt; m_hiddenValue;
 349 };
 350 
 351 class ImpureGetter : public JSNonFinalObject {
 352 public:
 353     ImpureGetter(VM&amp; vm, Structure* structure)
 354         : Base(vm, structure)
 355     {
<a name="33" id="anc33"></a><span class="line-added"> 356         DollarVMAssertScope assertScope;</span>
 357     }
 358 
 359     DECLARE_INFO;
 360     typedef JSNonFinalObject Base;
<a name="34" id="anc34"></a><span class="line-modified"> 361     static constexpr unsigned StructureFlags = Base::StructureFlags | JSC::GetOwnPropertySlotIsImpure | JSC::OverridesGetOwnPropertySlot;</span>
 362 
 363     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
 364     {
<a name="35" id="anc35"></a><span class="line-added"> 365         DollarVMAssertScope assertScope;</span>
 366         return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
 367     }
 368 
 369     static ImpureGetter* create(VM&amp; vm, Structure* structure, JSObject* delegate)
 370     {
<a name="36" id="anc36"></a><span class="line-added"> 371         DollarVMAssertScope assertScope;</span>
 372         ImpureGetter* getter = new (NotNull, allocateCell&lt;ImpureGetter&gt;(vm.heap)) ImpureGetter(vm, structure);
 373         getter-&gt;finishCreation(vm, delegate);
 374         return getter;
 375     }
 376 
 377     void finishCreation(VM&amp; vm, JSObject* delegate)
 378     {
<a name="37" id="anc37"></a><span class="line-added"> 379         DollarVMAssertScope assertScope;</span>
 380         Base::finishCreation(vm);
 381         if (delegate)
 382             m_delegate.set(vm, this, delegate);
 383     }
 384 
<a name="38" id="anc38"></a><span class="line-modified"> 385     static bool getOwnPropertySlot(JSObject* object, JSGlobalObject* globalObject, PropertyName name, PropertySlot&amp; slot)</span>
 386     {
<a name="39" id="anc39"></a><span class="line-modified"> 387         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 388         VM&amp; vm = globalObject-&gt;vm();</span>
 389         auto scope = DECLARE_THROW_SCOPE(vm);
 390         ImpureGetter* thisObject = jsCast&lt;ImpureGetter*&gt;(object);
 391 
 392         if (thisObject-&gt;m_delegate) {
<a name="40" id="anc40"></a><span class="line-modified"> 393             if (thisObject-&gt;m_delegate-&gt;getPropertySlot(globalObject, name, slot))</span>
 394                 return true;
 395             RETURN_IF_EXCEPTION(scope, false);
 396         }
 397 
<a name="41" id="anc41"></a><span class="line-modified"> 398         return Base::getOwnPropertySlot(object, globalObject, name, slot);</span>
 399     }
 400 
 401     static void visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
 402     {
<a name="42" id="anc42"></a><span class="line-added"> 403         DollarVMAssertScope assertScope;</span>
 404         ASSERT_GC_OBJECT_INHERITS(cell, info());
 405         Base::visitChildren(cell, visitor);
 406         ImpureGetter* thisObject = jsCast&lt;ImpureGetter*&gt;(cell);
 407         visitor.append(thisObject-&gt;m_delegate);
 408     }
 409 
 410     void setDelegate(VM&amp; vm, JSObject* delegate)
 411     {
 412         m_delegate.set(vm, this, delegate);
 413     }
 414 
 415 private:
 416     WriteBarrier&lt;JSObject&gt; m_delegate;
 417 };
 418 
 419 class CustomGetter : public JSNonFinalObject {
 420 public:
 421     CustomGetter(VM&amp; vm, Structure* structure)
 422         : Base(vm, structure)
 423     {
<a name="43" id="anc43"></a><span class="line-added"> 424         DollarVMAssertScope assertScope;</span>
 425     }
 426 
 427     DECLARE_INFO;
 428     typedef JSNonFinalObject Base;
<a name="44" id="anc44"></a><span class="line-modified"> 429     static constexpr unsigned StructureFlags = Base::StructureFlags | JSC::OverridesGetOwnPropertySlot;</span>
 430 
 431     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
 432     {
<a name="45" id="anc45"></a><span class="line-added"> 433         DollarVMAssertScope assertScope;</span>
 434         return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
 435     }
 436 
 437     static CustomGetter* create(VM&amp; vm, Structure* structure)
 438     {
<a name="46" id="anc46"></a><span class="line-added"> 439         DollarVMAssertScope assertScope;</span>
 440         CustomGetter* getter = new (NotNull, allocateCell&lt;CustomGetter&gt;(vm.heap)) CustomGetter(vm, structure);
 441         getter-&gt;finishCreation(vm);
 442         return getter;
 443     }
 444 
<a name="47" id="anc47"></a><span class="line-modified"> 445     static bool getOwnPropertySlot(JSObject* object, JSGlobalObject* globalObject, PropertyName propertyName, PropertySlot&amp; slot)</span>
 446     {
<a name="48" id="anc48"></a><span class="line-modified"> 447         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 448         VM&amp; vm = globalObject-&gt;vm();</span>
 449         CustomGetter* thisObject = jsCast&lt;CustomGetter*&gt;(object);
 450         if (propertyName == PropertyName(Identifier::fromString(vm, &quot;customGetter&quot;))) {
 451             slot.setCacheableCustom(thisObject, PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum, thisObject-&gt;customGetter);
 452             return true;
 453         }
 454 
 455         if (propertyName == PropertyName(Identifier::fromString(vm, &quot;customGetterAccessor&quot;))) {
 456             slot.setCacheableCustom(thisObject, PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum | PropertyAttribute::CustomAccessor, thisObject-&gt;customGetterAcessor);
 457             return true;
 458         }
 459 
<a name="49" id="anc49"></a><span class="line-modified"> 460         return JSObject::getOwnPropertySlot(thisObject, globalObject, propertyName, slot);</span>
 461     }
 462 
 463 private:
<a name="50" id="anc50"></a><span class="line-modified"> 464     static EncodedJSValue customGetter(JSGlobalObject* globalObject, EncodedJSValue thisValue, PropertyName)</span>
 465     {
<a name="51" id="anc51"></a><span class="line-modified"> 466         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 467         VM&amp; vm = globalObject-&gt;vm();</span>
 468         auto scope = DECLARE_THROW_SCOPE(vm);
 469 
 470         CustomGetter* thisObject = jsDynamicCast&lt;CustomGetter*&gt;(vm, JSValue::decode(thisValue));
 471         if (!thisObject)
<a name="52" id="anc52"></a><span class="line-modified"> 472             return throwVMTypeError(globalObject, scope);</span>
<span class="line-modified"> 473         bool shouldThrow = thisObject-&gt;get(globalObject, PropertyName(Identifier::fromString(vm, &quot;shouldThrow&quot;))).toBoolean(globalObject);</span>
 474         RETURN_IF_EXCEPTION(scope, encodedJSValue());
 475         if (shouldThrow)
<a name="53" id="anc53"></a><span class="line-modified"> 476             return throwVMTypeError(globalObject, scope);</span>
 477         return JSValue::encode(jsNumber(100));
 478     }
 479 
<a name="54" id="anc54"></a><span class="line-modified"> 480     static EncodedJSValue customGetterAcessor(JSGlobalObject* globalObject, EncodedJSValue thisValue, PropertyName)</span>
 481     {
<a name="55" id="anc55"></a><span class="line-modified"> 482         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 483         VM&amp; vm = globalObject-&gt;vm();</span>
 484         auto scope = DECLARE_THROW_SCOPE(vm);
 485 
 486         JSObject* thisObject = jsDynamicCast&lt;JSObject*&gt;(vm, JSValue::decode(thisValue));
 487         if (!thisObject)
<a name="56" id="anc56"></a><span class="line-modified"> 488             return throwVMTypeError(globalObject, scope);</span>
<span class="line-modified"> 489         bool shouldThrow = thisObject-&gt;get(globalObject, PropertyName(Identifier::fromString(vm, &quot;shouldThrow&quot;))).toBoolean(globalObject);</span>
 490         RETURN_IF_EXCEPTION(scope, encodedJSValue());
 491         if (shouldThrow)
<a name="57" id="anc57"></a><span class="line-modified"> 492             return throwVMTypeError(globalObject, scope);</span>
 493         return JSValue::encode(jsNumber(100));
 494     }
 495 };
 496 
 497 class RuntimeArray : public JSArray {
 498 public:
 499     typedef JSArray Base;
<a name="58" id="anc58"></a><span class="line-modified"> 500     static constexpr unsigned StructureFlags = Base::StructureFlags | OverridesGetOwnPropertySlot | InterceptsGetOwnPropertySlotByIndexEvenWhenLengthIsNotZero | OverridesGetPropertyNames;</span>
 501 
<a name="59" id="anc59"></a><span class="line-modified"> 502     static RuntimeArray* create(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 503     {
<a name="60" id="anc60"></a><span class="line-modified"> 504         DollarVMAssertScope assertScope;</span>
<span class="line-modified"> 505         VM&amp; vm = globalObject-&gt;vm();</span>
 506         Structure* structure = createStructure(vm, globalObject, createPrototype(vm, globalObject));
<a name="61" id="anc61"></a><span class="line-modified"> 507         RuntimeArray* runtimeArray = new (NotNull, allocateCell&lt;RuntimeArray&gt;(vm.heap)) RuntimeArray(globalObject, structure);</span>
<span class="line-modified"> 508         runtimeArray-&gt;finishCreation(globalObject, callFrame);</span>
 509         vm.heap.addFinalizer(runtimeArray, destroy);
 510         return runtimeArray;
 511     }
 512 
 513     ~RuntimeArray() { }
 514 
 515     static void destroy(JSCell* cell)
 516     {
<a name="62" id="anc62"></a><span class="line-added"> 517         DollarVMAssertScope assertScope;</span>
 518         static_cast&lt;RuntimeArray*&gt;(cell)-&gt;RuntimeArray::~RuntimeArray();
 519     }
 520 
<a name="63" id="anc63"></a><span class="line-modified"> 521     static constexpr bool needsDestruction = false;</span>
 522 
<a name="64" id="anc64"></a><span class="line-modified"> 523     static bool getOwnPropertySlot(JSObject* object, JSGlobalObject* globalObject, PropertyName propertyName, PropertySlot&amp; slot)</span>
 524     {
<a name="65" id="anc65"></a><span class="line-modified"> 525         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 526         VM&amp; vm = globalObject-&gt;vm();</span>
 527         RuntimeArray* thisObject = jsCast&lt;RuntimeArray*&gt;(object);
 528         if (propertyName == vm.propertyNames-&gt;length) {
 529             slot.setCacheableCustom(thisObject, PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum, thisObject-&gt;lengthGetter);
 530             return true;
 531         }
 532 
 533         Optional&lt;uint32_t&gt; index = parseIndex(propertyName);
 534         if (index &amp;&amp; index.value() &lt; thisObject-&gt;getLength()) {
 535             slot.setValue(thisObject, PropertyAttribute::DontDelete | PropertyAttribute::DontEnum, jsNumber(thisObject-&gt;m_vector[index.value()]));
 536             return true;
 537         }
 538 
<a name="66" id="anc66"></a><span class="line-modified"> 539         return JSObject::getOwnPropertySlot(thisObject, globalObject, propertyName, slot);</span>
 540     }
 541 
<a name="67" id="anc67"></a><span class="line-modified"> 542     static bool getOwnPropertySlotByIndex(JSObject* object, JSGlobalObject* globalObject, unsigned index, PropertySlot&amp; slot)</span>
 543     {
<a name="68" id="anc68"></a><span class="line-added"> 544         DollarVMAssertScope assertScope;</span>
 545         RuntimeArray* thisObject = jsCast&lt;RuntimeArray*&gt;(object);
 546         if (index &lt; thisObject-&gt;getLength()) {
 547             slot.setValue(thisObject, PropertyAttribute::DontDelete | PropertyAttribute::DontEnum, jsNumber(thisObject-&gt;m_vector[index]));
 548             return true;
 549         }
 550 
<a name="69" id="anc69"></a><span class="line-modified"> 551         return JSObject::getOwnPropertySlotByIndex(thisObject, globalObject, index, slot);</span>
 552     }
 553 
<a name="70" id="anc70"></a><span class="line-modified"> 554     static NO_RETURN_DUE_TO_CRASH bool put(JSCell*, JSGlobalObject*, PropertyName, JSValue, PutPropertySlot&amp;)</span>
 555     {
 556         RELEASE_ASSERT_NOT_REACHED();
 557     }
 558 
<a name="71" id="anc71"></a><span class="line-modified"> 559     static NO_RETURN_DUE_TO_CRASH bool deleteProperty(JSCell*, JSGlobalObject*, PropertyName)</span>
 560     {
 561         RELEASE_ASSERT_NOT_REACHED();
 562     }
 563 
 564     unsigned getLength() const { return m_vector.size(); }
 565 
 566     DECLARE_INFO;
 567 
 568     static ArrayPrototype* createPrototype(VM&amp;, JSGlobalObject* globalObject)
 569     {
<a name="72" id="anc72"></a><span class="line-added"> 570         DollarVMAssertScope assertScope;</span>
 571         return globalObject-&gt;arrayPrototype();
 572     }
 573 
 574     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
 575     {
<a name="73" id="anc73"></a><span class="line-added"> 576         DollarVMAssertScope assertScope;</span>
 577         return Structure::create(vm, globalObject, prototype, TypeInfo(DerivedArrayType, StructureFlags), info(), ArrayClass);
 578     }
 579 
 580 protected:
<a name="74" id="anc74"></a><span class="line-modified"> 581     void finishCreation(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 582     {
<a name="75" id="anc75"></a><span class="line-modified"> 583         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 584         VM&amp; vm = globalObject-&gt;vm();</span>
 585         Base::finishCreation(vm);
 586         ASSERT(inherits(vm, info()));
 587 
<a name="76" id="anc76"></a><span class="line-modified"> 588         for (size_t i = 0; i &lt; callFrame-&gt;argumentCount(); i++)</span>
<span class="line-modified"> 589             m_vector.append(callFrame-&gt;argument(i).toInt32(globalObject));</span>
 590     }
 591 
 592 private:
<a name="77" id="anc77"></a><span class="line-modified"> 593     RuntimeArray(JSGlobalObject* globalObject, Structure* structure)</span>
<span class="line-modified"> 594         : JSArray(globalObject-&gt;vm(), structure, 0)</span>
 595     {
<a name="78" id="anc78"></a><span class="line-added"> 596         DollarVMAssertScope assertScope;</span>
 597     }
 598 
<a name="79" id="anc79"></a><span class="line-modified"> 599     static EncodedJSValue lengthGetter(JSGlobalObject* globalObject, EncodedJSValue thisValue, PropertyName)</span>
 600     {
<a name="80" id="anc80"></a><span class="line-modified"> 601         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 602         VM&amp; vm = globalObject-&gt;vm();</span>
 603         auto scope = DECLARE_THROW_SCOPE(vm);
 604 
 605         RuntimeArray* thisObject = jsDynamicCast&lt;RuntimeArray*&gt;(vm, JSValue::decode(thisValue));
 606         if (!thisObject)
<a name="81" id="anc81"></a><span class="line-modified"> 607             return throwVMTypeError(globalObject, scope);</span>
 608         return JSValue::encode(jsNumber(thisObject-&gt;getLength()));
 609     }
 610 
 611     Vector&lt;int&gt; m_vector;
 612 };
 613 
<a name="82" id="anc82"></a><span class="line-added"> 614 static const struct CompactHashIndex staticCustomAccessorTableIndex[2] = {</span>
<span class="line-added"> 615     { 0, -1 },</span>
<span class="line-added"> 616     { -1, -1 },</span>
<span class="line-added"> 617 };</span>
<span class="line-added"> 618 </span>
<span class="line-added"> 619 static EncodedJSValue testStaticAccessorGetter(JSGlobalObject* globalObject, EncodedJSValue thisValue, PropertyName)</span>
<span class="line-added"> 620 {</span>
<span class="line-added"> 621     DollarVMAssertScope assertScope;</span>
<span class="line-added"> 622     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added"> 623 </span>
<span class="line-added"> 624     JSObject* thisObject = jsDynamicCast&lt;JSObject*&gt;(vm, JSValue::decode(thisValue));</span>
<span class="line-added"> 625     RELEASE_ASSERT(thisObject);</span>
<span class="line-added"> 626 </span>
<span class="line-added"> 627     if (JSValue result = thisObject-&gt;getDirect(vm, PropertyName(Identifier::fromString(vm, &quot;testField&quot;))))</span>
<span class="line-added"> 628         return JSValue::encode(result);</span>
<span class="line-added"> 629     return JSValue::encode(jsUndefined());</span>
<span class="line-added"> 630 }</span>
<span class="line-added"> 631 </span>
<span class="line-added"> 632 static bool testStaticAccessorPutter(JSGlobalObject* globalObject, EncodedJSValue thisValue, EncodedJSValue value)</span>
<span class="line-added"> 633 {</span>
<span class="line-added"> 634     DollarVMAssertScope assertScope;</span>
<span class="line-added"> 635     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added"> 636 </span>
<span class="line-added"> 637     JSObject* thisObject = jsDynamicCast&lt;JSObject*&gt;(vm, JSValue::decode(thisValue));</span>
<span class="line-added"> 638     RELEASE_ASSERT(thisObject);</span>
<span class="line-added"> 639 </span>
<span class="line-added"> 640     return thisObject-&gt;putDirect(vm, PropertyName(Identifier::fromString(vm, &quot;testField&quot;)), JSValue::decode(value));</span>
<span class="line-added"> 641 }</span>
<span class="line-added"> 642 </span>
<span class="line-added"> 643 static const struct HashTableValue staticCustomAccessorTableValues[1] = {</span>
<span class="line-added"> 644     { &quot;testStaticAccessor&quot;, static_cast&lt;unsigned&gt;(PropertyAttribute::CustomAccessor), NoIntrinsic, { (intptr_t)static_cast&lt;PropertySlot::GetValueFunc&gt;(testStaticAccessorGetter), (intptr_t)static_cast&lt;PutPropertySlot::PutValueFunc&gt;(testStaticAccessorPutter) } },</span>
<span class="line-added"> 645 };</span>
<span class="line-added"> 646 </span>
<span class="line-added"> 647 static const struct HashTable staticCustomAccessorTable =</span>
<span class="line-added"> 648     { 1, 1, true, nullptr, staticCustomAccessorTableValues, staticCustomAccessorTableIndex };</span>
<span class="line-added"> 649 </span>
<span class="line-added"> 650 class StaticCustomAccessor : public JSNonFinalObject {</span>
<span class="line-added"> 651     using Base = JSNonFinalObject;</span>
<span class="line-added"> 652 public:</span>
<span class="line-added"> 653     StaticCustomAccessor(VM&amp; vm, Structure* structure)</span>
<span class="line-added"> 654         : Base(vm, structure)</span>
<span class="line-added"> 655     {</span>
<span class="line-added"> 656         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 657     }</span>
<span class="line-added"> 658 </span>
<span class="line-added"> 659     DECLARE_INFO;</span>
<span class="line-added"> 660 </span>
<span class="line-added"> 661     static constexpr unsigned StructureFlags = Base::StructureFlags | HasStaticPropertyTable | OverridesGetOwnPropertySlot;</span>
<span class="line-added"> 662 </span>
<span class="line-added"> 663     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)</span>
<span class="line-added"> 664     {</span>
<span class="line-added"> 665         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 666         return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());</span>
<span class="line-added"> 667     }</span>
<span class="line-added"> 668 </span>
<span class="line-added"> 669     static StaticCustomAccessor* create(VM&amp; vm, Structure* structure)</span>
<span class="line-added"> 670     {</span>
<span class="line-added"> 671         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 672         StaticCustomAccessor* accessor = new (NotNull, allocateCell&lt;StaticCustomAccessor&gt;(vm.heap)) StaticCustomAccessor(vm, structure);</span>
<span class="line-added"> 673         accessor-&gt;finishCreation(vm);</span>
<span class="line-added"> 674         return accessor;</span>
<span class="line-added"> 675     }</span>
<span class="line-added"> 676 </span>
<span class="line-added"> 677     static bool getOwnPropertySlot(JSObject* thisObject, JSGlobalObject* globalObject, PropertyName propertyName, PropertySlot&amp; slot)</span>
<span class="line-added"> 678     {</span>
<span class="line-added"> 679         if (String(propertyName.uid()) == &quot;thinAirCustomGetter&quot;) {</span>
<span class="line-added"> 680             slot.setCacheableCustom(thisObject, PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum | PropertyAttribute::CustomAccessor, testStaticAccessorGetter);</span>
<span class="line-added"> 681             return true;</span>
<span class="line-added"> 682         }</span>
<span class="line-added"> 683         return JSNonFinalObject::getOwnPropertySlot(thisObject, globalObject, propertyName, slot);</span>
<span class="line-added"> 684     }</span>
<span class="line-added"> 685 };</span>
<span class="line-added"> 686 </span>
<span class="line-added"> 687 class ObjectDoingSideEffectPutWithoutCorrectSlotStatus : public JSNonFinalObject {</span>
<span class="line-added"> 688     using Base = JSNonFinalObject;</span>
<span class="line-added"> 689 public:</span>
<span class="line-added"> 690     ObjectDoingSideEffectPutWithoutCorrectSlotStatus(VM&amp; vm, Structure* structure)</span>
<span class="line-added"> 691         : Base(vm, structure)</span>
<span class="line-added"> 692     {</span>
<span class="line-added"> 693         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 694     }</span>
<span class="line-added"> 695 </span>
<span class="line-added"> 696     DECLARE_INFO;</span>
<span class="line-added"> 697 </span>
<span class="line-added"> 698     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)</span>
<span class="line-added"> 699     {</span>
<span class="line-added"> 700         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 701         return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());</span>
<span class="line-added"> 702     }</span>
<span class="line-added"> 703 </span>
<span class="line-added"> 704     static ObjectDoingSideEffectPutWithoutCorrectSlotStatus* create(VM&amp; vm, Structure* structure)</span>
<span class="line-added"> 705     {</span>
<span class="line-added"> 706         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 707         ObjectDoingSideEffectPutWithoutCorrectSlotStatus* accessor = new (NotNull, allocateCell&lt;ObjectDoingSideEffectPutWithoutCorrectSlotStatus&gt;(vm.heap)) ObjectDoingSideEffectPutWithoutCorrectSlotStatus(vm, structure);</span>
<span class="line-added"> 708         accessor-&gt;finishCreation(vm);</span>
<span class="line-added"> 709         return accessor;</span>
<span class="line-added"> 710     }</span>
<span class="line-added"> 711 </span>
<span class="line-added"> 712     static bool put(JSCell* cell, JSGlobalObject* globalObject, PropertyName propertyName, JSValue value, PutPropertySlot&amp; slot)</span>
<span class="line-added"> 713     {</span>
<span class="line-added"> 714         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 715         auto* thisObject = jsCast&lt;ObjectDoingSideEffectPutWithoutCorrectSlotStatus*&gt;(cell);</span>
<span class="line-added"> 716         auto throwScope = DECLARE_THROW_SCOPE(globalObject-&gt;vm());</span>
<span class="line-added"> 717         auto* string = value.toString(globalObject);</span>
<span class="line-added"> 718         RETURN_IF_EXCEPTION(throwScope, false);</span>
<span class="line-added"> 719         RELEASE_AND_RETURN(throwScope, Base::put(thisObject, globalObject, propertyName, string, slot));</span>
<span class="line-added"> 720     }</span>
<span class="line-added"> 721 };</span>
<span class="line-added"> 722 </span>
 723 class DOMJITNode : public JSNonFinalObject {
 724 public:
 725     DOMJITNode(VM&amp; vm, Structure* structure)
 726         : Base(vm, structure)
 727     {
<a name="83" id="anc83"></a><span class="line-added"> 728         DollarVMAssertScope assertScope;</span>
 729     }
 730 
 731     DECLARE_INFO;
 732     typedef JSNonFinalObject Base;
<a name="84" id="anc84"></a><span class="line-modified"> 733     static constexpr unsigned StructureFlags = Base::StructureFlags;</span>
 734 
 735     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
 736     {
<a name="85" id="anc85"></a><span class="line-added"> 737         DollarVMAssertScope assertScope;</span>
 738         return Structure::create(vm, globalObject, prototype, TypeInfo(JSC::JSType(LastJSCObjectType + 1), StructureFlags), info());
 739     }
 740 
 741 #if ENABLE(JIT)
 742     static Ref&lt;Snippet&gt; checkSubClassSnippet()
 743     {
<a name="86" id="anc86"></a><span class="line-added"> 744         DollarVMAssertScope assertScope;</span>
 745         Ref&lt;Snippet&gt; snippet = Snippet::create();
<a name="87" id="anc87"></a><span class="line-modified"> 746         snippet-&gt;setGenerator([=] (CCallHelpers&amp; jit, SnippetParams&amp; params) {</span>
<span class="line-added"> 747             DollarVMAssertScope assertScope;</span>
 748             CCallHelpers::JumpList failureCases;
 749             failureCases.append(jit.branchIfNotType(params[0].gpr(), JSC::JSType(LastJSCObjectType + 1)));
 750             return failureCases;
 751         });
 752         return snippet;
 753     }
 754 #endif
 755 
 756     static DOMJITNode* create(VM&amp; vm, Structure* structure)
 757     {
<a name="88" id="anc88"></a><span class="line-added"> 758         DollarVMAssertScope assertScope;</span>
 759         DOMJITNode* getter = new (NotNull, allocateCell&lt;DOMJITNode&gt;(vm.heap)) DOMJITNode(vm, structure);
 760         getter-&gt;finishCreation(vm);
 761         return getter;
 762     }
 763 
 764     int32_t value() const
 765     {
 766         return m_value;
 767     }
 768 
 769     static ptrdiff_t offsetOfValue() { return OBJECT_OFFSETOF(DOMJITNode, m_value); }
 770 
 771 private:
 772     int32_t m_value { 42 };
 773 };
 774 
 775 class DOMJITGetter : public DOMJITNode {
 776 public:
 777     DOMJITGetter(VM&amp; vm, Structure* structure)
 778         : Base(vm, structure)
 779     {
<a name="89" id="anc89"></a><span class="line-added"> 780         DollarVMAssertScope assertScope;</span>
 781     }
 782 
 783     DECLARE_INFO;
 784     typedef DOMJITNode Base;
<a name="90" id="anc90"></a><span class="line-modified"> 785     static constexpr unsigned StructureFlags = Base::StructureFlags;</span>
 786 
 787     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
 788     {
<a name="91" id="anc91"></a><span class="line-added"> 789         DollarVMAssertScope assertScope;</span>
 790         return Structure::create(vm, globalObject, prototype, TypeInfo(JSC::JSType(LastJSCObjectType + 1), StructureFlags), info());
 791     }
 792 
 793     static DOMJITGetter* create(VM&amp; vm, Structure* structure)
 794     {
<a name="92" id="anc92"></a><span class="line-added"> 795         DollarVMAssertScope assertScope;</span>
 796         DOMJITGetter* getter = new (NotNull, allocateCell&lt;DOMJITGetter&gt;(vm.heap)) DOMJITGetter(vm, structure);
 797         getter-&gt;finishCreation(vm);
 798         return getter;
 799     }
 800 
 801     class DOMJITAttribute : public DOMJIT::GetterSetter {
 802     public:
<a name="93" id="anc93"></a><span class="line-modified"> 803         ALWAYS_INLINE constexpr DOMJITAttribute()</span>
 804             : DOMJIT::GetterSetter(
 805                 DOMJITGetter::customGetter,
 806 #if ENABLE(JIT)
 807                 &amp;callDOMGetter,
 808 #else
 809                 nullptr,
 810 #endif
 811                 SpecInt32Only)
 812         {
 813         }
 814 
 815 #if ENABLE(JIT)
<a name="94" id="anc94"></a><span class="line-modified"> 816         static EncodedJSValue JIT_OPERATION slowCall(JSGlobalObject* globalObject, void* pointer)</span>
 817         {
<a name="95" id="anc95"></a><span class="line-modified"> 818             DollarVMAssertScope assertScope;</span>
<span class="line-modified"> 819             VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added"> 820             CallFrame* callFrame = DECLARE_CALL_FRAME(vm);</span>
<span class="line-added"> 821             JITOperationPrologueCallFrameTracer tracer(vm, callFrame);</span>
 822             return JSValue::encode(jsNumber(static_cast&lt;DOMJITGetter*&gt;(pointer)-&gt;value()));
 823         }
 824 
 825         static Ref&lt;DOMJIT::CallDOMGetterSnippet&gt; callDOMGetter()
 826         {
<a name="96" id="anc96"></a><span class="line-added"> 827             DollarVMAssertScope assertScope;</span>
 828             Ref&lt;DOMJIT::CallDOMGetterSnippet&gt; snippet = DOMJIT::CallDOMGetterSnippet::create();
<a name="97" id="anc97"></a><span class="line-modified"> 829             snippet-&gt;requireGlobalObject = true;</span>
<span class="line-modified"> 830             snippet-&gt;setGenerator([=] (CCallHelpers&amp; jit, SnippetParams&amp; params) {</span>
<span class="line-added"> 831                 DollarVMAssertScope assertScope;</span>
 832                 JSValueRegs results = params[0].jsValueRegs();
<a name="98" id="anc98"></a><span class="line-modified"> 833                 GPRReg domGPR = params[1].gpr();</span>
<span class="line-modified"> 834                 GPRReg globalObjectGPR = params[2].gpr();</span>
<span class="line-added"> 835                 params.addSlowPathCall(jit.jump(), jit, slowCall, results, globalObjectGPR, domGPR);</span>
 836                 return CCallHelpers::JumpList();
 837 
 838             });
 839             return snippet;
 840         }
 841 #endif
 842     };
 843 
 844 private:
 845     void finishCreation(VM&amp;);
 846 
<a name="99" id="anc99"></a><span class="line-modified"> 847     static EncodedJSValue customGetter(JSGlobalObject* globalObject, EncodedJSValue thisValue, PropertyName)</span>
 848     {
<a name="100" id="anc100"></a><span class="line-modified"> 849         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 850         VM&amp; vm = globalObject-&gt;vm();</span>
 851         DOMJITNode* thisObject = jsDynamicCast&lt;DOMJITNode*&gt;(vm, JSValue::decode(thisValue));
 852         ASSERT(thisObject);
 853         return JSValue::encode(jsNumber(thisObject-&gt;value()));
 854     }
 855 };
 856 
 857 static const DOMJITGetter::DOMJITAttribute DOMJITGetterDOMJIT;
 858 
 859 void DOMJITGetter::finishCreation(VM&amp; vm)
 860 {
<a name="101" id="anc101"></a><span class="line-added"> 861     DollarVMAssertScope assertScope;</span>
 862     Base::finishCreation(vm);
 863     const DOMJIT::GetterSetter* domJIT = &amp;DOMJITGetterDOMJIT;
 864     auto* customGetterSetter = DOMAttributeGetterSetter::create(vm, domJIT-&gt;getter(), nullptr, DOMAttributeAnnotation { DOMJITNode::info(), domJIT });
 865     putDirectCustomAccessor(vm, Identifier::fromString(vm, &quot;customGetter&quot;), customGetterSetter, PropertyAttribute::ReadOnly | PropertyAttribute::CustomAccessor);
 866 }
 867 
<a name="102" id="anc102"></a><span class="line-added"> 868 </span>
 869 class DOMJITGetterComplex : public DOMJITNode {
 870 public:
 871     DOMJITGetterComplex(VM&amp; vm, Structure* structure)
 872         : Base(vm, structure)
 873     {
<a name="103" id="anc103"></a><span class="line-added"> 874         DollarVMAssertScope assertScope;</span>
 875     }
 876 
 877     DECLARE_INFO;
 878     typedef DOMJITNode Base;
<a name="104" id="anc104"></a><span class="line-modified"> 879     static constexpr unsigned StructureFlags = Base::StructureFlags;</span>
 880 
 881     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
 882     {
<a name="105" id="anc105"></a><span class="line-added"> 883         DollarVMAssertScope assertScope;</span>
 884         return Structure::create(vm, globalObject, prototype, TypeInfo(JSC::JSType(LastJSCObjectType + 1), StructureFlags), info());
 885     }
 886 
 887     static DOMJITGetterComplex* create(VM&amp; vm, JSGlobalObject* globalObject, Structure* structure)
 888     {
<a name="106" id="anc106"></a><span class="line-added"> 889         DollarVMAssertScope assertScope;</span>
 890         DOMJITGetterComplex* getter = new (NotNull, allocateCell&lt;DOMJITGetterComplex&gt;(vm.heap)) DOMJITGetterComplex(vm, structure);
 891         getter-&gt;finishCreation(vm, globalObject);
 892         return getter;
 893     }
 894 
 895     class DOMJITAttribute : public DOMJIT::GetterSetter {
 896     public:
<a name="107" id="anc107"></a><span class="line-modified"> 897         ALWAYS_INLINE constexpr DOMJITAttribute()</span>
 898             : DOMJIT::GetterSetter(
 899                 DOMJITGetterComplex::customGetter,
 900 #if ENABLE(JIT)
 901                 &amp;callDOMGetter,
 902 #else
 903                 nullptr,
 904 #endif
 905                 SpecInt32Only)
 906         {
 907         }
 908 
 909 #if ENABLE(JIT)
<a name="108" id="anc108"></a><span class="line-modified"> 910         static EncodedJSValue JIT_OPERATION slowCall(JSGlobalObject* globalObject, void* pointer)</span>
 911         {
<a name="109" id="anc109"></a><span class="line-modified"> 912             DollarVMAssertScope assertScope;</span>
<span class="line-modified"> 913             VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added"> 914             CallFrame* callFrame = DECLARE_CALL_FRAME(vm);</span>
<span class="line-added"> 915             JITOperationPrologueCallFrameTracer tracer(vm, callFrame);</span>
 916             auto scope = DECLARE_THROW_SCOPE(vm);
 917             auto* object = static_cast&lt;DOMJITNode*&gt;(pointer);
 918             auto* domjitGetterComplex = jsDynamicCast&lt;DOMJITGetterComplex*&gt;(vm, object);
 919             if (domjitGetterComplex) {
 920                 if (domjitGetterComplex-&gt;m_enableException)
<a name="110" id="anc110"></a><span class="line-modified"> 921                     return JSValue::encode(throwException(globalObject, scope, createError(globalObject, &quot;DOMJITGetterComplex slow call exception&quot;_s)));</span>
 922             }
 923             return JSValue::encode(jsNumber(object-&gt;value()));
 924         }
 925 
 926         static Ref&lt;DOMJIT::CallDOMGetterSnippet&gt; callDOMGetter()
 927         {
<a name="111" id="anc111"></a><span class="line-added"> 928             DollarVMAssertScope assertScope;</span>
 929             Ref&lt;DOMJIT::CallDOMGetterSnippet&gt; snippet = DOMJIT::CallDOMGetterSnippet::create();
 930             static_assert(GPRInfo::numberOfRegisters &gt;= 4, &quot;Number of registers should be larger or equal to 4.&quot;);
 931             unsigned numGPScratchRegisters = GPRInfo::numberOfRegisters - 4;
 932             snippet-&gt;numGPScratchRegisters = numGPScratchRegisters;
 933             snippet-&gt;numFPScratchRegisters = 3;
<a name="112" id="anc112"></a><span class="line-modified"> 934             snippet-&gt;requireGlobalObject = true;</span>
<span class="line-added"> 935             snippet-&gt;setGenerator([=] (CCallHelpers&amp; jit, SnippetParams&amp; params) {</span>
<span class="line-added"> 936                 DollarVMAssertScope assertScope;</span>
 937                 JSValueRegs results = params[0].jsValueRegs();
 938                 GPRReg domGPR = params[1].gpr();
<a name="113" id="anc113"></a><span class="line-added"> 939                 GPRReg globalObjectGPR = params[2].gpr();</span>
 940                 for (unsigned i = 0; i &lt; numGPScratchRegisters; ++i)
 941                     jit.move(CCallHelpers::TrustedImm32(42), params.gpScratch(i));
 942 
<a name="114" id="anc114"></a><span class="line-modified"> 943                 params.addSlowPathCall(jit.jump(), jit, slowCall, results, globalObjectGPR, domGPR);</span>
 944                 return CCallHelpers::JumpList();
 945             });
 946             return snippet;
 947         }
 948 #endif
 949     };
 950 
 951 private:
 952     void finishCreation(VM&amp;, JSGlobalObject*);
 953 
<a name="115" id="anc115"></a><span class="line-modified"> 954     static EncodedJSValue JSC_HOST_CALL functionEnableException(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 955     {
<a name="116" id="anc116"></a><span class="line-modified"> 956         DollarVMAssertScope assertScope;</span>
<span class="line-modified"> 957         VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added"> 958         auto* object = jsDynamicCast&lt;DOMJITGetterComplex*&gt;(vm, callFrame-&gt;thisValue());</span>
 959         if (object)
 960             object-&gt;m_enableException = true;
 961         return JSValue::encode(jsUndefined());
 962     }
 963 
<a name="117" id="anc117"></a><span class="line-modified"> 964     static EncodedJSValue customGetter(JSGlobalObject* globalObject, EncodedJSValue thisValue, PropertyName)</span>
 965     {
<a name="118" id="anc118"></a><span class="line-modified"> 966         DollarVMAssertScope assertScope;</span>
<span class="line-added"> 967         VM&amp; vm = globalObject-&gt;vm();</span>
 968         auto scope = DECLARE_THROW_SCOPE(vm);
 969 
 970         auto* thisObject = jsDynamicCast&lt;DOMJITGetterComplex*&gt;(vm, JSValue::decode(thisValue));
 971         ASSERT(thisObject);
 972         if (thisObject-&gt;m_enableException)
<a name="119" id="anc119"></a><span class="line-modified"> 973             return JSValue::encode(throwException(globalObject, scope, createError(globalObject, &quot;DOMJITGetterComplex slow call exception&quot;_s)));</span>
 974         return JSValue::encode(jsNumber(thisObject-&gt;value()));
 975     }
 976 
 977     bool m_enableException { false };
 978 };
 979 
 980 static const DOMJITGetterComplex::DOMJITAttribute DOMJITGetterComplexDOMJIT;
 981 
 982 void DOMJITGetterComplex::finishCreation(VM&amp; vm, JSGlobalObject* globalObject)
 983 {
<a name="120" id="anc120"></a><span class="line-added"> 984     DollarVMAssertScope assertScope;</span>
 985     Base::finishCreation(vm);
 986     const DOMJIT::GetterSetter* domJIT = &amp;DOMJITGetterComplexDOMJIT;
 987     auto* customGetterSetter = DOMAttributeGetterSetter::create(vm, domJIT-&gt;getter(), nullptr, DOMAttributeAnnotation { DOMJITGetterComplex::info(), domJIT });
 988     putDirectCustomAccessor(vm, Identifier::fromString(vm, &quot;customGetter&quot;), customGetterSetter, PropertyAttribute::ReadOnly | PropertyAttribute::CustomAccessor);
 989     putDirectNativeFunction(vm, globalObject, Identifier::fromString(vm, &quot;enableException&quot;), 0, functionEnableException, NoIntrinsic, 0);
 990 }
 991 
 992 class DOMJITFunctionObject : public DOMJITNode {
 993 public:
 994     DOMJITFunctionObject(VM&amp; vm, Structure* structure)
 995         : Base(vm, structure)
 996     {
<a name="121" id="anc121"></a><span class="line-added"> 997         DollarVMAssertScope assertScope;</span>
 998     }
 999 
1000     DECLARE_INFO;
1001     typedef DOMJITNode Base;
<a name="122" id="anc122"></a><span class="line-modified">1002     static constexpr unsigned StructureFlags = Base::StructureFlags;</span>

1003 
1004     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
1005     {
<a name="123" id="anc123"></a><span class="line-added">1006         DollarVMAssertScope assertScope;</span>
1007         return Structure::create(vm, globalObject, prototype, TypeInfo(JSC::JSType(LastJSCObjectType + 1), StructureFlags), info());
1008     }
1009 
1010     static DOMJITFunctionObject* create(VM&amp; vm, JSGlobalObject* globalObject, Structure* structure)
1011     {
<a name="124" id="anc124"></a><span class="line-added">1012         DollarVMAssertScope assertScope;</span>
1013         DOMJITFunctionObject* object = new (NotNull, allocateCell&lt;DOMJITFunctionObject&gt;(vm.heap)) DOMJITFunctionObject(vm, structure);
1014         object-&gt;finishCreation(vm, globalObject);
1015         return object;
1016     }
1017 
<a name="125" id="anc125"></a><span class="line-modified">1018     static EncodedJSValue JSC_HOST_CALL functionWithTypeCheck(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1019     {
<a name="126" id="anc126"></a><span class="line-modified">1020         DollarVMAssertScope assertScope;</span>
<span class="line-added">1021         VM&amp; vm = globalObject-&gt;vm();</span>
1022         auto scope = DECLARE_THROW_SCOPE(vm);
1023 
<a name="127" id="anc127"></a><span class="line-modified">1024         DOMJITNode* thisObject = jsDynamicCast&lt;DOMJITNode*&gt;(vm, callFrame-&gt;thisValue());</span>
1025         if (!thisObject)
<a name="128" id="anc128"></a><span class="line-modified">1026             return throwVMTypeError(globalObject, scope);</span>
1027         return JSValue::encode(jsNumber(thisObject-&gt;value()));
1028     }
1029 
<a name="129" id="anc129"></a><span class="line-modified">1030     static EncodedJSValue JIT_OPERATION functionWithoutTypeCheck(JSGlobalObject* globalObject, DOMJITNode* node)</span>
1031     {
<a name="130" id="anc130"></a><span class="line-modified">1032         DollarVMAssertScope assertScope;</span>
<span class="line-modified">1033         VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">1034         CallFrame* callFrame = DECLARE_CALL_FRAME(vm);</span>
<span class="line-added">1035         JITOperationPrologueCallFrameTracer tracer(vm, callFrame);</span>
1036         return JSValue::encode(jsNumber(node-&gt;value()));
1037     }
1038 
1039 #if ENABLE(JIT)
1040     static Ref&lt;Snippet&gt; checkSubClassSnippet()
1041     {
<a name="131" id="anc131"></a><span class="line-added">1042         DollarVMAssertScope assertScope;</span>
1043         Ref&lt;Snippet&gt; snippet = Snippet::create();
1044         snippet-&gt;numFPScratchRegisters = 1;
<a name="132" id="anc132"></a><span class="line-modified">1045         snippet-&gt;setGenerator([=] (CCallHelpers&amp; jit, SnippetParams&amp; params) {</span>
<span class="line-added">1046             DollarVMAssertScope assertScope;</span>
1047             static const double value = 42.0;
1048             CCallHelpers::JumpList failureCases;
1049             // May use scratch registers.
1050             jit.loadDouble(CCallHelpers::TrustedImmPtr(&amp;value), params.fpScratch(0));
1051             failureCases.append(jit.branchIfNotType(params[0].gpr(), JSC::JSType(LastJSCObjectType + 1)));
1052             return failureCases;
1053         });
1054         return snippet;
1055     }
1056 #endif
1057 
1058 private:
1059     void finishCreation(VM&amp;, JSGlobalObject*);
1060 };
1061 
1062 static const DOMJIT::Signature DOMJITFunctionObjectSignature(DOMJITFunctionObject::functionWithoutTypeCheck, DOMJITFunctionObject::info(), DOMJIT::Effect::forRead(DOMJIT::HeapRange::top()), SpecInt32Only);
1063 
1064 void DOMJITFunctionObject::finishCreation(VM&amp; vm, JSGlobalObject* globalObject)
1065 {
<a name="133" id="anc133"></a><span class="line-added">1066     DollarVMAssertScope assertScope;</span>
1067     Base::finishCreation(vm);
1068     putDirectNativeFunction(vm, globalObject, Identifier::fromString(vm, &quot;func&quot;), 0, functionWithTypeCheck, NoIntrinsic, &amp;DOMJITFunctionObjectSignature, static_cast&lt;unsigned&gt;(PropertyAttribute::ReadOnly));
1069 }
1070 
1071 class DOMJITCheckSubClassObject : public DOMJITNode {
1072 public:
1073     DOMJITCheckSubClassObject(VM&amp; vm, Structure* structure)
1074         : Base(vm, structure)
1075     {
<a name="134" id="anc134"></a><span class="line-added">1076         DollarVMAssertScope assertScope;</span>
1077     }
1078 
1079     DECLARE_INFO;
1080     typedef DOMJITNode Base;
<a name="135" id="anc135"></a><span class="line-modified">1081     static constexpr unsigned StructureFlags = Base::StructureFlags;</span>

1082 
1083     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
1084     {
<a name="136" id="anc136"></a><span class="line-added">1085         DollarVMAssertScope assertScope;</span>
1086         return Structure::create(vm, globalObject, prototype, TypeInfo(JSC::JSType(LastJSCObjectType + 1), StructureFlags), info());
1087     }
1088 
1089     static DOMJITCheckSubClassObject* create(VM&amp; vm, JSGlobalObject* globalObject, Structure* structure)
1090     {
<a name="137" id="anc137"></a><span class="line-added">1091         DollarVMAssertScope assertScope;</span>
1092         DOMJITCheckSubClassObject* object = new (NotNull, allocateCell&lt;DOMJITCheckSubClassObject&gt;(vm.heap)) DOMJITCheckSubClassObject(vm, structure);
1093         object-&gt;finishCreation(vm, globalObject);
1094         return object;
1095     }
1096 
<a name="138" id="anc138"></a><span class="line-modified">1097     static EncodedJSValue JSC_HOST_CALL functionWithTypeCheck(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1098     {
<a name="139" id="anc139"></a><span class="line-modified">1099         DollarVMAssertScope assertScope;</span>
<span class="line-added">1100         VM&amp; vm = globalObject-&gt;vm();</span>
1101         auto scope = DECLARE_THROW_SCOPE(vm);
1102 
<a name="140" id="anc140"></a><span class="line-modified">1103         auto* thisObject = jsDynamicCast&lt;DOMJITCheckSubClassObject*&gt;(vm, callFrame-&gt;thisValue());</span>
1104         if (!thisObject)
<a name="141" id="anc141"></a><span class="line-modified">1105             return throwVMTypeError(globalObject, scope);</span>
1106         return JSValue::encode(jsNumber(thisObject-&gt;value()));
1107     }
1108 
<a name="142" id="anc142"></a><span class="line-modified">1109     static EncodedJSValue JIT_OPERATION functionWithoutTypeCheck(JSGlobalObject* globalObject, DOMJITNode* node)</span>
1110     {
<a name="143" id="anc143"></a><span class="line-modified">1111         DollarVMAssertScope assertScope;</span>
<span class="line-modified">1112         VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">1113         CallFrame* callFrame = DECLARE_CALL_FRAME(vm);</span>
<span class="line-added">1114         JITOperationPrologueCallFrameTracer tracer(vm, callFrame);</span>
1115         return JSValue::encode(jsNumber(node-&gt;value()));
1116     }
1117 
1118 private:
1119     void finishCreation(VM&amp;, JSGlobalObject*);
1120 };
1121 
1122 static const DOMJIT::Signature DOMJITCheckSubClassObjectSignature(DOMJITCheckSubClassObject::functionWithoutTypeCheck, DOMJITCheckSubClassObject::info(), DOMJIT::Effect::forRead(DOMJIT::HeapRange::top()), SpecInt32Only);
1123 
1124 void DOMJITCheckSubClassObject::finishCreation(VM&amp; vm, JSGlobalObject* globalObject)
1125 {
<a name="144" id="anc144"></a><span class="line-added">1126     DollarVMAssertScope assertScope;</span>
1127     Base::finishCreation(vm);
1128     putDirectNativeFunction(vm, globalObject, Identifier::fromString(vm, &quot;func&quot;), 0, functionWithTypeCheck, NoIntrinsic, &amp;DOMJITCheckSubClassObjectSignature, static_cast&lt;unsigned&gt;(PropertyAttribute::ReadOnly));
1129 }
1130 
1131 class DOMJITGetterBaseJSObject : public DOMJITNode {
1132 public:
1133     DOMJITGetterBaseJSObject(VM&amp; vm, Structure* structure)
1134         : Base(vm, structure)
1135     {
<a name="145" id="anc145"></a><span class="line-added">1136         DollarVMAssertScope assertScope;</span>
1137     }
1138 
1139     DECLARE_INFO;
1140     using Base = DOMJITNode;
<a name="146" id="anc146"></a><span class="line-modified">1141     static constexpr unsigned StructureFlags = Base::StructureFlags;</span>
1142 
1143     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
1144     {
<a name="147" id="anc147"></a><span class="line-added">1145         DollarVMAssertScope assertScope;</span>
1146         return Structure::create(vm, globalObject, prototype, TypeInfo(JSC::JSType(LastJSCObjectType + 1), StructureFlags), info());
1147     }
1148 
1149     static DOMJITGetterBaseJSObject* create(VM&amp; vm, Structure* structure)
1150     {
<a name="148" id="anc148"></a><span class="line-added">1151         DollarVMAssertScope assertScope;</span>
1152         DOMJITGetterBaseJSObject* getter = new (NotNull, allocateCell&lt;DOMJITGetterBaseJSObject&gt;(vm.heap)) DOMJITGetterBaseJSObject(vm, structure);
1153         getter-&gt;finishCreation(vm);
1154         return getter;
1155     }
1156 
1157     class DOMJITAttribute : public DOMJIT::GetterSetter {
1158     public:
<a name="149" id="anc149"></a><span class="line-modified">1159         ALWAYS_INLINE constexpr DOMJITAttribute()</span>
1160             : DOMJIT::GetterSetter(
1161                 DOMJITGetterBaseJSObject::customGetter,
1162 #if ENABLE(JIT)
1163                 &amp;callDOMGetter,
1164 #else
1165                 nullptr,
1166 #endif
1167                 SpecBytecodeTop)
1168         {
1169         }
1170 
1171 #if ENABLE(JIT)
<a name="150" id="anc150"></a><span class="line-modified">1172         static EncodedJSValue JIT_OPERATION slowCall(JSGlobalObject* globalObject, void* pointer)</span>
1173         {
<a name="151" id="anc151"></a><span class="line-modified">1174             DollarVMAssertScope assertScope;</span>
<span class="line-modified">1175             VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">1176             CallFrame* callFrame = DECLARE_CALL_FRAME(vm);</span>
<span class="line-added">1177             JITOperationPrologueCallFrameTracer tracer(vm, callFrame);</span>
1178             JSObject* object = static_cast&lt;JSObject*&gt;(pointer);
1179             return JSValue::encode(object-&gt;getPrototypeDirect(vm));
1180         }
1181 
1182         static Ref&lt;DOMJIT::CallDOMGetterSnippet&gt; callDOMGetter()
1183         {
<a name="152" id="anc152"></a><span class="line-added">1184             DollarVMAssertScope assertScope;</span>
1185             Ref&lt;DOMJIT::CallDOMGetterSnippet&gt; snippet = DOMJIT::CallDOMGetterSnippet::create();
<a name="153" id="anc153"></a><span class="line-modified">1186             snippet-&gt;requireGlobalObject = true;</span>
<span class="line-modified">1187             snippet-&gt;setGenerator([=] (CCallHelpers&amp; jit, SnippetParams&amp; params) {</span>
<span class="line-added">1188                 DollarVMAssertScope assertScope;</span>
1189                 JSValueRegs results = params[0].jsValueRegs();
<a name="154" id="anc154"></a><span class="line-modified">1190                 GPRReg domGPR = params[1].gpr();</span>
<span class="line-modified">1191                 GPRReg globalObjectGPR = params[2].gpr();</span>
<span class="line-added">1192                 params.addSlowPathCall(jit.jump(), jit, slowCall, results, globalObjectGPR, domGPR);</span>
1193                 return CCallHelpers::JumpList();
1194 
1195             });
1196             return snippet;
1197         }
1198 #endif
1199     };
1200 
1201 private:
1202     void finishCreation(VM&amp;);
1203 
<a name="155" id="anc155"></a><span class="line-modified">1204     static EncodedJSValue customGetter(JSGlobalObject* globalObject, EncodedJSValue thisValue, PropertyName)</span>
1205     {
<a name="156" id="anc156"></a><span class="line-modified">1206         DollarVMAssertScope assertScope;</span>
<span class="line-added">1207         VM&amp; vm = globalObject-&gt;vm();</span>
1208         JSObject* thisObject = jsDynamicCast&lt;JSObject*&gt;(vm, JSValue::decode(thisValue));
1209         RELEASE_ASSERT(thisObject);
1210         return JSValue::encode(thisObject-&gt;getPrototypeDirect(vm));
1211     }
1212 };
1213 
1214 static const DOMJITGetterBaseJSObject::DOMJITAttribute DOMJITGetterBaseJSObjectDOMJIT;
1215 
1216 void DOMJITGetterBaseJSObject::finishCreation(VM&amp; vm)
1217 {
<a name="157" id="anc157"></a><span class="line-added">1218     DollarVMAssertScope assertScope;</span>
1219     Base::finishCreation(vm);
1220     const DOMJIT::GetterSetter* domJIT = &amp;DOMJITGetterBaseJSObjectDOMJIT;
1221     auto* customGetterSetter = DOMAttributeGetterSetter::create(vm, domJIT-&gt;getter(), nullptr, DOMAttributeAnnotation { JSObject::info(), domJIT });
1222     putDirectCustomAccessor(vm, Identifier::fromString(vm, &quot;customGetter&quot;), customGetterSetter, PropertyAttribute::ReadOnly | PropertyAttribute::CustomAccessor);
1223 }
1224 
1225 class Message : public ThreadSafeRefCounted&lt;Message&gt; {
1226 public:
1227     Message(ArrayBufferContents&amp;&amp;, int32_t);
1228     ~Message();
1229 
1230     ArrayBufferContents&amp;&amp; releaseContents() { return WTFMove(m_contents); }
1231     int32_t index() const { return m_index; }
1232 
1233 private:
1234     ArrayBufferContents m_contents;
1235     int32_t m_index { 0 };
1236 };
1237 
1238 class JSTestCustomGetterSetter : public JSNonFinalObject {
1239 public:
1240     using Base = JSNonFinalObject;
<a name="158" id="anc158"></a><span class="line-modified">1241     static constexpr unsigned StructureFlags = Base::StructureFlags;</span>
1242 
1243     JSTestCustomGetterSetter(VM&amp; vm, Structure* structure)
1244         : Base(vm, structure)
<a name="159" id="anc159"></a><span class="line-modified">1245     {</span>
<span class="line-added">1246         DollarVMAssertScope assertScope;</span>
<span class="line-added">1247     }</span>
1248 
1249     static JSTestCustomGetterSetter* create(VM&amp; vm, JSGlobalObject*, Structure* structure)
1250     {
<a name="160" id="anc160"></a><span class="line-added">1251         DollarVMAssertScope assertScope;</span>
1252         JSTestCustomGetterSetter* result = new (NotNull, allocateCell&lt;JSTestCustomGetterSetter&gt;(vm.heap)) JSTestCustomGetterSetter(vm, structure);
1253         result-&gt;finishCreation(vm);
1254         return result;
1255     }
1256 
1257     void finishCreation(VM&amp;);
1258 
1259     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject)
1260     {
<a name="161" id="anc161"></a><span class="line-added">1261         DollarVMAssertScope assertScope;</span>
1262         return Structure::create(vm, globalObject, globalObject-&gt;objectPrototype(), TypeInfo(ObjectType, StructureFlags), info());
1263     }
1264 
1265     DECLARE_INFO;
1266 };
1267 
1268 
<a name="162" id="anc162"></a><span class="line-modified">1269 static EncodedJSValue customGetAccessor(JSGlobalObject*, EncodedJSValue thisValue, PropertyName)</span>
1270 {
1271     // Passed |this|
1272     return thisValue;
1273 }
1274 
<a name="163" id="anc163"></a><span class="line-modified">1275 static EncodedJSValue customGetValue(JSGlobalObject* globalObject, EncodedJSValue slotValue, PropertyName)</span>
1276 {
<a name="164" id="anc164"></a><span class="line-modified">1277     RELEASE_ASSERT(JSValue::decode(slotValue).inherits&lt;JSTestCustomGetterSetter&gt;(globalObject-&gt;vm()));</span>
1278     // Passed property holder.
1279     return slotValue;
1280 }
1281 
<a name="165" id="anc165"></a><span class="line-modified">1282 static bool customSetAccessor(JSGlobalObject* globalObject, EncodedJSValue thisObject, EncodedJSValue encodedValue)</span>
1283 {
<a name="166" id="anc166"></a><span class="line-modified">1284     DollarVMAssertScope assertScope;</span>
<span class="line-added">1285     VM&amp; vm = globalObject-&gt;vm();</span>
1286 
1287     JSValue value = JSValue::decode(encodedValue);
1288     RELEASE_ASSERT(value.isObject());
1289     JSObject* object = asObject(value);
1290     PutPropertySlot slot(object);
<a name="167" id="anc167"></a><span class="line-modified">1291     object-&gt;put(object, globalObject, Identifier::fromString(vm, &quot;result&quot;), JSValue::decode(thisObject), slot);</span>
1292 
1293     return true;
1294 }
1295 
<a name="168" id="anc168"></a><span class="line-modified">1296 static bool customSetValue(JSGlobalObject* globalObject, EncodedJSValue slotValue, EncodedJSValue encodedValue)</span>
1297 {
<a name="169" id="anc169"></a><span class="line-modified">1298     DollarVMAssertScope assertScope;</span>
<span class="line-added">1299     VM&amp; vm = globalObject-&gt;vm();</span>
1300 
<a name="170" id="anc170"></a><span class="line-modified">1301     RELEASE_ASSERT(JSValue::decode(slotValue).inherits&lt;JSTestCustomGetterSetter&gt;(globalObject-&gt;vm()));</span>
1302 
1303     JSValue value = JSValue::decode(encodedValue);
1304     RELEASE_ASSERT(value.isObject());
1305     JSObject* object = asObject(value);
1306     PutPropertySlot slot(object);
<a name="171" id="anc171"></a><span class="line-modified">1307     object-&gt;put(object, globalObject, Identifier::fromString(vm, &quot;result&quot;), JSValue::decode(slotValue), slot);</span>
1308 
1309     return true;
1310 }
1311 
1312 void JSTestCustomGetterSetter::finishCreation(VM&amp; vm)
1313 {
<a name="172" id="anc172"></a><span class="line-added">1314     DollarVMAssertScope assertScope;</span>
1315     Base::finishCreation(vm);
1316 
1317     putDirectCustomAccessor(vm, Identifier::fromString(vm, &quot;customValue&quot;),
1318         CustomGetterSetter::create(vm, customGetValue, customSetValue), 0);
1319     putDirectCustomAccessor(vm, Identifier::fromString(vm, &quot;customAccessor&quot;),
1320         CustomGetterSetter::create(vm, customGetAccessor, customSetAccessor), static_cast&lt;unsigned&gt;(PropertyAttribute::CustomAccessor));
1321 }
1322 
1323 const ClassInfo Element::s_info = { &quot;Element&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(Element) };
1324 const ClassInfo Root::s_info = { &quot;Root&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(Root) };
1325 const ClassInfo SimpleObject::s_info = { &quot;SimpleObject&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(SimpleObject) };
1326 const ClassInfo ImpureGetter::s_info = { &quot;ImpureGetter&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(ImpureGetter) };
1327 const ClassInfo CustomGetter::s_info = { &quot;CustomGetter&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(CustomGetter) };
1328 const ClassInfo RuntimeArray::s_info = { &quot;RuntimeArray&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(RuntimeArray) };
1329 #if ENABLE(JIT)
1330 const ClassInfo DOMJITNode::s_info = { &quot;DOMJITNode&quot;, &amp;Base::s_info, nullptr, &amp;DOMJITNode::checkSubClassSnippet, CREATE_METHOD_TABLE(DOMJITNode) };
1331 #else
1332 const ClassInfo DOMJITNode::s_info = { &quot;DOMJITNode&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(DOMJITNode) };
1333 #endif
1334 const ClassInfo DOMJITGetter::s_info = { &quot;DOMJITGetter&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(DOMJITGetter) };
1335 const ClassInfo DOMJITGetterComplex::s_info = { &quot;DOMJITGetterComplex&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(DOMJITGetterComplex) };
1336 const ClassInfo DOMJITGetterBaseJSObject::s_info = { &quot;DOMJITGetterBaseJSObject&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(DOMJITGetterBaseJSObject) };
1337 #if ENABLE(JIT)
1338 const ClassInfo DOMJITFunctionObject::s_info = { &quot;DOMJITFunctionObject&quot;, &amp;Base::s_info, nullptr, &amp;DOMJITFunctionObject::checkSubClassSnippet, CREATE_METHOD_TABLE(DOMJITFunctionObject) };
1339 #else
1340 const ClassInfo DOMJITFunctionObject::s_info = { &quot;DOMJITFunctionObject&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(DOMJITFunctionObject) };
1341 #endif
1342 const ClassInfo DOMJITCheckSubClassObject::s_info = { &quot;DOMJITCheckSubClassObject&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(DOMJITCheckSubClassObject) };
1343 const ClassInfo JSTestCustomGetterSetter::s_info = { &quot;JSTestCustomGetterSetter&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSTestCustomGetterSetter) };
1344 
<a name="173" id="anc173"></a><span class="line-added">1345 const ClassInfo StaticCustomAccessor::s_info = { &quot;StaticCustomAccessor&quot;, &amp;Base::s_info, &amp;staticCustomAccessorTable, nullptr, CREATE_METHOD_TABLE(StaticCustomAccessor) };</span>
<span class="line-added">1346 const ClassInfo ObjectDoingSideEffectPutWithoutCorrectSlotStatus::s_info = { &quot;ObjectDoingSideEffectPutWithoutCorrectSlotStatus&quot;, &amp;Base::s_info, &amp;staticCustomAccessorTable, nullptr, CREATE_METHOD_TABLE(ObjectDoingSideEffectPutWithoutCorrectSlotStatus) };</span>
<span class="line-added">1347 </span>
1348 ElementHandleOwner* Element::handleOwner()
1349 {
<a name="174" id="anc174"></a><span class="line-added">1350     DollarVMAssertScope assertScope;</span>
1351     static ElementHandleOwner* owner = 0;
1352     if (!owner)
1353         owner = new ElementHandleOwner();
1354     return owner;
1355 }
1356 
1357 void Element::finishCreation(VM&amp; vm, Root* root)
1358 {
<a name="175" id="anc175"></a><span class="line-added">1359     DollarVMAssertScope assertScope;</span>
1360     Base::finishCreation(vm);
1361     setRoot(vm, root);
1362     m_root-&gt;setElement(this);
1363 }
1364 
1365 #if ENABLE(WEBASSEMBLY)
1366 
<a name="176" id="anc176"></a><span class="line-modified">1367 static EncodedJSValue JSC_HOST_CALL functionWasmStreamingParserAddBytes(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">1368 static EncodedJSValue JSC_HOST_CALL functionWasmStreamingParserFinalize(JSGlobalObject*, CallFrame*);</span>
1369 
1370 class WasmStreamingParser : public JSDestructibleObject {
1371 public:
<a name="177" id="anc177"></a><span class="line-added">1372     class Client final : public Wasm::StreamingParserClient {</span>
<span class="line-added">1373     public:</span>
<span class="line-added">1374         explicit Client(WasmStreamingParser* parser)</span>
<span class="line-added">1375             : m_parser(parser)</span>
<span class="line-added">1376         {</span>
<span class="line-added">1377         }</span>
<span class="line-added">1378 </span>
<span class="line-added">1379         bool didReceiveSectionData(Wasm::Section) override { return true; }</span>
<span class="line-added">1380         bool didReceiveFunctionData(unsigned, const Wasm::FunctionData&amp;) override { return true; }</span>
<span class="line-added">1381         void didFinishParsing() override { }</span>
<span class="line-added">1382 </span>
<span class="line-added">1383         WasmStreamingParser* m_parser;</span>
<span class="line-added">1384     };</span>
<span class="line-added">1385 </span>
1386     WasmStreamingParser(VM&amp; vm, Structure* structure)
1387         : Base(vm, structure)
1388         , m_info(Wasm::ModuleInformation::create())
<a name="178" id="anc178"></a><span class="line-modified">1389         , m_client(this)</span>
<span class="line-added">1390         , m_streamingParser(m_info.get(), m_client)</span>
1391     {
<a name="179" id="anc179"></a><span class="line-added">1392         DollarVMAssertScope assertScope;</span>
1393     }
1394 
1395     using Base = JSDestructibleObject;
1396 
1397     static WasmStreamingParser* create(VM&amp; vm, JSGlobalObject* globalObject)
1398     {
<a name="180" id="anc180"></a><span class="line-added">1399         DollarVMAssertScope assertScope;</span>
1400         Structure* structure = createStructure(vm, globalObject, jsNull());
1401         WasmStreamingParser* result = new (NotNull, allocateCell&lt;WasmStreamingParser&gt;(vm.heap)) WasmStreamingParser(vm, structure);
1402         result-&gt;finishCreation(vm);
1403         return result;
1404     }
1405 
1406     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
1407     {
<a name="181" id="anc181"></a><span class="line-added">1408         DollarVMAssertScope assertScope;</span>
1409         return Structure::create(vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
1410     }
1411 
1412     Wasm::StreamingParser&amp; streamingParser() { return m_streamingParser; }
1413 
1414     void finishCreation(VM&amp; vm)
1415     {
<a name="182" id="anc182"></a><span class="line-added">1416         DollarVMAssertScope assertScope;</span>
1417         Base::finishCreation(vm);
1418 
1419         JSGlobalObject* globalObject = this-&gt;globalObject(vm);
1420         putDirectNativeFunction(vm, globalObject, Identifier::fromString(vm, &quot;addBytes&quot;), 0, functionWasmStreamingParserAddBytes, NoIntrinsic, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
1421         putDirectNativeFunction(vm, globalObject, Identifier::fromString(vm, &quot;finalize&quot;), 0, functionWasmStreamingParserFinalize, NoIntrinsic, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
1422     }
1423 
1424     DECLARE_INFO;
1425 
1426     Ref&lt;Wasm::ModuleInformation&gt; m_info;
<a name="183" id="anc183"></a><span class="line-added">1427     Client m_client;</span>
1428     Wasm::StreamingParser m_streamingParser;
1429 };
1430 
1431 const ClassInfo WasmStreamingParser::s_info = { &quot;WasmStreamingParser&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(WasmStreamingParser) };
1432 
<a name="184" id="anc184"></a><span class="line-modified">1433 EncodedJSValue JSC_HOST_CALL functionWasmStreamingParserAddBytes(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1434 {
<a name="185" id="anc185"></a><span class="line-modified">1435     DollarVMAssertScope assertScope;</span>
<span class="line-modified">1436     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">1437     auto scope = DECLARE_THROW_SCOPE(globalObject-&gt;vm());</span>
<span class="line-added">1438 </span>
<span class="line-added">1439     auto* thisObject = jsDynamicCast&lt;WasmStreamingParser*&gt;(vm, callFrame-&gt;thisValue());</span>
1440     if (!thisObject)
1441         RELEASE_AND_RETURN(scope, JSValue::encode(jsBoolean(false)));
1442 
<a name="186" id="anc186"></a><span class="line-modified">1443     auto data = getWasmBufferFromValue(globalObject, callFrame-&gt;argument(0));</span>
1444     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1445     RELEASE_AND_RETURN(scope, JSValue::encode(jsNumber(static_cast&lt;int32_t&gt;(thisObject-&gt;streamingParser().addBytes(bitwise_cast&lt;const uint8_t*&gt;(data.first), data.second)))));
1446 }
1447 
<a name="187" id="anc187"></a><span class="line-modified">1448 EncodedJSValue JSC_HOST_CALL functionWasmStreamingParserFinalize(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1449 {
<a name="188" id="anc188"></a><span class="line-modified">1450     DollarVMAssertScope assertScope;</span>
<span class="line-modified">1451     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">1452     auto* thisObject = jsDynamicCast&lt;WasmStreamingParser*&gt;(vm, callFrame-&gt;thisValue());</span>
1453     if (!thisObject)
1454         return JSValue::encode(jsBoolean(false));
1455     return JSValue::encode(jsNumber(static_cast&lt;int32_t&gt;(thisObject-&gt;streamingParser().finalize())));
1456 }
1457 
1458 #endif
1459 
1460 } // namespace
1461 
1462 namespace JSC {
1463 
1464 const ClassInfo JSDollarVM::s_info = { &quot;DollarVM&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSDollarVM) };
1465 
1466 // Triggers a crash immediately.
1467 // Usage: $vm.crash()
<a name="189" id="anc189"></a><span class="line-modified">1468 static NO_RETURN_DUE_TO_CRASH EncodedJSValue JSC_HOST_CALL functionCrash(JSGlobalObject*, CallFrame*)</span>
1469 {
<a name="190" id="anc190"></a><span class="line-added">1470     DollarVMAssertScope assertScope;</span>
1471     CRASH();
1472 }
1473 
1474 // Executes a breakpoint instruction if the first argument is truthy or is unset.
1475 // Usage: $vm.breakpoint(&lt;condition&gt;)
<a name="191" id="anc191"></a><span class="line-modified">1476 static EncodedJSValue JSC_HOST_CALL functionBreakpoint(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1477 {
<a name="192" id="anc192"></a><span class="line-added">1478     DollarVMAssertScope assertScope;</span>
1479     // Nothing should throw here but we might as well double check...
<a name="193" id="anc193"></a><span class="line-modified">1480     VM&amp; vm = globalObject-&gt;vm();</span>
1481     auto scope = DECLARE_CATCH_SCOPE(vm);
1482     UNUSED_PARAM(scope);
<a name="194" id="anc194"></a><span class="line-modified">1483     if (!callFrame-&gt;argumentCount() || callFrame-&gt;argument(0).toBoolean(globalObject))</span>
1484         WTFBreakpointTrap();
1485 
1486     return encodedJSUndefined();
1487 }
1488 
1489 // Returns true if the current frame is a DFG frame.
1490 // Usage: isDFG = $vm.dfgTrue()
<a name="195" id="anc195"></a><span class="line-modified">1491 static EncodedJSValue JSC_HOST_CALL functionDFGTrue(JSGlobalObject*, CallFrame*)</span>
1492 {
<a name="196" id="anc196"></a><span class="line-added">1493     DollarVMAssertScope assertScope;</span>
1494     return JSValue::encode(jsBoolean(false));
1495 }
1496 
1497 // Returns true if the current frame is a FTL frame.
1498 // Usage: isFTL = $vm.ftlTrue()
<a name="197" id="anc197"></a><span class="line-modified">1499 static EncodedJSValue JSC_HOST_CALL functionFTLTrue(JSGlobalObject*, CallFrame*)</span>
1500 {
<a name="198" id="anc198"></a><span class="line-added">1501     DollarVMAssertScope assertScope;</span>
1502     return JSValue::encode(jsBoolean(false));
1503 }
1504 
<a name="199" id="anc199"></a><span class="line-modified">1505 static EncodedJSValue JSC_HOST_CALL functionCpuMfence(JSGlobalObject*, CallFrame*)</span>
1506 {
<a name="200" id="anc200"></a><span class="line-added">1507     DollarVMAssertScope assertScope;</span>
1508 #if CPU(X86_64) &amp;&amp; !OS(WINDOWS)
1509     asm volatile(&quot;mfence&quot; ::: &quot;memory&quot;);
1510 #endif
1511     return JSValue::encode(jsUndefined());
1512 }
1513 
<a name="201" id="anc201"></a><span class="line-modified">1514 static EncodedJSValue JSC_HOST_CALL functionCpuRdtsc(JSGlobalObject*, CallFrame*)</span>
1515 {
<a name="202" id="anc202"></a><span class="line-added">1516     DollarVMAssertScope assertScope;</span>
1517 #if CPU(X86_64) &amp;&amp; !OS(WINDOWS)
1518     unsigned high;
1519     unsigned low;
1520     asm volatile (&quot;rdtsc&quot; : &quot;=a&quot;(low), &quot;=d&quot;(high));
1521     return JSValue::encode(jsNumber(low));
1522 #else
1523     return JSValue::encode(jsNumber(0));
1524 #endif
1525 }
1526 
<a name="203" id="anc203"></a><span class="line-modified">1527 static EncodedJSValue JSC_HOST_CALL functionCpuCpuid(JSGlobalObject*, CallFrame*)</span>
1528 {
<a name="204" id="anc204"></a><span class="line-added">1529     DollarVMAssertScope assertScope;</span>
1530 #if CPU(X86_64) &amp;&amp; !OS(WINDOWS)
1531     WTF::x86_cpuid();
1532 #endif
1533     return JSValue::encode(jsUndefined());
1534 }
1535 
<a name="205" id="anc205"></a><span class="line-modified">1536 static EncodedJSValue JSC_HOST_CALL functionCpuPause(JSGlobalObject*, CallFrame*)</span>
1537 {
<a name="206" id="anc206"></a><span class="line-added">1538     DollarVMAssertScope assertScope;</span>
1539 #if CPU(X86_64) &amp;&amp; !OS(WINDOWS)
1540     asm volatile (&quot;pause&quot; ::: &quot;memory&quot;);
1541 #endif
1542     return JSValue::encode(jsUndefined());
1543 }
1544 
1545 // This takes either a JSArrayBuffer, JSArrayBufferView*, or any other object as its first
1546 // argument. The second argument is expected to be an integer.
1547 //
1548 // If the first argument is a JSArrayBuffer, it&#39;ll clflush on that buffer
1549 // plus the second argument as a byte offset. It&#39;ll also flush on the object
1550 // itself so its length, etc, aren&#39;t in the cache.
1551 //
1552 // If the first argument is not a JSArrayBuffer, we load the butterfly
1553 // and clflush at the address of the butterfly.
<a name="207" id="anc207"></a><span class="line-modified">1554 static EncodedJSValue JSC_HOST_CALL functionCpuClflush(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1555 {
<a name="208" id="anc208"></a><span class="line-added">1556     DollarVMAssertScope assertScope;</span>
1557 #if CPU(X86_64) &amp;&amp; !OS(WINDOWS)
<a name="209" id="anc209"></a><span class="line-modified">1558     VM&amp; vm = globalObject-&gt;vm();</span>
1559 
<a name="210" id="anc210"></a><span class="line-modified">1560     if (!callFrame-&gt;argument(1).isInt32())</span>
1561         return JSValue::encode(jsBoolean(false));
1562 
1563     auto clflush = [] (void* ptr) {
<a name="211" id="anc211"></a><span class="line-added">1564         DollarVMAssertScope assertScope;</span>
1565         char* ptrToFlush = static_cast&lt;char*&gt;(ptr);
1566         asm volatile (&quot;clflush %0&quot; :: &quot;m&quot;(*ptrToFlush) : &quot;memory&quot;);
1567     };
1568 
1569     Vector&lt;void*&gt; toFlush;
1570 
<a name="212" id="anc212"></a><span class="line-modified">1571     uint32_t offset = callFrame-&gt;argument(1).asUInt32();</span>
1572 
<a name="213" id="anc213"></a><span class="line-modified">1573     if (JSArrayBufferView* view = jsDynamicCast&lt;JSArrayBufferView*&gt;(vm, callFrame-&gt;argument(0)))</span>
1574         toFlush.append(bitwise_cast&lt;char*&gt;(view-&gt;vector()) + offset);
<a name="214" id="anc214"></a><span class="line-modified">1575     else if (JSObject* object = jsDynamicCast&lt;JSObject*&gt;(vm, callFrame-&gt;argument(0))) {</span>
1576         switch (object-&gt;indexingType()) {
1577         case ALL_INT32_INDEXING_TYPES:
1578         case ALL_CONTIGUOUS_INDEXING_TYPES:
1579         case ALL_DOUBLE_INDEXING_TYPES:
1580             toFlush.append(bitwise_cast&lt;char*&gt;(object-&gt;butterfly()) + Butterfly::offsetOfVectorLength());
1581             toFlush.append(bitwise_cast&lt;char*&gt;(object-&gt;butterfly()) + Butterfly::offsetOfPublicLength());
1582         }
1583     }
1584 
1585     if (!toFlush.size())
1586         return JSValue::encode(jsBoolean(false));
1587 
1588     for (void* ptr : toFlush)
1589         clflush(ptr);
1590     return JSValue::encode(jsBoolean(true));
1591 #else
<a name="215" id="anc215"></a><span class="line-modified">1592     UNUSED_PARAM(globalObject);</span>
<span class="line-added">1593     UNUSED_PARAM(callFrame);</span>
1594     return JSValue::encode(jsBoolean(false));
1595 #endif
1596 }
1597 
1598 class CallerFrameJITTypeFunctor {
1599 public:
1600     CallerFrameJITTypeFunctor()
1601         : m_currentFrame(0)
1602         , m_jitType(JITType::None)
1603     {
<a name="216" id="anc216"></a><span class="line-added">1604         DollarVMAssertScope assertScope;</span>
1605     }
1606 
1607     StackVisitor::Status operator()(StackVisitor&amp; visitor) const
1608     {
1609         if (m_currentFrame++ &gt; 1) {
1610             m_jitType = visitor-&gt;codeBlock()-&gt;jitType();
1611             return StackVisitor::Done;
1612         }
1613         return StackVisitor::Continue;
1614     }
1615 
1616     JITType jitType() { return m_jitType; }
1617 
1618 private:
1619     mutable unsigned m_currentFrame;
1620     mutable JITType m_jitType;
1621 };
1622 
1623 static FunctionExecutable* getExecutableForFunction(JSValue theFunctionValue)
1624 {
<a name="217" id="anc217"></a><span class="line-added">1625     DollarVMAssertScope assertScope;</span>
1626     if (!theFunctionValue.isCell())
1627         return nullptr;
1628 
1629     VM&amp; vm = theFunctionValue.asCell()-&gt;vm();
1630     JSFunction* theFunction = jsDynamicCast&lt;JSFunction*&gt;(vm, theFunctionValue);
1631     if (!theFunction)
1632         return nullptr;
1633 
1634     FunctionExecutable* executable = jsDynamicCast&lt;FunctionExecutable*&gt;(vm,
1635         theFunction-&gt;executable());
1636 
1637     return executable;
1638 }
1639 
1640 // Returns true if the current frame is a LLInt frame.
1641 // Usage: isLLInt = $vm.llintTrue()
<a name="218" id="anc218"></a><span class="line-modified">1642 static EncodedJSValue JSC_HOST_CALL functionLLintTrue(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1643 {
<a name="219" id="anc219"></a><span class="line-modified">1644     DollarVMAssertScope assertScope;</span>
<span class="line-added">1645     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">1646     if (!callFrame)</span>
1647         return JSValue::encode(jsUndefined());
1648     CallerFrameJITTypeFunctor functor;
<a name="220" id="anc220"></a><span class="line-modified">1649     callFrame-&gt;iterate(vm, functor);</span>
1650     return JSValue::encode(jsBoolean(functor.jitType() == JITType::InterpreterThunk));
1651 }
1652 
1653 // Returns true if the current frame is a baseline JIT frame.
1654 // Usage: isBaselineJIT = $vm.jitTrue()
<a name="221" id="anc221"></a><span class="line-modified">1655 static EncodedJSValue JSC_HOST_CALL functionJITTrue(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1656 {
<a name="222" id="anc222"></a><span class="line-modified">1657     DollarVMAssertScope assertScope;</span>
<span class="line-added">1658     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">1659     if (!callFrame)</span>
1660         return JSValue::encode(jsUndefined());
1661     CallerFrameJITTypeFunctor functor;
<a name="223" id="anc223"></a><span class="line-modified">1662     callFrame-&gt;iterate(vm, functor);</span>
1663     return JSValue::encode(jsBoolean(functor.jitType() == JITType::BaselineJIT));
1664 }
1665 
1666 // Set that the argument function should not be inlined.
1667 // Usage:
1668 // function f() { };
1669 // $vm.noInline(f);
<a name="224" id="anc224"></a><span class="line-modified">1670 static EncodedJSValue JSC_HOST_CALL functionNoInline(JSGlobalObject*, CallFrame* callFrame)</span>
1671 {
<a name="225" id="anc225"></a><span class="line-modified">1672     DollarVMAssertScope assertScope;</span>
<span class="line-added">1673     if (callFrame-&gt;argumentCount() &lt; 1)</span>
1674         return JSValue::encode(jsUndefined());
1675 
<a name="226" id="anc226"></a><span class="line-modified">1676     JSValue theFunctionValue = callFrame-&gt;uncheckedArgument(0);</span>
1677 
1678     if (FunctionExecutable* executable = getExecutableForFunction(theFunctionValue))
1679         executable-&gt;setNeverInline(true);
1680 
1681     return JSValue::encode(jsUndefined());
1682 }
1683 
1684 // Runs a full GC synchronously.
1685 // Usage: $vm.gc()
<a name="227" id="anc227"></a><span class="line-modified">1686 static EncodedJSValue JSC_HOST_CALL functionGC(JSGlobalObject* globalObject, CallFrame*)</span>
1687 {
<a name="228" id="anc228"></a><span class="line-modified">1688     DollarVMAssertScope assertScope;</span>
<span class="line-added">1689     VMInspector::gc(globalObject);</span>
1690     return JSValue::encode(jsUndefined());
1691 }
1692 
1693 // Runs the edenGC synchronously.
1694 // Usage: $vm.edenGC()
<a name="229" id="anc229"></a><span class="line-modified">1695 static EncodedJSValue JSC_HOST_CALL functionEdenGC(JSGlobalObject* globalObject, CallFrame*)</span>
1696 {
<a name="230" id="anc230"></a><span class="line-modified">1697     DollarVMAssertScope assertScope;</span>
<span class="line-added">1698     VMInspector::edenGC(globalObject);</span>
1699     return JSValue::encode(jsUndefined());
1700 }
1701 
1702 // Dumps the hashes of all subspaces currently registered with the VM.
1703 // Usage: $vm.dumpSubspaceHashes()
<a name="231" id="anc231"></a><span class="line-modified">1704 static EncodedJSValue JSC_HOST_CALL functionDumpSubspaceHashes(JSGlobalObject* globalObject, CallFrame*)</span>
1705 {
<a name="232" id="anc232"></a><span class="line-modified">1706     DollarVMAssertScope assertScope;</span>
<span class="line-added">1707     VM&amp; vm = globalObject-&gt;vm();</span>
1708     VMInspector::dumpSubspaceHashes(&amp;vm);
1709     return JSValue::encode(jsUndefined());
1710 }
1711 
1712 // Gets a JSDollarVMCallFrame for a specified frame index.
1713 // Usage: var callFrame = $vm.callFrame(0) // frame 0 is the top frame.
1714 // Usage: var callFrame = $vm.callFrame() // implies frame 0 i.e. current frame.
1715 //
1716 // This gives you the ability to query the following:
1717 //    callFrame.valid; // false if we asked for a frame beyond the end of the stack, else true.
1718 //    callFrame.callee;
1719 //    callFrame.codeBlock;
1720 //    callFrame.unlinkedCodeBlock;
1721 //    callFrame.executable;
1722 //
1723 // Note: you cannot toString() a codeBlock, unlinkedCodeBlock, or executable because
1724 // there are internal objects and not a JS object. Hence, you cannot do string
1725 // concatenation with them.
<a name="233" id="anc233"></a><span class="line-modified">1726 static EncodedJSValue JSC_HOST_CALL functionCallFrame(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1727 {
<a name="234" id="anc234"></a><span class="line-added">1728     DollarVMAssertScope assertScope;</span>
1729     unsigned frameNumber = 1;
<a name="235" id="anc235"></a><span class="line-modified">1730     if (callFrame-&gt;argumentCount() &gt;= 1) {</span>
<span class="line-modified">1731         JSValue value = callFrame-&gt;uncheckedArgument(0);</span>
1732         if (!value.isUInt32())
1733             return JSValue::encode(jsUndefined());
1734 
1735         // We need to inc the frame number because the caller would consider
1736         // its own frame as frame 0. Hence, we need discount the frame for this
1737         // function.
1738         frameNumber = value.asUInt32() + 1;
1739     }
1740 
<a name="236" id="anc236"></a><span class="line-modified">1741     return JSValue::encode(JSDollarVMCallFrame::create(globalObject, callFrame, frameNumber));</span>
1742 }
1743 
1744 // Gets a token for the CodeBlock for a specified frame index.
1745 // Usage: codeBlockToken = $vm.codeBlockForFrame(0) // frame 0 is the top frame.
1746 // Usage: codeBlockToken = $vm.codeBlockForFrame() // implies frame 0 i.e. current frame.
<a name="237" id="anc237"></a><span class="line-modified">1747 static EncodedJSValue JSC_HOST_CALL functionCodeBlockForFrame(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1748 {
<a name="238" id="anc238"></a><span class="line-added">1749     DollarVMAssertScope assertScope;</span>
1750     unsigned frameNumber = 1;
<a name="239" id="anc239"></a><span class="line-modified">1751     if (callFrame-&gt;argumentCount() &gt;= 1) {</span>
<span class="line-modified">1752         JSValue value = callFrame-&gt;uncheckedArgument(0);</span>
1753         if (!value.isUInt32())
1754             return JSValue::encode(jsUndefined());
1755 
1756         // We need to inc the frame number because the caller would consider
1757         // its own frame as frame 0. Hence, we need discount the frame for this
1758         // function.
1759         frameNumber = value.asUInt32() + 1;
1760     }
1761 
<a name="240" id="anc240"></a><span class="line-modified">1762     CodeBlock* codeBlock = VMInspector::codeBlockForFrame(globalObject, callFrame, frameNumber);</span>
1763     if (codeBlock)
1764         return JSValue::encode(codeBlock);
1765     return JSValue::encode(jsUndefined());
1766 }
1767 
<a name="241" id="anc241"></a><span class="line-modified">1768 static CodeBlock* codeBlockFromArg(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1769 {
<a name="242" id="anc242"></a><span class="line-modified">1770     DollarVMAssertScope assertScope;</span>
<span class="line-modified">1771     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">1772     if (callFrame-&gt;argumentCount() &lt; 1)</span>
1773         return nullptr;
1774 
<a name="243" id="anc243"></a><span class="line-modified">1775     JSValue value = callFrame-&gt;uncheckedArgument(0);</span>
1776     CodeBlock* candidateCodeBlock = nullptr;
1777     if (value.isCell()) {
1778         JSFunction* func = jsDynamicCast&lt;JSFunction*&gt;(vm, value.asCell());
1779         if (func) {
1780             if (func-&gt;isHostFunction())
1781                 candidateCodeBlock = nullptr;
1782             else
1783                 candidateCodeBlock = func-&gt;jsExecutable()-&gt;eitherCodeBlock();
1784         } else
1785             candidateCodeBlock = static_cast&lt;CodeBlock*&gt;(value.asCell());
1786     }
1787 
<a name="244" id="anc244"></a><span class="line-modified">1788     if (candidateCodeBlock &amp;&amp; VMInspector::isValidCodeBlock(globalObject, candidateCodeBlock))</span>
1789         return candidateCodeBlock;
1790 
1791     if (candidateCodeBlock)
1792         dataLog(&quot;Invalid codeBlock: &quot;, RawPointer(candidateCodeBlock), &quot; &quot;, value, &quot;\n&quot;);
1793     else
1794         dataLog(&quot;Invalid codeBlock: &quot;, value, &quot;\n&quot;);
1795     return nullptr;
1796 }
1797 
1798 // Usage: $vm.print(&quot;codeblock = &quot;, $vm.codeBlockFor(functionObj))
1799 // Usage: $vm.print(&quot;codeblock = &quot;, $vm.codeBlockFor(codeBlockToken))
1800 // Note: you cannot toString() a codeBlock because it&#39;s an internal object and not
1801 // a JS object. Hence, you cannot do string concatenation with it.
<a name="245" id="anc245"></a><span class="line-modified">1802 static EncodedJSValue JSC_HOST_CALL functionCodeBlockFor(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1803 {
<a name="246" id="anc246"></a><span class="line-modified">1804     DollarVMAssertScope assertScope;</span>
<span class="line-added">1805     CodeBlock* codeBlock = codeBlockFromArg(globalObject, callFrame);</span>
1806     WTF::StringPrintStream stream;
1807     if (codeBlock) {
1808         stream.print(*codeBlock);
<a name="247" id="anc247"></a><span class="line-modified">1809         return JSValue::encode(jsString(globalObject-&gt;vm(), stream.toString()));</span>
1810     }
1811     return JSValue::encode(jsUndefined());
1812 }
1813 
1814 // Usage: $vm.dumpSourceFor(functionObj)
1815 // Usage: $vm.dumpSourceFor(codeBlockToken)
<a name="248" id="anc248"></a><span class="line-modified">1816 static EncodedJSValue JSC_HOST_CALL functionDumpSourceFor(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1817 {
<a name="249" id="anc249"></a><span class="line-modified">1818     DollarVMAssertScope assertScope;</span>
<span class="line-added">1819     CodeBlock* codeBlock = codeBlockFromArg(globalObject, callFrame);</span>
1820     if (codeBlock)
1821         codeBlock-&gt;dumpSource();
1822     return JSValue::encode(jsUndefined());
1823 }
1824 
1825 // Usage: $vm.dumpBytecodeFor(functionObj)
1826 // Usage: $vm.dumpBytecodeFor(codeBlock)
<a name="250" id="anc250"></a><span class="line-modified">1827 static EncodedJSValue JSC_HOST_CALL functionDumpBytecodeFor(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1828 {
<a name="251" id="anc251"></a><span class="line-modified">1829     DollarVMAssertScope assertScope;</span>
<span class="line-added">1830     CodeBlock* codeBlock = codeBlockFromArg(globalObject, callFrame);</span>
1831     if (codeBlock)
1832         codeBlock-&gt;dumpBytecode();
1833     return JSValue::encode(jsUndefined());
1834 }
1835 
<a name="252" id="anc252"></a><span class="line-modified">1836 static EncodedJSValue doPrint(JSGlobalObject* globalObject, CallFrame* callFrame, bool addLineFeed)</span>
1837 {
<a name="253" id="anc253"></a><span class="line-modified">1838     DollarVMAssertScope assertScope;</span>
<span class="line-modified">1839     auto scope = DECLARE_THROW_SCOPE(globalObject-&gt;vm());</span>
<span class="line-modified">1840     for (unsigned i = 0; i &lt; callFrame-&gt;argumentCount(); ++i) {</span>
<span class="line-added">1841         JSValue arg = callFrame-&gt;uncheckedArgument(i);</span>
1842         if (arg.isCell()
1843             &amp;&amp; !arg.isObject()
1844             &amp;&amp; !arg.isString()
1845             &amp;&amp; !arg.isBigInt()) {
1846             dataLog(arg);
1847             continue;
1848         }
<a name="254" id="anc254"></a><span class="line-modified">1849         String argStr = callFrame-&gt;uncheckedArgument(i).toWTFString(globalObject);</span>
1850         RETURN_IF_EXCEPTION(scope, encodedJSValue());
1851         dataLog(argStr);
1852     }
1853     if (addLineFeed)
1854         dataLog(&quot;\n&quot;);
1855     return JSValue::encode(jsUndefined());
1856 }
1857 
1858 // Prints a series of comma separate strings without appending a newline.
1859 // Usage: $vm.dataLog(str1, str2, str3)
<a name="255" id="anc255"></a><span class="line-modified">1860 static EncodedJSValue JSC_HOST_CALL functionDataLog(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1861 {
<a name="256" id="anc256"></a><span class="line-added">1862     DollarVMAssertScope assertScope;</span>
1863     const bool addLineFeed = false;
<a name="257" id="anc257"></a><span class="line-modified">1864     return doPrint(globalObject, callFrame, addLineFeed);</span>
1865 }
1866 
1867 // Prints a series of comma separate strings and appends a newline.
1868 // Usage: $vm.print(str1, str2, str3)
<a name="258" id="anc258"></a><span class="line-modified">1869 static EncodedJSValue JSC_HOST_CALL functionPrint(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1870 {
<a name="259" id="anc259"></a><span class="line-added">1871     DollarVMAssertScope assertScope;</span>
1872     const bool addLineFeed = true;
<a name="260" id="anc260"></a><span class="line-modified">1873     return doPrint(globalObject, callFrame, addLineFeed);</span>
1874 }
1875 
1876 // Dumps the current CallFrame.
1877 // Usage: $vm.dumpCallFrame()
<a name="261" id="anc261"></a><span class="line-modified">1878 static EncodedJSValue JSC_HOST_CALL functionDumpCallFrame(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1879 {
<a name="262" id="anc262"></a><span class="line-added">1880     DollarVMAssertScope assertScope;</span>
1881     // When the callers call this function, they are expecting to dump their
1882     // own frame. So skip 1 for this frame.
<a name="263" id="anc263"></a><span class="line-modified">1883     VMInspector::dumpCallFrame(globalObject, callFrame, 1);</span>
1884     return JSValue::encode(jsUndefined());
1885 }
1886 
1887 // Dumps the JS stack.
1888 // Usage: $vm.printStack()
<a name="264" id="anc264"></a><span class="line-modified">1889 static EncodedJSValue JSC_HOST_CALL functionDumpStack(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1890 {
<a name="265" id="anc265"></a><span class="line-added">1891     DollarVMAssertScope assertScope;</span>
1892     // When the callers call this function, they are expecting to dump the
1893     // stack starting their own frame. So skip 1 for this frame.
<a name="266" id="anc266"></a><span class="line-modified">1894     VMInspector::dumpStack(globalObject, callFrame, 1);</span>
1895     return JSValue::encode(jsUndefined());
1896 }
1897 
1898 // Dumps the current CallFrame.
1899 // Usage: $vm.dumpRegisters(N) // dump the registers of the Nth CallFrame.
1900 // Usage: $vm.dumpRegisters() // dump the registers of the current CallFrame.
1901 // FIXME: Currently, this function dumps the physical frame. We should make
1902 // it dump the logical frame (i.e. be able to dump inlined frames as well).
<a name="267" id="anc267"></a><span class="line-modified">1903 static EncodedJSValue JSC_HOST_CALL functionDumpRegisters(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1904 {
<a name="268" id="anc268"></a><span class="line-added">1905     DollarVMAssertScope assertScope;</span>
<span class="line-added">1906     VM&amp; vm = globalObject-&gt;vm();</span>
1907     unsigned requestedFrameIndex = 1;
<a name="269" id="anc269"></a><span class="line-modified">1908     if (callFrame-&gt;argumentCount() &gt;= 1) {</span>
<span class="line-modified">1909         JSValue value = callFrame-&gt;uncheckedArgument(0);</span>
1910         if (!value.isUInt32())
1911             return JSValue::encode(jsUndefined());
1912 
1913         // We need to inc the frame number because the caller would consider
1914         // its own frame as frame 0. Hence, we need discount the frame for this
1915         // function.
1916         requestedFrameIndex = value.asUInt32() + 1;
1917     }
1918 
1919     unsigned frameIndex = 0;
<a name="270" id="anc270"></a><span class="line-modified">1920     callFrame-&gt;iterate(vm, [&amp;] (StackVisitor&amp; visitor) {</span>
<span class="line-added">1921         DollarVMAssertScope assertScope;</span>
1922         if (frameIndex++ != requestedFrameIndex)
1923             return StackVisitor::Continue;
1924         VMInspector::dumpRegisters(visitor-&gt;callFrame());
1925         return StackVisitor::Done;
1926     });
1927 
1928     return encodedJSUndefined();
1929 }
1930 
1931 // Dumps the internal memory layout of a JSCell.
1932 // Usage: $vm.dumpCell(cell)
<a name="271" id="anc271"></a><span class="line-modified">1933 static EncodedJSValue JSC_HOST_CALL functionDumpCell(JSGlobalObject*, CallFrame* callFrame)</span>
1934 {
<a name="272" id="anc272"></a><span class="line-modified">1935     DollarVMAssertScope assertScope;</span>
<span class="line-added">1936     JSValue value = callFrame-&gt;argument(0);</span>
1937     if (!value.isCell())
1938         return encodedJSUndefined();
1939 
1940     VMInspector::dumpCellMemory(value.asCell());
1941     return encodedJSUndefined();
1942 }
1943 
1944 // Gets the dataLog dump of the indexingMode of the passed value.
1945 // Usage: $vm.print(&quot;indexingMode = &quot; + $vm.indexingMode(jsValue))
<a name="273" id="anc273"></a><span class="line-modified">1946 static EncodedJSValue JSC_HOST_CALL functionIndexingMode(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1947 {
<a name="274" id="anc274"></a><span class="line-modified">1948     DollarVMAssertScope assertScope;</span>
<span class="line-added">1949     if (!callFrame-&gt;argument(0).isObject())</span>
1950         return encodedJSUndefined();
1951 
1952     WTF::StringPrintStream stream;
<a name="275" id="anc275"></a><span class="line-modified">1953     stream.print(IndexingTypeDump(callFrame-&gt;uncheckedArgument(0).getObject()-&gt;indexingMode()));</span>
<span class="line-modified">1954     return JSValue::encode(jsString(globalObject-&gt;vm(), stream.toString()));</span>
1955 }
1956 
<a name="276" id="anc276"></a><span class="line-modified">1957 static EncodedJSValue JSC_HOST_CALL functionInlineCapacity(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1958 {
<a name="277" id="anc277"></a><span class="line-modified">1959     DollarVMAssertScope assertScope;</span>
<span class="line-modified">1960     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">1961     if (auto* object = jsDynamicCast&lt;JSObject*&gt;(vm, callFrame-&gt;argument(0)))</span>
1962         return JSValue::encode(jsNumber(object-&gt;structure(vm)-&gt;inlineCapacity()));
1963 
1964     return encodedJSUndefined();
1965 }
1966 
1967 // Gets the dataLog dump of a given JS value as a string.
1968 // Usage: $vm.print(&quot;value = &quot; + $vm.value(jsValue))
<a name="278" id="anc278"></a><span class="line-modified">1969 static EncodedJSValue JSC_HOST_CALL functionValue(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1970 {
<a name="279" id="anc279"></a><span class="line-added">1971     DollarVMAssertScope assertScope;</span>
1972     WTF::StringPrintStream stream;
<a name="280" id="anc280"></a><span class="line-modified">1973     for (unsigned i = 0; i &lt; callFrame-&gt;argumentCount(); ++i) {</span>
1974         if (i)
1975             stream.print(&quot;, &quot;);
<a name="281" id="anc281"></a><span class="line-modified">1976         stream.print(callFrame-&gt;uncheckedArgument(i));</span>
1977     }
1978 
<a name="282" id="anc282"></a><span class="line-modified">1979     return JSValue::encode(jsString(globalObject-&gt;vm(), stream.toString()));</span>
1980 }
1981 
1982 // Gets the pid of the current process.
1983 // Usage: $vm.print(&quot;pid = &quot; + $vm.getpid())
<a name="283" id="anc283"></a><span class="line-modified">1984 static EncodedJSValue JSC_HOST_CALL functionGetPID(JSGlobalObject*, CallFrame*)</span>
1985 {
<a name="284" id="anc284"></a><span class="line-added">1986     DollarVMAssertScope assertScope;</span>
1987     return JSValue::encode(jsNumber(getCurrentProcessID()));
1988 }
1989 
1990 // Make the globalObject have a bad time. Does nothing if the object is not a JSGlobalObject.
1991 // Usage: $vm.haveABadTime(globalObject)
<a name="285" id="anc285"></a><span class="line-modified">1992 static EncodedJSValue JSC_HOST_CALL functionHaveABadTime(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1993 {
<a name="286" id="anc286"></a><span class="line-modified">1994     DollarVMAssertScope assertScope;</span>
<span class="line-added">1995     VM&amp; vm = globalObject-&gt;vm();</span>
1996     JSLockHolder lock(vm);
<a name="287" id="anc287"></a><span class="line-modified">1997     JSValue objValue = callFrame-&gt;argument(0);</span>
1998     if (!objValue.isObject())
1999         return JSValue::encode(jsBoolean(false));
2000 
2001     JSObject* obj = asObject(objValue.asCell());
<a name="288" id="anc288"></a><span class="line-modified">2002     JSGlobalObject* target = jsDynamicCast&lt;JSGlobalObject*&gt;(vm, obj);</span>
<span class="line-modified">2003     if (!target)</span>
2004         JSValue::encode(jsBoolean(false));
2005 
<a name="289" id="anc289"></a><span class="line-modified">2006     target-&gt;haveABadTime(vm);</span>
2007     return JSValue::encode(jsBoolean(true));
2008 }
2009 
2010 // Checks if the object (or its global if the object is not a global) is having a bad time.
2011 // Usage: $vm.isHavingABadTime(obj)
<a name="290" id="anc290"></a><span class="line-modified">2012 static EncodedJSValue JSC_HOST_CALL functionIsHavingABadTime(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2013 {
<a name="291" id="anc291"></a><span class="line-modified">2014     DollarVMAssertScope assertScope;</span>
<span class="line-added">2015     VM&amp; vm = globalObject-&gt;vm();</span>
2016     JSLockHolder lock(vm);
<a name="292" id="anc292"></a><span class="line-modified">2017     JSValue objValue = callFrame-&gt;argument(0);</span>
2018     if (!objValue.isObject())
2019         return JSValue::encode(jsUndefined());
2020 
2021     JSObject* obj = asObject(objValue.asCell());
<a name="293" id="anc293"></a><span class="line-modified">2022     JSGlobalObject* target = jsDynamicCast&lt;JSGlobalObject*&gt;(vm, obj);</span>
<span class="line-modified">2023     if (target)</span>
<span class="line-modified">2024         JSValue::encode(jsBoolean(target-&gt;isHavingABadTime()));</span>
2025 
<a name="294" id="anc294"></a><span class="line-modified">2026     target= obj-&gt;globalObject();</span>
<span class="line-modified">2027     if (!target)</span>
2028         return JSValue::encode(jsUndefined());
2029 
<a name="295" id="anc295"></a><span class="line-modified">2030     return JSValue::encode(jsBoolean(target-&gt;isHavingABadTime()));</span>
<span class="line-added">2031 }</span>
<span class="line-added">2032 </span>
<span class="line-added">2033 // Calls the specified test function after adjusting the stack to have the specified</span>
<span class="line-added">2034 // remaining size from the end of the physical stack.</span>
<span class="line-added">2035 // Usage: $vm.callWithStackSize(funcToCall, desiredStackSize)</span>
<span class="line-added">2036 //</span>
<span class="line-added">2037 // This function will only work in test configurations, specifically, only if JSC</span>
<span class="line-added">2038 // options are not frozen. For the jsc shell, the --disableOptionsFreezingForTesting</span>
<span class="line-added">2039 // argument needs to be passed in on the command line.</span>
<span class="line-added">2040 </span>
<span class="line-added">2041 #if ENABLE(MASM_PROBE)</span>
<span class="line-added">2042 static void callWithStackSizeProbeFunction(Probe::State* state)</span>
<span class="line-added">2043 {</span>
<span class="line-added">2044     JSGlobalObject* globalObject = bitwise_cast&lt;JSGlobalObject*&gt;(state-&gt;arg);</span>
<span class="line-added">2045     JSFunction* function = bitwise_cast&lt;JSFunction*&gt;(state-&gt;probeFunction);</span>
<span class="line-added">2046     state-&gt;initializeStackFunction = nullptr;</span>
<span class="line-added">2047     state-&gt;initializeStackArg = nullptr;</span>
<span class="line-added">2048 </span>
<span class="line-added">2049     DollarVMAssertScope assertScope;</span>
<span class="line-added">2050     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">2051 </span>
<span class="line-added">2052     CallData callData;</span>
<span class="line-added">2053     CallType callType = getCallData(vm, function, callData);</span>
<span class="line-added">2054     MarkedArgumentBuffer args;</span>
<span class="line-added">2055     call(globalObject, function, callType, callData, jsUndefined(), args);</span>
<span class="line-added">2056 }</span>
<span class="line-added">2057 #endif // ENABLE(MASM_PROBE)</span>
<span class="line-added">2058 </span>
<span class="line-added">2059 SUPPRESS_ASAN</span>
<span class="line-added">2060 static EncodedJSValue JSC_HOST_CALL functionCallWithStackSize(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
<span class="line-added">2061 {</span>
<span class="line-added">2062     DollarVMAssertScope assertScope;</span>
<span class="line-added">2063     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">2064     JSLockHolder lock(vm);</span>
<span class="line-added">2065     auto throwScope = DECLARE_THROW_SCOPE(vm);</span>
<span class="line-added">2066 </span>
<span class="line-added">2067 #if OS(DARWIN) &amp;&amp; CPU(X86_64)</span>
<span class="line-added">2068     constexpr bool isSupportedByPlatform = true;</span>
<span class="line-added">2069 #else</span>
<span class="line-added">2070     constexpr bool isSupportedByPlatform = false;</span>
<span class="line-added">2071 #endif</span>
<span class="line-added">2072 </span>
<span class="line-added">2073     if (!isSupportedByPlatform)</span>
<span class="line-added">2074         return throwVMError(globalObject, throwScope, &quot;Not supported for this platform&quot;);</span>
<span class="line-added">2075 </span>
<span class="line-added">2076 #if ENABLE(MASM_PROBE)</span>
<span class="line-added">2077     if (g_jscConfig.isPermanentlyFrozen || !g_jscConfig.disabledFreezingForTesting)</span>
<span class="line-added">2078         return throwVMError(globalObject, throwScope, &quot;Options are frozen&quot;);</span>
<span class="line-added">2079 </span>
<span class="line-added">2080     if (callFrame-&gt;argumentCount() &lt; 2)</span>
<span class="line-added">2081         return throwVMError(globalObject, throwScope, &quot;Invalid number of arguments&quot;);</span>
<span class="line-added">2082     JSValue arg0 = callFrame-&gt;argument(0);</span>
<span class="line-added">2083     JSValue arg1 = callFrame-&gt;argument(1);</span>
<span class="line-added">2084     if (!arg0.isFunction(vm))</span>
<span class="line-added">2085         return throwVMError(globalObject, throwScope, &quot;arg0 should be a function&quot;);</span>
<span class="line-added">2086     if (!arg1.isNumber())</span>
<span class="line-added">2087         return throwVMError(globalObject, throwScope, &quot;arg1 should be a number&quot;);</span>
<span class="line-added">2088 </span>
<span class="line-added">2089     JSFunction* function = jsCast&lt;JSFunction*&gt;(arg0);</span>
<span class="line-added">2090     size_t desiredStackSize = arg1.asNumber();</span>
<span class="line-added">2091 </span>
<span class="line-added">2092     const StackBounds&amp; bounds = Thread::current().stack();</span>
<span class="line-added">2093     uint8_t* currentStackPosition = bitwise_cast&lt;uint8_t*&gt;(currentStackPointer());</span>
<span class="line-added">2094     uint8_t* end = bitwise_cast&lt;uint8_t*&gt;(bounds.end());</span>
<span class="line-added">2095     uint8_t* desiredStart = end + desiredStackSize;</span>
<span class="line-added">2096     if (desiredStart &gt;= currentStackPosition)</span>
<span class="line-added">2097         return throwVMError(globalObject, throwScope, &quot;Unable to setup desired stack size&quot;);</span>
<span class="line-added">2098 </span>
<span class="line-added">2099     JSDollarVMHelper helper(vm);</span>
<span class="line-added">2100 </span>
<span class="line-added">2101     unsigned originalMaxPerThreadStackUsage = Options::maxPerThreadStackUsage();</span>
<span class="line-added">2102     void* originalVMSoftStackLimit = vm.softStackLimit();</span>
<span class="line-added">2103     void* originalVMStackLimit = vm.stackLimit();</span>
<span class="line-added">2104 </span>
<span class="line-added">2105     // This is a hack to make the VM think it&#39;s stack limits are near the end</span>
<span class="line-added">2106     // of the physical stack.</span>
<span class="line-added">2107     uint8_t* vmStackStart = bitwise_cast&lt;uint8_t*&gt;(vm.stackPointerAtVMEntry());</span>
<span class="line-added">2108     uint8_t* vmStackEnd = vmStackStart - originalMaxPerThreadStackUsage;</span>
<span class="line-added">2109     ptrdiff_t sizeDiff = vmStackEnd - end;</span>
<span class="line-added">2110     RELEASE_ASSERT(sizeDiff &gt;= 0);</span>
<span class="line-added">2111     RELEASE_ASSERT(sizeDiff &lt; UINT_MAX);</span>
<span class="line-added">2112 </span>
<span class="line-added">2113     Options::maxPerThreadStackUsage() = originalMaxPerThreadStackUsage + sizeDiff;</span>
<span class="line-added">2114     helper.updateVMStackLimits();</span>
<span class="line-added">2115 </span>
<span class="line-added">2116 #if OS(DARWIN) &amp;&amp; CPU(X86_64)</span>
<span class="line-added">2117     __asm__ volatile (</span>
<span class="line-added">2118         &quot;subq %[sizeDiff], %%rsp&quot; &quot;\n&quot;</span>
<span class="line-added">2119         &quot;pushq %%rax&quot; &quot;\n&quot;</span>
<span class="line-added">2120         &quot;pushq %%rcx&quot; &quot;\n&quot;</span>
<span class="line-added">2121         &quot;pushq %%rdx&quot; &quot;\n&quot;</span>
<span class="line-added">2122         &quot;pushq %%rbx&quot; &quot;\n&quot;</span>
<span class="line-added">2123         &quot;callq *%%rax&quot; &quot;\n&quot;</span>
<span class="line-added">2124         &quot;addq %[sizeDiff], %%rsp&quot; &quot;\n&quot;</span>
<span class="line-added">2125         :</span>
<span class="line-added">2126         : &quot;a&quot; (ctiMasmProbeTrampoline)</span>
<span class="line-added">2127         , &quot;c&quot; (callWithStackSizeProbeFunction)</span>
<span class="line-added">2128         , &quot;d&quot; (function)</span>
<span class="line-added">2129         , &quot;b&quot; (globalObject)</span>
<span class="line-added">2130         , [sizeDiff] &quot;rm&quot; (sizeDiff)</span>
<span class="line-added">2131         : &quot;memory&quot;</span>
<span class="line-added">2132     );</span>
<span class="line-added">2133 #else</span>
<span class="line-added">2134     UNUSED_PARAM(function);</span>
<span class="line-added">2135 #if !COMPILER(MSVC)</span>
<span class="line-added">2136     UNUSED_PARAM(callWithStackSizeProbeFunction);</span>
<span class="line-added">2137 #endif</span>
<span class="line-added">2138 #endif // OS(DARWIN) &amp;&amp; CPU(X86_64)</span>
<span class="line-added">2139 </span>
<span class="line-added">2140     Options::maxPerThreadStackUsage() = originalMaxPerThreadStackUsage;</span>
<span class="line-added">2141     helper.updateVMStackLimits();</span>
<span class="line-added">2142     RELEASE_ASSERT(vm.softStackLimit() == originalVMSoftStackLimit);</span>
<span class="line-added">2143     RELEASE_ASSERT(vm.stackLimit() == originalVMStackLimit);</span>
<span class="line-added">2144 </span>
<span class="line-added">2145     throwScope.release();</span>
<span class="line-added">2146     return encodedJSUndefined();</span>
<span class="line-added">2147 </span>
<span class="line-added">2148 #else // not ENABLE(MASM_PROBE)</span>
<span class="line-added">2149     UNUSED_PARAM(callFrame);</span>
<span class="line-added">2150     return throwVMError(globalObject, throwScope, &quot;Not supported for this platform&quot;);</span>
<span class="line-added">2151 #endif // ENABLE(MASM_PROBE)</span>
2152 }
2153 
2154 // Creates a new global object.
2155 // Usage: $vm.createGlobalObject()
<a name="296" id="anc296"></a><span class="line-modified">2156 static EncodedJSValue JSC_HOST_CALL functionCreateGlobalObject(JSGlobalObject* globalObject, CallFrame*)</span>
2157 {
<a name="297" id="anc297"></a><span class="line-modified">2158     DollarVMAssertScope assertScope;</span>
<span class="line-added">2159     VM&amp; vm = globalObject-&gt;vm();</span>
2160     JSLockHolder lock(vm);
<a name="298" id="anc298"></a><span class="line-modified">2161     return JSValue::encode(JSGlobalObject::create(vm, JSGlobalObject::createStructure(vm, jsNull())));</span>

2162 }
2163 
<a name="299" id="anc299"></a><span class="line-modified">2164 static EncodedJSValue JSC_HOST_CALL functionCreateProxy(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2165 {
<a name="300" id="anc300"></a><span class="line-modified">2166     DollarVMAssertScope assertScope;</span>
<span class="line-added">2167     VM&amp; vm = globalObject-&gt;vm();</span>
2168     JSLockHolder lock(vm);
<a name="301" id="anc301"></a><span class="line-modified">2169     JSValue target = callFrame-&gt;argument(0);</span>
2170     if (!target.isObject())
2171         return JSValue::encode(jsUndefined());
2172     JSObject* jsTarget = asObject(target.asCell());
<a name="302" id="anc302"></a><span class="line-modified">2173     Structure* structure = JSProxy::createStructure(vm, globalObject, jsTarget-&gt;getPrototypeDirect(vm), ImpureProxyType);</span>
2174     JSProxy* proxy = JSProxy::create(vm, structure, jsTarget);
2175     return JSValue::encode(proxy);
2176 }
2177 
<a name="303" id="anc303"></a><span class="line-modified">2178 static EncodedJSValue JSC_HOST_CALL functionCreateRuntimeArray(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2179 {
<a name="304" id="anc304"></a><span class="line-modified">2180     DollarVMAssertScope assertScope;</span>
<span class="line-modified">2181     JSLockHolder lock(globalObject);</span>
<span class="line-added">2182     RuntimeArray* array = RuntimeArray::create(globalObject, callFrame);</span>
2183     return JSValue::encode(array);
2184 }
2185 
<a name="305" id="anc305"></a><span class="line-modified">2186 static EncodedJSValue JSC_HOST_CALL functionCreateNullRopeString(JSGlobalObject* globalObject, CallFrame*)</span>
2187 {
<a name="306" id="anc306"></a><span class="line-modified">2188     DollarVMAssertScope assertScope;</span>
<span class="line-added">2189     VM&amp; vm = globalObject-&gt;vm();</span>
2190     JSLockHolder lock(vm);
2191     return JSValue::encode(JSRopeString::createNullForTesting(vm));
2192 }
2193 
<a name="307" id="anc307"></a><span class="line-modified">2194 static EncodedJSValue JSC_HOST_CALL functionCreateImpureGetter(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2195 {
<a name="308" id="anc308"></a><span class="line-modified">2196     DollarVMAssertScope assertScope;</span>
<span class="line-added">2197     VM&amp; vm = globalObject-&gt;vm();</span>
2198     JSLockHolder lock(vm);
<a name="309" id="anc309"></a><span class="line-modified">2199     JSValue target = callFrame-&gt;argument(0);</span>
2200     JSObject* delegate = nullptr;
2201     if (target.isObject())
2202         delegate = asObject(target.asCell());
<a name="310" id="anc310"></a><span class="line-modified">2203     Structure* structure = ImpureGetter::createStructure(vm, globalObject, jsNull());</span>
2204     ImpureGetter* result = ImpureGetter::create(vm, structure, delegate);
2205     return JSValue::encode(result);
2206 }
2207 
<a name="311" id="anc311"></a><span class="line-modified">2208 static EncodedJSValue JSC_HOST_CALL functionCreateCustomGetterObject(JSGlobalObject* globalObject, CallFrame*)</span>
2209 {
<a name="312" id="anc312"></a><span class="line-modified">2210     DollarVMAssertScope assertScope;</span>
<span class="line-added">2211     VM&amp; vm = globalObject-&gt;vm();</span>
2212     JSLockHolder lock(vm);
<a name="313" id="anc313"></a><span class="line-modified">2213     Structure* structure = CustomGetter::createStructure(vm, globalObject, jsNull());</span>
2214     CustomGetter* result = CustomGetter::create(vm, structure);
2215     return JSValue::encode(result);
2216 }
2217 
<a name="314" id="anc314"></a><span class="line-modified">2218 static EncodedJSValue JSC_HOST_CALL functionCreateDOMJITNodeObject(JSGlobalObject* globalObject, CallFrame*)</span>
2219 {
<a name="315" id="anc315"></a><span class="line-modified">2220     DollarVMAssertScope assertScope;</span>
<span class="line-added">2221     VM&amp; vm = globalObject-&gt;vm();</span>
2222     JSLockHolder lock(vm);
<a name="316" id="anc316"></a><span class="line-modified">2223     Structure* structure = DOMJITNode::createStructure(vm, globalObject, DOMJITGetter::create(vm, DOMJITGetter::createStructure(vm, globalObject, jsNull())));</span>
2224     DOMJITNode* result = DOMJITNode::create(vm, structure);
2225     return JSValue::encode(result);
2226 }
2227 
<a name="317" id="anc317"></a><span class="line-modified">2228 static EncodedJSValue JSC_HOST_CALL functionCreateDOMJITGetterObject(JSGlobalObject* globalObject, CallFrame*)</span>
2229 {
<a name="318" id="anc318"></a><span class="line-modified">2230     DollarVMAssertScope assertScope;</span>
<span class="line-added">2231     VM&amp; vm = globalObject-&gt;vm();</span>
2232     JSLockHolder lock(vm);
<a name="319" id="anc319"></a><span class="line-modified">2233     Structure* structure = DOMJITGetter::createStructure(vm, globalObject, jsNull());</span>
2234     DOMJITGetter* result = DOMJITGetter::create(vm, structure);
2235     return JSValue::encode(result);
2236 }
2237 
<a name="320" id="anc320"></a><span class="line-modified">2238 static EncodedJSValue JSC_HOST_CALL functionCreateDOMJITGetterComplexObject(JSGlobalObject* globalObject, CallFrame*)</span>
2239 {
<a name="321" id="anc321"></a><span class="line-modified">2240     DollarVMAssertScope assertScope;</span>
<span class="line-added">2241     VM&amp; vm = globalObject-&gt;vm();</span>
2242     JSLockHolder lock(vm);
<a name="322" id="anc322"></a><span class="line-modified">2243     Structure* structure = DOMJITGetterComplex::createStructure(vm, globalObject, jsNull());</span>
<span class="line-modified">2244     DOMJITGetterComplex* result = DOMJITGetterComplex::create(vm, globalObject, structure);</span>
2245     return JSValue::encode(result);
2246 }
2247 
<a name="323" id="anc323"></a><span class="line-modified">2248 static EncodedJSValue JSC_HOST_CALL functionCreateDOMJITFunctionObject(JSGlobalObject* globalObject, CallFrame*)</span>
2249 {
<a name="324" id="anc324"></a><span class="line-modified">2250     DollarVMAssertScope assertScope;</span>
<span class="line-added">2251     VM&amp; vm = globalObject-&gt;vm();</span>
2252     JSLockHolder lock(vm);
<a name="325" id="anc325"></a><span class="line-modified">2253     Structure* structure = DOMJITFunctionObject::createStructure(vm, globalObject, jsNull());</span>
<span class="line-modified">2254     DOMJITFunctionObject* result = DOMJITFunctionObject::create(vm, globalObject, structure);</span>
2255     return JSValue::encode(result);
2256 }
2257 
<a name="326" id="anc326"></a><span class="line-modified">2258 static EncodedJSValue JSC_HOST_CALL functionCreateDOMJITCheckSubClassObject(JSGlobalObject* globalObject, CallFrame*)</span>
2259 {
<a name="327" id="anc327"></a><span class="line-modified">2260     DollarVMAssertScope assertScope;</span>
<span class="line-added">2261     VM&amp; vm = globalObject-&gt;vm();</span>
2262     JSLockHolder lock(vm);
<a name="328" id="anc328"></a><span class="line-modified">2263     Structure* structure = DOMJITCheckSubClassObject::createStructure(vm, globalObject, jsNull());</span>
<span class="line-modified">2264     DOMJITCheckSubClassObject* result = DOMJITCheckSubClassObject::create(vm, globalObject, structure);</span>
2265     return JSValue::encode(result);
2266 }
2267 
<a name="329" id="anc329"></a><span class="line-modified">2268 static EncodedJSValue JSC_HOST_CALL functionCreateDOMJITGetterBaseJSObject(JSGlobalObject* globalObject, CallFrame*)</span>
2269 {
<a name="330" id="anc330"></a><span class="line-modified">2270     DollarVMAssertScope assertScope;</span>
<span class="line-added">2271     VM&amp; vm = globalObject-&gt;vm();</span>
2272     JSLockHolder lock(vm);
<a name="331" id="anc331"></a><span class="line-modified">2273     Structure* structure = DOMJITGetterBaseJSObject::createStructure(vm, globalObject, jsNull());</span>
2274     DOMJITGetterBaseJSObject* result = DOMJITGetterBaseJSObject::create(vm, structure);
2275     return JSValue::encode(result);
2276 }
2277 
2278 #if ENABLE(WEBASSEMBLY)
<a name="332" id="anc332"></a><span class="line-modified">2279 static EncodedJSValue JSC_HOST_CALL functionCreateWasmStreamingParser(JSGlobalObject* globalObject, CallFrame*)</span>
2280 {
<a name="333" id="anc333"></a><span class="line-modified">2281     DollarVMAssertScope assertScope;</span>
<span class="line-added">2282     VM&amp; vm = globalObject-&gt;vm();</span>
2283     JSLockHolder lock(vm);
<a name="334" id="anc334"></a><span class="line-modified">2284     return JSValue::encode(WasmStreamingParser::create(vm, globalObject));</span>
2285 }
2286 #endif
2287 
<a name="335" id="anc335"></a><span class="line-modified">2288 static EncodedJSValue JSC_HOST_CALL functionCreateStaticCustomAccessor(JSGlobalObject* globalObject, CallFrame*)</span>
<span class="line-added">2289 {</span>
<span class="line-added">2290     DollarVMAssertScope assertScope;</span>
<span class="line-added">2291     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">2292     JSLockHolder lock(vm);</span>
<span class="line-added">2293     Structure* structure = StaticCustomAccessor::createStructure(vm, globalObject, jsNull());</span>
<span class="line-added">2294     auto* result = StaticCustomAccessor::create(vm, structure);</span>
<span class="line-added">2295     return JSValue::encode(result);</span>
<span class="line-added">2296 }</span>
<span class="line-added">2297 </span>
<span class="line-added">2298 static EncodedJSValue JSC_HOST_CALL functionCreateObjectDoingSideEffectPutWithoutCorrectSlotStatus(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2299 {
<a name="336" id="anc336"></a><span class="line-modified">2300     DollarVMAssertScope assertScope;</span>
<span class="line-added">2301     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">2302     JSLockHolder lock(vm);</span>
<span class="line-added">2303 </span>
<span class="line-added">2304     auto* dollarVM = jsDynamicCast&lt;JSDollarVM*&gt;(vm, callFrame-&gt;thisValue());</span>
<span class="line-added">2305     RELEASE_ASSERT(dollarVM);</span>
<span class="line-added">2306     auto* result = ObjectDoingSideEffectPutWithoutCorrectSlotStatus::create(vm, dollarVM-&gt;objectDoingSideEffectPutWithoutCorrectSlotStatusStructure());</span>
<span class="line-added">2307     return JSValue::encode(result);</span>
<span class="line-added">2308 }</span>
<span class="line-added">2309 </span>
<span class="line-added">2310 static EncodedJSValue JSC_HOST_CALL functionSetImpureGetterDelegate(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
<span class="line-added">2311 {</span>
<span class="line-added">2312     DollarVMAssertScope assertScope;</span>
<span class="line-added">2313     VM&amp; vm = globalObject-&gt;vm();</span>
2314     JSLockHolder lock(vm);
2315     auto scope = DECLARE_THROW_SCOPE(vm);
2316 
<a name="337" id="anc337"></a><span class="line-modified">2317     JSValue base = callFrame-&gt;argument(0);</span>
2318     if (!base.isObject())
2319         return JSValue::encode(jsUndefined());
<a name="338" id="anc338"></a><span class="line-modified">2320     JSValue delegate = callFrame-&gt;argument(1);</span>
2321     if (!delegate.isObject())
2322         return JSValue::encode(jsUndefined());
2323     ImpureGetter* impureGetter = jsDynamicCast&lt;ImpureGetter*&gt;(vm, asObject(base.asCell()));
2324     if (UNLIKELY(!impureGetter)) {
<a name="339" id="anc339"></a><span class="line-modified">2325         throwTypeError(globalObject, scope, &quot;argument is not an ImpureGetter&quot;_s);</span>
2326         return encodedJSValue();
2327     }
2328     impureGetter-&gt;setDelegate(vm, asObject(delegate.asCell()));
2329     return JSValue::encode(jsUndefined());
2330 }
2331 
<a name="340" id="anc340"></a><span class="line-modified">2332 static EncodedJSValue JSC_HOST_CALL functionCreateBuiltin(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2333 {
<a name="341" id="anc341"></a><span class="line-modified">2334     DollarVMAssertScope assertScope;</span>
<span class="line-added">2335     VM&amp; vm = globalObject-&gt;vm();</span>
2336     auto scope = DECLARE_THROW_SCOPE(vm);
2337 
<a name="342" id="anc342"></a><span class="line-modified">2338     if (callFrame-&gt;argumentCount() &lt; 1 || !callFrame-&gt;argument(0).isString())</span>
2339         return JSValue::encode(jsUndefined());
2340 
<a name="343" id="anc343"></a><span class="line-modified">2341     String functionText = asString(callFrame-&gt;argument(0))-&gt;value(globalObject);</span>
2342     RETURN_IF_EXCEPTION(scope, encodedJSValue());
2343 
<a name="344" id="anc344"></a><span class="line-modified">2344     SourceCode source = makeSource(functionText, { });</span>
<span class="line-modified">2345     JSFunction* func = JSFunction::create(vm, createBuiltinExecutable(vm, source, Identifier::fromString(vm, &quot;foo&quot;), ConstructorKind::None, ConstructAbility::CannotConstruct)-&gt;link(vm, nullptr, source), globalObject);</span>
2346 
2347     return JSValue::encode(func);
2348 }
2349 
<a name="345" id="anc345"></a><span class="line-modified">2350 static EncodedJSValue JSC_HOST_CALL functionGetPrivateProperty(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2351 {
<a name="346" id="anc346"></a><span class="line-modified">2352     DollarVMAssertScope assertScope;</span>
<span class="line-added">2353     VM&amp; vm = globalObject-&gt;vm();</span>
2354     auto scope = DECLARE_THROW_SCOPE(vm);
2355 
<a name="347" id="anc347"></a><span class="line-modified">2356     if (callFrame-&gt;argumentCount() &lt; 2 || !callFrame-&gt;argument(1).isString())</span>
2357         return encodedJSUndefined();
2358 
<a name="348" id="anc348"></a><span class="line-modified">2359     String str = asString(callFrame-&gt;argument(1))-&gt;value(globalObject);</span>
2360 
2361     SymbolImpl* symbol = vm.propertyNames-&gt;lookUpPrivateName(Identifier::fromString(vm, str));
2362     if (!symbol)
<a name="349" id="anc349"></a><span class="line-modified">2363         return throwVMError(globalObject, scope, &quot;Unknown private name.&quot;);</span>
2364 
<a name="350" id="anc350"></a><span class="line-modified">2365     RELEASE_AND_RETURN(scope, JSValue::encode(callFrame-&gt;argument(0).get(globalObject, symbol)));</span>
2366 }
2367 
<a name="351" id="anc351"></a><span class="line-modified">2368 static EncodedJSValue JSC_HOST_CALL functionCreateRoot(JSGlobalObject* globalObject, CallFrame*)</span>
2369 {
<a name="352" id="anc352"></a><span class="line-modified">2370     DollarVMAssertScope assertScope;</span>
<span class="line-added">2371     VM&amp; vm = globalObject-&gt;vm();</span>
2372     JSLockHolder lock(vm);
<a name="353" id="anc353"></a><span class="line-modified">2373     return JSValue::encode(Root::create(vm, globalObject));</span>
2374 }
2375 
<a name="354" id="anc354"></a><span class="line-modified">2376 static EncodedJSValue JSC_HOST_CALL functionCreateElement(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2377 {
<a name="355" id="anc355"></a><span class="line-modified">2378     DollarVMAssertScope assertScope;</span>
<span class="line-added">2379     VM&amp; vm = globalObject-&gt;vm();</span>
2380     JSLockHolder lock(vm);
2381     auto scope = DECLARE_THROW_SCOPE(vm);
2382 
<a name="356" id="anc356"></a><span class="line-modified">2383     Root* root = jsDynamicCast&lt;Root*&gt;(vm, callFrame-&gt;argument(0));</span>
2384     if (!root)
<a name="357" id="anc357"></a><span class="line-modified">2385         return JSValue::encode(throwException(globalObject, scope, createError(globalObject, &quot;Cannot create Element without a Root.&quot;_s)));</span>
<span class="line-modified">2386     return JSValue::encode(Element::create(vm, globalObject, root));</span>
2387 }
2388 
<a name="358" id="anc358"></a><span class="line-modified">2389 static EncodedJSValue JSC_HOST_CALL functionGetElement(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2390 {
<a name="359" id="anc359"></a><span class="line-modified">2391     DollarVMAssertScope assertScope;</span>
<span class="line-added">2392     VM&amp; vm = globalObject-&gt;vm();</span>
2393     JSLockHolder lock(vm);
<a name="360" id="anc360"></a><span class="line-modified">2394     Root* root = jsDynamicCast&lt;Root*&gt;(vm, callFrame-&gt;argument(0));</span>
2395     if (!root)
2396         return JSValue::encode(jsUndefined());
2397     Element* result = root-&gt;element();
2398     return JSValue::encode(result ? result : jsUndefined());
2399 }
2400 
<a name="361" id="anc361"></a><span class="line-modified">2401 static EncodedJSValue JSC_HOST_CALL functionCreateSimpleObject(JSGlobalObject* globalObject, CallFrame*)</span>
2402 {
<a name="362" id="anc362"></a><span class="line-modified">2403     DollarVMAssertScope assertScope;</span>
<span class="line-added">2404     VM&amp; vm = globalObject-&gt;vm();</span>
2405     JSLockHolder lock(vm);
<a name="363" id="anc363"></a><span class="line-modified">2406     return JSValue::encode(SimpleObject::create(vm, globalObject));</span>
2407 }
2408 
<a name="364" id="anc364"></a><span class="line-modified">2409 static EncodedJSValue JSC_HOST_CALL functionGetHiddenValue(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2410 {
<a name="365" id="anc365"></a><span class="line-modified">2411     DollarVMAssertScope assertScope;</span>
<span class="line-added">2412     VM&amp; vm = globalObject-&gt;vm();</span>
2413     JSLockHolder lock(vm);
2414     auto scope = DECLARE_THROW_SCOPE(vm);
2415 
<a name="366" id="anc366"></a><span class="line-modified">2416     SimpleObject* simpleObject = jsDynamicCast&lt;SimpleObject*&gt;(vm, callFrame-&gt;argument(0));</span>
2417     if (UNLIKELY(!simpleObject)) {
<a name="367" id="anc367"></a><span class="line-modified">2418         throwTypeError(globalObject, scope, &quot;Invalid use of getHiddenValue test function&quot;_s);</span>
2419         return encodedJSValue();
2420     }
2421     return JSValue::encode(simpleObject-&gt;hiddenValue());
2422 }
2423 
<a name="368" id="anc368"></a><span class="line-modified">2424 static EncodedJSValue JSC_HOST_CALL functionSetHiddenValue(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2425 {
<a name="369" id="anc369"></a><span class="line-modified">2426     DollarVMAssertScope assertScope;</span>
<span class="line-added">2427     VM&amp; vm = globalObject-&gt;vm();</span>
2428     JSLockHolder lock(vm);
2429     auto scope = DECLARE_THROW_SCOPE(vm);
2430 
<a name="370" id="anc370"></a><span class="line-modified">2431     SimpleObject* simpleObject = jsDynamicCast&lt;SimpleObject*&gt;(vm, callFrame-&gt;argument(0));</span>
2432     if (UNLIKELY(!simpleObject)) {
<a name="371" id="anc371"></a><span class="line-modified">2433         throwTypeError(globalObject, scope, &quot;Invalid use of setHiddenValue test function&quot;_s);</span>
2434         return encodedJSValue();
2435     }
<a name="372" id="anc372"></a><span class="line-modified">2436     JSValue value = callFrame-&gt;argument(1);</span>
2437     simpleObject-&gt;setHiddenValue(vm, value);
2438     return JSValue::encode(jsUndefined());
2439 }
2440 
<a name="373" id="anc373"></a><span class="line-modified">2441 static EncodedJSValue JSC_HOST_CALL functionShadowChickenFunctionsOnStack(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2442 {
<a name="374" id="anc374"></a><span class="line-modified">2443     DollarVMAssertScope assertScope;</span>
<span class="line-added">2444     VM&amp; vm = globalObject-&gt;vm();</span>
2445     auto scope = DECLARE_THROW_SCOPE(vm);
2446     if (auto* shadowChicken = vm.shadowChicken()) {
2447         scope.release();
<a name="375" id="anc375"></a><span class="line-modified">2448         return JSValue::encode(shadowChicken-&gt;functionsOnStack(globalObject, callFrame));</span>
2449     }
2450 
<a name="376" id="anc376"></a><span class="line-modified">2451     JSArray* result = constructEmptyArray(globalObject, 0);</span>
2452     RETURN_IF_EXCEPTION(scope, { });
<a name="377" id="anc377"></a><span class="line-modified">2453     StackVisitor::visit(callFrame, vm, [&amp;] (StackVisitor&amp; visitor) -&gt; StackVisitor::Status {</span>
<span class="line-added">2454         DollarVMAssertScope assertScope;</span>
2455         if (visitor-&gt;isInlinedFrame())
2456             return StackVisitor::Continue;
2457         if (visitor-&gt;isWasmFrame())
2458             return StackVisitor::Continue;
<a name="378" id="anc378"></a><span class="line-modified">2459         result-&gt;push(globalObject, jsCast&lt;JSObject*&gt;(visitor-&gt;callee().asCell()));</span>
2460         scope.releaseAssertNoException(); // This function is only called from tests.
2461         return StackVisitor::Continue;
2462     });
2463     RETURN_IF_EXCEPTION(scope, { });
2464     return JSValue::encode(result);
2465 }
2466 
<a name="379" id="anc379"></a><span class="line-modified">2467 static EncodedJSValue JSC_HOST_CALL functionSetGlobalConstRedeclarationShouldNotThrow(JSGlobalObject* globalObject, CallFrame*)</span>
2468 {
<a name="380" id="anc380"></a><span class="line-modified">2469     DollarVMAssertScope assertScope;</span>
<span class="line-added">2470     VM&amp; vm = globalObject-&gt;vm();</span>
2471     vm.setGlobalConstRedeclarationShouldThrow(false);
2472     return JSValue::encode(jsUndefined());
2473 }
2474 
<a name="381" id="anc381"></a><span class="line-modified">2475 static EncodedJSValue JSC_HOST_CALL functionFindTypeForExpression(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2476 {
<a name="382" id="anc382"></a><span class="line-modified">2477     DollarVMAssertScope assertScope;</span>
<span class="line-added">2478     VM&amp; vm = globalObject-&gt;vm();</span>
2479     RELEASE_ASSERT(vm.typeProfiler());
2480     vm.typeProfilerLog()-&gt;processLogEntries(vm, &quot;jsc Testing API: functionFindTypeForExpression&quot;_s);
2481 
<a name="383" id="anc383"></a><span class="line-modified">2482     JSValue functionValue = callFrame-&gt;argument(0);</span>
2483     RELEASE_ASSERT(functionValue.isFunction(vm));
2484     FunctionExecutable* executable = (jsDynamicCast&lt;JSFunction*&gt;(vm, functionValue.asCell()-&gt;getObject()))-&gt;jsExecutable();
2485 
<a name="384" id="anc384"></a><span class="line-modified">2486     RELEASE_ASSERT(callFrame-&gt;argument(1).isString());</span>
<span class="line-modified">2487     String substring = asString(callFrame-&gt;argument(1))-&gt;value(globalObject);</span>
2488     String sourceCodeText = executable-&gt;source().view().toString();
2489     unsigned offset = static_cast&lt;unsigned&gt;(sourceCodeText.find(substring) + executable-&gt;source().startOffset());
2490 
2491     String jsonString = vm.typeProfiler()-&gt;typeInformationForExpressionAtOffset(TypeProfilerSearchDescriptorNormal, offset, executable-&gt;sourceID(), vm);
<a name="385" id="anc385"></a><span class="line-modified">2492     return JSValue::encode(JSONParse(globalObject, jsonString));</span>
2493 }
2494 
<a name="386" id="anc386"></a><span class="line-modified">2495 static EncodedJSValue JSC_HOST_CALL functionReturnTypeFor(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2496 {
<a name="387" id="anc387"></a><span class="line-modified">2497     DollarVMAssertScope assertScope;</span>
<span class="line-added">2498     VM&amp; vm = globalObject-&gt;vm();</span>
2499     RELEASE_ASSERT(vm.typeProfiler());
2500     vm.typeProfilerLog()-&gt;processLogEntries(vm, &quot;jsc Testing API: functionReturnTypeFor&quot;_s);
2501 
<a name="388" id="anc388"></a><span class="line-modified">2502     JSValue functionValue = callFrame-&gt;argument(0);</span>
2503     RELEASE_ASSERT(functionValue.isFunction(vm));
2504     FunctionExecutable* executable = (jsDynamicCast&lt;JSFunction*&gt;(vm, functionValue.asCell()-&gt;getObject()))-&gt;jsExecutable();
2505 
2506     unsigned offset = executable-&gt;typeProfilingStartOffset(vm);
2507     String jsonString = vm.typeProfiler()-&gt;typeInformationForExpressionAtOffset(TypeProfilerSearchDescriptorFunctionReturn, offset, executable-&gt;sourceID(), vm);
<a name="389" id="anc389"></a><span class="line-modified">2508     return JSValue::encode(JSONParse(globalObject, jsonString));</span>
2509 }
2510 
<a name="390" id="anc390"></a><span class="line-modified">2511 static EncodedJSValue JSC_HOST_CALL functionFlattenDictionaryObject(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2512 {
<a name="391" id="anc391"></a><span class="line-modified">2513     DollarVMAssertScope assertScope;</span>
<span class="line-modified">2514     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">2515     JSValue value = callFrame-&gt;argument(0);</span>
2516     RELEASE_ASSERT(value.isObject() &amp;&amp; value.getObject()-&gt;structure()-&gt;isDictionary());
2517     value.getObject()-&gt;flattenDictionaryObject(vm);
2518     return encodedJSUndefined();
2519 }
2520 
<a name="392" id="anc392"></a><span class="line-modified">2521 static EncodedJSValue JSC_HOST_CALL functionDumpBasicBlockExecutionRanges(JSGlobalObject* globalObject, CallFrame*)</span>
2522 {
<a name="393" id="anc393"></a><span class="line-modified">2523     DollarVMAssertScope assertScope;</span>
<span class="line-added">2524     VM&amp; vm = globalObject-&gt;vm();</span>
2525     RELEASE_ASSERT(vm.controlFlowProfiler());
2526     vm.controlFlowProfiler()-&gt;dumpData();
2527     return JSValue::encode(jsUndefined());
2528 }
2529 
<a name="394" id="anc394"></a><span class="line-modified">2530 static EncodedJSValue JSC_HOST_CALL functionHasBasicBlockExecuted(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2531 {
<a name="395" id="anc395"></a><span class="line-modified">2532     DollarVMAssertScope assertScope;</span>
<span class="line-added">2533     VM&amp; vm = globalObject-&gt;vm();</span>
2534     RELEASE_ASSERT(vm.controlFlowProfiler());
2535 
<a name="396" id="anc396"></a><span class="line-modified">2536     JSValue functionValue = callFrame-&gt;argument(0);</span>
2537     RELEASE_ASSERT(functionValue.isFunction(vm));
2538     FunctionExecutable* executable = (jsDynamicCast&lt;JSFunction*&gt;(vm, functionValue.asCell()-&gt;getObject()))-&gt;jsExecutable();
2539 
<a name="397" id="anc397"></a><span class="line-modified">2540     RELEASE_ASSERT(callFrame-&gt;argument(1).isString());</span>
<span class="line-modified">2541     String substring = asString(callFrame-&gt;argument(1))-&gt;value(globalObject);</span>
2542     String sourceCodeText = executable-&gt;source().view().toString();
2543     RELEASE_ASSERT(sourceCodeText.contains(substring));
2544     int offset = sourceCodeText.find(substring) + executable-&gt;source().startOffset();
2545 
2546     bool hasExecuted = vm.controlFlowProfiler()-&gt;hasBasicBlockAtTextOffsetBeenExecuted(offset, executable-&gt;sourceID(), vm);
2547     return JSValue::encode(jsBoolean(hasExecuted));
2548 }
2549 
<a name="398" id="anc398"></a><span class="line-modified">2550 static EncodedJSValue JSC_HOST_CALL functionBasicBlockExecutionCount(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2551 {
<a name="399" id="anc399"></a><span class="line-modified">2552     DollarVMAssertScope assertScope;</span>
<span class="line-added">2553     VM&amp; vm = globalObject-&gt;vm();</span>
2554     RELEASE_ASSERT(vm.controlFlowProfiler());
2555 
<a name="400" id="anc400"></a><span class="line-modified">2556     JSValue functionValue = callFrame-&gt;argument(0);</span>
2557     RELEASE_ASSERT(functionValue.isFunction(vm));
2558     FunctionExecutable* executable = (jsDynamicCast&lt;JSFunction*&gt;(vm, functionValue.asCell()-&gt;getObject()))-&gt;jsExecutable();
2559 
<a name="401" id="anc401"></a><span class="line-modified">2560     RELEASE_ASSERT(callFrame-&gt;argument(1).isString());</span>
<span class="line-modified">2561     String substring = asString(callFrame-&gt;argument(1))-&gt;value(globalObject);</span>
2562     String sourceCodeText = executable-&gt;source().view().toString();
2563     RELEASE_ASSERT(sourceCodeText.contains(substring));
2564     int offset = sourceCodeText.find(substring) + executable-&gt;source().startOffset();
2565 
2566     size_t executionCount = vm.controlFlowProfiler()-&gt;basicBlockExecutionCountAtTextOffset(offset, executable-&gt;sourceID(), vm);
2567     return JSValue::encode(JSValue(executionCount));
2568 }
2569 
<a name="402" id="anc402"></a><span class="line-modified">2570 static EncodedJSValue JSC_HOST_CALL functionEnableExceptionFuzz(JSGlobalObject*, CallFrame*)</span>
2571 {
<a name="403" id="anc403"></a><span class="line-added">2572     DollarVMAssertScope assertScope;</span>
2573     Options::useExceptionFuzz() = true;
2574     return JSValue::encode(jsUndefined());
2575 }
2576 
<a name="404" id="anc404"></a><span class="line-modified">2577 class DoNothingDebugger final : public Debugger {</span>
<span class="line-added">2578     WTF_MAKE_NONCOPYABLE(DoNothingDebugger);</span>
<span class="line-added">2579     WTF_MAKE_FAST_ALLOCATED;</span>
<span class="line-added">2580 public:</span>
<span class="line-added">2581     DoNothingDebugger(VM&amp; vm)</span>
<span class="line-added">2582         : Debugger(vm)</span>
<span class="line-added">2583     {</span>
<span class="line-added">2584         DollarVMAssertScope assertScope;</span>
<span class="line-added">2585         setSuppressAllPauses(true);</span>
<span class="line-added">2586     }</span>
<span class="line-added">2587 </span>
<span class="line-added">2588 private:</span>
<span class="line-added">2589     void sourceParsed(JSGlobalObject*, SourceProvider*, int, const WTF::String&amp;) override</span>
<span class="line-added">2590     {</span>
<span class="line-added">2591         DollarVMAssertScope assertScope;</span>
<span class="line-added">2592     }</span>
<span class="line-added">2593 };</span>
<span class="line-added">2594 </span>
<span class="line-added">2595 static EncodedJSValue changeDebuggerModeWhenIdle(JSGlobalObject* globalObject, OptionSet&lt;CodeGenerationMode&gt; codeGenerationMode)</span>
2596 {
<a name="405" id="anc405"></a><span class="line-modified">2597     DollarVMAssertScope assertScope;</span>
<span class="line-modified">2598 </span>
<span class="line-added">2599     bool debuggerRequested = codeGenerationMode.contains(CodeGenerationMode::Debugger);</span>
<span class="line-added">2600     if (debuggerRequested == globalObject-&gt;hasDebugger())</span>
2601         return JSValue::encode(jsUndefined());
2602 
<a name="406" id="anc406"></a><span class="line-modified">2603     VM* vm = &amp;globalObject-&gt;vm();</span>
2604     vm-&gt;whenIdle([=] () {
<a name="407" id="anc407"></a><span class="line-modified">2605         DollarVMAssertScope assertScope;</span>
<span class="line-modified">2606         if (debuggerRequested) {</span>
<span class="line-modified">2607             Debugger* debugger = new DoNothingDebugger(globalObject-&gt;vm());</span>
<span class="line-modified">2608             globalObject-&gt;setDebugger(debugger);</span>
<span class="line-added">2609             debugger-&gt;activateBreakpoints(); // Also deletes all code.</span>
<span class="line-added">2610         } else {</span>
<span class="line-added">2611             Debugger* debugger = globalObject-&gt;debugger();</span>
<span class="line-added">2612             debugger-&gt;deactivateBreakpoints(); // Also deletes all code.</span>
<span class="line-added">2613             globalObject-&gt;setDebugger(nullptr);</span>
<span class="line-added">2614             delete debugger;</span>
<span class="line-added">2615         }</span>
2616     });
2617     return JSValue::encode(jsUndefined());
2618 }
2619 
<a name="408" id="anc408"></a><span class="line-modified">2620 static EncodedJSValue JSC_HOST_CALL functionEnableDebuggerModeWhenIdle(JSGlobalObject* globalObject, CallFrame*)</span>
2621 {
<a name="409" id="anc409"></a><span class="line-modified">2622     DollarVMAssertScope assertScope;</span>
<span class="line-added">2623     return changeDebuggerModeWhenIdle(globalObject, { CodeGenerationMode::Debugger });</span>
2624 }
2625 
<a name="410" id="anc410"></a><span class="line-modified">2626 static EncodedJSValue JSC_HOST_CALL functionDisableDebuggerModeWhenIdle(JSGlobalObject* globalObject, CallFrame*)</span>
2627 {
<a name="411" id="anc411"></a><span class="line-modified">2628     DollarVMAssertScope assertScope;</span>
<span class="line-added">2629     return changeDebuggerModeWhenIdle(globalObject, { });</span>
2630 }
2631 
<a name="412" id="anc412"></a><span class="line-modified">2632 static EncodedJSValue JSC_HOST_CALL functionDeleteAllCodeWhenIdle(JSGlobalObject* globalObject, CallFrame*)</span>
2633 {
<a name="413" id="anc413"></a><span class="line-modified">2634     DollarVMAssertScope assertScope;</span>
<span class="line-added">2635     VM* vm = &amp;globalObject-&gt;vm();</span>
2636     vm-&gt;whenIdle([=] () {
<a name="414" id="anc414"></a><span class="line-added">2637         DollarVMAssertScope assertScope;</span>
2638         vm-&gt;deleteAllCode(PreventCollectionAndDeleteAllCode);
2639     });
2640     return JSValue::encode(jsUndefined());
2641 }
2642 
<a name="415" id="anc415"></a><span class="line-modified">2643 static EncodedJSValue JSC_HOST_CALL functionGlobalObjectCount(JSGlobalObject* globalObject, CallFrame*)</span>
2644 {
<a name="416" id="anc416"></a><span class="line-modified">2645     DollarVMAssertScope assertScope;</span>
<span class="line-added">2646     return JSValue::encode(jsNumber(globalObject-&gt;vm().heap.globalObjectCount()));</span>
2647 }
2648 
<a name="417" id="anc417"></a><span class="line-modified">2649 static EncodedJSValue JSC_HOST_CALL functionGlobalObjectForObject(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2650 {
<a name="418" id="anc418"></a><span class="line-modified">2651     DollarVMAssertScope assertScope;</span>
<span class="line-added">2652     JSValue value = callFrame-&gt;argument(0);</span>
2653     RELEASE_ASSERT(value.isObject());
<a name="419" id="anc419"></a><span class="line-modified">2654     JSGlobalObject* result = jsCast&lt;JSObject*&gt;(value)-&gt;globalObject(globalObject-&gt;vm());</span>
<span class="line-modified">2655     RELEASE_ASSERT(result);</span>
<span class="line-modified">2656     return JSValue::encode(result);</span>
2657 }
2658 
<a name="420" id="anc420"></a><span class="line-modified">2659 static EncodedJSValue JSC_HOST_CALL functionGetGetterSetter(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2660 {
<a name="421" id="anc421"></a><span class="line-modified">2661     DollarVMAssertScope assertScope;</span>
<span class="line-added">2662     VM&amp; vm = globalObject-&gt;vm();</span>
2663     auto scope = DECLARE_THROW_SCOPE(vm);
2664 
<a name="422" id="anc422"></a><span class="line-modified">2665     JSValue value = callFrame-&gt;argument(0);</span>
2666     if (!value.isObject())
2667         return JSValue::encode(jsUndefined());
2668 
<a name="423" id="anc423"></a><span class="line-modified">2669     JSValue property = callFrame-&gt;argument(1);</span>
2670     if (!property.isString())
2671         return JSValue::encode(jsUndefined());
2672 
<a name="424" id="anc424"></a><span class="line-modified">2673     auto propertyName = asString(property)-&gt;toIdentifier(globalObject);</span>
2674     RETURN_IF_EXCEPTION(scope, { });
2675 
2676     PropertySlot slot(value, PropertySlot::InternalMethodType::VMInquiry);
<a name="425" id="anc425"></a><span class="line-modified">2677     value.getPropertySlot(globalObject, propertyName, slot);</span>
2678     RETURN_IF_EXCEPTION(scope, { });
2679 
2680     JSValue result;
2681     if (slot.isCacheableGetter())
2682         result = slot.getterSetter();
2683     else
2684         result = jsNull();
2685 
2686     return JSValue::encode(result);
2687 }
2688 
<a name="426" id="anc426"></a><span class="line-modified">2689 static EncodedJSValue JSC_HOST_CALL functionLoadGetterFromGetterSetter(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2690 {
<a name="427" id="anc427"></a><span class="line-modified">2691     DollarVMAssertScope assertScope;</span>
<span class="line-added">2692     VM&amp; vm = globalObject-&gt;vm();</span>
2693     auto scope = DECLARE_THROW_SCOPE(vm);
2694 
<a name="428" id="anc428"></a><span class="line-modified">2695     GetterSetter* getterSetter = jsDynamicCast&lt;GetterSetter*&gt;(vm, callFrame-&gt;argument(0));</span>
2696     if (UNLIKELY(!getterSetter)) {
<a name="429" id="anc429"></a><span class="line-modified">2697         throwTypeError(globalObject, scope, &quot;Invalid use of loadGetterFromGetterSetter test function: argument is not a GetterSetter&quot;_s);</span>
2698         return encodedJSValue();
2699     }
2700 
2701     JSObject* getter = getterSetter-&gt;getter();
2702     RELEASE_ASSERT(getter);
2703     return JSValue::encode(getter);
2704 }
2705 
<a name="430" id="anc430"></a><span class="line-modified">2706 static EncodedJSValue JSC_HOST_CALL functionCreateCustomTestGetterSetter(JSGlobalObject* globalObject, CallFrame*)</span>
2707 {
<a name="431" id="anc431"></a><span class="line-modified">2708     DollarVMAssertScope assertScope;</span>
<span class="line-modified">2709     VM&amp; vm = globalObject-&gt;vm();</span>
2710     return JSValue::encode(JSTestCustomGetterSetter::create(vm, globalObject, JSTestCustomGetterSetter::createStructure(vm, globalObject)));
2711 }
2712 
<a name="432" id="anc432"></a><span class="line-modified">2713 static EncodedJSValue JSC_HOST_CALL functionDeltaBetweenButterflies(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
2714 {
<a name="433" id="anc433"></a><span class="line-modified">2715     DollarVMAssertScope assertScope;</span>
<span class="line-modified">2716     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">2717     JSObject* a = jsDynamicCast&lt;JSObject*&gt;(vm, callFrame-&gt;argument(0));</span>
<span class="line-added">2718     JSObject* b = jsDynamicCast&lt;JSObject*&gt;(vm, callFrame-&gt;argument(1));</span>
2719     if (!a || !b)
2720         return JSValue::encode(jsNumber(PNaN));
2721 
2722     ptrdiff_t delta = bitwise_cast&lt;char*&gt;(a-&gt;butterfly()) - bitwise_cast&lt;char*&gt;(b-&gt;butterfly());
2723     if (delta &lt; 0)
2724         return JSValue::encode(jsNumber(PNaN));
2725     if (delta &gt; std::numeric_limits&lt;int32_t&gt;::max())
2726         return JSValue::encode(jsNumber(PNaN));
2727     return JSValue::encode(jsNumber(static_cast&lt;int32_t&gt;(delta)));
2728 }
2729 
<a name="434" id="anc434"></a><span class="line-modified">2730 static EncodedJSValue JSC_HOST_CALL functionCurrentCPUTime(JSGlobalObject*, CallFrame*)</span>
<span class="line-added">2731 {</span>
<span class="line-added">2732     DollarVMAssertScope assertScope;</span>
<span class="line-added">2733     return JSValue::encode(jsNumber(CPUTime::forCurrentThread().value()));</span>
<span class="line-added">2734 }</span>
<span class="line-added">2735 </span>
<span class="line-added">2736 static EncodedJSValue JSC_HOST_CALL functionTotalGCTime(JSGlobalObject* globalObject, CallFrame*)</span>
2737 {
<a name="435" id="anc435"></a><span class="line-modified">2738     DollarVMAssertScope assertScope;</span>
<span class="line-added">2739     VM&amp; vm = globalObject-&gt;vm();</span>
2740     return JSValue::encode(jsNumber(vm.heap.totalGCTime().seconds()));
2741 }
2742 
<a name="436" id="anc436"></a><span class="line-modified">2743 static EncodedJSValue JSC_HOST_CALL functionParseCount(JSGlobalObject*, CallFrame*)</span>
2744 {
<a name="437" id="anc437"></a><span class="line-added">2745     DollarVMAssertScope assertScope;</span>
2746     return JSValue::encode(jsNumber(globalParseCount.load()));
2747 }
2748 
<a name="438" id="anc438"></a><span class="line-modified">2749 static EncodedJSValue JSC_HOST_CALL functionIsWasmSupported(JSGlobalObject*, CallFrame*)</span>
2750 {
<a name="439" id="anc439"></a><span class="line-added">2751     DollarVMAssertScope assertScope;</span>
2752 #if ENABLE(WEBASSEMBLY)
2753     return JSValue::encode(jsBoolean(Wasm::isSupported()));
2754 #else
2755     return JSValue::encode(jsBoolean(false));
2756 #endif
2757 }
2758 
<a name="440" id="anc440"></a><span class="line-added">2759 static EncodedJSValue JSC_HOST_CALL functionMake16BitStringIfPossible(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
<span class="line-added">2760 {</span>
<span class="line-added">2761     DollarVMAssertScope assertScope;</span>
<span class="line-added">2762     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">2763     auto scope = DECLARE_THROW_SCOPE(vm);</span>
<span class="line-added">2764     String string = callFrame-&gt;argument(0).toWTFString(globalObject);</span>
<span class="line-added">2765     RETURN_IF_EXCEPTION(scope, { });</span>
<span class="line-added">2766     if (!string.is8Bit())</span>
<span class="line-added">2767         return JSValue::encode(jsString(vm, WTFMove(string)));</span>
<span class="line-added">2768     Vector&lt;UChar&gt; buffer;</span>
<span class="line-added">2769     buffer.resize(string.length());</span>
<span class="line-added">2770     StringImpl::copyCharacters(buffer.data(), string.characters8(), string.length());</span>
<span class="line-added">2771     return JSValue::encode(jsString(vm, String::adopt(WTFMove(buffer))));</span>
<span class="line-added">2772 }</span>
<span class="line-added">2773 </span>
<span class="line-added">2774 EncodedJSValue JSC_HOST_CALL JSDollarVMHelper::functionGetStructureTransitionList(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
<span class="line-added">2775 {</span>
<span class="line-added">2776     DollarVMAssertScope assertScope;</span>
<span class="line-added">2777     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">2778     auto scope = DECLARE_THROW_SCOPE(vm);</span>
<span class="line-added">2779     JSObject* obj = callFrame-&gt;argument(0).toObject(globalObject);</span>
<span class="line-added">2780     RETURN_IF_EXCEPTION(scope, { });</span>
<span class="line-added">2781     if (!obj)</span>
<span class="line-added">2782         return JSValue::encode(jsNull());</span>
<span class="line-added">2783     Vector&lt;Structure*, 8&gt; structures;</span>
<span class="line-added">2784 </span>
<span class="line-added">2785     for (auto* structure = obj-&gt;structure(); structure; structure = structure-&gt;previousID())</span>
<span class="line-added">2786         structures.append(structure);</span>
<span class="line-added">2787 </span>
<span class="line-added">2788     JSArray* result = JSArray::tryCreate(vm, globalObject-&gt;arrayStructureForIndexingTypeDuringAllocation(ArrayWithContiguous), 0);</span>
<span class="line-added">2789     RETURN_IF_EXCEPTION(scope, { });</span>
<span class="line-added">2790 </span>
<span class="line-added">2791     for (size_t i = 0; i &lt; structures.size(); ++i) {</span>
<span class="line-added">2792         auto* structure = structures[structures.size() - i - 1];</span>
<span class="line-added">2793         result-&gt;push(globalObject, JSValue(structure-&gt;id()));</span>
<span class="line-added">2794         RETURN_IF_EXCEPTION(scope, { });</span>
<span class="line-added">2795         result-&gt;push(globalObject, JSValue(structure-&gt;transitionOffset()));</span>
<span class="line-added">2796         RETURN_IF_EXCEPTION(scope, { });</span>
<span class="line-added">2797         result-&gt;push(globalObject, JSValue(structure-&gt;maxOffset()));</span>
<span class="line-added">2798         RETURN_IF_EXCEPTION(scope, { });</span>
<span class="line-added">2799         if (structure-&gt;m_transitionPropertyName)</span>
<span class="line-added">2800             result-&gt;push(globalObject, jsString(vm, String(*structure-&gt;m_transitionPropertyName)));</span>
<span class="line-added">2801         else</span>
<span class="line-added">2802             result-&gt;push(globalObject, jsNull());</span>
<span class="line-added">2803         RETURN_IF_EXCEPTION(scope, { });</span>
<span class="line-added">2804         result-&gt;push(globalObject, JSValue(structure-&gt;isPropertyDeletionTransition()));</span>
<span class="line-added">2805         RETURN_IF_EXCEPTION(scope, { });</span>
<span class="line-added">2806     }</span>
<span class="line-added">2807 </span>
<span class="line-added">2808     return JSValue::encode(result);</span>
<span class="line-added">2809 }</span>
<span class="line-added">2810 </span>
<span class="line-added">2811 static EncodedJSValue JSC_HOST_CALL functionGetConcurrently(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
<span class="line-added">2812 {</span>
<span class="line-added">2813     DollarVMAssertScope assertScope;</span>
<span class="line-added">2814     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-added">2815     auto scope = DECLARE_THROW_SCOPE(vm);</span>
<span class="line-added">2816     JSObject* obj = callFrame-&gt;argument(0).toObject(globalObject);</span>
<span class="line-added">2817     RETURN_IF_EXCEPTION(scope, { });</span>
<span class="line-added">2818     if (!obj)</span>
<span class="line-added">2819         return JSValue::encode(jsNull());</span>
<span class="line-added">2820     String property = callFrame-&gt;argument(1).toWTFString(globalObject);</span>
<span class="line-added">2821     RETURN_IF_EXCEPTION(scope, { });</span>
<span class="line-added">2822     auto name = PropertyName(Identifier::fromString(vm, property));</span>
<span class="line-added">2823     auto offset = obj-&gt;structure()-&gt;getConcurrently(name.uid());</span>
<span class="line-added">2824     if (offset != invalidOffset)</span>
<span class="line-added">2825         ASSERT(JSValue::encode(obj-&gt;getDirect(offset)));</span>
<span class="line-added">2826     JSValue result = JSValue(offset != invalidOffset);</span>
<span class="line-added">2827     RETURN_IF_EXCEPTION(scope, { });</span>
<span class="line-added">2828     return JSValue::encode(result);</span>
<span class="line-added">2829 }</span>
<span class="line-added">2830 </span>
2831 void JSDollarVM::finishCreation(VM&amp; vm)
2832 {
<a name="441" id="anc441"></a><span class="line-added">2833     DollarVMAssertScope assertScope;</span>
2834     Base::finishCreation(vm);
2835 
2836     JSGlobalObject* globalObject = this-&gt;globalObject(vm);
2837 
2838     auto addFunction = [&amp;] (VM&amp; vm, const char* name, NativeFunction function, unsigned arguments) {
<a name="442" id="anc442"></a><span class="line-added">2839         DollarVMAssertScope assertScope;</span>
2840         JSDollarVM::addFunction(vm, globalObject, name, function, arguments);
2841     };
2842     auto addConstructibleFunction = [&amp;] (VM&amp; vm, const char* name, NativeFunction function, unsigned arguments) {
<a name="443" id="anc443"></a><span class="line-added">2843         DollarVMAssertScope assertScope;</span>
2844         JSDollarVM::addConstructibleFunction(vm, globalObject, name, function, arguments);
2845     };
2846 
2847     addFunction(vm, &quot;abort&quot;, functionCrash, 0);
2848     addFunction(vm, &quot;crash&quot;, functionCrash, 0);
2849     addFunction(vm, &quot;breakpoint&quot;, functionBreakpoint, 0);
2850 
2851     putDirectNativeFunction(vm, globalObject, Identifier::fromString(vm, &quot;dfgTrue&quot;), 0, functionDFGTrue, DFGTrueIntrinsic, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
2852     putDirectNativeFunction(vm, globalObject, Identifier::fromString(vm, &quot;ftlTrue&quot;), 0, functionFTLTrue, FTLTrueIntrinsic, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
2853 
2854     putDirectNativeFunction(vm, globalObject, Identifier::fromString(vm, &quot;cpuMfence&quot;), 0, functionCpuMfence, CPUMfenceIntrinsic, 0);
2855     putDirectNativeFunction(vm, globalObject, Identifier::fromString(vm, &quot;cpuRdtsc&quot;), 0, functionCpuRdtsc, CPURdtscIntrinsic, 0);
2856     putDirectNativeFunction(vm, globalObject, Identifier::fromString(vm, &quot;cpuCpuid&quot;), 0, functionCpuCpuid, CPUCpuidIntrinsic, 0);
2857     putDirectNativeFunction(vm, globalObject, Identifier::fromString(vm, &quot;cpuPause&quot;), 0, functionCpuPause, CPUPauseIntrinsic, 0);
2858     addFunction(vm, &quot;cpuClflush&quot;, functionCpuClflush, 2);
2859 
2860     addFunction(vm, &quot;llintTrue&quot;, functionLLintTrue, 0);
2861     addFunction(vm, &quot;jitTrue&quot;, functionJITTrue, 0);
2862 
2863     addFunction(vm, &quot;noInline&quot;, functionNoInline, 1);
2864 
2865     addFunction(vm, &quot;gc&quot;, functionGC, 0);
2866     addFunction(vm, &quot;edenGC&quot;, functionEdenGC, 0);
2867     addFunction(vm, &quot;dumpSubspaceHashes&quot;, functionDumpSubspaceHashes, 0);
2868 
2869     addFunction(vm, &quot;callFrame&quot;, functionCallFrame, 1);
2870     addFunction(vm, &quot;codeBlockFor&quot;, functionCodeBlockFor, 1);
2871     addFunction(vm, &quot;codeBlockForFrame&quot;, functionCodeBlockForFrame, 1);
2872     addFunction(vm, &quot;dumpSourceFor&quot;, functionDumpSourceFor, 1);
2873     addFunction(vm, &quot;dumpBytecodeFor&quot;, functionDumpBytecodeFor, 1);
2874 
2875     addFunction(vm, &quot;dataLog&quot;, functionDataLog, 1);
2876     addFunction(vm, &quot;print&quot;, functionPrint, 1);
2877     addFunction(vm, &quot;dumpCallFrame&quot;, functionDumpCallFrame, 0);
2878     addFunction(vm, &quot;dumpStack&quot;, functionDumpStack, 0);
2879     addFunction(vm, &quot;dumpRegisters&quot;, functionDumpRegisters, 1);
2880 
2881     addFunction(vm, &quot;dumpCell&quot;, functionDumpCell, 1);
2882 
2883     addFunction(vm, &quot;indexingMode&quot;, functionIndexingMode, 1);
2884     addFunction(vm, &quot;inlineCapacity&quot;, functionInlineCapacity, 1);
2885     addFunction(vm, &quot;value&quot;, functionValue, 1);
2886     addFunction(vm, &quot;getpid&quot;, functionGetPID, 0);
2887 
2888     addFunction(vm, &quot;haveABadTime&quot;, functionHaveABadTime, 1);
2889     addFunction(vm, &quot;isHavingABadTime&quot;, functionIsHavingABadTime, 1);
2890 
<a name="444" id="anc444"></a><span class="line-added">2891     addFunction(vm, &quot;callWithStackSize&quot;, functionCallWithStackSize, 2);</span>
<span class="line-added">2892 </span>
2893     addFunction(vm, &quot;createGlobalObject&quot;, functionCreateGlobalObject, 0);
2894     addFunction(vm, &quot;createProxy&quot;, functionCreateProxy, 1);
2895     addFunction(vm, &quot;createRuntimeArray&quot;, functionCreateRuntimeArray, 0);
2896     addFunction(vm, &quot;createNullRopeString&quot;, functionCreateNullRopeString, 0);
2897 
2898     addFunction(vm, &quot;createImpureGetter&quot;, functionCreateImpureGetter, 1);
2899     addFunction(vm, &quot;createCustomGetterObject&quot;, functionCreateCustomGetterObject, 0);
2900     addFunction(vm, &quot;createDOMJITNodeObject&quot;, functionCreateDOMJITNodeObject, 0);
2901     addFunction(vm, &quot;createDOMJITGetterObject&quot;, functionCreateDOMJITGetterObject, 0);
2902     addFunction(vm, &quot;createDOMJITGetterComplexObject&quot;, functionCreateDOMJITGetterComplexObject, 0);
2903     addFunction(vm, &quot;createDOMJITFunctionObject&quot;, functionCreateDOMJITFunctionObject, 0);
2904     addFunction(vm, &quot;createDOMJITCheckSubClassObject&quot;, functionCreateDOMJITCheckSubClassObject, 0);
2905     addFunction(vm, &quot;createDOMJITGetterBaseJSObject&quot;, functionCreateDOMJITGetterBaseJSObject, 0);
2906     addFunction(vm, &quot;createBuiltin&quot;, functionCreateBuiltin, 2);
2907 #if ENABLE(WEBASSEMBLY)
2908     addFunction(vm, &quot;createWasmStreamingParser&quot;, functionCreateWasmStreamingParser, 0);
2909 #endif
<a name="445" id="anc445"></a><span class="line-added">2910     addFunction(vm, &quot;createStaticCustomAccessor&quot;, functionCreateStaticCustomAccessor, 0);</span>
<span class="line-added">2911     addFunction(vm, &quot;createObjectDoingSideEffectPutWithoutCorrectSlotStatus&quot;, functionCreateObjectDoingSideEffectPutWithoutCorrectSlotStatus, 0);</span>
2912     addFunction(vm, &quot;getPrivateProperty&quot;, functionGetPrivateProperty, 2);
2913     addFunction(vm, &quot;setImpureGetterDelegate&quot;, functionSetImpureGetterDelegate, 2);
2914 
2915     addConstructibleFunction(vm, &quot;Root&quot;, functionCreateRoot, 0);
2916     addConstructibleFunction(vm, &quot;Element&quot;, functionCreateElement, 1);
2917     addFunction(vm, &quot;getElement&quot;, functionGetElement, 1);
2918 
2919     addConstructibleFunction(vm, &quot;SimpleObject&quot;, functionCreateSimpleObject, 0);
2920     addFunction(vm, &quot;getHiddenValue&quot;, functionGetHiddenValue, 1);
2921     addFunction(vm, &quot;setHiddenValue&quot;, functionSetHiddenValue, 2);
2922 
2923     addFunction(vm, &quot;shadowChickenFunctionsOnStack&quot;, functionShadowChickenFunctionsOnStack, 0);
2924     addFunction(vm, &quot;setGlobalConstRedeclarationShouldNotThrow&quot;, functionSetGlobalConstRedeclarationShouldNotThrow, 0);
2925 
2926     addFunction(vm, &quot;findTypeForExpression&quot;, functionFindTypeForExpression, 2);
2927     addFunction(vm, &quot;returnTypeFor&quot;, functionReturnTypeFor, 1);
2928 
2929     addFunction(vm, &quot;flattenDictionaryObject&quot;, functionFlattenDictionaryObject, 1);
2930 
2931     addFunction(vm, &quot;dumpBasicBlockExecutionRanges&quot;, functionDumpBasicBlockExecutionRanges , 0);
2932     addFunction(vm, &quot;hasBasicBlockExecuted&quot;, functionHasBasicBlockExecuted, 2);
2933     addFunction(vm, &quot;basicBlockExecutionCount&quot;, functionBasicBlockExecutionCount, 2);
2934 
2935     addFunction(vm, &quot;enableExceptionFuzz&quot;, functionEnableExceptionFuzz, 0);
2936 
2937     addFunction(vm, &quot;enableDebuggerModeWhenIdle&quot;, functionEnableDebuggerModeWhenIdle, 0);
2938     addFunction(vm, &quot;disableDebuggerModeWhenIdle&quot;, functionDisableDebuggerModeWhenIdle, 0);
2939 
2940     addFunction(vm, &quot;deleteAllCodeWhenIdle&quot;, functionDeleteAllCodeWhenIdle, 0);
2941 
2942     addFunction(vm, &quot;globalObjectCount&quot;, functionGlobalObjectCount, 0);
2943     addFunction(vm, &quot;globalObjectForObject&quot;, functionGlobalObjectForObject, 1);
2944 
2945     addFunction(vm, &quot;getGetterSetter&quot;, functionGetGetterSetter, 2);
2946     addFunction(vm, &quot;loadGetterFromGetterSetter&quot;, functionLoadGetterFromGetterSetter, 1);
2947     addFunction(vm, &quot;createCustomTestGetterSetter&quot;, functionCreateCustomTestGetterSetter, 1);
2948 
2949     addFunction(vm, &quot;deltaBetweenButterflies&quot;, functionDeltaBetweenButterflies, 2);
2950 
<a name="446" id="anc446"></a><span class="line-added">2951     addFunction(vm, &quot;currentCPUTime&quot;, functionCurrentCPUTime, 0);</span>
2952     addFunction(vm, &quot;totalGCTime&quot;, functionTotalGCTime, 0);
2953 
2954     addFunction(vm, &quot;parseCount&quot;, functionParseCount, 0);
2955 
2956     addFunction(vm, &quot;isWasmSupported&quot;, functionIsWasmSupported, 0);
<a name="447" id="anc447"></a><span class="line-added">2957     addFunction(vm, &quot;make16BitStringIfPossible&quot;, functionMake16BitStringIfPossible, 1);</span>
<span class="line-added">2958 </span>
<span class="line-added">2959     addFunction(vm, &quot;getStructureTransitionList&quot;, JSDollarVMHelper::functionGetStructureTransitionList, 1);</span>
<span class="line-added">2960     addFunction(vm, &quot;getConcurrently&quot;, functionGetConcurrently, 2);</span>
<span class="line-added">2961 </span>
<span class="line-added">2962     m_objectDoingSideEffectPutWithoutCorrectSlotStatusStructure.set(vm, this, ObjectDoingSideEffectPutWithoutCorrectSlotStatus::createStructure(vm, globalObject, jsNull()));</span>
2963 }
2964 
2965 void JSDollarVM::addFunction(VM&amp; vm, JSGlobalObject* globalObject, const char* name, NativeFunction function, unsigned arguments)
2966 {
<a name="448" id="anc448"></a><span class="line-added">2967     DollarVMAssertScope assertScope;</span>
2968     Identifier identifier = Identifier::fromString(vm, name);
2969     putDirect(vm, identifier, JSFunction::create(vm, globalObject, arguments, identifier.string(), function));
2970 }
2971 
2972 void JSDollarVM::addConstructibleFunction(VM&amp; vm, JSGlobalObject* globalObject, const char* name, NativeFunction function, unsigned arguments)
2973 {
<a name="449" id="anc449"></a><span class="line-added">2974     DollarVMAssertScope assertScope;</span>
2975     Identifier identifier = Identifier::fromString(vm, name);
2976     putDirect(vm, identifier, JSFunction::create(vm, globalObject, arguments, identifier.string(), function, NoIntrinsic, function));
2977 }
2978 
<a name="450" id="anc450"></a><span class="line-added">2979 void JSDollarVM::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)</span>
<span class="line-added">2980 {</span>
<span class="line-added">2981     JSDollarVM* thisObject = jsCast&lt;JSDollarVM*&gt;(cell);</span>
<span class="line-added">2982     Base::visitChildren(thisObject, visitor);</span>
<span class="line-added">2983     visitor.append(thisObject-&gt;m_objectDoingSideEffectPutWithoutCorrectSlotStatusStructure);</span>
<span class="line-added">2984 }</span>
<span class="line-added">2985 </span>
2986 } // namespace JSC
<a name="451" id="anc451"></a><span class="line-added">2987 </span>
<span class="line-added">2988 IGNORE_WARNINGS_END</span>
<a name="452" id="anc452"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="452" type="hidden" />
</body>
</html>