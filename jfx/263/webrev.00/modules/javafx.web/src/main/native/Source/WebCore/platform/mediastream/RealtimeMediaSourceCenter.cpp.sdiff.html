<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/platform/mediastream/RealtimeMediaSourceCenter.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="RealtimeMediaSource.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RealtimeMediaSourceCenter.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/mediastream/RealtimeMediaSourceCenter.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 35 
 36 #if ENABLE(MEDIA_STREAM)
 37 
 38 #include &quot;CaptureDeviceManager.h&quot;
 39 #include &quot;Logging.h&quot;
 40 #include &quot;MediaStreamPrivate.h&quot;
 41 #include &quot;RuntimeEnabledFeatures.h&quot;
 42 #include &lt;wtf/SHA1.h&gt;
 43 
 44 namespace WebCore {
 45 
 46 RealtimeMediaSourceCenter&amp; RealtimeMediaSourceCenter::singleton()
 47 {
 48     ASSERT(isMainThread());
 49     static NeverDestroyed&lt;RealtimeMediaSourceCenter&gt; center;
 50     return center;
 51 }
 52 
 53 RealtimeMediaSourceCenter::RealtimeMediaSourceCenter()
 54 {

 55     m_supportedConstraints.setSupportsWidth(true);
 56     m_supportedConstraints.setSupportsHeight(true);
 57     m_supportedConstraints.setSupportsAspectRatio(true);
 58     m_supportedConstraints.setSupportsFrameRate(true);
 59     m_supportedConstraints.setSupportsFacingMode(true);
 60     m_supportedConstraints.setSupportsVolume(true);
 61     m_supportedConstraints.setSupportsDeviceId(true);
 62 }
 63 
 64 RealtimeMediaSourceCenter::~RealtimeMediaSourceCenter() = default;
 65 
 66 void RealtimeMediaSourceCenter::createMediaStream(Ref&lt;const Logger&gt;&amp;&amp; logger, NewMediaStreamHandler&amp;&amp; completionHandler, String&amp;&amp; hashSalt, CaptureDevice&amp;&amp; audioDevice, CaptureDevice&amp;&amp; videoDevice, const MediaStreamRequest&amp; request)
 67 {
 68     Vector&lt;Ref&lt;RealtimeMediaSource&gt;&gt; audioSources;
 69     Vector&lt;Ref&lt;RealtimeMediaSource&gt;&gt; videoSources;
 70     String invalidConstraint;
 71 
 72     if (audioDevice) {
 73         auto audioSource = audioCaptureFactory().createAudioCaptureSource(WTFMove(audioDevice), String { hashSalt }, &amp;request.audioConstraints);
 74         if (audioSource)
 75             audioSources.append(audioSource.source());
 76         else {
 77 #if !LOG_DISABLED
 78             if (!audioSource.errorMessage.isEmpty())
 79                 LOG(Media, &quot;RealtimeMediaSourceCenter::createMediaStream(%p), audio constraints failed to apply: %s&quot;, this, audioSource.errorMessage.utf8().data());
 80 #endif
<span class="line-modified"> 81             completionHandler(nullptr);</span>
 82             return;
 83         }
 84     }
 85 
 86     if (videoDevice) {
 87         CaptureSourceOrError videoSource;
 88         if (videoDevice.type() == CaptureDevice::DeviceType::Camera)
 89             videoSource = videoCaptureFactory().createVideoCaptureSource(WTFMove(videoDevice), WTFMove(hashSalt), &amp;request.videoConstraints);
 90         else
 91             videoSource = displayCaptureFactory().createDisplayCaptureSource(WTFMove(videoDevice), &amp;request.videoConstraints);
 92 
 93         if (videoSource)
 94             videoSources.append(videoSource.source());
 95         else {
 96 #if !LOG_DISABLED
 97             if (!videoSource.errorMessage.isEmpty())
 98                 LOG(Media, &quot;RealtimeMediaSourceCenter::createMediaStream(%p), video constraints failed to apply: %s&quot;, this, videoSource.errorMessage.utf8().data());
 99 #endif
<span class="line-modified">100             completionHandler(nullptr);</span>
101             return;
102         }
103     }
104 
105     completionHandler(MediaStreamPrivate::create(WTFMove(logger), audioSources, videoSources));
106 }
107 
108 Vector&lt;CaptureDevice&gt; RealtimeMediaSourceCenter::getMediaStreamDevices()
109 {
110     Vector&lt;CaptureDevice&gt; result;
111     for (auto&amp; device : audioCaptureFactory().audioCaptureDeviceManager().captureDevices()) {
112         if (device.enabled())
113             result.append(device);
114     }
115     for (auto&amp; device : videoCaptureFactory().videoCaptureDeviceManager().captureDevices()) {
116         if (device.enabled())
117             result.append(device);
118     }
119     for (auto&amp; device : displayCaptureFactory().displayCaptureDeviceManager().captureDevices()) {
120         if (device.enabled())
</pre>
</td>
<td>
<hr />
<pre>
 35 
 36 #if ENABLE(MEDIA_STREAM)
 37 
 38 #include &quot;CaptureDeviceManager.h&quot;
 39 #include &quot;Logging.h&quot;
 40 #include &quot;MediaStreamPrivate.h&quot;
 41 #include &quot;RuntimeEnabledFeatures.h&quot;
 42 #include &lt;wtf/SHA1.h&gt;
 43 
 44 namespace WebCore {
 45 
 46 RealtimeMediaSourceCenter&amp; RealtimeMediaSourceCenter::singleton()
 47 {
 48     ASSERT(isMainThread());
 49     static NeverDestroyed&lt;RealtimeMediaSourceCenter&gt; center;
 50     return center;
 51 }
 52 
 53 RealtimeMediaSourceCenter::RealtimeMediaSourceCenter()
 54 {
<span class="line-added"> 55     m_supportedConstraints.setSupportsEchoCancellation(true);</span>
 56     m_supportedConstraints.setSupportsWidth(true);
 57     m_supportedConstraints.setSupportsHeight(true);
 58     m_supportedConstraints.setSupportsAspectRatio(true);
 59     m_supportedConstraints.setSupportsFrameRate(true);
 60     m_supportedConstraints.setSupportsFacingMode(true);
 61     m_supportedConstraints.setSupportsVolume(true);
 62     m_supportedConstraints.setSupportsDeviceId(true);
 63 }
 64 
 65 RealtimeMediaSourceCenter::~RealtimeMediaSourceCenter() = default;
 66 
 67 void RealtimeMediaSourceCenter::createMediaStream(Ref&lt;const Logger&gt;&amp;&amp; logger, NewMediaStreamHandler&amp;&amp; completionHandler, String&amp;&amp; hashSalt, CaptureDevice&amp;&amp; audioDevice, CaptureDevice&amp;&amp; videoDevice, const MediaStreamRequest&amp; request)
 68 {
 69     Vector&lt;Ref&lt;RealtimeMediaSource&gt;&gt; audioSources;
 70     Vector&lt;Ref&lt;RealtimeMediaSource&gt;&gt; videoSources;
 71     String invalidConstraint;
 72 
 73     if (audioDevice) {
 74         auto audioSource = audioCaptureFactory().createAudioCaptureSource(WTFMove(audioDevice), String { hashSalt }, &amp;request.audioConstraints);
 75         if (audioSource)
 76             audioSources.append(audioSource.source());
 77         else {
 78 #if !LOG_DISABLED
 79             if (!audioSource.errorMessage.isEmpty())
 80                 LOG(Media, &quot;RealtimeMediaSourceCenter::createMediaStream(%p), audio constraints failed to apply: %s&quot;, this, audioSource.errorMessage.utf8().data());
 81 #endif
<span class="line-modified"> 82             completionHandler(makeUnexpected(makeString(&quot;Failed to create MediaStream audio source: &quot;, audioSource.errorMessage)));</span>
 83             return;
 84         }
 85     }
 86 
 87     if (videoDevice) {
 88         CaptureSourceOrError videoSource;
 89         if (videoDevice.type() == CaptureDevice::DeviceType::Camera)
 90             videoSource = videoCaptureFactory().createVideoCaptureSource(WTFMove(videoDevice), WTFMove(hashSalt), &amp;request.videoConstraints);
 91         else
 92             videoSource = displayCaptureFactory().createDisplayCaptureSource(WTFMove(videoDevice), &amp;request.videoConstraints);
 93 
 94         if (videoSource)
 95             videoSources.append(videoSource.source());
 96         else {
 97 #if !LOG_DISABLED
 98             if (!videoSource.errorMessage.isEmpty())
 99                 LOG(Media, &quot;RealtimeMediaSourceCenter::createMediaStream(%p), video constraints failed to apply: %s&quot;, this, videoSource.errorMessage.utf8().data());
100 #endif
<span class="line-modified">101             completionHandler(makeUnexpected(makeString(&quot;Failed to create MediaStream video source: &quot;, videoSource.errorMessage)));</span>
102             return;
103         }
104     }
105 
106     completionHandler(MediaStreamPrivate::create(WTFMove(logger), audioSources, videoSources));
107 }
108 
109 Vector&lt;CaptureDevice&gt; RealtimeMediaSourceCenter::getMediaStreamDevices()
110 {
111     Vector&lt;CaptureDevice&gt; result;
112     for (auto&amp; device : audioCaptureFactory().audioCaptureDeviceManager().captureDevices()) {
113         if (device.enabled())
114             result.append(device);
115     }
116     for (auto&amp; device : videoCaptureFactory().videoCaptureDeviceManager().captureDevices()) {
117         if (device.enabled())
118             result.append(device);
119     }
120     for (auto&amp; device : displayCaptureFactory().displayCaptureDeviceManager().captureDevices()) {
121         if (device.enabled())
</pre>
</td>
</tr>
</table>
<center><a href="RealtimeMediaSource.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RealtimeMediaSourceCenter.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>