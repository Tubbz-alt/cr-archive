<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/dom/DataTransfer.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DOMImplementation.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DataTransfer.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/dom/DataTransfer.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 66,13 ***</span>
      DataTransfer* m_dataTransfer;
  };
  
  #endif
  
<span class="line-modified">! DataTransfer::DataTransfer(const Document&amp; document, StoreMode mode, std::unique_ptr&lt;Pasteboard&gt; pasteboard, Type type)</span>
<span class="line-modified">!     : m_sessionID(document.sessionID())</span>
<span class="line-removed">-     , m_storeMode(mode)</span>
      , m_pasteboard(WTFMove(pasteboard))
  #if ENABLE(DRAG_SUPPORT)
      , m_type(type)
      , m_dropEffect(&quot;uninitialized&quot;_s)
      , m_effectAllowed(&quot;uninitialized&quot;_s)
<span class="line-new-header">--- 66,12 ---</span>
      DataTransfer* m_dataTransfer;
  };
  
  #endif
  
<span class="line-modified">! DataTransfer::DataTransfer(StoreMode mode, std::unique_ptr&lt;Pasteboard&gt; pasteboard, Type type)</span>
<span class="line-modified">!     : m_storeMode(mode)</span>
      , m_pasteboard(WTFMove(pasteboard))
  #if ENABLE(DRAG_SUPPORT)
      , m_type(type)
      , m_dropEffect(&quot;uninitialized&quot;_s)
      , m_effectAllowed(&quot;uninitialized&quot;_s)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 84,11 ***</span>
  #endif
  }
  
  Ref&lt;DataTransfer&gt; DataTransfer::createForCopyAndPaste(const Document&amp; document, StoreMode storeMode, std::unique_ptr&lt;Pasteboard&gt;&amp;&amp; pasteboard)
  {
<span class="line-modified">!     auto dataTransfer = adoptRef(*new DataTransfer(document, storeMode, WTFMove(pasteboard)));</span>
      dataTransfer-&gt;m_originIdentifier = document.originIdentifierForPasteboard();
      return dataTransfer;
  }
  
  DataTransfer::~DataTransfer()
<span class="line-new-header">--- 83,11 ---</span>
  #endif
  }
  
  Ref&lt;DataTransfer&gt; DataTransfer::createForCopyAndPaste(const Document&amp; document, StoreMode storeMode, std::unique_ptr&lt;Pasteboard&gt;&amp;&amp; pasteboard)
  {
<span class="line-modified">!     auto dataTransfer = adoptRef(*new DataTransfer(storeMode, WTFMove(pasteboard)));</span>
      dataTransfer-&gt;m_originIdentifier = document.originIdentifierForPasteboard();
      return dataTransfer;
  }
  
  DataTransfer::~DataTransfer()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 347,11 ***</span>
  Vector&lt;Ref&lt;File&gt;&gt; DataTransfer::filesFromPasteboardAndItemList() const
  {
      bool addedFilesFromPasteboard = false;
      Vector&lt;Ref&lt;File&gt;&gt; files;
      if ((!forDrag() || forFileDrag()) &amp;&amp; m_pasteboard-&gt;fileContentState() != Pasteboard::FileContentState::NoFileOrImageData) {
<span class="line-modified">!         WebCorePasteboardFileReader reader { m_sessionID };</span>
          m_pasteboard-&gt;read(reader);
          files = WTFMove(reader.files);
          addedFilesFromPasteboard = !files.isEmpty();
      }
  
<span class="line-new-header">--- 346,11 ---</span>
  Vector&lt;Ref&lt;File&gt;&gt; DataTransfer::filesFromPasteboardAndItemList() const
  {
      bool addedFilesFromPasteboard = false;
      Vector&lt;Ref&lt;File&gt;&gt; files;
      if ((!forDrag() || forFileDrag()) &amp;&amp; m_pasteboard-&gt;fileContentState() != Pasteboard::FileContentState::NoFileOrImageData) {
<span class="line-modified">!         WebCorePasteboardFileReader reader;</span>
          m_pasteboard-&gt;read(reader);
          files = WTFMove(reader.files);
          addedFilesFromPasteboard = !files.isEmpty();
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 412,32 ***</span>
      ASSERT_WITH_SECURITY_IMPLICATION(canReadTypes());
  
      return !type.isNull() &amp;&amp; types().contains(type);
  }
  
<span class="line-modified">! Ref&lt;DataTransfer&gt; DataTransfer::createForInputEvent(const Document&amp; document, const String&amp; plainText, const String&amp; htmlText)</span>
  {
      auto pasteboard = makeUnique&lt;StaticPasteboard&gt;();
      pasteboard-&gt;writeString(&quot;text/plain&quot;_s, plainText);
      pasteboard-&gt;writeString(&quot;text/html&quot;_s, htmlText);
<span class="line-modified">!     return adoptRef(*new DataTransfer(document, StoreMode::Readonly, WTFMove(pasteboard), Type::InputEvent));</span>
  }
  
  void DataTransfer::commitToPasteboard(Pasteboard&amp; nativePasteboard)
  {
      ASSERT(is&lt;StaticPasteboard&gt;(*m_pasteboard) &amp;&amp; !is&lt;StaticPasteboard&gt;(nativePasteboard));
      PasteboardCustomData customData = downcast&lt;StaticPasteboard&gt;(*m_pasteboard).takeCustomData();
      if (RuntimeEnabledFeatures::sharedFeatures().customPasteboardDataEnabled()) {
<span class="line-modified">!         customData.origin = m_originIdentifier;</span>
<span class="line-modified">!         nativePasteboard.writeCustomData(customData);</span>
          return;
      }
  
<span class="line-modified">!     for (auto&amp; entry : customData.platformData)</span>
<span class="line-modified">!         nativePasteboard.writeString(entry.key, entry.value);</span>
<span class="line-modified">!     for (auto&amp; entry : customData.sameOriginCustomData)</span>
<span class="line-modified">!         nativePasteboard.writeString(entry.key, entry.value);</span>
  }
  
  #if !ENABLE(DRAG_SUPPORT)
  
  String DataTransfer::dropEffect() const
<span class="line-new-header">--- 411,38 ---</span>
      ASSERT_WITH_SECURITY_IMPLICATION(canReadTypes());
  
      return !type.isNull() &amp;&amp; types().contains(type);
  }
  
<span class="line-modified">! Ref&lt;DataTransfer&gt; DataTransfer::createForInputEvent(const String&amp; plainText, const String&amp; htmlText)</span>
  {
      auto pasteboard = makeUnique&lt;StaticPasteboard&gt;();
      pasteboard-&gt;writeString(&quot;text/plain&quot;_s, plainText);
      pasteboard-&gt;writeString(&quot;text/html&quot;_s, htmlText);
<span class="line-modified">!     return adoptRef(*new DataTransfer(StoreMode::Readonly, WTFMove(pasteboard), Type::InputEvent));</span>
  }
  
  void DataTransfer::commitToPasteboard(Pasteboard&amp; nativePasteboard)
  {
      ASSERT(is&lt;StaticPasteboard&gt;(*m_pasteboard) &amp;&amp; !is&lt;StaticPasteboard&gt;(nativePasteboard));
      PasteboardCustomData customData = downcast&lt;StaticPasteboard&gt;(*m_pasteboard).takeCustomData();
<span class="line-added">+     if (!customData.hasData())</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
      if (RuntimeEnabledFeatures::sharedFeatures().customPasteboardDataEnabled()) {
<span class="line-modified">!         customData.setOrigin(m_originIdentifier);</span>
<span class="line-modified">!         nativePasteboard.writeCustomData({ customData });</span>
          return;
      }
  
<span class="line-modified">!     customData.forEachPlatformString([&amp;] (auto&amp; type, auto&amp; string) {</span>
<span class="line-modified">!         nativePasteboard.writeString(type, string);</span>
<span class="line-modified">!     });</span>
<span class="line-modified">! </span>
<span class="line-added">+     customData.forEachCustomString([&amp;] (auto&amp; type, auto&amp; string) {</span>
<span class="line-added">+         nativePasteboard.writeString(type, string);</span>
<span class="line-added">+     });</span>
  }
  
  #if !ENABLE(DRAG_SUPPORT)
  
  String DataTransfer::dropEffect() const
</pre>
<hr />
<pre>
<span class="line-old-header">*** 462,33 ***</span>
  {
  }
  
  #else
  
<span class="line-modified">! Ref&lt;DataTransfer&gt; DataTransfer::createForDrag(const Document&amp; document)</span>
  {
<span class="line-modified">!     return adoptRef(*new DataTransfer(document, StoreMode::ReadWrite, Pasteboard::createForDragAndDrop(), Type::DragAndDropData));</span>
  }
  
  Ref&lt;DataTransfer&gt; DataTransfer::createForDragStartEvent(const Document&amp; document)
  {
<span class="line-modified">!     auto dataTransfer = adoptRef(*new DataTransfer(document, StoreMode::ReadWrite, makeUnique&lt;StaticPasteboard&gt;(), Type::DragAndDropData));</span>
      dataTransfer-&gt;m_originIdentifier = document.originIdentifierForPasteboard();
      return dataTransfer;
  }
  
  Ref&lt;DataTransfer&gt; DataTransfer::createForDrop(const Document&amp; document, std::unique_ptr&lt;Pasteboard&gt;&amp;&amp; pasteboard, DragOperation sourceOperation, bool draggingFiles)
  {
<span class="line-modified">!     auto dataTransfer = adoptRef(*new DataTransfer(document, DataTransfer::StoreMode::Readonly, WTFMove(pasteboard), draggingFiles ? Type::DragAndDropFiles : Type::DragAndDropData));</span>
      dataTransfer-&gt;setSourceOperation(sourceOperation);
      dataTransfer-&gt;m_originIdentifier = document.originIdentifierForPasteboard();
      return dataTransfer;
  }
  
  Ref&lt;DataTransfer&gt; DataTransfer::createForUpdatingDropTarget(const Document&amp; document, std::unique_ptr&lt;Pasteboard&gt;&amp;&amp; pasteboard, DragOperation sourceOperation, bool draggingFiles)
  {
<span class="line-modified">!     auto dataTransfer = adoptRef(*new DataTransfer(document, DataTransfer::StoreMode::Protected, WTFMove(pasteboard), draggingFiles ? Type::DragAndDropFiles : Type::DragAndDropData));</span>
      dataTransfer-&gt;setSourceOperation(sourceOperation);
      dataTransfer-&gt;m_originIdentifier = document.originIdentifierForPasteboard();
      return dataTransfer;
  }
  
<span class="line-new-header">--- 467,33 ---</span>
  {
  }
  
  #else
  
<span class="line-modified">! Ref&lt;DataTransfer&gt; DataTransfer::createForDrag()</span>
  {
<span class="line-modified">!     return adoptRef(*new DataTransfer(StoreMode::ReadWrite, Pasteboard::createForDragAndDrop(), Type::DragAndDropData));</span>
  }
  
  Ref&lt;DataTransfer&gt; DataTransfer::createForDragStartEvent(const Document&amp; document)
  {
<span class="line-modified">!     auto dataTransfer = adoptRef(*new DataTransfer(StoreMode::ReadWrite, makeUnique&lt;StaticPasteboard&gt;(), Type::DragAndDropData));</span>
      dataTransfer-&gt;m_originIdentifier = document.originIdentifierForPasteboard();
      return dataTransfer;
  }
  
  Ref&lt;DataTransfer&gt; DataTransfer::createForDrop(const Document&amp; document, std::unique_ptr&lt;Pasteboard&gt;&amp;&amp; pasteboard, DragOperation sourceOperation, bool draggingFiles)
  {
<span class="line-modified">!     auto dataTransfer = adoptRef(*new DataTransfer(DataTransfer::StoreMode::Readonly, WTFMove(pasteboard), draggingFiles ? Type::DragAndDropFiles : Type::DragAndDropData));</span>
      dataTransfer-&gt;setSourceOperation(sourceOperation);
      dataTransfer-&gt;m_originIdentifier = document.originIdentifierForPasteboard();
      return dataTransfer;
  }
  
  Ref&lt;DataTransfer&gt; DataTransfer::createForUpdatingDropTarget(const Document&amp; document, std::unique_ptr&lt;Pasteboard&gt;&amp;&amp; pasteboard, DragOperation sourceOperation, bool draggingFiles)
  {
<span class="line-modified">!     auto dataTransfer = adoptRef(*new DataTransfer(DataTransfer::StoreMode::Protected, WTFMove(pasteboard), draggingFiles ? Type::DragAndDropFiles : Type::DragAndDropData));</span>
      dataTransfer-&gt;setSourceOperation(sourceOperation);
      dataTransfer-&gt;m_originIdentifier = document.originIdentifierForPasteboard();
      return dataTransfer;
  }
  
</pre>
<center><a href="DOMImplementation.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DataTransfer.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>