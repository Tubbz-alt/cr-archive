<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WTF/wtf/cocoa/MainThreadCocoa.mm</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MachSendRight.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="MemoryFootprintCocoa.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/wtf/cocoa/MainThreadCocoa.mm</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 54,53 ***</span>
      WTF::dispatchFunctionsFromMainThread();
  }
  
  @end
  
  namespace WTF {
  
  static JSWTFMainThreadCaller* staticMainThreadCaller;
  static bool isTimerPosted; // This is only accessed on the main thread.
<span class="line-modified">! static bool mainThreadEstablishedAsPthreadMain { false };</span>
  static pthread_t mainThreadPthread { nullptr };
  static NSThread* mainThreadNSThread { nullptr };
  
<span class="line-removed">- #if USE(WEB_THREAD)</span>
  static Thread* sApplicationUIThread;
  static Thread* sWebThread;
  #endif
  
  void initializeMainThreadPlatform()
<span class="line-removed">- {</span>
<span class="line-removed">-     ASSERT(!staticMainThreadCaller);</span>
<span class="line-removed">-     staticMainThreadCaller = [[JSWTFMainThreadCaller alloc] init];</span>
<span class="line-removed">- </span>
<span class="line-removed">- #if !USE(WEB_THREAD)</span>
<span class="line-removed">-     mainThreadEstablishedAsPthreadMain = false;</span>
<span class="line-removed">-     mainThreadPthread = pthread_self();</span>
<span class="line-removed">-     mainThreadNSThread = [NSThread currentThread];</span>
<span class="line-removed">- #else</span>
<span class="line-removed">-     mainThreadEstablishedAsPthreadMain = true;</span>
<span class="line-removed">-     ASSERT(!mainThreadPthread);</span>
<span class="line-removed">-     ASSERT(!mainThreadNSThread);</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- #if !USE(WEB_THREAD)</span>
<span class="line-removed">- void initializeMainThreadToProcessMainThreadPlatform()</span>
  {
      if (!pthread_main_np())
<span class="line-modified">!         NSLog(@&quot;WebKit Threading Violation - initial use of WebKit from a secondary thread.&quot;);</span>
  
      ASSERT(!staticMainThreadCaller);
      staticMainThreadCaller = [[JSWTFMainThreadCaller alloc] init];
<span class="line-removed">- </span>
<span class="line-removed">-     mainThreadEstablishedAsPthreadMain = true;</span>
<span class="line-removed">-     mainThreadPthread = 0;</span>
<span class="line-removed">-     mainThreadNSThread = nil;</span>
  }
<span class="line-removed">- #endif // !USE(WEB_THREAD)</span>
  
  static void timerFired(CFRunLoopTimerRef timer, void*)
  {
      CFRelease(timer);
      isTimerPosted = false;
<span class="line-new-header">--- 54,42 ---</span>
      WTF::dispatchFunctionsFromMainThread();
  }
  
  @end
  
<span class="line-added">+ #define LOG_CHANNEL_PREFIX Log</span>
<span class="line-added">+ </span>
  namespace WTF {
  
<span class="line-added">+ #if RELEASE_LOG_DISABLED</span>
<span class="line-added">+ WTFLogChannel LogThreading = { WTFLogChannelState::On, &quot;Threading&quot;, WTFLogLevel::Error };</span>
<span class="line-added">+ #else</span>
<span class="line-added">+ WTFLogChannel LogThreading = { WTFLogChannelState::On, &quot;Threading&quot;, WTFLogLevel::Error, LOG_CHANNEL_WEBKIT_SUBSYSTEM, OS_LOG_DEFAULT };</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
  static JSWTFMainThreadCaller* staticMainThreadCaller;
  static bool isTimerPosted; // This is only accessed on the main thread.
<span class="line-modified">! </span>
<span class="line-added">+ #if USE(WEB_THREAD)</span>
<span class="line-added">+ // When the Web thread is enabled, we consider it to be the main thread, not pthread main.</span>
  static pthread_t mainThreadPthread { nullptr };
  static NSThread* mainThreadNSThread { nullptr };
  
  static Thread* sApplicationUIThread;
  static Thread* sWebThread;
  #endif
  
  void initializeMainThreadPlatform()
  {
      if (!pthread_main_np())
<span class="line-modified">!         RELEASE_LOG_FAULT(Threading, &quot;WebKit Threading Violation - initial use of WebKit from a secondary thread.&quot;);</span>
<span class="line-added">+     ASSERT(pthread_main_np());</span>
  
      ASSERT(!staticMainThreadCaller);
      staticMainThreadCaller = [[JSWTFMainThreadCaller alloc] init];
  }
  
  static void timerFired(CFRunLoopTimerRef timer, void*)
  {
      CFRelease(timer);
      isTimerPosted = false;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 123,23 ***</span>
  
  void scheduleDispatchFunctionsOnMainThread()
  {
      ASSERT(staticMainThreadCaller);
  
      if (isWebThread()) {
          postTimer();
          return;
      }
<span class="line-modified">!     </span>
<span class="line-modified">!     if (mainThreadEstablishedAsPthreadMain) {</span>
<span class="line-modified">!         ASSERT(!mainThreadNSThread);</span>
<span class="line-modified">!         [staticMainThreadCaller performSelectorOnMainThread:@selector(call) withObject:nil waitUntilDone:NO];</span>
          return;
      }
  
<span class="line-modified">!     ASSERT(mainThreadNSThread);</span>
<span class="line-removed">-     [staticMainThreadCaller performSelector:@selector(call) onThread:mainThreadNSThread withObject:nil waitUntilDone:NO];</span>
  }
  
  void dispatchAsyncOnMainThreadWithWebThreadLockIfNeeded(void (^block)())
  {
  #if USE(WEB_THREAD)
<span class="line-new-header">--- 112,28 ---</span>
  
  void scheduleDispatchFunctionsOnMainThread()
  {
      ASSERT(staticMainThreadCaller);
  
<span class="line-added">+ #if USE(WEB_THREAD)</span>
      if (isWebThread()) {
          postTimer();
          return;
      }
<span class="line-modified">! </span>
<span class="line-modified">!     if (mainThreadPthread) {</span>
<span class="line-modified">!         [staticMainThreadCaller performSelector:@selector(call) onThread:mainThreadNSThread withObject:nil waitUntilDone:NO];</span>
<span class="line-modified">!         return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     if (isMainThread()) {</span>
<span class="line-added">+         postTimer();</span>
          return;
      }
<span class="line-added">+ #endif</span>
  
<span class="line-modified">!     [staticMainThreadCaller performSelectorOnMainThread:@selector(call) withObject:nil waitUntilDone:NO];</span>
  }
  
  void dispatchAsyncOnMainThreadWithWebThreadLockIfNeeded(void (^block)())
  {
  #if USE(WEB_THREAD)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 164,30 ***</span>
  #endif
      dispatch_async(dispatch_get_main_queue(), block);
  }
  
  #if USE(WEB_THREAD)
  static bool webThreadIsUninitializedOrLockedOrDisabled()
  {
      return !WebCoreWebThreadIsLockedOrDisabled || WebCoreWebThreadIsLockedOrDisabled();
  }
  
  bool isMainThread()
  {
      return (isWebThread() || pthread_main_np()) &amp;&amp; webThreadIsUninitializedOrLockedOrDisabled();
  }
  
<span class="line-removed">- bool isMainThreadIfInitialized()</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     return isMainThread();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- bool isMainThreadInitialized()</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     return true;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  bool isUIThread()
  {
      return pthread_main_np();
  }
  
<span class="line-new-header">--- 158,21 ---</span>
  #endif
      dispatch_async(dispatch_get_main_queue(), block);
  }
  
  #if USE(WEB_THREAD)
<span class="line-added">+ </span>
  static bool webThreadIsUninitializedOrLockedOrDisabled()
  {
      return !WebCoreWebThreadIsLockedOrDisabled || WebCoreWebThreadIsLockedOrDisabled();
  }
  
  bool isMainThread()
  {
      return (isWebThread() || pthread_main_np()) &amp;&amp; webThreadIsUninitializedOrLockedOrDisabled();
  }
  
  bool isUIThread()
  {
      return pthread_main_np();
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 201,54 ***</span>
  {
      ASSERT(pthread_main_np());
      sApplicationUIThread = &amp;Thread::current();
  }
  
<span class="line-modified">! void initializeWebThreadPlatform()</span>
  {
<span class="line-modified">!     ASSERT(!pthread_main_np());</span>
<span class="line-modified">! </span>
<span class="line-modified">!     mainThreadEstablishedAsPthreadMain = false;</span>
<span class="line-modified">!     mainThreadPthread = pthread_self();</span>
<span class="line-modified">!     mainThreadNSThread = [NSThread currentThread];</span>
<span class="line-modified">! </span>
<span class="line-modified">!     sWebThread = &amp;Thread::current();</span>
  }
  
<span class="line-modified">! bool canAccessThreadLocalDataForThread(Thread&amp; thread)</span>
  {
      Thread&amp; currentThread = Thread::current();
      if (&amp;thread == &amp;currentThread)
          return true;
  
      if (&amp;thread == sWebThread || &amp;thread == sApplicationUIThread)
          return (&amp;currentThread == sWebThread || &amp;currentThread == sApplicationUIThread) &amp;&amp; webThreadIsUninitializedOrLockedOrDisabled();
  
      return false;
  }
<span class="line-removed">- #else</span>
<span class="line-removed">- bool isMainThread()</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     if (mainThreadEstablishedAsPthreadMain) {</span>
<span class="line-removed">-         ASSERT(!mainThreadPthread);</span>
<span class="line-removed">-         return pthread_main_np();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     ASSERT(mainThreadPthread);</span>
<span class="line-removed">-     return pthread_equal(pthread_self(), mainThreadPthread);</span>
<span class="line-removed">- }</span>
  
<span class="line-modified">! bool isMainThreadIfInitialized()</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     if (mainThreadEstablishedAsPthreadMain)</span>
<span class="line-removed">-         return pthread_main_np();</span>
<span class="line-removed">-     return pthread_equal(pthread_self(), mainThreadPthread);</span>
<span class="line-removed">- }</span>
  
<span class="line-modified">! bool isMainThreadInitialized()</span>
  {
<span class="line-modified">!     return mainThreadEstablishedAsPthreadMain || mainThreadPthread;</span>
  }
  
  #endif // USE(WEB_THREAD)
  
  } // namespace WTF
<span class="line-new-header">--- 186,38 ---</span>
  {
      ASSERT(pthread_main_np());
      sApplicationUIThread = &amp;Thread::current();
  }
  
<span class="line-modified">! void initializeWebThread()</span>
  {
<span class="line-modified">!     static std::once_flag initializeKey;</span>
<span class="line-modified">!     std::call_once(initializeKey, [] {</span>
<span class="line-modified">!         ASSERT(!pthread_main_np());</span>
<span class="line-modified">!         mainThreadPthread = pthread_self();</span>
<span class="line-modified">!         mainThreadNSThread = [NSThread currentThread];</span>
<span class="line-modified">!         sWebThread = &amp;Thread::current();</span>
<span class="line-modified">!     });</span>
  }
  
<span class="line-modified">! bool canCurrentThreadAccessThreadLocalData(Thread&amp; thread)</span>
  {
      Thread&amp; currentThread = Thread::current();
      if (&amp;thread == &amp;currentThread)
          return true;
  
      if (&amp;thread == sWebThread || &amp;thread == sApplicationUIThread)
          return (&amp;currentThread == sWebThread || &amp;currentThread == sApplicationUIThread) &amp;&amp; webThreadIsUninitializedOrLockedOrDisabled();
  
      return false;
  }
  
<span class="line-modified">! #else</span>
  
<span class="line-modified">! bool isMainThread()</span>
  {
<span class="line-modified">!     return pthread_main_np();</span>
  }
  
  #endif // USE(WEB_THREAD)
  
  } // namespace WTF
</pre>
<center><a href="MachSendRight.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="MemoryFootprintCocoa.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>