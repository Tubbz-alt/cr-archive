<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/libwebrtc/LibWebRTCPeerConnectionBackend.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="LibWebRTCObservers.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="LibWebRTCPeerConnectionBackend.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/libwebrtc/LibWebRTCPeerConnectionBackend.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -43,11 +43,10 @@</span>
  #include &quot;RTCSessionDescription.h&quot;
  #include &quot;RealtimeIncomingAudioSource.h&quot;
  #include &quot;RealtimeIncomingVideoSource.h&quot;
  #include &quot;RealtimeOutgoingAudioSource.h&quot;
  #include &quot;RealtimeOutgoingVideoSource.h&quot;
<span class="udiff-line-removed">- #include &quot;RuntimeEnabledFeatures.h&quot;</span>
  #include &quot;Settings.h&quot;
  
  namespace WebCore {
  
  static std::unique_ptr&lt;PeerConnectionBackend&gt; createLibWebRTCPeerConnectionBackend(RTCPeerConnection&amp; peerConnection)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -88,10 +87,20 @@</span>
  {
  }
  
  LibWebRTCPeerConnectionBackend::~LibWebRTCPeerConnectionBackend() = default;
  
<span class="udiff-line-added">+ void LibWebRTCPeerConnectionBackend::suspend()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_endpoint-&gt;suspend();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void LibWebRTCPeerConnectionBackend::resume()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_endpoint-&gt;resume();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  static inline webrtc::PeerConnectionInterface::BundlePolicy bundlePolicyfromConfiguration(const MediaEndpointConfiguration&amp; configuration)
  {
      switch (configuration.bundlePolicy) {
      case RTCBundlePolicy::MaxCompat:
          return webrtc::PeerConnectionInterface::kBundlePolicyMaxCompat;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -240,10 +249,15 @@</span>
          return;
      }
      m_endpoint-&gt;doCreateAnswer();
  }
  
<span class="udiff-line-added">+ void LibWebRTCPeerConnectionBackend::close()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_endpoint-&gt;close();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void LibWebRTCPeerConnectionBackend::doStop()
  {
      m_endpoint-&gt;stop();
      m_pendingReceivers.clear();
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -397,66 +411,32 @@</span>
      return nullptr;
  }
  
  ExceptionOr&lt;Ref&lt;RTCRtpSender&gt;&gt; LibWebRTCPeerConnectionBackend::addTrack(MediaStreamTrack&amp; track, Vector&lt;String&gt;&amp;&amp; mediaStreamIds)
  {
<span class="udiff-line-modified-removed">-     if (RuntimeEnabledFeatures::sharedFeatures().webRTCUnifiedPlanEnabled()) {</span>
<span class="udiff-line-modified-removed">-         auto senderBackend = makeUnique&lt;LibWebRTCRtpSenderBackend&gt;(*this, nullptr);</span>
<span class="udiff-line-modified-removed">-         if (!m_endpoint-&gt;addTrack(*senderBackend, track, mediaStreamIds))</span>
<span class="udiff-line-removed">-             return Exception { TypeError, &quot;Unable to add track&quot;_s };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (auto sender = findExistingSender(m_peerConnection.currentTransceivers(), *senderBackend)) {</span>
<span class="udiff-line-removed">-             backendFromRTPSender(*sender).takeSource(*senderBackend);</span>
<span class="udiff-line-removed">-             sender-&gt;setTrack(makeRef(track));</span>
<span class="udiff-line-removed">-             sender-&gt;setMediaStreamIds(WTFMove(mediaStreamIds));</span>
<span class="udiff-line-removed">-             return sender.releaseNonNull();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         auto transceiverBackend = m_endpoint-&gt;transceiverBackendFromSender(*senderBackend);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         auto sender = RTCRtpSender::create(*this, makeRef(track), WTFMove(mediaStreamIds), WTFMove(senderBackend));</span>
<span class="udiff-line-removed">-         auto receiver = createReceiverForSource(createEmptySource(track.kind(), createCanonicalUUIDString()), transceiverBackend-&gt;createReceiverBackend());</span>
<span class="udiff-line-removed">-         auto transceiver = RTCRtpTransceiver::create(sender.copyRef(), WTFMove(receiver), WTFMove(transceiverBackend));</span>
<span class="udiff-line-removed">-         m_peerConnection.addInternalTransceiver(WTFMove(transceiver));</span>
<span class="udiff-line-removed">-         return sender;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     RTCRtpSender* sender = nullptr;</span>
<span class="udiff-line-removed">-     // Reuse an existing sender with the same track kind if it has never been used to send before.</span>
<span class="udiff-line-removed">-     for (auto&amp; transceiver : m_peerConnection.currentTransceivers()) {</span>
<span class="udiff-line-removed">-         auto&amp; existingSender = transceiver-&gt;sender();</span>
<span class="udiff-line-removed">-         if (!existingSender.isStopped() &amp;&amp; existingSender.trackKind() == track.kind() &amp;&amp; existingSender.trackId().isNull() &amp;&amp; !transceiver-&gt;hasSendingDirection()) {</span>
<span class="udiff-line-removed">-             existingSender.setTrack(makeRef(track));</span>
<span class="udiff-line-removed">-             existingSender.setMediaStreamIds(WTFMove(mediaStreamIds));</span>
<span class="udiff-line-removed">-             transceiver-&gt;enableSendingDirection();</span>
<span class="udiff-line-removed">-             sender = &amp;existingSender;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             break;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!sender) {</span>
<span class="udiff-line-removed">-         const String&amp; trackKind = track.kind();</span>
<span class="udiff-line-removed">-         String trackId = createCanonicalUUIDString();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         auto senderBackend = makeUnique&lt;LibWebRTCRtpSenderBackend&gt;(*this, nullptr);</span>
<span class="udiff-line-removed">-         auto newSender = RTCRtpSender::create(*this, makeRef(track), Vector&lt;String&gt; { mediaStreamIds }, WTFMove(senderBackend));</span>
<span class="udiff-line-removed">-         auto receiver = createReceiver(trackKind, trackId);</span>
<span class="udiff-line-removed">-         auto transceiver = RTCRtpTransceiver::create(WTFMove(newSender), WTFMove(receiver), nullptr);</span>
<span class="udiff-line-modified-added">+     auto senderBackend = makeUnique&lt;LibWebRTCRtpSenderBackend&gt;(*this, nullptr);</span>
<span class="udiff-line-modified-added">+     if (!m_endpoint-&gt;addTrack(*senderBackend, track, mediaStreamIds))</span>
<span class="udiff-line-modified-added">+         return Exception { TypeError, &quot;Unable to add track&quot;_s };</span>
  
<span class="udiff-line-modified-removed">-         sender = &amp;transceiver-&gt;sender();</span>
<span class="udiff-line-modified-removed">-         m_peerConnection.addInternalTransceiver(WTFMove(transceiver));</span>
<span class="udiff-line-modified-added">+     if (auto sender = findExistingSender(m_peerConnection.currentTransceivers(), *senderBackend)) {</span>
<span class="udiff-line-modified-added">+         backendFromRTPSender(*sender).takeSource(*senderBackend);</span>
<span class="udiff-line-added">+         sender-&gt;setTrack(makeRef(track));</span>
<span class="udiff-line-added">+         sender-&gt;setMediaStreamIds(WTFMove(mediaStreamIds));</span>
<span class="udiff-line-added">+         return sender.releaseNonNull();</span>
      }
  
<span class="udiff-line-modified-removed">-     if (!m_endpoint-&gt;addTrack(backendFromRTPSender(*sender), track, mediaStreamIds))</span>
<span class="udiff-line-removed">-         return Exception { TypeError, &quot;Unable to add track&quot;_s };</span>
<span class="udiff-line-modified-added">+     auto transceiverBackend = m_endpoint-&gt;transceiverBackendFromSender(*senderBackend);</span>
  
<span class="udiff-line-modified-removed">-     return makeRef(*sender);</span>
<span class="udiff-line-modified-added">+     auto sender = RTCRtpSender::create(*this, makeRef(track), WTFMove(mediaStreamIds), WTFMove(senderBackend));</span>
<span class="udiff-line-added">+     auto receiver = createReceiverForSource(createEmptySource(track.kind(), createCanonicalUUIDString()), transceiverBackend-&gt;createReceiverBackend());</span>
<span class="udiff-line-added">+     auto transceiver = RTCRtpTransceiver::create(sender.copyRef(), WTFMove(receiver), WTFMove(transceiverBackend));</span>
<span class="udiff-line-added">+     m_peerConnection.addInternalTransceiver(WTFMove(transceiver));</span>
<span class="udiff-line-added">+     return sender;</span>
  }
  
  template&lt;typename T&gt;
<span class="udiff-line-modified-removed">- ExceptionOr&lt;Ref&lt;RTCRtpTransceiver&gt;&gt; LibWebRTCPeerConnectionBackend::addUnifiedPlanTransceiver(T&amp;&amp; trackOrKind, const RTCRtpTransceiverInit&amp; init)</span>
<span class="udiff-line-modified-added">+ ExceptionOr&lt;Ref&lt;RTCRtpTransceiver&gt;&gt; LibWebRTCPeerConnectionBackend::addTransceiverFromTrackOrKind(T&amp;&amp; trackOrKind, const RTCRtpTransceiverInit&amp; init)</span>
  {
      auto backends = m_endpoint-&gt;addTransceiver(trackOrKind, init);
      if (!backends)
          return Exception { InvalidAccessError, &quot;Unable to add transceiver&quot;_s };
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -467,30 +447,16 @@</span>
      return transceiver;
  }
  
  ExceptionOr&lt;Ref&lt;RTCRtpTransceiver&gt;&gt; LibWebRTCPeerConnectionBackend::addTransceiver(const String&amp; trackKind, const RTCRtpTransceiverInit&amp; init)
  {
<span class="udiff-line-modified-removed">-     if (RuntimeEnabledFeatures::sharedFeatures().webRTCUnifiedPlanEnabled())</span>
<span class="udiff-line-removed">-         return addUnifiedPlanTransceiver(String { trackKind }, init);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto senderBackend = makeUnique&lt;LibWebRTCRtpSenderBackend&gt;(*this, nullptr);</span>
<span class="udiff-line-removed">-     auto newSender = RTCRtpSender::create(*this, String(trackKind), Vector&lt;String&gt;(), WTFMove(senderBackend));</span>
<span class="udiff-line-removed">-     return completeAddTransceiver(WTFMove(newSender), init, createCanonicalUUIDString(), trackKind);</span>
<span class="udiff-line-modified-added">+     return addTransceiverFromTrackOrKind(String { trackKind }, init);</span>
  }
  
  ExceptionOr&lt;Ref&lt;RTCRtpTransceiver&gt;&gt; LibWebRTCPeerConnectionBackend::addTransceiver(Ref&lt;MediaStreamTrack&gt;&amp;&amp; track, const RTCRtpTransceiverInit&amp; init)
  {
<span class="udiff-line-modified-removed">-     if (RuntimeEnabledFeatures::sharedFeatures().webRTCUnifiedPlanEnabled())</span>
<span class="udiff-line-removed">-         return addUnifiedPlanTransceiver(WTFMove(track), init);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto senderBackend = makeUnique&lt;LibWebRTCRtpSenderBackend&gt;(*this, nullptr);</span>
<span class="udiff-line-removed">-     auto&amp; backend = *senderBackend;</span>
<span class="udiff-line-removed">-     auto sender = RTCRtpSender::create(*this, track.copyRef(), Vector&lt;String&gt;(), WTFMove(senderBackend));</span>
<span class="udiff-line-removed">-     if (!m_endpoint-&gt;addTrack(backend, track, Vector&lt;String&gt; { }))</span>
<span class="udiff-line-removed">-         return Exception { InvalidAccessError, &quot;Unable to add track&quot;_s };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return completeAddTransceiver(WTFMove(sender), init, track-&gt;id(), track-&gt;kind());</span>
<span class="udiff-line-modified-added">+     return addTransceiverFromTrackOrKind(WTFMove(track), init);</span>
  }
  
  void LibWebRTCPeerConnectionBackend::setSenderSourceFromTrack(LibWebRTCRtpSenderBackend&amp; sender, MediaStreamTrack&amp; track)
  {
      m_endpoint-&gt;setSenderSourceFromTrack(sender, track);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -547,28 +513,8 @@</span>
                  videoSource-&gt;setApplyRotation(true);
          }
      }
  }
  
<span class="udiff-line-removed">- bool LibWebRTCPeerConnectionBackend::shouldOfferAllowToReceive(const char* kind) const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     ASSERT(!RuntimeEnabledFeatures::sharedFeatures().webRTCUnifiedPlanEnabled());</span>
<span class="udiff-line-removed">-     for (const auto&amp; transceiver : m_peerConnection.currentTransceivers()) {</span>
<span class="udiff-line-removed">-         if (transceiver-&gt;sender().trackKind() != kind)</span>
<span class="udiff-line-removed">-             continue;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (transceiver-&gt;direction() == RTCRtpTransceiverDirection::Recvonly)</span>
<span class="udiff-line-removed">-             return true;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (transceiver-&gt;direction() != RTCRtpTransceiverDirection::Sendrecv)</span>
<span class="udiff-line-removed">-             continue;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         auto* backend = static_cast&lt;LibWebRTCRtpSenderBackend*&gt;(transceiver-&gt;sender().backend());</span>
<span class="udiff-line-removed">-         if (backend &amp;&amp; !backend-&gt;rtcSender())</span>
<span class="udiff-line-removed">-             return true;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  } // namespace WebCore
  
  #endif // USE(LIBWEBRTC)
</pre>
<center><a href="LibWebRTCObservers.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="LibWebRTCPeerConnectionBackend.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>