<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/client/IDBConnectionProxy.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../IndexedDB.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="IDBConnectionProxy.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/client/IDBConnectionProxy.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 113,10 ***</span>
<span class="line-new-header">--- 113,23 ---</span>
      }
  
      if (!request)
          return;
  
<span class="line-added">+     if (request-&gt;isContextSuspended()) {</span>
<span class="line-added">+         switch (resultData.type()) {</span>
<span class="line-added">+         case IDBResultType::OpenDatabaseUpgradeNeeded: {</span>
<span class="line-added">+             abortOpenAndUpgradeNeeded(resultData.databaseConnectionIdentifier(), resultData.transactionInfo().identifier());</span>
<span class="line-added">+             auto result = IDBResultData::error(resultData.requestIdentifier(), IDBError { UnknownError, &quot;Version change transaction on cached page is aborted to unblock other connections&quot;_s });</span>
<span class="line-added">+             request-&gt;performCallbackOnOriginThread(*request, &amp;IDBOpenDBRequest::requestCompleted, result);</span>
<span class="line-added">+             return;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         default:</span>
<span class="line-added">+             break;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      request-&gt;performCallbackOnOriginThread(*request, &amp;IDBOpenDBRequest::requestCompleted, resultData);
  }
  
  void IDBConnectionProxy::createObjectStore(TransactionOperation&amp; operation, const IDBObjectStoreInfo&amp; info)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 223,11 ***</span>
  }
  
  void IDBConnectionProxy::iterateCursor(TransactionOperation&amp; operation, const IDBIterateCursorData&amp; data)
  {
      const IDBRequestData requestData { operation };
<span class="line-modified">!     saveOperation(operation);</span>
  
      callConnectionOnMainThread(&amp;IDBConnectionToServer::iterateCursor, requestData, data);
  }
  
  void IDBConnectionProxy::saveOperation(TransactionOperation&amp; operation)
<span class="line-new-header">--- 236,12 ---</span>
  }
  
  void IDBConnectionProxy::iterateCursor(TransactionOperation&amp; operation, const IDBIterateCursorData&amp; data)
  {
      const IDBRequestData requestData { operation };
<span class="line-modified">!     if (data.option != IndexedDB::CursorIterateOption::DoNotReply)</span>
<span class="line-added">+         saveOperation(operation);</span>
  
      callConnectionOnMainThread(&amp;IDBConnectionToServer::iterateCursor, requestData, data);
  }
  
  void IDBConnectionProxy::saveOperation(TransactionOperation&amp; operation)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 266,16 ***</span>
      }
  
      if (!database)
          return;
  
      database-&gt;performCallbackOnOriginThread(*database, &amp;IDBDatabase::fireVersionChangeEvent, requestIdentifier, requestedVersion);
  }
  
<span class="line-modified">! void IDBConnectionProxy::didFireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier)</span>
  {
<span class="line-modified">!     callConnectionOnMainThread(&amp;IDBConnectionToServer::didFireVersionChangeEvent, databaseConnectionIdentifier, requestIdentifier);</span>
  }
  
  void IDBConnectionProxy::notifyOpenDBRequestBlocked(const IDBResourceIdentifier&amp; requestIdentifier, uint64_t oldVersion, uint64_t newVersion)
  {
      ASSERT(isMainThread());
<span class="line-new-header">--- 280,22 ---</span>
      }
  
      if (!database)
          return;
  
<span class="line-added">+     if (database-&gt;isContextSuspended()) {</span>
<span class="line-added">+         didFireVersionChangeEvent(databaseConnectionIdentifier, requestIdentifier, IndexedDB::ConnectionClosedOnBehalfOfServer::Yes);</span>
<span class="line-added">+         database-&gt;performCallbackOnOriginThread(*database, &amp;IDBDatabase::connectionToServerLost, IDBError { UnknownError, &quot;Connection on cached page closed to unblock other connections&quot;_s});</span>
<span class="line-added">+         return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      database-&gt;performCallbackOnOriginThread(*database, &amp;IDBDatabase::fireVersionChangeEvent, requestIdentifier, requestedVersion);
  }
  
<span class="line-modified">! void IDBConnectionProxy::didFireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier, IndexedDB::ConnectionClosedOnBehalfOfServer connectionClosed)</span>
  {
<span class="line-modified">!     callConnectionOnMainThread(&amp;IDBConnectionToServer::didFireVersionChangeEvent, databaseConnectionIdentifier, requestIdentifier, connectionClosed);</span>
  }
  
  void IDBConnectionProxy::notifyOpenDBRequestBlocked(const IDBResourceIdentifier&amp; requestIdentifier, uint64_t oldVersion, uint64_t newVersion)
  {
      ASSERT(isMainThread());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 401,25 ***</span>
      {
          Locker&lt;Lock&gt; locker(m_databaseConnectionMapLock);
          database = m_databaseConnectionMap.get(databaseConnectionIdentifier);
      }
  
<span class="line-modified">!     // If the IDBDatabase object is gone, message back to the server so it doesn&#39;t hang</span>
<span class="line-removed">-     // waiting for a reply that will never come.</span>
<span class="line-removed">-     if (!database) {</span>
<span class="line-removed">-         m_connectionToServer.confirmDidCloseFromServer(databaseConnectionIdentifier);</span>
          return;
<span class="line-removed">-     }</span>
  
      database-&gt;performCallbackOnOriginThread(*database, &amp;IDBDatabase::didCloseFromServer, error);
  }
  
<span class="line-removed">- void IDBConnectionProxy::confirmDidCloseFromServer(IDBDatabase&amp; database)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     callConnectionOnMainThread(&amp;IDBConnectionToServer::confirmDidCloseFromServer, database.databaseConnectionIdentifier());</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void IDBConnectionProxy::connectionToServerLost(const IDBError&amp; error)
  {
      Vector&lt;uint64_t&gt; databaseConnectionIdentifiers;
      {
          Locker&lt;Lock&gt; locker(m_databaseConnectionMapLock);
<span class="line-new-header">--- 421,16 ---</span>
      {
          Locker&lt;Lock&gt; locker(m_databaseConnectionMapLock);
          database = m_databaseConnectionMap.get(databaseConnectionIdentifier);
      }
  
<span class="line-modified">!     if (!database)</span>
          return;
  
      database-&gt;performCallbackOnOriginThread(*database, &amp;IDBDatabase::didCloseFromServer, error);
  }
  
  void IDBConnectionProxy::connectionToServerLost(const IDBError&amp; error)
  {
      Vector&lt;uint64_t&gt; databaseConnectionIdentifiers;
      {
          Locker&lt;Lock&gt; locker(m_databaseConnectionMapLock);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 527,10 ***</span>
<span class="line-new-header">--- 538,12 ---</span>
  }
  
  template&lt;typename KeyType, typename ValueType&gt;
  void removeItemsMatchingCurrentThread(HashMap&lt;KeyType, ValueType&gt;&amp; map)
  {
<span class="line-added">+     // FIXME: Revisit when introducing WebThread aware thread comparison.</span>
<span class="line-added">+     // https://bugs.webkit.org/show_bug.cgi?id=204345</span>
      auto&amp; currentThread = Thread::current();
  
      Vector&lt;KeyType&gt; keys;
      keys.reserveInitialCapacity(map.size());
      for (auto&amp; iterator : map) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 540,10 ***</span>
<span class="line-new-header">--- 553,29 ---</span>
  
      for (auto&amp; key : keys)
          map.remove(key);
  }
  
<span class="line-added">+ template&lt;typename KeyType, typename ValueType&gt;</span>
<span class="line-added">+ void setMatchingItemsContextSuspended(ScriptExecutionContext&amp; currentContext, HashMap&lt;KeyType, ValueType&gt;&amp; map, bool isContextSuspended)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     // FIXME: Revisit when introducing WebThread aware thread comparison.</span>
<span class="line-added">+     // https://bugs.webkit.org/show_bug.cgi?id=204345</span>
<span class="line-added">+     auto&amp; currentThread = Thread::current();</span>
<span class="line-added">+     for (auto&amp; iterator : map) {</span>
<span class="line-added">+         if (&amp;iterator.value-&gt;originThread() != &amp;currentThread)</span>
<span class="line-added">+             continue;</span>
<span class="line-added">+ </span>
<span class="line-added">+         auto* context = iterator.value-&gt;scriptExecutionContext();</span>
<span class="line-added">+         if (!context)</span>
<span class="line-added">+             continue;</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (context == &amp;currentContext)</span>
<span class="line-added">+             iterator.value-&gt;setIsContextSuspended(isContextSuspended);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void IDBConnectionProxy::forgetActivityForCurrentThread()
  {
      ASSERT(!isMainThread());
  
      {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 564,9 ***</span>
<span class="line-new-header">--- 596,21 ---</span>
          Locker&lt;Lock&gt; lock(m_transactionOperationLock);
          removeItemsMatchingCurrentThread(m_activeOperations);
      }
  }
  
<span class="line-added">+ void IDBConnectionProxy::setContextSuspended(ScriptExecutionContext&amp; currentContext, bool isContextSuspended)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     {</span>
<span class="line-added">+         Locker&lt;Lock&gt; lock(m_databaseConnectionMapLock);</span>
<span class="line-added">+         setMatchingItemsContextSuspended(currentContext, m_databaseConnectionMap, isContextSuspended);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     {</span>
<span class="line-added">+         Locker&lt;Lock&gt; lock(m_openDBRequestMapLock);</span>
<span class="line-added">+         setMatchingItemsContextSuspended(currentContext, m_openDBRequestMap, isContextSuspended);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  } // namesapce IDBClient
  } // namespace WebCore
  
  #endif // ENABLE(INDEXED_DATABASE)
</pre>
<center><a href="../IndexedDB.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="IDBConnectionProxy.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>