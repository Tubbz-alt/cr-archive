<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/svg/SVGLengthValue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2004, 2005, 2006 Nikolas Zimmermann &lt;zimmermann@kde.org&gt;
  3  * Copyright (C) 2004, 2005, 2006, 2007 Rob Buis &lt;buis@kde.org&gt;
  4  * Copyright (C) 2007-2019 Apple Inc. All rights reserved.
  5  *
  6  * This library is free software; you can redistribute it and/or
  7  * modify it under the terms of the GNU Library General Public
  8  * License as published by the Free Software Foundation; either
  9  * version 2 of the License, or (at your option) any later version.
 10  *
 11  * This library is distributed in the hope that it will be useful,
 12  * but WITHOUT ANY WARRANTY; without even the implied warranty of
 13  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 14  * Library General Public License for more details.
 15  *
 16  * You should have received a copy of the GNU Library General Public License
 17  * along with this library; see the file COPYING.LIB.  If not, write to
 18  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 19  * Boston, MA 02110-1301, USA.
 20  */
 21 
 22 #include &quot;config.h&quot;
 23 #include &quot;SVGLengthValue.h&quot;
 24 
 25 #include &quot;AnimationUtilities.h&quot;
 26 #include &quot;CSSPrimitiveValue.h&quot;
 27 #include &quot;SVGLengthContext.h&quot;
 28 #include &quot;SVGParserUtilities.h&quot;
 29 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
 30 #include &lt;wtf/text/TextStream.h&gt;
 31 
 32 namespace WebCore {
 33 
 34 static inline const char* lengthTypeToString(SVGLengthType lengthType)
 35 {
 36     switch (lengthType) {
 37     case SVGLengthType::Unknown:
 38     case SVGLengthType::Number:
 39         return &quot;&quot;;
 40     case SVGLengthType::Percentage:
 41         return &quot;%&quot;;
 42     case SVGLengthType::Ems:
 43         return &quot;em&quot;;
 44     case SVGLengthType::Exs:
 45         return &quot;ex&quot;;
 46     case SVGLengthType::Pixels:
 47         return &quot;px&quot;;
 48     case SVGLengthType::Centimeters:
 49         return &quot;cm&quot;;
 50     case SVGLengthType::Millimeters:
 51         return &quot;mm&quot;;
 52     case SVGLengthType::Inches:
 53         return &quot;in&quot;;
 54     case SVGLengthType::Points:
 55         return &quot;pt&quot;;
 56     case SVGLengthType::Picas:
 57         return &quot;pc&quot;;
 58     }
 59 
 60     ASSERT_NOT_REACHED();
 61     return &quot;&quot;;
 62 }
 63 
 64 static inline SVGLengthType parseLengthType(const UChar* ptr, const UChar* end)
 65 {
 66     if (ptr == end)
 67         return SVGLengthType::Number;
 68 
 69     const UChar firstChar = *ptr;
 70 
 71     if (++ptr == end)
 72         return firstChar == &#39;%&#39; ? SVGLengthType::Percentage : SVGLengthType::Unknown;
 73 
 74     const UChar secondChar = *ptr;
 75 
 76     if (++ptr != end)
 77         return SVGLengthType::Unknown;
 78 
 79     if (firstChar == &#39;e&#39; &amp;&amp; secondChar == &#39;m&#39;)
 80         return SVGLengthType::Ems;
 81     if (firstChar == &#39;e&#39; &amp;&amp; secondChar == &#39;x&#39;)
 82         return SVGLengthType::Exs;
 83     if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;x&#39;)
 84         return SVGLengthType::Pixels;
 85     if (firstChar == &#39;c&#39; &amp;&amp; secondChar == &#39;m&#39;)
 86         return SVGLengthType::Centimeters;
 87     if (firstChar == &#39;m&#39; &amp;&amp; secondChar == &#39;m&#39;)
 88         return SVGLengthType::Millimeters;
 89     if (firstChar == &#39;i&#39; &amp;&amp; secondChar == &#39;n&#39;)
 90         return SVGLengthType::Inches;
 91     if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;t&#39;)
 92         return SVGLengthType::Points;
 93     if (firstChar == &#39;p&#39; &amp;&amp; secondChar == &#39;c&#39;)
 94         return SVGLengthType::Picas;
 95 
 96     return SVGLengthType::Unknown;
 97 }
 98 
 99 static inline SVGLengthType primitiveTypeToLengthType(CSSUnitType primitiveType)
100 {
101     switch (primitiveType) {
102     case CSSUnitType::CSS_UNKNOWN:
103         return SVGLengthType::Unknown;
104     case CSSUnitType::CSS_NUMBER:
105         return SVGLengthType::Number;
106     case CSSUnitType::CSS_PERCENTAGE:
107         return SVGLengthType::Percentage;
108     case CSSUnitType::CSS_EMS:
109         return SVGLengthType::Ems;
110     case CSSUnitType::CSS_EXS:
111         return SVGLengthType::Exs;
112     case CSSUnitType::CSS_PX:
113         return SVGLengthType::Pixels;
114     case CSSUnitType::CSS_CM:
115         return SVGLengthType::Centimeters;
116     case CSSUnitType::CSS_MM:
117         return SVGLengthType::Millimeters;
118     case CSSUnitType::CSS_IN:
119         return SVGLengthType::Inches;
120     case CSSUnitType::CSS_PT:
121         return SVGLengthType::Points;
122     case CSSUnitType::CSS_PC:
123         return SVGLengthType::Picas;
124     default:
125         return SVGLengthType::Unknown;
126     }
127 
128     return SVGLengthType::Unknown;
129 }
130 
131 static inline CSSUnitType lengthTypeToPrimitiveType(SVGLengthType lengthType)
132 {
133     switch (lengthType) {
134     case SVGLengthType::Unknown:
135         return CSSUnitType::CSS_UNKNOWN;
136     case SVGLengthType::Number:
137         return CSSUnitType::CSS_NUMBER;
138     case SVGLengthType::Percentage:
139         return CSSUnitType::CSS_PERCENTAGE;
140     case SVGLengthType::Ems:
141         return CSSUnitType::CSS_EMS;
142     case SVGLengthType::Exs:
143         return CSSUnitType::CSS_EXS;
144     case SVGLengthType::Pixels:
145         return CSSUnitType::CSS_PX;
146     case SVGLengthType::Centimeters:
147         return CSSUnitType::CSS_CM;
148     case SVGLengthType::Millimeters:
149         return CSSUnitType::CSS_MM;
150     case SVGLengthType::Inches:
151         return CSSUnitType::CSS_IN;
152     case SVGLengthType::Points:
153         return CSSUnitType::CSS_PT;
154     case SVGLengthType::Picas:
155         return CSSUnitType::CSS_PC;
156     }
157 
158     ASSERT_NOT_REACHED();
159     return CSSUnitType::CSS_UNKNOWN;
160 }
161 
162 SVGLengthValue::SVGLengthValue(SVGLengthMode lengthMode, const String&amp; valueAsString)
163     : m_lengthMode(lengthMode)
164 {
165     setValueAsString(valueAsString);
166 }
167 
168 SVGLengthValue::SVGLengthValue(float valueInSpecifiedUnits, SVGLengthType lengthType, SVGLengthMode lengthMode)
169     : m_valueInSpecifiedUnits(valueInSpecifiedUnits)
170     , m_lengthType(lengthType)
171     , m_lengthMode(lengthMode)
172 {
173     ASSERT(m_lengthType != SVGLengthType::Unknown);
174 }
175 
176 SVGLengthValue::SVGLengthValue(const SVGLengthContext&amp; context, float value, SVGLengthType lengthType, SVGLengthMode lengthMode)
177     : m_lengthType(lengthType)
178     , m_lengthMode(lengthMode)
179 {
180     setValue(context, value);
181 }
182 
183 SVGLengthValue SVGLengthValue::construct(SVGLengthMode lengthMode, const String&amp; valueAsString, SVGParsingError&amp; parseError, SVGLengthNegativeValuesMode negativeValuesMode)
184 {
185     SVGLengthValue length(lengthMode);
186 
187     if (length.setValueAsString(valueAsString).hasException())
188         parseError = ParsingAttributeFailedError;
189     else if (negativeValuesMode == SVGLengthNegativeValuesMode::Forbid &amp;&amp; length.valueInSpecifiedUnits() &lt; 0)
190         parseError = NegativeValueForbiddenError;
191 
192     return length;
193 }
194 
195 SVGLengthValue SVGLengthValue::blend(const SVGLengthValue&amp; from, const SVGLengthValue&amp; to, float progress)
196 {
197     if ((from.isZero() &amp;&amp; to.isZero())
198         || from.lengthType() == SVGLengthType::Unknown
199         || to.lengthType() == SVGLengthType::Unknown
200         || (!from.isZero() &amp;&amp; from.lengthType() != SVGLengthType::Percentage &amp;&amp; to.lengthType() == SVGLengthType::Percentage)
201         || (!to.isZero() &amp;&amp; from.lengthType() == SVGLengthType::Percentage &amp;&amp; to.lengthType() != SVGLengthType::Percentage)
202         || (!from.isZero() &amp;&amp; !to.isZero() &amp;&amp; (from.lengthType() == SVGLengthType::Ems || from.lengthType() == SVGLengthType::Exs) &amp;&amp; from.lengthType() != to.lengthType()))
203         return to;
204 
205     if (from.lengthType() == SVGLengthType::Percentage || to.lengthType() == SVGLengthType::Percentage) {
206         auto fromPercent = from.valueAsPercentage() * 100;
207         auto toPercent = to.valueAsPercentage() * 100;
208         return { WebCore::blend(fromPercent, toPercent, progress), SVGLengthType::Percentage };
209     }
210 
211     if (from.lengthType() == to.lengthType() || from.isZero() || to.isZero() || from.isRelative()) {
212         auto fromValue = from.valueInSpecifiedUnits();
213         auto toValue = to.valueInSpecifiedUnits();
214         return { WebCore::blend(fromValue, toValue, progress), to.isZero() ? from.lengthType() : to.lengthType() };
215     }
216 
217     SVGLengthContext nonRelativeLengthContext(nullptr);
218     auto fromValueInUserUnits = nonRelativeLengthContext.convertValueToUserUnits(from.valueInSpecifiedUnits(), from.lengthType(), from.lengthMode());
219     if (fromValueInUserUnits.hasException())
220         return { };
221 
222     auto fromValue = nonRelativeLengthContext.convertValueFromUserUnits(fromValueInUserUnits.releaseReturnValue(), to.lengthType(), to.lengthMode());
223     if (fromValue.hasException())
224         return { };
225 
226     float toValue = to.valueInSpecifiedUnits();
227     return { WebCore::blend(fromValue.releaseReturnValue(), toValue, progress), to.lengthType() };
228 }
229 
230 SVGLengthValue SVGLengthValue::fromCSSPrimitiveValue(const CSSPrimitiveValue&amp; value)
231 {
232     // FIXME: This needs to call value.computeLength() so it can correctly resolve non-absolute units (webkit.org/b/204826).
233     SVGLengthType lengthType = primitiveTypeToLengthType(value.primitiveType());
234     return lengthType == SVGLengthType::Unknown ? SVGLengthValue() : SVGLengthValue(value.floatValue(), lengthType);
235 }
236 
237 Ref&lt;CSSPrimitiveValue&gt; SVGLengthValue::toCSSPrimitiveValue(const SVGLengthValue&amp; length)
238 {
239     return CSSPrimitiveValue::create(length.valueInSpecifiedUnits(), lengthTypeToPrimitiveType(length.lengthType()));
240 }
241 
242 ExceptionOr&lt;void&gt; SVGLengthValue::setValueAsString(const String&amp; valueAsString, SVGLengthMode lengthMode)
243 {
244     m_valueInSpecifiedUnits = 0;
245     m_lengthMode = lengthMode;
246     m_lengthType = SVGLengthType::Number;
247     return setValueAsString(valueAsString);
248 }
249 
250 float SVGLengthValue::value(const SVGLengthContext&amp; context) const
251 {
252     auto result = valueForBindings(context);
253     if (result.hasException())
254         return 0;
255     return result.releaseReturnValue();
256 }
257 
258 String SVGLengthValue::valueAsString() const
259 {
260     return makeString(m_valueInSpecifiedUnits, lengthTypeToString(m_lengthType));
261 }
262 
263 ExceptionOr&lt;float&gt; SVGLengthValue::valueForBindings(const SVGLengthContext&amp; context) const
264 {
265     return context.convertValueToUserUnits(m_valueInSpecifiedUnits, m_lengthType, m_lengthMode);
266 }
267 
268 ExceptionOr&lt;void&gt; SVGLengthValue::setValue(const SVGLengthContext&amp; context, float value)
269 {
270     // 100% = 100.0 instead of 1.0 for historical reasons, this could eventually be changed
271     if (m_lengthType == SVGLengthType::Percentage)
272         value = value / 100;
273 
274     auto convertedValue = context.convertValueFromUserUnits(value, m_lengthType, m_lengthMode);
275     if (convertedValue.hasException())
276         return convertedValue.releaseException();
277     m_valueInSpecifiedUnits = convertedValue.releaseReturnValue();
278     return { };
279 }
280 
281 ExceptionOr&lt;void&gt; SVGLengthValue::setValue(const SVGLengthContext&amp; context, float value, SVGLengthType lengthType, SVGLengthMode lengthMode)
282 {
283     // FIXME: Seems like a bug that we change the value of m_unit even if setValue throws an exception.
284     m_lengthMode = lengthMode;
285     m_lengthType = lengthType;
286     return setValue(context, value);
287 }
288 
289 ExceptionOr&lt;void&gt; SVGLengthValue::setValueAsString(const String&amp; string)
290 {
291     if (string.isEmpty())
292         return { };
293 
294     float convertedNumber = 0;
295     auto upconvertedCharacters = StringView(string).upconvertedCharacters();
296     const UChar* ptr = upconvertedCharacters;
297     const UChar* end = ptr + string.length();
298 
299     if (!parseNumber(ptr, end, convertedNumber, false))
300         return Exception { SyntaxError };
301 
302     auto lengthType = parseLengthType(ptr, end);
303     if (lengthType == SVGLengthType::Unknown)
304         return Exception { SyntaxError };
305 
306     m_lengthType = lengthType;
307     m_valueInSpecifiedUnits = convertedNumber;
308     return { };
309 }
310 
311 ExceptionOr&lt;void&gt; SVGLengthValue::convertToSpecifiedUnits(const SVGLengthContext&amp; context, SVGLengthType lengthType)
312 {
313     auto valueInUserUnits = valueForBindings(context);
314     if (valueInUserUnits.hasException())
315         return valueInUserUnits.releaseException();
316 
317     auto originalLengthType = m_lengthType;
318     m_lengthType = lengthType;
319     auto result = setValue(context, valueInUserUnits.releaseReturnValue());
320     if (!result.hasException())
321         return { };
322 
323     m_lengthType = originalLengthType;
324     return result.releaseException();
325 }
326 
327 TextStream&amp; operator&lt;&lt;(TextStream&amp; ts, const SVGLengthValue&amp; length)
328 {
329     ts &lt;&lt; length.valueAsString();
330     return ts;
331 }
332 
333 }
    </pre>
  </body>
</html>