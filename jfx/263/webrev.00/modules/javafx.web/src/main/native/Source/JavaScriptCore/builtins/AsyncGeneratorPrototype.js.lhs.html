<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/builtins/AsyncGeneratorPrototype.js</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2017 Oleksandr Skachkov &lt;gskachkov@gmail.com&gt;.
<a name="1" id="anc1"></a>
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 @globalPrivate
 27 function asyncGeneratorQueueIsEmpty(generator)
 28 {
 29     &quot;use strict&quot;;
 30 
<a name="2" id="anc2"></a><span class="line-modified"> 31     return @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;) === null;</span>
 32 }
 33 
 34 @globalPrivate
 35 function asyncGeneratorQueueEnqueue(generator, item)
 36 {
 37     &quot;use strict&quot;;
 38 
<a name="3" id="anc3"></a><span class="line-modified"> 39     @assert(@getByIdDirectPrivate(item, &quot;asyncGeneratorQueueItemNext&quot;) === null &amp;&amp; @getByIdDirectPrivate(item, &quot;asyncGeneratorQueueItemPrevious&quot;) === null);</span>
 40 
<a name="4" id="anc4"></a><span class="line-modified"> 41     if (@getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;) === null) {</span>
<span class="line-modified"> 42         @assert(@getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;) === null);</span>
 43 
<a name="5" id="anc5"></a><span class="line-modified"> 44         @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;, item);</span>
<span class="line-modified"> 45         @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;, item);</span>
 46     } else {
<a name="6" id="anc6"></a><span class="line-modified"> 47         var last = @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;);</span>
<span class="line-removed"> 48         @putByIdDirectPrivate(item, &quot;asyncGeneratorQueueItemPrevious&quot;, last);</span>
 49         @putByIdDirectPrivate(last, &quot;asyncGeneratorQueueItemNext&quot;, item);
<a name="7" id="anc7"></a><span class="line-modified"> 50         @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;, item);</span>
 51     }
 52 }
 53 
 54 @globalPrivate
 55 function asyncGeneratorQueueDequeue(generator)
 56 {
 57     &quot;use strict&quot;;
 58 
<a name="8" id="anc8"></a><span class="line-modified"> 59     const result = @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;);</span>
<span class="line-modified"> 60     if (result === null)</span>
<span class="line-modified"> 61         return null;</span>
 62 
 63     var updatedFirst = @getByIdDirectPrivate(result, &quot;asyncGeneratorQueueItemNext&quot;);
<a name="9" id="anc9"></a><span class="line-modified"> 64     @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;, updatedFirst);</span>
 65 
 66     if (updatedFirst === null)
<a name="10" id="anc10"></a><span class="line-modified"> 67         @putByIdDirectPrivate(generator, &quot;asyncGeneratorQueueLast&quot;, null);</span>
 68 
 69     return result;
 70 }
 71 
<a name="11" id="anc11"></a><span class="line-removed"> 72 @globalPrivate</span>
<span class="line-removed"> 73 function asyncGeneratorDequeue(generator)</span>
<span class="line-removed"> 74 {</span>
<span class="line-removed"> 75     &quot;use strict&quot;;</span>
<span class="line-removed"> 76 </span>
<span class="line-removed"> 77     const queue = @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueue&quot;);</span>
<span class="line-removed"> 78 </span>
<span class="line-removed"> 79     @assert(!@asyncGeneratorQueueIsEmpty(generator), &quot;Async genetator&#39;s Queue is an empty List.&quot;);</span>
<span class="line-removed"> 80     </span>
<span class="line-removed"> 81     return @asyncGeneratorQueueDequeue(generator);</span>
<span class="line-removed"> 82 }</span>
<span class="line-removed"> 83 </span>
 84 @globalPrivate
 85 function isExecutionState(generator)
 86 {
 87     &quot;use strict&quot;;
 88 
<a name="12" id="anc12"></a><span class="line-modified"> 89     var state = @getByIdDirectPrivate(generator, &quot;generatorState&quot;);</span>
<span class="line-modified"> 90     var reason = @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;);</span>
 91     return (state &gt; 0 &amp;&amp; reason === @AsyncGeneratorSuspendReasonNone)
 92         || state === @AsyncGeneratorStateExecuting
 93         || reason === @AsyncGeneratorSuspendReasonAwait;
 94 }
 95 
 96 @globalPrivate
 97 function isSuspendYieldState(generator)
 98 {
 99     &quot;use strict&quot;;
100 
<a name="13" id="anc13"></a><span class="line-modified">101     var state = @getByIdDirectPrivate(generator, &quot;generatorState&quot;);</span>
<span class="line-modified">102     return (state &gt; 0 &amp;&amp; @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === @AsyncGeneratorSuspendReasonYield)</span>
103         || state === @AsyncGeneratorStateSuspendedYield;
104 }
105 
106 @globalPrivate
107 function asyncGeneratorReject(generator, exception)
108 {
109     &quot;use strict&quot;;
110 
<a name="14" id="anc14"></a><span class="line-modified">111     @assert(typeof @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === &quot;number&quot;, &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
112 
<a name="15" id="anc15"></a><span class="line-modified">113     const { promiseCapability } = @asyncGeneratorDequeue(generator);</span>
<span class="line-modified">114     promiseCapability.@reject.@call(@undefined, exception);</span>

115 
116     return @asyncGeneratorResumeNext(generator);
117 }
118 
119 @globalPrivate
120 function asyncGeneratorResolve(generator, value, done)
121 {
122     &quot;use strict&quot;;
123 
<a name="16" id="anc16"></a><span class="line-modified">124     @assert(typeof @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === &quot;number&quot;, &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
125 
<a name="17" id="anc17"></a><span class="line-modified">126     const { promiseCapability } = @asyncGeneratorDequeue(generator);</span>
<span class="line-modified">127     promiseCapability.@resolve.@call(@undefined, { value, done });</span>

128 
129     return @asyncGeneratorResumeNext(generator);
130 }
131 
132 @globalPrivate
133 function asyncGeneratorYield(generator, value, resumeMode)
134 {
135     &quot;use strict&quot;;
136 
137     function asyncGeneratorYieldAwaited(result)
138     {
<a name="18" id="anc18"></a><span class="line-modified">139         @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonYield);</span>
140         @asyncGeneratorResolve(generator, result, false);
141     }
142 
<a name="19" id="anc19"></a><span class="line-modified">143     @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonAwait);</span>
144 
145     @awaitValue(generator, value, asyncGeneratorYieldAwaited);
<a name="20" id="anc20"></a><span class="line-removed">146 </span>
<span class="line-removed">147     return @undefined;</span>
148 }
149 
150 @globalPrivate
<a name="21" id="anc21"></a><span class="line-modified">151 function awaitValue(generator, value, onFullfiled)</span>
152 {
153     &quot;use strict&quot;;
154 
<a name="22" id="anc22"></a><span class="line-modified">155     const wrappedValue = @newPromiseCapability(@Promise);</span>
<span class="line-modified">156 </span>
<span class="line-removed">157     const onRejected = function (result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeThrow); };</span>
<span class="line-removed">158 </span>
<span class="line-removed">159     wrappedValue.@resolve.@call(@undefined, value);</span>
<span class="line-removed">160     wrappedValue.@promise.@then(onFullfiled, onRejected);</span>
<span class="line-removed">161 </span>
<span class="line-removed">162     return wrappedValue;</span>
163 }
164 
165 @globalPrivate
166 function doAsyncGeneratorBodyCall(generator, resumeValue, resumeMode)
167 {
168     &quot;use strict&quot;;
169 
<a name="23" id="anc23"></a><span class="line-modified">170     let value = @undefined;</span>
<span class="line-modified">171     let state = @getByIdDirectPrivate(generator, &quot;generatorState&quot;);</span>
172 
<a name="24" id="anc24"></a><span class="line-modified">173     @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateExecuting);</span>
<span class="line-modified">174     @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonNone);</span>
175 
176     try {
<a name="25" id="anc25"></a><span class="line-modified">177         value = @getByIdDirectPrivate(generator, &quot;generatorNext&quot;).@call(@getByIdDirectPrivate(generator, &quot;generatorThis&quot;), generator, state, resumeValue, resumeMode, @getByIdDirectPrivate(generator, &quot;generatorFrame&quot;));</span>
<span class="line-modified">178         if (@getByIdDirectPrivate(generator, &quot;generatorState&quot;) === @AsyncGeneratorStateExecuting)</span>
<span class="line-modified">179             @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateCompleted);</span>



180     } catch (error) {
<a name="26" id="anc26"></a><span class="line-modified">181         @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateCompleted);</span>
<span class="line-modified">182         @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonNone);</span>
183 
184         return @asyncGeneratorReject(generator, error);
185     }
186 
<a name="27" id="anc27"></a><span class="line-modified">187     if (@getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === @AsyncGeneratorSuspendReasonAwait) {</span>
<span class="line-modified">188         const onFulfilled = function(result) { @doAsyncGeneratorBodyCall(generator, result, @GeneratorResumeModeNormal); };</span>

189 
190         @awaitValue(generator, value, onFulfilled);
<a name="28" id="anc28"></a><span class="line-modified">191 </span>
<span class="line-removed">192         return @undefined;</span>
193     }
194 
<a name="29" id="anc29"></a><span class="line-modified">195     if (@getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === @AsyncGeneratorSuspendReasonYield)</span>
196         return @asyncGeneratorYield(generator, value, resumeMode);
197 
<a name="30" id="anc30"></a><span class="line-modified">198     if (@getByIdDirectPrivate(generator, &quot;generatorState&quot;) === @AsyncGeneratorStateCompleted) {</span>
<span class="line-modified">199         @putByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;, @AsyncGeneratorSuspendReasonNone);</span>

200         return @asyncGeneratorResolve(generator, value, true);
201     }
<a name="31" id="anc31"></a><span class="line-removed">202 </span>
<span class="line-removed">203     return @undefined;</span>
204 }
205 
206 @globalPrivate
207 function asyncGeneratorResumeNext(generator)
208 {
209     &quot;use strict&quot;;
210 
<a name="32" id="anc32"></a><span class="line-modified">211     @assert(typeof @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) === &quot;number&quot;, &quot;Generator is not an AsyncGenerator instance.&quot;);</span>
212 
<a name="33" id="anc33"></a><span class="line-modified">213     let state = @getByIdDirectPrivate(generator, &quot;generatorState&quot;);</span>
214 
215     @assert(state !== @AsyncGeneratorStateExecuting, &quot;Async generator should not be in executing state&quot;);
216 
217     if (state === @AsyncGeneratorStateAwaitingReturn)
<a name="34" id="anc34"></a><span class="line-modified">218         return @undefined;</span>
219 
220     if (@asyncGeneratorQueueIsEmpty(generator))
<a name="35" id="anc35"></a><span class="line-modified">221         return @undefined;</span>
222 
<a name="36" id="anc36"></a><span class="line-modified">223     const next = @getByIdDirectPrivate(generator, &quot;asyncGeneratorQueueFirst&quot;);</span>
224 
225     if (next.resumeMode !== @GeneratorResumeModeNormal) {
226         if (state === @AsyncGeneratorStateSuspendedStart) {
<a name="37" id="anc37"></a><span class="line-modified">227             @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateCompleted);</span>
228             state = @AsyncGeneratorStateCompleted;
229         }
230 
231         if (state === @AsyncGeneratorStateCompleted) {
232             if (next.resumeMode === @GeneratorResumeModeReturn) {
<a name="38" id="anc38"></a><span class="line-modified">233                 @putByIdDirectPrivate(generator, &quot;generatorState&quot;, @AsyncGeneratorStateAwaitingReturn);</span>
<span class="line-modified">234 </span>
<span class="line-modified">235                 const promiseCapability = @newPromiseCapability(@Promise);</span>
<span class="line-modified">236                 promiseCapability.@resolve.@call(@undefined, next.value);</span>
<span class="line-modified">237 </span>
<span class="line-modified">238                 const throwawayCapabilityPromise = promiseCapability.@promise.@then(</span>
<span class="line-modified">239                     function (result) { generator.@generatorState = @AsyncGeneratorStateCompleted; @asyncGeneratorResolve(generator, result, true); },</span>
<span class="line-modified">240                     function (error) { generator.@generatorState = @AsyncGeneratorStateCompleted; @asyncGeneratorReject(generator, error); });</span>
<span class="line-modified">241 </span>
<span class="line-modified">242                 @putByIdDirectPrivate(throwawayCapabilityPromise, &quot;promiseIsHandled&quot;, true);</span>
<span class="line-modified">243 </span>
<span class="line-removed">244                 return @undefined;</span>
245             }
246 
247             @assert(next.resumeMode === @GeneratorResumeModeThrow, &quot;Async generator has wrong mode&quot;);
248 
249             return @asyncGeneratorReject(generator, next.value);;
250         }
251     } else if (state === @AsyncGeneratorStateCompleted)
252         return @asyncGeneratorResolve(generator, @undefined, true);
253 
254     @assert(state === @AsyncGeneratorStateSuspendedStart || @isSuspendYieldState(generator), &quot;Async generator has wrong state&quot;);
255 
256     @doAsyncGeneratorBodyCall(generator, next.value, next.resumeMode);
<a name="39" id="anc39"></a><span class="line-removed">257 </span>
<span class="line-removed">258     return @undefined;</span>
259 }
260 
261 @globalPrivate
262 function asyncGeneratorEnqueue(generator, value, resumeMode)
263 {
264     &quot;use strict&quot;;
<a name="40" id="anc40"></a><span class="line-modified">265     </span>
<span class="line-modified">266     const promiseCapability = @newPromiseCapability(@Promise);</span>
<span class="line-modified">267     if (!@isObject(generator) || typeof @getByIdDirectPrivate(generator, &quot;asyncGeneratorSuspendReason&quot;) !== &#39;number&#39;) {</span>
<span class="line-modified">268         promiseCapability.@reject.@call(@undefined, @makeTypeError(&#39;|this| should be an async generator&#39;));</span>
<span class="line-modified">269         return promiseCapability.@promise;</span>
270     }
271 
<a name="41" id="anc41"></a><span class="line-modified">272     @asyncGeneratorQueueEnqueue(generator, {resumeMode, value, promiseCapability, @asyncGeneratorQueueItemNext: null, @asyncGeneratorQueueItemPrevious: null});</span>
273 
274     if (!@isExecutionState(generator))
275         @asyncGeneratorResumeNext(generator);
276 
<a name="42" id="anc42"></a><span class="line-modified">277     return promiseCapability.@promise;</span>
278 }
279 
280 function next(value)
281 {
282     &quot;use strict&quot;;
283 
284     return @asyncGeneratorEnqueue(this, value, @GeneratorResumeModeNormal);
285 }
286 
287 function return(value)
288 {
289     &quot;use strict&quot;;
290 
291     return @asyncGeneratorEnqueue(this, value, @GeneratorResumeModeReturn);
292 }
293 
294 function throw(exception)
295 {
296     &quot;use strict&quot;;
297     
298     return @asyncGeneratorEnqueue(this, exception, @GeneratorResumeModeThrow);
299 }
<a name="43" id="anc43"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="43" type="hidden" />
</body>
</html>