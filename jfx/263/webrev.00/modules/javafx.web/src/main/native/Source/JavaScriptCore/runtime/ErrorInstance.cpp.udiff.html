<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/ErrorInstance.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ErrorConstructor.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ErrorInstance.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/ErrorInstance.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -37,20 +37,20 @@</span>
  ErrorInstance::ErrorInstance(VM&amp; vm, Structure* structure)
      : Base(vm, structure)
  {
  }
  
<span class="udiff-line-modified-removed">- ErrorInstance* ErrorInstance::create(ExecState* state, Structure* structure, JSValue message, SourceAppender appender, RuntimeType type, bool useCurrentFrame)</span>
<span class="udiff-line-modified-added">+ ErrorInstance* ErrorInstance::create(JSGlobalObject* globalObject, Structure* structure, JSValue message, SourceAppender appender, RuntimeType type, bool useCurrentFrame)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = state-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
<span class="udiff-line-modified-removed">-     String messageString = message.isUndefined() ? String() : message.toWTFString(state);</span>
<span class="udiff-line-modified-added">+     String messageString = message.isUndefined() ? String() : message.toWTFString(globalObject);</span>
      RETURN_IF_EXCEPTION(scope, nullptr);
<span class="udiff-line-modified-removed">-     return create(state, vm, structure, messageString, appender, type, useCurrentFrame);</span>
<span class="udiff-line-modified-added">+     return create(globalObject, vm, structure, messageString, appender, type, useCurrentFrame);</span>
  }
  
<span class="udiff-line-modified-removed">- static void appendSourceToError(CallFrame* callFrame, ErrorInstance* exception, unsigned bytecodeOffset)</span>
<span class="udiff-line-modified-added">+ static void appendSourceToError(JSGlobalObject* globalObject, CallFrame* callFrame, ErrorInstance* exception, BytecodeIndex bytecodeIndex)</span>
  {
      ErrorInstance::SourceAppender appender = exception-&gt;sourceAppender();
      exception-&gt;clearSourceAppender();
      RuntimeType type = exception-&gt;runtimeTypeForCause();
      exception-&gt;clearRuntimeTypeForCause();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -69,25 +69,25 @@</span>
      if (codeOrigin &amp;&amp; codeOrigin.inlineCallFrame())
          codeBlock = baselineCodeBlockForInlineCallFrame(codeOrigin.inlineCallFrame());
      else
          codeBlock = callFrame-&gt;codeBlock();
  
<span class="udiff-line-modified-removed">-     codeBlock-&gt;expressionRangeForBytecodeOffset(bytecodeOffset, divotPoint, startOffset, endOffset, line, column);</span>
<span class="udiff-line-modified-added">+     codeBlock-&gt;expressionRangeForBytecodeIndex(bytecodeIndex, divotPoint, startOffset, endOffset, line, column);</span>
  
      int expressionStart = divotPoint - startOffset;
      int expressionStop = divotPoint + endOffset;
  
      StringView sourceString = codeBlock-&gt;source().provider()-&gt;source();
      if (!expressionStop || expressionStart &gt; static_cast&lt;int&gt;(sourceString.length()))
          return;
  
<span class="udiff-line-modified-removed">-     VM&amp; vm = callFrame-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
      JSValue jsMessage = exception-&gt;getDirect(vm, vm.propertyNames-&gt;message);
      if (!jsMessage || !jsMessage.isString())
          return;
  
<span class="udiff-line-modified-removed">-     String message = asString(jsMessage)-&gt;value(callFrame);</span>
<span class="udiff-line-modified-added">+     String message = asString(jsMessage)-&gt;value(globalObject);</span>
      if (expressionStart &lt; expressionStop)
          message = appender(message, codeBlock-&gt;source().provider()-&gt;getRange(expressionStart, expressionStop).toString(), type, ErrorInstance::FoundExactSource);
      else {
          // No range information, so give a few characters of context.
          int dataLength = sourceString.length();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -107,46 +107,39 @@</span>
      }
      exception-&gt;putDirect(vm, vm.propertyNames-&gt;message, jsString(vm, message));
  
  }
  
<span class="udiff-line-modified-removed">- void ErrorInstance::finishCreation(ExecState* exec, VM&amp; vm, const String&amp; message, bool useCurrentFrame)</span>
<span class="udiff-line-modified-added">+ void ErrorInstance::finishCreation(JSGlobalObject* globalObject, VM&amp; vm, const String&amp; message, bool useCurrentFrame)</span>
  {
      Base::finishCreation(vm);
      ASSERT(inherits(vm, info()));
      if (!message.isNull())
          putDirect(vm, vm.propertyNames-&gt;message, jsString(vm, message), static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
  
<span class="udiff-line-modified-removed">-     std::unique_ptr&lt;Vector&lt;StackFrame&gt;&gt; stackTrace = getStackTrace(exec, vm, this, useCurrentFrame);</span>
<span class="udiff-line-modified-added">+     std::unique_ptr&lt;Vector&lt;StackFrame&gt;&gt; stackTrace = getStackTrace(globalObject, vm, this, useCurrentFrame);</span>
      {
          auto locker = holdLock(cellLock());
          m_stackTrace = WTFMove(stackTrace);
      }
      vm.heap.writeBarrier(this);
  
      if (m_stackTrace &amp;&amp; !m_stackTrace-&gt;isEmpty() &amp;&amp; hasSourceAppender()) {
<span class="udiff-line-modified-removed">-         unsigned bytecodeOffset;</span>
<span class="udiff-line-modified-added">+         BytecodeIndex bytecodeIndex;</span>
          CallFrame* callFrame;
<span class="udiff-line-modified-removed">-         getBytecodeOffset(exec, vm, m_stackTrace.get(), callFrame, bytecodeOffset);</span>
<span class="udiff-line-modified-removed">-         if (callFrame &amp;&amp; callFrame-&gt;codeBlock()) {</span>
<span class="udiff-line-modified-removed">-             ASSERT(!callFrame-&gt;callee().isWasm());</span>
<span class="udiff-line-removed">-             appendSourceToError(callFrame, this, bytecodeOffset);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         getBytecodeIndex(vm, vm.topCallFrame, m_stackTrace.get(), callFrame, bytecodeIndex);</span>
<span class="udiff-line-modified-added">+         if (callFrame &amp;&amp; callFrame-&gt;codeBlock() &amp;&amp; !callFrame-&gt;callee().isWasm())</span>
<span class="udiff-line-modified-added">+             appendSourceToError(globalObject, callFrame, this, bytecodeIndex);</span>
      }
  }
  
<span class="udiff-line-removed">- void ErrorInstance::destroy(JSCell* cell)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     static_cast&lt;ErrorInstance*&gt;(cell)-&gt;ErrorInstance::~ErrorInstance();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  // Based on ErrorPrototype&#39;s errorProtoFuncToString(), but is modified to
  // have no observable side effects to the user (i.e. does not call proxies,
  // and getters).
<span class="udiff-line-modified-removed">- String ErrorInstance::sanitizedToString(ExecState* exec)</span>
<span class="udiff-line-modified-added">+ String ErrorInstance::sanitizedToString(JSGlobalObject* globalObject)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = exec-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      JSValue nameValue;
      auto namePropertName = vm.propertyNames-&gt;name;
      PropertySlot nameSlot(this, PropertySlot::InternalMethodType::VMInquiry);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -157,38 +150,38 @@</span>
      // We only check the current object and its prototype (2 levels) because normal
      // Error objects may have a name property, and if not, its prototype should have
      // a name property for the type of error e.g. &quot;SyntaxError&quot;.
      while (currentObj.isCell() &amp;&amp; prototypeDepth++ &lt; 2) {
          JSObject* obj = jsCast&lt;JSObject*&gt;(currentObj);
<span class="udiff-line-modified-removed">-         if (JSObject::getOwnPropertySlot(obj, exec, namePropertName, nameSlot) &amp;&amp; nameSlot.isValue()) {</span>
<span class="udiff-line-modified-removed">-             nameValue = nameSlot.getValue(exec, namePropertName);</span>
<span class="udiff-line-modified-added">+         if (JSObject::getOwnPropertySlot(obj, globalObject, namePropertName, nameSlot) &amp;&amp; nameSlot.isValue()) {</span>
<span class="udiff-line-modified-added">+             nameValue = nameSlot.getValue(globalObject, namePropertName);</span>
              break;
          }
          currentObj = obj-&gt;getPrototypeDirect(vm);
      }
      scope.assertNoException();
  
      String nameString;
      if (!nameValue)
          nameString = &quot;Error&quot;_s;
      else {
<span class="udiff-line-modified-removed">-         nameString = nameValue.toWTFString(exec);</span>
<span class="udiff-line-modified-added">+         nameString = nameValue.toWTFString(globalObject);</span>
          RETURN_IF_EXCEPTION(scope, String());
      }
  
      JSValue messageValue;
      auto messagePropertName = vm.propertyNames-&gt;message;
      PropertySlot messageSlot(this, PropertySlot::InternalMethodType::VMInquiry);
<span class="udiff-line-modified-removed">-     if (JSObject::getOwnPropertySlot(this, exec, messagePropertName, messageSlot) &amp;&amp; messageSlot.isValue())</span>
<span class="udiff-line-modified-removed">-         messageValue = messageSlot.getValue(exec, messagePropertName);</span>
<span class="udiff-line-modified-added">+     if (JSObject::getOwnPropertySlot(this, globalObject, messagePropertName, messageSlot) &amp;&amp; messageSlot.isValue())</span>
<span class="udiff-line-modified-added">+         messageValue = messageSlot.getValue(globalObject, messagePropertName);</span>
      scope.assertNoException();
  
      String messageString;
      if (!messageValue)
          messageString = String();
      else {
<span class="udiff-line-modified-removed">-         messageString = messageValue.toWTFString(exec);</span>
<span class="udiff-line-modified-added">+         messageString = messageValue.toWTFString(globalObject);</span>
          RETURN_IF_EXCEPTION(scope, String());
      }
  
      if (!nameString.length())
          return messageString;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -236,16 +229,18 @@</span>
          return false;
  
      computeErrorInfo(vm);
  
      if (!m_stackString.isNull()) {
<span class="udiff-line-modified-removed">-         putDirect(vm, vm.propertyNames-&gt;line, jsNumber(m_line));</span>
<span class="udiff-line-modified-removed">-         putDirect(vm, vm.propertyNames-&gt;column, jsNumber(m_column));</span>
<span class="udiff-line-modified-added">+         auto attributes = static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+         putDirect(vm, vm.propertyNames-&gt;line, jsNumber(m_line), attributes);</span>
<span class="udiff-line-added">+         putDirect(vm, vm.propertyNames-&gt;column, jsNumber(m_column), attributes);</span>
          if (!m_sourceURL.isEmpty())
<span class="udiff-line-modified-removed">-             putDirect(vm, vm.propertyNames-&gt;sourceURL, jsString(vm, WTFMove(m_sourceURL)));</span>
<span class="udiff-line-modified-added">+             putDirect(vm, vm.propertyNames-&gt;sourceURL, jsString(vm, WTFMove(m_sourceURL)), attributes);</span>
  
<span class="udiff-line-modified-removed">-         putDirect(vm, vm.propertyNames-&gt;stack, jsString(vm, WTFMove(m_stackString)), static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));</span>
<span class="udiff-line-modified-added">+         putDirect(vm, vm.propertyNames-&gt;stack, jsString(vm, WTFMove(m_stackString)), attributes);</span>
      }
  
      m_errorInfoMaterialized = true;
      return true;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -258,56 +253,56 @@</span>
          || propertyName == vm.propertyNames-&gt;stack)
          return materializeErrorInfoIfNeeded(vm);
      return false;
  }
  
<span class="udiff-line-modified-removed">- bool ErrorInstance::getOwnPropertySlot(JSObject* object, ExecState* exec, PropertyName propertyName, PropertySlot&amp; slot)</span>
<span class="udiff-line-modified-added">+ bool ErrorInstance::getOwnPropertySlot(JSObject* object, JSGlobalObject* globalObject, PropertyName propertyName, PropertySlot&amp; slot)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = exec-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
      ErrorInstance* thisObject = jsCast&lt;ErrorInstance*&gt;(object);
      thisObject-&gt;materializeErrorInfoIfNeeded(vm, propertyName);
<span class="udiff-line-modified-removed">-     return Base::getOwnPropertySlot(thisObject, exec, propertyName, slot);</span>
<span class="udiff-line-modified-added">+     return Base::getOwnPropertySlot(thisObject, globalObject, propertyName, slot);</span>
  }
  
<span class="udiff-line-modified-removed">- void ErrorInstance::getOwnNonIndexPropertyNames(JSObject* object, ExecState* exec, PropertyNameArray&amp; propertyNameArray, EnumerationMode enumerationMode)</span>
<span class="udiff-line-modified-added">+ void ErrorInstance::getOwnNonIndexPropertyNames(JSObject* object, JSGlobalObject* globalObject, PropertyNameArray&amp; propertyNameArray, EnumerationMode enumerationMode)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = exec-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
      ErrorInstance* thisObject = jsCast&lt;ErrorInstance*&gt;(object);
      thisObject-&gt;materializeErrorInfoIfNeeded(vm);
<span class="udiff-line-modified-removed">-     Base::getOwnNonIndexPropertyNames(thisObject, exec, propertyNameArray, enumerationMode);</span>
<span class="udiff-line-modified-added">+     Base::getOwnNonIndexPropertyNames(thisObject, globalObject, propertyNameArray, enumerationMode);</span>
  }
  
<span class="udiff-line-modified-removed">- void ErrorInstance::getStructurePropertyNames(JSObject* object, ExecState* exec, PropertyNameArray&amp; propertyNameArray, EnumerationMode enumerationMode)</span>
<span class="udiff-line-modified-added">+ void ErrorInstance::getStructurePropertyNames(JSObject* object, JSGlobalObject* globalObject, PropertyNameArray&amp; propertyNameArray, EnumerationMode enumerationMode)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = exec-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
      ErrorInstance* thisObject = jsCast&lt;ErrorInstance*&gt;(object);
      thisObject-&gt;materializeErrorInfoIfNeeded(vm);
<span class="udiff-line-modified-removed">-     Base::getStructurePropertyNames(thisObject, exec, propertyNameArray, enumerationMode);</span>
<span class="udiff-line-modified-added">+     Base::getStructurePropertyNames(thisObject, globalObject, propertyNameArray, enumerationMode);</span>
  }
  
<span class="udiff-line-modified-removed">- bool ErrorInstance::defineOwnProperty(JSObject* object, ExecState* exec, PropertyName propertyName, const PropertyDescriptor&amp; descriptor, bool shouldThrow)</span>
<span class="udiff-line-modified-added">+ bool ErrorInstance::defineOwnProperty(JSObject* object, JSGlobalObject* globalObject, PropertyName propertyName, const PropertyDescriptor&amp; descriptor, bool shouldThrow)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = exec-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
      ErrorInstance* thisObject = jsCast&lt;ErrorInstance*&gt;(object);
      thisObject-&gt;materializeErrorInfoIfNeeded(vm, propertyName);
<span class="udiff-line-modified-removed">-     return Base::defineOwnProperty(thisObject, exec, propertyName, descriptor, shouldThrow);</span>
<span class="udiff-line-modified-added">+     return Base::defineOwnProperty(thisObject, globalObject, propertyName, descriptor, shouldThrow);</span>
  }
  
<span class="udiff-line-modified-removed">- bool ErrorInstance::put(JSCell* cell, ExecState* exec, PropertyName propertyName, JSValue value, PutPropertySlot&amp; slot)</span>
<span class="udiff-line-modified-added">+ bool ErrorInstance::put(JSCell* cell, JSGlobalObject* globalObject, PropertyName propertyName, JSValue value, PutPropertySlot&amp; slot)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = exec-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
      ErrorInstance* thisObject = jsCast&lt;ErrorInstance*&gt;(cell);
      bool materializedProperties = thisObject-&gt;materializeErrorInfoIfNeeded(vm, propertyName);
      if (materializedProperties)
          slot.disableCaching();
<span class="udiff-line-modified-removed">-     return Base::put(thisObject, exec, propertyName, value, slot);</span>
<span class="udiff-line-modified-added">+     return Base::put(thisObject, globalObject, propertyName, value, slot);</span>
  }
  
<span class="udiff-line-modified-removed">- bool ErrorInstance::deleteProperty(JSCell* cell, ExecState* exec, PropertyName propertyName)</span>
<span class="udiff-line-modified-added">+ bool ErrorInstance::deleteProperty(JSCell* cell, JSGlobalObject* globalObject, PropertyName propertyName)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = exec-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
      ErrorInstance* thisObject = jsCast&lt;ErrorInstance*&gt;(cell);
      thisObject-&gt;materializeErrorInfoIfNeeded(vm, propertyName);
<span class="udiff-line-modified-removed">-     return Base::deleteProperty(thisObject, exec, propertyName);</span>
<span class="udiff-line-modified-added">+     return Base::deleteProperty(thisObject, globalObject, propertyName);</span>
  }
  
  } // namespace JSC
</pre>
<center><a href="ErrorConstructor.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ErrorInstance.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>