<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/jit/JITInlineCacheGenerator.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JITExceptions.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JITInlineCacheGenerator.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/jit/JITInlineCacheGenerator.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 36,11 ***</span>
  
  namespace JSC {
  
  static StructureStubInfo* garbageStubInfo()
  {
<span class="line-modified">!     static StructureStubInfo* stubInfo = new StructureStubInfo(AccessType::Get);</span>
      return stubInfo;
  }
  
  JITInlineCacheGenerator::JITInlineCacheGenerator(
      CodeBlock* codeBlock, CodeOrigin codeOrigin, CallSiteIndex callSite, AccessType accessType,
<span class="line-new-header">--- 36,11 ---</span>
  
  namespace JSC {
  
  static StructureStubInfo* garbageStubInfo()
  {
<span class="line-modified">!     static StructureStubInfo* stubInfo = new StructureStubInfo(AccessType::GetById);</span>
      return stubInfo;
  }
  
  JITInlineCacheGenerator::JITInlineCacheGenerator(
      CodeBlock* codeBlock, CodeOrigin codeOrigin, CallSiteIndex callSite, AccessType accessType,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 49,38 ***</span>
  {
      m_stubInfo = m_codeBlock ? m_codeBlock-&gt;addStubInfo(accessType) : garbageStubInfo();
      m_stubInfo-&gt;codeOrigin = codeOrigin;
      m_stubInfo-&gt;callSiteIndex = callSite;
  
<span class="line-modified">!     m_stubInfo-&gt;patch.usedRegisters = usedRegisters;</span>
  }
  
  void JITInlineCacheGenerator::finalize(
      LinkBuffer&amp; fastPath, LinkBuffer&amp; slowPath, CodeLocationLabel&lt;JITStubRoutinePtrTag&gt; start)
  {
<span class="line-modified">!     m_stubInfo-&gt;patch.start = start;</span>
  
<span class="line-modified">!     m_stubInfo-&gt;patch.doneLocation = fastPath.locationOf&lt;JSInternalPtrTag&gt;(m_done);</span>
  
<span class="line-modified">!     m_stubInfo-&gt;patch.slowPathCallLocation = slowPath.locationOf&lt;JSInternalPtrTag&gt;(m_slowPathCall);</span>
<span class="line-modified">!     m_stubInfo-&gt;patch.slowPathStartLocation = slowPath.locationOf&lt;JITStubRoutinePtrTag&gt;(m_slowPathBegin);</span>
  }
  
  JITByIdGenerator::JITByIdGenerator(
      CodeBlock* codeBlock, CodeOrigin codeOrigin, CallSiteIndex callSite, AccessType accessType,
      const RegisterSet&amp; usedRegisters, JSValueRegs base, JSValueRegs value)
      : JITInlineCacheGenerator(codeBlock, codeOrigin, callSite, accessType, usedRegisters)
      , m_base(base)
      , m_value(value)
  {
<span class="line-modified">!     m_stubInfo-&gt;patch.baseGPR = base.payloadGPR();</span>
<span class="line-modified">!     m_stubInfo-&gt;patch.valueGPR = value.payloadGPR();</span>
<span class="line-modified">!     m_stubInfo-&gt;patch.thisGPR = InvalidGPRReg;</span>
  #if USE(JSVALUE32_64)
<span class="line-modified">!     m_stubInfo-&gt;patch.baseTagGPR = base.tagGPR();</span>
<span class="line-modified">!     m_stubInfo-&gt;patch.valueTagGPR = value.tagGPR();</span>
<span class="line-modified">!     m_stubInfo-&gt;patch.thisTagGPR = InvalidGPRReg;</span>
  #endif
  }
  
  void JITByIdGenerator::finalize(LinkBuffer&amp; fastPath, LinkBuffer&amp; slowPath)
  {
<span class="line-new-header">--- 49,38 ---</span>
  {
      m_stubInfo = m_codeBlock ? m_codeBlock-&gt;addStubInfo(accessType) : garbageStubInfo();
      m_stubInfo-&gt;codeOrigin = codeOrigin;
      m_stubInfo-&gt;callSiteIndex = callSite;
  
<span class="line-modified">!     m_stubInfo-&gt;usedRegisters = usedRegisters;</span>
  }
  
  void JITInlineCacheGenerator::finalize(
      LinkBuffer&amp; fastPath, LinkBuffer&amp; slowPath, CodeLocationLabel&lt;JITStubRoutinePtrTag&gt; start)
  {
<span class="line-modified">!     m_stubInfo-&gt;start = start;</span>
  
<span class="line-modified">!     m_stubInfo-&gt;doneLocation = fastPath.locationOf&lt;JSInternalPtrTag&gt;(m_done);</span>
  
<span class="line-modified">!     m_stubInfo-&gt;slowPathCallLocation = slowPath.locationOf&lt;JSInternalPtrTag&gt;(m_slowPathCall);</span>
<span class="line-modified">!     m_stubInfo-&gt;slowPathStartLocation = slowPath.locationOf&lt;JITStubRoutinePtrTag&gt;(m_slowPathBegin);</span>
  }
  
  JITByIdGenerator::JITByIdGenerator(
      CodeBlock* codeBlock, CodeOrigin codeOrigin, CallSiteIndex callSite, AccessType accessType,
      const RegisterSet&amp; usedRegisters, JSValueRegs base, JSValueRegs value)
      : JITInlineCacheGenerator(codeBlock, codeOrigin, callSite, accessType, usedRegisters)
      , m_base(base)
      , m_value(value)
  {
<span class="line-modified">!     m_stubInfo-&gt;baseGPR = base.payloadGPR();</span>
<span class="line-modified">!     m_stubInfo-&gt;valueGPR = value.payloadGPR();</span>
<span class="line-modified">!     m_stubInfo-&gt;regs.thisGPR = InvalidGPRReg;</span>
  #if USE(JSVALUE32_64)
<span class="line-modified">!     m_stubInfo-&gt;baseTagGPR = base.tagGPR();</span>
<span class="line-modified">!     m_stubInfo-&gt;valueTagGPR = value.tagGPR();</span>
<span class="line-modified">!     m_stubInfo-&gt;v.thisTagGPR = InvalidGPRReg;</span>
  #endif
  }
  
  void JITByIdGenerator::finalize(LinkBuffer&amp; fastPath, LinkBuffer&amp; slowPath)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 115,18 ***</span>
      generateFastCommon(jit, m_isLengthAccess ? InlineAccess::sizeForLengthAccess() : InlineAccess::sizeForPropertyAccess());
  }
  
  JITGetByIdWithThisGenerator::JITGetByIdWithThisGenerator(
      CodeBlock* codeBlock, CodeOrigin codeOrigin, CallSiteIndex callSite, const RegisterSet&amp; usedRegisters,
<span class="line-modified">!     UniquedStringImpl*, JSValueRegs value, JSValueRegs base, JSValueRegs thisRegs, AccessType accessType)</span>
<span class="line-modified">!     : JITByIdGenerator(codeBlock, codeOrigin, callSite, accessType, usedRegisters, base, value)</span>
  {
      RELEASE_ASSERT(thisRegs.payloadGPR() != thisRegs.tagGPR());
  
<span class="line-modified">!     m_stubInfo-&gt;patch.thisGPR = thisRegs.payloadGPR();</span>
  #if USE(JSVALUE32_64)
<span class="line-modified">!     m_stubInfo-&gt;patch.thisTagGPR = thisRegs.tagGPR();</span>
  #endif
  }
  
  void JITGetByIdWithThisGenerator::generateFastPath(MacroAssembler&amp; jit)
  {
<span class="line-new-header">--- 115,18 ---</span>
      generateFastCommon(jit, m_isLengthAccess ? InlineAccess::sizeForLengthAccess() : InlineAccess::sizeForPropertyAccess());
  }
  
  JITGetByIdWithThisGenerator::JITGetByIdWithThisGenerator(
      CodeBlock* codeBlock, CodeOrigin codeOrigin, CallSiteIndex callSite, const RegisterSet&amp; usedRegisters,
<span class="line-modified">!     UniquedStringImpl*, JSValueRegs value, JSValueRegs base, JSValueRegs thisRegs)</span>
<span class="line-modified">!     : JITByIdGenerator(codeBlock, codeOrigin, callSite, AccessType::GetByIdWithThis, usedRegisters, base, value)</span>
  {
      RELEASE_ASSERT(thisRegs.payloadGPR() != thisRegs.tagGPR());
  
<span class="line-modified">!     m_stubInfo-&gt;regs.thisGPR = thisRegs.payloadGPR();</span>
  #if USE(JSVALUE32_64)
<span class="line-modified">!     m_stubInfo-&gt;v.thisTagGPR = thisRegs.tagGPR();</span>
  #endif
  }
  
  void JITGetByIdWithThisGenerator::generateFastPath(MacroAssembler&amp; jit)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 140,19 ***</span>
      : JITByIdGenerator(
          codeBlock, codeOrigin, callSite, AccessType::Put, usedRegisters, base, value)
      , m_ecmaMode(ecmaMode)
      , m_putKind(putKind)
  {
<span class="line-modified">!     m_stubInfo-&gt;patch.usedRegisters.clear(scratch);</span>
  }
  
  void JITPutByIdGenerator::generateFastPath(MacroAssembler&amp; jit)
  {
      generateFastCommon(jit, InlineAccess::sizeForPropertyReplace());
  }
  
<span class="line-modified">! V_JITOperation_ESsiJJI JITPutByIdGenerator::slowPathFunction()</span>
  {
      if (m_ecmaMode == StrictMode) {
          if (m_putKind == Direct)
              return operationPutByIdDirectStrictOptimize;
          return operationPutByIdStrictOptimize;
<span class="line-new-header">--- 140,19 ---</span>
      : JITByIdGenerator(
          codeBlock, codeOrigin, callSite, AccessType::Put, usedRegisters, base, value)
      , m_ecmaMode(ecmaMode)
      , m_putKind(putKind)
  {
<span class="line-modified">!     m_stubInfo-&gt;usedRegisters.clear(scratch);</span>
  }
  
  void JITPutByIdGenerator::generateFastPath(MacroAssembler&amp; jit)
  {
      generateFastCommon(jit, InlineAccess::sizeForPropertyReplace());
  }
  
<span class="line-modified">! V_JITOperation_GSsiJJI JITPutByIdGenerator::slowPathFunction()</span>
  {
      if (m_ecmaMode == StrictMode) {
          if (m_putKind == Direct)
              return operationPutByIdDirectStrictOptimize;
          return operationPutByIdStrictOptimize;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 182,26 ***</span>
      const RegisterSet&amp; usedRegisters, GPRReg result, GPRReg value, GPRReg prototype,
      GPRReg scratch1, GPRReg scratch2, bool prototypeIsKnownObject)
      : JITInlineCacheGenerator(
          codeBlock, codeOrigin, callSiteIndex, AccessType::InstanceOf, usedRegisters)
  {
<span class="line-modified">!     m_stubInfo-&gt;patch.baseGPR = value;</span>
<span class="line-modified">!     m_stubInfo-&gt;patch.valueGPR = result;</span>
<span class="line-modified">!     m_stubInfo-&gt;patch.thisGPR = prototype;</span>
  #if USE(JSVALUE32_64)
<span class="line-modified">!     m_stubInfo-&gt;patch.baseTagGPR = InvalidGPRReg;</span>
<span class="line-modified">!     m_stubInfo-&gt;patch.valueTagGPR = InvalidGPRReg;</span>
<span class="line-modified">!     m_stubInfo-&gt;patch.thisTagGPR = InvalidGPRReg;</span>
  #endif
  
<span class="line-modified">!     m_stubInfo-&gt;patch.usedRegisters.clear(result);</span>
      if (scratch1 != InvalidGPRReg)
<span class="line-modified">!         m_stubInfo-&gt;patch.usedRegisters.clear(scratch1);</span>
      if (scratch2 != InvalidGPRReg)
<span class="line-modified">!         m_stubInfo-&gt;patch.usedRegisters.clear(scratch2);</span>
  
      m_stubInfo-&gt;prototypeIsKnownObject = prototypeIsKnownObject;
  }
  
  void JITInstanceOfGenerator::generateFastPath(MacroAssembler&amp; jit)
  {
      m_jump = jit.patchableJump();
<span class="line-new-header">--- 182,28 ---</span>
      const RegisterSet&amp; usedRegisters, GPRReg result, GPRReg value, GPRReg prototype,
      GPRReg scratch1, GPRReg scratch2, bool prototypeIsKnownObject)
      : JITInlineCacheGenerator(
          codeBlock, codeOrigin, callSiteIndex, AccessType::InstanceOf, usedRegisters)
  {
<span class="line-modified">!     m_stubInfo-&gt;baseGPR = value;</span>
<span class="line-modified">!     m_stubInfo-&gt;valueGPR = result;</span>
<span class="line-modified">!     m_stubInfo-&gt;regs.prototypeGPR = prototype;</span>
  #if USE(JSVALUE32_64)
<span class="line-modified">!     m_stubInfo-&gt;baseTagGPR = InvalidGPRReg;</span>
<span class="line-modified">!     m_stubInfo-&gt;valueTagGPR = InvalidGPRReg;</span>
<span class="line-modified">!     m_stubInfo-&gt;v.thisTagGPR = InvalidGPRReg;</span>
  #endif
  
<span class="line-modified">!     m_stubInfo-&gt;usedRegisters.clear(result);</span>
      if (scratch1 != InvalidGPRReg)
<span class="line-modified">!         m_stubInfo-&gt;usedRegisters.clear(scratch1);</span>
      if (scratch2 != InvalidGPRReg)
<span class="line-modified">!         m_stubInfo-&gt;usedRegisters.clear(scratch2);</span>
  
      m_stubInfo-&gt;prototypeIsKnownObject = prototypeIsKnownObject;
<span class="line-added">+ </span>
<span class="line-added">+     m_stubInfo-&gt;hasConstantIdentifier = false;</span>
  }
  
  void JITInstanceOfGenerator::generateFastPath(MacroAssembler&amp; jit)
  {
      m_jump = jit.patchableJump();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 215,9 ***</span>
<span class="line-new-header">--- 217,41 ---</span>
          fastPath.locationOf&lt;JITStubRoutinePtrTag&gt;(m_jump));
  
      fastPath.link(m_jump.m_jump, slowPath.locationOf&lt;NoPtrTag&gt;(m_slowPathBegin));
  }
  
<span class="line-added">+ JITGetByValGenerator::JITGetByValGenerator(CodeBlock* codeBlock, CodeOrigin codeOrigin, CallSiteIndex callSiteIndex, const RegisterSet&amp; usedRegisters, JSValueRegs base, JSValueRegs property, JSValueRegs result)</span>
<span class="line-added">+     : Base(codeBlock, codeOrigin, callSiteIndex, AccessType::GetByVal, usedRegisters)</span>
<span class="line-added">+     , m_base(base)</span>
<span class="line-added">+     , m_result(result)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     m_stubInfo-&gt;hasConstantIdentifier = false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     m_stubInfo-&gt;baseGPR = base.payloadGPR();</span>
<span class="line-added">+     m_stubInfo-&gt;regs.propertyGPR = property.payloadGPR();</span>
<span class="line-added">+     m_stubInfo-&gt;valueGPR = result.payloadGPR();</span>
<span class="line-added">+ #if USE(JSVALUE32_64)</span>
<span class="line-added">+     m_stubInfo-&gt;baseTagGPR = base.tagGPR();</span>
<span class="line-added">+     m_stubInfo-&gt;valueTagGPR = result.tagGPR();</span>
<span class="line-added">+     m_stubInfo-&gt;v.propertyTagGPR = property.tagGPR();</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void JITGetByValGenerator::generateFastPath(MacroAssembler&amp; jit)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     m_start = jit.label();</span>
<span class="line-added">+     m_slowPathJump = jit.patchableJump();</span>
<span class="line-added">+     m_done = jit.label();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void JITGetByValGenerator::finalize(</span>
<span class="line-added">+     LinkBuffer&amp; fastPath, LinkBuffer&amp; slowPath)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     ASSERT(m_start.isSet());</span>
<span class="line-added">+     Base::finalize(</span>
<span class="line-added">+         fastPath, slowPath, fastPath.locationOf&lt;JITStubRoutinePtrTag&gt;(m_start));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  } // namespace JSC
  
  #endif // ENABLE(JIT)
  
</pre>
<center><a href="JITExceptions.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JITInlineCacheGenerator.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>