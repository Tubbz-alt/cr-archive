<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/css/CSSPrimitiveValue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CSSNamedImageValue.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CSSPrimitiveValue.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/css/CSSPrimitiveValue.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  20 
  21 #include &quot;config.h&quot;
  22 #include &quot;CSSPrimitiveValue.h&quot;
  23 
  24 #include &quot;CSSBasicShapes.h&quot;
  25 #include &quot;CSSCalculationValue.h&quot;
  26 #include &quot;CSSFontFamily.h&quot;
  27 #include &quot;CSSHelper.h&quot;
  28 #include &quot;CSSMarkup.h&quot;
  29 #include &quot;CSSPrimitiveValueMappings.h&quot;
  30 #include &quot;CSSPropertyNames.h&quot;
  31 #include &quot;CSSToLengthConversionData.h&quot;
  32 #include &quot;CSSValueKeywords.h&quot;
  33 #include &quot;CalculationValue.h&quot;
  34 #include &quot;Color.h&quot;
  35 #include &quot;Counter.h&quot;
  36 #include &quot;DeprecatedCSSOMPrimitiveValue.h&quot;
  37 #include &quot;FontCascade.h&quot;
  38 #include &quot;Node.h&quot;
  39 #include &quot;Pair.h&quot;
<span class="line-removed">  40 #include &quot;RGBColor.h&quot;</span>
  41 #include &quot;Rect.h&quot;
  42 #include &quot;RenderStyle.h&quot;
  43 #include &lt;wtf/NeverDestroyed.h&gt;
  44 #include &lt;wtf/StdLibExtras.h&gt;
  45 #include &lt;wtf/text/StringBuilder.h&gt;
  46 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  47 
  48 namespace WebCore {
  49 
<span class="line-modified">  50 static inline bool isValidCSSUnitTypeForDoubleConversion(CSSPrimitiveValue::UnitType unitType)</span>
  51 {
  52     switch (unitType) {
<span class="line-modified">  53     case CSSPrimitiveValue::CSS_CALC:</span>
<span class="line-modified">  54     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified">  55     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified">  56     case CSSPrimitiveValue::CSS_CHS:</span>
<span class="line-modified">  57     case CSSPrimitiveValue::CSS_CM:</span>
<span class="line-modified">  58     case CSSPrimitiveValue::CSS_DEG:</span>
<span class="line-modified">  59     case CSSPrimitiveValue::CSS_DIMENSION:</span>
<span class="line-modified">  60     case CSSPrimitiveValue::CSS_EMS:</span>
<span class="line-modified">  61     case CSSPrimitiveValue::CSS_QUIRKY_EMS:</span>
<span class="line-modified">  62     case CSSPrimitiveValue::CSS_EXS:</span>
<span class="line-modified">  63     case CSSPrimitiveValue::CSS_FR:</span>
<span class="line-modified">  64     case CSSPrimitiveValue::CSS_GRAD:</span>
<span class="line-modified">  65     case CSSPrimitiveValue::CSS_HZ:</span>
<span class="line-modified">  66     case CSSPrimitiveValue::CSS_IN:</span>
<span class="line-modified">  67     case CSSPrimitiveValue::CSS_KHZ:</span>
<span class="line-modified">  68     case CSSPrimitiveValue::CSS_MM:</span>
<span class="line-modified">  69     case CSSPrimitiveValue::CSS_MS:</span>
<span class="line-modified">  70     case CSSPrimitiveValue::CSS_NUMBER:</span>
<span class="line-modified">  71     case CSSPrimitiveValue::CSS_PC:</span>
<span class="line-modified">  72     case CSSPrimitiveValue::CSS_PERCENTAGE:</span>
<span class="line-modified">  73     case CSSPrimitiveValue::CSS_PT:</span>
<span class="line-modified">  74     case CSSPrimitiveValue::CSS_PX:</span>
<span class="line-modified">  75     case CSSPrimitiveValue::CSS_RAD:</span>
<span class="line-modified">  76     case CSSPrimitiveValue::CSS_REMS:</span>
<span class="line-modified">  77     case CSSPrimitiveValue::CSS_S:</span>
<span class="line-modified">  78     case CSSPrimitiveValue::CSS_TURN:</span>
<span class="line-modified">  79     case CSSPrimitiveValue::CSS_VH:</span>
<span class="line-modified">  80     case CSSPrimitiveValue::CSS_VMAX:</span>
<span class="line-modified">  81     case CSSPrimitiveValue::CSS_VMIN:</span>
<span class="line-modified">  82     case CSSPrimitiveValue::CSS_VW:</span>




  83         return true;
<span class="line-modified">  84     case CSSPrimitiveValue::CSS_DPCM:</span>
<span class="line-modified">  85     case CSSPrimitiveValue::CSS_DPI:</span>
<span class="line-modified">  86     case CSSPrimitiveValue::CSS_DPPX:</span>
<span class="line-modified">  87 #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-modified">  88         return true;</span>
<span class="line-modified">  89 #else</span>
<span class="line-modified">  90         return false;</span>
<span class="line-modified">  91 #endif</span>
<span class="line-modified">  92     case CSSPrimitiveValue::CSS_ATTR:</span>
<span class="line-modified">  93     case CSSPrimitiveValue::CSS_COUNTER:</span>
<span class="line-modified">  94     case CSSPrimitiveValue::CSS_COUNTER_NAME:</span>
<span class="line-modified">  95     case CSSPrimitiveValue::CSS_FONT_FAMILY:</span>
<span class="line-modified">  96     case CSSPrimitiveValue::CSS_IDENT:</span>
<span class="line-modified">  97     case CSSPrimitiveValue::CSS_PAIR:</span>
<span class="line-modified">  98     case CSSPrimitiveValue::CSS_PROPERTY_ID:</span>
<span class="line-modified">  99     case CSSPrimitiveValue::CSS_QUAD:</span>
<span class="line-removed"> 100     case CSSPrimitiveValue::CSS_RECT:</span>
<span class="line-removed"> 101     case CSSPrimitiveValue::CSS_RGBCOLOR:</span>
<span class="line-removed"> 102     case CSSPrimitiveValue::CSS_SHAPE:</span>
<span class="line-removed"> 103     case CSSPrimitiveValue::CSS_STRING:</span>
<span class="line-removed"> 104     case CSSPrimitiveValue::CSS_UNICODE_RANGE:</span>
<span class="line-removed"> 105     case CSSPrimitiveValue::CSS_UNKNOWN:</span>
<span class="line-removed"> 106     case CSSPrimitiveValue::CSS_URI:</span>
<span class="line-removed"> 107     case CSSPrimitiveValue::CSS_VALUE_ID:</span>
 108         return false;
 109     }
 110 
 111     ASSERT_NOT_REACHED();
 112     return false;
 113 }
 114 
<span class="line-modified"> 115 #if !ASSERT_DISABLED</span>
 116 
<span class="line-modified"> 117 static inline bool isStringType(CSSPrimitiveValue::UnitType type)</span>
 118 {
 119     switch (type) {
<span class="line-modified"> 120     case CSSPrimitiveValue::CSS_STRING:</span>
<span class="line-modified"> 121     case CSSPrimitiveValue::CSS_URI:</span>
<span class="line-modified"> 122     case CSSPrimitiveValue::CSS_ATTR:</span>
<span class="line-modified"> 123     case CSSPrimitiveValue::CSS_COUNTER_NAME:</span>
<span class="line-modified"> 124     case CSSPrimitiveValue::CSS_DIMENSION:</span>
 125         return true;
<span class="line-modified"> 126     case CSSPrimitiveValue::CSS_CALC:</span>
<span class="line-modified"> 127     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified"> 128     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified"> 129     case CSSPrimitiveValue::CSS_CHS:</span>
<span class="line-modified"> 130     case CSSPrimitiveValue::CSS_CM:</span>
<span class="line-modified"> 131     case CSSPrimitiveValue::CSS_COUNTER:</span>
<span class="line-modified"> 132     case CSSPrimitiveValue::CSS_DEG:</span>
<span class="line-modified"> 133     case CSSPrimitiveValue::CSS_DPCM:</span>
<span class="line-modified"> 134     case CSSPrimitiveValue::CSS_DPI:</span>
<span class="line-modified"> 135     case CSSPrimitiveValue::CSS_DPPX:</span>
<span class="line-modified"> 136     case CSSPrimitiveValue::CSS_EMS:</span>
<span class="line-modified"> 137     case CSSPrimitiveValue::CSS_QUIRKY_EMS:</span>
<span class="line-modified"> 138     case CSSPrimitiveValue::CSS_EXS:</span>
<span class="line-modified"> 139     case CSSPrimitiveValue::CSS_FONT_FAMILY:</span>
<span class="line-modified"> 140     case CSSPrimitiveValue::CSS_FR:</span>
<span class="line-modified"> 141     case CSSPrimitiveValue::CSS_GRAD:</span>
<span class="line-modified"> 142     case CSSPrimitiveValue::CSS_HZ:</span>
<span class="line-modified"> 143     case CSSPrimitiveValue::CSS_IDENT:</span>
<span class="line-modified"> 144     case CSSPrimitiveValue::CSS_IN:</span>
<span class="line-modified"> 145     case CSSPrimitiveValue::CSS_KHZ:</span>
<span class="line-modified"> 146     case CSSPrimitiveValue::CSS_MM:</span>
<span class="line-modified"> 147     case CSSPrimitiveValue::CSS_MS:</span>
<span class="line-modified"> 148     case CSSPrimitiveValue::CSS_NUMBER:</span>
<span class="line-modified"> 149     case CSSPrimitiveValue::CSS_PAIR:</span>
<span class="line-modified"> 150     case CSSPrimitiveValue::CSS_PC:</span>
<span class="line-modified"> 151     case CSSPrimitiveValue::CSS_PERCENTAGE:</span>
<span class="line-modified"> 152     case CSSPrimitiveValue::CSS_PROPERTY_ID:</span>
<span class="line-modified"> 153     case CSSPrimitiveValue::CSS_PT:</span>
<span class="line-modified"> 154     case CSSPrimitiveValue::CSS_PX:</span>
<span class="line-modified"> 155     case CSSPrimitiveValue::CSS_QUAD:</span>
<span class="line-modified"> 156     case CSSPrimitiveValue::CSS_RAD:</span>
<span class="line-modified"> 157     case CSSPrimitiveValue::CSS_RECT:</span>
<span class="line-modified"> 158     case CSSPrimitiveValue::CSS_REMS:</span>
<span class="line-modified"> 159     case CSSPrimitiveValue::CSS_RGBCOLOR:</span>
<span class="line-modified"> 160     case CSSPrimitiveValue::CSS_S:</span>
<span class="line-modified"> 161     case CSSPrimitiveValue::CSS_SHAPE:</span>
<span class="line-modified"> 162     case CSSPrimitiveValue::CSS_TURN:</span>
<span class="line-modified"> 163     case CSSPrimitiveValue::CSS_UNICODE_RANGE:</span>
<span class="line-modified"> 164     case CSSPrimitiveValue::CSS_UNKNOWN:</span>
<span class="line-modified"> 165     case CSSPrimitiveValue::CSS_VALUE_ID:</span>
<span class="line-modified"> 166     case CSSPrimitiveValue::CSS_VH:</span>
<span class="line-modified"> 167     case CSSPrimitiveValue::CSS_VMAX:</span>
<span class="line-modified"> 168     case CSSPrimitiveValue::CSS_VMIN:</span>
<span class="line-modified"> 169     case CSSPrimitiveValue::CSS_VW:</span>

 170         return false;
 171     }
 172 
 173     ASSERT_NOT_REACHED();
 174     return false;
 175 }
 176 
<span class="line-modified"> 177 #endif // !ASSERT_DISABLED</span>
<span class="line-removed"> 178 </span>
<span class="line-removed"> 179 CSSPrimitiveValue::UnitCategory CSSPrimitiveValue::unitCategory(CSSPrimitiveValue::UnitType type)</span>
<span class="line-removed"> 180 {</span>
<span class="line-removed"> 181     // Here we violate the spec (http://www.w3.org/TR/DOM-Level-2-Style/css.html#CSS-CSSPrimitiveValue) and allow conversions</span>
<span class="line-removed"> 182     // between CSS_PX and relative lengths (see cssPixelsPerInch comment in CSSHelper.h for the topic treatment).</span>
<span class="line-removed"> 183     switch (type) {</span>
<span class="line-removed"> 184     case CSS_NUMBER:</span>
<span class="line-removed"> 185         return UNumber;</span>
<span class="line-removed"> 186     case CSS_PERCENTAGE:</span>
<span class="line-removed"> 187         return UPercent;</span>
<span class="line-removed"> 188     case CSS_PX:</span>
<span class="line-removed"> 189     case CSS_CM:</span>
<span class="line-removed"> 190     case CSS_MM:</span>
<span class="line-removed"> 191     case CSS_IN:</span>
<span class="line-removed"> 192     case CSS_PT:</span>
<span class="line-removed"> 193     case CSS_PC:</span>
<span class="line-removed"> 194         return ULength;</span>
<span class="line-removed"> 195     case CSS_MS:</span>
<span class="line-removed"> 196     case CSS_S:</span>
<span class="line-removed"> 197         return UTime;</span>
<span class="line-removed"> 198     case CSS_DEG:</span>
<span class="line-removed"> 199     case CSS_RAD:</span>
<span class="line-removed"> 200     case CSS_GRAD:</span>
<span class="line-removed"> 201     case CSS_TURN:</span>
<span class="line-removed"> 202         return UAngle;</span>
<span class="line-removed"> 203     case CSS_HZ:</span>
<span class="line-removed"> 204     case CSS_KHZ:</span>
<span class="line-removed"> 205         return UFrequency;</span>
<span class="line-removed"> 206 #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-removed"> 207     case CSS_DPPX:</span>
<span class="line-removed"> 208     case CSS_DPI:</span>
<span class="line-removed"> 209     case CSS_DPCM:</span>
<span class="line-removed"> 210         return UResolution;</span>
<span class="line-removed"> 211 #endif</span>
<span class="line-removed"> 212     default:</span>
<span class="line-removed"> 213         return UOther;</span>
<span class="line-removed"> 214     }</span>
<span class="line-removed"> 215 }</span>
 216 
 217 typedef HashMap&lt;const CSSPrimitiveValue*, String&gt; CSSTextCache;
 218 static CSSTextCache&amp; cssTextCache()
 219 {
 220     static NeverDestroyed&lt;CSSTextCache&gt; cache;
 221     return cache;
 222 }
 223 
<span class="line-modified"> 224 unsigned short CSSPrimitiveValue::primitiveType() const</span>
 225 {
<span class="line-modified"> 226     if (m_primitiveUnitType == CSS_PROPERTY_ID || m_primitiveUnitType == CSS_VALUE_ID)</span>
<span class="line-modified"> 227         return CSS_IDENT;</span>
 228 
<span class="line-modified"> 229     // Web-exposed content expects font family values to have CSS_STRING primitive type</span>
<span class="line-modified"> 230     // so we need to map our internal CSS_FONT_FAMILY type here.</span>
<span class="line-modified"> 231     if (m_primitiveUnitType == CSS_FONT_FAMILY)</span>
<span class="line-modified"> 232         return CSS_STRING;</span>
 233 
<span class="line-modified"> 234     if (m_primitiveUnitType != CSSPrimitiveValue::CSS_CALC)</span>
<span class="line-modified"> 235         return m_primitiveUnitType;</span>
 236 
 237     switch (m_value.calc-&gt;category()) {
 238     case CalculationCategory::Number:
<span class="line-modified"> 239         return CSSPrimitiveValue::CSS_NUMBER;</span>
<span class="line-removed"> 240     case CalculationCategory::Length:</span>
<span class="line-removed"> 241         return CSSPrimitiveValue::CSS_PX;</span>
 242     case CalculationCategory::Percent:
<span class="line-modified"> 243         return CSSPrimitiveValue::CSS_PERCENTAGE;</span>
 244     case CalculationCategory::PercentNumber:
<span class="line-modified"> 245         return CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_NUMBER;</span>
 246     case CalculationCategory::PercentLength:
<span class="line-modified"> 247         return CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_LENGTH;</span>

 248     case CalculationCategory::Angle:
 249     case CalculationCategory::Time:
 250     case CalculationCategory::Frequency:
 251         return m_value.calc-&gt;primitiveType();
 252     case CalculationCategory::Other:
<span class="line-modified"> 253         return CSSPrimitiveValue::CSS_UNKNOWN;</span>
 254     }
<span class="line-modified"> 255     return CSSPrimitiveValue::CSS_UNKNOWN;</span>
 256 }
 257 
 258 static const AtomString&amp; propertyName(CSSPropertyID propertyID)
 259 {
 260     ASSERT_ARG(propertyID, (propertyID &gt;= firstCSSProperty &amp;&amp; propertyID &lt; firstCSSProperty + numCSSProperties));
 261 
 262     return getPropertyNameAtomString(propertyID);
 263 }
 264 
 265 static const AtomString&amp; valueName(CSSValueID valueID)
 266 {
 267     ASSERT_ARG(valueID, (valueID &gt;= firstCSSValueKeyword &amp;&amp; valueID &lt;= lastCSSValueKeyword));
 268 
 269     return getValueNameAtomString(valueID);
 270 }
 271 
 272 CSSPrimitiveValue::CSSPrimitiveValue(CSSValueID valueID)
 273     : CSSValue(PrimitiveClass)
 274 {
<span class="line-modified"> 275     m_primitiveUnitType = CSS_VALUE_ID;</span>
 276     m_value.valueID = valueID;
 277 }
 278 
 279 CSSPrimitiveValue::CSSPrimitiveValue(CSSPropertyID propertyID)
 280     : CSSValue(PrimitiveClass)
 281 {
<span class="line-modified"> 282     m_primitiveUnitType = CSS_PROPERTY_ID;</span>
 283     m_value.propertyID = propertyID;
 284 }
 285 
<span class="line-modified"> 286 CSSPrimitiveValue::CSSPrimitiveValue(double num, UnitType type)</span>
 287     : CSSValue(PrimitiveClass)
 288 {
<span class="line-modified"> 289     m_primitiveUnitType = type;</span>
 290     ASSERT(std::isfinite(num));
 291     m_value.num = num;
 292 }
 293 
<span class="line-modified"> 294 CSSPrimitiveValue::CSSPrimitiveValue(const String&amp; string, UnitType type)</span>
 295     : CSSValue(PrimitiveClass)
 296 {
 297     ASSERT(isStringType(type));
<span class="line-modified"> 298     m_primitiveUnitType = type;</span>
 299     if ((m_value.string = string.impl()))
 300         m_value.string-&gt;ref();
 301 }
 302 
 303 CSSPrimitiveValue::CSSPrimitiveValue(const Color&amp; color)
 304     : CSSValue(PrimitiveClass)
 305 {
<span class="line-modified"> 306     m_primitiveUnitType = CSS_RGBCOLOR;</span>
 307     m_value.color = new Color(color);
 308 }
 309 
 310 CSSPrimitiveValue::CSSPrimitiveValue(const Length&amp; length)
 311     : CSSValue(PrimitiveClass)
 312 {
 313     init(length);
 314 }
 315 
 316 CSSPrimitiveValue::CSSPrimitiveValue(const Length&amp; length, const RenderStyle&amp; style)
 317     : CSSValue(PrimitiveClass)
 318 {
 319     switch (length.type()) {
 320     case Auto:
 321     case Intrinsic:
 322     case MinIntrinsic:
 323     case MinContent:
 324     case MaxContent:
 325     case FillAvailable:
 326     case FitContent:
 327     case Percent:
 328         init(length);
 329         return;
 330     case Fixed:
<span class="line-modified"> 331         m_primitiveUnitType = CSS_PX;</span>
 332         m_value.num = adjustFloatForAbsoluteZoom(length.value(), style);
 333         return;
 334     case Calculated: {
 335         init(CSSCalcValue::create(length.calculationValue(), style));
 336         return;
 337     }
 338     case Relative:
 339     case Undefined:
 340         ASSERT_NOT_REACHED();
 341         return;
 342     }
 343     ASSERT_NOT_REACHED();
 344 }
 345 
 346 CSSPrimitiveValue::CSSPrimitiveValue(const LengthSize&amp; lengthSize, const RenderStyle&amp; style)
 347     : CSSValue(PrimitiveClass)
 348 {
 349     init(lengthSize, style);
 350 }
 351 


















 352 void CSSPrimitiveValue::init(const Length&amp; length)
 353 {
 354     switch (length.type()) {
 355     case Auto:
<span class="line-modified"> 356         m_primitiveUnitType = CSS_VALUE_ID;</span>
 357         m_value.valueID = CSSValueAuto;
 358         return;
 359     case WebCore::Fixed:
<span class="line-modified"> 360         m_primitiveUnitType = CSS_PX;</span>
 361         m_value.num = length.value();
 362         return;
 363     case Intrinsic:
<span class="line-modified"> 364         m_primitiveUnitType = CSS_VALUE_ID;</span>
 365         m_value.valueID = CSSValueIntrinsic;
 366         return;
 367     case MinIntrinsic:
<span class="line-modified"> 368         m_primitiveUnitType = CSS_VALUE_ID;</span>
 369         m_value.valueID = CSSValueMinIntrinsic;
 370         return;
 371     case MinContent:
<span class="line-modified"> 372         m_primitiveUnitType = CSS_VALUE_ID;</span>
 373         m_value.valueID = CSSValueMinContent;
 374         return;
 375     case MaxContent:
<span class="line-modified"> 376         m_primitiveUnitType = CSS_VALUE_ID;</span>
 377         m_value.valueID = CSSValueMaxContent;
 378         return;
 379     case FillAvailable:
<span class="line-modified"> 380         m_primitiveUnitType = CSS_VALUE_ID;</span>
 381         m_value.valueID = CSSValueWebkitFillAvailable;
 382         return;
 383     case FitContent:
<span class="line-modified"> 384         m_primitiveUnitType = CSS_VALUE_ID;</span>
 385         m_value.valueID = CSSValueFitContent;
 386         return;
 387     case Percent:
<span class="line-modified"> 388         m_primitiveUnitType = CSS_PERCENTAGE;</span>
 389         ASSERT(std::isfinite(length.percent()));
 390         m_value.num = length.percent();
 391         return;
 392     case Calculated:
 393     case Relative:
 394     case Undefined:
 395         ASSERT_NOT_REACHED();
 396         return;
 397     }
 398     ASSERT_NOT_REACHED();
 399 }
 400 
 401 void CSSPrimitiveValue::init(const LengthSize&amp; lengthSize, const RenderStyle&amp; style)
 402 {
<span class="line-modified"> 403     m_primitiveUnitType = CSS_PAIR;</span>
 404     m_hasCachedCSSText = false;
 405     m_value.pair = &amp;Pair::create(create(lengthSize.width, style), create(lengthSize.height, style)).leakRef();
 406 }
 407 
 408 void CSSPrimitiveValue::init(Ref&lt;Counter&gt;&amp;&amp; counter)
 409 {
<span class="line-modified"> 410     m_primitiveUnitType = CSS_COUNTER;</span>
 411     m_hasCachedCSSText = false;
 412     m_value.counter = &amp;counter.leakRef();
 413 }
 414 
 415 void CSSPrimitiveValue::init(Ref&lt;Rect&gt;&amp;&amp; r)
 416 {
<span class="line-modified"> 417     m_primitiveUnitType = CSS_RECT;</span>
 418     m_hasCachedCSSText = false;
 419     m_value.rect = &amp;r.leakRef();
 420 }
 421 
 422 void CSSPrimitiveValue::init(Ref&lt;Quad&gt;&amp;&amp; quad)
 423 {
<span class="line-modified"> 424     m_primitiveUnitType = CSS_QUAD;</span>
 425     m_hasCachedCSSText = false;
 426     m_value.quad = &amp;quad.leakRef();
 427 }
 428 
 429 void CSSPrimitiveValue::init(Ref&lt;Pair&gt;&amp;&amp; p)
 430 {
<span class="line-modified"> 431     m_primitiveUnitType = CSS_PAIR;</span>
 432     m_hasCachedCSSText = false;
 433     m_value.pair = &amp;p.leakRef();
 434 }
 435 
 436 void CSSPrimitiveValue::init(Ref&lt;CSSBasicShape&gt;&amp;&amp; shape)
 437 {
<span class="line-modified"> 438     m_primitiveUnitType = CSS_SHAPE;</span>
 439     m_hasCachedCSSText = false;
 440     m_value.shape = &amp;shape.leakRef();
 441 }
 442 
 443 void CSSPrimitiveValue::init(RefPtr&lt;CSSCalcValue&gt;&amp;&amp; c)
 444 {
<span class="line-modified"> 445     m_primitiveUnitType = CSS_CALC;</span>
 446     m_hasCachedCSSText = false;
 447     m_value.calc = c.leakRef();
 448 }
 449 
 450 CSSPrimitiveValue::~CSSPrimitiveValue()
 451 {
 452     cleanup();
 453 }
 454 
 455 void CSSPrimitiveValue::cleanup()
 456 {
<span class="line-modified"> 457     auto type = static_cast&lt;UnitType&gt;(m_primitiveUnitType);</span>
 458     switch (type) {
<span class="line-modified"> 459     case CSS_STRING:</span>
<span class="line-modified"> 460     case CSS_URI:</span>
<span class="line-modified"> 461     case CSS_ATTR:</span>
<span class="line-modified"> 462     case CSS_COUNTER_NAME:</span>
 463         if (m_value.string)
 464             m_value.string-&gt;deref();
 465         break;
<span class="line-modified"> 466     case CSS_DIMENSION:</span>
<span class="line-modified"> 467     case CSS_COUNTER:</span>
 468         m_value.counter-&gt;deref();
 469         break;
<span class="line-modified"> 470     case CSS_RECT:</span>
 471         m_value.rect-&gt;deref();
 472         break;
<span class="line-modified"> 473     case CSS_QUAD:</span>
 474         m_value.quad-&gt;deref();
 475         break;
<span class="line-modified"> 476     case CSS_PAIR:</span>
 477         m_value.pair-&gt;deref();
 478         break;
<span class="line-modified"> 479     case CSS_CALC:</span>
 480         m_value.calc-&gt;deref();
 481         break;
<span class="line-modified"> 482     case CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified"> 483     case CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
 484         ASSERT_NOT_REACHED();
 485         break;
<span class="line-modified"> 486     case CSS_SHAPE:</span>
 487         m_value.shape-&gt;deref();
 488         break;
<span class="line-modified"> 489     case CSS_FONT_FAMILY:</span>
 490         ASSERT(m_value.fontFamily);
 491         delete m_value.fontFamily;
 492         m_value.fontFamily = nullptr;
 493         break;
<span class="line-modified"> 494     case CSS_RGBCOLOR:</span>
 495         ASSERT(m_value.color);
 496         delete m_value.color;
 497         m_value.color = nullptr;
 498         break;
<span class="line-modified"> 499     case CSS_NUMBER:</span>
<span class="line-modified"> 500     case CSS_PERCENTAGE:</span>
<span class="line-modified"> 501     case CSS_EMS:</span>
<span class="line-modified"> 502     case CSS_QUIRKY_EMS:</span>
<span class="line-modified"> 503     case CSS_EXS:</span>
<span class="line-modified"> 504     case CSS_REMS:</span>
<span class="line-modified"> 505     case CSS_CHS:</span>
<span class="line-modified"> 506     case CSS_PX:</span>
<span class="line-modified"> 507     case CSS_CM:</span>
<span class="line-modified"> 508     case CSS_MM:</span>
<span class="line-modified"> 509     case CSS_IN:</span>
<span class="line-modified"> 510     case CSS_PT:</span>
<span class="line-modified"> 511     case CSS_PC:</span>
<span class="line-modified"> 512     case CSS_DEG:</span>
<span class="line-modified"> 513     case CSS_RAD:</span>
<span class="line-modified"> 514     case CSS_GRAD:</span>
<span class="line-modified"> 515     case CSS_MS:</span>
<span class="line-modified"> 516     case CSS_S:</span>
<span class="line-modified"> 517     case CSS_HZ:</span>
<span class="line-modified"> 518     case CSS_KHZ:</span>
<span class="line-modified"> 519     case CSS_TURN:</span>
<span class="line-modified"> 520     case CSS_VW:</span>
<span class="line-modified"> 521     case CSS_VH:</span>
<span class="line-modified"> 522     case CSS_VMIN:</span>
<span class="line-modified"> 523     case CSS_VMAX:</span>
<span class="line-modified"> 524     case CSS_DPPX:</span>
<span class="line-modified"> 525     case CSS_DPI:</span>
<span class="line-modified"> 526     case CSS_DPCM:</span>
<span class="line-modified"> 527     case CSS_FR:</span>
<span class="line-modified"> 528     case CSS_IDENT:</span>
<span class="line-modified"> 529     case CSS_UNKNOWN:</span>
<span class="line-modified"> 530     case CSS_UNICODE_RANGE:</span>
<span class="line-modified"> 531     case CSS_PROPERTY_ID:</span>
<span class="line-modified"> 532     case CSS_VALUE_ID:</span>

 533         ASSERT(!isStringType(type));
 534         break;
 535     }
<span class="line-modified"> 536     m_primitiveUnitType = 0;</span>
 537     if (m_hasCachedCSSText) {
 538         cssTextCache().remove(this);
 539         m_hasCachedCSSText = false;
 540     }
 541 }
 542 
 543 double CSSPrimitiveValue::computeDegrees() const
 544 {
 545     switch (primitiveType()) {
<span class="line-modified"> 546     case CSS_DEG:</span>
 547         return doubleValue();
<span class="line-modified"> 548     case CSS_RAD:</span>
 549         return rad2deg(doubleValue());
<span class="line-modified"> 550     case CSS_GRAD:</span>
 551         return grad2deg(doubleValue());
<span class="line-modified"> 552     case CSS_TURN:</span>
 553         return turn2deg(doubleValue());
 554     default:
 555         ASSERT_NOT_REACHED();
 556         return 0;
 557     }
 558 }
 559 
 560 template&lt;&gt; int CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 561 {
 562     return roundForImpreciseConversion&lt;int&gt;(computeLengthDouble(conversionData));
 563 }
 564 
 565 template&lt;&gt; unsigned CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 566 {
 567     return roundForImpreciseConversion&lt;unsigned&gt;(computeLengthDouble(conversionData));
 568 }
 569 
 570 template&lt;&gt; Length CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 571 {
 572     return Length(clampTo&lt;float&gt;(computeLengthDouble(conversionData), minValueForCssLength, maxValueForCssLength), Fixed);
</pre>
<hr />
<pre>
 575 template&lt;&gt; short CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 576 {
 577     return roundForImpreciseConversion&lt;short&gt;(computeLengthDouble(conversionData));
 578 }
 579 
 580 template&lt;&gt; unsigned short CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 581 {
 582     return roundForImpreciseConversion&lt;unsigned short&gt;(computeLengthDouble(conversionData));
 583 }
 584 
 585 template&lt;&gt; float CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 586 {
 587     return static_cast&lt;float&gt;(computeLengthDouble(conversionData));
 588 }
 589 
 590 template&lt;&gt; double CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 591 {
 592     return computeLengthDouble(conversionData);
 593 }
 594 





 595 double CSSPrimitiveValue::computeLengthDouble(const CSSToLengthConversionData&amp; conversionData) const
 596 {
<span class="line-modified"> 597     if (m_primitiveUnitType == CSS_CALC)</span>
 598         // The multiplier and factor is applied to each value in the calc expression individually
 599         return m_value.calc-&gt;computeLengthPx(conversionData);

 600 
<span class="line-modified"> 601     return computeNonCalcLengthDouble(conversionData, static_cast&lt;UnitType&gt;(primitiveType()), m_value.num);</span>
 602 }
 603 
<span class="line-modified"> 604 double CSSPrimitiveValue::computeNonCalcLengthDouble(const CSSToLengthConversionData&amp; conversionData, UnitType primitiveType, double value)</span>




 605 {
 606     double factor;
 607     bool applyZoom = true;
 608 
 609     switch (primitiveType) {
<span class="line-modified"> 610     case CSS_EMS:</span>
<span class="line-modified"> 611     case CSS_QUIRKY_EMS:</span>
 612         ASSERT(conversionData.style());
 613         factor = conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize();
 614         break;
<span class="line-modified"> 615     case CSS_EXS:</span>
 616         ASSERT(conversionData.style());
 617         // FIXME: We have a bug right now where the zoom will be applied twice to EX units.
 618         // We really need to compute EX using fontMetrics for the original specifiedSize and not use
 619         // our actual constructed rendering font.
 620         if (conversionData.style()-&gt;fontMetrics().hasXHeight())
 621             factor = conversionData.style()-&gt;fontMetrics().xHeight();
 622         else
 623             factor = (conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize()) / 2.0;
 624         break;
<span class="line-modified"> 625     case CSS_REMS:</span>
 626         if (conversionData.rootStyle())
 627             factor = conversionData.computingFontSize() ? conversionData.rootStyle()-&gt;fontDescription().specifiedSize() : conversionData.rootStyle()-&gt;fontDescription().computedSize();
 628         else
 629             factor = 1.0;
 630         break;
<span class="line-modified"> 631     case CSS_CHS:</span>
 632         ASSERT(conversionData.style());
 633         factor = conversionData.style()-&gt;fontMetrics().zeroWidth();
 634         break;
<span class="line-modified"> 635     case CSS_PX:</span>
 636         factor = 1.0;
 637         break;
<span class="line-modified"> 638     case CSS_CM:</span>
<span class="line-modified"> 639         factor = cssPixelsPerInch / 2.54; // (2.54 cm/in)</span>



 640         break;
<span class="line-modified"> 641     case CSS_MM:</span>
<span class="line-modified"> 642         factor = cssPixelsPerInch / 25.4;</span>
 643         break;
<span class="line-modified"> 644     case CSS_IN:</span>
 645         factor = cssPixelsPerInch;
 646         break;
<span class="line-modified"> 647     case CSS_PT:</span>
 648         factor = cssPixelsPerInch / 72.0;
 649         break;
<span class="line-modified"> 650     case CSS_PC:</span>
 651         // 1 pc == 12 pt
 652         factor = cssPixelsPerInch * 12.0 / 72.0;
 653         break;
<span class="line-modified"> 654     case CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified"> 655     case CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
 656         ASSERT_NOT_REACHED();
 657         return -1.0;
<span class="line-modified"> 658     case CSS_VH:</span>
 659         factor = conversionData.viewportHeightFactor();
 660         applyZoom = false;
 661         break;
<span class="line-modified"> 662     case CSS_VW:</span>
 663         factor = conversionData.viewportWidthFactor();
 664         applyZoom = false;
 665         break;
<span class="line-modified"> 666     case CSS_VMAX:</span>
 667         factor = conversionData.viewportMaxFactor();
 668         applyZoom = false;
 669         break;
<span class="line-modified"> 670     case CSS_VMIN:</span>
 671         factor = conversionData.viewportMinFactor();
 672         applyZoom = false;
 673         break;
 674     default:
 675         ASSERT_NOT_REACHED();
 676         return -1.0;
 677     }
 678 
 679     // We do not apply the zoom factor when we are computing the value of the font-size property. The zooming
 680     // for font sizes is much more complicated, since we have to worry about enforcing the minimum font size preference
 681     // as well as enforcing the implicit &quot;smart minimum.&quot;
 682     double result = value * factor;
 683     if (conversionData.computingFontSize() || isFontRelativeLength(primitiveType))
 684         return result;
 685 
 686     if (applyZoom)
 687         result *= conversionData.zoom();
 688 
 689     return result;
 690 }
 691 
<span class="line-modified"> 692 ExceptionOr&lt;void&gt; CSSPrimitiveValue::setFloatValue(unsigned short, double)</span>



















 693 {
 694     // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
 695     // No other engine supports mutating style through this API. Computed style is always read-only anyway.
 696     // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
 697     return Exception { NoModificationAllowedError };
 698 }
 699 
<span class="line-modified"> 700 double CSSPrimitiveValue::conversionToCanonicalUnitsScaleFactor(UnitType unitType)</span>
 701 {
 702     double factor = 1.0;
 703     // FIXME: the switch can be replaced by an array of scale factors.
 704     switch (unitType) {
 705     // These are &quot;canonical&quot; units in their respective categories.
<span class="line-modified"> 706     case CSS_PX:</span>
<span class="line-modified"> 707     case CSS_DEG:</span>
<span class="line-modified"> 708     case CSS_MS:</span>
<span class="line-modified"> 709     case CSS_HZ:</span>




 710         break;
<span class="line-modified"> 711     case CSS_CM:</span>
<span class="line-modified"> 712         factor = cssPixelsPerInch / 2.54; // (2.54 cm/in)</span>
 713         break;
<span class="line-modified"> 714     case CSS_DPCM:</span>
<span class="line-modified"> 715         factor = 2.54 / cssPixelsPerInch; // (2.54 cm/in)</span>
 716         break;
<span class="line-modified"> 717     case CSS_MM:</span>
<span class="line-modified"> 718         factor = cssPixelsPerInch / 25.4;</span>
 719         break;
<span class="line-modified"> 720     case CSS_IN:</span>
 721         factor = cssPixelsPerInch;
 722         break;
<span class="line-modified"> 723     case CSS_DPI:</span>
 724         factor = 1 / cssPixelsPerInch;
 725         break;
<span class="line-modified"> 726     case CSS_PT:</span>
 727         factor = cssPixelsPerInch / 72.0;
 728         break;
<span class="line-modified"> 729     case CSS_PC:</span>
 730         factor = cssPixelsPerInch * 12.0 / 72.0; // 1 pc == 12 pt
 731         break;
<span class="line-modified"> 732     case CSS_RAD:</span>
 733         factor = 180 / piDouble;
 734         break;
<span class="line-modified"> 735     case CSS_GRAD:</span>
 736         factor = 0.9;
 737         break;
<span class="line-modified"> 738     case CSS_TURN:</span>
 739         factor = 360;
 740         break;
<span class="line-modified"> 741     case CSS_S:</span>
<span class="line-modified"> 742     case CSS_KHZ:</span>
 743         factor = 1000;
 744         break;
 745     default:
 746         break;
 747     }
 748 
 749     return factor;
 750 }
 751 
<span class="line-modified"> 752 ExceptionOr&lt;float&gt; CSSPrimitiveValue::getFloatValue(unsigned short unitType) const</span>
 753 {
<span class="line-modified"> 754     auto result = doubleValueInternal(static_cast&lt;UnitType&gt;(unitType));</span>
 755     if (!result)
 756         return Exception { InvalidAccessError };
 757     return clampTo&lt;float&gt;(result.value());
 758 }
 759 
<span class="line-modified"> 760 double CSSPrimitiveValue::doubleValue(UnitType unitType) const</span>
 761 {
 762     return doubleValueInternal(unitType).valueOr(0);
 763 }
 764 
 765 double CSSPrimitiveValue::doubleValue() const
 766 {
<span class="line-modified"> 767     return m_primitiveUnitType != CSS_CALC ? m_value.num : m_value.calc-&gt;doubleValue();</span>
 768 }
 769 






 770 
<span class="line-modified"> 771 CSSPrimitiveValue::UnitType CSSPrimitiveValue::canonicalUnitTypeForCategory(UnitCategory category)</span>
 772 {
<span class="line-modified"> 773     // The canonical unit type is chosen according to the way CSSParser::validUnit() chooses the default unit</span>
<span class="line-modified"> 774     // in each category (based on unitflags).</span>
<span class="line-modified"> 775     switch (category) {</span>
<span class="line-modified"> 776     case UNumber:</span>
<span class="line-modified"> 777         return CSS_NUMBER;</span>
<span class="line-modified"> 778     case ULength:</span>
<span class="line-modified"> 779         return CSS_PX;</span>
<span class="line-modified"> 780     case UPercent:</span>
<span class="line-modified"> 781         return CSS_UNKNOWN; // Cannot convert between numbers and percent.</span>
<span class="line-modified"> 782     case UTime:</span>
<span class="line-removed"> 783         return CSS_MS;</span>
<span class="line-removed"> 784     case UAngle:</span>
<span class="line-removed"> 785         return CSS_DEG;</span>
<span class="line-removed"> 786     case UFrequency:</span>
<span class="line-removed"> 787         return CSS_HZ;</span>
<span class="line-removed"> 788 #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-removed"> 789     case UResolution:</span>
<span class="line-removed"> 790         return CSS_DPPX;</span>
<span class="line-removed"> 791 #endif</span>
<span class="line-removed"> 792     default:</span>
<span class="line-removed"> 793         return CSS_UNKNOWN;</span>
<span class="line-removed"> 794     }</span>
 795 }
 796 
<span class="line-modified"> 797 Optional&lt;double&gt; CSSPrimitiveValue::doubleValueInternal(UnitType requestedUnitType) const</span>
 798 {
<span class="line-modified"> 799     if (!isValidCSSUnitTypeForDoubleConversion(static_cast&lt;UnitType&gt;(m_primitiveUnitType)) || !isValidCSSUnitTypeForDoubleConversion(requestedUnitType))</span>
 800         return WTF::nullopt;
 801 
<span class="line-modified"> 802     UnitType sourceUnitType = static_cast&lt;UnitType&gt;(primitiveType());</span>
<span class="line-modified"> 803     if (requestedUnitType == sourceUnitType || requestedUnitType == CSS_DIMENSION)</span>
 804         return doubleValue();
 805 
<span class="line-modified"> 806     UnitCategory sourceCategory = unitCategory(sourceUnitType);</span>
<span class="line-modified"> 807     ASSERT(sourceCategory != UOther);</span>
 808 
<span class="line-modified"> 809     UnitType targetUnitType = requestedUnitType;</span>
<span class="line-modified"> 810     UnitCategory targetCategory = unitCategory(targetUnitType);</span>
<span class="line-modified"> 811     ASSERT(targetCategory != UOther);</span>
 812 
<span class="line-modified"> 813     // Cannot convert between unrelated unit categories if one of them is not UNumber.</span>
<span class="line-modified"> 814     if (sourceCategory != targetCategory &amp;&amp; sourceCategory != UNumber &amp;&amp; targetCategory != UNumber)</span>
 815         return WTF::nullopt;
 816 
<span class="line-modified"> 817     if (targetCategory == UNumber) {</span>
<span class="line-modified"> 818         // We interpret conversion to CSS_NUMBER as conversion to a canonical unit in this value&#39;s category.</span>
 819         targetUnitType = canonicalUnitTypeForCategory(sourceCategory);
<span class="line-modified"> 820         if (targetUnitType == CSS_UNKNOWN)</span>
 821             return WTF::nullopt;
 822     }
 823 
<span class="line-modified"> 824     if (sourceUnitType == CSS_NUMBER) {</span>
<span class="line-modified"> 825         // We interpret conversion from CSS_NUMBER in the same way as CSSParser::validUnit() while using non-strict mode.</span>
 826         sourceUnitType = canonicalUnitTypeForCategory(targetCategory);
<span class="line-modified"> 827         if (sourceUnitType == CSS_UNKNOWN)</span>
 828             return WTF::nullopt;
 829     }
 830 
 831     double convertedValue = doubleValue();
 832 
<span class="line-modified"> 833     // First convert the value from m_primitiveUnitType to canonical type.</span>
 834     double factor = conversionToCanonicalUnitsScaleFactor(sourceUnitType);
 835     convertedValue *= factor;
 836 
 837     // Now convert from canonical type to the target unitType.
 838     factor = conversionToCanonicalUnitsScaleFactor(targetUnitType);
 839     convertedValue /= factor;
 840 
 841     return convertedValue;
 842 }
 843 
<span class="line-modified"> 844 ExceptionOr&lt;void&gt; CSSPrimitiveValue::setStringValue(unsigned short, const String&amp;)</span>
 845 {
 846     // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
 847     // No other engine supports mutating style through this API. Computed style is always read-only anyway.
 848     // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
 849     return Exception { NoModificationAllowedError };
 850 }
 851 
 852 ExceptionOr&lt;String&gt; CSSPrimitiveValue::getStringValue() const
 853 {
<span class="line-modified"> 854     switch (m_primitiveUnitType) {</span>
<span class="line-modified"> 855     case CSS_STRING:</span>
<span class="line-modified"> 856     case CSS_ATTR:</span>
<span class="line-modified"> 857     case CSS_URI:</span>
 858         return m_value.string;
<span class="line-modified"> 859     case CSS_FONT_FAMILY:</span>
 860         return String { m_value.fontFamily-&gt;familyName };
<span class="line-modified"> 861     case CSS_VALUE_ID:</span>
 862         return String { valueName(m_value.valueID).string() };
<span class="line-modified"> 863     case CSS_PROPERTY_ID:</span>
 864         return String { propertyName(m_value.propertyID).string() };
 865     default:
 866         return Exception { InvalidAccessError };
 867     }
 868 }
 869 
 870 String CSSPrimitiveValue::stringValue() const
 871 {
<span class="line-modified"> 872     switch (m_primitiveUnitType) {</span>
<span class="line-modified"> 873     case CSS_STRING:</span>
<span class="line-modified"> 874     case CSS_ATTR:</span>
<span class="line-modified"> 875     case CSS_URI:</span>
 876         return m_value.string;
<span class="line-modified"> 877     case CSS_FONT_FAMILY:</span>
 878         return m_value.fontFamily-&gt;familyName;
<span class="line-modified"> 879     case CSS_VALUE_ID:</span>
 880         return valueName(m_value.valueID);
<span class="line-modified"> 881     case CSS_PROPERTY_ID:</span>
 882         return propertyName(m_value.propertyID);
 883     default:
 884         return String();
 885     }
 886 }
 887 
<span class="line-modified"> 888 ExceptionOr&lt;Counter&amp;&gt; CSSPrimitiveValue::getCounterValue() const</span>
<span class="line-removed"> 889 {</span>
<span class="line-removed"> 890     if (m_primitiveUnitType != CSS_COUNTER)</span>
<span class="line-removed"> 891         return Exception { InvalidAccessError };</span>
<span class="line-removed"> 892     return *m_value.counter;</span>
<span class="line-removed"> 893 }</span>
<span class="line-removed"> 894 </span>
<span class="line-removed"> 895 ExceptionOr&lt;Rect&amp;&gt; CSSPrimitiveValue::getRectValue() const</span>
<span class="line-removed"> 896 {</span>
<span class="line-removed"> 897     if (m_primitiveUnitType != CSS_RECT)</span>
<span class="line-removed"> 898         return Exception { InvalidAccessError };</span>
<span class="line-removed"> 899     return *m_value.rect;</span>
<span class="line-removed"> 900 }</span>
<span class="line-removed"> 901 </span>
<span class="line-removed"> 902 ExceptionOr&lt;Ref&lt;RGBColor&gt;&gt; CSSPrimitiveValue::getRGBColorValue() const</span>
 903 {
<span class="line-modified"> 904     if (m_primitiveUnitType != CSS_RGBCOLOR)</span>
<span class="line-removed"> 905         return Exception { InvalidAccessError };</span>
<span class="line-removed"> 906 </span>
<span class="line-removed"> 907     // FIXME: This should not return a new object for each invocation.</span>
<span class="line-removed"> 908     return RGBColor::create(m_value.color-&gt;rgb());</span>
 909 }
 910 
<span class="line-modified"> 911 NEVER_INLINE String CSSPrimitiveValue::formatNumberValue(StringView suffix) const</span>
 912 {
<span class="line-modified"> 913     return makeString(m_value.num, suffix);</span>






















































 914 }
 915 
 916 ALWAYS_INLINE String CSSPrimitiveValue::formatNumberForCustomCSSText() const
 917 {
<span class="line-modified"> 918     switch (m_primitiveUnitType) {</span>
<span class="line-modified"> 919     case CSS_UNKNOWN:</span>
 920         return String();
<span class="line-modified"> 921     case CSS_NUMBER:</span>
 922         return formatNumberValue(&quot;&quot;);
<span class="line-modified"> 923     case CSS_PERCENTAGE:</span>
 924         return formatNumberValue(&quot;%&quot;);
<span class="line-modified"> 925     case CSS_EMS:</span>
<span class="line-modified"> 926     case CSS_QUIRKY_EMS:</span>
 927         return formatNumberValue(&quot;em&quot;);
<span class="line-modified"> 928     case CSS_EXS:</span>
 929         return formatNumberValue(&quot;ex&quot;);
<span class="line-modified"> 930     case CSS_REMS:</span>
 931         return formatNumberValue(&quot;rem&quot;);
<span class="line-modified"> 932     case CSS_CHS:</span>
 933         return formatNumberValue(&quot;ch&quot;);
<span class="line-modified"> 934     case CSS_PX:</span>
 935         return formatNumberValue(&quot;px&quot;);
<span class="line-modified"> 936     case CSS_CM:</span>
 937         return formatNumberValue(&quot;cm&quot;);
<span class="line-modified"> 938 #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-removed"> 939     case CSS_DPPX:</span>
 940         return formatNumberValue(&quot;dppx&quot;);
<span class="line-modified"> 941     case CSS_DPI:</span>
 942         return formatNumberValue(&quot;dpi&quot;);
<span class="line-modified"> 943     case CSS_DPCM:</span>
 944         return formatNumberValue(&quot;dpcm&quot;);
<span class="line-modified"> 945 #endif</span>
<span class="line-removed"> 946     case CSS_MM:</span>
 947         return formatNumberValue(&quot;mm&quot;);
<span class="line-modified"> 948     case CSS_IN:</span>
 949         return formatNumberValue(&quot;in&quot;);
<span class="line-modified"> 950     case CSS_PT:</span>
 951         return formatNumberValue(&quot;pt&quot;);
<span class="line-modified"> 952     case CSS_PC:</span>
 953         return formatNumberValue(&quot;pc&quot;);
<span class="line-modified"> 954     case CSS_DEG:</span>
 955         return formatNumberValue(&quot;deg&quot;);
<span class="line-modified"> 956     case CSS_RAD:</span>
 957         return formatNumberValue(&quot;rad&quot;);
<span class="line-modified"> 958     case CSS_GRAD:</span>
 959         return formatNumberValue(&quot;grad&quot;);
<span class="line-modified"> 960     case CSS_MS:</span>
 961         return formatNumberValue(&quot;ms&quot;);
<span class="line-modified"> 962     case CSS_S:</span>
 963         return formatNumberValue(&quot;s&quot;);
<span class="line-modified"> 964     case CSS_HZ:</span>
 965         return formatNumberValue(&quot;hz&quot;);
<span class="line-modified"> 966     case CSS_KHZ:</span>
 967         return formatNumberValue(&quot;khz&quot;);
<span class="line-modified"> 968     case CSS_TURN:</span>
 969         return formatNumberValue(&quot;turn&quot;);
<span class="line-modified"> 970     case CSS_FR:</span>
 971         return formatNumberValue(&quot;fr&quot;);
<span class="line-modified"> 972     case CSS_DIMENSION:</span>
<span class="line-modified"> 973         // FIXME: We currently don&#39;t handle CSS_DIMENSION properly as we don&#39;t store</span>


 974         // the actual dimension, just the numeric value as a string.
<span class="line-modified"> 975     case CSS_STRING:</span>
 976         // FIME-NEWPARSER: Once we have CSSCustomIdentValue hooked up, this can just be
 977         // serializeString, since custom identifiers won&#39;t be the same value as strings
 978         // any longer.
 979         return serializeAsStringOrCustomIdent(m_value.string);
<span class="line-modified"> 980     case CSS_FONT_FAMILY:</span>
 981         return serializeFontFamily(m_value.fontFamily-&gt;familyName);
<span class="line-modified"> 982     case CSS_URI:</span>
 983         return serializeURL(m_value.string);
<span class="line-modified"> 984     case CSS_VALUE_ID:</span>
 985         return valueName(m_value.valueID);
<span class="line-modified"> 986     case CSS_PROPERTY_ID:</span>
 987         return propertyName(m_value.propertyID);
<span class="line-modified"> 988     case CSS_ATTR:</span>
 989         return &quot;attr(&quot; + String(m_value.string) + &#39;)&#39;;
<span class="line-modified"> 990     case CSS_COUNTER_NAME:</span>
 991         return &quot;counter(&quot; + String(m_value.string) + &#39;)&#39;;
<span class="line-modified"> 992     case CSS_COUNTER: {</span>
 993         StringBuilder result;
 994         String separator = m_value.counter-&gt;separator();
 995         if (separator.isEmpty())
 996             result.appendLiteral(&quot;counter(&quot;);
 997         else
 998             result.appendLiteral(&quot;counters(&quot;);
 999 
1000         result.append(m_value.counter-&gt;identifier());
1001         if (!separator.isEmpty()) {
1002             result.appendLiteral(&quot;, &quot;);
1003             serializeString(separator, result);
1004         }
1005         String listStyle = m_value.counter-&gt;listStyle();
1006         if (!listStyle.isEmpty())
1007             result.append(&quot;, &quot;, listStyle);
1008         result.append(&#39;)&#39;);
1009 
1010         return result.toString();
1011     }
<span class="line-modified">1012     case CSS_RECT:</span>
1013         return rectValue()-&gt;cssText();
<span class="line-modified">1014     case CSS_QUAD:</span>
1015         return quadValue()-&gt;cssText();
<span class="line-modified">1016     case CSS_RGBCOLOR:</span>
1017         return color().cssText();
<span class="line-modified">1018     case CSS_PAIR:</span>
1019         return pairValue()-&gt;cssText();
<span class="line-modified">1020     case CSS_CALC:</span>
1021         return m_value.calc-&gt;cssText();
<span class="line-modified">1022     case CSS_SHAPE:</span>
1023         return m_value.shape-&gt;cssText();
<span class="line-modified">1024     case CSS_VW:</span>
1025         return formatNumberValue(&quot;vw&quot;);
<span class="line-modified">1026     case CSS_VH:</span>
1027         return formatNumberValue(&quot;vh&quot;);
<span class="line-modified">1028     case CSS_VMIN:</span>
1029         return formatNumberValue(&quot;vmin&quot;);
<span class="line-modified">1030     case CSS_VMAX:</span>
1031         return formatNumberValue(&quot;vmax&quot;);





1032     }
1033     return String();
1034 }
1035 
1036 String CSSPrimitiveValue::customCSSText() const
1037 {
1038     // FIXME: return the original value instead of a generated one (e.g. color
1039     // name if it was specified) - check what spec says about this
1040 
1041     CSSTextCache&amp; cssTextCache = WebCore::cssTextCache();
1042 
1043     if (m_hasCachedCSSText) {
1044         ASSERT(cssTextCache.contains(this));
1045         return cssTextCache.get(this);
1046     }
1047 
1048     String text = formatNumberForCustomCSSText();
1049 
1050     ASSERT(!cssTextCache.contains(this));
1051     m_hasCachedCSSText = true;
1052     cssTextCache.set(this, text);
1053     return text;
1054 }
1055 
1056 bool CSSPrimitiveValue::equals(const CSSPrimitiveValue&amp; other) const
1057 {
<span class="line-modified">1058     if (m_primitiveUnitType != other.m_primitiveUnitType)</span>
1059         return false;
1060 
<span class="line-modified">1061     switch (m_primitiveUnitType) {</span>
<span class="line-modified">1062     case CSS_UNKNOWN:</span>
1063         return false;
<span class="line-modified">1064     case CSS_NUMBER:</span>
<span class="line-modified">1065     case CSS_PERCENTAGE:</span>
<span class="line-modified">1066     case CSS_EMS:</span>
<span class="line-modified">1067     case CSS_QUIRKY_EMS:</span>
<span class="line-modified">1068     case CSS_EXS:</span>
<span class="line-modified">1069     case CSS_REMS:</span>
<span class="line-modified">1070     case CSS_PX:</span>
<span class="line-modified">1071     case CSS_CM:</span>
<span class="line-modified">1072 #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-modified">1073     case CSS_DPPX:</span>
<span class="line-modified">1074     case CSS_DPI:</span>
<span class="line-modified">1075     case CSS_DPCM:</span>
<span class="line-modified">1076 #endif</span>
<span class="line-modified">1077     case CSS_MM:</span>
<span class="line-modified">1078     case CSS_IN:</span>
<span class="line-modified">1079     case CSS_PT:</span>
<span class="line-modified">1080     case CSS_PC:</span>
<span class="line-modified">1081     case CSS_DEG:</span>
<span class="line-modified">1082     case CSS_RAD:</span>
<span class="line-modified">1083     case CSS_GRAD:</span>
<span class="line-modified">1084     case CSS_MS:</span>
<span class="line-modified">1085     case CSS_S:</span>
<span class="line-modified">1086     case CSS_HZ:</span>
<span class="line-modified">1087     case CSS_KHZ:</span>
<span class="line-modified">1088     case CSS_TURN:</span>
<span class="line-modified">1089     case CSS_VW:</span>
<span class="line-modified">1090     case CSS_VH:</span>
<span class="line-modified">1091     case CSS_VMIN:</span>
<span class="line-modified">1092     case CSS_FR:</span>

1093         return m_value.num == other.m_value.num;
<span class="line-modified">1094     case CSS_PROPERTY_ID:</span>
1095         return propertyName(m_value.propertyID) == propertyName(other.m_value.propertyID);
<span class="line-modified">1096     case CSS_VALUE_ID:</span>
1097         return valueName(m_value.valueID) == valueName(other.m_value.valueID);
<span class="line-modified">1098     case CSS_DIMENSION:</span>
<span class="line-modified">1099     case CSS_STRING:</span>
<span class="line-modified">1100     case CSS_URI:</span>
<span class="line-modified">1101     case CSS_ATTR:</span>
<span class="line-modified">1102     case CSS_COUNTER_NAME:</span>
1103         return equal(m_value.string, other.m_value.string);
<span class="line-modified">1104     case CSS_COUNTER:</span>
1105         return m_value.counter &amp;&amp; other.m_value.counter &amp;&amp; m_value.counter-&gt;equals(*other.m_value.counter);
<span class="line-modified">1106     case CSS_RECT:</span>
1107         return m_value.rect &amp;&amp; other.m_value.rect &amp;&amp; m_value.rect-&gt;equals(*other.m_value.rect);
<span class="line-modified">1108     case CSS_QUAD:</span>
1109         return m_value.quad &amp;&amp; other.m_value.quad &amp;&amp; m_value.quad-&gt;equals(*other.m_value.quad);
<span class="line-modified">1110     case CSS_RGBCOLOR:</span>
1111         return color() == other.color();
<span class="line-modified">1112     case CSS_PAIR:</span>
1113         return m_value.pair &amp;&amp; other.m_value.pair &amp;&amp; m_value.pair-&gt;equals(*other.m_value.pair);
<span class="line-modified">1114     case CSS_CALC:</span>
1115         return m_value.calc &amp;&amp; other.m_value.calc &amp;&amp; m_value.calc-&gt;equals(*other.m_value.calc);
<span class="line-modified">1116     case CSS_SHAPE:</span>
1117         return m_value.shape &amp;&amp; other.m_value.shape &amp;&amp; m_value.shape-&gt;equals(*other.m_value.shape);
<span class="line-modified">1118     case CSS_FONT_FAMILY:</span>
1119         return fontFamily() == other.fontFamily();







1120     }
1121     return false;
1122 }
1123 
1124 Ref&lt;DeprecatedCSSOMPrimitiveValue&gt; CSSPrimitiveValue::createDeprecatedCSSOMPrimitiveWrapper(CSSStyleDeclaration&amp; styleDeclaration) const
1125 {
1126     return DeprecatedCSSOMPrimitiveValue::create(*this, styleDeclaration);
1127 }
1128 
1129 // https://drafts.css-houdini.org/css-properties-values-api/#dependency-cycles-via-relative-units
1130 void CSSPrimitiveValue::collectDirectComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
1131 {
<span class="line-modified">1132     switch (m_primitiveUnitType) {</span>
<span class="line-modified">1133     case CSS_EMS:</span>
<span class="line-modified">1134     case CSS_QUIRKY_EMS:</span>
<span class="line-modified">1135     case CSS_EXS:</span>
<span class="line-modified">1136     case CSS_CHS:</span>
1137         values.add(CSSPropertyFontSize);
1138         break;
<span class="line-modified">1139     case CSS_CALC:</span>
1140         m_value.calc-&gt;collectDirectComputationalDependencies(values);
1141         break;


1142     }
1143 }
1144 
1145 void CSSPrimitiveValue::collectDirectRootComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
1146 {
<span class="line-modified">1147     switch (m_primitiveUnitType) {</span>
<span class="line-modified">1148     case CSS_REMS:</span>
1149         values.add(CSSPropertyFontSize);
1150         break;
<span class="line-modified">1151     case CSS_CALC:</span>
1152         m_value.calc-&gt;collectDirectRootComputationalDependencies(values);
1153         break;


1154     }
1155 }
1156 
1157 } // namespace WebCore
</pre>
</td>
<td>
<hr />
<pre>
  20 
  21 #include &quot;config.h&quot;
  22 #include &quot;CSSPrimitiveValue.h&quot;
  23 
  24 #include &quot;CSSBasicShapes.h&quot;
  25 #include &quot;CSSCalculationValue.h&quot;
  26 #include &quot;CSSFontFamily.h&quot;
  27 #include &quot;CSSHelper.h&quot;
  28 #include &quot;CSSMarkup.h&quot;
  29 #include &quot;CSSPrimitiveValueMappings.h&quot;
  30 #include &quot;CSSPropertyNames.h&quot;
  31 #include &quot;CSSToLengthConversionData.h&quot;
  32 #include &quot;CSSValueKeywords.h&quot;
  33 #include &quot;CalculationValue.h&quot;
  34 #include &quot;Color.h&quot;
  35 #include &quot;Counter.h&quot;
  36 #include &quot;DeprecatedCSSOMPrimitiveValue.h&quot;
  37 #include &quot;FontCascade.h&quot;
  38 #include &quot;Node.h&quot;
  39 #include &quot;Pair.h&quot;

  40 #include &quot;Rect.h&quot;
  41 #include &quot;RenderStyle.h&quot;
  42 #include &lt;wtf/NeverDestroyed.h&gt;
  43 #include &lt;wtf/StdLibExtras.h&gt;
  44 #include &lt;wtf/text/StringBuilder.h&gt;
  45 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  46 
  47 namespace WebCore {
  48 
<span class="line-modified">  49 static inline bool isValidCSSUnitTypeForDoubleConversion(CSSUnitType unitType)</span>
  50 {
  51     switch (unitType) {
<span class="line-modified">  52     case CSSUnitType::CSS_CALC:</span>
<span class="line-modified">  53     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified">  54     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified">  55     case CSSUnitType::CSS_CHS:</span>
<span class="line-modified">  56     case CSSUnitType::CSS_CM:</span>
<span class="line-modified">  57     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified">  58     case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-modified">  59     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified">  60     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified">  61     case CSSUnitType::CSS_FR:</span>
<span class="line-modified">  62     case CSSUnitType::CSS_GRAD:</span>
<span class="line-modified">  63     case CSSUnitType::CSS_HZ:</span>
<span class="line-modified">  64     case CSSUnitType::CSS_IN:</span>
<span class="line-modified">  65     case CSSUnitType::CSS_KHZ:</span>
<span class="line-modified">  66     case CSSUnitType::CSS_MM:</span>
<span class="line-modified">  67     case CSSUnitType::CSS_MS:</span>
<span class="line-modified">  68     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-modified">  69     case CSSUnitType::CSS_PC:</span>
<span class="line-modified">  70     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-modified">  71     case CSSUnitType::CSS_PT:</span>
<span class="line-modified">  72     case CSSUnitType::CSS_PX:</span>
<span class="line-modified">  73     case CSSUnitType::CSS_Q:</span>
<span class="line-modified">  74     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified">  75     case CSSUnitType::CSS_RAD:</span>
<span class="line-modified">  76     case CSSUnitType::CSS_REMS:</span>
<span class="line-modified">  77     case CSSUnitType::CSS_S:</span>
<span class="line-modified">  78     case CSSUnitType::CSS_TURN:</span>
<span class="line-modified">  79     case CSSUnitType::CSS_VH:</span>
<span class="line-modified">  80     case CSSUnitType::CSS_VMAX:</span>
<span class="line-modified">  81     case CSSUnitType::CSS_VMIN:</span>
<span class="line-added">  82     case CSSUnitType::CSS_VW:</span>
<span class="line-added">  83     case CSSUnitType::CSS_DPCM:</span>
<span class="line-added">  84     case CSSUnitType::CSS_DPI:</span>
<span class="line-added">  85     case CSSUnitType::CSS_DPPX:</span>
  86         return true;
<span class="line-modified">  87     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified">  88     case CSSUnitType::CSS_COUNTER:</span>
<span class="line-modified">  89     case CSSUnitType::CSS_COUNTER_NAME:</span>
<span class="line-modified">  90     case CSSUnitType::CSS_FONT_FAMILY:</span>
<span class="line-modified">  91     case CSSUnitType::CSS_IDENT:</span>
<span class="line-modified">  92     case CSSUnitType::CSS_PAIR:</span>
<span class="line-modified">  93     case CSSUnitType::CSS_PROPERTY_ID:</span>
<span class="line-modified">  94     case CSSUnitType::CSS_QUAD:</span>
<span class="line-modified">  95     case CSSUnitType::CSS_RECT:</span>
<span class="line-modified">  96     case CSSUnitType::CSS_RGBCOLOR:</span>
<span class="line-modified">  97     case CSSUnitType::CSS_SHAPE:</span>
<span class="line-modified">  98     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified">  99     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-modified"> 100     case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-modified"> 101     case CSSUnitType::CSS_URI:</span>
<span class="line-modified"> 102     case CSSUnitType::CSS_VALUE_ID:</span>








 103         return false;
 104     }
 105 
 106     ASSERT_NOT_REACHED();
 107     return false;
 108 }
 109 
<span class="line-modified"> 110 #if ASSERT_ENABLED</span>
 111 
<span class="line-modified"> 112 static inline bool isStringType(CSSUnitType type)</span>
 113 {
 114     switch (type) {
<span class="line-modified"> 115     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified"> 116     case CSSUnitType::CSS_URI:</span>
<span class="line-modified"> 117     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified"> 118     case CSSUnitType::CSS_COUNTER_NAME:</span>
<span class="line-modified"> 119     case CSSUnitType::CSS_DIMENSION:</span>
 120         return true;
<span class="line-modified"> 121     case CSSUnitType::CSS_CALC:</span>
<span class="line-modified"> 122     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified"> 123     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified"> 124     case CSSUnitType::CSS_CHS:</span>
<span class="line-modified"> 125     case CSSUnitType::CSS_CM:</span>
<span class="line-modified"> 126     case CSSUnitType::CSS_COUNTER:</span>
<span class="line-modified"> 127     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified"> 128     case CSSUnitType::CSS_DPCM:</span>
<span class="line-modified"> 129     case CSSUnitType::CSS_DPI:</span>
<span class="line-modified"> 130     case CSSUnitType::CSS_DPPX:</span>
<span class="line-modified"> 131     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified"> 132     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified"> 133     case CSSUnitType::CSS_FONT_FAMILY:</span>
<span class="line-modified"> 134     case CSSUnitType::CSS_FR:</span>
<span class="line-modified"> 135     case CSSUnitType::CSS_GRAD:</span>
<span class="line-modified"> 136     case CSSUnitType::CSS_HZ:</span>
<span class="line-modified"> 137     case CSSUnitType::CSS_IDENT:</span>
<span class="line-modified"> 138     case CSSUnitType::CSS_IN:</span>
<span class="line-modified"> 139     case CSSUnitType::CSS_KHZ:</span>
<span class="line-modified"> 140     case CSSUnitType::CSS_MM:</span>
<span class="line-modified"> 141     case CSSUnitType::CSS_MS:</span>
<span class="line-modified"> 142     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-modified"> 143     case CSSUnitType::CSS_PAIR:</span>
<span class="line-modified"> 144     case CSSUnitType::CSS_PC:</span>
<span class="line-modified"> 145     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-modified"> 146     case CSSUnitType::CSS_PROPERTY_ID:</span>
<span class="line-modified"> 147     case CSSUnitType::CSS_PT:</span>
<span class="line-modified"> 148     case CSSUnitType::CSS_PX:</span>
<span class="line-modified"> 149     case CSSUnitType::CSS_Q:</span>
<span class="line-modified"> 150     case CSSUnitType::CSS_QUAD:</span>
<span class="line-modified"> 151     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified"> 152     case CSSUnitType::CSS_RAD:</span>
<span class="line-modified"> 153     case CSSUnitType::CSS_RECT:</span>
<span class="line-modified"> 154     case CSSUnitType::CSS_REMS:</span>
<span class="line-modified"> 155     case CSSUnitType::CSS_RGBCOLOR:</span>
<span class="line-modified"> 156     case CSSUnitType::CSS_S:</span>
<span class="line-modified"> 157     case CSSUnitType::CSS_SHAPE:</span>
<span class="line-modified"> 158     case CSSUnitType::CSS_TURN:</span>
<span class="line-modified"> 159     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-modified"> 160     case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-modified"> 161     case CSSUnitType::CSS_VALUE_ID:</span>
<span class="line-modified"> 162     case CSSUnitType::CSS_VH:</span>
<span class="line-modified"> 163     case CSSUnitType::CSS_VMAX:</span>
<span class="line-modified"> 164     case CSSUnitType::CSS_VMIN:</span>
<span class="line-added"> 165     case CSSUnitType::CSS_VW:</span>
 166         return false;
 167     }
 168 
 169     ASSERT_NOT_REACHED();
 170     return false;
 171 }
 172 
<span class="line-modified"> 173 #endif // ASSERT_ENABLED</span>






































 174 
 175 typedef HashMap&lt;const CSSPrimitiveValue*, String&gt; CSSTextCache;
 176 static CSSTextCache&amp; cssTextCache()
 177 {
 178     static NeverDestroyed&lt;CSSTextCache&gt; cache;
 179     return cache;
 180 }
 181 
<span class="line-modified"> 182 CSSUnitType CSSPrimitiveValue::primitiveType() const</span>
 183 {
<span class="line-modified"> 184     if (primitiveUnitType() == CSSUnitType::CSS_PROPERTY_ID || primitiveUnitType() == CSSUnitType::CSS_VALUE_ID)</span>
<span class="line-modified"> 185         return CSSUnitType::CSS_IDENT;</span>
 186 
<span class="line-modified"> 187     // Web-exposed content expects font family values to have CSSUnitType::CSS_STRING primitive type</span>
<span class="line-modified"> 188     // so we need to map our internal CSSUnitType::CSS_FONT_FAMILY type here.</span>
<span class="line-modified"> 189     if (primitiveUnitType() == CSSUnitType::CSS_FONT_FAMILY)</span>
<span class="line-modified"> 190         return CSSUnitType::CSS_STRING;</span>
 191 
<span class="line-modified"> 192     if (primitiveUnitType() != CSSUnitType::CSS_CALC)</span>
<span class="line-modified"> 193         return primitiveUnitType();</span>
 194 
 195     switch (m_value.calc-&gt;category()) {
 196     case CalculationCategory::Number:
<span class="line-modified"> 197         return CSSUnitType::CSS_NUMBER;</span>


 198     case CalculationCategory::Percent:
<span class="line-modified"> 199         return CSSUnitType::CSS_PERCENTAGE;</span>
 200     case CalculationCategory::PercentNumber:
<span class="line-modified"> 201         return CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER;</span>
 202     case CalculationCategory::PercentLength:
<span class="line-modified"> 203         return CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH;</span>
<span class="line-added"> 204     case CalculationCategory::Length:</span>
 205     case CalculationCategory::Angle:
 206     case CalculationCategory::Time:
 207     case CalculationCategory::Frequency:
 208         return m_value.calc-&gt;primitiveType();
 209     case CalculationCategory::Other:
<span class="line-modified"> 210         return CSSUnitType::CSS_UNKNOWN;</span>
 211     }
<span class="line-modified"> 212     return CSSUnitType::CSS_UNKNOWN;</span>
 213 }
 214 
 215 static const AtomString&amp; propertyName(CSSPropertyID propertyID)
 216 {
 217     ASSERT_ARG(propertyID, (propertyID &gt;= firstCSSProperty &amp;&amp; propertyID &lt; firstCSSProperty + numCSSProperties));
 218 
 219     return getPropertyNameAtomString(propertyID);
 220 }
 221 
 222 static const AtomString&amp; valueName(CSSValueID valueID)
 223 {
 224     ASSERT_ARG(valueID, (valueID &gt;= firstCSSValueKeyword &amp;&amp; valueID &lt;= lastCSSValueKeyword));
 225 
 226     return getValueNameAtomString(valueID);
 227 }
 228 
 229 CSSPrimitiveValue::CSSPrimitiveValue(CSSValueID valueID)
 230     : CSSValue(PrimitiveClass)
 231 {
<span class="line-modified"> 232     setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 233     m_value.valueID = valueID;
 234 }
 235 
 236 CSSPrimitiveValue::CSSPrimitiveValue(CSSPropertyID propertyID)
 237     : CSSValue(PrimitiveClass)
 238 {
<span class="line-modified"> 239     setPrimitiveUnitType(CSSUnitType::CSS_PROPERTY_ID);</span>
 240     m_value.propertyID = propertyID;
 241 }
 242 
<span class="line-modified"> 243 CSSPrimitiveValue::CSSPrimitiveValue(double num, CSSUnitType type)</span>
 244     : CSSValue(PrimitiveClass)
 245 {
<span class="line-modified"> 246     setPrimitiveUnitType(type);</span>
 247     ASSERT(std::isfinite(num));
 248     m_value.num = num;
 249 }
 250 
<span class="line-modified"> 251 CSSPrimitiveValue::CSSPrimitiveValue(const String&amp; string, CSSUnitType type)</span>
 252     : CSSValue(PrimitiveClass)
 253 {
 254     ASSERT(isStringType(type));
<span class="line-modified"> 255     setPrimitiveUnitType(type);</span>
 256     if ((m_value.string = string.impl()))
 257         m_value.string-&gt;ref();
 258 }
 259 
 260 CSSPrimitiveValue::CSSPrimitiveValue(const Color&amp; color)
 261     : CSSValue(PrimitiveClass)
 262 {
<span class="line-modified"> 263     setPrimitiveUnitType(CSSUnitType::CSS_RGBCOLOR);</span>
 264     m_value.color = new Color(color);
 265 }
 266 
 267 CSSPrimitiveValue::CSSPrimitiveValue(const Length&amp; length)
 268     : CSSValue(PrimitiveClass)
 269 {
 270     init(length);
 271 }
 272 
 273 CSSPrimitiveValue::CSSPrimitiveValue(const Length&amp; length, const RenderStyle&amp; style)
 274     : CSSValue(PrimitiveClass)
 275 {
 276     switch (length.type()) {
 277     case Auto:
 278     case Intrinsic:
 279     case MinIntrinsic:
 280     case MinContent:
 281     case MaxContent:
 282     case FillAvailable:
 283     case FitContent:
 284     case Percent:
 285         init(length);
 286         return;
 287     case Fixed:
<span class="line-modified"> 288         setPrimitiveUnitType(CSSUnitType::CSS_PX);</span>
 289         m_value.num = adjustFloatForAbsoluteZoom(length.value(), style);
 290         return;
 291     case Calculated: {
 292         init(CSSCalcValue::create(length.calculationValue(), style));
 293         return;
 294     }
 295     case Relative:
 296     case Undefined:
 297         ASSERT_NOT_REACHED();
 298         return;
 299     }
 300     ASSERT_NOT_REACHED();
 301 }
 302 
 303 CSSPrimitiveValue::CSSPrimitiveValue(const LengthSize&amp; lengthSize, const RenderStyle&amp; style)
 304     : CSSValue(PrimitiveClass)
 305 {
 306     init(lengthSize, style);
 307 }
 308 
<span class="line-added"> 309 CSSPrimitiveValue::CSSPrimitiveValue(StaticCSSValueTag, CSSValueID valueID)</span>
<span class="line-added"> 310     : CSSPrimitiveValue(valueID)</span>
<span class="line-added"> 311 {</span>
<span class="line-added"> 312     makeStatic();</span>
<span class="line-added"> 313 }</span>
<span class="line-added"> 314 </span>
<span class="line-added"> 315 CSSPrimitiveValue::CSSPrimitiveValue(StaticCSSValueTag, const Color&amp; color)</span>
<span class="line-added"> 316     : CSSPrimitiveValue(color)</span>
<span class="line-added"> 317 {</span>
<span class="line-added"> 318     makeStatic();</span>
<span class="line-added"> 319 }</span>
<span class="line-added"> 320 </span>
<span class="line-added"> 321 CSSPrimitiveValue::CSSPrimitiveValue(StaticCSSValueTag, double num, CSSUnitType type)</span>
<span class="line-added"> 322     : CSSPrimitiveValue(num, type)</span>
<span class="line-added"> 323 {</span>
<span class="line-added"> 324     makeStatic();</span>
<span class="line-added"> 325 }</span>
<span class="line-added"> 326 </span>
 327 void CSSPrimitiveValue::init(const Length&amp; length)
 328 {
 329     switch (length.type()) {
 330     case Auto:
<span class="line-modified"> 331         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 332         m_value.valueID = CSSValueAuto;
 333         return;
 334     case WebCore::Fixed:
<span class="line-modified"> 335         setPrimitiveUnitType(CSSUnitType::CSS_PX);</span>
 336         m_value.num = length.value();
 337         return;
 338     case Intrinsic:
<span class="line-modified"> 339         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 340         m_value.valueID = CSSValueIntrinsic;
 341         return;
 342     case MinIntrinsic:
<span class="line-modified"> 343         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 344         m_value.valueID = CSSValueMinIntrinsic;
 345         return;
 346     case MinContent:
<span class="line-modified"> 347         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 348         m_value.valueID = CSSValueMinContent;
 349         return;
 350     case MaxContent:
<span class="line-modified"> 351         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 352         m_value.valueID = CSSValueMaxContent;
 353         return;
 354     case FillAvailable:
<span class="line-modified"> 355         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 356         m_value.valueID = CSSValueWebkitFillAvailable;
 357         return;
 358     case FitContent:
<span class="line-modified"> 359         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
 360         m_value.valueID = CSSValueFitContent;
 361         return;
 362     case Percent:
<span class="line-modified"> 363         setPrimitiveUnitType(CSSUnitType::CSS_PERCENTAGE);</span>
 364         ASSERT(std::isfinite(length.percent()));
 365         m_value.num = length.percent();
 366         return;
 367     case Calculated:
 368     case Relative:
 369     case Undefined:
 370         ASSERT_NOT_REACHED();
 371         return;
 372     }
 373     ASSERT_NOT_REACHED();
 374 }
 375 
 376 void CSSPrimitiveValue::init(const LengthSize&amp; lengthSize, const RenderStyle&amp; style)
 377 {
<span class="line-modified"> 378     setPrimitiveUnitType(CSSUnitType::CSS_PAIR);</span>
 379     m_hasCachedCSSText = false;
 380     m_value.pair = &amp;Pair::create(create(lengthSize.width, style), create(lengthSize.height, style)).leakRef();
 381 }
 382 
 383 void CSSPrimitiveValue::init(Ref&lt;Counter&gt;&amp;&amp; counter)
 384 {
<span class="line-modified"> 385     setPrimitiveUnitType(CSSUnitType::CSS_COUNTER);</span>
 386     m_hasCachedCSSText = false;
 387     m_value.counter = &amp;counter.leakRef();
 388 }
 389 
 390 void CSSPrimitiveValue::init(Ref&lt;Rect&gt;&amp;&amp; r)
 391 {
<span class="line-modified"> 392     setPrimitiveUnitType(CSSUnitType::CSS_RECT);</span>
 393     m_hasCachedCSSText = false;
 394     m_value.rect = &amp;r.leakRef();
 395 }
 396 
 397 void CSSPrimitiveValue::init(Ref&lt;Quad&gt;&amp;&amp; quad)
 398 {
<span class="line-modified"> 399     setPrimitiveUnitType(CSSUnitType::CSS_QUAD);</span>
 400     m_hasCachedCSSText = false;
 401     m_value.quad = &amp;quad.leakRef();
 402 }
 403 
 404 void CSSPrimitiveValue::init(Ref&lt;Pair&gt;&amp;&amp; p)
 405 {
<span class="line-modified"> 406     setPrimitiveUnitType(CSSUnitType::CSS_PAIR);</span>
 407     m_hasCachedCSSText = false;
 408     m_value.pair = &amp;p.leakRef();
 409 }
 410 
 411 void CSSPrimitiveValue::init(Ref&lt;CSSBasicShape&gt;&amp;&amp; shape)
 412 {
<span class="line-modified"> 413     setPrimitiveUnitType(CSSUnitType::CSS_SHAPE);</span>
 414     m_hasCachedCSSText = false;
 415     m_value.shape = &amp;shape.leakRef();
 416 }
 417 
 418 void CSSPrimitiveValue::init(RefPtr&lt;CSSCalcValue&gt;&amp;&amp; c)
 419 {
<span class="line-modified"> 420     setPrimitiveUnitType(CSSUnitType::CSS_CALC);</span>
 421     m_hasCachedCSSText = false;
 422     m_value.calc = c.leakRef();
 423 }
 424 
 425 CSSPrimitiveValue::~CSSPrimitiveValue()
 426 {
 427     cleanup();
 428 }
 429 
 430 void CSSPrimitiveValue::cleanup()
 431 {
<span class="line-modified"> 432     auto type = primitiveUnitType();</span>
 433     switch (type) {
<span class="line-modified"> 434     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified"> 435     case CSSUnitType::CSS_URI:</span>
<span class="line-modified"> 436     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified"> 437     case CSSUnitType::CSS_COUNTER_NAME:</span>
 438         if (m_value.string)
 439             m_value.string-&gt;deref();
 440         break;
<span class="line-modified"> 441     case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-modified"> 442     case CSSUnitType::CSS_COUNTER:</span>
 443         m_value.counter-&gt;deref();
 444         break;
<span class="line-modified"> 445     case CSSUnitType::CSS_RECT:</span>
 446         m_value.rect-&gt;deref();
 447         break;
<span class="line-modified"> 448     case CSSUnitType::CSS_QUAD:</span>
 449         m_value.quad-&gt;deref();
 450         break;
<span class="line-modified"> 451     case CSSUnitType::CSS_PAIR:</span>
 452         m_value.pair-&gt;deref();
 453         break;
<span class="line-modified"> 454     case CSSUnitType::CSS_CALC:</span>
 455         m_value.calc-&gt;deref();
 456         break;
<span class="line-modified"> 457     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified"> 458     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
 459         ASSERT_NOT_REACHED();
 460         break;
<span class="line-modified"> 461     case CSSUnitType::CSS_SHAPE:</span>
 462         m_value.shape-&gt;deref();
 463         break;
<span class="line-modified"> 464     case CSSUnitType::CSS_FONT_FAMILY:</span>
 465         ASSERT(m_value.fontFamily);
 466         delete m_value.fontFamily;
 467         m_value.fontFamily = nullptr;
 468         break;
<span class="line-modified"> 469     case CSSUnitType::CSS_RGBCOLOR:</span>
 470         ASSERT(m_value.color);
 471         delete m_value.color;
 472         m_value.color = nullptr;
 473         break;
<span class="line-modified"> 474     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-modified"> 475     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-modified"> 476     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified"> 477     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified"> 478     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified"> 479     case CSSUnitType::CSS_REMS:</span>
<span class="line-modified"> 480     case CSSUnitType::CSS_CHS:</span>
<span class="line-modified"> 481     case CSSUnitType::CSS_PX:</span>
<span class="line-modified"> 482     case CSSUnitType::CSS_CM:</span>
<span class="line-modified"> 483     case CSSUnitType::CSS_MM:</span>
<span class="line-modified"> 484     case CSSUnitType::CSS_IN:</span>
<span class="line-modified"> 485     case CSSUnitType::CSS_PT:</span>
<span class="line-modified"> 486     case CSSUnitType::CSS_PC:</span>
<span class="line-modified"> 487     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified"> 488     case CSSUnitType::CSS_RAD:</span>
<span class="line-modified"> 489     case CSSUnitType::CSS_GRAD:</span>
<span class="line-modified"> 490     case CSSUnitType::CSS_MS:</span>
<span class="line-modified"> 491     case CSSUnitType::CSS_S:</span>
<span class="line-modified"> 492     case CSSUnitType::CSS_HZ:</span>
<span class="line-modified"> 493     case CSSUnitType::CSS_KHZ:</span>
<span class="line-modified"> 494     case CSSUnitType::CSS_TURN:</span>
<span class="line-modified"> 495     case CSSUnitType::CSS_VW:</span>
<span class="line-modified"> 496     case CSSUnitType::CSS_VH:</span>
<span class="line-modified"> 497     case CSSUnitType::CSS_VMIN:</span>
<span class="line-modified"> 498     case CSSUnitType::CSS_VMAX:</span>
<span class="line-modified"> 499     case CSSUnitType::CSS_DPPX:</span>
<span class="line-modified"> 500     case CSSUnitType::CSS_DPI:</span>
<span class="line-modified"> 501     case CSSUnitType::CSS_DPCM:</span>
<span class="line-modified"> 502     case CSSUnitType::CSS_FR:</span>
<span class="line-modified"> 503     case CSSUnitType::CSS_Q:</span>
<span class="line-modified"> 504     case CSSUnitType::CSS_IDENT:</span>
<span class="line-modified"> 505     case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-modified"> 506     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-modified"> 507     case CSSUnitType::CSS_PROPERTY_ID:</span>
<span class="line-added"> 508     case CSSUnitType::CSS_VALUE_ID:</span>
 509         ASSERT(!isStringType(type));
 510         break;
 511     }
<span class="line-modified"> 512     setPrimitiveUnitType(CSSUnitType::CSS_UNKNOWN);</span>
 513     if (m_hasCachedCSSText) {
 514         cssTextCache().remove(this);
 515         m_hasCachedCSSText = false;
 516     }
 517 }
 518 
 519 double CSSPrimitiveValue::computeDegrees() const
 520 {
 521     switch (primitiveType()) {
<span class="line-modified"> 522     case CSSUnitType::CSS_DEG:</span>
 523         return doubleValue();
<span class="line-modified"> 524     case CSSUnitType::CSS_RAD:</span>
 525         return rad2deg(doubleValue());
<span class="line-modified"> 526     case CSSUnitType::CSS_GRAD:</span>
 527         return grad2deg(doubleValue());
<span class="line-modified"> 528     case CSSUnitType::CSS_TURN:</span>
 529         return turn2deg(doubleValue());
 530     default:
 531         ASSERT_NOT_REACHED();
 532         return 0;
 533     }
 534 }
 535 
 536 template&lt;&gt; int CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 537 {
 538     return roundForImpreciseConversion&lt;int&gt;(computeLengthDouble(conversionData));
 539 }
 540 
 541 template&lt;&gt; unsigned CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 542 {
 543     return roundForImpreciseConversion&lt;unsigned&gt;(computeLengthDouble(conversionData));
 544 }
 545 
 546 template&lt;&gt; Length CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 547 {
 548     return Length(clampTo&lt;float&gt;(computeLengthDouble(conversionData), minValueForCssLength, maxValueForCssLength), Fixed);
</pre>
<hr />
<pre>
 551 template&lt;&gt; short CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 552 {
 553     return roundForImpreciseConversion&lt;short&gt;(computeLengthDouble(conversionData));
 554 }
 555 
 556 template&lt;&gt; unsigned short CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 557 {
 558     return roundForImpreciseConversion&lt;unsigned short&gt;(computeLengthDouble(conversionData));
 559 }
 560 
 561 template&lt;&gt; float CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 562 {
 563     return static_cast&lt;float&gt;(computeLengthDouble(conversionData));
 564 }
 565 
 566 template&lt;&gt; double CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 567 {
 568     return computeLengthDouble(conversionData);
 569 }
 570 
<span class="line-added"> 571 template&lt;&gt; LayoutUnit CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const</span>
<span class="line-added"> 572 {</span>
<span class="line-added"> 573     return LayoutUnit(computeLengthDouble(conversionData));</span>
<span class="line-added"> 574 }</span>
<span class="line-added"> 575 </span>
 576 double CSSPrimitiveValue::computeLengthDouble(const CSSToLengthConversionData&amp; conversionData) const
 577 {
<span class="line-modified"> 578     if (primitiveUnitType() == CSSUnitType::CSS_CALC) {</span>
 579         // The multiplier and factor is applied to each value in the calc expression individually
 580         return m_value.calc-&gt;computeLengthPx(conversionData);
<span class="line-added"> 581     }</span>
 582 
<span class="line-modified"> 583     return computeNonCalcLengthDouble(conversionData, primitiveType(), m_value.num);</span>
 584 }
 585 
<span class="line-modified"> 586 static constexpr double mmPerInch = 25.4;</span>
<span class="line-added"> 587 static constexpr double cmPerInch = 2.54;</span>
<span class="line-added"> 588 static constexpr double QPerInch = 25.4 * 4.0;</span>
<span class="line-added"> 589 </span>
<span class="line-added"> 590 double CSSPrimitiveValue::computeNonCalcLengthDouble(const CSSToLengthConversionData&amp; conversionData, CSSUnitType primitiveType, double value)</span>
 591 {
 592     double factor;
 593     bool applyZoom = true;
 594 
 595     switch (primitiveType) {
<span class="line-modified"> 596     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified"> 597     case CSSUnitType::CSS_QUIRKY_EMS:</span>
 598         ASSERT(conversionData.style());
 599         factor = conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize();
 600         break;
<span class="line-modified"> 601     case CSSUnitType::CSS_EXS:</span>
 602         ASSERT(conversionData.style());
 603         // FIXME: We have a bug right now where the zoom will be applied twice to EX units.
 604         // We really need to compute EX using fontMetrics for the original specifiedSize and not use
 605         // our actual constructed rendering font.
 606         if (conversionData.style()-&gt;fontMetrics().hasXHeight())
 607             factor = conversionData.style()-&gt;fontMetrics().xHeight();
 608         else
 609             factor = (conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize()) / 2.0;
 610         break;
<span class="line-modified"> 611     case CSSUnitType::CSS_REMS:</span>
 612         if (conversionData.rootStyle())
 613             factor = conversionData.computingFontSize() ? conversionData.rootStyle()-&gt;fontDescription().specifiedSize() : conversionData.rootStyle()-&gt;fontDescription().computedSize();
 614         else
 615             factor = 1.0;
 616         break;
<span class="line-modified"> 617     case CSSUnitType::CSS_CHS:</span>
 618         ASSERT(conversionData.style());
 619         factor = conversionData.style()-&gt;fontMetrics().zeroWidth();
 620         break;
<span class="line-modified"> 621     case CSSUnitType::CSS_PX:</span>
 622         factor = 1.0;
 623         break;
<span class="line-modified"> 624     case CSSUnitType::CSS_CM:</span>
<span class="line-modified"> 625         factor = cssPixelsPerInch / cmPerInch;</span>
<span class="line-added"> 626         break;</span>
<span class="line-added"> 627     case CSSUnitType::CSS_MM:</span>
<span class="line-added"> 628         factor = cssPixelsPerInch / mmPerInch;</span>
 629         break;
<span class="line-modified"> 630     case CSSUnitType::CSS_Q:</span>
<span class="line-modified"> 631         factor = cssPixelsPerInch / QPerInch;</span>
 632         break;
<span class="line-modified"> 633     case CSSUnitType::CSS_IN:</span>
 634         factor = cssPixelsPerInch;
 635         break;
<span class="line-modified"> 636     case CSSUnitType::CSS_PT:</span>
 637         factor = cssPixelsPerInch / 72.0;
 638         break;
<span class="line-modified"> 639     case CSSUnitType::CSS_PC:</span>
 640         // 1 pc == 12 pt
 641         factor = cssPixelsPerInch * 12.0 / 72.0;
 642         break;
<span class="line-modified"> 643     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified"> 644     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
 645         ASSERT_NOT_REACHED();
 646         return -1.0;
<span class="line-modified"> 647     case CSSUnitType::CSS_VH:</span>
 648         factor = conversionData.viewportHeightFactor();
 649         applyZoom = false;
 650         break;
<span class="line-modified"> 651     case CSSUnitType::CSS_VW:</span>
 652         factor = conversionData.viewportWidthFactor();
 653         applyZoom = false;
 654         break;
<span class="line-modified"> 655     case CSSUnitType::CSS_VMAX:</span>
 656         factor = conversionData.viewportMaxFactor();
 657         applyZoom = false;
 658         break;
<span class="line-modified"> 659     case CSSUnitType::CSS_VMIN:</span>
 660         factor = conversionData.viewportMinFactor();
 661         applyZoom = false;
 662         break;
 663     default:
 664         ASSERT_NOT_REACHED();
 665         return -1.0;
 666     }
 667 
 668     // We do not apply the zoom factor when we are computing the value of the font-size property. The zooming
 669     // for font sizes is much more complicated, since we have to worry about enforcing the minimum font size preference
 670     // as well as enforcing the implicit &quot;smart minimum.&quot;
 671     double result = value * factor;
 672     if (conversionData.computingFontSize() || isFontRelativeLength(primitiveType))
 673         return result;
 674 
 675     if (applyZoom)
 676         result *= conversionData.zoom();
 677 
 678     return result;
 679 }
 680 
<span class="line-modified"> 681 bool CSSPrimitiveValue::equalForLengthResolution(const RenderStyle&amp; styleA, const RenderStyle&amp; styleB)</span>
<span class="line-added"> 682 {</span>
<span class="line-added"> 683     // These properties affect results of computeNonCalcLengthDouble above.</span>
<span class="line-added"> 684     if (styleA.fontDescription().computedSize() != styleB.fontDescription().computedSize())</span>
<span class="line-added"> 685         return false;</span>
<span class="line-added"> 686     if (styleA.fontDescription().specifiedSize() != styleB.fontDescription().specifiedSize())</span>
<span class="line-added"> 687         return false;</span>
<span class="line-added"> 688 </span>
<span class="line-added"> 689     if (styleA.fontMetrics().xHeight() != styleB.fontMetrics().xHeight())</span>
<span class="line-added"> 690         return false;</span>
<span class="line-added"> 691     if (styleA.fontMetrics().zeroWidth() != styleB.fontMetrics().zeroWidth())</span>
<span class="line-added"> 692         return false;</span>
<span class="line-added"> 693 </span>
<span class="line-added"> 694     if (styleA.zoom() != styleB.zoom())</span>
<span class="line-added"> 695         return false;</span>
<span class="line-added"> 696 </span>
<span class="line-added"> 697     return true;</span>
<span class="line-added"> 698 }</span>
<span class="line-added"> 699 </span>
<span class="line-added"> 700 ExceptionOr&lt;void&gt; CSSPrimitiveValue::setFloatValue(CSSUnitType, double)</span>
 701 {
 702     // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
 703     // No other engine supports mutating style through this API. Computed style is always read-only anyway.
 704     // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
 705     return Exception { NoModificationAllowedError };
 706 }
 707 
<span class="line-modified"> 708 double CSSPrimitiveValue::conversionToCanonicalUnitsScaleFactor(CSSUnitType unitType)</span>
 709 {
 710     double factor = 1.0;
 711     // FIXME: the switch can be replaced by an array of scale factors.
 712     switch (unitType) {
 713     // These are &quot;canonical&quot; units in their respective categories.
<span class="line-modified"> 714     case CSSUnitType::CSS_PX:</span>
<span class="line-modified"> 715     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified"> 716     case CSSUnitType::CSS_MS:</span>
<span class="line-modified"> 717     case CSSUnitType::CSS_HZ:</span>
<span class="line-added"> 718     case CSSUnitType::CSS_DPPX:</span>
<span class="line-added"> 719         break;</span>
<span class="line-added"> 720     case CSSUnitType::CSS_CM:</span>
<span class="line-added"> 721         factor = cssPixelsPerInch / cmPerInch;</span>
 722         break;
<span class="line-modified"> 723     case CSSUnitType::CSS_DPCM:</span>
<span class="line-modified"> 724         factor = cmPerInch / cssPixelsPerInch; // (2.54 cm/in)</span>
 725         break;
<span class="line-modified"> 726     case CSSUnitType::CSS_MM:</span>
<span class="line-modified"> 727         factor = cssPixelsPerInch / mmPerInch;</span>
 728         break;
<span class="line-modified"> 729     case CSSUnitType::CSS_Q:</span>
<span class="line-modified"> 730         factor = cssPixelsPerInch / QPerInch;</span>
 731         break;
<span class="line-modified"> 732     case CSSUnitType::CSS_IN:</span>
 733         factor = cssPixelsPerInch;
 734         break;
<span class="line-modified"> 735     case CSSUnitType::CSS_DPI:</span>
 736         factor = 1 / cssPixelsPerInch;
 737         break;
<span class="line-modified"> 738     case CSSUnitType::CSS_PT:</span>
 739         factor = cssPixelsPerInch / 72.0;
 740         break;
<span class="line-modified"> 741     case CSSUnitType::CSS_PC:</span>
 742         factor = cssPixelsPerInch * 12.0 / 72.0; // 1 pc == 12 pt
 743         break;
<span class="line-modified"> 744     case CSSUnitType::CSS_RAD:</span>
 745         factor = 180 / piDouble;
 746         break;
<span class="line-modified"> 747     case CSSUnitType::CSS_GRAD:</span>
 748         factor = 0.9;
 749         break;
<span class="line-modified"> 750     case CSSUnitType::CSS_TURN:</span>
 751         factor = 360;
 752         break;
<span class="line-modified"> 753     case CSSUnitType::CSS_S:</span>
<span class="line-modified"> 754     case CSSUnitType::CSS_KHZ:</span>
 755         factor = 1000;
 756         break;
 757     default:
 758         break;
 759     }
 760 
 761     return factor;
 762 }
 763 
<span class="line-modified"> 764 ExceptionOr&lt;float&gt; CSSPrimitiveValue::getFloatValue(CSSUnitType unitType) const</span>
 765 {
<span class="line-modified"> 766     auto result = doubleValueInternal(unitType);</span>
 767     if (!result)
 768         return Exception { InvalidAccessError };
 769     return clampTo&lt;float&gt;(result.value());
 770 }
 771 
<span class="line-modified"> 772 double CSSPrimitiveValue::doubleValue(CSSUnitType unitType) const</span>
 773 {
 774     return doubleValueInternal(unitType).valueOr(0);
 775 }
 776 
 777 double CSSPrimitiveValue::doubleValue() const
 778 {
<span class="line-modified"> 779     return primitiveUnitType() != CSSUnitType::CSS_CALC ? m_value.num : m_value.calc-&gt;doubleValue();</span>
 780 }
 781 
<span class="line-added"> 782 Optional&lt;bool&gt; CSSPrimitiveValue::isZero() const</span>
<span class="line-added"> 783 {</span>
<span class="line-added"> 784     if (primitiveUnitType() == CSSUnitType::CSS_CALC)</span>
<span class="line-added"> 785         return WTF::nullopt;</span>
<span class="line-added"> 786     return !m_value.num;</span>
<span class="line-added"> 787 }</span>
 788 
<span class="line-modified"> 789 Optional&lt;bool&gt; CSSPrimitiveValue::isPositive() const</span>
 790 {
<span class="line-modified"> 791     if (primitiveUnitType() == CSSUnitType::CSS_CALC)</span>
<span class="line-modified"> 792         return WTF::nullopt;</span>
<span class="line-modified"> 793     return m_value.num &gt; 0;</span>
<span class="line-modified"> 794 }</span>
<span class="line-modified"> 795 </span>
<span class="line-modified"> 796 Optional&lt;bool&gt; CSSPrimitiveValue::isNegative() const</span>
<span class="line-modified"> 797 {</span>
<span class="line-modified"> 798     if (primitiveUnitType() == CSSUnitType::CSS_CALC)</span>
<span class="line-modified"> 799         return WTF::nullopt;</span>
<span class="line-modified"> 800     return m_value.num &lt; 0;</span>












 801 }
 802 
<span class="line-modified"> 803 Optional&lt;double&gt; CSSPrimitiveValue::doubleValueInternal(CSSUnitType requestedUnitType) const</span>
 804 {
<span class="line-modified"> 805     if (!isValidCSSUnitTypeForDoubleConversion(primitiveUnitType()) || !isValidCSSUnitTypeForDoubleConversion(requestedUnitType))</span>
 806         return WTF::nullopt;
 807 
<span class="line-modified"> 808     CSSUnitType sourceUnitType = primitiveType();</span>
<span class="line-modified"> 809     if (requestedUnitType == sourceUnitType || requestedUnitType == CSSUnitType::CSS_DIMENSION)</span>
 810         return doubleValue();
 811 
<span class="line-modified"> 812     CSSUnitCategory sourceCategory = unitCategory(sourceUnitType);</span>
<span class="line-modified"> 813     ASSERT(sourceCategory != CSSUnitCategory::Other);</span>
 814 
<span class="line-modified"> 815     CSSUnitType targetUnitType = requestedUnitType;</span>
<span class="line-modified"> 816     CSSUnitCategory targetCategory = unitCategory(targetUnitType);</span>
<span class="line-modified"> 817     ASSERT(targetCategory != CSSUnitCategory::Other);</span>
 818 
<span class="line-modified"> 819     // Cannot convert between unrelated unit categories if one of them is not CSSUnitCategory::Number.</span>
<span class="line-modified"> 820     if (sourceCategory != targetCategory &amp;&amp; sourceCategory != CSSUnitCategory::Number &amp;&amp; targetCategory != CSSUnitCategory::Number)</span>
 821         return WTF::nullopt;
 822 
<span class="line-modified"> 823     if (targetCategory == CSSUnitCategory::Number) {</span>
<span class="line-modified"> 824         // We interpret conversion to CSSUnitType::CSS_NUMBER as conversion to a canonical unit in this value&#39;s category.</span>
 825         targetUnitType = canonicalUnitTypeForCategory(sourceCategory);
<span class="line-modified"> 826         if (targetUnitType == CSSUnitType::CSS_UNKNOWN)</span>
 827             return WTF::nullopt;
 828     }
 829 
<span class="line-modified"> 830     if (sourceUnitType == CSSUnitType::CSS_NUMBER) {</span>
<span class="line-modified"> 831         // We interpret conversion from CSSUnitType::CSS_NUMBER in the same way as CSSParser::validUnit() while using non-strict mode.</span>
 832         sourceUnitType = canonicalUnitTypeForCategory(targetCategory);
<span class="line-modified"> 833         if (sourceUnitType == CSSUnitType::CSS_UNKNOWN)</span>
 834             return WTF::nullopt;
 835     }
 836 
 837     double convertedValue = doubleValue();
 838 
<span class="line-modified"> 839     // First convert the value from primitiveUnitType() to canonical type.</span>
 840     double factor = conversionToCanonicalUnitsScaleFactor(sourceUnitType);
 841     convertedValue *= factor;
 842 
 843     // Now convert from canonical type to the target unitType.
 844     factor = conversionToCanonicalUnitsScaleFactor(targetUnitType);
 845     convertedValue /= factor;
 846 
 847     return convertedValue;
 848 }
 849 
<span class="line-modified"> 850 ExceptionOr&lt;void&gt; CSSPrimitiveValue::setStringValue(CSSUnitType, const String&amp;)</span>
 851 {
 852     // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
 853     // No other engine supports mutating style through this API. Computed style is always read-only anyway.
 854     // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
 855     return Exception { NoModificationAllowedError };
 856 }
 857 
 858 ExceptionOr&lt;String&gt; CSSPrimitiveValue::getStringValue() const
 859 {
<span class="line-modified"> 860     switch (primitiveUnitType()) {</span>
<span class="line-modified"> 861     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified"> 862     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified"> 863     case CSSUnitType::CSS_URI:</span>
 864         return m_value.string;
<span class="line-modified"> 865     case CSSUnitType::CSS_FONT_FAMILY:</span>
 866         return String { m_value.fontFamily-&gt;familyName };
<span class="line-modified"> 867     case CSSUnitType::CSS_VALUE_ID:</span>
 868         return String { valueName(m_value.valueID).string() };
<span class="line-modified"> 869     case CSSUnitType::CSS_PROPERTY_ID:</span>
 870         return String { propertyName(m_value.propertyID).string() };
 871     default:
 872         return Exception { InvalidAccessError };
 873     }
 874 }
 875 
 876 String CSSPrimitiveValue::stringValue() const
 877 {
<span class="line-modified"> 878     switch (primitiveUnitType()) {</span>
<span class="line-modified"> 879     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified"> 880     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified"> 881     case CSSUnitType::CSS_URI:</span>
 882         return m_value.string;
<span class="line-modified"> 883     case CSSUnitType::CSS_FONT_FAMILY:</span>
 884         return m_value.fontFamily-&gt;familyName;
<span class="line-modified"> 885     case CSSUnitType::CSS_VALUE_ID:</span>
 886         return valueName(m_value.valueID);
<span class="line-modified"> 887     case CSSUnitType::CSS_PROPERTY_ID:</span>
 888         return propertyName(m_value.propertyID);
 889     default:
 890         return String();
 891     }
 892 }
 893 
<span class="line-modified"> 894 NEVER_INLINE String CSSPrimitiveValue::formatNumberValue(StringView suffix) const</span>














 895 {
<span class="line-modified"> 896     return makeString(m_value.num, suffix);</span>




 897 }
 898 
<span class="line-modified"> 899 String CSSPrimitiveValue::unitTypeString(CSSUnitType unitType)</span>
 900 {
<span class="line-modified"> 901     switch (unitType) {</span>
<span class="line-added"> 902         case CSSUnitType::CSS_PERCENTAGE: return &quot;%&quot;;</span>
<span class="line-added"> 903         case CSSUnitType::CSS_EMS: return &quot;em&quot;;</span>
<span class="line-added"> 904         case CSSUnitType::CSS_EXS: return &quot;ex&quot;;</span>
<span class="line-added"> 905         case CSSUnitType::CSS_PX: return &quot;px&quot;;</span>
<span class="line-added"> 906         case CSSUnitType::CSS_CM: return &quot;cm&quot;;</span>
<span class="line-added"> 907         case CSSUnitType::CSS_MM: return &quot;mm&quot;;</span>
<span class="line-added"> 908         case CSSUnitType::CSS_IN: return &quot;in&quot;;</span>
<span class="line-added"> 909         case CSSUnitType::CSS_PT: return &quot;pt&quot;;</span>
<span class="line-added"> 910         case CSSUnitType::CSS_PC: return &quot;pc&quot;;</span>
<span class="line-added"> 911         case CSSUnitType::CSS_DEG: return &quot;deg&quot;;</span>
<span class="line-added"> 912         case CSSUnitType::CSS_RAD: return &quot;rad&quot;;</span>
<span class="line-added"> 913         case CSSUnitType::CSS_GRAD: return &quot;grad&quot;;</span>
<span class="line-added"> 914         case CSSUnitType::CSS_MS: return &quot;ms&quot;;</span>
<span class="line-added"> 915         case CSSUnitType::CSS_S: return &quot;s&quot;;</span>
<span class="line-added"> 916         case CSSUnitType::CSS_HZ: return &quot;hz&quot;;</span>
<span class="line-added"> 917         case CSSUnitType::CSS_KHZ: return &quot;khz&quot;;</span>
<span class="line-added"> 918         case CSSUnitType::CSS_VW: return &quot;vw&quot;;</span>
<span class="line-added"> 919         case CSSUnitType::CSS_VH: return &quot;vh&quot;;</span>
<span class="line-added"> 920         case CSSUnitType::CSS_VMIN: return &quot;vmin&quot;;</span>
<span class="line-added"> 921         case CSSUnitType::CSS_VMAX: return &quot;vmax&quot;;</span>
<span class="line-added"> 922         case CSSUnitType::CSS_DPPX: return &quot;dppx&quot;;</span>
<span class="line-added"> 923         case CSSUnitType::CSS_DPI: return &quot;dpi&quot;;</span>
<span class="line-added"> 924         case CSSUnitType::CSS_DPCM: return &quot;dpcm&quot;;</span>
<span class="line-added"> 925         case CSSUnitType::CSS_FR: return &quot;fr&quot;;</span>
<span class="line-added"> 926         case CSSUnitType::CSS_Q: return &quot;q&quot;;</span>
<span class="line-added"> 927         case CSSUnitType::CSS_TURN: return &quot;turn&quot;;</span>
<span class="line-added"> 928         case CSSUnitType::CSS_REMS: return &quot;rem&quot;;</span>
<span class="line-added"> 929         case CSSUnitType::CSS_CHS: return &quot;ch&quot;;</span>
<span class="line-added"> 930 </span>
<span class="line-added"> 931         case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-added"> 932         case CSSUnitType::CSS_NUMBER:</span>
<span class="line-added"> 933         case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-added"> 934         case CSSUnitType::CSS_STRING:</span>
<span class="line-added"> 935         case CSSUnitType::CSS_URI:</span>
<span class="line-added"> 936         case CSSUnitType::CSS_IDENT:</span>
<span class="line-added"> 937         case CSSUnitType::CSS_ATTR:</span>
<span class="line-added"> 938         case CSSUnitType::CSS_COUNTER:</span>
<span class="line-added"> 939         case CSSUnitType::CSS_RECT:</span>
<span class="line-added"> 940         case CSSUnitType::CSS_RGBCOLOR:</span>
<span class="line-added"> 941         case CSSUnitType::CSS_PAIR:</span>
<span class="line-added"> 942         case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-added"> 943         case CSSUnitType::CSS_COUNTER_NAME:</span>
<span class="line-added"> 944         case CSSUnitType::CSS_SHAPE:</span>
<span class="line-added"> 945         case CSSUnitType::CSS_QUAD:</span>
<span class="line-added"> 946         case CSSUnitType::CSS_CALC:</span>
<span class="line-added"> 947         case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-added"> 948         case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-added"> 949         case CSSUnitType::CSS_FONT_FAMILY:</span>
<span class="line-added"> 950         case CSSUnitType::CSS_PROPERTY_ID:</span>
<span class="line-added"> 951         case CSSUnitType::CSS_VALUE_ID:</span>
<span class="line-added"> 952         case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-added"> 953             return emptyString();</span>
<span class="line-added"> 954     }</span>
<span class="line-added"> 955     return emptyString();</span>
 956 }
 957 
 958 ALWAYS_INLINE String CSSPrimitiveValue::formatNumberForCustomCSSText() const
 959 {
<span class="line-modified"> 960     switch (primitiveUnitType()) {</span>
<span class="line-modified"> 961     case CSSUnitType::CSS_UNKNOWN:</span>
 962         return String();
<span class="line-modified"> 963     case CSSUnitType::CSS_NUMBER:</span>
 964         return formatNumberValue(&quot;&quot;);
<span class="line-modified"> 965     case CSSUnitType::CSS_PERCENTAGE:</span>
 966         return formatNumberValue(&quot;%&quot;);
<span class="line-modified"> 967     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified"> 968     case CSSUnitType::CSS_QUIRKY_EMS:</span>
 969         return formatNumberValue(&quot;em&quot;);
<span class="line-modified"> 970     case CSSUnitType::CSS_EXS:</span>
 971         return formatNumberValue(&quot;ex&quot;);
<span class="line-modified"> 972     case CSSUnitType::CSS_REMS:</span>
 973         return formatNumberValue(&quot;rem&quot;);
<span class="line-modified"> 974     case CSSUnitType::CSS_CHS:</span>
 975         return formatNumberValue(&quot;ch&quot;);
<span class="line-modified"> 976     case CSSUnitType::CSS_PX:</span>
 977         return formatNumberValue(&quot;px&quot;);
<span class="line-modified"> 978     case CSSUnitType::CSS_CM:</span>
 979         return formatNumberValue(&quot;cm&quot;);
<span class="line-modified"> 980     case CSSUnitType::CSS_DPPX:</span>

 981         return formatNumberValue(&quot;dppx&quot;);
<span class="line-modified"> 982     case CSSUnitType::CSS_DPI:</span>
 983         return formatNumberValue(&quot;dpi&quot;);
<span class="line-modified"> 984     case CSSUnitType::CSS_DPCM:</span>
 985         return formatNumberValue(&quot;dpcm&quot;);
<span class="line-modified"> 986     case CSSUnitType::CSS_MM:</span>

 987         return formatNumberValue(&quot;mm&quot;);
<span class="line-modified"> 988     case CSSUnitType::CSS_IN:</span>
 989         return formatNumberValue(&quot;in&quot;);
<span class="line-modified"> 990     case CSSUnitType::CSS_PT:</span>
 991         return formatNumberValue(&quot;pt&quot;);
<span class="line-modified"> 992     case CSSUnitType::CSS_PC:</span>
 993         return formatNumberValue(&quot;pc&quot;);
<span class="line-modified"> 994     case CSSUnitType::CSS_DEG:</span>
 995         return formatNumberValue(&quot;deg&quot;);
<span class="line-modified"> 996     case CSSUnitType::CSS_RAD:</span>
 997         return formatNumberValue(&quot;rad&quot;);
<span class="line-modified"> 998     case CSSUnitType::CSS_GRAD:</span>
 999         return formatNumberValue(&quot;grad&quot;);
<span class="line-modified">1000     case CSSUnitType::CSS_MS:</span>
1001         return formatNumberValue(&quot;ms&quot;);
<span class="line-modified">1002     case CSSUnitType::CSS_S:</span>
1003         return formatNumberValue(&quot;s&quot;);
<span class="line-modified">1004     case CSSUnitType::CSS_HZ:</span>
1005         return formatNumberValue(&quot;hz&quot;);
<span class="line-modified">1006     case CSSUnitType::CSS_KHZ:</span>
1007         return formatNumberValue(&quot;khz&quot;);
<span class="line-modified">1008     case CSSUnitType::CSS_TURN:</span>
1009         return formatNumberValue(&quot;turn&quot;);
<span class="line-modified">1010     case CSSUnitType::CSS_FR:</span>
1011         return formatNumberValue(&quot;fr&quot;);
<span class="line-modified">1012     case CSSUnitType::CSS_Q:</span>
<span class="line-modified">1013         return formatNumberValue(&quot;q&quot;);</span>
<span class="line-added">1014     case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-added">1015         // FIXME: We currently don&#39;t handle CSSUnitType::CSS_DIMENSION properly as we don&#39;t store</span>
1016         // the actual dimension, just the numeric value as a string.
<span class="line-modified">1017     case CSSUnitType::CSS_STRING:</span>
1018         // FIME-NEWPARSER: Once we have CSSCustomIdentValue hooked up, this can just be
1019         // serializeString, since custom identifiers won&#39;t be the same value as strings
1020         // any longer.
1021         return serializeAsStringOrCustomIdent(m_value.string);
<span class="line-modified">1022     case CSSUnitType::CSS_FONT_FAMILY:</span>
1023         return serializeFontFamily(m_value.fontFamily-&gt;familyName);
<span class="line-modified">1024     case CSSUnitType::CSS_URI:</span>
1025         return serializeURL(m_value.string);
<span class="line-modified">1026     case CSSUnitType::CSS_VALUE_ID:</span>
1027         return valueName(m_value.valueID);
<span class="line-modified">1028     case CSSUnitType::CSS_PROPERTY_ID:</span>
1029         return propertyName(m_value.propertyID);
<span class="line-modified">1030     case CSSUnitType::CSS_ATTR:</span>
1031         return &quot;attr(&quot; + String(m_value.string) + &#39;)&#39;;
<span class="line-modified">1032     case CSSUnitType::CSS_COUNTER_NAME:</span>
1033         return &quot;counter(&quot; + String(m_value.string) + &#39;)&#39;;
<span class="line-modified">1034     case CSSUnitType::CSS_COUNTER: {</span>
1035         StringBuilder result;
1036         String separator = m_value.counter-&gt;separator();
1037         if (separator.isEmpty())
1038             result.appendLiteral(&quot;counter(&quot;);
1039         else
1040             result.appendLiteral(&quot;counters(&quot;);
1041 
1042         result.append(m_value.counter-&gt;identifier());
1043         if (!separator.isEmpty()) {
1044             result.appendLiteral(&quot;, &quot;);
1045             serializeString(separator, result);
1046         }
1047         String listStyle = m_value.counter-&gt;listStyle();
1048         if (!listStyle.isEmpty())
1049             result.append(&quot;, &quot;, listStyle);
1050         result.append(&#39;)&#39;);
1051 
1052         return result.toString();
1053     }
<span class="line-modified">1054     case CSSUnitType::CSS_RECT:</span>
1055         return rectValue()-&gt;cssText();
<span class="line-modified">1056     case CSSUnitType::CSS_QUAD:</span>
1057         return quadValue()-&gt;cssText();
<span class="line-modified">1058     case CSSUnitType::CSS_RGBCOLOR:</span>
1059         return color().cssText();
<span class="line-modified">1060     case CSSUnitType::CSS_PAIR:</span>
1061         return pairValue()-&gt;cssText();
<span class="line-modified">1062     case CSSUnitType::CSS_CALC:</span>
1063         return m_value.calc-&gt;cssText();
<span class="line-modified">1064     case CSSUnitType::CSS_SHAPE:</span>
1065         return m_value.shape-&gt;cssText();
<span class="line-modified">1066     case CSSUnitType::CSS_VW:</span>
1067         return formatNumberValue(&quot;vw&quot;);
<span class="line-modified">1068     case CSSUnitType::CSS_VH:</span>
1069         return formatNumberValue(&quot;vh&quot;);
<span class="line-modified">1070     case CSSUnitType::CSS_VMIN:</span>
1071         return formatNumberValue(&quot;vmin&quot;);
<span class="line-modified">1072     case CSSUnitType::CSS_VMAX:</span>
1073         return formatNumberValue(&quot;vmax&quot;);
<span class="line-added">1074     case CSSUnitType::CSS_IDENT:</span>
<span class="line-added">1075     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-added">1076     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-added">1077     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-added">1078         ASSERT_NOT_REACHED();</span>
1079     }
1080     return String();
1081 }
1082 
1083 String CSSPrimitiveValue::customCSSText() const
1084 {
1085     // FIXME: return the original value instead of a generated one (e.g. color
1086     // name if it was specified) - check what spec says about this
1087 
1088     CSSTextCache&amp; cssTextCache = WebCore::cssTextCache();
1089 
1090     if (m_hasCachedCSSText) {
1091         ASSERT(cssTextCache.contains(this));
1092         return cssTextCache.get(this);
1093     }
1094 
1095     String text = formatNumberForCustomCSSText();
1096 
1097     ASSERT(!cssTextCache.contains(this));
1098     m_hasCachedCSSText = true;
1099     cssTextCache.set(this, text);
1100     return text;
1101 }
1102 
1103 bool CSSPrimitiveValue::equals(const CSSPrimitiveValue&amp; other) const
1104 {
<span class="line-modified">1105     if (primitiveUnitType() != other.primitiveUnitType())</span>
1106         return false;
1107 
<span class="line-modified">1108     switch (primitiveUnitType()) {</span>
<span class="line-modified">1109     case CSSUnitType::CSS_UNKNOWN:</span>
1110         return false;
<span class="line-modified">1111     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-modified">1112     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-modified">1113     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified">1114     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified">1115     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified">1116     case CSSUnitType::CSS_REMS:</span>
<span class="line-modified">1117     case CSSUnitType::CSS_CHS:</span>
<span class="line-modified">1118     case CSSUnitType::CSS_PX:</span>
<span class="line-modified">1119     case CSSUnitType::CSS_CM:</span>
<span class="line-modified">1120     case CSSUnitType::CSS_DPPX:</span>
<span class="line-modified">1121     case CSSUnitType::CSS_DPI:</span>
<span class="line-modified">1122     case CSSUnitType::CSS_DPCM:</span>
<span class="line-modified">1123     case CSSUnitType::CSS_MM:</span>
<span class="line-modified">1124     case CSSUnitType::CSS_IN:</span>
<span class="line-modified">1125     case CSSUnitType::CSS_PT:</span>
<span class="line-modified">1126     case CSSUnitType::CSS_PC:</span>
<span class="line-modified">1127     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified">1128     case CSSUnitType::CSS_RAD:</span>
<span class="line-modified">1129     case CSSUnitType::CSS_GRAD:</span>
<span class="line-modified">1130     case CSSUnitType::CSS_MS:</span>
<span class="line-modified">1131     case CSSUnitType::CSS_S:</span>
<span class="line-modified">1132     case CSSUnitType::CSS_HZ:</span>
<span class="line-modified">1133     case CSSUnitType::CSS_KHZ:</span>
<span class="line-modified">1134     case CSSUnitType::CSS_TURN:</span>
<span class="line-modified">1135     case CSSUnitType::CSS_VW:</span>
<span class="line-modified">1136     case CSSUnitType::CSS_VH:</span>
<span class="line-modified">1137     case CSSUnitType::CSS_VMIN:</span>
<span class="line-modified">1138     case CSSUnitType::CSS_VMAX:</span>
<span class="line-modified">1139     case CSSUnitType::CSS_FR:</span>
<span class="line-added">1140     case CSSUnitType::CSS_Q:</span>
1141         return m_value.num == other.m_value.num;
<span class="line-modified">1142     case CSSUnitType::CSS_PROPERTY_ID:</span>
1143         return propertyName(m_value.propertyID) == propertyName(other.m_value.propertyID);
<span class="line-modified">1144     case CSSUnitType::CSS_VALUE_ID:</span>
1145         return valueName(m_value.valueID) == valueName(other.m_value.valueID);
<span class="line-modified">1146     case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-modified">1147     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified">1148     case CSSUnitType::CSS_URI:</span>
<span class="line-modified">1149     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified">1150     case CSSUnitType::CSS_COUNTER_NAME:</span>
1151         return equal(m_value.string, other.m_value.string);
<span class="line-modified">1152     case CSSUnitType::CSS_COUNTER:</span>
1153         return m_value.counter &amp;&amp; other.m_value.counter &amp;&amp; m_value.counter-&gt;equals(*other.m_value.counter);
<span class="line-modified">1154     case CSSUnitType::CSS_RECT:</span>
1155         return m_value.rect &amp;&amp; other.m_value.rect &amp;&amp; m_value.rect-&gt;equals(*other.m_value.rect);
<span class="line-modified">1156     case CSSUnitType::CSS_QUAD:</span>
1157         return m_value.quad &amp;&amp; other.m_value.quad &amp;&amp; m_value.quad-&gt;equals(*other.m_value.quad);
<span class="line-modified">1158     case CSSUnitType::CSS_RGBCOLOR:</span>
1159         return color() == other.color();
<span class="line-modified">1160     case CSSUnitType::CSS_PAIR:</span>
1161         return m_value.pair &amp;&amp; other.m_value.pair &amp;&amp; m_value.pair-&gt;equals(*other.m_value.pair);
<span class="line-modified">1162     case CSSUnitType::CSS_CALC:</span>
1163         return m_value.calc &amp;&amp; other.m_value.calc &amp;&amp; m_value.calc-&gt;equals(*other.m_value.calc);
<span class="line-modified">1164     case CSSUnitType::CSS_SHAPE:</span>
1165         return m_value.shape &amp;&amp; other.m_value.shape &amp;&amp; m_value.shape-&gt;equals(*other.m_value.shape);
<span class="line-modified">1166     case CSSUnitType::CSS_FONT_FAMILY:</span>
1167         return fontFamily() == other.fontFamily();
<span class="line-added">1168     case CSSUnitType::CSS_IDENT:</span>
<span class="line-added">1169     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-added">1170     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-added">1171     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-added">1172         // FIXME: seems like these should be handled.</span>
<span class="line-added">1173         ASSERT_NOT_REACHED();</span>
<span class="line-added">1174         break;</span>
1175     }
1176     return false;
1177 }
1178 
1179 Ref&lt;DeprecatedCSSOMPrimitiveValue&gt; CSSPrimitiveValue::createDeprecatedCSSOMPrimitiveWrapper(CSSStyleDeclaration&amp; styleDeclaration) const
1180 {
1181     return DeprecatedCSSOMPrimitiveValue::create(*this, styleDeclaration);
1182 }
1183 
1184 // https://drafts.css-houdini.org/css-properties-values-api/#dependency-cycles-via-relative-units
1185 void CSSPrimitiveValue::collectDirectComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
1186 {
<span class="line-modified">1187     switch (primitiveUnitType()) {</span>
<span class="line-modified">1188     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified">1189     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified">1190     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified">1191     case CSSUnitType::CSS_CHS:</span>
1192         values.add(CSSPropertyFontSize);
1193         break;
<span class="line-modified">1194     case CSSUnitType::CSS_CALC:</span>
1195         m_value.calc-&gt;collectDirectComputationalDependencies(values);
1196         break;
<span class="line-added">1197     default:</span>
<span class="line-added">1198         break;</span>
1199     }
1200 }
1201 
1202 void CSSPrimitiveValue::collectDirectRootComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
1203 {
<span class="line-modified">1204     switch (primitiveUnitType()) {</span>
<span class="line-modified">1205     case CSSUnitType::CSS_REMS:</span>
1206         values.add(CSSPropertyFontSize);
1207         break;
<span class="line-modified">1208     case CSSUnitType::CSS_CALC:</span>
1209         m_value.calc-&gt;collectDirectRootComputationalDependencies(values);
1210         break;
<span class="line-added">1211     default:</span>
<span class="line-added">1212         break;</span>
1213     }
1214 }
1215 
1216 } // namespace WebCore
</pre>
</td>
</tr>
</table>
<center><a href="CSSNamedImageValue.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CSSPrimitiveValue.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>