<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/applepay/paymentrequest/ApplePayPaymentHandler.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../PaymentSession.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ApplePayPaymentHandler.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/applepay/paymentrequest/ApplePayPaymentHandler.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -39,27 +39,52 @@</span>
  #include &quot;Frame.h&quot;
  #include &quot;JSApplePayError.h&quot;
  #include &quot;JSApplePayPayment.h&quot;
  #include &quot;JSApplePayPaymentMethod.h&quot;
  #include &quot;JSApplePayRequest.h&quot;
<span class="udiff-line-added">+ #include &quot;JSDOMConvert.h&quot;</span>
  #include &quot;LinkIconCollector.h&quot;
  #include &quot;MerchantValidationEvent.h&quot;
  #include &quot;Page.h&quot;
  #include &quot;PayerErrorFields.h&quot;
  #include &quot;Payment.h&quot;
  #include &quot;PaymentAuthorizationStatus.h&quot;
  #include &quot;PaymentContact.h&quot;
  #include &quot;PaymentCoordinator.h&quot;
  #include &quot;PaymentMerchantSession.h&quot;
  #include &quot;PaymentMethod.h&quot;
<span class="udiff-line-added">+ #include &quot;PaymentMethodUpdate.h&quot;</span>
  #include &quot;PaymentRequestValidator.h&quot;
  #include &quot;PaymentResponse.h&quot;
  #include &quot;PaymentValidationErrors.h&quot;
  #include &quot;Settings.h&quot;
<span class="udiff-line-added">+ #include &lt;JavaScriptCore/JSONObject.h&gt;</span>
  
  namespace WebCore {
  
<span class="udiff-line-added">+ static ExceptionOr&lt;ApplePayRequest&gt; convertAndValidate(ScriptExecutionContext&amp; context, JSC::JSValue data)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (data.isEmpty())</span>
<span class="udiff-line-added">+         return Exception { TypeError, &quot;Missing payment method data.&quot; };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto throwScope = DECLARE_THROW_SCOPE(context.vm());</span>
<span class="udiff-line-added">+     auto applePayRequest = convertDictionary&lt;ApplePayRequest&gt;(*context.execState(), data);</span>
<span class="udiff-line-added">+     if (throwScope.exception())</span>
<span class="udiff-line-added">+         return Exception { ExistingExceptionError };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return WTFMove(applePayRequest);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ExceptionOr&lt;void&gt; ApplePayPaymentHandler::validateData(Document&amp; document, JSC::JSValue data)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto requestOrException = convertAndValidate(document, data);</span>
<span class="udiff-line-added">+     if (requestOrException.hasException())</span>
<span class="udiff-line-added">+         return requestOrException.releaseException();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return { };</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  bool ApplePayPaymentHandler::handlesIdentifier(const PaymentRequest::MethodIdentifier&amp; identifier)
  {
      if (!WTF::holds_alternative&lt;URL&gt;(identifier))
          return false;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -155,22 +180,17 @@</span>
      result.label = shippingOption.label;
      result.identifier = shippingOption.id;
      return { WTFMove(result) };
  }
  
<span class="udiff-line-modified-removed">- ExceptionOr&lt;void&gt; ApplePayPaymentHandler::convertData(JSC::JSValue&amp;&amp; data)</span>
<span class="udiff-line-modified-added">+ ExceptionOr&lt;void&gt; ApplePayPaymentHandler::convertData(JSC::JSValue data)</span>
  {
<span class="udiff-line-modified-removed">-     if (data.isEmpty())</span>
<span class="udiff-line-modified-removed">-         return Exception { TypeError, &quot;Missing payment method data.&quot; };</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-     auto&amp; context = *scriptExecutionContext();</span>
<span class="udiff-line-removed">-     auto throwScope = DECLARE_THROW_SCOPE(context.vm());</span>
<span class="udiff-line-removed">-     auto applePayRequest = convertDictionary&lt;ApplePayRequest&gt;(*context.execState(), WTFMove(data));</span>
<span class="udiff-line-removed">-     if (throwScope.exception())</span>
<span class="udiff-line-removed">-         return Exception { ExistingExceptionError };</span>
<span class="udiff-line-modified-added">+     auto requestOrException = convertAndValidate(*scriptExecutionContext(), data);</span>
<span class="udiff-line-modified-added">+     if (requestOrException.hasException())</span>
<span class="udiff-line-modified-added">+         return requestOrException.releaseException();</span>
  
<span class="udiff-line-modified-removed">-     m_applePayRequest = WTFMove(applePayRequest);</span>
<span class="udiff-line-modified-added">+     m_applePayRequest = requestOrException.releaseReturnValue();</span>
      return { };
  }
  
  static void mergePaymentOptions(const PaymentOptions&amp; options, ApplePaySessionPaymentRequest&amp; request)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -279,21 +299,21 @@</span>
              continue;
  
          if (serializedModifierData[i].isEmpty())
              continue;
  
<span class="udiff-line-modified-removed">-         auto&amp; execState = *document().execState();</span>
<span class="udiff-line-modified-removed">-         auto scope = DECLARE_THROW_SCOPE(execState.vm());</span>
<span class="udiff-line-modified-added">+         auto&amp; lexicalGlobalObject = *document().execState();</span>
<span class="udiff-line-modified-added">+         auto scope = DECLARE_THROW_SCOPE(lexicalGlobalObject.vm());</span>
          JSC::JSValue data;
          {
<span class="udiff-line-modified-removed">-             auto lock = JSC::JSLockHolder { &amp;execState };</span>
<span class="udiff-line-modified-removed">-             data = JSONParse(&amp;execState, serializedModifierData[i]);</span>
<span class="udiff-line-modified-added">+             auto lock = JSC::JSLockHolder { &amp;lexicalGlobalObject };</span>
<span class="udiff-line-modified-added">+             data = JSONParse(&amp;lexicalGlobalObject, serializedModifierData[i]);</span>
              if (scope.exception())
                  return Exception { ExistingExceptionError };
          }
  
<span class="udiff-line-modified-removed">-         auto applePayModifier = convertDictionary&lt;ApplePayModifier&gt;(execState, WTFMove(data));</span>
<span class="udiff-line-modified-added">+         auto applePayModifier = convertDictionary&lt;ApplePayModifier&gt;(lexicalGlobalObject, WTFMove(data));</span>
          if (scope.exception())
              return Exception { ExistingExceptionError };
  
          if (applePayModifier.paymentMethodType != *m_selectedPaymentMethodType)
              continue;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -471,18 +491,15 @@</span>
  ExceptionOr&lt;void&gt; ApplePayPaymentHandler::paymentMethodUpdated()
  {
      ASSERT(m_isUpdating);
      m_isUpdating = false;
  
<span class="udiff-line-removed">-     PaymentMethodUpdate update;</span>
<span class="udiff-line-removed">- </span>
      auto newTotalAndLineItems = computeTotalAndLineItems();
      if (newTotalAndLineItems.hasException())
          return newTotalAndLineItems.releaseException();
<span class="udiff-line-removed">-     update.newTotalAndLineItems = newTotalAndLineItems.releaseReturnValue();</span>
  
<span class="udiff-line-modified-removed">-     paymentCoordinator().completePaymentMethodSelection(WTFMove(update));</span>
<span class="udiff-line-modified-added">+     paymentCoordinator().completePaymentMethodSelection(PaymentMethodUpdate { newTotalAndLineItems.releaseReturnValue() });</span>
      return { };
  }
  
  void ApplePayPaymentHandler::complete(Optional&lt;PaymentComplete&gt;&amp;&amp; result)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -543,24 +560,24 @@</span>
  {
      return PaymentAddress::create(contact.countryCode, contact.addressLines.valueOr(Vector&lt;String&gt;()), contact.administrativeArea, contact.locality, contact.subLocality, contact.postalCode, String(), String(), contact.localizedName, contact.phoneNumber);
  }
  
  template&lt;typename T&gt;
<span class="udiff-line-modified-removed">- static JSC::Strong&lt;JSC::JSObject&gt; toJSDictionary(JSC::ExecState&amp; execState, const T&amp; value)</span>
<span class="udiff-line-modified-added">+ static JSC::Strong&lt;JSC::JSObject&gt; toJSDictionary(JSC::JSGlobalObject&amp; lexicalGlobalObject, const T&amp; value)</span>
  {
<span class="udiff-line-modified-removed">-     JSC::JSLockHolder lock { &amp;execState };</span>
<span class="udiff-line-modified-removed">-     return { execState.vm(), asObject(toJS&lt;IDLDictionary&lt;T&gt;&gt;(execState, *JSC::jsCast&lt;JSDOMGlobalObject*&gt;(execState.lexicalGlobalObject()), value)) };</span>
<span class="udiff-line-modified-added">+     JSC::JSLockHolder lock { &amp;lexicalGlobalObject };</span>
<span class="udiff-line-modified-added">+     return { lexicalGlobalObject.vm(), asObject(toJS&lt;IDLDictionary&lt;T&gt;&gt;(lexicalGlobalObject, *JSC::jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject), value)) };</span>
  }
  
  void ApplePayPaymentHandler::didAuthorizePayment(const Payment&amp; payment)
  {
      ASSERT(!m_isUpdating);
  
      auto applePayPayment = payment.toApplePayPayment(version());
      auto shippingContact = applePayPayment.shippingContact.valueOr(ApplePayPaymentContact());
<span class="udiff-line-modified-removed">-     auto detailsFunction = [applePayPayment = WTFMove(applePayPayment)](JSC::ExecState&amp; execState) {</span>
<span class="udiff-line-modified-removed">-         return toJSDictionary(execState, applePayPayment);</span>
<span class="udiff-line-modified-added">+     auto detailsFunction = [applePayPayment = WTFMove(applePayPayment)](JSC::JSGlobalObject&amp; lexicalGlobalObject) {</span>
<span class="udiff-line-modified-added">+         return toJSDictionary(lexicalGlobalObject, applePayPayment);</span>
      };
  
      m_paymentRequest-&gt;accept(WTF::get&lt;URL&gt;(m_identifier).string(), WTFMove(detailsFunction), convert(shippingContact), shippingContact.localizedName, shippingContact.emailAddress, shippingContact.phoneNumber);
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -585,16 +602,16 @@</span>
      ASSERT(!m_isUpdating);
      m_isUpdating = true;
  
      auto applePayPaymentMethod = paymentMethod.toApplePayPaymentMethod();
      m_selectedPaymentMethodType = applePayPaymentMethod.type;
<span class="udiff-line-modified-removed">-     m_paymentRequest-&gt;paymentMethodChanged(WTF::get&lt;URL&gt;(m_identifier).string(), [applePayPaymentMethod = WTFMove(applePayPaymentMethod)](JSC::ExecState&amp; execState) {</span>
<span class="udiff-line-modified-removed">-         return toJSDictionary(execState, applePayPaymentMethod);</span>
<span class="udiff-line-modified-added">+     m_paymentRequest-&gt;paymentMethodChanged(WTF::get&lt;URL&gt;(m_identifier).string(), [applePayPaymentMethod = WTFMove(applePayPaymentMethod)](JSC::JSGlobalObject&amp; lexicalGlobalObject) {</span>
<span class="udiff-line-modified-added">+         return toJSDictionary(lexicalGlobalObject, applePayPaymentMethod);</span>
      });
  }
  
<span class="udiff-line-modified-removed">- void ApplePayPaymentHandler::didCancelPaymentSession()</span>
<span class="udiff-line-modified-added">+ void ApplePayPaymentHandler::didCancelPaymentSession(PaymentSessionError&amp;&amp;)</span>
  {
      m_paymentRequest-&gt;cancel();
  }
  
  } // namespace WebCore
</pre>
<center><a href="../PaymentSession.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ApplePayPaymentHandler.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>