<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/libwebrtc/LibWebRTCRtpSenderBackend.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="LibWebRTCRtpReceiverBackend.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="LibWebRTCRtpSenderBackend.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/libwebrtc/LibWebRTCRtpSenderBackend.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -25,59 +25,77 @@</span>
  #include &quot;config.h&quot;
  #include &quot;LibWebRTCRtpSenderBackend.h&quot;
  
  #if ENABLE(WEB_RTC) &amp;&amp; USE(LIBWEBRTC)
  
<span class="udiff-line-added">+ #include &quot;JSDOMPromiseDeferred.h&quot;</span>
  #include &quot;LibWebRTCDTMFSenderBackend.h&quot;
  #include &quot;LibWebRTCPeerConnectionBackend.h&quot;
  #include &quot;LibWebRTCUtils.h&quot;
  #include &quot;RTCPeerConnection.h&quot;
  #include &quot;RTCRtpSender.h&quot;
<span class="udiff-line-removed">- #include &quot;RuntimeEnabledFeatures.h&quot;</span>
  #include &quot;ScriptExecutionContext.h&quot;
  
  namespace WebCore {
  
<span class="udiff-line-modified-removed">- template&lt;typename Source&gt;</span>
<span class="udiff-line-modified-removed">- static inline bool updateTrackSource(Source&amp; source, MediaStreamTrack* track)</span>
<span class="udiff-line-modified-added">+ LibWebRTCRtpSenderBackend::LibWebRTCRtpSenderBackend(LibWebRTCPeerConnectionBackend&amp; backend, rtc::scoped_refptr&lt;webrtc::RtpSenderInterface&gt;&amp;&amp; rtcSender, Source&amp;&amp; source)</span>
<span class="udiff-line-modified-added">+     : m_peerConnectionBackend(makeWeakPtr(&amp;backend))</span>
<span class="udiff-line-added">+     , m_rtcSender(WTFMove(rtcSender))</span>
<span class="udiff-line-added">+     , m_source(WTFMove(source))</span>
  {
<span class="udiff-line-modified-removed">-     if (!track) {</span>
<span class="udiff-line-modified-removed">-         source.stop();</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">-     return source.setSource(track-&gt;privateTrack());</span>
<span class="udiff-line-modified-added">+     startSource();</span>
<span class="udiff-line-modified-added">+ }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ LibWebRTCRtpSenderBackend::~LibWebRTCRtpSenderBackend()</span>
<span class="udiff-line-modified-added">+ {</span>
<span class="udiff-line-added">+     stopSource();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void LibWebRTCRtpSenderBackend::startSource()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     switchOn(m_source, [](Ref&lt;RealtimeOutgoingAudioSource&gt;&amp; source) {</span>
<span class="udiff-line-added">+         source-&gt;start();</span>
<span class="udiff-line-added">+     }, [](Ref&lt;RealtimeOutgoingVideoSource&gt;&amp; source) {</span>
<span class="udiff-line-added">+         source-&gt;start();</span>
<span class="udiff-line-added">+     }, [](std::nullptr_t&amp;) {</span>
<span class="udiff-line-added">+     });</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void LibWebRTCRtpSenderBackend::stopSource()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     switchOn(m_source, [](Ref&lt;RealtimeOutgoingAudioSource&gt;&amp; source) {</span>
<span class="udiff-line-added">+         source-&gt;stop();</span>
<span class="udiff-line-added">+     }, [](Ref&lt;RealtimeOutgoingVideoSource&gt;&amp; source) {</span>
<span class="udiff-line-added">+         source-&gt;stop();</span>
<span class="udiff-line-added">+     }, [](std::nullptr_t&amp;) {</span>
<span class="udiff-line-added">+     });</span>
<span class="udiff-line-added">+     m_source = nullptr;</span>
  }
  
  void LibWebRTCRtpSenderBackend::replaceTrack(ScriptExecutionContext&amp; context, RTCRtpSender&amp; sender, RefPtr&lt;MediaStreamTrack&gt;&amp;&amp; track, DOMPromiseDeferred&lt;void&gt;&amp;&amp; promise)
  {
      if (!m_peerConnectionBackend) {
          promise.reject(Exception { InvalidStateError, &quot;No WebRTC backend&quot;_s });
          return;
      }
  
<span class="udiff-line-modified-removed">-     auto* currentTrack = sender.track();</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     ASSERT(!track || !currentTrack || currentTrack-&gt;source().type() == track-&gt;source().type());</span>
<span class="udiff-line-modified-removed">-     if (currentTrack) {</span>
<span class="udiff-line-modified-removed">-     switch (currentTrack-&gt;source().type()) {</span>
<span class="udiff-line-modified-removed">-     case RealtimeMediaSource::Type::None:</span>
<span class="udiff-line-modified-removed">-         ASSERT_NOT_REACHED();</span>
<span class="udiff-line-modified-removed">-         promise.reject(InvalidModificationError);</span>
<span class="udiff-line-modified-removed">-         break;</span>
<span class="udiff-line-modified-removed">-     case RealtimeMediaSource::Type::Audio:</span>
<span class="udiff-line-modified-removed">-         if (!updateTrackSource(*audioSource(), track.get())) {</span>
<span class="udiff-line-modified-removed">-             promise.reject(InvalidModificationError);</span>
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         break;</span>
<span class="udiff-line-modified-removed">-     case RealtimeMediaSource::Type::Video:</span>
<span class="udiff-line-removed">-         if (!updateTrackSource(*videoSource(), track.get())) {</span>
<span class="udiff-line-removed">-             promise.reject(InvalidModificationError);</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         break;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     if (!track)</span>
<span class="udiff-line-modified-added">+         stopSource();</span>
<span class="udiff-line-modified-added">+     else if (sender.track()) {</span>
<span class="udiff-line-modified-added">+         switchOn(m_source, [&amp;](Ref&lt;RealtimeOutgoingAudioSource&gt;&amp; source) {</span>
<span class="udiff-line-modified-added">+             ASSERT(track-&gt;source().type() == RealtimeMediaSource::Type::Audio);</span>
<span class="udiff-line-modified-added">+             source-&gt;stop();</span>
<span class="udiff-line-modified-added">+             source-&gt;setSource(track-&gt;privateTrack());</span>
<span class="udiff-line-modified-added">+             source-&gt;start();</span>
<span class="udiff-line-modified-added">+         }, [&amp;](Ref&lt;RealtimeOutgoingVideoSource&gt;&amp; source) {</span>
<span class="udiff-line-modified-added">+             ASSERT(track-&gt;source().type() == RealtimeMediaSource::Type::Video);</span>
<span class="udiff-line-modified-added">+             source-&gt;stop();</span>
<span class="udiff-line-modified-added">+             source-&gt;setSource(track-&gt;privateTrack());</span>
<span class="udiff-line-modified-added">+             source-&gt;start();</span>
<span class="udiff-line-modified-added">+         }, [](std::nullptr_t&amp;) {</span>
<span class="udiff-line-modified-added">+             ASSERT_NOT_REACHED();</span>
<span class="udiff-line-modified-added">+         });</span>
      }
  
      // FIXME: Remove this postTask once this whole function is executed as part of the RTCPeerConnection operation queue.
      context.postTask([protectedSender = makeRef(sender), promise = WTFMove(promise), track = WTFMove(track), this](ScriptExecutionContext&amp;) mutable {
          if (protectedSender-&gt;isStopped())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -95,22 +113,11 @@</span>
          if (hasTrack) {
              promise.resolve();
              return;
          }
  
<span class="udiff-line-modified-removed">-         if (RuntimeEnabledFeatures::sharedFeatures().webRTCUnifiedPlanEnabled()) {</span>
<span class="udiff-line-removed">-             m_source = nullptr;</span>
<span class="udiff-line-removed">-             m_peerConnectionBackend-&gt;setSenderSourceFromTrack(*this, *protectedSender-&gt;track());</span>
<span class="udiff-line-removed">-             promise.resolve();</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         auto result = m_peerConnectionBackend-&gt;addTrack(*protectedSender-&gt;track(), { });</span>
<span class="udiff-line-removed">-         if (result.hasException()) {</span>
<span class="udiff-line-removed">-             promise.reject(result.releaseException());</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         m_peerConnectionBackend-&gt;setSenderSourceFromTrack(*this, *protectedSender-&gt;track());</span>
          promise.resolve();
      });
  }
  
  RTCRtpSendParameters LibWebRTCRtpSenderBackend::getParameters() const
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -149,8 +156,39 @@</span>
  std::unique_ptr&lt;RTCDTMFSenderBackend&gt; LibWebRTCRtpSenderBackend::createDTMFBackend()
  {
      return makeUnique&lt;LibWebRTCDTMFSenderBackend&gt;(m_rtcSender-&gt;GetDtmfSender());
  }
  
<span class="udiff-line-added">+ RealtimeOutgoingVideoSource* LibWebRTCRtpSenderBackend::videoSource()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return switchOn(m_source,</span>
<span class="udiff-line-added">+         [](Ref&lt;RealtimeOutgoingVideoSource&gt;&amp; source) { return source.ptr(); },</span>
<span class="udiff-line-added">+         [](const auto&amp;) -&gt; RealtimeOutgoingVideoSource* { return nullptr; }</span>
<span class="udiff-line-added">+     );</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool LibWebRTCRtpSenderBackend::hasSource() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return switchOn(m_source,</span>
<span class="udiff-line-added">+         [](const std::nullptr_t&amp;) { return false; },</span>
<span class="udiff-line-added">+         [](const auto&amp;) { return true; }</span>
<span class="udiff-line-added">+     );</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void LibWebRTCRtpSenderBackend::setSource(Source&amp;&amp; source)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     stopSource();</span>
<span class="udiff-line-added">+     m_source = WTFMove(source);</span>
<span class="udiff-line-added">+     startSource();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void LibWebRTCRtpSenderBackend::takeSource(LibWebRTCRtpSenderBackend&amp; backend)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(backend.hasSource());</span>
<span class="udiff-line-added">+     stopSource();</span>
<span class="udiff-line-added">+     m_source = WTFMove(backend.m_source);</span>
<span class="udiff-line-added">+     backend.m_source = nullptr;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  } // namespace WebCore
  
  #endif // ENABLE(WEB_RTC) &amp;&amp; USE(LIBWEBRTC)
</pre>
<center><a href="LibWebRTCRtpReceiverBackend.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="LibWebRTCRtpSenderBackend.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>