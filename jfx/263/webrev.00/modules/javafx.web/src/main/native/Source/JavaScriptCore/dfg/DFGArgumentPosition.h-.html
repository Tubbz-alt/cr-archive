<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old modules/javafx.web/src/main/native/Source/JavaScriptCore/dfg/DFGArgumentPosition.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2012, 2013, 2015 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
 28 #include &quot;DFGDoubleFormatState.h&quot;
 29 #include &quot;DFGVariableAccessData.h&quot;
 30 #include &quot;DFGVariableAccessDataDump.h&quot;
 31 #include &quot;SpeculatedType.h&quot;
 32 
 33 namespace JSC { namespace DFG {
 34 
 35 class ArgumentPosition {
 36 public:
 37     ArgumentPosition()
 38         : m_prediction(SpecNone)
 39         , m_doubleFormatState(EmptyDoubleFormatState)
 40         , m_isProfitableToUnbox(false)
 41         , m_shouldNeverUnbox(false)
 42     {
 43     }
 44 
 45     void addVariable(VariableAccessData* variable)
 46     {
 47         m_variables.append(variable);
 48 
 49         // We may set this early. Merging it here saves us time in prediction propagation.
 50         variable-&gt;mergeShouldNeverUnbox(m_shouldNeverUnbox);
 51     }
 52 
 53     VariableAccessData* someVariable() const
 54     {
 55         if (m_variables.isEmpty())
 56             return 0;
 57         return m_variables[0]-&gt;find();
 58     }
 59 
 60     FlushFormat flushFormat() const
 61     {
 62         if (VariableAccessData* variable = someVariable())
 63             return variable-&gt;flushFormat();
 64         return DeadFlush;
 65     }
 66 
 67     bool mergeShouldNeverUnbox(bool shouldNeverUnbox)
 68     {
 69         return checkAndSet(m_shouldNeverUnbox, m_shouldNeverUnbox || shouldNeverUnbox);
 70     }
 71 
 72     bool mergeArgumentPredictionAwareness()
 73     {
 74         bool changed = false;
 75         for (unsigned i = 0; i &lt; m_variables.size(); ++i) {
 76             VariableAccessData* variable = m_variables[i]-&gt;find();
 77             changed |= mergeSpeculation(m_prediction, variable-&gt;argumentAwarePrediction());
 78             changed |= mergeDoubleFormatState(m_doubleFormatState, variable-&gt;doubleFormatState());
 79             changed |= mergeShouldNeverUnbox(variable-&gt;shouldNeverUnbox());
 80         }
 81         if (!changed)
 82             return false;
 83         changed = false;
 84         for (unsigned i = 0; i &lt; m_variables.size(); ++i) {
 85             VariableAccessData* variable = m_variables[i]-&gt;find();
 86             changed |= variable-&gt;mergeArgumentAwarePrediction(m_prediction);
 87             changed |= variable-&gt;mergeDoubleFormatState(m_doubleFormatState);
 88             changed |= variable-&gt;mergeShouldNeverUnbox(m_shouldNeverUnbox);
 89         }
 90         return changed;
 91     }
 92 
 93     bool mergeArgumentUnboxingAwareness()
 94     {
 95         bool changed = false;
 96         for (unsigned i = 0; i &lt; m_variables.size(); ++i) {
 97             VariableAccessData* variable = m_variables[i]-&gt;find();
 98             changed |= checkAndSet(m_isProfitableToUnbox, m_isProfitableToUnbox || variable-&gt;isProfitableToUnbox());
 99         }
100         if (!changed)
101             return false;
102         changed = false;
103         for (unsigned i = 0; i &lt; m_variables.size(); ++i) {
104             VariableAccessData* variable = m_variables[i]-&gt;find();
105             changed |= variable-&gt;mergeIsProfitableToUnbox(m_isProfitableToUnbox);
106         }
107         return changed;
108     }
109 
110     bool shouldUnboxIfPossible() const { return m_isProfitableToUnbox &amp;&amp; !m_shouldNeverUnbox; }
111 
112     SpeculatedType prediction() const { return m_prediction; }
113     DoubleFormatState doubleFormatState() const { return m_doubleFormatState; }
114     bool shouldUseDoubleFormat() const
115     {
116         return doubleFormatState() == UsingDoubleFormat &amp;&amp; shouldUnboxIfPossible();
117     }
118 
119     void dump(PrintStream&amp; out, Graph* graph)
120     {
121         for (unsigned i = 0; i &lt; m_variables.size(); ++i) {
122             VariableAccessData* variable = m_variables[i]-&gt;find();
123             VirtualRegister operand = variable-&gt;local();
124 
125             if (i)
126                 out.print(&quot; &quot;);
127 
128             out.print(operand, &quot;(&quot;, VariableAccessDataDump(*graph, variable), &quot;)&quot;);
129         }
130         out.print(&quot;\n&quot;);
131     }
132 
133 private:
134     SpeculatedType m_prediction;
135     DoubleFormatState m_doubleFormatState;
136     bool m_isProfitableToUnbox;
137     bool m_shouldNeverUnbox;
138 
139     Vector&lt;VariableAccessData*, 2&gt; m_variables;
140 };
141 
142 } } // namespace JSC::DFG
    </pre>
  </body>
</html>