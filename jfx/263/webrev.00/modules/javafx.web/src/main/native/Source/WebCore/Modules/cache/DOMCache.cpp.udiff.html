<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/cache/DOMCache.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CacheStorageConnection.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="DOMCache.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/cache/DOMCache.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -25,10 +25,11 @@</span>
  
  #include &quot;config.h&quot;
  #include &quot;DOMCache.h&quot;
  
  #include &quot;CacheQueryOptions.h&quot;
<span class="udiff-line-added">+ #include &quot;EventLoop.h&quot;</span>
  #include &quot;FetchResponse.h&quot;
  #include &quot;HTTPParsers.h&quot;
  #include &quot;JSFetchRequest.h&quot;
  #include &quot;JSFetchResponse.h&quot;
  #include &quot;ReadableStreamChunk.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -55,20 +56,22 @@</span>
          m_connection-&gt;dereference(m_identifier);
  }
  
  void DOMCache::match(RequestInfo&amp;&amp; info, CacheQueryOptions&amp;&amp; options, Ref&lt;DeferredPromise&gt;&amp;&amp; promise)
  {
<span class="udiff-line-modified-removed">-     doMatch(WTFMove(info), WTFMove(options), [promise = WTFMove(promise)](ExceptionOr&lt;FetchResponse*&gt;&amp;&amp; result) mutable {</span>
<span class="udiff-line-modified-removed">-         if (result.hasException()) {</span>
<span class="udiff-line-modified-removed">-             promise-&gt;reject(result.releaseException());</span>
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         if (!result.returnValue()) {</span>
<span class="udiff-line-modified-removed">-             promise-&gt;resolve();</span>
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         promise-&gt;resolve&lt;IDLInterface&lt;FetchResponse&gt;&gt;(*result.returnValue());</span>
<span class="udiff-line-modified-added">+     doMatch(WTFMove(info), WTFMove(options), [this, protectedThis = makeRef(*this), promise = WTFMove(promise)](ExceptionOr&lt;RefPtr&lt;FetchResponse&gt;&gt;&amp;&amp; result) mutable {</span>
<span class="udiff-line-modified-added">+         queueTaskKeepingObjectAlive(*this, TaskSource::DOMManipulation, [promise = WTFMove(promise), result = WTFMove(result)]() mutable {</span>
<span class="udiff-line-modified-added">+             if (result.hasException()) {</span>
<span class="udiff-line-modified-added">+                 promise-&gt;reject(result.releaseException());</span>
<span class="udiff-line-modified-added">+                 return;</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-modified-added">+             if (!result.returnValue()) {</span>
<span class="udiff-line-modified-added">+                 promise-&gt;resolve();</span>
<span class="udiff-line-modified-added">+                 return;</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-added">+             promise-&gt;resolve&lt;IDLInterface&lt;FetchResponse&gt;&gt;(*result.returnValue());</span>
<span class="udiff-line-added">+         });</span>
      });
  }
  
  void DOMCache::doMatch(RequestInfo&amp;&amp; info, CacheQueryOptions&amp;&amp; options, MatchCallback&amp;&amp; callback)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -89,11 +92,11 @@</span>
          }
          if (result.returnValue().isEmpty()) {
              callback(nullptr);
              return;
          }
<span class="udiff-line-modified-removed">-         callback(result.returnValue()[0].response-&gt;clone(*scriptExecutionContext()).releaseReturnValue().ptr());</span>
<span class="udiff-line-modified-added">+         callback(RefPtr&lt;FetchResponse&gt;(result.returnValue()[0].response-&gt;clone(*scriptExecutionContext()).releaseReturnValue()));</span>
      });
  }
  
  Vector&lt;Ref&lt;FetchResponse&gt;&gt; DOMCache::cloneResponses(const Vector&lt;CacheStorageRecord&gt;&amp; records)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -118,24 +121,28 @@</span>
          request = requestOrException.releaseReturnValue();
      }
  
      if (!request) {
          retrieveRecords(URL { }, [this, promise = WTFMove(promise)](Optional&lt;Exception&gt;&amp;&amp; exception) mutable {
<span class="udiff-line-modified-removed">-             if (exception) {</span>
<span class="udiff-line-modified-removed">-                 promise.reject(WTFMove(exception.value()));</span>
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             promise.resolve(cloneResponses(m_records));</span>
<span class="udiff-line-modified-added">+             queueTaskKeepingObjectAlive(*this, TaskSource::DOMManipulation, [this, promise = WTFMove(promise), exception = WTFMove(exception)]() mutable {</span>
<span class="udiff-line-modified-added">+                 if (exception) {</span>
<span class="udiff-line-modified-added">+                     promise.reject(WTFMove(exception.value()));</span>
<span class="udiff-line-modified-added">+                     return;</span>
<span class="udiff-line-modified-added">+                 }</span>
<span class="udiff-line-added">+                 promise.resolve(cloneResponses(m_records));</span>
<span class="udiff-line-added">+             });</span>
          });
          return;
      }
      queryCache(request.releaseNonNull(), WTFMove(options), [this, promise = WTFMove(promise)](ExceptionOr&lt;Vector&lt;CacheStorageRecord&gt;&gt;&amp;&amp; result) mutable {
<span class="udiff-line-modified-removed">-         if (result.hasException()) {</span>
<span class="udiff-line-modified-removed">-             promise.reject(result.releaseException());</span>
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         promise.resolve(cloneResponses(result.releaseReturnValue()));</span>
<span class="udiff-line-modified-added">+         queueTaskKeepingObjectAlive(*this, TaskSource::DOMManipulation, [this, promise = WTFMove(promise), result = WTFMove(result)]() mutable {</span>
<span class="udiff-line-modified-added">+             if (result.hasException()) {</span>
<span class="udiff-line-modified-added">+                 promise.reject(result.releaseException());</span>
<span class="udiff-line-modified-added">+                 return;</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-added">+             promise.resolve(cloneResponses(result.releaseReturnValue()));</span>
<span class="udiff-line-added">+         });</span>
      });
  }
  
  void DOMCache::add(RequestInfo&amp;&amp; info, DOMPromiseDeferred&lt;void&gt;&amp;&amp; promise)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -231,17 +238,21 @@</span>
              return;
          }
          requests.uncheckedAppend(requestOrException.releaseReturnValue());
      }
  
<span class="udiff-line-modified-removed">-     auto taskHandler = FetchTasksHandler::create(*this, [this, promise = WTFMove(promise)](ExceptionOr&lt;Vector&lt;Record&gt;&gt;&amp;&amp; result) mutable {</span>
<span class="udiff-line-modified-added">+     auto taskHandler = FetchTasksHandler::create(*this, [this, protectedThis = makeRef(*this), promise = WTFMove(promise)](ExceptionOr&lt;Vector&lt;Record&gt;&gt;&amp;&amp; result) mutable {</span>
          if (result.hasException()) {
<span class="udiff-line-modified-removed">-             promise.reject(result.releaseException());</span>
<span class="udiff-line-modified-added">+             queueTaskKeepingObjectAlive(*this, TaskSource::DOMManipulation, [promise = WTFMove(promise), exception = result.releaseException()]() mutable {</span>
<span class="udiff-line-added">+                 promise.reject(WTFMove(exception));</span>
<span class="udiff-line-added">+             });</span>
              return;
          }
<span class="udiff-line-modified-removed">-         batchPutOperation(result.releaseReturnValue(), [promise = WTFMove(promise)](ExceptionOr&lt;void&gt;&amp;&amp; result) mutable {</span>
<span class="udiff-line-modified-removed">-             promise.settle(WTFMove(result));</span>
<span class="udiff-line-modified-added">+         batchPutOperation(result.releaseReturnValue(), [this, protectedThis = WTFMove(protectedThis), promise = WTFMove(promise)](ExceptionOr&lt;void&gt;&amp;&amp; result) mutable {</span>
<span class="udiff-line-modified-added">+             queueTaskKeepingObjectAlive(*this, TaskSource::DOMManipulation, [promise = WTFMove(promise), result = WTFMove(result)]() mutable {</span>
<span class="udiff-line-added">+                 promise.settle(WTFMove(result));</span>
<span class="udiff-line-added">+             });</span>
          });
      });
  
      for (auto&amp; request : requests) {
          auto&amp; requestReference = request.get();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -300,19 +311,23 @@</span>
  }
  
  void DOMCache::putWithResponseData(DOMPromiseDeferred&lt;void&gt;&amp;&amp; promise, Ref&lt;FetchRequest&gt;&amp;&amp; request, Ref&lt;FetchResponse&gt;&amp;&amp; response, ExceptionOr&lt;RefPtr&lt;SharedBuffer&gt;&gt;&amp;&amp; responseBody)
  {
      if (responseBody.hasException()) {
<span class="udiff-line-modified-removed">-         promise.reject(responseBody.releaseException());</span>
<span class="udiff-line-modified-added">+         queueTaskKeepingObjectAlive(*this, TaskSource::DOMManipulation, [promise = WTFMove(promise), exception = responseBody.releaseException()]() mutable {</span>
<span class="udiff-line-added">+             promise.reject(WTFMove(exception));</span>
<span class="udiff-line-added">+         });</span>
          return;
      }
  
      DOMCacheEngine::ResponseBody body;
      if (auto buffer = responseBody.releaseReturnValue())
          body = buffer.releaseNonNull();
<span class="udiff-line-modified-removed">-     batchPutOperation(request.get(), response.get(), WTFMove(body), [promise = WTFMove(promise)](ExceptionOr&lt;void&gt;&amp;&amp; result) mutable {</span>
<span class="udiff-line-modified-removed">-         promise.settle(WTFMove(result));</span>
<span class="udiff-line-modified-added">+     batchPutOperation(request.get(), response.get(), WTFMove(body), [this, protectedThis = makeRef(*this), promise = WTFMove(promise)](ExceptionOr&lt;void&gt;&amp;&amp; result) mutable {</span>
<span class="udiff-line-modified-added">+         queueTaskKeepingObjectAlive(*this, TaskSource::DOMManipulation, [promise = WTFMove(promise), result = WTFMove(result)]() mutable {</span>
<span class="udiff-line-added">+             promise.settle(WTFMove(result));</span>
<span class="udiff-line-added">+         });</span>
      });
  }
  
  void DOMCache::put(RequestInfo&amp;&amp; info, Ref&lt;FetchResponse&gt;&amp;&amp; response, DOMPromiseDeferred&lt;void&gt;&amp;&amp; promise)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -371,12 +386,14 @@</span>
                  this-&gt;putWithResponseData(WTFMove(promise), WTFMove(request), WTFMove(response), RefPtr&lt;SharedBuffer&gt; { WTFMove(data) });
          });
          return;
      }
  
<span class="udiff-line-modified-removed">-     batchPutOperation(request.get(), response.get(), response-&gt;consumeBody(), [promise = WTFMove(promise)](ExceptionOr&lt;void&gt;&amp;&amp; result) mutable {</span>
<span class="udiff-line-modified-removed">-         promise.settle(WTFMove(result));</span>
<span class="udiff-line-modified-added">+     batchPutOperation(request.get(), response.get(), response-&gt;consumeBody(), [this, protectedThis = makeRef(*this), promise = WTFMove(promise)](ExceptionOr&lt;void&gt;&amp;&amp; result) mutable {</span>
<span class="udiff-line-modified-added">+         queueTaskKeepingObjectAlive(*this, TaskSource::DOMManipulation, [promise = WTFMove(promise), result = WTFMove(result)]() mutable {</span>
<span class="udiff-line-added">+             promise.settle(WTFMove(result));</span>
<span class="udiff-line-added">+         });</span>
      });
  }
  
  void DOMCache::remove(RequestInfo&amp;&amp; info, CacheQueryOptions&amp;&amp; options, DOMPromiseDeferred&lt;IDLBoolean&gt;&amp;&amp; promise)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -387,12 +404,14 @@</span>
      if (requestOrException.hasException()) {
          promise.resolve(false);
          return;
      }
  
<span class="udiff-line-modified-removed">-     batchDeleteOperation(requestOrException.releaseReturnValue(), WTFMove(options), [promise = WTFMove(promise)](ExceptionOr&lt;bool&gt;&amp;&amp; result) mutable {</span>
<span class="udiff-line-modified-removed">-         promise.settle(WTFMove(result));</span>
<span class="udiff-line-modified-added">+     batchDeleteOperation(requestOrException.releaseReturnValue(), WTFMove(options), [this, protectedThis = makeRef(*this), promise = WTFMove(promise)](ExceptionOr&lt;bool&gt;&amp;&amp; result) mutable {</span>
<span class="udiff-line-modified-added">+         queueTaskKeepingObjectAlive(*this, TaskSource::DOMManipulation, [promise = WTFMove(promise), result = WTFMove(result)]() mutable {</span>
<span class="udiff-line-added">+             promise.settle(WTFMove(result));</span>
<span class="udiff-line-added">+         });</span>
      });
  }
  
  static inline Ref&lt;FetchRequest&gt; copyRequestRef(const CacheStorageRecord&amp; record)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -414,26 +433,30 @@</span>
          request = requestOrException.releaseReturnValue();
      }
  
      if (!request) {
          retrieveRecords(URL { }, [this, promise = WTFMove(promise)](Optional&lt;Exception&gt;&amp;&amp; exception) mutable {
<span class="udiff-line-modified-removed">-             if (exception) {</span>
<span class="udiff-line-modified-removed">-                 promise.reject(WTFMove(exception.value()));</span>
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             promise.resolve(WTF::map(m_records, copyRequestRef));</span>
<span class="udiff-line-modified-added">+             queueTaskKeepingObjectAlive(*this, TaskSource::DOMManipulation, [this, promise = WTFMove(promise), exception = WTFMove(exception)]() mutable {</span>
<span class="udiff-line-modified-added">+                 if (exception) {</span>
<span class="udiff-line-modified-added">+                     promise.reject(WTFMove(exception.value()));</span>
<span class="udiff-line-modified-added">+                     return;</span>
<span class="udiff-line-modified-added">+                 }</span>
<span class="udiff-line-added">+                 promise.resolve(WTF::map(m_records, copyRequestRef));</span>
<span class="udiff-line-added">+             });</span>
          });
          return;
      }
  
<span class="udiff-line-modified-removed">-     queryCache(request.releaseNonNull(), WTFMove(options), [promise = WTFMove(promise)](ExceptionOr&lt;Vector&lt;CacheStorageRecord&gt;&gt;&amp;&amp; result) mutable {</span>
<span class="udiff-line-modified-removed">-         if (result.hasException()) {</span>
<span class="udiff-line-modified-removed">-             promise.reject(result.releaseException());</span>
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+     queryCache(request.releaseNonNull(), WTFMove(options), [this, protectedThis = makeRef(*this), promise = WTFMove(promise)](auto&amp;&amp; result) mutable {</span>
<span class="udiff-line-modified-added">+         queueTaskKeepingObjectAlive(*this, TaskSource::DOMManipulation, [promise = WTFMove(promise), result = WTFMove(result)]() mutable {</span>
<span class="udiff-line-modified-added">+             if (result.hasException()) {</span>
<span class="udiff-line-modified-added">+                 promise.reject(result.releaseException());</span>
<span class="udiff-line-modified-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         promise.resolve(WTF::map(result.releaseReturnValue(), copyRequestRef));</span>
<span class="udiff-line-modified-added">+             promise.resolve(WTF::map(result.releaseReturnValue(), copyRequestRef));</span>
<span class="udiff-line-added">+         });</span>
      });
  }
  
  void DOMCache::retrieveRecords(const URL&amp; url, WTF::Function&lt;void(Optional&lt;Exception&gt;&amp;&amp;)&gt;&amp;&amp; callback)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -549,10 +572,11 @@</span>
      for (auto&amp; record : records) {
          size_t index = m_records.findMatching([&amp;](const auto&amp; item) { return item.identifier == record.identifier; });
          if (index != notFound) {
              auto&amp; current = m_records[index];
              if (current.updateResponseCounter != record.updateResponseCounter) {
<span class="udiff-line-added">+                 record.response.setSource(ResourceResponse::Source::DOMCache);</span>
                  auto response = FetchResponse::create(*scriptExecutionContext(), WTF::nullopt, record.responseHeadersGuard, WTFMove(record.response));
                  response-&gt;setBodyData(WTFMove(record.responseBody), record.responseBodySize);
  
                  current.response = WTFMove(response);
                  current.updateResponseCounter = record.updateResponseCounter;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -560,10 +584,11 @@</span>
              newRecords.append(WTFMove(current));
          } else {
              auto requestHeaders = FetchHeaders::create(record.requestHeadersGuard, HTTPHeaderMap { record.request.httpHeaderFields() });
              auto request = FetchRequest::create(*scriptExecutionContext(), WTF::nullopt, WTFMove(requestHeaders),  WTFMove(record.request), WTFMove(record.options), WTFMove(record.referrer));
  
<span class="udiff-line-added">+             record.response.setSource(ResourceResponse::Source::DOMCache);</span>
              auto response = FetchResponse::create(*scriptExecutionContext(), WTF::nullopt, record.responseHeadersGuard, WTFMove(record.response));
              response-&gt;setBodyData(WTFMove(record.responseBody), record.responseBodySize);
  
              newRecords.append(CacheStorageRecord { record.identifier, record.updateResponseCounter, WTFMove(request), WTFMove(response) });
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -582,12 +607,6 @@</span>
  const char* DOMCache::activeDOMObjectName() const
  {
      return &quot;Cache&quot;;
  }
  
<span class="udiff-line-removed">- bool DOMCache::canSuspendForDocumentSuspension() const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     return m_records.isEmpty() &amp;&amp; !hasPendingActivity();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
  } // namespace WebCore
</pre>
<center><a href="CacheStorageConnection.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="DOMCache.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>