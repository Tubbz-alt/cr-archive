<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/RegExpObject.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  *  Copyright (C) 1999-2000 Harri Porten (porten@kde.org)
<a name="1" id="anc1"></a><span class="line-modified">  3  *  Copyright (C) 2003-2019 Apple Inc. All Rights Reserved.</span>
  4  *
  5  *  This library is free software; you can redistribute it and/or
  6  *  modify it under the terms of the GNU Lesser General Public
  7  *  License as published by the Free Software Foundation; either
  8  *  version 2 of the License, or (at your option) any later version.
  9  *
 10  *  This library is distributed in the hope that it will be useful,
 11  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 12  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 13  *  Lesser General Public License for more details.
 14  *
 15  *  You should have received a copy of the GNU Lesser General Public
 16  *  License along with this library; if not, write to the Free Software
 17  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 18  *
 19  */
 20 
 21 #include &quot;config.h&quot;
 22 #include &quot;RegExpObject.h&quot;
 23 
 24 #include &quot;Error.h&quot;
 25 #include &quot;ExceptionHelpers.h&quot;
 26 #include &quot;JSArray.h&quot;
 27 #include &quot;JSGlobalObject.h&quot;
 28 #include &quot;JSString.h&quot;
 29 #include &quot;Lookup.h&quot;
 30 #include &quot;JSCInlines.h&quot;
 31 #include &quot;RegExpObjectInlines.h&quot;
 32 
 33 namespace JSC {
 34 
 35 STATIC_ASSERT_IS_TRIVIALLY_DESTRUCTIBLE(RegExpObject);
 36 
 37 const ClassInfo RegExpObject::s_info = { &quot;RegExp&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(RegExpObject) };
 38 
 39 RegExpObject::RegExpObject(VM&amp; vm, Structure* structure, RegExp* regExp)
 40     : JSNonFinalObject(vm, structure)
 41     , m_regExpAndLastIndexIsNotWritableFlag(bitwise_cast&lt;uintptr_t&gt;(regExp)) // lastIndexIsNotWritableFlag is not set.
 42 {
 43     m_lastIndex.setWithoutWriteBarrier(jsNumber(0));
 44 }
 45 
 46 void RegExpObject::finishCreation(VM&amp; vm)
 47 {
 48     Base::finishCreation(vm);
 49     ASSERT(inherits(vm, info()));
 50     ASSERT(type() == RegExpObjectType);
 51 }
 52 
 53 void RegExpObject::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
 54 {
 55     RegExpObject* thisObject = jsCast&lt;RegExpObject*&gt;(cell);
 56     ASSERT_GC_OBJECT_INHERITS(thisObject, info());
 57     Base::visitChildren(thisObject, visitor);
 58     visitor.appendUnbarriered(thisObject-&gt;regExp());
 59     visitor.append(thisObject-&gt;m_lastIndex);
 60 }
 61 
<a name="2" id="anc2"></a><span class="line-modified"> 62 bool RegExpObject::getOwnPropertySlot(JSObject* object, JSGlobalObject* globalObject, PropertyName propertyName, PropertySlot&amp; slot)</span>
 63 {
<a name="3" id="anc3"></a><span class="line-modified"> 64     VM&amp; vm = globalObject-&gt;vm();</span>
 65     if (propertyName == vm.propertyNames-&gt;lastIndex) {
 66         RegExpObject* regExp = jsCast&lt;RegExpObject*&gt;(object);
 67         unsigned attributes = regExp-&gt;lastIndexIsWritable() ? PropertyAttribute::DontDelete | PropertyAttribute::DontEnum : PropertyAttribute::DontDelete | PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly;
 68         slot.setValue(regExp, attributes, regExp-&gt;getLastIndex());
 69         return true;
 70     }
<a name="4" id="anc4"></a><span class="line-modified"> 71     return Base::getOwnPropertySlot(object, globalObject, propertyName, slot);</span>
 72 }
 73 
<a name="5" id="anc5"></a><span class="line-modified"> 74 bool RegExpObject::deleteProperty(JSCell* cell, JSGlobalObject* globalObject, PropertyName propertyName)</span>
 75 {
<a name="6" id="anc6"></a><span class="line-modified"> 76     VM&amp; vm = globalObject-&gt;vm();</span>
 77     if (propertyName == vm.propertyNames-&gt;lastIndex)
 78         return false;
<a name="7" id="anc7"></a><span class="line-modified"> 79     return Base::deleteProperty(cell, globalObject, propertyName);</span>
 80 }
 81 
<a name="8" id="anc8"></a><span class="line-modified"> 82 void RegExpObject::getOwnNonIndexPropertyNames(JSObject* object, JSGlobalObject* globalObject, PropertyNameArray&amp; propertyNames, EnumerationMode mode)</span>
 83 {
<a name="9" id="anc9"></a><span class="line-modified"> 84     VM&amp; vm = globalObject-&gt;vm();</span>
 85     if (mode.includeDontEnumProperties())
 86         propertyNames.add(vm.propertyNames-&gt;lastIndex);
<a name="10" id="anc10"></a><span class="line-modified"> 87     Base::getOwnNonIndexPropertyNames(object, globalObject, propertyNames, mode);</span>
 88 }
 89 
<a name="11" id="anc11"></a><span class="line-modified"> 90 void RegExpObject::getPropertyNames(JSObject* object, JSGlobalObject* globalObject, PropertyNameArray&amp; propertyNames, EnumerationMode mode)</span>
 91 {
<a name="12" id="anc12"></a><span class="line-modified"> 92     VM&amp; vm = globalObject-&gt;vm();</span>
 93     if (mode.includeDontEnumProperties())
 94         propertyNames.add(vm.propertyNames-&gt;lastIndex);
<a name="13" id="anc13"></a><span class="line-modified"> 95     Base::getPropertyNames(object, globalObject, propertyNames, mode);</span>
 96 }
 97 
<a name="14" id="anc14"></a><span class="line-modified"> 98 void RegExpObject::getGenericPropertyNames(JSObject* object, JSGlobalObject* globalObject, PropertyNameArray&amp; propertyNames, EnumerationMode mode)</span>
 99 {
<a name="15" id="anc15"></a><span class="line-modified">100     VM&amp; vm = globalObject-&gt;vm();</span>
101     if (mode.includeDontEnumProperties())
102         propertyNames.add(vm.propertyNames-&gt;lastIndex);
<a name="16" id="anc16"></a><span class="line-modified">103     Base::getGenericPropertyNames(object, globalObject, propertyNames, mode);</span>
104 }
105 
<a name="17" id="anc17"></a><span class="line-modified">106 bool RegExpObject::defineOwnProperty(JSObject* object, JSGlobalObject* globalObject, PropertyName propertyName, const PropertyDescriptor&amp; descriptor, bool shouldThrow)</span>
107 {
<a name="18" id="anc18"></a><span class="line-modified">108     VM&amp; vm = globalObject-&gt;vm();</span>
109     auto scope = DECLARE_THROW_SCOPE(vm);
110 
111     if (propertyName == vm.propertyNames-&gt;lastIndex) {
112         RegExpObject* regExp = jsCast&lt;RegExpObject*&gt;(object);
113         if (descriptor.configurablePresent() &amp;&amp; descriptor.configurable())
<a name="19" id="anc19"></a><span class="line-modified">114             return typeError(globalObject, scope, shouldThrow, UnconfigurablePropertyChangeConfigurabilityError);</span>
115         if (descriptor.enumerablePresent() &amp;&amp; descriptor.enumerable())
<a name="20" id="anc20"></a><span class="line-modified">116             return typeError(globalObject, scope, shouldThrow, UnconfigurablePropertyChangeEnumerabilityError);</span>
117         if (descriptor.isAccessorDescriptor())
<a name="21" id="anc21"></a><span class="line-modified">118             return typeError(globalObject, scope, shouldThrow, UnconfigurablePropertyChangeAccessMechanismError);</span>
119         if (!regExp-&gt;lastIndexIsWritable()) {
120             if (descriptor.writablePresent() &amp;&amp; descriptor.writable())
<a name="22" id="anc22"></a><span class="line-modified">121                 return typeError(globalObject, scope, shouldThrow, UnconfigurablePropertyChangeWritabilityError);</span>
<span class="line-modified">122             if (descriptor.value()) {</span>
<span class="line-modified">123                 bool isSame = sameValue(globalObject, regExp-&gt;getLastIndex(), descriptor.value());</span>
<span class="line-added">124                 RETURN_IF_EXCEPTION(scope, false);</span>
<span class="line-added">125                 if (!isSame)</span>
<span class="line-added">126                     return typeError(globalObject, scope, shouldThrow, ReadonlyPropertyChangeError);</span>
<span class="line-added">127             }</span>
128             return true;
129         }
130         if (descriptor.value()) {
<a name="23" id="anc23"></a><span class="line-modified">131             regExp-&gt;setLastIndex(globalObject, descriptor.value(), false);</span>
132             RETURN_IF_EXCEPTION(scope, false);
133         }
134         if (descriptor.writablePresent() &amp;&amp; !descriptor.writable())
135             regExp-&gt;setLastIndexIsNotWritable();
136         return true;
137     }
138 
<a name="24" id="anc24"></a><span class="line-modified">139     RELEASE_AND_RETURN(scope, Base::defineOwnProperty(object, globalObject, propertyName, descriptor, shouldThrow));</span>
140 }
141 
<a name="25" id="anc25"></a><span class="line-modified">142 static bool regExpObjectSetLastIndexStrict(JSGlobalObject* globalObject, EncodedJSValue thisValue, EncodedJSValue value)</span>
143 {
<a name="26" id="anc26"></a><span class="line-modified">144     return jsCast&lt;RegExpObject*&gt;(JSValue::decode(thisValue))-&gt;setLastIndex(globalObject, JSValue::decode(value), true);</span>
145 }
146 
<a name="27" id="anc27"></a><span class="line-modified">147 static bool regExpObjectSetLastIndexNonStrict(JSGlobalObject* globalObject, EncodedJSValue thisValue, EncodedJSValue value)</span>
148 {
<a name="28" id="anc28"></a><span class="line-modified">149     return jsCast&lt;RegExpObject*&gt;(JSValue::decode(thisValue))-&gt;setLastIndex(globalObject, JSValue::decode(value), false);</span>
150 }
151 
<a name="29" id="anc29"></a><span class="line-modified">152 bool RegExpObject::put(JSCell* cell, JSGlobalObject* globalObject, PropertyName propertyName, JSValue value, PutPropertySlot&amp; slot)</span>
153 {
<a name="30" id="anc30"></a><span class="line-modified">154     VM&amp; vm = globalObject-&gt;vm();</span>
155     RegExpObject* thisObject = jsCast&lt;RegExpObject*&gt;(cell);
156 
157     if (UNLIKELY(isThisValueAltered(slot, thisObject)))
<a name="31" id="anc31"></a><span class="line-modified">158         return ordinarySetSlow(globalObject, thisObject, propertyName, value, slot.thisValue(), slot.isStrictMode());</span>
159 
160     if (propertyName == vm.propertyNames-&gt;lastIndex) {
<a name="32" id="anc32"></a><span class="line-modified">161         bool result = thisObject-&gt;setLastIndex(globalObject, value, slot.isStrictMode());</span>
162         slot.setCustomValue(thisObject, slot.isStrictMode()
163             ? regExpObjectSetLastIndexStrict
164             : regExpObjectSetLastIndexNonStrict);
165         return result;
166     }
<a name="33" id="anc33"></a><span class="line-modified">167     return Base::put(cell, globalObject, propertyName, value, slot);</span>
168 }
169 
<a name="34" id="anc34"></a><span class="line-modified">170 JSValue RegExpObject::exec(JSGlobalObject* globalObject, JSString* string)</span>
171 {
<a name="35" id="anc35"></a><span class="line-modified">172     return execInline(globalObject, string);</span>
173 }
174 
175 // Shared implementation used by test and exec.
<a name="36" id="anc36"></a><span class="line-modified">176 MatchResult RegExpObject::match(JSGlobalObject* globalObject, JSString* string)</span>
177 {
<a name="37" id="anc37"></a><span class="line-modified">178     return matchInline(globalObject, string);</span>
179 }
180 
<a name="38" id="anc38"></a><span class="line-modified">181 JSValue RegExpObject::matchGlobal(JSGlobalObject* globalObject, JSString* string)</span>
182 {
183     VM&amp; vm = globalObject-&gt;vm();
184     auto scope = DECLARE_THROW_SCOPE(vm);
185     RegExp* regExp = this-&gt;regExp();
186 
187     ASSERT(regExp-&gt;global());
188 
<a name="39" id="anc39"></a><span class="line-modified">189     setLastIndex(globalObject, 0);</span>
190     RETURN_IF_EXCEPTION(scope, { });
191 
<a name="40" id="anc40"></a><span class="line-modified">192     String s = string-&gt;value(globalObject);</span>
193     RETURN_IF_EXCEPTION(scope, { });
194 
195     ASSERT(!s.isNull());
196     if (regExp-&gt;unicode()) {
197         unsigned stringLength = s.length();
198         RELEASE_AND_RETURN(scope, collectMatches(
<a name="41" id="anc41"></a><span class="line-modified">199             vm, globalObject, string, s, regExp,</span>
200             [&amp;] (size_t end) -&gt; size_t {
201                 return advanceStringUnicode(s, stringLength, end);
202             }));
203     }
204 
205     RELEASE_AND_RETURN(scope, collectMatches(
<a name="42" id="anc42"></a><span class="line-modified">206         vm, globalObject, string, s, regExp,</span>
207         [&amp;] (size_t end) -&gt; size_t {
208             return end + 1;
209         }));
210 }
211 
212 } // namespace JSC
<a name="43" id="anc43"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="43" type="hidden" />
</body>
</html>