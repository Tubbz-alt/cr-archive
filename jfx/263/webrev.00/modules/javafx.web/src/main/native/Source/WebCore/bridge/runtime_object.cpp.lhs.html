<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/bridge/runtime_object.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2003, 2008-2009, 2016 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;runtime_object.h&quot;
 28 
 29 #include &quot;JSDOMBinding.h&quot;
<a name="1" id="anc1"></a>
 30 #include &quot;runtime_method.h&quot;
 31 #include &lt;JavaScriptCore/Error.h&gt;
 32 
 33 using namespace WebCore;
 34 
 35 namespace JSC {
 36 namespace Bindings {
 37 
 38 WEBCORE_EXPORT const ClassInfo RuntimeObject::s_info = { &quot;RuntimeObject&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(RuntimeObject) };
 39 
 40 RuntimeObject::RuntimeObject(VM&amp; vm, Structure* structure, RefPtr&lt;Instance&gt;&amp;&amp; instance)
<a name="2" id="anc2"></a><span class="line-modified"> 41     : JSDestructibleObject(vm, structure)</span>
 42     , m_instance(WTFMove(instance))
 43 {
 44 }
 45 
 46 void RuntimeObject::finishCreation(VM&amp; vm)
 47 {
 48     Base::finishCreation(vm);
 49     ASSERT(inherits(vm, info()));
 50 }
 51 
 52 void RuntimeObject::destroy(JSCell* cell)
 53 {
 54     static_cast&lt;RuntimeObject*&gt;(cell)-&gt;RuntimeObject::~RuntimeObject();
 55 }
 56 
 57 void RuntimeObject::invalidate()
 58 {
 59     ASSERT(m_instance);
 60     if (m_instance)
 61         m_instance-&gt;willInvalidateRuntimeObject();
 62     m_instance = nullptr;
 63 }
 64 
<a name="3" id="anc3"></a><span class="line-modified"> 65 EncodedJSValue RuntimeObject::fallbackObjectGetter(ExecState* exec, EncodedJSValue thisValue, PropertyName propertyName)</span>
 66 {
<a name="4" id="anc4"></a><span class="line-modified"> 67     VM&amp; vm = exec-&gt;vm();</span>
 68     auto scope = DECLARE_THROW_SCOPE(vm);
 69 
 70     RuntimeObject* thisObj = jsCast&lt;RuntimeObject*&gt;(JSValue::decode(thisValue));
 71     RefPtr&lt;Instance&gt; instance = thisObj-&gt;m_instance;
 72 
 73     if (!instance)
<a name="5" id="anc5"></a><span class="line-modified"> 74         return JSValue::encode(throwInvalidAccessError(exec, scope));</span>
 75 
 76     instance-&gt;begin();
 77 
 78     Class *aClass = instance-&gt;getClass();
<a name="6" id="anc6"></a><span class="line-modified"> 79     JSValue result = aClass-&gt;fallbackObject(exec, instance.get(), propertyName);</span>
 80 
 81     instance-&gt;end();
 82 
 83     return JSValue::encode(result);
 84 }
 85 
<a name="7" id="anc7"></a><span class="line-modified"> 86 EncodedJSValue RuntimeObject::fieldGetter(ExecState* exec, EncodedJSValue thisValue, PropertyName propertyName)</span>
 87 {
<a name="8" id="anc8"></a><span class="line-modified"> 88     VM&amp; vm = exec-&gt;vm();</span>
 89     auto scope = DECLARE_THROW_SCOPE(vm);
 90 
 91     RuntimeObject* thisObj = jsCast&lt;RuntimeObject*&gt;(JSValue::decode(thisValue));
 92     RefPtr&lt;Instance&gt; instance = thisObj-&gt;m_instance;
 93 
 94     if (!instance)
<a name="9" id="anc9"></a><span class="line-modified"> 95         return JSValue::encode(throwInvalidAccessError(exec, scope));</span>
 96 
 97     instance-&gt;begin();
 98 
 99     Class *aClass = instance-&gt;getClass();
100     Field* aField = aClass-&gt;fieldNamed(propertyName, instance.get());
<a name="10" id="anc10"></a><span class="line-modified">101     JSValue result = aField-&gt;valueFromInstance(exec, instance.get());</span>
102 
103     instance-&gt;end();
104 
105     return JSValue::encode(result);
106 }
107 
<a name="11" id="anc11"></a><span class="line-modified">108 EncodedJSValue RuntimeObject::methodGetter(ExecState* exec, EncodedJSValue thisValue, PropertyName propertyName)</span>
109 {
<a name="12" id="anc12"></a><span class="line-modified">110     VM&amp; vm = exec-&gt;vm();</span>
111     auto scope = DECLARE_THROW_SCOPE(vm);
112 
113     RuntimeObject* thisObj = jsCast&lt;RuntimeObject*&gt;(JSValue::decode(thisValue));
114     RefPtr&lt;Instance&gt; instance = thisObj-&gt;m_instance;
115 
116     if (!instance)
<a name="13" id="anc13"></a><span class="line-modified">117         return JSValue::encode(throwInvalidAccessError(exec, scope));</span>
118 
119     instance-&gt;begin();
120 
<a name="14" id="anc14"></a><span class="line-modified">121     JSValue method = instance-&gt;getMethod(exec, propertyName);</span>
122 
123     instance-&gt;end();
124 
125     return JSValue::encode(method);
126 }
127 
<a name="15" id="anc15"></a><span class="line-modified">128 bool RuntimeObject::getOwnPropertySlot(JSObject* object, ExecState *exec, PropertyName propertyName, PropertySlot&amp; slot)</span>
129 {
<a name="16" id="anc16"></a><span class="line-modified">130     VM&amp; vm = exec-&gt;vm();</span>
131     auto scope = DECLARE_THROW_SCOPE(vm);
132 
133     RuntimeObject* thisObject = jsCast&lt;RuntimeObject*&gt;(object);
134     if (!thisObject-&gt;m_instance) {
<a name="17" id="anc17"></a><span class="line-modified">135         throwInvalidAccessError(exec, scope);</span>
136         return false;
137     }
138 
139     RefPtr&lt;Instance&gt; instance = thisObject-&gt;m_instance;
140 
141     instance-&gt;begin();
142 
143     Class *aClass = instance-&gt;getClass();
144 
145     if (aClass) {
146         // See if the instance has a field with the specified name.
147         Field *aField = aClass-&gt;fieldNamed(propertyName, instance.get());
148         if (aField) {
149             slot.setCustom(thisObject, static_cast&lt;unsigned&gt;(JSC::PropertyAttribute::DontDelete), thisObject-&gt;fieldGetter);
150             instance-&gt;end();
151             return true;
152         } else {
153             // Now check if a method with specified name exists, if so return a function object for
154             // that method.
155             if (aClass-&gt;methodNamed(propertyName, instance.get())) {
156                 slot.setCustom(thisObject, PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly, thisObject-&gt;methodGetter);
157 
158                 instance-&gt;end();
159                 return true;
160             }
161         }
162 
163         // Try a fallback object.
<a name="18" id="anc18"></a><span class="line-modified">164         if (!aClass-&gt;fallbackObject(exec, instance.get(), propertyName).isUndefined()) {</span>
165             slot.setCustom(thisObject, PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum, thisObject-&gt;fallbackObjectGetter);
166             instance-&gt;end();
167             return true;
168         }
169     }
170 
171     instance-&gt;end();
172 
<a name="19" id="anc19"></a><span class="line-modified">173     return instance-&gt;getOwnPropertySlot(thisObject, exec, propertyName, slot);</span>
174 }
175 
<a name="20" id="anc20"></a><span class="line-modified">176 bool RuntimeObject::put(JSCell* cell, ExecState* exec, PropertyName propertyName, JSValue value, PutPropertySlot&amp; slot)</span>
177 {
<a name="21" id="anc21"></a><span class="line-modified">178     VM&amp; vm = exec-&gt;vm();</span>
179     auto scope = DECLARE_THROW_SCOPE(vm);
180 
181     RuntimeObject* thisObject = jsCast&lt;RuntimeObject*&gt;(cell);
182     if (!thisObject-&gt;m_instance) {
<a name="22" id="anc22"></a><span class="line-modified">183         throwInvalidAccessError(exec, scope);</span>
184         return false;
185     }
186 
187     RefPtr&lt;Instance&gt; instance = thisObject-&gt;m_instance;
188     instance-&gt;begin();
189 
190     // Set the value of the property.
191     bool result = false;
192     Field *aField = instance-&gt;getClass()-&gt;fieldNamed(propertyName, instance.get());
193     if (aField)
<a name="23" id="anc23"></a><span class="line-modified">194         result = aField-&gt;setValueToInstance(exec, instance.get(), value);</span>
<span class="line-modified">195     else if (!instance-&gt;setValueOfUndefinedField(exec, propertyName, value))</span>
<span class="line-modified">196         result = instance-&gt;put(thisObject, exec, propertyName, value, slot);</span>
197 
198     instance-&gt;end();
199     return result;
200 }
201 
<a name="24" id="anc24"></a><span class="line-modified">202 bool RuntimeObject::deleteProperty(JSCell*, ExecState*, PropertyName)</span>
203 {
204     // Can never remove a property of a RuntimeObject.
205     return false;
206 }
207 
<a name="25" id="anc25"></a><span class="line-modified">208 JSValue RuntimeObject::defaultValue(const JSObject* object, ExecState* exec, PreferredPrimitiveType hint)</span>
209 {
<a name="26" id="anc26"></a><span class="line-modified">210     VM&amp; vm = exec-&gt;vm();</span>
211     auto scope = DECLARE_THROW_SCOPE(vm);
212 
213     const RuntimeObject* thisObject = jsCast&lt;const RuntimeObject*&gt;(object);
214     if (!thisObject-&gt;m_instance)
<a name="27" id="anc27"></a><span class="line-modified">215         return throwInvalidAccessError(exec, scope);</span>
216 
217     RefPtr&lt;Instance&gt; instance = thisObject-&gt;m_instance;
218 
219     instance-&gt;begin();
<a name="28" id="anc28"></a><span class="line-modified">220     JSValue result = instance-&gt;defaultValue(exec, hint);</span>
221     instance-&gt;end();
222     return result;
223 }
224 
<a name="29" id="anc29"></a><span class="line-modified">225 static EncodedJSValue JSC_HOST_CALL callRuntimeObject(ExecState* exec)</span>
226 {
<a name="30" id="anc30"></a><span class="line-modified">227     ASSERT(exec-&gt;jsCallee()-&gt;inherits&lt;RuntimeObject&gt;(exec-&gt;vm()));</span>
<span class="line-modified">228     RefPtr&lt;Instance&gt; instance(static_cast&lt;RuntimeObject*&gt;(exec-&gt;jsCallee())-&gt;getInternalInstance());</span>
229     instance-&gt;begin();
<a name="31" id="anc31"></a><span class="line-modified">230     JSValue result = instance-&gt;invokeDefaultMethod(exec);</span>
231     instance-&gt;end();
232     return JSValue::encode(result);
233 }
234 
235 CallType RuntimeObject::getCallData(JSCell* cell, CallData&amp; callData)
236 {
237     RuntimeObject* thisObject = jsCast&lt;RuntimeObject*&gt;(cell);
238     if (!thisObject-&gt;m_instance)
239         return CallType::None;
240 
241     RefPtr&lt;Instance&gt; instance = thisObject-&gt;m_instance;
242     if (!instance-&gt;supportsInvokeDefaultMethod())
243         return CallType::None;
244 
245     callData.native.function = callRuntimeObject;
246     return CallType::Host;
247 }
248 
<a name="32" id="anc32"></a><span class="line-modified">249 static EncodedJSValue JSC_HOST_CALL callRuntimeConstructor(ExecState* exec)</span>
250 {
<a name="33" id="anc33"></a><span class="line-modified">251     JSObject* constructor = exec-&gt;jsCallee();</span>
<span class="line-modified">252     ASSERT(constructor-&gt;inherits&lt;RuntimeObject&gt;(exec-&gt;vm()));</span>
<span class="line-modified">253     RefPtr&lt;Instance&gt; instance(static_cast&lt;RuntimeObject*&gt;(exec-&gt;jsCallee())-&gt;getInternalInstance());</span>
254     instance-&gt;begin();
<a name="34" id="anc34"></a><span class="line-modified">255     ArgList args(exec);</span>
<span class="line-modified">256     JSValue result = instance-&gt;invokeConstruct(exec, args);</span>
257     instance-&gt;end();
258 
259     ASSERT(result);
260     return JSValue::encode(result.isObject() ? jsCast&lt;JSObject*&gt;(result.asCell()) : constructor);
261 }
262 
263 ConstructType RuntimeObject::getConstructData(JSCell* cell, ConstructData&amp; constructData)
264 {
265     RuntimeObject* thisObject = jsCast&lt;RuntimeObject*&gt;(cell);
266     if (!thisObject-&gt;m_instance)
267         return ConstructType::None;
268 
269     RefPtr&lt;Instance&gt; instance = thisObject-&gt;m_instance;
270     if (!instance-&gt;supportsConstruct())
271         return ConstructType::None;
272 
273     constructData.native.function = callRuntimeConstructor;
274     return ConstructType::Host;
275 }
276 
<a name="35" id="anc35"></a><span class="line-modified">277 void RuntimeObject::getOwnPropertyNames(JSObject* object, ExecState* exec, PropertyNameArray&amp; propertyNames, EnumerationMode)</span>
278 {
<a name="36" id="anc36"></a><span class="line-modified">279     VM&amp; vm = exec-&gt;vm();</span>
280     auto scope = DECLARE_THROW_SCOPE(vm);
281 
282     RuntimeObject* thisObject = jsCast&lt;RuntimeObject*&gt;(object);
283     if (!thisObject-&gt;m_instance) {
<a name="37" id="anc37"></a><span class="line-modified">284         throwInvalidAccessError(exec, scope);</span>
285         return;
286     }
287 
288     RefPtr&lt;Instance&gt; instance = thisObject-&gt;m_instance;
289 
290     instance-&gt;begin();
<a name="38" id="anc38"></a><span class="line-modified">291     instance-&gt;getPropertyNames(exec, propertyNames);</span>
292     instance-&gt;end();
293 }
294 
<a name="39" id="anc39"></a><span class="line-modified">295 Exception* RuntimeObject::throwInvalidAccessError(ExecState* exec, ThrowScope&amp; scope)</span>
296 {
<a name="40" id="anc40"></a><span class="line-modified">297     return throwException(exec, scope, createReferenceError(exec, &quot;Trying to access object from destroyed plug-in.&quot;));</span>





298 }
299 
300 }
301 }
<a name="41" id="anc41"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="41" type="hidden" />
</body>
</html>