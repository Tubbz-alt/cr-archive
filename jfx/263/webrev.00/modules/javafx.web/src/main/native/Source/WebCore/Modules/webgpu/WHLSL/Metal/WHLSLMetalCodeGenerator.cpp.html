<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/Modules/webgpu/WHLSL/Metal/WHLSLMetalCodeGenerator.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2019 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;WHLSLMetalCodeGenerator.h&quot;
 28 
 29 #if ENABLE(WEBGPU)
 30 
 31 #include &quot;WHLSLFunctionWriter.h&quot;
 32 #include &quot;WHLSLTypeNamer.h&quot;
 33 #include &lt;wtf/DataLog.h&gt;
 34 #include &lt;wtf/text/StringBuilder.h&gt;
 35 
 36 namespace WebCore {
 37 
 38 namespace WHLSL {
 39 
 40 namespace Metal {
 41 
 42 static constexpr bool dumpMetalCode = false;
 43 
 44 static StringView metalCodePrologue()
 45 {
 46     return StringView {
 47         &quot;#include &lt;metal_stdlib&gt;\n&quot;
 48         &quot;#include &lt;metal_atomic&gt;\n&quot;
 49         &quot;#include &lt;metal_math&gt;\n&quot;
 50         &quot;#include &lt;metal_relational&gt;\n&quot;
 51         &quot;#include &lt;metal_compute&gt;\n&quot;
 52         &quot;#include &lt;metal_texture&gt;\n&quot;
 53         &quot;\n&quot;
 54         &quot;using namespace metal;\n&quot;
 55         &quot;\n&quot;
 56         &quot;template &lt;typename T, int Cols, int Rows&gt;\n&quot;
 57         &quot;struct WSLMatrix\n&quot;
 58         &quot;{\n&quot;
 59         &quot;    vec&lt;T, Rows&gt; columns[Cols];\n&quot;
 60         &quot;    private:\n&quot;
 61         &quot;    public:\n&quot;
 62         &quot;    inline WSLMatrix() thread = default;\n&quot;
 63         &quot;    inline WSLMatrix() constant = default;\n&quot;
 64         &quot;    inline WSLMatrix(const thread WSLMatrix&lt;T, Cols, Rows&gt; &amp;that) thread = default;\n&quot;
 65         &quot;    inline WSLMatrix(const device WSLMatrix&lt;T, Cols, Rows&gt; &amp;that) thread = default;\n&quot;
 66         &quot;    inline WSLMatrix(const constant WSLMatrix&lt;T, Cols, Rows&gt; &amp;that) thread = default;\n&quot;
 67         &quot;    inline WSLMatrix(const threadgroup WSLMatrix&lt;T, Cols, Rows&gt; &amp;that) thread = default;\n&quot;
 68         &quot;    inline WSLMatrix(const thread WSLMatrix&lt;T, Cols, Rows&gt; &amp;that) constant = default;\n&quot;
 69         &quot;    inline WSLMatrix(const device WSLMatrix&lt;T, Cols, Rows&gt; &amp;that) constant = default;\n&quot;
 70         &quot;    inline WSLMatrix(const constant WSLMatrix&lt;T, Cols, Rows&gt; &amp;that) constant = default;\n&quot;
 71         &quot;    inline WSLMatrix(const threadgroup WSLMatrix&lt;T, Cols, Rows&gt; &amp;that) constant = default;\n&quot;
 72         &quot;    public:\n&quot;
 73         &quot;    inline thread vec&lt;T, Rows&gt; &amp;operator[](int r) thread\n&quot;
 74         &quot;    {\n&quot;
 75         &quot;        return columns[r];\n&quot;
 76         &quot;    }\n&quot;
 77         &quot;    inline device vec&lt;T, Rows&gt; &amp;operator[](int r) device\n&quot;
 78         &quot;    {\n&quot;
 79         &quot;        return columns[r];\n&quot;
 80         &quot;    }\n&quot;
 81         &quot;    inline threadgroup vec&lt;T, Rows&gt; &amp;operator[](int r) threadgroup\n&quot;
 82         &quot;    {\n&quot;
 83         &quot;        return columns[r];\n&quot;
 84         &quot;    }\n&quot;
 85         &quot;    inline const thread vec&lt;T, Rows&gt; &amp;operator[](int r) const thread\n&quot;
 86         &quot;    {\n&quot;
 87         &quot;        return columns[r];\n&quot;
 88         &quot;    }\n&quot;
 89         &quot;    inline const device vec&lt;T, Rows&gt; &amp;operator[](int r) const device\n&quot;
 90         &quot;    {\n&quot;
 91         &quot;        return columns[r];\n&quot;
 92         &quot;    }\n&quot;
 93         &quot;    inline const constant vec&lt;T, Rows&gt; &amp;operator[](int r) const constant\n&quot;
 94         &quot;    {\n&quot;
 95         &quot;        return columns[r];\n&quot;
 96         &quot;    }\n&quot;
 97         &quot;    inline const threadgroup vec&lt;T, Rows&gt; &amp;operator[](int r) const threadgroup\n&quot;
 98         &quot;    {\n&quot;
 99         &quot;        return columns[r];\n&quot;
100         &quot;    }\n&quot;
101         &quot;};\n&quot;
102 
103 
104     };
105 
106 }
107 
108 static void dumpMetalCodeIfNeeded(StringBuilder&amp; stringBuilder)
109 {
110     if (dumpMetalCode) {
111         dataLogLn(&quot;Generated Metal code: &quot;);
112         dataLogLn(stringBuilder.toString());
113     }
114 }
115 
116 RenderMetalCode generateMetalCode(Program&amp; program, MatchedRenderSemantics&amp;&amp; matchedSemantics, Layout&amp; layout)
117 {
118     StringBuilder stringBuilder;
119     stringBuilder.append(metalCodePrologue());
120 
121     TypeNamer typeNamer(program);
122     typeNamer.emitMetalTypes(stringBuilder);
123 
124     auto metalFunctionEntryPoints = Metal::emitMetalFunctions(stringBuilder, program, typeNamer, WTFMove(matchedSemantics), layout);
125 
126     dumpMetalCodeIfNeeded(stringBuilder);
127 
128     return { WTFMove(stringBuilder), WTFMove(metalFunctionEntryPoints.mangledVertexEntryPointName), WTFMove(metalFunctionEntryPoints.mangledFragmentEntryPointName) };
129 }
130 
131 ComputeMetalCode generateMetalCode(Program&amp; program, MatchedComputeSemantics&amp;&amp; matchedSemantics, Layout&amp; layout)
132 {
133     StringBuilder stringBuilder;
134     stringBuilder.append(metalCodePrologue());
135 
136     TypeNamer typeNamer(program);
137     typeNamer.emitMetalTypes(stringBuilder);
138 
139     auto metalFunctionEntryPoints = Metal::emitMetalFunctions(stringBuilder, program, typeNamer, WTFMove(matchedSemantics), layout);
140 
141     dumpMetalCodeIfNeeded(stringBuilder);
142 
143     return { WTFMove(stringBuilder), WTFMove(metalFunctionEntryPoints.mangledEntryPointName) };
144 }
145 
146 }
147 
148 }
149 
150 }
151 
152 #endif
    </pre>
  </body>
</html>