<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/client/IDBConnectionProxy.h</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IDBConnectionProxy.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="IDBConnectionToServer.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/client/IDBConnectionProxy.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 68 
 69     Ref&lt;IDBOpenDBRequest&gt; deleteDatabase(ScriptExecutionContext&amp;, const IDBDatabaseIdentifier&amp;);
 70     void didDeleteDatabase(const IDBResultData&amp;);
 71 
 72     void createObjectStore(TransactionOperation&amp;, const IDBObjectStoreInfo&amp;);
 73     void deleteObjectStore(TransactionOperation&amp;, const String&amp; objectStoreName);
 74     void clearObjectStore(TransactionOperation&amp;, uint64_t objectStoreIdentifier);
 75     void createIndex(TransactionOperation&amp;, const IDBIndexInfo&amp;);
 76     void deleteIndex(TransactionOperation&amp;, uint64_t objectStoreIdentifier, const String&amp; indexName);
 77     void putOrAdd(TransactionOperation&amp;, IDBKeyData&amp;&amp;, const IDBValue&amp;, const IndexedDB::ObjectStoreOverwriteMode);
 78     void getRecord(TransactionOperation&amp;, const IDBGetRecordData&amp;);
 79     void getAllRecords(TransactionOperation&amp;, const IDBGetAllRecordsData&amp;);
 80     void getCount(TransactionOperation&amp;, const IDBKeyRangeData&amp;);
 81     void deleteRecord(TransactionOperation&amp;, const IDBKeyRangeData&amp;);
 82     void openCursor(TransactionOperation&amp;, const IDBCursorInfo&amp;);
 83     void iterateCursor(TransactionOperation&amp;, const IDBIterateCursorData&amp;);
 84     void renameObjectStore(TransactionOperation&amp;, uint64_t objectStoreIdentifier, const String&amp; newName);
 85     void renameIndex(TransactionOperation&amp;, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const String&amp; newName);
 86 
 87     void fireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier, uint64_t requestedVersion);
<span class="line-modified"> 88     void didFireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier);</span>
 89 
 90     void notifyOpenDBRequestBlocked(const IDBResourceIdentifier&amp; requestIdentifier, uint64_t oldVersion, uint64_t newVersion);
 91     void openDBRequestCancelled(const IDBRequestData&amp;);
 92 
 93     void establishTransaction(IDBTransaction&amp;);
 94     void commitTransaction(IDBTransaction&amp;);
 95     void abortTransaction(IDBTransaction&amp;);
 96 
 97     void didStartTransaction(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBError&amp;);
 98     void didCommitTransaction(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBError&amp;);
 99     void didAbortTransaction(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBError&amp;);
100 
101     void didFinishHandlingVersionChangeTransaction(uint64_t databaseConnectionIdentifier, IDBTransaction&amp;);
102     void databaseConnectionPendingClose(IDBDatabase&amp;);
103     void databaseConnectionClosed(IDBDatabase&amp;);
104 
105     void didCloseFromServer(uint64_t databaseConnectionIdentifier, const IDBError&amp;);
<span class="line-removed">106     void confirmDidCloseFromServer(IDBDatabase&amp;);</span>
107 
108     void connectionToServerLost(const IDBError&amp;);
109 
110     void abortOpenAndUpgradeNeeded(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier);
111 
112     void completeOperation(const IDBResultData&amp;);
113 
<span class="line-modified">114     uint64_t serverConnectionIdentifier() const { return m_serverConnectionIdentifier; }</span>
115 
116     void ref();
117     void deref();
118 
119     void getAllDatabaseNames(const SecurityOrigin&amp; mainFrameOrigin, const SecurityOrigin&amp; openingOrigin, WTF::Function&lt;void (const Vector&lt;String&gt;&amp;)&gt;&amp;&amp;);
120 
121     void registerDatabaseConnection(IDBDatabase&amp;);
122     void unregisterDatabaseConnection(IDBDatabase&amp;);
123 
124     void forgetActiveOperations(const Vector&lt;RefPtr&lt;TransactionOperation&gt;&gt;&amp;);
125     void forgetTransaction(IDBTransaction&amp;);
126     void forgetActivityForCurrentThread();

127 
128 private:
129     void completeOpenDBRequest(const IDBResultData&amp;);
130     bool hasRecordOfTransaction(const IDBTransaction&amp;) const;
131 
132     void saveOperation(TransactionOperation&amp;);
133 
134     template&lt;typename... Parameters, typename... Arguments&gt;
135     void callConnectionOnMainThread(void (IDBConnectionToServer::*method)(Parameters...), Arguments&amp;&amp;... arguments)
136     {
137         if (isMainThread())
138             (m_connectionToServer.*method)(std::forward&lt;Arguments&gt;(arguments)...);
139         else
140             postMainThreadTask(m_connectionToServer, method, arguments...);
141     }
142 
143     template&lt;typename... Arguments&gt;
144     void postMainThreadTask(Arguments&amp;&amp;... arguments)
145     {
146         auto task = createCrossThreadTask(arguments...);
147         m_mainThreadQueue.append(WTFMove(task));
148 
149         scheduleMainThreadTasks();
150     }
151 
152     void scheduleMainThreadTasks();
153     void handleMainThreadTasks();
154 
155     IDBConnectionToServer&amp; m_connectionToServer;
<span class="line-modified">156     uint64_t m_serverConnectionIdentifier;</span>
157 
158     HashMap&lt;uint64_t, IDBDatabase*&gt; m_databaseConnectionMap;
159     Lock m_databaseConnectionMapLock;
160 
161     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;IDBOpenDBRequest&gt;&gt; m_openDBRequestMap;
162     Lock m_openDBRequestMapLock;
163 
164     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;IDBTransaction&gt;&gt; m_pendingTransactions;
165     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;IDBTransaction&gt;&gt; m_committingTransactions;
166     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;IDBTransaction&gt;&gt; m_abortingTransactions;
167     Lock m_transactionMapLock;
168 
169     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;TransactionOperation&gt;&gt; m_activeOperations;
170     Lock m_transactionOperationLock;
171 
172     CrossThreadQueue&lt;CrossThreadTask&gt; m_mainThreadQueue;
173     Lock m_mainThreadTaskLock;
174     RefPtr&lt;IDBConnectionToServer&gt; m_mainThreadProtector;
175 };
176 
</pre>
</td>
<td>
<hr />
<pre>
 68 
 69     Ref&lt;IDBOpenDBRequest&gt; deleteDatabase(ScriptExecutionContext&amp;, const IDBDatabaseIdentifier&amp;);
 70     void didDeleteDatabase(const IDBResultData&amp;);
 71 
 72     void createObjectStore(TransactionOperation&amp;, const IDBObjectStoreInfo&amp;);
 73     void deleteObjectStore(TransactionOperation&amp;, const String&amp; objectStoreName);
 74     void clearObjectStore(TransactionOperation&amp;, uint64_t objectStoreIdentifier);
 75     void createIndex(TransactionOperation&amp;, const IDBIndexInfo&amp;);
 76     void deleteIndex(TransactionOperation&amp;, uint64_t objectStoreIdentifier, const String&amp; indexName);
 77     void putOrAdd(TransactionOperation&amp;, IDBKeyData&amp;&amp;, const IDBValue&amp;, const IndexedDB::ObjectStoreOverwriteMode);
 78     void getRecord(TransactionOperation&amp;, const IDBGetRecordData&amp;);
 79     void getAllRecords(TransactionOperation&amp;, const IDBGetAllRecordsData&amp;);
 80     void getCount(TransactionOperation&amp;, const IDBKeyRangeData&amp;);
 81     void deleteRecord(TransactionOperation&amp;, const IDBKeyRangeData&amp;);
 82     void openCursor(TransactionOperation&amp;, const IDBCursorInfo&amp;);
 83     void iterateCursor(TransactionOperation&amp;, const IDBIterateCursorData&amp;);
 84     void renameObjectStore(TransactionOperation&amp;, uint64_t objectStoreIdentifier, const String&amp; newName);
 85     void renameIndex(TransactionOperation&amp;, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const String&amp; newName);
 86 
 87     void fireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier, uint64_t requestedVersion);
<span class="line-modified"> 88     void didFireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier, const IndexedDB::ConnectionClosedOnBehalfOfServer = IndexedDB::ConnectionClosedOnBehalfOfServer::No);</span>
 89 
 90     void notifyOpenDBRequestBlocked(const IDBResourceIdentifier&amp; requestIdentifier, uint64_t oldVersion, uint64_t newVersion);
 91     void openDBRequestCancelled(const IDBRequestData&amp;);
 92 
 93     void establishTransaction(IDBTransaction&amp;);
 94     void commitTransaction(IDBTransaction&amp;);
 95     void abortTransaction(IDBTransaction&amp;);
 96 
 97     void didStartTransaction(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBError&amp;);
 98     void didCommitTransaction(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBError&amp;);
 99     void didAbortTransaction(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBError&amp;);
100 
101     void didFinishHandlingVersionChangeTransaction(uint64_t databaseConnectionIdentifier, IDBTransaction&amp;);
102     void databaseConnectionPendingClose(IDBDatabase&amp;);
103     void databaseConnectionClosed(IDBDatabase&amp;);
104 
105     void didCloseFromServer(uint64_t databaseConnectionIdentifier, const IDBError&amp;);

106 
107     void connectionToServerLost(const IDBError&amp;);
108 
109     void abortOpenAndUpgradeNeeded(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier);
110 
111     void completeOperation(const IDBResultData&amp;);
112 
<span class="line-modified">113     IDBConnectionIdentifier serverConnectionIdentifier() const { return m_serverConnectionIdentifier; }</span>
114 
115     void ref();
116     void deref();
117 
118     void getAllDatabaseNames(const SecurityOrigin&amp; mainFrameOrigin, const SecurityOrigin&amp; openingOrigin, WTF::Function&lt;void (const Vector&lt;String&gt;&amp;)&gt;&amp;&amp;);
119 
120     void registerDatabaseConnection(IDBDatabase&amp;);
121     void unregisterDatabaseConnection(IDBDatabase&amp;);
122 
123     void forgetActiveOperations(const Vector&lt;RefPtr&lt;TransactionOperation&gt;&gt;&amp;);
124     void forgetTransaction(IDBTransaction&amp;);
125     void forgetActivityForCurrentThread();
<span class="line-added">126     void setContextSuspended(ScriptExecutionContext&amp; currentContext, bool isContextSuspended);</span>
127 
128 private:
129     void completeOpenDBRequest(const IDBResultData&amp;);
130     bool hasRecordOfTransaction(const IDBTransaction&amp;) const;
131 
132     void saveOperation(TransactionOperation&amp;);
133 
134     template&lt;typename... Parameters, typename... Arguments&gt;
135     void callConnectionOnMainThread(void (IDBConnectionToServer::*method)(Parameters...), Arguments&amp;&amp;... arguments)
136     {
137         if (isMainThread())
138             (m_connectionToServer.*method)(std::forward&lt;Arguments&gt;(arguments)...);
139         else
140             postMainThreadTask(m_connectionToServer, method, arguments...);
141     }
142 
143     template&lt;typename... Arguments&gt;
144     void postMainThreadTask(Arguments&amp;&amp;... arguments)
145     {
146         auto task = createCrossThreadTask(arguments...);
147         m_mainThreadQueue.append(WTFMove(task));
148 
149         scheduleMainThreadTasks();
150     }
151 
152     void scheduleMainThreadTasks();
153     void handleMainThreadTasks();
154 
155     IDBConnectionToServer&amp; m_connectionToServer;
<span class="line-modified">156     IDBConnectionIdentifier m_serverConnectionIdentifier;</span>
157 
158     HashMap&lt;uint64_t, IDBDatabase*&gt; m_databaseConnectionMap;
159     Lock m_databaseConnectionMapLock;
160 
161     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;IDBOpenDBRequest&gt;&gt; m_openDBRequestMap;
162     Lock m_openDBRequestMapLock;
163 
164     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;IDBTransaction&gt;&gt; m_pendingTransactions;
165     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;IDBTransaction&gt;&gt; m_committingTransactions;
166     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;IDBTransaction&gt;&gt; m_abortingTransactions;
167     Lock m_transactionMapLock;
168 
169     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;TransactionOperation&gt;&gt; m_activeOperations;
170     Lock m_transactionOperationLock;
171 
172     CrossThreadQueue&lt;CrossThreadTask&gt; m_mainThreadQueue;
173     Lock m_mainThreadTaskLock;
174     RefPtr&lt;IDBConnectionToServer&gt; m_mainThreadProtector;
175 };
176 
</pre>
</td>
</tr>
</table>
<center><a href="IDBConnectionProxy.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="IDBConnectionToServer.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>