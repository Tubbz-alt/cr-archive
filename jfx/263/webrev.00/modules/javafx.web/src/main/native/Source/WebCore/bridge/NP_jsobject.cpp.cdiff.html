<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/bridge/NP_jsobject.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../bindings/scripts/preprocess-idls.pl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="c/CRuntimeObject.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bridge/NP_jsobject.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 108,14 ***</span>
  void ObjectMap::RootObjectInvalidationCallback::operator()(RootObject* rootObject)
  {
      objectMap().remove(rootObject);
  }
  
<span class="line-modified">! static void getListFromVariantArgs(ExecState* exec, const NPVariant* args, unsigned argCount, RootObject* rootObject, MarkedArgumentBuffer&amp; aList)</span>
  {
      for (unsigned i = 0; i &lt; argCount; ++i)
<span class="line-modified">!         aList.append(convertNPVariantToValue(exec, &amp;args[i], rootObject));</span>
  }
  
  static NPObject* jsAllocate(NPP, NPClass*)
  {
      return static_cast&lt;NPObject*&gt;(malloc(sizeof(JavaScriptObject)));
<span class="line-new-header">--- 108,14 ---</span>
  void ObjectMap::RootObjectInvalidationCallback::operator()(RootObject* rootObject)
  {
      objectMap().remove(rootObject);
  }
  
<span class="line-modified">! static void getListFromVariantArgs(JSGlobalObject* lexicalGlobalObject, const NPVariant* args, unsigned argCount, RootObject* rootObject, MarkedArgumentBuffer&amp; aList)</span>
  {
      for (unsigned i = 0; i &lt; argCount; ++i)
<span class="line-modified">!         aList.append(convertNPVariantToValue(lexicalGlobalObject, &amp;args[i], rootObject));</span>
  }
  
  static NPObject* jsAllocate(NPP, NPClass*)
  {
      return static_cast&lt;NPObject*&gt;(malloc(sizeof(JavaScriptObject)));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 182,26 ***</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         ExecState* exec = globalObject-&gt;globalExec();</span>
  
          // Call the function object.
          JSValue function = obj-&gt;imp;
          CallData callData;
          CallType callType = getCallData(vm, function, callData);
          if (callType == CallType::None)
              return false;
  
          MarkedArgumentBuffer argList;
<span class="line-modified">!         getListFromVariantArgs(exec, args, argCount, rootObject, argList);</span>
          RELEASE_ASSERT(!argList.hasOverflowed());
<span class="line-modified">!         JSValue resultV = JSC::call(exec, function, callType, callData, function, argList);</span>
  
          // Convert and return the result of the function call.
<span class="line-modified">!         convertValueToNPVariant(exec, resultV, result);</span>
          scope.clearException();
          return true;
      }
  
      if (o-&gt;_class-&gt;invokeDefault)
<span class="line-new-header">--- 182,26 ---</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
  
          // Call the function object.
          JSValue function = obj-&gt;imp;
          CallData callData;
          CallType callType = getCallData(vm, function, callData);
          if (callType == CallType::None)
              return false;
  
          MarkedArgumentBuffer argList;
<span class="line-modified">!         getListFromVariantArgs(lexicalGlobalObject, args, argCount, rootObject, argList);</span>
          RELEASE_ASSERT(!argList.hasOverflowed());
<span class="line-modified">!         JSValue resultV = JSC::call(lexicalGlobalObject, function, callType, callData, function, argList);</span>
  
          // Convert and return the result of the function call.
<span class="line-modified">!         convertValueToNPVariant(lexicalGlobalObject, resultV, result);</span>
          scope.clearException();
          return true;
      }
  
      if (o-&gt;_class-&gt;invokeDefault)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 236,25 ***</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         ExecState* exec = globalObject-&gt;globalExec();</span>
<span class="line-modified">!         JSValue function = obj-&gt;imp-&gt;get(exec, identifierFromNPIdentifier(exec, i-&gt;string()));</span>
          CallData callData;
          CallType callType = getCallData(vm, function, callData);
          if (callType == CallType::None)
              return false;
  
          // Call the function object.
          MarkedArgumentBuffer argList;
<span class="line-modified">!         getListFromVariantArgs(exec, args, argCount, rootObject, argList);</span>
          RELEASE_ASSERT(!argList.hasOverflowed());
<span class="line-modified">!         JSValue resultV = JSC::call(exec, function, callType, callData, obj-&gt;imp, argList);</span>
  
          // Convert and return the result of the function call.
<span class="line-modified">!         convertValueToNPVariant(exec, resultV, result);</span>
          scope.clearException();
          return true;
      }
  
      if (o-&gt;_class-&gt;invoke)
<span class="line-new-header">--- 236,25 ---</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
<span class="line-modified">!         JSValue function = obj-&gt;imp-&gt;get(lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()));</span>
          CallData callData;
          CallType callType = getCallData(vm, function, callData);
          if (callType == CallType::None)
              return false;
  
          // Call the function object.
          MarkedArgumentBuffer argList;
<span class="line-modified">!         getListFromVariantArgs(lexicalGlobalObject, args, argCount, rootObject, argList);</span>
          RELEASE_ASSERT(!argList.hasOverflowed());
<span class="line-modified">!         JSValue resultV = JSC::call(lexicalGlobalObject, function, callType, callData, obj-&gt;imp, argList);</span>
  
          // Convert and return the result of the function call.
<span class="line-modified">!         convertValueToNPVariant(lexicalGlobalObject, resultV, result);</span>
          scope.clearException();
          return true;
      }
  
      if (o-&gt;_class-&gt;invoke)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 276,16 ***</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         ExecState* exec = globalObject-&gt;globalExec();</span>
          String scriptString = convertNPStringToUTF16(s);
  
<span class="line-modified">!         JSValue returnValue = JSC::evaluate(exec, JSC::makeSource(scriptString, { }), JSC::JSValue());</span>
  
<span class="line-modified">!         convertValueToNPVariant(exec, returnValue, variant);</span>
          scope.clearException();
          return true;
      }
  
      VOID_TO_NPVARIANT(*variant);
<span class="line-new-header">--- 276,16 ---</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
          String scriptString = convertNPStringToUTF16(s);
  
<span class="line-modified">!         JSValue returnValue = JSC::evaluate(lexicalGlobalObject, JSC::makeSource(scriptString, { }), JSC::JSValue());</span>
  
<span class="line-modified">!         convertValueToNPVariant(lexicalGlobalObject, returnValue, variant);</span>
          scope.clearException();
          return true;
      }
  
      VOID_TO_NPVARIANT(*variant);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 304,20 ***</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         ExecState* exec = globalObject-&gt;globalExec();</span>
          IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
  
          JSValue result;
          if (i-&gt;isString())
<span class="line-modified">!             result = obj-&gt;imp-&gt;get(exec, identifierFromNPIdentifier(exec, i-&gt;string()));</span>
          else
<span class="line-modified">!             result = obj-&gt;imp-&gt;get(exec, i-&gt;number());</span>
  
<span class="line-modified">!         convertValueToNPVariant(exec, result, variant);</span>
          scope.clearException();
          return true;
      }
  
      if (o-&gt;_class-&gt;hasProperty &amp;&amp; o-&gt;_class-&gt;getProperty) {
<span class="line-new-header">--- 304,20 ---</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
          IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
  
          JSValue result;
          if (i-&gt;isString())
<span class="line-modified">!             result = obj-&gt;imp-&gt;get(lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()));</span>
          else
<span class="line-modified">!             result = obj-&gt;imp-&gt;get(lexicalGlobalObject, i-&gt;number());</span>
  
<span class="line-modified">!         convertValueToNPVariant(lexicalGlobalObject, result, variant);</span>
          scope.clearException();
          return true;
      }
  
      if (o-&gt;_class-&gt;hasProperty &amp;&amp; o-&gt;_class-&gt;getProperty) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 342,18 ***</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         ExecState* exec = globalObject-&gt;globalExec();</span>
          IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
  
          if (i-&gt;isString()) {
              PutPropertySlot slot(obj-&gt;imp);
<span class="line-modified">!             obj-&gt;imp-&gt;methodTable(vm)-&gt;put(obj-&gt;imp, exec, identifierFromNPIdentifier(exec, i-&gt;string()), convertNPVariantToValue(exec, variant, rootObject), slot);</span>
          } else
<span class="line-modified">!             obj-&gt;imp-&gt;methodTable(vm)-&gt;putByIndex(obj-&gt;imp, exec, i-&gt;number(), convertNPVariantToValue(exec, variant, rootObject), false);</span>
          scope.clearException();
          return true;
      }
  
      if (o-&gt;_class-&gt;setProperty)
<span class="line-new-header">--- 342,18 ---</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
          IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
  
          if (i-&gt;isString()) {
              PutPropertySlot slot(obj-&gt;imp);
<span class="line-modified">!             obj-&gt;imp-&gt;methodTable(vm)-&gt;put(obj-&gt;imp, lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()), convertNPVariantToValue(lexicalGlobalObject, variant, rootObject), slot);</span>
          } else
<span class="line-modified">!             obj-&gt;imp-&gt;methodTable(vm)-&gt;putByIndex(obj-&gt;imp, lexicalGlobalObject, i-&gt;number(), convertNPVariantToValue(lexicalGlobalObject, variant, rootObject), false);</span>
          scope.clearException();
          return true;
      }
  
      if (o-&gt;_class-&gt;setProperty)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 374,29 ***</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         ExecState* exec = globalObject-&gt;globalExec();</span>
  
          IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
          if (i-&gt;isString()) {
<span class="line-modified">!             if (!obj-&gt;imp-&gt;hasProperty(exec, identifierFromNPIdentifier(exec, i-&gt;string()))) {</span>
                  scope.clearException();
                  return false;
              }
          } else {
<span class="line-modified">!             if (!obj-&gt;imp-&gt;hasProperty(exec, i-&gt;number())) {</span>
                  scope.clearException();
                  return false;
              }
          }
  
          if (i-&gt;isString())
<span class="line-modified">!             obj-&gt;imp-&gt;methodTable(vm)-&gt;deleteProperty(obj-&gt;imp, exec, identifierFromNPIdentifier(exec, i-&gt;string()));</span>
          else
<span class="line-modified">!             obj-&gt;imp-&gt;methodTable(vm)-&gt;deletePropertyByIndex(obj-&gt;imp, exec, i-&gt;number());</span>
  
          scope.clearException();
          return true;
      }
      return false;
<span class="line-new-header">--- 374,29 ---</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
  
          IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
          if (i-&gt;isString()) {
<span class="line-modified">!             if (!obj-&gt;imp-&gt;hasProperty(lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()))) {</span>
                  scope.clearException();
                  return false;
              }
          } else {
<span class="line-modified">!             if (!obj-&gt;imp-&gt;hasProperty(lexicalGlobalObject, i-&gt;number())) {</span>
                  scope.clearException();
                  return false;
              }
          }
  
          if (i-&gt;isString())
<span class="line-modified">!             obj-&gt;imp-&gt;methodTable(vm)-&gt;deleteProperty(obj-&gt;imp, lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()));</span>
          else
<span class="line-modified">!             obj-&gt;imp-&gt;methodTable(vm)-&gt;deletePropertyByIndex(obj-&gt;imp, lexicalGlobalObject, i-&gt;number());</span>
  
          scope.clearException();
          return true;
      }
      return false;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 414,19 ***</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         ExecState* exec = globalObject-&gt;globalExec();</span>
          IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
          if (i-&gt;isString()) {
<span class="line-modified">!             bool result = obj-&gt;imp-&gt;hasProperty(exec, identifierFromNPIdentifier(exec, i-&gt;string()));</span>
              scope.clearException();
              return result;
          }
  
<span class="line-modified">!         bool result = obj-&gt;imp-&gt;hasProperty(exec, i-&gt;number());</span>
          scope.clearException();
          return result;
      }
  
      if (o-&gt;_class-&gt;hasProperty)
<span class="line-new-header">--- 414,19 ---</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
          IdentifierRep* i = static_cast&lt;IdentifierRep*&gt;(propertyName);
          if (i-&gt;isString()) {
<span class="line-modified">!             bool result = obj-&gt;imp-&gt;hasProperty(lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()));</span>
              scope.clearException();
              return result;
          }
  
<span class="line-modified">!         bool result = obj-&gt;imp-&gt;hasProperty(lexicalGlobalObject, i-&gt;number());</span>
          scope.clearException();
          return result;
      }
  
      if (o-&gt;_class-&gt;hasProperty)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 451,12 ***</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         ExecState* exec = globalObject-&gt;globalExec();</span>
<span class="line-modified">!         JSValue func = obj-&gt;imp-&gt;get(exec, identifierFromNPIdentifier(exec, i-&gt;string()));</span>
          scope.clearException();
          return !func.isUndefined();
      }
  
      if (o-&gt;_class-&gt;hasMethod)
<span class="line-new-header">--- 451,12 ---</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
<span class="line-modified">!         JSValue func = obj-&gt;imp-&gt;get(lexicalGlobalObject, identifierFromNPIdentifier(lexicalGlobalObject, i-&gt;string()));</span>
          scope.clearException();
          return !func.isUndefined();
      }
  
      if (o-&gt;_class-&gt;hasMethod)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 484,14 ***</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         ExecState* exec = globalObject-&gt;globalExec();</span>
          PropertyNameArray propertyNames(vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude);
  
<span class="line-modified">!         obj-&gt;imp-&gt;methodTable(vm)-&gt;getPropertyNames(obj-&gt;imp, exec, propertyNames, EnumerationMode());</span>
          unsigned size = static_cast&lt;unsigned&gt;(propertyNames.size());
          // FIXME: This should really call NPN_MemAlloc but that&#39;s in WebKit
          NPIdentifier* identifiers = static_cast&lt;NPIdentifier*&gt;(malloc(sizeof(NPIdentifier) * size));
  
          for (unsigned i = 0; i &lt; size; ++i)
<span class="line-new-header">--- 484,14 ---</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
          PropertyNameArray propertyNames(vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude);
  
<span class="line-modified">!         obj-&gt;imp-&gt;methodTable(vm)-&gt;getPropertyNames(obj-&gt;imp, lexicalGlobalObject, propertyNames, EnumerationMode());</span>
          unsigned size = static_cast&lt;unsigned&gt;(propertyNames.size());
          // FIXME: This should really call NPN_MemAlloc but that&#39;s in WebKit
          NPIdentifier* identifiers = static_cast&lt;NPIdentifier*&gt;(malloc(sizeof(NPIdentifier) * size));
  
          for (unsigned i = 0; i &lt; size; ++i)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 525,26 ***</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         ExecState* exec = globalObject-&gt;globalExec();</span>
  
          // Call the constructor object.
          JSValue constructor = obj-&gt;imp;
          ConstructData constructData;
          ConstructType constructType = getConstructData(vm, constructor, constructData);
          if (constructType == ConstructType::None)
              return false;
  
          MarkedArgumentBuffer argList;
<span class="line-modified">!         getListFromVariantArgs(exec, args, argCount, rootObject, argList);</span>
          RELEASE_ASSERT(!argList.hasOverflowed());
<span class="line-modified">!         JSValue resultV = JSC::construct(exec, constructor, constructType, constructData, argList);</span>
  
          // Convert and return the result.
<span class="line-modified">!         convertValueToNPVariant(exec, resultV, result);</span>
          scope.clearException();
          return true;
      }
  
      if (NP_CLASS_STRUCT_VERSION_HAS_CTOR(o-&gt;_class) &amp;&amp; o-&gt;_class-&gt;construct)
<span class="line-new-header">--- 525,26 ---</span>
          auto globalObject = rootObject-&gt;globalObject();
          VM&amp; vm = globalObject-&gt;vm();
          JSLockHolder lock(vm);
          auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="line-modified">!         JSGlobalObject* lexicalGlobalObject = globalObject;</span>
  
          // Call the constructor object.
          JSValue constructor = obj-&gt;imp;
          ConstructData constructData;
          ConstructType constructType = getConstructData(vm, constructor, constructData);
          if (constructType == ConstructType::None)
              return false;
  
          MarkedArgumentBuffer argList;
<span class="line-modified">!         getListFromVariantArgs(lexicalGlobalObject, args, argCount, rootObject, argList);</span>
          RELEASE_ASSERT(!argList.hasOverflowed());
<span class="line-modified">!         JSValue resultV = JSC::construct(lexicalGlobalObject, constructor, constructType, constructData, argList);</span>
  
          // Convert and return the result.
<span class="line-modified">!         convertValueToNPVariant(lexicalGlobalObject, resultV, result);</span>
          scope.clearException();
          return true;
      }
  
      if (NP_CLASS_STRUCT_VERSION_HAS_CTOR(o-&gt;_class) &amp;&amp; o-&gt;_class-&gt;construct)
</pre>
<center><a href="../bindings/scripts/preprocess-idls.pl.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="c/CRuntimeObject.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>