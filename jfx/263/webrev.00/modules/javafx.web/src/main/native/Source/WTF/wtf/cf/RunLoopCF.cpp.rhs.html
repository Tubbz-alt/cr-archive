<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WTF/wtf/cf/RunLoopCF.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (C) 2010-2019 Apple Inc. All rights reserved.</span>
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &lt;wtf/RunLoop.h&gt;
 28 
 29 #include &lt;CoreFoundation/CoreFoundation.h&gt;
 30 #include &lt;dispatch/dispatch.h&gt;
 31 #include &lt;wtf/AutodrainedPool.h&gt;
 32 
 33 namespace WTF {
 34 
 35 void RunLoop::performWork(void* context)
 36 {
 37     AutodrainedPool pool;
 38     static_cast&lt;RunLoop*&gt;(context)-&gt;performWork();
 39 }
 40 
 41 RunLoop::RunLoop()
 42     : m_runLoop(CFRunLoopGetCurrent())
 43 {
 44     CFRunLoopSourceContext context = { 0, this, 0, 0, 0, 0, 0, 0, 0, performWork };
 45     m_runLoopSource = adoptCF(CFRunLoopSourceCreate(kCFAllocatorDefault, 0, &amp;context));
 46     CFRunLoopAddSource(m_runLoop.get(), m_runLoopSource.get(), kCFRunLoopCommonModes);
 47 }
 48 
 49 RunLoop::~RunLoop()
 50 {
 51     CFRunLoopSourceInvalidate(m_runLoopSource.get());
 52 }
 53 
 54 void RunLoop::runForDuration(Seconds duration)
 55 {
 56     CFRunLoopRunInMode(kCFRunLoopDefaultMode, duration.seconds(), true);
 57 }
 58 
 59 void RunLoop::wakeUp()
 60 {
 61     CFRunLoopSourceSignal(m_runLoopSource.get());
 62     CFRunLoopWakeUp(m_runLoop.get());
 63 }
 64 
<a name="2" id="anc2"></a><span class="line-added"> 65 RunLoop::CycleResult RunLoop::cycle(RunLoopMode mode)</span>
<span class="line-added"> 66 {</span>
<span class="line-added"> 67     CFTimeInterval timeInterval = 0.05;</span>
<span class="line-added"> 68     CFRunLoopRunInMode(mode, timeInterval, true);</span>
<span class="line-added"> 69     return CycleResult::Continue;</span>
<span class="line-added"> 70 }</span>
<span class="line-added"> 71 </span>
 72 void RunLoop::run()
 73 {
 74     AutodrainedPool pool;
 75     CFRunLoopRun();
 76 }
 77 
 78 void RunLoop::stop()
 79 {
 80     ASSERT(m_runLoop == CFRunLoopGetCurrent());
 81     CFRunLoopStop(m_runLoop.get());
 82 }
 83 
 84 // RunLoop::Timer
 85 
 86 void RunLoop::TimerBase::timerFired(CFRunLoopTimerRef, void* context)
 87 {
 88     TimerBase* timer = static_cast&lt;TimerBase*&gt;(context);
 89 
 90     AutodrainedPool pool;
 91     timer-&gt;fired();
 92 }
 93 
 94 RunLoop::TimerBase::TimerBase(RunLoop&amp; runLoop)
 95     : m_runLoop(runLoop)
 96 {
 97 }
 98 
 99 RunLoop::TimerBase::~TimerBase()
100 {
101     stop();
102 }
103 
104 void RunLoop::TimerBase::start(Seconds nextFireInterval, bool repeat)
105 {
106     if (m_timer)
107         stop();
108 
109     CFRunLoopTimerContext context = { 0, this, 0, 0, 0 };
110     Seconds repeatInterval = repeat ? nextFireInterval : 0_s;
111     m_timer = adoptCF(CFRunLoopTimerCreate(kCFAllocatorDefault, CFAbsoluteTimeGetCurrent() + nextFireInterval.seconds(), repeatInterval.seconds(), 0, 0, timerFired, &amp;context));
112     CFRunLoopAddTimer(m_runLoop-&gt;m_runLoop.get(), m_timer.get(), kCFRunLoopCommonModes);
113 }
114 
115 void RunLoop::TimerBase::stop()
116 {
117     if (!m_timer)
118         return;
119 
120     CFRunLoopTimerInvalidate(m_timer.get());
121     m_timer = nullptr;
122 }
123 
124 bool RunLoop::TimerBase::isActive() const
125 {
126     return m_timer &amp;&amp; CFRunLoopTimerIsValid(m_timer.get());
127 }
128 
129 Seconds RunLoop::TimerBase::secondsUntilFire() const
130 {
131     if (isActive())
132         return std::max&lt;Seconds&gt;(Seconds { CFRunLoopTimerGetNextFireDate(m_timer.get()) - CFAbsoluteTimeGetCurrent() }, 0_s);
133     return 0_s;
134 }
135 
136 } // namespace WTF
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>