<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/bridge/jni/jsc/BridgeUtils.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../c/c_utility.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JNIUtilityPrivate.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bridge/jni/jsc/BridgeUtils.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 120,11 ***</span>
  
  namespace WebCore {
  
  JSGlobalContextRef getGlobalContext(WebCore::ScriptController* scriptController)
  {
<span class="line-modified">!     return toGlobalRef(scriptController-&gt;globalObject(WebCore::mainThreadNormalWorld())-&gt;globalExec());</span>
  }
  
  JSStringRef asJSStringRef(JNIEnv *env, jstring str)
  {
      unsigned int slen = env-&gt;GetStringLength(str);
<span class="line-new-header">--- 120,11 ---</span>
  
  namespace WebCore {
  
  JSGlobalContextRef getGlobalContext(WebCore::ScriptController* scriptController)
  {
<span class="line-modified">!     return toGlobalRef(scriptController-&gt;globalObject(WebCore::mainThreadNormalWorld()));</span>
  }
  
  JSStringRef asJSStringRef(JNIEnv *env, jstring str)
  {
      unsigned int slen = env-&gt;GetStringLength(str);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 141,12 ***</span>
      jobject val,
      jobject accessControlContext)
  {
      if (val == nullptr)
          return JSValueMakeNull(ctx);
<span class="line-modified">!     JSC::ExecState* exec = toJS(ctx);</span>
<span class="line-modified">!     JSC::JSLockHolder lock(exec);</span>
  
      jclass clJSObject = getJSObjectClass(env);
      if (env-&gt;IsInstanceOf(val, clJSObject)) {
          static jfieldID fldPeer = env-&gt;GetFieldID(clJSObject, &quot;peer&quot;, &quot;J&quot;);
          static jfieldID fldPeerType = env-&gt;GetFieldID(clJSObject, &quot;peer_type&quot;, &quot;I&quot;);
<span class="line-new-header">--- 141,12 ---</span>
      jobject val,
      jobject accessControlContext)
  {
      if (val == nullptr)
          return JSValueMakeNull(ctx);
<span class="line-modified">!     JSC::JSGlobalObject* lexicalGlobalObject = toJS(ctx);</span>
<span class="line-modified">!     JSC::JSLockHolder lock(lexicalGlobalObject);</span>
  
      jclass clJSObject = getJSObjectClass(env);
      if (env-&gt;IsInstanceOf(val, clJSObject)) {
          static jfieldID fldPeer = env-&gt;GetFieldID(clJSObject, &quot;peer&quot;, &quot;J&quot;);
          static jfieldID fldPeerType = env-&gt;GetFieldID(clJSObject, &quot;peer_type&quot;, &quot;I&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 160,15 ***</span>
              {
                  JSDOMGlobalObject* globalObject = toJSDOMGlobalObject(
                      ((peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
                          ? *static_cast&lt;DOMWindow*&gt;(jlong_to_ptr(peer))-&gt;document()
                          : static_cast&lt;Node*&gt;(jlong_to_ptr(peer))-&gt;document()),
<span class="line-modified">!                     normalWorld(exec-&gt;vm()));</span>
<span class="line-modified">!                 return toRef(exec,</span>
                      (peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
<span class="line-modified">!                         ? WebCore::toJS(exec, globalObject, static_cast&lt;DOMWindow*&gt;(jlong_to_ptr(peer)))</span>
<span class="line-modified">!                         : WebCore::toJS(exec, globalObject, static_cast&lt;Node*&gt;(jlong_to_ptr(peer))));</span>
              }
          }
      }
      jclass clString = getStringClass(env);
      if (env-&gt;IsInstanceOf(val, clString)) {
<span class="line-new-header">--- 160,15 ---</span>
              {
                  JSDOMGlobalObject* globalObject = toJSDOMGlobalObject(
                      ((peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
                          ? *static_cast&lt;DOMWindow*&gt;(jlong_to_ptr(peer))-&gt;document()
                          : static_cast&lt;Node*&gt;(jlong_to_ptr(peer))-&gt;document()),
<span class="line-modified">!                     normalWorld(lexicalGlobalObject-&gt;vm()));</span>
<span class="line-modified">!                 return toRef(lexicalGlobalObject,</span>
                      (peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
<span class="line-modified">!                         ? WebCore::toJS(lexicalGlobalObject, globalObject, static_cast&lt;DOMWindow*&gt;(jlong_to_ptr(peer)))</span>
<span class="line-modified">!                         : WebCore::toJS(lexicalGlobalObject, globalObject, static_cast&lt;Node*&gt;(jlong_to_ptr(peer))));</span>
              }
          }
      }
      jclass clString = getStringClass(env);
      if (env-&gt;IsInstanceOf(val, clString)) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 192,18 ***</span>
  
      JLObject valClass(JSC::Bindings::callJNIMethod&lt;jobject&gt;(val, &quot;getClass&quot;, &quot;()Ljava/lang/Class;&quot;));
      if (JSC::Bindings::callJNIMethod&lt;jboolean&gt;(valClass, &quot;isArray&quot;, &quot;()Z&quot;)) {
          JLString className((jstring)JSC::Bindings::callJNIMethod&lt;jobject&gt;(valClass, &quot;getName&quot;, &quot;()Ljava/lang/String;&quot;));
          const char* classNameC = JSC::Bindings::getCharactersFromJString(className);
<span class="line-modified">!         JSC::JSValue arr = JSC::Bindings::JavaArray::convertJObjectToArray(exec, val, classNameC, rootObject, accessControlContext);</span>
          JSC::Bindings::releaseCharactersForJString(className, classNameC);
<span class="line-modified">!         return toRef(exec, arr);</span>
      }
      else {
          // All other Java Object types including java.lang.Character will be wrapped inside JavaInstance.
          RefPtr&lt;JSC::Bindings::JavaInstance&gt; jinstance = JSC::Bindings::JavaInstance::create(val, rootObject, accessControlContext);
<span class="line-modified">!         return toRef(jinstance-&gt;createRuntimeObject(exec));</span>
      }
  }
  
  jstring JSValue_to_Java_String(JSValueRef value, JNIEnv* env, JSContextRef ctx)
  {
<span class="line-new-header">--- 192,18 ---</span>
  
      JLObject valClass(JSC::Bindings::callJNIMethod&lt;jobject&gt;(val, &quot;getClass&quot;, &quot;()Ljava/lang/Class;&quot;));
      if (JSC::Bindings::callJNIMethod&lt;jboolean&gt;(valClass, &quot;isArray&quot;, &quot;()Z&quot;)) {
          JLString className((jstring)JSC::Bindings::callJNIMethod&lt;jobject&gt;(valClass, &quot;getName&quot;, &quot;()Ljava/lang/String;&quot;));
          const char* classNameC = JSC::Bindings::getCharactersFromJString(className);
<span class="line-modified">!         JSC::JSValue arr = JSC::Bindings::JavaArray::convertJObjectToArray(lexicalGlobalObject, val, classNameC, rootObject, accessControlContext);</span>
          JSC::Bindings::releaseCharactersForJString(className, classNameC);
<span class="line-modified">!         return toRef(lexicalGlobalObject, arr);</span>
      }
      else {
          // All other Java Object types including java.lang.Character will be wrapped inside JavaInstance.
          RefPtr&lt;JSC::Bindings::JavaInstance&gt; jinstance = JSC::Bindings::JavaInstance::create(val, rootObject, accessControlContext);
<span class="line-modified">!         return toRef(jinstance-&gt;createRuntimeObject(lexicalGlobalObject));</span>
      }
  }
  
  jstring JSValue_to_Java_String(JSValueRef value, JNIEnv* env, JSContextRef ctx)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 219,12 ***</span>
      JSValueRef value,
      JNIEnv*,
      JSContextRef ctx,
      JSC::Bindings::RootObject* rootObject)
  {
<span class="line-modified">!     JSC::ExecState* exec = toJS(ctx);</span>
<span class="line-modified">!     return convertValueToJValue(exec, rootObject, toJS(exec, value),</span>
          JSC::Bindings::JavaTypeObject, &quot;java.lang.Object&quot;).l;
  }
  
  static void throwJavaException(
      JNIEnv* env,
<span class="line-new-header">--- 219,12 ---</span>
      JSValueRef value,
      JNIEnv*,
      JSContextRef ctx,
      JSC::Bindings::RootObject* rootObject)
  {
<span class="line-modified">!     JSC::JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">!     return convertValueToJValue(globalObject, rootObject, toJS(globalObject, value),</span>
          JSC::Bindings::JavaTypeObject, &quot;java.lang.Object&quot;).l;
  }
  
  static void throwJavaException(
      JNIEnv* env,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 280,11 ***</span>
      case com_sun_webkit_dom_JSObject_JS_CONTEXT_OBJECT:
          {
              object = static_cast&lt;JSObjectRef&gt;(jlong_to_ptr(peer));
              rootObject = JSC::Bindings::findProtectingRootObject(reinterpret_cast&lt;JSC::JSObject*&gt;(object));
              if (rootObject) {
<span class="line-modified">!                 context = toRef(rootObject-&gt;globalObject()-&gt;globalExec());</span>
              }
          }
          break;
      case com_sun_webkit_dom_JSObject_JS_DOM_NODE_OBJECT:
      case com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT:
<span class="line-new-header">--- 280,11 ---</span>
      case com_sun_webkit_dom_JSObject_JS_CONTEXT_OBJECT:
          {
              object = static_cast&lt;JSObjectRef&gt;(jlong_to_ptr(peer));
              rootObject = JSC::Bindings::findProtectingRootObject(reinterpret_cast&lt;JSC::JSObject*&gt;(object));
              if (rootObject) {
<span class="line-modified">!                 context = toRef(rootObject-&gt;globalObject());</span>
              }
          }
          break;
      case com_sun_webkit_dom_JSObject_JS_DOM_NODE_OBJECT:
      case com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 297,17 ***</span>
                  return rootObject;
              }
              rootObject = &amp;(frame-&gt;script().createRootObject(frame).leakRef());
              if (rootObject) {
                  context = WebCore::getGlobalContext(&amp;frame-&gt;script());
<span class="line-modified">!                 JSC::ExecState* exec = toJS(context);</span>
<span class="line-modified">!                 JSC::JSLockHolder lock(exec);</span>
  
<span class="line-modified">!                 object = const_cast&lt;JSObjectRef&gt;(toRef(exec,</span>
                      (peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
<span class="line-modified">!                     ? WebCore::toJS(exec, static_cast&lt;WebCore::JSDOMGlobalObject *&gt;(rootObject-&gt;globalObject()), static_cast&lt;WebCore::DOMWindow*&gt;(jlong_to_ptr(peer)))</span>
<span class="line-modified">!                     : WebCore::toJS(exec, static_cast&lt;WebCore::JSDOMGlobalObject *&gt;(rootObject-&gt;globalObject()), static_cast&lt;WebCore::Node*&gt;(jlong_to_ptr(peer)))));</span>
  
              }
          }
          break;
      };
<span class="line-new-header">--- 297,17 ---</span>
                  return rootObject;
              }
              rootObject = &amp;(frame-&gt;script().createRootObject(frame).leakRef());
              if (rootObject) {
                  context = WebCore::getGlobalContext(&amp;frame-&gt;script());
<span class="line-modified">!                 JSC::JSGlobalObject* JSGlobalObject = toJS(context);</span>
<span class="line-modified">!                 JSC::JSLockHolder lock(JSGlobalObject);</span>
  
<span class="line-modified">!                 object = const_cast&lt;JSObjectRef&gt;(toRef(JSGlobalObject,</span>
                      (peer_type == com_sun_webkit_dom_JSObject_JS_DOM_WINDOW_OBJECT)
<span class="line-modified">!                     ? WebCore::toJS(JSGlobalObject, static_cast&lt;WebCore::JSDOMGlobalObject *&gt;(rootObject-&gt;globalObject()), static_cast&lt;WebCore::DOMWindow*&gt;(jlong_to_ptr(peer)))</span>
<span class="line-modified">!                     : WebCore::toJS(JSGlobalObject, static_cast&lt;WebCore::JSDOMGlobalObject *&gt;(rootObject-&gt;globalObject()), static_cast&lt;WebCore::Node*&gt;(jlong_to_ptr(peer)))));</span>
  
              }
          }
          break;
      };
</pre>
<hr />
<pre>
<span class="line-old-header">*** 438,14 ***</span>
      JSContextRef ctx;
      if (!checkJSPeer(peer, peer_type, object, ctx)) {
          return nullptr;
      }
  
<span class="line-modified">!     JSC::ExecState* exec = toJS(ctx);</span>
<span class="line-modified">!     JSC::JSLockHolder lock(exec);</span>
  
<span class="line-modified">!     return toJS(object)-&gt;toString(exec)-&gt;value(exec)</span>
          .toJavaString(env).releaseLocal();
  }
  
  JNIEXPORT jobject JNICALL Java_com_sun_webkit_dom_JSObject_callImpl
    (JNIEnv *env, jclass, jlong peer, jint peer_type, jstring methodName, jobjectArray args, jobject accessControlContext)
<span class="line-new-header">--- 438,14 ---</span>
      JSContextRef ctx;
      if (!checkJSPeer(peer, peer_type, object, ctx)) {
          return nullptr;
      }
  
<span class="line-modified">!     JSC::JSGlobalObject* JSGlobalObject = toJS(ctx);</span>
<span class="line-modified">!     JSC::JSLockHolder lock(JSGlobalObject);</span>
  
<span class="line-modified">!     return toJS(object)-&gt;toString(JSGlobalObject)-&gt;value(JSGlobalObject)</span>
          .toJavaString(env).releaseLocal();
  }
  
  JNIEXPORT jobject JNICALL Java_com_sun_webkit_dom_JSObject_callImpl
    (JNIEnv *env, jclass, jlong peer, jint peer_type, jstring methodName, jobjectArray args, jobject accessControlContext)
</pre>
<center><a href="../../c/c_utility.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JNIUtilityPrivate.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>