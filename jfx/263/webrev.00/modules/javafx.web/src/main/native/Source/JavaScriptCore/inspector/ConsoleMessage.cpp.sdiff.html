<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/inspector/ConsoleMessage.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../heap/WeakSetInlines.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ConsoleMessage.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/inspector/ConsoleMessage.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 35 #include &quot;InjectedScript.h&quot;
 36 #include &quot;InjectedScriptManager.h&quot;
 37 #include &quot;InspectorFrontendDispatchers.h&quot;
 38 #include &quot;ScriptArguments.h&quot;
 39 #include &quot;ScriptCallFrame.h&quot;
 40 #include &quot;ScriptCallStack.h&quot;
 41 #include &quot;ScriptCallStackFactory.h&quot;
 42 
 43 namespace Inspector {
 44 
 45 ConsoleMessage::ConsoleMessage(MessageSource source, MessageType type, MessageLevel level, const String&amp; message, unsigned long requestIdentifier)
 46     : m_source(source)
 47     , m_type(type)
 48     , m_level(level)
 49     , m_message(message)
 50     , m_url()
 51     , m_requestId(IdentifiersFactory::requestId(requestIdentifier))
 52 {
 53 }
 54 
<span class="line-modified"> 55 ConsoleMessage::ConsoleMessage(MessageSource source, MessageType type, MessageLevel level, const String&amp; message, const String&amp; url, unsigned line, unsigned column, JSC::ExecState* state, unsigned long requestIdentifier)</span>
 56     : m_source(source)
 57     , m_type(type)
 58     , m_level(level)
 59     , m_message(message)
 60     , m_url(url)
 61     , m_line(line)
 62     , m_column(column)
 63     , m_requestId(IdentifiersFactory::requestId(requestIdentifier))
 64 {
<span class="line-modified"> 65     autogenerateMetadata(state);</span>
 66 }
 67 
 68 ConsoleMessage::ConsoleMessage(MessageSource source, MessageType type, MessageLevel level, const String&amp; message, Ref&lt;ScriptCallStack&gt;&amp;&amp; callStack, unsigned long requestIdentifier)
 69     : m_source(source)
 70     , m_type(type)
 71     , m_level(level)
 72     , m_message(message)
 73     , m_callStack(WTFMove(callStack))
 74     , m_url()
 75     , m_requestId(IdentifiersFactory::requestId(requestIdentifier))
 76 {
 77     const ScriptCallFrame* frame = m_callStack ? m_callStack-&gt;firstNonNativeCallFrame() : nullptr;
 78     if (frame) {
 79         m_url = frame-&gt;sourceURL();
 80         m_line = frame-&gt;lineNumber();
 81         m_column = frame-&gt;columnNumber();
 82     }
 83 }
 84 
 85 ConsoleMessage::ConsoleMessage(MessageSource source, MessageType type, MessageLevel level, const String&amp; message, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments, Ref&lt;ScriptCallStack&gt;&amp;&amp; callStack, unsigned long requestIdentifier)
 86     : m_source(source)
 87     , m_type(type)
 88     , m_level(level)
 89     , m_message(message)
 90     , m_arguments(WTFMove(arguments))
 91     , m_callStack(WTFMove(callStack))
 92     , m_url()
 93     , m_requestId(IdentifiersFactory::requestId(requestIdentifier))
 94 {
 95     const ScriptCallFrame* frame = m_callStack ? m_callStack-&gt;firstNonNativeCallFrame() : nullptr;
 96     if (frame) {
 97         m_url = frame-&gt;sourceURL();
 98         m_line = frame-&gt;lineNumber();
 99         m_column = frame-&gt;columnNumber();
100     }
101 }
102 
<span class="line-modified">103 ConsoleMessage::ConsoleMessage(MessageSource source, MessageType type, MessageLevel level, const String&amp; message, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments, JSC::ExecState* state, unsigned long requestIdentifier)</span>
104     : m_source(source)
105     , m_type(type)
106     , m_level(level)
107     , m_message(message)
108     , m_arguments(WTFMove(arguments))
109     , m_url()
110     , m_requestId(IdentifiersFactory::requestId(requestIdentifier))
111 {
<span class="line-modified">112     autogenerateMetadata(state);</span>
113 }
114 
<span class="line-modified">115 ConsoleMessage::ConsoleMessage(MessageSource source, MessageType type, MessageLevel level, Vector&lt;JSONLogValue&gt;&amp;&amp; messages, JSC::ExecState* state, unsigned long requestIdentifier)</span>
116     : m_source(source)
117     , m_type(type)
118     , m_level(level)
119     , m_url()
<span class="line-removed">120     , m_scriptState(state)</span>
121     , m_requestId(IdentifiersFactory::requestId(requestIdentifier))
122 {



123     if (!messages.size())
124         return;
125 
126     m_jsonLogValues.reserveInitialCapacity(messages.size());
127 
128     StringBuilder builder;
129     for (auto&amp; message : messages) {
130         switch (message.type) {
131         case JSONLogValue::Type::String:
132             builder.append(message.value);
133             break;
134         case JSONLogValue::Type::JSON:
135             if (builder.length()) {
136                 m_jsonLogValues.append({ JSONLogValue::Type::String, JSON::Value::create(builder.toString())-&gt;toJSONString() });
137                 builder.resize(0);
138             }
139 
140             m_jsonLogValues.append(message);
141             break;
142         }
143     }
144 
145     if (builder.length())
146         m_jsonLogValues.append({ JSONLogValue::Type::String, JSON::Value::create(builder.toString())-&gt;toJSONString() });
147 
148     if (m_jsonLogValues.size())
149         m_message = m_jsonLogValues[0].value;
150 }
151 
152 ConsoleMessage::~ConsoleMessage()
153 {
154 }
155 
<span class="line-modified">156 void ConsoleMessage::autogenerateMetadata(JSC::ExecState* state)</span>
157 {
<span class="line-modified">158     if (!state)</span>
159         return;
160 
161     if (m_type == MessageType::EndGroup)
162         return;
163 
164     // FIXME: Should this really be using &quot;for console&quot; in the generic ConsoleMessage autogeneration? This can skip the first frame.
<span class="line-modified">165     m_callStack = createScriptCallStackForConsole(state);</span>
166 
167     if (const ScriptCallFrame* frame = m_callStack-&gt;firstNonNativeCallFrame()) {
168         m_url = frame-&gt;sourceURL();
169         m_line = frame-&gt;lineNumber();
170         m_column = frame-&gt;columnNumber();
171         return;
172     }
173 }
174 
175 static Protocol::Console::ChannelSource messageSourceValue(MessageSource source)
176 {
177     switch (source) {
178     case MessageSource::XML: return Protocol::Console::ChannelSource::XML;
179     case MessageSource::JS: return Protocol::Console::ChannelSource::JavaScript;
180     case MessageSource::Network: return Protocol::Console::ChannelSource::Network;
181     case MessageSource::ConsoleAPI: return Protocol::Console::ChannelSource::ConsoleAPI;
182     case MessageSource::Storage: return Protocol::Console::ChannelSource::Storage;
183     case MessageSource::AppCache: return Protocol::Console::ChannelSource::Appcache;
184     case MessageSource::Rendering: return Protocol::Console::ChannelSource::Rendering;
185     case MessageSource::CSS: return Protocol::Console::ChannelSource::CSS;
</pre>
<hr />
<pre>
228 
229 void ConsoleMessage::addToFrontend(ConsoleFrontendDispatcher&amp; consoleFrontendDispatcher, InjectedScriptManager&amp; injectedScriptManager, bool generatePreview)
230 {
231     auto messageObject = Protocol::Console::ConsoleMessage::create()
232         .setSource(messageSourceValue(m_source))
233         .setLevel(messageLevelValue(m_level))
234         .setText(m_message)
235         .release();
236 
237     // FIXME: only send out type for ConsoleAPI source messages.
238     messageObject-&gt;setType(messageTypeValue(m_type));
239     messageObject-&gt;setLine(static_cast&lt;int&gt;(m_line));
240     messageObject-&gt;setColumn(static_cast&lt;int&gt;(m_column));
241     messageObject-&gt;setUrl(m_url);
242     messageObject-&gt;setRepeatCount(static_cast&lt;int&gt;(m_repeatCount));
243 
244     if (m_source == MessageSource::Network &amp;&amp; !m_requestId.isEmpty())
245         messageObject-&gt;setNetworkRequestId(m_requestId);
246 
247     if ((m_arguments &amp;&amp; m_arguments-&gt;argumentCount()) || m_jsonLogValues.size()) {
<span class="line-modified">248         InjectedScript injectedScript = injectedScriptManager.injectedScriptFor(scriptState());</span>
249         if (!injectedScript.hasNoValue()) {
250             auto argumentsObject = JSON::ArrayOf&lt;Protocol::Runtime::RemoteObject&gt;::create();
251             if (m_arguments &amp;&amp; m_arguments-&gt;argumentCount()) {
252                 if (m_type == MessageType::Table &amp;&amp; generatePreview &amp;&amp; m_arguments-&gt;argumentCount()) {
253                     auto table = m_arguments-&gt;argumentAt(0);
254                     auto columns = m_arguments-&gt;argumentCount() &gt; 1 ? m_arguments-&gt;argumentAt(1) : JSC::JSValue();
255                     auto inspectorValue = injectedScript.wrapTable(table, columns);
256                     if (!inspectorValue) {
257                         ASSERT_NOT_REACHED();
258                         return;
259                     }
260                     argumentsObject-&gt;addItem(WTFMove(inspectorValue));
261                     if (m_arguments-&gt;argumentCount() &gt; 1)
262                         argumentsObject-&gt;addItem(injectedScript.wrapObject(columns, &quot;console&quot;_s, true));
263                 } else {
264                     for (unsigned i = 0; i &lt; m_arguments-&gt;argumentCount(); ++i) {
265                         auto inspectorValue = injectedScript.wrapObject(m_arguments-&gt;argumentAt(i), &quot;console&quot;_s, generatePreview);
266                         if (!inspectorValue) {
267                             ASSERT_NOT_REACHED();
268                             return;
</pre>
<hr />
<pre>
323     if (m_jsonLogValues.size() || msg-&gt;m_jsonLogValues.size())
324         return false;
325 
326     return msg-&gt;m_source == m_source
327         &amp;&amp; msg-&gt;m_type == m_type
328         &amp;&amp; msg-&gt;m_level == m_level
329         &amp;&amp; msg-&gt;m_message == m_message
330         &amp;&amp; msg-&gt;m_line == m_line
331         &amp;&amp; msg-&gt;m_column == m_column
332         &amp;&amp; msg-&gt;m_url == m_url
333         &amp;&amp; msg-&gt;m_requestId == m_requestId;
334 }
335 
336 void ConsoleMessage::clear()
337 {
338     if (!m_message)
339         m_message = &quot;&lt;message collected&gt;&quot;_s;
340 
341     if (m_arguments)
342         m_arguments = nullptr;



343 }
344 
<span class="line-modified">345 JSC::ExecState* ConsoleMessage::scriptState() const</span>
346 {
347     if (m_arguments)
<span class="line-modified">348         return m_arguments-&gt;globalState();</span>
349 
<span class="line-modified">350     if (m_scriptState)</span>
<span class="line-modified">351         return m_scriptState;</span>
352 
353     return nullptr;
354 }
355 
356 unsigned ConsoleMessage::argumentCount() const
357 {
358     if (m_arguments)
359         return m_arguments-&gt;argumentCount();
360 
361     return 0;
362 }
363 
364 } // namespace Inspector
</pre>
</td>
<td>
<hr />
<pre>
 35 #include &quot;InjectedScript.h&quot;
 36 #include &quot;InjectedScriptManager.h&quot;
 37 #include &quot;InspectorFrontendDispatchers.h&quot;
 38 #include &quot;ScriptArguments.h&quot;
 39 #include &quot;ScriptCallFrame.h&quot;
 40 #include &quot;ScriptCallStack.h&quot;
 41 #include &quot;ScriptCallStackFactory.h&quot;
 42 
 43 namespace Inspector {
 44 
 45 ConsoleMessage::ConsoleMessage(MessageSource source, MessageType type, MessageLevel level, const String&amp; message, unsigned long requestIdentifier)
 46     : m_source(source)
 47     , m_type(type)
 48     , m_level(level)
 49     , m_message(message)
 50     , m_url()
 51     , m_requestId(IdentifiersFactory::requestId(requestIdentifier))
 52 {
 53 }
 54 
<span class="line-modified"> 55 ConsoleMessage::ConsoleMessage(MessageSource source, MessageType type, MessageLevel level, const String&amp; message, const String&amp; url, unsigned line, unsigned column, JSC::JSGlobalObject* globalObject, unsigned long requestIdentifier)</span>
 56     : m_source(source)
 57     , m_type(type)
 58     , m_level(level)
 59     , m_message(message)
 60     , m_url(url)
 61     , m_line(line)
 62     , m_column(column)
 63     , m_requestId(IdentifiersFactory::requestId(requestIdentifier))
 64 {
<span class="line-modified"> 65     autogenerateMetadata(globalObject);</span>
 66 }
 67 
 68 ConsoleMessage::ConsoleMessage(MessageSource source, MessageType type, MessageLevel level, const String&amp; message, Ref&lt;ScriptCallStack&gt;&amp;&amp; callStack, unsigned long requestIdentifier)
 69     : m_source(source)
 70     , m_type(type)
 71     , m_level(level)
 72     , m_message(message)
 73     , m_callStack(WTFMove(callStack))
 74     , m_url()
 75     , m_requestId(IdentifiersFactory::requestId(requestIdentifier))
 76 {
 77     const ScriptCallFrame* frame = m_callStack ? m_callStack-&gt;firstNonNativeCallFrame() : nullptr;
 78     if (frame) {
 79         m_url = frame-&gt;sourceURL();
 80         m_line = frame-&gt;lineNumber();
 81         m_column = frame-&gt;columnNumber();
 82     }
 83 }
 84 
 85 ConsoleMessage::ConsoleMessage(MessageSource source, MessageType type, MessageLevel level, const String&amp; message, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments, Ref&lt;ScriptCallStack&gt;&amp;&amp; callStack, unsigned long requestIdentifier)
 86     : m_source(source)
 87     , m_type(type)
 88     , m_level(level)
 89     , m_message(message)
 90     , m_arguments(WTFMove(arguments))
 91     , m_callStack(WTFMove(callStack))
 92     , m_url()
 93     , m_requestId(IdentifiersFactory::requestId(requestIdentifier))
 94 {
 95     const ScriptCallFrame* frame = m_callStack ? m_callStack-&gt;firstNonNativeCallFrame() : nullptr;
 96     if (frame) {
 97         m_url = frame-&gt;sourceURL();
 98         m_line = frame-&gt;lineNumber();
 99         m_column = frame-&gt;columnNumber();
100     }
101 }
102 
<span class="line-modified">103 ConsoleMessage::ConsoleMessage(MessageSource source, MessageType type, MessageLevel level, const String&amp; message, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments, JSC::JSGlobalObject* globalObject, unsigned long requestIdentifier)</span>
104     : m_source(source)
105     , m_type(type)
106     , m_level(level)
107     , m_message(message)
108     , m_arguments(WTFMove(arguments))
109     , m_url()
110     , m_requestId(IdentifiersFactory::requestId(requestIdentifier))
111 {
<span class="line-modified">112     autogenerateMetadata(globalObject);</span>
113 }
114 
<span class="line-modified">115 ConsoleMessage::ConsoleMessage(MessageSource source, MessageType type, MessageLevel level, Vector&lt;JSONLogValue&gt;&amp;&amp; messages, JSC::JSGlobalObject* globalObject, unsigned long requestIdentifier)</span>
116     : m_source(source)
117     , m_type(type)
118     , m_level(level)
119     , m_url()

120     , m_requestId(IdentifiersFactory::requestId(requestIdentifier))
121 {
<span class="line-added">122     if (globalObject)</span>
<span class="line-added">123         m_globalObject = { globalObject-&gt;vm(), globalObject };</span>
<span class="line-added">124 </span>
125     if (!messages.size())
126         return;
127 
128     m_jsonLogValues.reserveInitialCapacity(messages.size());
129 
130     StringBuilder builder;
131     for (auto&amp; message : messages) {
132         switch (message.type) {
133         case JSONLogValue::Type::String:
134             builder.append(message.value);
135             break;
136         case JSONLogValue::Type::JSON:
137             if (builder.length()) {
138                 m_jsonLogValues.append({ JSONLogValue::Type::String, JSON::Value::create(builder.toString())-&gt;toJSONString() });
139                 builder.resize(0);
140             }
141 
142             m_jsonLogValues.append(message);
143             break;
144         }
145     }
146 
147     if (builder.length())
148         m_jsonLogValues.append({ JSONLogValue::Type::String, JSON::Value::create(builder.toString())-&gt;toJSONString() });
149 
150     if (m_jsonLogValues.size())
151         m_message = m_jsonLogValues[0].value;
152 }
153 
154 ConsoleMessage::~ConsoleMessage()
155 {
156 }
157 
<span class="line-modified">158 void ConsoleMessage::autogenerateMetadata(JSC::JSGlobalObject* globalObject)</span>
159 {
<span class="line-modified">160     if (!globalObject)</span>
161         return;
162 
163     if (m_type == MessageType::EndGroup)
164         return;
165 
166     // FIXME: Should this really be using &quot;for console&quot; in the generic ConsoleMessage autogeneration? This can skip the first frame.
<span class="line-modified">167     m_callStack = createScriptCallStackForConsole(globalObject);</span>
168 
169     if (const ScriptCallFrame* frame = m_callStack-&gt;firstNonNativeCallFrame()) {
170         m_url = frame-&gt;sourceURL();
171         m_line = frame-&gt;lineNumber();
172         m_column = frame-&gt;columnNumber();
173         return;
174     }
175 }
176 
177 static Protocol::Console::ChannelSource messageSourceValue(MessageSource source)
178 {
179     switch (source) {
180     case MessageSource::XML: return Protocol::Console::ChannelSource::XML;
181     case MessageSource::JS: return Protocol::Console::ChannelSource::JavaScript;
182     case MessageSource::Network: return Protocol::Console::ChannelSource::Network;
183     case MessageSource::ConsoleAPI: return Protocol::Console::ChannelSource::ConsoleAPI;
184     case MessageSource::Storage: return Protocol::Console::ChannelSource::Storage;
185     case MessageSource::AppCache: return Protocol::Console::ChannelSource::Appcache;
186     case MessageSource::Rendering: return Protocol::Console::ChannelSource::Rendering;
187     case MessageSource::CSS: return Protocol::Console::ChannelSource::CSS;
</pre>
<hr />
<pre>
230 
231 void ConsoleMessage::addToFrontend(ConsoleFrontendDispatcher&amp; consoleFrontendDispatcher, InjectedScriptManager&amp; injectedScriptManager, bool generatePreview)
232 {
233     auto messageObject = Protocol::Console::ConsoleMessage::create()
234         .setSource(messageSourceValue(m_source))
235         .setLevel(messageLevelValue(m_level))
236         .setText(m_message)
237         .release();
238 
239     // FIXME: only send out type for ConsoleAPI source messages.
240     messageObject-&gt;setType(messageTypeValue(m_type));
241     messageObject-&gt;setLine(static_cast&lt;int&gt;(m_line));
242     messageObject-&gt;setColumn(static_cast&lt;int&gt;(m_column));
243     messageObject-&gt;setUrl(m_url);
244     messageObject-&gt;setRepeatCount(static_cast&lt;int&gt;(m_repeatCount));
245 
246     if (m_source == MessageSource::Network &amp;&amp; !m_requestId.isEmpty())
247         messageObject-&gt;setNetworkRequestId(m_requestId);
248 
249     if ((m_arguments &amp;&amp; m_arguments-&gt;argumentCount()) || m_jsonLogValues.size()) {
<span class="line-modified">250         InjectedScript injectedScript = injectedScriptManager.injectedScriptFor(globalObject());</span>
251         if (!injectedScript.hasNoValue()) {
252             auto argumentsObject = JSON::ArrayOf&lt;Protocol::Runtime::RemoteObject&gt;::create();
253             if (m_arguments &amp;&amp; m_arguments-&gt;argumentCount()) {
254                 if (m_type == MessageType::Table &amp;&amp; generatePreview &amp;&amp; m_arguments-&gt;argumentCount()) {
255                     auto table = m_arguments-&gt;argumentAt(0);
256                     auto columns = m_arguments-&gt;argumentCount() &gt; 1 ? m_arguments-&gt;argumentAt(1) : JSC::JSValue();
257                     auto inspectorValue = injectedScript.wrapTable(table, columns);
258                     if (!inspectorValue) {
259                         ASSERT_NOT_REACHED();
260                         return;
261                     }
262                     argumentsObject-&gt;addItem(WTFMove(inspectorValue));
263                     if (m_arguments-&gt;argumentCount() &gt; 1)
264                         argumentsObject-&gt;addItem(injectedScript.wrapObject(columns, &quot;console&quot;_s, true));
265                 } else {
266                     for (unsigned i = 0; i &lt; m_arguments-&gt;argumentCount(); ++i) {
267                         auto inspectorValue = injectedScript.wrapObject(m_arguments-&gt;argumentAt(i), &quot;console&quot;_s, generatePreview);
268                         if (!inspectorValue) {
269                             ASSERT_NOT_REACHED();
270                             return;
</pre>
<hr />
<pre>
325     if (m_jsonLogValues.size() || msg-&gt;m_jsonLogValues.size())
326         return false;
327 
328     return msg-&gt;m_source == m_source
329         &amp;&amp; msg-&gt;m_type == m_type
330         &amp;&amp; msg-&gt;m_level == m_level
331         &amp;&amp; msg-&gt;m_message == m_message
332         &amp;&amp; msg-&gt;m_line == m_line
333         &amp;&amp; msg-&gt;m_column == m_column
334         &amp;&amp; msg-&gt;m_url == m_url
335         &amp;&amp; msg-&gt;m_requestId == m_requestId;
336 }
337 
338 void ConsoleMessage::clear()
339 {
340     if (!m_message)
341         m_message = &quot;&lt;message collected&gt;&quot;_s;
342 
343     if (m_arguments)
344         m_arguments = nullptr;
<span class="line-added">345 </span>
<span class="line-added">346     if (m_globalObject)</span>
<span class="line-added">347         m_globalObject.clear();</span>
348 }
349 
<span class="line-modified">350 JSC::JSGlobalObject* ConsoleMessage::globalObject() const</span>
351 {
352     if (m_arguments)
<span class="line-modified">353         return m_arguments-&gt;globalObject();</span>
354 
<span class="line-modified">355     if (m_globalObject)</span>
<span class="line-modified">356         return m_globalObject.get();</span>
357 
358     return nullptr;
359 }
360 
361 unsigned ConsoleMessage::argumentCount() const
362 {
363     if (m_arguments)
364         return m_arguments-&gt;argumentCount();
365 
366     return 0;
367 }
368 
369 } // namespace Inspector
</pre>
</td>
</tr>
</table>
<center><a href="../heap/WeakSetInlines.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ConsoleMessage.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>