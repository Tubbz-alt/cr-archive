<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/UserMediaRequest.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="UserMediaController.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="UserMediaRequest.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/UserMediaRequest.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -36,19 +36,20 @@</span>
  
  #if ENABLE(MEDIA_STREAM)
  
  #include &quot;Document.h&quot;
  #include &quot;Frame.h&quot;
<span class="udiff-line-added">+ #include &quot;JSDOMPromiseDeferred.h&quot;</span>
  #include &quot;JSMediaStream.h&quot;
  #include &quot;JSOverconstrainedError.h&quot;
  #include &quot;Logging.h&quot;
  #include &quot;MediaConstraints.h&quot;
  #include &quot;PlatformMediaSessionManager.h&quot;
  #include &quot;RealtimeMediaSourceCenter.h&quot;
<span class="udiff-line-removed">- #include &quot;SchemeRegistry.h&quot;</span>
  #include &quot;Settings.h&quot;
  #include &quot;UserMediaController.h&quot;
<span class="udiff-line-added">+ #include &quot;WindowEventLoop.h&quot;</span>
  #include &lt;wtf/Scope.h&gt;
  
  namespace WebCore {
  
  Ref&lt;UserMediaRequest&gt; UserMediaRequest::create(Document&amp; document, MediaStreamRequest&amp;&amp; request, DOMPromiseDeferred&lt;IDLInterface&lt;MediaStream&gt;&gt;&amp;&amp; promise)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -58,16 +59,21 @@</span>
      return result;
  }
  
  UserMediaRequest::UserMediaRequest(Document&amp; document, MediaStreamRequest&amp;&amp; request, DOMPromiseDeferred&lt;IDLInterface&lt;MediaStream&gt;&gt;&amp;&amp; promise)
      : ActiveDOMObject(document)
<span class="udiff-line-modified-removed">-     , m_promise(WTFMove(promise))</span>
<span class="udiff-line-modified-added">+     , m_identifier(UserMediaRequestIdentifier::generate())</span>
<span class="udiff-line-added">+     , m_promise(makeUniqueRef&lt;DOMPromiseDeferred&lt;IDLInterface&lt;MediaStream&gt;&gt;&gt;(WTFMove(promise)))</span>
      , m_request(WTFMove(request))
  {
  }
  
<span class="udiff-line-modified-removed">- UserMediaRequest::~UserMediaRequest() = default;</span>
<span class="udiff-line-modified-added">+ UserMediaRequest::~UserMediaRequest()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (m_allowCompletionHandler)</span>
<span class="udiff-line-added">+         m_allowCompletionHandler();</span>
<span class="udiff-line-added">+ }</span>
  
  SecurityOrigin* UserMediaRequest::userMediaDocumentOrigin() const
  {
      if (!m_scriptExecutionContext)
          return nullptr;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -190,73 +196,95 @@</span>
      //     or due to platform limitations, jump to the step labeled Permission Failure below.
      // ...
      // 6.10 Permission Failure: Reject p with a new DOMException object whose name attribute has
      //      the value NotAllowedError.
  
<span class="udiff-line-modified-removed">-     OptionSet&lt;UserMediaController::CaptureType&gt; types;</span>
<span class="udiff-line-modified-removed">-     UserMediaController::BlockedCaller caller;</span>
<span class="udiff-line-modified-removed">-     if (m_request.type == MediaStreamRequest::Type::DisplayMedia) {</span>
<span class="udiff-line-modified-removed">-         types.add(UserMediaController::CaptureType::Display);</span>
<span class="udiff-line-modified-removed">-         caller = UserMediaController::BlockedCaller::GetDisplayMedia;</span>
<span class="udiff-line-modified-removed">-     } else {</span>
<span class="udiff-line-modified-removed">-         if (m_request.audioConstraints.isValid)</span>
<span class="udiff-line-modified-removed">-             types.add(UserMediaController::CaptureType::Microphone);</span>
<span class="udiff-line-modified-removed">-         if (m_request.videoConstraints.isValid)</span>
<span class="udiff-line-modified-removed">-             types.add(UserMediaController::CaptureType::Camera);</span>
<span class="udiff-line-modified-removed">-         caller = UserMediaController::BlockedCaller::GetUserMedia;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">-     auto access = controller-&gt;canCallGetUserMedia(document, types);</span>
<span class="udiff-line-modified-removed">-     if (access != UserMediaController::GetUserMediaAccess::CanCall) {</span>
<span class="udiff-line-modified-removed">-         deny(MediaAccessDenialReason::PermissionDenied);</span>
<span class="udiff-line-modified-removed">-         controller-&gt;logGetUserMediaDenial(document, access, caller);</span>
<span class="udiff-line-modified-removed">-         return;</span>
<span class="udiff-line-modified-added">+     switch (m_request.type) {</span>
<span class="udiff-line-modified-added">+     case MediaStreamRequest::Type::DisplayMedia:</span>
<span class="udiff-line-modified-added">+         if (!isFeaturePolicyAllowedByDocumentAndAllOwners(FeaturePolicy::Type::DisplayCapture, document)) {</span>
<span class="udiff-line-modified-added">+             deny(MediaAccessDenialReason::PermissionDenied);</span>
<span class="udiff-line-modified-added">+             controller-&gt;logGetDisplayMediaDenial(document);</span>
<span class="udiff-line-modified-added">+             return;</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+         break;</span>
<span class="udiff-line-modified-added">+     case MediaStreamRequest::Type::UserMedia:</span>
<span class="udiff-line-modified-added">+         if (m_request.audioConstraints.isValid &amp;&amp; !isFeaturePolicyAllowedByDocumentAndAllOwners(FeaturePolicy::Type::Microphone, document)) {</span>
<span class="udiff-line-modified-added">+             deny(MediaAccessDenialReason::PermissionDenied);</span>
<span class="udiff-line-modified-added">+             controller-&gt;logGetUserMediaDenial(document);</span>
<span class="udiff-line-modified-added">+             return;</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+         if (m_request.videoConstraints.isValid &amp;&amp; !isFeaturePolicyAllowedByDocumentAndAllOwners(FeaturePolicy::Type::Camera, document)) {</span>
<span class="udiff-line-modified-added">+             deny(MediaAccessDenialReason::PermissionDenied);</span>
<span class="udiff-line-modified-added">+             controller-&gt;logGetUserMediaDenial(document);</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         break;</span>
      }
  
      PlatformMediaSessionManager::sharedManager().prepareToSendUserMediaPermissionRequest();
      controller-&gt;requestUserMediaAccess(*this);
  }
  
<span class="udiff-line-added">+ static inline bool isMediaStreamCorrectlyStarted(const MediaStream&amp; stream)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (stream.getTracks().isEmpty())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return WTF::allOf(stream.getTracks(), [](auto&amp; track) {</span>
<span class="udiff-line-added">+         return !track-&gt;source().captureDidFail();</span>
<span class="udiff-line-added">+     });</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void UserMediaRequest::allow(CaptureDevice&amp;&amp; audioDevice, CaptureDevice&amp;&amp; videoDevice, String&amp;&amp; deviceIdentifierHashSalt, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)
  {
      RELEASE_LOG(MediaStream, &quot;UserMediaRequest::allow %s %s&quot;, audioDevice ? audioDevice.persistentId().utf8().data() : &quot;&quot;, videoDevice ? videoDevice.persistentId().utf8().data() : &quot;&quot;);
<span class="udiff-line-added">+     m_allowCompletionHandler = WTFMove(completionHandler);</span>
<span class="udiff-line-added">+     queueTaskKeepingObjectAlive(*this, TaskSource::UserInteraction, [this, audioDevice = WTFMove(audioDevice), videoDevice = WTFMove(videoDevice), deviceIdentifierHashSalt = WTFMove(deviceIdentifierHashSalt)]() mutable {</span>
<span class="udiff-line-added">+         auto callback = [this, protector = makePendingActivity(*this)](auto privateStreamOrError) mutable {</span>
<span class="udiff-line-added">+             auto scopeExit = makeScopeExit([completionHandler = WTFMove(m_allowCompletionHandler)]() mutable {</span>
<span class="udiff-line-added">+                 completionHandler();</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+             if (isContextStopped())</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (!privateStreamOrError.has_value()) {</span>
<span class="udiff-line-added">+                 RELEASE_LOG(MediaStream, &quot;UserMediaRequest::allow failed to create media stream!&quot;);</span>
<span class="udiff-line-added">+                 scriptExecutionContext()-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Error, privateStreamOrError.error());</span>
<span class="udiff-line-added">+                 deny(MediaAccessDenialReason::HardwareError);</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             auto privateStream = WTFMove(privateStreamOrError).value();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             auto&amp; document = downcast&lt;Document&gt;(*m_scriptExecutionContext);</span>
<span class="udiff-line-added">+             privateStream-&gt;monitorOrientation(document.orientationNotifier());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             auto stream = MediaStream::create(document, WTFMove(privateStream));</span>
<span class="udiff-line-added">+             stream-&gt;startProducingData();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (!isMediaStreamCorrectlyStarted(stream)) {</span>
<span class="udiff-line-added">+                 deny(MediaAccessDenialReason::HardwareError);</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             ASSERT(document.isCapturing());</span>
<span class="udiff-line-added">+             stream-&gt;document()-&gt;setHasCaptureMediaStreamTrack();</span>
<span class="udiff-line-added">+             m_promise-&gt;resolve(WTFMove(stream));</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         auto&amp; document = downcast&lt;Document&gt;(*scriptExecutionContext());</span>
<span class="udiff-line-added">+         document.setDeviceIDHashSalt(deviceIdentifierHashSalt);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         RealtimeMediaSourceCenter::singleton().createMediaStream(document.logger(), WTFMove(callback), WTFMove(deviceIdentifierHashSalt), WTFMove(audioDevice), WTFMove(videoDevice), m_request);</span>
  
<span class="udiff-line-removed">-     auto callback = [this, protector = makePendingActivity(*this), completionHandler = WTFMove(completionHandler)](RefPtr&lt;MediaStreamPrivate&gt;&amp;&amp; privateStream) mutable {</span>
<span class="udiff-line-removed">-         auto scopeExit = makeScopeExit([&amp;] {</span>
<span class="udiff-line-removed">-             completionHandler();</span>
<span class="udiff-line-removed">-         });</span>
          if (!m_scriptExecutionContext)
              return;
  
<span class="udiff-line-removed">-         if (!privateStream) {</span>
<span class="udiff-line-removed">-             RELEASE_LOG(MediaStream, &quot;UserMediaRequest::allow failed to create media stream!&quot;);</span>
<span class="udiff-line-removed">-             deny(MediaAccessDenialReason::HardwareError);</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         privateStream-&gt;monitorOrientation(downcast&lt;Document&gt;(m_scriptExecutionContext)-&gt;orientationNotifier());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         auto stream = MediaStream::create(*downcast&lt;Document&gt;(m_scriptExecutionContext), privateStream.releaseNonNull());</span>
<span class="udiff-line-removed">-         if (stream-&gt;getTracks().isEmpty()) {</span>
<span class="udiff-line-removed">-             deny(MediaAccessDenialReason::HardwareError);</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         scopeExit.release();</span>
<span class="udiff-line-removed">-         m_pendingActivationMediaStream = makeUnique&lt;PendingActivationMediaStream&gt;(WTFMove(protector), *this, WTFMove(stream), WTFMove(completionHandler));</span>
<span class="udiff-line-removed">-     };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto&amp; document = downcast&lt;Document&gt;(*scriptExecutionContext());</span>
<span class="udiff-line-removed">-     document.setDeviceIDHashSalt(deviceIdentifierHashSalt);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     RealtimeMediaSourceCenter::singleton().createMediaStream(document.logger(), WTFMove(callback), WTFMove(deviceIdentifierHashSalt), WTFMove(audioDevice), WTFMove(videoDevice), m_request);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!m_scriptExecutionContext)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
  #if ENABLE(WEB_RTC)
<span class="udiff-line-modified-removed">-     if (auto* page = document.page())</span>
<span class="udiff-line-modified-removed">-         page-&gt;rtcController().disableICECandidateFilteringForDocument(document);</span>
<span class="udiff-line-modified-added">+         if (auto* page = document.page())</span>
<span class="udiff-line-modified-added">+             page-&gt;rtcController().disableICECandidateFilteringForDocument(document);</span>
  #endif
<span class="udiff-line-added">+     });</span>
  }
  
  void UserMediaRequest::deny(MediaAccessDenialReason reason, const String&amp; message)
  {
      if (!m_scriptExecutionContext)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -280,11 +308,11 @@</span>
          RELEASE_LOG(MediaStream, &quot;UserMediaRequest::deny - no capture devices&quot;);
          code = NotFoundError;
          break;
      case MediaAccessDenialReason::InvalidConstraint:
          RELEASE_LOG(MediaStream, &quot;UserMediaRequest::deny - invalid constraint - %s&quot;, message.utf8().data());
<span class="udiff-line-modified-removed">-         m_promise.rejectType&lt;IDLInterface&lt;OverconstrainedError&gt;&gt;(OverconstrainedError::create(message, &quot;Invalid constraint&quot;_s).get());</span>
<span class="udiff-line-modified-added">+         m_promise-&gt;rejectType&lt;IDLInterface&lt;OverconstrainedError&gt;&gt;(OverconstrainedError::create(message, &quot;Invalid constraint&quot;_s).get());</span>
          return;
      case MediaAccessDenialReason::HardwareError:
          RELEASE_LOG(MediaStream, &quot;UserMediaRequest::deny - hardware error&quot;);
          code = NotReadableError;
          break;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -301,86 +329,32 @@</span>
          code = InvalidAccessError;
          break;
      }
  
      if (!message.isEmpty())
<span class="udiff-line-modified-removed">-         m_promise.reject(code, message);</span>
<span class="udiff-line-modified-added">+         m_promise-&gt;reject(code, message);</span>
      else
<span class="udiff-line-modified-removed">-         m_promise.reject(code);</span>
<span class="udiff-line-modified-added">+         m_promise-&gt;reject(code);</span>
  }
  
  void UserMediaRequest::stop()
  {
<span class="udiff-line-removed">-     // Protecting &#39;this&#39; since nulling m_pendingActivationMediaStream might destroy it.</span>
<span class="udiff-line-removed">-     Ref&lt;UserMediaRequest&gt; protectedThis(*this);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     m_pendingActivationMediaStream = nullptr;</span>
<span class="udiff-line-removed">- </span>
      auto&amp; document = downcast&lt;Document&gt;(*m_scriptExecutionContext);
      if (auto* controller = UserMediaController::from(document.page()))
          controller-&gt;cancelUserMediaAccessRequest(*this);
  }
  
  const char* UserMediaRequest::activeDOMObjectName() const
  {
      return &quot;UserMediaRequest&quot;;
  }
  
<span class="udiff-line-removed">- bool UserMediaRequest::canSuspendForDocumentSuspension() const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     return !hasPendingActivity();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  Document* UserMediaRequest::document() const
  {
      return downcast&lt;Document&gt;(m_scriptExecutionContext);
  }
  
<span class="udiff-line-removed">- UserMediaRequest::PendingActivationMediaStream::PendingActivationMediaStream(Ref&lt;PendingActivity&lt;UserMediaRequest&gt;&gt;&amp;&amp; protectingUserMediaRequest, UserMediaRequest&amp; userMediaRequest, Ref&lt;MediaStream&gt;&amp;&amp; stream, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)</span>
<span class="udiff-line-removed">-     : m_protectingUserMediaRequest(WTFMove(protectingUserMediaRequest))</span>
<span class="udiff-line-removed">-     , m_userMediaRequest(userMediaRequest)</span>
<span class="udiff-line-removed">-     , m_mediaStream(WTFMove(stream))</span>
<span class="udiff-line-removed">-     , m_completionHandler(WTFMove(completionHandler))</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     m_mediaStream-&gt;privateStream().addObserver(*this);</span>
<span class="udiff-line-removed">-     m_mediaStream-&gt;startProducingData();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- UserMediaRequest::PendingActivationMediaStream::~PendingActivationMediaStream()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     m_mediaStream-&gt;privateStream().removeObserver(*this);</span>
<span class="udiff-line-removed">-     m_completionHandler();</span>
<span class="udiff-line-removed">-     if (auto* document = m_mediaStream-&gt;document())</span>
<span class="udiff-line-removed">-         document-&gt;updateIsPlayingMedia();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void UserMediaRequest::PendingActivationMediaStream::characteristicsChanged()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     if (!m_userMediaRequest.m_pendingActivationMediaStream)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     for (auto&amp; track : m_mediaStream-&gt;privateStream().tracks()) {</span>
<span class="udiff-line-removed">-         if (track-&gt;source().captureDidFail()) {</span>
<span class="udiff-line-removed">-             m_userMediaRequest.mediaStreamDidFail(track-&gt;source().type());</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_mediaStream-&gt;privateStream().hasVideo() || m_mediaStream-&gt;privateStream().hasAudio()) {</span>
<span class="udiff-line-removed">-         m_userMediaRequest.mediaStreamIsReady(WTFMove(m_mediaStream));</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void UserMediaRequest::mediaStreamIsReady(Ref&lt;MediaStream&gt;&amp;&amp; stream)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     RELEASE_LOG(MediaStream, &quot;UserMediaRequest::mediaStreamIsReady&quot;);</span>
<span class="udiff-line-removed">-     stream-&gt;document()-&gt;setHasCaptureMediaStreamTrack();</span>
<span class="udiff-line-removed">-     m_promise.resolve(WTFMove(stream));</span>
<span class="udiff-line-removed">-     m_pendingActivationMediaStream = nullptr;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  void UserMediaRequest::mediaStreamDidFail(RealtimeMediaSource::Type type)
  {
      RELEASE_LOG(MediaStream, &quot;UserMediaRequest::mediaStreamDidFail&quot;);
      const char* typeDescription = &quot;&quot;;
      switch (type) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -392,12 +366,11 @@</span>
          break;
      case RealtimeMediaSource::Type::None:
          typeDescription = &quot;unknown&quot;;
          break;
      }
<span class="udiff-line-modified-removed">-     m_promise.reject(NotReadableError, makeString(&quot;Failed starting capture of a &quot;_s, typeDescription, &quot; track&quot;_s));</span>
<span class="udiff-line-removed">-     m_pendingActivationMediaStream = nullptr;</span>
<span class="udiff-line-modified-added">+     m_promise-&gt;reject(NotReadableError, makeString(&quot;Failed starting capture of a &quot;_s, typeDescription, &quot; track&quot;_s));</span>
  }
  
  } // namespace WebCore
  
  #endif // ENABLE(MEDIA_STREAM)
</pre>
<center><a href="UserMediaController.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="UserMediaRequest.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>