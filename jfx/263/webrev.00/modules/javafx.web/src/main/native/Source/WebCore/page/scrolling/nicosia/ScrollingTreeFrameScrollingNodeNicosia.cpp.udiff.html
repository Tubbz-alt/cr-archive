<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/page/scrolling/nicosia/ScrollingTreeFrameScrollingNodeNicosia.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ScrollingTreeFixedNode.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollingTreeFrameScrollingNodeNicosia.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/scrolling/nicosia/ScrollingTreeFrameScrollingNodeNicosia.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,8 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (C) 2018 Igalia S.L.</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 2012, 2014-2015 Apple Inc. All rights reserved.</span>
<span class="udiff-line-added">+  * Copyright (C) 2019 Igalia S.L.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,10 +29,16 @@</span>
  #include &quot;config.h&quot;
  #include &quot;ScrollingTreeFrameScrollingNodeNicosia.h&quot;
  
  #if ENABLE(ASYNC_SCROLLING) &amp;&amp; USE(NICOSIA)
  
<span class="udiff-line-added">+ #include &quot;FrameView.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;Logging.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;NicosiaPlatformLayer.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;ScrollingStateFrameScrollingNode.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;ScrollingTree.h&quot;</span>
<span class="udiff-line-added">+ </span>
  namespace WebCore {
  
  Ref&lt;ScrollingTreeFrameScrollingNode&gt; ScrollingTreeFrameScrollingNodeNicosia::create(ScrollingTree&amp; scrollingTree, ScrollingNodeType nodeType, ScrollingNodeID nodeID)
  {
      return adoptRef(*new ScrollingTreeFrameScrollingNodeNicosia(scrollingTree, nodeType, nodeID));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -42,17 +49,153 @@</span>
  {
  }
  
  ScrollingTreeFrameScrollingNodeNicosia::~ScrollingTreeFrameScrollingNodeNicosia() = default;
  
<span class="udiff-line-modified-removed">- ScrollingEventResult ScrollingTreeFrameScrollingNodeNicosia::handleWheelEvent(const PlatformWheelEvent&amp;)</span>
<span class="udiff-line-modified-added">+ void ScrollingTreeFrameScrollingNodeNicosia::commitStateBeforeChildren(const ScrollingStateNode&amp; stateNode)</span>
  {
<span class="udiff-line-modified-removed">-     return ScrollingEventResult::DidNotHandleEvent;</span>
<span class="udiff-line-modified-added">+     ScrollingTreeFrameScrollingNode::commitStateBeforeChildren(stateNode);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     const auto&amp; scrollingStateNode = downcast&lt;ScrollingStateFrameScrollingNode&gt;(stateNode);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (scrollingStateNode.hasChangedProperty(ScrollingStateFrameScrollingNode::RootContentsLayer)) {</span>
<span class="udiff-line-added">+         auto* layer = static_cast&lt;Nicosia::PlatformLayer*&gt;(scrollingStateNode.rootContentsLayer());</span>
<span class="udiff-line-added">+         m_rootContentsLayer = downcast&lt;Nicosia::CompositionLayer&gt;(layer);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     if (scrollingStateNode.hasChangedProperty(ScrollingStateFrameScrollingNode::CounterScrollingLayer)) {</span>
<span class="udiff-line-added">+         auto* layer = static_cast&lt;Nicosia::PlatformLayer*&gt;(scrollingStateNode.counterScrollingLayer());</span>
<span class="udiff-line-added">+         m_counterScrollingLayer = downcast&lt;Nicosia::CompositionLayer&gt;(layer);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     if (scrollingStateNode.hasChangedProperty(ScrollingStateFrameScrollingNode::InsetClipLayer)) {</span>
<span class="udiff-line-added">+         auto* layer = static_cast&lt;Nicosia::PlatformLayer*&gt;(scrollingStateNode.insetClipLayer());</span>
<span class="udiff-line-added">+         m_insetClipLayer = downcast&lt;Nicosia::CompositionLayer&gt;(layer);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     if (scrollingStateNode.hasChangedProperty(ScrollingStateFrameScrollingNode::ContentShadowLayer)) {</span>
<span class="udiff-line-added">+         auto* layer = static_cast&lt;Nicosia::PlatformLayer*&gt;(scrollingStateNode.contentShadowLayer());</span>
<span class="udiff-line-added">+         m_contentShadowLayer = downcast&lt;Nicosia::CompositionLayer&gt;(layer);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     if (scrollingStateNode.hasChangedProperty(ScrollingStateFrameScrollingNode::HeaderLayer)) {</span>
<span class="udiff-line-added">+         auto* layer = static_cast&lt;Nicosia::PlatformLayer*&gt;(scrollingStateNode.headerLayer());</span>
<span class="udiff-line-added">+         m_headerLayer = downcast&lt;Nicosia::CompositionLayer&gt;(layer);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     if (scrollingStateNode.hasChangedProperty(ScrollingStateFrameScrollingNode::FooterLayer)) {</span>
<span class="udiff-line-added">+         auto* layer = static_cast&lt;Nicosia::PlatformLayer*&gt;(scrollingStateNode.footerLayer());</span>
<span class="udiff-line-added">+         m_footerLayer = downcast&lt;Nicosia::CompositionLayer&gt;(layer);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ScrollingTreeFrameScrollingNodeNicosia::commitStateAfterChildren(const ScrollingStateNode&amp; stateNode)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ScrollingTreeFrameScrollingNode::commitStateAfterChildren(stateNode);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     const auto&amp; scrollingStateNode = downcast&lt;ScrollingStateScrollingNode&gt;(stateNode);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Update the scroll position after child nodes have been updated, because they need to have updated their constraints before any scrolling happens.</span>
<span class="udiff-line-added">+     if (scrollingStateNode.hasChangedProperty(ScrollingStateScrollingNode::RequestedScrollPosition)) {</span>
<span class="udiff-line-added">+         const auto&amp; requestedScrollData = scrollingStateNode.requestedScrollData();</span>
<span class="udiff-line-added">+         scrollTo(requestedScrollData.scrollPosition, requestedScrollData.scrollType, requestedScrollData.clamping);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ScrollingEventResult ScrollingTreeFrameScrollingNodeNicosia::handleWheelEvent(const PlatformWheelEvent&amp; wheelEvent)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!canHaveScrollbars())</span>
<span class="udiff-line-added">+         return ScrollingEventResult::DidNotHandleEvent;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (wheelEvent.deltaX() || wheelEvent.deltaY()) {</span>
<span class="udiff-line-added">+         auto* scrollLayer = static_cast&lt;Nicosia::PlatformLayer*&gt;(scrolledContentsLayer());</span>
<span class="udiff-line-added">+         ASSERT(scrollLayer);</span>
<span class="udiff-line-added">+         auto&amp; compositionLayer = downcast&lt;Nicosia::CompositionLayer&gt;(*scrollLayer);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         auto updateScope = compositionLayer.createUpdateScope();</span>
<span class="udiff-line-added">+         scrollBy({ -wheelEvent.deltaX(), -wheelEvent.deltaY() });</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     scrollingTree().setOrClearLatchedNode(wheelEvent, scrollingNodeID());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // FIXME: This needs to return whether the event was handled.</span>
<span class="udiff-line-added">+     return ScrollingEventResult::DidHandleEvent;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ FloatPoint ScrollingTreeFrameScrollingNodeNicosia::adjustedScrollPosition(const FloatPoint&amp; position, ScrollClamping clamping) const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     FloatPoint scrollPosition(roundf(position.x()), roundf(position.y()));</span>
<span class="udiff-line-added">+     return ScrollingTreeFrameScrollingNode::adjustedScrollPosition(scrollPosition, clamping);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ScrollingTreeFrameScrollingNodeNicosia::currentScrollPositionChanged()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     LOG_WITH_STREAM(Scrolling, stream &lt;&lt; &quot;ScrollingTreeFrameScrollingNodeNicosia::currentScrollPositionChanged to &quot; &lt;&lt; currentScrollPosition() &lt;&lt; &quot; min: &quot; &lt;&lt; minimumScrollPosition() &lt;&lt; &quot; max: &quot; &lt;&lt; maximumScrollPosition() &lt;&lt; &quot; sync: &quot; &lt;&lt; shouldUpdateScrollLayerPositionSynchronously());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (shouldUpdateScrollLayerPositionSynchronously())</span>
<span class="udiff-line-added">+         scrollingTree().scrollingTreeNodeDidScroll(*this, ScrollingLayerPositionAction::Set);</span>
<span class="udiff-line-added">+     else</span>
<span class="udiff-line-added">+         ScrollingTreeFrameScrollingNode::currentScrollPositionChanged();</span>
  }
  
  void ScrollingTreeFrameScrollingNodeNicosia::repositionScrollingLayers()
  {
<span class="udiff-line-added">+     auto* scrollLayer = static_cast&lt;Nicosia::PlatformLayer*&gt;(scrolledContentsLayer());</span>
<span class="udiff-line-added">+     ASSERT(scrollLayer);</span>
<span class="udiff-line-added">+     auto&amp; compositionLayer = downcast&lt;Nicosia::CompositionLayer&gt;(*scrollLayer);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto scrollPosition = currentScrollPosition();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     compositionLayer.updateState(</span>
<span class="udiff-line-added">+         [&amp;scrollPosition](Nicosia::CompositionLayer::LayerState&amp; state)</span>
<span class="udiff-line-added">+         {</span>
<span class="udiff-line-added">+             state.position = -scrollPosition;</span>
<span class="udiff-line-added">+             state.delta.positionChanged = true;</span>
<span class="udiff-line-added">+         });</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ScrollingTreeFrameScrollingNodeNicosia::repositionRelatedLayers()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto scrollPosition = currentScrollPosition();</span>
<span class="udiff-line-added">+     auto layoutViewport = this-&gt;layoutViewport();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     FloatRect visibleContentRect(scrollPosition, scrollableAreaSize());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto applyLayerPosition =</span>
<span class="udiff-line-added">+         [](auto&amp; layer, auto&amp;&amp; position)</span>
<span class="udiff-line-added">+         {</span>
<span class="udiff-line-added">+             layer.updateState(</span>
<span class="udiff-line-added">+                 [&amp;position](Nicosia::CompositionLayer::LayerState&amp; state)</span>
<span class="udiff-line-added">+                 {</span>
<span class="udiff-line-added">+                     state.position = position;</span>
<span class="udiff-line-added">+                     state.delta.positionChanged = true;</span>
<span class="udiff-line-added">+                 });</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (m_counterScrollingLayer)</span>
<span class="udiff-line-added">+         applyLayerPosition(*m_counterScrollingLayer, layoutViewport.location());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     float topContentInset = this-&gt;topContentInset();</span>
<span class="udiff-line-added">+     if (m_insetClipLayer &amp;&amp; m_rootContentsLayer) {</span>
<span class="udiff-line-added">+         m_insetClipLayer-&gt;updateState(</span>
<span class="udiff-line-added">+             [&amp;scrollPosition, &amp;topContentInset](Nicosia::CompositionLayer::LayerState&amp; state)</span>
<span class="udiff-line-added">+             {</span>
<span class="udiff-line-added">+                 state.position = { state.position.x(), FrameView::yPositionForInsetClipLayer(scrollPosition, topContentInset) };</span>
<span class="udiff-line-added">+                 state.delta.positionChanged = true;</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         auto rootContentsPosition = FrameView::positionForRootContentLayer(scrollPosition, scrollOrigin(), topContentInset, headerHeight());</span>
<span class="udiff-line-added">+         applyLayerPosition(*m_rootContentsLayer, rootContentsPosition);</span>
<span class="udiff-line-added">+         if (m_contentShadowLayer)</span>
<span class="udiff-line-added">+             applyLayerPosition(*m_contentShadowLayer, rootContentsPosition);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (m_headerLayer || m_footerLayer) {</span>
<span class="udiff-line-added">+         // Generally the banners should have the same horizontal-position computation as a fixed element. However,</span>
<span class="udiff-line-added">+         // the banners are not affected by the frameScaleFactor(), so if there is currently a non-1 frameScaleFactor()</span>
<span class="udiff-line-added">+         // then we should recompute layoutViewport.x() for the banner with a scale factor of 1.</span>
<span class="udiff-line-added">+         float horizontalScrollOffsetForBanner = layoutViewport.x();</span>
<span class="udiff-line-added">+         if (m_headerLayer)</span>
<span class="udiff-line-added">+             applyLayerPosition(*m_headerLayer, FloatPoint(horizontalScrollOffsetForBanner, FrameView::yPositionForHeaderLayer(scrollPosition, topContentInset)));</span>
<span class="udiff-line-added">+         if (m_footerLayer)</span>
<span class="udiff-line-added">+             applyLayerPosition(*m_footerLayer, FloatPoint(horizontalScrollOffsetForBanner, FrameView::yPositionForFooterLayer(scrollPosition, topContentInset, totalContentsSize().height(), footerHeight())));</span>
<span class="udiff-line-added">+     }</span>
  }
  
  } // namespace WebCore
  
  #endif // ENABLE(ASYNC_SCROLLING) &amp;&amp; USE(NICOSIA)
</pre>
<center><a href="ScrollingTreeFixedNode.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollingTreeFrameScrollingNodeNicosia.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>