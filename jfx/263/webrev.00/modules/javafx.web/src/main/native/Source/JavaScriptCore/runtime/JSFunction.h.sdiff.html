<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSFunction.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSFunction.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSFunctionInlines.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSFunction.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 32 
 33 class ExecutableBase;
 34 class FunctionExecutable;
 35 class FunctionPrototype;
 36 class JSLexicalEnvironment;
 37 class JSGlobalObject;
 38 class LLIntOffsetsExtractor;
 39 class NativeExecutable;
 40 class SourceCode;
 41 class InternalFunction;
 42 namespace DFG {
 43 class SpeculativeJIT;
 44 class JITCompiler;
 45 }
 46 
 47 namespace DOMJIT {
 48 class Signature;
 49 }
 50 
 51 
<span class="line-modified"> 52 JS_EXPORT_PRIVATE EncodedJSValue JSC_HOST_CALL callHostFunctionAsConstructor(ExecState*);</span>
 53 
 54 JS_EXPORT_PRIVATE String getCalculatedDisplayName(VM&amp;, JSObject*);
 55 
 56 class JSFunction : public JSCallee {
 57     friend class JIT;
 58     friend class DFG::SpeculativeJIT;
 59     friend class DFG::JITCompiler;
 60     friend class VM;
 61     friend class InternalFunction;
 62 
 63 public:

 64 
 65     template&lt;typename CellType, SubspaceAccess&gt;
 66     static IsoSubspace* subspaceFor(VM&amp; vm)
 67     {
 68         return &amp;vm.functionSpace;
 69     }
 70 
 71     typedef JSCallee Base;
<span class="line-modified"> 72     const static unsigned StructureFlags = Base::StructureFlags | OverridesGetOwnPropertySlot | OverridesGetPropertyNames | OverridesGetCallData;</span>
 73 
 74     static size_t allocationSize(Checked&lt;size_t&gt; inlineCapacity)
 75     {
 76         ASSERT_UNUSED(inlineCapacity, !inlineCapacity);
 77         return sizeof(JSFunction);
 78     }
 79 
 80     static Structure* selectStructureForNewFuncExp(JSGlobalObject*, FunctionExecutable*);
 81 
 82     JS_EXPORT_PRIVATE static JSFunction* create(VM&amp;, JSGlobalObject*, int length, const String&amp; name, NativeFunction, Intrinsic = NoIntrinsic, NativeFunction nativeConstructor = callHostFunctionAsConstructor, const DOMJIT::Signature* = nullptr);
 83     JS_EXPORT_PRIVATE static JSFunction* createFunctionThatMasqueradesAsUndefined(VM&amp;, JSGlobalObject*, int length, const String&amp; name, NativeFunction, Intrinsic = NoIntrinsic, NativeFunction nativeConstructor = callHostFunctionAsConstructor, const DOMJIT::Signature* = nullptr);
 84 
 85     static JSFunction* createWithInvalidatedReallocationWatchpoint(VM&amp;, FunctionExecutable*, JSScope*);
 86 
 87     JS_EXPORT_PRIVATE static JSFunction* create(VM&amp;, FunctionExecutable*, JSScope*);
 88     static JSFunction* create(VM&amp;, FunctionExecutable*, JSScope*, Structure*);
 89 
 90     JS_EXPORT_PRIVATE String name(VM&amp;);
 91     JS_EXPORT_PRIVATE String displayName(VM&amp;);
 92     JS_EXPORT_PRIVATE const String calculatedDisplayName(VM&amp;);
 93 
<span class="line-modified"> 94     ExecutableBase* executable() const { return m_executable.get(); }</span>






 95 
 96     // To call any of these methods include JSFunctionInlines.h
 97     bool isHostFunction() const;
 98     FunctionExecutable* jsExecutable() const;
 99     Intrinsic intrinsic() const;
100 
101     JS_EXPORT_PRIVATE const SourceCode* sourceCode() const;
102 
103     DECLARE_EXPORT_INFO;
104 
105     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
106     {
107         ASSERT(globalObject);
108         return Structure::create(vm, globalObject, prototype, TypeInfo(JSFunctionType, StructureFlags), info());
109     }
110 
111     TaggedNativeFunction nativeFunction();
112     TaggedNativeFunction nativeConstructor();
113 
<span class="line-modified">114     static ConstructType getConstructData(JSCell*, ConstructData&amp;);</span>
<span class="line-modified">115     static CallType getCallData(JSCell*, CallData&amp;);</span>
<span class="line-removed">116 </span>
<span class="line-removed">117     static inline ptrdiff_t offsetOfExecutable()</span>
<span class="line-removed">118     {</span>
<span class="line-removed">119         return OBJECT_OFFSETOF(JSFunction, m_executable);</span>
<span class="line-removed">120     }</span>
121 
<span class="line-modified">122     static inline ptrdiff_t offsetOfRareData()</span>
123     {
<span class="line-modified">124         return OBJECT_OFFSETOF(JSFunction, m_rareData);</span>
125     }
126 
<span class="line-modified">127     FunctionRareData* rareData(VM&amp; vm)</span>
128     {
<span class="line-modified">129         if (UNLIKELY(!m_rareData))</span>

130             return allocateRareData(vm);
<span class="line-modified">131         return m_rareData.get();</span>
132     }
133 
<span class="line-modified">134     FunctionRareData* ensureRareDataAndAllocationProfile(ExecState*, unsigned inlineCapacity);</span>
135 
<span class="line-modified">136     FunctionRareData* rareData()</span>
137     {
<span class="line-modified">138         FunctionRareData* rareData = m_rareData.get();</span>
<span class="line-modified">139 </span>
<span class="line-modified">140         // The JS thread may be concurrently creating the rare data</span>
<span class="line-modified">141         // If we see it, we want to ensure it has been properly created</span>
<span class="line-removed">142         WTF::loadLoadFence();</span>
<span class="line-removed">143 </span>
<span class="line-removed">144         return rareData;</span>
145     }
146 
147     bool isHostOrBuiltinFunction() const;
148     bool isBuiltinFunction() const;
<span class="line-removed">149     bool isAnonymousBuiltinFunction() const;</span>
150     JS_EXPORT_PRIVATE bool isHostFunctionNonInline() const;
151     bool isClassConstructorFunction() const;
152 
<span class="line-modified">153     void setFunctionName(ExecState*, JSValue name);</span>
154 
155     // Returns the __proto__ for the |this| value if this JSFunction were to be constructed.
<span class="line-modified">156     JSObject* prototypeForConstruction(VM&amp;, ExecState*);</span>
157 
158     bool canUseAllocationProfile();
159     bool canUseAllocationProfileNonInline();
160 
161     enum class PropertyStatus {
162         Eager,
163         Lazy,
164         Reified,
165     };
<span class="line-modified">166     PropertyStatus reifyLazyPropertyIfNeeded(VM&amp;, ExecState*, PropertyName);</span>


167 
168 protected:
<span class="line-modified">169     JS_EXPORT_PRIVATE JSFunction(VM&amp;, JSGlobalObject*, Structure*);</span>
170     JSFunction(VM&amp;, FunctionExecutable*, JSScope*, Structure*);
171 
172     void finishCreation(VM&amp;, NativeExecutable*, int length, const String&amp; name);
173     void finishCreation(VM&amp;);
174 
<span class="line-modified">175     static bool getOwnPropertySlot(JSObject*, ExecState*, PropertyName, PropertySlot&amp;);</span>
<span class="line-modified">176     static void getOwnNonIndexPropertyNames(JSObject*, ExecState*, PropertyNameArray&amp;, EnumerationMode = EnumerationMode());</span>
<span class="line-modified">177     static bool defineOwnProperty(JSObject*, ExecState*, PropertyName, const PropertyDescriptor&amp;, bool shouldThrow);</span>
178 
<span class="line-modified">179     static bool put(JSCell*, ExecState*, PropertyName, JSValue, PutPropertySlot&amp;);</span>
180 
<span class="line-modified">181     static bool deleteProperty(JSCell*, ExecState*, PropertyName);</span>
182 
183     static void visitChildren(JSCell*, SlotVisitor&amp;);
184 
185 private:
186     static JSFunction* createImpl(VM&amp; vm, FunctionExecutable* executable, JSScope* scope, Structure* structure)
187     {
188         JSFunction* function = new (NotNull, allocateCell&lt;JSFunction&gt;(vm.heap)) JSFunction(vm, executable, scope, structure);
189         ASSERT(function-&gt;structure(vm)-&gt;globalObject());
190         function-&gt;finishCreation(vm);
191         return function;
192     }
193 
194     FunctionRareData* allocateRareData(VM&amp;);
<span class="line-modified">195     FunctionRareData* allocateAndInitializeRareData(ExecState*, size_t inlineCapacity);</span>
<span class="line-modified">196     FunctionRareData* initializeRareData(ExecState*, size_t inlineCapacity);</span>
197 
198     bool hasReifiedLength() const;
199     bool hasReifiedName() const;
200     void reifyLength(VM&amp;);
<span class="line-modified">201     void reifyName(VM&amp;, ExecState*);</span>
<span class="line-modified">202     void reifyName(VM&amp;, ExecState*, String name);</span>
203 
204     static bool isLazy(PropertyStatus property) { return property == PropertyStatus::Lazy || property == PropertyStatus::Reified; }
205     static bool isReified(PropertyStatus property) { return property == PropertyStatus::Reified; }
206 
<span class="line-modified">207     PropertyStatus reifyLazyPropertyForHostOrBuiltinIfNeeded(VM&amp;, ExecState*, PropertyName);</span>
<span class="line-modified">208     PropertyStatus reifyLazyLengthIfNeeded(VM&amp;, ExecState*, PropertyName);</span>
<span class="line-modified">209     PropertyStatus reifyLazyNameIfNeeded(VM&amp;, ExecState*, PropertyName);</span>
<span class="line-modified">210     PropertyStatus reifyLazyBoundNameIfNeeded(VM&amp;, ExecState*, PropertyName);</span>
211 
<span class="line-modified">212 #if ASSERT_DISABLED</span>
<span class="line-removed">213     void assertTypeInfoFlagInvariants() { }</span>
<span class="line-removed">214 #else</span>
215     void assertTypeInfoFlagInvariants();


216 #endif
217 
218     friend class LLIntOffsetsExtractor;
219 
<span class="line-modified">220     static EncodedJSValue argumentsGetter(ExecState*, EncodedJSValue, PropertyName);</span>
<span class="line-modified">221     static EncodedJSValue callerGetter(ExecState*, EncodedJSValue, PropertyName);</span>
<span class="line-removed">222     static EncodedJSValue lengthGetter(ExecState*, EncodedJSValue, PropertyName);</span>
<span class="line-removed">223     static EncodedJSValue nameGetter(ExecState*, EncodedJSValue, PropertyName);</span>
224 
<span class="line-modified">225     WriteBarrier&lt;ExecutableBase&gt; m_executable;</span>
<span class="line-removed">226     WriteBarrier&lt;FunctionRareData&gt; m_rareData;</span>
227 };
228 
229 class JSStrictFunction final : public JSFunction {
230 public:
231     using Base = JSFunction;
232 
233     DECLARE_EXPORT_INFO;
234 
235     static constexpr unsigned StructureFlags = Base::StructureFlags;
236 
237     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
238     {
239         ASSERT(globalObject);
240         return Structure::create(vm, globalObject, prototype, TypeInfo(JSFunctionType, StructureFlags), info());
241     }
242 };
243 static_assert(sizeof(JSStrictFunction) == sizeof(JSFunction), &quot;Allocated in JSFunction IsoSubspace&quot;);
244 
245 class JSSloppyFunction final : public JSFunction {
246 public:
</pre>
</td>
<td>
<hr />
<pre>
 32 
 33 class ExecutableBase;
 34 class FunctionExecutable;
 35 class FunctionPrototype;
 36 class JSLexicalEnvironment;
 37 class JSGlobalObject;
 38 class LLIntOffsetsExtractor;
 39 class NativeExecutable;
 40 class SourceCode;
 41 class InternalFunction;
 42 namespace DFG {
 43 class SpeculativeJIT;
 44 class JITCompiler;
 45 }
 46 
 47 namespace DOMJIT {
 48 class Signature;
 49 }
 50 
 51 
<span class="line-modified"> 52 JS_EXPORT_PRIVATE EncodedJSValue JSC_HOST_CALL callHostFunctionAsConstructor(JSGlobalObject*, CallFrame*);</span>
 53 
 54 JS_EXPORT_PRIVATE String getCalculatedDisplayName(VM&amp;, JSObject*);
 55 
 56 class JSFunction : public JSCallee {
 57     friend class JIT;
 58     friend class DFG::SpeculativeJIT;
 59     friend class DFG::JITCompiler;
 60     friend class VM;
 61     friend class InternalFunction;
 62 
 63 public:
<span class="line-added"> 64     static constexpr uintptr_t rareDataTag = 0x1;</span>
 65 
 66     template&lt;typename CellType, SubspaceAccess&gt;
 67     static IsoSubspace* subspaceFor(VM&amp; vm)
 68     {
 69         return &amp;vm.functionSpace;
 70     }
 71 
 72     typedef JSCallee Base;
<span class="line-modified"> 73     static constexpr unsigned StructureFlags = Base::StructureFlags | OverridesGetOwnPropertySlot | OverridesGetPropertyNames | OverridesGetCallData;</span>
 74 
 75     static size_t allocationSize(Checked&lt;size_t&gt; inlineCapacity)
 76     {
 77         ASSERT_UNUSED(inlineCapacity, !inlineCapacity);
 78         return sizeof(JSFunction);
 79     }
 80 
 81     static Structure* selectStructureForNewFuncExp(JSGlobalObject*, FunctionExecutable*);
 82 
 83     JS_EXPORT_PRIVATE static JSFunction* create(VM&amp;, JSGlobalObject*, int length, const String&amp; name, NativeFunction, Intrinsic = NoIntrinsic, NativeFunction nativeConstructor = callHostFunctionAsConstructor, const DOMJIT::Signature* = nullptr);
 84     JS_EXPORT_PRIVATE static JSFunction* createFunctionThatMasqueradesAsUndefined(VM&amp;, JSGlobalObject*, int length, const String&amp; name, NativeFunction, Intrinsic = NoIntrinsic, NativeFunction nativeConstructor = callHostFunctionAsConstructor, const DOMJIT::Signature* = nullptr);
 85 
 86     static JSFunction* createWithInvalidatedReallocationWatchpoint(VM&amp;, FunctionExecutable*, JSScope*);
 87 
 88     JS_EXPORT_PRIVATE static JSFunction* create(VM&amp;, FunctionExecutable*, JSScope*);
 89     static JSFunction* create(VM&amp;, FunctionExecutable*, JSScope*, Structure*);
 90 
 91     JS_EXPORT_PRIVATE String name(VM&amp;);
 92     JS_EXPORT_PRIVATE String displayName(VM&amp;);
 93     JS_EXPORT_PRIVATE const String calculatedDisplayName(VM&amp;);
 94 
<span class="line-modified"> 95     ExecutableBase* executable() const</span>
<span class="line-added"> 96     {</span>
<span class="line-added"> 97         uintptr_t executableOrRareData = m_executableOrRareData;</span>
<span class="line-added"> 98         if (executableOrRareData &amp; rareDataTag)</span>
<span class="line-added"> 99             return bitwise_cast&lt;FunctionRareData*&gt;(executableOrRareData &amp; ~rareDataTag)-&gt;executable();</span>
<span class="line-added">100         return bitwise_cast&lt;ExecutableBase*&gt;(executableOrRareData);</span>
<span class="line-added">101     }</span>
102 
103     // To call any of these methods include JSFunctionInlines.h
104     bool isHostFunction() const;
105     FunctionExecutable* jsExecutable() const;
106     Intrinsic intrinsic() const;
107 
108     JS_EXPORT_PRIVATE const SourceCode* sourceCode() const;
109 
110     DECLARE_EXPORT_INFO;
111 
112     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
113     {
114         ASSERT(globalObject);
115         return Structure::create(vm, globalObject, prototype, TypeInfo(JSFunctionType, StructureFlags), info());
116     }
117 
118     TaggedNativeFunction nativeFunction();
119     TaggedNativeFunction nativeConstructor();
120 
<span class="line-modified">121     JS_EXPORT_PRIVATE static ConstructType getConstructData(JSCell*, ConstructData&amp;);</span>
<span class="line-modified">122     JS_EXPORT_PRIVATE static CallType getCallData(JSCell*, CallData&amp;);</span>





123 
<span class="line-modified">124     static inline ptrdiff_t offsetOfExecutableOrRareData()</span>
125     {
<span class="line-modified">126         return OBJECT_OFFSETOF(JSFunction, m_executableOrRareData);</span>
127     }
128 
<span class="line-modified">129     FunctionRareData* ensureRareData(VM&amp; vm)</span>
130     {
<span class="line-modified">131         uintptr_t executableOrRareData = m_executableOrRareData;</span>
<span class="line-added">132         if (UNLIKELY(!(executableOrRareData &amp; rareDataTag)))</span>
133             return allocateRareData(vm);
<span class="line-modified">134         return bitwise_cast&lt;FunctionRareData*&gt;(executableOrRareData &amp; ~rareDataTag);</span>
135     }
136 
<span class="line-modified">137     FunctionRareData* ensureRareDataAndAllocationProfile(JSGlobalObject*, unsigned inlineCapacity);</span>
138 
<span class="line-modified">139     FunctionRareData* rareData() const</span>
140     {
<span class="line-modified">141         uintptr_t executableOrRareData = m_executableOrRareData;</span>
<span class="line-modified">142         if (executableOrRareData &amp; rareDataTag)</span>
<span class="line-modified">143             return bitwise_cast&lt;FunctionRareData*&gt;(executableOrRareData &amp; ~rareDataTag);</span>
<span class="line-modified">144         return nullptr;</span>



145     }
146 
147     bool isHostOrBuiltinFunction() const;
148     bool isBuiltinFunction() const;

149     JS_EXPORT_PRIVATE bool isHostFunctionNonInline() const;
150     bool isClassConstructorFunction() const;
151 
<span class="line-modified">152     void setFunctionName(JSGlobalObject*, JSValue name);</span>
153 
154     // Returns the __proto__ for the |this| value if this JSFunction were to be constructed.
<span class="line-modified">155     JSObject* prototypeForConstruction(VM&amp;, JSGlobalObject*);</span>
156 
157     bool canUseAllocationProfile();
158     bool canUseAllocationProfileNonInline();
159 
160     enum class PropertyStatus {
161         Eager,
162         Lazy,
163         Reified,
164     };
<span class="line-modified">165     PropertyStatus reifyLazyPropertyIfNeeded(VM&amp;, JSGlobalObject*, PropertyName);</span>
<span class="line-added">166 </span>
<span class="line-added">167     bool areNameAndLengthOriginal(VM&amp;);</span>
168 
169 protected:
<span class="line-modified">170     JS_EXPORT_PRIVATE JSFunction(VM&amp;, NativeExecutable*, JSGlobalObject*, Structure*);</span>
171     JSFunction(VM&amp;, FunctionExecutable*, JSScope*, Structure*);
172 
173     void finishCreation(VM&amp;, NativeExecutable*, int length, const String&amp; name);
174     void finishCreation(VM&amp;);
175 
<span class="line-modified">176     static bool getOwnPropertySlot(JSObject*, JSGlobalObject*, PropertyName, PropertySlot&amp;);</span>
<span class="line-modified">177     static void getOwnNonIndexPropertyNames(JSObject*, JSGlobalObject*, PropertyNameArray&amp;, EnumerationMode = EnumerationMode());</span>
<span class="line-modified">178     static bool defineOwnProperty(JSObject*, JSGlobalObject*, PropertyName, const PropertyDescriptor&amp;, bool shouldThrow);</span>
179 
<span class="line-modified">180     static bool put(JSCell*, JSGlobalObject*, PropertyName, JSValue, PutPropertySlot&amp;);</span>
181 
<span class="line-modified">182     static bool deleteProperty(JSCell*, JSGlobalObject*, PropertyName);</span>
183 
184     static void visitChildren(JSCell*, SlotVisitor&amp;);
185 
186 private:
187     static JSFunction* createImpl(VM&amp; vm, FunctionExecutable* executable, JSScope* scope, Structure* structure)
188     {
189         JSFunction* function = new (NotNull, allocateCell&lt;JSFunction&gt;(vm.heap)) JSFunction(vm, executable, scope, structure);
190         ASSERT(function-&gt;structure(vm)-&gt;globalObject());
191         function-&gt;finishCreation(vm);
192         return function;
193     }
194 
195     FunctionRareData* allocateRareData(VM&amp;);
<span class="line-modified">196     FunctionRareData* allocateAndInitializeRareData(JSGlobalObject*, size_t inlineCapacity);</span>
<span class="line-modified">197     FunctionRareData* initializeRareData(JSGlobalObject*, size_t inlineCapacity);</span>
198 
199     bool hasReifiedLength() const;
200     bool hasReifiedName() const;
201     void reifyLength(VM&amp;);
<span class="line-modified">202     void reifyName(VM&amp;, JSGlobalObject*);</span>
<span class="line-modified">203     void reifyName(VM&amp;, JSGlobalObject*, String name);</span>
204 
205     static bool isLazy(PropertyStatus property) { return property == PropertyStatus::Lazy || property == PropertyStatus::Reified; }
206     static bool isReified(PropertyStatus property) { return property == PropertyStatus::Reified; }
207 
<span class="line-modified">208     PropertyStatus reifyLazyPropertyForHostOrBuiltinIfNeeded(VM&amp;, JSGlobalObject*, PropertyName);</span>
<span class="line-modified">209     PropertyStatus reifyLazyLengthIfNeeded(VM&amp;, JSGlobalObject*, PropertyName);</span>
<span class="line-modified">210     PropertyStatus reifyLazyNameIfNeeded(VM&amp;, JSGlobalObject*, PropertyName);</span>
<span class="line-modified">211     PropertyStatus reifyLazyBoundNameIfNeeded(VM&amp;, JSGlobalObject*, PropertyName);</span>
212 
<span class="line-modified">213 #if ASSERT_ENABLED</span>


214     void assertTypeInfoFlagInvariants();
<span class="line-added">215 #else</span>
<span class="line-added">216     void assertTypeInfoFlagInvariants() { }</span>
217 #endif
218 
219     friend class LLIntOffsetsExtractor;
220 
<span class="line-modified">221     static EncodedJSValue argumentsGetter(JSGlobalObject*, EncodedJSValue, PropertyName);</span>
<span class="line-modified">222     static EncodedJSValue callerGetter(JSGlobalObject*, EncodedJSValue, PropertyName);</span>


223 
<span class="line-modified">224     uintptr_t m_executableOrRareData;</span>

225 };
226 
227 class JSStrictFunction final : public JSFunction {
228 public:
229     using Base = JSFunction;
230 
231     DECLARE_EXPORT_INFO;
232 
233     static constexpr unsigned StructureFlags = Base::StructureFlags;
234 
235     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
236     {
237         ASSERT(globalObject);
238         return Structure::create(vm, globalObject, prototype, TypeInfo(JSFunctionType, StructureFlags), info());
239     }
240 };
241 static_assert(sizeof(JSStrictFunction) == sizeof(JSFunction), &quot;Allocated in JSFunction IsoSubspace&quot;);
242 
243 class JSSloppyFunction final : public JSFunction {
244 public:
</pre>
</td>
</tr>
</table>
<center><a href="JSFunction.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSFunctionInlines.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>