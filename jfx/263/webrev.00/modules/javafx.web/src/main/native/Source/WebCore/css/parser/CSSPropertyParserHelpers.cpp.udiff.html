<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/css/parser/CSSPropertyParserHelpers.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CSSPropertyParser.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="CSSPropertyParserHelpers.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/css/parser/CSSPropertyParserHelpers.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -84,47 +84,48 @@</span>
          : m_sourceRange(range)
          , m_range(range)
      {
          const CSSParserToken&amp; token = range.peek();
          auto functionId = token.functionId();
<span class="udiff-line-modified-removed">-         if (functionId == CSSValueCalc || functionId == CSSValueWebkitCalc || functionId == CSSValueMin || functionId == CSSValueMax)</span>
<span class="udiff-line-modified-added">+         if (CSSCalcValue::isCalcFunction(functionId))</span>
              m_calcValue = CSSCalcValue::create(functionId, consumeFunction(m_range), destinationCategory, valueRange);
      }
  
      const CSSCalcValue* value() const { return m_calcValue.get(); }
<span class="udiff-line-added">+ </span>
      RefPtr&lt;CSSPrimitiveValue&gt; consumeValue()
      {
          if (!m_calcValue)
              return nullptr;
          m_sourceRange = m_range;
          return CSSValuePool::singleton().createValue(WTFMove(m_calcValue));
      }
<span class="udiff-line-modified-removed">-     RefPtr&lt;CSSPrimitiveValue&gt; consumeNumber()</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     RefPtr&lt;CSSPrimitiveValue&gt; consumeInteger(double minimumValue)</span>
      {
          if (!m_calcValue)
              return nullptr;
          m_sourceRange = m_range;
<span class="udiff-line-modified-removed">-         return CSSValuePool::singleton().createValue(m_calcValue-&gt;doubleValue(), CSSPrimitiveValue::UnitType::CSS_NUMBER);</span>
<span class="udiff-line-modified-added">+         double value = std::max(m_calcValue-&gt;doubleValue(), minimumValue);</span>
<span class="udiff-line-added">+         value = std::round(value);</span>
<span class="udiff-line-added">+         return CSSValuePool::singleton().createValue(value, CSSUnitType::CSS_NUMBER);</span>
      }
  
<span class="udiff-line-modified-removed">-     bool consumeNumberRaw(double&amp; result)</span>
<span class="udiff-line-modified-added">+     RefPtr&lt;CSSPrimitiveValue&gt; consumeNumber()</span>
      {
<span class="udiff-line-modified-removed">-         if (!m_calcValue || m_calcValue-&gt;category() != CalculationCategory::Number)</span>
<span class="udiff-line-modified-removed">-             return false;</span>
<span class="udiff-line-modified-added">+         if (!m_calcValue)</span>
<span class="udiff-line-modified-added">+             return nullptr;</span>
          m_sourceRange = m_range;
<span class="udiff-line-modified-removed">-         result = m_calcValue-&gt;doubleValue();</span>
<span class="udiff-line-removed">-         return true;</span>
<span class="udiff-line-modified-added">+         return CSSValuePool::singleton().createValue(m_calcValue-&gt;doubleValue(), CSSUnitType::CSS_NUMBER);</span>
      }
  
<span class="udiff-line-modified-removed">-     bool consumePositiveIntegerRaw(int&amp; result)</span>
<span class="udiff-line-modified-added">+     bool consumeNumberRaw(double&amp; result)</span>
      {
<span class="udiff-line-modified-removed">-         if (!m_calcValue || m_calcValue-&gt;category() != CalculationCategory::Number || !m_calcValue-&gt;isInt())</span>
<span class="udiff-line-removed">-             return false;</span>
<span class="udiff-line-removed">-         result = static_cast&lt;int&gt;(m_calcValue-&gt;doubleValue());</span>
<span class="udiff-line-removed">-         if (result &lt; 1)</span>
<span class="udiff-line-modified-added">+         if (!m_calcValue || m_calcValue-&gt;category() != CalculationCategory::Number)</span>
              return false;
          m_sourceRange = m_range;
<span class="udiff-line-added">+         result = m_calcValue-&gt;doubleValue();</span>
          return true;
      }
  
  private:
      CSSParserTokenRange&amp; m_sourceRange;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -136,51 +137,31 @@</span>
  {
      const CSSParserToken&amp; token = range.peek();
      if (token.type() == NumberToken) {
          if (token.numericValueType() == NumberValueType || token.numericValue() &lt; minimumValue)
              return nullptr;
<span class="udiff-line-modified-removed">-         return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), CSSPrimitiveValue::UnitType::CSS_NUMBER);</span>
<span class="udiff-line-modified-added">+         return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), CSSUnitType::CSS_NUMBER);</span>
      }
  
      if (token.type() != FunctionToken)
          return nullptr;
  
      CalcParser calcParser(range, CalculationCategory::Number);
      if (const CSSCalcValue* calculation = calcParser.value()) {
<span class="udiff-line-modified-removed">-         if (calculation-&gt;category() != CalculationCategory::Number || !calculation-&gt;isInt())</span>
<span class="udiff-line-modified-added">+         if (calculation-&gt;category() != CalculationCategory::Number)</span>
              return nullptr;
<span class="udiff-line-modified-removed">-         double value = calculation-&gt;doubleValue();</span>
<span class="udiff-line-removed">-         if (value &lt; minimumValue)</span>
<span class="udiff-line-removed">-             return nullptr;</span>
<span class="udiff-line-removed">-         return calcParser.consumeNumber();</span>
<span class="udiff-line-modified-added">+         return calcParser.consumeInteger(minimumValue);</span>
      }
  
      return nullptr;
  }
  
  RefPtr&lt;CSSPrimitiveValue&gt; consumePositiveInteger(CSSParserTokenRange&amp; range)
  {
      return consumeInteger(range, 1);
  }
  
<span class="udiff-line-removed">- bool consumePositiveIntegerRaw(CSSParserTokenRange&amp; range, int&amp; result)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     const CSSParserToken&amp; token = range.peek();</span>
<span class="udiff-line-removed">-     if (token.type() == NumberToken) {</span>
<span class="udiff-line-removed">-         if (token.numericValueType() == NumberValueType || token.numericValue() &lt; 1)</span>
<span class="udiff-line-removed">-             return false;</span>
<span class="udiff-line-removed">-         result = range.consumeIncludingWhitespace().numericValue();</span>
<span class="udiff-line-removed">-         return true;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (token.type() != FunctionToken)</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     CalcParser calcParser(range, CalculationCategory::Number);</span>
<span class="udiff-line-removed">-     return calcParser.consumePositiveIntegerRaw(result);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  bool consumeNumberRaw(CSSParserTokenRange&amp; range, double&amp; result)
  {
      const CSSParserToken&amp; token = range.peek();
      if (token.type() == NumberToken) {
          result = range.consumeIncludingWhitespace().numericValue();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -205,17 +186,15 @@</span>
      }
  
      if (token.type() != FunctionToken)
          return nullptr;
  
<span class="udiff-line-modified-removed">-     CalcParser calcParser(range, CalculationCategory::Number, ValueRangeAll);</span>
<span class="udiff-line-modified-removed">-     if (const CSSCalcValue* calculation = calcParser.value()) {</span>
<span class="udiff-line-modified-removed">-         // FIXME: Calcs should not be subject to parse time range checks.</span>
<span class="udiff-line-removed">-         // spec: https://drafts.csswg.org/css-values-3/#calc-range</span>
<span class="udiff-line-removed">-         if (calculation-&gt;category() != CalculationCategory::Number || (valueRange == ValueRangeNonNegative &amp;&amp; calculation-&gt;isNegative()))</span>
<span class="udiff-line-modified-added">+     CalcParser calcParser(range, CalculationCategory::Number, valueRange);</span>
<span class="udiff-line-modified-added">+     if (const CSSCalcValue* calcValue = calcParser.value()) {</span>
<span class="udiff-line-modified-added">+         if (calcValue-&gt;category() != CalculationCategory::Number)</span>
              return nullptr;
<span class="udiff-line-modified-removed">-         return calcParser.consumeNumber();</span>
<span class="udiff-line-modified-added">+         return calcParser.consumeValue();</span>
      }
  
      return nullptr;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -247,11 +226,11 @@</span>
  #if !ENABLE(VARIATION_FONTS)
          &amp;&amp; result &gt; 0 &amp;&amp; result &lt; 1000 &amp;&amp; divisibleBy100(result)
  #endif
      ) {
          result = std::min(std::max(result, std::nextafter(0., 1.)), std::nextafter(1000., 0.));
<span class="udiff-line-modified-removed">-         return CSSValuePool::singleton().createValue(result, CSSPrimitiveValue::UnitType::CSS_NUMBER);</span>
<span class="udiff-line-modified-added">+         return CSSValuePool::singleton().createValue(result, CSSUnitType::CSS_NUMBER);</span>
      }
  
      return nullptr;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -266,28 +245,29 @@</span>
  RefPtr&lt;CSSPrimitiveValue&gt; consumeLength(CSSParserTokenRange&amp; range, CSSParserMode cssParserMode, ValueRange valueRange, UnitlessQuirk unitless)
  {
      const CSSParserToken&amp; token = range.peek();
      if (token.type() == DimensionToken) {
          switch (token.unitType()) {
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_QUIRKY_EMS:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_QUIRKY_EMS:</span>
              if (cssParserMode != UASheetMode)
                  return nullptr;
              FALLTHROUGH;
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_EMS:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_REMS:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_CHS:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_EXS:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_PX:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_CM:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_MM:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_IN:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_PT:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_PC:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_VW:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_VH:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_VMIN:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_VMAX:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_EMS:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_REMS:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_CHS:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_EXS:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_PX:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_CM:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_MM:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_IN:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_PT:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_PC:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_VW:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_VH:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_VMIN:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_VMAX:</span>
<span class="udiff-line-added">+         case CSSUnitType::CSS_Q:</span>
              break;
          default:
              return nullptr;
          }
          if ((valueRange == ValueRangeNonNegative &amp;&amp; token.numericValue() &lt; 0) || std::isinf(token.numericValue()))
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -298,11 +278,11 @@</span>
          if (!shouldAcceptUnitlessValue(token.numericValue(), cssParserMode, unitless)
              || (valueRange == ValueRangeNonNegative &amp;&amp; token.numericValue() &lt; 0))
              return nullptr;
          if (std::isinf(token.numericValue()))
              return nullptr;
<span class="udiff-line-modified-removed">-         CSSPrimitiveValue::UnitType unitType = CSSPrimitiveValue::UnitType::CSS_PX;</span>
<span class="udiff-line-modified-added">+         CSSUnitType unitType = CSSUnitType::CSS_PX;</span>
          return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), unitType);
      }
  
      if (token.type() != FunctionToken)
          return nullptr;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -318,11 +298,11 @@</span>
  {
      const CSSParserToken&amp; token = range.peek();
      if (token.type() == PercentageToken) {
          if ((valueRange == ValueRangeNonNegative &amp;&amp; token.numericValue() &lt; 0) || std::isinf(token.numericValue()))
              return nullptr;
<span class="udiff-line-modified-removed">-         return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), CSSPrimitiveValue::UnitType::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-added">+         return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), CSSUnitType::CSS_PERCENTAGE);</span>
      }
  
      if (token.type() != FunctionToken)
          return nullptr;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -370,22 +350,22 @@</span>
  RefPtr&lt;CSSPrimitiveValue&gt; consumeAngle(CSSParserTokenRange&amp; range, CSSParserMode cssParserMode, UnitlessQuirk unitless)
  {
      const CSSParserToken&amp; token = range.peek();
      if (token.type() == DimensionToken) {
          switch (token.unitType()) {
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_DEG:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_RAD:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_GRAD:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_TURN:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_DEG:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_RAD:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_GRAD:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_TURN:</span>
              return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), token.unitType());
          default:
              return nullptr;
          }
      }
  
      if (token.type() == NumberToken &amp;&amp; shouldAcceptUnitlessValue(token.numericValue(), cssParserMode, unitless))
<span class="udiff-line-modified-removed">-         return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), CSSPrimitiveValue::UnitType::CSS_DEG);</span>
<span class="udiff-line-modified-added">+         return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), CSSUnitType::CSS_DEG);</span>
  
      if (token.type() != FunctionToken)
          return nullptr;
  
      CalcParser calcParser(range, CalculationCategory::Angle, ValueRangeAll);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -399,21 +379,21 @@</span>
  static RefPtr&lt;CSSPrimitiveValue&gt; consumeAngleOrPercent(CSSParserTokenRange&amp; range, CSSParserMode cssParserMode, ValueRange valueRange, UnitlessQuirk unitless)
  {
      const CSSParserToken&amp; token = range.peek();
      if (token.type() == DimensionToken) {
          switch (token.unitType()) {
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_DEG:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_RAD:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_GRAD:</span>
<span class="udiff-line-modified-removed">-         case CSSPrimitiveValue::UnitType::CSS_TURN:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_DEG:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_RAD:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_GRAD:</span>
<span class="udiff-line-modified-added">+         case CSSUnitType::CSS_TURN:</span>
              return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), token.unitType());
          default:
              return nullptr;
          }
      }
      if (token.type() == NumberToken &amp;&amp; shouldAcceptUnitlessValue(token.numericValue(), cssParserMode, unitless))
<span class="udiff-line-modified-removed">-         return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), CSSPrimitiveValue::UnitType::CSS_DEG);</span>
<span class="udiff-line-modified-added">+         return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), CSSUnitType::CSS_DEG);</span>
  
      if (token.type() == PercentageToken)
          return consumePercent(range, valueRange);
  
       if (token.type() != FunctionToken)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -434,18 +414,18 @@</span>
  }
  
  RefPtr&lt;CSSPrimitiveValue&gt; consumeTime(CSSParserTokenRange&amp; range, CSSParserMode cssParserMode, ValueRange valueRange, UnitlessQuirk unitless)
  {
      const CSSParserToken&amp; token = range.peek();
<span class="udiff-line-modified-removed">-     CSSPrimitiveValue::UnitType unit = token.unitType();</span>
<span class="udiff-line-modified-removed">-     bool acceptUnitless = token.type() == NumberToken &amp;&amp; shouldAcceptUnitlessValue(token.numericValue(), cssParserMode, unitless);</span>
<span class="udiff-line-modified-added">+     CSSUnitType unit = token.unitType();</span>
<span class="udiff-line-modified-added">+     bool acceptUnitless = token.type() == NumberToken &amp;&amp; unitless == UnitlessQuirk::Allow &amp;&amp; shouldAcceptUnitlessValue(token.numericValue(), cssParserMode, unitless);</span>
      if (acceptUnitless)
<span class="udiff-line-modified-removed">-         unit = CSSPrimitiveValue::UnitType::CSS_MS;</span>
<span class="udiff-line-modified-added">+         unit = CSSUnitType::CSS_MS;</span>
      if (token.type() == DimensionToken || acceptUnitless) {
          if (valueRange == ValueRangeNonNegative &amp;&amp; token.numericValue() &lt; 0)
              return nullptr;
<span class="udiff-line-modified-removed">-         if (unit == CSSPrimitiveValue::UnitType::CSS_MS || unit == CSSPrimitiveValue::UnitType::CSS_S)</span>
<span class="udiff-line-modified-added">+         if (unit == CSSUnitType::CSS_MS || unit == CSSUnitType::CSS_S)</span>
              return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), unit);
          return nullptr;
      }
  
      if (token.type() != FunctionToken)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -457,19 +437,22 @@</span>
              return calcParser.consumeValue();
      }
      return nullptr;
  }
  
<span class="udiff-line-modified-removed">- RefPtr&lt;CSSPrimitiveValue&gt; consumeResolution(CSSParserTokenRange&amp; range)</span>
<span class="udiff-line-modified-added">+ RefPtr&lt;CSSPrimitiveValue&gt; consumeResolution(CSSParserTokenRange&amp; range, AllowXResolutionUnit allowX)</span>
  {
      const CSSParserToken&amp; token = range.peek();
      // Unlike the other types, calc() does not work with &lt;resolution&gt;.
      if (token.type() != DimensionToken)
          return nullptr;
<span class="udiff-line-modified-removed">-     CSSPrimitiveValue::UnitType unit = token.unitType();</span>
<span class="udiff-line-modified-removed">-     if (unit == CSSPrimitiveValue::UnitType::CSS_DPPX || unit == CSSPrimitiveValue::UnitType::CSS_DPI || unit == CSSPrimitiveValue::UnitType::CSS_DPCM)</span>
<span class="udiff-line-modified-added">+     CSSUnitType unit = token.unitType();</span>
<span class="udiff-line-modified-added">+     if (unit == CSSUnitType::CSS_DPPX || unit == CSSUnitType::CSS_DPI || unit == CSSUnitType::CSS_DPCM)</span>
          return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), unit);
<span class="udiff-line-added">+     if (allowX == AllowXResolutionUnit::Allow &amp;&amp; token.value() == &quot;x&quot;)</span>
<span class="udiff-line-added">+         return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().numericValue(), CSSUnitType::CSS_DPPX);</span>
<span class="udiff-line-added">+ </span>
      return nullptr;
  }
  
  RefPtr&lt;CSSPrimitiveValue&gt; consumeIdent(CSSParserTokenRange&amp; range)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -490,18 +473,18 @@</span>
  // use only primitive values).
  RefPtr&lt;CSSPrimitiveValue&gt; consumeCustomIdent(CSSParserTokenRange&amp; range)
  {
      if (range.peek().type() != IdentToken || isCSSWideKeyword(range.peek().id()))
          return nullptr;
<span class="udiff-line-modified-removed">-     return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().value().toString(), CSSPrimitiveValue::UnitType::CSS_STRING);</span>
<span class="udiff-line-modified-added">+     return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().value().toString(), CSSUnitType::CSS_STRING);</span>
  }
  
  RefPtr&lt;CSSPrimitiveValue&gt; consumeString(CSSParserTokenRange&amp; range)
  {
      if (range.peek().type() != StringToken)
          return nullptr;
<span class="udiff-line-modified-removed">-     return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().value().toString(), CSSPrimitiveValue::UnitType::CSS_STRING);</span>
<span class="udiff-line-modified-added">+     return CSSValuePool::singleton().createValue(range.consumeIncludingWhitespace().value().toString(), CSSUnitType::CSS_STRING);</span>
  }
  
  StringView consumeUrlAsStringView(CSSParserTokenRange&amp; range)
  {
      const CSSParserToken&amp; token = range.peek();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -527,11 +510,11 @@</span>
  RefPtr&lt;CSSPrimitiveValue&gt; consumeUrl(CSSParserTokenRange&amp; range)
  {
      StringView url = consumeUrlAsStringView(range);
      if (url.isNull())
          return nullptr;
<span class="udiff-line-modified-removed">-     return CSSValuePool::singleton().createValue(url.toString(), CSSPrimitiveValue::UnitType::CSS_URI);</span>
<span class="udiff-line-modified-added">+     return CSSValuePool::singleton().createValue(url.toString(), CSSUnitType::CSS_URI);</span>
  }
  
  static int clampRGBComponent(const CSSPrimitiveValue&amp; value)
  {
      double result = value.doubleValue();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -597,13 +580,12 @@</span>
              if (!alphaPercent)
                  return Color();
              alpha = alphaPercent-&gt;doubleValue() / 100.0;
          }
  
<span class="udiff-line-modified-removed">-         // Convert the floating pointer number of alpha to an integer in the range [0, 256),</span>
<span class="udiff-line-modified-removed">-         // with an equal distribution across all 256 values.</span>
<span class="udiff-line-removed">-         alphaComponent = static_cast&lt;int&gt;(clampTo&lt;double&gt;(alpha, 0.0, 1.0) * nextafter(256.0, 0.0));</span>
<span class="udiff-line-modified-added">+         // W3 standard stipulates a 2.55 alpha value multiplication factor.</span>
<span class="udiff-line-modified-added">+         alphaComponent = static_cast&lt;int&gt;(lroundf(clampTo&lt;double&gt;(alpha, 0.0, 1.0) * 255.0f));</span>
      };
  
      result = Color(makeRGBA(colorArray[0], colorArray[1], colorArray[2], alphaComponent));
  
      if (!args.atEnd())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -623,13 +605,13 @@</span>
          if (!hslValue)
              return Color();
          angleInDegrees = hslValue-&gt;doubleValue();
      } else
          angleInDegrees = hslValue-&gt;computeDegrees();
<span class="udiff-line-added">+ </span>
      double colorArray[3];
<span class="udiff-line-modified-removed">-     // The hue needs to be in the range [0.0, 6.0) for calcHue()</span>
<span class="udiff-line-removed">-     colorArray[0] = fmod(fmod(angleInDegrees, 360.0) + 360.0, 360.0) / 60.0;</span>
<span class="udiff-line-modified-added">+     colorArray[0] = fmod(fmod(angleInDegrees, 360.0) + 360.0, 360.0) / 360.0;</span>
      bool requiresCommas = false;
      for (int i = 1; i &lt; 3; i++) {
          if (consumeCommaIncludingWhitespace(args)) {
              if (i != 1 &amp;&amp; !requiresCommas)
                  return Color();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -659,25 +641,25 @@</span>
      }
  
      if (!args.atEnd())
          return Color();
  
<span class="udiff-line-modified-removed">-     return Color(makeRGBAFromHSLA(colorArray[0], colorArray[1], colorArray[2], alpha));</span>
<span class="udiff-line-modified-added">+     return Color(makeRGBAFromHSLA(static_cast&lt;float&gt;(colorArray[0]), static_cast&lt;float&gt;(colorArray[1]), static_cast&lt;float&gt;(colorArray[2]), static_cast&lt;float&gt;(alpha)));</span>
  }
  
  static Color parseColorFunctionParameters(CSSParserTokenRange&amp; range)
  {
      ASSERT(range.peek().functionId() == CSSValueColor);
      CSSParserTokenRange args = consumeFunction(range);
  
      ColorSpace colorSpace;
      switch (args.peek().id()) {
      case CSSValueSRGB:
<span class="udiff-line-modified-removed">-         colorSpace = ColorSpaceSRGB;</span>
<span class="udiff-line-modified-added">+         colorSpace = ColorSpace::SRGB;</span>
          break;
      case CSSValueDisplayP3:
<span class="udiff-line-modified-removed">-         colorSpace = ColorSpaceDisplayP3;</span>
<span class="udiff-line-modified-added">+         colorSpace = ColorSpace::DisplayP3;</span>
          break;
      default:
          return Color();
      }
      consumeIdent(args);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -831,19 +813,29 @@</span>
  {
      return CSSValuePool::singleton().createValue(Pair::create(std::forward&lt;Args&gt;(args)...));
  }
  }
  
<span class="udiff-line-modified-removed">- static bool positionFromThreeOrFourValues(CSSPrimitiveValue** values, RefPtr&lt;CSSPrimitiveValue&gt;&amp; resultX, RefPtr&lt;CSSPrimitiveValue&gt;&amp; resultY)</span>
<span class="udiff-line-modified-added">+ // https://drafts.csswg.org/css-backgrounds-3/#propdef-background-position</span>
<span class="udiff-line-added">+ // background-position has special parsing rules, allowing a 3-value syntax:</span>
<span class="udiff-line-added">+ // &lt;bg-position&gt; =  [ left | center | right | top | bottom | &lt;length-percentage&gt; ]</span>
<span class="udiff-line-added">+ // |</span>
<span class="udiff-line-added">+ //   [ left | center | right | &lt;length-percentage&gt; ]</span>
<span class="udiff-line-added">+ //   [ top | center | bottom | &lt;length-percentage&gt; ]</span>
<span class="udiff-line-added">+ // |</span>
<span class="udiff-line-added">+ //   [ center | [ left | right ] &lt;length-percentage&gt;? ] &amp;&amp;</span>
<span class="udiff-line-added">+ //   [ center | [ top | bottom ] &lt;length-percentage&gt;? ]</span>
<span class="udiff-line-added">+ //</span>
<span class="udiff-line-added">+ static bool backgroundPositionFromThreeValues(const std::array&lt;CSSPrimitiveValue*, 5&gt;&amp; values, RefPtr&lt;CSSPrimitiveValue&gt;&amp; resultX, RefPtr&lt;CSSPrimitiveValue&gt;&amp; resultY)</span>
  {
      CSSPrimitiveValue* center = nullptr;
      for (int i = 0; values[i]; i++) {
          CSSPrimitiveValue* currentValue = values[i];
          if (!currentValue-&gt;isValueID())
              return false;
<span class="udiff-line-removed">-         CSSValueID id = currentValue-&gt;valueID();</span>
  
<span class="udiff-line-added">+         CSSValueID id = currentValue-&gt;valueID();</span>
          if (id == CSSValueCenter) {
              if (center)
                  return false;
              center = currentValue;
              continue;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -879,13 +871,56 @@</span>
  
      ASSERT(resultX &amp;&amp; resultY);
      return true;
  }
  
<span class="udiff-line-added">+ // https://drafts.csswg.org/css-values-4/#typedef-position</span>
<span class="udiff-line-added">+ // &lt;position&gt; = [</span>
<span class="udiff-line-added">+ //   [ left | center | right ] || [ top | center | bottom ]</span>
<span class="udiff-line-added">+ // |</span>
<span class="udiff-line-added">+ //   [ left | center | right | &lt;length-percentage&gt; ]</span>
<span class="udiff-line-added">+ //   [ top | center | bottom | &lt;length-percentage&gt; ]?</span>
<span class="udiff-line-added">+ // |</span>
<span class="udiff-line-added">+ //   [ [ left | right ] &lt;length-percentage&gt; ] &amp;&amp;</span>
<span class="udiff-line-added">+ //   [ [ top | bottom ] &lt;length-percentage&gt; ]</span>
<span class="udiff-line-added">+ //</span>
<span class="udiff-line-added">+ static bool positionFromFourValues(const std::array&lt;CSSPrimitiveValue*, 5&gt;&amp; values, RefPtr&lt;CSSPrimitiveValue&gt;&amp; resultX, RefPtr&lt;CSSPrimitiveValue&gt;&amp; resultY)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     for (int i = 0; values[i]; i++) {</span>
<span class="udiff-line-added">+         CSSPrimitiveValue* currentValue = values[i];</span>
<span class="udiff-line-added">+         if (!currentValue-&gt;isValueID())</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         CSSValueID id = currentValue-&gt;valueID();</span>
<span class="udiff-line-added">+         if (id == CSSValueCenter)</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         RefPtr&lt;CSSPrimitiveValue&gt; result;</span>
<span class="udiff-line-added">+         if (values[i + 1] &amp;&amp; !values[i + 1]-&gt;isValueID())</span>
<span class="udiff-line-added">+             result = CSSPropertyParserHelpersInternal::createPrimitiveValuePair(currentValue, values[++i]);</span>
<span class="udiff-line-added">+         else</span>
<span class="udiff-line-added">+             result = currentValue;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (id == CSSValueLeft || id == CSSValueRight) {</span>
<span class="udiff-line-added">+             if (resultX)</span>
<span class="udiff-line-added">+                 return false;</span>
<span class="udiff-line-added">+             resultX = result;</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             ASSERT(id == CSSValueTop || id == CSSValueBottom);</span>
<span class="udiff-line-added">+             if (resultY)</span>
<span class="udiff-line-added">+                 return false;</span>
<span class="udiff-line-added">+             resultY = result;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ASSERT(resultX &amp;&amp; resultY);</span>
<span class="udiff-line-added">+     return true;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  // FIXME: This may consume from the range upon failure. The background
  // shorthand works around it, but we should just fix it here.
<span class="udiff-line-modified-removed">- bool consumePosition(CSSParserTokenRange&amp; range, CSSParserMode cssParserMode, UnitlessQuirk unitless, RefPtr&lt;CSSPrimitiveValue&gt;&amp; resultX, RefPtr&lt;CSSPrimitiveValue&gt;&amp; resultY)</span>
<span class="udiff-line-modified-added">+ bool consumePosition(CSSParserTokenRange&amp; range, CSSParserMode cssParserMode, UnitlessQuirk unitless, PositionSyntax positionSyntax, RefPtr&lt;CSSPrimitiveValue&gt;&amp; resultX, RefPtr&lt;CSSPrimitiveValue&gt;&amp; resultY)</span>
  {
      RefPtr&lt;CSSPrimitiveValue&gt; value1 = consumePositionComponent(range, cssParserMode, unitless);
      if (!value1)
          return false;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -898,24 +933,32 @@</span>
      RefPtr&lt;CSSPrimitiveValue&gt; value3 = consumePositionComponent(range, cssParserMode, unitless);
      if (!value3)
          return positionFromTwoValues(*value1, *value2, resultX, resultY);
  
      RefPtr&lt;CSSPrimitiveValue&gt; value4 = consumePositionComponent(range, cssParserMode, unitless);
<span class="udiff-line-modified-removed">-     CSSPrimitiveValue* values[5];</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     std::array&lt;CSSPrimitiveValue*, 5&gt; values;</span>
      values[0] = value1.get();
      values[1] = value2.get();
      values[2] = value3.get();
      values[3] = value4.get();
      values[4] = nullptr;
<span class="udiff-line-modified-removed">-     return positionFromThreeOrFourValues(values, resultX, resultY);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     if (value4)</span>
<span class="udiff-line-added">+         return positionFromFourValues(values, resultX, resultY);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (positionSyntax != PositionSyntax::BackgroundPosition)</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return backgroundPositionFromThreeValues(values, resultX, resultY);</span>
  }
  
<span class="udiff-line-modified-removed">- RefPtr&lt;CSSPrimitiveValue&gt; consumePosition(CSSParserTokenRange&amp; range, CSSParserMode cssParserMode, UnitlessQuirk unitless)</span>
<span class="udiff-line-modified-added">+ RefPtr&lt;CSSPrimitiveValue&gt; consumePosition(CSSParserTokenRange&amp; range, CSSParserMode cssParserMode, UnitlessQuirk unitless, PositionSyntax positionSyntax)</span>
  {
      RefPtr&lt;CSSPrimitiveValue&gt; resultX;
      RefPtr&lt;CSSPrimitiveValue&gt; resultY;
<span class="udiff-line-modified-removed">-     if (consumePosition(range, cssParserMode, unitless, resultX, resultY))</span>
<span class="udiff-line-modified-added">+     if (consumePosition(range, cssParserMode, unitless, positionSyntax, resultX, resultY))</span>
          return CSSPropertyParserHelpersInternal::createPrimitiveValuePair(resultX.releaseNonNull(), resultY.releaseNonNull());
      return nullptr;
  }
  
  bool consumeOneOrTwoValuedPosition(CSSParserTokenRange&amp; range, CSSParserMode cssParserMode, UnitlessQuirk unitless, RefPtr&lt;CSSPrimitiveValue&gt;&amp; resultX, RefPtr&lt;CSSPrimitiveValue&gt;&amp; resultY)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -934,15 +977,15 @@</span>
  // This should go away once we drop support for -webkit-gradient
  static RefPtr&lt;CSSPrimitiveValue&gt; consumeDeprecatedGradientPoint(CSSParserTokenRange&amp; args, bool horizontal)
  {
      if (args.peek().type() == IdentToken) {
          if ((horizontal &amp;&amp; consumeIdent&lt;CSSValueLeft&gt;(args)) || (!horizontal &amp;&amp; consumeIdent&lt;CSSValueTop&gt;(args)))
<span class="udiff-line-modified-removed">-             return CSSValuePool::singleton().createValue(0., CSSPrimitiveValue::UnitType::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-added">+             return CSSValuePool::singleton().createValue(0., CSSUnitType::CSS_PERCENTAGE);</span>
          if ((horizontal &amp;&amp; consumeIdent&lt;CSSValueRight&gt;(args)) || (!horizontal &amp;&amp; consumeIdent&lt;CSSValueBottom&gt;(args)))
<span class="udiff-line-modified-removed">-             return CSSValuePool::singleton().createValue(100., CSSPrimitiveValue::UnitType::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-added">+             return CSSValuePool::singleton().createValue(100., CSSUnitType::CSS_PERCENTAGE);</span>
          if (consumeIdent&lt;CSSValueCenter&gt;(args))
<span class="udiff-line-modified-removed">-             return CSSValuePool::singleton().createValue(50., CSSPrimitiveValue::UnitType::CSS_PERCENTAGE);</span>
<span class="udiff-line-modified-added">+             return CSSValuePool::singleton().createValue(50., CSSUnitType::CSS_PERCENTAGE);</span>
          return nullptr;
      }
      RefPtr&lt;CSSPrimitiveValue&gt; result = consumePercent(args, ValueRangeAll);
      if (!result)
          result = consumeNumber(args, ValueRangeAll);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -976,11 +1019,11 @@</span>
  
          if (!consumeCommaIncludingWhitespace(args))
              return false;
      }
  
<span class="udiff-line-modified-removed">-     stop.m_position = CSSValuePool::singleton().createValue(position, CSSPrimitiveValue::UnitType::CSS_NUMBER);</span>
<span class="udiff-line-modified-added">+     stop.m_position = CSSValuePool::singleton().createValue(position, CSSUnitType::CSS_NUMBER);</span>
      stop.m_color = consumeDeprecatedGradientStopColor(args, cssParserMode);
      return stop.m_color &amp;&amp; args.atEnd();
  }
  
  static RefPtr&lt;CSSValue&gt; consumeDeprecatedGradient(CSSParserTokenRange&amp; args, CSSParserMode cssParserMode)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -993,11 +1036,11 @@</span>
      else if (id == CSSValueLinear)
          result = CSSLinearGradientValue::create(NonRepeating, CSSDeprecatedLinearGradient);
      if (!result || !consumeCommaIncludingWhitespace(args))
          return nullptr;
  
<span class="udiff-line-modified-removed">-     RefPtr&lt;CSSPrimitiveValue&gt; point = consumeDeprecatedGradientPoint(args, true);</span>
<span class="udiff-line-modified-added">+     auto point = consumeDeprecatedGradientPoint(args, true);</span>
      if (!point)
          return nullptr;
      result-&gt;setFirstX(point.copyRef());
      point = consumeDeprecatedGradientPoint(args, false);
      if (!point)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1007,11 +1050,11 @@</span>
      if (!consumeCommaIncludingWhitespace(args))
          return nullptr;
  
      // For radial gradients only, we now expect a numeric radius.
      if (isDeprecatedRadialGradient) {
<span class="udiff-line-modified-removed">-         RefPtr&lt;CSSPrimitiveValue&gt; radius = consumeNumber(args, ValueRangeAll);</span>
<span class="udiff-line-modified-added">+         auto radius = consumeNumber(args, ValueRangeNonNegative);</span>
          if (!radius || !consumeCommaIncludingWhitespace(args))
              return nullptr;
          downcast&lt;CSSRadialGradientValue&gt;(result.get())-&gt;setFirstRadius(radius.copyRef());
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1026,11 +1069,11 @@</span>
  
      // For radial gradients only, we now expect the second radius.
      if (isDeprecatedRadialGradient) {
          if (!consumeCommaIncludingWhitespace(args))
              return nullptr;
<span class="udiff-line-modified-removed">-         RefPtr&lt;CSSPrimitiveValue&gt; radius = consumeNumber(args, ValueRangeAll);</span>
<span class="udiff-line-modified-added">+         auto radius = consumeNumber(args, ValueRangeNonNegative);</span>
          if (!radius)
              return nullptr;
          downcast&lt;CSSRadialGradientValue&gt;(result.get())-&gt;setSecondRadius(radius.copyRef());
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1070,23 +1113,24 @@</span>
          else
              stop.m_position = consumeLengthOrPercent(range, cssParserMode, ValueRangeAll);
  
          if (!stop.m_color &amp;&amp; !stop.m_position)
              return false;
<span class="udiff-line-added">+ </span>
          gradient.addStop(stop);
  
<span class="udiff-line-modified-removed">-         // See if there is a second color hint, which is optional.</span>
<span class="udiff-line-modified-added">+         if (!stop.m_color || !stop.m_position)</span>
<span class="udiff-line-added">+             continue;</span>
<span class="udiff-line-added">+ </span>
          CSSGradientColorStop secondStop;
          if (isConicGradient)
              secondStop.m_position = consumeAngleOrPercent(range, cssParserMode, ValueRangeAll, UnitlessQuirk::Forbid);
          else
              secondStop.m_position = consumeLengthOrPercent(range, cssParserMode, ValueRangeAll);
  
<span class="udiff-line-modified-removed">-         if (secondStop.m_position) {</span>
<span class="udiff-line-removed">-             secondStop.m_color = stop.m_color;</span>
<span class="udiff-line-modified-added">+         if (secondStop.m_position)</span>
              gradient.addStop(secondStop);
<span class="udiff-line-removed">-         }</span>
  
      } while (consumeCommaIncludingWhitespace(range));
  
      gradient.doneAddingStops();
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1110,23 +1154,23 @@</span>
      result-&gt;setFirstX(centerX.copyRef());
      result-&gt;setFirstY(centerY.copyRef());
      result-&gt;setSecondX(centerX.copyRef());
      result-&gt;setSecondY(centerY.copyRef());
  
<span class="udiff-line-modified-removed">-     RefPtr&lt;CSSPrimitiveValue&gt; shape = consumeIdent&lt;CSSValueCircle, CSSValueEllipse&gt;(args);</span>
<span class="udiff-line-modified-removed">-     RefPtr&lt;CSSPrimitiveValue&gt; sizeKeyword = consumeIdent&lt;CSSValueClosestSide, CSSValueClosestCorner, CSSValueFarthestSide, CSSValueFarthestCorner, CSSValueContain, CSSValueCover&gt;(args);</span>
<span class="udiff-line-modified-added">+     auto shape = consumeIdent&lt;CSSValueCircle, CSSValueEllipse&gt;(args);</span>
<span class="udiff-line-modified-added">+     auto sizeKeyword = consumeIdent&lt;CSSValueClosestSide, CSSValueClosestCorner, CSSValueFarthestSide, CSSValueFarthestCorner, CSSValueContain, CSSValueCover&gt;(args);</span>
      if (!shape)
          shape = consumeIdent&lt;CSSValueCircle, CSSValueEllipse&gt;(args);
      result-&gt;setShape(shape.copyRef());
      result-&gt;setSizingBehavior(sizeKeyword.copyRef());
  
      // Or, two lengths or percentages
      if (!shape &amp;&amp; !sizeKeyword) {
<span class="udiff-line-modified-removed">-         RefPtr&lt;CSSPrimitiveValue&gt; horizontalSize = consumeLengthOrPercent(args, cssParserMode, ValueRangeAll);</span>
<span class="udiff-line-modified-added">+         auto horizontalSize = consumeLengthOrPercent(args, cssParserMode, ValueRangeNonNegative);</span>
          RefPtr&lt;CSSPrimitiveValue&gt; verticalSize;
          if (horizontalSize) {
<span class="udiff-line-modified-removed">-             verticalSize = consumeLengthOrPercent(args, cssParserMode, ValueRangeAll);</span>
<span class="udiff-line-modified-added">+             verticalSize = consumeLengthOrPercent(args, cssParserMode, ValueRangeNonNegative);</span>
              if (!verticalSize)
                  return nullptr;
              consumeCommaIncludingWhitespace(args);
              result-&gt;setEndHorizontalSize(horizontalSize.copyRef());
              result-&gt;setEndVerticalSize(verticalSize.copyRef());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1166,17 +1210,17 @@</span>
                  sizeKeyword = consumeIdent(args);
              } else {
                  break;
              }
          } else {
<span class="udiff-line-modified-removed">-             RefPtr&lt;CSSPrimitiveValue&gt; center = consumeLengthOrPercent(args, cssParserMode, ValueRangeAll);</span>
<span class="udiff-line-modified-added">+             auto center = consumeLengthOrPercent(args, cssParserMode, ValueRangeNonNegative);</span>
              if (!center)
                  break;
              if (horizontalSize)
                  return nullptr;
              horizontalSize = center;
<span class="udiff-line-modified-removed">-             center = consumeLengthOrPercent(args, cssParserMode, ValueRangeAll);</span>
<span class="udiff-line-modified-added">+             center = consumeLengthOrPercent(args, cssParserMode, ValueRangeNonNegative);</span>
              if (center) {
                  verticalSize = center;
                  ++i;
              }
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1205,11 +1249,11 @@</span>
  
      RefPtr&lt;CSSPrimitiveValue&gt; centerX;
      RefPtr&lt;CSSPrimitiveValue&gt; centerY;
      if (args.peek().id() == CSSValueAt) {
          args.consumeIncludingWhitespace();
<span class="udiff-line-modified-removed">-         consumePosition(args, cssParserMode, UnitlessQuirk::Forbid, centerX, centerY);</span>
<span class="udiff-line-modified-added">+         consumePosition(args, cssParserMode, UnitlessQuirk::Forbid, PositionSyntax::Position, centerX, centerY);</span>
          if (!(centerX &amp;&amp; centerY))
              return nullptr;
  
          result-&gt;setFirstX(centerX.copyRef());
          result-&gt;setFirstY(centerY.copyRef());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1275,11 +1319,11 @@</span>
          }
  
          if (consumeIdent&lt;CSSValueAt&gt;(args)) {
              RefPtr&lt;CSSPrimitiveValue&gt; centerX;
              RefPtr&lt;CSSPrimitiveValue&gt; centerY;
<span class="udiff-line-modified-removed">-             consumePosition(args, context.mode, UnitlessQuirk::Forbid, centerX, centerY);</span>
<span class="udiff-line-modified-added">+             consumePosition(args, context.mode, UnitlessQuirk::Forbid, PositionSyntax::Position, centerX, centerY);</span>
              if (!(centerX &amp;&amp; centerY))
                  return nullptr;
  
              result-&gt;setFirstX(centerX.copyRef());
              result-&gt;setFirstY(centerY.copyRef());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1321,13 +1365,13 @@</span>
      if (!toImageValue || !consumeCommaIncludingWhitespace(args))
          return nullptr;
  
      RefPtr&lt;CSSPrimitiveValue&gt; percentage;
      if (auto percentValue = consumePercent(args, ValueRangeAll))
<span class="udiff-line-modified-removed">-         percentage = CSSValuePool::singleton().createValue(clampTo&lt;double&gt;(percentValue-&gt;doubleValue() / 100.0, 0, 1), CSSPrimitiveValue::UnitType::CSS_NUMBER);</span>
<span class="udiff-line-modified-added">+         percentage = CSSValuePool::singleton().createValue(clampTo&lt;double&gt;(percentValue-&gt;doubleValue() / 100.0, 0, 1), CSSUnitType::CSS_NUMBER);</span>
      else if (auto numberValue = consumeNumber(args, ValueRangeAll))
<span class="udiff-line-modified-removed">-         percentage = CSSValuePool::singleton().createValue(clampTo&lt;double&gt;(numberValue-&gt;doubleValue(), 0, 1), CSSPrimitiveValue::UnitType::CSS_NUMBER);</span>
<span class="udiff-line-modified-added">+         percentage = CSSValuePool::singleton().createValue(clampTo&lt;double&gt;(numberValue-&gt;doubleValue(), 0, 1), CSSUnitType::CSS_NUMBER);</span>
  
      if (!percentage)
          return nullptr;
      return CSSCrossfadeValue::create(fromImageValue.releaseNonNull(), toImageValue.releaseNonNull(), percentage.releaseNonNull(), prefixed);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1436,33 +1480,27 @@</span>
          return nullptr;
      range = rangeCopy;
      return result;
  }
  
<span class="udiff-line-modified-removed">- static RefPtr&lt;CSSValue&gt; consumeImageSet(CSSParserTokenRange&amp; range, const CSSParserContext&amp; context)</span>
<span class="udiff-line-modified-added">+ static RefPtr&lt;CSSValue&gt; consumeImageSet(CSSParserTokenRange&amp; range, const CSSParserContext&amp; context, OptionSet&lt;AllowedImageType&gt; allowedImageTypes)</span>
  {
      CSSParserTokenRange rangeCopy = range;
      CSSParserTokenRange args = consumeFunction(rangeCopy);
<span class="udiff-line-modified-removed">-     RefPtr&lt;CSSImageSetValue&gt; imageSet = CSSImageSetValue::create(context.isContentOpaque ? LoadedFromOpaqueSource::Yes : LoadedFromOpaqueSource::No);</span>
<span class="udiff-line-modified-added">+     RefPtr&lt;CSSImageSetValue&gt; imageSet = CSSImageSetValue::create();</span>
      do {
<span class="udiff-line-modified-removed">-         AtomString urlValue = consumeUrlAsStringView(args).toAtomString();</span>
<span class="udiff-line-modified-removed">-         if (urlValue.isNull())</span>
<span class="udiff-line-modified-added">+         auto image = consumeImage(args, context, allowedImageTypes);</span>
<span class="udiff-line-modified-added">+         if (!image)</span>
              return nullptr;
  
<span class="udiff-line-removed">-         RefPtr&lt;CSSValue&gt; image = CSSImageValue::create(completeURL(context, urlValue), context.isContentOpaque ? LoadedFromOpaqueSource::Yes : LoadedFromOpaqueSource::No);</span>
          imageSet-&gt;append(image.releaseNonNull());
  
<span class="udiff-line-modified-removed">-         const CSSParserToken&amp; token = args.consumeIncludingWhitespace();</span>
<span class="udiff-line-modified-removed">-         if (token.type() != DimensionToken)</span>
<span class="udiff-line-removed">-             return nullptr;</span>
<span class="udiff-line-removed">-         if (token.value() != &quot;x&quot;)</span>
<span class="udiff-line-modified-added">+         auto resolution = consumeResolution(args, AllowXResolutionUnit::Allow);</span>
<span class="udiff-line-modified-added">+         if (!resolution || resolution-&gt;floatValue() &lt;= 0)</span>
              return nullptr;
<span class="udiff-line-modified-removed">-         ASSERT(token.unitType() == CSSPrimitiveValue::UnitType::CSS_UNKNOWN);</span>
<span class="udiff-line-modified-removed">-         double imageScaleFactor = token.numericValue();</span>
<span class="udiff-line-removed">-         if (imageScaleFactor &lt;= 0)</span>
<span class="udiff-line-removed">-             return nullptr;</span>
<span class="udiff-line-removed">-         imageSet-&gt;append(CSSValuePool::singleton().createValue(imageScaleFactor, CSSPrimitiveValue::UnitType::CSS_NUMBER));</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         imageSet-&gt;append(resolution.releaseNonNull());</span>
      } while (consumeCommaIncludingWhitespace(args));
      if (!args.atEnd())
          return nullptr;
      range = rangeCopy;
      return imageSet;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1582,11 +1620,11 @@</span>
                  parsedValue = consumeNumber(args, ValueRangeNonNegative);
              if (parsedValue &amp;&amp; !allowsValuesGreaterThanOne(filterType)) {
                  bool isPercentage = downcast&lt;CSSPrimitiveValue&gt;(*parsedValue).isPercentage();
                  double maxAllowed = isPercentage ? 100.0 : 1.0;
                  if (downcast&lt;CSSPrimitiveValue&gt;(*parsedValue).doubleValue() &gt; maxAllowed)
<span class="udiff-line-modified-removed">-                     parsedValue = CSSPrimitiveValue::create(maxAllowed, isPercentage ? CSSPrimitiveValue::UnitType::CSS_PERCENTAGE : CSSPrimitiveValue::UnitType::CSS_NUMBER);</span>
<span class="udiff-line-modified-added">+                     parsedValue = CSSPrimitiveValue::create(maxAllowed, isPercentage ? CSSUnitType::CSS_PERCENTAGE : CSSUnitType::CSS_NUMBER);</span>
              }
          }
      }
      if (!parsedValue || !args.atEnd())
          return nullptr;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1634,20 +1672,24 @@</span>
  
      auto verticalOffset = consumeLength(range, cssParserMode, ValueRangeAll);
      if (!verticalOffset)
          return nullptr;
  
<span class="udiff-line-modified-removed">-     auto blurRadius = consumeLength(range, cssParserMode, ValueRangeAll);</span>
<span class="udiff-line-modified-added">+     RefPtr&lt;CSSPrimitiveValue&gt; blurRadius;</span>
      RefPtr&lt;CSSPrimitiveValue&gt; spreadDistance;
<span class="udiff-line-modified-removed">-     if (blurRadius) {</span>
<span class="udiff-line-modified-removed">-         // Blur radius must be non-negative.</span>
<span class="udiff-line-modified-removed">-         if (blurRadius-&gt;doubleValue() &lt; 0)</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     const CSSParserToken&amp; token = range.peek();</span>
<span class="udiff-line-modified-added">+     // The explicit check for calc() is unfortunate. This is ensuring that we only fail parsing if there is a length, but it fails the range check.</span>
<span class="udiff-line-added">+     if (token.type() == DimensionToken || token.type() == NumberToken || (token.type() == FunctionToken &amp;&amp; CSSCalcValue::isCalcFunction(token.functionId()))) {</span>
<span class="udiff-line-added">+         blurRadius = consumeLength(range, cssParserMode, ValueRangeNonNegative);</span>
<span class="udiff-line-added">+         if (!blurRadius)</span>
              return nullptr;
<span class="udiff-line-removed">-         if (allowSpread)</span>
<span class="udiff-line-removed">-             spreadDistance = consumeLength(range, cssParserMode, ValueRangeAll);</span>
      }
  
<span class="udiff-line-added">+     if (blurRadius &amp;&amp; allowSpread)</span>
<span class="udiff-line-added">+         spreadDistance = consumeLength(range, cssParserMode, ValueRangeAll);</span>
<span class="udiff-line-added">+ </span>
      if (!range.atEnd()) {
          if (!color)
              color = consumeColor(range, cssParserMode);
          if (range.peek().id() == CSSValueInset) {
              if (!allowInset || style)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1657,23 +1699,36 @@</span>
      }
  
      return CSSShadowValue::create(WTFMove(horizontalOffset), WTFMove(verticalOffset), WTFMove(blurRadius), WTFMove(spreadDistance), WTFMove(style), WTFMove(color));
  }
  
<span class="udiff-line-modified-removed">- RefPtr&lt;CSSValue&gt; consumeImage(CSSParserTokenRange&amp; range, CSSParserContext context, ConsumeGeneratedImage generatedImage)</span>
<span class="udiff-line-modified-added">+ RefPtr&lt;CSSValue&gt; consumeImage(CSSParserTokenRange&amp; range, CSSParserContext context, OptionSet&lt;AllowedImageType&gt; allowedImageTypes)</span>
  {
<span class="udiff-line-modified-removed">-     AtomString uri = consumeUrlAsStringView(range).toAtomString();</span>
<span class="udiff-line-modified-removed">-     if (!uri.isNull())</span>
<span class="udiff-line-modified-removed">-         return CSSImageValue::create(completeURL(context, uri), context.isContentOpaque ? LoadedFromOpaqueSource::Yes : LoadedFromOpaqueSource::No);</span>
<span class="udiff-line-modified-added">+     if ((range.peek().type() == StringToken) &amp;&amp; (allowedImageTypes.contains(AllowedImageType::RawStringAsURL))) {</span>
<span class="udiff-line-modified-added">+         auto urlStringView = range.consumeIncludingWhitespace().value();</span>
<span class="udiff-line-modified-added">+         return CSSImageValue::create(completeURL(context, urlStringView.toAtomString()), context.isContentOpaque ? LoadedFromOpaqueSource::Yes : LoadedFromOpaqueSource::No);</span>
<span class="udiff-line-added">+     }</span>
  
      if (range.peek().type() == FunctionToken) {
<span class="udiff-line-modified-removed">-         CSSValueID id = range.peek().functionId();</span>
<span class="udiff-line-modified-removed">-         if (id == CSSValueWebkitImageSet || id == CSSValueImageSet)</span>
<span class="udiff-line-removed">-             return consumeImageSet(range, context);</span>
<span class="udiff-line-removed">-         if (generatedImage == ConsumeGeneratedImage::Allow &amp;&amp; isGeneratedImage(id))</span>
<span class="udiff-line-modified-added">+         CSSValueID functionId = range.peek().functionId();</span>
<span class="udiff-line-modified-added">+         if ((allowedImageTypes.contains(AllowedImageType::GeneratedImage)) &amp;&amp; isGeneratedImage(functionId))</span>
              return consumeGeneratedImage(range, context);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (allowedImageTypes.contains(AllowedImageType::ImageSet)) {</span>
<span class="udiff-line-added">+             if (functionId == CSSValueImageSet)</span>
<span class="udiff-line-added">+                 return consumeImageSet(range, context, (allowedImageTypes | AllowedImageType::RawStringAsURL) - AllowedImageType::ImageSet);</span>
<span class="udiff-line-added">+             if (functionId == CSSValueWebkitImageSet)</span>
<span class="udiff-line-added">+                 return consumeImageSet(range, context, AllowedImageType::URLFunction);</span>
<span class="udiff-line-added">+         }</span>
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (allowedImageTypes.contains(AllowedImageType::URLFunction)) {</span>
<span class="udiff-line-added">+         auto uri = consumeUrlAsStringView(range);</span>
<span class="udiff-line-added">+         if (!uri.isNull())</span>
<span class="udiff-line-added">+             return CSSImageValue::create(completeURL(context, uri.toAtomString()), context.isContentOpaque ? LoadedFromOpaqueSource::Yes : LoadedFromOpaqueSource::No);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      return nullptr;
  }
  
  } // namespace CSSPropertyParserHelpers
  
</pre>
<center><a href="CSSPropertyParser.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="CSSPropertyParserHelpers.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>