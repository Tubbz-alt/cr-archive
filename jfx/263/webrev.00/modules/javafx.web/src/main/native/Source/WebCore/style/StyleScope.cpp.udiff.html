<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/style/StyleScope.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="StyleResolveForDocument.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StyleScope.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/style/StyleScope.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -86,19 +86,19 @@</span>
      if (!m_styleSheetCandidateNodes.isEmpty())
          return false;
      return true;
  }
  
<span class="udiff-line-modified-removed">- StyleResolver&amp; Scope::resolver()</span>
<span class="udiff-line-modified-added">+ Resolver&amp; Scope::resolver()</span>
  {
      if (shouldUseSharedUserAgentShadowTreeStyleResolver())
          return m_document.userAgentShadowTreeStyleResolver();
  
      if (!m_resolver) {
          SetForScope&lt;bool&gt; isUpdatingStyleResolver { m_isUpdatingStyleResolver, true };
  
<span class="udiff-line-modified-removed">-         m_resolver = makeUnique&lt;StyleResolver&gt;(m_document);</span>
<span class="udiff-line-modified-added">+         m_resolver = makeUnique&lt;Resolver&gt;(m_document);</span>
  
          if (!m_shadowRoot) {
              m_document.fontSelector().buildStarted();
              m_resolver-&gt;ruleSets().initializeUserStyle();
          } else {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -115,11 +115,11 @@</span>
      ASSERT(!m_shadowRoot || &amp;m_document == &amp;m_shadowRoot-&gt;document());
      ASSERT(&amp;m_resolver-&gt;document() == &amp;m_document);
      return *m_resolver;
  }
  
<span class="udiff-line-modified-removed">- StyleResolver* Scope::resolverIfExists()</span>
<span class="udiff-line-modified-added">+ Resolver* Scope::resolverIfExists()</span>
  {
      if (shouldUseSharedUserAgentShadowTreeStyleResolver())
          return &amp;m_document.userAgentShadowTreeStyleResolver();
  
      return m_resolver.get();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -379,64 +379,45 @@</span>
          if (sheet)
              sheets.append(WTFMove(sheet));
      }
  }
  
<span class="udiff-line-modified-removed">- Scope::StyleResolverUpdateType Scope::analyzeStyleSheetChange(const Vector&lt;RefPtr&lt;CSSStyleSheet&gt;&gt;&amp; newStylesheets, bool&amp; requiresFullStyleRecalc)</span>
<span class="udiff-line-modified-added">+ Scope::StyleSheetChange Scope::analyzeStyleSheetChange(const Vector&lt;RefPtr&lt;CSSStyleSheet&gt;&gt;&amp; newStylesheets)</span>
  {
<span class="udiff-line-removed">-     requiresFullStyleRecalc = true;</span>
<span class="udiff-line-removed">- </span>
      unsigned newStylesheetCount = newStylesheets.size();
  
      if (!resolverIfExists())
<span class="udiff-line-modified-removed">-         return Reconstruct;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     auto&amp; styleResolver = *resolverIfExists();</span>
<span class="udiff-line-modified-added">+         return { ResolverUpdateType::Reconstruct };</span>
  
      // Find out which stylesheets are new.
      unsigned oldStylesheetCount = m_activeStyleSheets.size();
      if (newStylesheetCount &lt; oldStylesheetCount)
<span class="udiff-line-modified-removed">-         return Reconstruct;</span>
<span class="udiff-line-modified-added">+         return { ResolverUpdateType::Reconstruct };</span>
  
      Vector&lt;StyleSheetContents*&gt; addedSheets;
      unsigned newIndex = 0;
      for (unsigned oldIndex = 0; oldIndex &lt; oldStylesheetCount; ++oldIndex) {
          if (newIndex &gt;= newStylesheetCount)
<span class="udiff-line-modified-removed">-             return Reconstruct;</span>
<span class="udiff-line-modified-added">+             return { ResolverUpdateType::Reconstruct };</span>
<span class="udiff-line-added">+ </span>
          while (m_activeStyleSheets[oldIndex] != newStylesheets[newIndex]) {
              addedSheets.append(&amp;newStylesheets[newIndex]-&gt;contents());
              ++newIndex;
              if (newIndex == newStylesheetCount)
<span class="udiff-line-modified-removed">-                 return Reconstruct;</span>
<span class="udiff-line-modified-added">+                 return { ResolverUpdateType::Reconstruct };</span>
          }
          ++newIndex;
      }
      bool hasInsertions = !addedSheets.isEmpty();
      while (newIndex &lt; newStylesheetCount) {
          addedSheets.append(&amp;newStylesheets[newIndex]-&gt;contents());
          ++newIndex;
      }
<span class="udiff-line-removed">-     // If all new sheets were added at the end of the list we can just add them to existing StyleResolver.</span>
<span class="udiff-line-removed">-     // If there were insertions we need to re-add all the stylesheets so rules are ordered correctly.</span>
<span class="udiff-line-removed">-     auto styleResolverUpdateType = hasInsertions ? Reset : Additive;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // If we are already parsing the body and so may have significant amount of elements, put some effort into trying to avoid style recalcs.</span>
<span class="udiff-line-removed">-     if (!m_document.bodyOrFrameset() || m_document.hasNodesWithNonFinalStyle() || m_document.hasNodesWithMissingStyle())</span>
<span class="udiff-line-removed">-         return styleResolverUpdateType;</span>
  
<span class="udiff-line-modified-removed">-     Invalidator invalidator(addedSheets, styleResolver.mediaQueryEvaluator());</span>
<span class="udiff-line-modified-removed">-     if (invalidator.dirtiesAllStyle())</span>
<span class="udiff-line-modified-removed">-         return styleResolverUpdateType;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (m_shadowRoot)</span>
<span class="udiff-line-removed">-         invalidator.invalidateStyle(*m_shadowRoot);</span>
<span class="udiff-line-removed">-     else</span>
<span class="udiff-line-removed">-         invalidator.invalidateStyle(m_document);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     requiresFullStyleRecalc = false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return styleResolverUpdateType;</span>
<span class="udiff-line-modified-added">+     // If all new sheets were added at the end of the list we can just add them to existing Resolver.</span>
<span class="udiff-line-modified-added">+     // If there were insertions we need to re-add all the stylesheets so rules are ordered correctly.</span>
<span class="udiff-line-modified-added">+     return { hasInsertions ? ResolverUpdateType::Reset : ResolverUpdateType::Additive, WTFMove(addedSheets) };</span>
  }
  
  static void filterEnabledNonemptyCSSStyleSheets(Vector&lt;RefPtr&lt;CSSStyleSheet&gt;&gt;&amp; result, const Vector&lt;RefPtr&lt;StyleSheet&gt;&gt;&amp; sheets)
  {
      for (auto&amp; sheet : sheets) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -451,22 +432,10 @@</span>
              continue;
          result.append(&amp;styleSheet);
      }
  }
  
<span class="udiff-line-removed">- static void invalidateHostAndSlottedStyleIfNeeded(ShadowRoot&amp; shadowRoot, StyleResolver&amp; resolver)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     auto&amp; host = *shadowRoot.host();</span>
<span class="udiff-line-removed">-     if (!resolver.ruleSets().authorStyle().hostPseudoClassRules().isEmpty())</span>
<span class="udiff-line-removed">-         host.invalidateStyle();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!resolver.ruleSets().authorStyle().slottedPseudoElementRules().isEmpty()) {</span>
<span class="udiff-line-removed">-         for (auto&amp; shadowChild : childrenOfType&lt;Element&gt;(host))</span>
<span class="udiff-line-removed">-             shadowChild.invalidateStyle();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  void Scope::updateActiveStyleSheets(UpdateType updateType)
  {
      ASSERT(!m_pendingUpdate);
  
      if (!m_document.hasLivingRenderTree())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -487,16 +456,15 @@</span>
      Vector&lt;RefPtr&lt;CSSStyleSheet&gt;&gt; activeCSSStyleSheets;
      activeCSSStyleSheets.appendVector(m_document.extensionStyleSheets().injectedAuthorStyleSheets());
      activeCSSStyleSheets.appendVector(m_document.extensionStyleSheets().authorStyleSheetsForTesting());
      filterEnabledNonemptyCSSStyleSheets(activeCSSStyleSheets, activeStyleSheets);
  
<span class="udiff-line-modified-removed">-     bool requiresFullStyleRecalc = true;</span>
<span class="udiff-line-removed">-     StyleResolverUpdateType styleResolverUpdateType = Reconstruct;</span>
<span class="udiff-line-modified-added">+     auto styleSheetChange = StyleSheetChange { ResolverUpdateType::Reconstruct };</span>
      if (updateType == UpdateType::ActiveSet)
<span class="udiff-line-modified-removed">-         styleResolverUpdateType = analyzeStyleSheetChange(activeCSSStyleSheets, requiresFullStyleRecalc);</span>
<span class="udiff-line-modified-added">+         styleSheetChange = analyzeStyleSheetChange(activeCSSStyleSheets);</span>
  
<span class="udiff-line-modified-removed">-     updateStyleResolver(activeCSSStyleSheets, styleResolverUpdateType);</span>
<span class="udiff-line-modified-added">+     updateResolver(activeCSSStyleSheets, styleSheetChange.resolverUpdateType);</span>
  
      m_weakCopyOfActiveStyleSheetListForFastLookup = nullptr;
      m_activeStyleSheets.swap(activeCSSStyleSheets);
      m_styleSheetsForStyleSheetList.swap(activeStyleSheets);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -505,35 +473,41 @@</span>
      for (const auto&amp; sheet : m_activeStyleSheets) {
          if (sheet-&gt;contents().usesStyleBasedEditability())
              m_usesStyleBasedEditability = true;
      }
  
<span class="udiff-line-modified-removed">-     // FIXME: Move this code somewhere else.</span>
<span class="udiff-line-modified-removed">-     if (requiresFullStyleRecalc) {</span>
<span class="udiff-line-modified-removed">-         if (m_shadowRoot) {</span>
<span class="udiff-line-modified-removed">-             for (auto&amp; shadowChild : childrenOfType&lt;Element&gt;(*m_shadowRoot))</span>
<span class="udiff-line-modified-removed">-                 shadowChild.invalidateStyleForSubtree();</span>
<span class="udiff-line-modified-removed">-             invalidateHostAndSlottedStyleIfNeeded(*m_shadowRoot, resolver());</span>
<span class="udiff-line-modified-removed">-         } else</span>
<span class="udiff-line-modified-removed">-             m_document.scheduleFullStyleRebuild();</span>
<span class="udiff-line-modified-added">+     invalidateStyleAfterStyleSheetChange(styleSheetChange);</span>
<span class="udiff-line-modified-added">+ }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ void Scope::invalidateStyleAfterStyleSheetChange(const StyleSheetChange&amp; styleSheetChange)</span>
<span class="udiff-line-modified-added">+ {</span>
<span class="udiff-line-modified-added">+     // If we are already parsing the body and so may have significant amount of elements, put some effort into trying to avoid style recalcs.</span>
<span class="udiff-line-modified-added">+     bool invalidateAll = !m_document.bodyOrFrameset() || m_document.hasNodesWithNonFinalStyle() || m_document.hasNodesWithMissingStyle();</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     if (styleSheetChange.resolverUpdateType == ResolverUpdateType::Reconstruct || invalidateAll) {</span>
<span class="udiff-line-added">+         Invalidator::invalidateAllStyle(*this);</span>
<span class="udiff-line-added">+         return;</span>
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     Invalidator invalidator(styleSheetChange.addedSheets, m_resolver-&gt;mediaQueryEvaluator());</span>
<span class="udiff-line-added">+     invalidator.invalidateStyle(*this);</span>
  }
  
<span class="udiff-line-modified-removed">- void Scope::updateStyleResolver(Vector&lt;RefPtr&lt;CSSStyleSheet&gt;&gt;&amp; activeStyleSheets, StyleResolverUpdateType updateType)</span>
<span class="udiff-line-modified-added">+ void Scope::updateResolver(Vector&lt;RefPtr&lt;CSSStyleSheet&gt;&gt;&amp; activeStyleSheets, ResolverUpdateType updateType)</span>
  {
<span class="udiff-line-modified-removed">-     if (updateType == Reconstruct) {</span>
<span class="udiff-line-modified-added">+     if (updateType == ResolverUpdateType::Reconstruct) {</span>
          clearResolver();
          return;
      }
      auto&amp; styleResolver = resolver();
  
      SetForScope&lt;bool&gt; isUpdatingStyleResolver { m_isUpdatingStyleResolver, true };
<span class="udiff-line-modified-removed">-     if (updateType == Reset) {</span>
<span class="udiff-line-modified-added">+     if (updateType == ResolverUpdateType::Reset) {</span>
          styleResolver.ruleSets().resetAuthorStyle();
          styleResolver.appendAuthorStyleSheets(activeStyleSheets);
      } else {
<span class="udiff-line-modified-removed">-         ASSERT(updateType == Additive);</span>
<span class="udiff-line-modified-added">+         ASSERT(updateType == ResolverUpdateType::Additive);</span>
          unsigned firstNewIndex = m_activeStyleSheets.size();
          Vector&lt;RefPtr&lt;CSSStyleSheet&gt;&gt; newStyleSheets;
          newStyleSheets.appendRange(activeStyleSheets.begin() + firstNewIndex, activeStyleSheets.end());
          styleResolver.appendAuthorStyleSheets(newStyleSheets);
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -541,10 +515,14 @@</span>
  
  const Vector&lt;RefPtr&lt;CSSStyleSheet&gt;&gt; Scope::activeStyleSheetsForInspector()
  {
      Vector&lt;RefPtr&lt;CSSStyleSheet&gt;&gt; result;
  
<span class="udiff-line-added">+     if (auto* pageUserSheet = m_document.extensionStyleSheets().pageUserSheet())</span>
<span class="udiff-line-added">+         result.append(pageUserSheet);</span>
<span class="udiff-line-added">+     result.appendVector(m_document.extensionStyleSheets().documentUserStyleSheets());</span>
<span class="udiff-line-added">+     result.appendVector(m_document.extensionStyleSheets().injectedUserStyleSheets());</span>
      result.appendVector(m_document.extensionStyleSheets().injectedAuthorStyleSheets());
      result.appendVector(m_document.extensionStyleSheets().authorStyleSheetsForTesting());
  
      for (auto&amp; styleSheet : m_styleSheetsForStyleSheetList) {
          if (!is&lt;CSSStyleSheet&gt;(*styleSheet))
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -597,15 +575,15 @@</span>
  
  void Scope::scheduleUpdate(UpdateType update)
  {
      if (update == UpdateType::ContentsOrInterpretation) {
          // :host and ::slotted rules might go away.
<span class="udiff-line-modified-removed">-         if (m_shadowRoot &amp;&amp; m_resolver)</span>
<span class="udiff-line-modified-removed">-             invalidateHostAndSlottedStyleIfNeeded(*m_shadowRoot, *m_resolver);</span>
<span class="udiff-line-modified-added">+         if (m_shadowRoot)</span>
<span class="udiff-line-modified-added">+             Invalidator::invalidateHostAndSlottedStyleIfNeeded(*m_shadowRoot);</span>
          // FIXME: Animation code may trigger resource load in middle of style recalc and that can add a rule to a content extension stylesheet.
          //        Fix and remove isResolvingTreeStyle() test below, see https://bugs.webkit.org/show_bug.cgi?id=194335
<span class="udiff-line-modified-removed">-         // FIXME: The m_isUpdatingStyleResolver test is here because extension stylesheets can get us here from StyleResolver::appendAuthorStyleSheets.</span>
<span class="udiff-line-modified-added">+         // FIXME: The m_isUpdatingStyleResolver test is here because extension stylesheets can get us here from Resolver::appendAuthorStyleSheets.</span>
          if (!m_isUpdatingStyleResolver &amp;&amp; !m_document.isResolvingTreeStyle())
              clearResolver();
      }
  
      if (!m_pendingUpdate || *m_pendingUpdate &lt; update) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -619,43 +597,56 @@</span>
      m_pendingUpdateTimer.startOneShot(0_s);
  }
  
  void Scope::evaluateMediaQueriesForViewportChange()
  {
<span class="udiff-line-modified-removed">-     evaluateMediaQueries([] (StyleResolver&amp; resolver) {</span>
<span class="udiff-line-modified-removed">-         return resolver.hasMediaQueriesAffectedByViewportChange();</span>
<span class="udiff-line-modified-added">+     evaluateMediaQueries([] (Resolver&amp; resolver) {</span>
<span class="udiff-line-modified-added">+         return resolver.evaluateDynamicMediaQueries();</span>
      });
  }
  
  void Scope::evaluateMediaQueriesForAccessibilitySettingsChange()
  {
<span class="udiff-line-modified-removed">-     evaluateMediaQueries([] (StyleResolver&amp; resolver) {</span>
<span class="udiff-line-modified-removed">-         return resolver.hasMediaQueriesAffectedByAccessibilitySettingsChange();</span>
<span class="udiff-line-modified-added">+     evaluateMediaQueries([] (Resolver&amp; resolver) {</span>
<span class="udiff-line-modified-added">+         return resolver.evaluateDynamicMediaQueries();</span>
      });
  }
  
  void Scope::evaluateMediaQueriesForAppearanceChange()
  {
<span class="udiff-line-modified-removed">-     evaluateMediaQueries([] (StyleResolver&amp; resolver) {</span>
<span class="udiff-line-modified-removed">-         return resolver.hasMediaQueriesAffectedByAppearanceChange();</span>
<span class="udiff-line-modified-added">+     evaluateMediaQueries([] (Resolver&amp; resolver) {</span>
<span class="udiff-line-modified-added">+         return resolver.evaluateDynamicMediaQueries();</span>
      });
  }
  
  template &lt;typename TestFunction&gt;
  void Scope::evaluateMediaQueries(TestFunction&amp;&amp; testFunction)
  {
<span class="udiff-line-added">+     auto* resolver = resolverIfExists();</span>
<span class="udiff-line-added">+     if (!resolver)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto evaluationChanges = testFunction(*resolver);</span>
<span class="udiff-line-added">+     if (evaluationChanges) {</span>
<span class="udiff-line-added">+         switch (evaluationChanges-&gt;type) {</span>
<span class="udiff-line-added">+         case DynamicMediaQueryEvaluationChanges::Type::InvalidateStyle: {</span>
<span class="udiff-line-added">+             Invalidator invalidator(evaluationChanges-&gt;invalidationRuleSets);</span>
<span class="udiff-line-added">+             invalidator.invalidateStyle(*this);</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         case DynamicMediaQueryEvaluationChanges::Type::ResetStyle:</span>
<span class="udiff-line-added">+             scheduleUpdate(UpdateType::ContentsOrInterpretation);</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         InspectorInstrumentation::mediaQueryResultChanged(m_document);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      if (!m_shadowRoot) {
          for (auto* descendantShadowRoot : m_document.inDocumentShadowRoots())
              descendantShadowRoot-&gt;styleScope().evaluateMediaQueries(testFunction);
      }
<span class="udiff-line-removed">-     auto* resolver = resolverIfExists();</span>
<span class="udiff-line-removed">-     if (!resolver)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     if (!testFunction(*resolver))</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     scheduleUpdate(UpdateType::ContentsOrInterpretation);</span>
<span class="udiff-line-removed">-     InspectorInstrumentation::mediaQueryResultChanged(m_document);</span>
  }
  
  void Scope::didChangeActiveStyleSheetCandidates()
  {
      scheduleUpdate(UpdateType::ActiveSet);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -676,10 +667,22 @@</span>
          }
      }
      scheduleUpdate(UpdateType::ContentsOrInterpretation);
  }
  
<span class="udiff-line-added">+ void Scope::invalidateMatchedDeclarationsCache()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!m_shadowRoot) {</span>
<span class="udiff-line-added">+         for (auto* descendantShadowRoot : m_document.inDocumentShadowRoots())</span>
<span class="udiff-line-added">+             descendantShadowRoot-&gt;styleScope().invalidateMatchedDeclarationsCache();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (auto* resolver = resolverIfExists())</span>
<span class="udiff-line-added">+         resolver-&gt;invalidateMatchedDeclarationsCache();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
  void Scope::pendingUpdateTimerFired()
  {
      flushPendingUpdate();
  }
  
</pre>
<center><a href="StyleResolveForDocument.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="StyleScope.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>