<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSDOMGlobalObject.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSDOMGlobalObject.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSDOMGlobalObjectTask.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSDOMGlobalObject.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 27 #pragma once
 28 
 29 #include &quot;WebCoreJSBuiltinInternals.h&quot;
 30 #include &lt;JavaScriptCore/HeapInlines.h&gt;
 31 #include &lt;JavaScriptCore/JSGlobalObject.h&gt;
 32 #include &lt;JavaScriptCore/JSObjectInlines.h&gt;
 33 #include &lt;JavaScriptCore/LockDuringMarking.h&gt;
 34 
 35 namespace WebCore {
 36 
 37 class DOMGuardedObject;
 38 class Event;
 39 class DOMWrapperWorld;
 40 class ScriptExecutionContext;
 41 
 42 using JSDOMStructureMap = HashMap&lt;const JSC::ClassInfo*, JSC::WriteBarrier&lt;JSC::Structure&gt;&gt;;
 43 using JSDOMConstructorMap = HashMap&lt;const JSC::ClassInfo*, JSC::WriteBarrier&lt;JSC::JSObject&gt;&gt;;
 44 using DOMGuardedObjectSet = HashSet&lt;DOMGuardedObject*&gt;;
 45 
 46 class WEBCORE_EXPORT JSDOMGlobalObject : public JSC::JSGlobalObject {
<span class="line-modified"> 47     using Base = JSC::JSGlobalObject;</span>
<span class="line-removed"> 48 protected:</span>
 49     struct JSDOMGlobalObjectData;
 50 
<span class="line-modified"> 51     JSDOMGlobalObject(JSC::VM&amp;, JSC::Structure*, Ref&lt;DOMWrapperWorld&gt;&amp;&amp;, const JSC::GlobalObjectMethodTable* = nullptr);</span>
<span class="line-modified"> 52     static void destroy(JSC::JSCell*);</span>
<span class="line-modified"> 53     void finishCreation(JSC::VM&amp;);</span>
<span class="line-modified"> 54     void finishCreation(JSC::VM&amp;, JSC::JSObject*);</span>


 55 

 56 public:
 57     Lock&amp; gcLock() { return m_gcLock; }
 58 
 59     JSDOMStructureMap&amp; structures(const AbstractLocker&amp;) { return m_structures; }
 60     JSDOMConstructorMap&amp; constructors(const AbstractLocker&amp;) { return m_constructors; }
 61 
 62     DOMGuardedObjectSet&amp; guardedObjects(const AbstractLocker&amp;) { return m_guardedObjects; }
 63 
 64     ScriptExecutionContext* scriptExecutionContext() const;
 65 
 66     // Make binding code generation easier.
 67     JSDOMGlobalObject* globalObject() { return this; }
 68 
 69     void setCurrentEvent(Event*);
 70     Event* currentEvent() const;
 71 
 72     static void visitChildren(JSC::JSCell*, JSC::SlotVisitor&amp;);
 73 
 74     DOMWrapperWorld&amp; world() { return m_world.get(); }
 75     bool worldIsNormal() const { return m_worldIsNormal; }
 76     static ptrdiff_t offsetOfWorldIsNormal() { return OBJECT_OFFSETOF(JSDOMGlobalObject, m_worldIsNormal); }
 77 
 78     JSBuiltinInternalFunctions&amp; builtinInternalFunctions() { return m_builtinInternalFunctions; }
 79 
<span class="line-removed"> 80 protected:</span>
<span class="line-removed"> 81     static const JSC::ClassInfo s_info;</span>
 82 
 83 public:
 84     ~JSDOMGlobalObject();
 85 
 86     static constexpr const JSC::ClassInfo* info() { return &amp;s_info; }
 87 
 88     static JSC::Structure* createStructure(JSC::VM&amp; vm, JSC::JSValue prototype)
 89     {
 90         return JSC::Structure::create(vm, 0, prototype, JSC::TypeInfo(JSC::GlobalObjectType, StructureFlags), info());
 91     }
 92 
 93 protected:
<span class="line-modified"> 94     static void promiseRejectionTracker(JSC::JSGlobalObject*, JSC::ExecState*, JSC::JSPromise*, JSC::JSPromiseRejectionOperation);</span>




 95 
 96     JSDOMStructureMap m_structures;
 97     JSDOMConstructorMap m_constructors;
 98     DOMGuardedObjectSet m_guardedObjects;
 99 
100     Ref&lt;DOMWrapperWorld&gt; m_world;
101     uint8_t m_worldIsNormal;
102     Lock m_gcLock;
103 
104 private:
105     void addBuiltinGlobals(JSC::VM&amp;);
106     friend void JSBuiltinInternalFunctions::initialize(JSDOMGlobalObject&amp;);
107 
108     Event* m_currentEvent { nullptr };
109 
110     JSBuiltinInternalFunctions m_builtinInternalFunctions;
111 };
112 
113 template&lt;class ConstructorClass&gt;
114 inline JSC::JSObject* getDOMConstructor(JSC::VM&amp; vm, const JSDOMGlobalObject&amp; globalObject)
115 {
116     if (JSC::JSObject* constructor = const_cast&lt;JSDOMGlobalObject&amp;&gt;(globalObject).constructors(NoLockingNecessary).get(ConstructorClass::info()).get())
117         return constructor;
118     JSC::JSObject* constructor = ConstructorClass::create(vm, ConstructorClass::createStructure(vm, const_cast&lt;JSDOMGlobalObject&amp;&gt;(globalObject), ConstructorClass::prototypeForStructure(vm, globalObject)), const_cast&lt;JSDOMGlobalObject&amp;&gt;(globalObject));
119     ASSERT(!const_cast&lt;JSDOMGlobalObject&amp;&gt;(globalObject).constructors(NoLockingNecessary).contains(ConstructorClass::info()));
120     JSC::WriteBarrier&lt;JSC::JSObject&gt; temp;
121     JSDOMGlobalObject&amp; mutableGlobalObject = const_cast&lt;JSDOMGlobalObject&amp;&gt;(globalObject);
122     auto locker = JSC::lockDuringMarking(vm.heap, mutableGlobalObject.gcLock());
123     mutableGlobalObject.constructors(locker).add(ConstructorClass::info(), temp).iterator-&gt;value.set(vm, &amp;globalObject, constructor);
124     return constructor;
125 }
126 
<span class="line-modified">127 WEBCORE_EXPORT JSDOMGlobalObject&amp; callerGlobalObject(JSC::ExecState&amp;);</span>
128 
129 JSDOMGlobalObject* toJSDOMGlobalObject(ScriptExecutionContext&amp;, DOMWrapperWorld&amp;);
130 
131 } // namespace WebCore
</pre>
</td>
<td>
<hr />
<pre>
 27 #pragma once
 28 
 29 #include &quot;WebCoreJSBuiltinInternals.h&quot;
 30 #include &lt;JavaScriptCore/HeapInlines.h&gt;
 31 #include &lt;JavaScriptCore/JSGlobalObject.h&gt;
 32 #include &lt;JavaScriptCore/JSObjectInlines.h&gt;
 33 #include &lt;JavaScriptCore/LockDuringMarking.h&gt;
 34 
 35 namespace WebCore {
 36 
 37 class DOMGuardedObject;
 38 class Event;
 39 class DOMWrapperWorld;
 40 class ScriptExecutionContext;
 41 
 42 using JSDOMStructureMap = HashMap&lt;const JSC::ClassInfo*, JSC::WriteBarrier&lt;JSC::Structure&gt;&gt;;
 43 using JSDOMConstructorMap = HashMap&lt;const JSC::ClassInfo*, JSC::WriteBarrier&lt;JSC::JSObject&gt;&gt;;
 44 using DOMGuardedObjectSet = HashSet&lt;DOMGuardedObject*&gt;;
 45 
 46 class WEBCORE_EXPORT JSDOMGlobalObject : public JSC::JSGlobalObject {
<span class="line-modified"> 47 public:</span>

 48     struct JSDOMGlobalObjectData;
 49 
<span class="line-modified"> 50     using Base = JSC::JSGlobalObject;</span>
<span class="line-modified"> 51 </span>
<span class="line-modified"> 52     static const JSC::ClassInfo s_info;</span>
<span class="line-modified"> 53 </span>
<span class="line-added"> 54     template&lt;typename, JSC::SubspaceAccess&gt;</span>
<span class="line-added"> 55     static void subspaceFor(JSC::VM&amp;) { RELEASE_ASSERT_NOT_REACHED(); }</span>
 56 
<span class="line-added"> 57     static void destroy(JSC::JSCell*);</span>
 58 public:
 59     Lock&amp; gcLock() { return m_gcLock; }
 60 
 61     JSDOMStructureMap&amp; structures(const AbstractLocker&amp;) { return m_structures; }
 62     JSDOMConstructorMap&amp; constructors(const AbstractLocker&amp;) { return m_constructors; }
 63 
 64     DOMGuardedObjectSet&amp; guardedObjects(const AbstractLocker&amp;) { return m_guardedObjects; }
 65 
 66     ScriptExecutionContext* scriptExecutionContext() const;
 67 
 68     // Make binding code generation easier.
 69     JSDOMGlobalObject* globalObject() { return this; }
 70 
 71     void setCurrentEvent(Event*);
 72     Event* currentEvent() const;
 73 
 74     static void visitChildren(JSC::JSCell*, JSC::SlotVisitor&amp;);
 75 
 76     DOMWrapperWorld&amp; world() { return m_world.get(); }
 77     bool worldIsNormal() const { return m_worldIsNormal; }
 78     static ptrdiff_t offsetOfWorldIsNormal() { return OBJECT_OFFSETOF(JSDOMGlobalObject, m_worldIsNormal); }
 79 
 80     JSBuiltinInternalFunctions&amp; builtinInternalFunctions() { return m_builtinInternalFunctions; }
 81 


 82 
 83 public:
 84     ~JSDOMGlobalObject();
 85 
 86     static constexpr const JSC::ClassInfo* info() { return &amp;s_info; }
 87 
 88     static JSC::Structure* createStructure(JSC::VM&amp; vm, JSC::JSValue prototype)
 89     {
 90         return JSC::Structure::create(vm, 0, prototype, JSC::TypeInfo(JSC::GlobalObjectType, StructureFlags), info());
 91     }
 92 
 93 protected:
<span class="line-modified"> 94     JSDOMGlobalObject(JSC::VM&amp;, JSC::Structure*, Ref&lt;DOMWrapperWorld&gt;&amp;&amp;, const JSC::GlobalObjectMethodTable* = nullptr);</span>
<span class="line-added"> 95     void finishCreation(JSC::VM&amp;);</span>
<span class="line-added"> 96     void finishCreation(JSC::VM&amp;, JSC::JSObject*);</span>
<span class="line-added"> 97 </span>
<span class="line-added"> 98     static void promiseRejectionTracker(JSC::JSGlobalObject*, JSC::JSPromise*, JSC::JSPromiseRejectionOperation);</span>
 99 
100     JSDOMStructureMap m_structures;
101     JSDOMConstructorMap m_constructors;
102     DOMGuardedObjectSet m_guardedObjects;
103 
104     Ref&lt;DOMWrapperWorld&gt; m_world;
105     uint8_t m_worldIsNormal;
106     Lock m_gcLock;
107 
108 private:
109     void addBuiltinGlobals(JSC::VM&amp;);
110     friend void JSBuiltinInternalFunctions::initialize(JSDOMGlobalObject&amp;);
111 
112     Event* m_currentEvent { nullptr };
113 
114     JSBuiltinInternalFunctions m_builtinInternalFunctions;
115 };
116 
117 template&lt;class ConstructorClass&gt;
118 inline JSC::JSObject* getDOMConstructor(JSC::VM&amp; vm, const JSDOMGlobalObject&amp; globalObject)
119 {
120     if (JSC::JSObject* constructor = const_cast&lt;JSDOMGlobalObject&amp;&gt;(globalObject).constructors(NoLockingNecessary).get(ConstructorClass::info()).get())
121         return constructor;
122     JSC::JSObject* constructor = ConstructorClass::create(vm, ConstructorClass::createStructure(vm, const_cast&lt;JSDOMGlobalObject&amp;&gt;(globalObject), ConstructorClass::prototypeForStructure(vm, globalObject)), const_cast&lt;JSDOMGlobalObject&amp;&gt;(globalObject));
123     ASSERT(!const_cast&lt;JSDOMGlobalObject&amp;&gt;(globalObject).constructors(NoLockingNecessary).contains(ConstructorClass::info()));
124     JSC::WriteBarrier&lt;JSC::JSObject&gt; temp;
125     JSDOMGlobalObject&amp; mutableGlobalObject = const_cast&lt;JSDOMGlobalObject&amp;&gt;(globalObject);
126     auto locker = JSC::lockDuringMarking(vm.heap, mutableGlobalObject.gcLock());
127     mutableGlobalObject.constructors(locker).add(ConstructorClass::info(), temp).iterator-&gt;value.set(vm, &amp;globalObject, constructor);
128     return constructor;
129 }
130 
<span class="line-modified">131 WEBCORE_EXPORT JSDOMGlobalObject&amp; callerGlobalObject(JSC::JSGlobalObject&amp;, JSC::CallFrame&amp;);</span>
132 
133 JSDOMGlobalObject* toJSDOMGlobalObject(ScriptExecutionContext&amp;, DOMWrapperWorld&amp;);
134 
135 } // namespace WebCore
</pre>
</td>
</tr>
</table>
<center><a href="JSDOMGlobalObject.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSDOMGlobalObjectTask.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>