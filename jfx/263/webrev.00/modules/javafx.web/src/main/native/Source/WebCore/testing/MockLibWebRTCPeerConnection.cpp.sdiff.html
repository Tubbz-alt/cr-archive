<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/testing/MockLibWebRTCPeerConnection.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MockContentFilter.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MockLibWebRTCPeerConnection.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/testing/MockLibWebRTCPeerConnection.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 15  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 16  * DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 17  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 18  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 19  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 20  * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 21  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 22  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 23  */
 24 
 25 #include &quot;config.h&quot;
 26 #include &quot;MockLibWebRTCPeerConnection.h&quot;
 27 
 28 #if USE(LIBWEBRTC)
 29 
 30 #include &quot;LibWebRTCProvider.h&quot;
 31 #include &lt;sstream&gt;
<span class="line-modified"> 32 #include &lt;webrtc/pc/mediastream.h&gt;</span>
 33 #include &lt;wtf/Function.h&gt;
 34 #include &lt;wtf/MainThread.h&gt;
 35 #include &lt;wtf/NeverDestroyed.h&gt;
 36 #include &lt;wtf/Threading.h&gt;
 37 
 38 namespace WebCore {
 39 
 40 static inline rtc::scoped_refptr&lt;webrtc::PeerConnectionFactoryInterface&gt;&amp; getRealPeerConnectionFactory()
 41 {
 42     static NeverDestroyed&lt;rtc::scoped_refptr&lt;webrtc::PeerConnectionFactoryInterface&gt;&gt; realPeerConnectionFactory;
 43     return realPeerConnectionFactory;
 44 }
 45 
 46 static inline webrtc::PeerConnectionFactoryInterface* realPeerConnectionFactory()
 47 {
 48     return getRealPeerConnectionFactory().get();
 49 }
 50 
 51 void useRealRTCPeerConnectionFactory(LibWebRTCProvider&amp; provider)
 52 {
</pre>
<hr />
<pre>
 61 {
 62     if (!provider)
 63         return;
 64 
 65     if (!realPeerConnectionFactory()) {
 66         auto&amp; factory = getRealPeerConnectionFactory();
 67         factory = provider-&gt;factory();
 68     }
 69     provider-&gt;setPeerConnectionFactory(MockLibWebRTCPeerConnectionFactory::create(testCase));
 70 }
 71 
 72 MockLibWebRTCPeerConnection::~MockLibWebRTCPeerConnection()
 73 {
 74     // Free senders and receivers in a different thread like an actual peer connection would probably do.
 75     Thread::create(&quot;MockLibWebRTCPeerConnection thread&quot;, [transceivers = WTFMove(m_transceivers)] { });
 76 }
 77 
 78 std::vector&lt;rtc::scoped_refptr&lt;webrtc::RtpTransceiverInterface&gt;&gt; MockLibWebRTCPeerConnection::GetTransceivers() const
 79 {
 80     std::vector&lt;rtc::scoped_refptr&lt;webrtc::RtpTransceiverInterface&gt;&gt; transceivers;
<span class="line-modified"> 81     for (auto transceiver : m_transceivers)</span>

 82         transceivers.push_back(transceiver);
 83     return transceivers;
 84 }
 85 
 86 class MockLibWebRTCPeerConnectionForIceCandidates : public MockLibWebRTCPeerConnection {
 87 public:
 88     explicit MockLibWebRTCPeerConnectionForIceCandidates(webrtc::PeerConnectionObserver&amp; observer) : MockLibWebRTCPeerConnection(observer) { }
 89     virtual ~MockLibWebRTCPeerConnectionForIceCandidates() = default;
 90 private:
 91     void gotLocalDescription() final;
 92 };
 93 
 94 void MockLibWebRTCPeerConnectionForIceCandidates::gotLocalDescription()
 95 {
 96     // Let&#39;s gather candidates
 97     LibWebRTCProvider::callOnWebRTCSignalingThread([this]() {
 98         MockLibWebRTCIceCandidate candidate(&quot;2013266431 1 udp 2013266432 192.168.0.100 38838 typ host generation 0&quot;, &quot;1&quot;);
 99         m_observer.OnIceCandidate(&amp;candidate);
100     });
101     LibWebRTCProvider::callOnWebRTCSignalingThread([this]() {
</pre>
</td>
<td>
<hr />
<pre>
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 15  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 16  * DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 17  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 18  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 19  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 20  * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 21  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 22  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 23  */
 24 
 25 #include &quot;config.h&quot;
 26 #include &quot;MockLibWebRTCPeerConnection.h&quot;
 27 
 28 #if USE(LIBWEBRTC)
 29 
 30 #include &quot;LibWebRTCProvider.h&quot;
 31 #include &lt;sstream&gt;
<span class="line-modified"> 32 #include &lt;webrtc/pc/media_stream.h&gt;</span>
 33 #include &lt;wtf/Function.h&gt;
 34 #include &lt;wtf/MainThread.h&gt;
 35 #include &lt;wtf/NeverDestroyed.h&gt;
 36 #include &lt;wtf/Threading.h&gt;
 37 
 38 namespace WebCore {
 39 
 40 static inline rtc::scoped_refptr&lt;webrtc::PeerConnectionFactoryInterface&gt;&amp; getRealPeerConnectionFactory()
 41 {
 42     static NeverDestroyed&lt;rtc::scoped_refptr&lt;webrtc::PeerConnectionFactoryInterface&gt;&gt; realPeerConnectionFactory;
 43     return realPeerConnectionFactory;
 44 }
 45 
 46 static inline webrtc::PeerConnectionFactoryInterface* realPeerConnectionFactory()
 47 {
 48     return getRealPeerConnectionFactory().get();
 49 }
 50 
 51 void useRealRTCPeerConnectionFactory(LibWebRTCProvider&amp; provider)
 52 {
</pre>
<hr />
<pre>
 61 {
 62     if (!provider)
 63         return;
 64 
 65     if (!realPeerConnectionFactory()) {
 66         auto&amp; factory = getRealPeerConnectionFactory();
 67         factory = provider-&gt;factory();
 68     }
 69     provider-&gt;setPeerConnectionFactory(MockLibWebRTCPeerConnectionFactory::create(testCase));
 70 }
 71 
 72 MockLibWebRTCPeerConnection::~MockLibWebRTCPeerConnection()
 73 {
 74     // Free senders and receivers in a different thread like an actual peer connection would probably do.
 75     Thread::create(&quot;MockLibWebRTCPeerConnection thread&quot;, [transceivers = WTFMove(m_transceivers)] { });
 76 }
 77 
 78 std::vector&lt;rtc::scoped_refptr&lt;webrtc::RtpTransceiverInterface&gt;&gt; MockLibWebRTCPeerConnection::GetTransceivers() const
 79 {
 80     std::vector&lt;rtc::scoped_refptr&lt;webrtc::RtpTransceiverInterface&gt;&gt; transceivers;
<span class="line-modified"> 81     transceivers.reserve(m_transceivers.size());</span>
<span class="line-added"> 82     for (const auto&amp; transceiver : m_transceivers)</span>
 83         transceivers.push_back(transceiver);
 84     return transceivers;
 85 }
 86 
 87 class MockLibWebRTCPeerConnectionForIceCandidates : public MockLibWebRTCPeerConnection {
 88 public:
 89     explicit MockLibWebRTCPeerConnectionForIceCandidates(webrtc::PeerConnectionObserver&amp; observer) : MockLibWebRTCPeerConnection(observer) { }
 90     virtual ~MockLibWebRTCPeerConnectionForIceCandidates() = default;
 91 private:
 92     void gotLocalDescription() final;
 93 };
 94 
 95 void MockLibWebRTCPeerConnectionForIceCandidates::gotLocalDescription()
 96 {
 97     // Let&#39;s gather candidates
 98     LibWebRTCProvider::callOnWebRTCSignalingThread([this]() {
 99         MockLibWebRTCIceCandidate candidate(&quot;2013266431 1 udp 2013266432 192.168.0.100 38838 typ host generation 0&quot;, &quot;1&quot;);
100         m_observer.OnIceCandidate(&amp;candidate);
101     });
102     LibWebRTCProvider::callOnWebRTCSignalingThread([this]() {
</pre>
</td>
</tr>
</table>
<center><a href="MockContentFilter.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MockLibWebRTCPeerConnection.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>