<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/webgpu/WebGPUDevice.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WebGPUComputePipelineDescriptor.idl.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebGPUDevice.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/webgpu/WebGPUDevice.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,26 +26,34 @@</span>
  #include &quot;config.h&quot;
  #include &quot;WebGPUDevice.h&quot;
  
  #if ENABLE(WEBGPU)
  
<span class="udiff-line-added">+ #include &quot;DOMWindow.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;Document.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;EventNames.h&quot;</span>
  #include &quot;Exception.h&quot;
  #include &quot;GPUBindGroup.h&quot;
  #include &quot;GPUBindGroupBinding.h&quot;
  #include &quot;GPUBindGroupDescriptor.h&quot;
  #include &quot;GPUBindGroupLayoutDescriptor.h&quot;
  #include &quot;GPUBufferBinding.h&quot;
  #include &quot;GPUBufferDescriptor.h&quot;
  #include &quot;GPUCommandBuffer.h&quot;
<span class="udiff-line-added">+ #include &quot;GPUComputePipeline.h&quot;</span>
  #include &quot;GPUComputePipelineDescriptor.h&quot;
<span class="udiff-line-modified-removed">- #include &quot;GPUPipelineStageDescriptor.h&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;GPUProgrammableStageDescriptor.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;GPURenderPipeline.h&quot;</span>
  #include &quot;GPURenderPipelineDescriptor.h&quot;
  #include &quot;GPUSampler.h&quot;
  #include &quot;GPUSamplerDescriptor.h&quot;
  #include &quot;GPUShaderModuleDescriptor.h&quot;
  #include &quot;GPUTextureDescriptor.h&quot;
<span class="udiff-line-added">+ #include &quot;GPUUncapturedErrorEvent.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;InspectorInstrumentation.h&quot;</span>
  #include &quot;JSDOMConvertBufferSource.h&quot;
<span class="udiff-line-added">+ #include &quot;JSDOMPromiseDeferred.h&quot;</span>
  #include &quot;JSGPUOutOfMemoryError.h&quot;
  #include &quot;JSGPUValidationError.h&quot;
  #include &quot;JSWebGPUBuffer.h&quot;
  #include &quot;Logging.h&quot;
  #include &quot;WebGPUBindGroup.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -54,62 +62,124 @@</span>
  #include &quot;WebGPUBindGroupLayout.h&quot;
  #include &quot;WebGPUBufferBinding.h&quot;
  #include &quot;WebGPUCommandEncoder.h&quot;
  #include &quot;WebGPUComputePipeline.h&quot;
  #include &quot;WebGPUComputePipelineDescriptor.h&quot;
<span class="udiff-line-added">+ #include &quot;WebGPUPipeline.h&quot;</span>
  #include &quot;WebGPUPipelineLayout.h&quot;
  #include &quot;WebGPUPipelineLayoutDescriptor.h&quot;
<span class="udiff-line-modified-removed">- #include &quot;WebGPUPipelineStageDescriptor.h&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;WebGPUProgrammableStageDescriptor.h&quot;</span>
  #include &quot;WebGPUQueue.h&quot;
  #include &quot;WebGPURenderPipeline.h&quot;
  #include &quot;WebGPURenderPipelineDescriptor.h&quot;
  #include &quot;WebGPUSampler.h&quot;
  #include &quot;WebGPUShaderModule.h&quot;
  #include &quot;WebGPUShaderModuleDescriptor.h&quot;
  #include &quot;WebGPUSwapChain.h&quot;
  #include &quot;WebGPUTexture.h&quot;
<span class="udiff-line-added">+ #include &lt;JavaScriptCore/ConsoleMessage.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;memory&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/HashSet.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/IsoMallocInlines.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/Lock.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/MainThread.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/NeverDestroyed.h&gt;</span>
  #include &lt;wtf/Optional.h&gt;
<span class="udiff-line-added">+ #include &lt;wtf/Ref.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/RefPtr.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/Variant.h&gt;</span>
<span class="udiff-line-added">+ #include &lt;wtf/Vector.h&gt;</span>
  #include &lt;wtf/text/WTFString.h&gt;
  
  namespace WebCore {
  
<span class="udiff-line-modified-removed">- RefPtr&lt;WebGPUDevice&gt; WebGPUDevice::tryCreate(Ref&lt;const WebGPUAdapter&gt;&amp;&amp; adapter)</span>
<span class="udiff-line-modified-added">+ WTF_MAKE_ISO_ALLOCATED_IMPL(WebGPUDevice);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ RefPtr&lt;WebGPUDevice&gt; WebGPUDevice::tryCreate(ScriptExecutionContext&amp; context, Ref&lt;const WebGPUAdapter&gt;&amp;&amp; adapter)</span>
  {
      if (auto device = GPUDevice::tryCreate(adapter-&gt;options()))
<span class="udiff-line-modified-removed">-         return adoptRef(new WebGPUDevice(WTFMove(adapter), device.releaseNonNull()));</span>
<span class="udiff-line-modified-added">+         return adoptRef(new WebGPUDevice(context, WTFMove(adapter), device.releaseNonNull()));</span>
      return nullptr;
  }
  
<span class="udiff-line-modified-removed">- WebGPUDevice::WebGPUDevice(Ref&lt;const WebGPUAdapter&gt;&amp;&amp; adapter, Ref&lt;GPUDevice&gt;&amp;&amp; device)</span>
<span class="udiff-line-modified-removed">-     : m_adapter(WTFMove(adapter))</span>
<span class="udiff-line-modified-added">+ HashSet&lt;WebGPUDevice*&gt;&amp; WebGPUDevice::instances(const LockHolder&amp;)</span>
<span class="udiff-line-modified-added">+ {</span>
<span class="udiff-line-added">+     static NeverDestroyed&lt;HashSet&lt;WebGPUDevice*&gt;&gt; instances;</span>
<span class="udiff-line-added">+     return instances;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ Lock&amp; WebGPUDevice::instancesMutex()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     static LazyNeverDestroyed&lt;Lock&gt; mutex;</span>
<span class="udiff-line-added">+     static std::once_flag initializeMutex;</span>
<span class="udiff-line-added">+     std::call_once(initializeMutex, [] {</span>
<span class="udiff-line-added">+         mutex.construct();</span>
<span class="udiff-line-added">+     });</span>
<span class="udiff-line-added">+     return mutex.get();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ WebGPUDevice::WebGPUDevice(ScriptExecutionContext&amp; context, Ref&lt;const WebGPUAdapter&gt;&amp;&amp; adapter, Ref&lt;GPUDevice&gt;&amp;&amp; device)</span>
<span class="udiff-line-added">+     : m_scriptExecutionContext(context)</span>
<span class="udiff-line-added">+     , m_adapter(WTFMove(adapter))</span>
      , m_device(WTFMove(device))
<span class="udiff-line-modified-removed">-     , m_errorScopes(GPUErrorScopes::create())</span>
<span class="udiff-line-modified-added">+     , m_errorScopes(GPUErrorScopes::create([this, weakThis = makeWeakPtr(this)] (GPUError&amp;&amp; error) {</span>
<span class="udiff-line-added">+         if (weakThis)</span>
<span class="udiff-line-added">+             dispatchUncapturedError(WTFMove(error));</span>
<span class="udiff-line-added">+     }))</span>
  {
<span class="udiff-line-added">+     ASSERT(m_scriptExecutionContext.isDocument());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         LockHolder lock(instancesMutex());</span>
<span class="udiff-line-added">+         instances(lock).add(this);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ WebGPUDevice::~WebGPUDevice()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     InspectorInstrumentation::willDestroyWebGPUDevice(*this);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         LockHolder lock(WebGPUPipeline::instancesMutex());</span>
<span class="udiff-line-added">+         for (auto&amp; entry : WebGPUPipeline::instances(lock)) {</span>
<span class="udiff-line-added">+             if (entry.value == this) {</span>
<span class="udiff-line-added">+                 // Don&#39;t remove any WebGPUPipeline from the instances list, as they may still exist.</span>
<span class="udiff-line-added">+                 // Only remove the association with a WebGPU device.</span>
<span class="udiff-line-added">+                 entry.value = nullptr;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         LockHolder lock(instancesMutex());</span>
<span class="udiff-line-added">+         ASSERT(instances(lock).contains(this));</span>
<span class="udiff-line-added">+         instances(lock).remove(this);</span>
<span class="udiff-line-added">+     }</span>
  }
  
  Ref&lt;WebGPUBuffer&gt; WebGPUDevice::createBuffer(const GPUBufferDescriptor&amp; descriptor) const
  {
      m_errorScopes-&gt;setErrorPrefix(&quot;GPUDevice.createBuffer(): &quot;);
  
      auto buffer = m_device-&gt;tryCreateBuffer(descriptor, GPUBufferMappedOption::NotMapped, m_errorScopes);
      return WebGPUBuffer::create(WTFMove(buffer), m_errorScopes);
  }
  
<span class="udiff-line-modified-removed">- Vector&lt;JSC::JSValue&gt; WebGPUDevice::createBufferMapped(JSC::ExecState&amp; state, const GPUBufferDescriptor&amp; descriptor) const</span>
<span class="udiff-line-modified-added">+ Vector&lt;JSC::JSValue&gt; WebGPUDevice::createBufferMapped(JSC::JSGlobalObject&amp; lexicalGlobalObject, const GPUBufferDescriptor&amp; descriptor) const</span>
  {
      m_errorScopes-&gt;setErrorPrefix(&quot;GPUDevice.createBufferMapped(): &quot;);
  
      JSC::JSValue wrappedArrayBuffer = JSC::jsNull();
  
      auto buffer = m_device-&gt;tryCreateBuffer(descriptor, GPUBufferMappedOption::IsMapped, m_errorScopes);
      if (buffer) {
          auto arrayBuffer = buffer-&gt;mapOnCreation();
<span class="udiff-line-modified-removed">-         wrappedArrayBuffer = toJS(&amp;state, JSC::jsCast&lt;JSDOMGlobalObject*&gt;(state.lexicalGlobalObject()), arrayBuffer);</span>
<span class="udiff-line-modified-added">+         wrappedArrayBuffer = toJS(&amp;lexicalGlobalObject, JSC::jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject), arrayBuffer);</span>
      }
  
      auto webBuffer = WebGPUBuffer::create(WTFMove(buffer), m_errorScopes);
<span class="udiff-line-modified-removed">-     auto wrappedWebBuffer = toJS(&amp;state, JSC::jsCast&lt;JSDOMGlobalObject*&gt;(state.lexicalGlobalObject()), webBuffer);</span>
<span class="udiff-line-modified-added">+     auto wrappedWebBuffer = toJS(&amp;lexicalGlobalObject, JSC::jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject), webBuffer);</span>
  
      return { wrappedWebBuffer, wrappedArrayBuffer };
  }
  
  Ref&lt;WebGPUTexture&gt; WebGPUDevice::createTexture(const GPUTextureDescriptor&amp; descriptor) const
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -152,35 +222,51 @@</span>
  
  Ref&lt;WebGPUShaderModule&gt; WebGPUDevice::createShaderModule(const WebGPUShaderModuleDescriptor&amp; descriptor) const
  {
      // FIXME: What can be validated here?
      auto module = m_device-&gt;tryCreateShaderModule(GPUShaderModuleDescriptor { descriptor.code });
<span class="udiff-line-modified-removed">-     return WebGPUShaderModule::create(WTFMove(module));</span>
<span class="udiff-line-modified-added">+     return WebGPUShaderModule::create(WTFMove(module), descriptor.code);</span>
  }
  
<span class="udiff-line-modified-removed">- Ref&lt;WebGPURenderPipeline&gt; WebGPUDevice::createRenderPipeline(const WebGPURenderPipelineDescriptor&amp; descriptor) const</span>
<span class="udiff-line-modified-added">+ Ref&lt;WebGPURenderPipeline&gt; WebGPUDevice::createRenderPipeline(const WebGPURenderPipelineDescriptor&amp; descriptor)</span>
  {
      m_errorScopes-&gt;setErrorPrefix(&quot;GPUDevice.createRenderPipeline(): &quot;);
  
      auto gpuDescriptor = descriptor.tryCreateGPURenderPipelineDescriptor(m_errorScopes);
      if (!gpuDescriptor)
<span class="udiff-line-modified-removed">-         return WebGPURenderPipeline::create(nullptr);</span>
<span class="udiff-line-modified-added">+         return WebGPURenderPipeline::create(*this, nullptr, m_errorScopes, { }, { });</span>
  
<span class="udiff-line-modified-removed">-     auto pipeline = m_device-&gt;tryCreateRenderPipeline(*gpuDescriptor, m_errorScopes);</span>
<span class="udiff-line-modified-removed">-     return WebGPURenderPipeline::create(WTFMove(pipeline));</span>
<span class="udiff-line-modified-added">+     auto gpuPipeline = m_device-&gt;tryCreateRenderPipeline(*gpuDescriptor, m_errorScopes);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     WebGPUPipeline::ShaderData vertexShader = { descriptor.vertexStage.module, descriptor.vertexStage.entryPoint };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     WebGPUPipeline::ShaderData fragmentShader;</span>
<span class="udiff-line-added">+     if (descriptor.fragmentStage)</span>
<span class="udiff-line-added">+         fragmentShader = { descriptor.fragmentStage.value().module, descriptor.fragmentStage.value().entryPoint };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto webGPUPipeline = WebGPURenderPipeline::create(*this, WTFMove(gpuPipeline), m_errorScopes, WTFMove(vertexShader), WTFMove(fragmentShader));</span>
<span class="udiff-line-added">+     if (webGPUPipeline-&gt;isValid())</span>
<span class="udiff-line-added">+         InspectorInstrumentation::didCreateWebGPUPipeline(*this, webGPUPipeline.get());</span>
<span class="udiff-line-added">+     return webGPUPipeline;</span>
  }
  
<span class="udiff-line-modified-removed">- Ref&lt;WebGPUComputePipeline&gt; WebGPUDevice::createComputePipeline(const WebGPUComputePipelineDescriptor&amp; descriptor) const</span>
<span class="udiff-line-modified-added">+ Ref&lt;WebGPUComputePipeline&gt; WebGPUDevice::createComputePipeline(const WebGPUComputePipelineDescriptor&amp; descriptor)</span>
  {
      m_errorScopes-&gt;setErrorPrefix(&quot;GPUDevice.createComputePipeline(): &quot;);
  
      auto gpuDescriptor = descriptor.tryCreateGPUComputePipelineDescriptor(m_errorScopes);
      if (!gpuDescriptor)
<span class="udiff-line-modified-removed">-         return WebGPUComputePipeline::create(nullptr);</span>
<span class="udiff-line-modified-added">+         return WebGPUComputePipeline::create(*this, nullptr, m_errorScopes, { });</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto gpuPipeline = m_device-&gt;tryCreateComputePipeline(*gpuDescriptor, m_errorScopes);</span>
  
<span class="udiff-line-modified-removed">-     auto pipeline = m_device-&gt;tryCreateComputePipeline(*gpuDescriptor, m_errorScopes);</span>
<span class="udiff-line-modified-removed">-     return WebGPUComputePipeline::create(WTFMove(pipeline));</span>
<span class="udiff-line-modified-added">+     WebGPUPipeline::ShaderData computeShader = { descriptor.computeStage.module, descriptor.computeStage.entryPoint };</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     auto webGPUPipeline = WebGPUComputePipeline::create(*this, WTFMove(gpuPipeline), m_errorScopes, WTFMove(computeShader));</span>
<span class="udiff-line-added">+     if (webGPUPipeline-&gt;isValid())</span>
<span class="udiff-line-added">+         InspectorInstrumentation::didCreateWebGPUPipeline(*this, webGPUPipeline.get());</span>
<span class="udiff-line-added">+     return webGPUPipeline;</span>
  }
  
  Ref&lt;WebGPUCommandEncoder&gt; WebGPUDevice::createCommandEncoder() const
  {
      auto commandBuffer = m_device-&gt;tryCreateCommandBuffer();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -203,8 +289,33 @@</span>
          promise.resolve(error);
      else
          promise.reject(Exception { OperationError, &quot;GPUDevice::popErrorScope(): &quot; + failMessage });
  }
  
<span class="udiff-line-added">+ // Errors reported via the validation error event should also appear in the console as warnings.</span>
<span class="udiff-line-added">+ static void printValidationErrorToConsole(GPUError&amp; error, ScriptExecutionContext&amp; context)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!WTF::holds_alternative&lt;RefPtr&lt;GPUValidationError&gt;&gt;(error))</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto validationError = WTF::get&lt;RefPtr&lt;GPUValidationError&gt;&gt;(error);</span>
<span class="udiff-line-added">+     if (!validationError)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto message = validationError-&gt;message();</span>
<span class="udiff-line-added">+     auto consoleMessage = makeUnique&lt;Inspector::ConsoleMessage&gt;(MessageSource::Rendering, MessageType::Log, MessageLevel::Warning, message);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     downcast&lt;Document&gt;(context).addConsoleMessage(WTFMove(consoleMessage));</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void WebGPUDevice::dispatchUncapturedError(GPUError&amp;&amp; error)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     printValidationErrorToConsole(error, m_scriptExecutionContext);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     callOnMainThread([error = WTFMove(error), this, protectedThis = makeRef(*this)] () mutable {</span>
<span class="udiff-line-added">+         dispatchEvent(GPUUncapturedErrorEvent::create(eventNames().uncapturederrorEvent, WTFMove(error)));</span>
<span class="udiff-line-added">+     });</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  } // namespace WebCore
  
  #endif // ENABLE(WEBGPU)
</pre>
<center><a href="WebGPUComputePipelineDescriptor.idl.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebGPUDevice.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>