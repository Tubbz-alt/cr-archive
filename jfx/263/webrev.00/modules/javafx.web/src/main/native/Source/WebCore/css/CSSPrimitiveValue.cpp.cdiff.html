<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/css/CSSPrimitiveValue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CSSNamedImageValue.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CSSPrimitiveValue.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/css/CSSPrimitiveValue.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 35,226 ***</span>
  #include &quot;Counter.h&quot;
  #include &quot;DeprecatedCSSOMPrimitiveValue.h&quot;
  #include &quot;FontCascade.h&quot;
  #include &quot;Node.h&quot;
  #include &quot;Pair.h&quot;
<span class="line-removed">- #include &quot;RGBColor.h&quot;</span>
  #include &quot;Rect.h&quot;
  #include &quot;RenderStyle.h&quot;
  #include &lt;wtf/NeverDestroyed.h&gt;
  #include &lt;wtf/StdLibExtras.h&gt;
  #include &lt;wtf/text/StringBuilder.h&gt;
  #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  
  namespace WebCore {
  
<span class="line-modified">! static inline bool isValidCSSUnitTypeForDoubleConversion(CSSPrimitiveValue::UnitType unitType)</span>
  {
      switch (unitType) {
<span class="line-modified">!     case CSSPrimitiveValue::CSS_CALC:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_CHS:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_CM:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_DEG:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_DIMENSION:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_EMS:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_QUIRKY_EMS:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_EXS:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_FR:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_GRAD:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_HZ:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_IN:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_KHZ:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_MM:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_MS:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_NUMBER:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_PC:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_PERCENTAGE:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_PT:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_PX:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_RAD:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_REMS:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_S:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_TURN:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_VH:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_VMAX:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_VMIN:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_VW:</span>
          return true;
<span class="line-modified">!     case CSSPrimitiveValue::CSS_DPCM:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_DPI:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_DPPX:</span>
<span class="line-modified">! #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-modified">!         return true;</span>
<span class="line-modified">! #else</span>
<span class="line-modified">!         return false;</span>
<span class="line-modified">! #endif</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_ATTR:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_COUNTER:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_COUNTER_NAME:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_FONT_FAMILY:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_IDENT:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_PAIR:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_PROPERTY_ID:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_QUAD:</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_RECT:</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_RGBCOLOR:</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_SHAPE:</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_STRING:</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_UNICODE_RANGE:</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_UNKNOWN:</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_URI:</span>
<span class="line-removed">-     case CSSPrimitiveValue::CSS_VALUE_ID:</span>
          return false;
      }
  
      ASSERT_NOT_REACHED();
      return false;
  }
  
<span class="line-modified">! #if !ASSERT_DISABLED</span>
  
<span class="line-modified">! static inline bool isStringType(CSSPrimitiveValue::UnitType type)</span>
  {
      switch (type) {
<span class="line-modified">!     case CSSPrimitiveValue::CSS_STRING:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_URI:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_ATTR:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_COUNTER_NAME:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_DIMENSION:</span>
          return true;
<span class="line-modified">!     case CSSPrimitiveValue::CSS_CALC:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_CHS:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_CM:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_COUNTER:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_DEG:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_DPCM:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_DPI:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_DPPX:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_EMS:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_QUIRKY_EMS:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_EXS:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_FONT_FAMILY:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_FR:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_GRAD:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_HZ:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_IDENT:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_IN:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_KHZ:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_MM:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_MS:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_NUMBER:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_PAIR:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_PC:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_PERCENTAGE:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_PROPERTY_ID:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_PT:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_PX:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_QUAD:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_RAD:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_RECT:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_REMS:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_RGBCOLOR:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_S:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_SHAPE:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_TURN:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_UNICODE_RANGE:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_UNKNOWN:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_VALUE_ID:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_VH:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_VMAX:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_VMIN:</span>
<span class="line-modified">!     case CSSPrimitiveValue::CSS_VW:</span>
          return false;
      }
  
      ASSERT_NOT_REACHED();
      return false;
  }
  
<span class="line-modified">! #endif // !ASSERT_DISABLED</span>
<span class="line-removed">- </span>
<span class="line-removed">- CSSPrimitiveValue::UnitCategory CSSPrimitiveValue::unitCategory(CSSPrimitiveValue::UnitType type)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     // Here we violate the spec (http://www.w3.org/TR/DOM-Level-2-Style/css.html#CSS-CSSPrimitiveValue) and allow conversions</span>
<span class="line-removed">-     // between CSS_PX and relative lengths (see cssPixelsPerInch comment in CSSHelper.h for the topic treatment).</span>
<span class="line-removed">-     switch (type) {</span>
<span class="line-removed">-     case CSS_NUMBER:</span>
<span class="line-removed">-         return UNumber;</span>
<span class="line-removed">-     case CSS_PERCENTAGE:</span>
<span class="line-removed">-         return UPercent;</span>
<span class="line-removed">-     case CSS_PX:</span>
<span class="line-removed">-     case CSS_CM:</span>
<span class="line-removed">-     case CSS_MM:</span>
<span class="line-removed">-     case CSS_IN:</span>
<span class="line-removed">-     case CSS_PT:</span>
<span class="line-removed">-     case CSS_PC:</span>
<span class="line-removed">-         return ULength;</span>
<span class="line-removed">-     case CSS_MS:</span>
<span class="line-removed">-     case CSS_S:</span>
<span class="line-removed">-         return UTime;</span>
<span class="line-removed">-     case CSS_DEG:</span>
<span class="line-removed">-     case CSS_RAD:</span>
<span class="line-removed">-     case CSS_GRAD:</span>
<span class="line-removed">-     case CSS_TURN:</span>
<span class="line-removed">-         return UAngle;</span>
<span class="line-removed">-     case CSS_HZ:</span>
<span class="line-removed">-     case CSS_KHZ:</span>
<span class="line-removed">-         return UFrequency;</span>
<span class="line-removed">- #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-removed">-     case CSS_DPPX:</span>
<span class="line-removed">-     case CSS_DPI:</span>
<span class="line-removed">-     case CSS_DPCM:</span>
<span class="line-removed">-         return UResolution;</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-     default:</span>
<span class="line-removed">-         return UOther;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- }</span>
  
  typedef HashMap&lt;const CSSPrimitiveValue*, String&gt; CSSTextCache;
  static CSSTextCache&amp; cssTextCache()
  {
      static NeverDestroyed&lt;CSSTextCache&gt; cache;
      return cache;
  }
  
<span class="line-modified">! unsigned short CSSPrimitiveValue::primitiveType() const</span>
  {
<span class="line-modified">!     if (m_primitiveUnitType == CSS_PROPERTY_ID || m_primitiveUnitType == CSS_VALUE_ID)</span>
<span class="line-modified">!         return CSS_IDENT;</span>
  
<span class="line-modified">!     // Web-exposed content expects font family values to have CSS_STRING primitive type</span>
<span class="line-modified">!     // so we need to map our internal CSS_FONT_FAMILY type here.</span>
<span class="line-modified">!     if (m_primitiveUnitType == CSS_FONT_FAMILY)</span>
<span class="line-modified">!         return CSS_STRING;</span>
  
<span class="line-modified">!     if (m_primitiveUnitType != CSSPrimitiveValue::CSS_CALC)</span>
<span class="line-modified">!         return m_primitiveUnitType;</span>
  
      switch (m_value.calc-&gt;category()) {
      case CalculationCategory::Number:
<span class="line-modified">!         return CSSPrimitiveValue::CSS_NUMBER;</span>
<span class="line-removed">-     case CalculationCategory::Length:</span>
<span class="line-removed">-         return CSSPrimitiveValue::CSS_PX;</span>
      case CalculationCategory::Percent:
<span class="line-modified">!         return CSSPrimitiveValue::CSS_PERCENTAGE;</span>
      case CalculationCategory::PercentNumber:
<span class="line-modified">!         return CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_NUMBER;</span>
      case CalculationCategory::PercentLength:
<span class="line-modified">!         return CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_LENGTH;</span>
      case CalculationCategory::Angle:
      case CalculationCategory::Time:
      case CalculationCategory::Frequency:
          return m_value.calc-&gt;primitiveType();
      case CalculationCategory::Other:
<span class="line-modified">!         return CSSPrimitiveValue::CSS_UNKNOWN;</span>
      }
<span class="line-modified">!     return CSSPrimitiveValue::CSS_UNKNOWN;</span>
  }
  
  static const AtomString&amp; propertyName(CSSPropertyID propertyID)
  {
      ASSERT_ARG(propertyID, (propertyID &gt;= firstCSSProperty &amp;&amp; propertyID &lt; firstCSSProperty + numCSSProperties));
<span class="line-new-header">--- 35,183 ---</span>
  #include &quot;Counter.h&quot;
  #include &quot;DeprecatedCSSOMPrimitiveValue.h&quot;
  #include &quot;FontCascade.h&quot;
  #include &quot;Node.h&quot;
  #include &quot;Pair.h&quot;
  #include &quot;Rect.h&quot;
  #include &quot;RenderStyle.h&quot;
  #include &lt;wtf/NeverDestroyed.h&gt;
  #include &lt;wtf/StdLibExtras.h&gt;
  #include &lt;wtf/text/StringBuilder.h&gt;
  #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  
  namespace WebCore {
  
<span class="line-modified">! static inline bool isValidCSSUnitTypeForDoubleConversion(CSSUnitType unitType)</span>
  {
      switch (unitType) {
<span class="line-modified">!     case CSSUnitType::CSS_CALC:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CHS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CM:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-modified">!     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_FR:</span>
<span class="line-modified">!     case CSSUnitType::CSS_GRAD:</span>
<span class="line-modified">!     case CSSUnitType::CSS_HZ:</span>
<span class="line-modified">!     case CSSUnitType::CSS_IN:</span>
<span class="line-modified">!     case CSSUnitType::CSS_KHZ:</span>
<span class="line-modified">!     case CSSUnitType::CSS_MM:</span>
<span class="line-modified">!     case CSSUnitType::CSS_MS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PC:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PT:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PX:</span>
<span class="line-modified">!     case CSSUnitType::CSS_Q:</span>
<span class="line-modified">!     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_RAD:</span>
<span class="line-modified">!     case CSSUnitType::CSS_REMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_S:</span>
<span class="line-modified">!     case CSSUnitType::CSS_TURN:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VH:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VMAX:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VMIN:</span>
<span class="line-added">+     case CSSUnitType::CSS_VW:</span>
<span class="line-added">+     case CSSUnitType::CSS_DPCM:</span>
<span class="line-added">+     case CSSUnitType::CSS_DPI:</span>
<span class="line-added">+     case CSSUnitType::CSS_DPPX:</span>
          return true;
<span class="line-modified">!     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified">!     case CSSUnitType::CSS_COUNTER:</span>
<span class="line-modified">!     case CSSUnitType::CSS_COUNTER_NAME:</span>
<span class="line-modified">!     case CSSUnitType::CSS_FONT_FAMILY:</span>
<span class="line-modified">!     case CSSUnitType::CSS_IDENT:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PAIR:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PROPERTY_ID:</span>
<span class="line-modified">!     case CSSUnitType::CSS_QUAD:</span>
<span class="line-modified">!     case CSSUnitType::CSS_RECT:</span>
<span class="line-modified">!     case CSSUnitType::CSS_RGBCOLOR:</span>
<span class="line-modified">!     case CSSUnitType::CSS_SHAPE:</span>
<span class="line-modified">!     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified">!     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-modified">!     case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-modified">!     case CSSUnitType::CSS_URI:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VALUE_ID:</span>
          return false;
      }
  
      ASSERT_NOT_REACHED();
      return false;
  }
  
<span class="line-modified">! #if ASSERT_ENABLED</span>
  
<span class="line-modified">! static inline bool isStringType(CSSUnitType type)</span>
  {
      switch (type) {
<span class="line-modified">!     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified">!     case CSSUnitType::CSS_URI:</span>
<span class="line-modified">!     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified">!     case CSSUnitType::CSS_COUNTER_NAME:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DIMENSION:</span>
          return true;
<span class="line-modified">!     case CSSUnitType::CSS_CALC:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CHS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CM:</span>
<span class="line-modified">!     case CSSUnitType::CSS_COUNTER:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DPCM:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DPI:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DPPX:</span>
<span class="line-modified">!     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_FONT_FAMILY:</span>
<span class="line-modified">!     case CSSUnitType::CSS_FR:</span>
<span class="line-modified">!     case CSSUnitType::CSS_GRAD:</span>
<span class="line-modified">!     case CSSUnitType::CSS_HZ:</span>
<span class="line-modified">!     case CSSUnitType::CSS_IDENT:</span>
<span class="line-modified">!     case CSSUnitType::CSS_IN:</span>
<span class="line-modified">!     case CSSUnitType::CSS_KHZ:</span>
<span class="line-modified">!     case CSSUnitType::CSS_MM:</span>
<span class="line-modified">!     case CSSUnitType::CSS_MS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PAIR:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PC:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PROPERTY_ID:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PT:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PX:</span>
<span class="line-modified">!     case CSSUnitType::CSS_Q:</span>
<span class="line-modified">!     case CSSUnitType::CSS_QUAD:</span>
<span class="line-modified">!     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_RAD:</span>
<span class="line-modified">!     case CSSUnitType::CSS_RECT:</span>
<span class="line-modified">!     case CSSUnitType::CSS_REMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_RGBCOLOR:</span>
<span class="line-modified">!     case CSSUnitType::CSS_S:</span>
<span class="line-modified">!     case CSSUnitType::CSS_SHAPE:</span>
<span class="line-modified">!     case CSSUnitType::CSS_TURN:</span>
<span class="line-modified">!     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-modified">!     case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VALUE_ID:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VH:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VMAX:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VMIN:</span>
<span class="line-added">+     case CSSUnitType::CSS_VW:</span>
          return false;
      }
  
      ASSERT_NOT_REACHED();
      return false;
  }
  
<span class="line-modified">! #endif // ASSERT_ENABLED</span>
  
  typedef HashMap&lt;const CSSPrimitiveValue*, String&gt; CSSTextCache;
  static CSSTextCache&amp; cssTextCache()
  {
      static NeverDestroyed&lt;CSSTextCache&gt; cache;
      return cache;
  }
  
<span class="line-modified">! CSSUnitType CSSPrimitiveValue::primitiveType() const</span>
  {
<span class="line-modified">!     if (primitiveUnitType() == CSSUnitType::CSS_PROPERTY_ID || primitiveUnitType() == CSSUnitType::CSS_VALUE_ID)</span>
<span class="line-modified">!         return CSSUnitType::CSS_IDENT;</span>
  
<span class="line-modified">!     // Web-exposed content expects font family values to have CSSUnitType::CSS_STRING primitive type</span>
<span class="line-modified">!     // so we need to map our internal CSSUnitType::CSS_FONT_FAMILY type here.</span>
<span class="line-modified">!     if (primitiveUnitType() == CSSUnitType::CSS_FONT_FAMILY)</span>
<span class="line-modified">!         return CSSUnitType::CSS_STRING;</span>
  
<span class="line-modified">!     if (primitiveUnitType() != CSSUnitType::CSS_CALC)</span>
<span class="line-modified">!         return primitiveUnitType();</span>
  
      switch (m_value.calc-&gt;category()) {
      case CalculationCategory::Number:
<span class="line-modified">!         return CSSUnitType::CSS_NUMBER;</span>
      case CalculationCategory::Percent:
<span class="line-modified">!         return CSSUnitType::CSS_PERCENTAGE;</span>
      case CalculationCategory::PercentNumber:
<span class="line-modified">!         return CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER;</span>
      case CalculationCategory::PercentLength:
<span class="line-modified">!         return CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH;</span>
<span class="line-added">+     case CalculationCategory::Length:</span>
      case CalculationCategory::Angle:
      case CalculationCategory::Time:
      case CalculationCategory::Frequency:
          return m_value.calc-&gt;primitiveType();
      case CalculationCategory::Other:
<span class="line-modified">!         return CSSUnitType::CSS_UNKNOWN;</span>
      }
<span class="line-modified">!     return CSSUnitType::CSS_UNKNOWN;</span>
  }
  
  static const AtomString&amp; propertyName(CSSPropertyID propertyID)
  {
      ASSERT_ARG(propertyID, (propertyID &gt;= firstCSSProperty &amp;&amp; propertyID &lt; firstCSSProperty + numCSSProperties));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 270,42 ***</span>
  }
  
  CSSPrimitiveValue::CSSPrimitiveValue(CSSValueID valueID)
      : CSSValue(PrimitiveClass)
  {
<span class="line-modified">!     m_primitiveUnitType = CSS_VALUE_ID;</span>
      m_value.valueID = valueID;
  }
  
  CSSPrimitiveValue::CSSPrimitiveValue(CSSPropertyID propertyID)
      : CSSValue(PrimitiveClass)
  {
<span class="line-modified">!     m_primitiveUnitType = CSS_PROPERTY_ID;</span>
      m_value.propertyID = propertyID;
  }
  
<span class="line-modified">! CSSPrimitiveValue::CSSPrimitiveValue(double num, UnitType type)</span>
      : CSSValue(PrimitiveClass)
  {
<span class="line-modified">!     m_primitiveUnitType = type;</span>
      ASSERT(std::isfinite(num));
      m_value.num = num;
  }
  
<span class="line-modified">! CSSPrimitiveValue::CSSPrimitiveValue(const String&amp; string, UnitType type)</span>
      : CSSValue(PrimitiveClass)
  {
      ASSERT(isStringType(type));
<span class="line-modified">!     m_primitiveUnitType = type;</span>
      if ((m_value.string = string.impl()))
          m_value.string-&gt;ref();
  }
  
  CSSPrimitiveValue::CSSPrimitiveValue(const Color&amp; color)
      : CSSValue(PrimitiveClass)
  {
<span class="line-modified">!     m_primitiveUnitType = CSS_RGBCOLOR;</span>
      m_value.color = new Color(color);
  }
  
  CSSPrimitiveValue::CSSPrimitiveValue(const Length&amp; length)
      : CSSValue(PrimitiveClass)
<span class="line-new-header">--- 227,42 ---</span>
  }
  
  CSSPrimitiveValue::CSSPrimitiveValue(CSSValueID valueID)
      : CSSValue(PrimitiveClass)
  {
<span class="line-modified">!     setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
      m_value.valueID = valueID;
  }
  
  CSSPrimitiveValue::CSSPrimitiveValue(CSSPropertyID propertyID)
      : CSSValue(PrimitiveClass)
  {
<span class="line-modified">!     setPrimitiveUnitType(CSSUnitType::CSS_PROPERTY_ID);</span>
      m_value.propertyID = propertyID;
  }
  
<span class="line-modified">! CSSPrimitiveValue::CSSPrimitiveValue(double num, CSSUnitType type)</span>
      : CSSValue(PrimitiveClass)
  {
<span class="line-modified">!     setPrimitiveUnitType(type);</span>
      ASSERT(std::isfinite(num));
      m_value.num = num;
  }
  
<span class="line-modified">! CSSPrimitiveValue::CSSPrimitiveValue(const String&amp; string, CSSUnitType type)</span>
      : CSSValue(PrimitiveClass)
  {
      ASSERT(isStringType(type));
<span class="line-modified">!     setPrimitiveUnitType(type);</span>
      if ((m_value.string = string.impl()))
          m_value.string-&gt;ref();
  }
  
  CSSPrimitiveValue::CSSPrimitiveValue(const Color&amp; color)
      : CSSValue(PrimitiveClass)
  {
<span class="line-modified">!     setPrimitiveUnitType(CSSUnitType::CSS_RGBCOLOR);</span>
      m_value.color = new Color(color);
  }
  
  CSSPrimitiveValue::CSSPrimitiveValue(const Length&amp; length)
      : CSSValue(PrimitiveClass)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 326,11 ***</span>
      case FitContent:
      case Percent:
          init(length);
          return;
      case Fixed:
<span class="line-modified">!         m_primitiveUnitType = CSS_PX;</span>
          m_value.num = adjustFloatForAbsoluteZoom(length.value(), style);
          return;
      case Calculated: {
          init(CSSCalcValue::create(length.calculationValue(), style));
          return;
<span class="line-new-header">--- 283,11 ---</span>
      case FitContent:
      case Percent:
          init(length);
          return;
      case Fixed:
<span class="line-modified">!         setPrimitiveUnitType(CSSUnitType::CSS_PX);</span>
          m_value.num = adjustFloatForAbsoluteZoom(length.value(), style);
          return;
      case Calculated: {
          init(CSSCalcValue::create(length.calculationValue(), style));
          return;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 347,47 ***</span>
      : CSSValue(PrimitiveClass)
  {
      init(lengthSize, style);
  }
  
  void CSSPrimitiveValue::init(const Length&amp; length)
  {
      switch (length.type()) {
      case Auto:
<span class="line-modified">!         m_primitiveUnitType = CSS_VALUE_ID;</span>
          m_value.valueID = CSSValueAuto;
          return;
      case WebCore::Fixed:
<span class="line-modified">!         m_primitiveUnitType = CSS_PX;</span>
          m_value.num = length.value();
          return;
      case Intrinsic:
<span class="line-modified">!         m_primitiveUnitType = CSS_VALUE_ID;</span>
          m_value.valueID = CSSValueIntrinsic;
          return;
      case MinIntrinsic:
<span class="line-modified">!         m_primitiveUnitType = CSS_VALUE_ID;</span>
          m_value.valueID = CSSValueMinIntrinsic;
          return;
      case MinContent:
<span class="line-modified">!         m_primitiveUnitType = CSS_VALUE_ID;</span>
          m_value.valueID = CSSValueMinContent;
          return;
      case MaxContent:
<span class="line-modified">!         m_primitiveUnitType = CSS_VALUE_ID;</span>
          m_value.valueID = CSSValueMaxContent;
          return;
      case FillAvailable:
<span class="line-modified">!         m_primitiveUnitType = CSS_VALUE_ID;</span>
          m_value.valueID = CSSValueWebkitFillAvailable;
          return;
      case FitContent:
<span class="line-modified">!         m_primitiveUnitType = CSS_VALUE_ID;</span>
          m_value.valueID = CSSValueFitContent;
          return;
      case Percent:
<span class="line-modified">!         m_primitiveUnitType = CSS_PERCENTAGE;</span>
          ASSERT(std::isfinite(length.percent()));
          m_value.num = length.percent();
          return;
      case Calculated:
      case Relative:
<span class="line-new-header">--- 304,65 ---</span>
      : CSSValue(PrimitiveClass)
  {
      init(lengthSize, style);
  }
  
<span class="line-added">+ CSSPrimitiveValue::CSSPrimitiveValue(StaticCSSValueTag, CSSValueID valueID)</span>
<span class="line-added">+     : CSSPrimitiveValue(valueID)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     makeStatic();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ CSSPrimitiveValue::CSSPrimitiveValue(StaticCSSValueTag, const Color&amp; color)</span>
<span class="line-added">+     : CSSPrimitiveValue(color)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     makeStatic();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ CSSPrimitiveValue::CSSPrimitiveValue(StaticCSSValueTag, double num, CSSUnitType type)</span>
<span class="line-added">+     : CSSPrimitiveValue(num, type)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     makeStatic();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void CSSPrimitiveValue::init(const Length&amp; length)
  {
      switch (length.type()) {
      case Auto:
<span class="line-modified">!         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
          m_value.valueID = CSSValueAuto;
          return;
      case WebCore::Fixed:
<span class="line-modified">!         setPrimitiveUnitType(CSSUnitType::CSS_PX);</span>
          m_value.num = length.value();
          return;
      case Intrinsic:
<span class="line-modified">!         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
          m_value.valueID = CSSValueIntrinsic;
          return;
      case MinIntrinsic:
<span class="line-modified">!         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
          m_value.valueID = CSSValueMinIntrinsic;
          return;
      case MinContent:
<span class="line-modified">!         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
          m_value.valueID = CSSValueMinContent;
          return;
      case MaxContent:
<span class="line-modified">!         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
          m_value.valueID = CSSValueMaxContent;
          return;
      case FillAvailable:
<span class="line-modified">!         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
          m_value.valueID = CSSValueWebkitFillAvailable;
          return;
      case FitContent:
<span class="line-modified">!         setPrimitiveUnitType(CSSUnitType::CSS_VALUE_ID);</span>
          m_value.valueID = CSSValueFitContent;
          return;
      case Percent:
<span class="line-modified">!         setPrimitiveUnitType(CSSUnitType::CSS_PERCENTAGE);</span>
          ASSERT(std::isfinite(length.percent()));
          m_value.num = length.percent();
          return;
      case Calculated:
      case Relative:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 398,53 ***</span>
      ASSERT_NOT_REACHED();
  }
  
  void CSSPrimitiveValue::init(const LengthSize&amp; lengthSize, const RenderStyle&amp; style)
  {
<span class="line-modified">!     m_primitiveUnitType = CSS_PAIR;</span>
      m_hasCachedCSSText = false;
      m_value.pair = &amp;Pair::create(create(lengthSize.width, style), create(lengthSize.height, style)).leakRef();
  }
  
  void CSSPrimitiveValue::init(Ref&lt;Counter&gt;&amp;&amp; counter)
  {
<span class="line-modified">!     m_primitiveUnitType = CSS_COUNTER;</span>
      m_hasCachedCSSText = false;
      m_value.counter = &amp;counter.leakRef();
  }
  
  void CSSPrimitiveValue::init(Ref&lt;Rect&gt;&amp;&amp; r)
  {
<span class="line-modified">!     m_primitiveUnitType = CSS_RECT;</span>
      m_hasCachedCSSText = false;
      m_value.rect = &amp;r.leakRef();
  }
  
  void CSSPrimitiveValue::init(Ref&lt;Quad&gt;&amp;&amp; quad)
  {
<span class="line-modified">!     m_primitiveUnitType = CSS_QUAD;</span>
      m_hasCachedCSSText = false;
      m_value.quad = &amp;quad.leakRef();
  }
  
  void CSSPrimitiveValue::init(Ref&lt;Pair&gt;&amp;&amp; p)
  {
<span class="line-modified">!     m_primitiveUnitType = CSS_PAIR;</span>
      m_hasCachedCSSText = false;
      m_value.pair = &amp;p.leakRef();
  }
  
  void CSSPrimitiveValue::init(Ref&lt;CSSBasicShape&gt;&amp;&amp; shape)
  {
<span class="line-modified">!     m_primitiveUnitType = CSS_SHAPE;</span>
      m_hasCachedCSSText = false;
      m_value.shape = &amp;shape.leakRef();
  }
  
  void CSSPrimitiveValue::init(RefPtr&lt;CSSCalcValue&gt;&amp;&amp; c)
  {
<span class="line-modified">!     m_primitiveUnitType = CSS_CALC;</span>
      m_hasCachedCSSText = false;
      m_value.calc = c.leakRef();
  }
  
  CSSPrimitiveValue::~CSSPrimitiveValue()
<span class="line-new-header">--- 373,53 ---</span>
      ASSERT_NOT_REACHED();
  }
  
  void CSSPrimitiveValue::init(const LengthSize&amp; lengthSize, const RenderStyle&amp; style)
  {
<span class="line-modified">!     setPrimitiveUnitType(CSSUnitType::CSS_PAIR);</span>
      m_hasCachedCSSText = false;
      m_value.pair = &amp;Pair::create(create(lengthSize.width, style), create(lengthSize.height, style)).leakRef();
  }
  
  void CSSPrimitiveValue::init(Ref&lt;Counter&gt;&amp;&amp; counter)
  {
<span class="line-modified">!     setPrimitiveUnitType(CSSUnitType::CSS_COUNTER);</span>
      m_hasCachedCSSText = false;
      m_value.counter = &amp;counter.leakRef();
  }
  
  void CSSPrimitiveValue::init(Ref&lt;Rect&gt;&amp;&amp; r)
  {
<span class="line-modified">!     setPrimitiveUnitType(CSSUnitType::CSS_RECT);</span>
      m_hasCachedCSSText = false;
      m_value.rect = &amp;r.leakRef();
  }
  
  void CSSPrimitiveValue::init(Ref&lt;Quad&gt;&amp;&amp; quad)
  {
<span class="line-modified">!     setPrimitiveUnitType(CSSUnitType::CSS_QUAD);</span>
      m_hasCachedCSSText = false;
      m_value.quad = &amp;quad.leakRef();
  }
  
  void CSSPrimitiveValue::init(Ref&lt;Pair&gt;&amp;&amp; p)
  {
<span class="line-modified">!     setPrimitiveUnitType(CSSUnitType::CSS_PAIR);</span>
      m_hasCachedCSSText = false;
      m_value.pair = &amp;p.leakRef();
  }
  
  void CSSPrimitiveValue::init(Ref&lt;CSSBasicShape&gt;&amp;&amp; shape)
  {
<span class="line-modified">!     setPrimitiveUnitType(CSSUnitType::CSS_SHAPE);</span>
      m_hasCachedCSSText = false;
      m_value.shape = &amp;shape.leakRef();
  }
  
  void CSSPrimitiveValue::init(RefPtr&lt;CSSCalcValue&gt;&amp;&amp; c)
  {
<span class="line-modified">!     setPrimitiveUnitType(CSSUnitType::CSS_CALC);</span>
      m_hasCachedCSSText = false;
      m_value.calc = c.leakRef();
  }
  
  CSSPrimitiveValue::~CSSPrimitiveValue()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 452,106 ***</span>
      cleanup();
  }
  
  void CSSPrimitiveValue::cleanup()
  {
<span class="line-modified">!     auto type = static_cast&lt;UnitType&gt;(m_primitiveUnitType);</span>
      switch (type) {
<span class="line-modified">!     case CSS_STRING:</span>
<span class="line-modified">!     case CSS_URI:</span>
<span class="line-modified">!     case CSS_ATTR:</span>
<span class="line-modified">!     case CSS_COUNTER_NAME:</span>
          if (m_value.string)
              m_value.string-&gt;deref();
          break;
<span class="line-modified">!     case CSS_DIMENSION:</span>
<span class="line-modified">!     case CSS_COUNTER:</span>
          m_value.counter-&gt;deref();
          break;
<span class="line-modified">!     case CSS_RECT:</span>
          m_value.rect-&gt;deref();
          break;
<span class="line-modified">!     case CSS_QUAD:</span>
          m_value.quad-&gt;deref();
          break;
<span class="line-modified">!     case CSS_PAIR:</span>
          m_value.pair-&gt;deref();
          break;
<span class="line-modified">!     case CSS_CALC:</span>
          m_value.calc-&gt;deref();
          break;
<span class="line-modified">!     case CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified">!     case CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
          ASSERT_NOT_REACHED();
          break;
<span class="line-modified">!     case CSS_SHAPE:</span>
          m_value.shape-&gt;deref();
          break;
<span class="line-modified">!     case CSS_FONT_FAMILY:</span>
          ASSERT(m_value.fontFamily);
          delete m_value.fontFamily;
          m_value.fontFamily = nullptr;
          break;
<span class="line-modified">!     case CSS_RGBCOLOR:</span>
          ASSERT(m_value.color);
          delete m_value.color;
          m_value.color = nullptr;
          break;
<span class="line-modified">!     case CSS_NUMBER:</span>
<span class="line-modified">!     case CSS_PERCENTAGE:</span>
<span class="line-modified">!     case CSS_EMS:</span>
<span class="line-modified">!     case CSS_QUIRKY_EMS:</span>
<span class="line-modified">!     case CSS_EXS:</span>
<span class="line-modified">!     case CSS_REMS:</span>
<span class="line-modified">!     case CSS_CHS:</span>
<span class="line-modified">!     case CSS_PX:</span>
<span class="line-modified">!     case CSS_CM:</span>
<span class="line-modified">!     case CSS_MM:</span>
<span class="line-modified">!     case CSS_IN:</span>
<span class="line-modified">!     case CSS_PT:</span>
<span class="line-modified">!     case CSS_PC:</span>
<span class="line-modified">!     case CSS_DEG:</span>
<span class="line-modified">!     case CSS_RAD:</span>
<span class="line-modified">!     case CSS_GRAD:</span>
<span class="line-modified">!     case CSS_MS:</span>
<span class="line-modified">!     case CSS_S:</span>
<span class="line-modified">!     case CSS_HZ:</span>
<span class="line-modified">!     case CSS_KHZ:</span>
<span class="line-modified">!     case CSS_TURN:</span>
<span class="line-modified">!     case CSS_VW:</span>
<span class="line-modified">!     case CSS_VH:</span>
<span class="line-modified">!     case CSS_VMIN:</span>
<span class="line-modified">!     case CSS_VMAX:</span>
<span class="line-modified">!     case CSS_DPPX:</span>
<span class="line-modified">!     case CSS_DPI:</span>
<span class="line-modified">!     case CSS_DPCM:</span>
<span class="line-modified">!     case CSS_FR:</span>
<span class="line-modified">!     case CSS_IDENT:</span>
<span class="line-modified">!     case CSS_UNKNOWN:</span>
<span class="line-modified">!     case CSS_UNICODE_RANGE:</span>
<span class="line-modified">!     case CSS_PROPERTY_ID:</span>
<span class="line-modified">!     case CSS_VALUE_ID:</span>
          ASSERT(!isStringType(type));
          break;
      }
<span class="line-modified">!     m_primitiveUnitType = 0;</span>
      if (m_hasCachedCSSText) {
          cssTextCache().remove(this);
          m_hasCachedCSSText = false;
      }
  }
  
  double CSSPrimitiveValue::computeDegrees() const
  {
      switch (primitiveType()) {
<span class="line-modified">!     case CSS_DEG:</span>
          return doubleValue();
<span class="line-modified">!     case CSS_RAD:</span>
          return rad2deg(doubleValue());
<span class="line-modified">!     case CSS_GRAD:</span>
          return grad2deg(doubleValue());
<span class="line-modified">!     case CSS_TURN:</span>
          return turn2deg(doubleValue());
      default:
          ASSERT_NOT_REACHED();
          return 0;
      }
<span class="line-new-header">--- 427,107 ---</span>
      cleanup();
  }
  
  void CSSPrimitiveValue::cleanup()
  {
<span class="line-modified">!     auto type = primitiveUnitType();</span>
      switch (type) {
<span class="line-modified">!     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified">!     case CSSUnitType::CSS_URI:</span>
<span class="line-modified">!     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified">!     case CSSUnitType::CSS_COUNTER_NAME:</span>
          if (m_value.string)
              m_value.string-&gt;deref();
          break;
<span class="line-modified">!     case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-modified">!     case CSSUnitType::CSS_COUNTER:</span>
          m_value.counter-&gt;deref();
          break;
<span class="line-modified">!     case CSSUnitType::CSS_RECT:</span>
          m_value.rect-&gt;deref();
          break;
<span class="line-modified">!     case CSSUnitType::CSS_QUAD:</span>
          m_value.quad-&gt;deref();
          break;
<span class="line-modified">!     case CSSUnitType::CSS_PAIR:</span>
          m_value.pair-&gt;deref();
          break;
<span class="line-modified">!     case CSSUnitType::CSS_CALC:</span>
          m_value.calc-&gt;deref();
          break;
<span class="line-modified">!     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
          ASSERT_NOT_REACHED();
          break;
<span class="line-modified">!     case CSSUnitType::CSS_SHAPE:</span>
          m_value.shape-&gt;deref();
          break;
<span class="line-modified">!     case CSSUnitType::CSS_FONT_FAMILY:</span>
          ASSERT(m_value.fontFamily);
          delete m_value.fontFamily;
          m_value.fontFamily = nullptr;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_RGBCOLOR:</span>
          ASSERT(m_value.color);
          delete m_value.color;
          m_value.color = nullptr;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-modified">!     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_REMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CHS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PX:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CM:</span>
<span class="line-modified">!     case CSSUnitType::CSS_MM:</span>
<span class="line-modified">!     case CSSUnitType::CSS_IN:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PT:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PC:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified">!     case CSSUnitType::CSS_RAD:</span>
<span class="line-modified">!     case CSSUnitType::CSS_GRAD:</span>
<span class="line-modified">!     case CSSUnitType::CSS_MS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_S:</span>
<span class="line-modified">!     case CSSUnitType::CSS_HZ:</span>
<span class="line-modified">!     case CSSUnitType::CSS_KHZ:</span>
<span class="line-modified">!     case CSSUnitType::CSS_TURN:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VW:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VH:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VMIN:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VMAX:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DPPX:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DPI:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DPCM:</span>
<span class="line-modified">!     case CSSUnitType::CSS_FR:</span>
<span class="line-modified">!     case CSSUnitType::CSS_Q:</span>
<span class="line-modified">!     case CSSUnitType::CSS_IDENT:</span>
<span class="line-modified">!     case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-modified">!     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PROPERTY_ID:</span>
<span class="line-added">+     case CSSUnitType::CSS_VALUE_ID:</span>
          ASSERT(!isStringType(type));
          break;
      }
<span class="line-modified">!     setPrimitiveUnitType(CSSUnitType::CSS_UNKNOWN);</span>
      if (m_hasCachedCSSText) {
          cssTextCache().remove(this);
          m_hasCachedCSSText = false;
      }
  }
  
  double CSSPrimitiveValue::computeDegrees() const
  {
      switch (primitiveType()) {
<span class="line-modified">!     case CSSUnitType::CSS_DEG:</span>
          return doubleValue();
<span class="line-modified">!     case CSSUnitType::CSS_RAD:</span>
          return rad2deg(doubleValue());
<span class="line-modified">!     case CSSUnitType::CSS_GRAD:</span>
          return grad2deg(doubleValue());
<span class="line-modified">!     case CSSUnitType::CSS_TURN:</span>
          return turn2deg(doubleValue());
      default:
          ASSERT_NOT_REACHED();
          return 0;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 590,86 ***</span>
  template&lt;&gt; double CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
  {
      return computeLengthDouble(conversionData);
  }
  
  double CSSPrimitiveValue::computeLengthDouble(const CSSToLengthConversionData&amp; conversionData) const
  {
<span class="line-modified">!     if (m_primitiveUnitType == CSS_CALC)</span>
          // The multiplier and factor is applied to each value in the calc expression individually
          return m_value.calc-&gt;computeLengthPx(conversionData);
  
<span class="line-modified">!     return computeNonCalcLengthDouble(conversionData, static_cast&lt;UnitType&gt;(primitiveType()), m_value.num);</span>
  }
  
<span class="line-modified">! double CSSPrimitiveValue::computeNonCalcLengthDouble(const CSSToLengthConversionData&amp; conversionData, UnitType primitiveType, double value)</span>
  {
      double factor;
      bool applyZoom = true;
  
      switch (primitiveType) {
<span class="line-modified">!     case CSS_EMS:</span>
<span class="line-modified">!     case CSS_QUIRKY_EMS:</span>
          ASSERT(conversionData.style());
          factor = conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize();
          break;
<span class="line-modified">!     case CSS_EXS:</span>
          ASSERT(conversionData.style());
          // FIXME: We have a bug right now where the zoom will be applied twice to EX units.
          // We really need to compute EX using fontMetrics for the original specifiedSize and not use
          // our actual constructed rendering font.
          if (conversionData.style()-&gt;fontMetrics().hasXHeight())
              factor = conversionData.style()-&gt;fontMetrics().xHeight();
          else
              factor = (conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize()) / 2.0;
          break;
<span class="line-modified">!     case CSS_REMS:</span>
          if (conversionData.rootStyle())
              factor = conversionData.computingFontSize() ? conversionData.rootStyle()-&gt;fontDescription().specifiedSize() : conversionData.rootStyle()-&gt;fontDescription().computedSize();
          else
              factor = 1.0;
          break;
<span class="line-modified">!     case CSS_CHS:</span>
          ASSERT(conversionData.style());
          factor = conversionData.style()-&gt;fontMetrics().zeroWidth();
          break;
<span class="line-modified">!     case CSS_PX:</span>
          factor = 1.0;
          break;
<span class="line-modified">!     case CSS_CM:</span>
<span class="line-modified">!         factor = cssPixelsPerInch / 2.54; // (2.54 cm/in)</span>
          break;
<span class="line-modified">!     case CSS_MM:</span>
<span class="line-modified">!         factor = cssPixelsPerInch / 25.4;</span>
          break;
<span class="line-modified">!     case CSS_IN:</span>
          factor = cssPixelsPerInch;
          break;
<span class="line-modified">!     case CSS_PT:</span>
          factor = cssPixelsPerInch / 72.0;
          break;
<span class="line-modified">!     case CSS_PC:</span>
          // 1 pc == 12 pt
          factor = cssPixelsPerInch * 12.0 / 72.0;
          break;
<span class="line-modified">!     case CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified">!     case CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
          ASSERT_NOT_REACHED();
          return -1.0;
<span class="line-modified">!     case CSS_VH:</span>
          factor = conversionData.viewportHeightFactor();
          applyZoom = false;
          break;
<span class="line-modified">!     case CSS_VW:</span>
          factor = conversionData.viewportWidthFactor();
          applyZoom = false;
          break;
<span class="line-modified">!     case CSS_VMAX:</span>
          factor = conversionData.viewportMaxFactor();
          applyZoom = false;
          break;
<span class="line-modified">!     case CSS_VMIN:</span>
          factor = conversionData.viewportMinFactor();
          applyZoom = false;
          break;
      default:
          ASSERT_NOT_REACHED();
<span class="line-new-header">--- 566,99 ---</span>
  template&lt;&gt; double CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
  {
      return computeLengthDouble(conversionData);
  }
  
<span class="line-added">+ template&lt;&gt; LayoutUnit CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return LayoutUnit(computeLengthDouble(conversionData));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  double CSSPrimitiveValue::computeLengthDouble(const CSSToLengthConversionData&amp; conversionData) const
  {
<span class="line-modified">!     if (primitiveUnitType() == CSSUnitType::CSS_CALC) {</span>
          // The multiplier and factor is applied to each value in the calc expression individually
          return m_value.calc-&gt;computeLengthPx(conversionData);
<span class="line-added">+     }</span>
  
<span class="line-modified">!     return computeNonCalcLengthDouble(conversionData, primitiveType(), m_value.num);</span>
  }
  
<span class="line-modified">! static constexpr double mmPerInch = 25.4;</span>
<span class="line-added">+ static constexpr double cmPerInch = 2.54;</span>
<span class="line-added">+ static constexpr double QPerInch = 25.4 * 4.0;</span>
<span class="line-added">+ </span>
<span class="line-added">+ double CSSPrimitiveValue::computeNonCalcLengthDouble(const CSSToLengthConversionData&amp; conversionData, CSSUnitType primitiveType, double value)</span>
  {
      double factor;
      bool applyZoom = true;
  
      switch (primitiveType) {
<span class="line-modified">!     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_QUIRKY_EMS:</span>
          ASSERT(conversionData.style());
          factor = conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize();
          break;
<span class="line-modified">!     case CSSUnitType::CSS_EXS:</span>
          ASSERT(conversionData.style());
          // FIXME: We have a bug right now where the zoom will be applied twice to EX units.
          // We really need to compute EX using fontMetrics for the original specifiedSize and not use
          // our actual constructed rendering font.
          if (conversionData.style()-&gt;fontMetrics().hasXHeight())
              factor = conversionData.style()-&gt;fontMetrics().xHeight();
          else
              factor = (conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize()) / 2.0;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_REMS:</span>
          if (conversionData.rootStyle())
              factor = conversionData.computingFontSize() ? conversionData.rootStyle()-&gt;fontDescription().specifiedSize() : conversionData.rootStyle()-&gt;fontDescription().computedSize();
          else
              factor = 1.0;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_CHS:</span>
          ASSERT(conversionData.style());
          factor = conversionData.style()-&gt;fontMetrics().zeroWidth();
          break;
<span class="line-modified">!     case CSSUnitType::CSS_PX:</span>
          factor = 1.0;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_CM:</span>
<span class="line-modified">!         factor = cssPixelsPerInch / cmPerInch;</span>
<span class="line-added">+         break;</span>
<span class="line-added">+     case CSSUnitType::CSS_MM:</span>
<span class="line-added">+         factor = cssPixelsPerInch / mmPerInch;</span>
          break;
<span class="line-modified">!     case CSSUnitType::CSS_Q:</span>
<span class="line-modified">!         factor = cssPixelsPerInch / QPerInch;</span>
          break;
<span class="line-modified">!     case CSSUnitType::CSS_IN:</span>
          factor = cssPixelsPerInch;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_PT:</span>
          factor = cssPixelsPerInch / 72.0;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_PC:</span>
          // 1 pc == 12 pt
          factor = cssPixelsPerInch * 12.0 / 72.0;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
          ASSERT_NOT_REACHED();
          return -1.0;
<span class="line-modified">!     case CSSUnitType::CSS_VH:</span>
          factor = conversionData.viewportHeightFactor();
          applyZoom = false;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_VW:</span>
          factor = conversionData.viewportWidthFactor();
          applyZoom = false;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_VMAX:</span>
          factor = conversionData.viewportMaxFactor();
          applyZoom = false;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_VMIN:</span>
          factor = conversionData.viewportMinFactor();
          applyZoom = false;
          break;
      default:
          ASSERT_NOT_REACHED();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 687,311 ***</span>
          result *= conversionData.zoom();
  
      return result;
  }
  
<span class="line-modified">! ExceptionOr&lt;void&gt; CSSPrimitiveValue::setFloatValue(unsigned short, double)</span>
  {
      // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
      // No other engine supports mutating style through this API. Computed style is always read-only anyway.
      // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
      return Exception { NoModificationAllowedError };
  }
  
<span class="line-modified">! double CSSPrimitiveValue::conversionToCanonicalUnitsScaleFactor(UnitType unitType)</span>
  {
      double factor = 1.0;
      // FIXME: the switch can be replaced by an array of scale factors.
      switch (unitType) {
      // These are &quot;canonical&quot; units in their respective categories.
<span class="line-modified">!     case CSS_PX:</span>
<span class="line-modified">!     case CSS_DEG:</span>
<span class="line-modified">!     case CSS_MS:</span>
<span class="line-modified">!     case CSS_HZ:</span>
          break;
<span class="line-modified">!     case CSS_CM:</span>
<span class="line-modified">!         factor = cssPixelsPerInch / 2.54; // (2.54 cm/in)</span>
          break;
<span class="line-modified">!     case CSS_DPCM:</span>
<span class="line-modified">!         factor = 2.54 / cssPixelsPerInch; // (2.54 cm/in)</span>
          break;
<span class="line-modified">!     case CSS_MM:</span>
<span class="line-modified">!         factor = cssPixelsPerInch / 25.4;</span>
          break;
<span class="line-modified">!     case CSS_IN:</span>
          factor = cssPixelsPerInch;
          break;
<span class="line-modified">!     case CSS_DPI:</span>
          factor = 1 / cssPixelsPerInch;
          break;
<span class="line-modified">!     case CSS_PT:</span>
          factor = cssPixelsPerInch / 72.0;
          break;
<span class="line-modified">!     case CSS_PC:</span>
          factor = cssPixelsPerInch * 12.0 / 72.0; // 1 pc == 12 pt
          break;
<span class="line-modified">!     case CSS_RAD:</span>
          factor = 180 / piDouble;
          break;
<span class="line-modified">!     case CSS_GRAD:</span>
          factor = 0.9;
          break;
<span class="line-modified">!     case CSS_TURN:</span>
          factor = 360;
          break;
<span class="line-modified">!     case CSS_S:</span>
<span class="line-modified">!     case CSS_KHZ:</span>
          factor = 1000;
          break;
      default:
          break;
      }
  
      return factor;
  }
  
<span class="line-modified">! ExceptionOr&lt;float&gt; CSSPrimitiveValue::getFloatValue(unsigned short unitType) const</span>
  {
<span class="line-modified">!     auto result = doubleValueInternal(static_cast&lt;UnitType&gt;(unitType));</span>
      if (!result)
          return Exception { InvalidAccessError };
      return clampTo&lt;float&gt;(result.value());
  }
  
<span class="line-modified">! double CSSPrimitiveValue::doubleValue(UnitType unitType) const</span>
  {
      return doubleValueInternal(unitType).valueOr(0);
  }
  
  double CSSPrimitiveValue::doubleValue() const
  {
<span class="line-modified">!     return m_primitiveUnitType != CSS_CALC ? m_value.num : m_value.calc-&gt;doubleValue();</span>
  }
  
  
<span class="line-modified">! CSSPrimitiveValue::UnitType CSSPrimitiveValue::canonicalUnitTypeForCategory(UnitCategory category)</span>
  {
<span class="line-modified">!     // The canonical unit type is chosen according to the way CSSParser::validUnit() chooses the default unit</span>
<span class="line-modified">!     // in each category (based on unitflags).</span>
<span class="line-modified">!     switch (category) {</span>
<span class="line-modified">!     case UNumber:</span>
<span class="line-modified">!         return CSS_NUMBER;</span>
<span class="line-modified">!     case ULength:</span>
<span class="line-modified">!         return CSS_PX;</span>
<span class="line-modified">!     case UPercent:</span>
<span class="line-modified">!         return CSS_UNKNOWN; // Cannot convert between numbers and percent.</span>
<span class="line-modified">!     case UTime:</span>
<span class="line-removed">-         return CSS_MS;</span>
<span class="line-removed">-     case UAngle:</span>
<span class="line-removed">-         return CSS_DEG;</span>
<span class="line-removed">-     case UFrequency:</span>
<span class="line-removed">-         return CSS_HZ;</span>
<span class="line-removed">- #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-removed">-     case UResolution:</span>
<span class="line-removed">-         return CSS_DPPX;</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-     default:</span>
<span class="line-removed">-         return CSS_UNKNOWN;</span>
<span class="line-removed">-     }</span>
  }
  
<span class="line-modified">! Optional&lt;double&gt; CSSPrimitiveValue::doubleValueInternal(UnitType requestedUnitType) const</span>
  {
<span class="line-modified">!     if (!isValidCSSUnitTypeForDoubleConversion(static_cast&lt;UnitType&gt;(m_primitiveUnitType)) || !isValidCSSUnitTypeForDoubleConversion(requestedUnitType))</span>
          return WTF::nullopt;
  
<span class="line-modified">!     UnitType sourceUnitType = static_cast&lt;UnitType&gt;(primitiveType());</span>
<span class="line-modified">!     if (requestedUnitType == sourceUnitType || requestedUnitType == CSS_DIMENSION)</span>
          return doubleValue();
  
<span class="line-modified">!     UnitCategory sourceCategory = unitCategory(sourceUnitType);</span>
<span class="line-modified">!     ASSERT(sourceCategory != UOther);</span>
  
<span class="line-modified">!     UnitType targetUnitType = requestedUnitType;</span>
<span class="line-modified">!     UnitCategory targetCategory = unitCategory(targetUnitType);</span>
<span class="line-modified">!     ASSERT(targetCategory != UOther);</span>
  
<span class="line-modified">!     // Cannot convert between unrelated unit categories if one of them is not UNumber.</span>
<span class="line-modified">!     if (sourceCategory != targetCategory &amp;&amp; sourceCategory != UNumber &amp;&amp; targetCategory != UNumber)</span>
          return WTF::nullopt;
  
<span class="line-modified">!     if (targetCategory == UNumber) {</span>
<span class="line-modified">!         // We interpret conversion to CSS_NUMBER as conversion to a canonical unit in this value&#39;s category.</span>
          targetUnitType = canonicalUnitTypeForCategory(sourceCategory);
<span class="line-modified">!         if (targetUnitType == CSS_UNKNOWN)</span>
              return WTF::nullopt;
      }
  
<span class="line-modified">!     if (sourceUnitType == CSS_NUMBER) {</span>
<span class="line-modified">!         // We interpret conversion from CSS_NUMBER in the same way as CSSParser::validUnit() while using non-strict mode.</span>
          sourceUnitType = canonicalUnitTypeForCategory(targetCategory);
<span class="line-modified">!         if (sourceUnitType == CSS_UNKNOWN)</span>
              return WTF::nullopt;
      }
  
      double convertedValue = doubleValue();
  
<span class="line-modified">!     // First convert the value from m_primitiveUnitType to canonical type.</span>
      double factor = conversionToCanonicalUnitsScaleFactor(sourceUnitType);
      convertedValue *= factor;
  
      // Now convert from canonical type to the target unitType.
      factor = conversionToCanonicalUnitsScaleFactor(targetUnitType);
      convertedValue /= factor;
  
      return convertedValue;
  }
  
<span class="line-modified">! ExceptionOr&lt;void&gt; CSSPrimitiveValue::setStringValue(unsigned short, const String&amp;)</span>
  {
      // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
      // No other engine supports mutating style through this API. Computed style is always read-only anyway.
      // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
      return Exception { NoModificationAllowedError };
  }
  
  ExceptionOr&lt;String&gt; CSSPrimitiveValue::getStringValue() const
  {
<span class="line-modified">!     switch (m_primitiveUnitType) {</span>
<span class="line-modified">!     case CSS_STRING:</span>
<span class="line-modified">!     case CSS_ATTR:</span>
<span class="line-modified">!     case CSS_URI:</span>
          return m_value.string;
<span class="line-modified">!     case CSS_FONT_FAMILY:</span>
          return String { m_value.fontFamily-&gt;familyName };
<span class="line-modified">!     case CSS_VALUE_ID:</span>
          return String { valueName(m_value.valueID).string() };
<span class="line-modified">!     case CSS_PROPERTY_ID:</span>
          return String { propertyName(m_value.propertyID).string() };
      default:
          return Exception { InvalidAccessError };
      }
  }
  
  String CSSPrimitiveValue::stringValue() const
  {
<span class="line-modified">!     switch (m_primitiveUnitType) {</span>
<span class="line-modified">!     case CSS_STRING:</span>
<span class="line-modified">!     case CSS_ATTR:</span>
<span class="line-modified">!     case CSS_URI:</span>
          return m_value.string;
<span class="line-modified">!     case CSS_FONT_FAMILY:</span>
          return m_value.fontFamily-&gt;familyName;
<span class="line-modified">!     case CSS_VALUE_ID:</span>
          return valueName(m_value.valueID);
<span class="line-modified">!     case CSS_PROPERTY_ID:</span>
          return propertyName(m_value.propertyID);
      default:
          return String();
      }
  }
  
<span class="line-modified">! ExceptionOr&lt;Counter&amp;&gt; CSSPrimitiveValue::getCounterValue() const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     if (m_primitiveUnitType != CSS_COUNTER)</span>
<span class="line-removed">-         return Exception { InvalidAccessError };</span>
<span class="line-removed">-     return *m_value.counter;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- ExceptionOr&lt;Rect&amp;&gt; CSSPrimitiveValue::getRectValue() const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     if (m_primitiveUnitType != CSS_RECT)</span>
<span class="line-removed">-         return Exception { InvalidAccessError };</span>
<span class="line-removed">-     return *m_value.rect;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- ExceptionOr&lt;Ref&lt;RGBColor&gt;&gt; CSSPrimitiveValue::getRGBColorValue() const</span>
  {
<span class="line-modified">!     if (m_primitiveUnitType != CSS_RGBCOLOR)</span>
<span class="line-removed">-         return Exception { InvalidAccessError };</span>
<span class="line-removed">- </span>
<span class="line-removed">-     // FIXME: This should not return a new object for each invocation.</span>
<span class="line-removed">-     return RGBColor::create(m_value.color-&gt;rgb());</span>
  }
  
<span class="line-modified">! NEVER_INLINE String CSSPrimitiveValue::formatNumberValue(StringView suffix) const</span>
  {
<span class="line-modified">!     return makeString(m_value.num, suffix);</span>
  }
  
  ALWAYS_INLINE String CSSPrimitiveValue::formatNumberForCustomCSSText() const
  {
<span class="line-modified">!     switch (m_primitiveUnitType) {</span>
<span class="line-modified">!     case CSS_UNKNOWN:</span>
          return String();
<span class="line-modified">!     case CSS_NUMBER:</span>
          return formatNumberValue(&quot;&quot;);
<span class="line-modified">!     case CSS_PERCENTAGE:</span>
          return formatNumberValue(&quot;%&quot;);
<span class="line-modified">!     case CSS_EMS:</span>
<span class="line-modified">!     case CSS_QUIRKY_EMS:</span>
          return formatNumberValue(&quot;em&quot;);
<span class="line-modified">!     case CSS_EXS:</span>
          return formatNumberValue(&quot;ex&quot;);
<span class="line-modified">!     case CSS_REMS:</span>
          return formatNumberValue(&quot;rem&quot;);
<span class="line-modified">!     case CSS_CHS:</span>
          return formatNumberValue(&quot;ch&quot;);
<span class="line-modified">!     case CSS_PX:</span>
          return formatNumberValue(&quot;px&quot;);
<span class="line-modified">!     case CSS_CM:</span>
          return formatNumberValue(&quot;cm&quot;);
<span class="line-modified">! #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-removed">-     case CSS_DPPX:</span>
          return formatNumberValue(&quot;dppx&quot;);
<span class="line-modified">!     case CSS_DPI:</span>
          return formatNumberValue(&quot;dpi&quot;);
<span class="line-modified">!     case CSS_DPCM:</span>
          return formatNumberValue(&quot;dpcm&quot;);
<span class="line-modified">! #endif</span>
<span class="line-removed">-     case CSS_MM:</span>
          return formatNumberValue(&quot;mm&quot;);
<span class="line-modified">!     case CSS_IN:</span>
          return formatNumberValue(&quot;in&quot;);
<span class="line-modified">!     case CSS_PT:</span>
          return formatNumberValue(&quot;pt&quot;);
<span class="line-modified">!     case CSS_PC:</span>
          return formatNumberValue(&quot;pc&quot;);
<span class="line-modified">!     case CSS_DEG:</span>
          return formatNumberValue(&quot;deg&quot;);
<span class="line-modified">!     case CSS_RAD:</span>
          return formatNumberValue(&quot;rad&quot;);
<span class="line-modified">!     case CSS_GRAD:</span>
          return formatNumberValue(&quot;grad&quot;);
<span class="line-modified">!     case CSS_MS:</span>
          return formatNumberValue(&quot;ms&quot;);
<span class="line-modified">!     case CSS_S:</span>
          return formatNumberValue(&quot;s&quot;);
<span class="line-modified">!     case CSS_HZ:</span>
          return formatNumberValue(&quot;hz&quot;);
<span class="line-modified">!     case CSS_KHZ:</span>
          return formatNumberValue(&quot;khz&quot;);
<span class="line-modified">!     case CSS_TURN:</span>
          return formatNumberValue(&quot;turn&quot;);
<span class="line-modified">!     case CSS_FR:</span>
          return formatNumberValue(&quot;fr&quot;);
<span class="line-modified">!     case CSS_DIMENSION:</span>
<span class="line-modified">!         // FIXME: We currently don&#39;t handle CSS_DIMENSION properly as we don&#39;t store</span>
          // the actual dimension, just the numeric value as a string.
<span class="line-modified">!     case CSS_STRING:</span>
          // FIME-NEWPARSER: Once we have CSSCustomIdentValue hooked up, this can just be
          // serializeString, since custom identifiers won&#39;t be the same value as strings
          // any longer.
          return serializeAsStringOrCustomIdent(m_value.string);
<span class="line-modified">!     case CSS_FONT_FAMILY:</span>
          return serializeFontFamily(m_value.fontFamily-&gt;familyName);
<span class="line-modified">!     case CSS_URI:</span>
          return serializeURL(m_value.string);
<span class="line-modified">!     case CSS_VALUE_ID:</span>
          return valueName(m_value.valueID);
<span class="line-modified">!     case CSS_PROPERTY_ID:</span>
          return propertyName(m_value.propertyID);
<span class="line-modified">!     case CSS_ATTR:</span>
          return &quot;attr(&quot; + String(m_value.string) + &#39;)&#39;;
<span class="line-modified">!     case CSS_COUNTER_NAME:</span>
          return &quot;counter(&quot; + String(m_value.string) + &#39;)&#39;;
<span class="line-modified">!     case CSS_COUNTER: {</span>
          StringBuilder result;
          String separator = m_value.counter-&gt;separator();
          if (separator.isEmpty())
              result.appendLiteral(&quot;counter(&quot;);
          else
<span class="line-new-header">--- 676,364 ---</span>
          result *= conversionData.zoom();
  
      return result;
  }
  
<span class="line-modified">! bool CSSPrimitiveValue::equalForLengthResolution(const RenderStyle&amp; styleA, const RenderStyle&amp; styleB)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     // These properties affect results of computeNonCalcLengthDouble above.</span>
<span class="line-added">+     if (styleA.fontDescription().computedSize() != styleB.fontDescription().computedSize())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+     if (styleA.fontDescription().specifiedSize() != styleB.fontDescription().specifiedSize())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (styleA.fontMetrics().xHeight() != styleB.fontMetrics().xHeight())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+     if (styleA.fontMetrics().zeroWidth() != styleB.fontMetrics().zeroWidth())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (styleA.zoom() != styleB.zoom())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     return true;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ ExceptionOr&lt;void&gt; CSSPrimitiveValue::setFloatValue(CSSUnitType, double)</span>
  {
      // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
      // No other engine supports mutating style through this API. Computed style is always read-only anyway.
      // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
      return Exception { NoModificationAllowedError };
  }
  
<span class="line-modified">! double CSSPrimitiveValue::conversionToCanonicalUnitsScaleFactor(CSSUnitType unitType)</span>
  {
      double factor = 1.0;
      // FIXME: the switch can be replaced by an array of scale factors.
      switch (unitType) {
      // These are &quot;canonical&quot; units in their respective categories.
<span class="line-modified">!     case CSSUnitType::CSS_PX:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified">!     case CSSUnitType::CSS_MS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_HZ:</span>
<span class="line-added">+     case CSSUnitType::CSS_DPPX:</span>
<span class="line-added">+         break;</span>
<span class="line-added">+     case CSSUnitType::CSS_CM:</span>
<span class="line-added">+         factor = cssPixelsPerInch / cmPerInch;</span>
          break;
<span class="line-modified">!     case CSSUnitType::CSS_DPCM:</span>
<span class="line-modified">!         factor = cmPerInch / cssPixelsPerInch; // (2.54 cm/in)</span>
          break;
<span class="line-modified">!     case CSSUnitType::CSS_MM:</span>
<span class="line-modified">!         factor = cssPixelsPerInch / mmPerInch;</span>
          break;
<span class="line-modified">!     case CSSUnitType::CSS_Q:</span>
<span class="line-modified">!         factor = cssPixelsPerInch / QPerInch;</span>
          break;
<span class="line-modified">!     case CSSUnitType::CSS_IN:</span>
          factor = cssPixelsPerInch;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_DPI:</span>
          factor = 1 / cssPixelsPerInch;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_PT:</span>
          factor = cssPixelsPerInch / 72.0;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_PC:</span>
          factor = cssPixelsPerInch * 12.0 / 72.0; // 1 pc == 12 pt
          break;
<span class="line-modified">!     case CSSUnitType::CSS_RAD:</span>
          factor = 180 / piDouble;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_GRAD:</span>
          factor = 0.9;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_TURN:</span>
          factor = 360;
          break;
<span class="line-modified">!     case CSSUnitType::CSS_S:</span>
<span class="line-modified">!     case CSSUnitType::CSS_KHZ:</span>
          factor = 1000;
          break;
      default:
          break;
      }
  
      return factor;
  }
  
<span class="line-modified">! ExceptionOr&lt;float&gt; CSSPrimitiveValue::getFloatValue(CSSUnitType unitType) const</span>
  {
<span class="line-modified">!     auto result = doubleValueInternal(unitType);</span>
      if (!result)
          return Exception { InvalidAccessError };
      return clampTo&lt;float&gt;(result.value());
  }
  
<span class="line-modified">! double CSSPrimitiveValue::doubleValue(CSSUnitType unitType) const</span>
  {
      return doubleValueInternal(unitType).valueOr(0);
  }
  
  double CSSPrimitiveValue::doubleValue() const
  {
<span class="line-modified">!     return primitiveUnitType() != CSSUnitType::CSS_CALC ? m_value.num : m_value.calc-&gt;doubleValue();</span>
  }
  
<span class="line-added">+ Optional&lt;bool&gt; CSSPrimitiveValue::isZero() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (primitiveUnitType() == CSSUnitType::CSS_CALC)</span>
<span class="line-added">+         return WTF::nullopt;</span>
<span class="line-added">+     return !m_value.num;</span>
<span class="line-added">+ }</span>
  
<span class="line-modified">! Optional&lt;bool&gt; CSSPrimitiveValue::isPositive() const</span>
  {
<span class="line-modified">!     if (primitiveUnitType() == CSSUnitType::CSS_CALC)</span>
<span class="line-modified">!         return WTF::nullopt;</span>
<span class="line-modified">!     return m_value.num &gt; 0;</span>
<span class="line-modified">! }</span>
<span class="line-modified">! </span>
<span class="line-modified">! Optional&lt;bool&gt; CSSPrimitiveValue::isNegative() const</span>
<span class="line-modified">! {</span>
<span class="line-modified">!     if (primitiveUnitType() == CSSUnitType::CSS_CALC)</span>
<span class="line-modified">!         return WTF::nullopt;</span>
<span class="line-modified">!     return m_value.num &lt; 0;</span>
  }
  
<span class="line-modified">! Optional&lt;double&gt; CSSPrimitiveValue::doubleValueInternal(CSSUnitType requestedUnitType) const</span>
  {
<span class="line-modified">!     if (!isValidCSSUnitTypeForDoubleConversion(primitiveUnitType()) || !isValidCSSUnitTypeForDoubleConversion(requestedUnitType))</span>
          return WTF::nullopt;
  
<span class="line-modified">!     CSSUnitType sourceUnitType = primitiveType();</span>
<span class="line-modified">!     if (requestedUnitType == sourceUnitType || requestedUnitType == CSSUnitType::CSS_DIMENSION)</span>
          return doubleValue();
  
<span class="line-modified">!     CSSUnitCategory sourceCategory = unitCategory(sourceUnitType);</span>
<span class="line-modified">!     ASSERT(sourceCategory != CSSUnitCategory::Other);</span>
  
<span class="line-modified">!     CSSUnitType targetUnitType = requestedUnitType;</span>
<span class="line-modified">!     CSSUnitCategory targetCategory = unitCategory(targetUnitType);</span>
<span class="line-modified">!     ASSERT(targetCategory != CSSUnitCategory::Other);</span>
  
<span class="line-modified">!     // Cannot convert between unrelated unit categories if one of them is not CSSUnitCategory::Number.</span>
<span class="line-modified">!     if (sourceCategory != targetCategory &amp;&amp; sourceCategory != CSSUnitCategory::Number &amp;&amp; targetCategory != CSSUnitCategory::Number)</span>
          return WTF::nullopt;
  
<span class="line-modified">!     if (targetCategory == CSSUnitCategory::Number) {</span>
<span class="line-modified">!         // We interpret conversion to CSSUnitType::CSS_NUMBER as conversion to a canonical unit in this value&#39;s category.</span>
          targetUnitType = canonicalUnitTypeForCategory(sourceCategory);
<span class="line-modified">!         if (targetUnitType == CSSUnitType::CSS_UNKNOWN)</span>
              return WTF::nullopt;
      }
  
<span class="line-modified">!     if (sourceUnitType == CSSUnitType::CSS_NUMBER) {</span>
<span class="line-modified">!         // We interpret conversion from CSSUnitType::CSS_NUMBER in the same way as CSSParser::validUnit() while using non-strict mode.</span>
          sourceUnitType = canonicalUnitTypeForCategory(targetCategory);
<span class="line-modified">!         if (sourceUnitType == CSSUnitType::CSS_UNKNOWN)</span>
              return WTF::nullopt;
      }
  
      double convertedValue = doubleValue();
  
<span class="line-modified">!     // First convert the value from primitiveUnitType() to canonical type.</span>
      double factor = conversionToCanonicalUnitsScaleFactor(sourceUnitType);
      convertedValue *= factor;
  
      // Now convert from canonical type to the target unitType.
      factor = conversionToCanonicalUnitsScaleFactor(targetUnitType);
      convertedValue /= factor;
  
      return convertedValue;
  }
  
<span class="line-modified">! ExceptionOr&lt;void&gt; CSSPrimitiveValue::setStringValue(CSSUnitType, const String&amp;)</span>
  {
      // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
      // No other engine supports mutating style through this API. Computed style is always read-only anyway.
      // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
      return Exception { NoModificationAllowedError };
  }
  
  ExceptionOr&lt;String&gt; CSSPrimitiveValue::getStringValue() const
  {
<span class="line-modified">!     switch (primitiveUnitType()) {</span>
<span class="line-modified">!     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified">!     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified">!     case CSSUnitType::CSS_URI:</span>
          return m_value.string;
<span class="line-modified">!     case CSSUnitType::CSS_FONT_FAMILY:</span>
          return String { m_value.fontFamily-&gt;familyName };
<span class="line-modified">!     case CSSUnitType::CSS_VALUE_ID:</span>
          return String { valueName(m_value.valueID).string() };
<span class="line-modified">!     case CSSUnitType::CSS_PROPERTY_ID:</span>
          return String { propertyName(m_value.propertyID).string() };
      default:
          return Exception { InvalidAccessError };
      }
  }
  
  String CSSPrimitiveValue::stringValue() const
  {
<span class="line-modified">!     switch (primitiveUnitType()) {</span>
<span class="line-modified">!     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified">!     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified">!     case CSSUnitType::CSS_URI:</span>
          return m_value.string;
<span class="line-modified">!     case CSSUnitType::CSS_FONT_FAMILY:</span>
          return m_value.fontFamily-&gt;familyName;
<span class="line-modified">!     case CSSUnitType::CSS_VALUE_ID:</span>
          return valueName(m_value.valueID);
<span class="line-modified">!     case CSSUnitType::CSS_PROPERTY_ID:</span>
          return propertyName(m_value.propertyID);
      default:
          return String();
      }
  }
  
<span class="line-modified">! NEVER_INLINE String CSSPrimitiveValue::formatNumberValue(StringView suffix) const</span>
  {
<span class="line-modified">!     return makeString(m_value.num, suffix);</span>
  }
  
<span class="line-modified">! String CSSPrimitiveValue::unitTypeString(CSSUnitType unitType)</span>
  {
<span class="line-modified">!     switch (unitType) {</span>
<span class="line-added">+         case CSSUnitType::CSS_PERCENTAGE: return &quot;%&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_EMS: return &quot;em&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_EXS: return &quot;ex&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_PX: return &quot;px&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_CM: return &quot;cm&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_MM: return &quot;mm&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_IN: return &quot;in&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_PT: return &quot;pt&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_PC: return &quot;pc&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_DEG: return &quot;deg&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_RAD: return &quot;rad&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_GRAD: return &quot;grad&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_MS: return &quot;ms&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_S: return &quot;s&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_HZ: return &quot;hz&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_KHZ: return &quot;khz&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_VW: return &quot;vw&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_VH: return &quot;vh&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_VMIN: return &quot;vmin&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_VMAX: return &quot;vmax&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_DPPX: return &quot;dppx&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_DPI: return &quot;dpi&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_DPCM: return &quot;dpcm&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_FR: return &quot;fr&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_Q: return &quot;q&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_TURN: return &quot;turn&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_REMS: return &quot;rem&quot;;</span>
<span class="line-added">+         case CSSUnitType::CSS_CHS: return &quot;ch&quot;;</span>
<span class="line-added">+ </span>
<span class="line-added">+         case CSSUnitType::CSS_UNKNOWN:</span>
<span class="line-added">+         case CSSUnitType::CSS_NUMBER:</span>
<span class="line-added">+         case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-added">+         case CSSUnitType::CSS_STRING:</span>
<span class="line-added">+         case CSSUnitType::CSS_URI:</span>
<span class="line-added">+         case CSSUnitType::CSS_IDENT:</span>
<span class="line-added">+         case CSSUnitType::CSS_ATTR:</span>
<span class="line-added">+         case CSSUnitType::CSS_COUNTER:</span>
<span class="line-added">+         case CSSUnitType::CSS_RECT:</span>
<span class="line-added">+         case CSSUnitType::CSS_RGBCOLOR:</span>
<span class="line-added">+         case CSSUnitType::CSS_PAIR:</span>
<span class="line-added">+         case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-added">+         case CSSUnitType::CSS_COUNTER_NAME:</span>
<span class="line-added">+         case CSSUnitType::CSS_SHAPE:</span>
<span class="line-added">+         case CSSUnitType::CSS_QUAD:</span>
<span class="line-added">+         case CSSUnitType::CSS_CALC:</span>
<span class="line-added">+         case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-added">+         case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-added">+         case CSSUnitType::CSS_FONT_FAMILY:</span>
<span class="line-added">+         case CSSUnitType::CSS_PROPERTY_ID:</span>
<span class="line-added">+         case CSSUnitType::CSS_VALUE_ID:</span>
<span class="line-added">+         case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-added">+             return emptyString();</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return emptyString();</span>
  }
  
  ALWAYS_INLINE String CSSPrimitiveValue::formatNumberForCustomCSSText() const
  {
<span class="line-modified">!     switch (primitiveUnitType()) {</span>
<span class="line-modified">!     case CSSUnitType::CSS_UNKNOWN:</span>
          return String();
<span class="line-modified">!     case CSSUnitType::CSS_NUMBER:</span>
          return formatNumberValue(&quot;&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_PERCENTAGE:</span>
          return formatNumberValue(&quot;%&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_QUIRKY_EMS:</span>
          return formatNumberValue(&quot;em&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_EXS:</span>
          return formatNumberValue(&quot;ex&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_REMS:</span>
          return formatNumberValue(&quot;rem&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_CHS:</span>
          return formatNumberValue(&quot;ch&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_PX:</span>
          return formatNumberValue(&quot;px&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_CM:</span>
          return formatNumberValue(&quot;cm&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_DPPX:</span>
          return formatNumberValue(&quot;dppx&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_DPI:</span>
          return formatNumberValue(&quot;dpi&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_DPCM:</span>
          return formatNumberValue(&quot;dpcm&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_MM:</span>
          return formatNumberValue(&quot;mm&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_IN:</span>
          return formatNumberValue(&quot;in&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_PT:</span>
          return formatNumberValue(&quot;pt&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_PC:</span>
          return formatNumberValue(&quot;pc&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_DEG:</span>
          return formatNumberValue(&quot;deg&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_RAD:</span>
          return formatNumberValue(&quot;rad&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_GRAD:</span>
          return formatNumberValue(&quot;grad&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_MS:</span>
          return formatNumberValue(&quot;ms&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_S:</span>
          return formatNumberValue(&quot;s&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_HZ:</span>
          return formatNumberValue(&quot;hz&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_KHZ:</span>
          return formatNumberValue(&quot;khz&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_TURN:</span>
          return formatNumberValue(&quot;turn&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_FR:</span>
          return formatNumberValue(&quot;fr&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_Q:</span>
<span class="line-modified">!         return formatNumberValue(&quot;q&quot;);</span>
<span class="line-added">+     case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-added">+         // FIXME: We currently don&#39;t handle CSSUnitType::CSS_DIMENSION properly as we don&#39;t store</span>
          // the actual dimension, just the numeric value as a string.
<span class="line-modified">!     case CSSUnitType::CSS_STRING:</span>
          // FIME-NEWPARSER: Once we have CSSCustomIdentValue hooked up, this can just be
          // serializeString, since custom identifiers won&#39;t be the same value as strings
          // any longer.
          return serializeAsStringOrCustomIdent(m_value.string);
<span class="line-modified">!     case CSSUnitType::CSS_FONT_FAMILY:</span>
          return serializeFontFamily(m_value.fontFamily-&gt;familyName);
<span class="line-modified">!     case CSSUnitType::CSS_URI:</span>
          return serializeURL(m_value.string);
<span class="line-modified">!     case CSSUnitType::CSS_VALUE_ID:</span>
          return valueName(m_value.valueID);
<span class="line-modified">!     case CSSUnitType::CSS_PROPERTY_ID:</span>
          return propertyName(m_value.propertyID);
<span class="line-modified">!     case CSSUnitType::CSS_ATTR:</span>
          return &quot;attr(&quot; + String(m_value.string) + &#39;)&#39;;
<span class="line-modified">!     case CSSUnitType::CSS_COUNTER_NAME:</span>
          return &quot;counter(&quot; + String(m_value.string) + &#39;)&#39;;
<span class="line-modified">!     case CSSUnitType::CSS_COUNTER: {</span>
          StringBuilder result;
          String separator = m_value.counter-&gt;separator();
          if (separator.isEmpty())
              result.appendLiteral(&quot;counter(&quot;);
          else
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1007,30 ***</span>
              result.append(&quot;, &quot;, listStyle);
          result.append(&#39;)&#39;);
  
          return result.toString();
      }
<span class="line-modified">!     case CSS_RECT:</span>
          return rectValue()-&gt;cssText();
<span class="line-modified">!     case CSS_QUAD:</span>
          return quadValue()-&gt;cssText();
<span class="line-modified">!     case CSS_RGBCOLOR:</span>
          return color().cssText();
<span class="line-modified">!     case CSS_PAIR:</span>
          return pairValue()-&gt;cssText();
<span class="line-modified">!     case CSS_CALC:</span>
          return m_value.calc-&gt;cssText();
<span class="line-modified">!     case CSS_SHAPE:</span>
          return m_value.shape-&gt;cssText();
<span class="line-modified">!     case CSS_VW:</span>
          return formatNumberValue(&quot;vw&quot;);
<span class="line-modified">!     case CSS_VH:</span>
          return formatNumberValue(&quot;vh&quot;);
<span class="line-modified">!     case CSS_VMIN:</span>
          return formatNumberValue(&quot;vmin&quot;);
<span class="line-modified">!     case CSS_VMAX:</span>
          return formatNumberValue(&quot;vmax&quot;);
      }
      return String();
  }
  
  String CSSPrimitiveValue::customCSSText() const
<span class="line-new-header">--- 1049,35 ---</span>
              result.append(&quot;, &quot;, listStyle);
          result.append(&#39;)&#39;);
  
          return result.toString();
      }
<span class="line-modified">!     case CSSUnitType::CSS_RECT:</span>
          return rectValue()-&gt;cssText();
<span class="line-modified">!     case CSSUnitType::CSS_QUAD:</span>
          return quadValue()-&gt;cssText();
<span class="line-modified">!     case CSSUnitType::CSS_RGBCOLOR:</span>
          return color().cssText();
<span class="line-modified">!     case CSSUnitType::CSS_PAIR:</span>
          return pairValue()-&gt;cssText();
<span class="line-modified">!     case CSSUnitType::CSS_CALC:</span>
          return m_value.calc-&gt;cssText();
<span class="line-modified">!     case CSSUnitType::CSS_SHAPE:</span>
          return m_value.shape-&gt;cssText();
<span class="line-modified">!     case CSSUnitType::CSS_VW:</span>
          return formatNumberValue(&quot;vw&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_VH:</span>
          return formatNumberValue(&quot;vh&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_VMIN:</span>
          return formatNumberValue(&quot;vmin&quot;);
<span class="line-modified">!     case CSSUnitType::CSS_VMAX:</span>
          return formatNumberValue(&quot;vmax&quot;);
<span class="line-added">+     case CSSUnitType::CSS_IDENT:</span>
<span class="line-added">+     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-added">+     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-added">+     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-added">+         ASSERT_NOT_REACHED();</span>
      }
      return String();
  }
  
  String CSSPrimitiveValue::customCSSText() const
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1053,72 ***</span>
      return text;
  }
  
  bool CSSPrimitiveValue::equals(const CSSPrimitiveValue&amp; other) const
  {
<span class="line-modified">!     if (m_primitiveUnitType != other.m_primitiveUnitType)</span>
          return false;
  
<span class="line-modified">!     switch (m_primitiveUnitType) {</span>
<span class="line-modified">!     case CSS_UNKNOWN:</span>
          return false;
<span class="line-modified">!     case CSS_NUMBER:</span>
<span class="line-modified">!     case CSS_PERCENTAGE:</span>
<span class="line-modified">!     case CSS_EMS:</span>
<span class="line-modified">!     case CSS_QUIRKY_EMS:</span>
<span class="line-modified">!     case CSS_EXS:</span>
<span class="line-modified">!     case CSS_REMS:</span>
<span class="line-modified">!     case CSS_PX:</span>
<span class="line-modified">!     case CSS_CM:</span>
<span class="line-modified">! #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-modified">!     case CSS_DPPX:</span>
<span class="line-modified">!     case CSS_DPI:</span>
<span class="line-modified">!     case CSS_DPCM:</span>
<span class="line-modified">! #endif</span>
<span class="line-modified">!     case CSS_MM:</span>
<span class="line-modified">!     case CSS_IN:</span>
<span class="line-modified">!     case CSS_PT:</span>
<span class="line-modified">!     case CSS_PC:</span>
<span class="line-modified">!     case CSS_DEG:</span>
<span class="line-modified">!     case CSS_RAD:</span>
<span class="line-modified">!     case CSS_GRAD:</span>
<span class="line-modified">!     case CSS_MS:</span>
<span class="line-modified">!     case CSS_S:</span>
<span class="line-modified">!     case CSS_HZ:</span>
<span class="line-modified">!     case CSS_KHZ:</span>
<span class="line-modified">!     case CSS_TURN:</span>
<span class="line-modified">!     case CSS_VW:</span>
<span class="line-modified">!     case CSS_VH:</span>
<span class="line-modified">!     case CSS_VMIN:</span>
<span class="line-modified">!     case CSS_FR:</span>
          return m_value.num == other.m_value.num;
<span class="line-modified">!     case CSS_PROPERTY_ID:</span>
          return propertyName(m_value.propertyID) == propertyName(other.m_value.propertyID);
<span class="line-modified">!     case CSS_VALUE_ID:</span>
          return valueName(m_value.valueID) == valueName(other.m_value.valueID);
<span class="line-modified">!     case CSS_DIMENSION:</span>
<span class="line-modified">!     case CSS_STRING:</span>
<span class="line-modified">!     case CSS_URI:</span>
<span class="line-modified">!     case CSS_ATTR:</span>
<span class="line-modified">!     case CSS_COUNTER_NAME:</span>
          return equal(m_value.string, other.m_value.string);
<span class="line-modified">!     case CSS_COUNTER:</span>
          return m_value.counter &amp;&amp; other.m_value.counter &amp;&amp; m_value.counter-&gt;equals(*other.m_value.counter);
<span class="line-modified">!     case CSS_RECT:</span>
          return m_value.rect &amp;&amp; other.m_value.rect &amp;&amp; m_value.rect-&gt;equals(*other.m_value.rect);
<span class="line-modified">!     case CSS_QUAD:</span>
          return m_value.quad &amp;&amp; other.m_value.quad &amp;&amp; m_value.quad-&gt;equals(*other.m_value.quad);
<span class="line-modified">!     case CSS_RGBCOLOR:</span>
          return color() == other.color();
<span class="line-modified">!     case CSS_PAIR:</span>
          return m_value.pair &amp;&amp; other.m_value.pair &amp;&amp; m_value.pair-&gt;equals(*other.m_value.pair);
<span class="line-modified">!     case CSS_CALC:</span>
          return m_value.calc &amp;&amp; other.m_value.calc &amp;&amp; m_value.calc-&gt;equals(*other.m_value.calc);
<span class="line-modified">!     case CSS_SHAPE:</span>
          return m_value.shape &amp;&amp; other.m_value.shape &amp;&amp; m_value.shape-&gt;equals(*other.m_value.shape);
<span class="line-modified">!     case CSS_FONT_FAMILY:</span>
          return fontFamily() == other.fontFamily();
      }
      return false;
  }
  
  Ref&lt;DeprecatedCSSOMPrimitiveValue&gt; CSSPrimitiveValue::createDeprecatedCSSOMPrimitiveWrapper(CSSStyleDeclaration&amp; styleDeclaration) const
<span class="line-new-header">--- 1100,80 ---</span>
      return text;
  }
  
  bool CSSPrimitiveValue::equals(const CSSPrimitiveValue&amp; other) const
  {
<span class="line-modified">!     if (primitiveUnitType() != other.primitiveUnitType())</span>
          return false;
  
<span class="line-modified">!     switch (primitiveUnitType()) {</span>
<span class="line-modified">!     case CSSUnitType::CSS_UNKNOWN:</span>
          return false;
<span class="line-modified">!     case CSSUnitType::CSS_NUMBER:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PERCENTAGE:</span>
<span class="line-modified">!     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_REMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CHS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PX:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CM:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DPPX:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DPI:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DPCM:</span>
<span class="line-modified">!     case CSSUnitType::CSS_MM:</span>
<span class="line-modified">!     case CSSUnitType::CSS_IN:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PT:</span>
<span class="line-modified">!     case CSSUnitType::CSS_PC:</span>
<span class="line-modified">!     case CSSUnitType::CSS_DEG:</span>
<span class="line-modified">!     case CSSUnitType::CSS_RAD:</span>
<span class="line-modified">!     case CSSUnitType::CSS_GRAD:</span>
<span class="line-modified">!     case CSSUnitType::CSS_MS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_S:</span>
<span class="line-modified">!     case CSSUnitType::CSS_HZ:</span>
<span class="line-modified">!     case CSSUnitType::CSS_KHZ:</span>
<span class="line-modified">!     case CSSUnitType::CSS_TURN:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VW:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VH:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VMIN:</span>
<span class="line-modified">!     case CSSUnitType::CSS_VMAX:</span>
<span class="line-modified">!     case CSSUnitType::CSS_FR:</span>
<span class="line-added">+     case CSSUnitType::CSS_Q:</span>
          return m_value.num == other.m_value.num;
<span class="line-modified">!     case CSSUnitType::CSS_PROPERTY_ID:</span>
          return propertyName(m_value.propertyID) == propertyName(other.m_value.propertyID);
<span class="line-modified">!     case CSSUnitType::CSS_VALUE_ID:</span>
          return valueName(m_value.valueID) == valueName(other.m_value.valueID);
<span class="line-modified">!     case CSSUnitType::CSS_DIMENSION:</span>
<span class="line-modified">!     case CSSUnitType::CSS_STRING:</span>
<span class="line-modified">!     case CSSUnitType::CSS_URI:</span>
<span class="line-modified">!     case CSSUnitType::CSS_ATTR:</span>
<span class="line-modified">!     case CSSUnitType::CSS_COUNTER_NAME:</span>
          return equal(m_value.string, other.m_value.string);
<span class="line-modified">!     case CSSUnitType::CSS_COUNTER:</span>
          return m_value.counter &amp;&amp; other.m_value.counter &amp;&amp; m_value.counter-&gt;equals(*other.m_value.counter);
<span class="line-modified">!     case CSSUnitType::CSS_RECT:</span>
          return m_value.rect &amp;&amp; other.m_value.rect &amp;&amp; m_value.rect-&gt;equals(*other.m_value.rect);
<span class="line-modified">!     case CSSUnitType::CSS_QUAD:</span>
          return m_value.quad &amp;&amp; other.m_value.quad &amp;&amp; m_value.quad-&gt;equals(*other.m_value.quad);
<span class="line-modified">!     case CSSUnitType::CSS_RGBCOLOR:</span>
          return color() == other.color();
<span class="line-modified">!     case CSSUnitType::CSS_PAIR:</span>
          return m_value.pair &amp;&amp; other.m_value.pair &amp;&amp; m_value.pair-&gt;equals(*other.m_value.pair);
<span class="line-modified">!     case CSSUnitType::CSS_CALC:</span>
          return m_value.calc &amp;&amp; other.m_value.calc &amp;&amp; m_value.calc-&gt;equals(*other.m_value.calc);
<span class="line-modified">!     case CSSUnitType::CSS_SHAPE:</span>
          return m_value.shape &amp;&amp; other.m_value.shape &amp;&amp; m_value.shape-&gt;equals(*other.m_value.shape);
<span class="line-modified">!     case CSSUnitType::CSS_FONT_FAMILY:</span>
          return fontFamily() == other.fontFamily();
<span class="line-added">+     case CSSUnitType::CSS_IDENT:</span>
<span class="line-added">+     case CSSUnitType::CSS_UNICODE_RANGE:</span>
<span class="line-added">+     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-added">+     case CSSUnitType::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-added">+         // FIXME: seems like these should be handled.</span>
<span class="line-added">+         ASSERT_NOT_REACHED();</span>
<span class="line-added">+         break;</span>
      }
      return false;
  }
  
  Ref&lt;DeprecatedCSSOMPrimitiveValue&gt; CSSPrimitiveValue::createDeprecatedCSSOMPrimitiveWrapper(CSSStyleDeclaration&amp; styleDeclaration) const
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1127,31 ***</span>
  }
  
  // https://drafts.css-houdini.org/css-properties-values-api/#dependency-cycles-via-relative-units
  void CSSPrimitiveValue::collectDirectComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
  {
<span class="line-modified">!     switch (m_primitiveUnitType) {</span>
<span class="line-modified">!     case CSS_EMS:</span>
<span class="line-modified">!     case CSS_QUIRKY_EMS:</span>
<span class="line-modified">!     case CSS_EXS:</span>
<span class="line-modified">!     case CSS_CHS:</span>
          values.add(CSSPropertyFontSize);
          break;
<span class="line-modified">!     case CSS_CALC:</span>
          m_value.calc-&gt;collectDirectComputationalDependencies(values);
          break;
      }
  }
  
  void CSSPrimitiveValue::collectDirectRootComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
  {
<span class="line-modified">!     switch (m_primitiveUnitType) {</span>
<span class="line-modified">!     case CSS_REMS:</span>
          values.add(CSSPropertyFontSize);
          break;
<span class="line-modified">!     case CSS_CALC:</span>
          m_value.calc-&gt;collectDirectRootComputationalDependencies(values);
          break;
      }
  }
  
  } // namespace WebCore
<span class="line-new-header">--- 1182,35 ---</span>
  }
  
  // https://drafts.css-houdini.org/css-properties-values-api/#dependency-cycles-via-relative-units
  void CSSPrimitiveValue::collectDirectComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
  {
<span class="line-modified">!     switch (primitiveUnitType()) {</span>
<span class="line-modified">!     case CSSUnitType::CSS_EMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_QUIRKY_EMS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_EXS:</span>
<span class="line-modified">!     case CSSUnitType::CSS_CHS:</span>
          values.add(CSSPropertyFontSize);
          break;
<span class="line-modified">!     case CSSUnitType::CSS_CALC:</span>
          m_value.calc-&gt;collectDirectComputationalDependencies(values);
          break;
<span class="line-added">+     default:</span>
<span class="line-added">+         break;</span>
      }
  }
  
  void CSSPrimitiveValue::collectDirectRootComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
  {
<span class="line-modified">!     switch (primitiveUnitType()) {</span>
<span class="line-modified">!     case CSSUnitType::CSS_REMS:</span>
          values.add(CSSPropertyFontSize);
          break;
<span class="line-modified">!     case CSSUnitType::CSS_CALC:</span>
          m_value.calc-&gt;collectDirectRootComputationalDependencies(values);
          break;
<span class="line-added">+     default:</span>
<span class="line-added">+         break;</span>
      }
  }
  
  } // namespace WebCore
</pre>
<center><a href="CSSNamedImageValue.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CSSPrimitiveValue.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>