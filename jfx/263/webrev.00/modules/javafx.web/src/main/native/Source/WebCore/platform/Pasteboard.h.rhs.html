<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/platform/Pasteboard.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2006-2018 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
 28 #include &quot;DragImage.h&quot;
<a name="1" id="anc1"></a><span class="line-added"> 29 #include &quot;PasteboardCustomData.h&quot;</span>
 30 #include &quot;PasteboardItemInfo.h&quot;
 31 #include &lt;wtf/HashMap.h&gt;
 32 #include &lt;wtf/ListHashSet.h&gt;
 33 #include &lt;wtf/Noncopyable.h&gt;
 34 #include &lt;wtf/URL.h&gt;
 35 #include &lt;wtf/Vector.h&gt;
 36 #include &lt;wtf/text/WTFString.h&gt;
 37 
 38 #if PLATFORM(IOS_FAMILY)
 39 OBJC_CLASS NSString;
 40 #endif
 41 
 42 #if PLATFORM(COCOA)
 43 OBJC_CLASS NSArray;
 44 #endif
 45 
 46 #if PLATFORM(WIN)
 47 #include &quot;COMPtr.h&quot;
 48 #include &quot;WCDataObject.h&quot;
 49 #include &lt;objidl.h&gt;
 50 #include &lt;windows.h&gt;
 51 typedef struct HWND__* HWND;
 52 #endif
 53 
 54 #if PLATFORM(JAVA)
 55 #include &quot;DataObjectJava.h&quot;
 56 #endif
 57 
 58 // FIXME: This class uses the DOM and makes calls to Editor.
 59 // It should be divested of its knowledge of the frame and editor.
 60 
 61 namespace WebCore {
 62 
 63 class DocumentFragment;
 64 class DragData;
 65 class Element;
 66 class Frame;
 67 class PasteboardStrategy;
 68 class Range;
 69 class SelectionData;
 70 class SharedBuffer;
 71 
<a name="2" id="anc2"></a><span class="line-modified"> 72 enum class PlainTextURLReadingPolicy : bool { IgnoreURL, AllowURL };</span>
<span class="line-added"> 73 enum class WebContentReadingPolicy : bool { AnyType, OnlyRichTextTypes };</span>
 74 enum ShouldSerializeSelectedTextForDataTransfer { DefaultSelectedTextType, IncludeImageAltTextForDataTransfer };
 75 
 76 // For writing to the pasteboard. Generally sorted with the richest formats on top.
 77 
 78 struct PasteboardWebContent {
 79 #if PLATFORM(COCOA)
 80     WEBCORE_EXPORT PasteboardWebContent();
 81     WEBCORE_EXPORT ~PasteboardWebContent();
 82     String contentOrigin;
 83     bool canSmartCopyOrDelete;
 84     RefPtr&lt;SharedBuffer&gt; dataInWebArchiveFormat;
 85     RefPtr&lt;SharedBuffer&gt; dataInRTFDFormat;
 86     RefPtr&lt;SharedBuffer&gt; dataInRTFFormat;
 87     RefPtr&lt;SharedBuffer&gt; dataInAttributedStringFormat;
 88     String dataInHTMLFormat;
 89     String dataInStringFormat;
 90     Vector&lt;String&gt; clientTypes;
 91     Vector&lt;RefPtr&lt;SharedBuffer&gt;&gt; clientData;
 92 #endif
 93 #if PLATFORM(GTK)
 94     bool canSmartCopyOrDelete;
 95     String text;
 96     String markup;
 97 #endif
 98 #if USE(LIBWPE)
 99     String text;
100     String markup;
101 #endif
102 };
103 
104 struct PasteboardURL {
105     URL url;
106     String title;
107 #if PLATFORM(MAC)
108     String userVisibleForm;
109 #endif
110 #if PLATFORM(GTK)
111     String markup;
112 #endif
113 };
114 
115 struct PasteboardImage {
116     WEBCORE_EXPORT PasteboardImage();
117     WEBCORE_EXPORT ~PasteboardImage();
118     RefPtr&lt;Image&gt; image;
119 #if PLATFORM(MAC)
120     RefPtr&lt;SharedBuffer&gt; dataInWebArchiveFormat;
121 #endif
122 #if !PLATFORM(WIN)
123     PasteboardURL url;
124 #endif
125 #if !(PLATFORM(GTK) || PLATFORM(WIN) || PLATFORM(JAVA))
126     RefPtr&lt;SharedBuffer&gt; resourceData;
127     String resourceMIMEType;
128     Vector&lt;String&gt; clientTypes;
129     Vector&lt;RefPtr&lt;SharedBuffer&gt;&gt; clientData;
130 #endif
131     String suggestedName;
132     FloatSize imageSize;
133 };
134 
135 // For reading from the pasteboard.
136 
137 class PasteboardWebContentReader {
138 public:
139     String contentOrigin;
140 
141     virtual ~PasteboardWebContentReader() = default;
142 
143 #if PLATFORM(COCOA)
144     virtual bool readWebArchive(SharedBuffer&amp;) = 0;
145     virtual bool readFilePath(const String&amp;, PresentationSize preferredPresentationSize = { }, const String&amp; contentType = { }) = 0;
146     virtual bool readFilePaths(const Vector&lt;String&gt;&amp;) = 0;
147     virtual bool readHTML(const String&amp;) = 0;
148     virtual bool readRTFD(SharedBuffer&amp;) = 0;
149     virtual bool readRTF(SharedBuffer&amp;) = 0;
150     virtual bool readImage(Ref&lt;SharedBuffer&gt;&amp;&amp;, const String&amp; type, PresentationSize preferredPresentationSize = { }) = 0;
151     virtual bool readURL(const URL&amp;, const String&amp; title) = 0;
152     virtual bool readDataBuffer(SharedBuffer&amp;, const String&amp; type, const String&amp; name, PresentationSize preferredPresentationSize = { }) = 0;
<a name="3" id="anc3"></a>
153     virtual bool readPlainText(const String&amp;) = 0;
<a name="4" id="anc4"></a><span class="line-added">154 #endif</span>
155 };
156 
157 struct PasteboardPlainText {
158     String text;
159 #if PLATFORM(COCOA)
160     bool isURL;
161 #endif
162 };
163 
164 struct PasteboardFileReader {
165     virtual ~PasteboardFileReader() = default;
166     virtual void readFilename(const String&amp;) = 0;
167     virtual void readBuffer(const String&amp; filename, const String&amp; type, Ref&lt;SharedBuffer&gt;&amp;&amp;) = 0;
168 };
169 
<a name="5" id="anc5"></a>














170 class Pasteboard {
171     WTF_MAKE_NONCOPYABLE(Pasteboard); WTF_MAKE_FAST_ALLOCATED;
172 public:
173     Pasteboard();
174     virtual ~Pasteboard();
175 
176 #if PLATFORM(GTK)
177     explicit Pasteboard(const String&amp; name);
178     explicit Pasteboard(SelectionData&amp;);
179 #endif
180 
181 #if PLATFORM(WIN)
182     explicit Pasteboard(IDataObject*);
183     explicit Pasteboard(WCDataObject*);
184     explicit Pasteboard(const DragDataMap&amp;);
185 #endif
186 
187     WEBCORE_EXPORT static std::unique_ptr&lt;Pasteboard&gt; createForCopyAndPaste();
188 
189     static bool isSafeTypeForDOMToReadAndWrite(const String&amp;);
190     static bool canExposeURLToDOMWhenPasteboardContainsFiles(const String&amp;);
191 
192     virtual bool isStatic() const { return false; }
193 
194     virtual WEBCORE_EXPORT bool hasData();
195     virtual WEBCORE_EXPORT Vector&lt;String&gt; typesSafeForBindings(const String&amp; origin);
196     virtual WEBCORE_EXPORT Vector&lt;String&gt; typesForLegacyUnsafeBindings();
197     virtual WEBCORE_EXPORT String readOrigin();
198     virtual WEBCORE_EXPORT String readString(const String&amp; type);
199     virtual WEBCORE_EXPORT String readStringInCustomData(const String&amp; type);
200     virtual WEBCORE_EXPORT Vector&lt;String&gt; readAllStrings(const String&amp; type);
201 
202     virtual WEBCORE_EXPORT void writeString(const String&amp; type, const String&amp; data);
203     virtual WEBCORE_EXPORT void clear();
204     virtual WEBCORE_EXPORT void clear(const String&amp; type);
205 
<a name="6" id="anc6"></a><span class="line-modified">206     virtual WEBCORE_EXPORT void read(PasteboardPlainText&amp;, PlainTextURLReadingPolicy = PlainTextURLReadingPolicy::AllowURL, Optional&lt;size_t&gt; itemIndex = WTF::nullopt);</span>
<span class="line-modified">207     virtual WEBCORE_EXPORT void read(PasteboardWebContentReader&amp;, WebContentReadingPolicy = WebContentReadingPolicy::AnyType, Optional&lt;size_t&gt; itemIndex = WTF::nullopt);</span>
208     virtual WEBCORE_EXPORT void read(PasteboardFileReader&amp;);
209 
210     virtual WEBCORE_EXPORT void write(const Color&amp;);
211     virtual WEBCORE_EXPORT void write(const PasteboardURL&amp;);
212     virtual WEBCORE_EXPORT void writeTrustworthyWebURLsPboardType(const PasteboardURL&amp;);
213     virtual WEBCORE_EXPORT void write(const PasteboardImage&amp;);
214     virtual WEBCORE_EXPORT void write(const PasteboardWebContent&amp;);
215 
<a name="7" id="anc7"></a><span class="line-modified">216     virtual WEBCORE_EXPORT void writeCustomData(const Vector&lt;PasteboardCustomData&gt;&amp;);</span>
217 
218     enum class FileContentState { NoFileOrImageData, InMemoryImage, MayContainFilePaths };
219     virtual WEBCORE_EXPORT FileContentState fileContentState();
220     virtual WEBCORE_EXPORT bool canSmartReplace();
221 
222     virtual WEBCORE_EXPORT void writeMarkup(const String&amp; markup);
223     enum SmartReplaceOption { CanSmartReplace, CannotSmartReplace };
224     virtual WEBCORE_EXPORT void writePlainText(const String&amp;, SmartReplaceOption); // FIXME: Two separate functions would be clearer than one function with an argument.
225 
226 #if PLATFORM(JAVA)
227     RefPtr&lt;DataObjectJava&gt; dataObject() const { return m_dataObject; }
228 #endif
229 
230 #if ENABLE(DRAG_SUPPORT)
231     WEBCORE_EXPORT static std::unique_ptr&lt;Pasteboard&gt; createForDragAndDrop();
232     WEBCORE_EXPORT static std::unique_ptr&lt;Pasteboard&gt; createForDragAndDrop(const DragData&amp;);
233 
234     virtual void setDragImage(DragImage, const IntPoint&amp; hotSpot);
235 #endif
236 
237 #if PLATFORM(WIN) || PLATFORM(JAVA)
238     RefPtr&lt;DocumentFragment&gt; documentFragment(Frame&amp;, Range&amp;, bool allowPlainText, bool&amp; chosePlainText); // FIXME: Layering violation.
239     void writeImage(Element&amp;, const URL&amp;, const String&amp; title); // FIXME: Layering violation.
240     void writeSelection(Range&amp;, bool canSmartCopyOrDelete, Frame&amp;, ShouldSerializeSelectedTextForDataTransfer = DefaultSelectedTextType); // FIXME: Layering violation.
241 #endif
242 
243 #if PLATFORM(GTK)
244     const SelectionData&amp; selectionData() const;
245     static std::unique_ptr&lt;Pasteboard&gt; createForGlobalSelection();
246 #endif
247 
248 #if PLATFORM(IOS_FAMILY)
<a name="8" id="anc8"></a><span class="line-modified">249     explicit Pasteboard(int64_t changeCount);</span>
250     explicit Pasteboard(const String&amp; pasteboardName);
251 
252     static NSArray *supportedWebContentPasteboardTypes();
253     static String resourceMIMEType(NSString *mimeType);
254 #endif
255 
256 #if PLATFORM(MAC)
257     explicit Pasteboard(const String&amp; pasteboardName, const Vector&lt;String&gt;&amp; promisedFilePaths = { });
258 #endif
259 
260 #if PLATFORM(COCOA)
261     static bool shouldTreatCocoaTypeAsFile(const String&amp;);
262     WEBCORE_EXPORT static NSArray *supportedFileUploadPasteboardTypes();
<a name="9" id="anc9"></a><span class="line-modified">263     int64_t changeCount() const;</span>

264     const PasteboardCustomData&amp; readCustomData();
<a name="10" id="anc10"></a><span class="line-added">265 #else</span>
<span class="line-added">266     int64_t changeCount() const { return 0; }</span>
<span class="line-added">267 #endif</span>
<span class="line-added">268 </span>
<span class="line-added">269 #if PLATFORM(COCOA)</span>
<span class="line-added">270     const String&amp; name() const { return m_pasteboardName; }</span>
<span class="line-added">271 #else</span>
<span class="line-added">272     const String&amp; name() const { return emptyString(); }</span>
273 #endif
274 
275 #if PLATFORM(WIN)
276     COMPtr&lt;IDataObject&gt; dataObject() const { return m_dataObject; }
277     void setExternalDataObject(IDataObject*);
278     const DragDataMap&amp; dragDataMap() const { return m_dragDataMap; }
279     void writeURLToWritableDataObject(const URL&amp;, const String&amp;);
280     COMPtr&lt;WCDataObject&gt; writableDataObject() const { return m_writableDataObject; }
281     void writeImageToDataObject(Element&amp;, const URL&amp;); // FIXME: Layering violation.
282 #endif
283 
<a name="11" id="anc11"></a><span class="line-added">284     Optional&lt;Vector&lt;PasteboardItemInfo&gt;&gt; allPasteboardItemInfo() const;</span>
<span class="line-added">285     Optional&lt;PasteboardItemInfo&gt; pasteboardItemInfo(size_t index) const;</span>
<span class="line-added">286 </span>
<span class="line-added">287     String readString(size_t index, const String&amp; type);</span>
<span class="line-added">288     RefPtr&lt;WebCore::SharedBuffer&gt; readBuffer(size_t index, const String&amp; type);</span>
<span class="line-added">289     URL readURL(size_t index, String&amp; title);</span>
<span class="line-added">290 </span>
291 private:
292 #if PLATFORM(IOS_FAMILY)
293     bool respectsUTIFidelities() const;
<a name="12" id="anc12"></a><span class="line-modified">294     void readRespectingUTIFidelities(PasteboardWebContentReader&amp;, WebContentReadingPolicy, Optional&lt;size_t&gt;);</span>
295 
296     enum class ReaderResult {
297         ReadType,
298         DidNotReadType,
299         PasteboardWasChangedExternally
300     };
301     ReaderResult readPasteboardWebContentDataForType(PasteboardWebContentReader&amp;, PasteboardStrategy&amp;, NSString *type, const PasteboardItemInfo&amp;, int itemIndex);
302 #endif
303 
304 #if PLATFORM(WIN)
305     void finishCreatingPasteboard();
306     void writeRangeToDataObject(Range&amp;, Frame&amp;); // FIXME: Layering violation.
307     void writeURLToDataObject(const URL&amp;, const String&amp;);
308     void writePlainTextToDataObject(const String&amp;, SmartReplaceOption);
309 #endif
310 
311 #if PLATFORM(JAVA)
312     Pasteboard(RefPtr&lt;DataObjectJava&gt;, bool copyPasteMode);
313     static std::unique_ptr&lt;Pasteboard&gt; create(RefPtr&lt;DataObjectJava&gt;);
314 #endif
315 
316 #if PLATFORM(COCOA)
317     Vector&lt;String&gt; readFilePaths();
<a name="13" id="anc13"></a><span class="line-modified">318     Vector&lt;String&gt; readPlatformValuesAsStrings(const String&amp; domType, int64_t changeCount, const String&amp; pasteboardName);</span>
319     static void addHTMLClipboardTypesForCocoaType(ListHashSet&lt;String&gt;&amp; resultTypes, const String&amp; cocoaType);
320     String readStringForPlatformType(const String&amp;);
321     Vector&lt;String&gt; readTypesWithSecurityCheck();
322     RefPtr&lt;SharedBuffer&gt; readBufferForTypeWithSecurityCheck(const String&amp;);
323 #endif
324 
325 #if PLATFORM(GTK)
326     void writeToClipboard();
327     void readFromClipboard();
328     Ref&lt;SelectionData&gt; m_selectionData;
329     String m_name;
330 #endif
331 
332 #if PLATFORM(COCOA)
333     String m_pasteboardName;
<a name="14" id="anc14"></a><span class="line-modified">334     int64_t m_changeCount;</span>
335     Optional&lt;PasteboardCustomData&gt; m_customDataCache;
336 #endif
337 
338 #if PLATFORM(MAC)
339     Vector&lt;String&gt; m_promisedFilePaths;
340 #endif
341 
342 #if PLATFORM(WIN)
343     HWND m_owner;
344     COMPtr&lt;IDataObject&gt; m_dataObject;
345     COMPtr&lt;WCDataObject&gt; m_writableDataObject;
346     DragDataMap m_dragDataMap;
347 #endif
348 
349 #if PLATFORM(JAVA)
350     RefPtr&lt;DataObjectJava&gt; m_dataObject;
351     bool m_copyPasteMode;
352 #endif
353 };
354 
355 #if PLATFORM(IOS_FAMILY)
356 extern NSString *WebArchivePboardType;
357 extern NSString *UIColorPboardType;
358 #endif
359 
360 #if PLATFORM(MAC)
361 extern const char* const WebArchivePboardType;
362 extern const char* const WebURLNamePboardType;
363 extern const char* const WebURLsWithTitlesPboardType;
364 #endif
365 
366 #if !PLATFORM(GTK)
367 
368 inline Pasteboard::~Pasteboard()
369 {
370 }
371 
372 #endif
373 
374 } // namespace WebCore
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>