<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/bridge/c/c_instance.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2003-2019 Apple Inc.  All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 
 28 #if ENABLE(NETSCAPE_PLUGIN_API)
 29 
 30 #include &quot;c_instance.h&quot;
 31 
 32 #include &quot;CRuntimeObject.h&quot;
 33 #include &quot;IdentifierRep.h&quot;
 34 #include &quot;JSDOMBinding.h&quot;
 35 #include &quot;c_class.h&quot;
 36 #include &quot;c_runtime.h&quot;
 37 #include &quot;c_utility.h&quot;
 38 #include &quot;npruntime_impl.h&quot;
 39 #include &quot;runtime_method.h&quot;
 40 #include &quot;runtime_root.h&quot;
 41 #include &lt;JavaScriptCore/ArgList.h&gt;
 42 #include &lt;JavaScriptCore/CallFrame.h&gt;
 43 #include &lt;JavaScriptCore/Error.h&gt;
 44 #include &lt;JavaScriptCore/FunctionPrototype.h&gt;
 45 #include &lt;JavaScriptCore/JSLock.h&gt;
 46 #include &lt;JavaScriptCore/PropertyNameArray.h&gt;
 47 #include &lt;wtf/Assertions.h&gt;
 48 #include &lt;wtf/NeverDestroyed.h&gt;
 49 #include &lt;wtf/StdLibExtras.h&gt;
 50 #include &lt;wtf/Vector.h&gt;
 51 
 52 using namespace WebCore;
 53 
 54 namespace JSC {
 55 namespace Bindings {
 56 
 57 static String&amp; globalExceptionString()
 58 {
 59     static NeverDestroyed&lt;String&gt; exceptionStr;
 60     return exceptionStr;
 61 }
 62 
 63 void CInstance::setGlobalException(String exception)
 64 {
 65     globalExceptionString() = exception;
 66 }
 67 
<a name="1" id="anc1"></a><span class="line-modified"> 68 void CInstance::moveGlobalExceptionToExecState(ExecState* exec)</span>
 69 {
 70     if (globalExceptionString().isNull())
 71         return;
 72 
 73     {
<a name="2" id="anc2"></a><span class="line-modified"> 74         VM&amp; vm = exec-&gt;vm();</span>
 75         JSLockHolder lock(vm);
 76         auto scope = DECLARE_THROW_SCOPE(vm);
<a name="3" id="anc3"></a><span class="line-modified"> 77         throwException(exec, scope, createError(exec, globalExceptionString()));</span>
 78     }
 79 
 80     globalExceptionString() = String();
 81 }
 82 
 83 CInstance::CInstance(NPObject* o, RefPtr&lt;RootObject&gt;&amp;&amp; rootObject)
 84     : Instance(WTFMove(rootObject))
 85 {
 86     _object = _NPN_RetainObject(o);
 87     _class = 0;
 88 }
 89 
 90 CInstance::~CInstance()
 91 {
 92     _NPN_ReleaseObject(_object);
 93 }
 94 
<a name="4" id="anc4"></a><span class="line-modified"> 95 RuntimeObject* CInstance::newRuntimeObject(ExecState* exec)</span>
 96 {
 97     // FIXME: deprecatedGetDOMStructure uses the prototype off of the wrong global object.
<a name="5" id="anc5"></a><span class="line-modified"> 98     return CRuntimeObject::create(exec-&gt;vm(), WebCore::deprecatedGetDOMStructure&lt;CRuntimeObject&gt;(exec), this);</span>
 99 }
100 
101 Class *CInstance::getClass() const
102 {
103     if (!_class)
104         _class = CClass::classForIsA(_object-&gt;_class);
105     return _class;
106 }
107 
108 bool CInstance::supportsInvokeDefaultMethod() const
109 {
110     return _object-&gt;_class-&gt;invokeDefault;
111 }
112 
<a name="6" id="anc6"></a><span class="line-modified">113 class CRuntimeMethod : public RuntimeMethod {</span>
114 public:
<a name="7" id="anc7"></a><span class="line-modified">115     typedef RuntimeMethod Base;</span>
116 
<a name="8" id="anc8"></a><span class="line-modified">117     static CRuntimeMethod* create(ExecState* exec, JSGlobalObject* globalObject, const String&amp; name, Bindings::Method* method)</span>
118     {
119         VM&amp; vm = globalObject-&gt;vm();
120         // FIXME: deprecatedGetDOMStructure uses the prototype off of the wrong global object
121         // We need to pass in the right global object for &quot;i&quot;.
<a name="9" id="anc9"></a><span class="line-modified">122         Structure* domStructure = WebCore::deprecatedGetDOMStructure&lt;CRuntimeMethod&gt;(exec);</span>
<span class="line-modified">123         CRuntimeMethod* runtimeMethod = new (NotNull, allocateCell&lt;CRuntimeMethod&gt;(vm.heap)) CRuntimeMethod(globalObject, domStructure, method);</span>
124         runtimeMethod-&gt;finishCreation(vm, name);
125         return runtimeMethod;
126     }
127 
128     static Structure* createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
129     {
130         return Structure::create(vm, globalObject, prototype, TypeInfo(InternalFunctionType, StructureFlags), info());
131     }
132 
133     DECLARE_INFO;
134 
135 private:
<a name="10" id="anc10"></a><span class="line-modified">136     CRuntimeMethod(JSGlobalObject* globalObject, Structure* structure, Bindings::Method* method)</span>
<span class="line-modified">137         : RuntimeMethod(globalObject, structure, method)</span>
138     {
139     }
140 
141     void finishCreation(VM&amp; vm, const String&amp; name)
142     {
143         Base::finishCreation(vm, name);
144         ASSERT(inherits(vm, info()));
145     }
<a name="11" id="anc11"></a><span class="line-removed">146 </span>
147 };
148 
149 const ClassInfo CRuntimeMethod::s_info = { &quot;CRuntimeMethod&quot;, &amp;RuntimeMethod::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(CRuntimeMethod) };
150 
<a name="12" id="anc12"></a><span class="line-modified">151 JSValue CInstance::getMethod(ExecState* exec, PropertyName propertyName)</span>
152 {
153     Method* method = getClass()-&gt;methodNamed(propertyName, this);
<a name="13" id="anc13"></a><span class="line-modified">154     return CRuntimeMethod::create(exec, exec-&gt;lexicalGlobalObject(), propertyName.publicName(), method);</span>
155 }
156 
<a name="14" id="anc14"></a><span class="line-modified">157 JSValue CInstance::invokeMethod(ExecState* exec, RuntimeMethod* runtimeMethod)</span>
158 {
<a name="15" id="anc15"></a><span class="line-modified">159     VM&amp; vm = exec-&gt;vm();</span>
160     auto scope = DECLARE_THROW_SCOPE(vm);
161 
162     if (!asObject(runtimeMethod)-&gt;inherits&lt;CRuntimeMethod&gt;(vm))
<a name="16" id="anc16"></a><span class="line-modified">163         return throwTypeError(exec, scope, &quot;Attempt to invoke non-plug-in method on plug-in object.&quot;_s);</span>
164 
165     CMethod* method = static_cast&lt;CMethod*&gt;(runtimeMethod-&gt;method());
166     ASSERT(method);
167 
168     NPIdentifier ident = method-&gt;identifier();
169     if (!_object-&gt;_class-&gt;hasMethod(_object, ident))
170         return jsUndefined();
171 
<a name="17" id="anc17"></a><span class="line-modified">172     unsigned count = exec-&gt;argumentCount();</span>
173     Vector&lt;NPVariant, 8&gt; cArgs(count);
174 
175     unsigned i;
176     for (i = 0; i &lt; count; i++)
<a name="18" id="anc18"></a><span class="line-modified">177         convertValueToNPVariant(exec, exec-&gt;uncheckedArgument(i), &amp;cArgs[i]);</span>
178 
179     // Invoke the &#39;C&#39; method.
180     bool retval = true;
181     NPVariant resultVariant;
182     VOID_TO_NPVARIANT(resultVariant);
183 
184     {
<a name="19" id="anc19"></a><span class="line-modified">185         JSLock::DropAllLocks dropAllLocks(exec);</span>
186         ASSERT(globalExceptionString().isNull());
187         retval = _object-&gt;_class-&gt;invoke(_object, ident, cArgs.data(), count, &amp;resultVariant);
<a name="20" id="anc20"></a><span class="line-modified">188         moveGlobalExceptionToExecState(exec);</span>
189     }
190 
191     if (!retval)
<a name="21" id="anc21"></a><span class="line-modified">192         throwException(exec, scope, createError(exec, &quot;Error calling method on NPObject.&quot;_s));</span>
193 
194     for (i = 0; i &lt; count; i++)
195         _NPN_ReleaseVariantValue(&amp;cArgs[i]);
196 
<a name="22" id="anc22"></a><span class="line-modified">197     JSValue resultValue = convertNPVariantToValue(exec, &amp;resultVariant, m_rootObject.get());</span>
198     _NPN_ReleaseVariantValue(&amp;resultVariant);
199     return resultValue;
200 }
201 
202 
<a name="23" id="anc23"></a><span class="line-modified">203 JSValue CInstance::invokeDefaultMethod(ExecState* exec)</span>
204 {
<a name="24" id="anc24"></a><span class="line-modified">205     VM&amp; vm = exec-&gt;vm();</span>
206     auto scope = DECLARE_THROW_SCOPE(vm);
207 
208     if (!_object-&gt;_class-&gt;invokeDefault)
209         return jsUndefined();
210 
<a name="25" id="anc25"></a><span class="line-modified">211     unsigned count = exec-&gt;argumentCount();</span>
212     Vector&lt;NPVariant, 8&gt; cArgs(count);
213 
214     unsigned i;
215     for (i = 0; i &lt; count; i++)
<a name="26" id="anc26"></a><span class="line-modified">216         convertValueToNPVariant(exec, exec-&gt;uncheckedArgument(i), &amp;cArgs[i]);</span>
217 
218     // Invoke the &#39;C&#39; method.
219     bool retval = true;
220     NPVariant resultVariant;
221     VOID_TO_NPVARIANT(resultVariant);
222     {
<a name="27" id="anc27"></a><span class="line-modified">223         JSLock::DropAllLocks dropAllLocks(exec);</span>
224         ASSERT(globalExceptionString().isNull());
225         retval = _object-&gt;_class-&gt;invokeDefault(_object, cArgs.data(), count, &amp;resultVariant);
<a name="28" id="anc28"></a><span class="line-modified">226         moveGlobalExceptionToExecState(exec);</span>
227     }
228 
229     if (!retval)
<a name="29" id="anc29"></a><span class="line-modified">230         throwException(exec, scope, createError(exec, &quot;Error calling method on NPObject.&quot;_s));</span>
231 
232     for (i = 0; i &lt; count; i++)
233         _NPN_ReleaseVariantValue(&amp;cArgs[i]);
234 
<a name="30" id="anc30"></a><span class="line-modified">235     JSValue resultValue = convertNPVariantToValue(exec, &amp;resultVariant, m_rootObject.get());</span>
236     _NPN_ReleaseVariantValue(&amp;resultVariant);
237     return resultValue;
238 }
239 
240 bool CInstance::supportsConstruct() const
241 {
242     return _object-&gt;_class-&gt;construct;
243 }
244 
<a name="31" id="anc31"></a><span class="line-modified">245 JSValue CInstance::invokeConstruct(ExecState* exec, const ArgList&amp; args)</span>
246 {
<a name="32" id="anc32"></a><span class="line-modified">247     VM&amp; vm = exec-&gt;vm();</span>
248     auto scope = DECLARE_THROW_SCOPE(vm);
249 
250     if (!_object-&gt;_class-&gt;construct)
251         return jsUndefined();
252 
253     unsigned count = args.size();
254     Vector&lt;NPVariant, 8&gt; cArgs(count);
255 
256     unsigned i;
257     for (i = 0; i &lt; count; i++)
<a name="33" id="anc33"></a><span class="line-modified">258         convertValueToNPVariant(exec, args.at(i), &amp;cArgs[i]);</span>
259 
260     // Invoke the &#39;C&#39; method.
261     bool retval = true;
262     NPVariant resultVariant;
263     VOID_TO_NPVARIANT(resultVariant);
264     {
<a name="34" id="anc34"></a><span class="line-modified">265         JSLock::DropAllLocks dropAllLocks(exec);</span>
266         ASSERT(globalExceptionString().isNull());
267         retval = _object-&gt;_class-&gt;construct(_object, cArgs.data(), count, &amp;resultVariant);
<a name="35" id="anc35"></a><span class="line-modified">268         moveGlobalExceptionToExecState(exec);</span>
269     }
270 
271     if (!retval)
<a name="36" id="anc36"></a><span class="line-modified">272         throwException(exec, scope, createError(exec, &quot;Error calling method on NPObject.&quot;_s));</span>
273 
274     for (i = 0; i &lt; count; i++)
275         _NPN_ReleaseVariantValue(&amp;cArgs[i]);
276 
<a name="37" id="anc37"></a><span class="line-modified">277     JSValue resultValue = convertNPVariantToValue(exec, &amp;resultVariant, m_rootObject.get());</span>
278     _NPN_ReleaseVariantValue(&amp;resultVariant);
279     return resultValue;
280 }
281 
<a name="38" id="anc38"></a><span class="line-modified">282 JSValue CInstance::defaultValue(ExecState* exec, PreferredPrimitiveType hint) const</span>
283 {
284     if (hint == PreferString)
<a name="39" id="anc39"></a><span class="line-modified">285         return stringValue(exec);</span>
286     if (hint == PreferNumber)
<a name="40" id="anc40"></a><span class="line-modified">287         return numberValue(exec);</span>
<span class="line-modified">288     return valueOf(exec);</span>
289 }
290 
<a name="41" id="anc41"></a><span class="line-modified">291 JSValue CInstance::stringValue(ExecState* exec) const</span>
292 {
293     JSValue value;
<a name="42" id="anc42"></a><span class="line-modified">294     if (toJSPrimitive(exec, &quot;toString&quot;, value))</span>
295         return value;
296 
297     // Fallback to default implementation.
<a name="43" id="anc43"></a><span class="line-modified">298     return jsNontrivialString(exec-&gt;vm(), &quot;NPObject&quot;_s);</span>
299 }
300 
<a name="44" id="anc44"></a><span class="line-modified">301 JSValue CInstance::numberValue(ExecState*) const</span>
302 {
303     // FIXME: Implement something sensible.
304     return jsNumber(0);
305 }
306 
307 JSValue CInstance::booleanValue() const
308 {
309     // As per ECMA 9.2.
310     return jsBoolean(getObject());
311 }
312 
<a name="45" id="anc45"></a><span class="line-modified">313 JSValue CInstance::valueOf(ExecState* exec) const</span>
314 {
315     JSValue value;
<a name="46" id="anc46"></a><span class="line-modified">316     if (toJSPrimitive(exec, &quot;valueOf&quot;, value))</span>
317         return value;
318 
319     // Fallback to default implementation.
<a name="47" id="anc47"></a><span class="line-modified">320     return stringValue(exec);</span>
321 }
322 
<a name="48" id="anc48"></a><span class="line-modified">323 bool CInstance::toJSPrimitive(ExecState* exec, const char* name, JSValue&amp; resultValue) const</span>
324 {
<a name="49" id="anc49"></a><span class="line-modified">325     VM&amp; vm = exec-&gt;vm();</span>
326     auto scope = DECLARE_THROW_SCOPE(vm);
327 
328     NPIdentifier ident = _NPN_GetStringIdentifier(name);
329     if (!_object-&gt;_class-&gt;hasMethod(_object, ident))
330         return false;
331 
332     // Invoke the &#39;C&#39; method.
333     bool retval = true;
334     NPVariant resultVariant;
335     VOID_TO_NPVARIANT(resultVariant);
336 
337     {
<a name="50" id="anc50"></a><span class="line-modified">338         JSLock::DropAllLocks dropAllLocks(exec);</span>
339         ASSERT(globalExceptionString().isNull());
340         retval = _object-&gt;_class-&gt;invoke(_object, ident, 0, 0, &amp;resultVariant);
<a name="51" id="anc51"></a><span class="line-modified">341         moveGlobalExceptionToExecState(exec);</span>
342     }
343 
344     if (!retval)
<a name="52" id="anc52"></a><span class="line-modified">345         throwException(exec, scope, createError(exec, &quot;Error calling method on NPObject.&quot;_s));</span>
346 
<a name="53" id="anc53"></a><span class="line-modified">347     resultValue = convertNPVariantToValue(exec, &amp;resultVariant, m_rootObject.get());</span>
348     _NPN_ReleaseVariantValue(&amp;resultVariant);
349     return true;
350 }
351 
<a name="54" id="anc54"></a><span class="line-modified">352 void CInstance::getPropertyNames(ExecState* exec, PropertyNameArray&amp; nameArray)</span>
353 {
354     if (!NP_CLASS_STRUCT_VERSION_HAS_ENUM(_object-&gt;_class) || !_object-&gt;_class-&gt;enumerate)
355         return;
356 
357     uint32_t count;
358     NPIdentifier* identifiers;
359 
360     {
<a name="55" id="anc55"></a><span class="line-modified">361         JSLock::DropAllLocks dropAllLocks(exec);</span>
362         ASSERT(globalExceptionString().isNull());
363         bool ok = _object-&gt;_class-&gt;enumerate(_object, &amp;identifiers, &amp;count);
<a name="56" id="anc56"></a><span class="line-modified">364         moveGlobalExceptionToExecState(exec);</span>
365         if (!ok)
366             return;
367     }
368 
<a name="57" id="anc57"></a><span class="line-modified">369     VM&amp; vm = exec-&gt;vm();</span>
370     for (uint32_t i = 0; i &lt; count; i++) {
371         IdentifierRep* identifier = static_cast&lt;IdentifierRep*&gt;(identifiers[i]);
372 
373         if (identifier-&gt;isString())
<a name="58" id="anc58"></a><span class="line-modified">374             nameArray.add(identifierFromNPIdentifier(exec, identifier-&gt;string()));</span>
375         else
376             nameArray.add(Identifier::from(vm, identifier-&gt;number()));
377     }
378 
379     // FIXME: This should really call NPN_MemFree but that&#39;s in WebKit
380     free(identifiers);
381 }
382 
383 }
384 }
385 
386 #endif // ENABLE(NETSCAPE_PLUGIN_API)
<a name="59" id="anc59"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="59" type="hidden" />
</body>
</html>