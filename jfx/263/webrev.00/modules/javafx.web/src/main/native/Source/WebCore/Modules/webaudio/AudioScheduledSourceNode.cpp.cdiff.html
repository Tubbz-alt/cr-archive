<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/webaudio/AudioScheduledSourceNode.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AudioProcessingEvent.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="AudioScheduledSourceNode.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/webaudio/AudioScheduledSourceNode.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 35,10 ***</span>
<span class="line-new-header">--- 35,11 ---</span>
  #include &quot;ScriptController.h&quot;
  #include &quot;ScriptExecutionContext.h&quot;
  #include &lt;algorithm&gt;
  #include &lt;wtf/IsoMallocInlines.h&gt;
  #include &lt;wtf/MathExtras.h&gt;
<span class="line-added">+ #include &lt;wtf/Scope.h&gt;</span>
  
  #if PLATFORM(IOS_FAMILY)
  #include &quot;ScriptController.h&quot;
  #endif
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 48,12 ***</span>
<span class="line-new-header">--- 49,15 ---</span>
  
  const double AudioScheduledSourceNode::UnknownTime = -1;
  
  AudioScheduledSourceNode::AudioScheduledSourceNode(AudioContext&amp; context, float sampleRate)
      : AudioNode(context, sampleRate)
<span class="line-added">+     , ActiveDOMObject(context.scriptExecutionContext())</span>
      , m_endTime(UnknownTime)
  {
<span class="line-added">+     suspendIfNeeded();</span>
<span class="line-added">+     m_pendingActivity = makePendingActivity(*this);</span>
  }
  
  void AudioScheduledSourceNode::updateSchedulingInfo(size_t quantumFrameSize, AudioBus&amp; outputBus, size_t&amp; quantumFrameOffset, size_t&amp; nonSilentFramesToProcess)
  {
      nonSilentFramesToProcess = 0;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 130,11 ***</span>
  
          finish();
      }
  }
  
<span class="line-modified">! ExceptionOr&lt;void&gt; AudioScheduledSourceNode::start(double when)</span>
  {
      ASSERT(isMainThread());
      ALWAYS_LOG(LOGIDENTIFIER, when);
  
      context().nodeWillBeginPlayback();
<span class="line-new-header">--- 134,11 ---</span>
  
          finish();
      }
  }
  
<span class="line-modified">! ExceptionOr&lt;void&gt; AudioScheduledSourceNode::startLater(double when)</span>
  {
      ASSERT(isMainThread());
      ALWAYS_LOG(LOGIDENTIFIER, when);
  
      context().nodeWillBeginPlayback();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 148,11 ***</span>
      m_playbackState = SCHEDULED_STATE;
  
      return { };
  }
  
<span class="line-modified">! ExceptionOr&lt;void&gt; AudioScheduledSourceNode::stop(double when)</span>
  {
      ASSERT(isMainThread());
      ALWAYS_LOG(LOGIDENTIFIER, when);
  
      if (m_playbackState == UNSCHEDULED_STATE || m_endTime != UnknownTime)
<span class="line-new-header">--- 152,11 ---</span>
      m_playbackState = SCHEDULED_STATE;
  
      return { };
  }
  
<span class="line-modified">! ExceptionOr&lt;void&gt; AudioScheduledSourceNode::stopLater(double when)</span>
  {
      ASSERT(isMainThread());
      ALWAYS_LOG(LOGIDENTIFIER, when);
  
      if (m_playbackState == UNSCHEDULED_STATE || m_endTime != UnknownTime)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 163,49 ***</span>
      m_endTime = when;
  
      return { };
  }
  
<span class="line-modified">! void AudioScheduledSourceNode::finish()</span>
  {
<span class="line-modified">!     if (m_playbackState != FINISHED_STATE) {</span>
<span class="line-modified">!         // Let the context dereference this AudioNode.</span>
<span class="line-modified">!         context().notifyNodeFinishedProcessing(this);</span>
<span class="line-modified">!         m_playbackState = FINISHED_STATE;</span>
<span class="line-removed">-         context().decrementActiveSourceCount();</span>
<span class="line-removed">-     }</span>
  
<span class="line-modified">!     if (!m_hasEndedListener)</span>
<span class="line-modified">!         return;</span>
  
      context().postTask([this, protectedThis = makeRef(*this)] {
          if (context().isStopped())
              return;
          this-&gt;dispatchEvent(Event::create(eventNames().endedEvent, Event::CanBubble::No, Event::IsCancelable::No));
      });
  }
  
<span class="line-removed">- bool AudioScheduledSourceNode::addEventListener(const AtomString&amp; eventType, Ref&lt;EventListener&gt;&amp;&amp; listener, const AddEventListenerOptions&amp; options)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     bool success = AudioNode::addEventListener(eventType, WTFMove(listener), options);</span>
<span class="line-removed">-     if (success &amp;&amp; eventType == eventNames().endedEvent)</span>
<span class="line-removed">-         m_hasEndedListener = hasEventListeners(eventNames().endedEvent);</span>
<span class="line-removed">-     return success;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- bool AudioScheduledSourceNode::removeEventListener(const AtomString&amp; eventType, EventListener&amp; listener, const ListenerOptions&amp; options)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     bool success = AudioNode::removeEventListener(eventType, listener, options);</span>
<span class="line-removed">-     if (success &amp;&amp; eventType == eventNames().endedEvent)</span>
<span class="line-removed">-         m_hasEndedListener = hasEventListeners(eventNames().endedEvent);</span>
<span class="line-removed">-     return success;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void AudioScheduledSourceNode::removeAllEventListeners()</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     m_hasEndedListener = false;</span>
<span class="line-removed">-     AudioNode::removeAllEventListeners();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  } // namespace WebCore
  
  #endif // ENABLE(WEB_AUDIO)
<span class="line-new-header">--- 167,35 ---</span>
      m_endTime = when;
  
      return { };
  }
  
<span class="line-modified">! void AudioScheduledSourceNode::didBecomeMarkedForDeletion()</span>
  {
<span class="line-modified">!     ASSERT(context().isGraphOwner());</span>
<span class="line-modified">!     m_pendingActivity = nullptr;</span>
<span class="line-modified">!     ASSERT(!hasPendingActivity());</span>
<span class="line-modified">! }</span>
  
<span class="line-modified">! void AudioScheduledSourceNode::finish()</span>
<span class="line-modified">! {</span>
<span class="line-added">+     ASSERT(!hasFinished());</span>
<span class="line-added">+     // Let the context dereference this AudioNode.</span>
<span class="line-added">+     context().notifyNodeFinishedProcessing(this);</span>
<span class="line-added">+     m_playbackState = FINISHED_STATE;</span>
<span class="line-added">+     context().decrementActiveSourceCount();</span>
  
      context().postTask([this, protectedThis = makeRef(*this)] {
<span class="line-added">+         auto release = makeScopeExit([&amp;] () {</span>
<span class="line-added">+             AudioContext::AutoLocker locker(context());</span>
<span class="line-added">+             m_pendingActivity = nullptr;</span>
<span class="line-added">+             ASSERT(!hasPendingActivity());</span>
<span class="line-added">+         });</span>
          if (context().isStopped())
              return;
          this-&gt;dispatchEvent(Event::create(eventNames().endedEvent, Event::CanBubble::No, Event::IsCancelable::No));
      });
  }
  
  } // namespace WebCore
  
  #endif // ENABLE(WEB_AUDIO)
</pre>
<center><a href="AudioProcessingEvent.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="AudioScheduledSourceNode.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>