<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/IDBDatabase.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IDBCursor.idl.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IDBDatabase.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/IDBDatabase.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -65,21 +65,21 @@</span>
      m_connectionProxy-&gt;registerDatabaseConnection(*this);
  }
  
  IDBDatabase::~IDBDatabase()
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (!m_closedInServer)
          m_connectionProxy-&gt;databaseConnectionClosed(*this);
  
      m_connectionProxy-&gt;unregisterDatabaseConnection(*this);
  }
  
  bool IDBDatabase::hasPendingActivity() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current() || Thread::mayBeGCThread());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()) || Thread::mayBeGCThread());</span>
  
      if (m_closedInServer || isContextStopped())
          return false;
  
      if (!m_activeTransactions.isEmpty() || !m_committingTransactions.isEmpty() || !m_abortingTransactions.isEmpty())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -88,45 +88,45 @@</span>
      return hasEventListeners(m_eventNames.abortEvent) || hasEventListeners(m_eventNames.errorEvent) || hasEventListeners(m_eventNames.versionchangeEvent);
  }
  
  const String IDBDatabase::name() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      return m_info.name();
  }
  
  uint64_t IDBDatabase::version() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      return m_info.version();
  }
  
  Ref&lt;DOMStringList&gt; IDBDatabase::objectStoreNames() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto objectStoreNames = DOMStringList::create();
      for (auto&amp; name : m_info.objectStoreNames())
          objectStoreNames-&gt;append(name);
      objectStoreNames-&gt;sort();
      return objectStoreNames;
  }
  
  void IDBDatabase::renameObjectStore(IDBObjectStore&amp; objectStore, const String&amp; newName)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(m_versionChangeTransaction);
      ASSERT(m_info.hasObjectStore(objectStore.info().name()));
  
      m_info.renameObjectStore(objectStore.info().identifier(), newName);
  
      m_versionChangeTransaction-&gt;renameObjectStore(objectStore, newName);
  }
  
  void IDBDatabase::renameIndex(IDBIndex&amp; index, const String&amp; newName)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(m_versionChangeTransaction);
      ASSERT(m_info.hasObjectStore(index.objectStore().info().name()));
      ASSERT(m_info.infoForExistingObjectStore(index.objectStore().info().name())-&gt;hasIndex(index.info().name()));
  
      m_info.infoForExistingObjectStore(index.objectStore().info().name())-&gt;infoForExistingIndex(index.info().identifier())-&gt;rename(newName);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -136,11 +136,11 @@</span>
  
  ExceptionOr&lt;Ref&lt;IDBObjectStore&gt;&gt; IDBDatabase::createObjectStore(const String&amp; name, ObjectStoreParameters&amp;&amp; parameters)
  {
      LOG(IndexedDB, &quot;IDBDatabase::createObjectStore - (%s %s)&quot;, m_info.name().utf8().data(), name.utf8().data());
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(!m_versionChangeTransaction || m_versionChangeTransaction-&gt;isVersionChange());
  
      if (!m_versionChangeTransaction)
          return Exception { InvalidStateError, &quot;Failed to execute &#39;createObjectStore&#39; on &#39;IDBDatabase&#39;: The database is not running a version change transaction.&quot;_s };
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -166,11 +166,11 @@</span>
  
  ExceptionOr&lt;Ref&lt;IDBTransaction&gt;&gt; IDBDatabase::transaction(StringOrVectorOfStrings&amp;&amp; storeNames, IDBTransactionMode mode)
  {
      LOG(IndexedDB, &quot;IDBDatabase::transaction&quot;);
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (m_versionChangeTransaction &amp;&amp; !m_versionChangeTransaction-&gt;isFinishedOrFinishing())
          return Exception { InvalidStateError, &quot;Failed to execute &#39;transaction&#39; on &#39;IDBDatabase&#39;: A version change transaction is running.&quot;_s };
  
      if (m_closePending)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -216,11 +216,11 @@</span>
  
  ExceptionOr&lt;void&gt; IDBDatabase::deleteObjectStore(const String&amp; objectStoreName)
  {
      LOG(IndexedDB, &quot;IDBDatabase::deleteObjectStore&quot;);
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (!m_versionChangeTransaction)
          return Exception { InvalidStateError, &quot;Failed to execute &#39;deleteObjectStore&#39; on &#39;IDBDatabase&#39;: The database is not running a version change transaction.&quot;_s };
  
      if (!m_versionChangeTransaction-&gt;isActive())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -237,11 +237,11 @@</span>
  
  void IDBDatabase::close()
  {
      LOG(IndexedDB, &quot;IDBDatabase::close - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (!m_closePending) {
          m_closePending = true;
          m_connectionProxy-&gt;databaseConnectionPendingClose(*this);
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -252,19 +252,17 @@</span>
  void IDBDatabase::didCloseFromServer(const IDBError&amp; error)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didCloseFromServer - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
      connectionToServerLost(error);
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     m_connectionProxy-&gt;confirmDidCloseFromServer(*this);</span>
  }
  
  void IDBDatabase::connectionToServerLost(const IDBError&amp; error)
  {
      LOG(IndexedDB, &quot;IDBDatabase::connectionToServerLost - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      m_closePending = true;
      m_closedInServer = true;
  
      auto activeTransactions = copyToVector(m_activeTransactions.values());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -276,25 +274,25 @@</span>
          transaction-&gt;connectionClosedFromServer(error);
  
      auto errorEvent = Event::create(m_eventNames.errorEvent, Event::CanBubble::Yes, Event::IsCancelable::No);
      errorEvent-&gt;setTarget(this);
  
<span class="udiff-line-modified-removed">-     if (auto* context = scriptExecutionContext())</span>
<span class="udiff-line-modified-removed">-         context-&gt;eventQueue().enqueueEvent(WTFMove(errorEvent));</span>
<span class="udiff-line-modified-added">+     if (scriptExecutionContext())</span>
<span class="udiff-line-modified-added">+         queueTaskToDispatchEvent(*this, TaskSource::DatabaseAccess, WTFMove(errorEvent));</span>
  
      auto closeEvent = Event::create(m_eventNames.closeEvent, Event::CanBubble::Yes, Event::IsCancelable::No);
      closeEvent-&gt;setTarget(this);
  
<span class="udiff-line-modified-removed">-     if (auto* context = scriptExecutionContext())</span>
<span class="udiff-line-modified-removed">-         context-&gt;eventQueue().enqueueEvent(WTFMove(closeEvent));</span>
<span class="udiff-line-modified-added">+     if (scriptExecutionContext())</span>
<span class="udiff-line-modified-added">+         queueTaskToDispatchEvent(*this, TaskSource::DatabaseAccess, WTFMove(closeEvent));</span>
  }
  
  void IDBDatabase::maybeCloseInServer()
  {
      LOG(IndexedDB, &quot;IDBDatabase::maybeCloseInServer - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (m_closedInServer)
          return;
  
      // 3.3.9 Database closing steps
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -307,28 +305,19 @@</span>
      m_connectionProxy-&gt;databaseConnectionClosed(*this);
  }
  
  const char* IDBDatabase::activeDOMObjectName() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      return &quot;IDBDatabase&quot;;
  }
  
<span class="udiff-line-removed">- bool IDBDatabase::canSuspendForDocumentSuspension() const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // FIXME: This value will sometimes be false when database operations are actually in progress.</span>
<span class="udiff-line-removed">-     // Such database operations do not yet exist.</span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  void IDBDatabase::stop()
  {
      LOG(IndexedDB, &quot;IDBDatabase::stop - %&quot; PRIu64, m_databaseConnectionIdentifier);
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      removeAllEventListeners();
  
      Vector&lt;IDBResourceIdentifier&gt; transactionIdentifiers;
      transactionIdentifiers.reserveInitialCapacity(m_activeTransactions.size());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -347,11 +336,11 @@</span>
  
  Ref&lt;IDBTransaction&gt; IDBDatabase::startVersionChangeTransaction(const IDBTransactionInfo&amp; info, IDBOpenDBRequest&amp; request)
  {
      LOG(IndexedDB, &quot;IDBDatabase::startVersionChangeTransaction %s&quot;, info.identifier().loggingString().utf8().data());
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(!m_versionChangeTransaction);
      ASSERT(info.mode() == IDBTransactionMode::Versionchange);
      ASSERT(!m_closePending);
      ASSERT(scriptExecutionContext());
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -365,11 +354,11 @@</span>
  
  void IDBDatabase::didStartTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didStartTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
      ASSERT(!m_versionChangeTransaction);
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      // It is possible for the client to have aborted a transaction before the server replies back that it has started.
      if (m_abortingTransactions.contains(transaction.info().identifier()))
          return;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -378,22 +367,22 @@</span>
  
  void IDBDatabase::willCommitTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::willCommitTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto refTransaction = m_activeTransactions.take(transaction.info().identifier());
      ASSERT(refTransaction);
      m_committingTransactions.set(transaction.info().identifier(), WTFMove(refTransaction));
  }
  
  void IDBDatabase::didCommitTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didCommitTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (m_versionChangeTransaction == &amp;transaction)
          m_info.setVersion(transaction.info().newVersion());
  
      didCommitOrAbortTransaction(transaction);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -401,11 +390,11 @@</span>
  
  void IDBDatabase::willAbortTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::willAbortTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto refTransaction = m_activeTransactions.take(transaction.info().identifier());
      if (!refTransaction)
          refTransaction = m_committingTransactions.take(transaction.info().identifier());
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -421,11 +410,11 @@</span>
  
  void IDBDatabase::didAbortTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didAbortTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (transaction.isVersionChange()) {
          ASSERT(transaction.originalDatabaseInfo());
          ASSERT(m_info.version() == transaction.originalDatabaseInfo()-&gt;version());
          m_closePending = true;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -437,11 +426,11 @@</span>
  
  void IDBDatabase::didCommitOrAbortTransaction(IDBTransaction&amp; transaction)
  {
      LOG(IndexedDB, &quot;IDBDatabase::didCommitOrAbortTransaction %s&quot;, transaction.info().identifier().loggingString().utf8().data());
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (m_versionChangeTransaction == &amp;transaction)
          m_versionChangeTransaction = nullptr;
  
  #ifndef NDBEBUG
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -467,26 +456,25 @@</span>
  void IDBDatabase::fireVersionChangeEvent(const IDBResourceIdentifier&amp; requestIdentifier, uint64_t requestedVersion)
  {
      uint64_t currentVersion = m_info.version();
      LOG(IndexedDB, &quot;IDBDatabase::fireVersionChangeEvent - current version %&quot; PRIu64 &quot;, requested version %&quot; PRIu64 &quot;, connection %&quot; PRIu64 &quot; (%p)&quot;, currentVersion, requestedVersion, m_databaseConnectionIdentifier, this);
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (!scriptExecutionContext() || m_closePending) {
          connectionProxy().didFireVersionChangeEvent(m_databaseConnectionIdentifier, requestIdentifier);
          return;
      }
  
      Ref&lt;Event&gt; event = IDBVersionChangeEvent::create(requestIdentifier, currentVersion, requestedVersion, m_eventNames.versionchangeEvent);
<span class="udiff-line-modified-removed">-     event-&gt;setTarget(this);</span>
<span class="udiff-line-removed">-     scriptExecutionContext()-&gt;eventQueue().enqueueEvent(WTFMove(event));</span>
<span class="udiff-line-modified-added">+     queueTaskToDispatchEvent(*this, TaskSource::DatabaseAccess, WTFMove(event));</span>
  }
  
  void IDBDatabase::dispatchEvent(Event&amp; event)
  {
      LOG(IndexedDB, &quot;IDBDatabase::dispatchEvent (%&quot; PRIu64 &quot;) (%p)&quot;, m_databaseConnectionIdentifier, this);
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto protectedThis = makeRef(*this);
  
      EventTargetWithInlineData::dispatchEvent(event);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -494,20 +482,20 @@</span>
          m_connectionProxy-&gt;didFireVersionChangeEvent(m_databaseConnectionIdentifier, downcast&lt;IDBVersionChangeEvent&gt;(event).requestIdentifier());
  }
  
  void IDBDatabase::didCreateIndexInfo(const IDBIndexInfo&amp; info)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto* objectStore = m_info.infoForExistingObjectStore(info.objectStoreIdentifier());
      ASSERT(objectStore);
      objectStore-&gt;addExistingIndex(info);
  }
  
  void IDBDatabase::didDeleteIndexInfo(const IDBIndexInfo&amp; info)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto* objectStore = m_info.infoForExistingObjectStore(info.objectStoreIdentifier());
      ASSERT(objectStore);
      objectStore-&gt;deleteIndex(info.name());
  }
</pre>
<center><a href="IDBCursor.idl.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IDBDatabase.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>