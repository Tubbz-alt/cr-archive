<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/css/CSSPrimitiveValue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * (C) 1999-2003 Lars Knoll (knoll@kde.org)
   3  * Copyright (C) 2004, 2005, 2006, 2007, 2008, 2012, 2013 Apple Inc. All rights reserved.
   4  *
   5  * This library is free software; you can redistribute it and/or
   6  * modify it under the terms of the GNU Library General Public
   7  * License as published by the Free Software Foundation; either
   8  * version 2 of the License, or (at your option) any later version.
   9  *
  10  * This library is distributed in the hope that it will be useful,
  11  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  12  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  13  * Library General Public License for more details.
  14  *
  15  * You should have received a copy of the GNU Library General Public License
  16  * along with this library; see the file COPYING.LIB.  If not, write to
  17  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
  18  * Boston, MA 02110-1301, USA.
  19  */
  20 
  21 #include &quot;config.h&quot;
  22 #include &quot;CSSPrimitiveValue.h&quot;
  23 
  24 #include &quot;CSSBasicShapes.h&quot;
  25 #include &quot;CSSCalculationValue.h&quot;
  26 #include &quot;CSSFontFamily.h&quot;
  27 #include &quot;CSSHelper.h&quot;
  28 #include &quot;CSSMarkup.h&quot;
  29 #include &quot;CSSPrimitiveValueMappings.h&quot;
  30 #include &quot;CSSPropertyNames.h&quot;
  31 #include &quot;CSSToLengthConversionData.h&quot;
  32 #include &quot;CSSValueKeywords.h&quot;
  33 #include &quot;CalculationValue.h&quot;
  34 #include &quot;Color.h&quot;
  35 #include &quot;Counter.h&quot;
  36 #include &quot;DeprecatedCSSOMPrimitiveValue.h&quot;
  37 #include &quot;FontCascade.h&quot;
  38 #include &quot;Node.h&quot;
  39 #include &quot;Pair.h&quot;
<a name="1" id="anc1"></a><span class="line-removed">  40 #include &quot;RGBColor.h&quot;</span>
  41 #include &quot;Rect.h&quot;
  42 #include &quot;RenderStyle.h&quot;
  43 #include &lt;wtf/NeverDestroyed.h&gt;
  44 #include &lt;wtf/StdLibExtras.h&gt;
  45 #include &lt;wtf/text/StringBuilder.h&gt;
  46 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  47 
  48 namespace WebCore {
  49 
<a name="2" id="anc2"></a><span class="line-modified">  50 static inline bool isValidCSSUnitTypeForDoubleConversion(CSSPrimitiveValue::UnitType unitType)</span>
  51 {
  52     switch (unitType) {
<a name="3" id="anc3"></a><span class="line-modified">  53     case CSSPrimitiveValue::CSS_CALC:</span>
<span class="line-modified">  54     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified">  55     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified">  56     case CSSPrimitiveValue::CSS_CHS:</span>
<span class="line-modified">  57     case CSSPrimitiveValue::CSS_CM:</span>
<span class="line-modified">  58     case CSSPrimitiveValue::CSS_DEG:</span>
<span class="line-modified">  59     case CSSPrimitiveValue::CSS_DIMENSION:</span>
<span class="line-modified">  60     case CSSPrimitiveValue::CSS_EMS:</span>
<span class="line-modified">  61     case CSSPrimitiveValue::CSS_QUIRKY_EMS:</span>
<span class="line-modified">  62     case CSSPrimitiveValue::CSS_EXS:</span>
<span class="line-modified">  63     case CSSPrimitiveValue::CSS_FR:</span>
<span class="line-modified">  64     case CSSPrimitiveValue::CSS_GRAD:</span>
<span class="line-modified">  65     case CSSPrimitiveValue::CSS_HZ:</span>
<span class="line-modified">  66     case CSSPrimitiveValue::CSS_IN:</span>
<span class="line-modified">  67     case CSSPrimitiveValue::CSS_KHZ:</span>
<span class="line-modified">  68     case CSSPrimitiveValue::CSS_MM:</span>
<span class="line-modified">  69     case CSSPrimitiveValue::CSS_MS:</span>
<span class="line-modified">  70     case CSSPrimitiveValue::CSS_NUMBER:</span>
<span class="line-modified">  71     case CSSPrimitiveValue::CSS_PC:</span>
<span class="line-modified">  72     case CSSPrimitiveValue::CSS_PERCENTAGE:</span>
<span class="line-modified">  73     case CSSPrimitiveValue::CSS_PT:</span>
<span class="line-modified">  74     case CSSPrimitiveValue::CSS_PX:</span>
<span class="line-modified">  75     case CSSPrimitiveValue::CSS_RAD:</span>
<span class="line-modified">  76     case CSSPrimitiveValue::CSS_REMS:</span>
<span class="line-modified">  77     case CSSPrimitiveValue::CSS_S:</span>
<span class="line-modified">  78     case CSSPrimitiveValue::CSS_TURN:</span>
<span class="line-modified">  79     case CSSPrimitiveValue::CSS_VH:</span>
<span class="line-modified">  80     case CSSPrimitiveValue::CSS_VMAX:</span>
<span class="line-modified">  81     case CSSPrimitiveValue::CSS_VMIN:</span>
<span class="line-modified">  82     case CSSPrimitiveValue::CSS_VW:</span>




  83         return true;
<a name="4" id="anc4"></a><span class="line-modified">  84     case CSSPrimitiveValue::CSS_DPCM:</span>
<span class="line-modified">  85     case CSSPrimitiveValue::CSS_DPI:</span>
<span class="line-modified">  86     case CSSPrimitiveValue::CSS_DPPX:</span>
<span class="line-modified">  87 #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-modified">  88         return true;</span>
<span class="line-modified">  89 #else</span>
<span class="line-modified">  90         return false;</span>
<span class="line-modified">  91 #endif</span>
<span class="line-modified">  92     case CSSPrimitiveValue::CSS_ATTR:</span>
<span class="line-modified">  93     case CSSPrimitiveValue::CSS_COUNTER:</span>
<span class="line-modified">  94     case CSSPrimitiveValue::CSS_COUNTER_NAME:</span>
<span class="line-modified">  95     case CSSPrimitiveValue::CSS_FONT_FAMILY:</span>
<span class="line-modified">  96     case CSSPrimitiveValue::CSS_IDENT:</span>
<span class="line-modified">  97     case CSSPrimitiveValue::CSS_PAIR:</span>
<span class="line-modified">  98     case CSSPrimitiveValue::CSS_PROPERTY_ID:</span>
<span class="line-modified">  99     case CSSPrimitiveValue::CSS_QUAD:</span>
<span class="line-removed"> 100     case CSSPrimitiveValue::CSS_RECT:</span>
<span class="line-removed"> 101     case CSSPrimitiveValue::CSS_RGBCOLOR:</span>
<span class="line-removed"> 102     case CSSPrimitiveValue::CSS_SHAPE:</span>
<span class="line-removed"> 103     case CSSPrimitiveValue::CSS_STRING:</span>
<span class="line-removed"> 104     case CSSPrimitiveValue::CSS_UNICODE_RANGE:</span>
<span class="line-removed"> 105     case CSSPrimitiveValue::CSS_UNKNOWN:</span>
<span class="line-removed"> 106     case CSSPrimitiveValue::CSS_URI:</span>
<span class="line-removed"> 107     case CSSPrimitiveValue::CSS_VALUE_ID:</span>
 108         return false;
 109     }
 110 
 111     ASSERT_NOT_REACHED();
 112     return false;
 113 }
 114 
<a name="5" id="anc5"></a><span class="line-modified"> 115 #if !ASSERT_DISABLED</span>
 116 
<a name="6" id="anc6"></a><span class="line-modified"> 117 static inline bool isStringType(CSSPrimitiveValue::UnitType type)</span>
 118 {
 119     switch (type) {
<a name="7" id="anc7"></a><span class="line-modified"> 120     case CSSPrimitiveValue::CSS_STRING:</span>
<span class="line-modified"> 121     case CSSPrimitiveValue::CSS_URI:</span>
<span class="line-modified"> 122     case CSSPrimitiveValue::CSS_ATTR:</span>
<span class="line-modified"> 123     case CSSPrimitiveValue::CSS_COUNTER_NAME:</span>
<span class="line-modified"> 124     case CSSPrimitiveValue::CSS_DIMENSION:</span>
 125         return true;
<a name="8" id="anc8"></a><span class="line-modified"> 126     case CSSPrimitiveValue::CSS_CALC:</span>
<span class="line-modified"> 127     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified"> 128     case CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified"> 129     case CSSPrimitiveValue::CSS_CHS:</span>
<span class="line-modified"> 130     case CSSPrimitiveValue::CSS_CM:</span>
<span class="line-modified"> 131     case CSSPrimitiveValue::CSS_COUNTER:</span>
<span class="line-modified"> 132     case CSSPrimitiveValue::CSS_DEG:</span>
<span class="line-modified"> 133     case CSSPrimitiveValue::CSS_DPCM:</span>
<span class="line-modified"> 134     case CSSPrimitiveValue::CSS_DPI:</span>
<span class="line-modified"> 135     case CSSPrimitiveValue::CSS_DPPX:</span>
<span class="line-modified"> 136     case CSSPrimitiveValue::CSS_EMS:</span>
<span class="line-modified"> 137     case CSSPrimitiveValue::CSS_QUIRKY_EMS:</span>
<span class="line-modified"> 138     case CSSPrimitiveValue::CSS_EXS:</span>
<span class="line-modified"> 139     case CSSPrimitiveValue::CSS_FONT_FAMILY:</span>
<span class="line-modified"> 140     case CSSPrimitiveValue::CSS_FR:</span>
<span class="line-modified"> 141     case CSSPrimitiveValue::CSS_GRAD:</span>
<span class="line-modified"> 142     case CSSPrimitiveValue::CSS_HZ:</span>
<span class="line-modified"> 143     case CSSPrimitiveValue::CSS_IDENT:</span>
<span class="line-modified"> 144     case CSSPrimitiveValue::CSS_IN:</span>
<span class="line-modified"> 145     case CSSPrimitiveValue::CSS_KHZ:</span>
<span class="line-modified"> 146     case CSSPrimitiveValue::CSS_MM:</span>
<span class="line-modified"> 147     case CSSPrimitiveValue::CSS_MS:</span>
<span class="line-modified"> 148     case CSSPrimitiveValue::CSS_NUMBER:</span>
<span class="line-modified"> 149     case CSSPrimitiveValue::CSS_PAIR:</span>
<span class="line-modified"> 150     case CSSPrimitiveValue::CSS_PC:</span>
<span class="line-modified"> 151     case CSSPrimitiveValue::CSS_PERCENTAGE:</span>
<span class="line-modified"> 152     case CSSPrimitiveValue::CSS_PROPERTY_ID:</span>
<span class="line-modified"> 153     case CSSPrimitiveValue::CSS_PT:</span>
<span class="line-modified"> 154     case CSSPrimitiveValue::CSS_PX:</span>
<span class="line-modified"> 155     case CSSPrimitiveValue::CSS_QUAD:</span>
<span class="line-modified"> 156     case CSSPrimitiveValue::CSS_RAD:</span>
<span class="line-modified"> 157     case CSSPrimitiveValue::CSS_RECT:</span>
<span class="line-modified"> 158     case CSSPrimitiveValue::CSS_REMS:</span>
<span class="line-modified"> 159     case CSSPrimitiveValue::CSS_RGBCOLOR:</span>
<span class="line-modified"> 160     case CSSPrimitiveValue::CSS_S:</span>
<span class="line-modified"> 161     case CSSPrimitiveValue::CSS_SHAPE:</span>
<span class="line-modified"> 162     case CSSPrimitiveValue::CSS_TURN:</span>
<span class="line-modified"> 163     case CSSPrimitiveValue::CSS_UNICODE_RANGE:</span>
<span class="line-modified"> 164     case CSSPrimitiveValue::CSS_UNKNOWN:</span>
<span class="line-modified"> 165     case CSSPrimitiveValue::CSS_VALUE_ID:</span>
<span class="line-modified"> 166     case CSSPrimitiveValue::CSS_VH:</span>
<span class="line-modified"> 167     case CSSPrimitiveValue::CSS_VMAX:</span>
<span class="line-modified"> 168     case CSSPrimitiveValue::CSS_VMIN:</span>
<span class="line-modified"> 169     case CSSPrimitiveValue::CSS_VW:</span>

 170         return false;
 171     }
 172 
 173     ASSERT_NOT_REACHED();
 174     return false;
 175 }
 176 
<a name="9" id="anc9"></a><span class="line-modified"> 177 #endif // !ASSERT_DISABLED</span>
<span class="line-removed"> 178 </span>
<span class="line-removed"> 179 CSSPrimitiveValue::UnitCategory CSSPrimitiveValue::unitCategory(CSSPrimitiveValue::UnitType type)</span>
<span class="line-removed"> 180 {</span>
<span class="line-removed"> 181     // Here we violate the spec (http://www.w3.org/TR/DOM-Level-2-Style/css.html#CSS-CSSPrimitiveValue) and allow conversions</span>
<span class="line-removed"> 182     // between CSS_PX and relative lengths (see cssPixelsPerInch comment in CSSHelper.h for the topic treatment).</span>
<span class="line-removed"> 183     switch (type) {</span>
<span class="line-removed"> 184     case CSS_NUMBER:</span>
<span class="line-removed"> 185         return UNumber;</span>
<span class="line-removed"> 186     case CSS_PERCENTAGE:</span>
<span class="line-removed"> 187         return UPercent;</span>
<span class="line-removed"> 188     case CSS_PX:</span>
<span class="line-removed"> 189     case CSS_CM:</span>
<span class="line-removed"> 190     case CSS_MM:</span>
<span class="line-removed"> 191     case CSS_IN:</span>
<span class="line-removed"> 192     case CSS_PT:</span>
<span class="line-removed"> 193     case CSS_PC:</span>
<span class="line-removed"> 194         return ULength;</span>
<span class="line-removed"> 195     case CSS_MS:</span>
<span class="line-removed"> 196     case CSS_S:</span>
<span class="line-removed"> 197         return UTime;</span>
<span class="line-removed"> 198     case CSS_DEG:</span>
<span class="line-removed"> 199     case CSS_RAD:</span>
<span class="line-removed"> 200     case CSS_GRAD:</span>
<span class="line-removed"> 201     case CSS_TURN:</span>
<span class="line-removed"> 202         return UAngle;</span>
<span class="line-removed"> 203     case CSS_HZ:</span>
<span class="line-removed"> 204     case CSS_KHZ:</span>
<span class="line-removed"> 205         return UFrequency;</span>
<span class="line-removed"> 206 #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-removed"> 207     case CSS_DPPX:</span>
<span class="line-removed"> 208     case CSS_DPI:</span>
<span class="line-removed"> 209     case CSS_DPCM:</span>
<span class="line-removed"> 210         return UResolution;</span>
<span class="line-removed"> 211 #endif</span>
<span class="line-removed"> 212     default:</span>
<span class="line-removed"> 213         return UOther;</span>
<span class="line-removed"> 214     }</span>
<span class="line-removed"> 215 }</span>
 216 
 217 typedef HashMap&lt;const CSSPrimitiveValue*, String&gt; CSSTextCache;
 218 static CSSTextCache&amp; cssTextCache()
 219 {
 220     static NeverDestroyed&lt;CSSTextCache&gt; cache;
 221     return cache;
 222 }
 223 
<a name="10" id="anc10"></a><span class="line-modified"> 224 unsigned short CSSPrimitiveValue::primitiveType() const</span>
 225 {
<a name="11" id="anc11"></a><span class="line-modified"> 226     if (m_primitiveUnitType == CSS_PROPERTY_ID || m_primitiveUnitType == CSS_VALUE_ID)</span>
<span class="line-modified"> 227         return CSS_IDENT;</span>
 228 
<a name="12" id="anc12"></a><span class="line-modified"> 229     // Web-exposed content expects font family values to have CSS_STRING primitive type</span>
<span class="line-modified"> 230     // so we need to map our internal CSS_FONT_FAMILY type here.</span>
<span class="line-modified"> 231     if (m_primitiveUnitType == CSS_FONT_FAMILY)</span>
<span class="line-modified"> 232         return CSS_STRING;</span>
 233 
<a name="13" id="anc13"></a><span class="line-modified"> 234     if (m_primitiveUnitType != CSSPrimitiveValue::CSS_CALC)</span>
<span class="line-modified"> 235         return m_primitiveUnitType;</span>
 236 
 237     switch (m_value.calc-&gt;category()) {
 238     case CalculationCategory::Number:
<a name="14" id="anc14"></a><span class="line-modified"> 239         return CSSPrimitiveValue::CSS_NUMBER;</span>
<span class="line-removed"> 240     case CalculationCategory::Length:</span>
<span class="line-removed"> 241         return CSSPrimitiveValue::CSS_PX;</span>
 242     case CalculationCategory::Percent:
<a name="15" id="anc15"></a><span class="line-modified"> 243         return CSSPrimitiveValue::CSS_PERCENTAGE;</span>
 244     case CalculationCategory::PercentNumber:
<a name="16" id="anc16"></a><span class="line-modified"> 245         return CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_NUMBER;</span>
 246     case CalculationCategory::PercentLength:
<a name="17" id="anc17"></a><span class="line-modified"> 247         return CSSPrimitiveValue::CSS_CALC_PERCENTAGE_WITH_LENGTH;</span>

 248     case CalculationCategory::Angle:
 249     case CalculationCategory::Time:
 250     case CalculationCategory::Frequency:
 251         return m_value.calc-&gt;primitiveType();
 252     case CalculationCategory::Other:
<a name="18" id="anc18"></a><span class="line-modified"> 253         return CSSPrimitiveValue::CSS_UNKNOWN;</span>
 254     }
<a name="19" id="anc19"></a><span class="line-modified"> 255     return CSSPrimitiveValue::CSS_UNKNOWN;</span>
 256 }
 257 
 258 static const AtomString&amp; propertyName(CSSPropertyID propertyID)
 259 {
 260     ASSERT_ARG(propertyID, (propertyID &gt;= firstCSSProperty &amp;&amp; propertyID &lt; firstCSSProperty + numCSSProperties));
 261 
 262     return getPropertyNameAtomString(propertyID);
 263 }
 264 
 265 static const AtomString&amp; valueName(CSSValueID valueID)
 266 {
 267     ASSERT_ARG(valueID, (valueID &gt;= firstCSSValueKeyword &amp;&amp; valueID &lt;= lastCSSValueKeyword));
 268 
 269     return getValueNameAtomString(valueID);
 270 }
 271 
 272 CSSPrimitiveValue::CSSPrimitiveValue(CSSValueID valueID)
 273     : CSSValue(PrimitiveClass)
 274 {
<a name="20" id="anc20"></a><span class="line-modified"> 275     m_primitiveUnitType = CSS_VALUE_ID;</span>
 276     m_value.valueID = valueID;
 277 }
 278 
 279 CSSPrimitiveValue::CSSPrimitiveValue(CSSPropertyID propertyID)
 280     : CSSValue(PrimitiveClass)
 281 {
<a name="21" id="anc21"></a><span class="line-modified"> 282     m_primitiveUnitType = CSS_PROPERTY_ID;</span>
 283     m_value.propertyID = propertyID;
 284 }
 285 
<a name="22" id="anc22"></a><span class="line-modified"> 286 CSSPrimitiveValue::CSSPrimitiveValue(double num, UnitType type)</span>
 287     : CSSValue(PrimitiveClass)
 288 {
<a name="23" id="anc23"></a><span class="line-modified"> 289     m_primitiveUnitType = type;</span>
 290     ASSERT(std::isfinite(num));
 291     m_value.num = num;
 292 }
 293 
<a name="24" id="anc24"></a><span class="line-modified"> 294 CSSPrimitiveValue::CSSPrimitiveValue(const String&amp; string, UnitType type)</span>
 295     : CSSValue(PrimitiveClass)
 296 {
 297     ASSERT(isStringType(type));
<a name="25" id="anc25"></a><span class="line-modified"> 298     m_primitiveUnitType = type;</span>
 299     if ((m_value.string = string.impl()))
 300         m_value.string-&gt;ref();
 301 }
 302 
 303 CSSPrimitiveValue::CSSPrimitiveValue(const Color&amp; color)
 304     : CSSValue(PrimitiveClass)
 305 {
<a name="26" id="anc26"></a><span class="line-modified"> 306     m_primitiveUnitType = CSS_RGBCOLOR;</span>
 307     m_value.color = new Color(color);
 308 }
 309 
 310 CSSPrimitiveValue::CSSPrimitiveValue(const Length&amp; length)
 311     : CSSValue(PrimitiveClass)
 312 {
 313     init(length);
 314 }
 315 
 316 CSSPrimitiveValue::CSSPrimitiveValue(const Length&amp; length, const RenderStyle&amp; style)
 317     : CSSValue(PrimitiveClass)
 318 {
 319     switch (length.type()) {
 320     case Auto:
 321     case Intrinsic:
 322     case MinIntrinsic:
 323     case MinContent:
 324     case MaxContent:
 325     case FillAvailable:
 326     case FitContent:
 327     case Percent:
 328         init(length);
 329         return;
 330     case Fixed:
<a name="27" id="anc27"></a><span class="line-modified"> 331         m_primitiveUnitType = CSS_PX;</span>
 332         m_value.num = adjustFloatForAbsoluteZoom(length.value(), style);
 333         return;
 334     case Calculated: {
 335         init(CSSCalcValue::create(length.calculationValue(), style));
 336         return;
 337     }
 338     case Relative:
 339     case Undefined:
 340         ASSERT_NOT_REACHED();
 341         return;
 342     }
 343     ASSERT_NOT_REACHED();
 344 }
 345 
 346 CSSPrimitiveValue::CSSPrimitiveValue(const LengthSize&amp; lengthSize, const RenderStyle&amp; style)
 347     : CSSValue(PrimitiveClass)
 348 {
 349     init(lengthSize, style);
 350 }
 351 
<a name="28" id="anc28"></a>

















 352 void CSSPrimitiveValue::init(const Length&amp; length)
 353 {
 354     switch (length.type()) {
 355     case Auto:
<a name="29" id="anc29"></a><span class="line-modified"> 356         m_primitiveUnitType = CSS_VALUE_ID;</span>
 357         m_value.valueID = CSSValueAuto;
 358         return;
 359     case WebCore::Fixed:
<a name="30" id="anc30"></a><span class="line-modified"> 360         m_primitiveUnitType = CSS_PX;</span>
 361         m_value.num = length.value();
 362         return;
 363     case Intrinsic:
<a name="31" id="anc31"></a><span class="line-modified"> 364         m_primitiveUnitType = CSS_VALUE_ID;</span>
 365         m_value.valueID = CSSValueIntrinsic;
 366         return;
 367     case MinIntrinsic:
<a name="32" id="anc32"></a><span class="line-modified"> 368         m_primitiveUnitType = CSS_VALUE_ID;</span>
 369         m_value.valueID = CSSValueMinIntrinsic;
 370         return;
 371     case MinContent:
<a name="33" id="anc33"></a><span class="line-modified"> 372         m_primitiveUnitType = CSS_VALUE_ID;</span>
 373         m_value.valueID = CSSValueMinContent;
 374         return;
 375     case MaxContent:
<a name="34" id="anc34"></a><span class="line-modified"> 376         m_primitiveUnitType = CSS_VALUE_ID;</span>
 377         m_value.valueID = CSSValueMaxContent;
 378         return;
 379     case FillAvailable:
<a name="35" id="anc35"></a><span class="line-modified"> 380         m_primitiveUnitType = CSS_VALUE_ID;</span>
 381         m_value.valueID = CSSValueWebkitFillAvailable;
 382         return;
 383     case FitContent:
<a name="36" id="anc36"></a><span class="line-modified"> 384         m_primitiveUnitType = CSS_VALUE_ID;</span>
 385         m_value.valueID = CSSValueFitContent;
 386         return;
 387     case Percent:
<a name="37" id="anc37"></a><span class="line-modified"> 388         m_primitiveUnitType = CSS_PERCENTAGE;</span>
 389         ASSERT(std::isfinite(length.percent()));
 390         m_value.num = length.percent();
 391         return;
 392     case Calculated:
 393     case Relative:
 394     case Undefined:
 395         ASSERT_NOT_REACHED();
 396         return;
 397     }
 398     ASSERT_NOT_REACHED();
 399 }
 400 
 401 void CSSPrimitiveValue::init(const LengthSize&amp; lengthSize, const RenderStyle&amp; style)
 402 {
<a name="38" id="anc38"></a><span class="line-modified"> 403     m_primitiveUnitType = CSS_PAIR;</span>
 404     m_hasCachedCSSText = false;
 405     m_value.pair = &amp;Pair::create(create(lengthSize.width, style), create(lengthSize.height, style)).leakRef();
 406 }
 407 
 408 void CSSPrimitiveValue::init(Ref&lt;Counter&gt;&amp;&amp; counter)
 409 {
<a name="39" id="anc39"></a><span class="line-modified"> 410     m_primitiveUnitType = CSS_COUNTER;</span>
 411     m_hasCachedCSSText = false;
 412     m_value.counter = &amp;counter.leakRef();
 413 }
 414 
 415 void CSSPrimitiveValue::init(Ref&lt;Rect&gt;&amp;&amp; r)
 416 {
<a name="40" id="anc40"></a><span class="line-modified"> 417     m_primitiveUnitType = CSS_RECT;</span>
 418     m_hasCachedCSSText = false;
 419     m_value.rect = &amp;r.leakRef();
 420 }
 421 
 422 void CSSPrimitiveValue::init(Ref&lt;Quad&gt;&amp;&amp; quad)
 423 {
<a name="41" id="anc41"></a><span class="line-modified"> 424     m_primitiveUnitType = CSS_QUAD;</span>
 425     m_hasCachedCSSText = false;
 426     m_value.quad = &amp;quad.leakRef();
 427 }
 428 
 429 void CSSPrimitiveValue::init(Ref&lt;Pair&gt;&amp;&amp; p)
 430 {
<a name="42" id="anc42"></a><span class="line-modified"> 431     m_primitiveUnitType = CSS_PAIR;</span>
 432     m_hasCachedCSSText = false;
 433     m_value.pair = &amp;p.leakRef();
 434 }
 435 
 436 void CSSPrimitiveValue::init(Ref&lt;CSSBasicShape&gt;&amp;&amp; shape)
 437 {
<a name="43" id="anc43"></a><span class="line-modified"> 438     m_primitiveUnitType = CSS_SHAPE;</span>
 439     m_hasCachedCSSText = false;
 440     m_value.shape = &amp;shape.leakRef();
 441 }
 442 
 443 void CSSPrimitiveValue::init(RefPtr&lt;CSSCalcValue&gt;&amp;&amp; c)
 444 {
<a name="44" id="anc44"></a><span class="line-modified"> 445     m_primitiveUnitType = CSS_CALC;</span>
 446     m_hasCachedCSSText = false;
 447     m_value.calc = c.leakRef();
 448 }
 449 
 450 CSSPrimitiveValue::~CSSPrimitiveValue()
 451 {
 452     cleanup();
 453 }
 454 
 455 void CSSPrimitiveValue::cleanup()
 456 {
<a name="45" id="anc45"></a><span class="line-modified"> 457     auto type = static_cast&lt;UnitType&gt;(m_primitiveUnitType);</span>
 458     switch (type) {
<a name="46" id="anc46"></a><span class="line-modified"> 459     case CSS_STRING:</span>
<span class="line-modified"> 460     case CSS_URI:</span>
<span class="line-modified"> 461     case CSS_ATTR:</span>
<span class="line-modified"> 462     case CSS_COUNTER_NAME:</span>
 463         if (m_value.string)
 464             m_value.string-&gt;deref();
 465         break;
<a name="47" id="anc47"></a><span class="line-modified"> 466     case CSS_DIMENSION:</span>
<span class="line-modified"> 467     case CSS_COUNTER:</span>
 468         m_value.counter-&gt;deref();
 469         break;
<a name="48" id="anc48"></a><span class="line-modified"> 470     case CSS_RECT:</span>
 471         m_value.rect-&gt;deref();
 472         break;
<a name="49" id="anc49"></a><span class="line-modified"> 473     case CSS_QUAD:</span>
 474         m_value.quad-&gt;deref();
 475         break;
<a name="50" id="anc50"></a><span class="line-modified"> 476     case CSS_PAIR:</span>
 477         m_value.pair-&gt;deref();
 478         break;
<a name="51" id="anc51"></a><span class="line-modified"> 479     case CSS_CALC:</span>
 480         m_value.calc-&gt;deref();
 481         break;
<a name="52" id="anc52"></a><span class="line-modified"> 482     case CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
<span class="line-modified"> 483     case CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
 484         ASSERT_NOT_REACHED();
 485         break;
<a name="53" id="anc53"></a><span class="line-modified"> 486     case CSS_SHAPE:</span>
 487         m_value.shape-&gt;deref();
 488         break;
<a name="54" id="anc54"></a><span class="line-modified"> 489     case CSS_FONT_FAMILY:</span>
 490         ASSERT(m_value.fontFamily);
 491         delete m_value.fontFamily;
 492         m_value.fontFamily = nullptr;
 493         break;
<a name="55" id="anc55"></a><span class="line-modified"> 494     case CSS_RGBCOLOR:</span>
 495         ASSERT(m_value.color);
 496         delete m_value.color;
 497         m_value.color = nullptr;
 498         break;
<a name="56" id="anc56"></a><span class="line-modified"> 499     case CSS_NUMBER:</span>
<span class="line-modified"> 500     case CSS_PERCENTAGE:</span>
<span class="line-modified"> 501     case CSS_EMS:</span>
<span class="line-modified"> 502     case CSS_QUIRKY_EMS:</span>
<span class="line-modified"> 503     case CSS_EXS:</span>
<span class="line-modified"> 504     case CSS_REMS:</span>
<span class="line-modified"> 505     case CSS_CHS:</span>
<span class="line-modified"> 506     case CSS_PX:</span>
<span class="line-modified"> 507     case CSS_CM:</span>
<span class="line-modified"> 508     case CSS_MM:</span>
<span class="line-modified"> 509     case CSS_IN:</span>
<span class="line-modified"> 510     case CSS_PT:</span>
<span class="line-modified"> 511     case CSS_PC:</span>
<span class="line-modified"> 512     case CSS_DEG:</span>
<span class="line-modified"> 513     case CSS_RAD:</span>
<span class="line-modified"> 514     case CSS_GRAD:</span>
<span class="line-modified"> 515     case CSS_MS:</span>
<span class="line-modified"> 516     case CSS_S:</span>
<span class="line-modified"> 517     case CSS_HZ:</span>
<span class="line-modified"> 518     case CSS_KHZ:</span>
<span class="line-modified"> 519     case CSS_TURN:</span>
<span class="line-modified"> 520     case CSS_VW:</span>
<span class="line-modified"> 521     case CSS_VH:</span>
<span class="line-modified"> 522     case CSS_VMIN:</span>
<span class="line-modified"> 523     case CSS_VMAX:</span>
<span class="line-modified"> 524     case CSS_DPPX:</span>
<span class="line-modified"> 525     case CSS_DPI:</span>
<span class="line-modified"> 526     case CSS_DPCM:</span>
<span class="line-modified"> 527     case CSS_FR:</span>
<span class="line-modified"> 528     case CSS_IDENT:</span>
<span class="line-modified"> 529     case CSS_UNKNOWN:</span>
<span class="line-modified"> 530     case CSS_UNICODE_RANGE:</span>
<span class="line-modified"> 531     case CSS_PROPERTY_ID:</span>
<span class="line-modified"> 532     case CSS_VALUE_ID:</span>

 533         ASSERT(!isStringType(type));
 534         break;
 535     }
<a name="57" id="anc57"></a><span class="line-modified"> 536     m_primitiveUnitType = 0;</span>
 537     if (m_hasCachedCSSText) {
 538         cssTextCache().remove(this);
 539         m_hasCachedCSSText = false;
 540     }
 541 }
 542 
 543 double CSSPrimitiveValue::computeDegrees() const
 544 {
 545     switch (primitiveType()) {
<a name="58" id="anc58"></a><span class="line-modified"> 546     case CSS_DEG:</span>
 547         return doubleValue();
<a name="59" id="anc59"></a><span class="line-modified"> 548     case CSS_RAD:</span>
 549         return rad2deg(doubleValue());
<a name="60" id="anc60"></a><span class="line-modified"> 550     case CSS_GRAD:</span>
 551         return grad2deg(doubleValue());
<a name="61" id="anc61"></a><span class="line-modified"> 552     case CSS_TURN:</span>
 553         return turn2deg(doubleValue());
 554     default:
 555         ASSERT_NOT_REACHED();
 556         return 0;
 557     }
 558 }
 559 
 560 template&lt;&gt; int CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 561 {
 562     return roundForImpreciseConversion&lt;int&gt;(computeLengthDouble(conversionData));
 563 }
 564 
 565 template&lt;&gt; unsigned CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 566 {
 567     return roundForImpreciseConversion&lt;unsigned&gt;(computeLengthDouble(conversionData));
 568 }
 569 
 570 template&lt;&gt; Length CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 571 {
 572     return Length(clampTo&lt;float&gt;(computeLengthDouble(conversionData), minValueForCssLength, maxValueForCssLength), Fixed);
 573 }
 574 
 575 template&lt;&gt; short CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 576 {
 577     return roundForImpreciseConversion&lt;short&gt;(computeLengthDouble(conversionData));
 578 }
 579 
 580 template&lt;&gt; unsigned short CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 581 {
 582     return roundForImpreciseConversion&lt;unsigned short&gt;(computeLengthDouble(conversionData));
 583 }
 584 
 585 template&lt;&gt; float CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 586 {
 587     return static_cast&lt;float&gt;(computeLengthDouble(conversionData));
 588 }
 589 
 590 template&lt;&gt; double CSSPrimitiveValue::computeLength(const CSSToLengthConversionData&amp; conversionData) const
 591 {
 592     return computeLengthDouble(conversionData);
 593 }
 594 
<a name="62" id="anc62"></a>




 595 double CSSPrimitiveValue::computeLengthDouble(const CSSToLengthConversionData&amp; conversionData) const
 596 {
<a name="63" id="anc63"></a><span class="line-modified"> 597     if (m_primitiveUnitType == CSS_CALC)</span>
 598         // The multiplier and factor is applied to each value in the calc expression individually
 599         return m_value.calc-&gt;computeLengthPx(conversionData);
<a name="64" id="anc64"></a>
 600 
<a name="65" id="anc65"></a><span class="line-modified"> 601     return computeNonCalcLengthDouble(conversionData, static_cast&lt;UnitType&gt;(primitiveType()), m_value.num);</span>
 602 }
 603 
<a name="66" id="anc66"></a><span class="line-modified"> 604 double CSSPrimitiveValue::computeNonCalcLengthDouble(const CSSToLengthConversionData&amp; conversionData, UnitType primitiveType, double value)</span>




 605 {
 606     double factor;
 607     bool applyZoom = true;
 608 
 609     switch (primitiveType) {
<a name="67" id="anc67"></a><span class="line-modified"> 610     case CSS_EMS:</span>
<span class="line-modified"> 611     case CSS_QUIRKY_EMS:</span>
 612         ASSERT(conversionData.style());
 613         factor = conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize();
 614         break;
<a name="68" id="anc68"></a><span class="line-modified"> 615     case CSS_EXS:</span>
 616         ASSERT(conversionData.style());
 617         // FIXME: We have a bug right now where the zoom will be applied twice to EX units.
 618         // We really need to compute EX using fontMetrics for the original specifiedSize and not use
 619         // our actual constructed rendering font.
 620         if (conversionData.style()-&gt;fontMetrics().hasXHeight())
 621             factor = conversionData.style()-&gt;fontMetrics().xHeight();
 622         else
 623             factor = (conversionData.computingFontSize() ? conversionData.style()-&gt;fontDescription().specifiedSize() : conversionData.style()-&gt;fontDescription().computedSize()) / 2.0;
 624         break;
<a name="69" id="anc69"></a><span class="line-modified"> 625     case CSS_REMS:</span>
 626         if (conversionData.rootStyle())
 627             factor = conversionData.computingFontSize() ? conversionData.rootStyle()-&gt;fontDescription().specifiedSize() : conversionData.rootStyle()-&gt;fontDescription().computedSize();
 628         else
 629             factor = 1.0;
 630         break;
<a name="70" id="anc70"></a><span class="line-modified"> 631     case CSS_CHS:</span>
 632         ASSERT(conversionData.style());
 633         factor = conversionData.style()-&gt;fontMetrics().zeroWidth();
 634         break;
<a name="71" id="anc71"></a><span class="line-modified"> 635     case CSS_PX:</span>
 636         factor = 1.0;
 637         break;
<a name="72" id="anc72"></a><span class="line-modified"> 638     case CSS_CM:</span>
<span class="line-modified"> 639         factor = cssPixelsPerInch / 2.54; // (2.54 cm/in)</span>



 640         break;
<a name="73" id="anc73"></a><span class="line-modified"> 641     case CSS_MM:</span>
<span class="line-modified"> 642         factor = cssPixelsPerInch / 25.4;</span>
 643         break;
<a name="74" id="anc74"></a><span class="line-modified"> 644     case CSS_IN:</span>
 645         factor = cssPixelsPerInch;
 646         break;
<a name="75" id="anc75"></a><span class="line-modified"> 647     case CSS_PT:</span>
 648         factor = cssPixelsPerInch / 72.0;
 649         break;
<a name="76" id="anc76"></a><span class="line-modified"> 650     case CSS_PC:</span>
 651         // 1 pc == 12 pt
 652         factor = cssPixelsPerInch * 12.0 / 72.0;
 653         break;
<a name="77" id="anc77"></a><span class="line-modified"> 654     case CSS_CALC_PERCENTAGE_WITH_LENGTH:</span>
<span class="line-modified"> 655     case CSS_CALC_PERCENTAGE_WITH_NUMBER:</span>
 656         ASSERT_NOT_REACHED();
 657         return -1.0;
<a name="78" id="anc78"></a><span class="line-modified"> 658     case CSS_VH:</span>
 659         factor = conversionData.viewportHeightFactor();
 660         applyZoom = false;
 661         break;
<a name="79" id="anc79"></a><span class="line-modified"> 662     case CSS_VW:</span>
 663         factor = conversionData.viewportWidthFactor();
 664         applyZoom = false;
 665         break;
<a name="80" id="anc80"></a><span class="line-modified"> 666     case CSS_VMAX:</span>
 667         factor = conversionData.viewportMaxFactor();
 668         applyZoom = false;
 669         break;
<a name="81" id="anc81"></a><span class="line-modified"> 670     case CSS_VMIN:</span>
 671         factor = conversionData.viewportMinFactor();
 672         applyZoom = false;
 673         break;
 674     default:
 675         ASSERT_NOT_REACHED();
 676         return -1.0;
 677     }
 678 
 679     // We do not apply the zoom factor when we are computing the value of the font-size property. The zooming
 680     // for font sizes is much more complicated, since we have to worry about enforcing the minimum font size preference
 681     // as well as enforcing the implicit &quot;smart minimum.&quot;
 682     double result = value * factor;
 683     if (conversionData.computingFontSize() || isFontRelativeLength(primitiveType))
 684         return result;
 685 
 686     if (applyZoom)
 687         result *= conversionData.zoom();
 688 
 689     return result;
 690 }
 691 
<a name="82" id="anc82"></a><span class="line-modified"> 692 ExceptionOr&lt;void&gt; CSSPrimitiveValue::setFloatValue(unsigned short, double)</span>



















 693 {
 694     // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
 695     // No other engine supports mutating style through this API. Computed style is always read-only anyway.
 696     // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
 697     return Exception { NoModificationAllowedError };
 698 }
 699 
<a name="83" id="anc83"></a><span class="line-modified"> 700 double CSSPrimitiveValue::conversionToCanonicalUnitsScaleFactor(UnitType unitType)</span>
 701 {
 702     double factor = 1.0;
 703     // FIXME: the switch can be replaced by an array of scale factors.
 704     switch (unitType) {
 705     // These are &quot;canonical&quot; units in their respective categories.
<a name="84" id="anc84"></a><span class="line-modified"> 706     case CSS_PX:</span>
<span class="line-modified"> 707     case CSS_DEG:</span>
<span class="line-modified"> 708     case CSS_MS:</span>
<span class="line-modified"> 709     case CSS_HZ:</span>




 710         break;
<a name="85" id="anc85"></a><span class="line-modified"> 711     case CSS_CM:</span>
<span class="line-modified"> 712         factor = cssPixelsPerInch / 2.54; // (2.54 cm/in)</span>
 713         break;
<a name="86" id="anc86"></a><span class="line-modified"> 714     case CSS_DPCM:</span>
<span class="line-modified"> 715         factor = 2.54 / cssPixelsPerInch; // (2.54 cm/in)</span>
 716         break;
<a name="87" id="anc87"></a><span class="line-modified"> 717     case CSS_MM:</span>
<span class="line-modified"> 718         factor = cssPixelsPerInch / 25.4;</span>
 719         break;
<a name="88" id="anc88"></a><span class="line-modified"> 720     case CSS_IN:</span>
 721         factor = cssPixelsPerInch;
 722         break;
<a name="89" id="anc89"></a><span class="line-modified"> 723     case CSS_DPI:</span>
 724         factor = 1 / cssPixelsPerInch;
 725         break;
<a name="90" id="anc90"></a><span class="line-modified"> 726     case CSS_PT:</span>
 727         factor = cssPixelsPerInch / 72.0;
 728         break;
<a name="91" id="anc91"></a><span class="line-modified"> 729     case CSS_PC:</span>
 730         factor = cssPixelsPerInch * 12.0 / 72.0; // 1 pc == 12 pt
 731         break;
<a name="92" id="anc92"></a><span class="line-modified"> 732     case CSS_RAD:</span>
 733         factor = 180 / piDouble;
 734         break;
<a name="93" id="anc93"></a><span class="line-modified"> 735     case CSS_GRAD:</span>
 736         factor = 0.9;
 737         break;
<a name="94" id="anc94"></a><span class="line-modified"> 738     case CSS_TURN:</span>
 739         factor = 360;
 740         break;
<a name="95" id="anc95"></a><span class="line-modified"> 741     case CSS_S:</span>
<span class="line-modified"> 742     case CSS_KHZ:</span>
 743         factor = 1000;
 744         break;
 745     default:
 746         break;
 747     }
 748 
 749     return factor;
 750 }
 751 
<a name="96" id="anc96"></a><span class="line-modified"> 752 ExceptionOr&lt;float&gt; CSSPrimitiveValue::getFloatValue(unsigned short unitType) const</span>
 753 {
<a name="97" id="anc97"></a><span class="line-modified"> 754     auto result = doubleValueInternal(static_cast&lt;UnitType&gt;(unitType));</span>
 755     if (!result)
 756         return Exception { InvalidAccessError };
 757     return clampTo&lt;float&gt;(result.value());
 758 }
 759 
<a name="98" id="anc98"></a><span class="line-modified"> 760 double CSSPrimitiveValue::doubleValue(UnitType unitType) const</span>
 761 {
 762     return doubleValueInternal(unitType).valueOr(0);
 763 }
 764 
 765 double CSSPrimitiveValue::doubleValue() const
 766 {
<a name="99" id="anc99"></a><span class="line-modified"> 767     return m_primitiveUnitType != CSS_CALC ? m_value.num : m_value.calc-&gt;doubleValue();</span>
 768 }
 769 
<a name="100" id="anc100"></a>





 770 
<a name="101" id="anc101"></a><span class="line-modified"> 771 CSSPrimitiveValue::UnitType CSSPrimitiveValue::canonicalUnitTypeForCategory(UnitCategory category)</span>
 772 {
<a name="102" id="anc102"></a><span class="line-modified"> 773     // The canonical unit type is chosen according to the way CSSParser::validUnit() chooses the default unit</span>
<span class="line-modified"> 774     // in each category (based on unitflags).</span>
<span class="line-modified"> 775     switch (category) {</span>
<span class="line-modified"> 776     case UNumber:</span>
<span class="line-modified"> 777         return CSS_NUMBER;</span>
<span class="line-modified"> 778     case ULength:</span>
<span class="line-modified"> 779         return CSS_PX;</span>
<span class="line-modified"> 780     case UPercent:</span>
<span class="line-modified"> 781         return CSS_UNKNOWN; // Cannot convert between numbers and percent.</span>
<span class="line-modified"> 782     case UTime:</span>
<span class="line-removed"> 783         return CSS_MS;</span>
<span class="line-removed"> 784     case UAngle:</span>
<span class="line-removed"> 785         return CSS_DEG;</span>
<span class="line-removed"> 786     case UFrequency:</span>
<span class="line-removed"> 787         return CSS_HZ;</span>
<span class="line-removed"> 788 #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-removed"> 789     case UResolution:</span>
<span class="line-removed"> 790         return CSS_DPPX;</span>
<span class="line-removed"> 791 #endif</span>
<span class="line-removed"> 792     default:</span>
<span class="line-removed"> 793         return CSS_UNKNOWN;</span>
<span class="line-removed"> 794     }</span>
 795 }
 796 
<a name="103" id="anc103"></a><span class="line-modified"> 797 Optional&lt;double&gt; CSSPrimitiveValue::doubleValueInternal(UnitType requestedUnitType) const</span>
 798 {
<a name="104" id="anc104"></a><span class="line-modified"> 799     if (!isValidCSSUnitTypeForDoubleConversion(static_cast&lt;UnitType&gt;(m_primitiveUnitType)) || !isValidCSSUnitTypeForDoubleConversion(requestedUnitType))</span>
 800         return WTF::nullopt;
 801 
<a name="105" id="anc105"></a><span class="line-modified"> 802     UnitType sourceUnitType = static_cast&lt;UnitType&gt;(primitiveType());</span>
<span class="line-modified"> 803     if (requestedUnitType == sourceUnitType || requestedUnitType == CSS_DIMENSION)</span>
 804         return doubleValue();
 805 
<a name="106" id="anc106"></a><span class="line-modified"> 806     UnitCategory sourceCategory = unitCategory(sourceUnitType);</span>
<span class="line-modified"> 807     ASSERT(sourceCategory != UOther);</span>
 808 
<a name="107" id="anc107"></a><span class="line-modified"> 809     UnitType targetUnitType = requestedUnitType;</span>
<span class="line-modified"> 810     UnitCategory targetCategory = unitCategory(targetUnitType);</span>
<span class="line-modified"> 811     ASSERT(targetCategory != UOther);</span>
 812 
<a name="108" id="anc108"></a><span class="line-modified"> 813     // Cannot convert between unrelated unit categories if one of them is not UNumber.</span>
<span class="line-modified"> 814     if (sourceCategory != targetCategory &amp;&amp; sourceCategory != UNumber &amp;&amp; targetCategory != UNumber)</span>
 815         return WTF::nullopt;
 816 
<a name="109" id="anc109"></a><span class="line-modified"> 817     if (targetCategory == UNumber) {</span>
<span class="line-modified"> 818         // We interpret conversion to CSS_NUMBER as conversion to a canonical unit in this value&#39;s category.</span>
 819         targetUnitType = canonicalUnitTypeForCategory(sourceCategory);
<a name="110" id="anc110"></a><span class="line-modified"> 820         if (targetUnitType == CSS_UNKNOWN)</span>
 821             return WTF::nullopt;
 822     }
 823 
<a name="111" id="anc111"></a><span class="line-modified"> 824     if (sourceUnitType == CSS_NUMBER) {</span>
<span class="line-modified"> 825         // We interpret conversion from CSS_NUMBER in the same way as CSSParser::validUnit() while using non-strict mode.</span>
 826         sourceUnitType = canonicalUnitTypeForCategory(targetCategory);
<a name="112" id="anc112"></a><span class="line-modified"> 827         if (sourceUnitType == CSS_UNKNOWN)</span>
 828             return WTF::nullopt;
 829     }
 830 
 831     double convertedValue = doubleValue();
 832 
<a name="113" id="anc113"></a><span class="line-modified"> 833     // First convert the value from m_primitiveUnitType to canonical type.</span>
 834     double factor = conversionToCanonicalUnitsScaleFactor(sourceUnitType);
 835     convertedValue *= factor;
 836 
 837     // Now convert from canonical type to the target unitType.
 838     factor = conversionToCanonicalUnitsScaleFactor(targetUnitType);
 839     convertedValue /= factor;
 840 
 841     return convertedValue;
 842 }
 843 
<a name="114" id="anc114"></a><span class="line-modified"> 844 ExceptionOr&lt;void&gt; CSSPrimitiveValue::setStringValue(unsigned short, const String&amp;)</span>
 845 {
 846     // Keeping values immutable makes optimizations easier and allows sharing of the primitive value objects.
 847     // No other engine supports mutating style through this API. Computed style is always read-only anyway.
 848     // Supporting setter would require making primitive value copy-on-write and taking care of style invalidation.
 849     return Exception { NoModificationAllowedError };
 850 }
 851 
 852 ExceptionOr&lt;String&gt; CSSPrimitiveValue::getStringValue() const
 853 {
<a name="115" id="anc115"></a><span class="line-modified"> 854     switch (m_primitiveUnitType) {</span>
<span class="line-modified"> 855     case CSS_STRING:</span>
<span class="line-modified"> 856     case CSS_ATTR:</span>
<span class="line-modified"> 857     case CSS_URI:</span>
 858         return m_value.string;
<a name="116" id="anc116"></a><span class="line-modified"> 859     case CSS_FONT_FAMILY:</span>
 860         return String { m_value.fontFamily-&gt;familyName };
<a name="117" id="anc117"></a><span class="line-modified"> 861     case CSS_VALUE_ID:</span>
 862         return String { valueName(m_value.valueID).string() };
<a name="118" id="anc118"></a><span class="line-modified"> 863     case CSS_PROPERTY_ID:</span>
 864         return String { propertyName(m_value.propertyID).string() };
 865     default:
 866         return Exception { InvalidAccessError };
 867     }
 868 }
 869 
 870 String CSSPrimitiveValue::stringValue() const
 871 {
<a name="119" id="anc119"></a><span class="line-modified"> 872     switch (m_primitiveUnitType) {</span>
<span class="line-modified"> 873     case CSS_STRING:</span>
<span class="line-modified"> 874     case CSS_ATTR:</span>
<span class="line-modified"> 875     case CSS_URI:</span>
 876         return m_value.string;
<a name="120" id="anc120"></a><span class="line-modified"> 877     case CSS_FONT_FAMILY:</span>
 878         return m_value.fontFamily-&gt;familyName;
<a name="121" id="anc121"></a><span class="line-modified"> 879     case CSS_VALUE_ID:</span>
 880         return valueName(m_value.valueID);
<a name="122" id="anc122"></a><span class="line-modified"> 881     case CSS_PROPERTY_ID:</span>
 882         return propertyName(m_value.propertyID);
 883     default:
 884         return String();
 885     }
 886 }
 887 
<a name="123" id="anc123"></a><span class="line-modified"> 888 ExceptionOr&lt;Counter&amp;&gt; CSSPrimitiveValue::getCounterValue() const</span>
<span class="line-removed"> 889 {</span>
<span class="line-removed"> 890     if (m_primitiveUnitType != CSS_COUNTER)</span>
<span class="line-removed"> 891         return Exception { InvalidAccessError };</span>
<span class="line-removed"> 892     return *m_value.counter;</span>
<span class="line-removed"> 893 }</span>
<span class="line-removed"> 894 </span>
<span class="line-removed"> 895 ExceptionOr&lt;Rect&amp;&gt; CSSPrimitiveValue::getRectValue() const</span>
<span class="line-removed"> 896 {</span>
<span class="line-removed"> 897     if (m_primitiveUnitType != CSS_RECT)</span>
<span class="line-removed"> 898         return Exception { InvalidAccessError };</span>
<span class="line-removed"> 899     return *m_value.rect;</span>
<span class="line-removed"> 900 }</span>
<span class="line-removed"> 901 </span>
<span class="line-removed"> 902 ExceptionOr&lt;Ref&lt;RGBColor&gt;&gt; CSSPrimitiveValue::getRGBColorValue() const</span>
 903 {
<a name="124" id="anc124"></a><span class="line-modified"> 904     if (m_primitiveUnitType != CSS_RGBCOLOR)</span>
<span class="line-removed"> 905         return Exception { InvalidAccessError };</span>
<span class="line-removed"> 906 </span>
<span class="line-removed"> 907     // FIXME: This should not return a new object for each invocation.</span>
<span class="line-removed"> 908     return RGBColor::create(m_value.color-&gt;rgb());</span>
 909 }
 910 
<a name="125" id="anc125"></a><span class="line-modified"> 911 NEVER_INLINE String CSSPrimitiveValue::formatNumberValue(StringView suffix) const</span>
 912 {
<a name="126" id="anc126"></a><span class="line-modified"> 913     return makeString(m_value.num, suffix);</span>






















































 914 }
 915 
 916 ALWAYS_INLINE String CSSPrimitiveValue::formatNumberForCustomCSSText() const
 917 {
<a name="127" id="anc127"></a><span class="line-modified"> 918     switch (m_primitiveUnitType) {</span>
<span class="line-modified"> 919     case CSS_UNKNOWN:</span>
 920         return String();
<a name="128" id="anc128"></a><span class="line-modified"> 921     case CSS_NUMBER:</span>
 922         return formatNumberValue(&quot;&quot;);
<a name="129" id="anc129"></a><span class="line-modified"> 923     case CSS_PERCENTAGE:</span>
 924         return formatNumberValue(&quot;%&quot;);
<a name="130" id="anc130"></a><span class="line-modified"> 925     case CSS_EMS:</span>
<span class="line-modified"> 926     case CSS_QUIRKY_EMS:</span>
 927         return formatNumberValue(&quot;em&quot;);
<a name="131" id="anc131"></a><span class="line-modified"> 928     case CSS_EXS:</span>
 929         return formatNumberValue(&quot;ex&quot;);
<a name="132" id="anc132"></a><span class="line-modified"> 930     case CSS_REMS:</span>
 931         return formatNumberValue(&quot;rem&quot;);
<a name="133" id="anc133"></a><span class="line-modified"> 932     case CSS_CHS:</span>
 933         return formatNumberValue(&quot;ch&quot;);
<a name="134" id="anc134"></a><span class="line-modified"> 934     case CSS_PX:</span>
 935         return formatNumberValue(&quot;px&quot;);
<a name="135" id="anc135"></a><span class="line-modified"> 936     case CSS_CM:</span>
 937         return formatNumberValue(&quot;cm&quot;);
<a name="136" id="anc136"></a><span class="line-modified"> 938 #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-removed"> 939     case CSS_DPPX:</span>
 940         return formatNumberValue(&quot;dppx&quot;);
<a name="137" id="anc137"></a><span class="line-modified"> 941     case CSS_DPI:</span>
 942         return formatNumberValue(&quot;dpi&quot;);
<a name="138" id="anc138"></a><span class="line-modified"> 943     case CSS_DPCM:</span>
 944         return formatNumberValue(&quot;dpcm&quot;);
<a name="139" id="anc139"></a><span class="line-modified"> 945 #endif</span>
<span class="line-removed"> 946     case CSS_MM:</span>
 947         return formatNumberValue(&quot;mm&quot;);
<a name="140" id="anc140"></a><span class="line-modified"> 948     case CSS_IN:</span>
 949         return formatNumberValue(&quot;in&quot;);
<a name="141" id="anc141"></a><span class="line-modified"> 950     case CSS_PT:</span>
 951         return formatNumberValue(&quot;pt&quot;);
<a name="142" id="anc142"></a><span class="line-modified"> 952     case CSS_PC:</span>
 953         return formatNumberValue(&quot;pc&quot;);
<a name="143" id="anc143"></a><span class="line-modified"> 954     case CSS_DEG:</span>
 955         return formatNumberValue(&quot;deg&quot;);
<a name="144" id="anc144"></a><span class="line-modified"> 956     case CSS_RAD:</span>
 957         return formatNumberValue(&quot;rad&quot;);
<a name="145" id="anc145"></a><span class="line-modified"> 958     case CSS_GRAD:</span>
 959         return formatNumberValue(&quot;grad&quot;);
<a name="146" id="anc146"></a><span class="line-modified"> 960     case CSS_MS:</span>
 961         return formatNumberValue(&quot;ms&quot;);
<a name="147" id="anc147"></a><span class="line-modified"> 962     case CSS_S:</span>
 963         return formatNumberValue(&quot;s&quot;);
<a name="148" id="anc148"></a><span class="line-modified"> 964     case CSS_HZ:</span>
 965         return formatNumberValue(&quot;hz&quot;);
<a name="149" id="anc149"></a><span class="line-modified"> 966     case CSS_KHZ:</span>
 967         return formatNumberValue(&quot;khz&quot;);
<a name="150" id="anc150"></a><span class="line-modified"> 968     case CSS_TURN:</span>
 969         return formatNumberValue(&quot;turn&quot;);
<a name="151" id="anc151"></a><span class="line-modified"> 970     case CSS_FR:</span>
 971         return formatNumberValue(&quot;fr&quot;);
<a name="152" id="anc152"></a><span class="line-modified"> 972     case CSS_DIMENSION:</span>
<span class="line-modified"> 973         // FIXME: We currently don&#39;t handle CSS_DIMENSION properly as we don&#39;t store</span>


 974         // the actual dimension, just the numeric value as a string.
<a name="153" id="anc153"></a><span class="line-modified"> 975     case CSS_STRING:</span>
 976         // FIME-NEWPARSER: Once we have CSSCustomIdentValue hooked up, this can just be
 977         // serializeString, since custom identifiers won&#39;t be the same value as strings
 978         // any longer.
 979         return serializeAsStringOrCustomIdent(m_value.string);
<a name="154" id="anc154"></a><span class="line-modified"> 980     case CSS_FONT_FAMILY:</span>
 981         return serializeFontFamily(m_value.fontFamily-&gt;familyName);
<a name="155" id="anc155"></a><span class="line-modified"> 982     case CSS_URI:</span>
 983         return serializeURL(m_value.string);
<a name="156" id="anc156"></a><span class="line-modified"> 984     case CSS_VALUE_ID:</span>
 985         return valueName(m_value.valueID);
<a name="157" id="anc157"></a><span class="line-modified"> 986     case CSS_PROPERTY_ID:</span>
 987         return propertyName(m_value.propertyID);
<a name="158" id="anc158"></a><span class="line-modified"> 988     case CSS_ATTR:</span>
 989         return &quot;attr(&quot; + String(m_value.string) + &#39;)&#39;;
<a name="159" id="anc159"></a><span class="line-modified"> 990     case CSS_COUNTER_NAME:</span>
 991         return &quot;counter(&quot; + String(m_value.string) + &#39;)&#39;;
<a name="160" id="anc160"></a><span class="line-modified"> 992     case CSS_COUNTER: {</span>
 993         StringBuilder result;
 994         String separator = m_value.counter-&gt;separator();
 995         if (separator.isEmpty())
 996             result.appendLiteral(&quot;counter(&quot;);
 997         else
 998             result.appendLiteral(&quot;counters(&quot;);
 999 
1000         result.append(m_value.counter-&gt;identifier());
1001         if (!separator.isEmpty()) {
1002             result.appendLiteral(&quot;, &quot;);
1003             serializeString(separator, result);
1004         }
1005         String listStyle = m_value.counter-&gt;listStyle();
1006         if (!listStyle.isEmpty())
1007             result.append(&quot;, &quot;, listStyle);
1008         result.append(&#39;)&#39;);
1009 
1010         return result.toString();
1011     }
<a name="161" id="anc161"></a><span class="line-modified">1012     case CSS_RECT:</span>
1013         return rectValue()-&gt;cssText();
<a name="162" id="anc162"></a><span class="line-modified">1014     case CSS_QUAD:</span>
1015         return quadValue()-&gt;cssText();
<a name="163" id="anc163"></a><span class="line-modified">1016     case CSS_RGBCOLOR:</span>
1017         return color().cssText();
<a name="164" id="anc164"></a><span class="line-modified">1018     case CSS_PAIR:</span>
1019         return pairValue()-&gt;cssText();
<a name="165" id="anc165"></a><span class="line-modified">1020     case CSS_CALC:</span>
1021         return m_value.calc-&gt;cssText();
<a name="166" id="anc166"></a><span class="line-modified">1022     case CSS_SHAPE:</span>
1023         return m_value.shape-&gt;cssText();
<a name="167" id="anc167"></a><span class="line-modified">1024     case CSS_VW:</span>
1025         return formatNumberValue(&quot;vw&quot;);
<a name="168" id="anc168"></a><span class="line-modified">1026     case CSS_VH:</span>
1027         return formatNumberValue(&quot;vh&quot;);
<a name="169" id="anc169"></a><span class="line-modified">1028     case CSS_VMIN:</span>
1029         return formatNumberValue(&quot;vmin&quot;);
<a name="170" id="anc170"></a><span class="line-modified">1030     case CSS_VMAX:</span>
1031         return formatNumberValue(&quot;vmax&quot;);
<a name="171" id="anc171"></a>




1032     }
1033     return String();
1034 }
1035 
1036 String CSSPrimitiveValue::customCSSText() const
1037 {
1038     // FIXME: return the original value instead of a generated one (e.g. color
1039     // name if it was specified) - check what spec says about this
1040 
1041     CSSTextCache&amp; cssTextCache = WebCore::cssTextCache();
1042 
1043     if (m_hasCachedCSSText) {
1044         ASSERT(cssTextCache.contains(this));
1045         return cssTextCache.get(this);
1046     }
1047 
1048     String text = formatNumberForCustomCSSText();
1049 
1050     ASSERT(!cssTextCache.contains(this));
1051     m_hasCachedCSSText = true;
1052     cssTextCache.set(this, text);
1053     return text;
1054 }
1055 
1056 bool CSSPrimitiveValue::equals(const CSSPrimitiveValue&amp; other) const
1057 {
<a name="172" id="anc172"></a><span class="line-modified">1058     if (m_primitiveUnitType != other.m_primitiveUnitType)</span>
1059         return false;
1060 
<a name="173" id="anc173"></a><span class="line-modified">1061     switch (m_primitiveUnitType) {</span>
<span class="line-modified">1062     case CSS_UNKNOWN:</span>
1063         return false;
<a name="174" id="anc174"></a><span class="line-modified">1064     case CSS_NUMBER:</span>
<span class="line-modified">1065     case CSS_PERCENTAGE:</span>
<span class="line-modified">1066     case CSS_EMS:</span>
<span class="line-modified">1067     case CSS_QUIRKY_EMS:</span>
<span class="line-modified">1068     case CSS_EXS:</span>
<span class="line-modified">1069     case CSS_REMS:</span>
<span class="line-modified">1070     case CSS_PX:</span>
<span class="line-modified">1071     case CSS_CM:</span>
<span class="line-modified">1072 #if ENABLE(CSS_IMAGE_RESOLUTION) || ENABLE(RESOLUTION_MEDIA_QUERY)</span>
<span class="line-modified">1073     case CSS_DPPX:</span>
<span class="line-modified">1074     case CSS_DPI:</span>
<span class="line-modified">1075     case CSS_DPCM:</span>
<span class="line-modified">1076 #endif</span>
<span class="line-modified">1077     case CSS_MM:</span>
<span class="line-modified">1078     case CSS_IN:</span>
<span class="line-modified">1079     case CSS_PT:</span>
<span class="line-modified">1080     case CSS_PC:</span>
<span class="line-modified">1081     case CSS_DEG:</span>
<span class="line-modified">1082     case CSS_RAD:</span>
<span class="line-modified">1083     case CSS_GRAD:</span>
<span class="line-modified">1084     case CSS_MS:</span>
<span class="line-modified">1085     case CSS_S:</span>
<span class="line-modified">1086     case CSS_HZ:</span>
<span class="line-modified">1087     case CSS_KHZ:</span>
<span class="line-modified">1088     case CSS_TURN:</span>
<span class="line-modified">1089     case CSS_VW:</span>
<span class="line-modified">1090     case CSS_VH:</span>
<span class="line-modified">1091     case CSS_VMIN:</span>
<span class="line-modified">1092     case CSS_FR:</span>

1093         return m_value.num == other.m_value.num;
<a name="175" id="anc175"></a><span class="line-modified">1094     case CSS_PROPERTY_ID:</span>
1095         return propertyName(m_value.propertyID) == propertyName(other.m_value.propertyID);
<a name="176" id="anc176"></a><span class="line-modified">1096     case CSS_VALUE_ID:</span>
1097         return valueName(m_value.valueID) == valueName(other.m_value.valueID);
<a name="177" id="anc177"></a><span class="line-modified">1098     case CSS_DIMENSION:</span>
<span class="line-modified">1099     case CSS_STRING:</span>
<span class="line-modified">1100     case CSS_URI:</span>
<span class="line-modified">1101     case CSS_ATTR:</span>
<span class="line-modified">1102     case CSS_COUNTER_NAME:</span>
1103         return equal(m_value.string, other.m_value.string);
<a name="178" id="anc178"></a><span class="line-modified">1104     case CSS_COUNTER:</span>
1105         return m_value.counter &amp;&amp; other.m_value.counter &amp;&amp; m_value.counter-&gt;equals(*other.m_value.counter);
<a name="179" id="anc179"></a><span class="line-modified">1106     case CSS_RECT:</span>
1107         return m_value.rect &amp;&amp; other.m_value.rect &amp;&amp; m_value.rect-&gt;equals(*other.m_value.rect);
<a name="180" id="anc180"></a><span class="line-modified">1108     case CSS_QUAD:</span>
1109         return m_value.quad &amp;&amp; other.m_value.quad &amp;&amp; m_value.quad-&gt;equals(*other.m_value.quad);
<a name="181" id="anc181"></a><span class="line-modified">1110     case CSS_RGBCOLOR:</span>
1111         return color() == other.color();
<a name="182" id="anc182"></a><span class="line-modified">1112     case CSS_PAIR:</span>
1113         return m_value.pair &amp;&amp; other.m_value.pair &amp;&amp; m_value.pair-&gt;equals(*other.m_value.pair);
<a name="183" id="anc183"></a><span class="line-modified">1114     case CSS_CALC:</span>
1115         return m_value.calc &amp;&amp; other.m_value.calc &amp;&amp; m_value.calc-&gt;equals(*other.m_value.calc);
<a name="184" id="anc184"></a><span class="line-modified">1116     case CSS_SHAPE:</span>
1117         return m_value.shape &amp;&amp; other.m_value.shape &amp;&amp; m_value.shape-&gt;equals(*other.m_value.shape);
<a name="185" id="anc185"></a><span class="line-modified">1118     case CSS_FONT_FAMILY:</span>
1119         return fontFamily() == other.fontFamily();
<a name="186" id="anc186"></a>






1120     }
1121     return false;
1122 }
1123 
1124 Ref&lt;DeprecatedCSSOMPrimitiveValue&gt; CSSPrimitiveValue::createDeprecatedCSSOMPrimitiveWrapper(CSSStyleDeclaration&amp; styleDeclaration) const
1125 {
1126     return DeprecatedCSSOMPrimitiveValue::create(*this, styleDeclaration);
1127 }
1128 
1129 // https://drafts.css-houdini.org/css-properties-values-api/#dependency-cycles-via-relative-units
1130 void CSSPrimitiveValue::collectDirectComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
1131 {
<a name="187" id="anc187"></a><span class="line-modified">1132     switch (m_primitiveUnitType) {</span>
<span class="line-modified">1133     case CSS_EMS:</span>
<span class="line-modified">1134     case CSS_QUIRKY_EMS:</span>
<span class="line-modified">1135     case CSS_EXS:</span>
<span class="line-modified">1136     case CSS_CHS:</span>
1137         values.add(CSSPropertyFontSize);
1138         break;
<a name="188" id="anc188"></a><span class="line-modified">1139     case CSS_CALC:</span>
1140         m_value.calc-&gt;collectDirectComputationalDependencies(values);
1141         break;
<a name="189" id="anc189"></a>

1142     }
1143 }
1144 
1145 void CSSPrimitiveValue::collectDirectRootComputationalDependencies(HashSet&lt;CSSPropertyID&gt;&amp; values) const
1146 {
<a name="190" id="anc190"></a><span class="line-modified">1147     switch (m_primitiveUnitType) {</span>
<span class="line-modified">1148     case CSS_REMS:</span>
1149         values.add(CSSPropertyFontSize);
1150         break;
<a name="191" id="anc191"></a><span class="line-modified">1151     case CSS_CALC:</span>
1152         m_value.calc-&gt;collectDirectRootComputationalDependencies(values);
1153         break;
<a name="192" id="anc192"></a>

1154     }
1155 }
1156 
1157 } // namespace WebCore
<a name="193" id="anc193"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="193" type="hidden" />
</body>
</html>