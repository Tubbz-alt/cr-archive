<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/loader/ProgressTracker.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PolicyChecker.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ProgressTracker.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/ProgressTracker.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 75,20 ***</span>
      long long estimatedLength;
  };
  
  unsigned long ProgressTracker::s_uniqueIdentifier = 0;
  
<span class="line-modified">! ProgressTracker::ProgressTracker(ProgressTrackerClient&amp; client)</span>
<span class="line-modified">!     : m_client(client)</span>
      , m_progressHeartbeatTimer(*this, &amp;ProgressTracker::progressHeartbeatTimerFired)
  {
  }
  
<span class="line-modified">! ProgressTracker::~ProgressTracker()</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     m_client.progressTrackerDestroyed();</span>
<span class="line-removed">- }</span>
  
  double ProgressTracker::estimatedProgress() const
  {
      return m_progressValue;
  }
<span class="line-new-header">--- 75,17 ---</span>
      long long estimatedLength;
  };
  
  unsigned long ProgressTracker::s_uniqueIdentifier = 0;
  
<span class="line-modified">! ProgressTracker::ProgressTracker(UniqueRef&lt;ProgressTrackerClient&gt;&amp;&amp; client)</span>
<span class="line-modified">!     : m_client(WTFMove(client))</span>
      , m_progressHeartbeatTimer(*this, &amp;ProgressTracker::progressHeartbeatTimerFired)
  {
  }
  
<span class="line-modified">! ProgressTracker::~ProgressTracker() = default;</span>
  
  double ProgressTracker::estimatedProgress() const
  {
      return m_progressValue;
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 115,11 ***</span>
  
  void ProgressTracker::progressStarted(Frame&amp; frame)
  {
      LOG(Progress, &quot;Progress started (%p) - frame %p(\&quot;%s\&quot;), value %f, tracked frames %d, originating frame %p&quot;, this, &amp;frame, frame.tree().uniqueName().string().utf8().data(), m_progressValue, m_numProgressTrackedFrames, m_originatingProgressFrame.get());
  
<span class="line-modified">!     m_client.willChangeEstimatedProgress();</span>
  
      if (!m_numProgressTrackedFrames || m_originatingProgressFrame == &amp;frame) {
          reset();
          m_progressValue = initialProgressValue;
          m_originatingProgressFrame = &amp;frame;
<span class="line-new-header">--- 112,11 ---</span>
  
  void ProgressTracker::progressStarted(Frame&amp; frame)
  {
      LOG(Progress, &quot;Progress started (%p) - frame %p(\&quot;%s\&quot;), value %f, tracked frames %d, originating frame %p&quot;, this, &amp;frame, frame.tree().uniqueName().string().utf8().data(), m_progressValue, m_numProgressTrackedFrames, m_originatingProgressFrame.get());
  
<span class="line-modified">!     m_client-&gt;willChangeEstimatedProgress();</span>
  
      if (!m_numProgressTrackedFrames || m_originatingProgressFrame == &amp;frame) {
          reset();
          m_progressValue = initialProgressValue;
          m_originatingProgressFrame = &amp;frame;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 131,17 ***</span>
          auto elapsedTimeSinceMainLoadComplete = MonotonicTime::now() - m_mainLoadCompletionTime;
  
          static const auto subframePartOfMainLoadThreshold = 1_s;
          m_isMainLoad = isMainFrame || elapsedTimeSinceMainLoadComplete &lt; subframePartOfMainLoadThreshold;
  
<span class="line-modified">!         m_client.progressStarted(*m_originatingProgressFrame);</span>
      }
      m_numProgressTrackedFrames++;
  
      RELEASE_LOG_IF_ALLOWED(&quot;progressStarted: frame %p, value %f, tracked frames %d, originating frame %p, isMainLoad %d&quot;, &amp;frame, m_progressValue, m_numProgressTrackedFrames, m_originatingProgressFrame.get(), m_isMainLoad);
  
<span class="line-modified">!     m_client.didChangeEstimatedProgress();</span>
      InspectorInstrumentation::frameStartedLoading(frame);
  }
  
  void ProgressTracker::progressCompleted(Frame&amp; frame)
  {
<span class="line-new-header">--- 128,17 ---</span>
          auto elapsedTimeSinceMainLoadComplete = MonotonicTime::now() - m_mainLoadCompletionTime;
  
          static const auto subframePartOfMainLoadThreshold = 1_s;
          m_isMainLoad = isMainFrame || elapsedTimeSinceMainLoadComplete &lt; subframePartOfMainLoadThreshold;
  
<span class="line-modified">!         m_client-&gt;progressStarted(*m_originatingProgressFrame);</span>
      }
      m_numProgressTrackedFrames++;
  
      RELEASE_LOG_IF_ALLOWED(&quot;progressStarted: frame %p, value %f, tracked frames %d, originating frame %p, isMainLoad %d&quot;, &amp;frame, m_progressValue, m_numProgressTrackedFrames, m_originatingProgressFrame.get(), m_isMainLoad);
  
<span class="line-modified">!     m_client-&gt;didChangeEstimatedProgress();</span>
      InspectorInstrumentation::frameStartedLoading(frame);
  }
  
  void ProgressTracker::progressCompleted(Frame&amp; frame)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 149,17 ***</span>
      RELEASE_LOG_IF_ALLOWED(&quot;progressCompleted: frame %p, value %f, tracked frames %d, originating frame %p, isMainLoad %d&quot;, &amp;frame, m_progressValue, m_numProgressTrackedFrames, m_originatingProgressFrame.get(), m_isMainLoad);
  
      if (m_numProgressTrackedFrames &lt;= 0)
          return;
  
<span class="line-modified">!     m_client.willChangeEstimatedProgress();</span>
  
      m_numProgressTrackedFrames--;
      if (!m_numProgressTrackedFrames || m_originatingProgressFrame == &amp;frame)
          finalProgressComplete();
  
<span class="line-modified">!     m_client.didChangeEstimatedProgress();</span>
  }
  
  void ProgressTracker::finalProgressComplete()
  {
      LOG(Progress, &quot;Final progress complete (%p)&quot;, this);
<span class="line-new-header">--- 146,17 ---</span>
      RELEASE_LOG_IF_ALLOWED(&quot;progressCompleted: frame %p, value %f, tracked frames %d, originating frame %p, isMainLoad %d&quot;, &amp;frame, m_progressValue, m_numProgressTrackedFrames, m_originatingProgressFrame.get(), m_isMainLoad);
  
      if (m_numProgressTrackedFrames &lt;= 0)
          return;
  
<span class="line-modified">!     m_client-&gt;willChangeEstimatedProgress();</span>
  
      m_numProgressTrackedFrames--;
      if (!m_numProgressTrackedFrames || m_originatingProgressFrame == &amp;frame)
          finalProgressComplete();
  
<span class="line-modified">!     m_client-&gt;didChangeEstimatedProgress();</span>
  }
  
  void ProgressTracker::finalProgressComplete()
  {
      LOG(Progress, &quot;Final progress complete (%p)&quot;, this);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 169,20 ***</span>
  
      // Before resetting progress value be sure to send client a least one notification
      // with final progress value.
      if (!m_finalProgressChangedSent) {
          m_progressValue = 1;
<span class="line-modified">!         m_client.progressEstimateChanged(*frame);</span>
      }
  
      reset();
  
      if (m_isMainLoad)
          m_mainLoadCompletionTime = MonotonicTime::now();
  
      frame-&gt;loader().client().setMainFrameDocumentReady(true);
<span class="line-modified">!     m_client.progressFinished(*frame);</span>
      frame-&gt;loader().loadProgressingStatusChanged();
  
      InspectorInstrumentation::frameStoppedLoading(*frame);
  }
  
<span class="line-new-header">--- 166,20 ---</span>
  
      // Before resetting progress value be sure to send client a least one notification
      // with final progress value.
      if (!m_finalProgressChangedSent) {
          m_progressValue = 1;
<span class="line-modified">!         m_client-&gt;progressEstimateChanged(*frame);</span>
      }
  
      reset();
  
      if (m_isMainLoad)
          m_mainLoadCompletionTime = MonotonicTime::now();
  
      frame-&gt;loader().client().setMainFrameDocumentReady(true);
<span class="line-modified">!     m_client-&gt;progressFinished(*frame);</span>
      frame-&gt;loader().loadProgressingStatusChanged();
  
      InspectorInstrumentation::frameStoppedLoading(*frame);
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 217,11 ***</span>
      if (!item)
          return;
  
      RefPtr&lt;Frame&gt; frame = m_originatingProgressFrame;
  
<span class="line-modified">!     m_client.willChangeEstimatedProgress();</span>
  
      double increment, percentOfRemainingBytes;
      long long remainingBytes, estimatedBytesForPendingRequests;
  
      item-&gt;bytesReceived += bytesReceived;
<span class="line-new-header">--- 214,11 ---</span>
      if (!item)
          return;
  
      RefPtr&lt;Frame&gt; frame = m_originatingProgressFrame;
  
<span class="line-modified">!     m_client-&gt;willChangeEstimatedProgress();</span>
  
      double increment, percentOfRemainingBytes;
      long long remainingBytes, estimatedBytesForPendingRequests;
  
      item-&gt;bytesReceived += bytesReceived;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 257,18 ***</span>
      if ((notifiedProgressTimeDelta &gt;= progressNotificationTimeInterval || m_progressValue == 1) &amp;&amp; m_numProgressTrackedFrames &gt; 0) {
          if (!m_finalProgressChangedSent) {
              if (m_progressValue == 1)
                  m_finalProgressChangedSent = true;
  
<span class="line-modified">!             m_client.progressEstimateChanged(*frame);</span>
  
              m_lastNotifiedProgressValue = m_progressValue;
              m_lastNotifiedProgressTime = now;
          }
      }
  
<span class="line-modified">!     m_client.didChangeEstimatedProgress();</span>
  }
  
  void ProgressTracker::completeProgress(unsigned long identifier)
  {
      auto it = m_progressItems.find(identifier);
<span class="line-new-header">--- 254,18 ---</span>
      if ((notifiedProgressTimeDelta &gt;= progressNotificationTimeInterval || m_progressValue == 1) &amp;&amp; m_numProgressTrackedFrames &gt; 0) {
          if (!m_finalProgressChangedSent) {
              if (m_progressValue == 1)
                  m_finalProgressChangedSent = true;
  
<span class="line-modified">!             m_client-&gt;progressEstimateChanged(*frame);</span>
  
              m_lastNotifiedProgressValue = m_progressValue;
              m_lastNotifiedProgressTime = now;
          }
      }
  
<span class="line-modified">!     m_client-&gt;didChangeEstimatedProgress();</span>
  }
  
  void ProgressTracker::completeProgress(unsigned long identifier)
  {
      auto it = m_progressItems.find(identifier);
</pre>
<center><a href="PolicyChecker.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ProgressTracker.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>