<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/debugger/DebuggerCallFrame.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2008, 2013-2014, 2016 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  *
  8  * 1.  Redistributions of source code must retain the above copyright
  9  *     notice, this list of conditions and the following disclaimer.
 10  * 2.  Redistributions in binary form must reproduce the above copyright
 11  *     notice, this list of conditions and the following disclaimer in the
 12  *     documentation and/or other materials provided with the distribution.
 13  * 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
 14  *     its contributors may be used to endorse or promote products derived
 15  *     from this software without specific prior written permission.
 16  *
 17  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
 18  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 19  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 20  * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 21  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 22  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 23  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 24  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 25  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 26  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 27  */
 28 
 29 #include &quot;config.h&quot;
 30 #include &quot;DebuggerCallFrame.h&quot;
 31 
 32 #include &quot;CatchScope.h&quot;
 33 #include &quot;CodeBlock.h&quot;
 34 #include &quot;DebuggerEvalEnabler.h&quot;
 35 #include &quot;DebuggerScope.h&quot;
 36 #include &quot;Interpreter.h&quot;
 37 #include &quot;JSCInlines.h&quot;
 38 #include &quot;JSFunction.h&quot;
 39 #include &quot;JSLexicalEnvironment.h&quot;
 40 #include &quot;JSWithScope.h&quot;
 41 #include &quot;Parser.h&quot;
 42 #include &quot;ShadowChickenInlines.h&quot;
 43 #include &quot;StackVisitor.h&quot;
 44 #include &quot;StrongInlines.h&quot;
 45 
 46 namespace JSC {
 47 
 48 class LineAndColumnFunctor {
 49 public:
 50     StackVisitor::Status operator()(StackVisitor&amp; visitor) const
 51     {
 52         visitor-&gt;computeLineAndColumn(m_line, m_column);
 53         return StackVisitor::Done;
 54     }
 55 
 56     unsigned line() const { return m_line; }
 57     unsigned column() const { return m_column; }
 58 
 59 private:
 60     mutable unsigned m_line { 0 };
 61     mutable unsigned m_column { 0 };
 62 };
 63 
 64 Ref&lt;DebuggerCallFrame&gt; DebuggerCallFrame::create(VM&amp; vm, CallFrame* callFrame)
 65 {
<a name="1" id="anc1"></a><span class="line-modified"> 66     if (UNLIKELY(!callFrame)) {</span>
<span class="line-added"> 67         ShadowChicken::Frame emptyFrame;</span>
<span class="line-added"> 68         RELEASE_ASSERT(!emptyFrame.isTailDeleted);</span>
<span class="line-added"> 69         return adoptRef(*new DebuggerCallFrame(vm, callFrame, emptyFrame));</span>
<span class="line-added"> 70     }</span>
<span class="line-added"> 71 </span>
<span class="line-added"> 72     if (callFrame-&gt;isDeprecatedCallFrameForDebugger()) {</span>
 73         ShadowChicken::Frame emptyFrame;
 74         RELEASE_ASSERT(!emptyFrame.isTailDeleted);
 75         return adoptRef(*new DebuggerCallFrame(vm, callFrame, emptyFrame));
 76     }
 77 
 78     Vector&lt;ShadowChicken::Frame&gt; frames;
 79     vm.ensureShadowChicken();
 80     vm.shadowChicken()-&gt;iterate(vm, callFrame, [&amp;] (const ShadowChicken::Frame&amp; frame) -&gt; bool {
 81         frames.append(frame);
 82         return true;
 83     });
 84 
 85     RELEASE_ASSERT(frames.size());
 86     ASSERT(!frames[0].isTailDeleted); // The top frame should never be tail deleted.
 87 
 88     RefPtr&lt;DebuggerCallFrame&gt; currentParent = nullptr;
<a name="2" id="anc2"></a>
 89     // This walks the stack from the entry stack frame to the top of the stack.
 90     for (unsigned i = frames.size(); i--; ) {
 91         const ShadowChicken::Frame&amp; frame = frames[i];
 92         if (!frame.isTailDeleted)
<a name="3" id="anc3"></a><span class="line-modified"> 93             callFrame = frame.frame;</span>
<span class="line-modified"> 94         Ref&lt;DebuggerCallFrame&gt; currentFrame = adoptRef(*new DebuggerCallFrame(vm, callFrame, frame));</span>
 95         currentFrame-&gt;m_caller = currentParent;
 96         currentParent = WTFMove(currentFrame);
 97     }
 98     return *currentParent;
 99 }
100 
101 DebuggerCallFrame::DebuggerCallFrame(VM&amp; vm, CallFrame* callFrame, const ShadowChicken::Frame&amp; frame)
102     : m_validMachineFrame(callFrame)
103     , m_shadowChickenFrame(frame)
104 {
105     m_position = currentPosition(vm);
106 }
107 
108 RefPtr&lt;DebuggerCallFrame&gt; DebuggerCallFrame::callerFrame()
109 {
110     ASSERT(isValid());
111     if (!isValid())
112         return nullptr;
113 
114     return m_caller;
115 }
116 
<a name="4" id="anc4"></a><span class="line-modified">117 JSGlobalObject* DebuggerCallFrame::globalObject()</span>
118 {
<a name="5" id="anc5"></a><span class="line-modified">119     return scope()-&gt;globalObject();</span>
120 }
121 
<a name="6" id="anc6"></a><span class="line-modified">122 JSC::JSGlobalObject* DebuggerCallFrame::deprecatedVMEntryGlobalObject() const</span>
123 {
124     ASSERT(isValid());
125     if (!isValid())
126         return nullptr;
<a name="7" id="anc7"></a><span class="line-modified">127     VM&amp; vm = m_validMachineFrame-&gt;deprecatedVM();</span>
<span class="line-modified">128     return vm.deprecatedVMEntryGlobalObject(m_validMachineFrame-&gt;lexicalGlobalObject(vm));</span>
129 }
130 
131 SourceID DebuggerCallFrame::sourceID() const
132 {
133     ASSERT(isValid());
134     if (!isValid())
135         return noSourceID;
136     if (isTailDeleted())
137         return m_shadowChickenFrame.codeBlock-&gt;ownerExecutable()-&gt;sourceID();
138     return sourceIDForCallFrame(m_validMachineFrame);
139 }
140 
141 String DebuggerCallFrame::functionName() const
142 {
143     ASSERT(isValid());
144     if (!isValid())
145         return String();
146 
<a name="8" id="anc8"></a><span class="line-modified">147     VM&amp; vm = m_validMachineFrame-&gt;deprecatedVM();</span>
148     if (isTailDeleted()) {
149         if (JSFunction* func = jsDynamicCast&lt;JSFunction*&gt;(vm, m_shadowChickenFrame.callee))
150             return func-&gt;calculatedDisplayName(vm);
151         return m_shadowChickenFrame.codeBlock-&gt;inferredName().data();
152     }
153 
154     return m_validMachineFrame-&gt;friendlyFunctionName();
155 }
156 
157 DebuggerScope* DebuggerCallFrame::scope()
158 {
159     ASSERT(isValid());
160     if (!isValid())
161         return nullptr;
162 
163     if (!m_scope) {
<a name="9" id="anc9"></a><span class="line-modified">164         VM&amp; vm = m_validMachineFrame-&gt;deprecatedVM();</span>
165         JSScope* scope;
166         CodeBlock* codeBlock = m_validMachineFrame-&gt;codeBlock();
167         if (isTailDeleted())
168             scope = m_shadowChickenFrame.scope;
169         else if (codeBlock &amp;&amp; codeBlock-&gt;scopeRegister().isValid())
170             scope = m_validMachineFrame-&gt;scope(codeBlock-&gt;scopeRegister().offset());
171         else if (JSCallee* callee = jsDynamicCast&lt;JSCallee*&gt;(vm, m_validMachineFrame-&gt;jsCallee()))
172             scope = callee-&gt;scope();
173         else
<a name="10" id="anc10"></a><span class="line-modified">174             scope = m_validMachineFrame-&gt;lexicalGlobalObject(vm)-&gt;globalLexicalEnvironment();</span>
175 
176         m_scope.set(vm, DebuggerScope::create(vm, scope));
177     }
178     return m_scope.get();
179 }
180 
181 DebuggerCallFrame::Type DebuggerCallFrame::type() const
182 {
183     ASSERT(isValid());
184     if (!isValid())
185         return ProgramType;
186 
187     if (isTailDeleted())
188         return FunctionType;
189 
<a name="11" id="anc11"></a><span class="line-modified">190     if (jsDynamicCast&lt;JSFunction*&gt;(m_validMachineFrame-&gt;deprecatedVM(), m_validMachineFrame-&gt;jsCallee()))</span>
191         return FunctionType;
192 
193     return ProgramType;
194 }
195 
<a name="12" id="anc12"></a><span class="line-modified">196 JSValue DebuggerCallFrame::thisValue(VM&amp; vm) const</span>
197 {
198     ASSERT(isValid());
199     if (!isValid())
200         return jsUndefined();
201 
202     CodeBlock* codeBlock = nullptr;
203     JSValue thisValue;
204     if (isTailDeleted()) {
205         thisValue = m_shadowChickenFrame.thisValue;
206         codeBlock = m_shadowChickenFrame.codeBlock;
207     } else {
208         thisValue = m_validMachineFrame-&gt;thisValue();
209         codeBlock = m_validMachineFrame-&gt;codeBlock();
210     }
211 
212     if (!thisValue)
213         return jsUndefined();
214 
215     ECMAMode ecmaMode = NotStrictMode;
216     if (codeBlock &amp;&amp; codeBlock-&gt;isStrictMode())
217         ecmaMode = StrictMode;
<a name="13" id="anc13"></a><span class="line-modified">218     return thisValue.toThis(m_validMachineFrame-&gt;lexicalGlobalObject(vm), ecmaMode);</span>
219 }
220 
221 // Evaluate some JavaScript code in the scope of this frame.
222 JSValue DebuggerCallFrame::evaluateWithScopeExtension(const String&amp; script, JSObject* scopeExtensionObject, NakedPtr&lt;Exception&gt;&amp; exception)
223 {
224     ASSERT(isValid());
225     CallFrame* callFrame = m_validMachineFrame;
226     if (!callFrame)
227         return jsUndefined();
228 
<a name="14" id="anc14"></a><span class="line-modified">229     VM&amp; vm = callFrame-&gt;deprecatedVM();</span>
230     JSLockHolder lock(vm);
231     auto catchScope = DECLARE_CATCH_SCOPE(vm);
232 
233     CodeBlock* codeBlock = nullptr;
234     if (isTailDeleted())
235         codeBlock = m_shadowChickenFrame.codeBlock;
236     else
237         codeBlock = callFrame-&gt;codeBlock();
238     if (!codeBlock)
239         return jsUndefined();
240 
<a name="15" id="anc15"></a><span class="line-modified">241     JSGlobalObject* globalObject = codeBlock-&gt;globalObject();</span>
<span class="line-added">242     DebuggerEvalEnabler evalEnabler(globalObject, DebuggerEvalEnabler::Mode::EvalOnGlobalObjectAtDebuggerEntry);</span>
243 
244     EvalContextType evalContextType;
245 
246     if (isFunctionParseMode(codeBlock-&gt;unlinkedCodeBlock()-&gt;parseMode()))
247         evalContextType = EvalContextType::FunctionEvalContext;
248     else if (codeBlock-&gt;unlinkedCodeBlock()-&gt;codeType() == EvalCode)
249         evalContextType = codeBlock-&gt;unlinkedCodeBlock()-&gt;evalContextType();
250     else
251         evalContextType = EvalContextType::None;
252 
253     VariableEnvironment variablesUnderTDZ;
254     JSScope::collectClosureVariablesUnderTDZ(scope()-&gt;jsScope(), variablesUnderTDZ);
255 
<a name="16" id="anc16"></a><span class="line-modified">256     auto* eval = DirectEvalExecutable::create(globalObject, makeSource(script, callFrame-&gt;callerSourceOrigin(vm)), codeBlock-&gt;isStrictMode(), codeBlock-&gt;unlinkedCodeBlock()-&gt;derivedContextType(), codeBlock-&gt;unlinkedCodeBlock()-&gt;needsClassFieldInitializer(), codeBlock-&gt;unlinkedCodeBlock()-&gt;isArrowFunction(), evalContextType, &amp;variablesUnderTDZ);</span>
257     if (UNLIKELY(catchScope.exception())) {
258         exception = catchScope.exception();
259         catchScope.clearException();
260         return jsUndefined();
261     }
262 
<a name="17" id="anc17"></a>
263     if (scopeExtensionObject) {
264         JSScope* ignoredPreviousScope = globalObject-&gt;globalScope();
265         globalObject-&gt;setGlobalScopeExtension(JSWithScope::create(vm, globalObject, ignoredPreviousScope, scopeExtensionObject));
266     }
267 
<a name="18" id="anc18"></a><span class="line-modified">268     JSValue thisValue = this-&gt;thisValue(vm);</span>
<span class="line-modified">269     JSValue result = vm.interpreter-&gt;execute(eval, globalObject, thisValue, scope()-&gt;jsScope());</span>
270     if (UNLIKELY(catchScope.exception())) {
271         exception = catchScope.exception();
272         catchScope.clearException();
273     }
274 
275     if (scopeExtensionObject)
276         globalObject-&gt;clearGlobalScopeExtension();
277 
278     ASSERT(result);
279     return result;
280 }
281 
282 void DebuggerCallFrame::invalidate()
283 {
284     RefPtr&lt;DebuggerCallFrame&gt; frame = this;
285     while (frame) {
286         frame-&gt;m_validMachineFrame = nullptr;
287         if (frame-&gt;m_scope) {
288             frame-&gt;m_scope-&gt;invalidateChain();
289             frame-&gt;m_scope.clear();
290         }
291         frame = WTFMove(frame-&gt;m_caller);
292     }
293 }
294 
295 TextPosition DebuggerCallFrame::currentPosition(VM&amp; vm)
296 {
297     if (!m_validMachineFrame)
298         return TextPosition();
299 
300     if (isTailDeleted()) {
301         CodeBlock* codeBlock = m_shadowChickenFrame.codeBlock;
<a name="19" id="anc19"></a><span class="line-modified">302         if (Optional&lt;BytecodeIndex&gt; bytecodeIndex = codeBlock-&gt;bytecodeIndexFromCallSiteIndex(m_shadowChickenFrame.callSiteIndex)) {</span>
<span class="line-modified">303             return TextPosition(OrdinalNumber::fromOneBasedInt(codeBlock-&gt;lineNumberForBytecodeIndex(*bytecodeIndex)),</span>
<span class="line-modified">304                 OrdinalNumber::fromOneBasedInt(codeBlock-&gt;columnNumberForBytecodeIndex(*bytecodeIndex)));</span>
305         }
306     }
307 
308     return positionForCallFrame(vm, m_validMachineFrame);
309 }
310 
311 TextPosition DebuggerCallFrame::positionForCallFrame(VM&amp; vm, CallFrame* callFrame)
312 {
313     LineAndColumnFunctor functor;
<a name="20" id="anc20"></a><span class="line-modified">314     StackVisitor::visit(callFrame, vm, functor);</span>
315     return TextPosition(OrdinalNumber::fromOneBasedInt(functor.line()), OrdinalNumber::fromOneBasedInt(functor.column()));
316 }
317 
318 SourceID DebuggerCallFrame::sourceIDForCallFrame(CallFrame* callFrame)
319 {
<a name="21" id="anc21"></a><span class="line-modified">320     if (!callFrame)</span>
<span class="line-added">321         return noSourceID;</span>
322     CodeBlock* codeBlock = callFrame-&gt;codeBlock();
<a name="22" id="anc22"></a><span class="line-modified">323     if (!codeBlock || callFrame-&gt;callee().isWasm())</span>
324         return noSourceID;
325     return codeBlock-&gt;ownerExecutable()-&gt;sourceID();
326 }
327 
328 } // namespace JSC
<a name="23" id="anc23"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="23" type="hidden" />
</body>
</html>