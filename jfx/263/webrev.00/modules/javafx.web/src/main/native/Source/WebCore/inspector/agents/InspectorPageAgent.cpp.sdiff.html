<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/InspectorPageAgent.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InspectorNetworkAgent.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="InspectorPageAgent.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/InspectorPageAgent.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 20  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 21  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 22  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 23  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 24  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 25  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 26  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 27  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 28  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 29  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 30  */
 31 
 32 #include &quot;config.h&quot;
 33 #include &quot;InspectorPageAgent.h&quot;
 34 
 35 #include &quot;CachedResource.h&quot;
 36 #include &quot;CachedResourceLoader.h&quot;
 37 #include &quot;Cookie.h&quot;
 38 #include &quot;CookieJar.h&quot;
 39 #include &quot;CustomHeaderFields.h&quot;

 40 #include &quot;Document.h&quot;
 41 #include &quot;DocumentLoader.h&quot;
 42 #include &quot;Frame.h&quot;
 43 #include &quot;FrameLoadRequest.h&quot;
 44 #include &quot;FrameLoader.h&quot;
 45 #include &quot;FrameSnapshotting.h&quot;
 46 #include &quot;FrameView.h&quot;
 47 #include &quot;HTMLFrameOwnerElement.h&quot;
 48 #include &quot;HTMLNames.h&quot;
 49 #include &quot;ImageBuffer.h&quot;
 50 #include &quot;InspectorClient.h&quot;
 51 #include &quot;InspectorDOMAgent.h&quot;
 52 #include &quot;InspectorNetworkAgent.h&quot;
 53 #include &quot;InspectorOverlay.h&quot;
 54 #include &quot;InstrumentingAgents.h&quot;
 55 #include &quot;MIMETypeRegistry.h&quot;
 56 #include &quot;MemoryCache.h&quot;
 57 #include &quot;Page.h&quot;
 58 #include &quot;RenderObject.h&quot;
 59 #include &quot;RenderTheme.h&quot;
 60 #include &quot;ScriptController.h&quot;

 61 #include &quot;SecurityOrigin.h&quot;
 62 #include &quot;Settings.h&quot;
 63 #include &quot;StyleScope.h&quot;
 64 #include &quot;TextEncoding.h&quot;
 65 #include &quot;UserGestureIndicator.h&quot;
 66 #include &lt;JavaScriptCore/ContentSearchUtilities.h&gt;
 67 #include &lt;JavaScriptCore/IdentifiersFactory.h&gt;
 68 #include &lt;JavaScriptCore/RegularExpression.h&gt;
 69 #include &lt;wtf/ListHashSet.h&gt;
 70 #include &lt;wtf/Stopwatch.h&gt;
 71 #include &lt;wtf/text/Base64.h&gt;
 72 #include &lt;wtf/text/StringBuilder.h&gt;
 73 
 74 #if ENABLE(APPLICATION_MANIFEST)
 75 #include &quot;CachedApplicationManifest.h&quot;
 76 #endif
 77 
 78 #if ENABLE(WEB_ARCHIVE) &amp;&amp; USE(CF)
 79 #include &quot;LegacyWebArchive.h&quot;
 80 #endif
 81 
 82 
 83 namespace WebCore {
 84 
 85 using namespace Inspector;
 86 
 87 // Keep this in sync with Page.Setting
 88 #define FOR_EACH_INSPECTOR_OVERRIDE_SETTING(macro) \
 89     macro(AuthorAndUserStylesEnabled) \
 90     macro(ICECandidateFilteringEnabled) \
 91     macro(ImagesEnabled) \
 92     macro(MediaCaptureRequiresSecureConnection) \
 93     macro(MockCaptureDevicesEnabled) \
 94     macro(NeedsSiteSpecificQuirks) \
 95     macro(ScriptEnabled) \


 96     macro(WebRTCEncryptionEnabled) \
 97     macro(WebSecurityEnabled)
 98 
 99 static bool decodeBuffer(const char* buffer, unsigned size, const String&amp; textEncodingName, String* result)
100 {
101     if (buffer) {
102         TextEncoding encoding(textEncodingName);
103         if (!encoding.isValid())
104             encoding = WindowsLatin1Encoding();
105         *result = encoding.decode(buffer, size);
106         return true;
107     }
108     return false;
109 }
110 
111 bool InspectorPageAgent::mainResourceContent(Frame* frame, bool withBase64Encode, String* result)
112 {
113     RefPtr&lt;SharedBuffer&gt; buffer = frame-&gt;loader().documentLoader()-&gt;mainResourceData();
114     if (!buffer)
115         return false;
</pre>
<hr />
<pre>
564             if (auto* page = document-&gt;page())
565                 page-&gt;cookieJar().deleteCookie(*document, parsedURL, cookieName);
566         }
567     }
568 }
569 
570 void InspectorPageAgent::getResourceTree(ErrorString&amp;, RefPtr&lt;Inspector::Protocol::Page::FrameResourceTree&gt;&amp; object)
571 {
572     object = buildObjectForFrameTree(&amp;m_inspectedPage.mainFrame());
573 }
574 
575 void InspectorPageAgent::getResourceContent(ErrorString&amp; errorString, const String&amp; frameId, const String&amp; url, String* content, bool* base64Encoded)
576 {
577     Frame* frame = assertFrame(errorString, frameId);
578     if (!frame)
579         return;
580 
581     resourceContent(errorString, frame, URL({ }, url), content, base64Encoded);
582 }
583 





584 void InspectorPageAgent::searchInResource(ErrorString&amp; errorString, const String&amp; frameId, const String&amp; url, const String&amp; query, const bool* optionalCaseSensitive, const bool* optionalIsRegex, const String* optionalRequestId, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::GenericTypes::SearchMatch&gt;&gt;&amp; results)
585 {
586     results = JSON::ArrayOf&lt;Inspector::Protocol::GenericTypes::SearchMatch&gt;::create();
587 
588     bool isRegex = optionalIsRegex ? *optionalIsRegex : false;
589     bool caseSensitive = optionalCaseSensitive ? *optionalCaseSensitive : false;
590 
591     if (optionalRequestId) {
592         if (InspectorNetworkAgent* networkAgent = m_instrumentingAgents.inspectorNetworkAgent()) {
593             networkAgent-&gt;searchInRequest(errorString, *optionalRequestId, query, caseSensitive, isRegex, results);
594             return;
595         }
596     }
597 
598     Frame* frame = assertFrame(errorString, frameId);
599     if (!frame)
600         return;
601 
602     DocumentLoader* loader = assertDocumentLoader(errorString, frame);
603     if (!loader)
</pre>
<hr />
<pre>
621 
622     if (!success)
623         return;
624 
625     results = ContentSearchUtilities::searchInTextByLines(content, query, caseSensitive, isRegex);
626 }
627 
628 static Ref&lt;Inspector::Protocol::Page::SearchResult&gt; buildObjectForSearchResult(const String&amp; frameId, const String&amp; url, int matchesCount)
629 {
630     return Inspector::Protocol::Page::SearchResult::create()
631         .setUrl(url)
632         .setFrameId(frameId)
633         .setMatchesCount(matchesCount)
634         .release();
635 }
636 
637 void InspectorPageAgent::searchInResources(ErrorString&amp;, const String&amp; text, const bool* optionalCaseSensitive, const bool* optionalIsRegex, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::Page::SearchResult&gt;&gt;&amp; result)
638 {
639     result = JSON::ArrayOf&lt;Inspector::Protocol::Page::SearchResult&gt;::create();
640 
<span class="line-removed">641     bool isRegex = optionalIsRegex ? *optionalIsRegex : false;</span>
642     bool caseSensitive = optionalCaseSensitive ? *optionalCaseSensitive : false;
<span class="line-modified">643     JSC::Yarr::RegularExpression regex = ContentSearchUtilities::createSearchRegex(text, caseSensitive, isRegex);</span>



644 
645     for (Frame* frame = &amp;m_inspectedPage.mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {
646         for (auto* cachedResource : cachedResourcesForFrame(frame)) {
647             if (auto textContent = InspectorNetworkAgent::textContentForCachedResource(*cachedResource)) {
648                 int matchesCount = ContentSearchUtilities::countRegularExpressionMatches(regex, *textContent);
649                 if (matchesCount)
650                     result-&gt;addItem(buildObjectForSearchResult(frameId(frame), cachedResource-&gt;url(), matchesCount));
651             }
652         }
653     }
654 
655     if (InspectorNetworkAgent* networkAgent = m_instrumentingAgents.inspectorNetworkAgent())
656         networkAgent-&gt;searchOtherRequests(regex, result);
657 }
658 
659 void InspectorPageAgent::setShowRulers(ErrorString&amp;, bool showRulers)
660 {
661     m_overlay-&gt;setShowRulers(showRulers);
662 }
663 
</pre>
<hr />
<pre>
743 void InspectorPageAgent::frameStoppedLoading(Frame&amp; frame)
744 {
745     m_frontendDispatcher-&gt;frameStoppedLoading(frameId(&amp;frame));
746 }
747 
748 void InspectorPageAgent::frameScheduledNavigation(Frame&amp; frame, Seconds delay)
749 {
750     m_frontendDispatcher-&gt;frameScheduledNavigation(frameId(&amp;frame), delay.value());
751 }
752 
753 void InspectorPageAgent::frameClearedScheduledNavigation(Frame&amp; frame)
754 {
755     m_frontendDispatcher-&gt;frameClearedScheduledNavigation(frameId(&amp;frame));
756 }
757 
758 void InspectorPageAgent::defaultAppearanceDidChange(bool useDarkAppearance)
759 {
760     m_frontendDispatcher-&gt;defaultAppearanceDidChange(useDarkAppearance ? Inspector::Protocol::Page::Appearance::Dark : Inspector::Protocol::Page::Appearance::Light);
761 }
762 











763 void InspectorPageAgent::didPaint(RenderObject&amp; renderer, const LayoutRect&amp; rect)
764 {
765     if (!m_showPaintRects)
766         return;
767 
768     LayoutRect absoluteRect = LayoutRect(renderer.localToAbsoluteQuad(FloatRect(rect)).boundingBox());
769     FrameView* view = renderer.document().view();
770 
771     LayoutRect rootRect = absoluteRect;
772     if (!view-&gt;frame().isMainFrame()) {
773         IntRect rootViewRect = view-&gt;contentsToRootView(snappedIntRect(absoluteRect));
774         rootRect = view-&gt;frame().mainFrame().view()-&gt;rootViewToContents(rootViewRect);
775     }
776 
777     if (m_client-&gt;overridesShowPaintRects()) {
778         m_client-&gt;showPaintRect(rootRect);
779         return;
780     }
781 
782     m_overlay-&gt;showPaintRect(rootRect);
</pre>
<hr />
<pre>
855     }
856 
857     RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::Page::FrameResourceTree&gt;&gt; childrenArray;
858     for (Frame* child = frame-&gt;tree().firstChild(); child; child = child-&gt;tree().nextSibling()) {
859         if (!childrenArray) {
860             childrenArray = JSON::ArrayOf&lt;Inspector::Protocol::Page::FrameResourceTree&gt;::create();
861             result-&gt;setChildFrames(childrenArray);
862         }
863         childrenArray-&gt;addItem(buildObjectForFrameTree(child));
864     }
865     return result;
866 }
867 
868 void InspectorPageAgent::setEmulatedMedia(ErrorString&amp;, const String&amp; media)
869 {
870     if (media == m_emulatedMedia)
871         return;
872 
873     m_emulatedMedia = media;
874 

875     m_inspectedPage.updateStyleAfterChangeInEnvironment();
876 
<span class="line-modified">877     if (auto* document = m_inspectedPage.mainFrame().document())</span>
<span class="line-modified">878         document-&gt;updateLayout();</span>




879 }
880 
881 void InspectorPageAgent::setForcedAppearance(ErrorString&amp;, const String&amp; appearance)
882 {
883     if (appearance == m_forcedAppearance)
884         return;
885 
886     m_forcedAppearance = appearance;
887 
888     if (appearance == &quot;Light&quot;_s)
889         m_inspectedPage.setUseDarkAppearanceOverride(false);
890     else if (appearance == &quot;Dark&quot;_s)
891         m_inspectedPage.setUseDarkAppearanceOverride(true);
892     else
893         m_inspectedPage.setUseDarkAppearanceOverride(WTF::nullopt);
894 }
895 
896 void InspectorPageAgent::applyUserAgentOverride(String&amp; userAgent)
897 {
898     if (!m_userAgentOverride.isEmpty())
899         userAgent = m_userAgentOverride;
900 }
901 
902 void InspectorPageAgent::applyEmulatedMedia(String&amp; media)
903 {
904     if (!m_emulatedMedia.isEmpty())
905         media = m_emulatedMedia;
906 }
907 
<span class="line-removed">908 void InspectorPageAgent::getCompositingBordersVisible(ErrorString&amp;, bool* outParam)</span>
<span class="line-removed">909 {</span>
<span class="line-removed">910     *outParam = m_inspectedPage.settings().showDebugBorders() || m_inspectedPage.settings().showRepaintCounter();</span>
<span class="line-removed">911 }</span>
<span class="line-removed">912 </span>
<span class="line-removed">913 void InspectorPageAgent::setCompositingBordersVisible(ErrorString&amp;, bool visible)</span>
<span class="line-removed">914 {</span>
<span class="line-removed">915     m_inspectedPage.settings().setShowDebugBorders(visible);</span>
<span class="line-removed">916     m_inspectedPage.settings().setShowRepaintCounter(visible);</span>
<span class="line-removed">917 }</span>
<span class="line-removed">918 </span>
919 void InspectorPageAgent::snapshotNode(ErrorString&amp; errorString, int nodeId, String* outDataURL)
920 {
921     InspectorDOMAgent* domAgent = m_instrumentingAgents.inspectorDOMAgent();
922     ASSERT(domAgent);
923     Node* node = domAgent-&gt;assertNode(errorString, nodeId);
924     if (!node)
925         return;
926 
927     std::unique_ptr&lt;ImageBuffer&gt; snapshot = WebCore::snapshotNode(m_inspectedPage.mainFrame(), *node);
928     if (!snapshot) {
929         errorString = &quot;Could not capture snapshot&quot;_s;
930         return;
931     }
932 
933     *outDataURL = snapshot-&gt;toDataURL(&quot;image/png&quot;_s, WTF::nullopt, PreserveResolution::Yes);
934 }
935 
936 void InspectorPageAgent::snapshotRect(ErrorString&amp; errorString, int x, int y, int width, int height, const String&amp; coordinateSystem, String* outDataURL)
937 {
938     SnapshotOptions options = SnapshotOptionsNone;
</pre>
</td>
<td>
<hr />
<pre>
 20  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 21  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 22  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 23  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 24  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 25  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 26  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 27  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 28  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 29  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 30  */
 31 
 32 #include &quot;config.h&quot;
 33 #include &quot;InspectorPageAgent.h&quot;
 34 
 35 #include &quot;CachedResource.h&quot;
 36 #include &quot;CachedResourceLoader.h&quot;
 37 #include &quot;Cookie.h&quot;
 38 #include &quot;CookieJar.h&quot;
 39 #include &quot;CustomHeaderFields.h&quot;
<span class="line-added"> 40 #include &quot;DOMWrapperWorld.h&quot;</span>
 41 #include &quot;Document.h&quot;
 42 #include &quot;DocumentLoader.h&quot;
 43 #include &quot;Frame.h&quot;
 44 #include &quot;FrameLoadRequest.h&quot;
 45 #include &quot;FrameLoader.h&quot;
 46 #include &quot;FrameSnapshotting.h&quot;
 47 #include &quot;FrameView.h&quot;
 48 #include &quot;HTMLFrameOwnerElement.h&quot;
 49 #include &quot;HTMLNames.h&quot;
 50 #include &quot;ImageBuffer.h&quot;
 51 #include &quot;InspectorClient.h&quot;
 52 #include &quot;InspectorDOMAgent.h&quot;
 53 #include &quot;InspectorNetworkAgent.h&quot;
 54 #include &quot;InspectorOverlay.h&quot;
 55 #include &quot;InstrumentingAgents.h&quot;
 56 #include &quot;MIMETypeRegistry.h&quot;
 57 #include &quot;MemoryCache.h&quot;
 58 #include &quot;Page.h&quot;
 59 #include &quot;RenderObject.h&quot;
 60 #include &quot;RenderTheme.h&quot;
 61 #include &quot;ScriptController.h&quot;
<span class="line-added"> 62 #include &quot;ScriptSourceCode.h&quot;</span>
 63 #include &quot;SecurityOrigin.h&quot;
 64 #include &quot;Settings.h&quot;
 65 #include &quot;StyleScope.h&quot;
 66 #include &quot;TextEncoding.h&quot;
 67 #include &quot;UserGestureIndicator.h&quot;
 68 #include &lt;JavaScriptCore/ContentSearchUtilities.h&gt;
 69 #include &lt;JavaScriptCore/IdentifiersFactory.h&gt;
 70 #include &lt;JavaScriptCore/RegularExpression.h&gt;
 71 #include &lt;wtf/ListHashSet.h&gt;
 72 #include &lt;wtf/Stopwatch.h&gt;
 73 #include &lt;wtf/text/Base64.h&gt;
 74 #include &lt;wtf/text/StringBuilder.h&gt;
 75 
 76 #if ENABLE(APPLICATION_MANIFEST)
 77 #include &quot;CachedApplicationManifest.h&quot;
 78 #endif
 79 
 80 #if ENABLE(WEB_ARCHIVE) &amp;&amp; USE(CF)
 81 #include &quot;LegacyWebArchive.h&quot;
 82 #endif
 83 
 84 
 85 namespace WebCore {
 86 
 87 using namespace Inspector;
 88 
 89 // Keep this in sync with Page.Setting
 90 #define FOR_EACH_INSPECTOR_OVERRIDE_SETTING(macro) \
 91     macro(AuthorAndUserStylesEnabled) \
 92     macro(ICECandidateFilteringEnabled) \
 93     macro(ImagesEnabled) \
 94     macro(MediaCaptureRequiresSecureConnection) \
 95     macro(MockCaptureDevicesEnabled) \
 96     macro(NeedsSiteSpecificQuirks) \
 97     macro(ScriptEnabled) \
<span class="line-added"> 98     macro(ShowDebugBorders) \</span>
<span class="line-added"> 99     macro(ShowRepaintCounter) \</span>
100     macro(WebRTCEncryptionEnabled) \
101     macro(WebSecurityEnabled)
102 
103 static bool decodeBuffer(const char* buffer, unsigned size, const String&amp; textEncodingName, String* result)
104 {
105     if (buffer) {
106         TextEncoding encoding(textEncodingName);
107         if (!encoding.isValid())
108             encoding = WindowsLatin1Encoding();
109         *result = encoding.decode(buffer, size);
110         return true;
111     }
112     return false;
113 }
114 
115 bool InspectorPageAgent::mainResourceContent(Frame* frame, bool withBase64Encode, String* result)
116 {
117     RefPtr&lt;SharedBuffer&gt; buffer = frame-&gt;loader().documentLoader()-&gt;mainResourceData();
118     if (!buffer)
119         return false;
</pre>
<hr />
<pre>
568             if (auto* page = document-&gt;page())
569                 page-&gt;cookieJar().deleteCookie(*document, parsedURL, cookieName);
570         }
571     }
572 }
573 
574 void InspectorPageAgent::getResourceTree(ErrorString&amp;, RefPtr&lt;Inspector::Protocol::Page::FrameResourceTree&gt;&amp; object)
575 {
576     object = buildObjectForFrameTree(&amp;m_inspectedPage.mainFrame());
577 }
578 
579 void InspectorPageAgent::getResourceContent(ErrorString&amp; errorString, const String&amp; frameId, const String&amp; url, String* content, bool* base64Encoded)
580 {
581     Frame* frame = assertFrame(errorString, frameId);
582     if (!frame)
583         return;
584 
585     resourceContent(errorString, frame, URL({ }, url), content, base64Encoded);
586 }
587 
<span class="line-added">588 void InspectorPageAgent::setBootstrapScript(ErrorString&amp;, const String* optionalSource)</span>
<span class="line-added">589 {</span>
<span class="line-added">590     m_bootstrapScript = optionalSource ? *optionalSource : nullString();</span>
<span class="line-added">591 }</span>
<span class="line-added">592 </span>
593 void InspectorPageAgent::searchInResource(ErrorString&amp; errorString, const String&amp; frameId, const String&amp; url, const String&amp; query, const bool* optionalCaseSensitive, const bool* optionalIsRegex, const String* optionalRequestId, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::GenericTypes::SearchMatch&gt;&gt;&amp; results)
594 {
595     results = JSON::ArrayOf&lt;Inspector::Protocol::GenericTypes::SearchMatch&gt;::create();
596 
597     bool isRegex = optionalIsRegex ? *optionalIsRegex : false;
598     bool caseSensitive = optionalCaseSensitive ? *optionalCaseSensitive : false;
599 
600     if (optionalRequestId) {
601         if (InspectorNetworkAgent* networkAgent = m_instrumentingAgents.inspectorNetworkAgent()) {
602             networkAgent-&gt;searchInRequest(errorString, *optionalRequestId, query, caseSensitive, isRegex, results);
603             return;
604         }
605     }
606 
607     Frame* frame = assertFrame(errorString, frameId);
608     if (!frame)
609         return;
610 
611     DocumentLoader* loader = assertDocumentLoader(errorString, frame);
612     if (!loader)
</pre>
<hr />
<pre>
630 
631     if (!success)
632         return;
633 
634     results = ContentSearchUtilities::searchInTextByLines(content, query, caseSensitive, isRegex);
635 }
636 
637 static Ref&lt;Inspector::Protocol::Page::SearchResult&gt; buildObjectForSearchResult(const String&amp; frameId, const String&amp; url, int matchesCount)
638 {
639     return Inspector::Protocol::Page::SearchResult::create()
640         .setUrl(url)
641         .setFrameId(frameId)
642         .setMatchesCount(matchesCount)
643         .release();
644 }
645 
646 void InspectorPageAgent::searchInResources(ErrorString&amp;, const String&amp; text, const bool* optionalCaseSensitive, const bool* optionalIsRegex, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::Page::SearchResult&gt;&gt;&amp; result)
647 {
648     result = JSON::ArrayOf&lt;Inspector::Protocol::Page::SearchResult&gt;::create();
649 

650     bool caseSensitive = optionalCaseSensitive ? *optionalCaseSensitive : false;
<span class="line-modified">651     bool isRegex = optionalIsRegex ? *optionalIsRegex : false;</span>
<span class="line-added">652 </span>
<span class="line-added">653     auto searchStringType = isRegex ? ContentSearchUtilities::SearchStringType::Regex : ContentSearchUtilities::SearchStringType::ContainsString;</span>
<span class="line-added">654     auto regex = ContentSearchUtilities::createRegularExpressionForSearchString(text, caseSensitive, searchStringType);</span>
655 
656     for (Frame* frame = &amp;m_inspectedPage.mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {
657         for (auto* cachedResource : cachedResourcesForFrame(frame)) {
658             if (auto textContent = InspectorNetworkAgent::textContentForCachedResource(*cachedResource)) {
659                 int matchesCount = ContentSearchUtilities::countRegularExpressionMatches(regex, *textContent);
660                 if (matchesCount)
661                     result-&gt;addItem(buildObjectForSearchResult(frameId(frame), cachedResource-&gt;url(), matchesCount));
662             }
663         }
664     }
665 
666     if (InspectorNetworkAgent* networkAgent = m_instrumentingAgents.inspectorNetworkAgent())
667         networkAgent-&gt;searchOtherRequests(regex, result);
668 }
669 
670 void InspectorPageAgent::setShowRulers(ErrorString&amp;, bool showRulers)
671 {
672     m_overlay-&gt;setShowRulers(showRulers);
673 }
674 
</pre>
<hr />
<pre>
754 void InspectorPageAgent::frameStoppedLoading(Frame&amp; frame)
755 {
756     m_frontendDispatcher-&gt;frameStoppedLoading(frameId(&amp;frame));
757 }
758 
759 void InspectorPageAgent::frameScheduledNavigation(Frame&amp; frame, Seconds delay)
760 {
761     m_frontendDispatcher-&gt;frameScheduledNavigation(frameId(&amp;frame), delay.value());
762 }
763 
764 void InspectorPageAgent::frameClearedScheduledNavigation(Frame&amp; frame)
765 {
766     m_frontendDispatcher-&gt;frameClearedScheduledNavigation(frameId(&amp;frame));
767 }
768 
769 void InspectorPageAgent::defaultAppearanceDidChange(bool useDarkAppearance)
770 {
771     m_frontendDispatcher-&gt;defaultAppearanceDidChange(useDarkAppearance ? Inspector::Protocol::Page::Appearance::Dark : Inspector::Protocol::Page::Appearance::Light);
772 }
773 
<span class="line-added">774 void InspectorPageAgent::didClearWindowObjectInWorld(Frame&amp; frame, DOMWrapperWorld&amp; world)</span>
<span class="line-added">775 {</span>
<span class="line-added">776     if (&amp;world != &amp;mainThreadNormalWorld())</span>
<span class="line-added">777         return;</span>
<span class="line-added">778 </span>
<span class="line-added">779     if (m_bootstrapScript.isEmpty())</span>
<span class="line-added">780         return;</span>
<span class="line-added">781 </span>
<span class="line-added">782     frame.script().evaluateIgnoringException(ScriptSourceCode(m_bootstrapScript, URL { URL(), &quot;web-inspector://bootstrap.js&quot;_s }));</span>
<span class="line-added">783 }</span>
<span class="line-added">784 </span>
785 void InspectorPageAgent::didPaint(RenderObject&amp; renderer, const LayoutRect&amp; rect)
786 {
787     if (!m_showPaintRects)
788         return;
789 
790     LayoutRect absoluteRect = LayoutRect(renderer.localToAbsoluteQuad(FloatRect(rect)).boundingBox());
791     FrameView* view = renderer.document().view();
792 
793     LayoutRect rootRect = absoluteRect;
794     if (!view-&gt;frame().isMainFrame()) {
795         IntRect rootViewRect = view-&gt;contentsToRootView(snappedIntRect(absoluteRect));
796         rootRect = view-&gt;frame().mainFrame().view()-&gt;rootViewToContents(rootViewRect);
797     }
798 
799     if (m_client-&gt;overridesShowPaintRects()) {
800         m_client-&gt;showPaintRect(rootRect);
801         return;
802     }
803 
804     m_overlay-&gt;showPaintRect(rootRect);
</pre>
<hr />
<pre>
877     }
878 
879     RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::Page::FrameResourceTree&gt;&gt; childrenArray;
880     for (Frame* child = frame-&gt;tree().firstChild(); child; child = child-&gt;tree().nextSibling()) {
881         if (!childrenArray) {
882             childrenArray = JSON::ArrayOf&lt;Inspector::Protocol::Page::FrameResourceTree&gt;::create();
883             result-&gt;setChildFrames(childrenArray);
884         }
885         childrenArray-&gt;addItem(buildObjectForFrameTree(child));
886     }
887     return result;
888 }
889 
890 void InspectorPageAgent::setEmulatedMedia(ErrorString&amp;, const String&amp; media)
891 {
892     if (media == m_emulatedMedia)
893         return;
894 
895     m_emulatedMedia = media;
896 
<span class="line-added">897     // FIXME: Schedule a rendering update instead of synchronously updating the layout.</span>
898     m_inspectedPage.updateStyleAfterChangeInEnvironment();
899 
<span class="line-modified">900     auto document = makeRefPtr(m_inspectedPage.mainFrame().document());</span>
<span class="line-modified">901     if (!document)</span>
<span class="line-added">902         return;</span>
<span class="line-added">903 </span>
<span class="line-added">904     document-&gt;updateLayout();</span>
<span class="line-added">905     document-&gt;evaluateMediaQueriesAndReportChanges();</span>
906 }
907 
908 void InspectorPageAgent::setForcedAppearance(ErrorString&amp;, const String&amp; appearance)
909 {
910     if (appearance == m_forcedAppearance)
911         return;
912 
913     m_forcedAppearance = appearance;
914 
915     if (appearance == &quot;Light&quot;_s)
916         m_inspectedPage.setUseDarkAppearanceOverride(false);
917     else if (appearance == &quot;Dark&quot;_s)
918         m_inspectedPage.setUseDarkAppearanceOverride(true);
919     else
920         m_inspectedPage.setUseDarkAppearanceOverride(WTF::nullopt);
921 }
922 
923 void InspectorPageAgent::applyUserAgentOverride(String&amp; userAgent)
924 {
925     if (!m_userAgentOverride.isEmpty())
926         userAgent = m_userAgentOverride;
927 }
928 
929 void InspectorPageAgent::applyEmulatedMedia(String&amp; media)
930 {
931     if (!m_emulatedMedia.isEmpty())
932         media = m_emulatedMedia;
933 }
934 











935 void InspectorPageAgent::snapshotNode(ErrorString&amp; errorString, int nodeId, String* outDataURL)
936 {
937     InspectorDOMAgent* domAgent = m_instrumentingAgents.inspectorDOMAgent();
938     ASSERT(domAgent);
939     Node* node = domAgent-&gt;assertNode(errorString, nodeId);
940     if (!node)
941         return;
942 
943     std::unique_ptr&lt;ImageBuffer&gt; snapshot = WebCore::snapshotNode(m_inspectedPage.mainFrame(), *node);
944     if (!snapshot) {
945         errorString = &quot;Could not capture snapshot&quot;_s;
946         return;
947     }
948 
949     *outDataURL = snapshot-&gt;toDataURL(&quot;image/png&quot;_s, WTF::nullopt, PreserveResolution::Yes);
950 }
951 
952 void InspectorPageAgent::snapshotRect(ErrorString&amp; errorString, int x, int y, int width, int height, const String&amp; coordinateSystem, String* outDataURL)
953 {
954     SnapshotOptions options = SnapshotOptionsNone;
</pre>
</td>
</tr>
</table>
<center><a href="InspectorNetworkAgent.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="InspectorPageAgent.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>