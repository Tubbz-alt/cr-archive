<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/bmalloc/bmalloc/IsoHeapImpl.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre> 1 /*
 2  * Copyright (C) 2017 Apple Inc. All rights reserved.
 3  *
 4  * Redistribution and use in source and binary forms, with or without
 5  * modification, are permitted provided that the following conditions
 6  * are met:
 7  * 1. Redistributions of source code must retain the above copyright
 8  *    notice, this list of conditions and the following disclaimer.
 9  * 2. Redistributions in binary form must reproduce the above copyright
10  *    notice, this list of conditions and the following disclaimer in the
11  *    documentation and/or other materials provided with the distribution.
12  *
13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
24  */
25 
26 #include &quot;IsoHeapImpl.h&quot;
27 
28 #include &quot;AllIsoHeaps.h&quot;
29 #include &quot;PerProcess.h&quot;
30 #include &lt;climits&gt;
31 
32 namespace bmalloc {
33 
<a name="1" id="anc1"></a><span class="line-modified">34 IsoHeapImplBase::IsoHeapImplBase(Mutex&amp; lock)</span>
<span class="line-added">35     : lock(lock)</span>
36 {
37 }
38 
39 IsoHeapImplBase::~IsoHeapImplBase()
40 {
41 }
42 
43 void IsoHeapImplBase::addToAllIsoHeaps()
44 {
45     AllIsoHeaps::get()-&gt;add(this);
46 }
47 
48 void IsoHeapImplBase::scavengeNow()
49 {
50     Vector&lt;DeferredDecommit&gt; deferredDecommits;
51     scavenge(deferredDecommits);
52     finishScavenging(deferredDecommits);
53 }
54 
55 void IsoHeapImplBase::finishScavenging(Vector&lt;DeferredDecommit&gt;&amp; deferredDecommits)
56 {
57     std::sort(
58         deferredDecommits.begin(), deferredDecommits.end(),
59         [&amp;] (const DeferredDecommit&amp; a, const DeferredDecommit&amp; b) -&gt; bool {
60             return a.page &lt; b.page;
61         });
62     unsigned runStartIndex = UINT_MAX;
63     char* run = nullptr;
64     size_t size = 0;
65     auto resetRun = [&amp;] (unsigned endIndex) {
66         if (!run) {
67             RELEASE_BASSERT(!size);
68             RELEASE_BASSERT(runStartIndex == UINT_MAX);
69             return;
70         }
71         RELEASE_BASSERT(size);
72         RELEASE_BASSERT(runStartIndex != UINT_MAX);
73         vmDeallocatePhysicalPages(run, size);
74         for (unsigned i = runStartIndex; i &lt; endIndex; ++i) {
75             const DeferredDecommit&amp; value = deferredDecommits[i];
76             value.directory-&gt;didDecommit(value.pageIndex);
77         }
78         run = nullptr;
79         size = 0;
80         runStartIndex = UINT_MAX;
81     };
82     for (unsigned i = 0; i &lt; deferredDecommits.size(); ++i) {
83         const DeferredDecommit&amp; value = deferredDecommits[i];
84         char* page = reinterpret_cast&lt;char*&gt;(value.page);
85         RELEASE_BASSERT(page &gt;= run + size);
86         if (page != run + size) {
87             resetRun(i);
88             runStartIndex = i;
89             run = page;
90         }
91         size += IsoPageBase::pageSize;
92     }
93     resetRun(deferredDecommits.size());
94 }
95 
96 } // namespace bmalloc
97 
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>