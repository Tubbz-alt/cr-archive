<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/bridge/jni/jsc/JavaFieldJSC.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2003, 2004, 2005, 2007, 2009 Apple Inc. All rights reserved.
  3  * Copyright 2010, The Android Open Source Project
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  * 1. Redistributions of source code must retain the above copyright
  9  *    notice, this list of conditions and the following disclaimer.
 10  * 2. Redistributions in binary form must reproduce the above copyright
 11  *    notice, this list of conditions and the following disclaimer in the
 12  *    documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY APPLE COMPUTER, INC. ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE COMPUTER, INC. OR
 18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 25  */
 26 
 27 #include &quot;config.h&quot;
 28 #include &quot;JavaFieldJSC.h&quot;
 29 
 30 #if ENABLE(JAVA_BRIDGE)
 31 
 32 #include &quot;BridgeUtils.h&quot;
 33 #include &quot;JNIUtilityPrivate.h&quot;
 34 #include &quot;JavaArrayJSC.h&quot;
 35 #include &quot;Logging.h&quot;
 36 #include &quot;runtime_array.h&quot;
 37 #include &quot;runtime_object.h&quot;
 38 
 39 #include &lt;JavaScriptCore/Error.h&gt;
 40 #include &lt;JavaScriptCore/APICast.h&gt;
 41 
 42 using namespace JSC;
 43 using namespace JSC::Bindings;
 44 using namespace WebCore;
 45 
 46 JavaField::JavaField(JNIEnv* env, jobject aField)
 47 {
 48     // Get field type name
 49     jstring fieldTypeName = 0;
 50     jclass fieldType = static_cast&lt;jclass&gt;(callJNIMethod&lt;jobject&gt;(aField, &quot;getType&quot;, &quot;()Ljava/lang/Class;&quot;));
 51     if (fieldType)
 52         fieldTypeName = static_cast&lt;jstring&gt;(callJNIMethod&lt;jobject&gt;(fieldType, &quot;getName&quot;, &quot;()Ljava/lang/String;&quot;));
 53     if (!fieldTypeName)
 54         fieldTypeName = env-&gt;NewStringUTF(&quot;&lt;Unknown&gt;&quot;);
 55     m_typeClassName = JavaString(env, fieldTypeName);
 56 
 57     m_type = javaTypeFromClassName(m_typeClassName.utf8());
 58     env-&gt;DeleteLocalRef(fieldType);
 59     env-&gt;DeleteLocalRef(fieldTypeName);
 60 
 61     // Get field name
 62     jstring fieldName = static_cast&lt;jstring&gt;(callJNIMethod&lt;jobject&gt;(aField, &quot;getName&quot;, &quot;()Ljava/lang/String;&quot;));
 63     if (!fieldName)
 64         fieldName = env-&gt;NewStringUTF(&quot;&lt;Unknown&gt;&quot;);
 65     m_name = JavaString(env, fieldName);
 66     env-&gt;DeleteLocalRef(fieldName);
 67 
 68     m_field = JobjectWrapper::create(aField);
 69 }
 70 
<a name="1" id="anc1"></a><span class="line-modified"> 71 JSValue JavaField::valueFromInstance(ExecState* exec, const Instance* i) const</span>
 72 {
 73     const JavaInstance* instance = static_cast&lt;const JavaInstance*&gt;(i);
 74 
 75     JSValue jsresult = jsUndefined();
 76     jobject jfield = m_field-&gt;instance();
 77     // Since jfield is WeakGlobalRef, creating a localref to safeguard instance() from GC
 78     JLObject jlfield(jfield, true);
 79 
 80     if (!jlfield) {
 81         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaField::valueFromInstance&quot;, (jobject)jlfield);
 82         return jsresult;
 83     }
 84 
 85     jobject jinstance = instance-&gt;javaInstance();
 86     // Since jinstance is WeakGlobalRef, creating a localref to safeguard instance() from GC
 87     JLObject jlinstance(jinstance, true);
 88 
 89     if (!jlinstance) {
 90         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaField::valueFromInstance&quot;, (jobject)jlinstance);
 91         return jsresult;
 92     }
 93 
 94     switch (m_type) {
 95     case JavaTypeArray:
 96     case JavaTypeObject:
 97     // Since we can&#39;t convert java.lang.Character to any JS primitive, we have
 98     // to treat it as JS foreign object.
 99     case JavaTypeChar:
100         {
101             jobject anObject = callJNIMethod&lt;jobject&gt;(jfield, &quot;get&quot;, &quot;(Ljava/lang/Object;)Ljava/lang/Object;&quot;, jinstance);
102             if (!anObject)
103                 return jsNull();
104 
105             const char* arrayType = typeClassName();
106             if (arrayType[0] == &#39;[&#39;)
<a name="2" id="anc2"></a><span class="line-modified">107                 jsresult = JavaArray::convertJObjectToArray(exec, anObject, arrayType, instance-&gt;rootObject(), instance-&gt;accessControlContext());</span>
108             else if (anObject)
109 
<a name="3" id="anc3"></a><span class="line-modified">110             jsresult = toJS(exec, WebCore::Java_Object_to_JSValue(getJNIEnv(), toRef(exec), instance-&gt;rootObject(), anObject, instance-&gt;accessControlContext()));</span>
111         }
112         break;
113 
114     case JavaTypeBoolean:
115         jsresult = jsBoolean(callJNIMethod&lt;jboolean&gt;(jfield, &quot;getBoolean&quot;, &quot;(Ljava/lang/Object;)Z&quot;, jinstance));
116         break;
117 
118     case JavaTypeByte:
119         jsresult = jsNumber(callJNIMethod&lt;jbyte&gt;(jfield, &quot;getByte&quot;, &quot;(Ljava/lang/Object;)B&quot;, jinstance));
120         break;
121 
122     case JavaTypeShort:
123         jsresult = jsNumber(callJNIMethod&lt;jshort&gt;(jfield, &quot;getShort&quot;, &quot;(Ljava/lang/Object;)S&quot;, jinstance));
124         break;
125 
126     case JavaTypeInt:
127         jsresult = jsNumber(static_cast&lt;int&gt;(callJNIMethod&lt;jint&gt;(jfield, &quot;getInt&quot;, &quot;(Ljava/lang/Object;)I&quot;, jinstance)));
128         break;
129 
130     case JavaTypeLong:
131         jsresult = jsNumber(static_cast&lt;double&gt;(callJNIMethod&lt;jlong&gt;(jfield, &quot;getLong&quot;, &quot;(Ljava/lang/Object;)J&quot;, jinstance)));
132         break;
133     case JavaTypeFloat:
134         jsresult = jsNumber(static_cast&lt;double&gt;(callJNIMethod&lt;jfloat&gt;(jfield, &quot;getFloat&quot;, &quot;(Ljava/lang/Object;)F&quot;, jinstance)));
135         break;
136 
137     case JavaTypeDouble:
138         jsresult = jsNumber(static_cast&lt;double&gt;(callJNIMethod&lt;jdouble&gt;(jfield, &quot;getDouble&quot;, &quot;(Ljava/lang/Object;)D&quot;, jinstance)));
139         break;
140 
141     default:
142         break;
143     }
144 
<a name="4" id="anc4"></a><span class="line-modified">145     LOG(LiveConnect, &quot;JavaField::valueFromInstance getting %s = %s&quot;, String(name().impl()).utf8().data(), jsresult.toString(exec)-&gt;value(exec).ascii().data());</span>
146 
147     return jsresult;
148 }
149 
<a name="5" id="anc5"></a><span class="line-modified">150 bool JavaField::setValueToInstance(ExecState* exec, const Instance* i, JSValue aValue) const</span>
151 {
152     const JavaInstance* instance = static_cast&lt;const JavaInstance*&gt;(i);
<a name="6" id="anc6"></a><span class="line-modified">153     jvalue javaValue = convertValueToJValue(exec, i-&gt;rootObject(), aValue, m_type, typeClassName());</span>
<span class="line-modified">154     LOG(LiveConnect, &quot;JavaField::setValueToInstance setting value %s to %s&quot;, String(name().impl()).utf8().data(), aValue.toString(exec)-&gt;value(exec).ascii().data());</span>
155 
156     jobject jfield = m_field-&gt;instance();
157     // Since jfield is WeakGlobalRef, creating a localref to safeguard instance() from GC
158     JLObject jlfield(jfield, true);
159 
160     if (!jlfield) {
161         LOG_ERROR(&quot;Could not get Instance for %p in JavaField::setValueToInstance&quot;, (jobject)jlfield);
162         return false;
163     }
164 
165     jobject jinstance = instance-&gt;javaInstance();
166     // Since jinstance is WeakGlobalRef, creating a localref to safeguard javaInstance() from GC
167     JLObject jlinstance(jinstance, true);
168 
169     if (!jlinstance) {
170         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaField::setValueToInstance&quot;, (jobject)jlinstance);
171         return false;
172     }
173 
174     switch (m_type) {
175     case JavaTypeArray:
176     case JavaTypeObject:
177         callJNIMethod&lt;void&gt;(jfield, &quot;set&quot;, &quot;(Ljava/lang/Object;Ljava/lang/Object;)V&quot;, jinstance, javaValue.l);
178         break;
179 
180     case JavaTypeBoolean:
181         callJNIMethod&lt;void&gt;(jfield, &quot;setBoolean&quot;, &quot;(Ljava/lang/Object;Z)V&quot;, jinstance, javaValue.z);
182         break;
183 
184     case JavaTypeByte:
185         callJNIMethod&lt;void&gt;(jfield, &quot;setByte&quot;, &quot;(Ljava/lang/Object;B)V&quot;, jinstance, javaValue.b);
186         break;
187 
188     case JavaTypeChar:
189         callJNIMethod&lt;void&gt;(jfield, &quot;setChar&quot;, &quot;(Ljava/lang/Object;C)V&quot;, jinstance, javaValue.c);
190         break;
191 
192     case JavaTypeShort:
193         callJNIMethod&lt;void&gt;(jfield, &quot;setShort&quot;, &quot;(Ljava/lang/Object;S)V&quot;, jinstance, javaValue.s);
194         break;
195 
196     case JavaTypeInt:
197         callJNIMethod&lt;void&gt;(jfield, &quot;setInt&quot;, &quot;(Ljava/lang/Object;I)V&quot;, jinstance, javaValue.i);
198         break;
199 
200     case JavaTypeLong:
201         callJNIMethod&lt;void&gt;(jfield, &quot;setLong&quot;, &quot;(Ljava/lang/Object;J)V&quot;, jinstance, javaValue.j);
202         break;
203 
204     case JavaTypeFloat:
205         callJNIMethod&lt;void&gt;(jfield, &quot;setFloat&quot;, &quot;(Ljava/lang/Object;F)V&quot;, jinstance, javaValue.f);
206         break;
207 
208     case JavaTypeDouble:
209         callJNIMethod&lt;void&gt;(jfield, &quot;setDouble&quot;, &quot;(Ljava/lang/Object;D)V&quot;, jinstance, javaValue.d);
210         break;
211 
212     default:
213         abort();
214     }
215     return true;
216 }
217 
218 #endif // ENABLE(JAVA_BRIDGE)
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>