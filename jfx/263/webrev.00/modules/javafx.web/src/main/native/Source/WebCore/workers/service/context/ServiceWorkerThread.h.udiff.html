<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/workers/service/context/ServiceWorkerThread.h</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ServiceWorkerThread.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ServiceWorkerThreadProxy.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/workers/service/context/ServiceWorkerThread.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -28,10 +28,11 @@</span>
  #if ENABLE(SERVICE_WORKER)
  
  #include &quot;ServiceWorkerContextData.h&quot;
  #include &quot;ServiceWorkerFetch.h&quot;
  #include &quot;ServiceWorkerIdentifier.h&quot;
<span class="udiff-line-added">+ #include &quot;Timer.h&quot;</span>
  #include &quot;WorkerThread.h&quot;
  
  namespace WebCore {
  
  class CacheStorageProvider;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -39,13 +40,11 @@</span>
  class ExtendableEvent;
  class MessagePortChannel;
  class SerializedScriptValue;
  class WorkerObjectProxy;
  struct MessageWithMessagePorts;
<span class="udiff-line-removed">- struct ServiceWorkerClientData;</span>
  struct ServiceWorkerClientIdentifier;
<span class="udiff-line-removed">- struct ServiceWorkerContextData;</span>
  
  class ServiceWorkerThread : public WorkerThread {
  public:
      template&lt;typename... Args&gt; static Ref&lt;ServiceWorkerThread&gt; create(Args&amp;&amp;... args)
      {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -53,31 +52,62 @@</span>
      }
      virtual ~ServiceWorkerThread();
  
      WorkerObjectProxy&amp; workerObjectProxy() const { return m_workerObjectProxy; }
  
<span class="udiff-line-modified-removed">-     WEBCORE_EXPORT void postFetchTask(Ref&lt;ServiceWorkerFetch::Client&gt;&amp;&amp;, Optional&lt;ServiceWorkerClientIdentifier&gt;&amp;&amp;, ResourceRequest&amp;&amp;, String&amp;&amp; referrer, FetchOptions&amp;&amp;);</span>
<span class="udiff-line-removed">-     WEBCORE_EXPORT void postMessageToServiceWorker(MessageWithMessagePorts&amp;&amp;, ServiceWorkerOrClientData&amp;&amp; sourceData);</span>
<span class="udiff-line-modified-added">+     void start(Function&lt;void(const String&amp;, bool)&gt;&amp;&amp;);</span>
  
<span class="udiff-line-modified-removed">-     void fireInstallEvent();</span>
<span class="udiff-line-modified-removed">-     void fireActivateEvent();</span>
<span class="udiff-line-modified-added">+     void willPostTaskToFireInstallEvent();</span>
<span class="udiff-line-modified-added">+     void willPostTaskToFireActivateEvent();</span>
<span class="udiff-line-added">+     void willPostTaskToFireMessageEvent();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void queueTaskToFireFetchEvent(Ref&lt;ServiceWorkerFetch::Client&gt;&amp;&amp;, Optional&lt;ServiceWorkerClientIdentifier&gt;&amp;&amp;, ResourceRequest&amp;&amp;, String&amp;&amp; referrer, FetchOptions&amp;&amp;);</span>
<span class="udiff-line-added">+     void queueTaskToPostMessage(MessageWithMessagePorts&amp;&amp;, ServiceWorkerOrClientData&amp;&amp; sourceData);</span>
<span class="udiff-line-added">+     void queueTaskToFireInstallEvent();</span>
<span class="udiff-line-added">+     void queueTaskToFireActivateEvent();</span>
  
      const ServiceWorkerContextData&amp; contextData() const { return m_data; }
  
      ServiceWorkerIdentifier identifier() const { return m_data.serviceWorkerIdentifier; }
<span class="udiff-line-added">+     bool doesHandleFetch() const { return m_doesHandleFetch; }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void startFetchEventMonitoring();</span>
<span class="udiff-line-added">+     void stopFetchEventMonitoring() { m_isHandlingFetchEvent = false; }</span>
  
  protected:
<span class="udiff-line-modified-removed">-     Ref&lt;WorkerGlobalScope&gt; createWorkerGlobalScope(const URL&amp;, Ref&lt;SecurityOrigin&gt;&amp;&amp;, const String&amp; name, const String&amp; identifier, const String&amp; userAgent, bool isOnline, const ContentSecurityPolicyResponseHeaders&amp;, bool shouldBypassMainWorldContentSecurityPolicy, Ref&lt;SecurityOrigin&gt;&amp;&amp; topOrigin, MonotonicTime timeOrigin, PAL::SessionID) final;</span>
<span class="udiff-line-modified-added">+     Ref&lt;WorkerGlobalScope&gt; createWorkerGlobalScope(const WorkerParameters&amp;, Ref&lt;SecurityOrigin&gt;&amp;&amp;, Ref&lt;SecurityOrigin&gt;&amp;&amp; topOrigin) final;</span>
      void runEventLoop() override;
  
  private:
<span class="udiff-line-modified-removed">-     WEBCORE_EXPORT ServiceWorkerThread(const ServiceWorkerContextData&amp;, PAL::SessionID, String&amp;&amp; userAgent, WorkerLoaderProxy&amp;, WorkerDebuggerProxy&amp;, IDBClient::IDBConnectionProxy*, SocketProvider*);</span>
<span class="udiff-line-modified-added">+     WEBCORE_EXPORT ServiceWorkerThread(const ServiceWorkerContextData&amp;, String&amp;&amp; userAgent, WorkerLoaderProxy&amp;, WorkerDebuggerProxy&amp;, IDBClient::IDBConnectionProxy*, SocketProvider*);</span>
  
      bool isServiceWorkerThread() const final { return true; }
<span class="udiff-line-added">+     void finishedEvaluatingScript() final;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void finishedFiringInstallEvent(bool hasRejectedAnyPromise);</span>
<span class="udiff-line-added">+     void finishedFiringActivateEvent();</span>
<span class="udiff-line-added">+     void finishedFiringMessageEvent();</span>
<span class="udiff-line-added">+     void finishedStarting();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void startHeartBeatTimer();</span>
<span class="udiff-line-added">+     void heartBeatTimerFired();</span>
<span class="udiff-line-added">+     void installEventTimerFired();</span>
  
      ServiceWorkerContextData m_data;
      WorkerObjectProxy&amp; m_workerObjectProxy;
<span class="udiff-line-added">+     bool m_doesHandleFetch { false };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     bool m_isHandlingFetchEvent { false };</span>
<span class="udiff-line-added">+     uint64_t m_messageEventCount { 0 };</span>
<span class="udiff-line-added">+     enum class State { Idle, Starting, Installing, Activating };</span>
<span class="udiff-line-added">+     State m_state { State::Idle };</span>
<span class="udiff-line-added">+     bool m_ongoingHeartBeatCheck { false };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static constexpr Seconds heartBeatTimeout { 60_s };</span>
<span class="udiff-line-added">+     static constexpr Seconds heartBeatTimeoutForTest { 1_s };</span>
<span class="udiff-line-added">+     Seconds m_heartBeatTimeout { heartBeatTimeout };</span>
<span class="udiff-line-added">+     Timer m_heartBeatTimer;</span>
  };
  
  } // namespace WebCore
  
  #endif // ENABLE(SERVICE_WORKER)
</pre>
<center><a href="ServiceWorkerThread.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ServiceWorkerThreadProxy.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>