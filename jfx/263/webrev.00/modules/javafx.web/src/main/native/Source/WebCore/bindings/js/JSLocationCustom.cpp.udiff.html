<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSLocationCustom.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSLazyEventListener.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSMediaStreamTrackCustom.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSLocationCustom.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -33,24 +33,24 @@</span>
  #include &lt;JavaScriptCore/Lookup.h&gt;
  
  namespace WebCore {
  using namespace JSC;
  
<span class="udiff-line-modified-removed">- static bool getOwnPropertySlotCommon(JSLocation&amp; thisObject, ExecState&amp; state, PropertyName propertyName, PropertySlot&amp; slot)</span>
<span class="udiff-line-modified-added">+ static bool getOwnPropertySlotCommon(JSLocation&amp; thisObject, JSGlobalObject&amp; lexicalGlobalObject, PropertyName propertyName, PropertySlot&amp; slot)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = state.vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = lexicalGlobalObject.vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      auto* window = thisObject.wrapped().window();
  
      // When accessing Location cross-domain, functions are always the native built-in ones.
      // See JSDOMWindow::getOwnPropertySlotDelegate for additional details.
  
      // Our custom code is only needed to implement the Window cross-domain scheme, so if access is
      // allowed, return false so the normal lookup will take place.
      String message;
<span class="udiff-line-modified-removed">-     if (BindingSecurity::shouldAllowAccessToDOMWindow(state, window, message))</span>
<span class="udiff-line-modified-added">+     if (BindingSecurity::shouldAllowAccessToDOMWindow(lexicalGlobalObject, window, message))</span>
          return false;
  
      // https://html.spec.whatwg.org/#crossorigingetownpropertyhelper-(-o,-p-)
  
      // We only allow access to Location.replace() cross origin.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -69,184 +69,181 @@</span>
      }
  
      if (handleCommonCrossOriginProperties(&amp;thisObject, vm, propertyName, slot))
          return true;
  
<span class="udiff-line-modified-removed">-     throwSecurityError(state, scope, message);</span>
<span class="udiff-line-modified-added">+     throwSecurityError(lexicalGlobalObject, scope, message);</span>
      slot.setUndefined();
      return false;
  }
  
<span class="udiff-line-modified-removed">- bool JSLocation::getOwnPropertySlot(JSObject* object, ExecState* state, PropertyName propertyName, PropertySlot&amp; slot)</span>
<span class="udiff-line-modified-added">+ bool JSLocation::getOwnPropertySlot(JSObject* object, JSGlobalObject* lexicalGlobalObject, PropertyName propertyName, PropertySlot&amp; slot)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = state-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
      auto* thisObject = jsCast&lt;JSLocation*&gt;(object);
      ASSERT_GC_OBJECT_INHERITS(thisObject, info());
  
<span class="udiff-line-modified-removed">-     bool result = getOwnPropertySlotCommon(*thisObject, *state, propertyName, slot);</span>
<span class="udiff-line-modified-added">+     bool result = getOwnPropertySlotCommon(*thisObject, *lexicalGlobalObject, propertyName, slot);</span>
      EXCEPTION_ASSERT(!scope.exception() || !result);
      RETURN_IF_EXCEPTION(scope, false);
      if (result)
          return true;
<span class="udiff-line-modified-removed">-     RELEASE_AND_RETURN(scope, JSObject::getOwnPropertySlot(object, state, propertyName, slot));</span>
<span class="udiff-line-modified-added">+     RELEASE_AND_RETURN(scope, JSObject::getOwnPropertySlot(object, lexicalGlobalObject, propertyName, slot));</span>
  }
  
<span class="udiff-line-modified-removed">- bool JSLocation::getOwnPropertySlotByIndex(JSObject* object, ExecState* state, unsigned index, PropertySlot&amp; slot)</span>
<span class="udiff-line-modified-added">+ bool JSLocation::getOwnPropertySlotByIndex(JSObject* object, JSGlobalObject* lexicalGlobalObject, unsigned index, PropertySlot&amp; slot)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = state-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
      auto* thisObject = jsCast&lt;JSLocation*&gt;(object);
      ASSERT_GC_OBJECT_INHERITS(thisObject, info());
  
<span class="udiff-line-modified-removed">-     bool result = getOwnPropertySlotCommon(*thisObject, *state, Identifier::from(vm, index), slot);</span>
<span class="udiff-line-modified-added">+     bool result = getOwnPropertySlotCommon(*thisObject, *lexicalGlobalObject, Identifier::from(vm, index), slot);</span>
      EXCEPTION_ASSERT(!scope.exception() || !result);
      RETURN_IF_EXCEPTION(scope, false);
      if (result)
          return true;
<span class="udiff-line-modified-removed">-     RELEASE_AND_RETURN(scope, JSObject::getOwnPropertySlotByIndex(object, state, index, slot));</span>
<span class="udiff-line-modified-added">+     RELEASE_AND_RETURN(scope, JSObject::getOwnPropertySlotByIndex(object, lexicalGlobalObject, index, slot));</span>
  }
  
<span class="udiff-line-modified-removed">- static bool putCommon(JSLocation&amp; thisObject, ExecState&amp; state, PropertyName propertyName)</span>
<span class="udiff-line-modified-added">+ static bool putCommon(JSLocation&amp; thisObject, JSGlobalObject&amp; lexicalGlobalObject, PropertyName propertyName)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = state.vm();</span>
<span class="udiff-line-removed">-     // Silently block access to toString and valueOf.</span>
<span class="udiff-line-removed">-     if (propertyName == vm.propertyNames-&gt;toString || propertyName == vm.propertyNames-&gt;valueOf)</span>
<span class="udiff-line-removed">-         return true;</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = lexicalGlobalObject.vm();</span>
  
      // Always allow assigning to the whole location.
      // However, alllowing assigning of pieces might inadvertently disclose parts of the original location.
      // So fall through to the access check for those.
      if (propertyName == static_cast&lt;JSVMClientData*&gt;(vm.clientData)-&gt;builtinNames().hrefPublicName())
          return false;
  
      // Block access and throw if there is a security error.
<span class="udiff-line-modified-removed">-     if (!BindingSecurity::shouldAllowAccessToDOMWindow(&amp;state, thisObject.wrapped().window(), ThrowSecurityError))</span>
<span class="udiff-line-modified-added">+     if (!BindingSecurity::shouldAllowAccessToDOMWindow(&amp;lexicalGlobalObject, thisObject.wrapped().window(), ThrowSecurityError))</span>
          return true;
  
      return false;
  }
  
<span class="udiff-line-modified-removed">- void JSLocation::doPutPropertySecurityCheck(JSObject* object, ExecState* state, PropertyName propertyName, PutPropertySlot&amp;)</span>
<span class="udiff-line-modified-added">+ void JSLocation::doPutPropertySecurityCheck(JSObject* object, JSGlobalObject* lexicalGlobalObject, PropertyName propertyName, PutPropertySlot&amp;)</span>
  {
      auto* thisObject = jsCast&lt;JSLocation*&gt;(object);
      ASSERT_GC_OBJECT_INHERITS(thisObject, info());
  
<span class="udiff-line-modified-removed">-     VM&amp; vm = state-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
  
      // Always allow assigning to the whole location.
      // However, alllowing assigning of pieces might inadvertently disclose parts of the original location.
      // So fall through to the access check for those.
      if (propertyName == static_cast&lt;JSVMClientData*&gt;(vm.clientData)-&gt;builtinNames().hrefPublicName())
          return;
  
      // Block access and throw if there is a security error.
<span class="udiff-line-modified-removed">-     BindingSecurity::shouldAllowAccessToDOMWindow(state, thisObject-&gt;wrapped().window(), ThrowSecurityError);</span>
<span class="udiff-line-modified-added">+     BindingSecurity::shouldAllowAccessToDOMWindow(lexicalGlobalObject, thisObject-&gt;wrapped().window(), ThrowSecurityError);</span>
  }
  
<span class="udiff-line-modified-removed">- bool JSLocation::put(JSCell* cell, ExecState* state, PropertyName propertyName, JSValue value, PutPropertySlot&amp; putPropertySlot)</span>
<span class="udiff-line-modified-added">+ bool JSLocation::put(JSCell* cell, JSGlobalObject* lexicalGlobalObject, PropertyName propertyName, JSValue value, PutPropertySlot&amp; putPropertySlot)</span>
  {
      auto* thisObject = jsCast&lt;JSLocation*&gt;(cell);
      ASSERT_GC_OBJECT_INHERITS(thisObject, info());
  
<span class="udiff-line-modified-removed">-     if (putCommon(*thisObject, *state, propertyName))</span>
<span class="udiff-line-modified-added">+     if (putCommon(*thisObject, *lexicalGlobalObject, propertyName))</span>
          return false;
  
<span class="udiff-line-modified-removed">-     return JSObject::put(thisObject, state, propertyName, value, putPropertySlot);</span>
<span class="udiff-line-modified-added">+     return JSObject::put(thisObject, lexicalGlobalObject, propertyName, value, putPropertySlot);</span>
  }
  
<span class="udiff-line-modified-removed">- bool JSLocation::putByIndex(JSCell* cell, ExecState* state, unsigned index, JSValue value, bool shouldThrow)</span>
<span class="udiff-line-modified-added">+ bool JSLocation::putByIndex(JSCell* cell, JSGlobalObject* lexicalGlobalObject, unsigned index, JSValue value, bool shouldThrow)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = state-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
      auto* thisObject = jsCast&lt;JSLocation*&gt;(cell);
      ASSERT_GC_OBJECT_INHERITS(thisObject, info());
  
<span class="udiff-line-modified-removed">-     if (putCommon(*thisObject, *state, Identifier::from(vm, index)))</span>
<span class="udiff-line-modified-added">+     if (putCommon(*thisObject, *lexicalGlobalObject, Identifier::from(vm, index)))</span>
          return false;
  
<span class="udiff-line-modified-removed">-     return JSObject::putByIndex(cell, state, index, value, shouldThrow);</span>
<span class="udiff-line-modified-added">+     return JSObject::putByIndex(cell, lexicalGlobalObject, index, value, shouldThrow);</span>
  }
  
<span class="udiff-line-modified-removed">- bool JSLocation::deleteProperty(JSCell* cell, ExecState* exec, PropertyName propertyName)</span>
<span class="udiff-line-modified-added">+ bool JSLocation::deleteProperty(JSCell* cell, JSGlobalObject* lexicalGlobalObject, PropertyName propertyName)</span>
  {
      JSLocation* thisObject = jsCast&lt;JSLocation*&gt;(cell);
      // Only allow deleting by frames in the same origin.
<span class="udiff-line-modified-removed">-     if (!BindingSecurity::shouldAllowAccessToDOMWindow(exec, thisObject-&gt;wrapped().window(), ThrowSecurityError))</span>
<span class="udiff-line-modified-added">+     if (!BindingSecurity::shouldAllowAccessToDOMWindow(lexicalGlobalObject, thisObject-&gt;wrapped().window(), ThrowSecurityError))</span>
          return false;
<span class="udiff-line-modified-removed">-     return Base::deleteProperty(thisObject, exec, propertyName);</span>
<span class="udiff-line-modified-added">+     return Base::deleteProperty(thisObject, lexicalGlobalObject, propertyName);</span>
  }
  
<span class="udiff-line-modified-removed">- bool JSLocation::deletePropertyByIndex(JSCell* cell, ExecState* exec, unsigned propertyName)</span>
<span class="udiff-line-modified-added">+ bool JSLocation::deletePropertyByIndex(JSCell* cell, JSGlobalObject* lexicalGlobalObject, unsigned propertyName)</span>
  {
      JSLocation* thisObject = jsCast&lt;JSLocation*&gt;(cell);
      // Only allow deleting by frames in the same origin.
<span class="udiff-line-modified-removed">-     if (!BindingSecurity::shouldAllowAccessToDOMWindow(exec, thisObject-&gt;wrapped().window(), ThrowSecurityError))</span>
<span class="udiff-line-modified-added">+     if (!BindingSecurity::shouldAllowAccessToDOMWindow(lexicalGlobalObject, thisObject-&gt;wrapped().window(), ThrowSecurityError))</span>
          return false;
<span class="udiff-line-modified-removed">-     return Base::deletePropertyByIndex(thisObject, exec, propertyName);</span>
<span class="udiff-line-modified-added">+     return Base::deletePropertyByIndex(thisObject, lexicalGlobalObject, propertyName);</span>
  }
  
<span class="udiff-line-modified-removed">- void JSLocation::getOwnPropertyNames(JSObject* object, ExecState* exec, PropertyNameArray&amp; propertyNames, EnumerationMode mode)</span>
<span class="udiff-line-modified-added">+ void JSLocation::getOwnPropertyNames(JSObject* object, JSGlobalObject* lexicalGlobalObject, PropertyNameArray&amp; propertyNames, EnumerationMode mode)</span>
  {
      JSLocation* thisObject = jsCast&lt;JSLocation*&gt;(object);
<span class="udiff-line-modified-removed">-     if (!BindingSecurity::shouldAllowAccessToDOMWindow(exec, thisObject-&gt;wrapped().window(), DoNotReportSecurityError)) {</span>
<span class="udiff-line-modified-added">+     if (!BindingSecurity::shouldAllowAccessToDOMWindow(lexicalGlobalObject, thisObject-&gt;wrapped().window(), DoNotReportSecurityError)) {</span>
          if (mode.includeDontEnumProperties())
<span class="udiff-line-modified-removed">-             addCrossOriginOwnPropertyNames&lt;CrossOriginObject::Location&gt;(*exec, propertyNames);</span>
<span class="udiff-line-modified-added">+             addCrossOriginOwnPropertyNames&lt;CrossOriginObject::Location&gt;(*lexicalGlobalObject, propertyNames);</span>
          return;
      }
<span class="udiff-line-modified-removed">-     Base::getOwnPropertyNames(thisObject, exec, propertyNames, mode);</span>
<span class="udiff-line-modified-added">+     Base::getOwnPropertyNames(thisObject, lexicalGlobalObject, propertyNames, mode);</span>
  }
  
<span class="udiff-line-modified-removed">- bool JSLocation::defineOwnProperty(JSObject* object, ExecState* exec, PropertyName propertyName, const PropertyDescriptor&amp; descriptor, bool throwException)</span>
<span class="udiff-line-modified-added">+ bool JSLocation::defineOwnProperty(JSObject* object, JSGlobalObject* lexicalGlobalObject, PropertyName propertyName, const PropertyDescriptor&amp; descriptor, bool throwException)</span>
  {
      JSLocation* thisObject = jsCast&lt;JSLocation*&gt;(object);
<span class="udiff-line-modified-removed">-     if (!BindingSecurity::shouldAllowAccessToDOMWindow(exec, thisObject-&gt;wrapped().window(), ThrowSecurityError))</span>
<span class="udiff-line-modified-added">+     if (!BindingSecurity::shouldAllowAccessToDOMWindow(lexicalGlobalObject, thisObject-&gt;wrapped().window(), ThrowSecurityError))</span>
          return false;
  
<span class="udiff-line-modified-removed">-     VM&amp; vm = exec-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
      if (descriptor.isAccessorDescriptor() &amp;&amp; (propertyName == vm.propertyNames-&gt;toString || propertyName == vm.propertyNames-&gt;valueOf))
          return false;
<span class="udiff-line-modified-removed">-     return Base::defineOwnProperty(object, exec, propertyName, descriptor, throwException);</span>
<span class="udiff-line-modified-added">+     return Base::defineOwnProperty(object, lexicalGlobalObject, propertyName, descriptor, throwException);</span>
  }
  
<span class="udiff-line-modified-removed">- JSValue JSLocation::getPrototype(JSObject* object, ExecState* exec)</span>
<span class="udiff-line-modified-added">+ JSValue JSLocation::getPrototype(JSObject* object, JSGlobalObject* lexicalGlobalObject)</span>
  {
      JSLocation* thisObject = jsCast&lt;JSLocation*&gt;(object);
<span class="udiff-line-modified-removed">-     if (!BindingSecurity::shouldAllowAccessToDOMWindow(exec, thisObject-&gt;wrapped().window(), DoNotReportSecurityError))</span>
<span class="udiff-line-modified-added">+     if (!BindingSecurity::shouldAllowAccessToDOMWindow(lexicalGlobalObject, thisObject-&gt;wrapped().window(), DoNotReportSecurityError))</span>
          return jsNull();
  
<span class="udiff-line-modified-removed">-     return Base::getPrototype(object, exec);</span>
<span class="udiff-line-modified-added">+     return Base::getPrototype(object, lexicalGlobalObject);</span>
  }
  
<span class="udiff-line-modified-removed">- bool JSLocation::preventExtensions(JSObject*, ExecState* exec)</span>
<span class="udiff-line-modified-added">+ bool JSLocation::preventExtensions(JSObject*, JSGlobalObject* lexicalGlobalObject)</span>
  {
<span class="udiff-line-modified-removed">-     auto scope = DECLARE_THROW_SCOPE(exec-&gt;vm());</span>
<span class="udiff-line-modified-added">+     auto scope = DECLARE_THROW_SCOPE(lexicalGlobalObject-&gt;vm());</span>
  
<span class="udiff-line-modified-removed">-     throwTypeError(exec, scope, &quot;Cannot prevent extensions on this object&quot;_s);</span>
<span class="udiff-line-modified-added">+     throwTypeError(lexicalGlobalObject, scope, &quot;Cannot prevent extensions on this object&quot;_s);</span>
      return false;
  }
  
<span class="udiff-line-modified-removed">- String JSLocation::toStringName(const JSObject* object, ExecState* exec)</span>
<span class="udiff-line-modified-added">+ String JSLocation::toStringName(const JSObject* object, JSGlobalObject* lexicalGlobalObject)</span>
  {
      auto* thisObject = jsCast&lt;const JSLocation*&gt;(object);
<span class="udiff-line-modified-removed">-     if (!BindingSecurity::shouldAllowAccessToDOMWindow(exec, thisObject-&gt;wrapped().window(), DoNotReportSecurityError))</span>
<span class="udiff-line-modified-added">+     if (!BindingSecurity::shouldAllowAccessToDOMWindow(lexicalGlobalObject, thisObject-&gt;wrapped().window(), DoNotReportSecurityError))</span>
          return &quot;Object&quot;_s;
      return &quot;Location&quot;_s;
  }
  
<span class="udiff-line-modified-removed">- bool JSLocationPrototype::put(JSCell* cell, ExecState* state, PropertyName propertyName, JSValue value, PutPropertySlot&amp; slot)</span>
<span class="udiff-line-modified-added">+ bool JSLocationPrototype::put(JSCell* cell, JSGlobalObject* lexicalGlobalObject, PropertyName propertyName, JSValue value, PutPropertySlot&amp; slot)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = state-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
      auto* thisObject = jsCast&lt;JSLocationPrototype*&gt;(cell);
      if (propertyName == vm.propertyNames-&gt;toString || propertyName == vm.propertyNames-&gt;valueOf)
          return false;
<span class="udiff-line-modified-removed">-     return Base::put(thisObject, state, propertyName, value, slot);</span>
<span class="udiff-line-modified-added">+     return Base::put(thisObject, lexicalGlobalObject, propertyName, value, slot);</span>
  }
  
<span class="udiff-line-modified-removed">- bool JSLocationPrototype::defineOwnProperty(JSObject* object, ExecState* exec, PropertyName propertyName, const PropertyDescriptor&amp; descriptor, bool throwException)</span>
<span class="udiff-line-modified-added">+ bool JSLocationPrototype::defineOwnProperty(JSObject* object, JSGlobalObject* lexicalGlobalObject, PropertyName propertyName, const PropertyDescriptor&amp; descriptor, bool throwException)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = exec-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
      if (descriptor.isAccessorDescriptor() &amp;&amp; (propertyName == vm.propertyNames-&gt;toString || propertyName == vm.propertyNames-&gt;valueOf))
          return false;
<span class="udiff-line-modified-removed">-     return Base::defineOwnProperty(object, exec, propertyName, descriptor, throwException);</span>
<span class="udiff-line-modified-added">+     return Base::defineOwnProperty(object, lexicalGlobalObject, propertyName, descriptor, throwException);</span>
  }
  
  } // namespace WebCore
</pre>
<center><a href="JSLazyEventListener.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSMediaStreamTrackCustom.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>