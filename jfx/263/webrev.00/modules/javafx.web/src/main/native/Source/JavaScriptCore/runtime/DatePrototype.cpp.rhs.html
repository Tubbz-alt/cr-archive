<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/DatePrototype.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  *  Copyright (C) 1999-2000 Harri Porten (porten@kde.org)
   3  *  Copyright (C) 2004-2019 Apple Inc. All rights reserved.
   4  *  Copyright (C) 2008, 2009 Torch Mobile, Inc. All rights reserved.
   5  *  Copyright (C) 2010 Torch Mobile (Beijing) Co. Ltd. All rights reserved.
   6  *
   7  *  This library is free software; you can redistribute it and/or
   8  *  modify it under the terms of the GNU Lesser General Public
   9  *  License as published by the Free Software Foundation; either
  10  *  version 2 of the License, or (at your option) any later version.
  11  *
  12  *  This library is distributed in the hope that it will be useful,
  13  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  14  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  15  *  Lesser General Public License for more details.
  16  *
  17  *  You should have received a copy of the GNU Lesser General Public
  18  *  License along with this library; if not, write to the Free Software
  19  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301
  20  *  USA
  21  *
  22  */
  23 
  24 #include &quot;config.h&quot;
  25 #include &quot;DatePrototype.h&quot;
  26 
  27 #include &quot;DateConversion.h&quot;
  28 #include &quot;DateInstance.h&quot;
  29 #include &quot;Error.h&quot;
  30 #include &quot;JSCBuiltins.h&quot;
  31 #include &quot;JSDateMath.h&quot;
  32 #include &quot;JSGlobalObject.h&quot;
  33 #include &quot;JSObject.h&quot;
  34 #include &quot;JSString.h&quot;
  35 #include &quot;Lookup.h&quot;
  36 #include &quot;ObjectPrototype.h&quot;
  37 #include &quot;JSCInlines.h&quot;
  38 #include &lt;limits.h&gt;
  39 #include &lt;locale.h&gt;
  40 #include &lt;math.h&gt;
  41 #include &lt;stdlib.h&gt;
  42 #include &lt;time.h&gt;
  43 #include &lt;wtf/Assertions.h&gt;
  44 #include &lt;wtf/MathExtras.h&gt;
  45 
  46 #if HAVE(LANGINFO_H)
  47 #include &lt;langinfo.h&gt;
  48 #endif
  49 
  50 #if HAVE(SYS_PARAM_H)
  51 #include &lt;sys/param.h&gt;
  52 #endif
  53 
  54 #if HAVE(SYS_TIME_H)
  55 #include &lt;sys/time.h&gt;
  56 #endif
  57 
  58 #if HAVE(SYS_TIMEB_H)
  59 #include &lt;sys/timeb.h&gt;
  60 #endif
  61 
  62 #if !(OS(DARWIN) &amp;&amp; USE(CF))
  63 #include &lt;unicode/udat.h&gt;
  64 #endif
  65 
  66 #if USE(CF)
  67 #include &lt;CoreFoundation/CoreFoundation.h&gt;
  68 #endif
  69 
  70 namespace JSC {
  71 
<a name="1" id="anc1"></a><span class="line-modified">  72 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetDate(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  73 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetDay(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  74 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetFullYear(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  75 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetHours(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  76 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMilliSeconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  77 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMinutes(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  78 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMonth(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  79 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetSeconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  80 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetTimezoneOffset(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  81 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCDate(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  82 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCDay(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  83 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCFullYear(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  84 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCHours(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  85 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMilliseconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  86 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMinutes(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  87 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMonth(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  88 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCSeconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  89 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetYear(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  90 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetDate(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  91 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetFullYear(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  92 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetHours(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  93 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMilliSeconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  94 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMinutes(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  95 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMonth(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  96 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetSeconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  97 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetTime(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  98 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCDate(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified">  99 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCFullYear(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 100 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCHours(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 101 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMilliseconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 102 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMinutes(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 103 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMonth(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 104 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCSeconds(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 105 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetYear(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 106 EncodedJSValue JSC_HOST_CALL dateProtoFuncToDateString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 107 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleDateString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 108 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 109 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleTimeString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 110 EncodedJSValue JSC_HOST_CALL dateProtoFuncToPrimitiveSymbol(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 111 EncodedJSValue JSC_HOST_CALL dateProtoFuncToString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 112 EncodedJSValue JSC_HOST_CALL dateProtoFuncToTimeString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 113 EncodedJSValue JSC_HOST_CALL dateProtoFuncToUTCString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 114 EncodedJSValue JSC_HOST_CALL dateProtoFuncToISOString(JSGlobalObject*, CallFrame*);</span>
<span class="line-modified"> 115 EncodedJSValue JSC_HOST_CALL dateProtoFuncToJSON(JSGlobalObject*, CallFrame*);</span>


 116 
 117 }
 118 
 119 #include &quot;DatePrototype.lut.h&quot;
 120 
 121 namespace JSC {
 122 
 123 enum LocaleDateTimeFormat { LocaleDateAndTime, LocaleDate, LocaleTime };
 124 
 125 #if OS(DARWIN) &amp;&amp; USE(CF)
 126 
 127 // FIXME: Since this is superior to the strftime-based version, why limit this to OS(DARWIN)?
 128 // Instead we should consider using this whenever USE(CF) is true.
 129 
 130 static CFDateFormatterStyle styleFromArgString(const String&amp; string, CFDateFormatterStyle defaultStyle)
 131 {
 132     if (string == &quot;short&quot;)
 133         return kCFDateFormatterShortStyle;
 134     if (string == &quot;medium&quot;)
 135         return kCFDateFormatterMediumStyle;
 136     if (string == &quot;long&quot;)
 137         return kCFDateFormatterLongStyle;
 138     if (string == &quot;full&quot;)
 139         return kCFDateFormatterFullStyle;
 140     return defaultStyle;
 141 }
 142 
<a name="2" id="anc2"></a><span class="line-modified"> 143 static JSCell* formatLocaleDate(JSGlobalObject* globalObject, CallFrame* callFrame, DateInstance*, double timeInMilliseconds, LocaleDateTimeFormat format)</span>
 144 {
<a name="3" id="anc3"></a><span class="line-modified"> 145     VM&amp; vm = globalObject-&gt;vm();</span>
 146     CFDateFormatterStyle dateStyle = (format != LocaleTime ? kCFDateFormatterLongStyle : kCFDateFormatterNoStyle);
 147     CFDateFormatterStyle timeStyle = (format != LocaleDate ? kCFDateFormatterLongStyle : kCFDateFormatterNoStyle);
 148 
 149     bool useCustomFormat = false;
 150     String customFormatString;
 151 
<a name="4" id="anc4"></a><span class="line-modified"> 152     String arg0String = callFrame-&gt;argument(0).toWTFString(globalObject);</span>
<span class="line-modified"> 153     if (arg0String == &quot;custom&quot; &amp;&amp; !callFrame-&gt;argument(1).isUndefined()) {</span>
 154         useCustomFormat = true;
<a name="5" id="anc5"></a><span class="line-modified"> 155         customFormatString = callFrame-&gt;argument(1).toWTFString(globalObject);</span>
<span class="line-modified"> 156     } else if (format == LocaleDateAndTime &amp;&amp; !callFrame-&gt;argument(1).isUndefined()) {</span>
 157         dateStyle = styleFromArgString(arg0String, dateStyle);
<a name="6" id="anc6"></a><span class="line-modified"> 158         timeStyle = styleFromArgString(callFrame-&gt;argument(1).toWTFString(globalObject), timeStyle);</span>
<span class="line-modified"> 159     } else if (format != LocaleTime &amp;&amp; !callFrame-&gt;argument(0).isUndefined())</span>
 160         dateStyle = styleFromArgString(arg0String, dateStyle);
<a name="7" id="anc7"></a><span class="line-modified"> 161     else if (format != LocaleDate &amp;&amp; !callFrame-&gt;argument(0).isUndefined())</span>
 162         timeStyle = styleFromArgString(arg0String, timeStyle);
 163 
 164     CFAbsoluteTime absoluteTime = floor(timeInMilliseconds / msPerSecond) - kCFAbsoluteTimeIntervalSince1970;
 165 
 166     auto formatter = adoptCF(CFDateFormatterCreate(kCFAllocatorDefault, adoptCF(CFLocaleCopyCurrent()).get(), dateStyle, timeStyle));
 167     if (useCustomFormat)
 168         CFDateFormatterSetFormat(formatter.get(), customFormatString.createCFString().get());
 169     return jsNontrivialString(vm, adoptCF(CFDateFormatterCreateStringWithAbsoluteTime(kCFAllocatorDefault, formatter.get(), absoluteTime)).get());
 170 }
 171 
 172 #elif !UCONFIG_NO_FORMATTING
 173 
<a name="8" id="anc8"></a><span class="line-modified"> 174 static JSCell* formatLocaleDate(JSGlobalObject* globalObject, CallFrame*, DateInstance*, double timeInMilliseconds, LocaleDateTimeFormat format)</span>
 175 {
<a name="9" id="anc9"></a><span class="line-modified"> 176     VM&amp; vm = globalObject-&gt;vm();</span>
 177     UDateFormatStyle timeStyle = (format != LocaleDate ? UDAT_LONG : UDAT_NONE);
 178     UDateFormatStyle dateStyle = (format != LocaleTime ? UDAT_LONG : UDAT_NONE);
 179 
 180     UErrorCode status = U_ZERO_ERROR;
 181     UDateFormat* df = udat_open(timeStyle, dateStyle, 0, 0, -1, 0, 0, &amp;status);
 182     if (!df)
 183         return jsEmptyString(vm);
 184 
 185     UChar buffer[128];
 186     int32_t length;
 187     length = udat_format(df, timeInMilliseconds, buffer, 128, 0, &amp;status);
 188     udat_close(df);
 189     if (status != U_ZERO_ERROR)
 190         return jsEmptyString(vm);
 191 
 192     return jsNontrivialString(vm, String(buffer, length));
 193 }
 194 
 195 #else
 196 
<a name="10" id="anc10"></a><span class="line-modified"> 197 static JSCell* formatLocaleDate(JSGlobalObject* globalObject, CallFrame* callFrame, const GregorianDateTime&amp; gdt, LocaleDateTimeFormat format)</span>
 198 {
<a name="11" id="anc11"></a><span class="line-modified"> 199     VM&amp; vm = globalObject-&gt;vm();</span>
 200 #if OS(WINDOWS)
 201     SYSTEMTIME systemTime;
 202     memset(&amp;systemTime, 0, sizeof(systemTime));
 203     systemTime.wYear = gdt.year();
 204     systemTime.wMonth = gdt.month() + 1;
 205     systemTime.wDay = gdt.monthDay();
 206     systemTime.wDayOfWeek = gdt.weekDay();
 207     systemTime.wHour = gdt.hour();
 208     systemTime.wMinute = gdt.minute();
 209     systemTime.wSecond = gdt.second();
 210 
 211     Vector&lt;UChar, 128&gt; buffer;
 212     size_t length = 0;
 213 
 214     if (format == LocaleDate) {
 215         buffer.resize(GetDateFormatW(LOCALE_USER_DEFAULT, DATE_LONGDATE, &amp;systemTime, 0, 0, 0));
 216         length = GetDateFormatW(LOCALE_USER_DEFAULT, DATE_LONGDATE, &amp;systemTime, 0, buffer.data(), buffer.size());
 217     } else if (format == LocaleTime) {
 218         buffer.resize(GetTimeFormatW(LOCALE_USER_DEFAULT, 0, &amp;systemTime, 0, 0, 0));
 219         length = GetTimeFormatW(LOCALE_USER_DEFAULT, 0, &amp;systemTime, 0, buffer.data(), buffer.size());
 220     } else if (format == LocaleDateAndTime) {
 221         buffer.resize(GetDateFormatW(LOCALE_USER_DEFAULT, DATE_LONGDATE, &amp;systemTime, 0, 0, 0) + GetTimeFormatW(LOCALE_USER_DEFAULT, 0, &amp;systemTime, 0, 0, 0));
 222         length = GetDateFormatW(LOCALE_USER_DEFAULT, DATE_LONGDATE, &amp;systemTime, 0, buffer.data(), buffer.size());
 223         if (length) {
 224             buffer[length - 1] = &#39; &#39;;
 225             length += GetTimeFormatW(LOCALE_USER_DEFAULT, 0, &amp;systemTime, 0, buffer.data() + length, buffer.size() - length);
 226         }
 227     } else
 228         RELEASE_ASSERT_NOT_REACHED();
 229 
 230     //  Remove terminating null character.
 231     if (length)
 232         length--;
 233 
 234     return jsNontrivialString(vm, String(buffer.data(), length));
 235 
 236 #else // OS(WINDOWS)
 237 
 238 #if HAVE(LANGINFO_H)
 239     static const nl_item formats[] = { D_T_FMT, D_FMT, T_FMT };
 240 #else
 241     static const char* const formatStrings[] = { &quot;%#c&quot;, &quot;%#x&quot;, &quot;%X&quot; };
 242 #endif
 243 
 244     // Offset year if needed
 245     struct tm localTM = gdt;
 246     int year = gdt.year();
 247     bool yearNeedsOffset = year &lt; 1900 || year &gt; 2038;
 248     if (yearNeedsOffset)
 249         localTM.tm_year = equivalentYearForDST(year) - 1900;
 250 
 251 #if HAVE(LANGINFO_H)
 252     // We do not allow strftime to generate dates with 2-digits years,
 253     // both to avoid ambiguity, and a crash in strncpy, for years that
 254     // need offset.
 255     char* formatString = strdup(nl_langinfo(formats[format]));
 256     char* yPos = strchr(formatString, &#39;y&#39;);
 257     if (yPos)
 258         *yPos = &#39;Y&#39;;
 259 #endif
 260 
 261     // Do the formatting
 262     const int bufsize = 128;
 263     char timebuffer[bufsize];
 264 
 265 #if HAVE(LANGINFO_H)
 266     size_t ret = strftime(timebuffer, bufsize, formatString, &amp;localTM);
 267     free(formatString);
 268 #else
 269     size_t ret = strftime(timebuffer, bufsize, formatStrings[format], &amp;localTM);
 270 #endif
 271 
 272     if (ret == 0)
 273         return jsEmptyString(vm);
 274 
 275     // Copy original into the buffer
 276     if (yearNeedsOffset &amp;&amp; format != LocaleTime) {
 277         static const int yearLen = 5;   // FIXME will be a problem in the year 10,000
 278         char yearString[yearLen];
 279 
 280         snprintf(yearString, yearLen, &quot;%d&quot;, localTM.tm_year + 1900);
 281         char* yearLocation = strstr(timebuffer, yearString);
 282         snprintf(yearString, yearLen, &quot;%d&quot;, year);
 283 
 284         strncpy(yearLocation, yearString, yearLen - 1);
 285     }
 286 
 287     // Convert multi-byte result to UNICODE.
 288     // If __STDC_ISO_10646__ is defined, wide character represents
 289     // UTF-16 (or UTF-32) code point. In most modern Unix like system
 290     // (e.g. Linux with glibc 2.2 and above) the macro is defined,
 291     // and wide character represents UTF-32 code point.
 292     // Here we static_cast potential UTF-32 to UTF-16, it should be
 293     // safe because date and (or) time related characters in different languages
 294     // should be in UNICODE BMP. If mbstowcs fails, we just fall
 295     // back on using multi-byte result as-is.
 296 #ifdef __STDC_ISO_10646__
 297     UChar buffer[bufsize];
 298     wchar_t tempbuffer[bufsize];
 299     size_t length = mbstowcs(tempbuffer, timebuffer, bufsize - 1);
 300     if (length != static_cast&lt;size_t&gt;(-1)) {
 301         for (size_t i = 0; i &lt; length; ++i)
 302             buffer[i] = static_cast&lt;UChar&gt;(tempbuffer[i]);
 303         return jsNontrivialString(vm, String(buffer, length));
 304     }
 305 #endif
 306 
 307     return jsNontrivialString(vm, timebuffer);
 308 #endif // OS(WINDOWS)
 309 }
 310 
<a name="12" id="anc12"></a><span class="line-modified"> 311 static JSCell* formatLocaleDate(JSGlobalObject* globalObject, CallFrame* callFrame, DateInstance* dateObject, double, LocaleDateTimeFormat format)</span>
 312 {
<a name="13" id="anc13"></a><span class="line-modified"> 313     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified"> 314     const GregorianDateTime* gregorianDateTime = dateObject-&gt;gregorianDateTime(vm);</span>
 315     if (!gregorianDateTime)
 316         return jsNontrivialString(vm, &quot;Invalid Date&quot;_s);
<a name="14" id="anc14"></a><span class="line-modified"> 317     return formatLocaleDate(globalObject, callFrame, *gregorianDateTime, format);</span>
 318 }
 319 
 320 #endif // OS(DARWIN) &amp;&amp; USE(CF)
 321 
<a name="15" id="anc15"></a><span class="line-modified"> 322 static EncodedJSValue formateDateInstance(JSGlobalObject* globalObject, CallFrame* callFrame, DateTimeFormat format, bool asUTCVariant)</span>
 323 {
<a name="16" id="anc16"></a><span class="line-modified"> 324     VM&amp; vm = globalObject-&gt;vm();</span>
 325     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="17" id="anc17"></a><span class="line-modified"> 326     JSValue thisValue = callFrame-&gt;thisValue();</span>
 327     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 328     if (UNLIKELY(!thisDateObj))
<a name="18" id="anc18"></a><span class="line-modified"> 329         return throwVMTypeError(globalObject, scope);</span>
 330 
 331     const GregorianDateTime* gregorianDateTime = asUTCVariant
<a name="19" id="anc19"></a><span class="line-modified"> 332         ? thisDateObj-&gt;gregorianDateTimeUTC(vm)</span>
<span class="line-modified"> 333         : thisDateObj-&gt;gregorianDateTime(vm);</span>
 334     if (!gregorianDateTime)
 335         return JSValue::encode(jsNontrivialString(vm, String(&quot;Invalid Date&quot;_s)));
 336 
 337     return JSValue::encode(jsNontrivialString(vm, formatDateTime(*gregorianDateTime, format, asUTCVariant)));
 338 }
 339 
 340 // Converts a list of arguments sent to a Date member function into milliseconds, updating
 341 // ms (representing milliseconds) and t (representing the rest of the date structure) appropriately.
 342 //
 343 // Format of member function: f([hour,] [min,] [sec,] [ms])
<a name="20" id="anc20"></a><span class="line-modified"> 344 static bool fillStructuresUsingTimeArgs(JSGlobalObject* globalObject, CallFrame* callFrame, int maxArgs, double* ms, GregorianDateTime* t)</span>
 345 {
<a name="21" id="anc21"></a><span class="line-modified"> 346     VM&amp; vm = globalObject-&gt;vm();</span>
 347     auto scope = DECLARE_THROW_SCOPE(vm);
 348 
 349     double milliseconds = 0;
 350     bool ok = true;
 351     int idx = 0;
<a name="22" id="anc22"></a><span class="line-modified"> 352     int numArgs = callFrame-&gt;argumentCount();</span>
 353 
 354     // JS allows extra trailing arguments -- ignore them
 355     if (numArgs &gt; maxArgs)
 356         numArgs = maxArgs;
 357 
 358     // hours
 359     if (maxArgs &gt;= 4 &amp;&amp; idx &lt; numArgs) {
 360         t-&gt;setHour(0);
<a name="23" id="anc23"></a><span class="line-modified"> 361         double hours = callFrame-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(globalObject);</span>
 362         RETURN_IF_EXCEPTION(scope, false);
 363         ok = std::isfinite(hours);
 364         milliseconds += hours * msPerHour;
 365     }
 366 
 367     // minutes
 368     if (maxArgs &gt;= 3 &amp;&amp; idx &lt; numArgs &amp;&amp; ok) {
 369         t-&gt;setMinute(0);
<a name="24" id="anc24"></a><span class="line-modified"> 370         double minutes = callFrame-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(globalObject);</span>
 371         RETURN_IF_EXCEPTION(scope, false);
 372         ok = std::isfinite(minutes);
 373         milliseconds += minutes * msPerMinute;
 374     }
 375 
 376     // seconds
 377     if (maxArgs &gt;= 2 &amp;&amp; idx &lt; numArgs &amp;&amp; ok) {
 378         t-&gt;setSecond(0);
<a name="25" id="anc25"></a><span class="line-modified"> 379         double seconds = callFrame-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(globalObject);</span>
 380         RETURN_IF_EXCEPTION(scope, false);
 381         ok = std::isfinite(seconds);
 382         milliseconds += seconds * msPerSecond;
 383     }
 384 
 385     if (!ok)
 386         return false;
 387 
 388     // milliseconds
 389     if (idx &lt; numArgs) {
<a name="26" id="anc26"></a><span class="line-modified"> 390         double millis = callFrame-&gt;uncheckedArgument(idx).toIntegerPreserveNaN(globalObject);</span>
 391         RETURN_IF_EXCEPTION(scope, false);
 392         ok = std::isfinite(millis);
 393         milliseconds += millis;
 394     } else
 395         milliseconds += *ms;
 396 
 397     *ms = milliseconds;
 398     return ok;
 399 }
 400 
 401 // Converts a list of arguments sent to a Date member function into years, months, and milliseconds, updating
 402 // ms (representing milliseconds) and t (representing the rest of the date structure) appropriately.
 403 //
 404 // Format of member function: f([years,] [months,] [days])
<a name="27" id="anc27"></a><span class="line-modified"> 405 static bool fillStructuresUsingDateArgs(JSGlobalObject* globalObject, CallFrame* callFrame, int maxArgs, double *ms, GregorianDateTime *t)</span>
 406 {
<a name="28" id="anc28"></a><span class="line-modified"> 407     VM&amp; vm = globalObject-&gt;vm();</span>
 408     auto scope = DECLARE_THROW_SCOPE(vm);
 409 
 410     int idx = 0;
 411     bool ok = true;
<a name="29" id="anc29"></a><span class="line-modified"> 412     int numArgs = callFrame-&gt;argumentCount();</span>
 413 
 414     // JS allows extra trailing arguments -- ignore them
 415     if (numArgs &gt; maxArgs)
 416         numArgs = maxArgs;
 417 
 418     // years
 419     if (maxArgs &gt;= 3 &amp;&amp; idx &lt; numArgs) {
<a name="30" id="anc30"></a><span class="line-modified"> 420         double years = callFrame-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(globalObject);</span>
 421         RETURN_IF_EXCEPTION(scope, false);
 422         ok = std::isfinite(years);
 423         t-&gt;setYear(toInt32(years));
 424     }
 425     // months
 426     if (maxArgs &gt;= 2 &amp;&amp; idx &lt; numArgs &amp;&amp; ok) {
<a name="31" id="anc31"></a><span class="line-modified"> 427         double months = callFrame-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(globalObject);</span>
 428         RETURN_IF_EXCEPTION(scope, false);
 429         ok = std::isfinite(months);
 430         t-&gt;setMonth(toInt32(months));
 431     }
 432     // days
 433     if (idx &lt; numArgs &amp;&amp; ok) {
<a name="32" id="anc32"></a><span class="line-modified"> 434         double days = callFrame-&gt;uncheckedArgument(idx++).toIntegerPreserveNaN(globalObject);</span>
 435         RETURN_IF_EXCEPTION(scope, false);
 436         ok = std::isfinite(days);
 437         t-&gt;setMonthDay(0);
 438         *ms += days * msPerDay;
 439     }
 440 
 441     return ok;
 442 }
 443 
 444 const ClassInfo DatePrototype::s_info = {&quot;Object&quot;, &amp;JSNonFinalObject::s_info, &amp;dateTable, nullptr, CREATE_METHOD_TABLE(DatePrototype)};
 445 
 446 /* Source for DatePrototype.lut.h
 447 @begin dateTable
 448   toString              dateProtoFuncToString                DontEnum|Function       0
 449   toISOString           dateProtoFuncToISOString             DontEnum|Function       0
 450   toDateString          dateProtoFuncToDateString            DontEnum|Function       0
 451   toTimeString          dateProtoFuncToTimeString            DontEnum|Function       0
 452   toLocaleString        dateProtoFuncToLocaleString          DontEnum|Function       0
 453   toLocaleDateString    dateProtoFuncToLocaleDateString      DontEnum|Function       0
 454   toLocaleTimeString    dateProtoFuncToLocaleTimeString      DontEnum|Function       0
<a name="33" id="anc33"></a><span class="line-modified"> 455   valueOf               dateProtoFuncGetTime                 DontEnum|Function       0  DatePrototypeGetTimeIntrinsic</span>
<span class="line-modified"> 456   getTime               dateProtoFuncGetTime                 DontEnum|Function       0  DatePrototypeGetTimeIntrinsic</span>
<span class="line-modified"> 457   getFullYear           dateProtoFuncGetFullYear             DontEnum|Function       0  DatePrototypeGetFullYearIntrinsic</span>
<span class="line-modified"> 458   getUTCFullYear        dateProtoFuncGetUTCFullYear          DontEnum|Function       0  DatePrototypeGetUTCFullYearIntrinsic</span>
<span class="line-modified"> 459   getMonth              dateProtoFuncGetMonth                DontEnum|Function       0  DatePrototypeGetMonthIntrinsic</span>
<span class="line-modified"> 460   getUTCMonth           dateProtoFuncGetUTCMonth             DontEnum|Function       0  DatePrototypeGetUTCMonthIntrinsic</span>
<span class="line-modified"> 461   getDate               dateProtoFuncGetDate                 DontEnum|Function       0  DatePrototypeGetDateIntrinsic</span>
<span class="line-modified"> 462   getUTCDate            dateProtoFuncGetUTCDate              DontEnum|Function       0  DatePrototypeGetUTCDateIntrinsic</span>
<span class="line-modified"> 463   getDay                dateProtoFuncGetDay                  DontEnum|Function       0  DatePrototypeGetDayIntrinsic</span>
<span class="line-modified"> 464   getUTCDay             dateProtoFuncGetUTCDay               DontEnum|Function       0  DatePrototypeGetUTCDayIntrinsic</span>
<span class="line-modified"> 465   getHours              dateProtoFuncGetHours                DontEnum|Function       0  DatePrototypeGetHoursIntrinsic</span>
<span class="line-modified"> 466   getUTCHours           dateProtoFuncGetUTCHours             DontEnum|Function       0  DatePrototypeGetUTCHoursIntrinsic</span>
<span class="line-modified"> 467   getMinutes            dateProtoFuncGetMinutes              DontEnum|Function       0  DatePrototypeGetMinutesIntrinsic</span>
<span class="line-modified"> 468   getUTCMinutes         dateProtoFuncGetUTCMinutes           DontEnum|Function       0  DatePrototypeGetUTCMinutesIntrinsic</span>
<span class="line-modified"> 469   getSeconds            dateProtoFuncGetSeconds              DontEnum|Function       0  DatePrototypeGetSecondsIntrinsic</span>
<span class="line-modified"> 470   getUTCSeconds         dateProtoFuncGetUTCSeconds           DontEnum|Function       0  DatePrototypeGetUTCSecondsIntrinsic</span>
<span class="line-modified"> 471   getMilliseconds       dateProtoFuncGetMilliSeconds         DontEnum|Function       0  DatePrototypeGetMillisecondsIntrinsic</span>
<span class="line-modified"> 472   getUTCMilliseconds    dateProtoFuncGetUTCMilliseconds      DontEnum|Function       0  DatePrototypeGetUTCMillisecondsIntrinsic</span>
<span class="line-modified"> 473   getTimezoneOffset     dateProtoFuncGetTimezoneOffset       DontEnum|Function       0  DatePrototypeGetTimezoneOffsetIntrinsic</span>
<span class="line-added"> 474   getYear               dateProtoFuncGetYear                 DontEnum|Function       0  DatePrototypeGetYearIntrinsic</span>
 475   setTime               dateProtoFuncSetTime                 DontEnum|Function       1
 476   setMilliseconds       dateProtoFuncSetMilliSeconds         DontEnum|Function       1
 477   setUTCMilliseconds    dateProtoFuncSetUTCMilliseconds      DontEnum|Function       1
 478   setSeconds            dateProtoFuncSetSeconds              DontEnum|Function       2
 479   setUTCSeconds         dateProtoFuncSetUTCSeconds           DontEnum|Function       2
 480   setMinutes            dateProtoFuncSetMinutes              DontEnum|Function       3
 481   setUTCMinutes         dateProtoFuncSetUTCMinutes           DontEnum|Function       3
 482   setHours              dateProtoFuncSetHours                DontEnum|Function       4
 483   setUTCHours           dateProtoFuncSetUTCHours             DontEnum|Function       4
 484   setDate               dateProtoFuncSetDate                 DontEnum|Function       1
 485   setUTCDate            dateProtoFuncSetUTCDate              DontEnum|Function       1
 486   setMonth              dateProtoFuncSetMonth                DontEnum|Function       2
 487   setUTCMonth           dateProtoFuncSetUTCMonth             DontEnum|Function       2
 488   setFullYear           dateProtoFuncSetFullYear             DontEnum|Function       3
 489   setUTCFullYear        dateProtoFuncSetUTCFullYear          DontEnum|Function       3
 490   setYear               dateProtoFuncSetYear                 DontEnum|Function       1
<a name="34" id="anc34"></a>
 491   toJSON                dateProtoFuncToJSON                  DontEnum|Function       1
 492 @end
 493 */
 494 
 495 // ECMA 15.9.4
 496 
 497 DatePrototype::DatePrototype(VM&amp; vm, Structure* structure)
 498     : Base(vm, structure)
 499 {
 500 }
 501 
 502 void DatePrototype::finishCreation(VM&amp; vm, JSGlobalObject* globalObject)
 503 {
 504     Base::finishCreation(vm);
 505     ASSERT(inherits(vm, info()));
 506 
 507     Identifier toUTCStringName = Identifier::fromString(vm, &quot;toUTCString&quot;_s);
 508     JSFunction* toUTCStringFunction = JSFunction::create(vm, globalObject, 0, toUTCStringName.string(), dateProtoFuncToUTCString);
 509     putDirectWithoutTransition(vm, toUTCStringName, toUTCStringFunction, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 510     putDirectWithoutTransition(vm, Identifier::fromString(vm, &quot;toGMTString&quot;_s), toUTCStringFunction, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 511 
 512 #if ENABLE(INTL)
 513     JSC_BUILTIN_FUNCTION_WITHOUT_TRANSITION(&quot;toLocaleString&quot;, datePrototypeToLocaleStringCodeGenerator, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 514     JSC_BUILTIN_FUNCTION_WITHOUT_TRANSITION(&quot;toLocaleDateString&quot;, datePrototypeToLocaleDateStringCodeGenerator, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 515     JSC_BUILTIN_FUNCTION_WITHOUT_TRANSITION(&quot;toLocaleTimeString&quot;, datePrototypeToLocaleTimeStringCodeGenerator, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 516 #endif
 517 
 518     JSFunction* toPrimitiveFunction = JSFunction::create(vm, globalObject, 1, &quot;[Symbol.toPrimitive]&quot;_s, dateProtoFuncToPrimitiveSymbol, NoIntrinsic);
 519     putDirectWithoutTransition(vm, vm.propertyNames-&gt;toPrimitiveSymbol, toPrimitiveFunction, PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly);
 520 
 521     // The constructor will be added later, after DateConstructor has been built.
 522 }
 523 
 524 // Functions
 525 
<a name="35" id="anc35"></a><span class="line-modified"> 526 EncodedJSValue JSC_HOST_CALL dateProtoFuncToString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 527 {
 528     const bool asUTCVariant = false;
<a name="36" id="anc36"></a><span class="line-modified"> 529     return formateDateInstance(globalObject, callFrame, DateTimeFormatDateAndTime, asUTCVariant);</span>
 530 }
 531 
<a name="37" id="anc37"></a><span class="line-modified"> 532 EncodedJSValue JSC_HOST_CALL dateProtoFuncToUTCString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 533 {
 534     const bool asUTCVariant = true;
<a name="38" id="anc38"></a><span class="line-modified"> 535     return formateDateInstance(globalObject, callFrame, DateTimeFormatDateAndTime, asUTCVariant);</span>
 536 }
 537 
<a name="39" id="anc39"></a><span class="line-modified"> 538 EncodedJSValue JSC_HOST_CALL dateProtoFuncToISOString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 539 {
<a name="40" id="anc40"></a><span class="line-modified"> 540     VM&amp; vm = globalObject-&gt;vm();</span>
 541     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="41" id="anc41"></a><span class="line-modified"> 542     JSValue thisValue = callFrame-&gt;thisValue();</span>
 543     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 544     if (UNLIKELY(!thisDateObj))
<a name="42" id="anc42"></a><span class="line-modified"> 545         return throwVMTypeError(globalObject, scope);</span>
 546 
 547     if (!std::isfinite(thisDateObj-&gt;internalNumber()))
<a name="43" id="anc43"></a><span class="line-modified"> 548         return throwVMError(globalObject, scope, createRangeError(globalObject, &quot;Invalid Date&quot;_s));</span>
 549 
<a name="44" id="anc44"></a><span class="line-modified"> 550     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 551     if (!gregorianDateTime)
 552         return JSValue::encode(jsNontrivialString(vm, String(&quot;Invalid Date&quot;_s)));
 553     // Maximum amount of space we need in buffer: 7 (max. digits in year) + 2 * 5 (2 characters each for month, day, hour, minute, second) + 4 (. + 3 digits for milliseconds)
 554     // 6 for formatting and one for null termination = 28. We add one extra character to allow us to force null termination.
 555     char buffer[28];
 556     // If the year is outside the bounds of 0 and 9999 inclusive we want to use the extended year format (ES 15.9.1.15.1).
 557     int ms = static_cast&lt;int&gt;(fmod(thisDateObj-&gt;internalNumber(), msPerSecond));
 558     if (ms &lt; 0)
 559         ms += msPerSecond;
 560 
 561     int charactersWritten;
 562     if (gregorianDateTime-&gt;year() &gt; 9999 || gregorianDateTime-&gt;year() &lt; 0)
 563         charactersWritten = snprintf(buffer, sizeof(buffer), &quot;%+07d-%02d-%02dT%02d:%02d:%02d.%03dZ&quot;, gregorianDateTime-&gt;year(), gregorianDateTime-&gt;month() + 1, gregorianDateTime-&gt;monthDay(), gregorianDateTime-&gt;hour(), gregorianDateTime-&gt;minute(), gregorianDateTime-&gt;second(), ms);
 564     else
 565         charactersWritten = snprintf(buffer, sizeof(buffer), &quot;%04d-%02d-%02dT%02d:%02d:%02d.%03dZ&quot;, gregorianDateTime-&gt;year(), gregorianDateTime-&gt;month() + 1, gregorianDateTime-&gt;monthDay(), gregorianDateTime-&gt;hour(), gregorianDateTime-&gt;minute(), gregorianDateTime-&gt;second(), ms);
 566 
 567     ASSERT(charactersWritten &gt; 0 &amp;&amp; static_cast&lt;unsigned&gt;(charactersWritten) &lt; sizeof(buffer));
 568     if (static_cast&lt;unsigned&gt;(charactersWritten) &gt;= sizeof(buffer))
 569         return JSValue::encode(jsEmptyString(vm));
 570 
 571     return JSValue::encode(jsNontrivialString(vm, String(buffer, charactersWritten)));
 572 }
 573 
<a name="45" id="anc45"></a><span class="line-modified"> 574 EncodedJSValue JSC_HOST_CALL dateProtoFuncToDateString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 575 {
 576     const bool asUTCVariant = false;
<a name="46" id="anc46"></a><span class="line-modified"> 577     return formateDateInstance(globalObject, callFrame, DateTimeFormatDate, asUTCVariant);</span>
 578 }
 579 
<a name="47" id="anc47"></a><span class="line-modified"> 580 EncodedJSValue JSC_HOST_CALL dateProtoFuncToTimeString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 581 {
 582     const bool asUTCVariant = false;
<a name="48" id="anc48"></a><span class="line-modified"> 583     return formateDateInstance(globalObject, callFrame, DateTimeFormatTime, asUTCVariant);</span>
 584 }
 585 
<a name="49" id="anc49"></a><span class="line-modified"> 586 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 587 {
<a name="50" id="anc50"></a><span class="line-modified"> 588     VM&amp; vm = globalObject-&gt;vm();</span>
 589     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="51" id="anc51"></a><span class="line-modified"> 590     JSValue thisValue = callFrame-&gt;thisValue();</span>
 591     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 592     if (UNLIKELY(!thisDateObj))
<a name="52" id="anc52"></a><span class="line-modified"> 593         return throwVMTypeError(globalObject, scope);</span>
 594 
<a name="53" id="anc53"></a><span class="line-modified"> 595     return JSValue::encode(formatLocaleDate(globalObject, callFrame, thisDateObj, thisDateObj-&gt;internalNumber(), LocaleDateAndTime));</span>
 596 }
 597 
<a name="54" id="anc54"></a><span class="line-modified"> 598 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleDateString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 599 {
<a name="55" id="anc55"></a><span class="line-modified"> 600     VM&amp; vm = globalObject-&gt;vm();</span>
 601     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="56" id="anc56"></a><span class="line-modified"> 602     JSValue thisValue = callFrame-&gt;thisValue();</span>
 603     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 604     if (UNLIKELY(!thisDateObj))
<a name="57" id="anc57"></a><span class="line-modified"> 605         return throwVMTypeError(globalObject, scope);</span>
 606 
<a name="58" id="anc58"></a><span class="line-modified"> 607     return JSValue::encode(formatLocaleDate(globalObject, callFrame, thisDateObj, thisDateObj-&gt;internalNumber(), LocaleDate));</span>
 608 }
 609 
<a name="59" id="anc59"></a><span class="line-modified"> 610 EncodedJSValue JSC_HOST_CALL dateProtoFuncToLocaleTimeString(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 611 {
<a name="60" id="anc60"></a><span class="line-modified"> 612     VM&amp; vm = globalObject-&gt;vm();</span>
 613     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="61" id="anc61"></a><span class="line-modified"> 614     JSValue thisValue = callFrame-&gt;thisValue();</span>
 615     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 616     if (UNLIKELY(!thisDateObj))
<a name="62" id="anc62"></a><span class="line-modified"> 617         return throwVMTypeError(globalObject, scope);</span>
 618 
<a name="63" id="anc63"></a><span class="line-modified"> 619     return JSValue::encode(formatLocaleDate(globalObject, callFrame, thisDateObj, thisDateObj-&gt;internalNumber(), LocaleTime));</span>
 620 }
 621 
<a name="64" id="anc64"></a><span class="line-modified"> 622 EncodedJSValue JSC_HOST_CALL dateProtoFuncToPrimitiveSymbol(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 623 {
<a name="65" id="anc65"></a><span class="line-modified"> 624     VM&amp; vm = globalObject-&gt;vm();</span>
 625     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="66" id="anc66"></a><span class="line-modified"> 626     JSValue thisValue = callFrame-&gt;thisValue();</span>
 627     if (!thisValue.isObject())
<a name="67" id="anc67"></a><span class="line-modified"> 628         return throwVMTypeError(globalObject, scope, &quot;Date.prototype[Symbol.toPrimitive] expected |this| to be an object.&quot;);</span>
 629     JSObject* thisObject = jsCast&lt;JSObject*&gt;(thisValue);
 630 
<a name="68" id="anc68"></a><span class="line-modified"> 631     if (!callFrame-&gt;argumentCount())</span>
<span class="line-modified"> 632         return throwVMTypeError(globalObject, scope, &quot;Date.prototype[Symbol.toPrimitive] expected a first argument.&quot;);</span>
 633 
<a name="69" id="anc69"></a><span class="line-modified"> 634     JSValue hintValue = callFrame-&gt;uncheckedArgument(0);</span>
<span class="line-modified"> 635     PreferredPrimitiveType type = toPreferredPrimitiveType(globalObject, hintValue);</span>
 636     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 637 
 638     if (type == NoPreference)
 639         type = PreferString;
 640 
<a name="70" id="anc70"></a><span class="line-modified"> 641     RELEASE_AND_RETURN(scope, JSValue::encode(thisObject-&gt;ordinaryToPrimitive(globalObject, type)));</span>
 642 }
 643 
<a name="71" id="anc71"></a><span class="line-modified"> 644 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetTime(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 645 {
<a name="72" id="anc72"></a><span class="line-modified"> 646     VM&amp; vm = globalObject-&gt;vm();</span>
 647     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="73" id="anc73"></a><span class="line-modified"> 648     JSValue thisValue = callFrame-&gt;thisValue();</span>
 649     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 650     if (UNLIKELY(!thisDateObj))
<a name="74" id="anc74"></a><span class="line-modified"> 651         return throwVMTypeError(globalObject, scope);</span>
 652 
 653     return JSValue::encode(jsNumber(thisDateObj-&gt;internalNumber()));
 654 }
 655 
<a name="75" id="anc75"></a><span class="line-modified"> 656 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetFullYear(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 657 {
<a name="76" id="anc76"></a><span class="line-modified"> 658     VM&amp; vm = globalObject-&gt;vm();</span>
 659     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="77" id="anc77"></a><span class="line-modified"> 660     JSValue thisValue = callFrame-&gt;thisValue();</span>
 661     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 662     if (UNLIKELY(!thisDateObj))
<a name="78" id="anc78"></a><span class="line-modified"> 663         return throwVMTypeError(globalObject, scope);</span>
 664 
<a name="79" id="anc79"></a><span class="line-modified"> 665     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 666     if (!gregorianDateTime)
 667         return JSValue::encode(jsNaN());
 668     return JSValue::encode(jsNumber(gregorianDateTime-&gt;year()));
 669 }
 670 
<a name="80" id="anc80"></a><span class="line-modified"> 671 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCFullYear(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 672 {
<a name="81" id="anc81"></a><span class="line-modified"> 673     VM&amp; vm = globalObject-&gt;vm();</span>
 674     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="82" id="anc82"></a><span class="line-modified"> 675     JSValue thisValue = callFrame-&gt;thisValue();</span>
 676     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 677     if (UNLIKELY(!thisDateObj))
<a name="83" id="anc83"></a><span class="line-modified"> 678         return throwVMTypeError(globalObject, scope);</span>
 679 
<a name="84" id="anc84"></a><span class="line-modified"> 680     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 681     if (!gregorianDateTime)
 682         return JSValue::encode(jsNaN());
 683     return JSValue::encode(jsNumber(gregorianDateTime-&gt;year()));
 684 }
 685 
<a name="85" id="anc85"></a><span class="line-modified"> 686 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMonth(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 687 {
<a name="86" id="anc86"></a><span class="line-modified"> 688     VM&amp; vm = globalObject-&gt;vm();</span>
 689     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="87" id="anc87"></a><span class="line-modified"> 690     JSValue thisValue = callFrame-&gt;thisValue();</span>
 691     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 692     if (UNLIKELY(!thisDateObj))
<a name="88" id="anc88"></a><span class="line-modified"> 693         return throwVMTypeError(globalObject, scope);</span>
 694 
<a name="89" id="anc89"></a><span class="line-modified"> 695     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 696     if (!gregorianDateTime)
 697         return JSValue::encode(jsNaN());
 698     return JSValue::encode(jsNumber(gregorianDateTime-&gt;month()));
 699 }
 700 
<a name="90" id="anc90"></a><span class="line-modified"> 701 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMonth(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 702 {
<a name="91" id="anc91"></a><span class="line-modified"> 703     VM&amp; vm = globalObject-&gt;vm();</span>
 704     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="92" id="anc92"></a><span class="line-modified"> 705     JSValue thisValue = callFrame-&gt;thisValue();</span>
 706     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 707     if (UNLIKELY(!thisDateObj))
<a name="93" id="anc93"></a><span class="line-modified"> 708         return throwVMTypeError(globalObject, scope);</span>
 709 
<a name="94" id="anc94"></a><span class="line-modified"> 710     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 711     if (!gregorianDateTime)
 712         return JSValue::encode(jsNaN());
 713     return JSValue::encode(jsNumber(gregorianDateTime-&gt;month()));
 714 }
 715 
<a name="95" id="anc95"></a><span class="line-modified"> 716 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetDate(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 717 {
<a name="96" id="anc96"></a><span class="line-modified"> 718     VM&amp; vm = globalObject-&gt;vm();</span>
 719     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="97" id="anc97"></a><span class="line-modified"> 720     JSValue thisValue = callFrame-&gt;thisValue();</span>
 721     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 722     if (UNLIKELY(!thisDateObj))
<a name="98" id="anc98"></a><span class="line-modified"> 723         return throwVMTypeError(globalObject, scope);</span>
 724 
<a name="99" id="anc99"></a><span class="line-modified"> 725     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 726     if (!gregorianDateTime)
 727         return JSValue::encode(jsNaN());
 728     return JSValue::encode(jsNumber(gregorianDateTime-&gt;monthDay()));
 729 }
 730 
<a name="100" id="anc100"></a><span class="line-modified"> 731 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCDate(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 732 {
<a name="101" id="anc101"></a><span class="line-modified"> 733     VM&amp; vm = globalObject-&gt;vm();</span>
 734     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="102" id="anc102"></a><span class="line-modified"> 735     JSValue thisValue = callFrame-&gt;thisValue();</span>
 736     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 737     if (UNLIKELY(!thisDateObj))
<a name="103" id="anc103"></a><span class="line-modified"> 738         return throwVMTypeError(globalObject, scope);</span>
 739 
<a name="104" id="anc104"></a><span class="line-modified"> 740     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 741     if (!gregorianDateTime)
 742         return JSValue::encode(jsNaN());
 743     return JSValue::encode(jsNumber(gregorianDateTime-&gt;monthDay()));
 744 }
 745 
<a name="105" id="anc105"></a><span class="line-modified"> 746 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetDay(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 747 {
<a name="106" id="anc106"></a><span class="line-modified"> 748     VM&amp; vm = globalObject-&gt;vm();</span>
 749     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="107" id="anc107"></a><span class="line-modified"> 750     JSValue thisValue = callFrame-&gt;thisValue();</span>
 751     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 752     if (UNLIKELY(!thisDateObj))
<a name="108" id="anc108"></a><span class="line-modified"> 753         return throwVMTypeError(globalObject, scope);</span>
 754 
<a name="109" id="anc109"></a><span class="line-modified"> 755     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 756     if (!gregorianDateTime)
 757         return JSValue::encode(jsNaN());
 758     return JSValue::encode(jsNumber(gregorianDateTime-&gt;weekDay()));
 759 }
 760 
<a name="110" id="anc110"></a><span class="line-modified"> 761 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCDay(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 762 {
<a name="111" id="anc111"></a><span class="line-modified"> 763     VM&amp; vm = globalObject-&gt;vm();</span>
 764     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="112" id="anc112"></a><span class="line-modified"> 765     JSValue thisValue = callFrame-&gt;thisValue();</span>
 766     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 767     if (UNLIKELY(!thisDateObj))
<a name="113" id="anc113"></a><span class="line-modified"> 768         return throwVMTypeError(globalObject, scope);</span>
 769 
<a name="114" id="anc114"></a><span class="line-modified"> 770     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 771     if (!gregorianDateTime)
 772         return JSValue::encode(jsNaN());
 773     return JSValue::encode(jsNumber(gregorianDateTime-&gt;weekDay()));
 774 }
 775 
<a name="115" id="anc115"></a><span class="line-modified"> 776 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetHours(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 777 {
<a name="116" id="anc116"></a><span class="line-modified"> 778     VM&amp; vm = globalObject-&gt;vm();</span>
 779     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="117" id="anc117"></a><span class="line-modified"> 780     JSValue thisValue = callFrame-&gt;thisValue();</span>
 781     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 782     if (UNLIKELY(!thisDateObj))
<a name="118" id="anc118"></a><span class="line-modified"> 783         return throwVMTypeError(globalObject, scope);</span>
 784 
<a name="119" id="anc119"></a><span class="line-modified"> 785     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 786     if (!gregorianDateTime)
 787         return JSValue::encode(jsNaN());
 788     return JSValue::encode(jsNumber(gregorianDateTime-&gt;hour()));
 789 }
 790 
<a name="120" id="anc120"></a><span class="line-modified"> 791 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCHours(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 792 {
<a name="121" id="anc121"></a><span class="line-modified"> 793     VM&amp; vm = globalObject-&gt;vm();</span>
 794     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="122" id="anc122"></a><span class="line-modified"> 795     JSValue thisValue = callFrame-&gt;thisValue();</span>
 796     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 797     if (UNLIKELY(!thisDateObj))
<a name="123" id="anc123"></a><span class="line-modified"> 798         return throwVMTypeError(globalObject, scope);</span>
 799 
<a name="124" id="anc124"></a><span class="line-modified"> 800     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 801     if (!gregorianDateTime)
 802         return JSValue::encode(jsNaN());
 803     return JSValue::encode(jsNumber(gregorianDateTime-&gt;hour()));
 804 }
 805 
<a name="125" id="anc125"></a><span class="line-modified"> 806 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMinutes(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 807 {
<a name="126" id="anc126"></a><span class="line-modified"> 808     VM&amp; vm = globalObject-&gt;vm();</span>
 809     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="127" id="anc127"></a><span class="line-modified"> 810     JSValue thisValue = callFrame-&gt;thisValue();</span>
 811     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 812     if (UNLIKELY(!thisDateObj))
<a name="128" id="anc128"></a><span class="line-modified"> 813         return throwVMTypeError(globalObject, scope);</span>
 814 
<a name="129" id="anc129"></a><span class="line-modified"> 815     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 816     if (!gregorianDateTime)
 817         return JSValue::encode(jsNaN());
 818     return JSValue::encode(jsNumber(gregorianDateTime-&gt;minute()));
 819 }
 820 
<a name="130" id="anc130"></a><span class="line-modified"> 821 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMinutes(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 822 {
<a name="131" id="anc131"></a><span class="line-modified"> 823     VM&amp; vm = globalObject-&gt;vm();</span>
 824     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="132" id="anc132"></a><span class="line-modified"> 825     JSValue thisValue = callFrame-&gt;thisValue();</span>
 826     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 827     if (UNLIKELY(!thisDateObj))
<a name="133" id="anc133"></a><span class="line-modified"> 828         return throwVMTypeError(globalObject, scope);</span>
 829 
<a name="134" id="anc134"></a><span class="line-modified"> 830     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 831     if (!gregorianDateTime)
 832         return JSValue::encode(jsNaN());
 833     return JSValue::encode(jsNumber(gregorianDateTime-&gt;minute()));
 834 }
 835 
<a name="135" id="anc135"></a><span class="line-modified"> 836 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetSeconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 837 {
<a name="136" id="anc136"></a><span class="line-modified"> 838     VM&amp; vm = globalObject-&gt;vm();</span>
 839     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="137" id="anc137"></a><span class="line-modified"> 840     JSValue thisValue = callFrame-&gt;thisValue();</span>
 841     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 842     if (UNLIKELY(!thisDateObj))
<a name="138" id="anc138"></a><span class="line-modified"> 843         return throwVMTypeError(globalObject, scope);</span>
 844 
<a name="139" id="anc139"></a><span class="line-modified"> 845     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 846     if (!gregorianDateTime)
 847         return JSValue::encode(jsNaN());
 848     return JSValue::encode(jsNumber(gregorianDateTime-&gt;second()));
 849 }
 850 
<a name="140" id="anc140"></a><span class="line-modified"> 851 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCSeconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 852 {
<a name="141" id="anc141"></a><span class="line-modified"> 853     VM&amp; vm = globalObject-&gt;vm();</span>
 854     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="142" id="anc142"></a><span class="line-modified"> 855     JSValue thisValue = callFrame-&gt;thisValue();</span>
 856     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 857     if (UNLIKELY(!thisDateObj))
<a name="143" id="anc143"></a><span class="line-modified"> 858         return throwVMTypeError(globalObject, scope);</span>
 859 
<a name="144" id="anc144"></a><span class="line-modified"> 860     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTimeUTC(vm);</span>
 861     if (!gregorianDateTime)
 862         return JSValue::encode(jsNaN());
 863     return JSValue::encode(jsNumber(gregorianDateTime-&gt;second()));
 864 }
 865 
<a name="145" id="anc145"></a><span class="line-modified"> 866 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetMilliSeconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 867 {
<a name="146" id="anc146"></a><span class="line-modified"> 868     VM&amp; vm = globalObject-&gt;vm();</span>
 869     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="147" id="anc147"></a><span class="line-modified"> 870     JSValue thisValue = callFrame-&gt;thisValue();</span>
 871     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 872     if (UNLIKELY(!thisDateObj))
<a name="148" id="anc148"></a><span class="line-modified"> 873         return throwVMTypeError(globalObject, scope);</span>
 874 
 875     double milli = thisDateObj-&gt;internalNumber();
 876     if (std::isnan(milli))
 877         return JSValue::encode(jsNaN());
 878 
 879     double secs = floor(milli / msPerSecond);
 880     double ms = milli - secs * msPerSecond;
<a name="149" id="anc149"></a><span class="line-modified"> 881     // Since timeClip makes internalNumber integer milliseconds, this result is always int32_t.</span>
<span class="line-added"> 882     return JSValue::encode(jsNumber(static_cast&lt;int32_t&gt;(ms)));</span>
 883 }
 884 
<a name="150" id="anc150"></a><span class="line-modified"> 885 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetUTCMilliseconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 886 {
<a name="151" id="anc151"></a><span class="line-modified"> 887     VM&amp; vm = globalObject-&gt;vm();</span>
 888     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="152" id="anc152"></a><span class="line-modified"> 889     JSValue thisValue = callFrame-&gt;thisValue();</span>
 890     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 891     if (UNLIKELY(!thisDateObj))
<a name="153" id="anc153"></a><span class="line-modified"> 892         return throwVMTypeError(globalObject, scope);</span>
 893 
 894     double milli = thisDateObj-&gt;internalNumber();
 895     if (std::isnan(milli))
 896         return JSValue::encode(jsNaN());
 897 
 898     double secs = floor(milli / msPerSecond);
 899     double ms = milli - secs * msPerSecond;
<a name="154" id="anc154"></a><span class="line-modified"> 900     // Since timeClip makes internalNumber integer milliseconds, this result is always int32_t.</span>
<span class="line-added"> 901     return JSValue::encode(jsNumber(static_cast&lt;int32_t&gt;(ms)));</span>
 902 }
 903 
<a name="155" id="anc155"></a><span class="line-modified"> 904 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetTimezoneOffset(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 905 {
<a name="156" id="anc156"></a><span class="line-modified"> 906     VM&amp; vm = globalObject-&gt;vm();</span>
 907     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="157" id="anc157"></a><span class="line-modified"> 908     JSValue thisValue = callFrame-&gt;thisValue();</span>
 909     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 910     if (UNLIKELY(!thisDateObj))
<a name="158" id="anc158"></a><span class="line-modified"> 911         return throwVMTypeError(globalObject, scope);</span>
 912 
<a name="159" id="anc159"></a><span class="line-modified"> 913     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
 914     if (!gregorianDateTime)
 915         return JSValue::encode(jsNaN());
<a name="160" id="anc160"></a><span class="line-modified"> 916     return JSValue::encode(jsNumber(-gregorianDateTime-&gt;utcOffsetInMinute()));</span>
 917 }
 918 
<a name="161" id="anc161"></a><span class="line-modified"> 919 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetTime(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
 920 {
<a name="162" id="anc162"></a><span class="line-modified"> 921     VM&amp; vm = globalObject-&gt;vm();</span>
 922     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="163" id="anc163"></a><span class="line-modified"> 923     JSValue thisValue = callFrame-&gt;thisValue();</span>
 924     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 925     if (UNLIKELY(!thisDateObj))
<a name="164" id="anc164"></a><span class="line-modified"> 926         return throwVMTypeError(globalObject, scope);</span>
 927 
<a name="165" id="anc165"></a><span class="line-modified"> 928     double milli = timeClip(callFrame-&gt;argument(0).toNumber(globalObject));</span>
 929     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 930     thisDateObj-&gt;setInternalNumber(milli);
 931     return JSValue::encode(jsNumber(milli));
 932 }
 933 
<a name="166" id="anc166"></a><span class="line-modified"> 934 static EncodedJSValue setNewValueFromTimeArgs(JSGlobalObject* globalObject, CallFrame* callFrame, int numArgsToUse, WTF::TimeType inputTimeType)</span>
 935 {
<a name="167" id="anc167"></a><span class="line-modified"> 936     VM&amp; vm = globalObject-&gt;vm();</span>
 937     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="168" id="anc168"></a><span class="line-modified"> 938     JSValue thisValue = callFrame-&gt;thisValue();</span>
 939     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 940     if (UNLIKELY(!thisDateObj))
<a name="169" id="anc169"></a><span class="line-modified"> 941         return throwVMTypeError(globalObject, scope);</span>
 942 
 943     double milli = thisDateObj-&gt;internalNumber();
 944 
<a name="170" id="anc170"></a><span class="line-modified"> 945     if (!callFrame-&gt;argumentCount() || std::isnan(milli)) {</span>
 946         thisDateObj-&gt;setInternalNumber(PNaN);
 947         return JSValue::encode(jsNaN());
 948     }
 949 
 950     double secs = floor(milli / msPerSecond);
 951     double ms = milli - secs * msPerSecond;
 952 
 953     const GregorianDateTime* other = inputTimeType == WTF::UTCTime
<a name="171" id="anc171"></a><span class="line-modified"> 954         ? thisDateObj-&gt;gregorianDateTimeUTC(vm)</span>
<span class="line-modified"> 955         : thisDateObj-&gt;gregorianDateTime(vm);</span>
 956     if (!other)
 957         return JSValue::encode(jsNaN());
 958 
<a name="172" id="anc172"></a><span class="line-modified"> 959     GregorianDateTime gregorianDateTime(*other);</span>
<span class="line-modified"> 960     bool success = fillStructuresUsingTimeArgs(globalObject, callFrame, numArgsToUse, &amp;ms, &amp;gregorianDateTime);</span>

 961     RETURN_IF_EXCEPTION(scope, encodedJSValue());
 962     if (!success) {
 963         thisDateObj-&gt;setInternalNumber(PNaN);
 964         return JSValue::encode(jsNaN());
 965     }
 966 
 967     double newUTCDate = gregorianDateTimeToMS(vm, gregorianDateTime, ms, inputTimeType);
 968     double result = timeClip(newUTCDate);
 969     thisDateObj-&gt;setInternalNumber(result);
 970     return JSValue::encode(jsNumber(result));
 971 }
 972 
<a name="173" id="anc173"></a><span class="line-modified"> 973 static EncodedJSValue setNewValueFromDateArgs(JSGlobalObject* globalObject, CallFrame* callFrame, int numArgsToUse, WTF::TimeType inputTimeType)</span>
 974 {
<a name="174" id="anc174"></a><span class="line-modified"> 975     VM&amp; vm = globalObject-&gt;vm();</span>
 976     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="175" id="anc175"></a><span class="line-modified"> 977     JSValue thisValue = callFrame-&gt;thisValue();</span>
 978     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
 979     if (UNLIKELY(!thisDateObj))
<a name="176" id="anc176"></a><span class="line-modified"> 980         return throwVMTypeError(globalObject, scope);</span>
 981 
<a name="177" id="anc177"></a><span class="line-modified"> 982     if (!callFrame-&gt;argumentCount()) {</span>
 983         thisDateObj-&gt;setInternalNumber(PNaN);
 984         return JSValue::encode(jsNaN());
 985     }
 986 
 987     double milli = thisDateObj-&gt;internalNumber();
 988     double ms = 0;
 989 
 990     GregorianDateTime gregorianDateTime;
 991     if (numArgsToUse == 3 &amp;&amp; std::isnan(milli))
 992         msToGregorianDateTime(vm, 0, WTF::UTCTime, gregorianDateTime);
 993     else {
 994         ms = milli - floor(milli / msPerSecond) * msPerSecond;
 995         const GregorianDateTime* other = inputTimeType == WTF::UTCTime
<a name="178" id="anc178"></a><span class="line-modified"> 996             ? thisDateObj-&gt;gregorianDateTimeUTC(vm)</span>
<span class="line-modified"> 997             : thisDateObj-&gt;gregorianDateTime(vm);</span>
 998         if (!other)
 999             return JSValue::encode(jsNaN());
<a name="179" id="anc179"></a><span class="line-modified">1000         gregorianDateTime = *other;</span>
1001     }
1002 
<a name="180" id="anc180"></a><span class="line-modified">1003     bool success = fillStructuresUsingDateArgs(globalObject, callFrame, numArgsToUse, &amp;ms, &amp;gregorianDateTime);</span>
1004     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1005     if (!success) {
1006         thisDateObj-&gt;setInternalNumber(PNaN);
1007         return JSValue::encode(jsNaN());
1008     }
1009 
1010     double newUTCDate = gregorianDateTimeToMS(vm, gregorianDateTime, ms, inputTimeType);
1011     double result = timeClip(newUTCDate);
1012     thisDateObj-&gt;setInternalNumber(result);
1013     return JSValue::encode(jsNumber(result));
1014 }
1015 
<a name="181" id="anc181"></a><span class="line-modified">1016 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMilliSeconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1017 {
<a name="182" id="anc182"></a><span class="line-modified">1018     return setNewValueFromTimeArgs(globalObject, callFrame, 1, WTF::LocalTime);</span>
1019 }
1020 
<a name="183" id="anc183"></a><span class="line-modified">1021 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMilliseconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1022 {
<a name="184" id="anc184"></a><span class="line-modified">1023     return setNewValueFromTimeArgs(globalObject, callFrame, 1, WTF::UTCTime);</span>
1024 }
1025 
<a name="185" id="anc185"></a><span class="line-modified">1026 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetSeconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1027 {
<a name="186" id="anc186"></a><span class="line-modified">1028     return setNewValueFromTimeArgs(globalObject, callFrame, 2, WTF::LocalTime);</span>
1029 }
1030 
<a name="187" id="anc187"></a><span class="line-modified">1031 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCSeconds(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1032 {
<a name="188" id="anc188"></a><span class="line-modified">1033     return setNewValueFromTimeArgs(globalObject, callFrame, 2, WTF::UTCTime);</span>
1034 }
1035 
<a name="189" id="anc189"></a><span class="line-modified">1036 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMinutes(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1037 {
<a name="190" id="anc190"></a><span class="line-modified">1038     return setNewValueFromTimeArgs(globalObject, callFrame, 3, WTF::LocalTime);</span>
1039 }
1040 
<a name="191" id="anc191"></a><span class="line-modified">1041 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMinutes(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1042 {
<a name="192" id="anc192"></a><span class="line-modified">1043     return setNewValueFromTimeArgs(globalObject, callFrame, 3, WTF::UTCTime);</span>
1044 }
1045 
<a name="193" id="anc193"></a><span class="line-modified">1046 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetHours(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1047 {
<a name="194" id="anc194"></a><span class="line-modified">1048     return setNewValueFromTimeArgs(globalObject, callFrame, 4, WTF::LocalTime);</span>
1049 }
1050 
<a name="195" id="anc195"></a><span class="line-modified">1051 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCHours(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1052 {
<a name="196" id="anc196"></a><span class="line-modified">1053     return setNewValueFromTimeArgs(globalObject, callFrame, 4, WTF::UTCTime);</span>
1054 }
1055 
<a name="197" id="anc197"></a><span class="line-modified">1056 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetDate(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1057 {
<a name="198" id="anc198"></a><span class="line-modified">1058     return setNewValueFromDateArgs(globalObject, callFrame, 1, WTF::LocalTime);</span>
1059 }
1060 
<a name="199" id="anc199"></a><span class="line-modified">1061 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCDate(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1062 {
<a name="200" id="anc200"></a><span class="line-modified">1063     return setNewValueFromDateArgs(globalObject, callFrame, 1, WTF::UTCTime);</span>
1064 }
1065 
<a name="201" id="anc201"></a><span class="line-modified">1066 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetMonth(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1067 {
<a name="202" id="anc202"></a><span class="line-modified">1068     return setNewValueFromDateArgs(globalObject, callFrame, 2, WTF::LocalTime);</span>
1069 }
1070 
<a name="203" id="anc203"></a><span class="line-modified">1071 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCMonth(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1072 {
<a name="204" id="anc204"></a><span class="line-modified">1073     return setNewValueFromDateArgs(globalObject, callFrame, 2, WTF::UTCTime);</span>
1074 }
1075 
<a name="205" id="anc205"></a><span class="line-modified">1076 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetFullYear(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1077 {
<a name="206" id="anc206"></a><span class="line-modified">1078     return setNewValueFromDateArgs(globalObject, callFrame, 3, WTF::LocalTime);</span>
1079 }
1080 
<a name="207" id="anc207"></a><span class="line-modified">1081 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetUTCFullYear(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1082 {
<a name="208" id="anc208"></a><span class="line-modified">1083     return setNewValueFromDateArgs(globalObject, callFrame, 3, WTF::UTCTime);</span>
1084 }
1085 
<a name="209" id="anc209"></a><span class="line-modified">1086 EncodedJSValue JSC_HOST_CALL dateProtoFuncSetYear(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1087 {
<a name="210" id="anc210"></a><span class="line-modified">1088     VM&amp; vm = globalObject-&gt;vm();</span>
1089     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="211" id="anc211"></a><span class="line-modified">1090     JSValue thisValue = callFrame-&gt;thisValue();</span>
1091     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
1092     if (UNLIKELY(!thisDateObj))
<a name="212" id="anc212"></a><span class="line-modified">1093         return throwVMTypeError(globalObject, scope);</span>
1094 
<a name="213" id="anc213"></a><span class="line-modified">1095     if (!callFrame-&gt;argumentCount()) {</span>
1096         thisDateObj-&gt;setInternalNumber(PNaN);
1097         return JSValue::encode(jsNaN());
1098     }
1099 
1100     double milli = thisDateObj-&gt;internalNumber();
1101     double ms = 0;
1102 
1103     GregorianDateTime gregorianDateTime;
1104     if (std::isnan(milli))
1105         // Based on ECMA 262 B.2.5 (setYear)
1106         // the time must be reset to +0 if it is NaN.
1107         msToGregorianDateTime(vm, 0, WTF::UTCTime, gregorianDateTime);
1108     else {
1109         double secs = floor(milli / msPerSecond);
1110         ms = milli - secs * msPerSecond;
<a name="214" id="anc214"></a><span class="line-modified">1111         if (const GregorianDateTime* other = thisDateObj-&gt;gregorianDateTime(vm))</span>
<span class="line-modified">1112             gregorianDateTime = *other;</span>
1113     }
1114 
<a name="215" id="anc215"></a><span class="line-modified">1115     double year = callFrame-&gt;argument(0).toIntegerPreserveNaN(globalObject);</span>
1116     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1117     if (!std::isfinite(year)) {
1118         thisDateObj-&gt;setInternalNumber(PNaN);
1119         return JSValue::encode(jsNaN());
1120     }
1121 
1122     gregorianDateTime.setYear(toInt32((year &gt;= 0 &amp;&amp; year &lt;= 99) ? (year + 1900) : year));
1123     double timeInMilliseconds = gregorianDateTimeToMS(vm, gregorianDateTime, ms, WTF::LocalTime);
1124     double result = timeClip(timeInMilliseconds);
1125     thisDateObj-&gt;setInternalNumber(result);
1126     return JSValue::encode(jsNumber(result));
1127 }
1128 
<a name="216" id="anc216"></a><span class="line-modified">1129 EncodedJSValue JSC_HOST_CALL dateProtoFuncGetYear(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1130 {
<a name="217" id="anc217"></a><span class="line-modified">1131     VM&amp; vm = globalObject-&gt;vm();</span>
1132     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="218" id="anc218"></a><span class="line-modified">1133     JSValue thisValue = callFrame-&gt;thisValue();</span>
1134     auto* thisDateObj = jsDynamicCast&lt;DateInstance*&gt;(vm, thisValue);
1135     if (UNLIKELY(!thisDateObj))
<a name="219" id="anc219"></a><span class="line-modified">1136         return throwVMTypeError(globalObject, scope);</span>
1137 
<a name="220" id="anc220"></a><span class="line-modified">1138     const GregorianDateTime* gregorianDateTime = thisDateObj-&gt;gregorianDateTime(vm);</span>
1139     if (!gregorianDateTime)
1140         return JSValue::encode(jsNaN());
1141 
1142     // NOTE: IE returns the full year even in getYear.
1143     return JSValue::encode(jsNumber(gregorianDateTime-&gt;year() - 1900));
1144 }
1145 
<a name="221" id="anc221"></a><span class="line-modified">1146 EncodedJSValue JSC_HOST_CALL dateProtoFuncToJSON(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
1147 {
<a name="222" id="anc222"></a><span class="line-modified">1148     VM&amp; vm = globalObject-&gt;vm();</span>
1149     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="223" id="anc223"></a><span class="line-modified">1150     JSValue thisValue = callFrame-&gt;thisValue();</span>
<span class="line-modified">1151     JSObject* object = thisValue.toObject(globalObject);</span>
1152     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1153 
<a name="224" id="anc224"></a><span class="line-modified">1154     JSValue timeValue = object-&gt;toPrimitive(globalObject, PreferNumber);</span>
1155     RETURN_IF_EXCEPTION(scope, encodedJSValue());
<a name="225" id="anc225"></a><span class="line-modified">1156     if (timeValue.isNumber() &amp;&amp; !std::isfinite(timeValue.asNumber()))</span>
1157         return JSValue::encode(jsNull());
1158 
<a name="226" id="anc226"></a><span class="line-modified">1159     JSValue toISOValue = object-&gt;get(globalObject, vm.propertyNames-&gt;toISOString);</span>
1160     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1161 
1162     CallData callData;
1163     CallType callType = getCallData(vm, toISOValue, callData);
1164     if (callType == CallType::None)
<a name="227" id="anc227"></a><span class="line-modified">1165         return throwVMTypeError(globalObject, scope, &quot;toISOString is not a function&quot;_s);</span>
1166 
<a name="228" id="anc228"></a><span class="line-modified">1167     JSValue result = call(globalObject, asObject(toISOValue), callType, callData, object, *vm.emptyList);</span>
1168     RETURN_IF_EXCEPTION(scope, encodedJSValue());
1169     return JSValue::encode(result);
1170 }
1171 
1172 } // namespace JSC
<a name="229" id="anc229"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="229" type="hidden" />
</body>
</html>