<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/webauthn/fido/DeviceResponseConverter.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DeviceRequestConverter.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="DeviceResponseConverter.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/webauthn/fido/DeviceResponseConverter.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 42,12 ***</span>
  
  namespace fido {
  using namespace WebCore;
  using CBOR = cbor::CBORValue;
  
<span class="line-removed">- constexpr size_t kResponseCodeLength = 1;</span>
<span class="line-removed">- </span>
  static ProtocolVersion convertStringToProtocolVersion(const String&amp; version)
  {
      if (version == kCtap2Version)
          return ProtocolVersion::kCtap;
      if (version == kU2fVersion)
<span class="line-new-header">--- 42,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 83,39 ***</span>
  }
  
  
  // Decodes byte array response from authenticator to CBOR value object and
  // checks for correct encoding format.
<span class="line-modified">! Optional&lt;PublicKeyCredentialData&gt; readCTAPMakeCredentialResponse(const Vector&lt;uint8_t&gt;&amp; inBuffer, const WebCore::AttestationConveyancePreference&amp; attestation)</span>
  {
      if (inBuffer.size() &lt;= kResponseCodeLength)
<span class="line-modified">!         return WTF::nullopt;</span>
  
      Vector&lt;uint8_t&gt; buffer;
      buffer.append(inBuffer.data() + 1, inBuffer.size() - 1);
      Optional&lt;CBOR&gt; decodedResponse = cbor::CBORReader::read(buffer);
      if (!decodedResponse || !decodedResponse-&gt;isMap())
<span class="line-modified">!         return WTF::nullopt;</span>
      const auto&amp; decodedMap = decodedResponse-&gt;getMap();
  
      auto it = decodedMap.find(CBOR(1));
      if (it == decodedMap.end() || !it-&gt;second.isString())
<span class="line-modified">!         return WTF::nullopt;</span>
      auto format = it-&gt;second.clone();
  
      it = decodedMap.find(CBOR(2));
      if (it == decodedMap.end() || !it-&gt;second.isByteString())
<span class="line-modified">!         return WTF::nullopt;</span>
      auto authenticatorData = it-&gt;second.clone();
  
      auto credentialId = getCredentialId(authenticatorData.getByteString());
      if (credentialId.isEmpty())
<span class="line-modified">!         return WTF::nullopt;</span>
  
      it = decodedMap.find(CBOR(3));
      if (it == decodedMap.end() || !it-&gt;second.isMap())
<span class="line-modified">!         return WTF::nullopt;</span>
      auto attStmt = it-&gt;second.clone();
  
      Optional&lt;Vector&lt;uint8_t&gt;&gt; attestationObject;
      if (attestation == AttestationConveyancePreference::None) {
          // The reason why we can&#39;t directly pass authenticatorData/format/attStmt to buildAttestationObject
<span class="line-new-header">--- 81,39 ---</span>
  }
  
  
  // Decodes byte array response from authenticator to CBOR value object and
  // checks for correct encoding format.
<span class="line-modified">! RefPtr&lt;AuthenticatorAttestationResponse&gt; readCTAPMakeCredentialResponse(const Vector&lt;uint8_t&gt;&amp; inBuffer, const AttestationConveyancePreference&amp; attestation)</span>
  {
      if (inBuffer.size() &lt;= kResponseCodeLength)
<span class="line-modified">!         return nullptr;</span>
  
      Vector&lt;uint8_t&gt; buffer;
      buffer.append(inBuffer.data() + 1, inBuffer.size() - 1);
      Optional&lt;CBOR&gt; decodedResponse = cbor::CBORReader::read(buffer);
      if (!decodedResponse || !decodedResponse-&gt;isMap())
<span class="line-modified">!         return nullptr;</span>
      const auto&amp; decodedMap = decodedResponse-&gt;getMap();
  
      auto it = decodedMap.find(CBOR(1));
      if (it == decodedMap.end() || !it-&gt;second.isString())
<span class="line-modified">!         return nullptr;</span>
      auto format = it-&gt;second.clone();
  
      it = decodedMap.find(CBOR(2));
      if (it == decodedMap.end() || !it-&gt;second.isByteString())
<span class="line-modified">!         return nullptr;</span>
      auto authenticatorData = it-&gt;second.clone();
  
      auto credentialId = getCredentialId(authenticatorData.getByteString());
      if (credentialId.isEmpty())
<span class="line-modified">!         return nullptr;</span>
  
      it = decodedMap.find(CBOR(3));
      if (it == decodedMap.end() || !it-&gt;second.isMap())
<span class="line-modified">!         return nullptr;</span>
      auto attStmt = it-&gt;second.clone();
  
      Optional&lt;Vector&lt;uint8_t&gt;&gt; attestationObject;
      if (attestation == AttestationConveyancePreference::None) {
          // The reason why we can&#39;t directly pass authenticatorData/format/attStmt to buildAttestationObject
</pre>
<hr />
<pre>
<span class="line-old-header">*** 128,60 ***</span>
          attestationObjectMap[CBOR(&quot;fmt&quot;)] = WTFMove(format);
          attestationObjectMap[CBOR(&quot;attStmt&quot;)] = WTFMove(attStmt);
          attestationObject = cbor::CBORWriter::write(CBOR(WTFMove(attestationObjectMap)));
      }
  
<span class="line-modified">!     return PublicKeyCredentialData { ArrayBuffer::create(credentialId.data(), credentialId.size()), true, nullptr, ArrayBuffer::create(attestationObject.value().data(), attestationObject.value().size()), nullptr, nullptr, nullptr, WTF::nullopt };</span>
  }
  
<span class="line-modified">! Optional&lt;PublicKeyCredentialData&gt; readCTAPGetAssertionResponse(const Vector&lt;uint8_t&gt;&amp; inBuffer)</span>
  {
      if (inBuffer.size() &lt;= kResponseCodeLength)
<span class="line-modified">!         return WTF::nullopt;</span>
  
      Vector&lt;uint8_t&gt; buffer;
      buffer.append(inBuffer.data() + 1, inBuffer.size() - 1);
      Optional&lt;CBOR&gt; decodedResponse = cbor::CBORReader::read(buffer);
  
      if (!decodedResponse || !decodedResponse-&gt;isMap())
<span class="line-modified">!         return WTF::nullopt;</span>
  
      auto&amp; responseMap = decodedResponse-&gt;getMap();
  
<span class="line-removed">-     RefPtr&lt;ArrayBuffer&gt; credentialId;</span>
      auto it = responseMap.find(CBOR(1));
<span class="line-modified">!     if (it != responseMap.end() &amp;&amp; it-&gt;second.isMap()) {</span>
<span class="line-modified">!         auto&amp; credential = it-&gt;second.getMap();</span>
<span class="line-modified">!         auto itr = credential.find(CBOR(kCredentialIdKey));</span>
<span class="line-modified">!         if (itr == credential.end() || !itr-&gt;second.isByteString())</span>
<span class="line-modified">!             return WTF::nullopt;</span>
<span class="line-modified">!         auto&amp; id = itr-&gt;second.getByteString();</span>
<span class="line-modified">!         credentialId = ArrayBuffer::create(id.data(), id.size());</span>
<span class="line-removed">-     }</span>
  
      it = responseMap.find(CBOR(2));
      if (it == responseMap.end() || !it-&gt;second.isByteString())
<span class="line-modified">!         return WTF::nullopt;</span>
      auto&amp; authData = it-&gt;second.getByteString();
  
      it = responseMap.find(CBOR(3));
      if (it == responseMap.end() || !it-&gt;second.isByteString())
<span class="line-modified">!         return WTF::nullopt;</span>
      auto&amp; signature = it-&gt;second.getByteString();
  
<span class="line-modified">!     RefPtr&lt;ArrayBuffer&gt; userHandle;</span>
      it = responseMap.find(CBOR(4));
      if (it != responseMap.end() &amp;&amp; it-&gt;second.isMap()) {
          auto&amp; user = it-&gt;second.getMap();
          auto itr = user.find(CBOR(kEntityIdMapKey));
          if (itr == user.end() || !itr-&gt;second.isByteString())
<span class="line-modified">!             return WTF::nullopt;</span>
<span class="line-modified">!         auto&amp; id = itr-&gt;second.getByteString();</span>
<span class="line-modified">!         userHandle = ArrayBuffer::create(id.data(), id.size());</span>
      }
  
<span class="line-modified">!     return PublicKeyCredentialData { WTFMove(credentialId), false, nullptr, nullptr, ArrayBuffer::create(authData.data(), authData.size()), ArrayBuffer::create(signature.data(), signature.size()), WTFMove(userHandle), WTF::nullopt };</span>
  }
  
  Optional&lt;AuthenticatorGetInfoResponse&gt; readCTAPGetInfoResponse(const Vector&lt;uint8_t&gt;&amp; inBuffer)
  {
      if (inBuffer.size() &lt;= kResponseCodeLength || getResponseCode(inBuffer) != CtapDeviceResponseCode::kSuccess)
<span class="line-new-header">--- 126,78 ---</span>
          attestationObjectMap[CBOR(&quot;fmt&quot;)] = WTFMove(format);
          attestationObjectMap[CBOR(&quot;attStmt&quot;)] = WTFMove(attStmt);
          attestationObject = cbor::CBORWriter::write(CBOR(WTFMove(attestationObjectMap)));
      }
  
<span class="line-modified">!     return AuthenticatorAttestationResponse::create(credentialId, *attestationObject);</span>
  }
  
<span class="line-modified">! RefPtr&lt;AuthenticatorAssertionResponse&gt; readCTAPGetAssertionResponse(const Vector&lt;uint8_t&gt;&amp; inBuffer)</span>
  {
      if (inBuffer.size() &lt;= kResponseCodeLength)
<span class="line-modified">!         return nullptr;</span>
  
      Vector&lt;uint8_t&gt; buffer;
      buffer.append(inBuffer.data() + 1, inBuffer.size() - 1);
      Optional&lt;CBOR&gt; decodedResponse = cbor::CBORReader::read(buffer);
  
      if (!decodedResponse || !decodedResponse-&gt;isMap())
<span class="line-modified">!         return nullptr;</span>
  
      auto&amp; responseMap = decodedResponse-&gt;getMap();
  
      auto it = responseMap.find(CBOR(1));
<span class="line-modified">!     if (it == responseMap.end() || !it-&gt;second.isMap())</span>
<span class="line-modified">!         return nullptr;</span>
<span class="line-modified">!     auto&amp; credential = it-&gt;second.getMap();</span>
<span class="line-modified">!     auto itr = credential.find(CBOR(kCredentialIdKey));</span>
<span class="line-modified">!     if (itr == credential.end() || !itr-&gt;second.isByteString())</span>
<span class="line-modified">!         return nullptr;</span>
<span class="line-modified">!     auto&amp; credentialId = itr-&gt;second.getByteString();</span>
  
      it = responseMap.find(CBOR(2));
      if (it == responseMap.end() || !it-&gt;second.isByteString())
<span class="line-modified">!         return nullptr;</span>
      auto&amp; authData = it-&gt;second.getByteString();
  
      it = responseMap.find(CBOR(3));
      if (it == responseMap.end() || !it-&gt;second.isByteString())
<span class="line-modified">!         return nullptr;</span>
      auto&amp; signature = it-&gt;second.getByteString();
  
<span class="line-modified">!     RefPtr&lt;AuthenticatorAssertionResponse&gt; response;</span>
      it = responseMap.find(CBOR(4));
      if (it != responseMap.end() &amp;&amp; it-&gt;second.isMap()) {
          auto&amp; user = it-&gt;second.getMap();
          auto itr = user.find(CBOR(kEntityIdMapKey));
          if (itr == user.end() || !itr-&gt;second.isByteString())
<span class="line-modified">!             return nullptr;</span>
<span class="line-modified">!         auto&amp; userHandle = itr-&gt;second.getByteString();</span>
<span class="line-modified">!         response = AuthenticatorAssertionResponse::create(credentialId, authData, signature, userHandle);</span>
<span class="line-added">+ </span>
<span class="line-added">+         itr = user.find(CBOR(kEntityNameMapKey));</span>
<span class="line-added">+         if (itr != user.end()) {</span>
<span class="line-added">+             if (!itr-&gt;second.isString())</span>
<span class="line-added">+                 return nullptr;</span>
<span class="line-added">+             response-&gt;setName(itr-&gt;second.getString());</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         itr = user.find(CBOR(kDisplayNameMapKey));</span>
<span class="line-added">+         if (itr != user.end()) {</span>
<span class="line-added">+             if (!itr-&gt;second.isString())</span>
<span class="line-added">+                 return nullptr;</span>
<span class="line-added">+             response-&gt;setDisplayName(itr-&gt;second.getString());</span>
<span class="line-added">+         }</span>
<span class="line-added">+     } else {</span>
<span class="line-added">+         response = AuthenticatorAssertionResponse::create(credentialId, authData, signature, { });</span>
      }
  
<span class="line-modified">!     it = responseMap.find(CBOR(5));</span>
<span class="line-added">+     if (it != responseMap.end() &amp;&amp; it-&gt;second.isUnsigned())</span>
<span class="line-added">+         response-&gt;setNumberOfCredentials(it-&gt;second.getUnsigned());</span>
<span class="line-added">+ </span>
<span class="line-added">+     return response;</span>
  }
  
  Optional&lt;AuthenticatorGetInfoResponse&gt; readCTAPGetInfoResponse(const Vector&lt;uint8_t&gt;&amp; inBuffer)
  {
      if (inBuffer.size() &lt;= kResponseCodeLength || getResponseCode(inBuffer) != CtapDeviceResponseCode::kSuccess)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 193,11 ***</span>
      if (!decodedResponse || !decodedResponse-&gt;isMap())
          return WTF::nullopt;
      const auto&amp; responseMap = decodedResponse-&gt;getMap();
  
      auto it = responseMap.find(CBOR(1));
<span class="line-modified">!     if (it == responseMap.end() || !it-&gt;second.isArray() || it-&gt;second.getArray().size() &gt; 2)</span>
          return WTF::nullopt;
      StdSet&lt;ProtocolVersion&gt; protocolVersions;
      for (const auto&amp; version : it-&gt;second.getArray()) {
          if (!version.isString())
              return WTF::nullopt;
<span class="line-new-header">--- 209,11 ---</span>
      if (!decodedResponse || !decodedResponse-&gt;isMap())
          return WTF::nullopt;
      const auto&amp; responseMap = decodedResponse-&gt;getMap();
  
      auto it = responseMap.find(CBOR(1));
<span class="line-modified">!     if (it == responseMap.end() || !it-&gt;second.isArray())</span>
          return WTF::nullopt;
      StdSet&lt;ProtocolVersion&gt; protocolVersions;
      for (const auto&amp; version : it-&gt;second.getArray()) {
          if (!version.isString())
              return WTF::nullopt;
</pre>
<center><a href="DeviceRequestConverter.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="DeviceResponseConverter.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>