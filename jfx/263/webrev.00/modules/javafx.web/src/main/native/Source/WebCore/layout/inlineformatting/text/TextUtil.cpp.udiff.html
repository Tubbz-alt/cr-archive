<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/layout/inlineformatting/text/TextUtil.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../InlineTextItem.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="TextUtil.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/layout/inlineformatting/text/TextUtil.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,57 +26,68 @@</span>
  #include &quot;config.h&quot;
  #include &quot;TextUtil.h&quot;
  
  #if ENABLE(LAYOUT_FORMATTING_CONTEXT)
  
<span class="udiff-line-added">+ #include &quot;BreakLines.h&quot;</span>
  #include &quot;FontCascade.h&quot;
<span class="udiff-line-added">+ #include &quot;InlineTextItem.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;RenderBox.h&quot;</span>
  #include &quot;RenderStyle.h&quot;
  
  namespace WebCore {
  namespace Layout {
  
<span class="udiff-line-modified-removed">- Optional&lt;unsigned&gt; TextUtil::hyphenPositionBefore(const InlineItem&amp;, unsigned, unsigned)</span>
<span class="udiff-line-modified-added">+ InlineLayoutUnit TextUtil::width(const InlineTextItem&amp; inlineTextItem, unsigned from, unsigned to, InlineLayoutUnit contentLogicalLeft)</span>
  {
<span class="udiff-line-modified-removed">-     return WTF::nullopt;</span>
<span class="udiff-line-modified-added">+     // Fast path for collapsed whitespace.</span>
<span class="udiff-line-added">+     if (inlineTextItem.isCollapsible()) {</span>
<span class="udiff-line-added">+         auto font = inlineTextItem.style().fontCascade();</span>
<span class="udiff-line-added">+         return font.spaceWidth() + font.wordSpacing();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     return TextUtil::width(inlineTextItem.layoutBox(), from, to, contentLogicalLeft);</span>
  }
  
<span class="udiff-line-modified-removed">- LayoutUnit TextUtil::width(const Box&amp; inlineBox, unsigned from, unsigned to, LayoutUnit contentLogicalLeft)</span>
<span class="udiff-line-modified-added">+ InlineLayoutUnit TextUtil::width(const Box&amp; inlineBox, unsigned from, unsigned to, InlineLayoutUnit contentLogicalLeft)</span>
  {
      auto&amp; style = inlineBox.style();
      auto&amp; font = style.fontCascade();
      if (!font.size() || from == to)
          return 0;
  
<span class="udiff-line-modified-removed">-     auto text = inlineBox.textContent();</span>
<span class="udiff-line-modified-added">+     auto&amp; textContext = *inlineBox.textContext();</span>
<span class="udiff-line-added">+     auto&amp; text = textContext.content;</span>
      ASSERT(to &lt;= text.length());
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (font.isFixedPitch())</span>
<span class="udiff-line-removed">-         return fixedPitchWidth(text, style, from, to, contentLogicalLeft);</span>
<span class="udiff-line-removed">- </span>
      auto hasKerningOrLigatures = font.enableKerning() || font.requiresShaping();
      auto measureWithEndSpace = hasKerningOrLigatures &amp;&amp; to &lt; text.length() &amp;&amp; text[to] == &#39; &#39;;
      if (measureWithEndSpace)
          ++to;
<span class="udiff-line-modified-removed">-     LayoutUnit width;</span>
<span class="udiff-line-modified-removed">-     auto tabWidth = style.collapseWhiteSpace() ? TabSize(0) : style.tabSize();</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     WebCore::TextRun run(StringView(text).substring(from, to - from), contentLogicalLeft);</span>
<span class="udiff-line-modified-removed">-     if (tabWidth)</span>
<span class="udiff-line-modified-removed">-         run.setTabSize(true, tabWidth);</span>
<span class="udiff-line-modified-removed">-     width = font.width(run);</span>
<span class="udiff-line-modified-added">+     float width = 0;</span>
<span class="udiff-line-modified-added">+     if (textContext.canUseSimplifiedContentMeasuring) {</span>
<span class="udiff-line-modified-added">+         if (font.isFixedPitch())</span>
<span class="udiff-line-modified-added">+             width = fixedPitchWidth(text, style, from, to, contentLogicalLeft);</span>
<span class="udiff-line-modified-added">+         else</span>
<span class="udiff-line-modified-added">+             width = font.widthForSimpleText(StringView(text).substring(from, to - from));</span>
<span class="udiff-line-modified-added">+     } else {</span>
<span class="udiff-line-added">+         auto tabWidth = style.collapseWhiteSpace() ? TabSize(0) : style.tabSize();</span>
<span class="udiff-line-added">+         WebCore::TextRun run(StringView(text).substring(from, to - from), contentLogicalLeft);</span>
<span class="udiff-line-added">+         if (tabWidth)</span>
<span class="udiff-line-added">+             run.setTabSize(true, tabWidth);</span>
<span class="udiff-line-added">+         width = font.width(run);</span>
<span class="udiff-line-added">+     }</span>
  
      if (measureWithEndSpace)
          width -= (font.spaceWidth() + font.wordSpacing());
  
<span class="udiff-line-modified-removed">-     return std::max&lt;LayoutUnit&gt;(0, width);</span>
<span class="udiff-line-modified-added">+     return std::max&lt;InlineLayoutUnit&gt;(0 , InlineLayoutUnit(width));</span>
  }
  
<span class="udiff-line-modified-removed">- LayoutUnit TextUtil::fixedPitchWidth(String text, const RenderStyle&amp; style, unsigned from, unsigned to, LayoutUnit contentLogicalLeft)</span>
<span class="udiff-line-modified-added">+ InlineLayoutUnit TextUtil::fixedPitchWidth(const StringView&amp; text, const RenderStyle&amp; style, unsigned from, unsigned to, InlineLayoutUnit contentLogicalLeft)</span>
  {
      auto&amp; font = style.fontCascade();
      auto monospaceCharacterWidth = font.spaceWidth();
<span class="udiff-line-modified-removed">-     LayoutUnit width;</span>
<span class="udiff-line-modified-added">+     float width = 0;</span>
      for (auto i = from; i &lt; to; ++i) {
          auto character = text[i];
          if (character &gt;= &#39; &#39; || character == &#39;\n&#39;)
              width += monospaceCharacterWidth;
          else if (character == &#39;\t&#39;)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -84,32 +95,24 @@</span>
  
          if (i &gt; from &amp;&amp; (character == &#39; &#39; || character == &#39;\t&#39; || character == &#39;\n&#39;))
              width += font.wordSpacing();
      }
  
<span class="udiff-line-modified-removed">-     return width;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- bool TextUtil::isTrimmableContent(const InlineItem&amp; inlineItem)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     if (!is&lt;InlineTextItem&gt;(inlineItem))</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">-     auto&amp; inlineTextItem = downcast&lt;InlineTextItem&gt;(inlineItem);</span>
<span class="udiff-line-removed">-     return inlineTextItem.isWhitespace() &amp;&amp; inlineTextItem.style().collapseWhiteSpace();</span>
<span class="udiff-line-modified-added">+     return std::max&lt;InlineLayoutUnit&gt;(0, InlineLayoutUnit(width));</span>
  }
  
<span class="udiff-line-modified-removed">- TextUtil::SplitData TextUtil::split(const Box&amp; inlineBox, unsigned startPosition, unsigned length, LayoutUnit textWidth, LayoutUnit availableWidth, LayoutUnit contentLogicalLeft)</span>
<span class="udiff-line-modified-added">+ TextUtil::SplitData TextUtil::split(const Box&amp; inlineBox, unsigned startPosition, unsigned length, InlineLayoutUnit textWidth, InlineLayoutUnit availableWidth, InlineLayoutUnit contentLogicalLeft)</span>
  {
<span class="udiff-line-removed">-     // FIXME This should take hypens into account.</span>
      ASSERT(availableWidth &gt;= 0);
      auto left = startPosition;
      // Pathological case of (extremely)long string and narrow lines.
      // Adjust the range so that we can pick a reasonable midpoint.
<span class="udiff-line-modified-removed">-     LayoutUnit averageCharacterWidth = textWidth / length;</span>
<span class="udiff-line-modified-removed">-     auto right = std::min&lt;unsigned&gt;(left + (2 * availableWidth / averageCharacterWidth).toUnsigned(), (startPosition + length - 1));</span>
<span class="udiff-line-modified-added">+     InlineLayoutUnit averageCharacterWidth = textWidth / length;</span>
<span class="udiff-line-modified-added">+     unsigned offset = toLayoutUnit(2 * availableWidth / averageCharacterWidth).toUnsigned();</span>
<span class="udiff-line-added">+     auto right = std::min&lt;unsigned&gt;(left + offset, (startPosition + length - 1));</span>
      // Preserve the left width for the final split position so that we don&#39;t need to remeasure the left side again.
<span class="udiff-line-modified-removed">-     LayoutUnit leftSideWidth = 0;</span>
<span class="udiff-line-modified-added">+     InlineLayoutUnit leftSideWidth = 0;</span>
      while (left &lt; right) {
          auto middle = (left + right) / 2;
          auto width = TextUtil::width(inlineBox, startPosition, middle + 1, contentLogicalLeft);
          if (width &lt; availableWidth) {
              left = middle + 1;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -123,8 +126,30 @@</span>
          }
      }
      return { startPosition, right - startPosition, leftSideWidth };
  }
  
<span class="udiff-line-added">+ unsigned TextUtil::findNextBreakablePosition(LazyLineBreakIterator&amp; lineBreakIterator, unsigned startPosition, const RenderStyle&amp; style)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto keepAllWordsForCJK = style.wordBreak() == WordBreak::KeepAll;</span>
<span class="udiff-line-added">+     auto breakNBSP = style.autoWrap() &amp;&amp; style.nbspMode() == NBSPMode::Space;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (keepAllWordsForCJK) {</span>
<span class="udiff-line-added">+         if (breakNBSP)</span>
<span class="udiff-line-added">+             return nextBreakablePositionKeepingAllWords(lineBreakIterator, startPosition);</span>
<span class="udiff-line-added">+         return nextBreakablePositionKeepingAllWordsIgnoringNBSP(lineBreakIterator, startPosition);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (lineBreakIterator.mode() == LineBreakIteratorMode::Default) {</span>
<span class="udiff-line-added">+         if (breakNBSP)</span>
<span class="udiff-line-added">+             return WebCore::nextBreakablePosition(lineBreakIterator, startPosition);</span>
<span class="udiff-line-added">+         return nextBreakablePositionIgnoringNBSP(lineBreakIterator, startPosition);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (breakNBSP)</span>
<span class="udiff-line-added">+         return nextBreakablePositionWithoutShortcut(lineBreakIterator, startPosition);</span>
<span class="udiff-line-added">+     return nextBreakablePositionIgnoringNBSPWithoutShortcut(lineBreakIterator, startPosition);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  }
  }
  #endif
</pre>
<center><a href="../InlineTextItem.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="TextUtil.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>