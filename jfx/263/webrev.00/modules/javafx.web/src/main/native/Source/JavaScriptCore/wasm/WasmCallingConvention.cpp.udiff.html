<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/wasm/WasmCallingConvention.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WasmCallee.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="WasmCallingConvention.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/wasm/WasmCallingConvention.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -28,70 +28,59 @@</span>
  
  #if ENABLE(WEBASSEMBLY)
  
  #include &lt;wtf/NeverDestroyed.h&gt;
  
<span class="udiff-line-modified-removed">- namespace JSC { namespace Wasm {</span>
<span class="udiff-line-modified-added">+ namespace JSC::Wasm {</span>
  
<span class="udiff-line-modified-removed">- const JSCCallingConvention&amp; jscCallingConvention()</span>
<span class="udiff-line-modified-added">+ const JSCallingConvention&amp; jsCallingConvention()</span>
  {
<span class="udiff-line-modified-removed">-     static LazyNeverDestroyed&lt;JSCCallingConvention&gt; staticJSCCallingConvention;</span>
<span class="udiff-line-modified-added">+     static LazyNeverDestroyed&lt;JSCallingConvention&gt; staticJSCallingConvention;</span>
      static std::once_flag staticJSCCallingConventionFlag;
      std::call_once(staticJSCCallingConventionFlag, [] () {
<span class="udiff-line-modified-removed">-         staticJSCCallingConvention.construct(Vector&lt;Reg&gt;(), Vector&lt;Reg&gt;(), RegisterSet::calleeSaveRegisters());</span>
<span class="udiff-line-modified-added">+         RegisterSet callerSaveRegisters = RegisterSet::allRegisters();</span>
<span class="udiff-line-added">+         callerSaveRegisters.exclude(RegisterSet::calleeSaveRegisters());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         staticJSCallingConvention.construct(Vector&lt;Reg&gt;(), Vector&lt;Reg&gt;(), RegisterSet::calleeSaveRegisters(), WTFMove(callerSaveRegisters));</span>
      });
  
<span class="udiff-line-modified-removed">-     return staticJSCCallingConvention;</span>
<span class="udiff-line-modified-added">+     return staticJSCallingConvention;</span>
  }
  
  const WasmCallingConvention&amp; wasmCallingConvention()
  {
<span class="udiff-line-modified-removed">-     static LazyNeverDestroyed&lt;JSCCallingConvention&gt; staticWasmCallingConvention;</span>
<span class="udiff-line-modified-added">+     static LazyNeverDestroyed&lt;WasmCallingConvention&gt; staticWasmCallingConvention;</span>
      static std::once_flag staticWasmCallingConventionFlag;
      std::call_once(staticWasmCallingConventionFlag, [] () {
          Vector&lt;Reg&gt; gprArgumentRegisters(GPRInfo::numberOfArgumentRegisters);
          for (unsigned i = 0; i &lt; GPRInfo::numberOfArgumentRegisters; ++i)
              gprArgumentRegisters[i] = GPRInfo::toArgumentRegister(i);
  
          Vector&lt;Reg&gt; fprArgumentRegisters(FPRInfo::numberOfArgumentRegisters);
          for (unsigned i = 0; i &lt; FPRInfo::numberOfArgumentRegisters; ++i)
              fprArgumentRegisters[i] = FPRInfo::toArgumentRegister(i);
  
<span class="udiff-line-modified-removed">-         staticWasmCallingConvention.construct(WTFMove(gprArgumentRegisters), WTFMove(fprArgumentRegisters), RegisterSet::calleeSaveRegisters());</span>
<span class="udiff-line-modified-removed">-     });</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     return staticWasmCallingConvention;</span>
<span class="udiff-line-modified-removed">- }</span>
<span class="udiff-line-modified-added">+         RegisterSet scratch = RegisterSet::allGPRs();</span>
<span class="udiff-line-modified-added">+         scratch.exclude(RegisterSet::calleeSaveRegisters());</span>
<span class="udiff-line-modified-added">+         scratch.exclude(RegisterSet::macroScratchRegisters());</span>
<span class="udiff-line-modified-added">+         scratch.exclude(RegisterSet::reservedHardwareRegisters());</span>
<span class="udiff-line-modified-added">+         scratch.exclude(RegisterSet::stackRegisters());</span>
<span class="udiff-line-added">+         for (Reg reg : gprArgumentRegisters)</span>
<span class="udiff-line-added">+             scratch.clear(reg);</span>
  
<span class="udiff-line-modified-removed">- const JSCCallingConventionAir&amp; jscCallingConventionAir()</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-modified-removed">-     static LazyNeverDestroyed&lt;JSCCallingConventionAir&gt; staticJSCCallingConvention;</span>
<span class="udiff-line-modified-removed">-     static std::once_flag staticJSCCallingConventionFlag;</span>
<span class="udiff-line-removed">-     std::call_once(staticJSCCallingConventionFlag, [] () {</span>
<span class="udiff-line-removed">-         staticJSCCallingConvention.construct(Vector&lt;Reg&gt;(), Vector&lt;Reg&gt;(), RegisterSet::calleeSaveRegisters());</span>
<span class="udiff-line-removed">-     });</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return staticJSCCallingConvention;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-modified-added">+         Vector&lt;GPRReg&gt; scratchGPRs;</span>
<span class="udiff-line-modified-added">+         for (Reg reg : scratch)</span>
<span class="udiff-line-modified-added">+             scratchGPRs.append(reg.gpr());</span>
<span class="udiff-line-modified-added">+         RELEASE_ASSERT(scratchGPRs.size() &gt;= 2);</span>
  
<span class="udiff-line-modified-removed">- const WasmCallingConventionAir&amp; wasmCallingConventionAir()</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-removed">-     static LazyNeverDestroyed&lt;WasmCallingConventionAir&gt; staticWasmCallingConvention;</span>
<span class="udiff-line-removed">-     static std::once_flag staticWasmCallingConventionFlag;</span>
<span class="udiff-line-removed">-     std::call_once(staticWasmCallingConventionFlag, [] () {</span>
<span class="udiff-line-removed">-         Vector&lt;Reg&gt; gprArgumentRegisters(GPRInfo::numberOfArgumentRegisters);</span>
<span class="udiff-line-removed">-         for (unsigned i = 0; i &lt; GPRInfo::numberOfArgumentRegisters; ++i)</span>
<span class="udiff-line-removed">-             gprArgumentRegisters[i] = GPRInfo::toArgumentRegister(i);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         Vector&lt;Reg&gt; fprArgumentRegisters(FPRInfo::numberOfArgumentRegisters);</span>
<span class="udiff-line-removed">-         for (unsigned i = 0; i &lt; FPRInfo::numberOfArgumentRegisters; ++i)</span>
<span class="udiff-line-removed">-             fprArgumentRegisters[i] = FPRInfo::toArgumentRegister(i);</span>
<span class="udiff-line-modified-added">+         RegisterSet callerSaveRegisters = RegisterSet::allRegisters();</span>
<span class="udiff-line-modified-added">+         callerSaveRegisters.exclude(RegisterSet::calleeSaveRegisters());</span>
  
<span class="udiff-line-modified-removed">-         staticWasmCallingConvention.construct(WTFMove(gprArgumentRegisters), WTFMove(fprArgumentRegisters), RegisterSet::calleeSaveRegisters());</span>
<span class="udiff-line-modified-added">+         staticWasmCallingConvention.construct(WTFMove(gprArgumentRegisters), WTFMove(fprArgumentRegisters), WTFMove(scratchGPRs), RegisterSet::calleeSaveRegisters(), WTFMove(callerSaveRegisters));</span>
      });
  
      return staticWasmCallingConvention;
  }
  
<span class="udiff-line-modified-removed">- } } // namespace JSC::Wasm</span>
<span class="udiff-line-modified-added">+ } // namespace JSC::Wasm</span>
  
  #endif // ENABLE(B3_JIT)
</pre>
<center><a href="WasmCallee.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="WasmCallingConvention.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>