<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/server/SQLiteIDBBackingStore.h</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2016 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
 28 #if ENABLE(INDEXED_DATABASE)
 29 
 30 #include &quot;IDBBackingStore.h&quot;
 31 #include &quot;IDBDatabaseIdentifier.h&quot;
 32 #include &quot;IDBDatabaseInfo.h&quot;
 33 #include &quot;IDBResourceIdentifier.h&quot;
 34 #include &quot;SQLiteIDBTransaction.h&quot;
 35 #include &lt;JavaScriptCore/Strong.h&gt;
 36 #include &lt;pal/SessionID.h&gt;
 37 #include &lt;wtf/HashMap.h&gt;
 38 
 39 namespace WebCore {
 40 
 41 class IndexKey;
 42 class SQLiteDatabase;
 43 class SQLiteStatement;
 44 
 45 namespace IDBServer {
 46 
 47 enum class IsSchemaUpgraded : bool { No, Yes };
 48 
 49 class IDBSerializationContext;
 50 class SQLiteIDBCursor;
 51 
 52 class SQLiteIDBBackingStore : public IDBBackingStore {
 53     WTF_MAKE_FAST_ALLOCATED;
 54 public:
 55     SQLiteIDBBackingStore(PAL::SessionID, const IDBDatabaseIdentifier&amp;, const String&amp; databaseRootDirectory);
 56 
 57     ~SQLiteIDBBackingStore() final;
 58 
 59     IDBError getOrEstablishDatabaseInfo(IDBDatabaseInfo&amp;) final;
 60 
 61     IDBError beginTransaction(const IDBTransactionInfo&amp;) final;
 62     IDBError abortTransaction(const IDBResourceIdentifier&amp; transactionIdentifier) final;
 63     IDBError commitTransaction(const IDBResourceIdentifier&amp; transactionIdentifier) final;
 64     IDBError createObjectStore(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBObjectStoreInfo&amp;) final;
 65     IDBError deleteObjectStore(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier) final;
 66     IDBError renameObjectStore(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, const String&amp; newName) final;
 67     IDBError clearObjectStore(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier) final;
 68     IDBError createIndex(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBIndexInfo&amp;) final;
 69     IDBError deleteIndex(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t indexIdentifier) final;
 70     IDBError renameIndex(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const String&amp; newName) final;
 71     IDBError keyExistsInObjectStore(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, const IDBKeyData&amp;, bool&amp; keyExists) final;
 72     IDBError deleteRange(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, const IDBKeyRangeData&amp;) final;
 73     IDBError addRecord(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBObjectStoreInfo&amp;, const IDBKeyData&amp;, const IDBValue&amp;) final;
 74     IDBError getRecord(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, const IDBKeyRangeData&amp;, IDBGetRecordDataType, IDBGetResult&amp; outValue) final;
 75     IDBError getAllRecords(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBGetAllRecordsData&amp;, IDBGetAllResult&amp; outValue) final;
 76     IDBError getIndexRecord(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, IndexedDB::IndexRecordType, const IDBKeyRangeData&amp;, IDBGetResult&amp; outValue) final;
 77     IDBError getCount(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const IDBKeyRangeData&amp;, uint64_t&amp; outCount) final;
 78     IDBError generateKeyNumber(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t&amp; keyNumber) final;
 79     IDBError revertGeneratedKeyNumber(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, uint64_t keyNumber) final;
 80     IDBError maybeUpdateKeyGeneratorNumber(const IDBResourceIdentifier&amp; transactionIdentifier, uint64_t objectStoreIdentifier, double newKeyNumber) final;
 81     IDBError openCursor(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBCursorInfo&amp;, IDBGetResult&amp; outResult) final;
 82     IDBError iterateCursor(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBResourceIdentifier&amp; cursorIdentifier, const IDBIterateCursorData&amp;, IDBGetResult&amp; outResult) final;
 83 
 84     IDBObjectStoreInfo* infoForObjectStore(uint64_t objectStoreIdentifier) final;
 85     void deleteBackingStore() final;
 86 
 87     bool supportsSimultaneousTransactions() final { return false; }
 88     bool isEphemeral() final { return false; }
 89 
 90     bool hasTransaction(const IDBResourceIdentifier&amp;) const final;
 91 
 92     void unregisterCursor(SQLiteIDBCursor&amp;);
 93 
 94     IDBError getBlobRecordsForObjectStoreRecord(int64_t objectStoreRecord, Vector&lt;String&gt;&amp; blobURLs, Vector&lt;String&gt;&amp; blobFilePaths);
 95 
 96     static String databaseNameFromEncodedFilename(const String&amp;);
 97     static uint64_t databasesSizeForDirectory(const String&amp; directory);
 98 
 99     String databaseDirectory() const { return m_databaseDirectory; };
100     static String fullDatabasePathForDirectory(const String&amp;);
101     static String databaseNameFromFile(const String&amp;);
102 
103     PAL::SessionID sessionID() const { return m_sessionID; }
104 
105 private:
106     String filenameForDatabaseName() const;
107     String fullDatabasePath() const;
108     String fullDatabaseDirectoryWithUpgrade();
109 
110     String databaseRootDirectoryIsolatedCopy() const { return m_databaseRootDirectory.isolatedCopy(); }
111 
112     bool ensureValidRecordsTable();
113     bool ensureValidIndexRecordsTable();
114     bool ensureValidIndexRecordsIndex();
115     bool ensureValidIndexRecordsRecordIndex();
116     bool ensureValidBlobTables();
117     Optional&lt;IsSchemaUpgraded&gt; ensureValidObjectStoreInfoTable();
118     std::unique_ptr&lt;IDBDatabaseInfo&gt; createAndPopulateInitialDatabaseInfo();
119     std::unique_ptr&lt;IDBDatabaseInfo&gt; extractExistingDatabaseInfo();
120 
121     IDBError deleteRecord(SQLiteIDBTransaction&amp;, int64_t objectStoreID, const IDBKeyData&amp;);
122     IDBError uncheckedGetKeyGeneratorValue(int64_t objectStoreID, uint64_t&amp; outValue);
123     IDBError uncheckedSetKeyGeneratorValue(int64_t objectStoreID, uint64_t value);
124 
125     IDBError updateAllIndexesForAddRecord(const IDBObjectStoreInfo&amp;, const IDBKeyData&amp;, const ThreadSafeDataBuffer&amp; value, int64_t recordID);
126     IDBError updateOneIndexForAddRecord(const IDBIndexInfo&amp;, const IDBKeyData&amp;, const ThreadSafeDataBuffer&amp; value, int64_t recordID);
127     IDBError uncheckedPutIndexKey(const IDBIndexInfo&amp;, const IDBKeyData&amp; keyValue, const IndexKey&amp;, int64_t recordID);
128     IDBError uncheckedPutIndexRecord(int64_t objectStoreID, int64_t indexID, const IDBKeyData&amp; keyValue, const IDBKeyData&amp; indexKey, int64_t recordID);
129     IDBError uncheckedHasIndexRecord(const IDBIndexInfo&amp;, const IDBKeyData&amp;, bool&amp; hasRecord);
130     IDBError uncheckedGetIndexRecordForOneKey(int64_t indexeID, int64_t objectStoreID, IndexedDB::IndexRecordType, const IDBKeyData&amp;, IDBGetResult&amp;);
131 
132     IDBError deleteUnusedBlobFileRecords(SQLiteIDBTransaction&amp;);
133 
134     IDBError getAllObjectStoreRecords(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBGetAllRecordsData&amp;, IDBGetAllResult&amp; outValue);
135     IDBError getAllIndexRecords(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBGetAllRecordsData&amp;, IDBGetAllResult&amp; outValue);
136 
137     void closeSQLiteDB();
138     void close() final;
139 
140     enum class SQL : size_t {
141         CreateObjectStoreInfo,
142         CreateObjectStoreKeyGenerator,
143         DeleteObjectStoreInfo,
144         DeleteObjectStoreKeyGenerator,
145         DeleteObjectStoreRecords,
146         DeleteObjectStoreIndexInfo,
147         DeleteObjectStoreIndexRecords,
148         DeleteObjectStoreBlobRecords,
149         RenameObjectStore,
150         ClearObjectStoreRecords,
151         ClearObjectStoreIndexRecords,
152         CreateIndexInfo,
153         DeleteIndexInfo,
154         HasIndexRecord,
155         PutIndexRecord,
156         GetIndexRecordForOneKey,
157         DeleteIndexRecords,
158         RenameIndex,
159         KeyExistsInObjectStore,
160         GetUnusedBlobFilenames,
161         DeleteUnusedBlobs,
162         GetObjectStoreRecord,
163         DeleteBlobRecord,
164         DeleteObjectStoreRecord,
165         DeleteObjectStoreIndexRecord,
166         AddObjectStoreRecord,
167         AddBlobRecord,
168         BlobFilenameForBlobURL,
169         AddBlobFilename,
170         GetBlobURL,
171         GetKeyGeneratorValue,
172         SetKeyGeneratorValue,
173         GetAllKeyRecordsLowerOpenUpperOpen,
174         GetAllKeyRecordsLowerOpenUpperClosed,
175         GetAllKeyRecordsLowerClosedUpperOpen,
176         GetAllKeyRecordsLowerClosedUpperClosed,
177         GetValueRecordsLowerOpenUpperOpen,
178         GetValueRecordsLowerOpenUpperClosed,
179         GetValueRecordsLowerClosedUpperOpen,
180         GetValueRecordsLowerClosedUpperClosed,
181         GetKeyRecordsLowerOpenUpperOpen,
182         GetKeyRecordsLowerOpenUpperClosed,
183         GetKeyRecordsLowerClosedUpperOpen,
184         GetKeyRecordsLowerClosedUpperClosed,
185         CountRecordsLowerOpenUpperOpen,
186         CountRecordsLowerOpenUpperClosed,
187         CountRecordsLowerClosedUpperOpen,
188         CountRecordsLowerClosedUpperClosed,
189         CountIndexRecordsLowerOpenUpperOpen,
190         CountIndexRecordsLowerOpenUpperClosed,
191         CountIndexRecordsLowerClosedUpperOpen,
192         CountIndexRecordsLowerClosedUpperClosed,
193         Invalid,
194     };
195 
196     SQLiteStatement* cachedStatement(SQL, const char*);
197     SQLiteStatement* cachedStatementForGetAllObjectStoreRecords(const IDBGetAllRecordsData&amp;);
198 
199     std::unique_ptr&lt;SQLiteStatement&gt; m_cachedStatements[static_cast&lt;int&gt;(SQL::Invalid)];
200 
201     PAL::SessionID m_sessionID;
202     IDBDatabaseIdentifier m_identifier;
203     std::unique_ptr&lt;IDBDatabaseInfo&gt; m_databaseInfo;
204     std::unique_ptr&lt;IDBDatabaseInfo&gt; m_originalDatabaseInfoBeforeVersionChange;
205 
206     std::unique_ptr&lt;SQLiteDatabase&gt; m_sqliteDB;
207 
208     HashMap&lt;IDBResourceIdentifier, std::unique_ptr&lt;SQLiteIDBTransaction&gt;&gt; m_transactions;
209     HashMap&lt;IDBResourceIdentifier, SQLiteIDBCursor*&gt; m_cursors;
210 
211     String m_databaseRootDirectory;
212     String m_databaseDirectory;
213 
214     Ref&lt;IDBSerializationContext&gt; m_serializationContext;
215 };
216 
217 } // namespace IDBServer
218 } // namespace WebCore
219 
220 #endif // ENABLE(INDEXED_DATABASE)
    </pre>
  </body>
</html>