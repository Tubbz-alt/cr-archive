<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/ScopedArguments.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SamplingProfiler.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ScopedArguments.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/ScopedArguments.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -33,15 +33,16 @@</span>
  
  STATIC_ASSERT_IS_TRIVIALLY_DESTRUCTIBLE(ScopedArguments);
  
  const ClassInfo ScopedArguments::s_info = { &quot;Arguments&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(ScopedArguments) };
  
<span class="udiff-line-modified-removed">- ScopedArguments::ScopedArguments(VM&amp; vm, Structure* structure, WriteBarrier&lt;Unknown&gt;* storage)</span>
<span class="udiff-line-modified-added">+ ScopedArguments::ScopedArguments(VM&amp; vm, Structure* structure, WriteBarrier&lt;Unknown&gt;* storage, unsigned totalLength)</span>
      : GenericArguments(vm, structure)
<span class="udiff-line-modified-removed">-     , m_storage(vm, this, storage)</span>
<span class="udiff-line-modified-added">+     , m_totalLength(totalLength)</span>
  {
<span class="udiff-line-modified-removed">-     ASSERT(!storageHeader(storage).overrodeThings);</span>
<span class="udiff-line-modified-added">+     if (storage)</span>
<span class="udiff-line-added">+         m_storage.set(vm, this, storage);</span>
  }
  
  void ScopedArguments::finishCreation(VM&amp; vm, JSFunction* callee, ScopedArgumentsTable* table, JSLexicalEnvironment* scope)
  {
      Base::finishCreation(vm);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -50,26 +51,20 @@</span>
      m_scope.set(vm, this, scope);
  }
  
  ScopedArguments* ScopedArguments::createUninitialized(VM&amp; vm, Structure* structure, JSFunction* callee, ScopedArgumentsTable* table, JSLexicalEnvironment* scope, unsigned totalLength)
  {
<span class="udiff-line-modified-removed">-     unsigned overflowLength;</span>
<span class="udiff-line-modified-removed">-     if (totalLength &gt; table-&gt;length())</span>
<span class="udiff-line-modified-removed">-         overflowLength = totalLength - table-&gt;length();</span>
<span class="udiff-line-modified-removed">-     else</span>
<span class="udiff-line-modified-removed">-         overflowLength = 0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     void* rawStoragePtr = vm.jsValueGigacageAuxiliarySpace.allocateNonVirtual(</span>
<span class="udiff-line-removed">-         vm, storageSize(overflowLength), nullptr, AllocationFailureMode::Assert);</span>
<span class="udiff-line-removed">-     WriteBarrier&lt;Unknown&gt;* storage = static_cast&lt;WriteBarrier&lt;Unknown&gt;*&gt;(rawStoragePtr) + 1;</span>
<span class="udiff-line-removed">-     storageHeader(storage).overrodeThings = false;</span>
<span class="udiff-line-removed">-     storageHeader(storage).totalLength = totalLength;</span>
<span class="udiff-line-modified-added">+     WriteBarrier&lt;Unknown&gt;* storage = nullptr;</span>
<span class="udiff-line-modified-added">+     if (totalLength &gt; table-&gt;length()) {</span>
<span class="udiff-line-modified-added">+         Checked&lt;unsigned&gt; overflowLength = totalLength - table-&gt;length();</span>
<span class="udiff-line-modified-added">+         storage = static_cast&lt;WriteBarrier&lt;Unknown&gt;*&gt;(vm.jsValueGigacageAuxiliarySpace.allocateNonVirtual(vm, (overflowLength * sizeof(WriteBarrier&lt;Unknown&gt;)).unsafeGet(), nullptr, AllocationFailureMode::Assert));</span>
<span class="udiff-line-modified-added">+     }</span>
  
      ScopedArguments* result = new (
          NotNull,
          allocateCell&lt;ScopedArguments&gt;(vm.heap))
<span class="udiff-line-modified-removed">-         ScopedArguments(vm, structure, storage);</span>
<span class="udiff-line-modified-added">+         ScopedArguments(vm, structure, storage, totalLength);</span>
      result-&gt;finishCreation(vm, callee, table, scope);
      return result;
  }
  
  ScopedArguments* ScopedArguments::create(VM&amp; vm, Structure* structure, JSFunction* callee, ScopedArgumentsTable* table, JSLexicalEnvironment* scope, unsigned totalLength)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -77,31 +72,31 @@</span>
      ScopedArguments* result =
          createUninitialized(vm, structure, callee, table, scope, totalLength);
  
      unsigned namedLength = table-&gt;length();
      for (unsigned i = namedLength; i &lt; totalLength; ++i)
<span class="udiff-line-modified-removed">-         result-&gt;overflowStorage()[i - namedLength].clear();</span>
<span class="udiff-line-modified-added">+         result-&gt;storage()[i - namedLength].clear();</span>
  
      return result;
  }
  
<span class="udiff-line-modified-removed">- ScopedArguments* ScopedArguments::createByCopying(ExecState* exec, ScopedArgumentsTable* table, JSLexicalEnvironment* scope)</span>
<span class="udiff-line-modified-added">+ ScopedArguments* ScopedArguments::createByCopying(JSGlobalObject* globalObject, CallFrame* callFrame, ScopedArgumentsTable* table, JSLexicalEnvironment* scope)</span>
  {
      return createByCopyingFrom(
<span class="udiff-line-modified-removed">-         exec-&gt;vm(), exec-&gt;lexicalGlobalObject()-&gt;scopedArgumentsStructure(),</span>
<span class="udiff-line-modified-removed">-         exec-&gt;registers() + CallFrame::argumentOffset(0), exec-&gt;argumentCount(),</span>
<span class="udiff-line-modified-removed">-         jsCast&lt;JSFunction*&gt;(exec-&gt;jsCallee()), table, scope);</span>
<span class="udiff-line-modified-added">+         globalObject-&gt;vm(), globalObject-&gt;scopedArgumentsStructure(),</span>
<span class="udiff-line-modified-added">+         callFrame-&gt;registers() + CallFrame::argumentOffset(0), callFrame-&gt;argumentCount(),</span>
<span class="udiff-line-modified-added">+         jsCast&lt;JSFunction*&gt;(callFrame-&gt;jsCallee()), table, scope);</span>
  }
  
  ScopedArguments* ScopedArguments::createByCopyingFrom(VM&amp; vm, Structure* structure, Register* argumentsStart, unsigned totalLength, JSFunction* callee, ScopedArgumentsTable* table, JSLexicalEnvironment* scope)
  {
      ScopedArguments* result =
          createUninitialized(vm, structure, callee, table, scope, totalLength);
  
      unsigned namedLength = table-&gt;length();
      for (unsigned i = namedLength; i &lt; totalLength; ++i)
<span class="udiff-line-modified-removed">-         result-&gt;overflowStorage()[i - namedLength].set(vm, result, argumentsStart[i].jsValue());</span>
<span class="udiff-line-modified-added">+         result-&gt;storage()[i - namedLength].set(vm, result, argumentsStart[i].jsValue());</span>
  
      return result;
  }
  
  void ScopedArguments::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -112,52 +107,54 @@</span>
  
      visitor.append(thisObject-&gt;m_callee);
      visitor.append(thisObject-&gt;m_table);
      visitor.append(thisObject-&gt;m_scope);
  
<span class="udiff-line-modified-removed">-     visitor.markAuxiliary(&amp;thisObject-&gt;storageHeader());</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     if (thisObject-&gt;storageHeader().totalLength &gt; thisObject-&gt;m_table-&gt;length()) {</span>
<span class="udiff-line-modified-removed">-         visitor.appendValues(</span>
<span class="udiff-line-removed">-             thisObject-&gt;overflowStorage(), thisObject-&gt;storageHeader().totalLength - thisObject-&gt;m_table-&gt;length());</span>
<span class="udiff-line-modified-added">+     if (WriteBarrier&lt;Unknown&gt;* storage = thisObject-&gt;m_storage.get()) {</span>
<span class="udiff-line-modified-added">+         visitor.markAuxiliary(storage);</span>
<span class="udiff-line-modified-added">+         if (thisObject-&gt;m_totalLength &gt; thisObject-&gt;m_table-&gt;length())</span>
<span class="udiff-line-modified-added">+             visitor.appendValues(storage, thisObject-&gt;m_totalLength - thisObject-&gt;m_table-&gt;length());</span>
      }
  }
  
  Structure* ScopedArguments::createStructure(VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
  {
      return Structure::create(vm, globalObject, prototype, TypeInfo(ScopedArgumentsType, StructureFlags), info());
  }
  
<span class="udiff-line-modified-removed">- void ScopedArguments::overrideThings(VM&amp; vm)</span>
<span class="udiff-line-modified-added">+ void ScopedArguments::overrideThings(JSGlobalObject* globalObject)</span>
  {
<span class="udiff-line-modified-removed">-     RELEASE_ASSERT(!storageHeader().overrodeThings);</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     RELEASE_ASSERT(!m_overrodeThings);</span>
  
      putDirect(vm, vm.propertyNames-&gt;length, jsNumber(m_table-&gt;length()), static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
      putDirect(vm, vm.propertyNames-&gt;callee, m_callee.get(), static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
<span class="udiff-line-modified-removed">-     putDirect(vm, vm.propertyNames-&gt;iteratorSymbol, globalObject(vm)-&gt;arrayProtoValuesFunction(), static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));</span>
<span class="udiff-line-modified-added">+     putDirect(vm, vm.propertyNames-&gt;iteratorSymbol, globalObject-&gt;arrayProtoValuesFunction(), static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));</span>
  
<span class="udiff-line-modified-removed">-     storageHeader().overrodeThings = true;</span>
<span class="udiff-line-modified-added">+     m_overrodeThings = true;</span>
  }
  
<span class="udiff-line-modified-removed">- void ScopedArguments::overrideThingsIfNecessary(VM&amp; vm)</span>
<span class="udiff-line-modified-added">+ void ScopedArguments::overrideThingsIfNecessary(JSGlobalObject* globalObject)</span>
  {
<span class="udiff-line-modified-removed">-     if (!storageHeader().overrodeThings)</span>
<span class="udiff-line-modified-removed">-         overrideThings(vm);</span>
<span class="udiff-line-modified-added">+     if (!m_overrodeThings)</span>
<span class="udiff-line-modified-added">+         overrideThings(globalObject);</span>
  }
  
<span class="udiff-line-modified-removed">- void ScopedArguments::unmapArgument(VM&amp; vm, uint32_t i)</span>
<span class="udiff-line-modified-added">+ void ScopedArguments::unmapArgument(JSGlobalObject* globalObject, uint32_t i)</span>
  {
<span class="udiff-line-modified-removed">-     ASSERT_WITH_SECURITY_IMPLICATION(i &lt; storageHeader().totalLength);</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="udiff-line-added">+     ASSERT_WITH_SECURITY_IMPLICATION(i &lt; m_totalLength);</span>
      unsigned namedLength = m_table-&gt;length();
      if (i &lt; namedLength)
          m_table.set(vm, this, m_table-&gt;set(vm, i, ScopeOffset()));
      else
<span class="udiff-line-modified-removed">-         overflowStorage()[i - namedLength].clear();</span>
<span class="udiff-line-modified-added">+         storage()[i - namedLength].clear();</span>
  }
  
<span class="udiff-line-modified-removed">- void ScopedArguments::copyToArguments(ExecState* exec, VirtualRegister firstElementDest, unsigned offset, unsigned length)</span>
<span class="udiff-line-modified-added">+ void ScopedArguments::copyToArguments(JSGlobalObject* globalObject, JSValue* firstElementDest, unsigned offset, unsigned length)</span>
  {
<span class="udiff-line-modified-removed">-     GenericArguments::copyToArguments(exec, firstElementDest, offset, length);</span>
<span class="udiff-line-modified-added">+     GenericArguments::copyToArguments(globalObject, firstElementDest, offset, length);</span>
  }
  
  } // namespace JSC
  
</pre>
<center><a href="SamplingProfiler.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ScopedArguments.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>