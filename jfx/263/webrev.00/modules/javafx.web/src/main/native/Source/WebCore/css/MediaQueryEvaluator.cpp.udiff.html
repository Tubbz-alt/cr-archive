<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/css/MediaQueryEvaluator.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MediaList.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MediaQueryEvaluator.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/css/MediaQueryEvaluator.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -43,13 +43,11 @@</span>
  #include &quot;NodeRenderStyle.h&quot;
  #include &quot;Page.h&quot;
  #include &quot;PlatformScreen.h&quot;
  #include &quot;RenderStyle.h&quot;
  #include &quot;RenderView.h&quot;
<span class="udiff-line-removed">- #include &quot;RuntimeEnabledFeatures.h&quot;</span>
  #include &quot;Settings.h&quot;
<span class="udiff-line-removed">- #include &quot;StyleResolver.h&quot;</span>
  #include &quot;Theme.h&quot;
  #include &lt;wtf/HashMap.h&gt;
  #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  #include &lt;wtf/text/TextStream.h&gt;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -145,11 +143,11 @@</span>
  static bool applyRestrictor(MediaQuery::Restrictor r, bool value)
  {
      return r == MediaQuery::Not ? !value : value;
  }
  
<span class="udiff-line-modified-removed">- bool MediaQueryEvaluator::evaluate(const MediaQuerySet&amp; querySet, StyleResolver* styleResolver) const</span>
<span class="udiff-line-modified-added">+ bool MediaQueryEvaluator::evaluate(const MediaQuerySet&amp; querySet, MediaQueryDynamicResults* dynamicResults, Mode mode) const</span>
  {
      LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;MediaQueryEvaluator::evaluate on &quot; &lt;&lt; (m_document ? m_document-&gt;url().string() : emptyString()));
  
      auto&amp; queries = querySet.queryVector();
      if (!queries.size()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -166,64 +164,61 @@</span>
              continue;
  
          if (mediaTypeMatch(query.mediaType())) {
              auto&amp; expressions = query.expressions();
              // Iterate through expressions, stop if any of them eval to false (AND semantics).
<span class="udiff-line-added">+             bool isDynamic = false;</span>
              size_t j = 0;
              for (; j &lt; expressions.size(); ++j) {
                  bool expressionResult = evaluate(expressions[j]);
<span class="udiff-line-modified-removed">-                 if (styleResolver &amp;&amp; isViewportDependent(expressions[j].mediaFeature()))</span>
<span class="udiff-line-modified-removed">-                     styleResolver-&gt;addViewportDependentMediaQueryResult(expressions[j], expressionResult);</span>
<span class="udiff-line-modified-removed">-                 if (styleResolver &amp;&amp; isAccessibilitySettingsDependent(expressions[j].mediaFeature()))</span>
<span class="udiff-line-modified-removed">-                     styleResolver-&gt;addAccessibilitySettingsDependentMediaQueryResult(expressions[j], expressionResult);</span>
<span class="udiff-line-modified-removed">-                 if (styleResolver &amp;&amp; isAppearanceDependent(expressions[j].mediaFeature()))</span>
<span class="udiff-line-modified-removed">-                     styleResolver-&gt;addAppearanceDependentMediaQueryResult(expressions[j], expressionResult);</span>
<span class="udiff-line-modified-added">+                 if (dynamicResults) {</span>
<span class="udiff-line-modified-added">+                     if (isViewportDependent(expressions[j].mediaFeature())) {</span>
<span class="udiff-line-modified-added">+                         isDynamic = true;</span>
<span class="udiff-line-modified-added">+                         dynamicResults-&gt;viewport.append({ expressions[j], expressionResult });</span>
<span class="udiff-line-modified-added">+                     }</span>
<span class="udiff-line-modified-added">+                     if (isAppearanceDependent(expressions[j].mediaFeature())) {</span>
<span class="udiff-line-added">+                         isDynamic = true;</span>
<span class="udiff-line-added">+                         dynamicResults-&gt;appearance.append({ expressions[j], expressionResult });</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     if (isAccessibilitySettingsDependent(expressions[j].mediaFeature())) {</span>
<span class="udiff-line-added">+                         isDynamic = true;</span>
<span class="udiff-line-added">+                         dynamicResults-&gt;accessibilitySettings.append({ expressions[j], expressionResult });</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (mode == Mode::AlwaysMatchDynamic &amp;&amp; isDynamic)</span>
<span class="udiff-line-added">+                     continue;</span>
<span class="udiff-line-added">+ </span>
                  if (!expressionResult)
                      break;
              }
  
<span class="udiff-line-added">+             if (mode == Mode::AlwaysMatchDynamic &amp;&amp; isDynamic) {</span>
<span class="udiff-line-added">+                 result = true;</span>
<span class="udiff-line-added">+                 continue;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
              // Assume true if we are at the end of the list, otherwise assume false.
              result = applyRestrictor(query.restrictor(), expressions.size() == j);
          } else
              result = applyRestrictor(query.restrictor(), false);
      }
  
      LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;MediaQueryEvaluator::evaluate &quot; &lt;&lt; querySet &lt;&lt; &quot; returning &quot; &lt;&lt; result);
      return result;
  }
  
<span class="udiff-line-modified-removed">- bool MediaQueryEvaluator::evaluate(const MediaQuerySet&amp; querySet, Vector&lt;MediaQueryResult&gt;&amp; viewportDependentResults, Vector&lt;MediaQueryResult&gt;&amp; appearanceDependentResults) const</span>
<span class="udiff-line-modified-added">+ bool MediaQueryEvaluator::evaluateForChanges(const MediaQueryDynamicResults&amp; dynamicResults) const</span>
  {
<span class="udiff-line-modified-removed">-     auto&amp; queries = querySet.queryVector();</span>
<span class="udiff-line-modified-removed">-     if (!queries.size())</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     bool result = false;</span>
<span class="udiff-line-modified-removed">-     for (size_t i = 0; i &lt; queries.size() &amp;&amp; !result; ++i) {</span>
<span class="udiff-line-modified-removed">-         auto&amp; query = queries[i];</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (query.ignored())</span>
<span class="udiff-line-removed">-             continue;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (mediaTypeMatch(query.mediaType())) {</span>
<span class="udiff-line-removed">-             auto&amp; expressions = query.expressions();</span>
<span class="udiff-line-removed">-             size_t j = 0;</span>
<span class="udiff-line-removed">-             for (; j &lt; expressions.size(); ++j) {</span>
<span class="udiff-line-removed">-                 bool expressionResult = evaluate(expressions[j]);</span>
<span class="udiff-line-removed">-                 if (isViewportDependent(expressions[j].mediaFeature()))</span>
<span class="udiff-line-removed">-                     viewportDependentResults.append({ expressions[j], expressionResult });</span>
<span class="udiff-line-removed">-                 if (isAppearanceDependent(expressions[j].mediaFeature()))</span>
<span class="udiff-line-removed">-                     appearanceDependentResults.append({ expressions[j], expressionResult });</span>
<span class="udiff-line-removed">-                 if (!expressionResult)</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             result = applyRestrictor(query.restrictor(), expressions.size() == j);</span>
<span class="udiff-line-removed">-         } else</span>
<span class="udiff-line-removed">-             result = applyRestrictor(query.restrictor(), false);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     auto hasChanges = [&amp;](auto&amp; dynamicResultsVector) {</span>
<span class="udiff-line-modified-added">+         for (auto&amp; dynamicResult : dynamicResultsVector) {</span>
<span class="udiff-line-modified-added">+             if (evaluate(dynamicResult.expression) != dynamicResult.result)</span>
<span class="udiff-line-modified-added">+                 return true;</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+         return false;</span>
<span class="udiff-line-modified-added">+     };</span>
  
<span class="udiff-line-modified-removed">-     return result;</span>
<span class="udiff-line-modified-added">+     return hasChanges(dynamicResults.viewport) || hasChanges(dynamicResults.appearance) || hasChanges(dynamicResults.accessibilitySettings);</span>
  }
  
  template&lt;typename T, typename U&gt; bool compareValue(T a, U b, MediaFeaturePrefix op)
  {
      switch (op) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -243,11 +238,11 @@</span>
  {
      if (!is&lt;CSSAspectRatioValue&gt;(value))
          return emptyString();
  
      auto&amp; aspectRatio = downcast&lt;CSSAspectRatioValue&gt;(*value);
<span class="udiff-line-modified-removed">-     return makeString(FormattedNumber::fixedWidth(aspectRatio.numeratorValue(), 6), &#39;/&#39;, FormattedNumber::fixedWidth(aspectRatio.denominatorValue(), 6));</span>
<span class="udiff-line-modified-added">+     return makeString(aspectRatio.numeratorValue(), &#39;/&#39;, aspectRatio.denominatorValue());</span>
  }
  
  #endif
  
  static bool compareAspectRatioValue(CSSValue* value, int width, int height, MediaFeaturePrefix op)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -260,11 +255,11 @@</span>
  
  static Optional&lt;double&gt; doubleValue(CSSValue* value)
  {
      if (!is&lt;CSSPrimitiveValue&gt;(value) || !downcast&lt;CSSPrimitiveValue&gt;(*value).isNumber())
          return WTF::nullopt;
<span class="udiff-line-modified-removed">-     return downcast&lt;CSSPrimitiveValue&gt;(*value).doubleValue(CSSPrimitiveValue::CSS_NUMBER);</span>
<span class="udiff-line-modified-added">+     return downcast&lt;CSSPrimitiveValue&gt;(*value).doubleValue(CSSUnitType::CSS_NUMBER);</span>
  }
  
  static bool zeroEvaluate(CSSValue* value, MediaFeaturePrefix op)
  {
      auto numericValue = doubleValue(value);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -426,11 +421,11 @@</span>
  
      if (!is&lt;CSSPrimitiveValue&gt;(value))
          return false;
  
      auto&amp; resolution = downcast&lt;CSSPrimitiveValue&gt;(*value);
<span class="udiff-line-modified-removed">-     float resolutionValue = resolution.isNumber() ? resolution.floatValue() : resolution.floatValue(CSSPrimitiveValue::CSS_DPPX);</span>
<span class="udiff-line-modified-added">+     float resolutionValue = resolution.isNumber() ? resolution.floatValue() : resolution.floatValue(CSSUnitType::CSS_DPPX);</span>
      bool result = compareValue(deviceScaleFactor, resolutionValue, op);
      LOG_WITH_STREAM(MediaQueries, stream &lt;&lt; &quot;  evaluateResolution: &quot; &lt;&lt; op &lt;&lt; &quot; &quot; &lt;&lt; resolutionValue &lt;&lt; &quot; device scale factor &quot; &lt;&lt; deviceScaleFactor &lt;&lt; &quot;: &quot; &lt;&lt; result);
      return result;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -449,10 +444,37 @@</span>
      UNUSED_PARAM(op);
      return false;
  #endif
  }
  
<span class="udiff-line-added">+ static bool dynamicRangeEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp; frame, MediaFeaturePrefix)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!value)</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!frame.settings().hdrMediaCapabilitiesEnabled())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     bool supportsHighDynamicRange;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (frame.settings().forcedSupportsHighDynamicRangeValue() == Settings::ForcedAccessibilityValue::On)</span>
<span class="udiff-line-added">+         supportsHighDynamicRange = true;</span>
<span class="udiff-line-added">+     else if (frame.settings().forcedSupportsHighDynamicRangeValue() == Settings::ForcedAccessibilityValue::Off)</span>
<span class="udiff-line-added">+         supportsHighDynamicRange = false;</span>
<span class="udiff-line-added">+     else</span>
<span class="udiff-line-added">+         supportsHighDynamicRange = screenSupportsHighDynamicRange(frame.mainFrame().view());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     switch (downcast&lt;CSSPrimitiveValue&gt;(*value).valueID()) {</span>
<span class="udiff-line-added">+     case CSSValueHigh:</span>
<span class="udiff-line-added">+         return supportsHighDynamicRange;</span>
<span class="udiff-line-added">+     case CSSValueStandard:</span>
<span class="udiff-line-added">+         return true;</span>
<span class="udiff-line-added">+     default:</span>
<span class="udiff-line-added">+         return false; // Any unknown value should not be considered a match.</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  static bool gridEvaluate(CSSValue* value, const CSSToLengthConversionData&amp;, Frame&amp;, MediaFeaturePrefix op)
  {
      return zeroEvaluate(value, op);
  }
  
</pre>
<center><a href="MediaList.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MediaQueryEvaluator.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>