<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/RTCPeerConnection.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="RTCDataChannelEvent.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RTCPeerConnection.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/RTCPeerConnection.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -38,10 +38,11 @@</span>
  
  #include &quot;Document.h&quot;
  #include &quot;Event.h&quot;
  #include &quot;EventNames.h&quot;
  #include &quot;Frame.h&quot;
<span class="udiff-line-added">+ #include &quot;JSDOMPromiseDeferred.h&quot;</span>
  #include &quot;JSRTCPeerConnection.h&quot;
  #include &quot;Logging.h&quot;
  #include &quot;MediaEndpointConfiguration.h&quot;
  #include &quot;MediaStream.h&quot;
  #include &quot;MediaStreamTrack.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -65,36 +66,34 @@</span>
  
  WTF_MAKE_ISO_ALLOCATED_IMPL(RTCPeerConnection);
  
  Ref&lt;RTCPeerConnection&gt; RTCPeerConnection::create(ScriptExecutionContext&amp; context)
  {
<span class="udiff-line-modified-removed">-     auto peerConnection = adoptRef(*new RTCPeerConnection(context));</span>
<span class="udiff-line-modified-added">+     auto&amp; document = downcast&lt;Document&gt;(context);</span>
<span class="udiff-line-added">+     auto peerConnection = adoptRef(*new RTCPeerConnection(document));</span>
      peerConnection-&gt;suspendIfNeeded();
<span class="udiff-line-removed">-     // RTCPeerConnection may send events at about any time during its lifetime.</span>
<span class="udiff-line-removed">-     // Let&#39;s make it uncollectable until the pc is closed by JS or the page stops it.</span>
      if (!peerConnection-&gt;isClosed()) {
<span class="udiff-line-modified-removed">-         peerConnection-&gt;m_pendingActivity = peerConnection-&gt;makePendingActivity(peerConnection.get());</span>
<span class="udiff-line-removed">-         if (auto* page = downcast&lt;Document&gt;(context).page()) {</span>
<span class="udiff-line-modified-added">+         if (auto* page = document.page()) {</span>
              peerConnection-&gt;registerToController(page-&gt;rtcController());
<span class="udiff-line-modified-removed">-             page-&gt;libWebRTCProvider().setEnableLogging(!context.sessionID().isEphemeral());</span>
<span class="udiff-line-modified-added">+             page-&gt;libWebRTCProvider().setEnableLogging(!page-&gt;sessionID().isEphemeral());</span>
          }
      }
      return peerConnection;
  }
  
<span class="udiff-line-modified-removed">- RTCPeerConnection::RTCPeerConnection(ScriptExecutionContext&amp; context)</span>
<span class="udiff-line-modified-removed">-     : ActiveDOMObject(&amp;context)</span>
<span class="udiff-line-modified-added">+ RTCPeerConnection::RTCPeerConnection(Document&amp; document)</span>
<span class="udiff-line-modified-added">+     : ActiveDOMObject(document)</span>
  #if !RELEASE_LOG_DISABLED
<span class="udiff-line-modified-removed">-     , m_logger(downcast&lt;Document&gt;(context).logger())</span>
<span class="udiff-line-modified-added">+     , m_logger(document.logger())</span>
      , m_logIdentifier(reinterpret_cast&lt;const void*&gt;(cryptographicallyRandomNumber()))
  #endif
      , m_backend(PeerConnectionBackend::create(*this))
  {
      ALWAYS_LOG(LOGIDENTIFIER);
  
  #if !RELEASE_LOG_DISABLED
<span class="udiff-line-modified-removed">-     auto* page = downcast&lt;Document&gt;(context).page();</span>
<span class="udiff-line-modified-added">+     auto* page = document.page();</span>
      if (page &amp;&amp; !page-&gt;settings().webRTCEncryptionEnabled())
          ALWAYS_LOG(LOGIDENTIFIER, &quot;encryption is disabled&quot;);
  #endif
  
      if (!m_backend)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -194,10 +193,11 @@</span>
      if (isClosed()) {
          promise.reject(InvalidStateError);
          return;
      }
  
<span class="udiff-line-added">+     addPendingPromise(promise);</span>
      m_backend-&gt;createOffer(WTFMove(options), WTFMove(promise));
  }
  
  void RTCPeerConnection::queuedCreateAnswer(RTCAnswerOptions&amp;&amp; options, SessionDescriptionPromise&amp;&amp; promise)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -205,10 +205,11 @@</span>
      if (isClosed()) {
          promise.reject(InvalidStateError);
          return;
      }
  
<span class="udiff-line-added">+     addPendingPromise(promise);</span>
      m_backend-&gt;createAnswer(WTFMove(options), WTFMove(promise));
  }
  
  void RTCPeerConnection::queuedSetLocalDescription(RTCSessionDescription&amp; description, DOMPromiseDeferred&lt;void&gt;&amp;&amp; promise)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -216,10 +217,11 @@</span>
      if (isClosed()) {
          promise.reject(InvalidStateError);
          return;
      }
  
<span class="udiff-line-added">+     addPendingPromise(promise);</span>
      m_backend-&gt;setLocalDescription(description, WTFMove(promise));
  }
  
  RefPtr&lt;RTCSessionDescription&gt; RTCPeerConnection::localDescription() const
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -242,10 +244,11 @@</span>
  
      if (isClosed()) {
          promise.reject(InvalidStateError);
          return;
      }
<span class="udiff-line-added">+     addPendingPromise(promise);</span>
      m_backend-&gt;setRemoteDescription(description, WTFMove(promise));
  }
  
  RefPtr&lt;RTCSessionDescription&gt; RTCPeerConnection::remoteDescription() const
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -269,10 +272,11 @@</span>
      if (isClosed()) {
          promise.reject(InvalidStateError);
          return;
      }
  
<span class="udiff-line-added">+     addPendingPromise(promise);</span>
      m_backend-&gt;addIceCandidate(rtcCandidate, WTFMove(promise));
  }
  
  // Implementation of https://w3c.github.io/webrtc-pc/#set-pc-configuration
  static inline ExceptionOr&lt;Vector&lt;MediaEndpointConfiguration::IceServerInfo&gt;&gt; iceServersFromConfiguration(RTCConfiguration&amp; newConfiguration, const RTCConfiguration* existingConfiguration, bool isLocalDescriptionSet)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -316,11 +320,11 @@</span>
  }
  
  ExceptionOr&lt;Vector&lt;MediaEndpointConfiguration::CertificatePEM&gt;&gt; RTCPeerConnection::certificatesFromConfiguration(const RTCConfiguration&amp; configuration)
  {
      auto currentMilliSeconds = WallTime::now().secondsSinceEpoch().milliseconds();
<span class="udiff-line-modified-removed">-     auto&amp; origin = downcast&lt;Document&gt;(*scriptExecutionContext()).securityOrigin();</span>
<span class="udiff-line-modified-added">+     auto&amp; origin = document()-&gt;securityOrigin();</span>
  
      Vector&lt;MediaEndpointConfiguration::CertificatePEM&gt; certificates;
      certificates.reserveInitialCapacity(configuration.certificates.size());
      for (auto&amp; certificate : configuration.certificates) {
          if (!origin.isSameOriginAs(certificate-&gt;origin()))
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -396,14 +400,15 @@</span>
                  m_backend-&gt;getStats(transceiver-&gt;receiver(), WTFMove(promise));
                  return;
              }
          }
      }
<span class="udiff-line-added">+     addPendingPromise(promise.get());</span>
      m_backend-&gt;getStats(WTFMove(promise));
  }
  
<span class="udiff-line-modified-removed">- ExceptionOr&lt;Ref&lt;RTCDataChannel&gt;&gt; RTCPeerConnection::createDataChannel(ScriptExecutionContext&amp; context, String&amp;&amp; label, RTCDataChannelInit&amp;&amp; options)</span>
<span class="udiff-line-modified-added">+ ExceptionOr&lt;Ref&lt;RTCDataChannel&gt;&gt; RTCPeerConnection::createDataChannel(String&amp;&amp; label, RTCDataChannelInit&amp;&amp; options)</span>
  {
      ALWAYS_LOG(LOGIDENTIFIER);
  
      if (isClosed())
          return Exception { InvalidStateError };
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -419,18 +424,19 @@</span>
  
      auto channelHandler = m_backend-&gt;createDataChannelHandler(label, options);
      if (!channelHandler)
          return Exception { NotSupportedError };
  
<span class="udiff-line-modified-removed">-     return RTCDataChannel::create(context, WTFMove(channelHandler), WTFMove(label), WTFMove(options));</span>
<span class="udiff-line-modified-added">+     return RTCDataChannel::create(*document(), WTFMove(channelHandler), WTFMove(label), WTFMove(options));</span>
  }
  
  bool RTCPeerConnection::doClose()
  {
      if (isClosed())
          return false;
  
<span class="udiff-line-added">+     m_shouldDelayTasks = false;</span>
      m_connectionState = RTCPeerConnectionState::Closed;
      m_iceConnectionState = RTCIceConnectionState::Closed;
      m_signalingState = RTCSignalingState::Closed;
  
      for (auto&amp; transceiver : m_transceiverSet-&gt;list()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -447,35 +453,32 @@</span>
      if (!doClose())
          return;
  
      updateConnectionState();
      ASSERT(isClosed());
<span class="udiff-line-modified-removed">-     doStop();</span>
<span class="udiff-line-modified-added">+     m_backend-&gt;close();</span>
  }
  
  void RTCPeerConnection::emulatePlatformEvent(const String&amp; action)
  {
      m_backend-&gt;emulatePlatformEvent(action);
  }
  
  void RTCPeerConnection::stop()
  {
<span class="udiff-line-modified-removed">-     if (!doClose())</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+     doClose();</span>
      doStop();
  }
  
  void RTCPeerConnection::doStop()
  {
      if (m_isStopped)
          return;
  
      m_isStopped = true;
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     m_backend-&gt;stop();</span>
<span class="udiff-line-removed">-     m_pendingActivity = nullptr;</span>
<span class="udiff-line-modified-added">+     if (m_backend)</span>
<span class="udiff-line-modified-added">+         m_backend-&gt;stop();</span>
  }
  
  void RTCPeerConnection::registerToController(RTCController&amp; controller)
  {
      m_controller = &amp;controller;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -491,18 +494,48 @@</span>
  const char* RTCPeerConnection::activeDOMObjectName() const
  {
      return &quot;RTCPeerConnection&quot;;
  }
  
<span class="udiff-line-modified-removed">- bool RTCPeerConnection::canSuspendForDocumentSuspension() const</span>
<span class="udiff-line-modified-added">+ void RTCPeerConnection::suspend(ReasonForSuspension reason)</span>
  {
<span class="udiff-line-modified-removed">-     return !hasPendingActivity();</span>
<span class="udiff-line-modified-added">+     if (reason != ReasonForSuspension::BackForwardCache)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_shouldDelayTasks = true;</span>
<span class="udiff-line-added">+     m_backend-&gt;suspend();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void RTCPeerConnection::resume()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!m_shouldDelayTasks)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_shouldDelayTasks = false;</span>
<span class="udiff-line-added">+     m_backend-&gt;resume();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     scriptExecutionContext()-&gt;postTask([this, protectedThis = makeRef(*this)](auto&amp;) {</span>
<span class="udiff-line-added">+         if (m_isStopped || m_shouldDelayTasks)</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         auto tasks = WTFMove(m_pendingTasks);</span>
<span class="udiff-line-added">+         for (auto&amp; task : tasks)</span>
<span class="udiff-line-added">+             task();</span>
<span class="udiff-line-added">+     });</span>
  }
  
  bool RTCPeerConnection::hasPendingActivity() const
  {
<span class="udiff-line-modified-removed">-     return !m_isStopped;</span>
<span class="udiff-line-modified-added">+     if (m_isStopped)</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // This returns true if we have pending promises to be resolved.</span>
<span class="udiff-line-added">+     if (ActiveDOMObject::hasPendingActivity())</span>
<span class="udiff-line-added">+         return true;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // As long as the connection is not stopped and it has event listeners, it may dispatch events.</span>
<span class="udiff-line-added">+     return hasEventListeners();</span>
  }
  
  void RTCPeerConnection::addTransceiver(Ref&lt;RTCRtpTransceiver&gt;&amp;&amp; transceiver)
  {
      INFO_LOG(LOGIDENTIFIER);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -522,11 +555,11 @@</span>
      scriptExecutionContext()-&gt;postTask([protectedThis = makeRef(*this), newState](ScriptExecutionContext&amp;) {
          if (protectedThis-&gt;isClosed() || protectedThis-&gt;m_iceGatheringState == newState)
              return;
  
          protectedThis-&gt;m_iceGatheringState = newState;
<span class="udiff-line-modified-removed">-         protectedThis-&gt;dispatchEvent(Event::create(eventNames().icegatheringstatechangeEvent, Event::CanBubble::No, Event::IsCancelable::No));</span>
<span class="udiff-line-modified-added">+         protectedThis-&gt;dispatchEventWhenFeasible(Event::create(eventNames().icegatheringstatechangeEvent, Event::CanBubble::No, Event::IsCancelable::No));</span>
          protectedThis-&gt;updateConnectionState();
      });
  }
  
  void RTCPeerConnection::updateIceConnectionState(RTCIceConnectionState newState)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -536,11 +569,11 @@</span>
      scriptExecutionContext()-&gt;postTask([protectedThis = makeRef(*this), newState](ScriptExecutionContext&amp;) {
          if (protectedThis-&gt;isClosed() || protectedThis-&gt;m_iceConnectionState == newState)
              return;
  
          protectedThis-&gt;m_iceConnectionState = newState;
<span class="udiff-line-modified-removed">-         protectedThis-&gt;dispatchEvent(Event::create(eventNames().iceconnectionstatechangeEvent, Event::CanBubble::No, Event::IsCancelable::No));</span>
<span class="udiff-line-modified-added">+         protectedThis-&gt;dispatchEventWhenFeasible(Event::create(eventNames().iceconnectionstatechangeEvent, Event::CanBubble::No, Event::IsCancelable::No));</span>
          protectedThis-&gt;updateConnectionState();
      });
  }
  
  void RTCPeerConnection::updateConnectionState()
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -566,47 +599,58 @@</span>
          return;
  
      INFO_LOG(LOGIDENTIFIER, &quot;state changed from: &quot; , m_connectionState, &quot; to &quot;, state);
  
      m_connectionState = state;
<span class="udiff-line-modified-removed">-     dispatchEvent(Event::create(eventNames().connectionstatechangeEvent, Event::CanBubble::No, Event::IsCancelable::No));</span>
<span class="udiff-line-modified-added">+     dispatchEventWhenFeasible(Event::create(eventNames().connectionstatechangeEvent, Event::CanBubble::No, Event::IsCancelable::No));</span>
  }
  
  void RTCPeerConnection::scheduleNegotiationNeededEvent()
  {
      scriptExecutionContext()-&gt;postTask([protectedThis = makeRef(*this)](ScriptExecutionContext&amp;) {
          if (protectedThis-&gt;isClosed())
              return;
          if (!protectedThis-&gt;m_backend-&gt;isNegotiationNeeded())
              return;
          protectedThis-&gt;m_backend-&gt;clearNegotiationNeededState();
<span class="udiff-line-modified-removed">-         protectedThis-&gt;dispatchEvent(Event::create(eventNames().negotiationneededEvent, Event::CanBubble::No, Event::IsCancelable::No));</span>
<span class="udiff-line-modified-added">+         protectedThis-&gt;dispatchEventWhenFeasible(Event::create(eventNames().negotiationneededEvent, Event::CanBubble::No, Event::IsCancelable::No));</span>
      });
  }
  
<span class="udiff-line-modified-removed">- void RTCPeerConnection::fireEvent(Event&amp; event)</span>
<span class="udiff-line-modified-added">+ void RTCPeerConnection::doTask(Function&lt;void()&gt;&amp;&amp; task)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (m_shouldDelayTasks || !m_pendingTasks.isEmpty()) {</span>
<span class="udiff-line-added">+         m_pendingTasks.append(WTFMove(task));</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     task();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void RTCPeerConnection::dispatchEventWhenFeasible(Ref&lt;Event&gt;&amp;&amp; event)</span>
  {
<span class="udiff-line-modified-removed">-     dispatchEvent(event);</span>
<span class="udiff-line-modified-added">+     doTask([this, event = WTFMove(event)] {</span>
<span class="udiff-line-added">+         dispatchEvent(event);</span>
<span class="udiff-line-added">+     });</span>
  }
  
  void RTCPeerConnection::dispatchEvent(Event&amp; event)
  {
      INFO_LOG(LOGIDENTIFIER, &quot;dispatching &#39;&quot;, event.type(), &quot;&#39;&quot;);
      EventTarget::dispatchEvent(event);
  }
  
<span class="udiff-line-modified-removed">- static inline ExceptionOr&lt;PeerConnectionBackend::CertificateInformation&gt; certificateTypeFromAlgorithmIdentifier(JSC::ExecState&amp; state, RTCPeerConnection::AlgorithmIdentifier&amp;&amp; algorithmIdentifier)</span>
<span class="udiff-line-modified-added">+ static inline ExceptionOr&lt;PeerConnectionBackend::CertificateInformation&gt; certificateTypeFromAlgorithmIdentifier(JSC::JSGlobalObject&amp; lexicalGlobalObject, RTCPeerConnection::AlgorithmIdentifier&amp;&amp; algorithmIdentifier)</span>
  {
      if (WTF::holds_alternative&lt;String&gt;(algorithmIdentifier))
          return Exception { NotSupportedError, &quot;Algorithm is not supported&quot;_s };
  
      auto&amp; value = WTF::get&lt;JSC::Strong&lt;JSC::JSObject&gt;&gt;(algorithmIdentifier);
  
<span class="udiff-line-modified-removed">-     JSC::VM&amp; vm = state.vm();</span>
<span class="udiff-line-modified-added">+     JSC::VM&amp; vm = lexicalGlobalObject.vm();</span>
      auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="udiff-line-modified-removed">-     auto parameters = convertDictionary&lt;RTCPeerConnection::CertificateParameters&gt;(state, value.get());</span>
<span class="udiff-line-modified-added">+     auto parameters = convertDictionary&lt;RTCPeerConnection::CertificateParameters&gt;(lexicalGlobalObject, value.get());</span>
      if (UNLIKELY(scope.exception())) {
          scope.clearException();
          return Exception { TypeError, &quot;Unable to read certificate parameters&quot;_s };
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -638,18 +682,18 @@</span>
      }
  
      return Exception { NotSupportedError, &quot;Algorithm is not supported&quot;_s };
  }
  
<span class="udiff-line-modified-removed">- void RTCPeerConnection::generateCertificate(JSC::ExecState&amp; state, AlgorithmIdentifier&amp;&amp; algorithmIdentifier, DOMPromiseDeferred&lt;IDLInterface&lt;RTCCertificate&gt;&gt;&amp;&amp; promise)</span>
<span class="udiff-line-modified-added">+ void RTCPeerConnection::generateCertificate(JSC::JSGlobalObject&amp; lexicalGlobalObject, AlgorithmIdentifier&amp;&amp; algorithmIdentifier, DOMPromiseDeferred&lt;IDLInterface&lt;RTCCertificate&gt;&gt;&amp;&amp; promise)</span>
  {
<span class="udiff-line-modified-removed">-     auto parameters = certificateTypeFromAlgorithmIdentifier(state, WTFMove(algorithmIdentifier));</span>
<span class="udiff-line-modified-added">+     auto parameters = certificateTypeFromAlgorithmIdentifier(lexicalGlobalObject, WTFMove(algorithmIdentifier));</span>
      if (parameters.hasException()) {
          promise.reject(parameters.releaseException());
          return;
      }
<span class="udiff-line-modified-removed">-     auto&amp; document = downcast&lt;Document&gt;(*JSC::jsCast&lt;JSDOMGlobalObject*&gt;(state.lexicalGlobalObject())-&gt;scriptExecutionContext());</span>
<span class="udiff-line-modified-added">+     auto&amp; document = downcast&lt;Document&gt;(*JSC::jsCast&lt;JSDOMGlobalObject*&gt;(&amp;lexicalGlobalObject)-&gt;scriptExecutionContext());</span>
      PeerConnectionBackend::generateCertificate(document, parameters.returnValue(), WTFMove(promise));
  }
  
  Vector&lt;std::reference_wrapper&lt;RTCRtpSender&gt;&gt; RTCPeerConnection::getSenders() const
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -667,10 +711,15 @@</span>
  {
      m_backend-&gt;collectTransceivers();
      return m_transceiverSet-&gt;list();
  }
  
<span class="udiff-line-added">+ Document* RTCPeerConnection::document()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return downcast&lt;Document&gt;(scriptExecutionContext());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  #if !RELEASE_LOG_DISABLED
  WTFLogChannel&amp; RTCPeerConnection::logChannel() const
  {
      return LogWebRTC;
  }
</pre>
<center><a href="RTCDataChannelEvent.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RTCPeerConnection.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>