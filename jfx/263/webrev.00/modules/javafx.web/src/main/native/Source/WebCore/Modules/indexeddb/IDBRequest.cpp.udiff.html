<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/IDBRequest.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IDBOpenDBRequest.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IDBRequest.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/IDBRequest.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -150,11 +150,11 @@</span>
      m_requestedIndexRecordType = requestedRecordType;
  }
  
  IDBRequest::~IDBRequest()
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      WTF::switchOn(m_result,
          [] (RefPtr&lt;IDBCursor&gt;&amp; cursor) { cursor-&gt;clearRequest(); },
          [] (const auto&amp;) { }
      );
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -168,44 +168,44 @@</span>
      return IDBRequest::Result { m_result };
  }
  
  ExceptionOr&lt;DOMException*&gt; IDBRequest::error() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (!isDone())
          return Exception { InvalidStateError, &quot;Failed to read the &#39;error&#39; property from &#39;IDBRequest&#39;: The request has not finished.&quot;_s };
  
      return m_domError.get();
  }
  
  void IDBRequest::setSource(IDBCursor&amp; cursor)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      m_source = Source { &amp;cursor };
  }
  
  void IDBRequest::setVersionChangeTransaction(IDBTransaction&amp; transaction)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(!m_transaction);
      ASSERT(transaction.isVersionChange());
      ASSERT(!transaction.isFinishedOrFinishing());
  
      m_transaction = &amp;transaction;
  }
  
  RefPtr&lt;WebCore::IDBTransaction&gt; IDBRequest::transaction() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      return m_shouldExposeTransactionToDOM ? m_transaction : nullptr;
  }
  
  uint64_t IDBRequest::sourceObjectStoreIdentifier() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (!m_source)
          return 0;
  
      return WTF::switchOn(m_source.value(),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -215,11 +215,11 @@</span>
      );
  }
  
  uint64_t IDBRequest::sourceIndexIdentifier() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (!m_source)
          return 0;
  
      return WTF::switchOn(m_source.value(),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -229,53 +229,47 @@</span>
      );
  }
  
  IndexedDB::ObjectStoreRecordType IDBRequest::requestedObjectStoreRecordType() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      return m_requestedObjectStoreRecordType;
  }
  
  IndexedDB::IndexRecordType IDBRequest::requestedIndexRecordType() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(m_source);
      ASSERT(WTF::holds_alternative&lt;RefPtr&lt;IDBIndex&gt;&gt;(m_source.value()));
  
      return m_requestedIndexRecordType;
  }
  
  EventTargetInterface IDBRequest::eventTargetInterface() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      return IDBRequestEventTargetInterfaceType;
  }
  
  const char* IDBRequest::activeDOMObjectName() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      return &quot;IDBRequest&quot;;
  }
  
<span class="udiff-line-removed">- bool IDBRequest::canSuspendForDocumentSuspension() const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  bool IDBRequest::hasPendingActivity() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current() || Thread::mayBeGCThread());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()) || Thread::mayBeGCThread());</span>
      return !m_contextStopped &amp;&amp; m_hasPendingActivity;
  }
  
  void IDBRequest::stop()
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(!m_contextStopped);
  
      cancelForStop();
  
      removeAllEventListeners();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -290,23 +284,22 @@</span>
      // The base IDBRequest class has nothing additional to do here.
  }
  
  void IDBRequest::enqueueEvent(Ref&lt;Event&gt;&amp;&amp; event)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      if (m_contextStopped)
          return;
  
<span class="udiff-line-modified-removed">-     event-&gt;setTarget(this);</span>
<span class="udiff-line-removed">-     scriptExecutionContext()-&gt;eventQueue().enqueueEvent(WTFMove(event));</span>
<span class="udiff-line-modified-added">+     queueTaskToDispatchEvent(*this, TaskSource::DatabaseAccess, WTFMove(event));</span>
  }
  
  void IDBRequest::dispatchEvent(Event&amp; event)
  {
      LOG(IndexedDB, &quot;IDBRequest::dispatchEvent - %s (%p)&quot;, event.type().string().utf8().data(), this);
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(m_hasPendingActivity);
      ASSERT(!m_contextStopped);
  
      auto protectedThis = makeRef(*this);
      m_dispatchingEvent = true;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -335,29 +328,29 @@</span>
  
      m_dispatchingEvent = false;
      if (!m_transaction)
          return;
  
<span class="udiff-line-removed">-     // The request should only remain in the transaction&#39;s request list if it represents a pending cursor operation, or this is an open request that was blocked.</span>
<span class="udiff-line-removed">-     if (!m_pendingCursor &amp;&amp; event.type() != eventNames().blockedEvent)</span>
<span class="udiff-line-removed">-         m_transaction-&gt;removeRequest(*this);</span>
<span class="udiff-line-removed">- </span>
      if (m_hasUncaughtException)
          m_transaction-&gt;abortDueToFailedRequest(DOMException::create(AbortError, &quot;IDBTransaction will abort due to uncaught exception in an event handler&quot;_s));
      else if (!event.defaultPrevented() &amp;&amp; event.type() == eventNames().errorEvent &amp;&amp; !m_transaction-&gt;isFinishedOrFinishing()) {
          ASSERT(m_domError);
          m_transaction-&gt;abortDueToFailedRequest(*m_domError);
      }
  
      m_transaction-&gt;finishedDispatchEventForRequest(*this);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // The request should only remain in the transaction&#39;s request list if it represents a pending cursor operation, or this is an open request that was blocked.</span>
<span class="udiff-line-added">+     if (!m_pendingCursor &amp;&amp; event.type() != eventNames().blockedEvent)</span>
<span class="udiff-line-added">+         m_transaction-&gt;removeRequest(*this);</span>
  }
  
  void IDBRequest::uncaughtExceptionInEventHandler()
  {
      LOG(IndexedDB, &quot;IDBRequest::uncaughtExceptionInEventHandler&quot;);
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      if (m_dispatchingEvent) {
          ASSERT(!m_hasUncaughtException);
          m_hasUncaughtException = true;
          return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -366,11 +359,11 @@</span>
          m_transaction-&gt;abortDueToFailedRequest(DOMException::create(AbortError, &quot;IDBTransaction will abort due to uncaught exception in an event handler&quot;_s));
  }
  
  void IDBRequest::setResult(const IDBKeyData&amp; keyData)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto* context = scriptExecutionContext();
      if (!context)
          return;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -380,11 +373,11 @@</span>
      m_resultWrapper = { };
  }
  
  void IDBRequest::setResult(const Vector&lt;IDBKeyData&gt;&amp; keyDatas)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto* context = scriptExecutionContext();
      if (!context)
          return;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -394,11 +387,11 @@</span>
      m_resultWrapper = { };
  }
  
  void IDBRequest::setResult(const IDBGetAllResult&amp; result)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto* context = scriptExecutionContext();
      if (!context)
          return;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -408,11 +401,11 @@</span>
      m_resultWrapper = { };
  }
  
  void IDBRequest::setResult(uint64_t number)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto* context = scriptExecutionContext();
      if (!context)
          return;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -422,11 +415,11 @@</span>
      m_resultWrapper = { };
  }
  
  void IDBRequest::setResultToStructuredClone(const IDBGetResult&amp; result)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      LOG(IndexedDB, &quot;IDBRequest::setResultToStructuredClone&quot;);
  
      auto* context = scriptExecutionContext();
      if (!context)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -438,11 +431,11 @@</span>
      m_resultWrapper = { };
  }
  
  void IDBRequest::setResultToUndefined()
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto* context = scriptExecutionContext();
      if (!context)
          return;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -452,21 +445,21 @@</span>
      m_resultWrapper = { };
  }
  
  IDBCursor* IDBRequest::resultCursor()
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      return WTF::switchOn(m_result,
          [] (const RefPtr&lt;IDBCursor&gt;&amp; cursor) -&gt; IDBCursor* { return cursor.get(); },
          [] (const auto&amp;) -&gt; IDBCursor* { return nullptr; }
      );
  }
  
  void IDBRequest::willIterateCursor(IDBCursor&amp; cursor)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(isDone());
      ASSERT(scriptExecutionContext());
      ASSERT(m_transaction);
      ASSERT(!m_pendingCursor);
      ASSERT(&amp;cursor == resultCursor());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -490,11 +483,11 @@</span>
      m_idbError = IDBError { };
  }
  
  void IDBRequest::didOpenOrIterateCursor(const IDBResultData&amp; resultData)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(m_pendingCursor);
  
      auto* context = scriptExecutionContext();
      if (!context)
          return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -504,11 +497,11 @@</span>
  
      m_result = NullResultType::Empty;
      m_resultWrapper = { };
  
      if (resultData.type() == IDBResultType::IterateCursorSuccess || resultData.type() == IDBResultType::OpenCursorSuccess) {
<span class="udiff-line-modified-removed">-         if (m_pendingCursor-&gt;setGetResult(*this, resultData.getResult()) &amp;&amp; m_cursorWrapper)</span>
<span class="udiff-line-modified-added">+         if (m_pendingCursor-&gt;setGetResult(*this, resultData.getResult(), m_currentTransactionOperationID) &amp;&amp; m_cursorWrapper)</span>
              m_resultWrapper = m_cursorWrapper;
          if (resultData.getResult().isDefined())
              m_result = m_pendingCursor;
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -517,11 +510,11 @@</span>
      completeRequestAndDispatchEvent(resultData);
  }
  
  void IDBRequest::completeRequestAndDispatchEvent(const IDBResultData&amp; resultData)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      m_readyState = ReadyState::Done;
  
      m_idbError = resultData.error();
      if (!m_idbError.isNull())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -532,27 +525,27 @@</span>
  
  void IDBRequest::onError()
  {
      LOG(IndexedDB, &quot;IDBRequest::onError&quot;);
  
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      ASSERT(!m_idbError.isNull());
  
      m_domError = m_idbError.toDOMException();
      enqueueEvent(Event::create(eventNames().errorEvent, Event::CanBubble::Yes, Event::IsCancelable::Yes));
  }
  
  void IDBRequest::onSuccess()
  {
      LOG(IndexedDB, &quot;IDBRequest::onSuccess&quot;);
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
      enqueueEvent(Event::create(eventNames().successEvent, Event::CanBubble::No, Event::IsCancelable::No));
  }
  
  void IDBRequest::setResult(Ref&lt;IDBDatabase&gt;&amp;&amp; database)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(originThread()));</span>
  
      auto* context = scriptExecutionContext();
      if (!context)
          return;
  
</pre>
<center><a href="IDBOpenDBRequest.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IDBRequest.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>