<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/css/DOMCSSRegisterCustomProperty.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DOMCSSNamespace.idl.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DeprecatedCSSOMPrimitiveValue.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/css/DOMCSSRegisterCustomProperty.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;DOMCSSRegisterCustomProperty.h&quot;
 28 
 29 #include &quot;CSSCustomPropertyValue.h&quot;
 30 #include &quot;CSSPropertyNames.h&quot;
 31 #include &quot;CSSPropertyParser.h&quot;
 32 #include &quot;CSSRegisteredCustomProperty.h&quot;
 33 #include &quot;CSSTokenizer.h&quot;
 34 #include &quot;DOMCSSNamespace.h&quot;
 35 #include &quot;Document.h&quot;

 36 #include &quot;StyleBuilderConverter.h&quot;

 37 #include &lt;wtf/text/WTFString.h&gt;
 38 
 39 namespace WebCore {
 40 
 41 ExceptionOr&lt;void&gt; DOMCSSRegisterCustomProperty::registerProperty(Document&amp; document, const DOMCSSCustomPropertyDescriptor&amp; descriptor)
 42 {
 43     if (!isCustomPropertyName(descriptor.name))
 44         return Exception { SyntaxError, &quot;The name of this property is not a custom property name.&quot; };
 45 
 46     RefPtr&lt;CSSCustomPropertyValue&gt; initialValue;
 47     if (!descriptor.initialValue.isEmpty()) {
 48         CSSTokenizer tokenizer(descriptor.initialValue);
<span class="line-modified"> 49         StyleResolver styleResolver(document);</span>
 50 
 51         // We need to initialize this so that we can successfully parse computationally dependent values (like em units).
 52         // We don&#39;t actually need the values to be accurate, since they will be rejected later anyway
<span class="line-modified"> 53         styleResolver.applyPropertyToStyle(CSSPropertyInvalid, nullptr, styleResolver.defaultStyleForElement());</span>
<span class="line-removed"> 54         styleResolver.updateFont();</span>
 55 
 56         HashSet&lt;CSSPropertyID&gt; dependencies;
 57         CSSPropertyParser::collectParsedCustomPropertyValueDependencies(descriptor.syntax, false, dependencies, tokenizer.tokenRange(), strictCSSParserContext());
 58 
 59         if (!dependencies.isEmpty())
 60             return Exception { SyntaxError, &quot;The given initial value must be computationally independent.&quot; };
 61 
<span class="line-modified"> 62         initialValue = CSSPropertyParser::parseTypedCustomPropertyValue(descriptor.name, descriptor.syntax, tokenizer.tokenRange(), styleResolver, strictCSSParserContext());</span>






 63 
 64         if (!initialValue || !initialValue-&gt;isResolved())
 65             return Exception { SyntaxError, &quot;The given initial value does not parse for the given syntax.&quot; };
 66 
 67         initialValue-&gt;collectDirectComputationalDependencies(dependencies);
 68         initialValue-&gt;collectDirectRootComputationalDependencies(dependencies);
 69 
 70         if (!dependencies.isEmpty())
 71             return Exception { SyntaxError, &quot;The given initial value must be computationally independent.&quot; };
 72     }
 73 
 74     CSSRegisteredCustomProperty property { descriptor.name, descriptor.syntax, descriptor.inherits, WTFMove(initialValue) };
 75     if (!document.registerCSSProperty(WTFMove(property)))
 76         return Exception { InvalidModificationError, &quot;This property has already been registered.&quot; };
 77 
 78     document.styleScope().didChangeStyleSheetEnvironment();
 79 
 80     return { };
 81 }
 82 
</pre>
</td>
<td>
<hr />
<pre>
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;DOMCSSRegisterCustomProperty.h&quot;
 28 
 29 #include &quot;CSSCustomPropertyValue.h&quot;
 30 #include &quot;CSSPropertyNames.h&quot;
 31 #include &quot;CSSPropertyParser.h&quot;
 32 #include &quot;CSSRegisteredCustomProperty.h&quot;
 33 #include &quot;CSSTokenizer.h&quot;
 34 #include &quot;DOMCSSNamespace.h&quot;
 35 #include &quot;Document.h&quot;
<span class="line-added"> 36 #include &quot;StyleBuilder.h&quot;</span>
 37 #include &quot;StyleBuilderConverter.h&quot;
<span class="line-added"> 38 #include &quot;StyleResolver.h&quot;</span>
 39 #include &lt;wtf/text/WTFString.h&gt;
 40 
 41 namespace WebCore {
 42 
 43 ExceptionOr&lt;void&gt; DOMCSSRegisterCustomProperty::registerProperty(Document&amp; document, const DOMCSSCustomPropertyDescriptor&amp; descriptor)
 44 {
 45     if (!isCustomPropertyName(descriptor.name))
 46         return Exception { SyntaxError, &quot;The name of this property is not a custom property name.&quot; };
 47 
 48     RefPtr&lt;CSSCustomPropertyValue&gt; initialValue;
 49     if (!descriptor.initialValue.isEmpty()) {
 50         CSSTokenizer tokenizer(descriptor.initialValue);
<span class="line-modified"> 51         Style::Resolver styleResolver(document);</span>
 52 
 53         // We need to initialize this so that we can successfully parse computationally dependent values (like em units).
 54         // We don&#39;t actually need the values to be accurate, since they will be rejected later anyway
<span class="line-modified"> 55         auto style = styleResolver.defaultStyleForElement(nullptr);</span>

 56 
 57         HashSet&lt;CSSPropertyID&gt; dependencies;
 58         CSSPropertyParser::collectParsedCustomPropertyValueDependencies(descriptor.syntax, false, dependencies, tokenizer.tokenRange(), strictCSSParserContext());
 59 
 60         if (!dependencies.isEmpty())
 61             return Exception { SyntaxError, &quot;The given initial value must be computationally independent.&quot; };
 62 
<span class="line-modified"> 63 </span>
<span class="line-added"> 64         Style::MatchResult matchResult;</span>
<span class="line-added"> 65 </span>
<span class="line-added"> 66         auto parentStyle = RenderStyle::clone(*style);</span>
<span class="line-added"> 67         Style::Builder dummyBuilder(*style, { document, parentStyle }, matchResult, { });</span>
<span class="line-added"> 68 </span>
<span class="line-added"> 69         initialValue = CSSPropertyParser::parseTypedCustomPropertyValue(descriptor.name, descriptor.syntax, tokenizer.tokenRange(), dummyBuilder.state(), strictCSSParserContext());</span>
 70 
 71         if (!initialValue || !initialValue-&gt;isResolved())
 72             return Exception { SyntaxError, &quot;The given initial value does not parse for the given syntax.&quot; };
 73 
 74         initialValue-&gt;collectDirectComputationalDependencies(dependencies);
 75         initialValue-&gt;collectDirectRootComputationalDependencies(dependencies);
 76 
 77         if (!dependencies.isEmpty())
 78             return Exception { SyntaxError, &quot;The given initial value must be computationally independent.&quot; };
 79     }
 80 
 81     CSSRegisteredCustomProperty property { descriptor.name, descriptor.syntax, descriptor.inherits, WTFMove(initialValue) };
 82     if (!document.registerCSSProperty(WTFMove(property)))
 83         return Exception { InvalidModificationError, &quot;This property has already been registered.&quot; };
 84 
 85     document.styleScope().didChangeStyleSheetEnvironment();
 86 
 87     return { };
 88 }
 89 
</pre>
</td>
</tr>
</table>
<center><a href="DOMCSSNamespace.idl.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DeprecatedCSSOMPrimitiveValue.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>