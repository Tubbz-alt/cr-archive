<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/html/FeaturePolicy.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="FTPDirectoryDocument.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FeaturePolicy.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/html/FeaturePolicy.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,16 +24,68 @@</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;FeaturePolicy.h&quot;
  
<span class="udiff-line-added">+ #include &quot;DOMWindow.h&quot;</span>
  #include &quot;Document.h&quot;
<span class="udiff-line-added">+ #include &quot;HTMLIFrameElement.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;HTMLNames.h&quot;</span>
  #include &quot;HTMLParserIdioms.h&quot;
  #include &quot;SecurityOrigin.h&quot;
  
  namespace WebCore {
  
<span class="udiff-line-added">+ using namespace HTMLNames;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static const char* policyTypeName(FeaturePolicy::Type type)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     switch (type) {</span>
<span class="udiff-line-added">+     case FeaturePolicy::Type::Camera:</span>
<span class="udiff-line-added">+         return &quot;Camera&quot;;</span>
<span class="udiff-line-added">+     case FeaturePolicy::Type::Microphone:</span>
<span class="udiff-line-added">+         return &quot;Microphone&quot;;</span>
<span class="udiff-line-added">+     case FeaturePolicy::Type::DisplayCapture:</span>
<span class="udiff-line-added">+         return &quot;DisplayCapture&quot;;</span>
<span class="udiff-line-added">+     case FeaturePolicy::Type::SyncXHR:</span>
<span class="udiff-line-added">+         return &quot;SyncXHR&quot;;</span>
<span class="udiff-line-added">+     case FeaturePolicy::Type::Fullscreen:</span>
<span class="udiff-line-added">+         return &quot;Fullscreen&quot;;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+     return &quot;&quot;;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool isFeaturePolicyAllowedByDocumentAndAllOwners(FeaturePolicy::Type type, const Document&amp; document, LogFeaturePolicyFailure logFailure)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto&amp; topDocument = document.topDocument();</span>
<span class="udiff-line-added">+     auto* ancestorDocument = &amp;document;</span>
<span class="udiff-line-added">+     while (ancestorDocument != &amp;topDocument) {</span>
<span class="udiff-line-added">+         if (!ancestorDocument) {</span>
<span class="udiff-line-added">+             if (logFailure == LogFeaturePolicyFailure::Yes &amp;&amp; document.domWindow())</span>
<span class="udiff-line-added">+                 document.domWindow()-&gt;printErrorMessage(makeString(&quot;Feature policy &#39;&quot;, policyTypeName(type), &quot;&#39; check failed.&quot;));</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         auto* ownerElement = ancestorDocument-&gt;ownerElement();</span>
<span class="udiff-line-added">+         if (is&lt;HTMLIFrameElement&gt;(ownerElement)) {</span>
<span class="udiff-line-added">+             const auto&amp; featurePolicy = downcast&lt;HTMLIFrameElement&gt;(ownerElement)-&gt;featurePolicy();</span>
<span class="udiff-line-added">+             if (!featurePolicy.allows(type, ancestorDocument-&gt;securityOrigin().data())) {</span>
<span class="udiff-line-added">+                 if (logFailure == LogFeaturePolicyFailure::Yes &amp;&amp; document.domWindow()) {</span>
<span class="udiff-line-added">+                     auto&amp; allowValue = downcast&lt;HTMLIFrameElement&gt;(ownerElement)-&gt;attributeWithoutSynchronization(HTMLNames::allowAttr);</span>
<span class="udiff-line-added">+                     document.domWindow()-&gt;printErrorMessage(makeString(&quot;Feature policy &#39;&quot;, policyTypeName(type), &quot;&#39; check failed for iframe with origin &#39;&quot;, document.securityOrigin().toString(), &quot;&#39; and allow attribute &#39;&quot;, allowValue, &quot;&#39;.&quot;));</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 return false;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         ancestorDocument = ancestorDocument-&gt;parentDocument();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return true;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  static bool isAllowedByFeaturePolicy(const FeaturePolicy::AllowRule&amp; rule, const SecurityOriginData&amp; origin)
  {
      switch (rule.type) {
      case FeaturePolicy::AllowRule::Type::None:
          return false;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -92,16 +144,18 @@</span>
          processOriginItem(document, rule, value.substring(0, position));
          value = value.substring(position + 1).stripLeadingAndTrailingMatchedCharacters(isHTMLSpace&lt;UChar&gt;);
      }
  }
  
<span class="udiff-line-modified-removed">- FeaturePolicy FeaturePolicy::parse(Document&amp; document, StringView allowAttributeValue)</span>
<span class="udiff-line-modified-added">+ FeaturePolicy FeaturePolicy::parse(Document&amp; document, const HTMLIFrameElement&amp; iframe, StringView allowAttributeValue)</span>
  {
      FeaturePolicy policy;
      bool isCameraInitialized = false;
      bool isMicrophoneInitialized = false;
      bool isDisplayCaptureInitialized = false;
<span class="udiff-line-added">+     bool isSyncXHRInitialized = false;</span>
<span class="udiff-line-added">+     bool isFullscreenInitialized = false;</span>
      for (auto allowItem : allowAttributeValue.split(&#39;;&#39;)) {
          auto item = allowItem.stripLeadingAndTrailingMatchedCharacters(isHTMLSpace&lt;UChar&gt;);
          if (item.startsWith(&quot;camera&quot;)) {
              isCameraInitialized = true;
              updateList(document, policy.m_cameraRule, item.substring(7));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -115,20 +169,48 @@</span>
          if (item.startsWith(&quot;display-capture&quot;)) {
              isDisplayCaptureInitialized = true;
              updateList(document, policy.m_displayCaptureRule, item.substring(16));
              continue;
          }
<span class="udiff-line-added">+         if (item.startsWith(&quot;sync-xhr&quot;)) {</span>
<span class="udiff-line-added">+             isSyncXHRInitialized = true;</span>
<span class="udiff-line-added">+             updateList(document, policy.m_syncXHRRule, item.substring(8));</span>
<span class="udiff-line-added">+             continue;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (item.startsWith(&quot;fullscreen&quot;)) {</span>
<span class="udiff-line-added">+             isFullscreenInitialized = true;</span>
<span class="udiff-line-added">+             updateList(document, policy.m_fullscreenRule, item.substring(11));</span>
<span class="udiff-line-added">+             continue;</span>
<span class="udiff-line-added">+         }</span>
      }
  
<span class="udiff-line-modified-removed">-     // By default, camera, microphone and display-capture policy is &#39;self&#39;</span>
<span class="udiff-line-modified-added">+     // By default, camera, microphone, display-capture, and fullscreen policy is &#39;self&#39;</span>
      if (!isCameraInitialized)
          policy.m_cameraRule.allowedList.add(document.securityOrigin().data());
      if (!isMicrophoneInitialized)
          policy.m_microphoneRule.allowedList.add(document.securityOrigin().data());
      if (!isDisplayCaptureInitialized)
          policy.m_displayCaptureRule.allowedList.add(document.securityOrigin().data());
  
<span class="udiff-line-added">+     // https://w3c.github.io/webappsec-feature-policy/#process-feature-policy-attributes</span>
<span class="udiff-line-added">+     // 9.5 Process Feature Policy Attributes</span>
<span class="udiff-line-added">+     // 3.1 If elementâ€™s allowfullscreen attribute is specified, and container policy does</span>
<span class="udiff-line-added">+     //     not contain an allowlist for fullscreen,</span>
<span class="udiff-line-added">+     if (!isFullscreenInitialized) {</span>
<span class="udiff-line-added">+         if (iframe.hasAttribute(allowfullscreenAttr) || iframe.hasAttribute(webkitallowfullscreenAttr)) {</span>
<span class="udiff-line-added">+             // 3.1.1 Construct a new declaration for fullscreen, whose allowlist is the special value *.</span>
<span class="udiff-line-added">+             policy.m_fullscreenRule.type = FeaturePolicy::AllowRule::Type::All;</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             // https://fullscreen.spec.whatwg.org/#feature-policy-integration</span>
<span class="udiff-line-added">+             // The default allowlist is &#39;self&#39;.</span>
<span class="udiff-line-added">+             policy.m_fullscreenRule.allowedList.add(document.securityOrigin().data());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!isSyncXHRInitialized)</span>
<span class="udiff-line-added">+         policy.m_syncXHRRule.type = AllowRule::Type::All;</span>
<span class="udiff-line-added">+ </span>
      return policy;
  }
  
  bool FeaturePolicy::allows(Type type, const SecurityOriginData&amp; origin) const
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -137,10 +219,14 @@</span>
          return isAllowedByFeaturePolicy(m_cameraRule, origin);
      case Type::Microphone:
          return isAllowedByFeaturePolicy(m_microphoneRule, origin);
      case Type::DisplayCapture:
          return isAllowedByFeaturePolicy(m_displayCaptureRule, origin);
<span class="udiff-line-added">+     case Type::SyncXHR:</span>
<span class="udiff-line-added">+         return isAllowedByFeaturePolicy(m_syncXHRRule, origin);</span>
<span class="udiff-line-added">+     case Type::Fullscreen:</span>
<span class="udiff-line-added">+         return isAllowedByFeaturePolicy(m_fullscreenRule, origin);</span>
      }
      ASSERT_NOT_REACHED();
      return false;
  }
  
</pre>
<center><a href="FTPDirectoryDocument.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FeaturePolicy.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>