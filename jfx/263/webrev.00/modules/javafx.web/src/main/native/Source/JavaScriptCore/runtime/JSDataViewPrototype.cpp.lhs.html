<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSDataViewPrototype.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2013-2019 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;JSDataViewPrototype.h&quot;
 28 
 29 #include &quot;Error.h&quot;
 30 #include &quot;JSArrayBuffer.h&quot;
 31 #include &quot;JSDataView.h&quot;
 32 #include &quot;Lookup.h&quot;
 33 #include &quot;JSCInlines.h&quot;
 34 #include &quot;ToNativeFromValue.h&quot;
 35 #include &quot;TypedArrayAdaptors.h&quot;
 36 #include &lt;wtf/FlipBytes.h&gt;
 37 
 38 namespace JSC {
 39 
 40 /* Source for JSDataViewPrototype.lut.h
 41 @begin dataViewTable
 42   getInt8               dataViewProtoFuncGetInt8             DontEnum|Function       1  DataViewGetInt8
 43   getUint8              dataViewProtoFuncGetUint8            DontEnum|Function       1  DataViewGetUint8
 44   getInt16              dataViewProtoFuncGetInt16            DontEnum|Function       1  DataViewGetInt16
 45   getUint16             dataViewProtoFuncGetUint16           DontEnum|Function       1  DataViewGetUint16
 46   getInt32              dataViewProtoFuncGetInt32            DontEnum|Function       1  DataViewGetInt32
 47   getUint32             dataViewProtoFuncGetUint32           DontEnum|Function       1  DataViewGetUint32
 48   getFloat32            dataViewProtoFuncGetFloat32          DontEnum|Function       1  DataViewGetFloat32
 49   getFloat64            dataViewProtoFuncGetFloat64          DontEnum|Function       1  DataViewGetFloat64
 50   setInt8               dataViewProtoFuncSetInt8             DontEnum|Function       2  DataViewSetInt8
 51   setUint8              dataViewProtoFuncSetUint8            DontEnum|Function       2  DataViewSetUint8
 52   setInt16              dataViewProtoFuncSetInt16            DontEnum|Function       2  DataViewSetInt16
 53   setUint16             dataViewProtoFuncSetUint16           DontEnum|Function       2  DataViewSetUint16
 54   setInt32              dataViewProtoFuncSetInt32            DontEnum|Function       2  DataViewSetInt32
 55   setUint32             dataViewProtoFuncSetUint32           DontEnum|Function       2  DataViewSetUint32
 56   setFloat32            dataViewProtoFuncSetFloat32          DontEnum|Function       2  DataViewSetFloat32
 57   setFloat64            dataViewProtoFuncSetFloat64          DontEnum|Function       2  DataViewSetFloat64
 58   buffer                dataViewProtoGetterBuffer            DontEnum|Accessor       0
 59   byteLength            dataViewProtoGetterByteLength        DontEnum|Accessor       0
 60   byteOffset            dataViewProtoGetterByteOffset        DontEnum|Accessor       0
 61 @end
 62 */
 63 
<a name="1" id="anc1"></a><span class="line-modified"> 64 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetInt8(ExecState*);</span>
<span class="line-modified"> 65 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetInt16(ExecState*);</span>
<span class="line-modified"> 66 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetInt32(ExecState*);</span>
<span class="line-modified"> 67 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetUint8(ExecState*);</span>
<span class="line-modified"> 68 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetUint16(ExecState*);</span>
<span class="line-modified"> 69 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetUint32(ExecState*);</span>
<span class="line-modified"> 70 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetFloat32(ExecState*);</span>
<span class="line-modified"> 71 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetFloat64(ExecState*);</span>
<span class="line-modified"> 72 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetInt8(ExecState*);</span>
<span class="line-modified"> 73 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetInt16(ExecState*);</span>
<span class="line-modified"> 74 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetInt32(ExecState*);</span>
<span class="line-modified"> 75 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetUint8(ExecState*);</span>
<span class="line-modified"> 76 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetUint16(ExecState*);</span>
<span class="line-modified"> 77 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetUint32(ExecState*);</span>
<span class="line-modified"> 78 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetFloat32(ExecState*);</span>
<span class="line-modified"> 79 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetFloat64(ExecState*);</span>
<span class="line-modified"> 80 EncodedJSValue JSC_HOST_CALL dataViewProtoGetterBuffer(ExecState*);</span>
<span class="line-modified"> 81 EncodedJSValue JSC_HOST_CALL dataViewProtoGetterByteLength(ExecState*);</span>
<span class="line-modified"> 82 EncodedJSValue JSC_HOST_CALL dataViewProtoGetterByteOffset(ExecState*);</span>
 83 
 84 }
 85 
 86 #include &quot;JSDataViewPrototype.lut.h&quot;
 87 
 88 namespace JSC {
 89 
 90 const ClassInfo JSDataViewPrototype::s_info = {
 91     &quot;DataViewPrototype&quot;, &amp;Base::s_info, &amp;dataViewTable, nullptr,
 92     CREATE_METHOD_TABLE(JSDataViewPrototype)
 93 };
 94 
 95 JSDataViewPrototype::JSDataViewPrototype(VM&amp; vm, Structure* structure)
 96     : Base(vm, structure)
 97 {
 98 }
 99 
100 JSDataViewPrototype* JSDataViewPrototype::create(VM&amp; vm, Structure* structure)
101 {
102     JSDataViewPrototype* prototype =
103         new (NotNull, allocateCell&lt;JSDataViewPrototype&gt;(vm.heap))
104         JSDataViewPrototype(vm, structure);
105     prototype-&gt;finishCreation(vm);
106     return prototype;
107 }
108 
109 void JSDataViewPrototype::finishCreation(JSC::VM&amp; vm)
110 {
111     Base::finishCreation(vm);
<a name="2" id="anc2"></a><span class="line-modified">112     putDirectWithoutTransition(vm, vm.propertyNames-&gt;toStringTagSymbol, jsString(vm, &quot;DataView&quot;), PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly);</span>
113 }
114 
115 Structure* JSDataViewPrototype::createStructure(
116     VM&amp; vm, JSGlobalObject* globalObject, JSValue prototype)
117 {
118     return Structure::create(
119         vm, globalObject, prototype, TypeInfo(ObjectType, StructureFlags), info());
120 }
121 
122 template&lt;typename Adaptor&gt;
<a name="3" id="anc3"></a><span class="line-modified">123 EncodedJSValue getData(ExecState* exec)</span>
124 {
<a name="4" id="anc4"></a><span class="line-modified">125     VM&amp; vm = exec-&gt;vm();</span>
126     auto scope = DECLARE_THROW_SCOPE(vm);
127 
<a name="5" id="anc5"></a><span class="line-modified">128     JSDataView* dataView = jsDynamicCast&lt;JSDataView*&gt;(vm, exec-&gt;thisValue());</span>
129     if (!dataView)
<a name="6" id="anc6"></a><span class="line-modified">130         return throwVMTypeError(exec, scope, &quot;Receiver of DataView method must be a DataView&quot;_s);</span>
131 
<a name="7" id="anc7"></a><span class="line-modified">132     unsigned byteOffset = exec-&gt;argument(0).toIndex(exec, &quot;byteOffset&quot;);</span>
133     RETURN_IF_EXCEPTION(scope, encodedJSValue());
134 
135     bool littleEndian = false;
136     unsigned elementSize = sizeof(typename Adaptor::Type);
<a name="8" id="anc8"></a><span class="line-modified">137     if (elementSize &gt; 1 &amp;&amp; exec-&gt;argumentCount() &gt;= 2) {</span>
<span class="line-modified">138         littleEndian = exec-&gt;uncheckedArgument(1).toBoolean(exec);</span>
139         RETURN_IF_EXCEPTION(scope, encodedJSValue());
140     }
141 
142     unsigned byteLength = dataView-&gt;length();
143     if (elementSize &gt; byteLength || byteOffset &gt; byteLength - elementSize)
<a name="9" id="anc9"></a><span class="line-modified">144         return throwVMError(exec, scope, createRangeError(exec, &quot;Out of bounds access&quot;_s));</span>
145 
146     const unsigned dataSize = sizeof(typename Adaptor::Type);
147     union {
148         typename Adaptor::Type value;
149         uint8_t rawBytes[dataSize];
150     } u = { };
151 
152     uint8_t* dataPtr = static_cast&lt;uint8_t*&gt;(dataView-&gt;vector()) + byteOffset;
153 
154     if (needToFlipBytesIfLittleEndian(littleEndian)) {
155         for (unsigned i = dataSize; i--;)
156             u.rawBytes[i] = *dataPtr++;
157     } else {
158         for (unsigned i = 0; i &lt; dataSize; i++)
159             u.rawBytes[i] = *dataPtr++;
160     }
161 
162     return JSValue::encode(Adaptor::toJSValue(u.value));
163 }
164 
165 template&lt;typename Adaptor&gt;
<a name="10" id="anc10"></a><span class="line-modified">166 EncodedJSValue setData(ExecState* exec)</span>
167 {
<a name="11" id="anc11"></a><span class="line-modified">168     VM&amp; vm = exec-&gt;vm();</span>
169     auto scope = DECLARE_THROW_SCOPE(vm);
170 
<a name="12" id="anc12"></a><span class="line-modified">171     JSDataView* dataView = jsDynamicCast&lt;JSDataView*&gt;(vm, exec-&gt;thisValue());</span>
172     if (!dataView)
<a name="13" id="anc13"></a><span class="line-modified">173         return throwVMTypeError(exec, scope, &quot;Receiver of DataView method must be a DataView&quot;_s);</span>
174 
<a name="14" id="anc14"></a><span class="line-modified">175     unsigned byteOffset = exec-&gt;argument(0).toIndex(exec, &quot;byteOffset&quot;);</span>
176     RETURN_IF_EXCEPTION(scope, encodedJSValue());
177 
178     const unsigned dataSize = sizeof(typename Adaptor::Type);
179     union {
180         typename Adaptor::Type value;
181         uint8_t rawBytes[dataSize];
182     } u;
183 
<a name="15" id="anc15"></a><span class="line-modified">184     u.value = toNativeFromValue&lt;Adaptor&gt;(exec, exec-&gt;argument(1));</span>
185     RETURN_IF_EXCEPTION(scope, encodedJSValue());
186 
187     bool littleEndian = false;
188     unsigned elementSize = sizeof(typename Adaptor::Type);
<a name="16" id="anc16"></a><span class="line-modified">189     if (elementSize &gt; 1 &amp;&amp; exec-&gt;argumentCount() &gt;= 3) {</span>
<span class="line-modified">190         littleEndian = exec-&gt;uncheckedArgument(2).toBoolean(exec);</span>
191         RETURN_IF_EXCEPTION(scope, encodedJSValue());
192     }
193 
194     unsigned byteLength = dataView-&gt;length();
195     if (elementSize &gt; byteLength || byteOffset &gt; byteLength - elementSize)
<a name="17" id="anc17"></a><span class="line-modified">196         return throwVMError(exec, scope, createRangeError(exec, &quot;Out of bounds access&quot;_s));</span>
197 
198     uint8_t* dataPtr = static_cast&lt;uint8_t*&gt;(dataView-&gt;vector()) + byteOffset;
199 
200     if (needToFlipBytesIfLittleEndian(littleEndian)) {
201         for (unsigned i = dataSize; i--;)
202             *dataPtr++ = u.rawBytes[i];
203     } else {
204         for (unsigned i = 0; i &lt; dataSize; i++)
205             *dataPtr++ = u.rawBytes[i];
206     }
207 
208     return JSValue::encode(jsUndefined());
209 }
210 
211 IGNORE_CLANG_WARNINGS_BEGIN(&quot;missing-prototypes&quot;)
212 
<a name="18" id="anc18"></a><span class="line-modified">213 EncodedJSValue JSC_HOST_CALL dataViewProtoGetterBuffer(ExecState* exec)</span>
214 {
<a name="19" id="anc19"></a><span class="line-modified">215     VM&amp; vm = exec-&gt;vm();</span>
216     auto scope = DECLARE_THROW_SCOPE(vm);
217 
<a name="20" id="anc20"></a><span class="line-modified">218     JSDataView* view = jsDynamicCast&lt;JSDataView*&gt;(vm, exec-&gt;thisValue());</span>
219     if (!view)
<a name="21" id="anc21"></a><span class="line-modified">220         return throwVMTypeError(exec, scope, &quot;DataView.prototype.buffer expects |this| to be a DataView object&quot;);</span>
221 
<a name="22" id="anc22"></a><span class="line-modified">222     return JSValue::encode(view-&gt;possiblySharedJSBuffer(exec));</span>
223 }
224 
<a name="23" id="anc23"></a><span class="line-modified">225 EncodedJSValue JSC_HOST_CALL dataViewProtoGetterByteLength(ExecState* exec)</span>
226 {
<a name="24" id="anc24"></a><span class="line-modified">227     VM&amp; vm = exec-&gt;vm();</span>
228     auto scope = DECLARE_THROW_SCOPE(vm);
229 
<a name="25" id="anc25"></a><span class="line-modified">230     JSDataView* view = jsDynamicCast&lt;JSDataView*&gt;(vm, exec-&gt;thisValue());</span>
231     if (!view)
<a name="26" id="anc26"></a><span class="line-modified">232         return throwVMTypeError(exec, scope, &quot;DataView.prototype.buffer expects |this| to be a DataView object&quot;);</span>
233 
234     return JSValue::encode(jsNumber(view-&gt;length()));
235 }
236 
<a name="27" id="anc27"></a><span class="line-modified">237 EncodedJSValue JSC_HOST_CALL dataViewProtoGetterByteOffset(ExecState* exec)</span>
238 {
<a name="28" id="anc28"></a><span class="line-modified">239     VM&amp; vm = exec-&gt;vm();</span>
240     auto scope = DECLARE_THROW_SCOPE(vm);
241 
<a name="29" id="anc29"></a><span class="line-modified">242     JSDataView* view = jsDynamicCast&lt;JSDataView*&gt;(vm, exec-&gt;thisValue());</span>
243     if (!view)
<a name="30" id="anc30"></a><span class="line-modified">244         return throwVMTypeError(exec, scope, &quot;DataView.prototype.buffer expects |this| to be a DataView object&quot;);</span>
245 
246     return JSValue::encode(jsNumber(view-&gt;byteOffset()));
247 }
248 
<a name="31" id="anc31"></a><span class="line-modified">249 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetInt8(ExecState* exec)</span>
250 {
<a name="32" id="anc32"></a><span class="line-modified">251     return getData&lt;Int8Adaptor&gt;(exec);</span>
252 }
253 
<a name="33" id="anc33"></a><span class="line-modified">254 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetInt16(ExecState* exec)</span>
255 {
<a name="34" id="anc34"></a><span class="line-modified">256     return getData&lt;Int16Adaptor&gt;(exec);</span>
257 }
258 
<a name="35" id="anc35"></a><span class="line-modified">259 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetInt32(ExecState* exec)</span>
260 {
<a name="36" id="anc36"></a><span class="line-modified">261     return getData&lt;Int32Adaptor&gt;(exec);</span>
262 }
263 
<a name="37" id="anc37"></a><span class="line-modified">264 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetUint8(ExecState* exec)</span>
265 {
<a name="38" id="anc38"></a><span class="line-modified">266     return getData&lt;Uint8Adaptor&gt;(exec);</span>
267 }
268 
<a name="39" id="anc39"></a><span class="line-modified">269 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetUint16(ExecState* exec)</span>
270 {
<a name="40" id="anc40"></a><span class="line-modified">271     return getData&lt;Uint16Adaptor&gt;(exec);</span>
272 }
273 
<a name="41" id="anc41"></a><span class="line-modified">274 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetUint32(ExecState* exec)</span>
275 {
<a name="42" id="anc42"></a><span class="line-modified">276     return getData&lt;Uint32Adaptor&gt;(exec);</span>
277 }
278 
<a name="43" id="anc43"></a><span class="line-modified">279 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetFloat32(ExecState* exec)</span>
280 {
<a name="44" id="anc44"></a><span class="line-modified">281     return getData&lt;Float32Adaptor&gt;(exec);</span>
282 }
283 
<a name="45" id="anc45"></a><span class="line-modified">284 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncGetFloat64(ExecState* exec)</span>
285 {
<a name="46" id="anc46"></a><span class="line-modified">286     return getData&lt;Float64Adaptor&gt;(exec);</span>
287 }
288 
<a name="47" id="anc47"></a><span class="line-modified">289 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetInt8(ExecState* exec)</span>
290 {
<a name="48" id="anc48"></a><span class="line-modified">291     return setData&lt;Int8Adaptor&gt;(exec);</span>
292 }
293 
<a name="49" id="anc49"></a><span class="line-modified">294 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetInt16(ExecState* exec)</span>
295 {
<a name="50" id="anc50"></a><span class="line-modified">296     return setData&lt;Int16Adaptor&gt;(exec);</span>
297 }
298 
<a name="51" id="anc51"></a><span class="line-modified">299 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetInt32(ExecState* exec)</span>
300 {
<a name="52" id="anc52"></a><span class="line-modified">301     return setData&lt;Int32Adaptor&gt;(exec);</span>
302 }
303 
<a name="53" id="anc53"></a><span class="line-modified">304 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetUint8(ExecState* exec)</span>
305 {
<a name="54" id="anc54"></a><span class="line-modified">306     return setData&lt;Uint8Adaptor&gt;(exec);</span>
307 }
308 
<a name="55" id="anc55"></a><span class="line-modified">309 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetUint16(ExecState* exec)</span>
310 {
<a name="56" id="anc56"></a><span class="line-modified">311     return setData&lt;Uint16Adaptor&gt;(exec);</span>
312 }
313 
<a name="57" id="anc57"></a><span class="line-modified">314 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetUint32(ExecState* exec)</span>
315 {
<a name="58" id="anc58"></a><span class="line-modified">316     return setData&lt;Uint32Adaptor&gt;(exec);</span>
317 }
318 
<a name="59" id="anc59"></a><span class="line-modified">319 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetFloat32(ExecState* exec)</span>
320 {
<a name="60" id="anc60"></a><span class="line-modified">321     return setData&lt;Float32Adaptor&gt;(exec);</span>
322 }
323 
<a name="61" id="anc61"></a><span class="line-modified">324 EncodedJSValue JSC_HOST_CALL dataViewProtoFuncSetFloat64(ExecState* exec)</span>
325 {
<a name="62" id="anc62"></a><span class="line-modified">326     return setData&lt;Float64Adaptor&gt;(exec);</span>
327 }
328 IGNORE_CLANG_WARNINGS_END
329 
330 } // namespace JSC
<a name="63" id="anc63"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="63" type="hidden" />
</body>
</html>