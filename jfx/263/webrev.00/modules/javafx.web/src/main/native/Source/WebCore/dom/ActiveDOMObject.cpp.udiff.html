<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/dom/ActiveDOMObject.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ActiveDOMCallback.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ActiveDOMObject.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/dom/ActiveDOMObject.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,32 +26,50 @@</span>
  
  #include &quot;config.h&quot;
  #include &quot;ActiveDOMObject.h&quot;
  
  #include &quot;Document.h&quot;
<span class="udiff-line-added">+ #include &quot;EventLoop.h&quot;</span>
  #include &quot;ScriptExecutionContext.h&quot;
  
  namespace WebCore {
  
<span class="udiff-line-modified-removed">- ActiveDOMObject::ActiveDOMObject(ScriptExecutionContext* scriptExecutionContext)</span>
<span class="udiff-line-removed">-     : ContextDestructionObserver(scriptExecutionContext)</span>
<span class="udiff-line-removed">-     , m_pendingActivityCount(0)</span>
<span class="udiff-line-removed">- #if !ASSERT_DISABLED</span>
<span class="udiff-line-removed">-     , m_suspendIfNeededWasCalled(false)</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-modified-added">+ static inline ScriptExecutionContext* suitableScriptExecutionContext(ScriptExecutionContext* scriptExecutionContext)</span>
  {
<span class="udiff-line-modified-removed">-     ASSERT(!is&lt;Document&gt;(m_scriptExecutionContext) || &amp;downcast&lt;Document&gt;(m_scriptExecutionContext)-&gt;contextDocument() == downcast&lt;Document&gt;(m_scriptExecutionContext));</span>
<span class="udiff-line-modified-removed">-     if (!m_scriptExecutionContext)</span>
<span class="udiff-line-modified-added">+     // For detached documents, make sure we observe their context document instead.</span>
<span class="udiff-line-modified-added">+     return is&lt;Document&gt;(scriptExecutionContext) ? &amp;downcast&lt;Document&gt;(*scriptExecutionContext).contextDocument() : scriptExecutionContext;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ inline ActiveDOMObject::ActiveDOMObject(ScriptExecutionContext* context, CheckedScriptExecutionContextType)</span>
<span class="udiff-line-added">+     : ContextDestructionObserver(context)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(!is&lt;Document&gt;(context) || &amp;downcast&lt;Document&gt;(context)-&gt;contextDocument() == downcast&lt;Document&gt;(context));</span>
<span class="udiff-line-added">+     if (!context)</span>
          return;
  
<span class="udiff-line-modified-removed">-     ASSERT(m_scriptExecutionContext-&gt;isContextThread());</span>
<span class="udiff-line-modified-removed">-     m_scriptExecutionContext-&gt;didCreateActiveDOMObject(*this);</span>
<span class="udiff-line-modified-added">+     ASSERT(context-&gt;isContextThread());</span>
<span class="udiff-line-modified-added">+     context-&gt;didCreateActiveDOMObject(*this);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ActiveDOMObject::ActiveDOMObject(ScriptExecutionContext* scriptExecutionContext)</span>
<span class="udiff-line-added">+     : ActiveDOMObject(suitableScriptExecutionContext(scriptExecutionContext), CheckedScriptExecutionContext)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ActiveDOMObject::ActiveDOMObject(Document* document)</span>
<span class="udiff-line-added">+     : ActiveDOMObject(document ? &amp;document-&gt;contextDocument() : nullptr, CheckedScriptExecutionContext)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ActiveDOMObject::ActiveDOMObject(Document&amp; document)</span>
<span class="udiff-line-added">+     : ActiveDOMObject(&amp;document.contextDocument(), CheckedScriptExecutionContext)</span>
<span class="udiff-line-added">+ {</span>
  }
  
  ActiveDOMObject::~ActiveDOMObject()
  {
<span class="udiff-line-modified-removed">-     ASSERT(canAccessThreadLocalDataForThread(m_creationThread));</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(m_creationThread));</span>
  
      // ActiveDOMObject may be inherited by a sub-class whose life-cycle
      // exceeds that of the associated ScriptExecutionContext. In those cases,
      // m_scriptExecutionContext would/should have been nullified by
      // ContextDestructionObserver::contextDestroyed() (which we implement /
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -65,39 +83,36 @@</span>
      m_scriptExecutionContext-&gt;willDestroyActiveDOMObject(*this);
  }
  
  void ActiveDOMObject::suspendIfNeeded()
  {
<span class="udiff-line-modified-removed">- #if !ASSERT_DISABLED</span>
<span class="udiff-line-modified-added">+ #if ASSERT_ENABLED</span>
      ASSERT(!m_suspendIfNeededWasCalled);
      m_suspendIfNeededWasCalled = true;
  #endif
      if (!m_scriptExecutionContext)
          return;
  
      m_scriptExecutionContext-&gt;suspendActiveDOMObjectIfNeeded(*this);
  }
  
<span class="udiff-line-modified-removed">- #if !ASSERT_DISABLED</span>
<span class="udiff-line-modified-added">+ #if ASSERT_ENABLED</span>
  
  void ActiveDOMObject::assertSuspendIfNeededWasCalled() const
  {
<span class="udiff-line-added">+     if (!m_suspendIfNeededWasCalled)</span>
<span class="udiff-line-added">+         WTFLogAlways(&quot;Failed to call suspendIfNeeded() for %s&quot;, activeDOMObjectName());</span>
      ASSERT(m_suspendIfNeededWasCalled);
  }
  
<span class="udiff-line-modified-removed">- #endif</span>
<span class="udiff-line-modified-added">+ #endif // ASSERT_ENABLED</span>
  
  bool ActiveDOMObject::hasPendingActivity() const
  {
      return m_pendingActivityCount;
  }
  
<span class="udiff-line-removed">- bool ActiveDOMObject::canSuspendForDocumentSuspension() const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  void ActiveDOMObject::suspend(ReasonForSuspension)
  {
  }
  
  void ActiveDOMObject::resume()
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -111,6 +126,55 @@</span>
  bool ActiveDOMObject::isContextStopped() const
  {
      return !scriptExecutionContext() || scriptExecutionContext()-&gt;activeDOMObjectsAreStopped();
  }
  
<span class="udiff-line-added">+ bool ActiveDOMObject::isAllowedToRunScript() const</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return scriptExecutionContext() &amp;&amp; !scriptExecutionContext()-&gt;activeDOMObjectsAreStopped() &amp;&amp; !scriptExecutionContext()-&gt;activeDOMObjectsAreSuspended();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ActiveDOMObject::queueTaskInEventLoop(TaskSource source, Function&lt;void ()&gt;&amp;&amp; function)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto* context = scriptExecutionContext();</span>
<span class="udiff-line-added">+     if (!context)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     context-&gt;eventLoop().queueTask(source, WTFMove(function));</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ class ActiveDOMObjectEventDispatchTask : public EventLoopTask {</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+     ActiveDOMObjectEventDispatchTask(TaskSource source, EventLoopTaskGroup&amp; group, ActiveDOMObject&amp; object, EventTarget&amp; target, Ref&lt;Event&gt;&amp;&amp; event)</span>
<span class="udiff-line-added">+         : EventLoopTask(source, group)</span>
<span class="udiff-line-added">+         , m_object(object)</span>
<span class="udiff-line-added">+         , m_target(target)</span>
<span class="udiff-line-added">+         , m_event(WTFMove(event))</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         ++m_object.m_pendingActivityCount;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ~ActiveDOMObjectEventDispatchTask()</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         ASSERT(m_object.m_pendingActivityCount);</span>
<span class="udiff-line-added">+         --m_object.m_pendingActivityCount;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void execute() final { m_target-&gt;dispatchEvent(m_event.get()); }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+     ActiveDOMObject&amp; m_object;</span>
<span class="udiff-line-added">+     Ref&lt;EventTarget&gt; m_target;</span>
<span class="udiff-line-added">+     Ref&lt;Event&gt; m_event;</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ActiveDOMObject::queueTaskToDispatchEventInternal(EventTarget&amp; target, TaskSource source, Ref&lt;Event&gt;&amp;&amp; event)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(!event-&gt;target() || &amp;target == event-&gt;target());</span>
<span class="udiff-line-added">+     auto* context = scriptExecutionContext();</span>
<span class="udiff-line-added">+     if (!context)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     auto&amp; eventLoopTaskGroup = context-&gt;eventLoop();</span>
<span class="udiff-line-added">+     auto task = makeUnique&lt;ActiveDOMObjectEventDispatchTask&gt;(source, eventLoopTaskGroup, *this, target, WTFMove(event));</span>
<span class="udiff-line-added">+     eventLoopTaskGroup.queueTask(WTFMove(task));</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  } // namespace WebCore
</pre>
<center><a href="ActiveDOMCallback.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ActiveDOMObject.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>