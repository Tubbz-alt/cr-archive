<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Tools/DumpRenderTree/TestOptions.cpp</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2016-2020 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;TestOptions.h&quot;
 28 
 29 #include &lt;fstream&gt;
 30 #include &lt;string&gt;
 31 #include &lt;wtf/text/WTFString.h&gt;
 32 
 33 static bool parseBooleanTestHeaderValue(const std::string&amp; value)
 34 {
 35     if (value == &quot;true&quot;)
 36         return true;
 37     if (value == &quot;false&quot;)
 38         return false;
 39 
 40     LOG_ERROR(&quot;Found unexpected value &#39;%s&#39; for boolean option. Expected &#39;true&#39; or &#39;false&#39;.&quot;, value.c_str());
 41     return false;
 42 }
 43 
 44 static bool pathContains(const std::string&amp; pathOrURL, const char* substring)
 45 {
 46     String path(pathOrURL.c_str());
 47     return path.contains(substring);
 48 }
 49 
 50 static bool shouldDumpJSConsoleLogInStdErr(const std::string&amp; pathOrURL)
 51 {
 52     return pathContains(pathOrURL, &quot;localhost:8800/beacon&quot;) || pathContains(pathOrURL, &quot;localhost:9443/beacon&quot;)
 53         || pathContains(pathOrURL, &quot;localhost:8800/cors&quot;) || pathContains(pathOrURL, &quot;localhost:9443/cors&quot;)
 54         || pathContains(pathOrURL, &quot;localhost:8800/fetch&quot;) || pathContains(pathOrURL, &quot;localhost:9443/fetch&quot;)
 55         || pathContains(pathOrURL, &quot;localhost:8800/service-workers&quot;) || pathContains(pathOrURL, &quot;localhost:9443/service-workers&quot;)
 56         || pathContains(pathOrURL, &quot;localhost:8800/xhr&quot;) || pathContains(pathOrURL, &quot;localhost:9443/xhr&quot;)
 57         || pathContains(pathOrURL, &quot;localhost:8800/webrtc&quot;) || pathContains(pathOrURL, &quot;localhost:9443/webrtc&quot;)
 58         || pathContains(pathOrURL, &quot;localhost:8800/websockets&quot;) || pathContains(pathOrURL, &quot;localhost:9443/websockets&quot;);
 59 }
 60 
 61 TestOptions::TestOptions(const std::string&amp; pathOrURL, const std::string&amp; absolutePath)
 62 {
 63     const auto&amp; path = absolutePath.empty() ? pathOrURL : absolutePath;
 64     if (path.empty())
 65         return;
 66 
 67     dumpJSConsoleLogInStdErr = shouldDumpJSConsoleLogInStdErr(pathOrURL);
 68 
 69     std::string options;
 70     std::ifstream testFile(path.data());
 71     if (!testFile.good())
 72         return;
 73     getline(testFile, options);
 74     std::string beginString(&quot;webkit-test-runner [ &quot;);
 75     std::string endString(&quot; ]&quot;);
 76     size_t beginLocation = options.find(beginString);
 77     if (beginLocation == std::string::npos)
 78         return;
 79     size_t endLocation = options.find(endString, beginLocation);
 80     if (endLocation == std::string::npos) {
 81         LOG_ERROR(&quot;Could not find end of test header in %s&quot;, path.c_str());
 82         return;
 83     }
 84     std::string pairString = options.substr(beginLocation + beginString.size(), endLocation - (beginLocation + beginString.size()));
 85     size_t pairStart = 0;
 86     while (pairStart &lt; pairString.size()) {
 87         size_t pairEnd = pairString.find(&quot; &quot;, pairStart);
 88         if (pairEnd == std::string::npos)
 89             pairEnd = pairString.size();
 90         size_t equalsLocation = pairString.find(&quot;=&quot;, pairStart);
 91         if (equalsLocation == std::string::npos) {
 92             LOG_ERROR(&quot;Malformed option in test header (could not find &#39;=&#39; character) in %s&quot;, path.c_str());
 93             break;
 94         }
 95         auto key = pairString.substr(pairStart, equalsLocation - pairStart);
 96         auto value = pairString.substr(equalsLocation + 1, pairEnd - (equalsLocation + 1));
 97         if (key == &quot;enableAttachmentElement&quot;)
 98             enableAttachmentElement = parseBooleanTestHeaderValue(value);
 99         if (key == &quot;useAcceleratedDrawing&quot;)
100             useAcceleratedDrawing = parseBooleanTestHeaderValue(value);
101         else if (key == &quot;enableIntersectionObserver&quot;)
102             enableIntersectionObserver = parseBooleanTestHeaderValue(value);
103         else if (key == &quot;useEphemeralSession&quot;)
104             useEphemeralSession = parseBooleanTestHeaderValue(value);
105         else if (key == &quot;enableBackForwardCache&quot;)
106             enableBackForwardCache = parseBooleanTestHeaderValue(value);
107         else if (key == &quot;enableMenuItemElement&quot;)
108             enableMenuItemElement = parseBooleanTestHeaderValue(value);
109         else if (key == &quot;enableKeygenElement&quot;)
110             enableKeygenElement = parseBooleanTestHeaderValue(value);
111         else if (key == &quot;enableModernMediaControls&quot;)
112             enableModernMediaControls = parseBooleanTestHeaderValue(value);
113         else if (key == &quot;enablePointerLock&quot;)
114             enablePointerLock = parseBooleanTestHeaderValue(value);
115         else if (key == &quot;enableDragDestinationActionLoad&quot;)
116             enableDragDestinationActionLoad = parseBooleanTestHeaderValue(value);
117         else if (key == &quot;layerBackedWebView&quot;)
118             layerBackedWebView = parseBooleanTestHeaderValue(value);
119         else if (key == &quot;enableIsSecureContextAttribute&quot;)
120             enableIsSecureContextAttribute = parseBooleanTestHeaderValue(value);
121         else if (key == &quot;enableInspectorAdditions&quot;)
122             enableInspectorAdditions = parseBooleanTestHeaderValue(value);
123         else if (key == &quot;dumpJSConsoleLogInStdErr&quot;)
124             dumpJSConsoleLogInStdErr = parseBooleanTestHeaderValue(value);
125         else if (key == &quot;allowCrossOriginSubresourcesToAskForCredentials&quot;)
126             allowCrossOriginSubresourcesToAskForCredentials = parseBooleanTestHeaderValue(value);
127         else if (key == &quot;experimental:WebAnimationsCSSIntegrationEnabled&quot;)
128             enableWebAnimationsCSSIntegration = parseBooleanTestHeaderValue(value);
129         else if (key == &quot;internal:selectionAcrossShadowBoundariesEnabled&quot;)
130             enableSelectionAcrossShadowBoundaries = parseBooleanTestHeaderValue(value);
131         else if (key == &quot;enableColorFilter&quot;)
132             enableColorFilter = parseBooleanTestHeaderValue(value);
133         else if (key == &quot;jscOptions&quot;)
134             jscOptions = value;
135         else if (key == &quot;additionalSupportedImageTypes&quot;)
136             additionalSupportedImageTypes = value;
137         else if (key == &quot;experimental:WebGPUEnabled&quot;)
138             enableWebGPU = parseBooleanTestHeaderValue(value);
139         else if (key == &quot;internal:CSSLogicalEnabled&quot;)
140             enableCSSLogical = parseBooleanTestHeaderValue(value);
141         else if (key == &quot;experimental:AdClickAttributionEnabled&quot;)
142             adClickAttributionEnabled = parseBooleanTestHeaderValue(value);
143         else if (key == &quot;experimental:ResizeObserverEnabled&quot;)
144             enableResizeObserver = parseBooleanTestHeaderValue(value);
145         else if (key == &quot;experimental:CSSOMViewSmoothScrollingEnabled&quot;)
146             enableCSSOMViewSmoothScrolling = parseBooleanTestHeaderValue(value);
147         else if (key == &quot;experimental:CoreMathMLEnabled&quot;)
148             enableCoreMathML = parseBooleanTestHeaderValue(value);
149         else if (key == &quot;experimental:RequestIdleCallbackEnabled&quot;)
150             enableRequestIdleCallback = parseBooleanTestHeaderValue(value);
151         else if (key == &quot;experimental:AsyncClipboardAPIEnabled&quot;)
152             enableAsyncClipboardAPI = parseBooleanTestHeaderValue(value);
153         else if (key == &quot;internal:LayoutFormattingContextIntegrationEnabled&quot;)
154             layoutFormattingContextIntegrationEnabled = parseBooleanTestHeaderValue(value);
155         else if (key == &quot;experimental:AspectRatioOfImgFromWidthAndHeightEnabled&quot;)
156             enableAspectRatioOfImgFromWidthAndHeight = parseBooleanTestHeaderValue(value);
157         else if (key == &quot;allowTopNavigationToDataURLs&quot;)
158             allowTopNavigationToDataURLs = parseBooleanTestHeaderValue(value);
159         pairStart = pairEnd + 1;
160     }
161 }
162 
163 bool TestOptions::webViewIsCompatibleWithOptions(const TestOptions&amp; other) const
164 {
165     return other.layerBackedWebView == layerBackedWebView
166         &amp;&amp; other.jscOptions == jscOptions
167         &amp;&amp; other.enableWebAnimationsCSSIntegration == enableWebAnimationsCSSIntegration;
168 }
    </pre>
  </body>
</html>