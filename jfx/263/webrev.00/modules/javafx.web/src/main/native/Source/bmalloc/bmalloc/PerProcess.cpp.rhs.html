<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/bmalloc/bmalloc/PerProcess.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre> 1 /*
 2  * Copyright (C) 2018 Apple Inc. All rights reserved.
 3  *
 4  * Redistribution and use in source and binary forms, with or without
 5  * modification, are permitted provided that the following conditions
 6  * are met:
 7  * 1. Redistributions of source code must retain the above copyright
 8  *    notice, this list of conditions and the following disclaimer.
 9  * 2. Redistributions in binary form must reproduce the above copyright
10  *    notice, this list of conditions and the following disclaimer in the
11  *    documentation and/or other materials provided with the distribution.
12  *
13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
24  */
25 
26 #include &quot;PerProcess.h&quot;
27 
28 #include &quot;VMAllocate.h&quot;
29 #include &lt;stdio.h&gt;
30 
31 namespace bmalloc {
32 
33 static constexpr unsigned tableSize = 100;
34 static constexpr bool verbose = false;
35 
36 static Mutex s_mutex;
37 
38 static char* s_bumpBase;
39 static size_t s_bumpOffset;
40 static size_t s_bumpLimit;
41 
42 static PerProcessData* s_table[tableSize];
43 
44 // Returns zero-filled memory by virtual of using vmAllocate.
45 static void* allocate(size_t size, size_t alignment)
46 {
47     s_bumpOffset = roundUpToMultipleOf(alignment, s_bumpOffset);
48     void* result = s_bumpBase + s_bumpOffset;
49     s_bumpOffset += size;
50     if (s_bumpOffset &lt;= s_bumpLimit)
51         return result;
52 
53     size_t allocationSize = vmSize(size);
54     void* allocation = vmAllocate(allocationSize);
55     s_bumpBase = static_cast&lt;char*&gt;(allocation);
56     s_bumpOffset = 0;
57     s_bumpLimit = allocationSize;
58     return allocate(size, alignment);
59 }
60 
61 PerProcessData* getPerProcessData(unsigned hash, const char* disambiguator, size_t size, size_t alignment)
62 {
<a name="1" id="anc1"></a><span class="line-modified">63     LockHolder lock(s_mutex);</span>
64 
65     PerProcessData*&amp; bucket = s_table[hash % tableSize];
66 
67     for (PerProcessData* data = bucket; data; data = data-&gt;next) {
68         if (!strcmp(data-&gt;disambiguator, disambiguator)) {
69             if (verbose)
70                 fprintf(stderr, &quot;%d: Using existing %s\n&quot;, getpid(), disambiguator);
71             RELEASE_BASSERT(data-&gt;size == size);
72             RELEASE_BASSERT(data-&gt;alignment == alignment);
73             return data;
74         }
75     }
76 
77     if (verbose)
78         fprintf(stderr, &quot;%d: Creating new %s\n&quot;, getpid(), disambiguator);
79     void* rawDataPtr = allocate(sizeof(PerProcessData), std::alignment_of&lt;PerProcessData&gt;::value);
80     PerProcessData* data = static_cast&lt;PerProcessData*&gt;(rawDataPtr);
81     data-&gt;disambiguator = disambiguator;
82     data-&gt;memory = allocate(size, alignment);
83     data-&gt;size = size;
84     data-&gt;alignment = alignment;
85     data-&gt;next = bucket;
86     bucket = data;
87     return data;
88 }
89 
90 } // namespace bmalloc
91 
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>