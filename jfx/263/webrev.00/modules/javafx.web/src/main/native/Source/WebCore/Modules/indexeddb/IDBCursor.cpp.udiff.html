<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/IDBCursor.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IDBActiveDOMObject.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IDBCursor.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/IDBCursor.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -60,28 +60,28 @@</span>
  
  IDBCursor::IDBCursor(IDBObjectStore&amp; objectStore, const IDBCursorInfo&amp; info)
      : m_info(info)
      , m_source(&amp;objectStore)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;effectiveObjectStore().transaction().database().originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(effectiveObjectStore().transaction().database().originThread()));</span>
  }
  
  IDBCursor::IDBCursor(IDBIndex&amp; index, const IDBCursorInfo&amp; info)
      : m_info(info)
      , m_source(&amp;index)
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;effectiveObjectStore().transaction().database().originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(effectiveObjectStore().transaction().database().originThread()));</span>
  }
  
  IDBCursor::~IDBCursor()
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;effectiveObjectStore().transaction().database().originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(effectiveObjectStore().transaction().database().originThread()));</span>
  }
  
  bool IDBCursor::sourcesDeleted() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;effectiveObjectStore().transaction().database().originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(effectiveObjectStore().transaction().database().originThread()));</span>
  
      return WTF::switchOn(m_source,
          [] (const RefPtr&lt;IDBObjectStore&gt;&amp; objectStore) { return objectStore-&gt;isDeleted(); },
          [] (const RefPtr&lt;IDBIndex&gt;&amp; index) { return index-&gt;isDeleted() || index-&gt;objectStore().isDeleted(); }
      );
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -95,18 +95,18 @@</span>
      );
  }
  
  IDBTransaction&amp; IDBCursor::transaction() const
  {
<span class="udiff-line-modified-removed">-     ASSERT(&amp;effectiveObjectStore().transaction().database().originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(effectiveObjectStore().transaction().database().originThread()));</span>
      return effectiveObjectStore().transaction();
  }
  
<span class="udiff-line-modified-removed">- ExceptionOr&lt;Ref&lt;IDBRequest&gt;&gt; IDBCursor::update(ExecState&amp; state, JSValue value)</span>
<span class="udiff-line-modified-added">+ ExceptionOr&lt;Ref&lt;IDBRequest&gt;&gt; IDBCursor::update(JSGlobalObject&amp; state, JSValue value)</span>
  {
      LOG(IndexedDB, &quot;IDBCursor::update&quot;);
<span class="udiff-line-modified-removed">-     ASSERT(&amp;effectiveObjectStore().transaction().database().originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(effectiveObjectStore().transaction().database().originThread()));</span>
  
      if (sourcesDeleted())
          return Exception { InvalidStateError, &quot;Failed to execute &#39;update&#39; on &#39;IDBCursor&#39;: The cursor&#39;s source or effective object store has been deleted.&quot;_s };
  
      if (!transaction().isActive())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -142,11 +142,11 @@</span>
  }
  
  ExceptionOr&lt;void&gt; IDBCursor::advance(unsigned count)
  {
      LOG(IndexedDB, &quot;IDBCursor::advance&quot;);
<span class="udiff-line-modified-removed">-     ASSERT(&amp;effectiveObjectStore().transaction().database().originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(effectiveObjectStore().transaction().database().originThread()));</span>
  
      if (!m_request)
          return Exception { InvalidStateError };
  
      if (!count)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -166,11 +166,11 @@</span>
      uncheckedIterateCursor(IDBKeyData(), count);
  
      return { };
  }
  
<span class="udiff-line-modified-removed">- ExceptionOr&lt;void&gt; IDBCursor::continuePrimaryKey(ExecState&amp; state, JSValue keyValue, JSValue primaryKeyValue)</span>
<span class="udiff-line-modified-added">+ ExceptionOr&lt;void&gt; IDBCursor::continuePrimaryKey(JSGlobalObject&amp; state, JSValue keyValue, JSValue primaryKeyValue)</span>
  {
      if (!m_request)
          return Exception { InvalidStateError };
  
      if (!transaction().isActive())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -218,11 +218,11 @@</span>
      uncheckedIterateCursor(keyData, primaryKeyData);
  
      return { };
  }
  
<span class="udiff-line-modified-removed">- ExceptionOr&lt;void&gt; IDBCursor::continueFunction(ExecState&amp; execState, JSValue keyValue)</span>
<span class="udiff-line-modified-added">+ ExceptionOr&lt;void&gt; IDBCursor::continueFunction(JSGlobalObject&amp; execState, JSValue keyValue)</span>
  {
      RefPtr&lt;IDBKey&gt; key;
      if (!keyValue.isUndefined())
          key = scriptValueToIDBKey(execState, keyValue);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -230,11 +230,11 @@</span>
  }
  
  ExceptionOr&lt;void&gt; IDBCursor::continueFunction(const IDBKeyData&amp; key)
  {
      LOG(IndexedDB, &quot;IDBCursor::continueFunction (to key %s)&quot;, key.loggingString().utf8().data());
<span class="udiff-line-modified-removed">-     ASSERT(&amp;effectiveObjectStore().transaction().database().originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(effectiveObjectStore().transaction().database().originThread()));</span>
  
      if (!m_request)
          return Exception { InvalidStateError };
  
      if (!transaction().isActive())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -265,29 +265,29 @@</span>
  }
  
  void IDBCursor::uncheckedIterateCursor(const IDBKeyData&amp; key, unsigned count)
  {
      ASSERT(m_request);
<span class="udiff-line-modified-removed">-     ASSERT(&amp;effectiveObjectStore().transaction().database().originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(effectiveObjectStore().transaction().database().originThread()));</span>
  
      m_request-&gt;willIterateCursor(*this);
      transaction().iterateCursor(*this, { key, { }, count });
  }
  
  void IDBCursor::uncheckedIterateCursor(const IDBKeyData&amp; key, const IDBKeyData&amp; primaryKey)
  {
      ASSERT(m_request);
<span class="udiff-line-modified-removed">-     ASSERT(&amp;effectiveObjectStore().transaction().database().originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(effectiveObjectStore().transaction().database().originThread()));</span>
  
      m_request-&gt;willIterateCursor(*this);
      transaction().iterateCursor(*this, { key, primaryKey, 0 });
  }
  
<span class="udiff-line-modified-removed">- ExceptionOr&lt;Ref&lt;WebCore::IDBRequest&gt;&gt; IDBCursor::deleteFunction(ExecState&amp; state)</span>
<span class="udiff-line-modified-added">+ ExceptionOr&lt;Ref&lt;WebCore::IDBRequest&gt;&gt; IDBCursor::deleteFunction(JSGlobalObject&amp; state)</span>
  {
      LOG(IndexedDB, &quot;IDBCursor::deleteFunction&quot;);
<span class="udiff-line-modified-removed">-     ASSERT(&amp;effectiveObjectStore().transaction().database().originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(effectiveObjectStore().transaction().database().originThread()));</span>
  
      if (sourcesDeleted())
          return Exception { InvalidStateError, &quot;Failed to execute &#39;delete&#39; on &#39;IDBCursor&#39;: The cursor&#39;s source or effective object store has been deleted.&quot;_s };
  
      if (!transaction().isActive())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -310,14 +310,14 @@</span>
      request-&gt;setSource(*this);
  
      return request;
  }
  
<span class="udiff-line-modified-removed">- bool IDBCursor::setGetResult(IDBRequest&amp; request, const IDBGetResult&amp; getResult)</span>
<span class="udiff-line-modified-added">+ bool IDBCursor::setGetResult(IDBRequest&amp; request, const IDBGetResult&amp; getResult, uint64_t operationID)</span>
  {
      LOG(IndexedDB, &quot;IDBCursor::setGetResult - current key %s&quot;, getResult.keyData().loggingString().substring(0, 100).utf8().data());
<span class="udiff-line-modified-removed">-     ASSERT(&amp;effectiveObjectStore().transaction().database().originThread() == &amp;Thread::current());</span>
<span class="udiff-line-modified-added">+     ASSERT(canCurrentThreadAccessThreadLocalData(effectiveObjectStore().transaction().database().originThread()));</span>
  
      auto* context = request.scriptExecutionContext();
      if (!context)
          return false;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -347,10 +347,17 @@</span>
      if (isKeyCursorWithValue()) {
          m_value = getResult.value();
          m_keyPath = getResult.keyPath();
      }
  
<span class="udiff-line-added">+     auto prefetchedRecords = getResult.prefetchedRecords();</span>
<span class="udiff-line-added">+     if (!prefetchedRecords.isEmpty()) {</span>
<span class="udiff-line-added">+         for (auto&amp; record : prefetchedRecords)</span>
<span class="udiff-line-added">+             m_prefetchedRecords.append(record);</span>
<span class="udiff-line-added">+         m_prefetchOperationID = operationID;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      m_gotValue = true;
      return true;
  }
  
  void IDBCursor::clearWrappers()
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -358,8 +365,28 @@</span>
      m_keyWrapper.clear();
      m_primaryKeyWrapper.clear();
      m_valueWrapper.clear();
  }
  
<span class="udiff-line-added">+ Optional&lt;IDBGetResult&gt; IDBCursor::iterateWithPrefetchedRecords(unsigned count, uint64_t lastWriteOperationID)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     unsigned step = count &gt; 0 ? count : 1;</span>
<span class="udiff-line-added">+     if (step &gt; m_prefetchedRecords.size() || m_prefetchOperationID &lt;= lastWriteOperationID)</span>
<span class="udiff-line-added">+         return WTF::nullopt;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     while (--step)</span>
<span class="udiff-line-added">+         m_prefetchedRecords.removeFirst();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto record = m_prefetchedRecords.takeFirst();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     LOG(IndexedDB, &quot;IDBTransaction::iterateWithPrefetchedRecords consumes %u records&quot;, count &gt; 0 ? count : 1);</span>
<span class="udiff-line-added">+     return IDBGetResult(record.key, record.primaryKey, IDBValue(record.value), effectiveObjectStore().keyPath());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void IDBCursor::clearPrefetchedRecords()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_prefetchedRecords.clear();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  } // namespace WebCore
  
  #endif // ENABLE(INDEXED_DATABASE)
</pre>
<center><a href="IDBActiveDOMObject.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="IDBCursor.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>