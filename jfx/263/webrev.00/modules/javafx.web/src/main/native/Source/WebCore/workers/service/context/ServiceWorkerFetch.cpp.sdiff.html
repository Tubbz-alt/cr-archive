<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/workers/service/context/ServiceWorkerFetch.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SWContextManager.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ServiceWorkerThread.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/workers/service/context/ServiceWorkerFetch.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 72     }
 73     auto response = WTFMove(result.value());
 74 
 75     auto loadingError = response-&gt;loadingError();
 76     if (!loadingError.isNull()) {
 77         client-&gt;didFail(loadingError);
 78         return;
 79     }
 80 
 81     auto resourceResponse = response-&gt;resourceResponse();
 82     if (auto error = validateResponse(resourceResponse, mode, redirect)) {
 83         client-&gt;didFail(error.value());
 84         return;
 85     }
 86 
 87     if (resourceResponse.isRedirection() &amp;&amp; resourceResponse.httpHeaderFields().contains(HTTPHeaderName::Location)) {
 88         client-&gt;didReceiveRedirection(resourceResponse);
 89         return;
 90     }
 91 
<span class="line-removed"> 92     resourceResponse.setSource(ResourceResponse::Source::ServiceWorker);</span>
<span class="line-removed"> 93 </span>
 94     // In case of main resource and mime type is the default one, we set it to text/html to pass more service worker WPT tests.
 95     // FIXME: We should refine our MIME type sniffing strategy for synthetic responses.
 96     if (mode == FetchOptions::Mode::Navigate) {
 97         if (resourceResponse.mimeType() == defaultMIMEType()) {
 98             resourceResponse.setMimeType(&quot;text/html&quot;_s);
 99             resourceResponse.setTextEncodingName(&quot;UTF-8&quot;_s);
100         }
101     }
102 
103     // As per https://fetch.spec.whatwg.org/#main-fetch step 9, copy request&#39;s url list in response&#39;s url list if empty.
104     if (resourceResponse.url().isNull())
105         resourceResponse.setURL(requestURL);
106 
107     client-&gt;didReceiveResponse(resourceResponse);
108 
109     if (response-&gt;isBodyReceivedByChunk()) {
110         response-&gt;consumeBodyReceivedByChunk([client = WTFMove(client)] (auto&amp;&amp; result) mutable {
111             if (result.hasException()) {
112                 client-&gt;didFail(FetchEvent::createResponseError(URL { }, result.exception().message()));
113                 return;
</pre>
<hr />
<pre>
123 
124     auto body = response-&gt;consumeBody();
125     WTF::switchOn(body, [&amp;] (Ref&lt;FormData&gt;&amp; formData) {
126         client-&gt;didReceiveFormDataAndFinish(WTFMove(formData));
127     }, [&amp;] (Ref&lt;SharedBuffer&gt;&amp; buffer) {
128         client-&gt;didReceiveData(WTFMove(buffer));
129         client-&gt;didFinish();
130     }, [&amp;] (std::nullptr_t&amp;) {
131         client-&gt;didFinish();
132     });
133 }
134 
135 void dispatchFetchEvent(Ref&lt;Client&gt;&amp;&amp; client, ServiceWorkerGlobalScope&amp; globalScope, Optional&lt;ServiceWorkerClientIdentifier&gt; clientId, ResourceRequest&amp;&amp; request, String&amp;&amp; referrer, FetchOptions&amp;&amp; options)
136 {
137     auto requestHeaders = FetchHeaders::create(FetchHeaders::Guard::Immutable, HTTPHeaderMap { request.httpHeaderFields() });
138 
139     FetchOptions::Mode mode = options.mode;
140     FetchOptions::Redirect redirect = options.redirect;
141 
142     bool isNavigation = options.mode == FetchOptions::Mode::Navigate;
<span class="line-removed">143     bool isNonSubresourceRequest = WebCore::isNonSubresourceRequest(options.destination);</span>
144 
145     ASSERT(globalScope.registration().active());
146     ASSERT(globalScope.registration().active()-&gt;identifier() == globalScope.thread().identifier());
147     ASSERT(globalScope.registration().active()-&gt;state() == ServiceWorkerState::Activated);
148 
149     auto* formData = request.httpBody();
150     Optional&lt;FetchBody&gt; body;
151     if (formData &amp;&amp; !formData-&gt;isEmpty()) {
<span class="line-modified">152         body = FetchBody::fromFormData(globalScope.sessionID(), *formData);</span>
153         if (!body) {
154             client-&gt;didNotHandle();
155             return;
156         }
157     }
158     // FIXME: loading code should set redirect mode to manual.
159     if (isNavigation)
160         options.redirect = FetchOptions::Redirect::Manual;
161 
162     URL requestURL = request.url();
163     auto fetchRequest = FetchRequest::create(globalScope, WTFMove(body), WTFMove(requestHeaders),  WTFMove(request), WTFMove(options), WTFMove(referrer));
164 
165     FetchEvent::Init init;
166     init.request = WTFMove(fetchRequest);
167     if (isNavigation) {
168         // FIXME: Set reservedClientId.
169         if (clientId)
170             init.targetClientId = clientId-&gt;toString();
171     } else if (clientId)
172         init.clientId = clientId-&gt;toString();
173     init.cancelable = true;
174     auto event = FetchEvent::create(eventNames().fetchEvent, WTFMove(init), Event::IsTrusted::Yes);
175 
176     event-&gt;onResponse([client = client.copyRef(), mode, redirect, requestURL] (auto&amp;&amp; result) mutable {
177         processResponse(WTFMove(client), WTFMove(result), mode, redirect, requestURL);
178     });
179 
180     globalScope.dispatchEvent(event);
181 
182     if (!event-&gt;respondWithEntered()) {
183         if (event-&gt;defaultPrevented()) {
184             client-&gt;didFail(ResourceError { errorDomainWebKitInternal, 0, requestURL, &quot;Fetch event was canceled&quot;_s });
185             return;
186         }
187         client-&gt;didNotHandle();
188     }
189 
190     globalScope.updateExtendedEventsSet(event.ptr());
<span class="line-removed">191 </span>
<span class="line-removed">192     auto&amp; registration = globalScope.registration();</span>
<span class="line-removed">193     if (isNonSubresourceRequest || registration.needsUpdate())</span>
<span class="line-removed">194         registration.scheduleSoftUpdate();</span>
195 }
196 
197 } // namespace ServiceWorkerFetch
198 
199 } // namespace WebCore
200 
201 #endif // ENABLE(SERVICE_WORKER)
</pre>
</td>
<td>
<hr />
<pre>
 72     }
 73     auto response = WTFMove(result.value());
 74 
 75     auto loadingError = response-&gt;loadingError();
 76     if (!loadingError.isNull()) {
 77         client-&gt;didFail(loadingError);
 78         return;
 79     }
 80 
 81     auto resourceResponse = response-&gt;resourceResponse();
 82     if (auto error = validateResponse(resourceResponse, mode, redirect)) {
 83         client-&gt;didFail(error.value());
 84         return;
 85     }
 86 
 87     if (resourceResponse.isRedirection() &amp;&amp; resourceResponse.httpHeaderFields().contains(HTTPHeaderName::Location)) {
 88         client-&gt;didReceiveRedirection(resourceResponse);
 89         return;
 90     }
 91 


 92     // In case of main resource and mime type is the default one, we set it to text/html to pass more service worker WPT tests.
 93     // FIXME: We should refine our MIME type sniffing strategy for synthetic responses.
 94     if (mode == FetchOptions::Mode::Navigate) {
 95         if (resourceResponse.mimeType() == defaultMIMEType()) {
 96             resourceResponse.setMimeType(&quot;text/html&quot;_s);
 97             resourceResponse.setTextEncodingName(&quot;UTF-8&quot;_s);
 98         }
 99     }
100 
101     // As per https://fetch.spec.whatwg.org/#main-fetch step 9, copy request&#39;s url list in response&#39;s url list if empty.
102     if (resourceResponse.url().isNull())
103         resourceResponse.setURL(requestURL);
104 
105     client-&gt;didReceiveResponse(resourceResponse);
106 
107     if (response-&gt;isBodyReceivedByChunk()) {
108         response-&gt;consumeBodyReceivedByChunk([client = WTFMove(client)] (auto&amp;&amp; result) mutable {
109             if (result.hasException()) {
110                 client-&gt;didFail(FetchEvent::createResponseError(URL { }, result.exception().message()));
111                 return;
</pre>
<hr />
<pre>
121 
122     auto body = response-&gt;consumeBody();
123     WTF::switchOn(body, [&amp;] (Ref&lt;FormData&gt;&amp; formData) {
124         client-&gt;didReceiveFormDataAndFinish(WTFMove(formData));
125     }, [&amp;] (Ref&lt;SharedBuffer&gt;&amp; buffer) {
126         client-&gt;didReceiveData(WTFMove(buffer));
127         client-&gt;didFinish();
128     }, [&amp;] (std::nullptr_t&amp;) {
129         client-&gt;didFinish();
130     });
131 }
132 
133 void dispatchFetchEvent(Ref&lt;Client&gt;&amp;&amp; client, ServiceWorkerGlobalScope&amp; globalScope, Optional&lt;ServiceWorkerClientIdentifier&gt; clientId, ResourceRequest&amp;&amp; request, String&amp;&amp; referrer, FetchOptions&amp;&amp; options)
134 {
135     auto requestHeaders = FetchHeaders::create(FetchHeaders::Guard::Immutable, HTTPHeaderMap { request.httpHeaderFields() });
136 
137     FetchOptions::Mode mode = options.mode;
138     FetchOptions::Redirect redirect = options.redirect;
139 
140     bool isNavigation = options.mode == FetchOptions::Mode::Navigate;

141 
142     ASSERT(globalScope.registration().active());
143     ASSERT(globalScope.registration().active()-&gt;identifier() == globalScope.thread().identifier());
144     ASSERT(globalScope.registration().active()-&gt;state() == ServiceWorkerState::Activated);
145 
146     auto* formData = request.httpBody();
147     Optional&lt;FetchBody&gt; body;
148     if (formData &amp;&amp; !formData-&gt;isEmpty()) {
<span class="line-modified">149         body = FetchBody::fromFormData(*formData);</span>
150         if (!body) {
151             client-&gt;didNotHandle();
152             return;
153         }
154     }
155     // FIXME: loading code should set redirect mode to manual.
156     if (isNavigation)
157         options.redirect = FetchOptions::Redirect::Manual;
158 
159     URL requestURL = request.url();
160     auto fetchRequest = FetchRequest::create(globalScope, WTFMove(body), WTFMove(requestHeaders),  WTFMove(request), WTFMove(options), WTFMove(referrer));
161 
162     FetchEvent::Init init;
163     init.request = WTFMove(fetchRequest);
164     if (isNavigation) {
165         // FIXME: Set reservedClientId.
166         if (clientId)
167             init.targetClientId = clientId-&gt;toString();
168     } else if (clientId)
169         init.clientId = clientId-&gt;toString();
170     init.cancelable = true;
171     auto event = FetchEvent::create(eventNames().fetchEvent, WTFMove(init), Event::IsTrusted::Yes);
172 
173     event-&gt;onResponse([client = client.copyRef(), mode, redirect, requestURL] (auto&amp;&amp; result) mutable {
174         processResponse(WTFMove(client), WTFMove(result), mode, redirect, requestURL);
175     });
176 
177     globalScope.dispatchEvent(event);
178 
179     if (!event-&gt;respondWithEntered()) {
180         if (event-&gt;defaultPrevented()) {
181             client-&gt;didFail(ResourceError { errorDomainWebKitInternal, 0, requestURL, &quot;Fetch event was canceled&quot;_s });
182             return;
183         }
184         client-&gt;didNotHandle();
185     }
186 
187     globalScope.updateExtendedEventsSet(event.ptr());




188 }
189 
190 } // namespace ServiceWorkerFetch
191 
192 } // namespace WebCore
193 
194 #endif // ENABLE(SERVICE_WORKER)
</pre>
</td>
</tr>
</table>
<center><a href="SWContextManager.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ServiceWorkerThread.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>