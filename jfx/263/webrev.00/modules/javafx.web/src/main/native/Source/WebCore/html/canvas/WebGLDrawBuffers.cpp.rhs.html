<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/html/canvas/WebGLDrawBuffers.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2013 Google Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  *
  8  * 1.  Redistributions of source code must retain the above copyright
  9  *     notice, this list of conditions and the following disclaimer.
 10  * 2.  Redistributions in binary form must reproduce the above copyright
 11  *     notice, this list of conditions and the following disclaimer in the
 12  *     documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 16  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 17  * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 18  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 19  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 20  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 21  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 23  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 
 28 #if ENABLE(WEBGL)
 29 #include &quot;WebGLDrawBuffers.h&quot;
 30 
<a name="1" id="anc1"></a><span class="line-modified"> 31 #include &quot;ExtensionsGL.h&quot;</span>
 32 
 33 namespace WebCore {
 34 
 35 WebGLDrawBuffers::WebGLDrawBuffers(WebGLRenderingContextBase&amp; context)
 36     : WebGLExtension(context)
 37 {
<a name="2" id="anc2"></a><span class="line-added"> 38     context.graphicsContextGL()-&gt;getExtensions().ensureEnabled(&quot;GL_EXT_draw_buffers&quot;);</span>
 39 }
 40 
 41 WebGLDrawBuffers::~WebGLDrawBuffers() = default;
 42 
 43 WebGLExtension::ExtensionName WebGLDrawBuffers::getName() const
 44 {
 45     return WebGLExtension::WebGLDrawBuffersName;
 46 }
 47 
 48 bool WebGLDrawBuffers::supported(WebGLRenderingContextBase&amp; context)
 49 {
<a name="3" id="anc3"></a><span class="line-modified"> 50 #if USE(ANGLE)</span>
<span class="line-added"> 51     return context.graphicsContextGL()-&gt;getExtensions().supports(&quot;GL_EXT_draw_buffers&quot;);</span>
<span class="line-added"> 52 #else</span>
<span class="line-added"> 53     return context.graphicsContextGL()-&gt;getExtensions().supports(&quot;GL_EXT_draw_buffers&quot;)</span>
 54         &amp;&amp; satisfiesWebGLRequirements(context);
<a name="4" id="anc4"></a><span class="line-added"> 55 #endif</span>
 56 }
 57 
<a name="5" id="anc5"></a><span class="line-modified"> 58 void WebGLDrawBuffers::drawBuffersWEBGL(const Vector&lt;GCGLenum&gt;&amp; buffers)</span>
 59 {
 60     if (m_context.isContextLost())
 61         return;
<a name="6" id="anc6"></a><span class="line-modified"> 62     GCGLsizei n = buffers.size();</span>
<span class="line-modified"> 63     const GCGLenum* bufs = buffers.data();</span>
 64     if (!m_context.m_framebufferBinding) {
 65         if (n != 1) {
<a name="7" id="anc7"></a><span class="line-modified"> 66             m_context.synthesizeGLError(GraphicsContextGL::INVALID_VALUE, &quot;drawBuffersWEBGL&quot;, &quot;more than one buffer&quot;);</span>
 67             return;
 68         }
<a name="8" id="anc8"></a><span class="line-modified"> 69         if (bufs[0] != GraphicsContextGL::BACK &amp;&amp; bufs[0] != GraphicsContextGL::NONE) {</span>
<span class="line-modified"> 70             m_context.synthesizeGLError(GraphicsContextGL::INVALID_OPERATION, &quot;drawBuffersWEBGL&quot;, &quot;BACK or NONE&quot;);</span>
 71             return;
 72         }
 73         // Because the backbuffer is simulated on all current WebKit ports, we need to change BACK to COLOR_ATTACHMENT0.
<a name="9" id="anc9"></a><span class="line-modified"> 74         GCGLenum value = (bufs[0] == GraphicsContextGL::BACK) ? GraphicsContextGL::COLOR_ATTACHMENT0 : GraphicsContextGL::NONE;</span>
<span class="line-modified"> 75         m_context.graphicsContextGL()-&gt;getExtensions().drawBuffersEXT(1, &amp;value);</span>
 76         m_context.setBackDrawBuffer(bufs[0]);
 77     } else {
 78         if (n &gt; m_context.getMaxDrawBuffers()) {
<a name="10" id="anc10"></a><span class="line-modified"> 79             m_context.synthesizeGLError(GraphicsContextGL::INVALID_VALUE, &quot;drawBuffersWEBGL&quot;, &quot;more than max draw buffers&quot;);</span>
 80             return;
 81         }
<a name="11" id="anc11"></a><span class="line-modified"> 82         for (GCGLsizei i = 0; i &lt; n; ++i) {</span>
<span class="line-modified"> 83             if (bufs[i] != GraphicsContextGL::NONE &amp;&amp; bufs[i] != static_cast&lt;GCGLenum&gt;(ExtensionsGL::COLOR_ATTACHMENT0_EXT + i)) {</span>
<span class="line-modified"> 84                 m_context.synthesizeGLError(GraphicsContextGL::INVALID_OPERATION, &quot;drawBuffersWEBGL&quot;, &quot;COLOR_ATTACHMENTi_EXT or NONE&quot;);</span>
 85                 return;
 86             }
 87         }
 88         m_context.m_framebufferBinding-&gt;drawBuffers(buffers);
 89     }
 90 }
 91 
 92 // static
 93 bool WebGLDrawBuffers::satisfiesWebGLRequirements(WebGLRenderingContextBase&amp; webglContext)
 94 {
<a name="12" id="anc12"></a><span class="line-modified"> 95     GraphicsContextGLOpenGL* context = webglContext.graphicsContextGL();</span>
 96 
 97     // This is called after we make sure GL_EXT_draw_buffers is supported.
<a name="13" id="anc13"></a><span class="line-modified"> 98     GCGLint maxDrawBuffers = 0;</span>
<span class="line-modified"> 99     GCGLint maxColorAttachments = 0;</span>
<span class="line-modified">100     context-&gt;getIntegerv(ExtensionsGL::MAX_DRAW_BUFFERS_EXT, &amp;maxDrawBuffers);</span>
<span class="line-modified">101     context-&gt;getIntegerv(ExtensionsGL::MAX_COLOR_ATTACHMENTS_EXT, &amp;maxColorAttachments);</span>
102     if (maxDrawBuffers &lt; 4 || maxColorAttachments &lt; 4)
103         return false;
104 
<a name="14" id="anc14"></a><span class="line-modified">105     PlatformGLObject fbo = context-&gt;createFramebuffer();</span>
<span class="line-modified">106     context-&gt;bindFramebuffer(GraphicsContextGL::FRAMEBUFFER, fbo);</span>
107 
108     const unsigned char buffer[4] = { 0, 0, 0, 0 }; // textures are required to be initialized for other ports.
109     bool supportsDepth = context-&gt;getExtensions().supports(&quot;GL_OES_depth_texture&quot;)
110         || context-&gt;getExtensions().supports(&quot;GL_ARB_depth_texture&quot;);
111     bool supportsDepthStencil = (context-&gt;getExtensions().supports(&quot;GL_EXT_packed_depth_stencil&quot;)
112         || context-&gt;getExtensions().supports(&quot;GL_OES_packed_depth_stencil&quot;));
<a name="15" id="anc15"></a><span class="line-modified">113     PlatformGLObject depthStencil = 0;</span>
114     if (supportsDepthStencil) {
115         depthStencil = context-&gt;createTexture();
<a name="16" id="anc16"></a><span class="line-modified">116         context-&gt;bindTexture(GraphicsContextGL::TEXTURE_2D, depthStencil);</span>
<span class="line-modified">117         context-&gt;texImage2D(GraphicsContextGL::TEXTURE_2D, 0, GraphicsContextGL::DEPTH_STENCIL, 1, 1, 0, GraphicsContextGL::DEPTH_STENCIL, GraphicsContextGL::UNSIGNED_INT_24_8, buffer);</span>
118     }
<a name="17" id="anc17"></a><span class="line-modified">119     PlatformGLObject depth = 0;</span>
120     if (supportsDepth) {
121         depth = context-&gt;createTexture();
<a name="18" id="anc18"></a><span class="line-modified">122         context-&gt;bindTexture(GraphicsContextGL::TEXTURE_2D, depth);</span>
<span class="line-modified">123         context-&gt;texImage2D(GraphicsContextGL::TEXTURE_2D, 0, GraphicsContextGL::DEPTH_COMPONENT, 1, 1, 0, GraphicsContextGL::DEPTH_COMPONENT, GraphicsContextGL::UNSIGNED_INT, buffer);</span>
124     }
125 
<a name="19" id="anc19"></a><span class="line-modified">126     Vector&lt;PlatformGLObject&gt; colors;</span>
127     bool ok = true;
<a name="20" id="anc20"></a><span class="line-modified">128     GCGLint maxAllowedBuffers = std::min(maxDrawBuffers, maxColorAttachments);</span>
<span class="line-modified">129     for (GCGLint i = 0; i &lt; maxAllowedBuffers; ++i) {</span>
<span class="line-modified">130         PlatformGLObject color = context-&gt;createTexture();</span>
131         colors.append(color);
<a name="21" id="anc21"></a><span class="line-modified">132         context-&gt;bindTexture(GraphicsContextGL::TEXTURE_2D, color);</span>
<span class="line-modified">133         context-&gt;texImage2D(GraphicsContextGL::TEXTURE_2D, 0, GraphicsContextGL::RGBA, 1, 1, 0, GraphicsContextGL::RGBA, GraphicsContextGL::UNSIGNED_BYTE, buffer);</span>
<span class="line-modified">134         context-&gt;framebufferTexture2D(GraphicsContextGL::FRAMEBUFFER, GraphicsContextGL::COLOR_ATTACHMENT0 + i, GraphicsContextGL::TEXTURE_2D, color, 0);</span>
<span class="line-modified">135         if (context-&gt;checkFramebufferStatus(GraphicsContextGL::FRAMEBUFFER) != GraphicsContextGL::FRAMEBUFFER_COMPLETE) {</span>
136             ok = false;
137             break;
138         }
139         if (supportsDepth) {
<a name="22" id="anc22"></a><span class="line-modified">140             context-&gt;framebufferTexture2D(GraphicsContextGL::FRAMEBUFFER, GraphicsContextGL::DEPTH_ATTACHMENT, GraphicsContextGL::TEXTURE_2D, depth, 0);</span>
<span class="line-modified">141             if (context-&gt;checkFramebufferStatus(GraphicsContextGL::FRAMEBUFFER) != GraphicsContextGL::FRAMEBUFFER_COMPLETE) {</span>
142                 ok = false;
143                 break;
144             }
<a name="23" id="anc23"></a><span class="line-modified">145             context-&gt;framebufferTexture2D(GraphicsContextGL::FRAMEBUFFER, GraphicsContextGL::DEPTH_ATTACHMENT, GraphicsContextGL::TEXTURE_2D, 0, 0);</span>
146         }
147         if (supportsDepthStencil) {
<a name="24" id="anc24"></a><span class="line-modified">148             context-&gt;framebufferTexture2D(GraphicsContextGL::FRAMEBUFFER, GraphicsContextGL::DEPTH_ATTACHMENT, GraphicsContextGL::TEXTURE_2D, depthStencil, 0);</span>
<span class="line-modified">149             context-&gt;framebufferTexture2D(GraphicsContextGL::FRAMEBUFFER, GraphicsContextGL::STENCIL_ATTACHMENT, GraphicsContextGL::TEXTURE_2D, depthStencil, 0);</span>
<span class="line-modified">150             if (context-&gt;checkFramebufferStatus(GraphicsContextGL::FRAMEBUFFER) != GraphicsContextGL::FRAMEBUFFER_COMPLETE) {</span>
151                 ok = false;
152                 break;
153             }
<a name="25" id="anc25"></a><span class="line-modified">154             context-&gt;framebufferTexture2D(GraphicsContextGL::FRAMEBUFFER, GraphicsContextGL::DEPTH_ATTACHMENT, GraphicsContextGL::TEXTURE_2D, 0, 0);</span>
<span class="line-modified">155             context-&gt;framebufferTexture2D(GraphicsContextGL::FRAMEBUFFER, GraphicsContextGL::STENCIL_ATTACHMENT, GraphicsContextGL::TEXTURE_2D, 0, 0);</span>
156         }
157     }
158 
159     webglContext.restoreCurrentFramebuffer();
160     context-&gt;deleteFramebuffer(fbo);
161     webglContext.restoreCurrentTexture2D();
162     if (supportsDepth)
163         context-&gt;deleteTexture(depth);
164     if (supportsDepthStencil)
165         context-&gt;deleteTexture(depthStencil);
166     for (auto&amp; color : colors)
167         context-&gt;deleteTexture(color);
168     return ok;
169 }
170 
171 } // namespace WebCore
172 
173 #endif // ENABLE(WEBGL)
<a name="26" id="anc26"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="26" type="hidden" />
</body>
</html>