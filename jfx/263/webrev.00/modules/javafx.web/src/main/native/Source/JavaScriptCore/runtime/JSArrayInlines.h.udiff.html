<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSArrayInlines.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSArrayBufferViewInlines.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSAsyncFunction.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSArrayInlines.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  *  Copyright (C) 2016 Apple Inc. All rights reserved.</span>
<span class="udiff-line-modified-added">+  *  Copyright (C) 2016-2019 Apple Inc. All rights reserved.</span>
   *
   *  This library is free software; you can redistribute it and/or
   *  modify it under the terms of the GNU Lesser General Public
   *  License as published by the Free Software Foundation; either
   *  version 2 of the License, or (at your option) any later version.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -18,10 +18,11 @@</span>
   */
  
  #pragma once
  
  #include &quot;ArrayPrototype.h&quot;
<span class="udiff-line-added">+ #include &quot;ButterflyInlines.h&quot;</span>
  #include &quot;Error.h&quot;
  #include &quot;JSArray.h&quot;
  #include &quot;JSCellInlines.h&quot;
  #include &quot;Structure.h&quot;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -89,25 +90,25 @@</span>
          return false;
  
      return true;
  }
  
<span class="udiff-line-modified-removed">- ALWAYS_INLINE double toLength(ExecState* exec, JSObject* obj)</span>
<span class="udiff-line-modified-added">+ ALWAYS_INLINE double toLength(JSGlobalObject* globalObject, JSObject* obj)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = exec-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
      if (LIKELY(isJSArray(obj)))
          return jsCast&lt;JSArray*&gt;(obj)-&gt;length();
  
<span class="udiff-line-modified-removed">-     JSValue lengthValue = obj-&gt;get(exec, vm.propertyNames-&gt;length);</span>
<span class="udiff-line-modified-added">+     JSValue lengthValue = obj-&gt;get(globalObject, vm.propertyNames-&gt;length);</span>
      RETURN_IF_EXCEPTION(scope, PNaN);
<span class="udiff-line-modified-removed">-     RELEASE_AND_RETURN(scope, lengthValue.toLength(exec));</span>
<span class="udiff-line-modified-added">+     RELEASE_AND_RETURN(scope, lengthValue.toLength(globalObject));</span>
  }
  
<span class="udiff-line-modified-removed">- ALWAYS_INLINE void JSArray::pushInline(ExecState* exec, JSValue value)</span>
<span class="udiff-line-modified-added">+ ALWAYS_INLINE void JSArray::pushInline(JSGlobalObject* globalObject, JSValue value)</span>
  {
<span class="udiff-line-modified-removed">-     VM&amp; vm = exec-&gt;vm();</span>
<span class="udiff-line-modified-added">+     VM&amp; vm = globalObject-&gt;vm();</span>
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      ensureWritable(vm);
  
      Butterfly* butterfly = this-&gt;butterfly();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -119,19 +120,19 @@</span>
      }
  
      case ArrayWithUndecided: {
          convertUndecidedForValue(vm, value);
          scope.release();
<span class="udiff-line-modified-removed">-         push(exec, value);</span>
<span class="udiff-line-modified-added">+         push(globalObject, value);</span>
          return;
      }
  
      case ArrayWithInt32: {
          if (!value.isInt32()) {
              convertInt32ForValue(vm, value);
              scope.release();
<span class="udiff-line-modified-removed">-             push(exec, value);</span>
<span class="udiff-line-modified-added">+             push(globalObject, value);</span>
              return;
          }
  
          unsigned length = butterfly-&gt;publicLength();
          ASSERT(length &lt;= butterfly-&gt;vectorLength());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -140,54 +141,55 @@</span>
              butterfly-&gt;setPublicLength(length + 1);
              return;
          }
  
          if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="udiff-line-modified-removed">-             methodTable(vm)-&gt;putByIndex(this, exec, length, value, true);</span>
<span class="udiff-line-modified-added">+             methodTable(vm)-&gt;putByIndex(this, globalObject, length, value, true);</span>
              if (!scope.exception())
<span class="udiff-line-modified-removed">-                 throwException(exec, scope, createRangeError(exec, LengthExceededTheMaximumArrayLengthError));</span>
<span class="udiff-line-modified-added">+                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
              return;
          }
  
          scope.release();
<span class="udiff-line-modified-removed">-         putByIndexBeyondVectorLengthWithoutAttributes&lt;Int32Shape&gt;(exec, length, value);</span>
<span class="udiff-line-modified-added">+         putByIndexBeyondVectorLengthWithoutAttributes&lt;Int32Shape&gt;(globalObject, length, value);</span>
          return;
      }
  
      case ArrayWithContiguous: {
          unsigned length = butterfly-&gt;publicLength();
          ASSERT(length &lt;= butterfly-&gt;vectorLength());
          if (length &lt; butterfly-&gt;vectorLength()) {
<span class="udiff-line-modified-removed">-             butterfly-&gt;contiguous().at(this, length).set(vm, this, value);</span>
<span class="udiff-line-modified-added">+             butterfly-&gt;contiguous().at(this, length).setWithoutWriteBarrier(value);</span>
              butterfly-&gt;setPublicLength(length + 1);
<span class="udiff-line-added">+             vm.heap.writeBarrier(this, value);</span>
              return;
          }
  
          if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="udiff-line-modified-removed">-             methodTable(vm)-&gt;putByIndex(this, exec, length, value, true);</span>
<span class="udiff-line-modified-added">+             methodTable(vm)-&gt;putByIndex(this, globalObject, length, value, true);</span>
              if (!scope.exception())
<span class="udiff-line-modified-removed">-                 throwException(exec, scope, createRangeError(exec, LengthExceededTheMaximumArrayLengthError));</span>
<span class="udiff-line-modified-added">+                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
              return;
          }
  
          scope.release();
<span class="udiff-line-modified-removed">-         putByIndexBeyondVectorLengthWithoutAttributes&lt;ContiguousShape&gt;(exec, length, value);</span>
<span class="udiff-line-modified-added">+         putByIndexBeyondVectorLengthWithoutAttributes&lt;ContiguousShape&gt;(globalObject, length, value);</span>
          return;
      }
  
      case ArrayWithDouble: {
          if (!value.isNumber()) {
              convertDoubleToContiguous(vm);
              scope.release();
<span class="udiff-line-modified-removed">-             push(exec, value);</span>
<span class="udiff-line-modified-added">+             push(globalObject, value);</span>
              return;
          }
          double valueAsDouble = value.asNumber();
          if (valueAsDouble != valueAsDouble) {
              convertDoubleToContiguous(vm);
              scope.release();
<span class="udiff-line-modified-removed">-             push(exec, value);</span>
<span class="udiff-line-modified-added">+             push(globalObject, value);</span>
              return;
          }
  
          unsigned length = butterfly-&gt;publicLength();
          ASSERT(length &lt;= butterfly-&gt;vectorLength());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -196,30 +198,30 @@</span>
              butterfly-&gt;setPublicLength(length + 1);
              return;
          }
  
          if (UNLIKELY(length &gt; MAX_ARRAY_INDEX)) {
<span class="udiff-line-modified-removed">-             methodTable(vm)-&gt;putByIndex(this, exec, length, value, true);</span>
<span class="udiff-line-modified-added">+             methodTable(vm)-&gt;putByIndex(this, globalObject, length, value, true);</span>
              if (!scope.exception())
<span class="udiff-line-modified-removed">-                 throwException(exec, scope, createRangeError(exec, LengthExceededTheMaximumArrayLengthError));</span>
<span class="udiff-line-modified-added">+                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
              return;
          }
  
          scope.release();
<span class="udiff-line-modified-removed">-         putByIndexBeyondVectorLengthWithoutAttributes&lt;DoubleShape&gt;(exec, length, value);</span>
<span class="udiff-line-modified-added">+         putByIndexBeyondVectorLengthWithoutAttributes&lt;DoubleShape&gt;(globalObject, length, value);</span>
          return;
      }
  
      case ArrayWithSlowPutArrayStorage: {
          unsigned oldLength = length();
          bool putResult = false;
<span class="udiff-line-modified-removed">-         bool result = attemptToInterceptPutByIndexOnHole(exec, oldLength, value, true, putResult);</span>
<span class="udiff-line-modified-added">+         bool result = attemptToInterceptPutByIndexOnHole(globalObject, oldLength, value, true, putResult);</span>
          RETURN_IF_EXCEPTION(scope, void());
          if (result) {
              if (oldLength &lt; 0xFFFFFFFFu) {
                  scope.release();
<span class="udiff-line-modified-removed">-                 setLength(exec, oldLength + 1, true);</span>
<span class="udiff-line-modified-added">+                 setLength(globalObject, oldLength + 1, true);</span>
              }
              return;
          }
          FALLTHROUGH;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -236,20 +238,20 @@</span>
              return;
          }
  
          // Pushing to an array of invalid length (2^31-1) stores the property, but throws a range error.
          if (UNLIKELY(storage-&gt;length() &gt; MAX_ARRAY_INDEX)) {
<span class="udiff-line-modified-removed">-             methodTable(vm)-&gt;putByIndex(this, exec, storage-&gt;length(), value, true);</span>
<span class="udiff-line-modified-added">+             methodTable(vm)-&gt;putByIndex(this, globalObject, storage-&gt;length(), value, true);</span>
              // Per ES5.1 15.4.4.7 step 6 &amp; 15.4.5.1 step 3.d.
              if (!scope.exception())
<span class="udiff-line-modified-removed">-                 throwException(exec, scope, createRangeError(exec, LengthExceededTheMaximumArrayLengthError));</span>
<span class="udiff-line-modified-added">+                 throwException(globalObject, scope, createRangeError(globalObject, LengthExceededTheMaximumArrayLengthError));</span>
              return;
          }
  
          // Handled the same as putIndex.
          scope.release();
<span class="udiff-line-modified-removed">-         putByIndexBeyondVectorLengthWithArrayStorage(exec, storage-&gt;length(), value, true, storage);</span>
<span class="udiff-line-modified-added">+         putByIndexBeyondVectorLengthWithArrayStorage(globalObject, storage-&gt;length(), value, true, storage);</span>
          return;
      }
  
      default:
          RELEASE_ASSERT_NOT_REACHED();
</pre>
<center><a href="JSArrayBufferViewInlines.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSAsyncFunction.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>