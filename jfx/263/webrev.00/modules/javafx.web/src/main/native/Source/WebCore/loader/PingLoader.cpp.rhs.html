<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/loader/PingLoader.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2010 Google Inc. All rights reserved.
  3  * Copyright (C) 2015 Roopesh Chander (roop@roopc.net)
  4  * Copyright (C) 2015-2017 Apple Inc. All rights reserved.
  5  *
  6  * Redistribution and use in source and binary forms, with or without
  7  * modification, are permitted provided that the following conditions are
  8  * met:
  9  *
 10  *     * Redistributions of source code must retain the above copyright
 11  * notice, this list of conditions and the following disclaimer.
 12  *     * Redistributions in binary form must reproduce the above
 13  * copyright notice, this list of conditions and the following disclaimer
 14  * in the documentation and/or other materials provided with the
 15  * distribution.
 16  *     * Neither the name of Google Inc. nor the names of its
 17  * contributors may be used to endorse or promote products derived from
 18  * this software without specific prior written permission.
 19  *
 20  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 21  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 22  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 23  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 24  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 25  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 26  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 27  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 28  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 29  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 30  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 31  *
 32  */
 33 
 34 #include &quot;config.h&quot;
 35 #include &quot;PingLoader.h&quot;
 36 
 37 #include &quot;CachedResourceLoader.h&quot;
 38 #include &quot;CachedResourceRequest.h&quot;
 39 #include &quot;ContentRuleListResults.h&quot;
 40 #include &quot;ContentSecurityPolicy.h&quot;
 41 #include &quot;Document.h&quot;
 42 #include &quot;Frame.h&quot;
 43 #include &quot;FrameLoader.h&quot;
 44 #include &quot;FrameLoaderClient.h&quot;
<a name="1" id="anc1"></a><span class="line-added"> 45 #include &quot;HTTPHeaderValues.h&quot;</span>
 46 #include &quot;InspectorInstrumentation.h&quot;
 47 #include &quot;LoaderStrategy.h&quot;
 48 #include &quot;NetworkLoadMetrics.h&quot;
 49 #include &quot;Page.h&quot;
 50 #include &quot;PlatformStrategies.h&quot;
 51 #include &quot;ProgressTracker.h&quot;
 52 #include &quot;ResourceError.h&quot;
 53 #include &quot;ResourceHandle.h&quot;
 54 #include &quot;ResourceLoadInfo.h&quot;
 55 #include &quot;ResourceRequest.h&quot;
 56 #include &quot;ResourceResponse.h&quot;
 57 #include &quot;SecurityOrigin.h&quot;
 58 #include &quot;SecurityPolicy.h&quot;
 59 #include &quot;UserContentController.h&quot;
 60 #include &lt;wtf/text/CString.h&gt;
 61 
 62 namespace WebCore {
 63 
 64 #if ENABLE(CONTENT_EXTENSIONS)
 65 
 66 // Returns true if we should block the load.
 67 static bool processContentRuleListsForLoad(const Frame&amp; frame, ResourceRequest&amp; request, OptionSet&lt;ContentExtensions::ResourceType&gt; resourceType)
 68 {
 69     auto* documentLoader = frame.loader().documentLoader();
 70     if (!documentLoader)
 71         return false;
 72     auto* page = frame.page();
 73     if (!page)
 74         return false;
 75     auto results = page-&gt;userContentProvider().processContentRuleListsForLoad(request.url(), resourceType, *documentLoader);
 76     bool result = results.summary.blockedLoad;
 77     ContentExtensions::applyResultsToRequest(WTFMove(results), page, request);
 78     return result;
 79 }
 80 
 81 #endif
 82 
 83 void PingLoader::loadImage(Frame&amp; frame, const URL&amp; url)
 84 {
 85     ASSERT(frame.document());
 86     auto&amp; document = *frame.document();
 87 
 88     if (!document.securityOrigin().canDisplay(url)) {
 89         FrameLoader::reportLocalLoadFailed(&amp;frame, url);
 90         return;
 91     }
 92 
 93     ResourceRequest request(url);
 94 #if ENABLE(CONTENT_EXTENSIONS)
 95     if (processContentRuleListsForLoad(frame, request, ContentExtensions::ResourceType::Image))
 96         return;
 97 #endif
 98 
 99     document.contentSecurityPolicy()-&gt;upgradeInsecureRequestIfNeeded(request, ContentSecurityPolicy::InsecureRequestType::Load);
100 
<a name="2" id="anc2"></a><span class="line-modified">101     request.setHTTPHeaderField(HTTPHeaderName::CacheControl, HTTPHeaderValues::maxAge0());</span>
102 
103     HTTPHeaderMap originalRequestHeader = request.httpHeaderFields();
104 
105     String referrer = SecurityPolicy::generateReferrerHeader(document.referrerPolicy(), request.url(), frame.loader().outgoingReferrer());
106     if (!referrer.isEmpty())
107         request.setHTTPReferrer(referrer);
108     frame.loader().addExtraFieldsToSubresourceRequest(request);
109 
110     startPingLoad(frame, request, WTFMove(originalRequestHeader), ShouldFollowRedirects::Yes, ContentSecurityPolicyImposition::DoPolicyCheck, ReferrerPolicy::EmptyString);
111 }
112 
113 // http://www.whatwg.org/specs/web-apps/current-work/multipage/links.html#hyperlink-auditing
114 void PingLoader::sendPing(Frame&amp; frame, const URL&amp; pingURL, const URL&amp; destinationURL)
115 {
116     ASSERT(frame.document());
117 
118     if (!pingURL.protocolIsInHTTPFamily())
119         return;
120 
121     ResourceRequest request(pingURL);
122 #if ENABLE(CONTENT_EXTENSIONS)
123     if (processContentRuleListsForLoad(frame, request, { ContentExtensions::ResourceType::Raw, ContentExtensions::ResourceType::Ping }))
124         return;
125 #endif
126 
127     auto&amp; document = *frame.document();
128     document.contentSecurityPolicy()-&gt;upgradeInsecureRequestIfNeeded(request, ContentSecurityPolicy::InsecureRequestType::Load);
129 
130     request.setHTTPMethod(&quot;POST&quot;);
131     request.setHTTPContentType(&quot;text/ping&quot;);
132     request.setHTTPBody(FormData::create(&quot;PING&quot;));
<a name="3" id="anc3"></a><span class="line-modified">133     request.setHTTPHeaderField(HTTPHeaderName::CacheControl, HTTPHeaderValues::maxAge0());</span>

134 
135     HTTPHeaderMap originalRequestHeader = request.httpHeaderFields();
136 
137     frame.loader().addExtraFieldsToSubresourceRequest(request);
138 
139     auto&amp; sourceOrigin = document.securityOrigin();
140     FrameLoader::addHTTPOriginIfNeeded(request, sourceOrigin.toString());
141     request.setHTTPHeaderField(HTTPHeaderName::PingTo, destinationURL);
<a name="4" id="anc4"></a><span class="line-modified">142     if (!SecurityPolicy::shouldHideReferrer(pingURL, frame.loader().outgoingReferrer()))</span>
143         request.setHTTPHeaderField(HTTPHeaderName::PingFrom, document.url());
<a name="5" id="anc5"></a>





144 
<a name="6" id="anc6"></a><span class="line-modified">145     startPingLoad(frame, request, WTFMove(originalRequestHeader), ShouldFollowRedirects::Yes, ContentSecurityPolicyImposition::DoPolicyCheck, ReferrerPolicy::NoReferrer);</span>
146 }
147 
148 void PingLoader::sendViolationReport(Frame&amp; frame, const URL&amp; reportURL, Ref&lt;FormData&gt;&amp;&amp; report, ViolationReportType reportType)
149 {
150     ASSERT(frame.document());
151 
152     ResourceRequest request(reportURL);
153 #if ENABLE(CONTENT_EXTENSIONS)
154     if (processContentRuleListsForLoad(frame, request, ContentExtensions::ResourceType::Raw))
155         return;
156 #endif
157 
158     auto&amp; document = *frame.document();
159     document.contentSecurityPolicy()-&gt;upgradeInsecureRequestIfNeeded(request, ContentSecurityPolicy::InsecureRequestType::Load);
160 
161     request.setHTTPMethod(&quot;POST&quot;_s);
162     request.setHTTPBody(WTFMove(report));
163     switch (reportType) {
164     case ViolationReportType::ContentSecurityPolicy:
165         request.setHTTPContentType(&quot;application/csp-report&quot;_s);
166         break;
167     case ViolationReportType::XSSAuditor:
168         request.setHTTPContentType(&quot;application/json&quot;_s);
169         break;
170     }
171 
172     bool removeCookies = true;
173     if (document.securityOrigin().isSameSchemeHostPort(SecurityOrigin::create(reportURL).get()))
174         removeCookies = false;
175     if (removeCookies)
176         request.setAllowCookies(false);
177 
178     HTTPHeaderMap originalRequestHeader = request.httpHeaderFields();
179 
180     frame.loader().addExtraFieldsToSubresourceRequest(request);
181 
182     String referrer = SecurityPolicy::generateReferrerHeader(document.referrerPolicy(), reportURL, frame.loader().outgoingReferrer());
183     if (!referrer.isEmpty())
184         request.setHTTPReferrer(referrer);
185 
186     startPingLoad(frame, request, WTFMove(originalRequestHeader), ShouldFollowRedirects::No, ContentSecurityPolicyImposition::SkipPolicyCheck, ReferrerPolicy::EmptyString);
187 }
188 
189 void PingLoader::startPingLoad(Frame&amp; frame, ResourceRequest&amp; request, HTTPHeaderMap&amp;&amp; originalRequestHeaders, ShouldFollowRedirects shouldFollowRedirects, ContentSecurityPolicyImposition policyCheck, ReferrerPolicy referrerPolicy)
190 {
191     unsigned long identifier = frame.page()-&gt;progress().createUniqueIdentifier();
192     // FIXME: Why activeDocumentLoader? I would have expected documentLoader().
193     // It seems like the PingLoader should be associated with the current
194     // Document in the Frame, but the activeDocumentLoader will be associated
195     // with the provisional DocumentLoader if there is a provisional
196     // DocumentLoader.
197     bool shouldUseCredentialStorage = frame.loader().client().shouldUseCredentialStorage(frame.loader().activeDocumentLoader(), identifier);
198     ResourceLoaderOptions options;
199     options.credentials = shouldUseCredentialStorage ? FetchOptions::Credentials::Include : FetchOptions::Credentials::Omit;
200     options.redirect = shouldFollowRedirects == ShouldFollowRedirects::Yes ? FetchOptions::Redirect::Follow : FetchOptions::Redirect::Error;
201     options.keepAlive = true;
202     options.contentSecurityPolicyImposition = policyCheck;
203     options.referrerPolicy = referrerPolicy;
204     options.sendLoadCallbacks = SendCallbackPolicy::SendCallbacks;
205     options.cache = FetchOptions::Cache::NoCache;
206 
207     // FIXME: Deprecate the ping load code path.
208     if (platformStrategies()-&gt;loaderStrategy()-&gt;usePingLoad()) {
209         InspectorInstrumentation::willSendRequestOfType(&amp;frame, identifier, frame.loader().activeDocumentLoader(), request, InspectorInstrumentation::LoadType::Ping);
210 
211         platformStrategies()-&gt;loaderStrategy()-&gt;startPingLoad(frame, request, WTFMove(originalRequestHeaders), options, policyCheck, [protectedFrame = makeRef(frame), identifier] (const ResourceError&amp; error, const ResourceResponse&amp; response) {
212             if (!response.isNull())
213                 InspectorInstrumentation::didReceiveResourceResponse(protectedFrame, identifier, protectedFrame-&gt;loader().activeDocumentLoader(), response, nullptr);
214             if (!error.isNull()) {
215                 InspectorInstrumentation::didFailLoading(protectedFrame.ptr(), protectedFrame-&gt;loader().activeDocumentLoader(), identifier, error);
216                 return;
217             }
218             InspectorInstrumentation::didFinishLoading(protectedFrame.ptr(), protectedFrame-&gt;loader().activeDocumentLoader(), identifier, { }, nullptr);
219         });
220         return;
221     }
222 
223     CachedResourceRequest cachedResourceRequest { ResourceRequest { request }, options };
224     frame.document()-&gt;cachedResourceLoader().requestPingResource(WTFMove(cachedResourceRequest));
225 }
226 
227 }
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>