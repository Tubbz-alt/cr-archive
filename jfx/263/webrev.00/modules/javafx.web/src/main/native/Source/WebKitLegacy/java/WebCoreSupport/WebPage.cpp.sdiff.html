<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebKitLegacy/java/WebCoreSupport/WebPage.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="VisitedLinkStoreJava.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebPage.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebKitLegacy/java/WebCoreSupport/WebPage.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  40 #include &quot;InspectorClientJava.h&quot;
  41 #include &quot;PageStorageSessionProvider.h&quot;
  42 #include &quot;PlatformStrategiesJava.h&quot;
  43 #include &quot;ProgressTrackerClientJava.h&quot;
  44 #include &quot;VisitedLinkStoreJava.h&quot;
  45 #include &quot;WebKitLegacy/Storage/StorageNamespaceImpl.h&quot;
  46 #include &quot;WebKitLegacy/Storage/WebDatabaseProvider.h&quot;
  47 #include &quot;WebKitVersion.h&quot; //generated
  48 #include &quot;WebPageConfig.h&quot;
  49 #include &lt;WebCore/WebCoreTestSupport.h&gt;
  50 #include &lt;JavaScriptCore/APICast.h&gt;
  51 #include &lt;JavaScriptCore/InitializeThreading.h&gt;
  52 #include &lt;JavaScriptCore/JSContextRef.h&gt;
  53 #include &lt;JavaScriptCore/JSContextRefPrivate.h&gt;
  54 #include &lt;JavaScriptCore/JSStringRef.h&gt;
  55 #include &lt;JavaScriptCore/Options.h&gt;
  56 #include &lt;WebCore/BackForwardController.h&gt;
  57 #include &lt;WebCore/BridgeUtils.h&gt;
  58 #include &lt;WebCore/CharacterData.h&gt;
  59 #include &lt;WebCore/Chrome.h&gt;

  60 #include &lt;WebCore/ContextMenu.h&gt;
  61 #include &lt;WebCore/ContextMenuController.h&gt;
  62 #include &lt;WebCore/CookieJar.h&gt;
  63 #include &lt;WebCore/DeprecatedGlobalSettings.h&gt;
  64 #include &lt;WebCore/Document.h&gt;
  65 #include &lt;WebCore/DragController.h&gt;
  66 #include &lt;WebCore/DragData.h&gt;
  67 #include &lt;WebCore/Editor.h&gt;
  68 #include &lt;WebCore/EmptyClients.h&gt;
  69 #include &lt;WebCore/EventHandler.h&gt;
  70 #include &lt;WebCore/FloatRect.h&gt;
  71 #include &lt;WebCore/FloatSize.h&gt;
  72 #include &lt;WebCore/FocusController.h&gt;
  73 #include &lt;WebCore/Frame.h&gt;
  74 #include &lt;WebCore/FrameLoadRequest.h&gt;
  75 #include &lt;WebCore/FrameTree.h&gt;
  76 #include &lt;WebCore/FrameView.h&gt;
  77 #include &lt;WebCore/GCController.h&gt;
  78 #include &lt;WebCore/GeolocationClientMock.h&gt;
  79 #include &lt;WebCore/GraphicsContext.h&gt;
</pre>
<hr />
<pre>
 231         // Updating layout &amp; styles precedes normal painting.
 232         frameView-&gt;updateLayoutAndStyleIfNeededRecursive();
 233     }
 234 }
 235 
 236 RefPtr&lt;RQRef&gt; WebPage::jRenderTheme()
 237 {
 238     if (!m_jRenderTheme) {
 239         JNIEnv* env = WTF::GetJavaEnv();
 240         m_jRenderTheme = RQRef::create(PG_GetRenderThemeObjectFromPage(env, jobjectFromPage(m_page.get())));
 241     }
 242     return m_jRenderTheme;
 243 }
 244 
 245 void WebPage::paint(jobject rq, jint x, jint y, jint w, jint h)
 246 {
 247     if (m_rootLayer) {
 248         return;
 249     }
 250 
<span class="line-modified"> 251     DBG_CHECKPOINTEX(&quot;twkUpdateContent&quot;, 15, 100);</span>
 252 
 253     RefPtr&lt;Frame&gt; mainFrame((Frame*)&amp;m_page-&gt;mainFrame());
 254     RefPtr&lt;FrameView&gt; frameView(mainFrame-&gt;view());
 255     if (!frameView) {
 256         return;
 257     }
 258 
 259     // Will be deleted by GraphicsContext destructor
 260     PlatformContextJava* ppgc = new PlatformContextJava(rq, jRenderTheme());
 261     GraphicsContext gc(ppgc);
 262 
 263     // TODO: Following JS synchronization is not necessary for single thread model
<span class="line-modified"> 264     JSGlobalContextRef globalContext = toGlobalRef(mainFrame-&gt;script().globalObject(mainThreadNormalWorld())-&gt;globalExec());</span>
 265     JSC::JSLockHolder sw(toJS(globalContext)); // TODO-java: was JSC::APIEntryShim sw( toJS(globalContext) );
 266 
 267     frameView-&gt;paint(gc, IntRect(x, y, w, h));
 268     if (m_page-&gt;settings().showDebugBorders()) {
 269         drawDebugLed(gc, IntRect(x, y, w, h), Color(0, 0, 255, 128));
 270     }
 271 
 272     gc.platformContext()-&gt;rq().flushBuffer();
 273 }
 274 
 275 void WebPage::postPaint(jobject rq, jint x, jint y, jint w, jint h)
 276 {
 277     if (!m_page-&gt;inspectorController().highlightedNode()
 278             &amp;&amp; !m_rootLayer
 279     ) {
 280         return;
 281     }
 282 
 283     // Will be deleted by GraphicsContext destructor
 284     PlatformContextJava* ppgc = new PlatformContextJava(rq, jRenderTheme());
</pre>
<hr />
<pre>
 436     TransformationMatrix matrix;
 437     m_textureMapper-&gt;beginPainting();
 438     m_textureMapper-&gt;beginClip(matrix, clip);
 439     rootTextureMapperLayer.applyAnimationsRecursively(MonotonicTime::now());
 440     downcast&lt;GraphicsLayerTextureMapper&gt;(*m_rootLayer).updateBackingStoreIncludingSubLayers();
 441     rootTextureMapperLayer.paint();
 442     m_textureMapper-&gt;endClip();
 443     m_textureMapper-&gt;endPainting();
 444 }
 445 
 446 void WebPage::notifyAnimationStarted(const GraphicsLayer*, const String&amp; /*animationKey*/, MonotonicTime /*time*/)
 447 {
 448     ASSERT_NOT_REACHED();
 449 }
 450 
 451 void WebPage::notifyFlushRequired(const GraphicsLayer*)
 452 {
 453     markForSync();
 454 }
 455 
<span class="line-modified"> 456 void WebPage::paintContents(const GraphicsLayer*,</span>
<span class="line-removed"> 457                    GraphicsContext&amp; context,</span>
<span class="line-removed"> 458                    OptionSet&lt;GraphicsLayerPaintingPhase&gt;,</span>
<span class="line-removed"> 459                    const FloatRect&amp; inClip,</span>
<span class="line-removed"> 460                    GraphicsLayerPaintBehavior)</span>
 461 {
 462     context.save();
 463     context.clip(inClip);
 464     m_page-&gt;mainFrame().view()-&gt;paint(context, enclosingIntRect(inClip));
 465     if (m_page-&gt;settings().showDebugBorders()) {
 466         drawDebugBorder(context, roundedIntRect(inClip), Color(0, 192, 0), 20);
 467     }
 468     context.restore();
 469 }
 470 
 471 bool WebPage::processKeyEvent(const PlatformKeyboardEvent&amp; event)
 472 {
 473     return event.type() == PlatformKeyboardEvent::Char
 474         ? charEvent(event)
 475         : keyEvent(event);
 476 }
 477 
 478 //
 479 // The below keyboard event handling code was adapted from
 480 // WebKit/chromium/src/WebViewImpl.cpp
</pre>
<hr />
<pre>
 853     //DBG_CHECKPOINTEX(&quot;twkCreatePage&quot;, 3, 5);
 854 
 855     VisitedLinkStoreJava::setShouldTrackVisitedLinks(true);
 856 
 857 #if !LOG_DISABLED
 858     WebKitInitializeLogChannelsIfNecessary();
 859 #endif
 860     WebCore::PlatformStrategiesJava::initialize();
 861 
 862     static std::once_flag initializeJSCOptions;
 863     std::call_once(initializeJSCOptions, [] {
 864         JSC::Options::useJIT() = s_useJIT;
 865         // Enable DFG only if JIT is enabled.
 866         JSC::Options::useDFGJIT() = s_useJIT &amp;&amp; s_useDFGJIT;
 867     });
 868 
 869     JLObject jlself(self, true);
 870 
 871     //utaTODO: history agent implementation
 872 
<span class="line-modified"> 873     auto pc = pageConfigurationWithEmptyClients();</span>
 874     auto pageStorageSessionProvider = PageStorageSessionProvider::create();
 875     pc.cookieJar = CookieJar::create(pageStorageSessionProvider.copyRef());
 876     pc.chromeClient = new ChromeClientJava(jlself);
 877     pc.contextMenuClient = new ContextMenuClientJava(jlself);
 878     pc.editorClient = makeUniqueRef&lt;EditorClientJava&gt;(jlself);
<span class="line-modified"> 879     pc.dragClient = new DragClientJava(jlself);</span>
 880     pc.inspectorClient = new InspectorClientJava(jlself);
 881     pc.databaseProvider = &amp;WebDatabaseProvider::singleton();
 882     pc.storageNamespaceProvider = adoptRef(new WebStorageNamespaceProviderJava());
 883     pc.visitedLinkStore = VisitedLinkStoreJava::create();
 884 
 885     pc.loaderClientForMainFrame = new FrameLoaderClientJava(jlself);
<span class="line-modified"> 886     pc.progressTrackerClient = new ProgressTrackerClientJava(jlself);</span>
 887 
 888     pc.backForwardClient = BackForwardList::create();
 889     auto page = std::make_unique&lt;Page&gt;(WTFMove(pc));
 890     // Associate PageSupplementJava instance which has WebPage java object.
 891     page-&gt;provideSupplement(PageSupplementJava::supplementName(), std::make_unique&lt;PageSupplementJava&gt;(self));
 892     pageStorageSessionProvider-&gt;setPage(*page);
 893 #if ENABLE(GEOLOCATION)
 894     WebCore::provideGeolocationTo(page.get(), *new GeolocationClientMock());
 895 #endif
 896     return ptr_to_jlong(new WebPage(WTFMove(page)));
 897 }
 898 
 899 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkInit
 900     (JNIEnv* env, jobject self, jlong pPage, jboolean usePlugins, jfloat devicePixelScale)
 901 {
 902     Page* page = WebPage::pageFromJLong(pPage);
 903 
 904     /* Initialization of the default settings */
 905     Settings&amp; settings = page-&gt;settings();
 906     settings.setTextAreasAreResizable(true);
</pre>
<hr />
<pre>
1097     if (!frame) {
1098         return 0;
1099     }
1100 #if ENABLE(ICONDATABASE)
1101     return frame-&gt;loader()-&gt;icon()-&gt;url().string().toJavaString(env).releaseLocal();
1102 #else
1103     return 0;
1104 #endif
1105 }
1106 
1107 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkOpen
1108     (JNIEnv* env, jobject self, jlong pFrame, jstring url)
1109 {
1110     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1111     if (!frame) {
1112         return;
1113     }
1114 
1115     static const URL emptyParent;
1116 
<span class="line-modified">1117     frame-&gt;loader().load(FrameLoadRequest(</span>
1118         *frame,
1119         ResourceRequest(URL(emptyParent, String(env, url))),
1120         ShouldOpenExternalURLsPolicy::ShouldNotAllow // TODO-java: recheck policy value
<span class="line-modified">1121     ));</span>


1122 }
1123 
1124 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkLoad
1125     (JNIEnv* env, jobject self, jlong pFrame, jstring text, jstring contentType)
1126 {
1127     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1128     if (!frame) {
1129         return;
1130     }
1131 
1132     const char* stringChars = env-&gt;GetStringUTFChars(text, JNI_FALSE);
1133     size_t stringLen = (size_t)env-&gt;GetStringUTFLength(text);
1134     RefPtr&lt;SharedBuffer&gt; buffer = SharedBuffer::create(stringChars, (int)stringLen);
1135 
1136     static const URL emptyUrl({ }, &quot;&quot;);
1137     ResourceResponse response(URL(), String(env, contentType), stringLen, &quot;UTF-8&quot;);
<span class="line-modified">1138     frame-&gt;loader().load(FrameLoadRequest(</span>
1139         *frame,
1140         ResourceRequest(emptyUrl),
1141         ShouldOpenExternalURLsPolicy::ShouldNotAllow, // TODO-java: recheck policy value
1142         SubstituteData(
1143             WTFMove(buffer),
1144             URL(),
1145             response,
1146             SubstituteData::SessionHistoryVisibility::Visible) // TODO-java: or Hidden?
<span class="line-modified">1147     ));</span>


1148 
1149     env-&gt;ReleaseStringUTFChars(text, stringChars);
1150 }
1151 
1152 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsLoading
1153     (JNIEnv* env, jobject self, jlong pFrame)
1154 {
1155     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1156 
1157     return bool_to_jbool(frame &amp;&amp; frame-&gt;loader().isLoading());
1158 }
1159 
1160 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkStop
1161     (JNIEnv* env, jobject self, jlong pFrame)
1162 {
1163     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1164     if (!frame) {
1165         return;
1166     }
1167 
</pre>
<hr />
<pre>
1290     } else if (nativePropertyName == &quot;WebKitPluginsEnabled&quot;) {
1291         settings.setPluginsEnabled(nativePropertyValue.toInt());
1292     } else if (nativePropertyName == &quot;WebKitDefaultFixedFontSize&quot;) {
1293         settings.setDefaultFixedFontSize(nativePropertyValue.toInt());
1294     } else if (nativePropertyName == &quot;WebKitContextMenuEnabled&quot;) {
1295         settings.setContextMenuEnabled(nativePropertyValue.toInt());
1296     } else if (nativePropertyName == &quot;WebKitUserAgent&quot;) {
1297         settings.setUserAgent(nativePropertyValue);
1298     } else if (nativePropertyName == &quot;WebKitMaximumHTMLParserDOMTreeDepth&quot;) {
1299         settings.setMaximumHTMLParserDOMTreeDepth(nativePropertyValue.toUInt());
1300     } else if (nativePropertyName == &quot;WebKitXSSAuditorEnabled&quot;)  {
1301         settings.setXSSAuditorEnabled(nativePropertyValue.toInt());
1302     } else if (nativePropertyName == &quot;WebKitSerifFontFamily&quot;) {
1303         settings.setSerifFontFamily(nativePropertyValue);
1304     } else if (nativePropertyName == &quot;WebKitSansSerifFontFamily&quot;) {
1305         settings.setSansSerifFontFamily(nativePropertyValue);
1306     } else if (nativePropertyName == &quot;WebKitFixedFontFamily&quot;) {
1307         settings.setFixedFontFamily(nativePropertyValue);
1308     } else if (nativePropertyName == &quot;WebKitShowsURLsInToolTips&quot;) {
1309         settings.setShowsURLsInToolTips(nativePropertyValue.toInt());
<span class="line-removed">1310     } else if (nativePropertyName == &quot;WebKitUsesPageCachePreferenceKey&quot;) {</span>
<span class="line-removed">1311         settings.setUsesPageCache(nativePropertyValue.toInt() != 0);</span>
1312     } else if (nativePropertyName == &quot;WebKitJavaScriptCanAccessClipboardPreferenceKey&quot;) {
1313         settings.setJavaScriptCanAccessClipboard(nativePropertyValue.toInt() != 0);




1314     } else if (nativePropertyName == &quot;enableColorFilter&quot;) {
1315         settings.setColorFilterEnabled(nativePropertyValue == &quot;true&quot;);
1316     } else if (nativePropertyName == &quot;enableKeygenElement&quot;) {
1317         // removed from Chrome, Firefox, and the HTML specification in 2017.
1318         // https://trac.webkit.org/changeset/248960/webkit
1319         RuntimeEnabledFeatures::sharedFeatures().setKeygenElementEnabled(nativePropertyValue == &quot;true&quot;);
1320     } else if (nativePropertyName == &quot;experimental:WebAnimationsCSSIntegrationEnabled&quot;) {
1321         RuntimeEnabledFeatures::sharedFeatures().setWebAnimationsCSSIntegrationEnabled(nativePropertyValue == &quot;true&quot;);


1322     } else if (nativePropertyName == &quot;enableIntersectionObserver&quot;) {
1323 #if ENABLE(INTERSECTION_OBSERVER)
1324         RuntimeEnabledFeatures::sharedFeatures().setIntersectionObserverEnabled(nativePropertyValue == &quot;true&quot;);
1325 #endif
<span class="line-modified">1326     } else if(nativePropertyName == &quot;jscOptions&quot; &amp;&amp; !nativePropertyValue.isEmpty()) {</span>


1327         JSC::Options::setOptions(nativePropertyValue.utf8().data());
<span class="line-removed">1328     } else if(nativePropertyName == &quot;experimental:CSSCustomPropertiesAndValuesEnabled&quot;) {</span>
<span class="line-removed">1329         RuntimeEnabledFeatures::sharedFeatures().setCSSCustomPropertiesAndValuesEnabled(nativePropertyValue == &quot;true&quot;);</span>
1330     }
1331 }
1332 
1333 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkResetToConsistentStateBeforeTesting
1334     (JNIEnv* env, jobject self, jlong pPage)
1335 {
1336     Page* page = WebPage::pageFromJLong(pPage);
1337     if (!page) {
1338         return;
1339     }
1340 
1341     Settings&amp; settings = page-&gt;settings();
1342 
1343     settings.setAllowUniversalAccessFromFileURLs(true);
1344     settings.setAllowFileAccessFromFileURLs(true);
1345     // settings.setStandardFontFamily(standardFamily);
1346     // settings.setFixedFontFamily(fixedFamily);
1347     // settings.setSerifFontFamily(standardFamily);
1348     // settings.setSansSerifFontFamily(sansSerifFamily);
1349     // settings.setCursiveFontFamily(cursiveFamily);
1350     // settings.setFantasyFontFamily(fantasyFamily);
1351     // settings.setPictographFontFamily(pictographFamily);
1352     settings.setDefaultFontSize(16);
1353     settings.setDefaultFixedFontSize(13);
1354     settings.setMinimumFontSize(0);
1355     settings.setDefaultTextEncodingName(&quot;ISO-8859-1&quot;);
1356     settings.setJavaEnabled(false);
1357     settings.setFullScreenEnabled(true);
1358     settings.setScriptEnabled(true);
1359     settings.setEditableLinkBehavior(EditableLinkOnlyLiveWithShiftKey);
1360     // settings.setTabsToLinks(false);
1361     settings.setDOMPasteAllowed(true);
1362     settings.setShouldPrintBackgrounds(true);
1363     // settings.setCacheModel(WebCacheModelDocumentBrowser);
1364     settings.setXSSAuditorEnabled(false);
1365     settings.setExperimentalNotificationsEnabled(false);
1366     settings.setPluginsEnabled(true);
1367     settings.setTextAreasAreResizable(true);
<span class="line-modified">1368     settings.setUsesPageCache(false);</span>
1369     settings.setCSSOMViewScrollingAPIEnabled(true);

1370 
1371     // settings.setPrivateBrowsingEnabled(false);

1372     settings.setAuthorAndUserStylesEnabled(true);
1373     // Shrinks standalone images to fit: YES
1374     settings.setJavaScriptCanOpenWindowsAutomatically(true);
1375     settings.setJavaScriptCanAccessClipboard(true);
1376     settings.setOfflineWebApplicationCacheEnabled(true);
1377     // settings.setDeveloperExtrasEnabled(false);
1378     settings.setJavaScriptRuntimeFlags(JSC::RuntimeFlags(0));
1379     // Set JS experiments enabled: YES
1380     settings.setLoadsImagesAutomatically(true);
1381     settings.setLoadsSiteIconsIgnoringImageLoadingSetting(false);
1382     settings.setFrameFlattening(FrameFlattening::Disabled);
1383     settings.setFontRenderingMode(FontRenderingMode::Normal);
1384     // Doesn&#39;t work well with DRT
1385     settings.setScrollAnimatorEnabled(false);
1386     // Set spatial navigation enabled: NO
1387 
1388     // Set WebGL Enabled: NO
1389     // settings.setCSSRegionsEnabled(true);
1390     // Set uses HTML5 parser quirks: NO
1391     // Async spellcheck: NO
1392     DeprecatedGlobalSettings::setMockScrollbarsEnabled(true);
1393 
<span class="line-modified">1394 </span>
1395     RuntimeEnabledFeatures::sharedFeatures().setFetchAPIEnabled(true);
1396     RuntimeEnabledFeatures::sharedFeatures().setShadowDOMEnabled(true);
1397     RuntimeEnabledFeatures::sharedFeatures().setCustomElementsEnabled(true);
1398     RuntimeEnabledFeatures::sharedFeatures().setModernMediaControlsEnabled(false);
1399     RuntimeEnabledFeatures::sharedFeatures().setResourceTimingEnabled(true);
1400     RuntimeEnabledFeatures::sharedFeatures().setUserTimingEnabled(true);
1401     RuntimeEnabledFeatures::sharedFeatures().setDataTransferItemsEnabled(true);
1402     RuntimeEnabledFeatures::sharedFeatures().setInspectorAdditionsEnabled(true);
1403     RuntimeEnabledFeatures::sharedFeatures().setWebAnimationsEnabled(true);
1404     // RuntimeEnabledFeatures::sharedFeatures().clearNetworkLoaderSession();
1405 
1406     Frame&amp; coreFrame = page-&gt;mainFrame();
<span class="line-modified">1407     auto globalContext = toGlobalRef(coreFrame.script().globalObject(mainThreadNormalWorld())-&gt;globalExec());</span>
1408     WebCoreTestSupport::resetInternalsObject(globalContext);
1409 }
1410 
1411 JNIEXPORT jfloat JNICALL Java_com_sun_webkit_WebPage_twkGetZoomFactor
1412     (JNIEnv* env, jobject self, jlong pFrame, jboolean textOnly)
1413 {
1414     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1415     ASSERT(frame);
1416     if (!frame) {
1417         return 1.0;
1418     }
1419     return textOnly
1420         ? frame-&gt;textZoomFactor()
1421         : frame-&gt;pageZoomFactor();
1422 }
1423 
1424 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetZoomFactor
1425     (JNIEnv* env, jobject self, jlong pFrame, jfloat zoomFactor, jboolean textOnly)
1426 {
1427     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
</pre>
<hr />
<pre>
1620 {
1621     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1622     if (!frame || !frame-&gt;view()) {
1623         return;
1624     }
1625     frame-&gt;view()-&gt;setBaseBackgroundColor(Color(RGBA32(backgroundColor)));
1626 }
1627 
1628 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkPrePaint
1629   (JNIEnv*, jobject, jlong pPage)
1630 {
1631     WebPage::webPageFromJLong(pPage)-&gt;prePaint();
1632 }
1633 
1634 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkUpdateContent
1635     (JNIEnv* env, jobject self, jlong pPage, jobject rq, jint x, jint y, jint w, jint h)
1636 {
1637     WebPage::webPageFromJLong(pPage)-&gt;paint(rq, x, y, w, h);
1638 }
1639 






1640 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkPostPaint
1641   (JNIEnv*, jobject, jlong pPage, jobject rq, jint x, jint y, jint w, jint h)
1642 {
1643     WebPage::webPageFromJLong(pPage)-&gt;postPaint(rq, x, y, w, h);
1644 }
1645 
1646 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetEncoding
1647     (JNIEnv* env, jobject self, jlong pPage)
1648 {
1649     Page* p = WebPage::pageFromJLong(pPage);
1650     ASSERT(p);
1651     Frame* mainFrame = (Frame*)&amp;p-&gt;mainFrame();
1652     ASSERT(mainFrame);
1653 
1654     return mainFrame-&gt;document()-&gt;charset().toJavaString(env).releaseLocal();
1655 }
1656 
1657 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetEncoding
1658     (JNIEnv* env, jobject self, jlong pPage, jstring encoding)
1659 {
</pre>
<hr />
<pre>
1855         frame-&gt;editor().confirmComposition(committed);
1856     }
1857 
1858     // Process composed (composition) text here
1859     if (env-&gt;GetStringLength(jcomposed) &gt; 0) {
1860         jsize length = env-&gt;GetArrayLength(jattributes);
1861         Vector&lt;CompositionUnderline&gt; underlines;
1862         underlines.resize(length / 3); // 3 members per element
1863         jint* attrs = env-&gt;GetIntArrayElements(jattributes, nullptr);
1864         if (attrs) {
1865             for (int i = 0; i &lt; length;) {
1866                 int x = i / 3;
1867                 underlines[x].startOffset = attrs[i++];
1868                 underlines[x].endOffset = attrs[i++];
1869                 underlines[x].thick = (attrs[i++] == 1);
1870                 underlines[x].color = Color(0, 0, 0);
1871             }
1872             env-&gt;ReleaseIntArrayElements(jattributes, attrs, JNI_ABORT);
1873         }
1874         String composed = String(env, jcomposed);
<span class="line-modified">1875         frame-&gt;editor().setComposition(composed, underlines, caretPosition, 0);</span>
1876     }
1877     return JNI_TRUE;
1878 }
1879 
1880 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessCaretPositionChange
1881     (JNIEnv* env, jobject self, jlong pPage,
1882      jint caretPosition)
1883 {
1884     Page* page = WebPage::pageFromJLong(pPage);
1885 
1886     Frame* frame = (Frame*)&amp;page-&gt;focusController().focusedOrMainFrame();
1887 
1888     ASSERT(frame);
1889 
1890     Text* text = frame-&gt;editor().compositionNode();
1891     if (!text) {
1892         return JNI_FALSE;
1893     }
1894 
1895     // FIXME: the following code may not work with having committed text
</pre>
<hr />
<pre>
2260     Document* document = frame-&gt;document();
2261     if (!document || !document-&gt;isHTMLDocument()) {
2262         return 0;
2263     }
2264 
2265     HTMLElement* documentElement =
2266             static_cast&lt;HTMLElement*&gt;(document-&gt;documentElement());
2267     if (!documentElement) {
2268         return 0;
2269     }
2270 
2271     return documentElement-&gt;outerHTML().toJavaString(env).releaseLocal();
2272 }
2273 
2274 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkGetUsePageCache
2275     (JNIEnv*, jobject, jlong pPage)
2276 {
2277     ASSERT(pPage);
2278     Page* page = WebPage::pageFromJLong(pPage);
2279     ASSERT(page);
<span class="line-modified">2280     return bool_to_jbool(page-&gt;settings().usesPageCache());</span>
2281 }
2282 
2283 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetUsePageCache
2284     (JNIEnv*, jobject, jlong pPage, jboolean usePageCache)
2285 {
2286     ASSERT(pPage);
2287     Page* page = WebPage::pageFromJLong(pPage);
2288     ASSERT(page);
<span class="line-modified">2289     page-&gt;settings().setUsesPageCache(jbool_to_bool(usePageCache));</span>
2290 }
2291 
2292 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsJavaScriptEnabled
2293     (JNIEnv*, jobject, jlong pPage)
2294 {
2295     ASSERT(pPage);
2296     Page* page = WebPage::pageFromJLong(pPage);
2297     ASSERT(page);
2298     return bool_to_jbool(page-&gt;mainFrame().script().canExecuteScripts(NotAboutToExecuteScript));
2299 }
2300 
2301 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetJavaScriptEnabled
2302     (JNIEnv*, jobject, jlong pPage, jboolean enable)
2303 {
2304     ASSERT(pPage);
2305     Page* page = WebPage::pageFromJLong(pPage);
2306     ASSERT(page);
2307     page-&gt;settings().setScriptEnabled(jbool_to_bool(enable));
2308 }
2309 
</pre>
</td>
<td>
<hr />
<pre>
  40 #include &quot;InspectorClientJava.h&quot;
  41 #include &quot;PageStorageSessionProvider.h&quot;
  42 #include &quot;PlatformStrategiesJava.h&quot;
  43 #include &quot;ProgressTrackerClientJava.h&quot;
  44 #include &quot;VisitedLinkStoreJava.h&quot;
  45 #include &quot;WebKitLegacy/Storage/StorageNamespaceImpl.h&quot;
  46 #include &quot;WebKitLegacy/Storage/WebDatabaseProvider.h&quot;
  47 #include &quot;WebKitVersion.h&quot; //generated
  48 #include &quot;WebPageConfig.h&quot;
  49 #include &lt;WebCore/WebCoreTestSupport.h&gt;
  50 #include &lt;JavaScriptCore/APICast.h&gt;
  51 #include &lt;JavaScriptCore/InitializeThreading.h&gt;
  52 #include &lt;JavaScriptCore/JSContextRef.h&gt;
  53 #include &lt;JavaScriptCore/JSContextRefPrivate.h&gt;
  54 #include &lt;JavaScriptCore/JSStringRef.h&gt;
  55 #include &lt;JavaScriptCore/Options.h&gt;
  56 #include &lt;WebCore/BackForwardController.h&gt;
  57 #include &lt;WebCore/BridgeUtils.h&gt;
  58 #include &lt;WebCore/CharacterData.h&gt;
  59 #include &lt;WebCore/Chrome.h&gt;
<span class="line-added">  60 #include &lt;WebCore/CompositionHighlight.h&gt;</span>
  61 #include &lt;WebCore/ContextMenu.h&gt;
  62 #include &lt;WebCore/ContextMenuController.h&gt;
  63 #include &lt;WebCore/CookieJar.h&gt;
  64 #include &lt;WebCore/DeprecatedGlobalSettings.h&gt;
  65 #include &lt;WebCore/Document.h&gt;
  66 #include &lt;WebCore/DragController.h&gt;
  67 #include &lt;WebCore/DragData.h&gt;
  68 #include &lt;WebCore/Editor.h&gt;
  69 #include &lt;WebCore/EmptyClients.h&gt;
  70 #include &lt;WebCore/EventHandler.h&gt;
  71 #include &lt;WebCore/FloatRect.h&gt;
  72 #include &lt;WebCore/FloatSize.h&gt;
  73 #include &lt;WebCore/FocusController.h&gt;
  74 #include &lt;WebCore/Frame.h&gt;
  75 #include &lt;WebCore/FrameLoadRequest.h&gt;
  76 #include &lt;WebCore/FrameTree.h&gt;
  77 #include &lt;WebCore/FrameView.h&gt;
  78 #include &lt;WebCore/GCController.h&gt;
  79 #include &lt;WebCore/GeolocationClientMock.h&gt;
  80 #include &lt;WebCore/GraphicsContext.h&gt;
</pre>
<hr />
<pre>
 232         // Updating layout &amp; styles precedes normal painting.
 233         frameView-&gt;updateLayoutAndStyleIfNeededRecursive();
 234     }
 235 }
 236 
 237 RefPtr&lt;RQRef&gt; WebPage::jRenderTheme()
 238 {
 239     if (!m_jRenderTheme) {
 240         JNIEnv* env = WTF::GetJavaEnv();
 241         m_jRenderTheme = RQRef::create(PG_GetRenderThemeObjectFromPage(env, jobjectFromPage(m_page.get())));
 242     }
 243     return m_jRenderTheme;
 244 }
 245 
 246 void WebPage::paint(jobject rq, jint x, jint y, jint w, jint h)
 247 {
 248     if (m_rootLayer) {
 249         return;
 250     }
 251 
<span class="line-modified"> 252     // DBG_CHECKPOINTEX(&quot;twkUpdateContent&quot;, 15, 100);</span>
 253 
 254     RefPtr&lt;Frame&gt; mainFrame((Frame*)&amp;m_page-&gt;mainFrame());
 255     RefPtr&lt;FrameView&gt; frameView(mainFrame-&gt;view());
 256     if (!frameView) {
 257         return;
 258     }
 259 
 260     // Will be deleted by GraphicsContext destructor
 261     PlatformContextJava* ppgc = new PlatformContextJava(rq, jRenderTheme());
 262     GraphicsContext gc(ppgc);
 263 
 264     // TODO: Following JS synchronization is not necessary for single thread model
<span class="line-modified"> 265     JSGlobalContextRef globalContext = toGlobalRef(mainFrame-&gt;script().globalObject(mainThreadNormalWorld()));</span>
 266     JSC::JSLockHolder sw(toJS(globalContext)); // TODO-java: was JSC::APIEntryShim sw( toJS(globalContext) );
 267 
 268     frameView-&gt;paint(gc, IntRect(x, y, w, h));
 269     if (m_page-&gt;settings().showDebugBorders()) {
 270         drawDebugLed(gc, IntRect(x, y, w, h), Color(0, 0, 255, 128));
 271     }
 272 
 273     gc.platformContext()-&gt;rq().flushBuffer();
 274 }
 275 
 276 void WebPage::postPaint(jobject rq, jint x, jint y, jint w, jint h)
 277 {
 278     if (!m_page-&gt;inspectorController().highlightedNode()
 279             &amp;&amp; !m_rootLayer
 280     ) {
 281         return;
 282     }
 283 
 284     // Will be deleted by GraphicsContext destructor
 285     PlatformContextJava* ppgc = new PlatformContextJava(rq, jRenderTheme());
</pre>
<hr />
<pre>
 437     TransformationMatrix matrix;
 438     m_textureMapper-&gt;beginPainting();
 439     m_textureMapper-&gt;beginClip(matrix, clip);
 440     rootTextureMapperLayer.applyAnimationsRecursively(MonotonicTime::now());
 441     downcast&lt;GraphicsLayerTextureMapper&gt;(*m_rootLayer).updateBackingStoreIncludingSubLayers();
 442     rootTextureMapperLayer.paint();
 443     m_textureMapper-&gt;endClip();
 444     m_textureMapper-&gt;endPainting();
 445 }
 446 
 447 void WebPage::notifyAnimationStarted(const GraphicsLayer*, const String&amp; /*animationKey*/, MonotonicTime /*time*/)
 448 {
 449     ASSERT_NOT_REACHED();
 450 }
 451 
 452 void WebPage::notifyFlushRequired(const GraphicsLayer*)
 453 {
 454     markForSync();
 455 }
 456 
<span class="line-modified"> 457 void WebPage::paintContents(const GraphicsLayer*, GraphicsContext&amp; context, const FloatRect&amp; inClip, GraphicsLayerPaintBehavior)</span>




 458 {
 459     context.save();
 460     context.clip(inClip);
 461     m_page-&gt;mainFrame().view()-&gt;paint(context, enclosingIntRect(inClip));
 462     if (m_page-&gt;settings().showDebugBorders()) {
 463         drawDebugBorder(context, roundedIntRect(inClip), Color(0, 192, 0), 20);
 464     }
 465     context.restore();
 466 }
 467 
 468 bool WebPage::processKeyEvent(const PlatformKeyboardEvent&amp; event)
 469 {
 470     return event.type() == PlatformKeyboardEvent::Char
 471         ? charEvent(event)
 472         : keyEvent(event);
 473 }
 474 
 475 //
 476 // The below keyboard event handling code was adapted from
 477 // WebKit/chromium/src/WebViewImpl.cpp
</pre>
<hr />
<pre>
 850     //DBG_CHECKPOINTEX(&quot;twkCreatePage&quot;, 3, 5);
 851 
 852     VisitedLinkStoreJava::setShouldTrackVisitedLinks(true);
 853 
 854 #if !LOG_DISABLED
 855     WebKitInitializeLogChannelsIfNecessary();
 856 #endif
 857     WebCore::PlatformStrategiesJava::initialize();
 858 
 859     static std::once_flag initializeJSCOptions;
 860     std::call_once(initializeJSCOptions, [] {
 861         JSC::Options::useJIT() = s_useJIT;
 862         // Enable DFG only if JIT is enabled.
 863         JSC::Options::useDFGJIT() = s_useJIT &amp;&amp; s_useDFGJIT;
 864     });
 865 
 866     JLObject jlself(self, true);
 867 
 868     //utaTODO: history agent implementation
 869 
<span class="line-modified"> 870     auto pc = pageConfigurationWithEmptyClients(PAL::SessionID::defaultSessionID());</span>
 871     auto pageStorageSessionProvider = PageStorageSessionProvider::create();
 872     pc.cookieJar = CookieJar::create(pageStorageSessionProvider.copyRef());
 873     pc.chromeClient = new ChromeClientJava(jlself);
 874     pc.contextMenuClient = new ContextMenuClientJava(jlself);
 875     pc.editorClient = makeUniqueRef&lt;EditorClientJava&gt;(jlself);
<span class="line-modified"> 876     pc.dragClient = makeUnique&lt;DragClientJava&gt;(jlself);</span>
 877     pc.inspectorClient = new InspectorClientJava(jlself);
 878     pc.databaseProvider = &amp;WebDatabaseProvider::singleton();
 879     pc.storageNamespaceProvider = adoptRef(new WebStorageNamespaceProviderJava());
 880     pc.visitedLinkStore = VisitedLinkStoreJava::create();
 881 
 882     pc.loaderClientForMainFrame = new FrameLoaderClientJava(jlself);
<span class="line-modified"> 883     pc.progressTrackerClient = makeUniqueRef&lt;ProgressTrackerClientJava&gt;(jlself);</span>
 884 
 885     pc.backForwardClient = BackForwardList::create();
 886     auto page = std::make_unique&lt;Page&gt;(WTFMove(pc));
 887     // Associate PageSupplementJava instance which has WebPage java object.
 888     page-&gt;provideSupplement(PageSupplementJava::supplementName(), std::make_unique&lt;PageSupplementJava&gt;(self));
 889     pageStorageSessionProvider-&gt;setPage(*page);
 890 #if ENABLE(GEOLOCATION)
 891     WebCore::provideGeolocationTo(page.get(), *new GeolocationClientMock());
 892 #endif
 893     return ptr_to_jlong(new WebPage(WTFMove(page)));
 894 }
 895 
 896 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkInit
 897     (JNIEnv* env, jobject self, jlong pPage, jboolean usePlugins, jfloat devicePixelScale)
 898 {
 899     Page* page = WebPage::pageFromJLong(pPage);
 900 
 901     /* Initialization of the default settings */
 902     Settings&amp; settings = page-&gt;settings();
 903     settings.setTextAreasAreResizable(true);
</pre>
<hr />
<pre>
1094     if (!frame) {
1095         return 0;
1096     }
1097 #if ENABLE(ICONDATABASE)
1098     return frame-&gt;loader()-&gt;icon()-&gt;url().string().toJavaString(env).releaseLocal();
1099 #else
1100     return 0;
1101 #endif
1102 }
1103 
1104 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkOpen
1105     (JNIEnv* env, jobject self, jlong pFrame, jstring url)
1106 {
1107     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1108     if (!frame) {
1109         return;
1110     }
1111 
1112     static const URL emptyParent;
1113 
<span class="line-modified">1114     FrameLoadRequest frameLoadRequest(</span>
1115         *frame,
1116         ResourceRequest(URL(emptyParent, String(env, url))),
1117         ShouldOpenExternalURLsPolicy::ShouldNotAllow // TODO-java: recheck policy value
<span class="line-modified">1118     );</span>
<span class="line-added">1119     frameLoadRequest.setIsRequestFromClientOrUserInput();</span>
<span class="line-added">1120     frame-&gt;loader().load(WTFMove(frameLoadRequest));</span>
1121 }
1122 
1123 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkLoad
1124     (JNIEnv* env, jobject self, jlong pFrame, jstring text, jstring contentType)
1125 {
1126     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1127     if (!frame) {
1128         return;
1129     }
1130 
1131     const char* stringChars = env-&gt;GetStringUTFChars(text, JNI_FALSE);
1132     size_t stringLen = (size_t)env-&gt;GetStringUTFLength(text);
1133     RefPtr&lt;SharedBuffer&gt; buffer = SharedBuffer::create(stringChars, (int)stringLen);
1134 
1135     static const URL emptyUrl({ }, &quot;&quot;);
1136     ResourceResponse response(URL(), String(env, contentType), stringLen, &quot;UTF-8&quot;);
<span class="line-modified">1137     FrameLoadRequest frameLoadRequest(</span>
1138         *frame,
1139         ResourceRequest(emptyUrl),
1140         ShouldOpenExternalURLsPolicy::ShouldNotAllow, // TODO-java: recheck policy value
1141         SubstituteData(
1142             WTFMove(buffer),
1143             URL(),
1144             response,
1145             SubstituteData::SessionHistoryVisibility::Visible) // TODO-java: or Hidden?
<span class="line-modified">1146     );</span>
<span class="line-added">1147     frameLoadRequest.setIsRequestFromClientOrUserInput();</span>
<span class="line-added">1148     frame-&gt;loader().load(WTFMove(frameLoadRequest));</span>
1149 
1150     env-&gt;ReleaseStringUTFChars(text, stringChars);
1151 }
1152 
1153 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsLoading
1154     (JNIEnv* env, jobject self, jlong pFrame)
1155 {
1156     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1157 
1158     return bool_to_jbool(frame &amp;&amp; frame-&gt;loader().isLoading());
1159 }
1160 
1161 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkStop
1162     (JNIEnv* env, jobject self, jlong pFrame)
1163 {
1164     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1165     if (!frame) {
1166         return;
1167     }
1168 
</pre>
<hr />
<pre>
1291     } else if (nativePropertyName == &quot;WebKitPluginsEnabled&quot;) {
1292         settings.setPluginsEnabled(nativePropertyValue.toInt());
1293     } else if (nativePropertyName == &quot;WebKitDefaultFixedFontSize&quot;) {
1294         settings.setDefaultFixedFontSize(nativePropertyValue.toInt());
1295     } else if (nativePropertyName == &quot;WebKitContextMenuEnabled&quot;) {
1296         settings.setContextMenuEnabled(nativePropertyValue.toInt());
1297     } else if (nativePropertyName == &quot;WebKitUserAgent&quot;) {
1298         settings.setUserAgent(nativePropertyValue);
1299     } else if (nativePropertyName == &quot;WebKitMaximumHTMLParserDOMTreeDepth&quot;) {
1300         settings.setMaximumHTMLParserDOMTreeDepth(nativePropertyValue.toUInt());
1301     } else if (nativePropertyName == &quot;WebKitXSSAuditorEnabled&quot;)  {
1302         settings.setXSSAuditorEnabled(nativePropertyValue.toInt());
1303     } else if (nativePropertyName == &quot;WebKitSerifFontFamily&quot;) {
1304         settings.setSerifFontFamily(nativePropertyValue);
1305     } else if (nativePropertyName == &quot;WebKitSansSerifFontFamily&quot;) {
1306         settings.setSansSerifFontFamily(nativePropertyValue);
1307     } else if (nativePropertyName == &quot;WebKitFixedFontFamily&quot;) {
1308         settings.setFixedFontFamily(nativePropertyValue);
1309     } else if (nativePropertyName == &quot;WebKitShowsURLsInToolTips&quot;) {
1310         settings.setShowsURLsInToolTips(nativePropertyValue.toInt());


1311     } else if (nativePropertyName == &quot;WebKitJavaScriptCanAccessClipboardPreferenceKey&quot;) {
1312         settings.setJavaScriptCanAccessClipboard(nativePropertyValue.toInt() != 0);
<span class="line-added">1313     } else if (nativePropertyName == &quot;allowTopNavigationToDataURLs&quot;) {</span>
<span class="line-added">1314         settings.setAllowTopNavigationToDataURLs(nativePropertyValue == &quot;true&quot;);</span>
<span class="line-added">1315     } else if (nativePropertyName == &quot;enableBackForwardCache&quot;) {</span>
<span class="line-added">1316         settings.setUsesBackForwardCache(nativePropertyValue == &quot;true&quot;);</span>
1317     } else if (nativePropertyName == &quot;enableColorFilter&quot;) {
1318         settings.setColorFilterEnabled(nativePropertyValue == &quot;true&quot;);
1319     } else if (nativePropertyName == &quot;enableKeygenElement&quot;) {
1320         // removed from Chrome, Firefox, and the HTML specification in 2017.
1321         // https://trac.webkit.org/changeset/248960/webkit
1322         RuntimeEnabledFeatures::sharedFeatures().setKeygenElementEnabled(nativePropertyValue == &quot;true&quot;);
1323     } else if (nativePropertyName == &quot;experimental:WebAnimationsCSSIntegrationEnabled&quot;) {
1324         RuntimeEnabledFeatures::sharedFeatures().setWebAnimationsCSSIntegrationEnabled(nativePropertyValue == &quot;true&quot;);
<span class="line-added">1325     } else if (nativePropertyName == &quot;experimental:CSSCustomPropertiesAndValuesEnabled&quot;) {</span>
<span class="line-added">1326         RuntimeEnabledFeatures::sharedFeatures().setCSSCustomPropertiesAndValuesEnabled(nativePropertyValue == &quot;true&quot;);</span>
1327     } else if (nativePropertyName == &quot;enableIntersectionObserver&quot;) {
1328 #if ENABLE(INTERSECTION_OBSERVER)
1329         RuntimeEnabledFeatures::sharedFeatures().setIntersectionObserverEnabled(nativePropertyValue == &quot;true&quot;);
1330 #endif
<span class="line-modified">1331     } else if (nativePropertyName == &quot;experimental:RequestIdleCallbackEnabled&quot;) {</span>
<span class="line-added">1332         settings.setRequestIdleCallbackEnabled(nativePropertyValue == &quot;true&quot;);</span>
<span class="line-added">1333     } else if (nativePropertyName == &quot;jscOptions&quot; &amp;&amp; !nativePropertyValue.isEmpty()) {</span>
1334         JSC::Options::setOptions(nativePropertyValue.utf8().data());


1335     }
1336 }
1337 
1338 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkResetToConsistentStateBeforeTesting
1339     (JNIEnv* env, jobject self, jlong pPage)
1340 {
1341     Page* page = WebPage::pageFromJLong(pPage);
1342     if (!page) {
1343         return;
1344     }
1345 
1346     Settings&amp; settings = page-&gt;settings();
1347 
1348     settings.setAllowUniversalAccessFromFileURLs(true);
1349     settings.setAllowFileAccessFromFileURLs(true);
1350     // settings.setStandardFontFamily(standardFamily);
1351     // settings.setFixedFontFamily(fixedFamily);
1352     // settings.setSerifFontFamily(standardFamily);
1353     // settings.setSansSerifFontFamily(sansSerifFamily);
1354     // settings.setCursiveFontFamily(cursiveFamily);
1355     // settings.setFantasyFontFamily(fantasyFamily);
1356     // settings.setPictographFontFamily(pictographFamily);
1357     settings.setDefaultFontSize(16);
1358     settings.setDefaultFixedFontSize(13);
1359     settings.setMinimumFontSize(0);
1360     settings.setDefaultTextEncodingName(&quot;ISO-8859-1&quot;);
1361     settings.setJavaEnabled(false);
1362     settings.setFullScreenEnabled(true);
1363     settings.setScriptEnabled(true);
1364     settings.setEditableLinkBehavior(EditableLinkOnlyLiveWithShiftKey);
1365     // settings.setTabsToLinks(false);
1366     settings.setDOMPasteAllowed(true);
1367     settings.setShouldPrintBackgrounds(true);
1368     // settings.setCacheModel(WebCacheModelDocumentBrowser);
1369     settings.setXSSAuditorEnabled(false);
1370     settings.setExperimentalNotificationsEnabled(false);
1371     settings.setPluginsEnabled(true);
1372     settings.setTextAreasAreResizable(true);
<span class="line-modified">1373     settings.setUsesBackForwardCache(false);</span>
1374     settings.setCSSOMViewScrollingAPIEnabled(true);
<span class="line-added">1375     settings.setRequestIdleCallbackEnabled(true);</span>
1376 
1377     // settings.setPrivateBrowsingEnabled(false);
<span class="line-added">1378     settings.setAllowTopNavigationToDataURLs(true);</span>
1379     settings.setAuthorAndUserStylesEnabled(true);
1380     // Shrinks standalone images to fit: YES
1381     settings.setJavaScriptCanOpenWindowsAutomatically(true);
1382     settings.setJavaScriptCanAccessClipboard(true);
1383     settings.setOfflineWebApplicationCacheEnabled(true);
1384     // settings.setDeveloperExtrasEnabled(false);
1385     settings.setJavaScriptRuntimeFlags(JSC::RuntimeFlags(0));
1386     // Set JS experiments enabled: YES
1387     settings.setLoadsImagesAutomatically(true);
1388     settings.setLoadsSiteIconsIgnoringImageLoadingSetting(false);
1389     settings.setFrameFlattening(FrameFlattening::Disabled);
1390     settings.setFontRenderingMode(FontRenderingMode::Normal);
1391     // Doesn&#39;t work well with DRT
1392     settings.setScrollAnimatorEnabled(false);
1393     // Set spatial navigation enabled: NO
1394 
1395     // Set WebGL Enabled: NO
1396     // settings.setCSSRegionsEnabled(true);
1397     // Set uses HTML5 parser quirks: NO
1398     // Async spellcheck: NO
1399     DeprecatedGlobalSettings::setMockScrollbarsEnabled(true);
1400 
<span class="line-modified">1401     RuntimeEnabledFeatures::sharedFeatures().setHighlightAPIEnabled(true);</span>
1402     RuntimeEnabledFeatures::sharedFeatures().setFetchAPIEnabled(true);
1403     RuntimeEnabledFeatures::sharedFeatures().setShadowDOMEnabled(true);
1404     RuntimeEnabledFeatures::sharedFeatures().setCustomElementsEnabled(true);
1405     RuntimeEnabledFeatures::sharedFeatures().setModernMediaControlsEnabled(false);
1406     RuntimeEnabledFeatures::sharedFeatures().setResourceTimingEnabled(true);
1407     RuntimeEnabledFeatures::sharedFeatures().setUserTimingEnabled(true);
1408     RuntimeEnabledFeatures::sharedFeatures().setDataTransferItemsEnabled(true);
1409     RuntimeEnabledFeatures::sharedFeatures().setInspectorAdditionsEnabled(true);
1410     RuntimeEnabledFeatures::sharedFeatures().setWebAnimationsEnabled(true);
1411     // RuntimeEnabledFeatures::sharedFeatures().clearNetworkLoaderSession();
1412 
1413     Frame&amp; coreFrame = page-&gt;mainFrame();
<span class="line-modified">1414     auto globalContext = toGlobalRef(coreFrame.script().globalObject(mainThreadNormalWorld()));</span>
1415     WebCoreTestSupport::resetInternalsObject(globalContext);
1416 }
1417 
1418 JNIEXPORT jfloat JNICALL Java_com_sun_webkit_WebPage_twkGetZoomFactor
1419     (JNIEnv* env, jobject self, jlong pFrame, jboolean textOnly)
1420 {
1421     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1422     ASSERT(frame);
1423     if (!frame) {
1424         return 1.0;
1425     }
1426     return textOnly
1427         ? frame-&gt;textZoomFactor()
1428         : frame-&gt;pageZoomFactor();
1429 }
1430 
1431 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetZoomFactor
1432     (JNIEnv* env, jobject self, jlong pFrame, jfloat zoomFactor, jboolean textOnly)
1433 {
1434     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
</pre>
<hr />
<pre>
1627 {
1628     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1629     if (!frame || !frame-&gt;view()) {
1630         return;
1631     }
1632     frame-&gt;view()-&gt;setBaseBackgroundColor(Color(RGBA32(backgroundColor)));
1633 }
1634 
1635 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkPrePaint
1636   (JNIEnv*, jobject, jlong pPage)
1637 {
1638     WebPage::webPageFromJLong(pPage)-&gt;prePaint();
1639 }
1640 
1641 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkUpdateContent
1642     (JNIEnv* env, jobject self, jlong pPage, jobject rq, jint x, jint y, jint w, jint h)
1643 {
1644     WebPage::webPageFromJLong(pPage)-&gt;paint(rq, x, y, w, h);
1645 }
1646 
<span class="line-added">1647 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkUpdateRendering</span>
<span class="line-added">1648     (JNIEnv*, jobject, jlong pPage)</span>
<span class="line-added">1649 {</span>
<span class="line-added">1650     WebPage::pageFromJLong(pPage)-&gt;updateRendering();</span>
<span class="line-added">1651 }</span>
<span class="line-added">1652 </span>
1653 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkPostPaint
1654   (JNIEnv*, jobject, jlong pPage, jobject rq, jint x, jint y, jint w, jint h)
1655 {
1656     WebPage::webPageFromJLong(pPage)-&gt;postPaint(rq, x, y, w, h);
1657 }
1658 
1659 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetEncoding
1660     (JNIEnv* env, jobject self, jlong pPage)
1661 {
1662     Page* p = WebPage::pageFromJLong(pPage);
1663     ASSERT(p);
1664     Frame* mainFrame = (Frame*)&amp;p-&gt;mainFrame();
1665     ASSERT(mainFrame);
1666 
1667     return mainFrame-&gt;document()-&gt;charset().toJavaString(env).releaseLocal();
1668 }
1669 
1670 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetEncoding
1671     (JNIEnv* env, jobject self, jlong pPage, jstring encoding)
1672 {
</pre>
<hr />
<pre>
1868         frame-&gt;editor().confirmComposition(committed);
1869     }
1870 
1871     // Process composed (composition) text here
1872     if (env-&gt;GetStringLength(jcomposed) &gt; 0) {
1873         jsize length = env-&gt;GetArrayLength(jattributes);
1874         Vector&lt;CompositionUnderline&gt; underlines;
1875         underlines.resize(length / 3); // 3 members per element
1876         jint* attrs = env-&gt;GetIntArrayElements(jattributes, nullptr);
1877         if (attrs) {
1878             for (int i = 0; i &lt; length;) {
1879                 int x = i / 3;
1880                 underlines[x].startOffset = attrs[i++];
1881                 underlines[x].endOffset = attrs[i++];
1882                 underlines[x].thick = (attrs[i++] == 1);
1883                 underlines[x].color = Color(0, 0, 0);
1884             }
1885             env-&gt;ReleaseIntArrayElements(jattributes, attrs, JNI_ABORT);
1886         }
1887         String composed = String(env, jcomposed);
<span class="line-modified">1888         frame-&gt;editor().setComposition(composed, underlines, { }, caretPosition, 0);</span>
1889     }
1890     return JNI_TRUE;
1891 }
1892 
1893 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessCaretPositionChange
1894     (JNIEnv* env, jobject self, jlong pPage,
1895      jint caretPosition)
1896 {
1897     Page* page = WebPage::pageFromJLong(pPage);
1898 
1899     Frame* frame = (Frame*)&amp;page-&gt;focusController().focusedOrMainFrame();
1900 
1901     ASSERT(frame);
1902 
1903     Text* text = frame-&gt;editor().compositionNode();
1904     if (!text) {
1905         return JNI_FALSE;
1906     }
1907 
1908     // FIXME: the following code may not work with having committed text
</pre>
<hr />
<pre>
2273     Document* document = frame-&gt;document();
2274     if (!document || !document-&gt;isHTMLDocument()) {
2275         return 0;
2276     }
2277 
2278     HTMLElement* documentElement =
2279             static_cast&lt;HTMLElement*&gt;(document-&gt;documentElement());
2280     if (!documentElement) {
2281         return 0;
2282     }
2283 
2284     return documentElement-&gt;outerHTML().toJavaString(env).releaseLocal();
2285 }
2286 
2287 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkGetUsePageCache
2288     (JNIEnv*, jobject, jlong pPage)
2289 {
2290     ASSERT(pPage);
2291     Page* page = WebPage::pageFromJLong(pPage);
2292     ASSERT(page);
<span class="line-modified">2293     return bool_to_jbool(page-&gt;settings().usesBackForwardCache());</span>
2294 }
2295 
2296 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetUsePageCache
2297     (JNIEnv*, jobject, jlong pPage, jboolean usePageCache)
2298 {
2299     ASSERT(pPage);
2300     Page* page = WebPage::pageFromJLong(pPage);
2301     ASSERT(page);
<span class="line-modified">2302     page-&gt;settings().setUsesBackForwardCache(jbool_to_bool(usePageCache));</span>
2303 }
2304 
2305 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsJavaScriptEnabled
2306     (JNIEnv*, jobject, jlong pPage)
2307 {
2308     ASSERT(pPage);
2309     Page* page = WebPage::pageFromJLong(pPage);
2310     ASSERT(page);
2311     return bool_to_jbool(page-&gt;mainFrame().script().canExecuteScripts(NotAboutToExecuteScript));
2312 }
2313 
2314 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetJavaScriptEnabled
2315     (JNIEnv*, jobject, jlong pPage, jboolean enable)
2316 {
2317     ASSERT(pPage);
2318     Page* page = WebPage::pageFromJLong(pPage);
2319     ASSERT(page);
2320     page-&gt;settings().setScriptEnabled(jbool_to_bool(enable));
2321 }
2322 
</pre>
</td>
</tr>
</table>
<center><a href="VisitedLinkStoreJava.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebPage.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>