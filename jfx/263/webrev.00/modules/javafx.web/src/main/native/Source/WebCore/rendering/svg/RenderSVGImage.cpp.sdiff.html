<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/rendering/svg/RenderSVGImage.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="RenderSVGEllipse.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RenderSVGImage.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/rendering/svg/RenderSVGImage.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 51     , m_needsBoundariesUpdate(true)
 52     , m_needsTransformUpdate(true)
 53     , m_imageResource(makeUnique&lt;RenderImageResource&gt;())
 54 {
 55     imageResource().initialize(*this);
 56 }
 57 
 58 RenderSVGImage::~RenderSVGImage() = default;
 59 
 60 void RenderSVGImage::willBeDestroyed()
 61 {
 62     imageResource().shutdown();
 63     RenderSVGModelObject::willBeDestroyed();
 64 }
 65 
 66 SVGImageElement&amp; RenderSVGImage::imageElement() const
 67 {
 68     return downcast&lt;SVGImageElement&gt;(RenderSVGModelObject::element());
 69 }
 70 
<span class="line-modified"> 71 bool RenderSVGImage::updateImageViewport()</span>
 72 {
<span class="line-modified"> 73     FloatRect oldBoundaries = m_objectBoundingBox;</span>
<span class="line-modified"> 74     bool updatedViewport = false;</span>

 75 
 76     SVGLengthContext lengthContext(&amp;imageElement());
<span class="line-removed"> 77     m_objectBoundingBox = FloatRect(imageElement().x().value(lengthContext), imageElement().y().value(lengthContext), imageElement().width().value(lengthContext), imageElement().height().value(lengthContext));</span>
 78 




























 79     URL imageSourceURL = document().completeURL(imageElement().imageSourceURL());
 80 
 81     // Images with preserveAspectRatio=none should force non-uniform scaling. This can be achieved
 82     // by setting the image&#39;s container size to its intrinsic size.
 83     // See: http://www.w3.org/TR/SVG/single-page.html, 7.8 The ‘preserveAspectRatio’ attribute.
 84     if (imageElement().preserveAspectRatio().align() == SVGPreserveAspectRatioValue::SVG_PRESERVEASPECTRATIO_NONE) {
 85         if (CachedImage* cachedImage = imageResource().cachedImage()) {
 86             LayoutSize intrinsicSize = cachedImage-&gt;imageSizeForRenderer(nullptr, style().effectiveZoom());
 87             if (intrinsicSize != imageResource().imageSize(style().effectiveZoom())) {
 88                 imageResource().setContainerContext(roundedIntSize(intrinsicSize), imageSourceURL);
 89                 updatedViewport = true;
 90             }
 91         }
 92     }
 93 
 94     if (oldBoundaries != m_objectBoundingBox) {
 95         if (!updatedViewport)
 96             imageResource().setContainerContext(enclosingIntRect(m_objectBoundingBox).size(), imageSourceURL);
 97         updatedViewport = true;
 98         m_needsBoundariesUpdate = true;
</pre>
<hr />
<pre>
206             }
207         }
208     }
209 
210     return false;
211 }
212 
213 void RenderSVGImage::imageChanged(WrappedImagePtr, const IntRect*)
214 {
215     // The image resource defaults to nullImage until the resource arrives.
216     // This empty image may be cached by SVG resources which must be invalidated.
217     if (auto* resources = SVGResourcesCache::cachedResourcesForRenderer(*this))
218         resources-&gt;removeClientFromCache(*this);
219 
220     // Eventually notify parent resources, that we&#39;ve changed.
221     RenderSVGResource::markForLayoutAndParentResourceInvalidation(*this, false);
222 
223     // Update the SVGImageCache sizeAndScales entry in case image loading finished after layout.
224     // (https://bugs.webkit.org/show_bug.cgi?id=99489)
225     m_objectBoundingBox = FloatRect();
<span class="line-modified">226     updateImageViewport();</span>

227 
228     invalidateBufferedForeground();
229 
230     repaint();
231 }
232 
233 void RenderSVGImage::addFocusRingRects(Vector&lt;LayoutRect&gt;&amp; rects, const LayoutPoint&amp;, const RenderLayerModelObject*)
234 {
235     // this is called from paint() after the localTransform has already been applied
236     LayoutRect contentRect = LayoutRect(repaintRectInLocalCoordinates());
237     if (!contentRect.isEmpty())
238         rects.append(contentRect);
239 }
240 
241 } // namespace WebCore
</pre>
</td>
<td>
<hr />
<pre>
 51     , m_needsBoundariesUpdate(true)
 52     , m_needsTransformUpdate(true)
 53     , m_imageResource(makeUnique&lt;RenderImageResource&gt;())
 54 {
 55     imageResource().initialize(*this);
 56 }
 57 
 58 RenderSVGImage::~RenderSVGImage() = default;
 59 
 60 void RenderSVGImage::willBeDestroyed()
 61 {
 62     imageResource().shutdown();
 63     RenderSVGModelObject::willBeDestroyed();
 64 }
 65 
 66 SVGImageElement&amp; RenderSVGImage::imageElement() const
 67 {
 68     return downcast&lt;SVGImageElement&gt;(RenderSVGModelObject::element());
 69 }
 70 
<span class="line-modified"> 71 FloatRect RenderSVGImage::calculateObjectBoundingBox() const</span>
 72 {
<span class="line-modified"> 73     LayoutSize intrinsicSize;</span>
<span class="line-modified"> 74     if (CachedImage* cachedImage = imageResource().cachedImage())</span>
<span class="line-added"> 75         intrinsicSize = cachedImage-&gt;imageSizeForRenderer(nullptr, style().effectiveZoom());</span>
 76 
 77     SVGLengthContext lengthContext(&amp;imageElement());

 78 
<span class="line-added"> 79     Length width = style().width();</span>
<span class="line-added"> 80     Length height = style().height();</span>
<span class="line-added"> 81 </span>
<span class="line-added"> 82     float concreteWidth;</span>
<span class="line-added"> 83     if (!width.isAuto())</span>
<span class="line-added"> 84         concreteWidth = lengthContext.valueForLength(width, SVGLengthMode::Width);</span>
<span class="line-added"> 85     else if (!height.isAuto() &amp;&amp; !intrinsicSize.isEmpty())</span>
<span class="line-added"> 86         concreteWidth = lengthContext.valueForLength(height, SVGLengthMode::Height) * intrinsicSize.width() / intrinsicSize.height();</span>
<span class="line-added"> 87     else</span>
<span class="line-added"> 88         concreteWidth = intrinsicSize.width();</span>
<span class="line-added"> 89 </span>
<span class="line-added"> 90     float concreteHeight;</span>
<span class="line-added"> 91     if (!height.isAuto())</span>
<span class="line-added"> 92         concreteHeight = lengthContext.valueForLength(height, SVGLengthMode::Height);</span>
<span class="line-added"> 93     else if (!width.isAuto() &amp;&amp; !intrinsicSize.isEmpty())</span>
<span class="line-added"> 94         concreteHeight = lengthContext.valueForLength(width, SVGLengthMode::Width) * intrinsicSize.height() / intrinsicSize.width();</span>
<span class="line-added"> 95     else</span>
<span class="line-added"> 96         concreteHeight = intrinsicSize.height();</span>
<span class="line-added"> 97 </span>
<span class="line-added"> 98     return { imageElement().x().value(lengthContext), imageElement().y().value(lengthContext), concreteWidth, concreteHeight };</span>
<span class="line-added"> 99 }</span>
<span class="line-added">100 </span>
<span class="line-added">101 bool RenderSVGImage::updateImageViewport()</span>
<span class="line-added">102 {</span>
<span class="line-added">103     FloatRect oldBoundaries = m_objectBoundingBox;</span>
<span class="line-added">104     m_objectBoundingBox = calculateObjectBoundingBox();</span>
<span class="line-added">105 </span>
<span class="line-added">106     bool updatedViewport = false;</span>
107     URL imageSourceURL = document().completeURL(imageElement().imageSourceURL());
108 
109     // Images with preserveAspectRatio=none should force non-uniform scaling. This can be achieved
110     // by setting the image&#39;s container size to its intrinsic size.
111     // See: http://www.w3.org/TR/SVG/single-page.html, 7.8 The ‘preserveAspectRatio’ attribute.
112     if (imageElement().preserveAspectRatio().align() == SVGPreserveAspectRatioValue::SVG_PRESERVEASPECTRATIO_NONE) {
113         if (CachedImage* cachedImage = imageResource().cachedImage()) {
114             LayoutSize intrinsicSize = cachedImage-&gt;imageSizeForRenderer(nullptr, style().effectiveZoom());
115             if (intrinsicSize != imageResource().imageSize(style().effectiveZoom())) {
116                 imageResource().setContainerContext(roundedIntSize(intrinsicSize), imageSourceURL);
117                 updatedViewport = true;
118             }
119         }
120     }
121 
122     if (oldBoundaries != m_objectBoundingBox) {
123         if (!updatedViewport)
124             imageResource().setContainerContext(enclosingIntRect(m_objectBoundingBox).size(), imageSourceURL);
125         updatedViewport = true;
126         m_needsBoundariesUpdate = true;
</pre>
<hr />
<pre>
234             }
235         }
236     }
237 
238     return false;
239 }
240 
241 void RenderSVGImage::imageChanged(WrappedImagePtr, const IntRect*)
242 {
243     // The image resource defaults to nullImage until the resource arrives.
244     // This empty image may be cached by SVG resources which must be invalidated.
245     if (auto* resources = SVGResourcesCache::cachedResourcesForRenderer(*this))
246         resources-&gt;removeClientFromCache(*this);
247 
248     // Eventually notify parent resources, that we&#39;ve changed.
249     RenderSVGResource::markForLayoutAndParentResourceInvalidation(*this, false);
250 
251     // Update the SVGImageCache sizeAndScales entry in case image loading finished after layout.
252     // (https://bugs.webkit.org/show_bug.cgi?id=99489)
253     m_objectBoundingBox = FloatRect();
<span class="line-modified">254     if (updateImageViewport())</span>
<span class="line-added">255         setNeedsLayout();</span>
256 
257     invalidateBufferedForeground();
258 
259     repaint();
260 }
261 
262 void RenderSVGImage::addFocusRingRects(Vector&lt;LayoutRect&gt;&amp; rects, const LayoutPoint&amp;, const RenderLayerModelObject*)
263 {
264     // this is called from paint() after the localTransform has already been applied
265     LayoutRect contentRect = LayoutRect(repaintRectInLocalCoordinates());
266     if (!contentRect.isEmpty())
267         rects.append(contentRect);
268 }
269 
270 } // namespace WebCore
</pre>
</td>
</tr>
</table>
<center><a href="RenderSVGEllipse.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RenderSVGImage.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>