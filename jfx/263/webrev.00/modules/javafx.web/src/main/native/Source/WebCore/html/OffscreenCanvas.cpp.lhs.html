<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/html/OffscreenCanvas.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2017 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;OffscreenCanvas.h&quot;
 28 
<a name="1" id="anc1"></a>


 29 #include &quot;CanvasRenderingContext.h&quot;
 30 #include &quot;ImageBitmap.h&quot;
<a name="2" id="anc2"></a>



 31 #include &quot;WebGLRenderingContext.h&quot;
<a name="3" id="anc3"></a>
 32 #include &lt;wtf/IsoMallocInlines.h&gt;
 33 
 34 namespace WebCore {
 35 
 36 WTF_MAKE_ISO_ALLOCATED_IMPL(OffscreenCanvas);
 37 
<a name="4" id="anc4"></a>











 38 Ref&lt;OffscreenCanvas&gt; OffscreenCanvas::create(ScriptExecutionContext&amp; context, unsigned width, unsigned height)
 39 {
 40     return adoptRef(*new OffscreenCanvas(context, width, height));
 41 }
 42 
<a name="5" id="anc5"></a>









 43 OffscreenCanvas::OffscreenCanvas(ScriptExecutionContext&amp; context, unsigned width, unsigned height)
<a name="6" id="anc6"></a><span class="line-modified"> 44     : ContextDestructionObserver(&amp;context)</span>
<span class="line-modified"> 45     , m_size(width, height)</span>
 46 {
 47 }
 48 
 49 OffscreenCanvas::~OffscreenCanvas()
 50 {
 51     notifyObserversCanvasDestroyed();
 52 
<a name="7" id="anc7"></a><span class="line-modified"> 53     m_context = nullptr;</span>

 54 }
 55 
 56 unsigned OffscreenCanvas::width() const
 57 {
<a name="8" id="anc8"></a><span class="line-modified"> 58     return m_size.width();</span>
<span class="line-modified"> 59 }</span>
<span class="line-modified"> 60 </span>
<span class="line-removed"> 61 void OffscreenCanvas::setWidth(unsigned newWidth)</span>
<span class="line-removed"> 62 {</span>
<span class="line-removed"> 63     return m_size.setWidth(newWidth);</span>
 64 }
 65 
 66 unsigned OffscreenCanvas::height() const
 67 {
<a name="9" id="anc9"></a><span class="line-modified"> 68     return m_size.height();</span>


 69 }
 70 
<a name="10" id="anc10"></a><span class="line-modified"> 71 void OffscreenCanvas::setHeight(unsigned newHeight)</span>
 72 {
<a name="11" id="anc11"></a><span class="line-modified"> 73     return m_size.setHeight(newHeight);</span>


 74 }
 75 
<a name="12" id="anc12"></a><span class="line-modified"> 76 const IntSize&amp; OffscreenCanvas::size() const</span>
 77 {
<a name="13" id="anc13"></a><span class="line-modified"> 78     return m_size;</span>


 79 }
 80 
 81 void OffscreenCanvas::setSize(const IntSize&amp; newSize)
 82 {
<a name="14" id="anc14"></a><span class="line-modified"> 83     m_size = newSize;</span>

 84 }
 85 
<a name="15" id="anc15"></a><span class="line-modified"> 86 #if ENABLE(WEBGL)</span>
<span class="line-removed"> 87 ExceptionOr&lt;OffscreenRenderingContext&gt; OffscreenCanvas::getContext(JSC::ExecState&amp; state, RenderingContextType contextType, Vector&lt;JSC::Strong&lt;JSC::Unknown&gt;&gt;&amp;&amp; arguments)</span>
 88 {
<a name="16" id="anc16"></a><span class="line-modified"> 89     if (m_context &amp;&amp; contextType == RenderingContextType::Webgl)</span>
<span class="line-modified"> 90         return { RefPtr&lt;WebGLRenderingContext&gt; { &amp;downcast&lt;WebGLRenderingContext&gt;(*m_context) } };</span>











 91 
<a name="17" id="anc17"></a>


 92     if (contextType == RenderingContextType::Webgl) {
<a name="18" id="anc18"></a>





 93         auto scope = DECLARE_THROW_SCOPE(state.vm());
 94         auto attributes = convert&lt;IDLDictionary&lt;WebGLContextAttributes&gt;&gt;(state, !arguments.isEmpty() ? arguments[0].get() : JSC::jsUndefined());
 95         RETURN_IF_EXCEPTION(scope, Exception { ExistingExceptionError });
 96 
 97         m_context = WebGLRenderingContextBase::create(*this, attributes, &quot;webgl&quot;);
 98         if (!m_context)
<a name="19" id="anc19"></a><span class="line-modified"> 99             return { nullptr };</span>
100 
101         return { RefPtr&lt;WebGLRenderingContext&gt; { &amp;downcast&lt;WebGLRenderingContext&gt;(*m_context) } };
102     }
<a name="20" id="anc20"></a>
103 
<a name="21" id="anc21"></a><span class="line-modified">104     return { nullptr };</span>
105 }
<a name="22" id="anc22"></a><span class="line-removed">106 #endif</span>
107 
<a name="23" id="anc23"></a><span class="line-modified">108 RefPtr&lt;ImageBitmap&gt; OffscreenCanvas::transferToImageBitmap()</span>
109 {
<a name="24" id="anc24"></a><span class="line-modified">110     if (!m_context)</span>
<span class="line-modified">111         return nullptr;</span>














112 
113 #if ENABLE(WEBGL)
<a name="25" id="anc25"></a><span class="line-modified">114     if (!is&lt;WebGLRenderingContext&gt;(*m_context))</span>

































































































115         return nullptr;
116 
<a name="26" id="anc26"></a><span class="line-modified">117     auto webGLContext = &amp;downcast&lt;WebGLRenderingContext&gt;(*m_context);</span>




















118 
<a name="27" id="anc27"></a><span class="line-modified">119     // FIXME: We&#39;re supposed to create an ImageBitmap using the backing</span>
<span class="line-modified">120     // store from this canvas (or its context), but for now we&#39;ll just</span>
<span class="line-modified">121     // create a new bitmap and paint into it.</span>




122 
<a name="28" id="anc28"></a><span class="line-modified">123     auto imageBitmap = ImageBitmap::create(m_size);</span>
<span class="line-modified">124     if (!imageBitmap-&gt;buffer())</span>



125         return nullptr;
126 
<a name="29" id="anc29"></a><span class="line-modified">127     auto* gc3d = webGLContext-&gt;graphicsContext3D();</span>
<span class="line-modified">128     gc3d-&gt;paintRenderingResultsToCanvas(imageBitmap-&gt;buffer());</span>
129 
<a name="30" id="anc30"></a><span class="line-modified">130     // FIXME: The transfer algorithm requires that the canvas effectively</span>
<span class="line-modified">131     // creates a new backing store. Since we&#39;re not doing that yet, we</span>
<span class="line-modified">132     // need to erase what&#39;s there.</span>


133 
<a name="31" id="anc31"></a><span class="line-modified">134     GC3Dfloat clearColor[4];</span>
<span class="line-modified">135     gc3d-&gt;getFloatv(GraphicsContext3D::COLOR_CLEAR_VALUE, clearColor);</span>
<span class="line-removed">136     gc3d-&gt;clearColor(0, 0, 0, 0);</span>
<span class="line-removed">137     gc3d-&gt;clear(GraphicsContext3D::COLOR_BUFFER_BIT | GraphicsContext3D::DEPTH_BUFFER_BIT | GraphicsContext3D::STENCIL_BUFFER_BIT);</span>
<span class="line-removed">138     gc3d-&gt;clearColor(clearColor[0], clearColor[1], clearColor[2], clearColor[3]);</span>
139 
<a name="32" id="anc32"></a><span class="line-modified">140     return imageBitmap;</span>
<span class="line-removed">141 #else</span>
<span class="line-removed">142     return nullptr;</span>
<span class="line-removed">143 #endif</span>
144 }
145 
146 }
<a name="33" id="anc33"></a>

<a name="34" id="anc34"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="34" type="hidden" />
</body>
</html>