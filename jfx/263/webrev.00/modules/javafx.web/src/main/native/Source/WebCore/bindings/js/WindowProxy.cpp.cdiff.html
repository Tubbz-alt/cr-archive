<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/bindings/js/WindowProxy.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WebCoreTypedArrayController.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WindowProxy.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bindings/js/WindowProxy.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 30,10 ***</span>
<span class="line-new-header">--- 30,11 ---</span>
  #include &quot;PageGroup.h&quot;
  #include &quot;RemoteFrame.h&quot;
  #include &quot;ScriptController.h&quot;
  #include &quot;runtime_root.h&quot;
  #include &lt;JavaScriptCore/JSLock.h&gt;
<span class="line-added">+ #include &lt;JavaScriptCore/StrongInlines.h&gt;</span>
  #include &lt;JavaScriptCore/WeakGCMapInlines.h&gt;
  #include &lt;wtf/MemoryPressureHandler.h&gt;
  
  namespace WebCore {
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 51,62 ***</span>
          GCController::singleton().garbageCollectSoon();
  }
  
  WindowProxy::WindowProxy(AbstractFrame&amp; frame)
      : m_frame(&amp;frame)
  {
  }
  
  WindowProxy::~WindowProxy()
  {
      ASSERT(!m_frame);
<span class="line-modified">!     ASSERT(m_jsWindowProxies.isEmpty());</span>
  }
  
  void WindowProxy::detachFromFrame()
  {
      ASSERT(m_frame);
  
      m_frame = nullptr;
  
      // It&#39;s likely that destroying windowProxies will create a lot of garbage.
<span class="line-modified">!     if (!m_jsWindowProxies.isEmpty()) {</span>
<span class="line-modified">!         while (!m_jsWindowProxies.isEmpty()) {</span>
<span class="line-modified">!             auto it = m_jsWindowProxies.begin();</span>
              it-&gt;value-&gt;window()-&gt;setConsoleClient(nullptr);
              destroyJSWindowProxy(*it-&gt;key);
          }
          collectGarbageAfterWindowProxyDestruction();
      }
  }
  
  void WindowProxy::destroyJSWindowProxy(DOMWrapperWorld&amp; world)
  {
<span class="line-modified">!     ASSERT(m_jsWindowProxies.contains(&amp;world));</span>
<span class="line-modified">!     m_jsWindowProxies.remove(&amp;world);</span>
      world.didDestroyWindowProxy(this);
  }
  
  JSWindowProxy&amp; WindowProxy::createJSWindowProxy(DOMWrapperWorld&amp; world)
  {
      ASSERT(m_frame);
  
<span class="line-modified">!     ASSERT(!m_jsWindowProxies.contains(&amp;world));</span>
      ASSERT(m_frame-&gt;window());
  
      VM&amp; vm = world.vm();
  
      Strong&lt;JSWindowProxy&gt; jsWindowProxy(vm, &amp;JSWindowProxy::create(vm, *m_frame-&gt;window(), world));
      Strong&lt;JSWindowProxy&gt; jsWindowProxy2(jsWindowProxy);
<span class="line-modified">!     m_jsWindowProxies.add(&amp;world, jsWindowProxy);</span>
      world.didCreateWindowProxy(this);
      return *jsWindowProxy.get();
  }
  
  Vector&lt;JSC::Strong&lt;JSWindowProxy&gt;&gt; WindowProxy::jsWindowProxiesAsVector() const
  {
<span class="line-modified">!     return copyToVector(m_jsWindowProxies.values());</span>
  }
  
  JSDOMGlobalObject* WindowProxy::globalObject(DOMWrapperWorld&amp; world)
  {
      if (auto* windowProxy = jsWindowProxy(world))
<span class="line-new-header">--- 52,63 ---</span>
          GCController::singleton().garbageCollectSoon();
  }
  
  WindowProxy::WindowProxy(AbstractFrame&amp; frame)
      : m_frame(&amp;frame)
<span class="line-added">+     , m_jsWindowProxies(makeUniqueRef&lt;ProxyMap&gt;())</span>
  {
  }
  
  WindowProxy::~WindowProxy()
  {
      ASSERT(!m_frame);
<span class="line-modified">!     ASSERT(m_jsWindowProxies-&gt;isEmpty());</span>
  }
  
  void WindowProxy::detachFromFrame()
  {
      ASSERT(m_frame);
  
      m_frame = nullptr;
  
      // It&#39;s likely that destroying windowProxies will create a lot of garbage.
<span class="line-modified">!     if (!m_jsWindowProxies-&gt;isEmpty()) {</span>
<span class="line-modified">!         while (!m_jsWindowProxies-&gt;isEmpty()) {</span>
<span class="line-modified">!             auto it = m_jsWindowProxies-&gt;begin();</span>
              it-&gt;value-&gt;window()-&gt;setConsoleClient(nullptr);
              destroyJSWindowProxy(*it-&gt;key);
          }
          collectGarbageAfterWindowProxyDestruction();
      }
  }
  
  void WindowProxy::destroyJSWindowProxy(DOMWrapperWorld&amp; world)
  {
<span class="line-modified">!     ASSERT(m_jsWindowProxies-&gt;contains(&amp;world));</span>
<span class="line-modified">!     m_jsWindowProxies-&gt;remove(&amp;world);</span>
      world.didDestroyWindowProxy(this);
  }
  
  JSWindowProxy&amp; WindowProxy::createJSWindowProxy(DOMWrapperWorld&amp; world)
  {
      ASSERT(m_frame);
  
<span class="line-modified">!     ASSERT(!m_jsWindowProxies-&gt;contains(&amp;world));</span>
      ASSERT(m_frame-&gt;window());
  
      VM&amp; vm = world.vm();
  
      Strong&lt;JSWindowProxy&gt; jsWindowProxy(vm, &amp;JSWindowProxy::create(vm, *m_frame-&gt;window(), world));
      Strong&lt;JSWindowProxy&gt; jsWindowProxy2(jsWindowProxy);
<span class="line-modified">!     m_jsWindowProxies-&gt;add(&amp;world, jsWindowProxy);</span>
      world.didCreateWindowProxy(this);
      return *jsWindowProxy.get();
  }
  
  Vector&lt;JSC::Strong&lt;JSWindowProxy&gt;&gt; WindowProxy::jsWindowProxiesAsVector() const
  {
<span class="line-modified">!     return copyToVector(m_jsWindowProxies-&gt;values());</span>
  }
  
  JSDOMGlobalObject* WindowProxy::globalObject(DOMWrapperWorld&amp; world)
  {
      if (auto* windowProxy = jsWindowProxy(world))
</pre>
<hr />
<pre>
<span class="line-old-header">*** 123,13 ***</span>
      if (is&lt;Frame&gt;(*m_frame))
          downcast&lt;Frame&gt;(*m_frame).script().initScriptForWindowProxy(windowProxy);
      return windowProxy;
  }
  
<span class="line-modified">! void WindowProxy::clearJSWindowProxiesNotMatchingDOMWindow(AbstractDOMWindow* newDOMWindow, bool goingIntoPageCache)</span>
  {
<span class="line-modified">!     if (m_jsWindowProxies.isEmpty())</span>
          return;
  
      JSLockHolder lock(commonVM());
  
      for (auto&amp; windowProxy : jsWindowProxiesAsVector()) {
<span class="line-new-header">--- 125,13 ---</span>
      if (is&lt;Frame&gt;(*m_frame))
          downcast&lt;Frame&gt;(*m_frame).script().initScriptForWindowProxy(windowProxy);
      return windowProxy;
  }
  
<span class="line-modified">! void WindowProxy::clearJSWindowProxiesNotMatchingDOMWindow(AbstractDOMWindow* newDOMWindow, bool goingIntoBackForwardCache)</span>
  {
<span class="line-modified">!     if (m_jsWindowProxies-&gt;isEmpty())</span>
          return;
  
      JSLockHolder lock(commonVM());
  
      for (auto&amp; windowProxy : jsWindowProxiesAsVector()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 143,19 ***</span>
              jsDOMWindow-&gt;willRemoveFromWindowProxy();
      }
  
      // It&#39;s likely that resetting our windows created a lot of garbage, unless
      // it went in a back/forward cache.
<span class="line-modified">!     if (!goingIntoPageCache)</span>
          collectGarbageAfterWindowProxyDestruction();
  }
  
  void WindowProxy::setDOMWindow(AbstractDOMWindow* newDOMWindow)
  {
      ASSERT(newDOMWindow);
  
<span class="line-modified">!     if (m_jsWindowProxies.isEmpty())</span>
          return;
  
      ASSERT(m_frame);
  
      JSLockHolder lock(commonVM());
<span class="line-new-header">--- 145,19 ---</span>
              jsDOMWindow-&gt;willRemoveFromWindowProxy();
      }
  
      // It&#39;s likely that resetting our windows created a lot of garbage, unless
      // it went in a back/forward cache.
<span class="line-modified">!     if (!goingIntoBackForwardCache)</span>
          collectGarbageAfterWindowProxyDestruction();
  }
  
  void WindowProxy::setDOMWindow(AbstractDOMWindow* newDOMWindow)
  {
      ASSERT(newDOMWindow);
  
<span class="line-modified">!     if (m_jsWindowProxies-&gt;isEmpty())</span>
          return;
  
      ASSERT(m_frame);
  
      JSLockHolder lock(commonVM());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 186,15 ***</span>
      }
  }
  
  void WindowProxy::attachDebugger(JSC::Debugger* debugger)
  {
<span class="line-modified">!     for (auto&amp; windowProxy : m_jsWindowProxies.values())</span>
          windowProxy-&gt;attachDebugger(debugger);
  }
  
  AbstractDOMWindow* WindowProxy::window() const
  {
      return m_frame ? m_frame-&gt;window() : nullptr;
  }
  
  } // namespace WebCore
<span class="line-new-header">--- 188,30 ---</span>
      }
  }
  
  void WindowProxy::attachDebugger(JSC::Debugger* debugger)
  {
<span class="line-modified">!     for (auto&amp; windowProxy : m_jsWindowProxies-&gt;values())</span>
          windowProxy-&gt;attachDebugger(debugger);
  }
  
  AbstractDOMWindow* WindowProxy::window() const
  {
      return m_frame ? m_frame-&gt;window() : nullptr;
  }
  
<span class="line-added">+ WindowProxy::ProxyMap::ValuesConstIteratorRange WindowProxy::jsWindowProxies() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return m_jsWindowProxies-&gt;values();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ WindowProxy::ProxyMap WindowProxy::releaseJSWindowProxies()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return std::exchange(m_jsWindowProxies, makeUniqueRef&lt;ProxyMap&gt;());</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void WindowProxy::setJSWindowProxies(ProxyMap&amp;&amp; windowProxies)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     m_jsWindowProxies = makeUniqueRef&lt;ProxyMap&gt;(WTFMove(windowProxies));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  } // namespace WebCore
</pre>
<center><a href="WebCoreTypedArrayController.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WindowProxy.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>