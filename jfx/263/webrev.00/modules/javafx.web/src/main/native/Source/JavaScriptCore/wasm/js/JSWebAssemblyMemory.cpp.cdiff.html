<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/wasm/js/JSWebAssemblyMemory.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSWebAssemblyLinkError.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSWebAssemblyMemory.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/wasm/js/JSWebAssemblyMemory.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 35,22 ***</span>
  
  namespace JSC {
  
  const ClassInfo JSWebAssemblyMemory::s_info = { &quot;WebAssembly.Memory&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSWebAssemblyMemory) };
  
<span class="line-modified">! JSWebAssemblyMemory* JSWebAssemblyMemory::create(ExecState* exec, VM&amp; vm, Structure* structure)</span>
  {
      auto throwScope = DECLARE_THROW_SCOPE(vm);
<span class="line-removed">-     auto* globalObject = exec-&gt;lexicalGlobalObject();</span>
  
      auto exception = [&amp;] (JSObject* error) {
<span class="line-modified">!         throwException(exec, throwScope, error);</span>
          return nullptr;
      };
  
      if (!globalObject-&gt;webAssemblyEnabled())
<span class="line-modified">!         return exception(createEvalError(exec, globalObject-&gt;webAssemblyDisabledErrorMessage()));</span>
  
      auto* memory = new (NotNull, allocateCell&lt;JSWebAssemblyMemory&gt;(vm.heap)) JSWebAssemblyMemory(vm, structure);
      memory-&gt;finishCreation(vm);
      return memory;
  }
<span class="line-new-header">--- 35,21 ---</span>
  
  namespace JSC {
  
  const ClassInfo JSWebAssemblyMemory::s_info = { &quot;WebAssembly.Memory&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSWebAssemblyMemory) };
  
<span class="line-modified">! JSWebAssemblyMemory* JSWebAssemblyMemory::tryCreate(JSGlobalObject* globalObject, VM&amp; vm, Structure* structure)</span>
  {
      auto throwScope = DECLARE_THROW_SCOPE(vm);
  
      auto exception = [&amp;] (JSObject* error) {
<span class="line-modified">!         throwException(globalObject, throwScope, error);</span>
          return nullptr;
      };
  
      if (!globalObject-&gt;webAssemblyEnabled())
<span class="line-modified">!         return exception(createEvalError(globalObject, globalObject-&gt;webAssemblyDisabledErrorMessage()));</span>
  
      auto* memory = new (NotNull, allocateCell&lt;JSWebAssemblyMemory&gt;(vm.heap)) JSWebAssemblyMemory(vm, structure);
      memory-&gt;finishCreation(vm);
      return memory;
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 78,36 ***</span>
      if (m_bufferWrapper)
          return m_bufferWrapper.get();
  
      // We can&#39;t use a ref here since it doesn&#39;t have a copy constructor...
      Ref&lt;Wasm::Memory&gt; protectedMemory = m_memory.get();
<span class="line-modified">!     auto destructor = [protectedMemory = WTFMove(protectedMemory)] (void*) { };</span>
      m_buffer = ArrayBuffer::createFromBytes(memory().memory(), memory().size(), WTFMove(destructor));
      m_buffer-&gt;makeWasmMemory();
      m_bufferWrapper.set(vm, this, JSArrayBuffer::create(vm, globalObject-&gt;arrayBufferStructure(ArrayBufferSharingMode::Default), m_buffer.get()));
      RELEASE_ASSERT(m_bufferWrapper);
      return m_bufferWrapper.get();
  }
  
<span class="line-modified">! Wasm::PageCount JSWebAssemblyMemory::grow(VM&amp; vm, ExecState* exec, uint32_t delta)</span>
  {
      auto throwScope = DECLARE_THROW_SCOPE(vm);
  
      auto grown = memory().grow(Wasm::PageCount(delta));
      if (!grown) {
          switch (grown.error()) {
          case Wasm::Memory::GrowFailReason::InvalidDelta:
<span class="line-modified">!             throwException(exec, throwScope, createRangeError(exec, &quot;WebAssembly.Memory.grow expects the delta to be a valid page count&quot;_s));</span>
              break;
          case Wasm::Memory::GrowFailReason::InvalidGrowSize:
<span class="line-modified">!             throwException(exec, throwScope, createRangeError(exec, &quot;WebAssembly.Memory.grow expects the grown size to be a valid page count&quot;_s));</span>
              break;
          case Wasm::Memory::GrowFailReason::WouldExceedMaximum:
<span class="line-modified">!             throwException(exec, throwScope, createRangeError(exec, &quot;WebAssembly.Memory.grow would exceed the memory&#39;s declared maximum size&quot;_s));</span>
              break;
          case Wasm::Memory::GrowFailReason::OutOfMemory:
<span class="line-modified">!             throwException(exec, throwScope, createOutOfMemoryError(exec));</span>
              break;
          }
          return Wasm::PageCount();
      }
  
<span class="line-new-header">--- 77,36 ---</span>
      if (m_bufferWrapper)
          return m_bufferWrapper.get();
  
      // We can&#39;t use a ref here since it doesn&#39;t have a copy constructor...
      Ref&lt;Wasm::Memory&gt; protectedMemory = m_memory.get();
<span class="line-modified">!     auto destructor = createSharedTask&lt;void(void*)&gt;([protectedMemory = WTFMove(protectedMemory)] (void*) { });</span>
      m_buffer = ArrayBuffer::createFromBytes(memory().memory(), memory().size(), WTFMove(destructor));
      m_buffer-&gt;makeWasmMemory();
      m_bufferWrapper.set(vm, this, JSArrayBuffer::create(vm, globalObject-&gt;arrayBufferStructure(ArrayBufferSharingMode::Default), m_buffer.get()));
      RELEASE_ASSERT(m_bufferWrapper);
      return m_bufferWrapper.get();
  }
  
<span class="line-modified">! Wasm::PageCount JSWebAssemblyMemory::grow(VM&amp; vm, JSGlobalObject* globalObject, uint32_t delta)</span>
  {
      auto throwScope = DECLARE_THROW_SCOPE(vm);
  
      auto grown = memory().grow(Wasm::PageCount(delta));
      if (!grown) {
          switch (grown.error()) {
          case Wasm::Memory::GrowFailReason::InvalidDelta:
<span class="line-modified">!             throwException(globalObject, throwScope, createRangeError(globalObject, &quot;WebAssembly.Memory.grow expects the delta to be a valid page count&quot;_s));</span>
              break;
          case Wasm::Memory::GrowFailReason::InvalidGrowSize:
<span class="line-modified">!             throwException(globalObject, throwScope, createRangeError(globalObject, &quot;WebAssembly.Memory.grow expects the grown size to be a valid page count&quot;_s));</span>
              break;
          case Wasm::Memory::GrowFailReason::WouldExceedMaximum:
<span class="line-modified">!             throwException(globalObject, throwScope, createRangeError(globalObject, &quot;WebAssembly.Memory.grow would exceed the memory&#39;s declared maximum size&quot;_s));</span>
              break;
          case Wasm::Memory::GrowFailReason::OutOfMemory:
<span class="line-modified">!             throwException(globalObject, throwScope, createOutOfMemoryError(globalObject));</span>
              break;
          }
          return Wasm::PageCount();
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 137,12 ***</span>
  }
  
  void JSWebAssemblyMemory::destroy(JSCell* cell)
  {
      auto memory = static_cast&lt;JSWebAssemblyMemory*&gt;(cell);
<span class="line-removed">-     ASSERT(memory-&gt;classInfo() == info());</span>
<span class="line-removed">- </span>
      memory-&gt;JSWebAssemblyMemory::~JSWebAssemblyMemory();
  }
  
  void JSWebAssemblyMemory::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
  {
<span class="line-new-header">--- 136,10 ---</span>
</pre>
<center><a href="JSWebAssemblyLinkError.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSWebAssemblyMemory.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>