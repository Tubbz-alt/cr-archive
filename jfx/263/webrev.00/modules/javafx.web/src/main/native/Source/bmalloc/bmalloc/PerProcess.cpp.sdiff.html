<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/bmalloc/bmalloc/PerProcess.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ObjectType.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PerProcess.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/bmalloc/bmalloc/PerProcess.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
43 
44 // Returns zero-filled memory by virtual of using vmAllocate.
45 static void* allocate(size_t size, size_t alignment)
46 {
47     s_bumpOffset = roundUpToMultipleOf(alignment, s_bumpOffset);
48     void* result = s_bumpBase + s_bumpOffset;
49     s_bumpOffset += size;
50     if (s_bumpOffset &lt;= s_bumpLimit)
51         return result;
52 
53     size_t allocationSize = vmSize(size);
54     void* allocation = vmAllocate(allocationSize);
55     s_bumpBase = static_cast&lt;char*&gt;(allocation);
56     s_bumpOffset = 0;
57     s_bumpLimit = allocationSize;
58     return allocate(size, alignment);
59 }
60 
61 PerProcessData* getPerProcessData(unsigned hash, const char* disambiguator, size_t size, size_t alignment)
62 {
<span class="line-modified">63     std::lock_guard&lt;Mutex&gt; lock(s_mutex);</span>
64 
65     PerProcessData*&amp; bucket = s_table[hash % tableSize];
66 
67     for (PerProcessData* data = bucket; data; data = data-&gt;next) {
68         if (!strcmp(data-&gt;disambiguator, disambiguator)) {
69             if (verbose)
70                 fprintf(stderr, &quot;%d: Using existing %s\n&quot;, getpid(), disambiguator);
71             RELEASE_BASSERT(data-&gt;size == size);
72             RELEASE_BASSERT(data-&gt;alignment == alignment);
73             return data;
74         }
75     }
76 
77     if (verbose)
78         fprintf(stderr, &quot;%d: Creating new %s\n&quot;, getpid(), disambiguator);
79     void* rawDataPtr = allocate(sizeof(PerProcessData), std::alignment_of&lt;PerProcessData&gt;::value);
80     PerProcessData* data = static_cast&lt;PerProcessData*&gt;(rawDataPtr);
81     data-&gt;disambiguator = disambiguator;
82     data-&gt;memory = allocate(size, alignment);
83     data-&gt;size = size;
</pre>
</td>
<td>
<hr />
<pre>
43 
44 // Returns zero-filled memory by virtual of using vmAllocate.
45 static void* allocate(size_t size, size_t alignment)
46 {
47     s_bumpOffset = roundUpToMultipleOf(alignment, s_bumpOffset);
48     void* result = s_bumpBase + s_bumpOffset;
49     s_bumpOffset += size;
50     if (s_bumpOffset &lt;= s_bumpLimit)
51         return result;
52 
53     size_t allocationSize = vmSize(size);
54     void* allocation = vmAllocate(allocationSize);
55     s_bumpBase = static_cast&lt;char*&gt;(allocation);
56     s_bumpOffset = 0;
57     s_bumpLimit = allocationSize;
58     return allocate(size, alignment);
59 }
60 
61 PerProcessData* getPerProcessData(unsigned hash, const char* disambiguator, size_t size, size_t alignment)
62 {
<span class="line-modified">63     LockHolder lock(s_mutex);</span>
64 
65     PerProcessData*&amp; bucket = s_table[hash % tableSize];
66 
67     for (PerProcessData* data = bucket; data; data = data-&gt;next) {
68         if (!strcmp(data-&gt;disambiguator, disambiguator)) {
69             if (verbose)
70                 fprintf(stderr, &quot;%d: Using existing %s\n&quot;, getpid(), disambiguator);
71             RELEASE_BASSERT(data-&gt;size == size);
72             RELEASE_BASSERT(data-&gt;alignment == alignment);
73             return data;
74         }
75     }
76 
77     if (verbose)
78         fprintf(stderr, &quot;%d: Creating new %s\n&quot;, getpid(), disambiguator);
79     void* rawDataPtr = allocate(sizeof(PerProcessData), std::alignment_of&lt;PerProcessData&gt;::value);
80     PerProcessData* data = static_cast&lt;PerProcessData*&gt;(rawDataPtr);
81     data-&gt;disambiguator = disambiguator;
82     data-&gt;memory = allocate(size, alignment);
83     data-&gt;size = size;
</pre>
</td>
</tr>
</table>
<center><a href="ObjectType.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PerProcess.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>