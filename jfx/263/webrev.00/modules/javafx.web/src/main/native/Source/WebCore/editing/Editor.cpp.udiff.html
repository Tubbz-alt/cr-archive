<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/editing/Editor.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="EditingStyle.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Editor.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/editing/Editor.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -36,10 +36,11 @@</span>
  #include &quot;CSSValuePool.h&quot;
  #include &quot;CachedResourceLoader.h&quot;
  #include &quot;ChangeListTypeCommand.h&quot;
  #include &quot;ClipboardEvent.h&quot;
  #include &quot;CompositionEvent.h&quot;
<span class="udiff-line-added">+ #include &quot;CompositionHighlight.h&quot;</span>
  #include &quot;CreateLinkCommand.h&quot;
  #include &quot;CustomUndoStep.h&quot;
  #include &quot;DataTransfer.h&quot;
  #include &quot;DeleteSelectionCommand.h&quot;
  #include &quot;DictationAlternative.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -84,10 +85,11 @@</span>
  #include &quot;Page.h&quot;
  #include &quot;Pasteboard.h&quot;
  #include &quot;Range.h&quot;
  #include &quot;RemoveFormatCommand.h&quot;
  #include &quot;RenderBlock.h&quot;
<span class="udiff-line-added">+ #include &quot;RenderLayer.h&quot;</span>
  #include &quot;RenderTextControl.h&quot;
  #include &quot;RenderedDocumentMarker.h&quot;
  #include &quot;RenderedPosition.h&quot;
  #include &quot;ReplaceRangeWithTextCommand.h&quot;
  #include &quot;ReplaceSelectionCommand.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -299,10 +301,16 @@</span>
  {
      if (auto* client = this-&gt;client())
          client-&gt;handleInputMethodKeydown(event);
  }
  
<span class="udiff-line-added">+ void Editor::didDispatchInputMethodKeydown(KeyboardEvent&amp; event)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (auto* client = this-&gt;client())</span>
<span class="udiff-line-added">+         client-&gt;didDispatchInputMethodKeydown(event);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  bool Editor::handleTextEvent(TextEvent&amp; event)
  {
      LOG(Editing, &quot;Editor %p handleTextEvent (data %s)&quot;, this, event.data().utf8().data());
  
      // Default event handling for Drag and Drop will be handled by DragController
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -672,11 +680,17 @@</span>
      if (mailBlockquoteHandling == MailBlockquoteHandling::IgnoreBlockquote)
          options.add(ReplaceSelectionCommand::IgnoreMailBlockquote);
  
      auto command = ReplaceSelectionCommand::create(document(), &amp;fragment, options, editingAction);
      command-&gt;apply();
<span class="udiff-line-modified-removed">-     revealSelectionAfterEditingOperation();</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     m_imageElementsToLoadBeforeRevealingSelection.clear();</span>
<span class="udiff-line-added">+     if (auto insertionRange = command-&gt;insertedContentRange())</span>
<span class="udiff-line-added">+         m_imageElementsToLoadBeforeRevealingSelection = visibleImageElementsInRangeWithNonLoadedImages(*insertionRange);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (m_imageElementsToLoadBeforeRevealingSelection.isEmpty())</span>
<span class="udiff-line-added">+         revealSelectionAfterEditingOperation();</span>
  
      selection = m_frame.selection().selection();
      if (selection.isInPasswordField())
          return;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1202,10 +1216,11 @@</span>
          m_compositionNode = nullptr;
          if (EditorClient* client = this-&gt;client())
              client-&gt;discardedComposition(&amp;m_frame);
      }
      m_customCompositionUnderlines.clear();
<span class="udiff-line-added">+     m_customCompositionHighlights.clear();</span>
      m_shouldStyleWithCSS = false;
      m_defaultParagraphSeparator = EditorParagraphSeparatorIsDiv;
      m_mark = { };
      m_oldSelectionForEditorUIUpdate = { };
      m_editorUIUpdateTimer.stop();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1569,10 +1584,48 @@</span>
  #endif
  }
  
  #endif
  
<span class="udiff-line-added">+ void Editor::revealSelectionIfNeededAfterLoadingImageForElement(HTMLImageElement&amp; element)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (m_imageElementsToLoadBeforeRevealingSelection.isEmpty())</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!m_imageElementsToLoadBeforeRevealingSelection.remove(&amp;element))</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!m_imageElementsToLoadBeforeRevealingSelection.isEmpty())</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // FIXME: This should be queued as a task for the next rendering update.</span>
<span class="udiff-line-added">+     document().updateLayout();</span>
<span class="udiff-line-added">+     revealSelectionAfterEditingOperation();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Editor::renderLayerDidScroll(const RenderLayer&amp; layer)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (m_imageElementsToLoadBeforeRevealingSelection.isEmpty())</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto startContainer = makeRefPtr(m_frame.selection().selection().start().containerNode());</span>
<span class="udiff-line-added">+     if (!startContainer)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto* startContainerRenderer = startContainer-&gt;renderer();</span>
<span class="udiff-line-added">+     if (!startContainerRenderer)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // FIXME: Ideally, this would also cancel deferred selection revealing if the selection is inside a subframe and a parent frame is scrolled.</span>
<span class="udiff-line-added">+     for (auto* enclosingLayer = startContainerRenderer-&gt;enclosingLayer(); enclosingLayer; enclosingLayer = enclosingLayer-&gt;parent()) {</span>
<span class="udiff-line-added">+         if (enclosingLayer == &amp;layer) {</span>
<span class="udiff-line-added">+             m_imageElementsToLoadBeforeRevealingSelection.clear();</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  bool Editor::isContinuousSpellCheckingEnabled() const
  {
      return client() &amp;&amp; client()-&gt;isContinuousSpellCheckingEnabled();
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1917,10 +1970,11 @@</span>
      else
          selectComposition();
  
      m_compositionNode = nullptr;
      m_customCompositionUnderlines.clear();
<span class="udiff-line-added">+     m_customCompositionHighlights.clear();</span>
  
      if (m_frame.selection().isNone())
          return;
  
      // Always delete the current composition before inserting the finalized composition text if we&#39;re confirming our composition.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1938,11 +1992,11 @@</span>
          // An open typing command that disagrees about current selection would cause issues with typing later on.
          TypingCommand::closeTyping(&amp;m_frame);
      }
  }
  
<span class="udiff-line-modified-removed">- void Editor::setComposition(const String&amp; text, const Vector&lt;CompositionUnderline&gt;&amp; underlines, unsigned selectionStart, unsigned selectionEnd)</span>
<span class="udiff-line-modified-added">+ void Editor::setComposition(const String&amp; text, const Vector&lt;CompositionUnderline&gt;&amp; underlines, const Vector&lt;CompositionHighlight&gt;&amp; highlights, unsigned selectionStart, unsigned selectionEnd)</span>
  {
      SetCompositionScope setCompositionScope(m_frame);
  
      // Updates styles before setting selection for composition to prevent
      // inserting the previous composition text into text nodes oddly.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2010,10 +2064,11 @@</span>
              target-&gt;dispatchEvent(CompositionEvent::create(eventNames().compositionendEvent, document().windowProxy(), text));
      }
  
      m_compositionNode = nullptr;
      m_customCompositionUnderlines.clear();
<span class="udiff-line-added">+     m_customCompositionHighlights.clear();</span>
  
      if (!text.isEmpty()) {
          TypingCommand::insertText(document(), text, TypingCommand::SelectInsertedText | TypingCommand::PreventSpellChecking, TypingCommand::TextCompositionPending);
  
          // Find out what node has the composition now.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2031,10 +2086,15 @@</span>
              m_customCompositionUnderlines = underlines;
              for (auto&amp; underline : m_customCompositionUnderlines) {
                  underline.startOffset += baseOffset;
                  underline.endOffset += baseOffset;
              }
<span class="udiff-line-added">+             m_customCompositionHighlights = highlights;</span>
<span class="udiff-line-added">+             for (auto&amp; highlight : m_customCompositionHighlights) {</span>
<span class="udiff-line-added">+                 highlight.startOffset += baseOffset;</span>
<span class="udiff-line-added">+                 highlight.endOffset += baseOffset;</span>
<span class="udiff-line-added">+             }</span>
              if (baseNode-&gt;renderer())
                  baseNode-&gt;renderer()-&gt;repaint();
  
              unsigned start = std::min(baseOffset + selectionStart, extentOffset);
              unsigned end = std::min(std::max(start, baseOffset + selectionEnd), extentOffset);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3573,10 +3633,11 @@</span>
      if (shouldDetectTelephoneNumbers())
          m_telephoneNumberDetectionUpdateTimer.startOneShot(0_s);
  #endif
  
      setStartNewKillRingSequence(true);
<span class="udiff-line-added">+     m_imageElementsToLoadBeforeRevealingSelection.clear();</span>
  
      if (m_editorUIUpdateTimer.isActive())
          return;
  
      // Don&#39;t check spelling and grammar if the change of selection is triggered by spelling correction itself.
</pre>
<center><a href="EditingStyle.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Editor.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>