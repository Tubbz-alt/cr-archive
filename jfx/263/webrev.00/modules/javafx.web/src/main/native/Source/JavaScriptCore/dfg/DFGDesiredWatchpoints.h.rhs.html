<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/dfg/DFGDesiredWatchpoints.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2013-2019 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
 28 #if ENABLE(DFG_JIT)
 29 
 30 #include &quot;DFGCommonData.h&quot;
 31 #include &quot;FunctionExecutable.h&quot;
 32 #include &quot;JSArrayBufferView.h&quot;
 33 #include &quot;ObjectPropertyCondition.h&quot;
 34 #include &quot;SymbolTable.h&quot;
 35 #include &quot;Watchpoint.h&quot;
 36 #include &lt;wtf/CommaPrinter.h&gt;
 37 #include &lt;wtf/HashSet.h&gt;
 38 
 39 namespace JSC { namespace DFG {
 40 
 41 class Graph;
 42 struct Prefix;
 43 
 44 template&lt;typename T&gt;
 45 struct SetPointerAdaptor {
 46     static void add(CodeBlock* codeBlock, T set, CommonData&amp; common)
 47     {
<a name="1" id="anc1"></a><span class="line-modified"> 48         CodeBlockJettisoningWatchpoint* watchpoint = nullptr;</span>
<span class="line-added"> 49         {</span>
<span class="line-added"> 50             ConcurrentJSLocker locker(codeBlock-&gt;m_lock);</span>
<span class="line-added"> 51             watchpoint = common.watchpoints.add(codeBlock);</span>
<span class="line-added"> 52         }</span>
<span class="line-added"> 53         return set-&gt;add(WTFMove(watchpoint));</span>
 54     }
 55     static bool hasBeenInvalidated(T set)
 56     {
 57         return set-&gt;hasBeenInvalidated();
 58     }
 59     static void dumpInContext(PrintStream&amp; out, T set, DumpContext*)
 60     {
 61         out.print(RawPointer(set));
 62     }
 63 };
 64 
 65 struct SymbolTableAdaptor {
 66     static void add(CodeBlock*, SymbolTable*, CommonData&amp;);
 67     static bool hasBeenInvalidated(SymbolTable* symbolTable)
 68     {
 69         return symbolTable-&gt;singleton().hasBeenInvalidated();
 70     }
 71     static void dumpInContext(PrintStream&amp; out, SymbolTable* symbolTable, DumpContext*)
 72     {
 73         out.print(RawPointer(symbolTable));
 74     }
 75 };
 76 
 77 struct FunctionExecutableAdaptor {
 78     static void add(CodeBlock*, FunctionExecutable*, CommonData&amp;);
 79     static bool hasBeenInvalidated(FunctionExecutable* executable)
 80     {
 81         return executable-&gt;singleton().hasBeenInvalidated();
 82     }
 83     static void dumpInContext(PrintStream&amp; out, FunctionExecutable* executable, DumpContext*)
 84     {
 85         out.print(RawPointer(executable));
 86     }
 87 };
 88 
 89 struct ArrayBufferViewWatchpointAdaptor {
 90     static void add(CodeBlock*, JSArrayBufferView*, CommonData&amp;);
 91     static bool hasBeenInvalidated(JSArrayBufferView* view)
 92     {
 93         return !view-&gt;length();
 94     }
 95     static void dumpInContext(PrintStream&amp; out, JSArrayBufferView* view, DumpContext* context)
 96     {
 97         out.print(inContext(JSValue(view), context));
 98     }
 99 };
100 
101 struct AdaptiveStructureWatchpointAdaptor {
102     static void add(CodeBlock*, const ObjectPropertyCondition&amp;, CommonData&amp;);
103     static bool hasBeenInvalidated(const ObjectPropertyCondition&amp; key)
104     {
105         return !key.isWatchable();
106     }
107     static void dumpInContext(
108         PrintStream&amp; out, const ObjectPropertyCondition&amp; key, DumpContext* context)
109     {
110         out.print(inContext(key, context));
111     }
112 };
113 
114 template&lt;typename WatchpointSetType, typename Adaptor = SetPointerAdaptor&lt;WatchpointSetType&gt;&gt;
115 class GenericDesiredWatchpoints {
<a name="2" id="anc2"></a><span class="line-modified">116 #if ASSERT_ENABLED</span>
117     typedef HashMap&lt;WatchpointSetType, bool&gt; StateMap;
118 #endif
119 public:
120     GenericDesiredWatchpoints()
121         : m_reallyAdded(false)
122     {
123     }
124 
125     void addLazily(const WatchpointSetType&amp; set)
126     {
127         m_sets.add(set);
128     }
129 
130     void reallyAdd(CodeBlock* codeBlock, CommonData&amp; common)
131     {
132         RELEASE_ASSERT(!m_reallyAdded);
133 
134         for (auto&amp; set : m_sets)
135             Adaptor::add(codeBlock, set, common);
136 
137         m_reallyAdded = true;
138     }
139 
140     bool areStillValid() const
141     {
142         for (auto&amp; set : m_sets) {
143             if (Adaptor::hasBeenInvalidated(set))
144                 return false;
145         }
146 
147         return true;
148     }
149 
150     bool isWatched(const WatchpointSetType&amp; set) const
151     {
152         return m_sets.contains(set);
153     }
154 
155     void dumpInContext(PrintStream&amp; out, DumpContext* context) const
156     {
157         CommaPrinter comma;
158         for (const WatchpointSetType&amp; entry : m_sets) {
159             out.print(comma);
160             Adaptor::dumpInContext(out, entry, context);
161         }
162     }
163 
164 private:
165     HashSet&lt;WatchpointSetType&gt; m_sets;
166     bool m_reallyAdded;
167 };
168 
169 class DesiredWatchpoints {
170 public:
171     DesiredWatchpoints();
172     ~DesiredWatchpoints();
173 
174     void addLazily(WatchpointSet*);
175     void addLazily(InlineWatchpointSet&amp;);
176     void addLazily(SymbolTable*);
177     void addLazily(FunctionExecutable*);
178     void addLazily(JSArrayBufferView*);
179 
180     // It&#39;s recommended that you don&#39;t call this directly. Use Graph::watchCondition(), which does
181     // the required GC magic as well as some other bookkeeping.
182     void addLazily(const ObjectPropertyCondition&amp;);
183 
184     bool consider(Structure*);
185 
186     void reallyAdd(CodeBlock*, CommonData&amp;);
187 
188     bool areStillValid() const;
189 
190     bool isWatched(WatchpointSet* set)
191     {
192         return m_sets.isWatched(set);
193     }
194     bool isWatched(InlineWatchpointSet&amp; set)
195     {
196         return m_inlineSets.isWatched(&amp;set);
197     }
198     bool isWatched(SymbolTable* symbolTable)
199     {
200         return m_symbolTables.isWatched(symbolTable);
201     }
202     bool isWatched(FunctionExecutable* executable)
203     {
204         return m_functionExecutables.isWatched(executable);
205     }
206     bool isWatched(JSArrayBufferView* view)
207     {
208         return m_bufferViews.isWatched(view);
209     }
210     bool isWatched(const ObjectPropertyCondition&amp; key)
211     {
212         return m_adaptiveStructureSets.isWatched(key);
213     }
214     void dumpInContext(PrintStream&amp;, DumpContext*) const;
215 
216 private:
217     GenericDesiredWatchpoints&lt;WatchpointSet*&gt; m_sets;
218     GenericDesiredWatchpoints&lt;InlineWatchpointSet*&gt; m_inlineSets;
219     GenericDesiredWatchpoints&lt;SymbolTable*, SymbolTableAdaptor&gt; m_symbolTables;
220     GenericDesiredWatchpoints&lt;FunctionExecutable*, FunctionExecutableAdaptor&gt; m_functionExecutables;
221     GenericDesiredWatchpoints&lt;JSArrayBufferView*, ArrayBufferViewWatchpointAdaptor&gt; m_bufferViews;
222     GenericDesiredWatchpoints&lt;ObjectPropertyCondition, AdaptiveStructureWatchpointAdaptor&gt; m_adaptiveStructureSets;
223 };
224 
225 } } // namespace JSC::DFG
226 
227 #endif // ENABLE(DFG_JIT)
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>