<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/loader/DocumentWriter.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DocumentThreadableLoader.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="EmptyClients.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/DocumentWriter.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 113,11 ***</span>
      if (MIMETypeRegistry::isPDFMIMEType(m_mimeType) &amp;&amp; (m_frame-&gt;isMainFrame() || !m_frame-&gt;settings().useImageDocumentForSubframePDF()))
          return SinkDocument::create(*m_frame, url);
  #endif
      if (!m_frame-&gt;loader().client().hasHTMLView())
          return Document::createNonRenderedPlaceholder(*m_frame, url);
<span class="line-modified">!     return DOMImplementation::createDocument(m_frame-&gt;sessionID(), m_mimeType, m_frame, url);</span>
  }
  
  bool DocumentWriter::begin(const URL&amp; urlReference, bool dispatch, Document* ownerDocument)
  {
      // We grab a local copy of the URL because it&#39;s easy for callers to supply
<span class="line-new-header">--- 113,11 ---</span>
      if (MIMETypeRegistry::isPDFMIMEType(m_mimeType) &amp;&amp; (m_frame-&gt;isMainFrame() || !m_frame-&gt;settings().useImageDocumentForSubframePDF()))
          return SinkDocument::create(*m_frame, url);
  #endif
      if (!m_frame-&gt;loader().client().hasHTMLView())
          return Document::createNonRenderedPlaceholder(*m_frame, url);
<span class="line-modified">!     return DOMImplementation::createDocument(m_mimeType, m_frame, url);</span>
  }
  
  bool DocumentWriter::begin(const URL&amp; urlReference, bool dispatch, Document* ownerDocument)
  {
      // We grab a local copy of the URL because it&#39;s easy for callers to supply
</pre>
<hr />
<pre>
<span class="line-old-header">*** 138,13 ***</span>
  
      bool shouldReuseDefaultView = m_frame-&gt;loader().stateMachine().isDisplayingInitialEmptyDocument() &amp;&amp; m_frame-&gt;document()-&gt;isSecureTransitionTo(url);
  
      // Temporarily extend the lifetime of the existing document so that FrameLoader::clear() doesn&#39;t destroy it as
      // we need to retain its ongoing set of upgraded requests in new navigation contexts per &lt;http://www.w3.org/TR/upgrade-insecure-requests/&gt;
<span class="line-modified">!     // and we may also need to inherit its Content Security Policy in FrameLoader::didBeginDocument().</span>
      RefPtr&lt;Document&gt; existingDocument = m_frame-&gt;document();
<span class="line-removed">-     auto* previousContentSecurityPolicy = existingDocument ? existingDocument-&gt;contentSecurityPolicy() : nullptr;</span>
  
      WTF::Function&lt;void()&gt; handleDOMWindowCreation = [this, document = document.copyRef(), url] {
          if (m_frame-&gt;loader().stateMachine().isDisplayingInitialEmptyDocument() &amp;&amp; m_frame-&gt;document()-&gt;isSecureTransitionTo(url))
              document-&gt;takeDOMWindowFrom(*m_frame-&gt;document());
          else
<span class="line-new-header">--- 138,12 ---</span>
  
      bool shouldReuseDefaultView = m_frame-&gt;loader().stateMachine().isDisplayingInitialEmptyDocument() &amp;&amp; m_frame-&gt;document()-&gt;isSecureTransitionTo(url);
  
      // Temporarily extend the lifetime of the existing document so that FrameLoader::clear() doesn&#39;t destroy it as
      // we need to retain its ongoing set of upgraded requests in new navigation contexts per &lt;http://www.w3.org/TR/upgrade-insecure-requests/&gt;
<span class="line-modified">!     // and we may also need to inherit its Content Security Policy below.</span>
      RefPtr&lt;Document&gt; existingDocument = m_frame-&gt;document();
  
      WTF::Function&lt;void()&gt; handleDOMWindowCreation = [this, document = document.copyRef(), url] {
          if (m_frame-&gt;loader().stateMachine().isDisplayingInitialEmptyDocument() &amp;&amp; m_frame-&gt;document()-&gt;isSecureTransitionTo(url))
              document-&gt;takeDOMWindowFrom(*m_frame-&gt;document());
          else
</pre>
<hr />
<pre>
<span class="line-old-header">*** 163,22 ***</span>
          m_frame-&gt;script().updatePlatformScriptObjects();
  
      m_frame-&gt;loader().setOutgoingReferrer(url);
      m_frame-&gt;setDocument(document.copyRef());
  
<span class="line-removed">-     if (previousContentSecurityPolicy)</span>
<span class="line-removed">-         document-&gt;contentSecurityPolicy()-&gt;setInsecureNavigationRequestsToUpgrade(previousContentSecurityPolicy-&gt;takeNavigationRequestsToUpgrade());</span>
<span class="line-removed">- </span>
      if (m_decoder)
          document-&gt;setDecoder(m_decoder.get());
      if (ownerDocument) {
          document-&gt;setCookieURL(ownerDocument-&gt;cookieURL());
          document-&gt;setSecurityOriginPolicy(ownerDocument-&gt;securityOriginPolicy());
          document-&gt;setStrictMixedContentMode(ownerDocument-&gt;isStrictMixedContentMode());
      }
  
<span class="line-modified">!     m_frame-&gt;loader().didBeginDocument(dispatch, previousContentSecurityPolicy);</span>
  
      document-&gt;implicitOpen();
  
      // We grab a reference to the parser so that we&#39;ll always send data to the
      // original parser, even if the document acquires a new parser (e.g., via
<span class="line-new-header">--- 162,35 ---</span>
          m_frame-&gt;script().updatePlatformScriptObjects();
  
      m_frame-&gt;loader().setOutgoingReferrer(url);
      m_frame-&gt;setDocument(document.copyRef());
  
      if (m_decoder)
          document-&gt;setDecoder(m_decoder.get());
      if (ownerDocument) {
<span class="line-added">+         // |document| is the result of evaluating a JavaScript URL.</span>
          document-&gt;setCookieURL(ownerDocument-&gt;cookieURL());
          document-&gt;setSecurityOriginPolicy(ownerDocument-&gt;securityOriginPolicy());
          document-&gt;setStrictMixedContentMode(ownerDocument-&gt;isStrictMixedContentMode());
<span class="line-added">+ </span>
<span class="line-added">+         document-&gt;setContentSecurityPolicy(makeUnique&lt;ContentSecurityPolicy&gt;(URL { url }, document));</span>
<span class="line-added">+         document-&gt;contentSecurityPolicy()-&gt;copyStateFrom(ownerDocument-&gt;contentSecurityPolicy());</span>
<span class="line-added">+         document-&gt;contentSecurityPolicy()-&gt;setInsecureNavigationRequestsToUpgrade(ownerDocument-&gt;contentSecurityPolicy()-&gt;takeNavigationRequestsToUpgrade());</span>
<span class="line-added">+     } else if (existingDocument) {</span>
<span class="line-added">+         if (url.protocolIsData() || url.protocolIsBlob()) {</span>
<span class="line-added">+             document-&gt;setContentSecurityPolicy(makeUnique&lt;ContentSecurityPolicy&gt;(URL { url }, document));</span>
<span class="line-added">+             document-&gt;contentSecurityPolicy()-&gt;copyStateFrom(existingDocument-&gt;contentSecurityPolicy());</span>
<span class="line-added">+ </span>
<span class="line-added">+             // Fix up &#39;self&#39; for blob: and data:, which is inherited from its embedding document or opener.</span>
<span class="line-added">+             auto* parentFrame = m_frame-&gt;tree().parent();</span>
<span class="line-added">+             if (auto* ownerFrame = parentFrame ? parentFrame : m_frame-&gt;loader().opener())</span>
<span class="line-added">+                 document-&gt;contentSecurityPolicy()-&gt;updateSourceSelf(ownerFrame-&gt;document()-&gt;securityOrigin());</span>
<span class="line-added">+         }</span>
<span class="line-added">+         document-&gt;contentSecurityPolicy()-&gt;setInsecureNavigationRequestsToUpgrade(existingDocument-&gt;contentSecurityPolicy()-&gt;takeNavigationRequestsToUpgrade());</span>
      }
  
<span class="line-modified">!     m_frame-&gt;loader().didBeginDocument(dispatch);</span>
  
      document-&gt;implicitOpen();
  
      // We grab a reference to the parser so that we&#39;ll always send data to the
      // original parser, even if the document acquires a new parser (e.g., via
</pre>
<center><a href="DocumentThreadableLoader.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="EmptyClients.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>