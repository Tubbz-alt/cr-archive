<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/platform/mediastream/RealtimeVideoCaptureSource.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="RealtimeOutgoingVideoSource.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RealtimeVideoSource.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/mediastream/RealtimeVideoCaptureSource.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
378 
379 RefPtr&lt;MediaSample&gt; RealtimeVideoCaptureSource::adaptVideoSample(MediaSample&amp; sample)
380 {
381     MediaTime sampleTime = sample.outputPresentationTime();
382     if (!sampleTime || !sampleTime.isValid())
383         sampleTime = sample.presentationTime();
384 
385     auto frameTime = sampleTime.toDouble();
386     m_observedFrameTimeStamps.append(frameTime);
387     m_observedFrameTimeStamps.removeAllMatching([&amp;](auto time) {
388         return time &lt;= frameTime - 2;
389     });
390 
391     auto interval = m_observedFrameTimeStamps.last() - m_observedFrameTimeStamps.first();
392     if (interval &gt; 1)
393         m_observedFrameRate = (m_observedFrameTimeStamps.size() / interval);
394 
395     auto mediaSample = makeRefPtr(&amp;sample);
396 
397 #if PLATFORM(COCOA)
<span class="line-modified">398     if (!isRemote()) {</span>
<span class="line-modified">399         auto size = this-&gt;size();</span>
<span class="line-modified">400         if (!size.isEmpty() &amp;&amp; size != expandedIntSize(sample.presentationSize())) {</span>
<span class="line-modified">401 </span>
<span class="line-modified">402             if (!m_imageTransferSession || m_imageTransferSession-&gt;pixelFormat() != sample.videoPixelFormat())</span>
<span class="line-modified">403                 m_imageTransferSession = ImageTransferSessionVT::create(sample.videoPixelFormat());</span>
<span class="line-modified">404 </span>
<span class="line-modified">405             if (m_imageTransferSession) {</span>
<span class="line-modified">406                 mediaSample = m_imageTransferSession-&gt;convertMediaSample(sample, size);</span>
<span class="line-modified">407                 if (!mediaSample) {</span>
<span class="line-modified">408                     ASSERT_NOT_REACHED();</span>
<span class="line-modified">409                     return nullptr;</span>
<span class="line-removed">410                 }</span>
411             }
412         }
413     }
414 #endif
415 
416     return mediaSample.releaseNonNull();
417 }
418 
419 void RealtimeVideoCaptureSource::dispatchMediaSampleToObservers(MediaSample&amp; sample)
420 {
421     if (auto mediaSample = adaptVideoSample(sample))
422         videoSampleAvailable(*mediaSample);
423 }
424 
425 void RealtimeVideoCaptureSource::clientUpdatedSizeAndFrameRate(Optional&lt;int&gt; width, Optional&lt;int&gt; height, Optional&lt;double&gt; frameRate)
426 {
427     // FIXME: We only change settings if capture resolution is below requested one. We should get the best preset for all clients.
428     auto&amp; settings = this-&gt;settings();
429     if (width &amp;&amp; *width &lt; static_cast&lt;int&gt;(settings.width()))
430         width = { };
</pre>
</td>
<td>
<hr />
<pre>
378 
379 RefPtr&lt;MediaSample&gt; RealtimeVideoCaptureSource::adaptVideoSample(MediaSample&amp; sample)
380 {
381     MediaTime sampleTime = sample.outputPresentationTime();
382     if (!sampleTime || !sampleTime.isValid())
383         sampleTime = sample.presentationTime();
384 
385     auto frameTime = sampleTime.toDouble();
386     m_observedFrameTimeStamps.append(frameTime);
387     m_observedFrameTimeStamps.removeAllMatching([&amp;](auto time) {
388         return time &lt;= frameTime - 2;
389     });
390 
391     auto interval = m_observedFrameTimeStamps.last() - m_observedFrameTimeStamps.first();
392     if (interval &gt; 1)
393         m_observedFrameRate = (m_observedFrameTimeStamps.size() / interval);
394 
395     auto mediaSample = makeRefPtr(&amp;sample);
396 
397 #if PLATFORM(COCOA)
<span class="line-modified">398     auto size = this-&gt;size();</span>
<span class="line-modified">399     if (!size.isEmpty() &amp;&amp; size != expandedIntSize(sample.presentationSize())) {</span>
<span class="line-modified">400 </span>
<span class="line-modified">401         if (!m_imageTransferSession || m_imageTransferSession-&gt;pixelFormat() != sample.videoPixelFormat())</span>
<span class="line-modified">402             m_imageTransferSession = ImageTransferSessionVT::create(sample.videoPixelFormat());</span>
<span class="line-modified">403 </span>
<span class="line-modified">404         ASSERT(m_imageTransferSession);</span>
<span class="line-modified">405         if (m_imageTransferSession) {</span>
<span class="line-modified">406             mediaSample = m_imageTransferSession-&gt;convertMediaSample(sample, size);</span>
<span class="line-modified">407             if (!mediaSample) {</span>
<span class="line-modified">408                 ASSERT_NOT_REACHED();</span>
<span class="line-modified">409                 return nullptr;</span>

410             }
411         }
412     }
413 #endif
414 
415     return mediaSample.releaseNonNull();
416 }
417 
418 void RealtimeVideoCaptureSource::dispatchMediaSampleToObservers(MediaSample&amp; sample)
419 {
420     if (auto mediaSample = adaptVideoSample(sample))
421         videoSampleAvailable(*mediaSample);
422 }
423 
424 void RealtimeVideoCaptureSource::clientUpdatedSizeAndFrameRate(Optional&lt;int&gt; width, Optional&lt;int&gt; height, Optional&lt;double&gt; frameRate)
425 {
426     // FIXME: We only change settings if capture resolution is below requested one. We should get the best preset for all clients.
427     auto&amp; settings = this-&gt;settings();
428     if (width &amp;&amp; *width &lt; static_cast&lt;int&gt;(settings.width()))
429         width = { };
</pre>
</td>
</tr>
</table>
<center><a href="RealtimeOutgoingVideoSource.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="RealtimeVideoSource.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>