<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/inspector/JSInjectedScriptHost.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSGlobalObjectScriptDebugServer.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSInjectedScriptHost.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/inspector/JSInjectedScriptHost.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 26 #include &quot;config.h&quot;
 27 #include &quot;JSInjectedScriptHost.h&quot;
 28 
 29 #include &quot;ArrayIteratorPrototype.h&quot;
 30 #include &quot;ArrayPrototype.h&quot;
 31 #include &quot;BuiltinNames.h&quot;
 32 #include &quot;Completion.h&quot;
 33 #include &quot;DateInstance.h&quot;
 34 #include &quot;DeferGC.h&quot;
 35 #include &quot;DirectArguments.h&quot;
 36 #include &quot;Error.h&quot;
 37 #include &quot;FunctionPrototype.h&quot;
 38 #include &quot;HeapAnalyzer.h&quot;
 39 #include &quot;HeapIterationScope.h&quot;
 40 #include &quot;HeapProfiler.h&quot;
 41 #include &quot;InjectedScriptHost.h&quot;
 42 #include &quot;IterationKind.h&quot;
 43 #include &quot;IteratorOperations.h&quot;
 44 #include &quot;IteratorPrototype.h&quot;
 45 #include &quot;JSArray.h&quot;

 46 #include &quot;JSBoundFunction.h&quot;
 47 #include &quot;JSCInlines.h&quot;
 48 #include &quot;JSFunction.h&quot;
 49 #include &quot;JSGlobalObjectFunctions.h&quot;
 50 #include &quot;JSInjectedScriptHostPrototype.h&quot;
 51 #include &quot;JSLock.h&quot;
 52 #include &quot;JSMap.h&quot;
 53 #include &quot;JSPromise.h&quot;
 54 #include &quot;JSPromisePrototype.h&quot;
 55 #include &quot;JSSet.h&quot;
 56 #include &quot;JSStringIterator.h&quot;
 57 #include &quot;JSTypedArrays.h&quot;
 58 #include &quot;JSWeakMap.h&quot;
 59 #include &quot;JSWeakSet.h&quot;
 60 #include &quot;JSWithScope.h&quot;
 61 #include &quot;MapIteratorPrototype.h&quot;
 62 #include &quot;MapPrototype.h&quot;
 63 #include &quot;MarkedSpaceInlines.h&quot;
 64 #include &quot;ObjectConstructor.h&quot;
 65 #include &quot;ObjectPrototype.h&quot;
 66 #include &quot;PreventCollectionScope.h&quot;
 67 #include &quot;ProxyObject.h&quot;
 68 #include &quot;RegExpObject.h&quot;
 69 #include &quot;ScopedArguments.h&quot;
 70 #include &quot;SetIteratorPrototype.h&quot;
 71 #include &quot;SetPrototype.h&quot;
 72 #include &quot;SourceCode.h&quot;
 73 #include &quot;TypedArrayInlines.h&quot;
 74 #include &lt;wtf/Function.h&gt;
 75 #include &lt;wtf/HashFunctions.h&gt;
 76 #include &lt;wtf/HashMap.h&gt;
 77 #include &lt;wtf/HashSet.h&gt;
 78 #include &lt;wtf/HashTraits.h&gt;
 79 #include &lt;wtf/Lock.h&gt;
 80 #include &lt;wtf/PrintStream.h&gt;
 81 #include &lt;wtf/text/StringConcatenate.h&gt;
 82 
<span class="line-removed"> 83 using namespace JSC;</span>
<span class="line-removed"> 84 </span>
 85 namespace Inspector {
 86 


 87 const ClassInfo JSInjectedScriptHost::s_info = { &quot;InjectedScriptHost&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSInjectedScriptHost) };
 88 
 89 JSInjectedScriptHost::JSInjectedScriptHost(VM&amp; vm, Structure* structure, Ref&lt;InjectedScriptHost&gt;&amp;&amp; impl)
 90     : JSDestructibleObject(vm, structure)
 91     , m_wrapped(WTFMove(impl))
 92 {
 93 }
 94 
 95 void JSInjectedScriptHost::finishCreation(VM&amp; vm)
 96 {
 97     Base::finishCreation(vm);
 98     ASSERT(inherits(vm, info()));
 99 }
100 
101 JSObject* JSInjectedScriptHost::createPrototype(VM&amp; vm, JSGlobalObject* globalObject)
102 {
103     return JSInjectedScriptHostPrototype::create(vm, globalObject, JSInjectedScriptHostPrototype::createStructure(vm, globalObject, globalObject-&gt;objectPrototype()));
104 }
105 
106 void JSInjectedScriptHost::destroy(JSC::JSCell* cell)
107 {
108     JSInjectedScriptHost* thisObject = static_cast&lt;JSInjectedScriptHost*&gt;(cell);
109     thisObject-&gt;JSInjectedScriptHost::~JSInjectedScriptHost();
110 }
111 
<span class="line-modified">112 JSValue JSInjectedScriptHost::evaluate(ExecState* exec) const</span>
113 {
<span class="line-removed">114     JSGlobalObject* globalObject = exec-&gt;lexicalGlobalObject();</span>
115     return globalObject-&gt;evalFunction();
116 }
117 
<span class="line-modified">118 JSValue JSInjectedScriptHost::savedResultAlias(ExecState* exec) const</span>
119 {
120     auto savedResultAlias = impl().savedResultAlias();
121     if (!savedResultAlias)
122         return jsUndefined();
<span class="line-modified">123     return jsString(exec-&gt;vm(), savedResultAlias.value());</span>
124 }
125 
<span class="line-modified">126 JSValue JSInjectedScriptHost::evaluateWithScopeExtension(ExecState* exec)</span>
127 {
<span class="line-modified">128     VM&amp; vm = exec-&gt;vm();</span>
129     auto scope = DECLARE_THROW_SCOPE(vm);
130 
<span class="line-modified">131     JSValue scriptValue = exec-&gt;argument(0);</span>
132     if (!scriptValue.isString())
<span class="line-modified">133         return throwTypeError(exec, scope, &quot;InjectedScriptHost.evaluateWithScopeExtension first argument must be a string.&quot;_s);</span>
134 
<span class="line-modified">135     String program = asString(scriptValue)-&gt;value(exec);</span>
136     RETURN_IF_EXCEPTION(scope, JSValue());
137 
138     NakedPtr&lt;Exception&gt; exception;
<span class="line-modified">139     JSObject* scopeExtension = exec-&gt;argument(1).getObject();</span>
<span class="line-modified">140     JSValue result = JSC::evaluateWithScopeExtension(exec, makeSource(program, exec-&gt;callerSourceOrigin()), scopeExtension, exception);</span>
141     if (exception)
<span class="line-modified">142         throwException(exec, scope, exception);</span>
143 
144     return result;
145 }
146 
<span class="line-modified">147 JSValue JSInjectedScriptHost::internalConstructorName(ExecState* exec)</span>
148 {
<span class="line-modified">149     if (exec-&gt;argumentCount() &lt; 1)</span>
150         return jsUndefined();
151 
<span class="line-modified">152     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-modified">153     JSObject* object = jsCast&lt;JSObject*&gt;(exec-&gt;uncheckedArgument(0).toThis(exec, NotStrictMode));</span>
154     return jsString(vm, JSObject::calculatedClassName(object));
155 }
156 
<span class="line-modified">157 JSValue JSInjectedScriptHost::isHTMLAllCollection(ExecState* exec)</span>
158 {
<span class="line-modified">159     if (exec-&gt;argumentCount() &lt; 1)</span>
160         return jsUndefined();
161 
<span class="line-modified">162     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-modified">163     JSValue value = exec-&gt;uncheckedArgument(0);</span>
164     return jsBoolean(impl().isHTMLAllCollection(vm, value));
165 }
166 
<span class="line-modified">167 JSValue JSInjectedScriptHost::isPromiseRejectedWithNativeGetterTypeError(ExecState* exec)</span>
168 {
<span class="line-modified">169     VM&amp; vm = exec-&gt;vm();</span>
170     auto scope = DECLARE_THROW_SCOPE(vm);
171 
<span class="line-modified">172     auto* promise = jsDynamicCast&lt;JSPromise*&gt;(vm, exec-&gt;argument(0));</span>
<span class="line-modified">173     if (!promise || promise-&gt;status(vm) != JSPromise::Status::Rejected)</span>
<span class="line-modified">174         return throwTypeError(exec, scope, &quot;InjectedScriptHost.isPromiseRejectedWithNativeGetterTypeError first argument must be a rejected Promise.&quot;_s);</span>
175 
176     bool result = false;
177     if (auto* errorInstance = jsDynamicCast&lt;ErrorInstance*&gt;(vm, promise-&gt;result(vm)))
178         result = errorInstance-&gt;isNativeGetterTypeError();
179     return jsBoolean(result);
180 }
181 
<span class="line-modified">182 JSValue JSInjectedScriptHost::subtype(ExecState* exec)</span>
183 {
<span class="line-modified">184     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-modified">185     if (exec-&gt;argumentCount() &lt; 1)</span>
186         return jsUndefined();
187 
<span class="line-modified">188     JSValue value = exec-&gt;uncheckedArgument(0);</span>
189     if (value.isString())
190         return vm.smallStrings.stringString();
191     if (value.isBoolean())
192         return vm.smallStrings.booleanString();
193     if (value.isNumber())
194         return vm.smallStrings.numberString();
195     if (value.isSymbol())
196         return vm.smallStrings.symbolString();
197 
198     if (auto* object = jsDynamicCast&lt;JSObject*&gt;(vm, value)) {
199         if (object-&gt;isErrorInstance())
200             return jsNontrivialString(vm, &quot;error&quot;_s);
201 
202         // Consider class constructor functions class objects.
203         JSFunction* function = jsDynamicCast&lt;JSFunction*&gt;(vm, value);
204         if (function &amp;&amp; function-&gt;isClassConstructorFunction())
205             return jsNontrivialString(vm, &quot;class&quot;_s);
206 
207         if (object-&gt;inherits&lt;JSArray&gt;(vm))
208             return jsNontrivialString(vm, &quot;array&quot;_s);
</pre>
<hr />
<pre>
211 
212         if (object-&gt;inherits&lt;DateInstance&gt;(vm))
213             return jsNontrivialString(vm, &quot;date&quot;_s);
214         if (object-&gt;inherits&lt;RegExpObject&gt;(vm))
215             return jsNontrivialString(vm, &quot;regexp&quot;_s);
216         if (object-&gt;inherits&lt;ProxyObject&gt;(vm))
217             return jsNontrivialString(vm, &quot;proxy&quot;_s);
218 
219         if (object-&gt;inherits&lt;JSMap&gt;(vm))
220             return jsNontrivialString(vm, &quot;map&quot;_s);
221         if (object-&gt;inherits&lt;JSSet&gt;(vm))
222             return jsNontrivialString(vm, &quot;set&quot;_s);
223         if (object-&gt;inherits&lt;JSWeakMap&gt;(vm))
224             return jsNontrivialString(vm, &quot;weakmap&quot;_s);
225         if (object-&gt;inherits&lt;JSWeakSet&gt;(vm))
226             return jsNontrivialString(vm, &quot;weakset&quot;_s);
227 
228         if (object-&gt;inherits&lt;JSStringIterator&gt;(vm))
229             return jsNontrivialString(vm, &quot;iterator&quot;_s);
230 
<span class="line-modified">231         if (object-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().arrayIteratorNextIndexPrivateName())</span>
232             || object-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().mapBucketPrivateName())
233             || object-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().setBucketPrivateName()))
234             return jsNontrivialString(vm, &quot;iterator&quot;_s);
235 
236         if (object-&gt;inherits&lt;JSInt8Array&gt;(vm)
237             || object-&gt;inherits&lt;JSInt16Array&gt;(vm)
238             || object-&gt;inherits&lt;JSInt32Array&gt;(vm)
239             || object-&gt;inherits&lt;JSUint8Array&gt;(vm)
240             || object-&gt;inherits&lt;JSUint8ClampedArray&gt;(vm)
241             || object-&gt;inherits&lt;JSUint16Array&gt;(vm)
242             || object-&gt;inherits&lt;JSUint32Array&gt;(vm)
243             || object-&gt;inherits&lt;JSFloat32Array&gt;(vm)
244             || object-&gt;inherits&lt;JSFloat64Array&gt;(vm))
245             return jsNontrivialString(vm, &quot;array&quot;_s);
246     }
247 
<span class="line-modified">248     return impl().subtype(exec, value);</span>
249 }
250 
<span class="line-modified">251 JSValue JSInjectedScriptHost::functionDetails(ExecState* exec)</span>
252 {
<span class="line-modified">253     if (exec-&gt;argumentCount() &lt; 1)</span>
254         return jsUndefined();
255 
<span class="line-modified">256     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-modified">257     JSValue value = exec-&gt;uncheckedArgument(0);</span>
258     auto* function = jsDynamicCast&lt;JSFunction*&gt;(vm, value);
259     if (!function)
260         return jsUndefined();
261 
262     // FIXME: &lt;https://webkit.org/b/87192&gt; Web Inspector: Expose function scope / closure data
263 
264     // FIXME: This should provide better details for JSBoundFunctions.
265 
266     const SourceCode* sourceCode = function-&gt;sourceCode();
267     if (!sourceCode)
268         return jsUndefined();
269 
270     // In the inspector protocol all positions are 0-based while in SourceCode they are 1-based
271     int lineNumber = sourceCode-&gt;firstLine().oneBasedInt();
272     if (lineNumber)
273         lineNumber -= 1;
274     int columnNumber = sourceCode-&gt;startColumn().oneBasedInt();
275     if (columnNumber)
276         columnNumber -= 1;
277 
278     String scriptID = String::number(sourceCode-&gt;provider()-&gt;asID());
<span class="line-modified">279     JSObject* location = constructEmptyObject(exec);</span>
280     location-&gt;putDirect(vm, Identifier::fromString(vm, &quot;scriptId&quot;), jsString(vm, scriptID));
281     location-&gt;putDirect(vm, Identifier::fromString(vm, &quot;lineNumber&quot;), jsNumber(lineNumber));
282     location-&gt;putDirect(vm, Identifier::fromString(vm, &quot;columnNumber&quot;), jsNumber(columnNumber));
283 
<span class="line-modified">284     JSObject* result = constructEmptyObject(exec);</span>
285     result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;location&quot;), location);
286 
287     String name = function-&gt;name(vm);
288     if (!name.isEmpty())
289         result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;name&quot;), jsString(vm, name));
290 
291     String displayName = function-&gt;displayName(vm);
292     if (!displayName.isEmpty())
293         result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;displayName&quot;), jsString(vm, displayName));
294 
295     return result;
296 }
297 
<span class="line-modified">298 static JSObject* constructInternalProperty(ExecState* exec, const String&amp; name, JSValue value)</span>
299 {
<span class="line-modified">300     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-modified">301     JSObject* result = constructEmptyObject(exec);</span>
302     result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;name&quot;), jsString(vm, name));
303     result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;value&quot;), value);
304     return result;
305 }
306 
<span class="line-modified">307 JSValue JSInjectedScriptHost::getInternalProperties(ExecState* exec)</span>
308 {
<span class="line-modified">309     if (exec-&gt;argumentCount() &lt; 1)</span>
310         return jsUndefined();
311 
<span class="line-modified">312     VM&amp; vm = exec-&gt;vm();</span>
313     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">314     JSValue value = exec-&gt;uncheckedArgument(0);</span>
315 
<span class="line-modified">316     JSValue internalProperties = impl().getInternalProperties(vm, exec, value);</span>
317     if (internalProperties)
318         return internalProperties;
319 
320     if (JSPromise* promise = jsDynamicCast&lt;JSPromise*&gt;(vm, value)) {
321         unsigned index = 0;
<span class="line-modified">322         JSArray* array = constructEmptyArray(exec, nullptr);</span>
323         RETURN_IF_EXCEPTION(scope, JSValue());
324         switch (promise-&gt;status(vm)) {
325         case JSPromise::Status::Pending:
326             scope.release();
<span class="line-modified">327             array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;status&quot;_s, jsNontrivialString(vm, &quot;pending&quot;_s)));</span>
328             return array;
329         case JSPromise::Status::Fulfilled:
<span class="line-modified">330             array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;status&quot;_s, jsNontrivialString(vm, &quot;resolved&quot;_s)));</span>
331             RETURN_IF_EXCEPTION(scope, JSValue());
332             scope.release();
<span class="line-modified">333             array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;result&quot;_s, promise-&gt;result(vm)));</span>
334             return array;
335         case JSPromise::Status::Rejected:
<span class="line-modified">336             array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;status&quot;_s, jsNontrivialString(vm, &quot;rejected&quot;_s)));</span>
337             RETURN_IF_EXCEPTION(scope, JSValue());
338             scope.release();
<span class="line-modified">339             array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;result&quot;_s, promise-&gt;result(vm)));</span>
340             return array;
341         }
342         // FIXME: &lt;https://webkit.org/b/141664&gt; Web Inspector: ES6: Improved Support for Promises - Promise Reactions
343         RELEASE_ASSERT_NOT_REACHED();
344     }
345 
346     if (JSBoundFunction* boundFunction = jsDynamicCast&lt;JSBoundFunction*&gt;(vm, value)) {
347         unsigned index = 0;
<span class="line-modified">348         JSArray* array = constructEmptyArray(exec, nullptr);</span>
349         RETURN_IF_EXCEPTION(scope, JSValue());
<span class="line-modified">350         array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;targetFunction&quot;, boundFunction-&gt;targetFunction()));</span>
351         RETURN_IF_EXCEPTION(scope, JSValue());
<span class="line-modified">352         array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;boundThis&quot;, boundFunction-&gt;boundThis()));</span>
353         RETURN_IF_EXCEPTION(scope, JSValue());
354         if (boundFunction-&gt;boundArgs()) {
355             scope.release();
<span class="line-modified">356             array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;boundArgs&quot;, boundFunction-&gt;boundArgsCopy(exec)));</span>
357             return array;
358         }
359         return array;
360     }
361 
362     if (ProxyObject* proxy = jsDynamicCast&lt;ProxyObject*&gt;(vm, value)) {
363         unsigned index = 0;
<span class="line-modified">364         JSArray* array = constructEmptyArray(exec, nullptr, 2);</span>
365         RETURN_IF_EXCEPTION(scope, JSValue());
<span class="line-modified">366         array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;target&quot;_s, proxy-&gt;target()));</span>
367         RETURN_IF_EXCEPTION(scope, JSValue());
368         scope.release();
<span class="line-modified">369         array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;handler&quot;_s, proxy-&gt;handler()));</span>
370         return array;
371     }
372 
373     if (JSObject* iteratorObject = jsDynamicCast&lt;JSObject*&gt;(vm, value)) {
<span class="line-modified">374         if (iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().arrayIteratorNextIndexPrivateName())) {</span>
<span class="line-modified">375             JSValue iteratedValue = iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().iteratedObjectPrivateName());</span>
<span class="line-modified">376             JSValue kind = iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().arrayIteratorKindPrivateName());</span>












377 
378             unsigned index = 0;
<span class="line-modified">379             JSArray* array = constructEmptyArray(exec, nullptr, 2);</span>
380             RETURN_IF_EXCEPTION(scope, JSValue());
<span class="line-modified">381             array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;array&quot;, iteratedValue));</span>
382             RETURN_IF_EXCEPTION(scope, JSValue());
383             scope.release();
<span class="line-modified">384             array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;kind&quot;, kind));</span>
385             return array;
386         }
387 
388         if (iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().mapBucketPrivateName())) {
389             JSValue iteratedValue = iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().iteratedObjectPrivateName());
<span class="line-modified">390             String kind;</span>
<span class="line-modified">391             switch (static_cast&lt;IterationKind&gt;(iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().mapIteratorKindPrivateName()).asInt32())) {</span>
<span class="line-removed">392             case IterateKey:</span>
<span class="line-removed">393                 kind = &quot;key&quot;_s;</span>
<span class="line-removed">394                 break;</span>
<span class="line-removed">395             case IterateValue:</span>
<span class="line-removed">396                 kind = &quot;value&quot;_s;</span>
<span class="line-removed">397                 break;</span>
<span class="line-removed">398             case IterateKeyValue:</span>
<span class="line-removed">399                 kind = &quot;key+value&quot;_s;</span>
<span class="line-removed">400                 break;</span>
<span class="line-removed">401             }</span>
402             unsigned index = 0;
<span class="line-modified">403             JSArray* array = constructEmptyArray(exec, nullptr, 2);</span>
404             RETURN_IF_EXCEPTION(scope, JSValue());
<span class="line-modified">405             array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;map&quot;, iteratedValue));</span>
406             RETURN_IF_EXCEPTION(scope, JSValue());
407             scope.release();
<span class="line-modified">408             array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;kind&quot;, jsNontrivialString(vm, kind)));</span>
409             return array;
410         }
411 
412         if (iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().setBucketPrivateName())) {
413             JSValue iteratedValue = iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().iteratedObjectPrivateName());
<span class="line-modified">414             String kind;</span>
<span class="line-modified">415             switch (static_cast&lt;IterationKind&gt;(iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().setIteratorKindPrivateName()).asInt32())) {</span>
<span class="line-removed">416             case IterateKey:</span>
<span class="line-removed">417                 kind = &quot;key&quot;_s;</span>
<span class="line-removed">418                 break;</span>
<span class="line-removed">419             case IterateValue:</span>
<span class="line-removed">420                 kind = &quot;value&quot;_s;</span>
<span class="line-removed">421                 break;</span>
<span class="line-removed">422             case IterateKeyValue:</span>
<span class="line-removed">423                 kind = &quot;key+value&quot;_s;</span>
<span class="line-removed">424                 break;</span>
<span class="line-removed">425             }</span>
426             unsigned index = 0;
<span class="line-modified">427             JSArray* array = constructEmptyArray(exec, nullptr, 2);</span>
428             RETURN_IF_EXCEPTION(scope, JSValue());
<span class="line-modified">429             array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;set&quot;, iteratedValue));</span>
430             RETURN_IF_EXCEPTION(scope, JSValue());
431             scope.release();
<span class="line-modified">432             array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;kind&quot;, jsNontrivialString(vm, kind)));</span>
433             return array;
434         }
435     }
436 
437     if (JSStringIterator* stringIterator = jsDynamicCast&lt;JSStringIterator*&gt;(vm, value)) {
438         unsigned index = 0;
<span class="line-modified">439         JSArray* array = constructEmptyArray(exec, nullptr, 1);</span>
440         RETURN_IF_EXCEPTION(scope, JSValue());
441         scope.release();
<span class="line-modified">442         array-&gt;putDirectIndex(exec, index++, constructInternalProperty(exec, &quot;string&quot;, stringIterator-&gt;iteratedValue(exec)));</span>
443         return array;
444     }
445 
446     return jsUndefined();
447 }
448 
<span class="line-modified">449 JSValue JSInjectedScriptHost::proxyTargetValue(ExecState *exec)</span>
450 {
<span class="line-modified">451     if (exec-&gt;argumentCount() &lt; 1)</span>
452         return jsUndefined();
453 
<span class="line-modified">454     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-removed">455     JSValue value = exec-&gt;uncheckedArgument(0);</span>
456     ProxyObject* proxy = jsDynamicCast&lt;ProxyObject*&gt;(vm, value);
457     if (!proxy)
458         return jsUndefined();
459 
460     JSObject* target = proxy-&gt;target();
461     while (ProxyObject* proxy = jsDynamicCast&lt;ProxyObject*&gt;(vm, target))
462         target = proxy-&gt;target();
463 
464     return target;
465 }
466 
<span class="line-modified">467 JSValue JSInjectedScriptHost::weakMapSize(ExecState* exec)</span>
468 {
<span class="line-modified">469     if (exec-&gt;argumentCount() &lt; 1)</span>
470         return jsUndefined();
471 
<span class="line-modified">472     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-modified">473     JSValue value = exec-&gt;uncheckedArgument(0);</span>
474     JSWeakMap* weakMap = jsDynamicCast&lt;JSWeakMap*&gt;(vm, value);
475     if (!weakMap)
476         return jsUndefined();
477 
478     return jsNumber(weakMap-&gt;size());
479 }
480 
<span class="line-modified">481 JSValue JSInjectedScriptHost::weakMapEntries(ExecState* exec)</span>
482 {
<span class="line-modified">483     if (exec-&gt;argumentCount() &lt; 1)</span>
484         return jsUndefined();
485 
<span class="line-modified">486     VM&amp; vm = exec-&gt;vm();</span>
487     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">488     JSValue value = exec-&gt;uncheckedArgument(0);</span>
<span class="line-removed">489     JSWeakMap* weakMap = jsDynamicCast&lt;JSWeakMap*&gt;(vm, value);</span>
490     if (!weakMap)
491         return jsUndefined();
492 
<span class="line-modified">493     unsigned numberToFetch = 100;</span>
<span class="line-modified">494 </span>
<span class="line-modified">495     JSValue numberToFetchArg = exec-&gt;argument(1);</span>
<span class="line-modified">496     double fetchDouble = numberToFetchArg.toInteger(exec);</span>
<span class="line-removed">497     if (fetchDouble &gt;= 0)</span>
<span class="line-removed">498         numberToFetch = static_cast&lt;unsigned&gt;(fetchDouble);</span>
499 
<span class="line-modified">500     JSArray* array = constructEmptyArray(exec, nullptr);</span>
501     RETURN_IF_EXCEPTION(scope, JSValue());
502 
<span class="line-removed">503     MarkedArgumentBuffer buffer;</span>
<span class="line-removed">504     weakMap-&gt;takeSnapshot(buffer, numberToFetch);</span>
<span class="line-removed">505 </span>
506     for (unsigned index = 0; index &lt; buffer.size(); index += 2) {
<span class="line-modified">507         JSObject* entry = constructEmptyObject(exec);</span>
508         entry-&gt;putDirect(vm, Identifier::fromString(vm, &quot;key&quot;), buffer.at(index));
509         entry-&gt;putDirect(vm, Identifier::fromString(vm, &quot;value&quot;), buffer.at(index + 1));
<span class="line-modified">510         array-&gt;putDirectIndex(exec, index / 2, entry);</span>
511         RETURN_IF_EXCEPTION(scope, JSValue());
512     }
513 
514     return array;
515 }
516 
<span class="line-modified">517 JSValue JSInjectedScriptHost::weakSetSize(ExecState* exec)</span>
518 {
<span class="line-modified">519     if (exec-&gt;argumentCount() &lt; 1)</span>
520         return jsUndefined();
521 
<span class="line-modified">522     VM&amp; vm = exec-&gt;vm();</span>
<span class="line-modified">523     JSValue value = exec-&gt;uncheckedArgument(0);</span>
524     JSWeakSet* weakSet = jsDynamicCast&lt;JSWeakSet*&gt;(vm, value);
525     if (!weakSet)
526         return jsUndefined();
527 
528     return jsNumber(weakSet-&gt;size());
529 }
530 
<span class="line-modified">531 JSValue JSInjectedScriptHost::weakSetEntries(ExecState* exec)</span>
532 {
<span class="line-modified">533     if (exec-&gt;argumentCount() &lt; 1)</span>
534         return jsUndefined();
535 
<span class="line-modified">536     VM&amp; vm = exec-&gt;vm();</span>
537     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">538     JSValue value = exec-&gt;uncheckedArgument(0);</span>
<span class="line-removed">539     JSWeakSet* weakSet = jsDynamicCast&lt;JSWeakSet*&gt;(vm, value);</span>
540     if (!weakSet)
541         return jsUndefined();
542 
<span class="line-modified">543     unsigned numberToFetch = 100;</span>
<span class="line-modified">544 </span>
<span class="line-modified">545     JSValue numberToFetchArg = exec-&gt;argument(1);</span>
<span class="line-modified">546     double fetchDouble = numberToFetchArg.toInteger(exec);</span>
<span class="line-removed">547     if (fetchDouble &gt;= 0)</span>
<span class="line-removed">548         numberToFetch = static_cast&lt;unsigned&gt;(fetchDouble);</span>
549 
<span class="line-modified">550     JSArray* array = constructEmptyArray(exec, nullptr);</span>
551     RETURN_IF_EXCEPTION(scope, JSValue());
552 
<span class="line-removed">553     MarkedArgumentBuffer buffer;</span>
<span class="line-removed">554     weakSet-&gt;takeSnapshot(buffer, numberToFetch);</span>
<span class="line-removed">555 </span>
556     for (unsigned index = 0; index &lt; buffer.size(); ++index) {
<span class="line-modified">557         JSObject* entry = constructEmptyObject(exec);</span>
558         entry-&gt;putDirect(vm, Identifier::fromString(vm, &quot;value&quot;), buffer.at(index));
<span class="line-modified">559         array-&gt;putDirectIndex(exec, index, entry);</span>
560         RETURN_IF_EXCEPTION(scope, JSValue());
561     }
562 
563     return array;
564 }
565 
<span class="line-modified">566 static JSObject* cloneArrayIteratorObject(ExecState* exec, VM&amp; vm, JSObject* iteratorObject, JSGlobalObject* globalObject, JSValue nextIndex, JSValue iteratedObject)</span>
567 {
<span class="line-modified">568     ASSERT(iteratorObject-&gt;type() == FinalObjectType);</span>
<span class="line-modified">569     JSObject* clone = constructEmptyObject(exec, ArrayIteratorPrototype::create(vm, globalObject, ArrayIteratorPrototype::createStructure(vm, globalObject, globalObject-&gt;iteratorPrototype())));</span>
<span class="line-removed">570     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().iteratedObjectPrivateName(), iteratedObject);</span>
<span class="line-removed">571     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().arrayIteratorKindPrivateName(), iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().arrayIteratorKindPrivateName()));</span>
<span class="line-removed">572     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().arrayIteratorNextIndexPrivateName(), nextIndex);</span>
<span class="line-removed">573     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().arrayIteratorNextPrivateName(), iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().arrayIteratorNextPrivateName()));</span>
<span class="line-removed">574     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().arrayIteratorIsDonePrivateName(), iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().arrayIteratorIsDonePrivateName()));</span>
575     return clone;
576 }
577 
<span class="line-modified">578 static JSObject* cloneMapIteratorObject(ExecState* exec, VM&amp; vm, JSObject* iteratorObject, JSGlobalObject* globalObject, JSValue mapBucket, JSValue iteratedObject)</span>
579 {
580     ASSERT(iteratorObject-&gt;type() == FinalObjectType);
<span class="line-modified">581     JSObject* clone = constructEmptyObject(exec, MapIteratorPrototype::create(vm, globalObject, MapIteratorPrototype::createStructure(vm, globalObject, globalObject-&gt;iteratorPrototype())));</span>
582     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().iteratedObjectPrivateName(), iteratedObject);
583     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().mapIteratorKindPrivateName(), iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().mapIteratorKindPrivateName()));
584     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().mapBucketPrivateName(), mapBucket);
585     return clone;
586 }
587 
<span class="line-modified">588 static JSObject* cloneSetIteratorObject(ExecState* exec, VM&amp; vm, JSObject* iteratorObject, JSGlobalObject* globalObject, JSValue setBucket, JSValue iteratedObject)</span>
589 {
590     ASSERT(iteratorObject-&gt;type() == FinalObjectType);
<span class="line-modified">591     JSObject* clone = constructEmptyObject(exec, SetIteratorPrototype::create(vm, globalObject, SetIteratorPrototype::createStructure(vm, globalObject, globalObject-&gt;iteratorPrototype())));</span>
592     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().iteratedObjectPrivateName(), iteratedObject);
593     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().setIteratorKindPrivateName(), iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().setIteratorKindPrivateName()));
594     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().setBucketPrivateName(), setBucket);
595     return clone;
596 }
597 
<span class="line-modified">598 JSValue JSInjectedScriptHost::iteratorEntries(ExecState* exec)</span>
599 {
<span class="line-modified">600     if (exec-&gt;argumentCount() &lt; 1)</span>
601         return jsUndefined();
602 
<span class="line-modified">603     VM&amp; vm = exec-&gt;vm();</span>
604     auto scope = DECLARE_THROW_SCOPE(vm);
605 
606     JSValue iterator;
<span class="line-modified">607     JSGlobalObject* globalObject = exec-&gt;lexicalGlobalObject();</span>
<span class="line-removed">608     JSValue value = exec-&gt;uncheckedArgument(0);</span>
609     if (JSStringIterator* stringIterator = jsDynamicCast&lt;JSStringIterator*&gt;(vm, value)) {
610         if (globalObject-&gt;isStringPrototypeIteratorProtocolFastAndNonObservable())
<span class="line-modified">611             iterator = stringIterator-&gt;clone(exec);</span>
612     } else if (JSObject* iteratorObject = jsDynamicCast&lt;JSObject*&gt;(vm, value)) {
<span class="line-modified">613         // Detect an ArrayIterator by checking for one of its unique private properties.</span>
<span class="line-modified">614         JSValue iteratedObject = iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().iteratedObjectPrivateName());</span>
<span class="line-removed">615         if (JSValue nextIndex = iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().arrayIteratorNextIndexPrivateName())) {</span>
616             if (isJSArray(iteratedObject)) {
617                 JSArray* array = jsCast&lt;JSArray*&gt;(iteratedObject);
618                 if (array-&gt;isIteratorProtocolFastAndNonObservable())
<span class="line-modified">619                     iterator = cloneArrayIteratorObject(exec, vm, iteratorObject, globalObject, nextIndex, iteratedObject);</span>
<span class="line-modified">620             } else if (iteratedObject.isObject() &amp;&amp; TypeInfo::isArgumentsType(asObject(iteratedObject)-&gt;type())) {</span>
621                 if (globalObject-&gt;isArrayPrototypeIteratorProtocolFastAndNonObservable())
<span class="line-modified">622                     iterator = cloneArrayIteratorObject(exec, vm, iteratorObject, globalObject, nextIndex, iteratedObject);</span>









623             }
<span class="line-removed">624         } else if (JSValue mapBucket = iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().mapBucketPrivateName())) {</span>
<span class="line-removed">625             if (jsCast&lt;JSMap*&gt;(iteratedObject)-&gt;isIteratorProtocolFastAndNonObservable())</span>
<span class="line-removed">626                 iterator = cloneMapIteratorObject(exec, vm, iteratorObject, globalObject, mapBucket, iteratedObject);</span>
<span class="line-removed">627         } else if (JSValue setBucket = iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().setBucketPrivateName())) {</span>
<span class="line-removed">628             if (jsCast&lt;JSSet*&gt;(iteratedObject)-&gt;isIteratorProtocolFastAndNonObservable())</span>
<span class="line-removed">629                 iterator = cloneSetIteratorObject(exec, vm, iteratorObject, globalObject, setBucket, iteratedObject);</span>
630         }
631     }
632     RETURN_IF_EXCEPTION(scope, { });
633     if (!iterator)
634         return jsUndefined();
635 
<span class="line-modified">636     IterationRecord iterationRecord = { iterator, iterator.get(exec, vm.propertyNames-&gt;next) };</span>
637 
638     unsigned numberToFetch = 5;
<span class="line-modified">639     JSValue numberToFetchArg = exec-&gt;argument(1);</span>
<span class="line-modified">640     double fetchDouble = numberToFetchArg.toInteger(exec);</span>
641     RETURN_IF_EXCEPTION(scope, { });
642     if (fetchDouble &gt;= 0)
643         numberToFetch = static_cast&lt;unsigned&gt;(fetchDouble);
644 
<span class="line-modified">645     JSArray* array = constructEmptyArray(exec, nullptr);</span>
646     RETURN_IF_EXCEPTION(scope, { });
647 
648     for (unsigned i = 0; i &lt; numberToFetch; ++i) {
<span class="line-modified">649         JSValue next = iteratorStep(exec, iterationRecord);</span>
650         if (UNLIKELY(scope.exception()) || next.isFalse())
651             break;
652 
<span class="line-modified">653         JSValue nextValue = iteratorValue(exec, next);</span>
654         RETURN_IF_EXCEPTION(scope, { });
655 
<span class="line-modified">656         JSObject* entry = constructEmptyObject(exec);</span>
657         entry-&gt;putDirect(vm, Identifier::fromString(vm, &quot;value&quot;), nextValue);
<span class="line-modified">658         array-&gt;putDirectIndex(exec, i, entry);</span>
659         if (UNLIKELY(scope.exception())) {
660             scope.release();
<span class="line-modified">661             iteratorClose(exec, iterationRecord);</span>
662             break;
663         }
664     }
665 
666     return array;
667 }
668 
<span class="line-modified">669 static bool checkForbiddenPrototype(ExecState* exec, JSValue value, JSValue proto)</span>
670 {
671     if (value == proto)
672         return true;
673 
674     // Check that the prototype chain of proto hasn&#39;t been modified to include value.
<span class="line-modified">675     return JSObject::defaultHasInstance(exec, proto, value);</span>
676 }
677 
<span class="line-modified">678 JSValue JSInjectedScriptHost::queryInstances(ExecState* exec)</span>
679 {
<span class="line-modified">680     if (exec-&gt;argumentCount() &lt; 1)</span>
681         return jsUndefined();
682 
<span class="line-modified">683     VM&amp; vm = exec-&gt;vm();</span>
684     auto scope = DECLARE_THROW_SCOPE(vm);
685 
<span class="line-modified">686     JSValue prototypeOrConstructor = exec-&gt;uncheckedArgument(0);</span>
687     if (!prototypeOrConstructor.isObject())
<span class="line-modified">688         return throwTypeError(exec, scope, &quot;queryInstances first argument must be an object.&quot;_s);</span>
689 
690     JSObject* object = asObject(prototypeOrConstructor);
691     if (object-&gt;inherits&lt;ProxyObject&gt;(vm))
<span class="line-modified">692         return throwTypeError(exec, scope, &quot;queryInstances cannot be called with a Proxy.&quot;_s);</span>
693 
694     JSValue prototype = object;
695 
696     PropertySlot prototypeSlot(object, PropertySlot::InternalMethodType::VMInquiry);
<span class="line-modified">697     if (object-&gt;getPropertySlot(exec, vm.propertyNames-&gt;prototype, prototypeSlot)) {</span>
698         RETURN_IF_EXCEPTION(scope, { });
699         if (prototypeSlot.isValue()) {
<span class="line-modified">700             JSValue prototypeValue = prototypeSlot.getValue(exec, vm.propertyNames-&gt;prototype);</span>
701             if (prototypeValue.isObject()) {
702                 prototype = prototypeValue;
703                 object = asObject(prototype);
704             }
705         }
706     }
707 
708     if (object-&gt;inherits&lt;ProxyObject&gt;(vm) || prototype.inherits&lt;ProxyObject&gt;(vm))
<span class="line-modified">709         return throwTypeError(exec, scope, &quot;queryInstances cannot be called with a Proxy.&quot;_s);</span>
710 
711     // FIXME: implement a way of distinguishing between internal and user-created objects.
<span class="line-modified">712     JSGlobalObject* lexicalGlobalObject = exec-&gt;lexicalGlobalObject();</span>
<span class="line-modified">713     if (checkForbiddenPrototype(exec, object, lexicalGlobalObject-&gt;objectPrototype()))</span>
<span class="line-modified">714         return throwTypeError(exec, scope, &quot;queryInstances cannot be called with Object.&quot;_s);</span>
<span class="line-modified">715     if (checkForbiddenPrototype(exec, object, lexicalGlobalObject-&gt;functionPrototype()))</span>
<span class="line-modified">716         return throwTypeError(exec, scope, &quot;queryInstances cannot be called with Function.&quot;_s);</span>
<span class="line-modified">717     if (checkForbiddenPrototype(exec, object, lexicalGlobalObject-&gt;arrayPrototype()))</span>
<span class="line-modified">718         return throwTypeError(exec, scope, &quot;queryInstances cannot be called with Array.&quot;_s);</span>
<span class="line-modified">719     if (checkForbiddenPrototype(exec, object, lexicalGlobalObject-&gt;mapPrototype()))</span>
<span class="line-modified">720         return throwTypeError(exec, scope, &quot;queryInstances cannot be called with Map.&quot;_s);</span>
<span class="line-modified">721     if (checkForbiddenPrototype(exec, object, lexicalGlobalObject-&gt;jsSetPrototype()))</span>
<span class="line-modified">722         return throwTypeError(exec, scope, &quot;queryInstances cannot be called with Set.&quot;_s);</span>
<span class="line-modified">723     if (checkForbiddenPrototype(exec, object, lexicalGlobalObject-&gt;promisePrototype()))</span>
<span class="line-removed">724         return throwTypeError(exec, scope, &quot;queryInstances cannot be called with Promise.&quot;_s);</span>
725 
726     sanitizeStackForVM(vm);
727     vm.heap.collectNow(Sync, CollectionScope::Full);
728 
<span class="line-modified">729     JSArray* array = constructEmptyArray(exec, nullptr);</span>
730     RETURN_IF_EXCEPTION(scope, { });
731 
732     {
733         HeapIterationScope iterationScope(vm.heap);
734         vm.heap.objectSpace().forEachLiveCell(iterationScope, [&amp;] (HeapCell* cell, HeapCell::Kind kind) {
735             if (!isJSCellKind(kind))
736                 return IterationStatus::Continue;
737 
738             JSValue value(static_cast&lt;JSCell*&gt;(cell));
739             if (value.inherits&lt;ProxyObject&gt;(vm))
740                 return IterationStatus::Continue;
741 
<span class="line-modified">742             if (JSObject::defaultHasInstance(exec, value, prototype))</span>
<span class="line-modified">743                 array-&gt;putDirectIndex(exec, array-&gt;length(), value);</span>
744 
745             return IterationStatus::Continue;
746         });
747     }
748 
749     return array;
750 }
751 
752 class HeapHolderFinder final : public HeapAnalyzer {
753     WTF_MAKE_FAST_ALLOCATED;
754 public:
755     HeapHolderFinder(HeapProfiler&amp; profiler, JSCell* target)
756         : HeapAnalyzer()
757         , m_target(target)
758     {
759         ASSERT(!profiler.activeHeapAnalyzer());
760         profiler.setActiveHeapAnalyzer(this);
761         profiler.vm().heap.collectNow(Sync, CollectionScope::Full);
762         profiler.setActiveHeapAnalyzer(nullptr);
763 
</pre>
<hr />
<pre>
781             queue.add(holder);
782         while (auto* holder = queue.takeAny()) {
783             if (holder-&gt;isObject())
784                 continue;
785 
786             for (auto* from : m_predecessors.get(holder)) {
787                 if (!m_holders.contains(from)) {
788                     m_holders.add(from);
789                     queue.add(from);
790                 }
791             }
792         }
793 
794         m_holders.removeIf([&amp;] (auto* holder) {
795             return !holder-&gt;isObject() || !visited.contains(holder);
796         });
797     }
798 
799     HashSet&lt;JSCell*&gt;&amp; holders() { return m_holders; }
800 
<span class="line-modified">801     void analyzeEdge(JSCell* from, JSCell* to, SlotVisitor::RootMarkReason reason)</span>
802     {
803         ASSERT(to);
804         ASSERT(to-&gt;vm().heapProfiler()-&gt;activeHeapAnalyzer() == this);
805 
806         auto locker = holdLock(m_mutex);
807 
808         if (from &amp;&amp; from != to) {
809             m_successors.ensure(from, [] {
810                 return HashSet&lt;JSCell*&gt;();
811             }).iterator-&gt;value.add(to);
812 
813             m_predecessors.ensure(to, [] {
814                 return HashSet&lt;JSCell*&gt;();
815             }).iterator-&gt;value.add(from);
816 
817             if (to == m_target)
818                 m_holders.add(from);
819         }
820 
821         if (reason == SlotVisitor::RootMarkReason::Debugger)
822             m_rootsToIgnore.add(to);
823         else if (!from || reason != SlotVisitor::RootMarkReason::None)
824             m_rootsToInclude.add(to);
825     }
<span class="line-modified">826     void analyzePropertyNameEdge(JSCell* from, JSCell* to, UniquedStringImpl*) { analyzeEdge(from, to, SlotVisitor::RootMarkReason::None); }</span>
<span class="line-modified">827     void analyzeVariableNameEdge(JSCell* from, JSCell* to, UniquedStringImpl*) { analyzeEdge(from, to, SlotVisitor::RootMarkReason::None); }</span>
<span class="line-modified">828     void analyzeIndexEdge(JSCell* from, JSCell* to, uint32_t) { analyzeEdge(from, to, SlotVisitor::RootMarkReason::None); }</span>
829 
<span class="line-modified">830     void analyzeNode(JSCell*) { }</span>
<span class="line-modified">831     void setOpaqueRootReachabilityReasonForCell(JSCell*, const char*) { }</span>
<span class="line-modified">832     void setWrappedObjectForCell(JSCell*, void*) { }</span>
<span class="line-modified">833     void setLabelForCell(JSCell*, const String&amp;) { }</span>
834 
835 #ifndef NDEBUG
836     void dump(PrintStream&amp; out) const
837     {
838         Indentation&lt;4&gt; indent;
839 
840         HashSet&lt;JSCell*&gt; visited;
841 
842         Function&lt;void(JSCell*)&gt; visit = [&amp;] (auto* from) {
843             auto isFirstVisit = visited.add(from).isNewEntry;
844 
845             out.print(makeString(indent));
846 
847             out.print(&quot;[ &quot;_s);
848             if (from == m_target)
849                 out.print(&quot;T &quot;_s);
850             if (m_holders.contains(from))
851                 out.print(&quot;H &quot;_s);
852             if (m_rootsToIgnore.contains(from))
853                 out.print(&quot;- &quot;_s);
</pre>
<hr />
<pre>
866                 for (auto* to : m_successors.get(from))
867                     visit(to);
868             }
869         };
870 
871         for (auto* from : m_rootsToInclude)
872             visit(from);
873     }
874 #endif
875 
876 private:
877     Lock m_mutex;
878     HashMap&lt;JSCell*, HashSet&lt;JSCell*&gt;&gt; m_predecessors;
879     HashMap&lt;JSCell*, HashSet&lt;JSCell*&gt;&gt; m_successors;
880     HashSet&lt;JSCell*&gt; m_rootsToInclude;
881     HashSet&lt;JSCell*&gt; m_rootsToIgnore;
882     HashSet&lt;JSCell*&gt; m_holders;
883     const JSCell* m_target;
884 };
885 
<span class="line-modified">886 JSValue JSInjectedScriptHost::queryHolders(ExecState* exec)</span>
887 {
<span class="line-modified">888     if (exec-&gt;argumentCount() &lt; 1)</span>
889         return jsUndefined();
890 
<span class="line-modified">891     VM&amp; vm = exec-&gt;vm();</span>
892     auto scope = DECLARE_THROW_SCOPE(vm);
893 
<span class="line-modified">894     JSValue target = exec-&gt;uncheckedArgument(0);</span>
895     if (!target.isObject())
<span class="line-modified">896         return throwTypeError(exec, scope, &quot;queryHolders first argument must be an object.&quot;_s);</span>
897 
<span class="line-modified">898     JSArray* result = constructEmptyArray(exec, nullptr);</span>
899     RETURN_IF_EXCEPTION(scope, { });
900 
901     {
902         DeferGC deferGC(vm.heap);
903         PreventCollectionScope preventCollectionScope(vm.heap);
904         sanitizeStackForVM(vm);
905 
906         HeapHolderFinder holderFinder(vm.ensureHeapProfiler(), target.asCell());
907 
908         auto holders = copyToVector(holderFinder.holders());
909         std::sort(holders.begin(), holders.end());
910         for (auto* holder : holders)
<span class="line-modified">911             result-&gt;putDirectIndex(exec, result-&gt;length(), holder);</span>
912     }
913 
914     return result;
915 }
916 
917 } // namespace Inspector
</pre>
</td>
<td>
<hr />
<pre>
 26 #include &quot;config.h&quot;
 27 #include &quot;JSInjectedScriptHost.h&quot;
 28 
 29 #include &quot;ArrayIteratorPrototype.h&quot;
 30 #include &quot;ArrayPrototype.h&quot;
 31 #include &quot;BuiltinNames.h&quot;
 32 #include &quot;Completion.h&quot;
 33 #include &quot;DateInstance.h&quot;
 34 #include &quot;DeferGC.h&quot;
 35 #include &quot;DirectArguments.h&quot;
 36 #include &quot;Error.h&quot;
 37 #include &quot;FunctionPrototype.h&quot;
 38 #include &quot;HeapAnalyzer.h&quot;
 39 #include &quot;HeapIterationScope.h&quot;
 40 #include &quot;HeapProfiler.h&quot;
 41 #include &quot;InjectedScriptHost.h&quot;
 42 #include &quot;IterationKind.h&quot;
 43 #include &quot;IteratorOperations.h&quot;
 44 #include &quot;IteratorPrototype.h&quot;
 45 #include &quot;JSArray.h&quot;
<span class="line-added"> 46 #include &quot;JSArrayIterator.h&quot;</span>
 47 #include &quot;JSBoundFunction.h&quot;
 48 #include &quot;JSCInlines.h&quot;
 49 #include &quot;JSFunction.h&quot;
 50 #include &quot;JSGlobalObjectFunctions.h&quot;
 51 #include &quot;JSInjectedScriptHostPrototype.h&quot;
 52 #include &quot;JSLock.h&quot;
 53 #include &quot;JSMap.h&quot;
 54 #include &quot;JSPromise.h&quot;
 55 #include &quot;JSPromisePrototype.h&quot;
 56 #include &quot;JSSet.h&quot;
 57 #include &quot;JSStringIterator.h&quot;
 58 #include &quot;JSTypedArrays.h&quot;
 59 #include &quot;JSWeakMap.h&quot;
 60 #include &quot;JSWeakSet.h&quot;
 61 #include &quot;JSWithScope.h&quot;
 62 #include &quot;MapIteratorPrototype.h&quot;
 63 #include &quot;MapPrototype.h&quot;
 64 #include &quot;MarkedSpaceInlines.h&quot;
 65 #include &quot;ObjectConstructor.h&quot;
 66 #include &quot;ObjectPrototype.h&quot;
 67 #include &quot;PreventCollectionScope.h&quot;
 68 #include &quot;ProxyObject.h&quot;
 69 #include &quot;RegExpObject.h&quot;
 70 #include &quot;ScopedArguments.h&quot;
 71 #include &quot;SetIteratorPrototype.h&quot;
 72 #include &quot;SetPrototype.h&quot;
 73 #include &quot;SourceCode.h&quot;
 74 #include &quot;TypedArrayInlines.h&quot;
 75 #include &lt;wtf/Function.h&gt;
 76 #include &lt;wtf/HashFunctions.h&gt;
 77 #include &lt;wtf/HashMap.h&gt;
 78 #include &lt;wtf/HashSet.h&gt;
 79 #include &lt;wtf/HashTraits.h&gt;
 80 #include &lt;wtf/Lock.h&gt;
 81 #include &lt;wtf/PrintStream.h&gt;
 82 #include &lt;wtf/text/StringConcatenate.h&gt;
 83 


 84 namespace Inspector {
 85 
<span class="line-added"> 86 using namespace JSC;</span>
<span class="line-added"> 87 </span>
 88 const ClassInfo JSInjectedScriptHost::s_info = { &quot;InjectedScriptHost&quot;, &amp;Base::s_info, nullptr, nullptr, CREATE_METHOD_TABLE(JSInjectedScriptHost) };
 89 
 90 JSInjectedScriptHost::JSInjectedScriptHost(VM&amp; vm, Structure* structure, Ref&lt;InjectedScriptHost&gt;&amp;&amp; impl)
 91     : JSDestructibleObject(vm, structure)
 92     , m_wrapped(WTFMove(impl))
 93 {
 94 }
 95 
 96 void JSInjectedScriptHost::finishCreation(VM&amp; vm)
 97 {
 98     Base::finishCreation(vm);
 99     ASSERT(inherits(vm, info()));
100 }
101 
102 JSObject* JSInjectedScriptHost::createPrototype(VM&amp; vm, JSGlobalObject* globalObject)
103 {
104     return JSInjectedScriptHostPrototype::create(vm, globalObject, JSInjectedScriptHostPrototype::createStructure(vm, globalObject, globalObject-&gt;objectPrototype()));
105 }
106 
107 void JSInjectedScriptHost::destroy(JSC::JSCell* cell)
108 {
109     JSInjectedScriptHost* thisObject = static_cast&lt;JSInjectedScriptHost*&gt;(cell);
110     thisObject-&gt;JSInjectedScriptHost::~JSInjectedScriptHost();
111 }
112 
<span class="line-modified">113 JSValue JSInjectedScriptHost::evaluate(JSGlobalObject* globalObject) const</span>
114 {

115     return globalObject-&gt;evalFunction();
116 }
117 
<span class="line-modified">118 JSValue JSInjectedScriptHost::savedResultAlias(JSGlobalObject* globalObject) const</span>
119 {
120     auto savedResultAlias = impl().savedResultAlias();
121     if (!savedResultAlias)
122         return jsUndefined();
<span class="line-modified">123     return jsString(globalObject-&gt;vm(), savedResultAlias.value());</span>
124 }
125 
<span class="line-modified">126 JSValue JSInjectedScriptHost::evaluateWithScopeExtension(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
127 {
<span class="line-modified">128     VM&amp; vm = globalObject-&gt;vm();</span>
129     auto scope = DECLARE_THROW_SCOPE(vm);
130 
<span class="line-modified">131     JSValue scriptValue = callFrame-&gt;argument(0);</span>
132     if (!scriptValue.isString())
<span class="line-modified">133         return throwTypeError(globalObject, scope, &quot;InjectedScriptHost.evaluateWithScopeExtension first argument must be a string.&quot;_s);</span>
134 
<span class="line-modified">135     String program = asString(scriptValue)-&gt;value(globalObject);</span>
136     RETURN_IF_EXCEPTION(scope, JSValue());
137 
138     NakedPtr&lt;Exception&gt; exception;
<span class="line-modified">139     JSObject* scopeExtension = callFrame-&gt;argument(1).getObject();</span>
<span class="line-modified">140     JSValue result = JSC::evaluateWithScopeExtension(globalObject, makeSource(program, callFrame-&gt;callerSourceOrigin(vm)), scopeExtension, exception);</span>
141     if (exception)
<span class="line-modified">142         throwException(globalObject, scope, exception);</span>
143 
144     return result;
145 }
146 
<span class="line-modified">147 JSValue JSInjectedScriptHost::internalConstructorName(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
148 {
<span class="line-modified">149     if (callFrame-&gt;argumentCount() &lt; 1)</span>
150         return jsUndefined();
151 
<span class="line-modified">152     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">153     JSObject* object = jsCast&lt;JSObject*&gt;(callFrame-&gt;uncheckedArgument(0).toThis(globalObject, NotStrictMode));</span>
154     return jsString(vm, JSObject::calculatedClassName(object));
155 }
156 
<span class="line-modified">157 JSValue JSInjectedScriptHost::isHTMLAllCollection(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
158 {
<span class="line-modified">159     if (callFrame-&gt;argumentCount() &lt; 1)</span>
160         return jsUndefined();
161 
<span class="line-modified">162     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">163     JSValue value = callFrame-&gt;uncheckedArgument(0);</span>
164     return jsBoolean(impl().isHTMLAllCollection(vm, value));
165 }
166 
<span class="line-modified">167 JSValue JSInjectedScriptHost::isPromiseRejectedWithNativeGetterTypeError(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
168 {
<span class="line-modified">169     VM&amp; vm = globalObject-&gt;vm();</span>
170     auto scope = DECLARE_THROW_SCOPE(vm);
171 
<span class="line-modified">172     auto* promise = jsDynamicCast&lt;JSPromise*&gt;(vm, callFrame-&gt;argument(0));</span>
<span class="line-modified">173     if (!promise)</span>
<span class="line-modified">174         return throwTypeError(globalObject, scope, &quot;InjectedScriptHost.isPromiseRejectedWithNativeGetterTypeError first argument must be a Promise.&quot;_s);</span>
175 
176     bool result = false;
177     if (auto* errorInstance = jsDynamicCast&lt;ErrorInstance*&gt;(vm, promise-&gt;result(vm)))
178         result = errorInstance-&gt;isNativeGetterTypeError();
179     return jsBoolean(result);
180 }
181 
<span class="line-modified">182 JSValue JSInjectedScriptHost::subtype(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
183 {
<span class="line-modified">184     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">185     if (callFrame-&gt;argumentCount() &lt; 1)</span>
186         return jsUndefined();
187 
<span class="line-modified">188     JSValue value = callFrame-&gt;uncheckedArgument(0);</span>
189     if (value.isString())
190         return vm.smallStrings.stringString();
191     if (value.isBoolean())
192         return vm.smallStrings.booleanString();
193     if (value.isNumber())
194         return vm.smallStrings.numberString();
195     if (value.isSymbol())
196         return vm.smallStrings.symbolString();
197 
198     if (auto* object = jsDynamicCast&lt;JSObject*&gt;(vm, value)) {
199         if (object-&gt;isErrorInstance())
200             return jsNontrivialString(vm, &quot;error&quot;_s);
201 
202         // Consider class constructor functions class objects.
203         JSFunction* function = jsDynamicCast&lt;JSFunction*&gt;(vm, value);
204         if (function &amp;&amp; function-&gt;isClassConstructorFunction())
205             return jsNontrivialString(vm, &quot;class&quot;_s);
206 
207         if (object-&gt;inherits&lt;JSArray&gt;(vm))
208             return jsNontrivialString(vm, &quot;array&quot;_s);
</pre>
<hr />
<pre>
211 
212         if (object-&gt;inherits&lt;DateInstance&gt;(vm))
213             return jsNontrivialString(vm, &quot;date&quot;_s);
214         if (object-&gt;inherits&lt;RegExpObject&gt;(vm))
215             return jsNontrivialString(vm, &quot;regexp&quot;_s);
216         if (object-&gt;inherits&lt;ProxyObject&gt;(vm))
217             return jsNontrivialString(vm, &quot;proxy&quot;_s);
218 
219         if (object-&gt;inherits&lt;JSMap&gt;(vm))
220             return jsNontrivialString(vm, &quot;map&quot;_s);
221         if (object-&gt;inherits&lt;JSSet&gt;(vm))
222             return jsNontrivialString(vm, &quot;set&quot;_s);
223         if (object-&gt;inherits&lt;JSWeakMap&gt;(vm))
224             return jsNontrivialString(vm, &quot;weakmap&quot;_s);
225         if (object-&gt;inherits&lt;JSWeakSet&gt;(vm))
226             return jsNontrivialString(vm, &quot;weakset&quot;_s);
227 
228         if (object-&gt;inherits&lt;JSStringIterator&gt;(vm))
229             return jsNontrivialString(vm, &quot;iterator&quot;_s);
230 
<span class="line-modified">231         if (object-&gt;inherits&lt;JSArrayIterator&gt;(vm)</span>
232             || object-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().mapBucketPrivateName())
233             || object-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().setBucketPrivateName()))
234             return jsNontrivialString(vm, &quot;iterator&quot;_s);
235 
236         if (object-&gt;inherits&lt;JSInt8Array&gt;(vm)
237             || object-&gt;inherits&lt;JSInt16Array&gt;(vm)
238             || object-&gt;inherits&lt;JSInt32Array&gt;(vm)
239             || object-&gt;inherits&lt;JSUint8Array&gt;(vm)
240             || object-&gt;inherits&lt;JSUint8ClampedArray&gt;(vm)
241             || object-&gt;inherits&lt;JSUint16Array&gt;(vm)
242             || object-&gt;inherits&lt;JSUint32Array&gt;(vm)
243             || object-&gt;inherits&lt;JSFloat32Array&gt;(vm)
244             || object-&gt;inherits&lt;JSFloat64Array&gt;(vm))
245             return jsNontrivialString(vm, &quot;array&quot;_s);
246     }
247 
<span class="line-modified">248     return impl().subtype(globalObject, value);</span>
249 }
250 
<span class="line-modified">251 JSValue JSInjectedScriptHost::functionDetails(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
252 {
<span class="line-modified">253     if (callFrame-&gt;argumentCount() &lt; 1)</span>
254         return jsUndefined();
255 
<span class="line-modified">256     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">257     JSValue value = callFrame-&gt;uncheckedArgument(0);</span>
258     auto* function = jsDynamicCast&lt;JSFunction*&gt;(vm, value);
259     if (!function)
260         return jsUndefined();
261 
262     // FIXME: &lt;https://webkit.org/b/87192&gt; Web Inspector: Expose function scope / closure data
263 
264     // FIXME: This should provide better details for JSBoundFunctions.
265 
266     const SourceCode* sourceCode = function-&gt;sourceCode();
267     if (!sourceCode)
268         return jsUndefined();
269 
270     // In the inspector protocol all positions are 0-based while in SourceCode they are 1-based
271     int lineNumber = sourceCode-&gt;firstLine().oneBasedInt();
272     if (lineNumber)
273         lineNumber -= 1;
274     int columnNumber = sourceCode-&gt;startColumn().oneBasedInt();
275     if (columnNumber)
276         columnNumber -= 1;
277 
278     String scriptID = String::number(sourceCode-&gt;provider()-&gt;asID());
<span class="line-modified">279     JSObject* location = constructEmptyObject(globalObject);</span>
280     location-&gt;putDirect(vm, Identifier::fromString(vm, &quot;scriptId&quot;), jsString(vm, scriptID));
281     location-&gt;putDirect(vm, Identifier::fromString(vm, &quot;lineNumber&quot;), jsNumber(lineNumber));
282     location-&gt;putDirect(vm, Identifier::fromString(vm, &quot;columnNumber&quot;), jsNumber(columnNumber));
283 
<span class="line-modified">284     JSObject* result = constructEmptyObject(globalObject);</span>
285     result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;location&quot;), location);
286 
287     String name = function-&gt;name(vm);
288     if (!name.isEmpty())
289         result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;name&quot;), jsString(vm, name));
290 
291     String displayName = function-&gt;displayName(vm);
292     if (!displayName.isEmpty())
293         result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;displayName&quot;), jsString(vm, displayName));
294 
295     return result;
296 }
297 
<span class="line-modified">298 static JSObject* constructInternalProperty(JSGlobalObject* globalObject, const String&amp; name, JSValue value)</span>
299 {
<span class="line-modified">300     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">301     JSObject* result = constructEmptyObject(globalObject);</span>
302     result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;name&quot;), jsString(vm, name));
303     result-&gt;putDirect(vm, Identifier::fromString(vm, &quot;value&quot;), value);
304     return result;
305 }
306 
<span class="line-modified">307 JSValue JSInjectedScriptHost::getInternalProperties(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
308 {
<span class="line-modified">309     if (callFrame-&gt;argumentCount() &lt; 1)</span>
310         return jsUndefined();
311 
<span class="line-modified">312     VM&amp; vm = globalObject-&gt;vm();</span>
313     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">314     JSValue value = callFrame-&gt;uncheckedArgument(0);</span>
315 
<span class="line-modified">316     JSValue internalProperties = impl().getInternalProperties(vm, globalObject, value);</span>
317     if (internalProperties)
318         return internalProperties;
319 
320     if (JSPromise* promise = jsDynamicCast&lt;JSPromise*&gt;(vm, value)) {
321         unsigned index = 0;
<span class="line-modified">322         JSArray* array = constructEmptyArray(globalObject, nullptr);</span>
323         RETURN_IF_EXCEPTION(scope, JSValue());
324         switch (promise-&gt;status(vm)) {
325         case JSPromise::Status::Pending:
326             scope.release();
<span class="line-modified">327             array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;status&quot;_s, jsNontrivialString(vm, &quot;pending&quot;_s)));</span>
328             return array;
329         case JSPromise::Status::Fulfilled:
<span class="line-modified">330             array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;status&quot;_s, jsNontrivialString(vm, &quot;resolved&quot;_s)));</span>
331             RETURN_IF_EXCEPTION(scope, JSValue());
332             scope.release();
<span class="line-modified">333             array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;result&quot;_s, promise-&gt;result(vm)));</span>
334             return array;
335         case JSPromise::Status::Rejected:
<span class="line-modified">336             array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;status&quot;_s, jsNontrivialString(vm, &quot;rejected&quot;_s)));</span>
337             RETURN_IF_EXCEPTION(scope, JSValue());
338             scope.release();
<span class="line-modified">339             array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;result&quot;_s, promise-&gt;result(vm)));</span>
340             return array;
341         }
342         // FIXME: &lt;https://webkit.org/b/141664&gt; Web Inspector: ES6: Improved Support for Promises - Promise Reactions
343         RELEASE_ASSERT_NOT_REACHED();
344     }
345 
346     if (JSBoundFunction* boundFunction = jsDynamicCast&lt;JSBoundFunction*&gt;(vm, value)) {
347         unsigned index = 0;
<span class="line-modified">348         JSArray* array = constructEmptyArray(globalObject, nullptr);</span>
349         RETURN_IF_EXCEPTION(scope, JSValue());
<span class="line-modified">350         array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;targetFunction&quot;, boundFunction-&gt;targetFunction()));</span>
351         RETURN_IF_EXCEPTION(scope, JSValue());
<span class="line-modified">352         array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;boundThis&quot;, boundFunction-&gt;boundThis()));</span>
353         RETURN_IF_EXCEPTION(scope, JSValue());
354         if (boundFunction-&gt;boundArgs()) {
355             scope.release();
<span class="line-modified">356             array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;boundArgs&quot;, boundFunction-&gt;boundArgsCopy(globalObject)));</span>
357             return array;
358         }
359         return array;
360     }
361 
362     if (ProxyObject* proxy = jsDynamicCast&lt;ProxyObject*&gt;(vm, value)) {
363         unsigned index = 0;
<span class="line-modified">364         JSArray* array = constructEmptyArray(globalObject, nullptr, 2);</span>
365         RETURN_IF_EXCEPTION(scope, JSValue());
<span class="line-modified">366         array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;target&quot;_s, proxy-&gt;target()));</span>
367         RETURN_IF_EXCEPTION(scope, JSValue());
368         scope.release();
<span class="line-modified">369         array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;handler&quot;_s, proxy-&gt;handler()));</span>
370         return array;
371     }
372 
373     if (JSObject* iteratorObject = jsDynamicCast&lt;JSObject*&gt;(vm, value)) {
<span class="line-modified">374         auto toString = [&amp;] (IterationKind kind) {</span>
<span class="line-modified">375             switch (kind) {</span>
<span class="line-modified">376             case IterationKind::Keys:</span>
<span class="line-added">377                 return jsNontrivialString(vm, &quot;keys&quot;_s);</span>
<span class="line-added">378             case IterationKind::Values:</span>
<span class="line-added">379                 return jsNontrivialString(vm, &quot;values&quot;_s);</span>
<span class="line-added">380             case IterationKind::Entries:</span>
<span class="line-added">381                 return jsNontrivialString(vm, &quot;entries&quot;_s);</span>
<span class="line-added">382             }</span>
<span class="line-added">383             return jsNontrivialString(vm, &quot;&quot;_s);</span>
<span class="line-added">384         };</span>
<span class="line-added">385 </span>
<span class="line-added">386         if (auto* arrayIterator = jsDynamicCast&lt;JSArrayIterator*&gt;(vm, iteratorObject)) {</span>
<span class="line-added">387             JSValue iteratedValue = arrayIterator-&gt;iteratedObject();</span>
<span class="line-added">388             IterationKind kind = arrayIterator-&gt;kind();</span>
389 
390             unsigned index = 0;
<span class="line-modified">391             JSArray* array = constructEmptyArray(globalObject, nullptr, 2);</span>
392             RETURN_IF_EXCEPTION(scope, JSValue());
<span class="line-modified">393             array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;array&quot;, iteratedValue));</span>
394             RETURN_IF_EXCEPTION(scope, JSValue());
395             scope.release();
<span class="line-modified">396             array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;kind&quot;, toString(kind)));</span>
397             return array;
398         }
399 
400         if (iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().mapBucketPrivateName())) {
401             JSValue iteratedValue = iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().iteratedObjectPrivateName());
<span class="line-modified">402             IterationKind kind = static_cast&lt;IterationKind&gt;(iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().mapIteratorKindPrivateName()).asInt32());</span>
<span class="line-modified">403 </span>










404             unsigned index = 0;
<span class="line-modified">405             JSArray* array = constructEmptyArray(globalObject, nullptr, 2);</span>
406             RETURN_IF_EXCEPTION(scope, JSValue());
<span class="line-modified">407             array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;map&quot;, iteratedValue));</span>
408             RETURN_IF_EXCEPTION(scope, JSValue());
409             scope.release();
<span class="line-modified">410             array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;kind&quot;, toString(kind)));</span>
411             return array;
412         }
413 
414         if (iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().setBucketPrivateName())) {
415             JSValue iteratedValue = iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().iteratedObjectPrivateName());
<span class="line-modified">416             IterationKind kind = static_cast&lt;IterationKind&gt;(iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().setIteratorKindPrivateName()).asInt32());</span>
<span class="line-modified">417 </span>










418             unsigned index = 0;
<span class="line-modified">419             JSArray* array = constructEmptyArray(globalObject, nullptr, 2);</span>
420             RETURN_IF_EXCEPTION(scope, JSValue());
<span class="line-modified">421             array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;set&quot;, iteratedValue));</span>
422             RETURN_IF_EXCEPTION(scope, JSValue());
423             scope.release();
<span class="line-modified">424             array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;kind&quot;, toString(kind)));</span>
425             return array;
426         }
427     }
428 
429     if (JSStringIterator* stringIterator = jsDynamicCast&lt;JSStringIterator*&gt;(vm, value)) {
430         unsigned index = 0;
<span class="line-modified">431         JSArray* array = constructEmptyArray(globalObject, nullptr, 1);</span>
432         RETURN_IF_EXCEPTION(scope, JSValue());
433         scope.release();
<span class="line-modified">434         array-&gt;putDirectIndex(globalObject, index++, constructInternalProperty(globalObject, &quot;string&quot;, stringIterator-&gt;iteratedString()));</span>
435         return array;
436     }
437 
438     return jsUndefined();
439 }
440 
<span class="line-modified">441 JSValue JSInjectedScriptHost::proxyTargetValue(VM&amp; vm, CallFrame* callFrame)</span>
442 {
<span class="line-modified">443     if (callFrame-&gt;argumentCount() &lt; 1)</span>
444         return jsUndefined();
445 
<span class="line-modified">446     JSValue value = callFrame-&gt;uncheckedArgument(0);</span>

447     ProxyObject* proxy = jsDynamicCast&lt;ProxyObject*&gt;(vm, value);
448     if (!proxy)
449         return jsUndefined();
450 
451     JSObject* target = proxy-&gt;target();
452     while (ProxyObject* proxy = jsDynamicCast&lt;ProxyObject*&gt;(vm, target))
453         target = proxy-&gt;target();
454 
455     return target;
456 }
457 
<span class="line-modified">458 JSValue JSInjectedScriptHost::weakMapSize(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
459 {
<span class="line-modified">460     if (callFrame-&gt;argumentCount() &lt; 1)</span>
461         return jsUndefined();
462 
<span class="line-modified">463     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">464     JSValue value = callFrame-&gt;uncheckedArgument(0);</span>
465     JSWeakMap* weakMap = jsDynamicCast&lt;JSWeakMap*&gt;(vm, value);
466     if (!weakMap)
467         return jsUndefined();
468 
469     return jsNumber(weakMap-&gt;size());
470 }
471 
<span class="line-modified">472 JSValue JSInjectedScriptHost::weakMapEntries(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
473 {
<span class="line-modified">474     if (callFrame-&gt;argumentCount() &lt; 1)</span>
475         return jsUndefined();
476 
<span class="line-modified">477     VM&amp; vm = globalObject-&gt;vm();</span>
478     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">479     auto* weakMap = jsDynamicCast&lt;JSWeakMap*&gt;(vm, callFrame-&gt;uncheckedArgument(0));</span>

480     if (!weakMap)
481         return jsUndefined();
482 
<span class="line-modified">483     MarkedArgumentBuffer buffer;</span>
<span class="line-modified">484     auto fetchCount = callFrame-&gt;argument(1).toInteger(globalObject);</span>
<span class="line-modified">485     weakMap-&gt;takeSnapshot(buffer, fetchCount &gt;= 0 ? static_cast&lt;unsigned&gt;(fetchCount) : 0);</span>
<span class="line-modified">486     ASSERT(!buffer.hasOverflowed());</span>


487 
<span class="line-modified">488     JSArray* array = constructEmptyArray(globalObject, nullptr);</span>
489     RETURN_IF_EXCEPTION(scope, JSValue());
490 



491     for (unsigned index = 0; index &lt; buffer.size(); index += 2) {
<span class="line-modified">492         JSObject* entry = constructEmptyObject(globalObject);</span>
493         entry-&gt;putDirect(vm, Identifier::fromString(vm, &quot;key&quot;), buffer.at(index));
494         entry-&gt;putDirect(vm, Identifier::fromString(vm, &quot;value&quot;), buffer.at(index + 1));
<span class="line-modified">495         array-&gt;putDirectIndex(globalObject, index / 2, entry);</span>
496         RETURN_IF_EXCEPTION(scope, JSValue());
497     }
498 
499     return array;
500 }
501 
<span class="line-modified">502 JSValue JSInjectedScriptHost::weakSetSize(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
503 {
<span class="line-modified">504     if (callFrame-&gt;argumentCount() &lt; 1)</span>
505         return jsUndefined();
506 
<span class="line-modified">507     VM&amp; vm = globalObject-&gt;vm();</span>
<span class="line-modified">508     JSValue value = callFrame-&gt;uncheckedArgument(0);</span>
509     JSWeakSet* weakSet = jsDynamicCast&lt;JSWeakSet*&gt;(vm, value);
510     if (!weakSet)
511         return jsUndefined();
512 
513     return jsNumber(weakSet-&gt;size());
514 }
515 
<span class="line-modified">516 JSValue JSInjectedScriptHost::weakSetEntries(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
517 {
<span class="line-modified">518     if (callFrame-&gt;argumentCount() &lt; 1)</span>
519         return jsUndefined();
520 
<span class="line-modified">521     VM&amp; vm = globalObject-&gt;vm();</span>
522     auto scope = DECLARE_THROW_SCOPE(vm);
<span class="line-modified">523     auto* weakSet = jsDynamicCast&lt;JSWeakSet*&gt;(vm, callFrame-&gt;uncheckedArgument(0));</span>

524     if (!weakSet)
525         return jsUndefined();
526 
<span class="line-modified">527     MarkedArgumentBuffer buffer;</span>
<span class="line-modified">528     auto fetchCount = callFrame-&gt;argument(1).toInteger(globalObject);</span>
<span class="line-modified">529     weakSet-&gt;takeSnapshot(buffer, fetchCount &gt;= 0 ? static_cast&lt;unsigned&gt;(fetchCount) : 0);</span>
<span class="line-modified">530     ASSERT(!buffer.hasOverflowed());</span>


531 
<span class="line-modified">532     JSArray* array = constructEmptyArray(globalObject, nullptr);</span>
533     RETURN_IF_EXCEPTION(scope, JSValue());
534 



535     for (unsigned index = 0; index &lt; buffer.size(); ++index) {
<span class="line-modified">536         JSObject* entry = constructEmptyObject(globalObject);</span>
537         entry-&gt;putDirect(vm, Identifier::fromString(vm, &quot;value&quot;), buffer.at(index));
<span class="line-modified">538         array-&gt;putDirectIndex(globalObject, index, entry);</span>
539         RETURN_IF_EXCEPTION(scope, JSValue());
540     }
541 
542     return array;
543 }
544 
<span class="line-modified">545 static JSObject* cloneArrayIteratorObject(JSGlobalObject* globalObject, VM&amp; vm, JSArrayIterator* iteratorObject)</span>
546 {
<span class="line-modified">547     JSArrayIterator* clone = JSArrayIterator::create(vm, globalObject-&gt;arrayIteratorStructure(), iteratorObject-&gt;iteratedObject(), iteratorObject-&gt;internalField(JSArrayIterator::Field::Kind).get());</span>
<span class="line-modified">548     clone-&gt;internalField(JSArrayIterator::Field::Index).set(vm, clone, iteratorObject-&gt;internalField(JSArrayIterator::Field::Index).get());</span>





549     return clone;
550 }
551 
<span class="line-modified">552 static JSObject* cloneMapIteratorObject(JSGlobalObject* globalObject, VM&amp; vm, JSObject* iteratorObject, JSValue mapBucket, JSValue iteratedObject)</span>
553 {
554     ASSERT(iteratorObject-&gt;type() == FinalObjectType);
<span class="line-modified">555     JSObject* clone = constructEmptyObject(globalObject, MapIteratorPrototype::create(vm, globalObject, MapIteratorPrototype::createStructure(vm, globalObject, globalObject-&gt;iteratorPrototype())));</span>
556     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().iteratedObjectPrivateName(), iteratedObject);
557     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().mapIteratorKindPrivateName(), iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().mapIteratorKindPrivateName()));
558     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().mapBucketPrivateName(), mapBucket);
559     return clone;
560 }
561 
<span class="line-modified">562 static JSObject* cloneSetIteratorObject(JSGlobalObject* globalObject, VM&amp; vm, JSObject* iteratorObject, JSValue setBucket, JSValue iteratedObject)</span>
563 {
564     ASSERT(iteratorObject-&gt;type() == FinalObjectType);
<span class="line-modified">565     JSObject* clone = constructEmptyObject(globalObject, SetIteratorPrototype::create(vm, globalObject, SetIteratorPrototype::createStructure(vm, globalObject, globalObject-&gt;iteratorPrototype())));</span>
566     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().iteratedObjectPrivateName(), iteratedObject);
567     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().setIteratorKindPrivateName(), iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().setIteratorKindPrivateName()));
568     clone-&gt;putDirect(vm, vm.propertyNames-&gt;builtinNames().setBucketPrivateName(), setBucket);
569     return clone;
570 }
571 
<span class="line-modified">572 JSValue JSInjectedScriptHost::iteratorEntries(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
573 {
<span class="line-modified">574     if (callFrame-&gt;argumentCount() &lt; 1)</span>
575         return jsUndefined();
576 
<span class="line-modified">577     VM&amp; vm = globalObject-&gt;vm();</span>
578     auto scope = DECLARE_THROW_SCOPE(vm);
579 
580     JSValue iterator;
<span class="line-modified">581     JSValue value = callFrame-&gt;uncheckedArgument(0);</span>

582     if (JSStringIterator* stringIterator = jsDynamicCast&lt;JSStringIterator*&gt;(vm, value)) {
583         if (globalObject-&gt;isStringPrototypeIteratorProtocolFastAndNonObservable())
<span class="line-modified">584             iterator = stringIterator-&gt;clone(globalObject);</span>
585     } else if (JSObject* iteratorObject = jsDynamicCast&lt;JSObject*&gt;(vm, value)) {
<span class="line-modified">586         if (auto* arrayIterator = jsDynamicCast&lt;JSArrayIterator*&gt;(vm, iteratorObject)) {</span>
<span class="line-modified">587             JSObject* iteratedObject = arrayIterator-&gt;iteratedObject();</span>

588             if (isJSArray(iteratedObject)) {
589                 JSArray* array = jsCast&lt;JSArray*&gt;(iteratedObject);
590                 if (array-&gt;isIteratorProtocolFastAndNonObservable())
<span class="line-modified">591                     iterator = cloneArrayIteratorObject(globalObject, vm, arrayIterator);</span>
<span class="line-modified">592             } else if (TypeInfo::isArgumentsType(iteratedObject-&gt;type())) {</span>
593                 if (globalObject-&gt;isArrayPrototypeIteratorProtocolFastAndNonObservable())
<span class="line-modified">594                     iterator = cloneArrayIteratorObject(globalObject, vm, arrayIterator);</span>
<span class="line-added">595             }</span>
<span class="line-added">596         } else {</span>
<span class="line-added">597             JSValue iteratedObject = iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().iteratedObjectPrivateName());</span>
<span class="line-added">598             if (JSValue mapBucket = iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().mapBucketPrivateName())) {</span>
<span class="line-added">599                 if (jsCast&lt;JSMap*&gt;(iteratedObject)-&gt;isIteratorProtocolFastAndNonObservable())</span>
<span class="line-added">600                     iterator = cloneMapIteratorObject(globalObject, vm, iteratorObject, mapBucket, iteratedObject);</span>
<span class="line-added">601             } else if (JSValue setBucket = iteratorObject-&gt;getDirect(vm, vm.propertyNames-&gt;builtinNames().setBucketPrivateName())) {</span>
<span class="line-added">602                 if (jsCast&lt;JSSet*&gt;(iteratedObject)-&gt;isIteratorProtocolFastAndNonObservable())</span>
<span class="line-added">603                     iterator = cloneSetIteratorObject(globalObject, vm, iteratorObject, setBucket, iteratedObject);</span>
604             }






605         }
606     }
607     RETURN_IF_EXCEPTION(scope, { });
608     if (!iterator)
609         return jsUndefined();
610 
<span class="line-modified">611     IterationRecord iterationRecord = { iterator, iterator.get(globalObject, vm.propertyNames-&gt;next) };</span>
612 
613     unsigned numberToFetch = 5;
<span class="line-modified">614     JSValue numberToFetchArg = callFrame-&gt;argument(1);</span>
<span class="line-modified">615     double fetchDouble = numberToFetchArg.toInteger(globalObject);</span>
616     RETURN_IF_EXCEPTION(scope, { });
617     if (fetchDouble &gt;= 0)
618         numberToFetch = static_cast&lt;unsigned&gt;(fetchDouble);
619 
<span class="line-modified">620     JSArray* array = constructEmptyArray(globalObject, nullptr);</span>
621     RETURN_IF_EXCEPTION(scope, { });
622 
623     for (unsigned i = 0; i &lt; numberToFetch; ++i) {
<span class="line-modified">624         JSValue next = iteratorStep(globalObject, iterationRecord);</span>
625         if (UNLIKELY(scope.exception()) || next.isFalse())
626             break;
627 
<span class="line-modified">628         JSValue nextValue = iteratorValue(globalObject, next);</span>
629         RETURN_IF_EXCEPTION(scope, { });
630 
<span class="line-modified">631         JSObject* entry = constructEmptyObject(globalObject);</span>
632         entry-&gt;putDirect(vm, Identifier::fromString(vm, &quot;value&quot;), nextValue);
<span class="line-modified">633         array-&gt;putDirectIndex(globalObject, i, entry);</span>
634         if (UNLIKELY(scope.exception())) {
635             scope.release();
<span class="line-modified">636             iteratorClose(globalObject, iterationRecord);</span>
637             break;
638         }
639     }
640 
641     return array;
642 }
643 
<span class="line-modified">644 static bool checkForbiddenPrototype(JSGlobalObject* globalObject, JSValue value, JSValue proto)</span>
645 {
646     if (value == proto)
647         return true;
648 
649     // Check that the prototype chain of proto hasn&#39;t been modified to include value.
<span class="line-modified">650     return JSObject::defaultHasInstance(globalObject, proto, value);</span>
651 }
652 
<span class="line-modified">653 JSValue JSInjectedScriptHost::queryInstances(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
654 {
<span class="line-modified">655     if (callFrame-&gt;argumentCount() &lt; 1)</span>
656         return jsUndefined();
657 
<span class="line-modified">658     VM&amp; vm = globalObject-&gt;vm();</span>
659     auto scope = DECLARE_THROW_SCOPE(vm);
660 
<span class="line-modified">661     JSValue prototypeOrConstructor = callFrame-&gt;uncheckedArgument(0);</span>
662     if (!prototypeOrConstructor.isObject())
<span class="line-modified">663         return throwTypeError(globalObject, scope, &quot;queryInstances first argument must be an object.&quot;_s);</span>
664 
665     JSObject* object = asObject(prototypeOrConstructor);
666     if (object-&gt;inherits&lt;ProxyObject&gt;(vm))
<span class="line-modified">667         return throwTypeError(globalObject, scope, &quot;queryInstances cannot be called with a Proxy.&quot;_s);</span>
668 
669     JSValue prototype = object;
670 
671     PropertySlot prototypeSlot(object, PropertySlot::InternalMethodType::VMInquiry);
<span class="line-modified">672     if (object-&gt;getPropertySlot(globalObject, vm.propertyNames-&gt;prototype, prototypeSlot)) {</span>
673         RETURN_IF_EXCEPTION(scope, { });
674         if (prototypeSlot.isValue()) {
<span class="line-modified">675             JSValue prototypeValue = prototypeSlot.getValue(globalObject, vm.propertyNames-&gt;prototype);</span>
676             if (prototypeValue.isObject()) {
677                 prototype = prototypeValue;
678                 object = asObject(prototype);
679             }
680         }
681     }
682 
683     if (object-&gt;inherits&lt;ProxyObject&gt;(vm) || prototype.inherits&lt;ProxyObject&gt;(vm))
<span class="line-modified">684         return throwTypeError(globalObject, scope, &quot;queryInstances cannot be called with a Proxy.&quot;_s);</span>
685 
686     // FIXME: implement a way of distinguishing between internal and user-created objects.
<span class="line-modified">687     if (checkForbiddenPrototype(globalObject, object, globalObject-&gt;objectPrototype()))</span>
<span class="line-modified">688         return throwTypeError(globalObject, scope, &quot;queryInstances cannot be called with Object.&quot;_s);</span>
<span class="line-modified">689     if (checkForbiddenPrototype(globalObject, object, globalObject-&gt;functionPrototype()))</span>
<span class="line-modified">690         return throwTypeError(globalObject, scope, &quot;queryInstances cannot be called with Function.&quot;_s);</span>
<span class="line-modified">691     if (checkForbiddenPrototype(globalObject, object, globalObject-&gt;arrayPrototype()))</span>
<span class="line-modified">692         return throwTypeError(globalObject, scope, &quot;queryInstances cannot be called with Array.&quot;_s);</span>
<span class="line-modified">693     if (checkForbiddenPrototype(globalObject, object, globalObject-&gt;mapPrototype()))</span>
<span class="line-modified">694         return throwTypeError(globalObject, scope, &quot;queryInstances cannot be called with Map.&quot;_s);</span>
<span class="line-modified">695     if (checkForbiddenPrototype(globalObject, object, globalObject-&gt;jsSetPrototype()))</span>
<span class="line-modified">696         return throwTypeError(globalObject, scope, &quot;queryInstances cannot be called with Set.&quot;_s);</span>
<span class="line-modified">697     if (checkForbiddenPrototype(globalObject, object, globalObject-&gt;promisePrototype()))</span>
<span class="line-modified">698         return throwTypeError(globalObject, scope, &quot;queryInstances cannot be called with Promise.&quot;_s);</span>

699 
700     sanitizeStackForVM(vm);
701     vm.heap.collectNow(Sync, CollectionScope::Full);
702 
<span class="line-modified">703     JSArray* array = constructEmptyArray(globalObject, nullptr);</span>
704     RETURN_IF_EXCEPTION(scope, { });
705 
706     {
707         HeapIterationScope iterationScope(vm.heap);
708         vm.heap.objectSpace().forEachLiveCell(iterationScope, [&amp;] (HeapCell* cell, HeapCell::Kind kind) {
709             if (!isJSCellKind(kind))
710                 return IterationStatus::Continue;
711 
712             JSValue value(static_cast&lt;JSCell*&gt;(cell));
713             if (value.inherits&lt;ProxyObject&gt;(vm))
714                 return IterationStatus::Continue;
715 
<span class="line-modified">716             if (JSObject::defaultHasInstance(globalObject, value, prototype))</span>
<span class="line-modified">717                 array-&gt;putDirectIndex(globalObject, array-&gt;length(), value);</span>
718 
719             return IterationStatus::Continue;
720         });
721     }
722 
723     return array;
724 }
725 
726 class HeapHolderFinder final : public HeapAnalyzer {
727     WTF_MAKE_FAST_ALLOCATED;
728 public:
729     HeapHolderFinder(HeapProfiler&amp; profiler, JSCell* target)
730         : HeapAnalyzer()
731         , m_target(target)
732     {
733         ASSERT(!profiler.activeHeapAnalyzer());
734         profiler.setActiveHeapAnalyzer(this);
735         profiler.vm().heap.collectNow(Sync, CollectionScope::Full);
736         profiler.setActiveHeapAnalyzer(nullptr);
737 
</pre>
<hr />
<pre>
755             queue.add(holder);
756         while (auto* holder = queue.takeAny()) {
757             if (holder-&gt;isObject())
758                 continue;
759 
760             for (auto* from : m_predecessors.get(holder)) {
761                 if (!m_holders.contains(from)) {
762                     m_holders.add(from);
763                     queue.add(from);
764                 }
765             }
766         }
767 
768         m_holders.removeIf([&amp;] (auto* holder) {
769             return !holder-&gt;isObject() || !visited.contains(holder);
770         });
771     }
772 
773     HashSet&lt;JSCell*&gt;&amp; holders() { return m_holders; }
774 
<span class="line-modified">775     void analyzeEdge(JSCell* from, JSCell* to, SlotVisitor::RootMarkReason reason) override</span>
776     {
777         ASSERT(to);
778         ASSERT(to-&gt;vm().heapProfiler()-&gt;activeHeapAnalyzer() == this);
779 
780         auto locker = holdLock(m_mutex);
781 
782         if (from &amp;&amp; from != to) {
783             m_successors.ensure(from, [] {
784                 return HashSet&lt;JSCell*&gt;();
785             }).iterator-&gt;value.add(to);
786 
787             m_predecessors.ensure(to, [] {
788                 return HashSet&lt;JSCell*&gt;();
789             }).iterator-&gt;value.add(from);
790 
791             if (to == m_target)
792                 m_holders.add(from);
793         }
794 
795         if (reason == SlotVisitor::RootMarkReason::Debugger)
796             m_rootsToIgnore.add(to);
797         else if (!from || reason != SlotVisitor::RootMarkReason::None)
798             m_rootsToInclude.add(to);
799     }
<span class="line-modified">800     void analyzePropertyNameEdge(JSCell* from, JSCell* to, UniquedStringImpl*) override { analyzeEdge(from, to, SlotVisitor::RootMarkReason::None); }</span>
<span class="line-modified">801     void analyzeVariableNameEdge(JSCell* from, JSCell* to, UniquedStringImpl*) override { analyzeEdge(from, to, SlotVisitor::RootMarkReason::None); }</span>
<span class="line-modified">802     void analyzeIndexEdge(JSCell* from, JSCell* to, uint32_t) override { analyzeEdge(from, to, SlotVisitor::RootMarkReason::None); }</span>
803 
<span class="line-modified">804     void analyzeNode(JSCell*) override { }</span>
<span class="line-modified">805     void setOpaqueRootReachabilityReasonForCell(JSCell*, const char*) override { }</span>
<span class="line-modified">806     void setWrappedObjectForCell(JSCell*, void*) override { }</span>
<span class="line-modified">807     void setLabelForCell(JSCell*, const String&amp;) override { }</span>
808 
809 #ifndef NDEBUG
810     void dump(PrintStream&amp; out) const
811     {
812         Indentation&lt;4&gt; indent;
813 
814         HashSet&lt;JSCell*&gt; visited;
815 
816         Function&lt;void(JSCell*)&gt; visit = [&amp;] (auto* from) {
817             auto isFirstVisit = visited.add(from).isNewEntry;
818 
819             out.print(makeString(indent));
820 
821             out.print(&quot;[ &quot;_s);
822             if (from == m_target)
823                 out.print(&quot;T &quot;_s);
824             if (m_holders.contains(from))
825                 out.print(&quot;H &quot;_s);
826             if (m_rootsToIgnore.contains(from))
827                 out.print(&quot;- &quot;_s);
</pre>
<hr />
<pre>
840                 for (auto* to : m_successors.get(from))
841                     visit(to);
842             }
843         };
844 
845         for (auto* from : m_rootsToInclude)
846             visit(from);
847     }
848 #endif
849 
850 private:
851     Lock m_mutex;
852     HashMap&lt;JSCell*, HashSet&lt;JSCell*&gt;&gt; m_predecessors;
853     HashMap&lt;JSCell*, HashSet&lt;JSCell*&gt;&gt; m_successors;
854     HashSet&lt;JSCell*&gt; m_rootsToInclude;
855     HashSet&lt;JSCell*&gt; m_rootsToIgnore;
856     HashSet&lt;JSCell*&gt; m_holders;
857     const JSCell* m_target;
858 };
859 
<span class="line-modified">860 JSValue JSInjectedScriptHost::queryHolders(JSGlobalObject* globalObject, CallFrame* callFrame)</span>
861 {
<span class="line-modified">862     if (callFrame-&gt;argumentCount() &lt; 1)</span>
863         return jsUndefined();
864 
<span class="line-modified">865     VM&amp; vm = globalObject-&gt;vm();</span>
866     auto scope = DECLARE_THROW_SCOPE(vm);
867 
<span class="line-modified">868     JSValue target = callFrame-&gt;uncheckedArgument(0);</span>
869     if (!target.isObject())
<span class="line-modified">870         return throwTypeError(globalObject, scope, &quot;queryHolders first argument must be an object.&quot;_s);</span>
871 
<span class="line-modified">872     JSArray* result = constructEmptyArray(globalObject, nullptr);</span>
873     RETURN_IF_EXCEPTION(scope, { });
874 
875     {
876         DeferGC deferGC(vm.heap);
877         PreventCollectionScope preventCollectionScope(vm.heap);
878         sanitizeStackForVM(vm);
879 
880         HeapHolderFinder holderFinder(vm.ensureHeapProfiler(), target.asCell());
881 
882         auto holders = copyToVector(holderFinder.holders());
883         std::sort(holders.begin(), holders.end());
884         for (auto* holder : holders)
<span class="line-modified">885             result-&gt;putDirectIndex(globalObject, result-&gt;length(), holder);</span>
886     }
887 
888     return result;
889 }
890 
891 } // namespace Inspector
</pre>
</td>
</tr>
</table>
<center><a href="JSGlobalObjectScriptDebugServer.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JSInjectedScriptHost.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>