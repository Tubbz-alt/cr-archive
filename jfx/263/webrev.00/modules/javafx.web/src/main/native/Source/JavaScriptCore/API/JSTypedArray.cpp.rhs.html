<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/API/JSTypedArray.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2015 Dominic Szablewski (dominic@phoboslab.org)
  3  * Copyright (C) 2016 Apple Inc. All rights reserved.
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  * 1. Redistributions of source code must retain the above copyright
  9  *    notice, this list of conditions and the following disclaimer.
 10  * 2. Redistributions in binary form must reproduce the above copyright
 11  *    notice, this list of conditions and the following disclaimer in the
 12  *    documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY APPLE COMPUTER, INC. ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE COMPUTER, INC. OR
 18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 25  */
 26 
 27 #include &quot;config.h&quot;
 28 #include &quot;JSTypedArray.h&quot;
 29 
 30 #include &quot;APICast.h&quot;
 31 #include &quot;APIUtils.h&quot;
 32 #include &quot;ClassInfo.h&quot;
 33 #include &quot;Error.h&quot;
 34 #include &quot;JSArrayBufferViewInlines.h&quot;
 35 #include &quot;JSCInlines.h&quot;
 36 #include &quot;JSDataView.h&quot;
 37 #include &quot;JSGenericTypedArrayViewInlines.h&quot;
 38 #include &quot;JSTypedArrays.h&quot;
 39 #include &quot;TypedArrayController.h&quot;
 40 #include &lt;wtf/RefPtr.h&gt;
 41 
 42 using namespace JSC;
 43 
 44 // Helper functions.
 45 
 46 inline JSTypedArrayType toJSTypedArrayType(TypedArrayType type)
 47 {
 48     switch (type) {
 49     case JSC::TypeDataView:
 50     case NotTypedArray:
 51         return kJSTypedArrayTypeNone;
 52     case TypeInt8:
 53         return kJSTypedArrayTypeInt8Array;
 54     case TypeUint8:
 55         return kJSTypedArrayTypeUint8Array;
 56     case TypeUint8Clamped:
 57         return kJSTypedArrayTypeUint8ClampedArray;
 58     case TypeInt16:
 59         return kJSTypedArrayTypeInt16Array;
 60     case TypeUint16:
 61         return kJSTypedArrayTypeUint16Array;
 62     case TypeInt32:
 63         return kJSTypedArrayTypeInt32Array;
 64     case TypeUint32:
 65         return kJSTypedArrayTypeUint32Array;
 66     case TypeFloat32:
 67         return kJSTypedArrayTypeFloat32Array;
 68     case TypeFloat64:
 69         return kJSTypedArrayTypeFloat64Array;
 70     }
 71     RELEASE_ASSERT_NOT_REACHED();
 72 }
 73 
 74 inline TypedArrayType toTypedArrayType(JSTypedArrayType type)
 75 {
 76     switch (type) {
 77     case kJSTypedArrayTypeArrayBuffer:
 78     case kJSTypedArrayTypeNone:
 79         return NotTypedArray;
 80     case kJSTypedArrayTypeInt8Array:
 81         return TypeInt8;
 82     case kJSTypedArrayTypeUint8Array:
 83         return TypeUint8;
 84     case kJSTypedArrayTypeUint8ClampedArray:
 85         return TypeUint8Clamped;
 86     case kJSTypedArrayTypeInt16Array:
 87         return TypeInt16;
 88     case kJSTypedArrayTypeUint16Array:
 89         return TypeUint16;
 90     case kJSTypedArrayTypeInt32Array:
 91         return TypeInt32;
 92     case kJSTypedArrayTypeUint32Array:
 93         return TypeUint32;
 94     case kJSTypedArrayTypeFloat32Array:
 95         return TypeFloat32;
 96     case kJSTypedArrayTypeFloat64Array:
 97         return TypeFloat64;
 98     }
 99     RELEASE_ASSERT_NOT_REACHED();
100 }
101 
<a name="1" id="anc1"></a><span class="line-modified">102 static JSObject* createTypedArray(JSGlobalObject* globalObject, JSTypedArrayType type, RefPtr&lt;ArrayBuffer&gt;&amp;&amp; buffer, size_t offset, size_t length)</span>
103 {
<a name="2" id="anc2"></a><span class="line-modified">104     VM&amp; vm = globalObject-&gt;vm();</span>
105     auto scope = DECLARE_THROW_SCOPE(vm);
<a name="3" id="anc3"></a>
106     if (!buffer) {
<a name="4" id="anc4"></a><span class="line-modified">107         throwOutOfMemoryError(globalObject, scope);</span>
108         return nullptr;
109     }
110     switch (type) {
111     case kJSTypedArrayTypeInt8Array:
<a name="5" id="anc5"></a><span class="line-modified">112         return JSInt8Array::create(globalObject, globalObject-&gt;typedArrayStructure(TypeInt8), WTFMove(buffer), offset, length);</span>
113     case kJSTypedArrayTypeInt16Array:
<a name="6" id="anc6"></a><span class="line-modified">114         return JSInt16Array::create(globalObject, globalObject-&gt;typedArrayStructure(TypeInt16), WTFMove(buffer), offset, length);</span>
115     case kJSTypedArrayTypeInt32Array:
<a name="7" id="anc7"></a><span class="line-modified">116         return JSInt32Array::create(globalObject, globalObject-&gt;typedArrayStructure(TypeInt32), WTFMove(buffer), offset, length);</span>
117     case kJSTypedArrayTypeUint8Array:
<a name="8" id="anc8"></a><span class="line-modified">118         return JSUint8Array::create(globalObject, globalObject-&gt;typedArrayStructure(TypeUint8), WTFMove(buffer), offset, length);</span>
119     case kJSTypedArrayTypeUint8ClampedArray:
<a name="9" id="anc9"></a><span class="line-modified">120         return JSUint8ClampedArray::create(globalObject, globalObject-&gt;typedArrayStructure(TypeUint8Clamped), WTFMove(buffer), offset, length);</span>
121     case kJSTypedArrayTypeUint16Array:
<a name="10" id="anc10"></a><span class="line-modified">122         return JSUint16Array::create(globalObject, globalObject-&gt;typedArrayStructure(TypeUint16), WTFMove(buffer), offset, length);</span>
123     case kJSTypedArrayTypeUint32Array:
<a name="11" id="anc11"></a><span class="line-modified">124         return JSUint32Array::create(globalObject, globalObject-&gt;typedArrayStructure(TypeUint32), WTFMove(buffer), offset, length);</span>
125     case kJSTypedArrayTypeFloat32Array:
<a name="12" id="anc12"></a><span class="line-modified">126         return JSFloat32Array::create(globalObject, globalObject-&gt;typedArrayStructure(TypeFloat32), WTFMove(buffer), offset, length);</span>
127     case kJSTypedArrayTypeFloat64Array:
<a name="13" id="anc13"></a><span class="line-modified">128         return JSFloat64Array::create(globalObject, globalObject-&gt;typedArrayStructure(TypeFloat64), WTFMove(buffer), offset, length);</span>
129     case kJSTypedArrayTypeArrayBuffer:
130     case kJSTypedArrayTypeNone:
131         RELEASE_ASSERT_NOT_REACHED();
132     }
133     return nullptr;
134 }
135 
136 // Implementations of the API functions.
137 
138 JSTypedArrayType JSValueGetTypedArrayType(JSContextRef ctx, JSValueRef valueRef, JSValueRef*)
139 {
140 
<a name="14" id="anc14"></a><span class="line-modified">141     JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">142     VM&amp; vm = globalObject-&gt;vm();</span>
143     JSLockHolder locker(vm);
144 
<a name="15" id="anc15"></a><span class="line-modified">145     JSValue value = toJS(globalObject, valueRef);</span>
146     if (!value.isObject())
147         return kJSTypedArrayTypeNone;
148     JSObject* object = value.getObject();
149 
150     if (jsDynamicCast&lt;JSArrayBuffer*&gt;(vm, object))
151         return kJSTypedArrayTypeArrayBuffer;
152 
153     return toJSTypedArrayType(object-&gt;classInfo(vm)-&gt;typedArrayStorageType);
154 }
155 
156 JSObjectRef JSObjectMakeTypedArray(JSContextRef ctx, JSTypedArrayType arrayType, size_t length, JSValueRef* exception)
157 {
<a name="16" id="anc16"></a><span class="line-modified">158     JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">159     VM&amp; vm = globalObject-&gt;vm();</span>
160     JSLockHolder locker(vm);
161     auto scope = DECLARE_CATCH_SCOPE(vm);
162 
163     if (arrayType == kJSTypedArrayTypeNone || arrayType == kJSTypedArrayTypeArrayBuffer)
164         return nullptr;
165 
166     unsigned elementByteSize = elementSize(toTypedArrayType(arrayType));
167 
168     auto buffer = ArrayBuffer::tryCreate(length, elementByteSize);
<a name="17" id="anc17"></a><span class="line-modified">169     JSObject* result = createTypedArray(globalObject, arrayType, WTFMove(buffer), 0, length);</span>
<span class="line-modified">170     if (handleExceptionIfNeeded(scope, ctx, exception) == ExceptionStatus::DidThrow)</span>
171         return nullptr;
172     return toRef(result);
173 }
174 
175 JSObjectRef JSObjectMakeTypedArrayWithBytesNoCopy(JSContextRef ctx, JSTypedArrayType arrayType, void* bytes, size_t length, JSTypedArrayBytesDeallocator destructor, void* destructorContext, JSValueRef* exception)
176 {
<a name="18" id="anc18"></a><span class="line-modified">177     JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">178     VM&amp; vm = globalObject-&gt;vm();</span>
179     JSLockHolder locker(vm);
180     auto scope = DECLARE_CATCH_SCOPE(vm);
181 
182     if (arrayType == kJSTypedArrayTypeNone || arrayType == kJSTypedArrayTypeArrayBuffer)
183         return nullptr;
184 
185     unsigned elementByteSize = elementSize(toTypedArrayType(arrayType));
186 
<a name="19" id="anc19"></a><span class="line-modified">187     auto buffer = ArrayBuffer::createFromBytes(bytes, length, createSharedTask&lt;void(void*)&gt;([=](void* p) {</span>
188         if (destructor)
189             destructor(p, destructorContext);
<a name="20" id="anc20"></a><span class="line-modified">190     }));</span>
<span class="line-modified">191     JSObject* result = createTypedArray(globalObject, arrayType, WTFMove(buffer), 0, length / elementByteSize);</span>
<span class="line-modified">192     if (handleExceptionIfNeeded(scope, ctx, exception) == ExceptionStatus::DidThrow)</span>
193         return nullptr;
194     return toRef(result);
195 }
196 
197 JSObjectRef JSObjectMakeTypedArrayWithArrayBuffer(JSContextRef ctx, JSTypedArrayType arrayType, JSObjectRef jsBufferRef, JSValueRef* exception)
198 {
<a name="21" id="anc21"></a><span class="line-modified">199     JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">200     VM&amp; vm = globalObject-&gt;vm();</span>
201     JSLockHolder locker(vm);
202     auto scope = DECLARE_CATCH_SCOPE(vm);
203 
204     if (arrayType == kJSTypedArrayTypeNone || arrayType == kJSTypedArrayTypeArrayBuffer)
205         return nullptr;
206 
207     JSArrayBuffer* jsBuffer = jsDynamicCast&lt;JSArrayBuffer*&gt;(vm, toJS(jsBufferRef));
208     if (!jsBuffer) {
<a name="22" id="anc22"></a><span class="line-modified">209         setException(ctx, exception, createTypeError(globalObject, &quot;JSObjectMakeTypedArrayWithArrayBuffer expects buffer to be an Array Buffer object&quot;));</span>
210         return nullptr;
211     }
212 
213     RefPtr&lt;ArrayBuffer&gt; buffer = jsBuffer-&gt;impl();
214     unsigned elementByteSize = elementSize(toTypedArrayType(arrayType));
215 
<a name="23" id="anc23"></a><span class="line-modified">216     JSObject* result = createTypedArray(globalObject, arrayType, WTFMove(buffer), 0, buffer-&gt;byteLength() / elementByteSize);</span>
<span class="line-modified">217     if (handleExceptionIfNeeded(scope, ctx, exception) == ExceptionStatus::DidThrow)</span>
218         return nullptr;
219     return toRef(result);
220 }
221 
222 JSObjectRef JSObjectMakeTypedArrayWithArrayBufferAndOffset(JSContextRef ctx, JSTypedArrayType arrayType, JSObjectRef jsBufferRef, size_t offset, size_t length, JSValueRef* exception)
223 {
<a name="24" id="anc24"></a><span class="line-modified">224     JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">225     VM&amp; vm = globalObject-&gt;vm();</span>
226     JSLockHolder locker(vm);
227     auto scope = DECLARE_CATCH_SCOPE(vm);
228 
229     if (arrayType == kJSTypedArrayTypeNone || arrayType == kJSTypedArrayTypeArrayBuffer)
230         return nullptr;
231 
232     JSArrayBuffer* jsBuffer = jsDynamicCast&lt;JSArrayBuffer*&gt;(vm, toJS(jsBufferRef));
233     if (!jsBuffer) {
<a name="25" id="anc25"></a><span class="line-modified">234         setException(ctx, exception, createTypeError(globalObject, &quot;JSObjectMakeTypedArrayWithArrayBuffer expects buffer to be an Array Buffer object&quot;));</span>
235         return nullptr;
236     }
237 
<a name="26" id="anc26"></a><span class="line-modified">238     JSObject* result = createTypedArray(globalObject, arrayType, jsBuffer-&gt;impl(), offset, length);</span>
<span class="line-modified">239     if (handleExceptionIfNeeded(scope, ctx, exception) == ExceptionStatus::DidThrow)</span>
240         return nullptr;
241     return toRef(result);
242 }
243 
244 void* JSObjectGetTypedArrayBytesPtr(JSContextRef ctx, JSObjectRef objectRef, JSValueRef*)
245 {
<a name="27" id="anc27"></a><span class="line-modified">246     JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">247     VM&amp; vm = globalObject-&gt;vm();</span>
248     JSLockHolder locker(vm);
249     JSObject* object = toJS(objectRef);
250 
251     if (JSArrayBufferView* typedArray = jsDynamicCast&lt;JSArrayBufferView*&gt;(vm, object)) {
252         ArrayBuffer* buffer = typedArray-&gt;possiblySharedBuffer();
253         buffer-&gt;pinAndLock();
254         return buffer-&gt;data();
255     }
256     return nullptr;
257 }
258 
259 size_t JSObjectGetTypedArrayLength(JSContextRef ctx, JSObjectRef objectRef, JSValueRef*)
260 {
<a name="28" id="anc28"></a><span class="line-modified">261     JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">262     VM&amp; vm = globalObject-&gt;vm();</span>
263     JSObject* object = toJS(objectRef);
264 
265     if (JSArrayBufferView* typedArray = jsDynamicCast&lt;JSArrayBufferView*&gt;(vm, object))
266         return typedArray-&gt;length();
267 
268     return 0;
269 }
270 
271 size_t JSObjectGetTypedArrayByteLength(JSContextRef ctx, JSObjectRef objectRef, JSValueRef*)
272 {
<a name="29" id="anc29"></a><span class="line-modified">273     JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">274     VM&amp; vm = globalObject-&gt;vm();</span>
275     JSObject* object = toJS(objectRef);
276 
277     if (JSArrayBufferView* typedArray = jsDynamicCast&lt;JSArrayBufferView*&gt;(vm, object))
278         return typedArray-&gt;length() * elementSize(typedArray-&gt;classInfo(vm)-&gt;typedArrayStorageType);
279 
280     return 0;
281 }
282 
283 size_t JSObjectGetTypedArrayByteOffset(JSContextRef ctx, JSObjectRef objectRef, JSValueRef*)
284 {
<a name="30" id="anc30"></a><span class="line-modified">285     JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">286     VM&amp; vm = globalObject-&gt;vm();</span>
287     JSObject* object = toJS(objectRef);
288 
289     if (JSArrayBufferView* typedArray = jsDynamicCast&lt;JSArrayBufferView*&gt;(vm, object))
290         return typedArray-&gt;byteOffset();
291 
292     return 0;
293 }
294 
295 JSObjectRef JSObjectGetTypedArrayBuffer(JSContextRef ctx, JSObjectRef objectRef, JSValueRef*)
296 {
<a name="31" id="anc31"></a><span class="line-modified">297     JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">298     VM&amp; vm = globalObject-&gt;vm();</span>
299     JSLockHolder locker(vm);
300     JSObject* object = toJS(objectRef);
301 
302     if (JSArrayBufferView* typedArray = jsDynamicCast&lt;JSArrayBufferView*&gt;(vm, object))
<a name="32" id="anc32"></a><span class="line-modified">303         return toRef(vm.m_typedArrayController-&gt;toJS(globalObject, typedArray-&gt;globalObject(vm), typedArray-&gt;possiblySharedBuffer()));</span>
304 
305     return nullptr;
306 }
307 
308 JSObjectRef JSObjectMakeArrayBufferWithBytesNoCopy(JSContextRef ctx, void* bytes, size_t byteLength, JSTypedArrayBytesDeallocator bytesDeallocator, void* deallocatorContext, JSValueRef* exception)
309 {
<a name="33" id="anc33"></a><span class="line-modified">310     JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">311     VM&amp; vm = globalObject-&gt;vm();</span>
312     JSLockHolder locker(vm);
313     auto scope = DECLARE_CATCH_SCOPE(vm);
314 
<a name="34" id="anc34"></a><span class="line-modified">315     auto buffer = ArrayBuffer::createFromBytes(bytes, byteLength, createSharedTask&lt;void(void*)&gt;([=](void* p) {</span>
316         if (bytesDeallocator)
317             bytesDeallocator(p, deallocatorContext);
<a name="35" id="anc35"></a><span class="line-modified">318     }));</span>
319 
<a name="36" id="anc36"></a><span class="line-modified">320     JSArrayBuffer* jsBuffer = JSArrayBuffer::create(vm, globalObject-&gt;arrayBufferStructure(ArrayBufferSharingMode::Default), WTFMove(buffer));</span>
<span class="line-modified">321     if (handleExceptionIfNeeded(scope, ctx, exception) == ExceptionStatus::DidThrow)</span>
322         return nullptr;
323 
324     return toRef(jsBuffer);
325 }
326 
327 void* JSObjectGetArrayBufferBytesPtr(JSContextRef ctx, JSObjectRef objectRef, JSValueRef* exception)
328 {
<a name="37" id="anc37"></a><span class="line-modified">329     JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">330     VM&amp; vm = globalObject-&gt;vm();</span>
331     JSLockHolder locker(vm);
332     JSObject* object = toJS(objectRef);
333 
334     if (JSArrayBuffer* jsBuffer = jsDynamicCast&lt;JSArrayBuffer*&gt;(vm, object)) {
335         ArrayBuffer* buffer = jsBuffer-&gt;impl();
336         if (buffer-&gt;isWasmMemory()) {
<a name="38" id="anc38"></a><span class="line-modified">337             setException(ctx, exception, createTypeError(globalObject, &quot;Cannot get the backing buffer for a WebAssembly.Memory&quot;_s));</span>
338             return nullptr;
339         }
340 
341         buffer-&gt;pinAndLock();
342         return buffer-&gt;data();
343     }
344     return nullptr;
345 }
346 
347 size_t JSObjectGetArrayBufferByteLength(JSContextRef ctx, JSObjectRef objectRef, JSValueRef*)
348 {
<a name="39" id="anc39"></a><span class="line-modified">349     JSGlobalObject* globalObject = toJS(ctx);</span>
<span class="line-modified">350     VM&amp; vm = globalObject-&gt;vm();</span>
351     JSObject* object = toJS(objectRef);
352 
353     if (JSArrayBuffer* jsBuffer = jsDynamicCast&lt;JSArrayBuffer*&gt;(vm, object))
354         return jsBuffer-&gt;impl()-&gt;byteLength();
355 
356     return 0;
357 }
<a name="40" id="anc40"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="40" type="hidden" />
</body>
</html>