<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/wasm/WasmCallee.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WasmCallee.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="WasmCallingConvention.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/wasm/WasmCallee.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -29,111 +29,133 @@</span>
  
  #include &quot;B3Compilation.h&quot;
  #include &quot;RegisterAtOffsetList.h&quot;
  #include &quot;WasmCompilationMode.h&quot;
  #include &quot;WasmFormat.h&quot;
<span class="udiff-line-added">+ #include &quot;WasmFunctionCodeBlock.h&quot;</span>
  #include &quot;WasmIndexOrName.h&quot;
  #include &quot;WasmTierUpCount.h&quot;
  #include &lt;wtf/ThreadSafeRefCounted.h&gt;
  
<span class="udiff-line-modified-removed">- namespace JSC { namespace Wasm {</span>
<span class="udiff-line-modified-added">+ namespace JSC {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ class LLIntOffsetsExtractor;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ namespace Wasm {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ class OMGForOSREntryCallee;</span>
  
  class Callee : public ThreadSafeRefCounted&lt;Callee&gt; {
      WTF_MAKE_FAST_ALLOCATED;
<span class="udiff-line-added">+ </span>
  public:
<span class="udiff-line-modified-removed">-     MacroAssemblerCodePtr&lt;WasmEntryPtrTag&gt; entrypoint() const { return m_entrypoint.compilation-&gt;code().retagged&lt;WasmEntryPtrTag&gt;(); }</span>
<span class="udiff-line-modified-added">+     JS_EXPORT_PRIVATE virtual ~Callee();</span>
  
<span class="udiff-line-removed">-     RegisterAtOffsetList* calleeSaveRegisters() { return &amp;m_entrypoint.calleeSaveRegisters; }</span>
      IndexOrName indexOrName() const { return m_indexOrName; }
      CompilationMode compilationMode() const { return m_compilationMode; }
  
<span class="udiff-line-modified-removed">-     std::tuple&lt;void*, void*&gt; range() const</span>
<span class="udiff-line-modified-added">+     virtual MacroAssemblerCodePtr&lt;WasmEntryPtrTag&gt; entrypoint() const = 0;</span>
<span class="udiff-line-added">+     virtual RegisterAtOffsetList* calleeSaveRegisters() = 0;</span>
<span class="udiff-line-added">+     virtual std::tuple&lt;void*, void*&gt; range() const = 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     virtual void setOSREntryCallee(Ref&lt;OMGForOSREntryCallee&gt;&amp;&amp;)</span>
      {
<span class="udiff-line-modified-removed">-         void* start = m_entrypoint.compilation-&gt;codeRef().executableMemory()-&gt;start().untaggedPtr();</span>
<span class="udiff-line-removed">-         void* end = m_entrypoint.compilation-&gt;codeRef().executableMemory()-&gt;end().untaggedPtr();</span>
<span class="udiff-line-removed">-         return { start, end };</span>
<span class="udiff-line-modified-added">+         RELEASE_ASSERT_NOT_REACHED();</span>
      }
  
<span class="udiff-line-modified-removed">-     JS_EXPORT_PRIVATE virtual ~Callee();</span>
<span class="udiff-line-modified-added">+     void dump(PrintStream&amp;) const;</span>
  
  protected:
<span class="udiff-line-modified-removed">-     JS_EXPORT_PRIVATE Callee(Wasm::CompilationMode, Wasm::Entrypoint&amp;&amp;);</span>
<span class="udiff-line-modified-removed">-     JS_EXPORT_PRIVATE Callee(Wasm::CompilationMode, Wasm::Entrypoint&amp;&amp;, size_t, std::pair&lt;const Name*, RefPtr&lt;NameSection&gt;&gt;&amp;&amp;);</span>
<span class="udiff-line-modified-added">+     JS_EXPORT_PRIVATE Callee(Wasm::CompilationMode);</span>
<span class="udiff-line-modified-added">+     JS_EXPORT_PRIVATE Callee(Wasm::CompilationMode, size_t, std::pair&lt;const Name*, RefPtr&lt;NameSection&gt;&gt;&amp;&amp;);</span>
  
  private:
      CompilationMode m_compilationMode;
<span class="udiff-line-removed">-     Wasm::Entrypoint m_entrypoint;</span>
      IndexOrName m_indexOrName;
  };
  
<span class="udiff-line-modified-removed">- class OMGCallee final : public Callee {</span>
<span class="udiff-line-modified-added">+ class JITCallee : public Callee {</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+     MacroAssemblerCodePtr&lt;WasmEntryPtrTag&gt; entrypoint() const override { return m_entrypoint.compilation-&gt;code().retagged&lt;WasmEntryPtrTag&gt;(); }</span>
<span class="udiff-line-added">+     RegisterAtOffsetList* calleeSaveRegisters() override { return &amp;m_entrypoint.calleeSaveRegisters; }</span>
<span class="udiff-line-added">+     Vector&lt;UnlinkedWasmToWasmCall&gt;&amp; wasmToWasmCallsites() { return m_wasmToWasmCallsites; }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ protected:</span>
<span class="udiff-line-added">+     JS_EXPORT_PRIVATE JITCallee(Wasm::CompilationMode, Wasm::Entrypoint&amp;&amp;);</span>
<span class="udiff-line-added">+     JS_EXPORT_PRIVATE JITCallee(Wasm::CompilationMode, Wasm::Entrypoint&amp;&amp;, size_t, std::pair&lt;const Name*, RefPtr&lt;NameSection&gt;&gt;&amp;&amp;, Vector&lt;UnlinkedWasmToWasmCall&gt;&amp;&amp;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     std::tuple&lt;void*, void*&gt; range() const override</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         void* start = m_entrypoint.compilation-&gt;codeRef().executableMemory()-&gt;start().untaggedPtr();</span>
<span class="udiff-line-added">+         void* end = m_entrypoint.compilation-&gt;codeRef().executableMemory()-&gt;end().untaggedPtr();</span>
<span class="udiff-line-added">+         return { start, end };</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+     Vector&lt;UnlinkedWasmToWasmCall&gt; m_wasmToWasmCallsites;</span>
<span class="udiff-line-added">+     Wasm::Entrypoint m_entrypoint;</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ class OMGCallee final : public JITCallee {</span>
  public:
      static Ref&lt;OMGCallee&gt; create(Wasm::Entrypoint&amp;&amp; entrypoint, size_t index, std::pair&lt;const Name*, RefPtr&lt;NameSection&gt;&gt;&amp;&amp; name, Vector&lt;UnlinkedWasmToWasmCall&gt;&amp;&amp; unlinkedCalls)
      {
          return adoptRef(*new OMGCallee(WTFMove(entrypoint), index, WTFMove(name), WTFMove(unlinkedCalls)));
      }
  
<span class="udiff-line-removed">-     Vector&lt;UnlinkedWasmToWasmCall&gt;&amp; wasmToWasmCallsites() { return m_wasmToWasmCallsites; }</span>
<span class="udiff-line-removed">- </span>
  private:
      OMGCallee(Wasm::Entrypoint&amp;&amp; entrypoint, size_t index, std::pair&lt;const Name*, RefPtr&lt;NameSection&gt;&gt;&amp;&amp; name, Vector&lt;UnlinkedWasmToWasmCall&gt;&amp;&amp; unlinkedCalls)
<span class="udiff-line-modified-removed">-         : Callee(Wasm::CompilationMode::OMGMode, WTFMove(entrypoint), index, WTFMove(name))</span>
<span class="udiff-line-removed">-         , m_wasmToWasmCallsites(WTFMove(unlinkedCalls))</span>
<span class="udiff-line-modified-added">+         : JITCallee(Wasm::CompilationMode::OMGMode, WTFMove(entrypoint), index, WTFMove(name), WTFMove(unlinkedCalls))</span>
      {
      }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     Vector&lt;UnlinkedWasmToWasmCall&gt; m_wasmToWasmCallsites;</span>
  };
  
<span class="udiff-line-modified-removed">- class OMGForOSREntryCallee final : public Callee {</span>
<span class="udiff-line-modified-added">+ class OMGForOSREntryCallee final : public JITCallee {</span>
  public:
      static Ref&lt;OMGForOSREntryCallee&gt; create(Wasm::Entrypoint&amp;&amp; entrypoint, size_t index, std::pair&lt;const Name*, RefPtr&lt;NameSection&gt;&gt;&amp;&amp; name, unsigned osrEntryScratchBufferSize, uint32_t loopIndex, Vector&lt;UnlinkedWasmToWasmCall&gt;&amp;&amp; unlinkedCalls)
      {
          return adoptRef(*new OMGForOSREntryCallee(WTFMove(entrypoint), index, WTFMove(name), osrEntryScratchBufferSize, loopIndex, WTFMove(unlinkedCalls)));
      }
  
      unsigned osrEntryScratchBufferSize() const { return m_osrEntryScratchBufferSize; }
      uint32_t loopIndex() const { return m_loopIndex; }
<span class="udiff-line-removed">-     Vector&lt;UnlinkedWasmToWasmCall&gt;&amp; wasmToWasmCallsites() { return m_wasmToWasmCallsites; }</span>
  
  private:
      OMGForOSREntryCallee(Wasm::Entrypoint&amp;&amp; entrypoint, size_t index, std::pair&lt;const Name*, RefPtr&lt;NameSection&gt;&gt;&amp;&amp; name, unsigned osrEntryScratchBufferSize, uint32_t loopIndex, Vector&lt;UnlinkedWasmToWasmCall&gt;&amp;&amp; unlinkedCalls)
<span class="udiff-line-modified-removed">-         : Callee(Wasm::CompilationMode::OMGForOSREntryMode, WTFMove(entrypoint), index, WTFMove(name))</span>
<span class="udiff-line-removed">-         , m_wasmToWasmCallsites(WTFMove(unlinkedCalls))</span>
<span class="udiff-line-modified-added">+         : JITCallee(Wasm::CompilationMode::OMGForOSREntryMode, WTFMove(entrypoint), index, WTFMove(name), WTFMove(unlinkedCalls))</span>
          , m_osrEntryScratchBufferSize(osrEntryScratchBufferSize)
          , m_loopIndex(loopIndex)
      {
      }
  
<span class="udiff-line-removed">-     Vector&lt;UnlinkedWasmToWasmCall&gt; m_wasmToWasmCallsites;</span>
      unsigned m_osrEntryScratchBufferSize;
      uint32_t m_loopIndex;
  };
  
<span class="udiff-line-modified-removed">- class EmbedderEntrypointCallee final : public Callee {</span>
<span class="udiff-line-modified-added">+ class EmbedderEntrypointCallee final : public JITCallee {</span>
  public:
      static Ref&lt;EmbedderEntrypointCallee&gt; create(Wasm::Entrypoint&amp;&amp; entrypoint)
      {
          return adoptRef(*new EmbedderEntrypointCallee(WTFMove(entrypoint)));
      }
  
  private:
      EmbedderEntrypointCallee(Wasm::Entrypoint&amp;&amp; entrypoint)
<span class="udiff-line-modified-removed">-         : Callee(Wasm::CompilationMode::EmbedderEntrypointMode, WTFMove(entrypoint))</span>
<span class="udiff-line-modified-added">+         : JITCallee(Wasm::CompilationMode::EmbedderEntrypointMode, WTFMove(entrypoint))</span>
      {
      }
  };
  
<span class="udiff-line-modified-removed">- class BBQCallee final : public Callee {</span>
<span class="udiff-line-modified-added">+ class BBQCallee final : public JITCallee {</span>
  public:
<span class="udiff-line-modified-removed">-     static Ref&lt;BBQCallee&gt; create(Wasm::Entrypoint&amp;&amp; entrypoint, size_t index, std::pair&lt;const Name*, RefPtr&lt;NameSection&gt;&gt;&amp;&amp; name, std::unique_ptr&lt;TierUpCount&gt;&amp;&amp; tierUpCount)</span>
<span class="udiff-line-modified-added">+     static Ref&lt;BBQCallee&gt; create(Wasm::Entrypoint&amp;&amp; entrypoint, size_t index, std::pair&lt;const Name*, RefPtr&lt;NameSection&gt;&gt;&amp;&amp; name, std::unique_ptr&lt;TierUpCount&gt;&amp;&amp; tierUpCount, Vector&lt;UnlinkedWasmToWasmCall&gt;&amp;&amp; unlinkedCalls)</span>
      {
<span class="udiff-line-modified-removed">-         return adoptRef(*new BBQCallee(WTFMove(entrypoint), index, WTFMove(name), WTFMove(tierUpCount)));</span>
<span class="udiff-line-modified-added">+         return adoptRef(*new BBQCallee(WTFMove(entrypoint), index, WTFMove(name), WTFMove(tierUpCount), WTFMove(unlinkedCalls)));</span>
      }
  
      OMGForOSREntryCallee* osrEntryCallee() { return m_osrEntryCallee.get(); }
<span class="udiff-line-modified-removed">-     void setOSREntryCallee(Ref&lt;OMGForOSREntryCallee&gt;&amp;&amp; osrEntryCallee)</span>
<span class="udiff-line-modified-added">+     void setOSREntryCallee(Ref&lt;OMGForOSREntryCallee&gt;&amp;&amp; osrEntryCallee) override</span>
      {
          m_osrEntryCallee = WTFMove(osrEntryCallee);
      }
  
      bool didStartCompilingOSREntryCallee() const { return m_didStartCompilingOSREntryCallee; }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -146,20 +168,88 @@</span>
      }
  
      TierUpCount* tierUpCount() { return m_tierUpCount.get(); }
  
  private:
<span class="udiff-line-modified-removed">-     BBQCallee(Wasm::Entrypoint&amp;&amp; entrypoint, size_t index, std::pair&lt;const Name*, RefPtr&lt;NameSection&gt;&gt;&amp;&amp; name, std::unique_ptr&lt;TierUpCount&gt;&amp;&amp; tierUpCount)</span>
<span class="udiff-line-modified-removed">-         : Callee(Wasm::CompilationMode::BBQMode, WTFMove(entrypoint), index, WTFMove(name))</span>
<span class="udiff-line-modified-added">+     BBQCallee(Wasm::Entrypoint&amp;&amp; entrypoint, size_t index, std::pair&lt;const Name*, RefPtr&lt;NameSection&gt;&gt;&amp;&amp; name, std::unique_ptr&lt;TierUpCount&gt;&amp;&amp; tierUpCount, Vector&lt;UnlinkedWasmToWasmCall&gt;&amp;&amp; unlinkedCalls)</span>
<span class="udiff-line-modified-added">+         : JITCallee(Wasm::CompilationMode::BBQMode, WTFMove(entrypoint), index, WTFMove(name), WTFMove(unlinkedCalls))</span>
          , m_tierUpCount(WTFMove(tierUpCount))
      {
      }
  
      RefPtr&lt;OMGForOSREntryCallee&gt; m_osrEntryCallee;
      RefPtr&lt;OMGCallee&gt; m_replacement;
      std::unique_ptr&lt;TierUpCount&gt; m_tierUpCount;
      bool m_didStartCompilingOSREntryCallee { false };
  };
  
<span class="udiff-line-added">+ class LLIntCallee final : public Callee {</span>
<span class="udiff-line-added">+     friend LLIntOffsetsExtractor;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+     static Ref&lt;LLIntCallee&gt; create(std::unique_ptr&lt;FunctionCodeBlock&gt; codeBlock, size_t index, std::pair&lt;const Name*, RefPtr&lt;NameSection&gt;&gt;&amp;&amp; name)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         return adoptRef(*new LLIntCallee(WTFMove(codeBlock), index, WTFMove(name)));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     JS_EXPORT_PRIVATE void setEntrypoint(MacroAssemblerCodePtr&lt;WasmEntryPtrTag&gt;);</span>
<span class="udiff-line-added">+     JS_EXPORT_PRIVATE MacroAssemblerCodePtr&lt;WasmEntryPtrTag&gt; entrypoint() const override;</span>
<span class="udiff-line-added">+     JS_EXPORT_PRIVATE RegisterAtOffsetList* calleeSaveRegisters() override;</span>
<span class="udiff-line-added">+     JS_EXPORT_PRIVATE std::tuple&lt;void*, void*&gt; range() const override;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     JITCallee* replacement() { return m_replacement.get(); }</span>
<span class="udiff-line-added">+     void setReplacement(Ref&lt;JITCallee&gt;&amp;&amp; replacement)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         m_replacement = WTFMove(replacement);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     OMGForOSREntryCallee* osrEntryCallee() { return m_osrEntryCallee.get(); }</span>
<span class="udiff-line-added">+     void setOSREntryCallee(Ref&lt;OMGForOSREntryCallee&gt;&amp;&amp; osrEntryCallee) override</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         m_osrEntryCallee = WTFMove(osrEntryCallee);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     LLIntTierUpCounter&amp; tierUpCounter() { return m_codeBlock-&gt;tierUpCounter(); }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+     LLIntCallee(std::unique_ptr&lt;FunctionCodeBlock&gt; codeBlock, size_t index, std::pair&lt;const Name*, RefPtr&lt;NameSection&gt;&gt;&amp;&amp; name)</span>
<span class="udiff-line-added">+         : Callee(Wasm::CompilationMode::LLIntMode, index, WTFMove(name))</span>
<span class="udiff-line-added">+         , m_codeBlock(WTFMove(codeBlock))</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         RELEASE_ASSERT(m_codeBlock);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     RefPtr&lt;JITCallee&gt; m_replacement;</span>
<span class="udiff-line-added">+     RefPtr&lt;OMGForOSREntryCallee&gt; m_osrEntryCallee;</span>
<span class="udiff-line-added">+     std::unique_ptr&lt;FunctionCodeBlock&gt; m_codeBlock;</span>
<span class="udiff-line-added">+     MacroAssemblerCodePtr&lt;WasmEntryPtrTag&gt; m_entrypoint;</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ class LLIntCallees : public ThreadSafeRefCounted&lt;LLIntCallees&gt; {</span>
<span class="udiff-line-added">+ public:</span>
<span class="udiff-line-added">+     static Ref&lt;LLIntCallees&gt; create(Vector&lt;Ref&lt;LLIntCallee&gt;&gt;&amp;&amp; llintCallees)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         return adoptRef(*new LLIntCallees(WTFMove(llintCallees)));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     const Ref&lt;LLIntCallee&gt;&amp; at(unsigned i) const</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         return m_llintCallees.at(i);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     const Ref&lt;LLIntCallee&gt;* data() const</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         return m_llintCallees.data();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ private:</span>
<span class="udiff-line-added">+     LLIntCallees(Vector&lt;Ref&lt;LLIntCallee&gt;&gt;&amp;&amp; llintCallees)</span>
<span class="udiff-line-added">+         : m_llintCallees(WTFMove(llintCallees))</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     Vector&lt;Ref&lt;LLIntCallee&gt;&gt; m_llintCallees;</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
  } } // namespace JSC::Wasm
  
  #endif // ENABLE(WEBASSEMBLY)
</pre>
<center><a href="WasmCallee.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="WasmCallingConvention.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>