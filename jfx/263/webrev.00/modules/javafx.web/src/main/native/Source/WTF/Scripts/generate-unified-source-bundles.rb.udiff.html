<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WTF/Scripts/generate-unified-source-bundles.rb</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../JavaScriptCore/yarr/generateYarrCanonicalizeUnicode.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../wtf/AggregateLogger.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/Scripts/generate-unified-source-bundles.rb</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -53,24 +53,27 @@</span>
      puts &quot;--feature-flags                 (-f) Space or semicolon separated list of enabled feature flags&quot;
      puts
      puts &quot;Generation options:&quot;
      puts &quot;--max-cpp-bundle-count               Use global sequential numbers for cpp bundle filenames and set the limit on the number&quot;
      puts &quot;--max-obj-c-bundle-count             Use global sequential numbers for Obj-C bundle filenames and set the limit on the number&quot;
<span class="udiff-line-added">+     puts &quot;--dense-bundle-filter                Densely bundle files matching the given path glob&quot;</span>
      exit 1
  end
  
  MAX_BUNDLE_SIZE = 8
<span class="udiff-line-added">+ MAX_DENSE_BUNDLE_SIZE = 64</span>
  $derivedSourcesPath = nil
  $unifiedSourceOutputPath = nil
  $sourceTreePath = nil
  $featureFlags = {}
  $verbose = false
  $mode = :GenerateBundles
  $inputXCFilelistPath = nil
  $outputXCFilelistPath = nil
  $maxCppBundleCount = nil
  $maxObjCBundleCount = nil
<span class="udiff-line-added">+ $denseBundleFilters = []</span>
  
  def log(text)
      $stderr.puts text if $verbose
  end
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -83,11 +86,12 @@</span>
                 [&#39;--print-all-sources&#39;, GetoptLong::NO_ARGUMENT],
                 [&#39;--generate-xcfilelists&#39;, GetoptLong::NO_ARGUMENT],
                 [&#39;--input-xcfilelist-path&#39;, GetoptLong::REQUIRED_ARGUMENT],
                 [&#39;--output-xcfilelist-path&#39;, GetoptLong::REQUIRED_ARGUMENT],
                 [&#39;--max-cpp-bundle-count&#39;, GetoptLong::REQUIRED_ARGUMENT],
<span class="udiff-line-modified-removed">-                [&#39;--max-obj-c-bundle-count&#39;, GetoptLong::REQUIRED_ARGUMENT]).each {</span>
<span class="udiff-line-modified-added">+                [&#39;--max-obj-c-bundle-count&#39;, GetoptLong::REQUIRED_ARGUMENT],</span>
<span class="udiff-line-added">+                [&#39;--dense-bundle-filter&#39;, GetoptLong::REQUIRED_ARGUMENT]).each {</span>
      | opt, arg |
      case opt
      when &#39;--help&#39;
          usage(nil)
      when &#39;--verbose&#39;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -111,10 +115,12 @@</span>
          $outputXCFilelistPath = arg
      when &#39;--max-cpp-bundle-count&#39;
          $maxCppBundleCount = arg.to_i
      when &#39;--max-obj-c-bundle-count&#39;
          $maxObjCBundleCount = arg.to_i
<span class="udiff-line-added">+     when &#39;--dense-bundle-filter&#39;</span>
<span class="udiff-line-added">+         $denseBundleFilters.push(arg)</span>
      end
  }
  
  $unifiedSourceOutputPath = $derivedSourcesPath + Pathname.new(&quot;unified-sources&quot;)
  FileUtils.mkpath($unifiedSourceOutputPath) if !$unifiedSourceOutputPath.exist? &amp;&amp; $mode != :GenerateXCFilelists
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -192,10 +198,11 @@</span>
          @bundleCount = 0
          @currentBundleText = &quot;&quot;
          @maxCount = max
          @extraFiles = []
          @currentDirectory = nil
<span class="udiff-line-added">+         @lastBundlingPrefix = nil</span>
      end
  
      def writeFile(file, text)
          bundleFile = $unifiedSourceOutputPath + file
          if $mode == :GenerateXCFilelists
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -239,25 +246,37 @@</span>
      end
  
      def addFile(sourceFile)
          path = sourceFile.path
          raise &quot;wrong extension: #{path.extname} expected #{@extension}&quot; unless path.extname == &quot;.#{@extension}&quot;
<span class="udiff-line-modified-removed">-         if (TopLevelDirectoryForPath(@currentDirectory) != TopLevelDirectoryForPath(path.dirname))</span>
<span class="udiff-line-modified-added">+         bundlePrefix, bundleSize = BundlePrefixAndSizeForPath(path)</span>
<span class="udiff-line-added">+         if (@lastBundlingPrefix != bundlePrefix)</span>
              log(&quot;Flushing because new top level directory; old: #{@currentDirectory}, new: #{path.dirname}&quot;)
              flush
<span class="udiff-line-added">+             @lastBundlingPrefix = bundlePrefix</span>
              @currentDirectory = path.dirname
              @bundleCount = 0 unless @maxCount
          end
<span class="udiff-line-modified-removed">-         if @fileCount == MAX_BUNDLE_SIZE</span>
<span class="udiff-line-modified-added">+         if @fileCount &gt;= bundleSize</span>
              log(&quot;Flushing because new bundle is full (#{@fileCount} sources)&quot;)
              flush
          end
          @currentBundleText += &quot;#include \&quot;#{sourceFile}\&quot;\n&quot;
          @fileCount += 1
      end
  end
  
<span class="udiff-line-added">+ def BundlePrefixAndSizeForPath(path)</span>
<span class="udiff-line-added">+     topLevelDirectory = TopLevelDirectoryForPath(path.dirname)</span>
<span class="udiff-line-added">+     $denseBundleFilters.each { |filter|</span>
<span class="udiff-line-added">+         if path.fnmatch(filter)</span>
<span class="udiff-line-added">+             return filter, MAX_DENSE_BUNDLE_SIZE</span>
<span class="udiff-line-added">+         end</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     return topLevelDirectory, MAX_BUNDLE_SIZE</span>
<span class="udiff-line-added">+ end</span>
<span class="udiff-line-added">+ </span>
  def TopLevelDirectoryForPath(path)
      if !path
          return nil
      end
      while path.dirname != path.dirname.dirname
</pre>
<center><a href="../../JavaScriptCore/yarr/generateYarrCanonicalizeUnicode.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../wtf/AggregateLogger.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>