<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/bridge/jni/jsc/JavaFieldJSC.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JavaArrayJSC.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JavaFieldJSC.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bridge/jni/jsc/JavaFieldJSC.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 51     if (fieldType)
 52         fieldTypeName = static_cast&lt;jstring&gt;(callJNIMethod&lt;jobject&gt;(fieldType, &quot;getName&quot;, &quot;()Ljava/lang/String;&quot;));
 53     if (!fieldTypeName)
 54         fieldTypeName = env-&gt;NewStringUTF(&quot;&lt;Unknown&gt;&quot;);
 55     m_typeClassName = JavaString(env, fieldTypeName);
 56 
 57     m_type = javaTypeFromClassName(m_typeClassName.utf8());
 58     env-&gt;DeleteLocalRef(fieldType);
 59     env-&gt;DeleteLocalRef(fieldTypeName);
 60 
 61     // Get field name
 62     jstring fieldName = static_cast&lt;jstring&gt;(callJNIMethod&lt;jobject&gt;(aField, &quot;getName&quot;, &quot;()Ljava/lang/String;&quot;));
 63     if (!fieldName)
 64         fieldName = env-&gt;NewStringUTF(&quot;&lt;Unknown&gt;&quot;);
 65     m_name = JavaString(env, fieldName);
 66     env-&gt;DeleteLocalRef(fieldName);
 67 
 68     m_field = JobjectWrapper::create(aField);
 69 }
 70 
<span class="line-modified"> 71 JSValue JavaField::valueFromInstance(ExecState* exec, const Instance* i) const</span>
 72 {
 73     const JavaInstance* instance = static_cast&lt;const JavaInstance*&gt;(i);
 74 
 75     JSValue jsresult = jsUndefined();
 76     jobject jfield = m_field-&gt;instance();
 77     // Since jfield is WeakGlobalRef, creating a localref to safeguard instance() from GC
 78     JLObject jlfield(jfield, true);
 79 
 80     if (!jlfield) {
 81         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaField::valueFromInstance&quot;, (jobject)jlfield);
 82         return jsresult;
 83     }
 84 
 85     jobject jinstance = instance-&gt;javaInstance();
 86     // Since jinstance is WeakGlobalRef, creating a localref to safeguard instance() from GC
 87     JLObject jlinstance(jinstance, true);
 88 
 89     if (!jlinstance) {
 90         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaField::valueFromInstance&quot;, (jobject)jlinstance);
 91         return jsresult;
 92     }
 93 
 94     switch (m_type) {
 95     case JavaTypeArray:
 96     case JavaTypeObject:
 97     // Since we can&#39;t convert java.lang.Character to any JS primitive, we have
 98     // to treat it as JS foreign object.
 99     case JavaTypeChar:
100         {
101             jobject anObject = callJNIMethod&lt;jobject&gt;(jfield, &quot;get&quot;, &quot;(Ljava/lang/Object;)Ljava/lang/Object;&quot;, jinstance);
102             if (!anObject)
103                 return jsNull();
104 
105             const char* arrayType = typeClassName();
106             if (arrayType[0] == &#39;[&#39;)
<span class="line-modified">107                 jsresult = JavaArray::convertJObjectToArray(exec, anObject, arrayType, instance-&gt;rootObject(), instance-&gt;accessControlContext());</span>
108             else if (anObject)
109 
<span class="line-modified">110             jsresult = toJS(exec, WebCore::Java_Object_to_JSValue(getJNIEnv(), toRef(exec), instance-&gt;rootObject(), anObject, instance-&gt;accessControlContext()));</span>
111         }
112         break;
113 
114     case JavaTypeBoolean:
115         jsresult = jsBoolean(callJNIMethod&lt;jboolean&gt;(jfield, &quot;getBoolean&quot;, &quot;(Ljava/lang/Object;)Z&quot;, jinstance));
116         break;
117 
118     case JavaTypeByte:
119         jsresult = jsNumber(callJNIMethod&lt;jbyte&gt;(jfield, &quot;getByte&quot;, &quot;(Ljava/lang/Object;)B&quot;, jinstance));
120         break;
121 
122     case JavaTypeShort:
123         jsresult = jsNumber(callJNIMethod&lt;jshort&gt;(jfield, &quot;getShort&quot;, &quot;(Ljava/lang/Object;)S&quot;, jinstance));
124         break;
125 
126     case JavaTypeInt:
127         jsresult = jsNumber(static_cast&lt;int&gt;(callJNIMethod&lt;jint&gt;(jfield, &quot;getInt&quot;, &quot;(Ljava/lang/Object;)I&quot;, jinstance)));
128         break;
129 
130     case JavaTypeLong:
131         jsresult = jsNumber(static_cast&lt;double&gt;(callJNIMethod&lt;jlong&gt;(jfield, &quot;getLong&quot;, &quot;(Ljava/lang/Object;)J&quot;, jinstance)));
132         break;
133     case JavaTypeFloat:
134         jsresult = jsNumber(static_cast&lt;double&gt;(callJNIMethod&lt;jfloat&gt;(jfield, &quot;getFloat&quot;, &quot;(Ljava/lang/Object;)F&quot;, jinstance)));
135         break;
136 
137     case JavaTypeDouble:
138         jsresult = jsNumber(static_cast&lt;double&gt;(callJNIMethod&lt;jdouble&gt;(jfield, &quot;getDouble&quot;, &quot;(Ljava/lang/Object;)D&quot;, jinstance)));
139         break;
140 
141     default:
142         break;
143     }
144 
<span class="line-modified">145     LOG(LiveConnect, &quot;JavaField::valueFromInstance getting %s = %s&quot;, String(name().impl()).utf8().data(), jsresult.toString(exec)-&gt;value(exec).ascii().data());</span>
146 
147     return jsresult;
148 }
149 
<span class="line-modified">150 bool JavaField::setValueToInstance(ExecState* exec, const Instance* i, JSValue aValue) const</span>
151 {
152     const JavaInstance* instance = static_cast&lt;const JavaInstance*&gt;(i);
<span class="line-modified">153     jvalue javaValue = convertValueToJValue(exec, i-&gt;rootObject(), aValue, m_type, typeClassName());</span>
<span class="line-modified">154     LOG(LiveConnect, &quot;JavaField::setValueToInstance setting value %s to %s&quot;, String(name().impl()).utf8().data(), aValue.toString(exec)-&gt;value(exec).ascii().data());</span>
155 
156     jobject jfield = m_field-&gt;instance();
157     // Since jfield is WeakGlobalRef, creating a localref to safeguard instance() from GC
158     JLObject jlfield(jfield, true);
159 
160     if (!jlfield) {
161         LOG_ERROR(&quot;Could not get Instance for %p in JavaField::setValueToInstance&quot;, (jobject)jlfield);
162         return false;
163     }
164 
165     jobject jinstance = instance-&gt;javaInstance();
166     // Since jinstance is WeakGlobalRef, creating a localref to safeguard javaInstance() from GC
167     JLObject jlinstance(jinstance, true);
168 
169     if (!jlinstance) {
170         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaField::setValueToInstance&quot;, (jobject)jlinstance);
171         return false;
172     }
173 
174     switch (m_type) {
</pre>
</td>
<td>
<hr />
<pre>
 51     if (fieldType)
 52         fieldTypeName = static_cast&lt;jstring&gt;(callJNIMethod&lt;jobject&gt;(fieldType, &quot;getName&quot;, &quot;()Ljava/lang/String;&quot;));
 53     if (!fieldTypeName)
 54         fieldTypeName = env-&gt;NewStringUTF(&quot;&lt;Unknown&gt;&quot;);
 55     m_typeClassName = JavaString(env, fieldTypeName);
 56 
 57     m_type = javaTypeFromClassName(m_typeClassName.utf8());
 58     env-&gt;DeleteLocalRef(fieldType);
 59     env-&gt;DeleteLocalRef(fieldTypeName);
 60 
 61     // Get field name
 62     jstring fieldName = static_cast&lt;jstring&gt;(callJNIMethod&lt;jobject&gt;(aField, &quot;getName&quot;, &quot;()Ljava/lang/String;&quot;));
 63     if (!fieldName)
 64         fieldName = env-&gt;NewStringUTF(&quot;&lt;Unknown&gt;&quot;);
 65     m_name = JavaString(env, fieldName);
 66     env-&gt;DeleteLocalRef(fieldName);
 67 
 68     m_field = JobjectWrapper::create(aField);
 69 }
 70 
<span class="line-modified"> 71 JSValue JavaField::valueFromInstance(JSGlobalObject* globalObject, const Instance* i) const</span>
 72 {
 73     const JavaInstance* instance = static_cast&lt;const JavaInstance*&gt;(i);
 74 
 75     JSValue jsresult = jsUndefined();
 76     jobject jfield = m_field-&gt;instance();
 77     // Since jfield is WeakGlobalRef, creating a localref to safeguard instance() from GC
 78     JLObject jlfield(jfield, true);
 79 
 80     if (!jlfield) {
 81         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaField::valueFromInstance&quot;, (jobject)jlfield);
 82         return jsresult;
 83     }
 84 
 85     jobject jinstance = instance-&gt;javaInstance();
 86     // Since jinstance is WeakGlobalRef, creating a localref to safeguard instance() from GC
 87     JLObject jlinstance(jinstance, true);
 88 
 89     if (!jlinstance) {
 90         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaField::valueFromInstance&quot;, (jobject)jlinstance);
 91         return jsresult;
 92     }
 93 
 94     switch (m_type) {
 95     case JavaTypeArray:
 96     case JavaTypeObject:
 97     // Since we can&#39;t convert java.lang.Character to any JS primitive, we have
 98     // to treat it as JS foreign object.
 99     case JavaTypeChar:
100         {
101             jobject anObject = callJNIMethod&lt;jobject&gt;(jfield, &quot;get&quot;, &quot;(Ljava/lang/Object;)Ljava/lang/Object;&quot;, jinstance);
102             if (!anObject)
103                 return jsNull();
104 
105             const char* arrayType = typeClassName();
106             if (arrayType[0] == &#39;[&#39;)
<span class="line-modified">107                 jsresult = JavaArray::convertJObjectToArray(globalObject, anObject, arrayType, instance-&gt;rootObject(), instance-&gt;accessControlContext());</span>
108             else if (anObject)
109 
<span class="line-modified">110             jsresult = toJS(globalObject, WebCore::Java_Object_to_JSValue(getJNIEnv(), toRef(globalObject), instance-&gt;rootObject(), anObject, instance-&gt;accessControlContext()));</span>
111         }
112         break;
113 
114     case JavaTypeBoolean:
115         jsresult = jsBoolean(callJNIMethod&lt;jboolean&gt;(jfield, &quot;getBoolean&quot;, &quot;(Ljava/lang/Object;)Z&quot;, jinstance));
116         break;
117 
118     case JavaTypeByte:
119         jsresult = jsNumber(callJNIMethod&lt;jbyte&gt;(jfield, &quot;getByte&quot;, &quot;(Ljava/lang/Object;)B&quot;, jinstance));
120         break;
121 
122     case JavaTypeShort:
123         jsresult = jsNumber(callJNIMethod&lt;jshort&gt;(jfield, &quot;getShort&quot;, &quot;(Ljava/lang/Object;)S&quot;, jinstance));
124         break;
125 
126     case JavaTypeInt:
127         jsresult = jsNumber(static_cast&lt;int&gt;(callJNIMethod&lt;jint&gt;(jfield, &quot;getInt&quot;, &quot;(Ljava/lang/Object;)I&quot;, jinstance)));
128         break;
129 
130     case JavaTypeLong:
131         jsresult = jsNumber(static_cast&lt;double&gt;(callJNIMethod&lt;jlong&gt;(jfield, &quot;getLong&quot;, &quot;(Ljava/lang/Object;)J&quot;, jinstance)));
132         break;
133     case JavaTypeFloat:
134         jsresult = jsNumber(static_cast&lt;double&gt;(callJNIMethod&lt;jfloat&gt;(jfield, &quot;getFloat&quot;, &quot;(Ljava/lang/Object;)F&quot;, jinstance)));
135         break;
136 
137     case JavaTypeDouble:
138         jsresult = jsNumber(static_cast&lt;double&gt;(callJNIMethod&lt;jdouble&gt;(jfield, &quot;getDouble&quot;, &quot;(Ljava/lang/Object;)D&quot;, jinstance)));
139         break;
140 
141     default:
142         break;
143     }
144 
<span class="line-modified">145     LOG(LiveConnect, &quot;JavaField::valueFromInstance getting %s = %s&quot;, String(name().impl()).utf8().data(), jsresult.toString(globalObject)-&gt;value(globalObject).ascii().data());</span>
146 
147     return jsresult;
148 }
149 
<span class="line-modified">150 bool JavaField::setValueToInstance(JSGlobalObject* globalObject, const Instance* i, JSValue aValue) const</span>
151 {
152     const JavaInstance* instance = static_cast&lt;const JavaInstance*&gt;(i);
<span class="line-modified">153     jvalue javaValue = convertValueToJValue(globalObject, i-&gt;rootObject(), aValue, m_type, typeClassName());</span>
<span class="line-modified">154     LOG(LiveConnect, &quot;JavaField::setValueToInstance setting value %s to %s&quot;, String(name().impl()).utf8().data(), aValue.toString(globalObject)-&gt;value(globalObject).ascii().data());</span>
155 
156     jobject jfield = m_field-&gt;instance();
157     // Since jfield is WeakGlobalRef, creating a localref to safeguard instance() from GC
158     JLObject jlfield(jfield, true);
159 
160     if (!jlfield) {
161         LOG_ERROR(&quot;Could not get Instance for %p in JavaField::setValueToInstance&quot;, (jobject)jlfield);
162         return false;
163     }
164 
165     jobject jinstance = instance-&gt;javaInstance();
166     // Since jinstance is WeakGlobalRef, creating a localref to safeguard javaInstance() from GC
167     JLObject jlinstance(jinstance, true);
168 
169     if (!jlinstance) {
170         LOG_ERROR(&quot;Could not get javaInstance for %p in JavaField::setValueToInstance&quot;, (jobject)jlinstance);
171         return false;
172     }
173 
174     switch (m_type) {
</pre>
</td>
</tr>
</table>
<center><a href="JavaArrayJSC.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JavaFieldJSC.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>