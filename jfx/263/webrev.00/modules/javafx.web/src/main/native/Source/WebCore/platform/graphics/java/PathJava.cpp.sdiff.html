<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/java/PathJava.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="NativeImageJava.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../nicosia/NicosiaAnimation.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/java/PathJava.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 29 #include &quot;FloatRect.h&quot;
 30 #include &quot;StrokeStyleApplier.h&quot;
 31 #include &quot;PlatformContextJava.h&quot;
 32 #include &quot;PlatformJavaClasses.h&quot;
 33 #include &quot;NotImplemented.h&quot;
 34 #include &quot;GraphicsContextJava.h&quot;
 35 #include &quot;RQRef.h&quot;
 36 #include &quot;GraphicsContext.h&quot;
 37 #include &quot;ImageBuffer.h&quot;
 38 
 39 #include &lt;wtf/text/WTFString.h&gt;
 40 #include &lt;wtf/java/JavaRef.h&gt;
 41 
 42 #include &quot;com_sun_webkit_graphics_WCPathIterator.h&quot;
 43 
 44 
 45 namespace WebCore {
 46 
 47 static GraphicsContext&amp; scratchContext()
 48 {
<span class="line-modified"> 49     static std::unique_ptr&lt;ImageBuffer&gt; img = ImageBuffer::create(FloatSize(1.f, 1.f), Unaccelerated);</span>
 50     static GraphicsContext &amp;context = img-&gt;context();
 51     return context;
 52 }
 53 
 54 RefPtr&lt;RQRef&gt; createEmptyPath()
 55 {
 56     JNIEnv* env = WTF::GetJavaEnv();
 57     static jmethodID mid = env-&gt;GetMethodID(PG_GetGraphicsManagerClass(env),
 58         &quot;createWCPath&quot;, &quot;()Lcom/sun/webkit/graphics/WCPath;&quot;);
 59     ASSERT(mid);
 60 
 61     JLObject ref(env-&gt;CallObjectMethod(PL_GetGraphicsManager(env), mid));
 62     ASSERT(ref);
 63     WTF::CheckAndClearException(env);
 64     return RQRef::create(ref);
 65 }
 66 
 67 RefPtr&lt;RQRef&gt; copyPath(RefPtr&lt;RQRef&gt; p)
 68 {
 69     if (!p) {
</pre>
<hr />
<pre>
427     static jmethodID mid = env-&gt;GetMethodID(PG_GetPathClass(env),
428         &quot;getPathIterator&quot;, &quot;()Lcom/sun/webkit/graphics/WCPathIterator;&quot;);
429     ASSERT(mid);
430 
431     JLObject iter(env-&gt;CallObjectMethod(*m_path, mid));
432     WTF::CheckAndClearException(env);
433 
434     if (iter) {
435         static jmethodID midIsDone = env-&gt;GetMethodID(PG_GetPathIteratorClass(env),
436             &quot;isDone&quot;, &quot;()Z&quot;);
437         ASSERT(midIsDone);
438 
439         static jmethodID midNext = env-&gt;GetMethodID(PG_GetPathIteratorClass(env),
440             &quot;next&quot;, &quot;()V&quot;);
441         ASSERT(midNext);
442 
443         static jmethodID midCurrentSegment = env-&gt;GetMethodID(PG_GetPathIteratorClass(env),
444             &quot;currentSegment&quot;, &quot;([D)I&quot;);
445         ASSERT(midCurrentSegment);
446 
<span class="line-modified">447         PathElement pelement;</span>
<span class="line-removed">448         FloatPoint points[3];</span>
<span class="line-removed">449         pelement.points = points;</span>
450 
451         JLocalRef&lt;jdoubleArray&gt; coords(env-&gt;NewDoubleArray(6));
452         while(JNI_FALSE == env-&gt;CallBooleanMethod(iter, midIsDone)) {
453             jint type = env-&gt;CallBooleanMethod(
454                 iter,
455                 midCurrentSegment,
456                 (jdoubleArray)coords);
457             jboolean isCopy = JNI_FALSE;
458             jdouble *data = env-&gt;GetDoubleArrayElements(coords, &amp;isCopy);
459             switch (type) {
460             case com_sun_webkit_graphics_WCPathIterator_SEG_MOVETO:
<span class="line-modified">461                 pelement.type = PathElementMoveToPoint;</span>
<span class="line-modified">462                 pelement.points[0] = FloatPoint(data[0],data[1]);</span>
<span class="line-modified">463                 function(pelement);</span>
464                 break;
465             case com_sun_webkit_graphics_WCPathIterator_SEG_LINETO:
<span class="line-modified">466                 pelement.type = PathElementAddLineToPoint;</span>
<span class="line-modified">467                 pelement.points[0] = FloatPoint(data[0],data[1]);</span>
<span class="line-modified">468                 function(pelement);</span>
469                 break;
470             case com_sun_webkit_graphics_WCPathIterator_SEG_QUADTO:
<span class="line-modified">471                 pelement.type = PathElementAddQuadCurveToPoint;</span>
<span class="line-modified">472                 pelement.points[0] = FloatPoint(data[0],data[1]);</span>
<span class="line-modified">473                 pelement.points[1] = FloatPoint(data[2],data[3]);</span>
<span class="line-modified">474                 function(pelement);</span>
475                 break;
476             case com_sun_webkit_graphics_WCPathIterator_SEG_CUBICTO:
<span class="line-modified">477                 pelement.type = PathElementAddCurveToPoint;</span>
<span class="line-modified">478                 pelement.points[0] = FloatPoint(data[0],data[1]);</span>
<span class="line-modified">479                 pelement.points[1] = FloatPoint(data[2],data[3]);</span>
<span class="line-modified">480                 pelement.points[2] = FloatPoint(data[4],data[5]);</span>
<span class="line-modified">481                 function(pelement);</span>
482                 break;
483             case com_sun_webkit_graphics_WCPathIterator_SEG_CLOSE:
<span class="line-modified">484                 pelement.type = PathElementCloseSubpath;</span>
<span class="line-modified">485                 function(pelement);</span>
486                 break;
487             }
488             env-&gt;ReleaseDoubleArrayElements(coords, data, JNI_ABORT);
489             env-&gt;CallVoidMethod(iter, midNext);
490         }
491         WTF::CheckAndClearException(env);
492     }
493 }
494 
<span class="line-modified">495 bool Path::strokeContains(StrokeStyleApplier *applier, const FloatPoint&amp; p) const</span>
496 {
497     ASSERT(m_path);
498 
499     GraphicsContext&amp; gc = scratchContext();
500     gc.save();
501 
502     // Stroke style is set to SolidStroke if the path is not dashed, else it
503     // is unchanged. Setting it to NoStroke enables us to detect the switch.
504     gc.setStrokeStyle(NoStroke);
<span class="line-modified">505 </span>
<span class="line-removed">506     if (applier) {</span>
<span class="line-removed">507         applier-&gt;strokeStyle(&amp;gc);</span>
<span class="line-removed">508     }</span>
509 
510     float thickness = gc.strokeThickness();
511     StrokeStyle strokeStyle = gc.strokeStyle();
512     float miterLimit = gc.platformContext()-&gt;miterLimit();
513     LineCap cap = gc.platformContext()-&gt;lineCap();
514     LineJoin join = gc.platformContext()-&gt;lineJoin();
515     float dashOffset = gc.platformContext()-&gt;dashOffset();
516     DashArray dashes = gc.platformContext()-&gt;dashArray();
517 
518     gc.restore();
519 
520     JNIEnv* env = WTF::GetJavaEnv();
521 
522     static jmethodID mid = env-&gt;GetMethodID(PG_GetPathClass(env), &quot;strokeContains&quot;,
523         &quot;(DDDDIID[D)Z&quot;);
524 
525     ASSERT(mid);
526 
527     size_t size = strokeStyle == SolidStroke ? 0 : dashes.size();
528     JLocalRef&lt;jdoubleArray&gt; dashArray(env-&gt;NewDoubleArray(size));
</pre>
</td>
<td>
<hr />
<pre>
 29 #include &quot;FloatRect.h&quot;
 30 #include &quot;StrokeStyleApplier.h&quot;
 31 #include &quot;PlatformContextJava.h&quot;
 32 #include &quot;PlatformJavaClasses.h&quot;
 33 #include &quot;NotImplemented.h&quot;
 34 #include &quot;GraphicsContextJava.h&quot;
 35 #include &quot;RQRef.h&quot;
 36 #include &quot;GraphicsContext.h&quot;
 37 #include &quot;ImageBuffer.h&quot;
 38 
 39 #include &lt;wtf/text/WTFString.h&gt;
 40 #include &lt;wtf/java/JavaRef.h&gt;
 41 
 42 #include &quot;com_sun_webkit_graphics_WCPathIterator.h&quot;
 43 
 44 
 45 namespace WebCore {
 46 
 47 static GraphicsContext&amp; scratchContext()
 48 {
<span class="line-modified"> 49     static std::unique_ptr&lt;ImageBuffer&gt; img = ImageBuffer::create(FloatSize(1.f, 1.f), RenderingMode::Unaccelerated);</span>
 50     static GraphicsContext &amp;context = img-&gt;context();
 51     return context;
 52 }
 53 
 54 RefPtr&lt;RQRef&gt; createEmptyPath()
 55 {
 56     JNIEnv* env = WTF::GetJavaEnv();
 57     static jmethodID mid = env-&gt;GetMethodID(PG_GetGraphicsManagerClass(env),
 58         &quot;createWCPath&quot;, &quot;()Lcom/sun/webkit/graphics/WCPath;&quot;);
 59     ASSERT(mid);
 60 
 61     JLObject ref(env-&gt;CallObjectMethod(PL_GetGraphicsManager(env), mid));
 62     ASSERT(ref);
 63     WTF::CheckAndClearException(env);
 64     return RQRef::create(ref);
 65 }
 66 
 67 RefPtr&lt;RQRef&gt; copyPath(RefPtr&lt;RQRef&gt; p)
 68 {
 69     if (!p) {
</pre>
<hr />
<pre>
427     static jmethodID mid = env-&gt;GetMethodID(PG_GetPathClass(env),
428         &quot;getPathIterator&quot;, &quot;()Lcom/sun/webkit/graphics/WCPathIterator;&quot;);
429     ASSERT(mid);
430 
431     JLObject iter(env-&gt;CallObjectMethod(*m_path, mid));
432     WTF::CheckAndClearException(env);
433 
434     if (iter) {
435         static jmethodID midIsDone = env-&gt;GetMethodID(PG_GetPathIteratorClass(env),
436             &quot;isDone&quot;, &quot;()Z&quot;);
437         ASSERT(midIsDone);
438 
439         static jmethodID midNext = env-&gt;GetMethodID(PG_GetPathIteratorClass(env),
440             &quot;next&quot;, &quot;()V&quot;);
441         ASSERT(midNext);
442 
443         static jmethodID midCurrentSegment = env-&gt;GetMethodID(PG_GetPathIteratorClass(env),
444             &quot;currentSegment&quot;, &quot;([D)I&quot;);
445         ASSERT(midCurrentSegment);
446 
<span class="line-modified">447         PathElement pathElement;</span>


448 
449         JLocalRef&lt;jdoubleArray&gt; coords(env-&gt;NewDoubleArray(6));
450         while(JNI_FALSE == env-&gt;CallBooleanMethod(iter, midIsDone)) {
451             jint type = env-&gt;CallBooleanMethod(
452                 iter,
453                 midCurrentSegment,
454                 (jdoubleArray)coords);
455             jboolean isCopy = JNI_FALSE;
456             jdouble *data = env-&gt;GetDoubleArrayElements(coords, &amp;isCopy);
457             switch (type) {
458             case com_sun_webkit_graphics_WCPathIterator_SEG_MOVETO:
<span class="line-modified">459                 pathElement.type = PathElement::Type::MoveToPoint;</span>
<span class="line-modified">460                 pathElement.points[0] = FloatPoint(data[0],data[1]);</span>
<span class="line-modified">461                 function(pathElement);</span>
462                 break;
463             case com_sun_webkit_graphics_WCPathIterator_SEG_LINETO:
<span class="line-modified">464                 pathElement.type = PathElement::Type::AddLineToPoint;</span>
<span class="line-modified">465                 pathElement.points[0] = FloatPoint(data[0],data[1]);</span>
<span class="line-modified">466                 function(pathElement);</span>
467                 break;
468             case com_sun_webkit_graphics_WCPathIterator_SEG_QUADTO:
<span class="line-modified">469                 pathElement.type = PathElement::Type::AddQuadCurveToPoint;</span>
<span class="line-modified">470                 pathElement.points[0] = FloatPoint(data[0],data[1]);</span>
<span class="line-modified">471                 pathElement.points[1] = FloatPoint(data[2],data[3]);</span>
<span class="line-modified">472                 function(pathElement);</span>
473                 break;
474             case com_sun_webkit_graphics_WCPathIterator_SEG_CUBICTO:
<span class="line-modified">475                 pathElement.type = PathElement::Type::AddCurveToPoint;</span>
<span class="line-modified">476                 pathElement.points[0] = FloatPoint(data[0],data[1]);</span>
<span class="line-modified">477                 pathElement.points[1] = FloatPoint(data[2],data[3]);</span>
<span class="line-modified">478                 pathElement.points[2] = FloatPoint(data[4],data[5]);</span>
<span class="line-modified">479                 function(pathElement);</span>
480                 break;
481             case com_sun_webkit_graphics_WCPathIterator_SEG_CLOSE:
<span class="line-modified">482                 pathElement.type = PathElement::Type::CloseSubpath;</span>
<span class="line-modified">483                 function(pathElement);</span>
484                 break;
485             }
486             env-&gt;ReleaseDoubleArrayElements(coords, data, JNI_ABORT);
487             env-&gt;CallVoidMethod(iter, midNext);
488         }
489         WTF::CheckAndClearException(env);
490     }
491 }
492 
<span class="line-modified">493 bool Path::strokeContains(StrokeStyleApplier&amp; applier, const FloatPoint&amp; p) const</span>
494 {
495     ASSERT(m_path);
496 
497     GraphicsContext&amp; gc = scratchContext();
498     gc.save();
499 
500     // Stroke style is set to SolidStroke if the path is not dashed, else it
501     // is unchanged. Setting it to NoStroke enables us to detect the switch.
502     gc.setStrokeStyle(NoStroke);
<span class="line-modified">503     applier.strokeStyle(&amp;gc);</span>



504 
505     float thickness = gc.strokeThickness();
506     StrokeStyle strokeStyle = gc.strokeStyle();
507     float miterLimit = gc.platformContext()-&gt;miterLimit();
508     LineCap cap = gc.platformContext()-&gt;lineCap();
509     LineJoin join = gc.platformContext()-&gt;lineJoin();
510     float dashOffset = gc.platformContext()-&gt;dashOffset();
511     DashArray dashes = gc.platformContext()-&gt;dashArray();
512 
513     gc.restore();
514 
515     JNIEnv* env = WTF::GetJavaEnv();
516 
517     static jmethodID mid = env-&gt;GetMethodID(PG_GetPathClass(env), &quot;strokeContains&quot;,
518         &quot;(DDDDIID[D)Z&quot;);
519 
520     ASSERT(mid);
521 
522     size_t size = strokeStyle == SolidStroke ? 0 : dashes.size();
523     JLocalRef&lt;jdoubleArray&gt; dashArray(env-&gt;NewDoubleArray(size));
</pre>
</td>
</tr>
</table>
<center><a href="NativeImageJava.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../nicosia/NicosiaAnimation.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>