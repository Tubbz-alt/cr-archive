<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/libwebrtc/LibWebRTCStatsCollector.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="LibWebRTCRtpTransceiverBackend.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="LibWebRTCStatsCollector.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/libwebrtc/LibWebRTCStatsCollector.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 10  *     notice, this list of conditions and the following disclaimer in the
 11  *     documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 15  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 16  * DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 17  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 18  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 19  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 20  * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 21  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 22  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 23  */
 24 
 25 #include &quot;config.h&quot;
 26 #include &quot;LibWebRTCStatsCollector.h&quot;
 27 
 28 #if USE(LIBWEBRTC)
 29 

 30 #include &quot;JSRTCStatsReport.h&quot;
 31 #include &quot;Performance.h&quot;
 32 #include &lt;wtf/MainThread.h&gt;
 33 
 34 namespace WebCore {
 35 
 36 LibWebRTCStatsCollector::LibWebRTCStatsCollector(CollectorCallback&amp;&amp; callback)
 37     : m_callback(WTFMove(callback))
 38 {
 39 }
 40 
 41 LibWebRTCStatsCollector::~LibWebRTCStatsCollector()
 42 {
 43     if (!m_callback)
 44         return;
 45 
 46     callOnMainThread([callback = WTFMove(m_callback)]() mutable {
<span class="line-modified"> 47         callback();</span>
 48     });
 49 }
 50 
 51 static inline String fromStdString(const std::string&amp; value)
 52 {
 53     return String::fromUTF8(value.data(), value.length());
 54 }
 55 
 56 static inline void fillRTCStats(RTCStatsReport::Stats&amp; stats, const webrtc::RTCStats&amp; rtcStats)
 57 {
 58     stats.timestamp = Performance::reduceTimeResolution(Seconds::fromMicroseconds(rtcStats.timestamp_us())).milliseconds();
 59     stats.id = fromStdString(rtcStats.id());
 60 }
 61 
 62 static inline void fillRTCRTPStreamStats(RTCStatsReport::RTCRTPStreamStats&amp; stats, const webrtc::RTCRTPStreamStats&amp; rtcStats)
 63 {
 64     fillRTCStats(stats, rtcStats);
 65 
 66     if (rtcStats.ssrc.is_defined())
 67         stats.ssrc = *rtcStats.ssrc;
</pre>
<hr />
<pre>
 77         stats.transportId = fromStdString(*rtcStats.transport_id);
 78     if (rtcStats.codec_id.is_defined())
 79         stats.codecId = fromStdString(*rtcStats.codec_id);
 80     if (rtcStats.fir_count.is_defined())
 81         stats.firCount = *rtcStats.fir_count;
 82     if (rtcStats.pli_count.is_defined())
 83         stats.pliCount = *rtcStats.pli_count;
 84     if (rtcStats.nack_count.is_defined())
 85         stats.nackCount = *rtcStats.nack_count;
 86     if (rtcStats.sli_count.is_defined())
 87         stats.sliCount = *rtcStats.sli_count;
 88     if (rtcStats.qp_sum.is_defined())
 89         stats.qpSum = *rtcStats.qp_sum;
 90     stats.qpSum = 0;
 91 }
 92 
 93 static inline void fillInboundRTPStreamStats(RTCStatsReport::InboundRTPStreamStats&amp; stats, const webrtc::RTCInboundRTPStreamStats&amp; rtcStats)
 94 {
 95     fillRTCRTPStreamStats(stats, rtcStats);
 96 

 97     if (rtcStats.packets_received.is_defined())
 98         stats.packetsReceived = *rtcStats.packets_received;
 99     if (rtcStats.bytes_received.is_defined())
100         stats.bytesReceived = *rtcStats.bytes_received;
101     if (rtcStats.packets_lost.is_defined())
102         stats.packetsLost = *rtcStats.packets_lost;
103     if (rtcStats.jitter.is_defined())
104         stats.jitter = *rtcStats.jitter;
<span class="line-modified">105     if (rtcStats.fraction_lost.is_defined())</span>
<span class="line-removed">106         stats.fractionLost = *rtcStats.fraction_lost;</span>
107     if (rtcStats.packets_discarded.is_defined())
108         stats.packetsDiscarded = *rtcStats.packets_discarded;
109     if (rtcStats.packets_repaired.is_defined())
110         stats.packetsRepaired = *rtcStats.packets_repaired;
111     if (rtcStats.burst_packets_lost.is_defined())
112         stats.burstPacketsLost = *rtcStats.burst_packets_lost;
113     if (rtcStats.burst_packets_discarded.is_defined())
114         stats.burstPacketsDiscarded = *rtcStats.burst_packets_discarded;
115     if (rtcStats.burst_loss_count.is_defined())
116         stats.burstLossCount = *rtcStats.burst_loss_count;
117     if (rtcStats.burst_discard_count.is_defined())
118         stats.burstDiscardCount = *rtcStats.burst_discard_count;
119     if (rtcStats.burst_loss_rate.is_defined())
120         stats.burstLossRate = *rtcStats.burst_loss_rate;
121     if (rtcStats.burst_discard_rate.is_defined())
122         stats.burstDiscardRate = *rtcStats.burst_discard_rate;
123     if (rtcStats.gap_loss_rate.is_defined())
124         stats.gapLossRate = *rtcStats.gap_loss_rate;
125     if (rtcStats.gap_discard_rate.is_defined())
126         stats.gapDiscardRate = *rtcStats.gap_discard_rate;
127     if (rtcStats.frames_decoded.is_defined())
128         stats.framesDecoded = *rtcStats.frames_decoded;
129 }
130 
131 static inline void fillOutboundRTPStreamStats(RTCStatsReport::OutboundRTPStreamStats&amp; stats, const webrtc::RTCOutboundRTPStreamStats&amp; rtcStats)
132 {
133     fillRTCRTPStreamStats(stats, rtcStats);
134 

135     if (rtcStats.packets_sent.is_defined())
136         stats.packetsSent = *rtcStats.packets_sent;
137     if (rtcStats.bytes_sent.is_defined())
138         stats.bytesSent = *rtcStats.bytes_sent;
139     if (rtcStats.target_bitrate.is_defined())
140         stats.targetBitrate = *rtcStats.target_bitrate;
141     if (rtcStats.frames_encoded.is_defined())
142         stats.framesEncoded = *rtcStats.frames_encoded;
143 }
144 
145 static inline void fillRTCMediaStreamTrackStats(RTCStatsReport::MediaStreamTrackStats&amp; stats, const webrtc::RTCMediaStreamTrackStats&amp; rtcStats)
146 {
147     fillRTCStats(stats, rtcStats);
148 
149     if (rtcStats.track_identifier.is_defined())
150         stats.trackIdentifier = fromStdString(*rtcStats.track_identifier);
151     if (rtcStats.remote_source.is_defined())
152         stats.remoteSource = *rtcStats.remote_source;
153     if (rtcStats.ended.is_defined())
154         stats.ended = *rtcStats.ended;
</pre>
<hr />
<pre>
332     if (rtcStats.base64_certificate.is_defined())
333         stats.base64Certificate = fromStdString(*rtcStats.base64_certificate);
334     if (rtcStats.issuer_certificate_id.is_defined())
335         stats.issuerCertificateId = fromStdString(*rtcStats.issuer_certificate_id);
336 }
337 
338 static inline void fillRTCCodecStats(RTCStatsReport::CodecStats&amp; stats, const webrtc::RTCCodecStats&amp; rtcStats)
339 {
340     fillRTCStats(stats, rtcStats);
341 
342     if (rtcStats.payload_type.is_defined())
343         stats.payloadType = *rtcStats.payload_type;
344     if (rtcStats.mime_type.is_defined())
345         stats.mimeType = fromStdString(*rtcStats.mime_type);
346     if (rtcStats.clock_rate.is_defined())
347         stats.clockRate = *rtcStats.clock_rate;
348     if (rtcStats.channels.is_defined())
349         stats.channels = *rtcStats.channels;
350     if (rtcStats.sdp_fmtp_line.is_defined())
351         stats.sdpFmtpLine = fromStdString(*rtcStats.sdp_fmtp_line);
<span class="line-removed">352     if (rtcStats.implementation.is_defined())</span>
<span class="line-removed">353         stats.implementation = fromStdString(*rtcStats.implementation);</span>
354 }
355 
356 static inline void fillRTCTransportStats(RTCStatsReport::TransportStats&amp; stats, const webrtc::RTCTransportStats&amp; rtcStats)
357 {
358     fillRTCStats(stats, rtcStats);
359 
360     if (rtcStats.bytes_sent.is_defined())
361         stats.bytesSent = *rtcStats.bytes_sent;
362     if (rtcStats.bytes_received.is_defined())
363         stats.bytesReceived = *rtcStats.bytes_received;
364     if (rtcStats.rtcp_transport_stats_id.is_defined())
365         stats.rtcpTransportStatsId = fromStdString(*rtcStats.rtcp_transport_stats_id);
366     if (rtcStats.selected_candidate_pair_id.is_defined())
367         stats.selectedCandidatePairId = fromStdString(*rtcStats.selected_candidate_pair_id);
368     if (rtcStats.local_certificate_id.is_defined())
369         stats.localCertificateId = fromStdString(*rtcStats.local_certificate_id);
370     if (rtcStats.remote_certificate_id.is_defined())
371         stats.remoteCertificateId = fromStdString(*rtcStats.remote_certificate_id);
372 }
373 
374 static inline void fillRTCPeerConnectionStats(RTCStatsReport::PeerConnectionStats&amp; stats, const webrtc::RTCPeerConnectionStats&amp; rtcStats)
375 {
376     fillRTCStats(stats, rtcStats);
377 
378     if (rtcStats.data_channels_opened.is_defined())
379         stats.dataChannelsOpened = *rtcStats.data_channels_opened;
380     if (rtcStats.data_channels_closed.is_defined())
381         stats.dataChannelsClosed = *rtcStats.data_channels_closed;
382 }
383 
<span class="line-modified">384 void LibWebRTCStatsCollector::OnStatsDelivered(const rtc::scoped_refptr&lt;const webrtc::RTCStatsReport&gt;&amp; rtcReport)</span>
385 {
<span class="line-modified">386     callOnMainThread([protectedThis = rtc::scoped_refptr&lt;LibWebRTCStatsCollector&gt;(this), rtcReport] {</span>
<span class="line-modified">387         auto report = protectedThis-&gt;m_callback();</span>
<span class="line-modified">388         if (!report)</span>
<span class="line-modified">389             return;</span>
<span class="line-modified">390 </span>
<span class="line-modified">391         ASSERT(report-&gt;backingMap());</span>
<span class="line-modified">392 </span>
<span class="line-modified">393         for (const auto&amp; rtcStats : *rtcReport) {</span>
<span class="line-modified">394             if (rtcStats.type() == webrtc::RTCInboundRTPStreamStats::kType) {</span>
<span class="line-modified">395                 RTCStatsReport::InboundRTPStreamStats stats;</span>
<span class="line-modified">396                 fillInboundRTPStreamStats(stats, static_cast&lt;const webrtc::RTCInboundRTPStreamStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">397                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::InboundRTPStreamStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">398             } else if (rtcStats.type() == webrtc::RTCOutboundRTPStreamStats::kType) {</span>
<span class="line-modified">399                 RTCStatsReport::OutboundRTPStreamStats stats;</span>
<span class="line-modified">400                 fillOutboundRTPStreamStats(stats, static_cast&lt;const webrtc::RTCOutboundRTPStreamStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">401                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::OutboundRTPStreamStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">402             } else if (rtcStats.type() == webrtc::RTCMediaStreamTrackStats::kType) {</span>
<span class="line-modified">403                 RTCStatsReport::MediaStreamTrackStats stats;</span>
<span class="line-modified">404                 fillRTCMediaStreamTrackStats(stats, static_cast&lt;const webrtc::RTCMediaStreamTrackStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">405                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::MediaStreamTrackStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">406             } else if (rtcStats.type() == webrtc::RTCDataChannelStats::kType) {</span>
<span class="line-modified">407                 RTCStatsReport::DataChannelStats stats;</span>
<span class="line-modified">408                 fillRTCDataChannelStats(stats, static_cast&lt;const webrtc::RTCDataChannelStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">409                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::DataChannelStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">410             } else if (rtcStats.type() == webrtc::RTCIceCandidatePairStats::kType) {</span>
<span class="line-modified">411                 RTCStatsReport::IceCandidatePairStats stats;</span>
<span class="line-modified">412                 fillRTCIceCandidatePairStats(stats, static_cast&lt;const webrtc::RTCIceCandidatePairStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">413                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::IceCandidatePairStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">414             } else if (rtcStats.type() == webrtc::RTCRemoteIceCandidateStats::kType || rtcStats.type() == webrtc::RTCLocalIceCandidateStats::kType) {</span>
<span class="line-modified">415                 RTCStatsReport::IceCandidateStats stats;</span>
<span class="line-modified">416                 fillRTCIceCandidateStats(stats, static_cast&lt;const webrtc::RTCIceCandidateStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">417                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::IceCandidateStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">418             } else if (rtcStats.type() == webrtc::RTCCertificateStats::kType) {</span>
<span class="line-modified">419                 RTCStatsReport::CertificateStats stats;</span>
<span class="line-modified">420                 fillRTCCertificateStats(stats, static_cast&lt;const webrtc::RTCCertificateStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">421                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::CertificateStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">422             } else if (rtcStats.type() == webrtc::RTCCodecStats::kType) {</span>
<span class="line-modified">423                 RTCStatsReport::CodecStats stats;</span>
<span class="line-modified">424                 fillRTCCodecStats(stats, static_cast&lt;const webrtc::RTCCodecStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">425                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::CodecStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-modified">426             } else if (rtcStats.type() == webrtc::RTCTransportStats::kType) {</span>
<span class="line-removed">427                 RTCStatsReport::TransportStats stats;</span>
<span class="line-removed">428                 fillRTCTransportStats(stats, static_cast&lt;const webrtc::RTCTransportStats&amp;&gt;(rtcStats));</span>
<span class="line-removed">429                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::TransportStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-removed">430             } else if (rtcStats.type() == webrtc::RTCPeerConnectionStats::kType) {</span>
<span class="line-removed">431                 RTCStatsReport::PeerConnectionStats stats;</span>
<span class="line-removed">432                 fillRTCPeerConnectionStats(stats, static_cast&lt;const webrtc::RTCPeerConnectionStats&amp;&gt;(rtcStats));</span>
<span class="line-removed">433                 report-&gt;addStats&lt;IDLDictionary&lt;RTCStatsReport::PeerConnectionStats&gt;&gt;(WTFMove(stats));</span>
<span class="line-removed">434             }</span>
435         }










436     });
437 }
438 
439 }; // namespace WTF
440 
441 
442 #endif // USE(LIBWEBRTC)
</pre>
</td>
<td>
<hr />
<pre>
 10  *     notice, this list of conditions and the following disclaimer in the
 11  *     documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 15  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 16  * DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 17  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 18  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 19  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 20  * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 21  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 22  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 23  */
 24 
 25 #include &quot;config.h&quot;
 26 #include &quot;LibWebRTCStatsCollector.h&quot;
 27 
 28 #if USE(LIBWEBRTC)
 29 
<span class="line-added"> 30 #include &quot;JSDOMMapLike.h&quot;</span>
 31 #include &quot;JSRTCStatsReport.h&quot;
 32 #include &quot;Performance.h&quot;
 33 #include &lt;wtf/MainThread.h&gt;
 34 
 35 namespace WebCore {
 36 
 37 LibWebRTCStatsCollector::LibWebRTCStatsCollector(CollectorCallback&amp;&amp; callback)
 38     : m_callback(WTFMove(callback))
 39 {
 40 }
 41 
 42 LibWebRTCStatsCollector::~LibWebRTCStatsCollector()
 43 {
 44     if (!m_callback)
 45         return;
 46 
 47     callOnMainThread([callback = WTFMove(m_callback)]() mutable {
<span class="line-modified"> 48         callback(nullptr);</span>
 49     });
 50 }
 51 
 52 static inline String fromStdString(const std::string&amp; value)
 53 {
 54     return String::fromUTF8(value.data(), value.length());
 55 }
 56 
 57 static inline void fillRTCStats(RTCStatsReport::Stats&amp; stats, const webrtc::RTCStats&amp; rtcStats)
 58 {
 59     stats.timestamp = Performance::reduceTimeResolution(Seconds::fromMicroseconds(rtcStats.timestamp_us())).milliseconds();
 60     stats.id = fromStdString(rtcStats.id());
 61 }
 62 
 63 static inline void fillRTCRTPStreamStats(RTCStatsReport::RTCRTPStreamStats&amp; stats, const webrtc::RTCRTPStreamStats&amp; rtcStats)
 64 {
 65     fillRTCStats(stats, rtcStats);
 66 
 67     if (rtcStats.ssrc.is_defined())
 68         stats.ssrc = *rtcStats.ssrc;
</pre>
<hr />
<pre>
 78         stats.transportId = fromStdString(*rtcStats.transport_id);
 79     if (rtcStats.codec_id.is_defined())
 80         stats.codecId = fromStdString(*rtcStats.codec_id);
 81     if (rtcStats.fir_count.is_defined())
 82         stats.firCount = *rtcStats.fir_count;
 83     if (rtcStats.pli_count.is_defined())
 84         stats.pliCount = *rtcStats.pli_count;
 85     if (rtcStats.nack_count.is_defined())
 86         stats.nackCount = *rtcStats.nack_count;
 87     if (rtcStats.sli_count.is_defined())
 88         stats.sliCount = *rtcStats.sli_count;
 89     if (rtcStats.qp_sum.is_defined())
 90         stats.qpSum = *rtcStats.qp_sum;
 91     stats.qpSum = 0;
 92 }
 93 
 94 static inline void fillInboundRTPStreamStats(RTCStatsReport::InboundRTPStreamStats&amp; stats, const webrtc::RTCInboundRTPStreamStats&amp; rtcStats)
 95 {
 96     fillRTCRTPStreamStats(stats, rtcStats);
 97 
<span class="line-added"> 98     // FIXME: Add support for decoder_implementation</span>
 99     if (rtcStats.packets_received.is_defined())
100         stats.packetsReceived = *rtcStats.packets_received;
101     if (rtcStats.bytes_received.is_defined())
102         stats.bytesReceived = *rtcStats.bytes_received;
103     if (rtcStats.packets_lost.is_defined())
104         stats.packetsLost = *rtcStats.packets_lost;
105     if (rtcStats.jitter.is_defined())
106         stats.jitter = *rtcStats.jitter;
<span class="line-modified">107     // FIXME: Add support back for fractionLost.</span>

108     if (rtcStats.packets_discarded.is_defined())
109         stats.packetsDiscarded = *rtcStats.packets_discarded;
110     if (rtcStats.packets_repaired.is_defined())
111         stats.packetsRepaired = *rtcStats.packets_repaired;
112     if (rtcStats.burst_packets_lost.is_defined())
113         stats.burstPacketsLost = *rtcStats.burst_packets_lost;
114     if (rtcStats.burst_packets_discarded.is_defined())
115         stats.burstPacketsDiscarded = *rtcStats.burst_packets_discarded;
116     if (rtcStats.burst_loss_count.is_defined())
117         stats.burstLossCount = *rtcStats.burst_loss_count;
118     if (rtcStats.burst_discard_count.is_defined())
119         stats.burstDiscardCount = *rtcStats.burst_discard_count;
120     if (rtcStats.burst_loss_rate.is_defined())
121         stats.burstLossRate = *rtcStats.burst_loss_rate;
122     if (rtcStats.burst_discard_rate.is_defined())
123         stats.burstDiscardRate = *rtcStats.burst_discard_rate;
124     if (rtcStats.gap_loss_rate.is_defined())
125         stats.gapLossRate = *rtcStats.gap_loss_rate;
126     if (rtcStats.gap_discard_rate.is_defined())
127         stats.gapDiscardRate = *rtcStats.gap_discard_rate;
128     if (rtcStats.frames_decoded.is_defined())
129         stats.framesDecoded = *rtcStats.frames_decoded;
130 }
131 
132 static inline void fillOutboundRTPStreamStats(RTCStatsReport::OutboundRTPStreamStats&amp; stats, const webrtc::RTCOutboundRTPStreamStats&amp; rtcStats)
133 {
134     fillRTCRTPStreamStats(stats, rtcStats);
135 
<span class="line-added">136     // FIXME: Add support for encoder_implementation</span>
137     if (rtcStats.packets_sent.is_defined())
138         stats.packetsSent = *rtcStats.packets_sent;
139     if (rtcStats.bytes_sent.is_defined())
140         stats.bytesSent = *rtcStats.bytes_sent;
141     if (rtcStats.target_bitrate.is_defined())
142         stats.targetBitrate = *rtcStats.target_bitrate;
143     if (rtcStats.frames_encoded.is_defined())
144         stats.framesEncoded = *rtcStats.frames_encoded;
145 }
146 
147 static inline void fillRTCMediaStreamTrackStats(RTCStatsReport::MediaStreamTrackStats&amp; stats, const webrtc::RTCMediaStreamTrackStats&amp; rtcStats)
148 {
149     fillRTCStats(stats, rtcStats);
150 
151     if (rtcStats.track_identifier.is_defined())
152         stats.trackIdentifier = fromStdString(*rtcStats.track_identifier);
153     if (rtcStats.remote_source.is_defined())
154         stats.remoteSource = *rtcStats.remote_source;
155     if (rtcStats.ended.is_defined())
156         stats.ended = *rtcStats.ended;
</pre>
<hr />
<pre>
334     if (rtcStats.base64_certificate.is_defined())
335         stats.base64Certificate = fromStdString(*rtcStats.base64_certificate);
336     if (rtcStats.issuer_certificate_id.is_defined())
337         stats.issuerCertificateId = fromStdString(*rtcStats.issuer_certificate_id);
338 }
339 
340 static inline void fillRTCCodecStats(RTCStatsReport::CodecStats&amp; stats, const webrtc::RTCCodecStats&amp; rtcStats)
341 {
342     fillRTCStats(stats, rtcStats);
343 
344     if (rtcStats.payload_type.is_defined())
345         stats.payloadType = *rtcStats.payload_type;
346     if (rtcStats.mime_type.is_defined())
347         stats.mimeType = fromStdString(*rtcStats.mime_type);
348     if (rtcStats.clock_rate.is_defined())
349         stats.clockRate = *rtcStats.clock_rate;
350     if (rtcStats.channels.is_defined())
351         stats.channels = *rtcStats.channels;
352     if (rtcStats.sdp_fmtp_line.is_defined())
353         stats.sdpFmtpLine = fromStdString(*rtcStats.sdp_fmtp_line);


354 }
355 
356 static inline void fillRTCTransportStats(RTCStatsReport::TransportStats&amp; stats, const webrtc::RTCTransportStats&amp; rtcStats)
357 {
358     fillRTCStats(stats, rtcStats);
359 
360     if (rtcStats.bytes_sent.is_defined())
361         stats.bytesSent = *rtcStats.bytes_sent;
362     if (rtcStats.bytes_received.is_defined())
363         stats.bytesReceived = *rtcStats.bytes_received;
364     if (rtcStats.rtcp_transport_stats_id.is_defined())
365         stats.rtcpTransportStatsId = fromStdString(*rtcStats.rtcp_transport_stats_id);
366     if (rtcStats.selected_candidate_pair_id.is_defined())
367         stats.selectedCandidatePairId = fromStdString(*rtcStats.selected_candidate_pair_id);
368     if (rtcStats.local_certificate_id.is_defined())
369         stats.localCertificateId = fromStdString(*rtcStats.local_certificate_id);
370     if (rtcStats.remote_certificate_id.is_defined())
371         stats.remoteCertificateId = fromStdString(*rtcStats.remote_certificate_id);
372 }
373 
374 static inline void fillRTCPeerConnectionStats(RTCStatsReport::PeerConnectionStats&amp; stats, const webrtc::RTCPeerConnectionStats&amp; rtcStats)
375 {
376     fillRTCStats(stats, rtcStats);
377 
378     if (rtcStats.data_channels_opened.is_defined())
379         stats.dataChannelsOpened = *rtcStats.data_channels_opened;
380     if (rtcStats.data_channels_closed.is_defined())
381         stats.dataChannelsClosed = *rtcStats.data_channels_closed;
382 }
383 
<span class="line-modified">384 static inline void initializeRTCStatsReportBackingMap(DOMMapAdapter&amp; report, const webrtc::RTCStatsReport&amp; rtcReport)</span>
385 {
<span class="line-modified">386     for (const auto&amp; rtcStats : rtcReport) {</span>
<span class="line-modified">387         if (rtcStats.type() == webrtc::RTCInboundRTPStreamStats::kType) {</span>
<span class="line-modified">388             RTCStatsReport::InboundRTPStreamStats stats;</span>
<span class="line-modified">389             fillInboundRTPStreamStats(stats, static_cast&lt;const webrtc::RTCInboundRTPStreamStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">390             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::InboundRTPStreamStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">391         } else if (rtcStats.type() == webrtc::RTCOutboundRTPStreamStats::kType) {</span>
<span class="line-modified">392             RTCStatsReport::OutboundRTPStreamStats stats;</span>
<span class="line-modified">393             fillOutboundRTPStreamStats(stats, static_cast&lt;const webrtc::RTCOutboundRTPStreamStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">394             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::OutboundRTPStreamStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">395         } else if (rtcStats.type() == webrtc::RTCMediaStreamTrackStats::kType) {</span>
<span class="line-modified">396             RTCStatsReport::MediaStreamTrackStats stats;</span>
<span class="line-modified">397             fillRTCMediaStreamTrackStats(stats, static_cast&lt;const webrtc::RTCMediaStreamTrackStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">398             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::MediaStreamTrackStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">399         } else if (rtcStats.type() == webrtc::RTCDataChannelStats::kType) {</span>
<span class="line-modified">400             RTCStatsReport::DataChannelStats stats;</span>
<span class="line-modified">401             fillRTCDataChannelStats(stats, static_cast&lt;const webrtc::RTCDataChannelStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">402             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::DataChannelStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">403         } else if (rtcStats.type() == webrtc::RTCIceCandidatePairStats::kType) {</span>
<span class="line-modified">404             RTCStatsReport::IceCandidatePairStats stats;</span>
<span class="line-modified">405             fillRTCIceCandidatePairStats(stats, static_cast&lt;const webrtc::RTCIceCandidatePairStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">406             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::IceCandidatePairStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">407         } else if (rtcStats.type() == webrtc::RTCRemoteIceCandidateStats::kType || rtcStats.type() == webrtc::RTCLocalIceCandidateStats::kType) {</span>
<span class="line-modified">408             RTCStatsReport::IceCandidateStats stats;</span>
<span class="line-modified">409             fillRTCIceCandidateStats(stats, static_cast&lt;const webrtc::RTCIceCandidateStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">410             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::IceCandidateStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">411         } else if (rtcStats.type() == webrtc::RTCCertificateStats::kType) {</span>
<span class="line-modified">412             RTCStatsReport::CertificateStats stats;</span>
<span class="line-modified">413             fillRTCCertificateStats(stats, static_cast&lt;const webrtc::RTCCertificateStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">414             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::CertificateStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">415         } else if (rtcStats.type() == webrtc::RTCCodecStats::kType) {</span>
<span class="line-modified">416             RTCStatsReport::CodecStats stats;</span>
<span class="line-modified">417             fillRTCCodecStats(stats, static_cast&lt;const webrtc::RTCCodecStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">418             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::CodecStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">419         } else if (rtcStats.type() == webrtc::RTCTransportStats::kType) {</span>
<span class="line-modified">420             RTCStatsReport::TransportStats stats;</span>
<span class="line-modified">421             fillRTCTransportStats(stats, static_cast&lt;const webrtc::RTCTransportStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">422             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::TransportStats&gt;&gt;(stats.id, WTFMove(stats));</span>
<span class="line-modified">423         } else if (rtcStats.type() == webrtc::RTCPeerConnectionStats::kType) {</span>
<span class="line-modified">424             RTCStatsReport::PeerConnectionStats stats;</span>
<span class="line-modified">425             fillRTCPeerConnectionStats(stats, static_cast&lt;const webrtc::RTCPeerConnectionStats&amp;&gt;(rtcStats));</span>
<span class="line-modified">426             report.set&lt;IDLDOMString, IDLDictionary&lt;RTCStatsReport::PeerConnectionStats&gt;&gt;(stats.id, WTFMove(stats));</span>








427         }
<span class="line-added">428     }</span>
<span class="line-added">429 }</span>
<span class="line-added">430 </span>
<span class="line-added">431 void LibWebRTCStatsCollector::OnStatsDelivered(const rtc::scoped_refptr&lt;const webrtc::RTCStatsReport&gt;&amp; rtcReport)</span>
<span class="line-added">432 {</span>
<span class="line-added">433     callOnMainThread([this, protectedThis = rtc::scoped_refptr&lt;LibWebRTCStatsCollector&gt;(this), rtcReport]() {</span>
<span class="line-added">434         m_callback(RTCStatsReport::create([rtcReport](auto&amp; mapAdapter) {</span>
<span class="line-added">435             if (rtcReport)</span>
<span class="line-added">436                 initializeRTCStatsReportBackingMap(mapAdapter, *rtcReport);</span>
<span class="line-added">437         }));</span>
438     });
439 }
440 
441 }; // namespace WTF
442 
443 
444 #endif // USE(LIBWEBRTC)
</pre>
</td>
</tr>
</table>
<center><a href="LibWebRTCRtpTransceiverBackend.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="LibWebRTCStatsCollector.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>