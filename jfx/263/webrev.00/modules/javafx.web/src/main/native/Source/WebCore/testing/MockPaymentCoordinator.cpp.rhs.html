<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/testing/MockPaymentCoordinator.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2017-2019 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;MockPaymentCoordinator.h&quot;
 28 
 29 #if ENABLE(APPLE_PAY)
 30 
 31 #include &quot;ApplePaySessionPaymentRequest.h&quot;
 32 #include &quot;MockPayment.h&quot;
 33 #include &quot;MockPaymentContact.h&quot;
 34 #include &quot;MockPaymentMethod.h&quot;
 35 #include &quot;Page.h&quot;
 36 #include &quot;PaymentCoordinator.h&quot;
<a name="1" id="anc1"></a><span class="line-added"> 37 #include &quot;PaymentMethodUpdate.h&quot;</span>
<span class="line-added"> 38 #include &quot;PaymentSessionError.h&quot;</span>
 39 #include &lt;wtf/CompletionHandler.h&gt;
 40 #include &lt;wtf/RunLoop.h&gt;
 41 #include &lt;wtf/URL.h&gt;
 42 
 43 namespace WebCore {
 44 
 45 MockPaymentCoordinator::MockPaymentCoordinator(Page&amp; page)
 46     : m_page { page }
 47 {
 48     m_availablePaymentNetworks.add(&quot;amex&quot;);
 49     m_availablePaymentNetworks.add(&quot;carteBancaire&quot;);
 50     m_availablePaymentNetworks.add(&quot;chinaUnionPay&quot;);
 51     m_availablePaymentNetworks.add(&quot;discover&quot;);
 52     m_availablePaymentNetworks.add(&quot;interac&quot;);
 53     m_availablePaymentNetworks.add(&quot;jcb&quot;);
 54     m_availablePaymentNetworks.add(&quot;masterCard&quot;);
 55     m_availablePaymentNetworks.add(&quot;privateLabel&quot;);
 56     m_availablePaymentNetworks.add(&quot;visa&quot;);
 57 }
 58 
 59 Optional&lt;String&gt; MockPaymentCoordinator::validatedPaymentNetwork(const String&amp; paymentNetwork)
 60 {
 61     auto result = m_availablePaymentNetworks.find(paymentNetwork);
 62     if (result == m_availablePaymentNetworks.end())
 63         return WTF::nullopt;
 64     return *result;
 65 }
 66 
 67 bool MockPaymentCoordinator::canMakePayments()
 68 {
 69     return m_canMakePayments;
 70 }
 71 
 72 void MockPaymentCoordinator::canMakePaymentsWithActiveCard(const String&amp;, const String&amp;, CompletionHandler&lt;void(bool)&gt;&amp;&amp; completionHandler)
 73 {
 74     RunLoop::main().dispatch([completionHandler = WTFMove(completionHandler), canMakePaymentsWithActiveCard = m_canMakePaymentsWithActiveCard]() mutable {
 75         completionHandler(canMakePaymentsWithActiveCard);
 76     });
 77 }
 78 
 79 void MockPaymentCoordinator::openPaymentSetup(const String&amp;, const String&amp;, CompletionHandler&lt;void(bool)&gt;&amp;&amp; completionHandler)
 80 {
 81     RunLoop::main().dispatch([completionHandler = WTFMove(completionHandler)]() mutable {
 82         completionHandler(true);
 83     });
 84 }
 85 
 86 static uint64_t showCount;
 87 static uint64_t hideCount;
 88 
 89 static void dispatchIfShowing(Function&lt;void()&gt;&amp;&amp; function)
 90 {
 91     ASSERT(showCount &gt; hideCount);
 92     RunLoop::main().dispatch([currentShowCount = showCount, function = WTFMove(function)]() {
 93         if (showCount &gt; hideCount &amp;&amp; showCount == currentShowCount)
 94             function();
 95     });
 96 }
 97 
 98 static Vector&lt;ApplePayShippingMethod&gt; convert(const Vector&lt;ApplePaySessionPaymentRequest::ShippingMethod&gt;&amp; shippingMethods)
 99 {
100     return WTF::map(shippingMethods, [] (auto&amp; shippingMethod) {
101         return ApplePayShippingMethod { shippingMethod.label, shippingMethod.detail, shippingMethod.amount, shippingMethod.identifier };
102     });
103 }
104 
105 bool MockPaymentCoordinator::showPaymentUI(const URL&amp;, const Vector&lt;URL&gt;&amp;, const ApplePaySessionPaymentRequest&amp; request)
106 {
107     if (request.shippingContact().pkContact())
108         m_shippingAddress = request.shippingContact().toApplePayPaymentContact(request.version());
109     m_shippingMethods = convert(request.shippingMethods());
110     m_requiredBillingContactFields = request.requiredBillingContactFields();
111     m_requiredShippingContactFields = request.requiredShippingContactFields();
112 
113     ASSERT(showCount == hideCount);
114     ++showCount;
115     dispatchIfShowing([page = &amp;m_page]() {
116         page-&gt;paymentCoordinator().validateMerchant({ URL(), &quot;https://webkit.org/&quot;_s });
117     });
118     return true;
119 }
120 
121 void MockPaymentCoordinator::completeMerchantValidation(const PaymentMerchantSession&amp;)
122 {
123     dispatchIfShowing([page = &amp;m_page, shippingAddress = m_shippingAddress]() mutable {
124         page-&gt;paymentCoordinator().didSelectShippingContact(MockPaymentContact { WTFMove(shippingAddress) });
125     });
126 }
127 
128 static ApplePayLineItem convert(const ApplePaySessionPaymentRequest::LineItem&amp; lineItem)
129 {
130     ApplePayLineItem result;
131     result.type = lineItem.type;
132     result.label = lineItem.label;
133     result.amount = lineItem.amount;
134     return result;
135 }
136 
137 void MockPaymentCoordinator::updateTotalAndLineItems(const ApplePaySessionPaymentRequest::TotalAndLineItems&amp; totalAndLineItems)
138 {
139     m_total = convert(totalAndLineItems.total);
140     m_lineItems.clear();
141     for (auto&amp; lineItem : totalAndLineItems.lineItems)
142         m_lineItems.append(convert(lineItem));
143 }
144 
145 void MockPaymentCoordinator::completeShippingMethodSelection(Optional&lt;ShippingMethodUpdate&gt;&amp;&amp; shippingMethodUpdate)
146 {
147     if (shippingMethodUpdate)
148         updateTotalAndLineItems(shippingMethodUpdate-&gt;newTotalAndLineItems);
149 }
150 
151 void MockPaymentCoordinator::completeShippingContactSelection(Optional&lt;ShippingContactUpdate&gt;&amp;&amp; shippingContactUpdate)
152 {
153     if (!shippingContactUpdate)
154         return;
155 
156     m_shippingMethods = convert(shippingContactUpdate-&gt;newShippingMethods);
157     updateTotalAndLineItems(shippingContactUpdate-&gt;newTotalAndLineItems);
158     m_errors = WTFMove(shippingContactUpdate-&gt;errors);
159 }
160 
161 void MockPaymentCoordinator::completePaymentMethodSelection(Optional&lt;PaymentMethodUpdate&gt;&amp;&amp; paymentMethodUpdate)
162 {
163     if (paymentMethodUpdate)
<a name="2" id="anc2"></a><span class="line-modified">164         updateTotalAndLineItems(paymentMethodUpdate-&gt;totalAndLineItems());</span>
165 }
166 
167 void MockPaymentCoordinator::changeShippingOption(String&amp;&amp; shippingOption)
168 {
169     dispatchIfShowing([page = &amp;m_page, shippingOption = WTFMove(shippingOption)]() mutable {
170         ApplePaySessionPaymentRequest::ShippingMethod shippingMethod;
171         shippingMethod.identifier = WTFMove(shippingOption);
172         page-&gt;paymentCoordinator().didSelectShippingMethod(shippingMethod);
173     });
174 }
175 
176 void MockPaymentCoordinator::changePaymentMethod(ApplePayPaymentMethod&amp;&amp; paymentMethod)
177 {
178     dispatchIfShowing([page = &amp;m_page, paymentMethod = WTFMove(paymentMethod)]() mutable {
179         page-&gt;paymentCoordinator().didSelectPaymentMethod(MockPaymentMethod { WTFMove(paymentMethod) });
180     });
181 }
182 
183 void MockPaymentCoordinator::acceptPayment()
184 {
185     dispatchIfShowing([page = &amp;m_page, shippingAddress = m_shippingAddress]() mutable {
186         ApplePayPayment payment;
187         payment.shippingContact = WTFMove(shippingAddress);
188         page-&gt;paymentCoordinator().didAuthorizePayment(MockPayment { WTFMove(payment) });
189     });
190 }
191 
192 void MockPaymentCoordinator::cancelPayment()
193 {
194     dispatchIfShowing([page = &amp;m_page] {
<a name="3" id="anc3"></a><span class="line-modified">195         page-&gt;paymentCoordinator().didCancelPaymentSession({ });</span>
196         ++hideCount;
197         ASSERT(showCount == hideCount);
198     });
199 }
200 
201 void MockPaymentCoordinator::completePaymentSession(Optional&lt;PaymentAuthorizationResult&gt;&amp;&amp; result)
202 {
203     auto isFinalState = isFinalStateResult(result);
204     m_errors = WTFMove(result-&gt;errors);
205 
206     if (!isFinalState)
207         return;
208 
209     ++hideCount;
210     ASSERT(showCount == hideCount);
211 }
212 
213 void MockPaymentCoordinator::abortPaymentSession()
214 {
215     ++hideCount;
216     ASSERT(showCount == hideCount);
217 }
218 
219 void MockPaymentCoordinator::cancelPaymentSession()
220 {
221     ++hideCount;
222     ASSERT(showCount == hideCount);
223 }
224 
225 void MockPaymentCoordinator::paymentCoordinatorDestroyed()
226 {
227     ASSERT(showCount == hideCount);
228     delete this;
229 }
230 
231 } // namespace WebCore
232 
233 #endif // ENABLE(APPLE_PAY)
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>