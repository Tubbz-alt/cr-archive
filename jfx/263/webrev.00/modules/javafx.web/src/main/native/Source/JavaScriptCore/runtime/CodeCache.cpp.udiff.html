<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/CodeCache.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ClonedArguments.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CodeCache.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/CodeCache.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,17 +24,16 @@</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;CodeCache.h&quot;
  
<span class="udiff-line-added">+ #include &quot;BytecodeGenerator.h&quot;</span>
  #include &quot;IndirectEvalExecutable.h&quot;
  #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  
  namespace JSC {
  
<span class="udiff-line-removed">- const Seconds CodeCacheMap::workingSetTime = 10_s;</span>
<span class="udiff-line-removed">- </span>
  void CodeCacheMap::pruneSlowCase()
  {
      m_minCapacity = std::max(m_size - m_sizeAtLastPrune, static_cast&lt;int64_t&gt;(0));
      m_sizeAtLastPrune = m_size;
      m_timeAtLastPrune = MonotonicTime::now();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -50,10 +49,104 @@</span>
          m_size -= it-&gt;key.length();
          m_map.remove(it);
      }
  }
  
<span class="udiff-line-added">+ static void generateUnlinkedCodeBlockForFunctions(VM&amp; vm, UnlinkedCodeBlock* unlinkedCodeBlock, const SourceCode&amp; parentSource, OptionSet&lt;CodeGenerationMode&gt; codeGenerationMode, ParserError&amp; error)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto generate = [&amp;](UnlinkedFunctionExecutable* unlinkedExecutable, CodeSpecializationKind constructorKind) {</span>
<span class="udiff-line-added">+         if (constructorKind == CodeForConstruct &amp;&amp; SourceParseModeSet(SourceParseMode::AsyncArrowFunctionMode, SourceParseMode::AsyncMethodMode, SourceParseMode::AsyncFunctionMode).contains(unlinkedExecutable-&gt;parseMode()))</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         SourceCode source = unlinkedExecutable-&gt;linkedSourceCode(parentSource);</span>
<span class="udiff-line-added">+         UnlinkedFunctionCodeBlock* unlinkedFunctionCodeBlock = unlinkedExecutable-&gt;unlinkedCodeBlockFor(vm, source, constructorKind, codeGenerationMode, error, unlinkedExecutable-&gt;parseMode());</span>
<span class="udiff-line-added">+         if (unlinkedFunctionCodeBlock)</span>
<span class="udiff-line-added">+             generateUnlinkedCodeBlockForFunctions(vm, unlinkedFunctionCodeBlock, source, codeGenerationMode, error);</span>
<span class="udiff-line-added">+     };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // FIXME: We should also generate CodeBlocks for CodeForConstruct</span>
<span class="udiff-line-added">+     // https://bugs.webkit.org/show_bug.cgi?id=193823</span>
<span class="udiff-line-added">+     for (unsigned i = 0; i &lt; unlinkedCodeBlock-&gt;numberOfFunctionDecls(); i++)</span>
<span class="udiff-line-added">+         generate(unlinkedCodeBlock-&gt;functionDecl(i), CodeForCall);</span>
<span class="udiff-line-added">+     for (unsigned i = 0; i &lt; unlinkedCodeBlock-&gt;numberOfFunctionExprs(); i++)</span>
<span class="udiff-line-added">+         generate(unlinkedCodeBlock-&gt;functionExpr(i), CodeForCall);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ template &lt;class UnlinkedCodeBlockType, class ExecutableType = ScriptExecutable&gt;</span>
<span class="udiff-line-added">+ UnlinkedCodeBlockType* generateUnlinkedCodeBlockImpl(VM&amp; vm, const SourceCode&amp; source, JSParserStrictMode strictMode, JSParserScriptMode scriptMode, OptionSet&lt;CodeGenerationMode&gt; codeGenerationMode, ParserError&amp; error, EvalContextType evalContextType, DerivedContextType derivedContextType, bool isArrowFunctionContext, const VariableEnvironment* variablesUnderTDZ, ExecutableType* executable = nullptr)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     typedef typename CacheTypes&lt;UnlinkedCodeBlockType&gt;::RootNode RootNode;</span>
<span class="udiff-line-added">+     std::unique_ptr&lt;RootNode&gt; rootNode = parse&lt;RootNode&gt;(</span>
<span class="udiff-line-added">+         vm, source, Identifier(), JSParserBuiltinMode::NotBuiltin, strictMode, scriptMode, CacheTypes&lt;UnlinkedCodeBlockType&gt;::parseMode, SuperBinding::NotNeeded, error, nullptr, ConstructorKind::None, derivedContextType, evalContextType);</span>
<span class="udiff-line-added">+     if (!rootNode)</span>
<span class="udiff-line-added">+         return nullptr;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     unsigned lineCount = rootNode-&gt;lastLine() - rootNode-&gt;firstLine();</span>
<span class="udiff-line-added">+     unsigned startColumn = rootNode-&gt;startColumn() + 1;</span>
<span class="udiff-line-added">+     bool endColumnIsOnStartLine = !lineCount;</span>
<span class="udiff-line-added">+     unsigned unlinkedEndColumn = rootNode-&gt;endColumn();</span>
<span class="udiff-line-added">+     unsigned endColumn = unlinkedEndColumn + (endColumnIsOnStartLine ? startColumn : 1);</span>
<span class="udiff-line-added">+     unsigned arrowContextFeature = isArrowFunctionContext ? ArrowFunctionContextFeature : 0;</span>
<span class="udiff-line-added">+     if (executable)</span>
<span class="udiff-line-added">+         executable-&gt;recordParse(rootNode-&gt;features() | arrowContextFeature, rootNode-&gt;hasCapturedVariables(), rootNode-&gt;lastLine(), endColumn);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     bool usesEval = rootNode-&gt;features() &amp; EvalFeature;</span>
<span class="udiff-line-added">+     bool isStrictMode = rootNode-&gt;features() &amp; StrictModeFeature;</span>
<span class="udiff-line-added">+     NeedsClassFieldInitializer needsClassFieldInitializer = NeedsClassFieldInitializer::No;</span>
<span class="udiff-line-added">+     if constexpr (std::is_same_v&lt;ExecutableType, DirectEvalExecutable&gt;)</span>
<span class="udiff-line-added">+         needsClassFieldInitializer = executable-&gt;needsClassFieldInitializer();</span>
<span class="udiff-line-added">+     ExecutableInfo executableInfo(usesEval, isStrictMode, false, false, ConstructorKind::None, scriptMode, SuperBinding::NotNeeded, CacheTypes&lt;UnlinkedCodeBlockType&gt;::parseMode, derivedContextType, needsClassFieldInitializer, isArrowFunctionContext, false, evalContextType);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     UnlinkedCodeBlockType* unlinkedCodeBlock = UnlinkedCodeBlockType::create(vm, executableInfo, codeGenerationMode);</span>
<span class="udiff-line-added">+     unlinkedCodeBlock-&gt;recordParse(rootNode-&gt;features(), rootNode-&gt;hasCapturedVariables(), lineCount, unlinkedEndColumn);</span>
<span class="udiff-line-added">+     if (!source.provider()-&gt;sourceURLDirective().isNull())</span>
<span class="udiff-line-added">+         unlinkedCodeBlock-&gt;setSourceURLDirective(source.provider()-&gt;sourceURLDirective());</span>
<span class="udiff-line-added">+     if (!source.provider()-&gt;sourceMappingURLDirective().isNull())</span>
<span class="udiff-line-added">+         unlinkedCodeBlock-&gt;setSourceMappingURLDirective(source.provider()-&gt;sourceMappingURLDirective());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     error = BytecodeGenerator::generate(vm, rootNode.get(), source, unlinkedCodeBlock, codeGenerationMode, variablesUnderTDZ);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (error.isValid())</span>
<span class="udiff-line-added">+         return nullptr;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return unlinkedCodeBlock;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ template &lt;class UnlinkedCodeBlockType, class ExecutableType&gt;</span>
<span class="udiff-line-added">+ UnlinkedCodeBlockType* generateUnlinkedCodeBlock(VM&amp; vm, ExecutableType* executable, const SourceCode&amp; source, JSParserStrictMode strictMode, JSParserScriptMode scriptMode, OptionSet&lt;CodeGenerationMode&gt; codeGenerationMode, ParserError&amp; error, EvalContextType evalContextType, const VariableEnvironment* variablesUnderTDZ)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return generateUnlinkedCodeBlockImpl&lt;UnlinkedCodeBlockType, ExecutableType&gt;(vm, source, strictMode, scriptMode, codeGenerationMode, error, evalContextType, executable-&gt;derivedContextType(), executable-&gt;isArrowFunctionContext(), variablesUnderTDZ, executable);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ UnlinkedEvalCodeBlock* generateUnlinkedCodeBlockForDirectEval(VM&amp; vm, DirectEvalExecutable* executable, const SourceCode&amp; source, JSParserStrictMode strictMode, JSParserScriptMode scriptMode, OptionSet&lt;CodeGenerationMode&gt; codeGenerationMode, ParserError&amp; error, EvalContextType evalContextType, const VariableEnvironment* variablesUnderTDZ)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return generateUnlinkedCodeBlock&lt;UnlinkedEvalCodeBlock&gt;(vm, executable, source, strictMode, scriptMode, codeGenerationMode, error, evalContextType, variablesUnderTDZ);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ template &lt;class UnlinkedCodeBlockType&gt;</span>
<span class="udiff-line-added">+ std::enable_if_t&lt;!std::is_same&lt;UnlinkedCodeBlockType, UnlinkedEvalCodeBlock&gt;::value, UnlinkedCodeBlockType*&gt;</span>
<span class="udiff-line-added">+ recursivelyGenerateUnlinkedCodeBlock(VM&amp; vm, const SourceCode&amp; source, JSParserStrictMode strictMode, JSParserScriptMode scriptMode, OptionSet&lt;CodeGenerationMode&gt; codeGenerationMode, ParserError&amp; error, EvalContextType evalContextType, const VariableEnvironment* variablesUnderTDZ)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     bool isArrowFunctionContext = false;</span>
<span class="udiff-line-added">+     UnlinkedCodeBlockType* unlinkedCodeBlock = generateUnlinkedCodeBlockImpl&lt;UnlinkedCodeBlockType&gt;(vm, source, strictMode, scriptMode, codeGenerationMode, error, evalContextType, DerivedContextType::None, isArrowFunctionContext, variablesUnderTDZ);</span>
<span class="udiff-line-added">+     if (!unlinkedCodeBlock)</span>
<span class="udiff-line-added">+         return nullptr;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     generateUnlinkedCodeBlockForFunctions(vm, unlinkedCodeBlock, source, codeGenerationMode, error);</span>
<span class="udiff-line-added">+     return unlinkedCodeBlock;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ UnlinkedProgramCodeBlock* recursivelyGenerateUnlinkedCodeBlockForProgram(VM&amp; vm, const SourceCode&amp; source, JSParserStrictMode strictMode, JSParserScriptMode scriptMode, OptionSet&lt;CodeGenerationMode&gt; codeGenerationMode, ParserError&amp; error, EvalContextType evalContextType, const VariableEnvironment* variablesUnderTDZ)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return recursivelyGenerateUnlinkedCodeBlock&lt;UnlinkedProgramCodeBlock&gt;(vm, source, strictMode, scriptMode, codeGenerationMode, error, evalContextType, variablesUnderTDZ);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ UnlinkedModuleProgramCodeBlock* recursivelyGenerateUnlinkedCodeBlockForModuleProgram(VM&amp; vm, const SourceCode&amp; source, JSParserStrictMode strictMode, JSParserScriptMode scriptMode, OptionSet&lt;CodeGenerationMode&gt; codeGenerationMode, ParserError&amp; error, EvalContextType evalContextType, const VariableEnvironment* variablesUnderTDZ)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return recursivelyGenerateUnlinkedCodeBlock&lt;UnlinkedModuleProgramCodeBlock&gt;(vm, source, strictMode, scriptMode, codeGenerationMode, error, evalContextType, variablesUnderTDZ);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  template &lt;class UnlinkedCodeBlockType, class ExecutableType&gt;
  UnlinkedCodeBlockType* CodeCache::getUnlinkedGlobalCodeBlock(VM&amp; vm, ExecutableType* executable, const SourceCode&amp; source, JSParserStrictMode strictMode, JSParserScriptMode scriptMode, OptionSet&lt;CodeGenerationMode&gt; codeGenerationMode, ParserError&amp; error, EvalContextType evalContextType)
  {
      DerivedContextType derivedContextType = executable-&gt;derivedContextType();
      bool isArrowFunctionContext = executable-&gt;isArrowFunctionContext();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -66,13 +159,13 @@</span>
          unsigned lineCount = unlinkedCodeBlock-&gt;lineCount();
          unsigned startColumn = unlinkedCodeBlock-&gt;startColumn() + source.startColumn().oneBasedInt();
          bool endColumnIsOnStartLine = !lineCount;
          unsigned endColumn = unlinkedCodeBlock-&gt;endColumn() + (endColumnIsOnStartLine ? startColumn : 1);
          executable-&gt;recordParse(unlinkedCodeBlock-&gt;codeFeatures(), unlinkedCodeBlock-&gt;hasCapturedVariables(), source.firstLine().oneBasedInt() + lineCount, endColumn);
<span class="udiff-line-modified-removed">-         if (!unlinkedCodeBlock-&gt;sourceURLDirective().isNull())</span>
<span class="udiff-line-modified-added">+         if (unlinkedCodeBlock-&gt;sourceURLDirective())</span>
              source.provider()-&gt;setSourceURLDirective(unlinkedCodeBlock-&gt;sourceURLDirective());
<span class="udiff-line-modified-removed">-         if (!unlinkedCodeBlock-&gt;sourceMappingURLDirective().isNull())</span>
<span class="udiff-line-modified-added">+         if (unlinkedCodeBlock-&gt;sourceMappingURLDirective())</span>
              source.provider()-&gt;setSourceMappingURLDirective(unlinkedCodeBlock-&gt;sourceMappingURLDirective());
          return unlinkedCodeBlock;
      }
  
      VariableEnvironment variablesUnderTDZ;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -149,11 +242,11 @@</span>
      metadata-&gt;overrideName(name);
      metadata-&gt;setEndPosition(positionBeforeLastNewline);
      // The Function constructor only has access to global variables, so no variables will be under TDZ unless they&#39;re
      // in the global lexical environment, which we always TDZ check accesses from.
      ConstructAbility constructAbility = constructAbilityForParseMode(metadata-&gt;parseMode());
<span class="udiff-line-modified-removed">-     UnlinkedFunctionExecutable* functionExecutable = UnlinkedFunctionExecutable::create(vm, source, metadata, UnlinkedNormalFunction, constructAbility, JSParserScriptMode::Classic, WTF::nullopt, DerivedContextType::None);</span>
<span class="udiff-line-modified-added">+     UnlinkedFunctionExecutable* functionExecutable = UnlinkedFunctionExecutable::create(vm, source, metadata, UnlinkedNormalFunction, constructAbility, JSParserScriptMode::Classic, WTF::nullopt, DerivedContextType::None, NeedsClassFieldInitializer::No);</span>
  
      if (!source.provider()-&gt;sourceURLDirective().isNull())
          functionExecutable-&gt;setSourceURLDirective(source.provider()-&gt;sourceURLDirective());
      if (!source.provider()-&gt;sourceMappingURLDirective().isNull())
          functionExecutable-&gt;setSourceMappingURLDirective(source.provider()-&gt;sourceMappingURLDirective());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -172,30 +265,10 @@</span>
  {
      for (auto&amp; it : m_sourceCode)
          writeCodeBlock(vm, it.key, it.value);
  }
  
<span class="udiff-line-removed">- void generateUnlinkedCodeBlockForFunctions(VM&amp; vm, UnlinkedCodeBlock* unlinkedCodeBlock, const SourceCode&amp; parentSource, OptionSet&lt;CodeGenerationMode&gt; codeGenerationMode, ParserError&amp; error)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     auto generate = [&amp;](UnlinkedFunctionExecutable* unlinkedExecutable, CodeSpecializationKind constructorKind) {</span>
<span class="udiff-line-removed">-         if (constructorKind == CodeForConstruct &amp;&amp; SourceParseModeSet(SourceParseMode::AsyncArrowFunctionMode, SourceParseMode::AsyncMethodMode, SourceParseMode::AsyncFunctionMode).contains(unlinkedExecutable-&gt;parseMode()))</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         SourceCode source = unlinkedExecutable-&gt;linkedSourceCode(parentSource);</span>
<span class="udiff-line-removed">-         UnlinkedFunctionCodeBlock* unlinkedFunctionCodeBlock = unlinkedExecutable-&gt;unlinkedCodeBlockFor(vm, source, constructorKind, codeGenerationMode, error, unlinkedExecutable-&gt;parseMode());</span>
<span class="udiff-line-removed">-         if (unlinkedFunctionCodeBlock)</span>
<span class="udiff-line-removed">-             generateUnlinkedCodeBlockForFunctions(vm, unlinkedFunctionCodeBlock, source, codeGenerationMode, error);</span>
<span class="udiff-line-removed">-     };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // FIXME: We should also generate CodeBlocks for CodeForConstruct</span>
<span class="udiff-line-removed">-     // https://bugs.webkit.org/show_bug.cgi?id=193823</span>
<span class="udiff-line-removed">-     for (unsigned i = 0; i &lt; unlinkedCodeBlock-&gt;numberOfFunctionDecls(); i++)</span>
<span class="udiff-line-removed">-         generate(unlinkedCodeBlock-&gt;functionDecl(i), CodeForCall);</span>
<span class="udiff-line-removed">-     for (unsigned i = 0; i &lt; unlinkedCodeBlock-&gt;numberOfFunctionExprs(); i++)</span>
<span class="udiff-line-removed">-         generate(unlinkedCodeBlock-&gt;functionExpr(i), CodeForCall);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  void writeCodeBlock(VM&amp; vm, const SourceCodeKey&amp; key, const SourceCodeValue&amp; value)
  {
      UnlinkedCodeBlock* codeBlock = jsDynamicCast&lt;UnlinkedCodeBlock*&gt;(vm, value.cell.get());
      if (!codeBlock)
          return;
</pre>
<center><a href="ClonedArguments.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CodeCache.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>