<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/workers/service/ServiceWorker.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (C) 2017 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;ServiceWorker.h&quot;
 28 
 29 #if ENABLE(SERVICE_WORKER)
 30 
 31 #include &quot;Document.h&quot;
 32 #include &quot;EventNames.h&quot;
 33 #include &quot;Logging.h&quot;
 34 #include &quot;MessagePort.h&quot;
 35 #include &quot;SWClientConnection.h&quot;
 36 #include &quot;ScriptExecutionContext.h&quot;
 37 #include &quot;SerializedScriptValue.h&quot;
 38 #include &quot;ServiceWorkerClientData.h&quot;
 39 #include &quot;ServiceWorkerContainer.h&quot;
 40 #include &quot;ServiceWorkerGlobalScope.h&quot;
 41 #include &quot;ServiceWorkerProvider.h&quot;
 42 #include &quot;ServiceWorkerThread.h&quot;
 43 #include &quot;WorkerSWClientConnection.h&quot;
 44 #include &lt;JavaScriptCore/JSCJSValueInlines.h&gt;
 45 #include &lt;wtf/IsoMallocInlines.h&gt;
 46 #include &lt;wtf/NeverDestroyed.h&gt;
 47 
 48 #define WORKER_RELEASE_LOG_IF_ALLOWED(fmt, ...) RELEASE_LOG_IF(isAlwaysOnLoggingAllowed(), ServiceWorker, &quot;%p - ServiceWorker::&quot; fmt, this, ##__VA_ARGS__)
 49 #define WORKER_RELEASE_LOG_ERROR_IF_ALLOWED(fmt, ...) RELEASE_LOG_ERROR_IF(isAlwaysOnLoggingAllowed(), ServiceWorker, &quot;%p - ServiceWorker::&quot; fmt, this, ##__VA_ARGS__)
 50 
 51 namespace WebCore {
 52 
 53 WTF_MAKE_ISO_ALLOCATED_IMPL(ServiceWorker);
 54 
 55 Ref&lt;ServiceWorker&gt; ServiceWorker::getOrCreate(ScriptExecutionContext&amp; context, ServiceWorkerData&amp;&amp; data)
 56 {
 57     if (auto existingServiceWorker = context.serviceWorker(data.identifier))
 58         return *existingServiceWorker;
 59     return adoptRef(*new ServiceWorker(context, WTFMove(data)));
 60 }
 61 
 62 ServiceWorker::ServiceWorker(ScriptExecutionContext&amp; context, ServiceWorkerData&amp;&amp; data)
 63     : ActiveDOMObject(&amp;context)
 64     , m_data(WTFMove(data))
 65 {
 66     suspendIfNeeded();
 67 
 68     context.registerServiceWorker(*this);
 69 
 70     relaxAdoptionRequirement();
 71     updatePendingActivityForEventDispatch();
 72 
 73     WORKER_RELEASE_LOG_IF_ALLOWED(&quot;ServiceWorker: ID: %llu, state: %hhu&quot;, identifier().toUInt64(), m_data.state);
 74 }
 75 
 76 ServiceWorker::~ServiceWorker()
 77 {
 78     if (auto* context = scriptExecutionContext())
 79         context-&gt;unregisterServiceWorker(*this);
 80 }
 81 
 82 void ServiceWorker::updateState(State state)
 83 {
 84     WORKER_RELEASE_LOG_IF_ALLOWED(&quot;updateState: Updating service worker %llu state from %hhu to %hhu. Registration ID: %llu&quot;, identifier().toUInt64(), m_data.state, state, registrationIdentifier().toUInt64());
 85     m_data.state = state;
 86     if (state != State::Installing &amp;&amp; !m_isStopped) {
 87         ASSERT(m_pendingActivityForEventDispatch);
 88         dispatchEvent(Event::create(eventNames().statechangeEvent, Event::CanBubble::No, Event::IsCancelable::No));
 89     }
 90 
 91     updatePendingActivityForEventDispatch();
 92 }
 93 
 94 SWClientConnection&amp; ServiceWorker::swConnection()
 95 {
 96     ASSERT(scriptExecutionContext());
 97     if (is&lt;WorkerGlobalScope&gt;(scriptExecutionContext()))
 98         return downcast&lt;WorkerGlobalScope&gt;(scriptExecutionContext())-&gt;swClientConnection();
 99     return ServiceWorkerProvider::singleton().serviceWorkerConnection();
100 }
101 
102 ExceptionOr&lt;void&gt; ServiceWorker::postMessage(JSC::JSGlobalObject&amp; globalObject, JSC::JSValue messageValue, PostMessageOptions&amp;&amp; options)
103 {
104     if (m_isStopped)
105         return Exception { InvalidStateError };
106 
107     Vector&lt;RefPtr&lt;MessagePort&gt;&gt; ports;
108     auto messageData = SerializedScriptValue::create(globalObject, messageValue, WTFMove(options.transfer), ports, SerializationContext::WorkerPostMessage);
109     if (messageData.hasException())
110         return messageData.releaseException();
111 
112     // Disentangle the port in preparation for sending it to the remote context.
113     auto portsOrException = MessagePort::disentanglePorts(WTFMove(ports));
114     if (portsOrException.hasException())
115         return portsOrException.releaseException();
116 
117     auto&amp; context = *scriptExecutionContext();
118     ServiceWorkerOrClientIdentifier sourceIdentifier;
119     if (is&lt;ServiceWorkerGlobalScope&gt;(context))
120         sourceIdentifier = downcast&lt;ServiceWorkerGlobalScope&gt;(context).thread().identifier();
121     else {
122         auto&amp; connection = ServiceWorkerProvider::singleton().serviceWorkerConnection();
123         sourceIdentifier = ServiceWorkerClientIdentifier { connection.serverConnectionIdentifier(), downcast&lt;Document&gt;(context).identifier() };
124     }
125 
126     MessageWithMessagePorts message { messageData.releaseReturnValue(), portsOrException.releaseReturnValue() };
127     swConnection().postMessageToServiceWorker(identifier(), WTFMove(message), sourceIdentifier);
128     return { };
129 }
130 
131 EventTargetInterface ServiceWorker::eventTargetInterface() const
132 {
133     return ServiceWorkerEventTargetInterfaceType;
134 }
135 
136 ScriptExecutionContext* ServiceWorker::scriptExecutionContext() const
137 {
138     return ContextDestructionObserver::scriptExecutionContext();
139 }
140 
141 const char* ServiceWorker::activeDOMObjectName() const
142 {
143     return &quot;ServiceWorker&quot;;
144 }
145 
146 void ServiceWorker::stop()
147 {
148     m_isStopped = true;
149     removeAllEventListeners();
150     scriptExecutionContext()-&gt;unregisterServiceWorker(*this);
151     updatePendingActivityForEventDispatch();
152 }
153 
154 void ServiceWorker::updatePendingActivityForEventDispatch()
155 {
156     // ServiceWorkers can dispatch events until they become redundant or they are stopped.
157     if (m_isStopped || state() == State::Redundant) {
158         m_pendingActivityForEventDispatch = nullptr;
159         return;
160     }
161     if (m_pendingActivityForEventDispatch)
162         return;
163     m_pendingActivityForEventDispatch = makePendingActivity(*this);
164 }
165 
166 bool ServiceWorker::isAlwaysOnLoggingAllowed() const
167 {
168     auto* context = scriptExecutionContext();
169     if (!context)
170         return false;
171 
172     auto* container = context-&gt;serviceWorkerContainer();
173     if (!container)
174         return false;
175 
176     return container-&gt;isAlwaysOnLoggingAllowed();
177 }
178 
179 } // namespace WebCore
180 
181 #endif // ENABLE(SERVICE_WORKER)
    </pre>
  </body>
</html>