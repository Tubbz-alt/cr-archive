<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/Modules/geolocation/Geolocation.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../gamepad/GamepadEvent.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Geolocation.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/geolocation/Geolocation.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -144,10 +144,11 @@</span>
  }
  
  Geolocation::~Geolocation()
  {
      ASSERT(m_allowGeolocation != InProgress);
<span class="udiff-line-added">+     revokeAuthorizationTokenIfNecessary();</span>
  }
  
  SecurityOrigin* Geolocation::securityOrigin() const
  {
      return scriptExecutionContext()-&gt;securityOrigin();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -156,18 +157,13 @@</span>
  Page* Geolocation::page() const
  {
      return document() ? document()-&gt;page() : nullptr;
  }
  
<span class="udiff-line-removed">- bool Geolocation::canSuspendForDocumentSuspension() const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  void Geolocation::suspend(ReasonForSuspension reason)
  {
<span class="udiff-line-modified-removed">-     if (reason == ReasonForSuspension::PageCache) {</span>
<span class="udiff-line-modified-added">+     if (reason == ReasonForSuspension::BackForwardCache) {</span>
          stop();
          m_resetOnResume = true;
      }
  
      // Suspend GeoNotifier timeout timers.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -209,19 +205,19 @@</span>
              watcher-&gt;startTimerIfNeeded();
      }
  
      if ((isAllowed() || isDenied()) &amp;&amp; !m_pendingForPermissionNotifiers.isEmpty()) {
          // The pending permission was granted while the object was suspended.
<span class="udiff-line-modified-removed">-         setIsAllowed(isAllowed());</span>
<span class="udiff-line-modified-added">+         setIsAllowed(isAllowed(), authorizationToken());</span>
          ASSERT(!m_hasChangedPosition);
          ASSERT(!m_errorWaitingForResume);
          return;
      }
  
      if (isDenied() &amp;&amp; hasListeners()) {
          // The permission was revoked while the object was suspended.
<span class="udiff-line-modified-removed">-         setIsAllowed(false);</span>
<span class="udiff-line-modified-added">+         setIsAllowed(false, { });</span>
          return;
      }
  
      if (m_hasChangedPosition) {
          positionChanged();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -251,11 +247,11 @@</span>
          return;
      }
  
      // 1) Reset our own state.
      stopUpdating();
<span class="udiff-line-modified-removed">-     m_allowGeolocation = Unknown;</span>
<span class="udiff-line-modified-added">+     resetIsAllowed();</span>
      m_hasChangedPosition = false;
      m_errorWaitingForResume = nullptr;
  
      // 2) Request new permission for the active notifiers.
      stopTimers();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -274,11 +270,11 @@</span>
  {
      Page* page = this-&gt;page();
      if (page &amp;&amp; m_allowGeolocation == InProgress)
          GeolocationController::from(page)-&gt;cancelPermissionRequest(*this);
      // The frame may be moving to a new page and we want to get the permissions from the new page&#39;s client.
<span class="udiff-line-modified-removed">-     m_allowGeolocation = Unknown;</span>
<span class="udiff-line-modified-added">+     resetIsAllowed();</span>
      cancelAllRequests();
      stopUpdating();
      m_hasChangedPosition = false;
      m_errorWaitingForResume = nullptr;
      m_pendingForPermissionNotifiers.clear();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -483,18 +479,19 @@</span>
  
      if (!hasListeners())
          stopUpdating();
  }
  
<span class="udiff-line-modified-removed">- void Geolocation::setIsAllowed(bool allowed)</span>
<span class="udiff-line-modified-added">+ void Geolocation::setIsAllowed(bool allowed, const String&amp; authorizationToken)</span>
  {
      // Protect the Geolocation object from garbage collection during a callback.
      Ref&lt;Geolocation&gt; protectedThis(*this);
  
      // This may be due to either a new position from the service, or a cached
      // position.
      m_allowGeolocation = allowed ? Yes : No;
<span class="udiff-line-added">+     m_authorizationToken = authorizationToken;</span>
  
      if (m_isSuspended)
          return;
  
      // Permission request was made during the startRequest process
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -640,10 +637,28 @@</span>
  
      // Ask the embedder: it maintains the geolocation challenge policy itself.
      GeolocationController::from(page)-&gt;requestPermission(*this);
  }
  
<span class="udiff-line-added">+ void Geolocation::revokeAuthorizationTokenIfNecessary()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (m_authorizationToken.isNull())</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     Page* page = this-&gt;page();</span>
<span class="udiff-line-added">+     if (!page)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     GeolocationController::from(page)-&gt;revokeAuthorizationToken(std::exchange(m_authorizationToken, String()));</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Geolocation::resetIsAllowed()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_allowGeolocation = Unknown;</span>
<span class="udiff-line-added">+     revokeAuthorizationTokenIfNecessary();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void Geolocation::makeSuccessCallbacks(GeolocationPosition&amp; position)
  {
      ASSERT(lastPosition());
      ASSERT(isAllowed());
  
</pre>
<center><a href="../gamepad/GamepadEvent.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Geolocation.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>