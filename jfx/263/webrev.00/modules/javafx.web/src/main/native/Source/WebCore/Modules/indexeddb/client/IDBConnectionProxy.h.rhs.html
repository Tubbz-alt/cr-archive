<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/Modules/indexeddb/client/IDBConnectionProxy.h</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2016 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #pragma once
 27 
 28 #if ENABLE(INDEXED_DATABASE)
 29 
 30 #include &quot;IDBConnectionToServer.h&quot;
 31 #include &quot;IDBResourceIdentifier.h&quot;
 32 #include &quot;TransactionOperation.h&quot;
 33 #include &lt;wtf/CrossThreadQueue.h&gt;
 34 #include &lt;wtf/CrossThreadTask.h&gt;
 35 #include &lt;wtf/Forward.h&gt;
 36 #include &lt;wtf/Function.h&gt;
 37 #include &lt;wtf/HashMap.h&gt;
 38 #include &lt;wtf/MainThread.h&gt;
 39 #include &lt;wtf/RefPtr.h&gt;
 40 #include &lt;wtf/text/WTFString.h&gt;
 41 
 42 namespace WebCore {
 43 
 44 class IDBDatabase;
 45 class IDBDatabaseIdentifier;
 46 class IDBError;
 47 class IDBOpenDBRequest;
 48 class IDBResultData;
 49 class IDBTransaction;
 50 class ScriptExecutionContext;
 51 class SecurityOrigin;
 52 
 53 struct IDBGetRecordData;
 54 struct IDBIterateCursorData;
 55 
 56 namespace IDBClient {
 57 
 58 class IDBConnectionToServer;
 59 
 60 class IDBConnectionProxy {
 61     WTF_MAKE_NONCOPYABLE(IDBConnectionProxy);
 62     WTF_MAKE_FAST_ALLOCATED;
 63 public:
 64     IDBConnectionProxy(IDBConnectionToServer&amp;);
 65 
 66     Ref&lt;IDBOpenDBRequest&gt; openDatabase(ScriptExecutionContext&amp;, const IDBDatabaseIdentifier&amp;, uint64_t version);
 67     void didOpenDatabase(const IDBResultData&amp;);
 68 
 69     Ref&lt;IDBOpenDBRequest&gt; deleteDatabase(ScriptExecutionContext&amp;, const IDBDatabaseIdentifier&amp;);
 70     void didDeleteDatabase(const IDBResultData&amp;);
 71 
 72     void createObjectStore(TransactionOperation&amp;, const IDBObjectStoreInfo&amp;);
 73     void deleteObjectStore(TransactionOperation&amp;, const String&amp; objectStoreName);
 74     void clearObjectStore(TransactionOperation&amp;, uint64_t objectStoreIdentifier);
 75     void createIndex(TransactionOperation&amp;, const IDBIndexInfo&amp;);
 76     void deleteIndex(TransactionOperation&amp;, uint64_t objectStoreIdentifier, const String&amp; indexName);
 77     void putOrAdd(TransactionOperation&amp;, IDBKeyData&amp;&amp;, const IDBValue&amp;, const IndexedDB::ObjectStoreOverwriteMode);
 78     void getRecord(TransactionOperation&amp;, const IDBGetRecordData&amp;);
 79     void getAllRecords(TransactionOperation&amp;, const IDBGetAllRecordsData&amp;);
 80     void getCount(TransactionOperation&amp;, const IDBKeyRangeData&amp;);
 81     void deleteRecord(TransactionOperation&amp;, const IDBKeyRangeData&amp;);
 82     void openCursor(TransactionOperation&amp;, const IDBCursorInfo&amp;);
 83     void iterateCursor(TransactionOperation&amp;, const IDBIterateCursorData&amp;);
 84     void renameObjectStore(TransactionOperation&amp;, uint64_t objectStoreIdentifier, const String&amp; newName);
 85     void renameIndex(TransactionOperation&amp;, uint64_t objectStoreIdentifier, uint64_t indexIdentifier, const String&amp; newName);
 86 
 87     void fireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier, uint64_t requestedVersion);
<a name="1" id="anc1"></a><span class="line-modified"> 88     void didFireVersionChangeEvent(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; requestIdentifier, const IndexedDB::ConnectionClosedOnBehalfOfServer = IndexedDB::ConnectionClosedOnBehalfOfServer::No);</span>
 89 
 90     void notifyOpenDBRequestBlocked(const IDBResourceIdentifier&amp; requestIdentifier, uint64_t oldVersion, uint64_t newVersion);
 91     void openDBRequestCancelled(const IDBRequestData&amp;);
 92 
 93     void establishTransaction(IDBTransaction&amp;);
 94     void commitTransaction(IDBTransaction&amp;);
 95     void abortTransaction(IDBTransaction&amp;);
 96 
 97     void didStartTransaction(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBError&amp;);
 98     void didCommitTransaction(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBError&amp;);
 99     void didAbortTransaction(const IDBResourceIdentifier&amp; transactionIdentifier, const IDBError&amp;);
100 
101     void didFinishHandlingVersionChangeTransaction(uint64_t databaseConnectionIdentifier, IDBTransaction&amp;);
102     void databaseConnectionPendingClose(IDBDatabase&amp;);
103     void databaseConnectionClosed(IDBDatabase&amp;);
104 
105     void didCloseFromServer(uint64_t databaseConnectionIdentifier, const IDBError&amp;);
<a name="2" id="anc2"></a>
106 
107     void connectionToServerLost(const IDBError&amp;);
108 
109     void abortOpenAndUpgradeNeeded(uint64_t databaseConnectionIdentifier, const IDBResourceIdentifier&amp; transactionIdentifier);
110 
111     void completeOperation(const IDBResultData&amp;);
112 
<a name="3" id="anc3"></a><span class="line-modified">113     IDBConnectionIdentifier serverConnectionIdentifier() const { return m_serverConnectionIdentifier; }</span>
114 
115     void ref();
116     void deref();
117 
118     void getAllDatabaseNames(const SecurityOrigin&amp; mainFrameOrigin, const SecurityOrigin&amp; openingOrigin, WTF::Function&lt;void (const Vector&lt;String&gt;&amp;)&gt;&amp;&amp;);
119 
120     void registerDatabaseConnection(IDBDatabase&amp;);
121     void unregisterDatabaseConnection(IDBDatabase&amp;);
122 
123     void forgetActiveOperations(const Vector&lt;RefPtr&lt;TransactionOperation&gt;&gt;&amp;);
124     void forgetTransaction(IDBTransaction&amp;);
125     void forgetActivityForCurrentThread();
<a name="4" id="anc4"></a><span class="line-added">126     void setContextSuspended(ScriptExecutionContext&amp; currentContext, bool isContextSuspended);</span>
127 
128 private:
129     void completeOpenDBRequest(const IDBResultData&amp;);
130     bool hasRecordOfTransaction(const IDBTransaction&amp;) const;
131 
132     void saveOperation(TransactionOperation&amp;);
133 
134     template&lt;typename... Parameters, typename... Arguments&gt;
135     void callConnectionOnMainThread(void (IDBConnectionToServer::*method)(Parameters...), Arguments&amp;&amp;... arguments)
136     {
137         if (isMainThread())
138             (m_connectionToServer.*method)(std::forward&lt;Arguments&gt;(arguments)...);
139         else
140             postMainThreadTask(m_connectionToServer, method, arguments...);
141     }
142 
143     template&lt;typename... Arguments&gt;
144     void postMainThreadTask(Arguments&amp;&amp;... arguments)
145     {
146         auto task = createCrossThreadTask(arguments...);
147         m_mainThreadQueue.append(WTFMove(task));
148 
149         scheduleMainThreadTasks();
150     }
151 
152     void scheduleMainThreadTasks();
153     void handleMainThreadTasks();
154 
155     IDBConnectionToServer&amp; m_connectionToServer;
<a name="5" id="anc5"></a><span class="line-modified">156     IDBConnectionIdentifier m_serverConnectionIdentifier;</span>
157 
158     HashMap&lt;uint64_t, IDBDatabase*&gt; m_databaseConnectionMap;
159     Lock m_databaseConnectionMapLock;
160 
161     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;IDBOpenDBRequest&gt;&gt; m_openDBRequestMap;
162     Lock m_openDBRequestMapLock;
163 
164     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;IDBTransaction&gt;&gt; m_pendingTransactions;
165     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;IDBTransaction&gt;&gt; m_committingTransactions;
166     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;IDBTransaction&gt;&gt; m_abortingTransactions;
167     Lock m_transactionMapLock;
168 
169     HashMap&lt;IDBResourceIdentifier, RefPtr&lt;TransactionOperation&gt;&gt; m_activeOperations;
170     Lock m_transactionOperationLock;
171 
172     CrossThreadQueue&lt;CrossThreadTask&gt; m_mainThreadQueue;
173     Lock m_mainThreadTaskLock;
174     RefPtr&lt;IDBConnectionToServer&gt; m_mainThreadProtector;
175 };
176 
177 } // namespace IDBClient
178 } // namespace WebCore
179 
180 #endif // ENABLE(INDEXED_DATABASE)
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>