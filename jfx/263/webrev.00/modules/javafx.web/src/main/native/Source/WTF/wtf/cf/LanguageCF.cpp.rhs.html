<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WTF/wtf/cf/LanguageCF.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2003, 2005, 2006, 2010, 2011, 2016, 2017 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &lt;wtf/Language.h&gt;
 28 
 29 #include &lt;CoreFoundation/CoreFoundation.h&gt;
 30 #include &lt;mutex&gt;
 31 #include &lt;unicode/uloc.h&gt;
 32 #include &lt;wtf/Assertions.h&gt;
 33 #include &lt;wtf/Lock.h&gt;
 34 #include &lt;wtf/NeverDestroyed.h&gt;
 35 #include &lt;wtf/RetainPtr.h&gt;
 36 #include &lt;wtf/spi/cf/CFBundleSPI.h&gt;
 37 #include &lt;wtf/text/WTFString.h&gt;
 38 
 39 namespace WTF {
 40 
 41 static Lock preferredLanguagesMutex;
 42 
 43 static Vector&lt;String&gt;&amp; preferredLanguages()
 44 {
 45     static NeverDestroyed&lt;Vector&lt;String&gt;&gt; languages;
 46     return languages;
 47 }
 48 
 49 static String httpStyleLanguageCode(CFStringRef language)
 50 {
<a name="1" id="anc1"></a><span class="line-modified"> 51     RetainPtr&lt;CFStringRef&gt; preferredLanguageCode;</span>
<span class="line-modified"> 52 #if !PLATFORM(JAVA)</span>
<span class="line-modified"> 53     // If we can minimize the language list to reduce fingerprinting, we can afford to be more lossless when canonicalizing the locale list.</span>
<span class="line-modified"> 54     if (canMinimizeLanguages())</span>
<span class="line-modified"> 55         preferredLanguageCode = adoptCF(CFLocaleCreateCanonicalLanguageIdentifierFromString(kCFAllocatorDefault, language));</span>
<span class="line-modified"> 56     else {</span>
<span class="line-modified"> 57 #endif</span>
<span class="line-modified"> 58         SInt32 languageCode;</span>
<span class="line-modified"> 59         SInt32 regionCode;</span>
<span class="line-modified"> 60         SInt32 scriptCode;</span>
<span class="line-modified"> 61         CFStringEncoding stringEncoding;</span>
<span class="line-modified"> 62 </span>
<span class="line-modified"> 63         // FIXME: This transformation is very wrong:</span>
<span class="line-added"> 64         // 1. There is no reason why CFBundle localization names would be at all related to language names as used on the Web.</span>
<span class="line-added"> 65         // 2. Script Manager codes cannot represent all languages that are now supported by the platform, so the conversion is lossy.</span>
<span class="line-added"> 66         // 3. This should probably match what is sent by the network layer as Accept-Language, but currently, that&#39;s implemented separately.</span>
<span class="line-added"> 67         CFBundleGetLocalizationInfoForLocalization(language, &amp;languageCode, &amp;regionCode, &amp;scriptCode, &amp;stringEncoding);</span>
<span class="line-added"> 68         preferredLanguageCode = adoptCF(CFBundleCopyLocalizationForLocalizationInfo(languageCode, regionCode, scriptCode, stringEncoding));</span>
<span class="line-added"> 69 #if !PLATFORM(JAVA)</span>
<span class="line-added"> 70     }</span>
<span class="line-added"> 71 #endif</span>
<span class="line-added"> 72 </span>
<span class="line-added"> 73     if (!preferredLanguageCode)</span>
<span class="line-added"> 74         preferredLanguageCode = language;</span>
<span class="line-added"> 75     auto mutableLanguageCode = adoptCF(CFStringCreateMutableCopy(kCFAllocatorDefault, 0, preferredLanguageCode.get()));</span>
 76 
 77     // Turn a &#39;_&#39; into a &#39;-&#39; if it appears after a 2-letter language code
<a name="2" id="anc2"></a><span class="line-modified"> 78     if (CFStringGetLength(mutableLanguageCode.get()) &gt;= 3 &amp;&amp; CFStringGetCharacterAtIndex(mutableLanguageCode.get(), 2) == &#39;_&#39;)</span>

 79         CFStringReplace(mutableLanguageCode.get(), CFRangeMake(2, 1), CFSTR(&quot;-&quot;));
<a name="3" id="anc3"></a>

 80 
<a name="4" id="anc4"></a><span class="line-modified"> 81     CFStringLowercase(mutableLanguageCode.get(), nullptr);</span>
<span class="line-added"> 82     return mutableLanguageCode.get();</span>
<span class="line-added"> 83 </span>
 84 }
 85 
 86 #if PLATFORM(MAC)
 87 static void languagePreferencesDidChange(CFNotificationCenterRef, void*, CFStringRef, const void*, CFDictionaryRef)
 88 {
 89     {
 90         std::lock_guard&lt;Lock&gt; lock(preferredLanguagesMutex);
 91         preferredLanguages().clear();
 92     }
 93 
 94     languageDidChange();
 95 }
 96 #endif
 97 
 98 Vector&lt;String&gt; platformUserPreferredLanguages()
 99 {
100 #if PLATFORM(MAC)
101     static dispatch_once_t onceToken;
102     dispatch_once(&amp;onceToken, ^ {
103         CFNotificationCenterAddObserver(CFNotificationCenterGetDistributedCenter(), nullptr, &amp;languagePreferencesDidChange, CFSTR(&quot;AppleLanguagePreferencesChangedNotification&quot;), nullptr, CFNotificationSuspensionBehaviorCoalesce);
104     });
105 #endif
106 
107     std::lock_guard&lt;Lock&gt; lock(preferredLanguagesMutex);
108     Vector&lt;String&gt;&amp; userPreferredLanguages = preferredLanguages();
109 
110     if (userPreferredLanguages.isEmpty()) {
111         RetainPtr&lt;CFArrayRef&gt; languages = adoptCF(CFLocaleCopyPreferredLanguages());
<a name="5" id="anc5"></a><span class="line-added">112 #if !PLATFORM(JAVA)</span>
<span class="line-added">113         languages = minimizedLanguagesFromLanguages(languages.get());</span>
<span class="line-added">114 #endif</span>
115         CFIndex languageCount = CFArrayGetCount(languages.get());
116         if (!languageCount)
117             userPreferredLanguages.append(&quot;en&quot;);
118         else {
119             for (CFIndex i = 0; i &lt; languageCount; i++)
120                 userPreferredLanguages.append(httpStyleLanguageCode(static_cast&lt;CFStringRef&gt;(CFArrayGetValueAtIndex(languages.get(), i))));
121         }
122     }
123 
124     Vector&lt;String&gt; userPreferredLanguagesCopy;
125     userPreferredLanguagesCopy.reserveInitialCapacity(userPreferredLanguages.size());
126 
127     for (auto&amp; language : userPreferredLanguages)
128         userPreferredLanguagesCopy.uncheckedAppend(language.isolatedCopy());
129 
130     return userPreferredLanguagesCopy;
131 
132     return Vector&lt;String&gt;();
133 }
134 
135 } // namespace WTF
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>