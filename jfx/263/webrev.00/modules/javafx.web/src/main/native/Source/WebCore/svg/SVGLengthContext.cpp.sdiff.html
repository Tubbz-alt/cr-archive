<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/svg/SVGLengthContext.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SVGLength.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SVGLengthContext.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/svg/SVGLengthContext.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
  2  * Copyright (C) 2004, 2005, 2006 Nikolas Zimmermann &lt;zimmermann@kde.org&gt;
  3  * Copyright (C) 2004, 2005, 2006, 2007 Rob Buis &lt;buis@kde.org&gt;
<span class="line-modified">  4  * Copyright (C) 2007 Apple Inc. All rights reserved.</span>
  5  * Copyright (C) Research In Motion Limited 2011. All rights reserved.
  6  * Copyright (C) 2014 Adobe Systems Incorporated. All rights reserved.
  7  *
  8  * This library is free software; you can redistribute it and/or
  9  * modify it under the terms of the GNU Library General Public
 10  * License as published by the Free Software Foundation; either
 11  * version 2 of the License, or (at your option) any later version.
 12  *
 13  * This library is distributed in the hope that it will be useful,
 14  * but WITHOUT ANY WARRANTY; without even the implied warranty of
 15  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 16  * Library General Public License for more details.
 17  *
 18  * You should have received a copy of the GNU Library General Public License
 19  * along with this library; see the file COPYING.LIB.  If not, write to
 20  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 21  * Boston, MA 02110-1301, USA.
 22  */
 23 
 24 #include &quot;config.h&quot;
 25 #include &quot;SVGLengthContext.h&quot;
 26 
 27 #include &quot;CSSHelper.h&quot;
 28 #include &quot;FontMetrics.h&quot;
 29 #include &quot;Frame.h&quot;
 30 #include &quot;LengthFunctions.h&quot;
 31 #include &quot;RenderSVGRoot.h&quot;
 32 #include &quot;RenderSVGViewportContainer.h&quot;
 33 #include &quot;RenderView.h&quot;
 34 #include &quot;SVGSVGElement.h&quot;

 35 
 36 namespace WebCore {
 37 
 38 SVGLengthContext::SVGLengthContext(const SVGElement* context)
 39     : m_context(context)
 40 {
 41 }
 42 
 43 SVGLengthContext::SVGLengthContext(const SVGElement* context, const FloatRect&amp; viewport)
 44     : m_context(context)
 45     , m_overriddenViewport(viewport)
 46 {
 47 }
 48 
 49 FloatRect SVGLengthContext::resolveRectangle(const SVGElement* context, SVGUnitTypes::SVGUnitType type, const FloatRect&amp; viewport, const SVGLengthValue&amp; x, const SVGLengthValue&amp; y, const SVGLengthValue&amp; width, const SVGLengthValue&amp; height)
 50 {
 51     ASSERT(type != SVGUnitTypes::SVG_UNIT_TYPE_UNKNOWN);
 52     if (type == SVGUnitTypes::SVG_UNIT_TYPE_USERSPACEONUSE) {
 53         SVGLengthContext lengthContext(context);
 54         return FloatRect(x.value(lengthContext), y.value(lengthContext), width.value(lengthContext), height.value(lengthContext));
</pre>
<hr />
<pre>
 68         SVGLengthContext lengthContext(context);
 69         return FloatPoint(x.value(lengthContext), y.value(lengthContext));
 70     }
 71 
 72     // FIXME: valueAsPercentage() won&#39;t be correct for eg. cm units. They need to be resolved in user space and then be considered in objectBoundingBox space.
 73     return FloatPoint(x.valueAsPercentage(), y.valueAsPercentage());
 74 }
 75 
 76 float SVGLengthContext::resolveLength(const SVGElement* context, SVGUnitTypes::SVGUnitType type, const SVGLengthValue&amp; x)
 77 {
 78     ASSERT(type != SVGUnitTypes::SVG_UNIT_TYPE_UNKNOWN);
 79     if (type == SVGUnitTypes::SVG_UNIT_TYPE_USERSPACEONUSE) {
 80         SVGLengthContext lengthContext(context);
 81         return x.value(lengthContext);
 82     }
 83 
 84     // FIXME: valueAsPercentage() won&#39;t be correct for eg. cm units. They need to be resolved in user space and then be considered in objectBoundingBox space.
 85     return x.valueAsPercentage();
 86 }
 87 
<span class="line-modified"> 88 float SVGLengthContext::valueForLength(const Length&amp; length, SVGLengthMode mode)</span>
 89 {
 90     if (length.isPercent()) {
<span class="line-modified"> 91         auto result = convertValueFromPercentageToUserUnits(length.value() / 100, mode);</span>
 92         if (result.hasException())
 93             return 0;
 94         return result.releaseReturnValue();
 95     }
 96     if (length.isAuto() || !length.isSpecified())
 97         return 0;
 98 
 99     FloatSize viewportSize;
100     determineViewport(viewportSize);
101 
<span class="line-modified">102     switch (mode) {</span>
<span class="line-modified">103     case LengthModeWidth:</span>
104         return floatValueForLength(length, viewportSize.width());
<span class="line-modified">105     case LengthModeHeight:</span>
106         return floatValueForLength(length, viewportSize.height());
<span class="line-modified">107     case LengthModeOther:</span>
<span class="line-modified">108         return floatValueForLength(length, std::sqrt(viewportSize.diagonalLengthSquared() / 2));</span>
109     };
110     return 0;
111 }
112 
<span class="line-modified">113 ExceptionOr&lt;float&gt; SVGLengthContext::convertValueToUserUnits(float value, SVGLengthMode mode, SVGLengthType fromUnit) const</span>
114 {
115     // If the SVGLengthContext carries a custom viewport, force resolving against it.
116     if (!m_overriddenViewport.isEmpty()) {
117         // 100% = 100.0 instead of 1.0 for historical reasons, this could eventually be changed
<span class="line-modified">118         if (fromUnit == LengthTypePercentage)</span>
119             value /= 100;
<span class="line-modified">120         return convertValueFromPercentageToUserUnits(value, mode);</span>
121     }
122 
<span class="line-modified">123     switch (fromUnit) {</span>
<span class="line-modified">124     case LengthTypeUnknown:</span>
125         return Exception { NotSupportedError };
<span class="line-modified">126     case LengthTypeNumber:</span>
127         return value;
<span class="line-modified">128     case LengthTypePX:</span>
129         return value;
<span class="line-modified">130     case LengthTypePercentage:</span>
<span class="line-modified">131         return convertValueFromPercentageToUserUnits(value / 100, mode);</span>
<span class="line-modified">132     case LengthTypeEMS:</span>
133         return convertValueFromEMSToUserUnits(value);
<span class="line-modified">134     case LengthTypeEXS:</span>
135         return convertValueFromEXSToUserUnits(value);
<span class="line-modified">136     case LengthTypeCM:</span>
137         return value * cssPixelsPerInch / 2.54f;
<span class="line-modified">138     case LengthTypeMM:</span>
139         return value * cssPixelsPerInch / 25.4f;
<span class="line-modified">140     case LengthTypeIN:</span>
141         return value * cssPixelsPerInch;
<span class="line-modified">142     case LengthTypePT:</span>
143         return value * cssPixelsPerInch / 72;
<span class="line-modified">144     case LengthTypePC:</span>
145         return value * cssPixelsPerInch / 6;
146     }
147 
148     ASSERT_NOT_REACHED();
149     return 0;
150 }
151 
<span class="line-modified">152 ExceptionOr&lt;float&gt; SVGLengthContext::convertValueFromUserUnits(float value, SVGLengthMode mode, SVGLengthType toUnit) const</span>
153 {
<span class="line-modified">154     switch (toUnit) {</span>
<span class="line-modified">155     case LengthTypeUnknown:</span>
156         return Exception { NotSupportedError };
<span class="line-modified">157     case LengthTypeNumber:</span>
158         return value;
<span class="line-modified">159     case LengthTypePercentage:</span>
<span class="line-modified">160         return convertValueFromUserUnitsToPercentage(value * 100, mode);</span>
<span class="line-modified">161     case LengthTypeEMS:</span>
162         return convertValueFromUserUnitsToEMS(value);
<span class="line-modified">163     case LengthTypeEXS:</span>
164         return convertValueFromUserUnitsToEXS(value);
<span class="line-modified">165     case LengthTypePX:</span>
166         return value;
<span class="line-modified">167     case LengthTypeCM:</span>
168         return value * 2.54f / cssPixelsPerInch;
<span class="line-modified">169     case LengthTypeMM:</span>
170         return value * 25.4f / cssPixelsPerInch;
<span class="line-modified">171     case LengthTypeIN:</span>
172         return value / cssPixelsPerInch;
<span class="line-modified">173     case LengthTypePT:</span>
174         return value * 72 / cssPixelsPerInch;
<span class="line-modified">175     case LengthTypePC:</span>
176         return value * 6 / cssPixelsPerInch;
177     }
178 
179     ASSERT_NOT_REACHED();
180     return 0;
181 }
182 
<span class="line-modified">183 ExceptionOr&lt;float&gt; SVGLengthContext::convertValueFromUserUnitsToPercentage(float value, SVGLengthMode mode) const</span>
184 {
185     FloatSize viewportSize;
186     if (!determineViewport(viewportSize))
187         return Exception { NotSupportedError };
188 
<span class="line-modified">189     switch (mode) {</span>
<span class="line-modified">190     case LengthModeWidth:</span>
191         return value / viewportSize.width() * 100;
<span class="line-modified">192     case LengthModeHeight:</span>
193         return value / viewportSize.height() * 100;
<span class="line-modified">194     case LengthModeOther:</span>
<span class="line-modified">195         return value / (std::sqrt(viewportSize.diagonalLengthSquared() / 2)) * 100;</span>
196     };
197 
198     ASSERT_NOT_REACHED();
199     return 0;
200 }
201 
<span class="line-modified">202 ExceptionOr&lt;float&gt; SVGLengthContext::convertValueFromPercentageToUserUnits(float value, SVGLengthMode mode) const</span>
203 {
204     FloatSize viewportSize;
205     if (!determineViewport(viewportSize))
206         return Exception { NotSupportedError };
207 
<span class="line-modified">208     switch (mode) {</span>
<span class="line-modified">209     case LengthModeWidth:</span>
210         return value * viewportSize.width();
<span class="line-modified">211     case LengthModeHeight:</span>
212         return value * viewportSize.height();
<span class="line-modified">213     case LengthModeOther:</span>
<span class="line-modified">214         return value * std::sqrt(viewportSize.diagonalLengthSquared() / 2);</span>
215     };
216 
217     ASSERT_NOT_REACHED();
218     return 0;
219 }
220 
221 static inline const RenderStyle* renderStyleForLengthResolving(const SVGElement* context)
222 {
223     if (!context)
224         return nullptr;
225 
226     const ContainerNode* currentContext = context;
227     do {
228         if (currentContext-&gt;renderer())
229             return &amp;currentContext-&gt;renderer()-&gt;style();
230         currentContext = currentContext-&gt;parentNode();
231     } while (currentContext);
232 
233     // There must be at least a RenderSVGRoot renderer, carrying a style.
234     ASSERT_NOT_REACHED();
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
  2  * Copyright (C) 2004, 2005, 2006 Nikolas Zimmermann &lt;zimmermann@kde.org&gt;
  3  * Copyright (C) 2004, 2005, 2006, 2007 Rob Buis &lt;buis@kde.org&gt;
<span class="line-modified">  4  * Copyright (C) 2007-2019 Apple Inc. All rights reserved.</span>
  5  * Copyright (C) Research In Motion Limited 2011. All rights reserved.
  6  * Copyright (C) 2014 Adobe Systems Incorporated. All rights reserved.
  7  *
  8  * This library is free software; you can redistribute it and/or
  9  * modify it under the terms of the GNU Library General Public
 10  * License as published by the Free Software Foundation; either
 11  * version 2 of the License, or (at your option) any later version.
 12  *
 13  * This library is distributed in the hope that it will be useful,
 14  * but WITHOUT ANY WARRANTY; without even the implied warranty of
 15  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 16  * Library General Public License for more details.
 17  *
 18  * You should have received a copy of the GNU Library General Public License
 19  * along with this library; see the file COPYING.LIB.  If not, write to
 20  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 21  * Boston, MA 02110-1301, USA.
 22  */
 23 
 24 #include &quot;config.h&quot;
 25 #include &quot;SVGLengthContext.h&quot;
 26 
 27 #include &quot;CSSHelper.h&quot;
 28 #include &quot;FontMetrics.h&quot;
 29 #include &quot;Frame.h&quot;
 30 #include &quot;LengthFunctions.h&quot;
 31 #include &quot;RenderSVGRoot.h&quot;
 32 #include &quot;RenderSVGViewportContainer.h&quot;
 33 #include &quot;RenderView.h&quot;
 34 #include &quot;SVGSVGElement.h&quot;
<span class="line-added"> 35 #include &lt;wtf/MathExtras.h&gt;</span>
 36 
 37 namespace WebCore {
 38 
 39 SVGLengthContext::SVGLengthContext(const SVGElement* context)
 40     : m_context(context)
 41 {
 42 }
 43 
 44 SVGLengthContext::SVGLengthContext(const SVGElement* context, const FloatRect&amp; viewport)
 45     : m_context(context)
 46     , m_overriddenViewport(viewport)
 47 {
 48 }
 49 
 50 FloatRect SVGLengthContext::resolveRectangle(const SVGElement* context, SVGUnitTypes::SVGUnitType type, const FloatRect&amp; viewport, const SVGLengthValue&amp; x, const SVGLengthValue&amp; y, const SVGLengthValue&amp; width, const SVGLengthValue&amp; height)
 51 {
 52     ASSERT(type != SVGUnitTypes::SVG_UNIT_TYPE_UNKNOWN);
 53     if (type == SVGUnitTypes::SVG_UNIT_TYPE_USERSPACEONUSE) {
 54         SVGLengthContext lengthContext(context);
 55         return FloatRect(x.value(lengthContext), y.value(lengthContext), width.value(lengthContext), height.value(lengthContext));
</pre>
<hr />
<pre>
 69         SVGLengthContext lengthContext(context);
 70         return FloatPoint(x.value(lengthContext), y.value(lengthContext));
 71     }
 72 
 73     // FIXME: valueAsPercentage() won&#39;t be correct for eg. cm units. They need to be resolved in user space and then be considered in objectBoundingBox space.
 74     return FloatPoint(x.valueAsPercentage(), y.valueAsPercentage());
 75 }
 76 
 77 float SVGLengthContext::resolveLength(const SVGElement* context, SVGUnitTypes::SVGUnitType type, const SVGLengthValue&amp; x)
 78 {
 79     ASSERT(type != SVGUnitTypes::SVG_UNIT_TYPE_UNKNOWN);
 80     if (type == SVGUnitTypes::SVG_UNIT_TYPE_USERSPACEONUSE) {
 81         SVGLengthContext lengthContext(context);
 82         return x.value(lengthContext);
 83     }
 84 
 85     // FIXME: valueAsPercentage() won&#39;t be correct for eg. cm units. They need to be resolved in user space and then be considered in objectBoundingBox space.
 86     return x.valueAsPercentage();
 87 }
 88 
<span class="line-modified"> 89 float SVGLengthContext::valueForLength(const Length&amp; length, SVGLengthMode lengthMode)</span>
 90 {
 91     if (length.isPercent()) {
<span class="line-modified"> 92         auto result = convertValueFromPercentageToUserUnits(length.value() / 100, lengthMode);</span>
 93         if (result.hasException())
 94             return 0;
 95         return result.releaseReturnValue();
 96     }
 97     if (length.isAuto() || !length.isSpecified())
 98         return 0;
 99 
100     FloatSize viewportSize;
101     determineViewport(viewportSize);
102 
<span class="line-modified">103     switch (lengthMode) {</span>
<span class="line-modified">104     case SVGLengthMode::Width:</span>
105         return floatValueForLength(length, viewportSize.width());
<span class="line-modified">106     case SVGLengthMode::Height:</span>
107         return floatValueForLength(length, viewportSize.height());
<span class="line-modified">108     case SVGLengthMode::Other:</span>
<span class="line-modified">109         return floatValueForLength(length, viewportSize.diagonalLength() / sqrtOfTwoFloat);</span>
110     };
111     return 0;
112 }
113 
<span class="line-modified">114 ExceptionOr&lt;float&gt; SVGLengthContext::convertValueToUserUnits(float value, SVGLengthType lengthType, SVGLengthMode lengthMode) const</span>
115 {
116     // If the SVGLengthContext carries a custom viewport, force resolving against it.
117     if (!m_overriddenViewport.isEmpty()) {
118         // 100% = 100.0 instead of 1.0 for historical reasons, this could eventually be changed
<span class="line-modified">119         if (lengthType == SVGLengthType::Percentage)</span>
120             value /= 100;
<span class="line-modified">121         return convertValueFromPercentageToUserUnits(value, lengthMode);</span>
122     }
123 
<span class="line-modified">124     switch (lengthType) {</span>
<span class="line-modified">125     case SVGLengthType::Unknown:</span>
126         return Exception { NotSupportedError };
<span class="line-modified">127     case SVGLengthType::Number:</span>
128         return value;
<span class="line-modified">129     case SVGLengthType::Pixels:</span>
130         return value;
<span class="line-modified">131     case SVGLengthType::Percentage:</span>
<span class="line-modified">132         return convertValueFromPercentageToUserUnits(value / 100, lengthMode);</span>
<span class="line-modified">133     case SVGLengthType::Ems:</span>
134         return convertValueFromEMSToUserUnits(value);
<span class="line-modified">135     case SVGLengthType::Exs:</span>
136         return convertValueFromEXSToUserUnits(value);
<span class="line-modified">137     case SVGLengthType::Centimeters:</span>
138         return value * cssPixelsPerInch / 2.54f;
<span class="line-modified">139     case SVGLengthType::Millimeters:</span>
140         return value * cssPixelsPerInch / 25.4f;
<span class="line-modified">141     case SVGLengthType::Inches:</span>
142         return value * cssPixelsPerInch;
<span class="line-modified">143     case SVGLengthType::Points:</span>
144         return value * cssPixelsPerInch / 72;
<span class="line-modified">145     case SVGLengthType::Picas:</span>
146         return value * cssPixelsPerInch / 6;
147     }
148 
149     ASSERT_NOT_REACHED();
150     return 0;
151 }
152 
<span class="line-modified">153 ExceptionOr&lt;float&gt; SVGLengthContext::convertValueFromUserUnits(float value, SVGLengthType lengthType, SVGLengthMode lengthMode) const</span>
154 {
<span class="line-modified">155     switch (lengthType) {</span>
<span class="line-modified">156     case SVGLengthType::Unknown:</span>
157         return Exception { NotSupportedError };
<span class="line-modified">158     case SVGLengthType::Number:</span>
159         return value;
<span class="line-modified">160     case SVGLengthType::Percentage:</span>
<span class="line-modified">161         return convertValueFromUserUnitsToPercentage(value * 100, lengthMode);</span>
<span class="line-modified">162     case SVGLengthType::Ems:</span>
163         return convertValueFromUserUnitsToEMS(value);
<span class="line-modified">164     case SVGLengthType::Exs:</span>
165         return convertValueFromUserUnitsToEXS(value);
<span class="line-modified">166     case SVGLengthType::Pixels:</span>
167         return value;
<span class="line-modified">168     case SVGLengthType::Centimeters:</span>
169         return value * 2.54f / cssPixelsPerInch;
<span class="line-modified">170     case SVGLengthType::Millimeters:</span>
171         return value * 25.4f / cssPixelsPerInch;
<span class="line-modified">172     case SVGLengthType::Inches:</span>
173         return value / cssPixelsPerInch;
<span class="line-modified">174     case SVGLengthType::Points:</span>
175         return value * 72 / cssPixelsPerInch;
<span class="line-modified">176     case SVGLengthType::Picas:</span>
177         return value * 6 / cssPixelsPerInch;
178     }
179 
180     ASSERT_NOT_REACHED();
181     return 0;
182 }
183 
<span class="line-modified">184 ExceptionOr&lt;float&gt; SVGLengthContext::convertValueFromUserUnitsToPercentage(float value, SVGLengthMode lengthMode) const</span>
185 {
186     FloatSize viewportSize;
187     if (!determineViewport(viewportSize))
188         return Exception { NotSupportedError };
189 
<span class="line-modified">190     switch (lengthMode) {</span>
<span class="line-modified">191     case SVGLengthMode::Width:</span>
192         return value / viewportSize.width() * 100;
<span class="line-modified">193     case SVGLengthMode::Height:</span>
194         return value / viewportSize.height() * 100;
<span class="line-modified">195     case SVGLengthMode::Other:</span>
<span class="line-modified">196         return value / (viewportSize.diagonalLength() / sqrtOfTwoFloat) * 100;</span>
197     };
198 
199     ASSERT_NOT_REACHED();
200     return 0;
201 }
202 
<span class="line-modified">203 ExceptionOr&lt;float&gt; SVGLengthContext::convertValueFromPercentageToUserUnits(float value, SVGLengthMode lengthMode) const</span>
204 {
205     FloatSize viewportSize;
206     if (!determineViewport(viewportSize))
207         return Exception { NotSupportedError };
208 
<span class="line-modified">209     switch (lengthMode) {</span>
<span class="line-modified">210     case SVGLengthMode::Width:</span>
211         return value * viewportSize.width();
<span class="line-modified">212     case SVGLengthMode::Height:</span>
213         return value * viewportSize.height();
<span class="line-modified">214     case SVGLengthMode::Other:</span>
<span class="line-modified">215         return value * viewportSize.diagonalLength() / sqrtOfTwoFloat;</span>
216     };
217 
218     ASSERT_NOT_REACHED();
219     return 0;
220 }
221 
222 static inline const RenderStyle* renderStyleForLengthResolving(const SVGElement* context)
223 {
224     if (!context)
225         return nullptr;
226 
227     const ContainerNode* currentContext = context;
228     do {
229         if (currentContext-&gt;renderer())
230             return &amp;currentContext-&gt;renderer()-&gt;style();
231         currentContext = currentContext-&gt;parentNode();
232     } while (currentContext);
233 
234     // There must be at least a RenderSVGRoot renderer, carrying a style.
235     ASSERT_NOT_REACHED();
</pre>
</td>
</tr>
</table>
<center><a href="SVGLength.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SVGLengthContext.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>