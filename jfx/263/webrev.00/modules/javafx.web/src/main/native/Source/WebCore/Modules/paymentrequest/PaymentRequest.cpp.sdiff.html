<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/paymentrequest/PaymentRequest.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PaymentMethodChangeEvent.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="PaymentRequest.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/paymentrequest/PaymentRequest.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;PaymentRequest.h&quot;
 28 
 29 #if ENABLE(PAYMENT_REQUEST)
 30 
 31 #include &quot;ApplePayPaymentHandler.h&quot;
 32 #include &quot;Document.h&quot;
 33 #include &quot;EventNames.h&quot;
 34 #include &quot;JSDOMPromise.h&quot;

 35 #include &quot;JSPaymentDetailsUpdate.h&quot;
 36 #include &quot;JSPaymentResponse.h&quot;
 37 #include &quot;Page.h&quot;
 38 #include &quot;PaymentAddress.h&quot;
 39 #include &quot;PaymentCoordinator.h&quot;
 40 #include &quot;PaymentCurrencyAmount.h&quot;
 41 #include &quot;PaymentDetailsInit.h&quot;
 42 #include &quot;PaymentHandler.h&quot;
 43 #include &quot;PaymentMethodChangeEvent.h&quot;
 44 #include &quot;PaymentMethodData.h&quot;
 45 #include &quot;PaymentOptions.h&quot;
 46 #include &quot;PaymentRequestUpdateEvent.h&quot;
 47 #include &quot;PaymentValidationErrors.h&quot;
 48 #include &quot;ScriptController.h&quot;
 49 #include &lt;JavaScriptCore/JSONObject.h&gt;
 50 #include &lt;JavaScriptCore/ThrowScope.h&gt;
 51 #include &lt;wtf/ASCIICType.h&gt;
 52 #include &lt;wtf/IsoMallocInlines.h&gt;
 53 #include &lt;wtf/RunLoop.h&gt;
 54 #include &lt;wtf/Scope.h&gt;
</pre>
<hr />
<pre>
233 Optional&lt;PaymentRequest::MethodIdentifier&gt; convertAndValidatePaymentMethodIdentifier(const String&amp; identifier)
234 {
235     URL url { URL(), identifier };
236     if (!url.isValid()) {
237         if (isValidStandardizedPaymentMethodIdentifier(identifier))
238             return { identifier };
239         return WTF::nullopt;
240     }
241 
242     if (isValidURLBasedPaymentMethodIdentifier(url))
243         return { WTFMove(url) };
244 
245     return WTF::nullopt;
246 }
247 
248 enum class ShouldValidatePaymentMethodIdentifier {
249     No,
250     Yes,
251 };
252 
<span class="line-modified">253 static ExceptionOr&lt;std::tuple&lt;String, Vector&lt;String&gt;&gt;&gt; checkAndCanonicalizeDetails(JSC::ExecState&amp; execState, PaymentDetailsBase&amp; details, bool requestShipping, ShouldValidatePaymentMethodIdentifier shouldValidatePaymentMethodIdentifier)</span>
254 {
255     for (auto&amp; item : details.displayItems) {
256         auto exception = checkAndCanonicalizeAmount(item.amount);
257         if (exception.hasException())
258             return exception.releaseException();
259     }
260 
261     String selectedShippingOption;
262     if (requestShipping) {
263         HashSet&lt;String&gt; seenShippingOptionIDs;
264         for (auto&amp; shippingOption : details.shippingOptions) {
265             auto exception = checkAndCanonicalizeAmount(shippingOption.amount);
266             if (exception.hasException())
267                 return exception.releaseException();
268 
269             auto addResult = seenShippingOptionIDs.add(shippingOption.id);
270             if (!addResult.isNewEntry)
271                 return Exception { TypeError, &quot;Shipping option IDs must be unique.&quot; };
272 
273             if (shippingOption.selected)
</pre>
<hr />
<pre>
293         for (auto&amp; item : modifier.additionalDisplayItems) {
294             auto exception = checkAndCanonicalizeAmount(item.amount);
295             if (exception.hasException())
296                 return exception.releaseException();
297         }
298 
299         String serializedData;
300         if (modifier.data) {
301             auto scope = DECLARE_THROW_SCOPE(execState.vm());
302             serializedData = JSONStringify(&amp;execState, modifier.data.get(), 0);
303             if (scope.exception())
304                 return Exception { ExistingExceptionError };
305             modifier.data.clear();
306         }
307         serializedModifierData.uncheckedAppend(WTFMove(serializedData));
308     }
309 
310     return std::make_tuple(WTFMove(selectedShippingOption), WTFMove(serializedModifierData));
311 }
312 









313 // Implements the PaymentRequest Constructor
314 // https://www.w3.org/TR/payment-request/#constructor
315 ExceptionOr&lt;Ref&lt;PaymentRequest&gt;&gt; PaymentRequest::create(Document&amp; document, Vector&lt;PaymentMethodData&gt;&amp;&amp; methodData, PaymentDetailsInit&amp;&amp; details, PaymentOptions&amp;&amp; options)
316 {
317     auto canCreateSession = PaymentHandler::canCreateSession(document);
318     if (canCreateSession.hasException())
319         return canCreateSession.releaseException();
320 
321     if (details.id.isNull())
322         details.id = createCanonicalUUIDString();
323 
324     if (methodData.isEmpty())
325         return Exception { TypeError, &quot;At least one payment method is required.&quot;_s };
326 
327     Vector&lt;Method&gt; serializedMethodData;
328     serializedMethodData.reserveInitialCapacity(methodData.size());
329     for (auto&amp; paymentMethod : methodData) {
330         auto identifier = convertAndValidatePaymentMethodIdentifier(paymentMethod.supportedMethods);
331         if (!identifier)
332             return Exception { RangeError, makeString(&#39;&quot;&#39;, paymentMethod.supportedMethods, &quot;\&quot; is an invalid payment method identifier.&quot;) };
333 
334         String serializedData;
335         if (paymentMethod.data) {
336             auto scope = DECLARE_THROW_SCOPE(document.execState()-&gt;vm());
337             serializedData = JSONStringify(document.execState(), paymentMethod.data.get(), 0);
338             if (scope.exception())
339                 return Exception { ExistingExceptionError };








340         }
341         serializedMethodData.uncheckedAppend({ WTFMove(*identifier), WTFMove(serializedData) });
342     }
343 
344     auto totalResult = checkAndCanonicalizeTotal(details.total.amount);
345     if (totalResult.hasException())
346         return totalResult.releaseException();
347 
348     auto detailsResult = checkAndCanonicalizeDetails(*document.execState(), details, options.requestShipping, ShouldValidatePaymentMethodIdentifier::No);
349     if (detailsResult.hasException())
350         return detailsResult.releaseException();
351 
352     auto shippingOptionAndModifierData = detailsResult.releaseReturnValue();
353     return adoptRef(*new PaymentRequest(document, WTFMove(options), WTFMove(details), WTFMove(std::get&lt;1&gt;(shippingOptionAndModifierData)), WTFMove(serializedMethodData), WTFMove(std::get&lt;0&gt;(shippingOptionAndModifierData))));
354 }
355 
356 bool PaymentRequest::enabledForContext(ScriptExecutionContext&amp; context)
357 {
358     return PaymentHandler::enabledForContext(context);
359 }
360 
361 PaymentRequest::PaymentRequest(Document&amp; document, PaymentOptions&amp;&amp; options, PaymentDetailsInit&amp;&amp; details, Vector&lt;String&gt;&amp;&amp; serializedModifierData, Vector&lt;Method&gt;&amp;&amp; serializedMethodData, String&amp;&amp; selectedShippingOption)
362     : ActiveDOMObject { document }
363     , m_options { WTFMove(options) }
364     , m_details { WTFMove(details) }
365     , m_serializedModifierData { WTFMove(serializedModifierData) }
366     , m_serializedMethodData { WTFMove(serializedMethodData) }
367     , m_shippingOption { WTFMove(selectedShippingOption) }
368 {
369     suspendIfNeeded();
370 }
371 
372 PaymentRequest::~PaymentRequest()
373 {
374     ASSERT(!hasPendingActivity());
375     ASSERT(!m_activePaymentHandler);
376 }
377 
<span class="line-removed">378 static ExceptionOr&lt;JSC::JSValue&gt; parse(ScriptExecutionContext&amp; context, const String&amp; string)</span>
<span class="line-removed">379 {</span>
<span class="line-removed">380     auto scope = DECLARE_THROW_SCOPE(context.vm());</span>
<span class="line-removed">381     JSC::JSValue data = JSONParse(context.execState(), string);</span>
<span class="line-removed">382     if (scope.exception())</span>
<span class="line-removed">383         return Exception { ExistingExceptionError };</span>
<span class="line-removed">384     return WTFMove(data);</span>
<span class="line-removed">385 }</span>
<span class="line-removed">386 </span>
387 // https://www.w3.org/TR/payment-request/#show()-method
388 void PaymentRequest::show(Document&amp; document, RefPtr&lt;DOMPromise&gt;&amp;&amp; detailsPromise, ShowPromise&amp;&amp; promise)
389 {
390     if (!document.frame()) {
391         promise.reject(Exception { AbortError });
392         return;
393     }
394 
395     if (!UserGestureIndicator::processingUserGesture()) {
396         promise.reject(Exception { SecurityError, &quot;show() must be triggered by user activation.&quot; });
397         return;
398     }
399 
400     if (m_state != State::Created) {
401         promise.reject(Exception { InvalidStateError });
402         return;
403     }
404 
405     if (PaymentHandler::hasActiveSession(document)) {
406         promise.reject(Exception { AbortError });
407         m_state = State::Closed;
408         return;
409     }
410 
411     m_state = State::Interactive;
412     ASSERT(!m_showPromise);
<span class="line-modified">413     m_showPromise = WTFMove(promise);</span>
414 
415     RefPtr&lt;PaymentHandler&gt; selectedPaymentHandler;
416     for (auto&amp; paymentMethod : m_serializedMethodData) {
417         auto data = parse(document, paymentMethod.serializedData);
418         if (data.hasException()) {
419             settleShowPromise(data.releaseException());
420             return;
421         }
422 
423         auto handler = PaymentHandler::create(document, *this, paymentMethod.identifier);
424         if (!handler)
425             continue;
426 
427         auto result = handler-&gt;convertData(data.releaseReturnValue());
428         if (result.hasException()) {
429             settleShowPromise(result.releaseException());
430             return;
431         }
432 
433         if (!selectedPaymentHandler)
</pre>
<hr />
<pre>
451     if (!detailsPromise)
452         return;
453 
454     exception = updateWith(UpdateReason::ShowDetailsResolved, detailsPromise.releaseNonNull());
455     ASSERT(!exception.hasException());
456 }
457 
458 void PaymentRequest::abortWithException(Exception&amp;&amp; exception)
459 {
460     ASSERT(m_state == State::Interactive);
461     closeActivePaymentHandler();
462 
463     if (m_response)
464         m_response-&gt;abortWithException(WTFMove(exception));
465     else
466         settleShowPromise(WTFMove(exception));
467 }
468 
469 void PaymentRequest::settleShowPromise(ExceptionOr&lt;PaymentResponse&amp;&gt;&amp;&amp; result)
470 {
<span class="line-modified">471     if (auto showPromise = std::exchange(m_showPromise, WTF::nullopt))</span>
472         showPromise-&gt;settle(WTFMove(result));
473 }
474 
475 void PaymentRequest::closeActivePaymentHandler()
476 {
477     if (auto activePaymentHandler = std::exchange(m_activePaymentHandler, WTF::nullopt))
478         activePaymentHandler-&gt;paymentHandler-&gt;hide();
479 
480     m_isUpdating = false;
481     m_state = State::Closed;
482 }
483 
484 void PaymentRequest::stop()
485 {
486     closeActivePaymentHandler();
487     settleShowPromise(Exception { AbortError });
488 }
489 














490 // https://www.w3.org/TR/payment-request/#abort()-method
491 void PaymentRequest::abort(AbortPromise&amp;&amp; promise)
492 {
493     if (m_response &amp;&amp; m_response-&gt;hasRetryPromise()) {
494         promise.reject(Exception { InvalidStateError });
495         return;
496     }
497 
498     if (m_state != State::Interactive) {
499         promise.reject(Exception { InvalidStateError });
500         return;
501     }
502 
503     abortWithException(Exception { AbortError });
504     promise.resolve();
505 }
506 
507 // https://www.w3.org/TR/payment-request/#canmakepayment()-method
508 void PaymentRequest::canMakePayment(Document&amp; document, CanMakePaymentPromise&amp;&amp; promise)
509 {
</pre>
<hr />
<pre>
521             promise.resolve(canMakePayment);
522         });
523         return;
524     }
525 
526     promise.resolve(false);
527 }
528 
529 const String&amp; PaymentRequest::id() const
530 {
531     return m_details.id;
532 }
533 
534 Optional&lt;PaymentShippingType&gt; PaymentRequest::shippingType() const
535 {
536     if (m_options.requestShipping)
537         return m_options.shippingType;
538     return WTF::nullopt;
539 }
540 
<span class="line-removed">541 bool PaymentRequest::canSuspendForDocumentSuspension() const</span>
<span class="line-removed">542 {</span>
<span class="line-removed">543     return !hasPendingActivity();</span>
<span class="line-removed">544 }</span>
<span class="line-removed">545 </span>
546 void PaymentRequest::shippingAddressChanged(Ref&lt;PaymentAddress&gt;&amp;&amp; shippingAddress)
547 {
548     whenDetailsSettled([this, protectedThis = makeRefPtr(this), shippingAddress = makeRefPtr(shippingAddress.get())]() mutable {
549         m_shippingAddress = WTFMove(shippingAddress);
550         dispatchEvent(PaymentRequestUpdateEvent::create(eventNames().shippingaddresschangeEvent));
551     });
552 }
553 
554 void PaymentRequest::shippingOptionChanged(const String&amp; shippingOption)
555 {
556     whenDetailsSettled([this, protectedThis = makeRefPtr(this), shippingOption]() mutable {
557         m_shippingOption = shippingOption;
558         dispatchEvent(PaymentRequestUpdateEvent::create(eventNames().shippingoptionchangeEvent));
559     });
560 }
561 
562 void PaymentRequest::paymentMethodChanged(const String&amp; methodName, PaymentMethodChangeEvent::MethodDetailsFunction&amp;&amp; methodDetailsFunction)
563 {
564     whenDetailsSettled([this, protectedThis = makeRefPtr(this), methodName, methodDetailsFunction = WTFMove(methodDetailsFunction)]() mutable {
565         auto&amp; eventName = eventNames().paymentmethodchangeEvent;
</pre>
</td>
<td>
<hr />
<pre>
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;PaymentRequest.h&quot;
 28 
 29 #if ENABLE(PAYMENT_REQUEST)
 30 
 31 #include &quot;ApplePayPaymentHandler.h&quot;
 32 #include &quot;Document.h&quot;
 33 #include &quot;EventNames.h&quot;
 34 #include &quot;JSDOMPromise.h&quot;
<span class="line-added"> 35 #include &quot;JSDOMPromiseDeferred.h&quot;</span>
 36 #include &quot;JSPaymentDetailsUpdate.h&quot;
 37 #include &quot;JSPaymentResponse.h&quot;
 38 #include &quot;Page.h&quot;
 39 #include &quot;PaymentAddress.h&quot;
 40 #include &quot;PaymentCoordinator.h&quot;
 41 #include &quot;PaymentCurrencyAmount.h&quot;
 42 #include &quot;PaymentDetailsInit.h&quot;
 43 #include &quot;PaymentHandler.h&quot;
 44 #include &quot;PaymentMethodChangeEvent.h&quot;
 45 #include &quot;PaymentMethodData.h&quot;
 46 #include &quot;PaymentOptions.h&quot;
 47 #include &quot;PaymentRequestUpdateEvent.h&quot;
 48 #include &quot;PaymentValidationErrors.h&quot;
 49 #include &quot;ScriptController.h&quot;
 50 #include &lt;JavaScriptCore/JSONObject.h&gt;
 51 #include &lt;JavaScriptCore/ThrowScope.h&gt;
 52 #include &lt;wtf/ASCIICType.h&gt;
 53 #include &lt;wtf/IsoMallocInlines.h&gt;
 54 #include &lt;wtf/RunLoop.h&gt;
 55 #include &lt;wtf/Scope.h&gt;
</pre>
<hr />
<pre>
234 Optional&lt;PaymentRequest::MethodIdentifier&gt; convertAndValidatePaymentMethodIdentifier(const String&amp; identifier)
235 {
236     URL url { URL(), identifier };
237     if (!url.isValid()) {
238         if (isValidStandardizedPaymentMethodIdentifier(identifier))
239             return { identifier };
240         return WTF::nullopt;
241     }
242 
243     if (isValidURLBasedPaymentMethodIdentifier(url))
244         return { WTFMove(url) };
245 
246     return WTF::nullopt;
247 }
248 
249 enum class ShouldValidatePaymentMethodIdentifier {
250     No,
251     Yes,
252 };
253 
<span class="line-modified">254 static ExceptionOr&lt;std::tuple&lt;String, Vector&lt;String&gt;&gt;&gt; checkAndCanonicalizeDetails(JSC::JSGlobalObject&amp; execState, PaymentDetailsBase&amp; details, bool requestShipping, ShouldValidatePaymentMethodIdentifier shouldValidatePaymentMethodIdentifier)</span>
255 {
256     for (auto&amp; item : details.displayItems) {
257         auto exception = checkAndCanonicalizeAmount(item.amount);
258         if (exception.hasException())
259             return exception.releaseException();
260     }
261 
262     String selectedShippingOption;
263     if (requestShipping) {
264         HashSet&lt;String&gt; seenShippingOptionIDs;
265         for (auto&amp; shippingOption : details.shippingOptions) {
266             auto exception = checkAndCanonicalizeAmount(shippingOption.amount);
267             if (exception.hasException())
268                 return exception.releaseException();
269 
270             auto addResult = seenShippingOptionIDs.add(shippingOption.id);
271             if (!addResult.isNewEntry)
272                 return Exception { TypeError, &quot;Shipping option IDs must be unique.&quot; };
273 
274             if (shippingOption.selected)
</pre>
<hr />
<pre>
294         for (auto&amp; item : modifier.additionalDisplayItems) {
295             auto exception = checkAndCanonicalizeAmount(item.amount);
296             if (exception.hasException())
297                 return exception.releaseException();
298         }
299 
300         String serializedData;
301         if (modifier.data) {
302             auto scope = DECLARE_THROW_SCOPE(execState.vm());
303             serializedData = JSONStringify(&amp;execState, modifier.data.get(), 0);
304             if (scope.exception())
305                 return Exception { ExistingExceptionError };
306             modifier.data.clear();
307         }
308         serializedModifierData.uncheckedAppend(WTFMove(serializedData));
309     }
310 
311     return std::make_tuple(WTFMove(selectedShippingOption), WTFMove(serializedModifierData));
312 }
313 
<span class="line-added">314 static ExceptionOr&lt;JSC::JSValue&gt; parse(ScriptExecutionContext&amp; context, const String&amp; string)</span>
<span class="line-added">315 {</span>
<span class="line-added">316     auto scope = DECLARE_THROW_SCOPE(context.vm());</span>
<span class="line-added">317     JSC::JSValue data = JSONParse(context.execState(), string);</span>
<span class="line-added">318     if (scope.exception())</span>
<span class="line-added">319         return Exception { ExistingExceptionError };</span>
<span class="line-added">320     return data;</span>
<span class="line-added">321 }</span>
<span class="line-added">322 </span>
323 // Implements the PaymentRequest Constructor
324 // https://www.w3.org/TR/payment-request/#constructor
325 ExceptionOr&lt;Ref&lt;PaymentRequest&gt;&gt; PaymentRequest::create(Document&amp; document, Vector&lt;PaymentMethodData&gt;&amp;&amp; methodData, PaymentDetailsInit&amp;&amp; details, PaymentOptions&amp;&amp; options)
326 {
327     auto canCreateSession = PaymentHandler::canCreateSession(document);
328     if (canCreateSession.hasException())
329         return canCreateSession.releaseException();
330 
331     if (details.id.isNull())
332         details.id = createCanonicalUUIDString();
333 
334     if (methodData.isEmpty())
335         return Exception { TypeError, &quot;At least one payment method is required.&quot;_s };
336 
337     Vector&lt;Method&gt; serializedMethodData;
338     serializedMethodData.reserveInitialCapacity(methodData.size());
339     for (auto&amp; paymentMethod : methodData) {
340         auto identifier = convertAndValidatePaymentMethodIdentifier(paymentMethod.supportedMethods);
341         if (!identifier)
342             return Exception { RangeError, makeString(&#39;&quot;&#39;, paymentMethod.supportedMethods, &quot;\&quot; is an invalid payment method identifier.&quot;) };
343 
344         String serializedData;
345         if (paymentMethod.data) {
346             auto scope = DECLARE_THROW_SCOPE(document.execState()-&gt;vm());
347             serializedData = JSONStringify(document.execState(), paymentMethod.data.get(), 0);
348             if (scope.exception())
349                 return Exception { ExistingExceptionError };
<span class="line-added">350 </span>
<span class="line-added">351             auto parsedDataOrException = parse(document, serializedData);</span>
<span class="line-added">352             if (parsedDataOrException.hasException())</span>
<span class="line-added">353                 return parsedDataOrException.releaseException();</span>
<span class="line-added">354 </span>
<span class="line-added">355             auto exception = PaymentHandler::validateData(document, parsedDataOrException.releaseReturnValue(), *identifier);</span>
<span class="line-added">356             if (exception.hasException())</span>
<span class="line-added">357                 return exception.releaseException();</span>
358         }
359         serializedMethodData.uncheckedAppend({ WTFMove(*identifier), WTFMove(serializedData) });
360     }
361 
362     auto totalResult = checkAndCanonicalizeTotal(details.total.amount);
363     if (totalResult.hasException())
364         return totalResult.releaseException();
365 
366     auto detailsResult = checkAndCanonicalizeDetails(*document.execState(), details, options.requestShipping, ShouldValidatePaymentMethodIdentifier::No);
367     if (detailsResult.hasException())
368         return detailsResult.releaseException();
369 
370     auto shippingOptionAndModifierData = detailsResult.releaseReturnValue();
371     return adoptRef(*new PaymentRequest(document, WTFMove(options), WTFMove(details), WTFMove(std::get&lt;1&gt;(shippingOptionAndModifierData)), WTFMove(serializedMethodData), WTFMove(std::get&lt;0&gt;(shippingOptionAndModifierData))));
372 }
373 
374 bool PaymentRequest::enabledForContext(ScriptExecutionContext&amp; context)
375 {
376     return PaymentHandler::enabledForContext(context);
377 }
378 
379 PaymentRequest::PaymentRequest(Document&amp; document, PaymentOptions&amp;&amp; options, PaymentDetailsInit&amp;&amp; details, Vector&lt;String&gt;&amp;&amp; serializedModifierData, Vector&lt;Method&gt;&amp;&amp; serializedMethodData, String&amp;&amp; selectedShippingOption)
380     : ActiveDOMObject { document }
381     , m_options { WTFMove(options) }
382     , m_details { WTFMove(details) }
383     , m_serializedModifierData { WTFMove(serializedModifierData) }
384     , m_serializedMethodData { WTFMove(serializedMethodData) }
385     , m_shippingOption { WTFMove(selectedShippingOption) }
386 {
387     suspendIfNeeded();
388 }
389 
390 PaymentRequest::~PaymentRequest()
391 {
392     ASSERT(!hasPendingActivity());
393     ASSERT(!m_activePaymentHandler);
394 }
395 









396 // https://www.w3.org/TR/payment-request/#show()-method
397 void PaymentRequest::show(Document&amp; document, RefPtr&lt;DOMPromise&gt;&amp;&amp; detailsPromise, ShowPromise&amp;&amp; promise)
398 {
399     if (!document.frame()) {
400         promise.reject(Exception { AbortError });
401         return;
402     }
403 
404     if (!UserGestureIndicator::processingUserGesture()) {
405         promise.reject(Exception { SecurityError, &quot;show() must be triggered by user activation.&quot; });
406         return;
407     }
408 
409     if (m_state != State::Created) {
410         promise.reject(Exception { InvalidStateError });
411         return;
412     }
413 
414     if (PaymentHandler::hasActiveSession(document)) {
415         promise.reject(Exception { AbortError });
416         m_state = State::Closed;
417         return;
418     }
419 
420     m_state = State::Interactive;
421     ASSERT(!m_showPromise);
<span class="line-modified">422     m_showPromise = WTF::makeUnique&lt;ShowPromise&gt;(WTFMove(promise));</span>
423 
424     RefPtr&lt;PaymentHandler&gt; selectedPaymentHandler;
425     for (auto&amp; paymentMethod : m_serializedMethodData) {
426         auto data = parse(document, paymentMethod.serializedData);
427         if (data.hasException()) {
428             settleShowPromise(data.releaseException());
429             return;
430         }
431 
432         auto handler = PaymentHandler::create(document, *this, paymentMethod.identifier);
433         if (!handler)
434             continue;
435 
436         auto result = handler-&gt;convertData(data.releaseReturnValue());
437         if (result.hasException()) {
438             settleShowPromise(result.releaseException());
439             return;
440         }
441 
442         if (!selectedPaymentHandler)
</pre>
<hr />
<pre>
460     if (!detailsPromise)
461         return;
462 
463     exception = updateWith(UpdateReason::ShowDetailsResolved, detailsPromise.releaseNonNull());
464     ASSERT(!exception.hasException());
465 }
466 
467 void PaymentRequest::abortWithException(Exception&amp;&amp; exception)
468 {
469     ASSERT(m_state == State::Interactive);
470     closeActivePaymentHandler();
471 
472     if (m_response)
473         m_response-&gt;abortWithException(WTFMove(exception));
474     else
475         settleShowPromise(WTFMove(exception));
476 }
477 
478 void PaymentRequest::settleShowPromise(ExceptionOr&lt;PaymentResponse&amp;&gt;&amp;&amp; result)
479 {
<span class="line-modified">480     if (auto showPromise = std::exchange(m_showPromise, nullptr))</span>
481         showPromise-&gt;settle(WTFMove(result));
482 }
483 
484 void PaymentRequest::closeActivePaymentHandler()
485 {
486     if (auto activePaymentHandler = std::exchange(m_activePaymentHandler, WTF::nullopt))
487         activePaymentHandler-&gt;paymentHandler-&gt;hide();
488 
489     m_isUpdating = false;
490     m_state = State::Closed;
491 }
492 
493 void PaymentRequest::stop()
494 {
495     closeActivePaymentHandler();
496     settleShowPromise(Exception { AbortError });
497 }
498 
<span class="line-added">499 void PaymentRequest::suspend(ReasonForSuspension reason)</span>
<span class="line-added">500 {</span>
<span class="line-added">501     if (reason != ReasonForSuspension::BackForwardCache)</span>
<span class="line-added">502         return;</span>
<span class="line-added">503 </span>
<span class="line-added">504     if (!m_activePaymentHandler) {</span>
<span class="line-added">505         ASSERT(!m_showPromise);</span>
<span class="line-added">506         ASSERT(m_state != State::Interactive);</span>
<span class="line-added">507         return;</span>
<span class="line-added">508     }</span>
<span class="line-added">509 </span>
<span class="line-added">510     stop();</span>
<span class="line-added">511 }</span>
<span class="line-added">512 </span>
513 // https://www.w3.org/TR/payment-request/#abort()-method
514 void PaymentRequest::abort(AbortPromise&amp;&amp; promise)
515 {
516     if (m_response &amp;&amp; m_response-&gt;hasRetryPromise()) {
517         promise.reject(Exception { InvalidStateError });
518         return;
519     }
520 
521     if (m_state != State::Interactive) {
522         promise.reject(Exception { InvalidStateError });
523         return;
524     }
525 
526     abortWithException(Exception { AbortError });
527     promise.resolve();
528 }
529 
530 // https://www.w3.org/TR/payment-request/#canmakepayment()-method
531 void PaymentRequest::canMakePayment(Document&amp; document, CanMakePaymentPromise&amp;&amp; promise)
532 {
</pre>
<hr />
<pre>
544             promise.resolve(canMakePayment);
545         });
546         return;
547     }
548 
549     promise.resolve(false);
550 }
551 
552 const String&amp; PaymentRequest::id() const
553 {
554     return m_details.id;
555 }
556 
557 Optional&lt;PaymentShippingType&gt; PaymentRequest::shippingType() const
558 {
559     if (m_options.requestShipping)
560         return m_options.shippingType;
561     return WTF::nullopt;
562 }
563 





564 void PaymentRequest::shippingAddressChanged(Ref&lt;PaymentAddress&gt;&amp;&amp; shippingAddress)
565 {
566     whenDetailsSettled([this, protectedThis = makeRefPtr(this), shippingAddress = makeRefPtr(shippingAddress.get())]() mutable {
567         m_shippingAddress = WTFMove(shippingAddress);
568         dispatchEvent(PaymentRequestUpdateEvent::create(eventNames().shippingaddresschangeEvent));
569     });
570 }
571 
572 void PaymentRequest::shippingOptionChanged(const String&amp; shippingOption)
573 {
574     whenDetailsSettled([this, protectedThis = makeRefPtr(this), shippingOption]() mutable {
575         m_shippingOption = shippingOption;
576         dispatchEvent(PaymentRequestUpdateEvent::create(eventNames().shippingoptionchangeEvent));
577     });
578 }
579 
580 void PaymentRequest::paymentMethodChanged(const String&amp; methodName, PaymentMethodChangeEvent::MethodDetailsFunction&amp;&amp; methodDetailsFunction)
581 {
582     whenDetailsSettled([this, protectedThis = makeRefPtr(this), methodName, methodDetailsFunction = WTFMove(methodDetailsFunction)]() mutable {
583         auto&amp; eventName = eventNames().paymentmethodchangeEvent;
</pre>
</td>
</tr>
</table>
<center><a href="PaymentMethodChangeEvent.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="PaymentRequest.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>