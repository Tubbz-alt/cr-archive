<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/UserMediaController.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="UserMediaClient.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="UserMediaController.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/Modules/mediastream/UserMediaController.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 26,19 ***</span>
  #include &quot;config.h&quot;
  #include &quot;UserMediaController.h&quot;
  
  #if ENABLE(MEDIA_STREAM)
  
<span class="line-removed">- #include &quot;CustomHeaderFields.h&quot;</span>
  #include &quot;DOMWindow.h&quot;
  #include &quot;Document.h&quot;
<span class="line-removed">- #include &quot;DocumentLoader.h&quot;</span>
  #include &quot;Frame.h&quot;
  #include &quot;HTMLIFrameElement.h&quot;
<span class="line-removed">- #include &quot;HTMLParserIdioms.h&quot;</span>
<span class="line-removed">- #include &quot;SchemeRegistry.h&quot;</span>
<span class="line-removed">- #include &quot;Settings.h&quot;</span>
  #include &quot;UserMediaRequest.h&quot;
  
  namespace WebCore {
  
  const char* UserMediaController::supplementName()
<span class="line-new-header">--- 26,14 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 59,114 ***</span>
  void provideUserMediaTo(Page* page, UserMediaClient* client)
  {
      UserMediaController::provideTo(page, UserMediaController::supplementName(), makeUnique&lt;UserMediaController&gt;(client));
  }
  
<span class="line-modified">! static inline bool isSecure(DocumentLoader&amp; documentLoader)</span>
  {
<span class="line-modified">!     auto&amp; response = documentLoader.response();</span>
<span class="line-modified">!     if (SecurityOrigin::isLocalHostOrLoopbackIPAddress(documentLoader.response().url().host()))</span>
<span class="line-removed">-         return true;</span>
<span class="line-removed">-     return SchemeRegistry::shouldTreatURLSchemeAsSecure(response.url().protocol().toStringWithoutCopying())</span>
<span class="line-removed">-         &amp;&amp; response.certificateInfo()</span>
<span class="line-removed">-         &amp;&amp; !response.certificateInfo()-&gt;containsNonRootSHA1SignedCertificate();</span>
  }
  
<span class="line-modified">! static inline bool isAllowedByFeaturePolicy(const FeaturePolicy&amp; featurePolicy, const SecurityOriginData&amp; origin, OptionSet&lt;UserMediaController::CaptureType&gt; types)</span>
  {
<span class="line-modified">!     if ((types &amp; UserMediaController::CaptureType::Camera) &amp;&amp; !featurePolicy.allows(FeaturePolicy::Type::Camera, origin))</span>
<span class="line-modified">!         return false;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if ((types &amp; UserMediaController::CaptureType::Microphone) &amp;&amp; !featurePolicy.allows(FeaturePolicy::Type::Microphone, origin))</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if ((types &amp; UserMediaController::CaptureType::Display) &amp;&amp; !featurePolicy.allows(FeaturePolicy::Type::DisplayCapture, origin))</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return true;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- static UserMediaController::GetUserMediaAccess isAllowedToUse(const Document&amp; document, const Document&amp; topDocument, OptionSet&lt;UserMediaController::CaptureType&gt; types)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     if (&amp;document == &amp;topDocument)</span>
<span class="line-removed">-         return UserMediaController::GetUserMediaAccess::CanCall;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     auto* parentDocument = document.parentDocument();</span>
<span class="line-removed">-     if (!parentDocument)</span>
<span class="line-removed">-         return UserMediaController::GetUserMediaAccess::BlockedByParent;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     auto* element = document.ownerElement();</span>
<span class="line-removed">-     ASSERT(element);</span>
<span class="line-removed">-     if (!element || !is&lt;HTMLIFrameElement&gt;(*element))</span>
<span class="line-removed">-         return UserMediaController::GetUserMediaAccess::BlockedByParent;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     auto&amp; featurePolicy = downcast&lt;HTMLIFrameElement&gt;(*element).featurePolicy();</span>
<span class="line-removed">-     if (isAllowedByFeaturePolicy(featurePolicy, document.securityOrigin().data(), types))</span>
<span class="line-removed">-         return UserMediaController::GetUserMediaAccess::CanCall;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return UserMediaController::GetUserMediaAccess::BlockedByFeaturePolicy;</span>
  }
  
<span class="line-modified">! UserMediaController::GetUserMediaAccess UserMediaController::canCallGetUserMedia(const Document&amp; document, OptionSet&lt;UserMediaController::CaptureType&gt; types) const</span>
  {
<span class="line-modified">!     ASSERT(!types.isEmpty());</span>
<span class="line-modified">! </span>
<span class="line-modified">!     bool requiresSecureConnection = true;</span>
<span class="line-modified">!     if (auto page = document.page())</span>
<span class="line-modified">!         requiresSecureConnection = page-&gt;settings().mediaCaptureRequiresSecureConnection();</span>
<span class="line-removed">-     auto&amp; documentLoader = *document.loader();</span>
<span class="line-removed">-     if (requiresSecureConnection &amp;&amp; !isSecure(documentLoader))</span>
<span class="line-removed">-         return GetUserMediaAccess::InsecureDocument;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     auto&amp; topDocument = document.topDocument();</span>
<span class="line-removed">-     if (&amp;document != &amp;topDocument) {</span>
<span class="line-removed">-         for (auto* ancestorDocument = &amp;document; ancestorDocument != &amp;topDocument; ancestorDocument = ancestorDocument-&gt;parentDocument()) {</span>
<span class="line-removed">-             if (requiresSecureConnection &amp;&amp; !isSecure(*ancestorDocument-&gt;loader()))</span>
<span class="line-removed">-                 return GetUserMediaAccess::InsecureParent;</span>
<span class="line-removed">- </span>
<span class="line-removed">-             auto status = isAllowedToUse(*ancestorDocument, topDocument, types);</span>
<span class="line-removed">-             if (status != GetUserMediaAccess::CanCall)</span>
<span class="line-removed">-                 return status;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return GetUserMediaAccess::CanCall;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void UserMediaController::logGetUserMediaDenial(Document&amp; document, GetUserMediaAccess access, BlockedCaller caller)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     auto&amp; domWindow = *document.domWindow();</span>
<span class="line-removed">-     const char* callerName;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     switch (caller) {</span>
<span class="line-removed">-     case BlockedCaller::GetUserMedia:</span>
<span class="line-removed">-         callerName = &quot;getUserMedia&quot;;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case BlockedCaller::GetDisplayMedia:</span>
<span class="line-removed">-         callerName = &quot;getDisplayMedia&quot;;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case BlockedCaller::EnumerateDevices:</span>
<span class="line-removed">-         callerName = &quot;enumerateDevices&quot;;</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     switch (access) {</span>
<span class="line-removed">-     case UserMediaController::GetUserMediaAccess::InsecureDocument:</span>
<span class="line-removed">-         domWindow.printErrorMessage(makeString(&quot;Trying to call &quot;, callerName, &quot; from an insecure document.&quot;));</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case UserMediaController::GetUserMediaAccess::InsecureParent:</span>
<span class="line-removed">-         domWindow.printErrorMessage(makeString(&quot;Trying to call &quot;, callerName, &quot; from a document with an insecure parent frame.&quot;));</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case UserMediaController::GetUserMediaAccess::BlockedByParent:</span>
<span class="line-removed">-         domWindow.printErrorMessage(makeString(&quot;The top-level frame has prevented a document with a different security origin from calling &quot;, callerName, &quot;.&quot;));</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case GetUserMediaAccess::BlockedByFeaturePolicy:</span>
<span class="line-removed">-         domWindow.printErrorMessage(makeString(&quot;Trying to call &quot;, callerName, &quot; from a frame without correct &#39;allow&#39; attribute.&quot;));</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     case UserMediaController::GetUserMediaAccess::CanCall:</span>
<span class="line-removed">-         break;</span>
<span class="line-removed">-     }</span>
  }
  
  } // namespace WebCore
  
  #endif // ENABLE(MEDIA_STREAM)
<span class="line-new-header">--- 54,29 ---</span>
  void provideUserMediaTo(Page* page, UserMediaClient* client)
  {
      UserMediaController::provideTo(page, UserMediaController::supplementName(), makeUnique&lt;UserMediaController&gt;(client));
  }
  
<span class="line-modified">! void UserMediaController::logGetUserMediaDenial(Document&amp; document)</span>
  {
<span class="line-modified">!     if (auto* window = document.domWindow())</span>
<span class="line-modified">!         window-&gt;printErrorMessage(makeString(&quot;Not allowed to call getUserMedia.&quot;));</span>
  }
  
<span class="line-modified">! void UserMediaController::logGetDisplayMediaDenial(Document&amp; document)</span>
  {
<span class="line-modified">!     if (auto* window = document.domWindow())</span>
<span class="line-modified">!         window-&gt;printErrorMessage(makeString(&quot;Not allowed to call getDisplayMedia.&quot;));</span>
  }
  
<span class="line-modified">! void UserMediaController::logEnumerateDevicesDenial(Document&amp; document)</span>
  {
<span class="line-modified">!     // We redo the check to print to the console log.</span>
<span class="line-modified">!     isFeaturePolicyAllowedByDocumentAndAllOwners(FeaturePolicy::Type::Camera, document, LogFeaturePolicyFailure::Yes);</span>
<span class="line-modified">!     isFeaturePolicyAllowedByDocumentAndAllOwners(FeaturePolicy::Type::Microphone, document, LogFeaturePolicyFailure::Yes);</span>
<span class="line-modified">!     if (auto* window = document.domWindow())</span>
<span class="line-modified">!         window-&gt;printErrorMessage(makeString(&quot;Not allowed to call enumerateDevices.&quot;));</span>
  }
  
  } // namespace WebCore
  
  #endif // ENABLE(MEDIA_STREAM)
</pre>
<center><a href="UserMediaClient.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="UserMediaController.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>