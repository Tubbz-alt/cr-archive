<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/page/PageConsoleClient.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PageConfiguration.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PageConsoleClient.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/PageConsoleClient.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -54,23 +54,27 @@</span>
  #include &quot;JSHTMLCanvasElement.h&quot;
  #include &quot;JSImageBitmap.h&quot;
  #include &quot;JSImageBitmapRenderingContext.h&quot;
  #include &quot;JSImageData.h&quot;
  #include &quot;JSNode.h&quot;
<span class="udiff-line-removed">- #include &quot;JSOffscreenCanvas.h&quot;</span>
  #include &quot;Node.h&quot;
<span class="udiff-line-removed">- #include &quot;OffscreenCanvas.h&quot;</span>
  #include &quot;Page.h&quot;
  #include &quot;ScriptableDocumentParser.h&quot;
  #include &quot;Settings.h&quot;
  #include &lt;JavaScriptCore/ConsoleMessage.h&gt;
  #include &lt;JavaScriptCore/JSCInlines.h&gt;
  #include &lt;JavaScriptCore/ScriptArguments.h&gt;
  #include &lt;JavaScriptCore/ScriptCallStack.h&gt;
  #include &lt;JavaScriptCore/ScriptCallStackFactory.h&gt;
<span class="udiff-line-added">+ #include &lt;JavaScriptCore/StrongInlines.h&gt;</span>
  #include &lt;wtf/text/WTFString.h&gt;
  
<span class="udiff-line-added">+ #if ENABLE(OFFSCREEN_CANVAS)</span>
<span class="udiff-line-added">+ #include &quot;JSOffscreenCanvas.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;OffscreenCanvas.h&quot;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  #if ENABLE(WEBGL)
  #include &quot;JSWebGLRenderingContext.h&quot;
  #include &quot;WebGLRenderingContext.h&quot;
  #endif
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -125,11 +129,11 @@</span>
          m_page.chrome().client().addMessageToConsole(consoleMessage-&gt;source(), consoleMessage-&gt;level(), message, consoleMessage-&gt;line(), consoleMessage-&gt;column(), consoleMessage-&gt;url());
  
          if (UNLIKELY(m_page.settings().logsPageMessagesToSystemConsoleEnabled() || shouldPrintExceptions())) {
              if (consoleMessage-&gt;type() == MessageType::Image) {
                  ASSERT(consoleMessage-&gt;arguments());
<span class="udiff-line-modified-removed">-                 ConsoleClient::printConsoleMessageWithArguments(MessageSource::ConsoleAPI, MessageType::Log, consoleMessage-&gt;level(), consoleMessage-&gt;arguments()-&gt;globalState(), *consoleMessage-&gt;arguments());</span>
<span class="udiff-line-modified-added">+                 ConsoleClient::printConsoleMessageWithArguments(MessageSource::ConsoleAPI, MessageType::Log, consoleMessage-&gt;level(), consoleMessage-&gt;arguments()-&gt;globalObject(), *consoleMessage-&gt;arguments());</span>
              } else
                  ConsoleClient::printConsoleMessage(MessageSource::ConsoleAPI, MessageType::Log, consoleMessage-&gt;level(), consoleMessage-&gt;message(), consoleMessage-&gt;url(), consoleMessage-&gt;line(), consoleMessage-&gt;column());
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -150,32 +154,32 @@</span>
  void PageConsoleClient::addMessage(MessageSource source, MessageLevel level, const String&amp; message, Ref&lt;ScriptCallStack&gt;&amp;&amp; callStack)
  {
      addMessage(source, level, message, String(), 0, 0, WTFMove(callStack), 0);
  }
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::addMessage(MessageSource source, MessageLevel level, const String&amp; messageText, const String&amp; suggestedURL, unsigned suggestedLineNumber, unsigned suggestedColumnNumber, RefPtr&lt;ScriptCallStack&gt;&amp;&amp; callStack, JSC::ExecState* state, unsigned long requestIdentifier)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::addMessage(MessageSource source, MessageLevel level, const String&amp; messageText, const String&amp; suggestedURL, unsigned suggestedLineNumber, unsigned suggestedColumnNumber, RefPtr&lt;ScriptCallStack&gt;&amp;&amp; callStack, JSC::JSGlobalObject* lexicalGlobalObject, unsigned long requestIdentifier)</span>
  {
      if (muteCount &amp;&amp; source != MessageSource::ConsoleAPI)
          return;
  
      std::unique_ptr&lt;Inspector::ConsoleMessage&gt; message;
  
      if (callStack)
          message = makeUnique&lt;Inspector::ConsoleMessage&gt;(source, MessageType::Log, level, messageText, callStack.releaseNonNull(), requestIdentifier);
      else
<span class="udiff-line-modified-removed">-         message = makeUnique&lt;Inspector::ConsoleMessage&gt;(source, MessageType::Log, level, messageText, suggestedURL, suggestedLineNumber, suggestedColumnNumber, state, requestIdentifier);</span>
<span class="udiff-line-modified-added">+         message = makeUnique&lt;Inspector::ConsoleMessage&gt;(source, MessageType::Log, level, messageText, suggestedURL, suggestedLineNumber, suggestedColumnNumber, lexicalGlobalObject, requestIdentifier);</span>
  
      addMessage(WTFMove(message));
  }
  
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::messageWithTypeAndLevel(MessageType type, MessageLevel level, JSC::ExecState* exec, Ref&lt;Inspector::ScriptArguments&gt;&amp;&amp; arguments)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::messageWithTypeAndLevel(MessageType type, MessageLevel level, JSC::JSGlobalObject* lexicalGlobalObject, Ref&lt;Inspector::ScriptArguments&gt;&amp;&amp; arguments)</span>
  {
      String messageText;
      bool gotMessage = arguments-&gt;getFirstArgumentAsString(messageText);
  
<span class="udiff-line-modified-removed">-     auto message = makeUnique&lt;Inspector::ConsoleMessage&gt;(MessageSource::ConsoleAPI, type, level, messageText, arguments.copyRef(), exec);</span>
<span class="udiff-line-modified-added">+     auto message = makeUnique&lt;Inspector::ConsoleMessage&gt;(MessageSource::ConsoleAPI, type, level, messageText, arguments.copyRef(), lexicalGlobalObject);</span>
  
      String url = message-&gt;url();
      unsigned lineNumber = message-&gt;line();
      unsigned columnNumber = message-&gt;column();
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -186,56 +190,56 @@</span>
  
      if (gotMessage)
          m_page.chrome().client().addMessageToConsole(MessageSource::ConsoleAPI, level, messageText, lineNumber, columnNumber, url);
  
      if (m_page.settings().logsPageMessagesToSystemConsoleEnabled() || PageConsoleClient::shouldPrintExceptions())
<span class="udiff-line-modified-removed">-         ConsoleClient::printConsoleMessageWithArguments(MessageSource::ConsoleAPI, type, level, exec, WTFMove(arguments));</span>
<span class="udiff-line-modified-added">+         ConsoleClient::printConsoleMessageWithArguments(MessageSource::ConsoleAPI, type, level, lexicalGlobalObject, WTFMove(arguments));</span>
  }
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::count(JSC::ExecState* exec, const String&amp; label)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::count(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; label)</span>
  {
<span class="udiff-line-modified-removed">-     InspectorInstrumentation::consoleCount(m_page, exec, label);</span>
<span class="udiff-line-modified-added">+     InspectorInstrumentation::consoleCount(m_page, lexicalGlobalObject, label);</span>
  }
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::countReset(JSC::ExecState* exec, const String&amp; label)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::countReset(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; label)</span>
  {
<span class="udiff-line-modified-removed">-     InspectorInstrumentation::consoleCountReset(m_page, exec, label);</span>
<span class="udiff-line-modified-added">+     InspectorInstrumentation::consoleCountReset(m_page, lexicalGlobalObject, label);</span>
  }
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::profile(JSC::ExecState* exec, const String&amp; title)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::profile(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; title)</span>
  {
      // FIXME: &lt;https://webkit.org/b/153499&gt; Web Inspector: console.profile should use the new Sampling Profiler
<span class="udiff-line-modified-removed">-     InspectorInstrumentation::startProfiling(m_page, exec, title);</span>
<span class="udiff-line-modified-added">+     InspectorInstrumentation::startProfiling(m_page, lexicalGlobalObject, title);</span>
  }
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::profileEnd(JSC::ExecState* exec, const String&amp; title)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::profileEnd(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; title)</span>
  {
      // FIXME: &lt;https://webkit.org/b/153499&gt; Web Inspector: console.profile should use the new Sampling Profiler
<span class="udiff-line-modified-removed">-     InspectorInstrumentation::stopProfiling(m_page, exec, title);</span>
<span class="udiff-line-modified-added">+     InspectorInstrumentation::stopProfiling(m_page, lexicalGlobalObject, title);</span>
  }
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::takeHeapSnapshot(JSC::ExecState*, const String&amp; title)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::takeHeapSnapshot(JSC::JSGlobalObject*, const String&amp; title)</span>
  {
      InspectorInstrumentation::takeHeapSnapshot(m_page.mainFrame(), title);
  }
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::time(JSC::ExecState* exec, const String&amp; label)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::time(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; label)</span>
  {
<span class="udiff-line-modified-removed">-     InspectorInstrumentation::startConsoleTiming(m_page.mainFrame(), exec, label);</span>
<span class="udiff-line-modified-added">+     InspectorInstrumentation::startConsoleTiming(m_page.mainFrame(), lexicalGlobalObject, label);</span>
  }
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::timeLog(JSC::ExecState* exec, const String&amp; label, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::timeLog(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; label, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
  {
<span class="udiff-line-modified-removed">-     InspectorInstrumentation::logConsoleTiming(m_page.mainFrame(), exec, label, WTFMove(arguments));</span>
<span class="udiff-line-modified-added">+     InspectorInstrumentation::logConsoleTiming(m_page.mainFrame(), lexicalGlobalObject, label, WTFMove(arguments));</span>
  }
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::timeEnd(JSC::ExecState* exec, const String&amp; label)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::timeEnd(JSC::JSGlobalObject* lexicalGlobalObject, const String&amp; label)</span>
  {
<span class="udiff-line-modified-removed">-     InspectorInstrumentation::stopConsoleTiming(m_page.mainFrame(), exec, label);</span>
<span class="udiff-line-modified-added">+     InspectorInstrumentation::stopConsoleTiming(m_page.mainFrame(), lexicalGlobalObject, label);</span>
  }
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::timeStamp(JSC::ExecState*, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::timeStamp(JSC::JSGlobalObject*, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
  {
      InspectorInstrumentation::consoleTimeStamp(m_page.mainFrame(), WTFMove(arguments));
  }
  
  static JSC::JSObject* objectArgumentAt(ScriptArguments&amp; arguments, unsigned index)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -245,12 +249,14 @@</span>
  
  static CanvasRenderingContext* canvasRenderingContext(JSC::VM&amp; vm, JSC::JSValue target)
  {
      if (auto* canvas = JSHTMLCanvasElement::toWrapped(vm, target))
          return canvas-&gt;renderingContext();
<span class="udiff-line-added">+ #if ENABLE(OFFSCREEN_CANVAS)</span>
      if (auto* canvas = JSOffscreenCanvas::toWrapped(vm, target))
          return canvas-&gt;renderingContext();
<span class="udiff-line-added">+ #endif</span>
      if (auto* context = JSCanvasRenderingContext2D::toWrapped(vm, target))
          return context;
      if (auto* context = JSImageBitmapRenderingContext::toWrapped(vm, target))
          return context;
  #if ENABLE(WEBGL)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -262,23 +268,29 @@</span>
          return context;
  #endif
      return nullptr;
  }
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::record(JSC::ExecState* state, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::record(JSC::JSGlobalObject* lexicalGlobalObject, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
  {
<span class="udiff-line-added">+     if (LIKELY(!InspectorInstrumentation::hasFrontends()))</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
      if (auto* target = objectArgumentAt(arguments, 0)) {
<span class="udiff-line-modified-removed">-         if (auto* context = canvasRenderingContext(state-&gt;vm(), target))</span>
<span class="udiff-line-modified-removed">-             InspectorInstrumentation::consoleStartRecordingCanvas(*context, *state, objectArgumentAt(arguments, 1));</span>
<span class="udiff-line-modified-added">+         if (auto* context = canvasRenderingContext(lexicalGlobalObject-&gt;vm(), target))</span>
<span class="udiff-line-modified-added">+             InspectorInstrumentation::consoleStartRecordingCanvas(*context, *lexicalGlobalObject, objectArgumentAt(arguments, 1));</span>
      }
  }
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::recordEnd(JSC::ExecState* state, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::recordEnd(JSC::JSGlobalObject* lexicalGlobalObject, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
  {
<span class="udiff-line-added">+     if (LIKELY(!InspectorInstrumentation::hasFrontends()))</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
      if (auto* target = objectArgumentAt(arguments, 0)) {
<span class="udiff-line-modified-removed">-         if (auto* context = canvasRenderingContext(state-&gt;vm(), target))</span>
<span class="udiff-line-modified-removed">-             InspectorInstrumentation::didFinishRecordingCanvasFrame(*context, true);</span>
<span class="udiff-line-modified-added">+         if (auto* context = canvasRenderingContext(lexicalGlobalObject-&gt;vm(), target))</span>
<span class="udiff-line-modified-added">+             InspectorInstrumentation::consoleStopRecordingCanvas(*context);</span>
      }
  }
  
  static Optional&lt;String&gt; snapshotCanvas(HTMLCanvasElement&amp; canvasElement, CanvasRenderingContext&amp; canvasRenderingContext)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -298,13 +310,13 @@</span>
          return result.releaseReturnValue().string;
  
      return WTF::nullopt;
  }
  
<span class="udiff-line-modified-removed">- void PageConsoleClient::screenshot(JSC::ExecState* state, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
<span class="udiff-line-modified-added">+ void PageConsoleClient::screenshot(JSC::JSGlobalObject* lexicalGlobalObject, Ref&lt;ScriptArguments&gt;&amp;&amp; arguments)</span>
  {
<span class="udiff-line-modified-removed">-     JSC::VM&amp; vm = state-&gt;vm();</span>
<span class="udiff-line-modified-added">+     JSC::VM&amp; vm = lexicalGlobalObject-&gt;vm();</span>
      String dataURL;
      JSC::JSValue target;
  
      if (arguments-&gt;argumentCount()) {
          auto possibleTarget = arguments-&gt;argumentAt(0);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -385,11 +397,11 @@</span>
              }
  
              // FIXME: &lt;https://webkit.org/b/180833&gt; Web Inspector: support OffscreenCanvas for Canvas related operations
          } else {
              String base64;
<span class="udiff-line-modified-removed">-             if (possibleTarget.getString(state, base64) &amp;&amp; base64.startsWithIgnoringASCIICase(&quot;data:&quot;_s) &amp;&amp; base64.length() &gt; 5) {</span>
<span class="udiff-line-modified-added">+             if (possibleTarget.getString(lexicalGlobalObject, base64) &amp;&amp; base64.startsWithIgnoringASCIICase(&quot;data:&quot;_s) &amp;&amp; base64.length() &gt; 5) {</span>
                  target = possibleTarget;
                  dataURL = base64;
              }
          }
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -410,10 +422,10 @@</span>
  
      Vector&lt;JSC::Strong&lt;JSC::Unknown&gt;&gt; adjustedArguments;
      adjustedArguments.append({ vm, target ? target : JSC::jsNontrivialString(vm, &quot;Viewport&quot;_s) });
      for (size_t i = (!target ? 0 : 1); i &lt; arguments-&gt;argumentCount(); ++i)
          adjustedArguments.append({ vm, arguments-&gt;argumentAt(i) });
<span class="udiff-line-modified-removed">-     arguments = ScriptArguments::create(*state, WTFMove(adjustedArguments));</span>
<span class="udiff-line-modified-added">+     arguments = ScriptArguments::create(lexicalGlobalObject, WTFMove(adjustedArguments));</span>
      addMessage(makeUnique&lt;Inspector::ConsoleMessage&gt;(MessageSource::ConsoleAPI, MessageType::Image, MessageLevel::Log, dataURL, WTFMove(arguments)));
  }
  
  } // namespace WebCore
</pre>
<center><a href="PageConfiguration.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PageConsoleClient.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>