<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/html/HTMLVideoElement.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HTMLTrackElement.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="HTMLVideoElement.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/html/HTMLVideoElement.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -37,10 +37,11 @@</span>
  #include &quot;HTMLImageLoader.h&quot;
  #include &quot;HTMLNames.h&quot;
  #include &quot;HTMLParserIdioms.h&quot;
  #include &quot;Logging.h&quot;
  #include &quot;Page.h&quot;
<span class="udiff-line-added">+ #include &quot;PictureInPictureSupport.h&quot;</span>
  #include &quot;RenderImage.h&quot;
  #include &quot;RenderVideo.h&quot;
  #include &quot;ScriptController.h&quot;
  #include &quot;Settings.h&quot;
  #include &lt;wtf/IsoMallocInlines.h&gt;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -48,10 +49,15 @@</span>
  
  #if ENABLE(VIDEO_PRESENTATION_MODE)
  #include &quot;VideoFullscreenModel.h&quot;
  #endif
  
<span class="udiff-line-added">+ #if ENABLE(PICTURE_IN_PICTURE_API)</span>
<span class="udiff-line-added">+ #include &quot;HTMLVideoElementPictureInPicture.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;PictureInPictureObserver.h&quot;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  namespace WebCore {
  
  WTF_MAKE_ISO_ALLOCATED_IMPL(HTMLVideoElement);
  
  using namespace HTMLNames;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -65,10 +71,15 @@</span>
  }
  
  Ref&lt;HTMLVideoElement&gt; HTMLVideoElement::create(const QualifiedName&amp; tagName, Document&amp; document, bool createdByParser)
  {
      auto videoElement = adoptRef(*new HTMLVideoElement(tagName, document, createdByParser));
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(PICTURE_IN_PICTURE_API)</span>
<span class="udiff-line-added">+     HTMLVideoElementPictureInPicture::providePictureInPictureTo(videoElement);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
      videoElement-&gt;finishInitialization();
      videoElement-&gt;suspendIfNeeded();
      return videoElement;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -257,20 +268,10 @@</span>
      } else if (oldMode != Video &amp;&amp; player())
          player()-&gt;prepareForRendering();
  
      HTMLMediaElement::setDisplayMode(mode);
  
<span class="udiff-line-removed">-     if (player() &amp;&amp; player()-&gt;canLoadPoster()) {</span>
<span class="udiff-line-removed">-         bool canLoad = true;</span>
<span class="udiff-line-removed">-         if (!poster.isEmpty()) {</span>
<span class="udiff-line-removed">-             if (RefPtr&lt;Frame&gt; frame = document().frame())</span>
<span class="udiff-line-removed">-                 canLoad = frame-&gt;loader().willLoadMediaElementURL(poster, *this);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (canLoad)</span>
<span class="udiff-line-removed">-             player()-&gt;setPoster(poster);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      if (auto* renderer = this-&gt;renderer()) {
          if (displayMode() != oldMode)
              renderer-&gt;updateFromElement();
      }
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -291,11 +292,11 @@</span>
  
      player-&gt;setVisible(true); // Make player visible or it won&#39;t draw.
      player-&gt;paintCurrentFrameInContext(context, destRect);
  }
  
<span class="udiff-line-modified-removed">- bool HTMLVideoElement::copyVideoTextureToPlatformTexture(GraphicsContext3D* context, Platform3DObject texture, GC3Denum target, GC3Dint level, GC3Denum internalFormat, GC3Denum format, GC3Denum type, bool premultiplyAlpha, bool flipY)</span>
<span class="udiff-line-modified-added">+ bool HTMLVideoElement::copyVideoTextureToPlatformTexture(GraphicsContextGLOpenGL* context, PlatformGLObject texture, GCGLenum target, GCGLint level, GCGLenum internalFormat, GCGLenum format, GCGLenum type, bool premultiplyAlpha, bool flipY)</span>
  {
      if (!player())
          return false;
      return player()-&gt;copyVideoTextureToPlatformTexture(context, texture, target, level, internalFormat, format, type, premultiplyAlpha, flipY);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -411,14 +412,12 @@</span>
  {
      if (mode == VideoPresentationMode::Fullscreen)
          return supportsFullscreen(HTMLMediaElementEnums::VideoFullscreenModeStandard);
  
      if (mode == VideoPresentationMode::PictureInPicture) {
<span class="udiff-line-removed">- #if PLATFORM(COCOA)</span>
          if (!supportsPictureInPicture())
              return false;
<span class="udiff-line-removed">- #endif</span>
  
          return supportsFullscreen(HTMLMediaElementEnums::VideoFullscreenModePictureInPicture);
      }
  
      if (mode == VideoPresentationMode::Inline)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -441,18 +440,37 @@</span>
      return HTMLMediaElementEnums::VideoFullscreenModeNone;
  }
  
  void HTMLVideoElement::webkitSetPresentationMode(VideoPresentationMode mode)
  {
<span class="udiff-line-modified-removed">-     ALWAYS_LOG(LOGIDENTIFIER, mode);</span>
<span class="udiff-line-modified-added">+     INFO_LOG(LOGIDENTIFIER, &quot;, mode = &quot;,  mode);</span>
      setFullscreenMode(toFullscreenMode(mode));
  }
  
  void HTMLVideoElement::setFullscreenMode(HTMLMediaElementEnums::VideoFullscreenMode mode)
  {
<span class="udiff-line-modified-removed">-     if (mode == VideoFullscreenModeNone &amp;&amp; isFullscreen()) {</span>
<span class="udiff-line-modified-removed">-         exitFullscreen();</span>
<span class="udiff-line-modified-added">+     INFO_LOG(LOGIDENTIFIER, &quot;, mode = &quot;, mode);</span>
<span class="udiff-line-modified-added">+ #if ENABLE(PICTURE_IN_PICTURE_API)</span>
<span class="udiff-line-added">+     if (m_pictureInPictureAPITestEnabled) {</span>
<span class="udiff-line-added">+         if (mode == VideoFullscreenModePictureInPicture) {</span>
<span class="udiff-line-added">+             fullscreenModeChanged(mode);</span>
<span class="udiff-line-added">+             didBecomeFullscreenElement();</span>
<span class="udiff-line-added">+             setVideoFullscreenFrame({0, 0, 100, 100});</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (mode == VideoFullscreenModeNone) {</span>
<span class="udiff-line-added">+             fullscreenModeChanged(mode);</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (mode == VideoFullscreenModeNone) {</span>
<span class="udiff-line-added">+         if (isFullscreen())</span>
<span class="udiff-line-added">+             exitFullscreen();</span>
<span class="udiff-line-added">+ </span>
          return;
      }
  
      if (!mediaSession().fullscreenPermitted() || !supportsFullscreen(mode))
          return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -481,20 +499,79 @@</span>
  }
  
  void HTMLVideoElement::fullscreenModeChanged(VideoFullscreenMode mode)
  {
      if (mode != fullscreenMode()) {
<span class="udiff-line-modified-removed">-         ALWAYS_LOG(LOGIDENTIFIER, &quot;changed from &quot;, fullscreenMode(), &quot;, to &quot;, mode);</span>
<span class="udiff-line-modified-added">+         INFO_LOG(LOGIDENTIFIER, &quot;changed from &quot;, fullscreenMode(), &quot;, to &quot;, mode);</span>
          scheduleEvent(eventNames().webkitpresentationmodechangedEvent);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(PICTURE_IN_PICTURE_API)</span>
<span class="udiff-line-added">+         if (m_pictureInPictureObserver) {</span>
<span class="udiff-line-added">+             HTMLVideoElement::VideoPresentationMode targetVideoPresentationMode = toPresentationMode(mode);</span>
<span class="udiff-line-added">+             HTMLVideoElement::VideoPresentationMode sourceVideoPresentationMode = toPresentationMode(fullscreenMode());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (targetVideoPresentationMode != HTMLVideoElement::VideoPresentationMode::PictureInPicture &amp;&amp; sourceVideoPresentationMode == HTMLVideoElement::VideoPresentationMode::PictureInPicture) {</span>
<span class="udiff-line-added">+                 m_pictureInPictureObserver-&gt;didExitPictureInPicture();</span>
<span class="udiff-line-added">+                 m_isFullscreen = false;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ #endif</span>
      }
  
      if (player())
          player()-&gt;setVideoFullscreenMode(mode);
  
      HTMLMediaElement::fullscreenModeChanged(mode);
  }
  
<span class="udiff-line-added">+ #if ENABLE(PICTURE_IN_PICTURE_API)</span>
<span class="udiff-line-added">+ void HTMLVideoElement::didBecomeFullscreenElement()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_isFullscreen = true;</span>
<span class="udiff-line-added">+     m_waitingForPictureInPictureWindowFrame = true;</span>
<span class="udiff-line-added">+     HTMLMediaElement::didBecomeFullscreenElement();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void HTMLVideoElement::setPictureInPictureObserver(PictureInPictureObserver* observer)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_pictureInPictureObserver = observer;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void HTMLVideoElement::setPictureInPictureAPITestEnabled(bool enabled)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_pictureInPictureAPITestEnabled = enabled;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if PLATFORM(IOS_FAMILY) || (PLATFORM(MAC) &amp;&amp; ENABLE(VIDEO_PRESENTATION_MODE))</span>
<span class="udiff-line-added">+ void HTMLVideoElement::setVideoFullscreenFrame(FloatRect frame)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     HTMLMediaElement::setVideoFullscreenFrame(frame);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(PICTURE_IN_PICTURE_API)</span>
<span class="udiff-line-added">+     // fullscreenMode() does not always provide the correct fullscreen mode</span>
<span class="udiff-line-added">+     // when mode changing is happening (webkit.org/b/203443)</span>
<span class="udiff-line-added">+     if (!m_isFullscreen)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (toPresentationMode(fullscreenMode()) != VideoPresentationMode::PictureInPicture)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (m_waitingForPictureInPictureWindowFrame) {</span>
<span class="udiff-line-added">+         m_waitingForPictureInPictureWindowFrame = false;</span>
<span class="udiff-line-added">+         if (m_pictureInPictureObserver)</span>
<span class="udiff-line-added">+             m_pictureInPictureObserver-&gt;didEnterPictureInPicture(IntSize(frame.size()));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (m_pictureInPictureObserver)</span>
<span class="udiff-line-added">+         m_pictureInPictureObserver-&gt;pictureInPictureWindowResized(IntSize(frame.size()));</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ }</span>
  #endif
  
  #if PLATFORM(MAC) &amp;&amp; ENABLE(VIDEO_PRESENTATION_MODE)
  void HTMLVideoElement::exitToFullscreenModeWithoutAnimationIfPossible(HTMLMediaElementEnums::VideoFullscreenMode fromMode, HTMLMediaElementEnums::VideoFullscreenMode toMode)
  {
</pre>
<center><a href="HTMLTrackElement.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="HTMLVideoElement.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>