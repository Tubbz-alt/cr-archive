<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/workers/service/ServiceWorkerGlobalScope.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ServiceWorkerFetchResult.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="ServiceWorkerGlobalScope.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/workers/service/ServiceWorkerGlobalScope.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -27,10 +27,11 @@</span>
  #include &quot;ServiceWorkerGlobalScope.h&quot;
  
  #if ENABLE(SERVICE_WORKER)
  
  #include &quot;ExtendableEvent.h&quot;
<span class="udiff-line-added">+ #include &quot;JSDOMPromiseDeferred.h&quot;</span>
  #include &quot;SWContextManager.h&quot;
  #include &quot;ServiceWorkerClient.h&quot;
  #include &quot;ServiceWorkerClients.h&quot;
  #include &quot;ServiceWorkerContainer.h&quot;
  #include &quot;ServiceWorkerThread.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -40,19 +41,19 @@</span>
  
  namespace WebCore {
  
  WTF_MAKE_ISO_ALLOCATED_IMPL(ServiceWorkerGlobalScope);
  
<span class="udiff-line-modified-removed">- Ref&lt;ServiceWorkerGlobalScope&gt; ServiceWorkerGlobalScope::create(const ServiceWorkerContextData&amp; data, const URL&amp; url, Ref&lt;SecurityOrigin&gt;&amp;&amp; origin, const String&amp; identifier, const String&amp; userAgent, bool isOnline, ServiceWorkerThread&amp; thread, const ContentSecurityPolicyResponseHeaders&amp; contentSecurityPolicy, bool shouldBypassMainWorldContentSecurityPolicy, Ref&lt;SecurityOrigin&gt;&amp;&amp; topOrigin, MonotonicTime timeOrigin, IDBClient::IDBConnectionProxy* connectionProxy, SocketProvider* socketProvider, PAL::SessionID sessionID)</span>
<span class="udiff-line-modified-added">+ Ref&lt;ServiceWorkerGlobalScope&gt; ServiceWorkerGlobalScope::create(const ServiceWorkerContextData&amp; data, const WorkerParameters&amp; params, Ref&lt;SecurityOrigin&gt;&amp;&amp; origin, ServiceWorkerThread&amp; thread, Ref&lt;SecurityOrigin&gt;&amp;&amp; topOrigin, IDBClient::IDBConnectionProxy* connectionProxy, SocketProvider* socketProvider)</span>
  {
<span class="udiff-line-modified-removed">-     auto scope = adoptRef(*new ServiceWorkerGlobalScope { data, url, WTFMove(origin), identifier, userAgent, isOnline, thread, shouldBypassMainWorldContentSecurityPolicy, WTFMove(topOrigin), timeOrigin, connectionProxy, socketProvider, sessionID });</span>
<span class="udiff-line-modified-removed">-     scope-&gt;applyContentSecurityPolicyResponseHeaders(contentSecurityPolicy);</span>
<span class="udiff-line-modified-added">+     auto scope = adoptRef(*new ServiceWorkerGlobalScope { data, params, WTFMove(origin), thread, WTFMove(topOrigin), connectionProxy, socketProvider });</span>
<span class="udiff-line-modified-added">+     scope-&gt;applyContentSecurityPolicyResponseHeaders(params.contentSecurityPolicyResponseHeaders);</span>
      return scope;
  }
  
<span class="udiff-line-modified-removed">- ServiceWorkerGlobalScope::ServiceWorkerGlobalScope(const ServiceWorkerContextData&amp; data, const URL&amp; url, Ref&lt;SecurityOrigin&gt;&amp;&amp; origin, const String&amp; identifier, const String&amp; userAgent, bool isOnline, ServiceWorkerThread&amp; thread, bool shouldBypassMainWorldContentSecurityPolicy, Ref&lt;SecurityOrigin&gt;&amp;&amp; topOrigin, MonotonicTime timeOrigin, IDBClient::IDBConnectionProxy* connectionProxy, SocketProvider* socketProvider, PAL::SessionID sessionID)</span>
<span class="udiff-line-modified-removed">-     : WorkerGlobalScope(url, WTFMove(origin), identifier, userAgent, isOnline, thread, shouldBypassMainWorldContentSecurityPolicy, WTFMove(topOrigin), timeOrigin, connectionProxy, socketProvider, sessionID)</span>
<span class="udiff-line-modified-added">+ ServiceWorkerGlobalScope::ServiceWorkerGlobalScope(const ServiceWorkerContextData&amp; data, const WorkerParameters&amp; params, Ref&lt;SecurityOrigin&gt;&amp;&amp; origin, ServiceWorkerThread&amp; thread, Ref&lt;SecurityOrigin&gt;&amp;&amp; topOrigin, IDBClient::IDBConnectionProxy* connectionProxy, SocketProvider* socketProvider)</span>
<span class="udiff-line-modified-added">+     : WorkerGlobalScope(params, WTFMove(origin), thread, WTFMove(topOrigin), connectionProxy, socketProvider)</span>
      , m_contextData(crossThreadCopy(data))
      , m_registration(ServiceWorkerRegistration::getOrCreate(*this, navigator().serviceWorker(), WTFMove(m_contextData.registration)))
      , m_clients(ServiceWorkerClients::create())
  {
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -68,12 +69,14 @@</span>
          if (auto* connection = SWContextManager::singleton().connection()) {
              auto identifier = workerThread-&gt;identifier();
              connection-&gt;skipWaiting(identifier, [workerThread = WTFMove(workerThread), requestIdentifier] {
                  workerThread-&gt;runLoop().postTask([requestIdentifier](auto&amp; context) {
                      auto&amp; scope = downcast&lt;ServiceWorkerGlobalScope&gt;(context);
<span class="udiff-line-modified-removed">-                     if (auto promise = scope.m_pendingSkipWaitingPromises.take(requestIdentifier))</span>
<span class="udiff-line-modified-removed">-                         promise-&gt;resolve();</span>
<span class="udiff-line-modified-added">+                     scope.eventLoop().queueTask(TaskSource::DOMManipulation, [scope = makeRef(scope), requestIdentifier]() mutable {</span>
<span class="udiff-line-modified-added">+                         if (auto promise = scope-&gt;m_pendingSkipWaitingPromises.take(requestIdentifier))</span>
<span class="udiff-line-added">+                             promise-&gt;resolve();</span>
<span class="udiff-line-added">+                     });</span>
                  });
              });
          }
      });
  }
</pre>
<center><a href="ServiceWorkerFetchResult.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="ServiceWorkerGlobalScope.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>