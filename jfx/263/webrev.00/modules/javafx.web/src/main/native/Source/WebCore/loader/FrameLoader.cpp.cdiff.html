<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/loader/FrameLoader.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="FrameLoadRequest.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FrameLoader.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/FrameLoader.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 35,10 ***</span>
<span class="line-new-header">--- 35,11 ---</span>
  #include &quot;config.h&quot;
  #include &quot;FrameLoader.h&quot;
  
  #include &quot;AXObjectCache.h&quot;
  #include &quot;ApplicationCacheHost.h&quot;
<span class="line-added">+ #include &quot;BackForwardCache.h&quot;</span>
  #include &quot;BackForwardController.h&quot;
  #include &quot;BeforeUnloadEvent.h&quot;
  #include &quot;CachedPage.h&quot;
  #include &quot;CachedResourceLoader.h&quot;
  #include &quot;Chrome.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 74,10 ***</span>
<span class="line-new-header">--- 75,11 ---</span>
  #include &quot;HTMLInputElement.h&quot;
  #include &quot;HTMLNames.h&quot;
  #include &quot;HTMLObjectElement.h&quot;
  #include &quot;HTMLParserIdioms.h&quot;
  #include &quot;HTTPHeaderNames.h&quot;
<span class="line-added">+ #include &quot;HTTPHeaderValues.h&quot;</span>
  #include &quot;HTTPParsers.h&quot;
  #include &quot;HistoryController.h&quot;
  #include &quot;HistoryItem.h&quot;
  #include &quot;IgnoreOpensDuringUnloadCountIncrementer.h&quot;
  #include &quot;InspectorController.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 90,11 ***</span>
  #include &quot;MemoryRelease.h&quot;
  #include &quot;NavigationDisabler.h&quot;
  #include &quot;NavigationScheduler.h&quot;
  #include &quot;Node.h&quot;
  #include &quot;Page.h&quot;
<span class="line-removed">- #include &quot;PageCache.h&quot;</span>
  #include &quot;PageTransitionEvent.h&quot;
  #include &quot;PerformanceLogging.h&quot;
  #include &quot;PlatformStrategies.h&quot;
  #include &quot;PluginData.h&quot;
  #include &quot;PluginDocument.h&quot;
<span class="line-new-header">--- 92,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 148,11 ***</span>
  #include &quot;DocumentType.h&quot;
  #include &quot;ResourceLoader.h&quot;
  #include &quot;RuntimeApplicationChecks.h&quot;
  #endif
  
<span class="line-modified">! #define RELEASE_LOG_IF_ALLOWED(fmt, ...) RELEASE_LOG_IF(isAlwaysOnLoggingAllowed(), Network, &quot;%p - FrameLoader::&quot; fmt, this, ##__VA_ARGS__)</span>
  
  namespace WebCore {
  
  using namespace HTMLNames;
  using namespace SVGNames;
<span class="line-new-header">--- 149,14 ---</span>
  #include &quot;DocumentType.h&quot;
  #include &quot;ResourceLoader.h&quot;
  #include &quot;RuntimeApplicationChecks.h&quot;
  #endif
  
<span class="line-modified">! #define FRAMELOADER_RELEASE_LOG(channel, fmt, ...) RELEASE_LOG(channel, &quot;%p - [frame=%p, main=%d] FrameLoader::&quot; fmt, this, &amp;m_frame, m_frame.isMainFrame(), ##__VA_ARGS__)</span>
<span class="line-added">+ #define FRAMELOADER_RELEASE_LOG_ERROR(channel, fmt, ...) RELEASE_LOG(channel, &quot;%p - [frame=%p, main=%d] FrameLoader::&quot; fmt, this, &amp;m_frame, m_frame.isMainFrame(), ##__VA_ARGS__)</span>
<span class="line-added">+ #define FRAMELOADER_RELEASE_LOG_IF_ALLOWED(channel, fmt, ...) RELEASE_LOG_IF(isAlwaysOnLoggingAllowed(), channel, &quot;%p - [frame=%p, main=%d] FrameLoader::&quot; fmt, this, &amp;m_frame, m_frame.isMainFrame(), ##__VA_ARGS__)</span>
<span class="line-added">+ #define FRAMELOADER_RELEASE_LOG_ERROR_IF_ALLOWED(channel, fmt, ...) RELEASE_LOG_IF(isAlwaysOnLoggingAllowed(), channel, &quot;%p - [frame=%p, main=%d] FrameLoader::&quot; fmt, this, &amp;m_frame, m_frame.isMainFrame(), ##__VA_ARGS__)</span>
  
  namespace WebCore {
  
  using namespace HTMLNames;
  using namespace SVGNames;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 208,26 ***</span>
  static bool isDocumentSandboxed(Frame&amp; frame, SandboxFlags mask)
  {
      return frame.document() &amp;&amp; frame.document()-&gt;isSandboxed(mask);
  }
  
<span class="line-modified">! struct ForbidPromptsScope {</span>
<span class="line-modified">!     ForbidPromptsScope(Page* page) : m_page(page)</span>
      {
<span class="line-modified">!         if (!m_page)</span>
<span class="line-modified">!             return;</span>
<span class="line-modified">!         m_page-&gt;forbidPrompts();</span>
      }
  
      ~ForbidPromptsScope()
      {
<span class="line-modified">!         if (!m_page)</span>
<span class="line-modified">!             return;</span>
<span class="line-removed">-         m_page-&gt;allowPrompts();</span>
      }
  
<span class="line-modified">!     Page* m_page;</span>
  };
  
  class FrameLoader::FrameProgressTracker {
      WTF_MAKE_FAST_ALLOCATED;
  public:
<span class="line-new-header">--- 212,50 ---</span>
  static bool isDocumentSandboxed(Frame&amp; frame, SandboxFlags mask)
  {
      return frame.document() &amp;&amp; frame.document()-&gt;isSandboxed(mask);
  }
  
<span class="line-modified">! class PageLevelForbidScope {</span>
<span class="line-modified">! protected:</span>
<span class="line-added">+     explicit PageLevelForbidScope(Page* page)</span>
<span class="line-added">+         : m_page(makeWeakPtr(page))</span>
      {
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     ~PageLevelForbidScope() = default;</span>
<span class="line-added">+ </span>
<span class="line-added">+     WeakPtr&lt;Page&gt; m_page;</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
<span class="line-added">+ struct ForbidPromptsScope : public PageLevelForbidScope {</span>
<span class="line-added">+     explicit ForbidPromptsScope(Page* page)</span>
<span class="line-added">+         : PageLevelForbidScope(page)</span>
<span class="line-added">+     {</span>
<span class="line-added">+         if (m_page)</span>
<span class="line-added">+             m_page-&gt;forbidPrompts();</span>
      }
  
      ~ForbidPromptsScope()
      {
<span class="line-modified">!         if (m_page)</span>
<span class="line-modified">!             m_page-&gt;allowPrompts();</span>
      }
<span class="line-added">+ };</span>
  
<span class="line-modified">! struct ForbidSynchronousLoadsScope : public PageLevelForbidScope {</span>
<span class="line-added">+     explicit ForbidSynchronousLoadsScope(Page* page)</span>
<span class="line-added">+         : PageLevelForbidScope(page)</span>
<span class="line-added">+     {</span>
<span class="line-added">+         if (m_page)</span>
<span class="line-added">+             m_page-&gt;forbidSynchronousLoads();</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     ~ForbidSynchronousLoadsScope()</span>
<span class="line-added">+     {</span>
<span class="line-added">+         if (m_page)</span>
<span class="line-added">+             m_page-&gt;allowSynchronousLoads();</span>
<span class="line-added">+     }</span>
  };
  
  class FrameLoader::FrameProgressTracker {
      WTF_MAKE_FAST_ALLOCATED;
  public:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 255,13 ***</span>
      {
          ASSERT(m_inProgress);
          ASSERT(m_frame.page());
          m_inProgress = false;
          m_frame.page()-&gt;progress().progressCompleted(m_frame);
<span class="line-modified">! </span>
<span class="line-removed">-         if (auto pageID = m_frame.loader().client().pageID())</span>
<span class="line-removed">-             platformStrategies()-&gt;loaderStrategy()-&gt;pageLoadCompleted(pageID.value());</span>
      }
  
  private:
      Frame&amp; m_frame;
      bool m_inProgress;
<span class="line-new-header">--- 283,11 ---</span>
      {
          ASSERT(m_inProgress);
          ASSERT(m_frame.page());
          m_inProgress = false;
          m_frame.page()-&gt;progress().progressCompleted(m_frame);
<span class="line-modified">!         platformStrategies()-&gt;loaderStrategy()-&gt;pageLoadCompleted(*m_frame.page());</span>
      }
  
  private:
      Frame&amp; m_frame;
      bool m_inProgress;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 297,20 ***</span>
  }
  
  FrameLoader::~FrameLoader()
  {
      setOpener(nullptr);
<span class="line-modified">! </span>
<span class="line-removed">-     for (auto&amp; frame : m_openedFrames)</span>
<span class="line-removed">-         frame-&gt;loader().m_opener = nullptr;</span>
  
      m_client.frameLoaderDestroyed();
  
      if (m_networkingContext)
          m_networkingContext-&gt;invalidate();
  }
  
  void FrameLoader::init()
  {
      // This somewhat odd set of steps gives the frame an initial empty document.
      setPolicyDocumentLoader(m_client.createDocumentLoader(ResourceRequest(URL({ }, emptyString())), SubstituteData()).ptr());
      setProvisionalDocumentLoader(m_policyDocumentLoader.get());
<span class="line-new-header">--- 323,25 ---</span>
  }
  
  FrameLoader::~FrameLoader()
  {
      setOpener(nullptr);
<span class="line-modified">!     detachFromAllOpenedFrames();</span>
  
      m_client.frameLoaderDestroyed();
  
      if (m_networkingContext)
          m_networkingContext-&gt;invalidate();
  }
  
<span class="line-added">+ void FrameLoader::detachFromAllOpenedFrames()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     for (auto&amp; frame : m_openedFrames)</span>
<span class="line-added">+         frame-&gt;loader().m_opener = nullptr;</span>
<span class="line-added">+     m_openedFrames.clear();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void FrameLoader::init()
  {
      // This somewhat odd set of steps gives the frame an initial empty document.
      setPolicyDocumentLoader(m_client.createDocumentLoader(ResourceRequest(URL({ }, emptyString())), SubstituteData()).ptr());
      setProvisionalDocumentLoader(m_policyDocumentLoader.get());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 391,16 ***</span>
      urlSelected(FrameLoadRequest(*m_frame.document(), m_frame.document()-&gt;securityOrigin(), { url }, passedTarget, lockHistory, lockBackForwardList, shouldSendReferrer, AllowNavigationToInvalidURL::Yes, newFrameOpenerPolicy, shouldOpenExternalURLsPolicy, initiatedByMainFrame, DoNotReplaceDocumentIfJavaScriptURL, downloadAttribute, systemPreviewInfo), triggeringEvent, WTFMove(adClickAttribution));
  }
  
  void FrameLoader::urlSelected(FrameLoadRequest&amp;&amp; frameRequest, Event* triggeringEvent, Optional&lt;AdClickAttribution&gt;&amp;&amp; adClickAttribution)
  {
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;urlSelected: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      Ref&lt;Frame&gt; protect(m_frame);
  
<span class="line-modified">!     if (m_frame.script().executeIfJavaScriptURL(frameRequest.resourceRequest().url(), frameRequest.shouldReplaceDocumentIfJavaScriptURL()))</span>
          return;
  
      if (frameRequest.frameName().isEmpty())
          frameRequest.setFrameName(m_frame.document()-&gt;baseTarget());
  
      addHTTPOriginIfNeeded(frameRequest.resourceRequest(), outgoingOrigin());
<span class="line-new-header">--- 422,18 ---</span>
      urlSelected(FrameLoadRequest(*m_frame.document(), m_frame.document()-&gt;securityOrigin(), { url }, passedTarget, lockHistory, lockBackForwardList, shouldSendReferrer, AllowNavigationToInvalidURL::Yes, newFrameOpenerPolicy, shouldOpenExternalURLsPolicy, initiatedByMainFrame, DoNotReplaceDocumentIfJavaScriptURL, downloadAttribute, systemPreviewInfo), triggeringEvent, WTFMove(adClickAttribution));
  }
  
  void FrameLoader::urlSelected(FrameLoadRequest&amp;&amp; frameRequest, Event* triggeringEvent, Optional&lt;AdClickAttribution&gt;&amp;&amp; adClickAttribution)
  {
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;urlSelected: frame load started&quot;);</span>
  
      Ref&lt;Frame&gt; protect(m_frame);
  
<span class="line-modified">!     if (m_frame.script().executeIfJavaScriptURL(frameRequest.resourceRequest().url(), &amp;frameRequest.requester().securityOrigin(), frameRequest.shouldReplaceDocumentIfJavaScriptURL())) {</span>
<span class="line-added">+         m_quickRedirectComing = false;</span>
          return;
<span class="line-added">+     }</span>
  
      if (frameRequest.frameName().isEmpty())
          frameRequest.setFrameName(m_frame.document()-&gt;baseTarget());
  
      addHTTPOriginIfNeeded(frameRequest.resourceRequest(), outgoingOrigin());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 431,11 ***</span>
      if (WTF::protocolIsJavaScript(submission-&gt;action())) {
          if (!m_frame.document()-&gt;contentSecurityPolicy()-&gt;allowFormAction(URL(submission-&gt;action())))
              return;
          m_isExecutingJavaScriptFormAction = true;
          Ref&lt;Frame&gt; protect(m_frame);
<span class="line-modified">!         m_frame.script().executeIfJavaScriptURL(submission-&gt;action(), DoNotReplaceDocumentIfJavaScriptURL);</span>
          m_isExecutingJavaScriptFormAction = false;
          return;
      }
  
      Frame* targetFrame = findFrameForNavigation(submission-&gt;target(), &amp;submission-&gt;state().sourceDocument());
<span class="line-new-header">--- 464,11 ---</span>
      if (WTF::protocolIsJavaScript(submission-&gt;action())) {
          if (!m_frame.document()-&gt;contentSecurityPolicy()-&gt;allowFormAction(URL(submission-&gt;action())))
              return;
          m_isExecutingJavaScriptFormAction = true;
          Ref&lt;Frame&gt; protect(m_frame);
<span class="line-modified">!         m_frame.script().executeIfJavaScriptURL(submission-&gt;action(), nullptr, DoNotReplaceDocumentIfJavaScriptURL);</span>
          m_isExecutingJavaScriptFormAction = false;
          return;
      }
  
      Frame* targetFrame = findFrameForNavigation(submission-&gt;target(), &amp;submission-&gt;state().sourceDocument());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 454,27 ***</span>
          submission-&gt;clearTarget();
  
      if (!targetFrame-&gt;page())
          return;
  
<span class="line-modified">!     // FIXME: We&#39;d like to remove this altogether and fix the multiple form submission issue another way.</span>
<span class="line-removed">- </span>
<span class="line-removed">-     // We do not want to submit more than one form from the same page, nor do we want to submit a single</span>
<span class="line-removed">-     // form more than once. This flag prevents these from happening; not sure how other browsers prevent this.</span>
<span class="line-removed">-     // The flag is reset in each time we start dispatching a new mouse or key down event, and</span>
<span class="line-removed">-     // also in setView since this part may get reused for a page from the back/forward cache.</span>
<span class="line-removed">-     // The form multi-submit logic here is only needed when we are submitting a form that affects this frame.</span>
<span class="line-removed">- </span>
<span class="line-removed">-     // FIXME: Frame targeting is only one of the ways the submission could end up doing something other</span>
<span class="line-removed">-     // than replacing this frame&#39;s content, so this check is flawed. On the other hand, the check is hardly</span>
<span class="line-removed">-     // needed any more now that we reset m_submittedFormURL on each mouse or key down event.</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (m_frame.tree().isDescendantOf(targetFrame)) {</span>
<span class="line-removed">-         if (m_submittedFormURL == submission-&gt;requestURL())</span>
<span class="line-removed">-             return;</span>
          m_submittedFormURL = submission-&gt;requestURL();
<span class="line-removed">-     }</span>
  
      submission-&gt;setReferrer(outgoingReferrer());
      submission-&gt;setOrigin(outgoingOrigin());
  
      targetFrame-&gt;navigationScheduler().scheduleFormSubmission(WTFMove(submission));
<span class="line-new-header">--- 487,12 ---</span>
          submission-&gt;clearTarget();
  
      if (!targetFrame-&gt;page())
          return;
  
<span class="line-modified">!     if (m_frame.tree().isDescendantOf(targetFrame))</span>
          m_submittedFormURL = submission-&gt;requestURL();
  
      submission-&gt;setReferrer(outgoingReferrer());
      submission-&gt;setOrigin(outgoingOrigin());
  
      targetFrame-&gt;navigationScheduler().scheduleFormSubmission(WTFMove(submission));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 541,12 ***</span>
      UnloadEventPolicy unloadEventPolicy;
      if (m_frame.page() &amp;&amp; m_frame.page()-&gt;chrome().client().isSVGImageChromeClient()) {
          // If this is the SVGDocument of an SVGImage, no need to dispatch events or recalcStyle.
          unloadEventPolicy = UnloadEventPolicyNone;
      } else {
<span class="line-modified">!         // Should only send the pagehide event here if the current document exists and has not been placed in the page cache.</span>
<span class="line-modified">!         unloadEventPolicy = currentDocument &amp;&amp; currentDocument-&gt;pageCacheState() == Document::NotInPageCache ? UnloadEventPolicyUnloadAndPageHide : UnloadEventPolicyUnloadOnly;</span>
      }
  
      stopLoading(unloadEventPolicy);
  
      m_frame.editor().clearUndoRedoOperations();
<span class="line-new-header">--- 559,12 ---</span>
      UnloadEventPolicy unloadEventPolicy;
      if (m_frame.page() &amp;&amp; m_frame.page()-&gt;chrome().client().isSVGImageChromeClient()) {
          // If this is the SVGDocument of an SVGImage, no need to dispatch events or recalcStyle.
          unloadEventPolicy = UnloadEventPolicyNone;
      } else {
<span class="line-modified">!         // Should only send the pagehide event here if the current document exists and has not been placed in the back/forward cache.</span>
<span class="line-modified">!         unloadEventPolicy = currentDocument &amp;&amp; currentDocument-&gt;backForwardCacheState() == Document::NotInBackForwardCache ? UnloadEventPolicyUnloadAndPageHide : UnloadEventPolicyUnloadOnly;</span>
      }
  
      stopLoading(unloadEventPolicy);
  
      m_frame.editor().clearUndoRedoOperations();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 588,11 ***</span>
  
      // Calling document.open counts as committing the first real document load.
      if (!m_stateMachine.committedFirstRealDocumentLoad())
          m_stateMachine.advanceTo(FrameLoaderStateMachine::DisplayingInitialEmptyDocumentPostCommit);
  
<span class="line-modified">!     m_client.dispatchDidExplicitOpen(m_frame.document() ? m_frame.document()-&gt;url() : URL());</span>
  
      // Prevent window.open(url) -- eg window.open(&quot;about:blank&quot;) -- from blowing away results
      // from a subsequent window.document.open / window.document.write call.
      // Canceling redirection here works for all cases because document.open
      // implicitly precedes document.write.
<span class="line-new-header">--- 606,12 ---</span>
  
      // Calling document.open counts as committing the first real document load.
      if (!m_stateMachine.committedFirstRealDocumentLoad())
          m_stateMachine.advanceTo(FrameLoaderStateMachine::DisplayingInitialEmptyDocumentPostCommit);
  
<span class="line-modified">!     if (auto* document = m_frame.document())</span>
<span class="line-added">+         m_client.dispatchDidExplicitOpen(document-&gt;url(), document-&gt;contentType());</span>
  
      // Prevent window.open(url) -- eg window.open(&quot;about:blank&quot;) -- from blowing away results
      // from a subsequent window.document.open / window.document.write call.
      // Canceling redirection here works for all cases because document.open
      // implicitly precedes document.write.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 627,11 ***</span>
      m_frame.editor().clear();
  
      bool neededClear = m_needsClear;
      m_needsClear = false;
  
<span class="line-modified">!     if (neededClear &amp;&amp; m_frame.document()-&gt;pageCacheState() != Document::InPageCache) {</span>
          m_frame.document()-&gt;cancelParsing();
          m_frame.document()-&gt;stopActiveDOMObjects();
          bool hadLivingRenderTree = m_frame.document()-&gt;hasLivingRenderTree();
          m_frame.document()-&gt;prepareForDestruction();
          if (hadLivingRenderTree)
<span class="line-new-header">--- 646,11 ---</span>
      m_frame.editor().clear();
  
      bool neededClear = m_needsClear;
      m_needsClear = false;
  
<span class="line-modified">!     if (neededClear &amp;&amp; m_frame.document()-&gt;backForwardCacheState() != Document::InBackForwardCache) {</span>
          m_frame.document()-&gt;cancelParsing();
          m_frame.document()-&gt;stopActiveDOMObjects();
          bool hadLivingRenderTree = m_frame.document()-&gt;hasLivingRenderTree();
          m_frame.document()-&gt;prepareForDestruction();
          if (hadLivingRenderTree)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 646,11 ***</span>
  
      // Do this after detaching the document so that the unload event works.
      if (clearWindowProperties) {
          InspectorInstrumentation::frameWindowDiscarded(m_frame, m_frame.document()-&gt;domWindow());
          m_frame.document()-&gt;domWindow()-&gt;resetUnlessSuspendedForDocumentSuspension();
<span class="line-modified">!         m_frame.windowProxy().clearJSWindowProxiesNotMatchingDOMWindow(newDocument-&gt;domWindow(), m_frame.document()-&gt;pageCacheState() == Document::AboutToEnterPageCache);</span>
  
          if (shouldClearWindowName(m_frame, *newDocument))
              m_frame.tree().setName(nullAtom());
      }
  
<span class="line-new-header">--- 665,11 ---</span>
  
      // Do this after detaching the document so that the unload event works.
      if (clearWindowProperties) {
          InspectorInstrumentation::frameWindowDiscarded(m_frame, m_frame.document()-&gt;domWindow());
          m_frame.document()-&gt;domWindow()-&gt;resetUnlessSuspendedForDocumentSuspension();
<span class="line-modified">!         m_frame.windowProxy().clearJSWindowProxiesNotMatchingDOMWindow(newDocument-&gt;domWindow(), m_frame.document()-&gt;backForwardCacheState() == Document::AboutToEnterBackForwardCache);</span>
  
          if (shouldClearWindowName(m_frame, *newDocument))
              m_frame.tree().setName(nullAtom());
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 703,11 ***</span>
  
      LinkLoader::loadLinksFromHeader(documentLoader.response().httpHeaderField(HTTPHeaderName::Link), document.url(), document, LinkLoader::MediaAttributeCheck::MediaAttributeEmpty);
  
      double delay;
      String urlString;
<span class="line-modified">!     if (!parseHTTPRefresh(documentLoader.response().httpHeaderField(HTTPHeaderName::Refresh), delay, urlString))</span>
          return;
      auto completedURL = urlString.isEmpty() ? document.url() : document.completeURL(urlString);
      if (!WTF::protocolIsJavaScript(completedURL))
          m_frame.navigationScheduler().scheduleRedirect(document, delay, completedURL);
      else {
<span class="line-new-header">--- 722,11 ---</span>
  
      LinkLoader::loadLinksFromHeader(documentLoader.response().httpHeaderField(HTTPHeaderName::Link), document.url(), document, LinkLoader::MediaAttributeCheck::MediaAttributeEmpty);
  
      double delay;
      String urlString;
<span class="line-modified">!     if (!parseMetaHTTPEquivRefresh(documentLoader.response().httpHeaderField(HTTPHeaderName::Refresh), delay, urlString))</span>
          return;
      auto completedURL = urlString.isEmpty() ? document.url() : document.completeURL(urlString);
      if (!WTF::protocolIsJavaScript(completedURL))
          m_frame.navigationScheduler().scheduleRedirect(document, delay, completedURL);
      else {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 719,11 ***</span>
  void FrameLoader::setOutgoingReferrer(const URL&amp; url)
  {
      m_outgoingReferrer = url.strippedForUseAsReferrer();
  }
  
<span class="line-modified">! void FrameLoader::didBeginDocument(bool dispatch, ContentSecurityPolicy* previousPolicy)</span>
  {
      m_needsClear = true;
      m_isComplete = false;
      m_didCallImplicitClose = false;
      m_frame.document()-&gt;setReadyState(Document::Loading);
<span class="line-new-header">--- 738,11 ---</span>
  void FrameLoader::setOutgoingReferrer(const URL&amp; url)
  {
      m_outgoingReferrer = url.strippedForUseAsReferrer();
  }
  
<span class="line-modified">! void FrameLoader::didBeginDocument(bool dispatch)</span>
  {
      m_needsClear = true;
      m_isComplete = false;
      m_didCallImplicitClose = false;
      m_frame.document()-&gt;setReadyState(Document::Loading);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 735,11 ***</span>
  
      if (dispatch)
          dispatchDidClearWindowObjectsInAllWorlds();
  
      updateFirstPartyForCookies();
<span class="line-modified">!     m_frame.document()-&gt;initContentSecurityPolicy(previousPolicy);</span>
  
      const Settings&amp; settings = m_frame.settings();
      m_frame.document()-&gt;cachedResourceLoader().setImagesEnabled(settings.areImagesEnabled());
      m_frame.document()-&gt;cachedResourceLoader().setAutoLoadImages(settings.loadsImagesAutomatically());
  
<span class="line-new-header">--- 754,11 ---</span>
  
      if (dispatch)
          dispatchDidClearWindowObjectsInAllWorlds();
  
      updateFirstPartyForCookies();
<span class="line-modified">!     m_frame.document()-&gt;initContentSecurityPolicy();</span>
  
      const Settings&amp; settings = m_frame.settings();
      m_frame.document()-&gt;cachedResourceLoader().setImagesEnabled(settings.areImagesEnabled());
      m_frame.document()-&gt;cachedResourceLoader().setAutoLoadImages(settings.loadsImagesAutomatically());
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 836,19 ***</span>
  
      // Have we completed before?
      if (m_isComplete)
          return;
  
<span class="line-removed">- #if ENABLE(VIDEO)</span>
<span class="line-removed">-     // FIXME: Remove this code once https://webkit.org/b/185284 is fixed.</span>
<span class="line-removed">-     if (HTMLMediaElement::isRunningDestructor()) {</span>
<span class="line-removed">-         ASSERT_NOT_REACHED();</span>
<span class="line-removed">-         scheduleCheckCompleted();</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- </span>
      // FIXME: It would be better if resource loads were kicked off after render tree update (or didn&#39;t complete synchronously).
      //        https://bugs.webkit.org/show_bug.cgi?id=171729
      if (m_frame.document()-&gt;inRenderTreeUpdate()) {
          scheduleCheckCompleted();
          return;
<span class="line-new-header">--- 855,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 882,22 ***</span>
      // OK, completed.
      m_isComplete = true;
      m_requestedHistoryItem = nullptr;
      m_frame.document()-&gt;setReadyState(Document::Complete);
  
<span class="line-removed">- #if PLATFORM(IOS_FAMILY)</span>
<span class="line-removed">-     if (m_frame.document()-&gt;url().isEmpty()) {</span>
<span class="line-removed">-         // We need to update the document URL of a PDF document to be non-empty so that both back/forward history navigation</span>
<span class="line-removed">-         // between PDF pages and fragment navigation works. See &lt;rdar://problem/9544769&gt; for more details.</span>
<span class="line-removed">-         // FIXME: Is there a better place for this code, say DocumentLoader? Also, we should explicitly only update the URL</span>
<span class="line-removed">-         // of the document when it&#39;s a PDFDocument object instead of assuming that a Document object with an empty URL is a PDFDocument.</span>
<span class="line-removed">-         // FIXME: This code is incorrect for a synthesized document (which also has an empty URL). The URL for a synthesized</span>
<span class="line-removed">-         // document should be the URL specified to FrameLoader::initForSynthesizedDocument().</span>
<span class="line-removed">-         m_frame.document()-&gt;setURL(activeDocumentLoader()-&gt;documentURL());</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- </span>
      checkCallImplicitClose(); // if we didn&#39;t do it before
  
      m_frame.navigationScheduler().startTimer();
  
      completed();
<span class="line-new-header">--- 892,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 958,11 ***</span>
      m_frame.document()-&gt;implicitClose();
  }
  
  void FrameLoader::loadURLIntoChildFrame(const URL&amp; url, const String&amp; referer, Frame* childFrame)
  {
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;loadURLIntoChildFrame: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      ASSERT(childFrame);
  
  #if ENABLE(WEB_ARCHIVE) || ENABLE(MHTML)
      if (auto activeLoader = activeDocumentLoader()) {
<span class="line-new-header">--- 956,11 ---</span>
      m_frame.document()-&gt;implicitClose();
  }
  
  void FrameLoader::loadURLIntoChildFrame(const URL&amp; url, const String&amp; referer, Frame* childFrame)
  {
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;loadURLIntoChildFrame: frame load started&quot;);</span>
  
      ASSERT(childFrame);
  
  #if ENABLE(WEB_ARCHIVE) || ENABLE(MHTML)
      if (auto activeLoader = activeDocumentLoader()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 993,11 ***</span>
  
  #if ENABLE(WEB_ARCHIVE) || ENABLE(MHTML)
  
  void FrameLoader::loadArchive(Ref&lt;Archive&gt;&amp;&amp; archive)
  {
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;loadArchive: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      ArchiveResource* mainResource = archive-&gt;mainResource();
      ASSERT(mainResource);
      if (!mainResource)
          return;
<span class="line-new-header">--- 991,11 ---</span>
  
  #if ENABLE(WEB_ARCHIVE) || ENABLE(MHTML)
  
  void FrameLoader::loadArchive(Ref&lt;Archive&gt;&amp;&amp; archive)
  {
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;loadArchive: frame load started&quot;);</span>
  
      ArchiveResource* mainResource = archive-&gt;mainResource();
      ASSERT(mainResource);
      if (!mainResource)
          return;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1121,11 ***</span>
  
  // This does the same kind of work that didOpenURL does, except it relies on the fact
  // that a higher level already checked that the URLs match and the scrolling is the right thing to do.
  void FrameLoader::loadInSameDocument(const URL&amp; url, SerializedScriptValue* stateObject, bool isNewNavigation)
  {
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;loadInSameDocument: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      // If we have a state object, we cannot also be a new navigation.
      ASSERT(!stateObject || (stateObject &amp;&amp; !isNewNavigation));
  
      // Update the data source&#39;s request with the new URL to fake the URL change
<span class="line-new-header">--- 1119,11 ---</span>
  
  // This does the same kind of work that didOpenURL does, except it relies on the fact
  // that a higher level already checked that the URLs match and the scrolling is the right thing to do.
  void FrameLoader::loadInSameDocument(const URL&amp; url, SerializedScriptValue* stateObject, bool isNewNavigation)
  {
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;loadInSameDocument: frame load started&quot;);</span>
  
      // If we have a state object, we cannot also be a new navigation.
      ASSERT(!stateObject || (stateObject &amp;&amp; !isNewNavigation));
  
      // Update the data source&#39;s request with the new URL to fake the URL change
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1220,11 ***</span>
          frame-&gt;loader().m_isComplete = false;
  }
  
  void FrameLoader::prepareForLoadStart()
  {
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;prepareForLoadStart: Starting frame load (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      m_progressTracker-&gt;progressStarted();
      m_client.dispatchDidStartProvisionalLoad();
  
      if (AXObjectCache::accessibilityEnabled()) {
<span class="line-new-header">--- 1218,11 ---</span>
          frame-&gt;loader().m_isComplete = false;
  }
  
  void FrameLoader::prepareForLoadStart()
  {
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;prepareForLoadStart: Starting frame load&quot;);</span>
  
      m_progressTracker-&gt;progressStarted();
      m_client.dispatchDidStartProvisionalLoad();
  
      if (AXObjectCache::accessibilityEnabled()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1238,17 ***</span>
  void FrameLoader::setupForReplace()
  {
      m_client.revertToProvisionalState(m_documentLoader.get());
      setState(FrameStateProvisional);
      m_provisionalDocumentLoader = m_documentLoader;
      m_documentLoader = nullptr;
      detachChildren();
  }
  
  void FrameLoader::loadFrameRequest(FrameLoadRequest&amp;&amp; request, Event* event, RefPtr&lt;FormState&gt;&amp;&amp; formState, Optional&lt;AdClickAttribution&gt;&amp;&amp; adClickAttribution)
  {
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;loadFrameRequest: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      // Protect frame from getting blown away inside dispatchBeforeLoadEvent in loadWithDocumentLoader.
      auto protectFrame = makeRef(m_frame);
  
      URL url = request.resourceRequest().url();
<span class="line-new-header">--- 1236,18 ---</span>
  void FrameLoader::setupForReplace()
  {
      m_client.revertToProvisionalState(m_documentLoader.get());
      setState(FrameStateProvisional);
      m_provisionalDocumentLoader = m_documentLoader;
<span class="line-added">+     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;setupForReplace: Setting provisional document loader (m_provisionalDocumentLoader=%p)&quot;, m_provisionalDocumentLoader.get());</span>
      m_documentLoader = nullptr;
      detachChildren();
  }
  
  void FrameLoader::loadFrameRequest(FrameLoadRequest&amp;&amp; request, Event* event, RefPtr&lt;FormState&gt;&amp;&amp; formState, Optional&lt;AdClickAttribution&gt;&amp;&amp; adClickAttribution)
  {
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;loadFrameRequest: frame load started&quot;);</span>
  
      // Protect frame from getting blown away inside dispatchBeforeLoadEvent in loadWithDocumentLoader.
      auto protectFrame = makeRef(m_frame);
  
      URL url = request.resourceRequest().url();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1333,11 ***</span>
      return m_pageDismissalEventBeingDispatched == PageDismissalType::None;
  }
  
  void FrameLoader::loadURL(FrameLoadRequest&amp;&amp; frameLoadRequest, const String&amp; referrer, FrameLoadType newLoadType, Event* event, RefPtr&lt;FormState&gt;&amp;&amp; formState, Optional&lt;AdClickAttribution&gt;&amp;&amp; adClickAttribution, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)
  {
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;loadURL: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      CompletionHandlerCallingScope completionHandlerCaller(WTFMove(completionHandler));
      if (m_inStopAllLoaders || m_inClearProvisionalLoadForPolicyCheck)
          return;
  
<span class="line-new-header">--- 1332,11 ---</span>
      return m_pageDismissalEventBeingDispatched == PageDismissalType::None;
  }
  
  void FrameLoader::loadURL(FrameLoadRequest&amp;&amp; frameLoadRequest, const String&amp; referrer, FrameLoadType newLoadType, Event* event, RefPtr&lt;FormState&gt;&amp;&amp; formState, Optional&lt;AdClickAttribution&gt;&amp;&amp; adClickAttribution, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)
  {
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;loadURL: frame load started&quot;);</span>
  
      CompletionHandlerCallingScope completionHandlerCaller(WTFMove(completionHandler));
      if (m_inStopAllLoaders || m_inClearProvisionalLoadForPolicyCheck)
          return;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1383,11 ***</span>
      if (adClickAttribution &amp;&amp; m_frame.isMainFrame())
          action.setAdClickAttribution(WTFMove(*adClickAttribution));
  
      if (!targetFrame &amp;&amp; !effectiveFrameName.isEmpty()) {
          action = action.copyWithShouldOpenExternalURLsPolicy(shouldOpenExternalURLsPolicyToApply(m_frame, frameLoadRequest));
<span class="line-modified">!         policyChecker().checkNewWindowPolicy(WTFMove(action), WTFMove(request), WTFMove(formState), effectiveFrameName, [this, allowNavigationToInvalidURL, openerPolicy, completionHandler = completionHandlerCaller.release()] (const ResourceRequest&amp; request, WeakPtr&lt;FormState&gt;&amp;&amp; formState, const String&amp; frameName, const NavigationAction&amp; action, ShouldContinue shouldContinue) mutable {</span>
              continueLoadAfterNewWindowPolicy(request, formState.get(), frameName, action, shouldContinue, allowNavigationToInvalidURL, openerPolicy);
              completionHandler();
          });
          return;
      }
<span class="line-new-header">--- 1382,11 ---</span>
      if (adClickAttribution &amp;&amp; m_frame.isMainFrame())
          action.setAdClickAttribution(WTFMove(*adClickAttribution));
  
      if (!targetFrame &amp;&amp; !effectiveFrameName.isEmpty()) {
          action = action.copyWithShouldOpenExternalURLsPolicy(shouldOpenExternalURLsPolicyToApply(m_frame, frameLoadRequest));
<span class="line-modified">!         policyChecker().checkNewWindowPolicy(WTFMove(action), WTFMove(request), WTFMove(formState), effectiveFrameName, [this, allowNavigationToInvalidURL, openerPolicy, completionHandler = completionHandlerCaller.release()] (const ResourceRequest&amp; request, WeakPtr&lt;FormState&gt;&amp;&amp; formState, const String&amp; frameName, const NavigationAction&amp; action, PolicyChecker::ShouldContinue shouldContinue) mutable {</span>
              continueLoadAfterNewWindowPolicy(request, formState.get(), frameName, action, shouldContinue, allowNavigationToInvalidURL, openerPolicy);
              completionHandler();
          });
          return;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1414,13 ***</span>
  
      // Must grab this now, since this load may stop the previous load and clear this flag.
      bool isRedirect = m_quickRedirectComing;
  #if USE(SYSTEM_PREVIEW)
      bool isSystemPreview = frameLoadRequest.isSystemPreview();
<span class="line-removed">-     request.setSystemPreview(isSystemPreview);</span>
      if (isSystemPreview)
<span class="line-modified">!         request.setSystemPreviewRect(frameLoadRequest.systemPreviewRect());</span>
  #endif
      loadWithNavigationAction(request, WTFMove(action), lockHistory, newLoadType, WTFMove(formState), allowNavigationToInvalidURL, frameLoadRequest.downloadAttribute(), [this, isRedirect, sameURL, newLoadType, protectedFrame = makeRef(m_frame), completionHandler = completionHandlerCaller.release()] () mutable {
          if (isRedirect) {
              m_quickRedirectComing = false;
              if (m_provisionalDocumentLoader)
<span class="line-new-header">--- 1413,12 ---</span>
  
      // Must grab this now, since this load may stop the previous load and clear this flag.
      bool isRedirect = m_quickRedirectComing;
  #if USE(SYSTEM_PREVIEW)
      bool isSystemPreview = frameLoadRequest.isSystemPreview();
      if (isSystemPreview)
<span class="line-modified">!         request.setSystemPreviewInfo(frameLoadRequest.systemPreviewInfo());</span>
  #endif
      loadWithNavigationAction(request, WTFMove(action), lockHistory, newLoadType, WTFMove(formState), allowNavigationToInvalidURL, frameLoadRequest.downloadAttribute(), [this, isRedirect, sameURL, newLoadType, protectedFrame = makeRef(m_frame), completionHandler = completionHandlerCaller.release()] () mutable {
          if (isRedirect) {
              m_quickRedirectComing = false;
              if (m_provisionalDocumentLoader)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1449,11 ***</span>
      return SubstituteData(SharedBuffer::create(encodedSrcdoc.data(), encodedSrcdoc.length()), URL(), response, SubstituteData::SessionHistoryVisibility::Hidden);
  }
  
  void FrameLoader::load(FrameLoadRequest&amp;&amp; request)
  {
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;load (FrameLoadRequest): frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      if (m_inStopAllLoaders || m_inClearProvisionalLoadForPolicyCheck)
          return;
  
      if (!request.frameName().isEmpty()) {
<span class="line-new-header">--- 1447,11 ---</span>
      return SubstituteData(SharedBuffer::create(encodedSrcdoc.data(), encodedSrcdoc.length()), URL(), response, SubstituteData::SessionHistoryVisibility::Hidden);
  }
  
  void FrameLoader::load(FrameLoadRequest&amp;&amp; request)
  {
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;load (FrameLoadRequest): frame load started&quot;);</span>
  
      if (m_inStopAllLoaders || m_inClearProvisionalLoadForPolicyCheck)
          return;
  
      if (!request.frameName().isEmpty()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1467,11 ***</span>
          }
      }
  
      if (request.shouldCheckNewWindowPolicy()) {
          NavigationAction action { request.requester(), request.resourceRequest(), InitiatedByMainFrame::Unknown, NavigationType::Other, request.shouldOpenExternalURLsPolicy() };
<span class="line-modified">!         policyChecker().checkNewWindowPolicy(WTFMove(action), WTFMove(request.resourceRequest()), { }, request.frameName(), [this] (const ResourceRequest&amp; request, WeakPtr&lt;FormState&gt;&amp;&amp; formState, const String&amp; frameName, const NavigationAction&amp; action, ShouldContinue shouldContinue) {</span>
              continueLoadAfterNewWindowPolicy(request, formState.get(), frameName, action, shouldContinue, AllowNavigationToInvalidURL::Yes, NewFrameOpenerPolicy::Suppress);
          });
  
          return;
      }
<span class="line-new-header">--- 1465,11 ---</span>
          }
      }
  
      if (request.shouldCheckNewWindowPolicy()) {
          NavigationAction action { request.requester(), request.resourceRequest(), InitiatedByMainFrame::Unknown, NavigationType::Other, request.shouldOpenExternalURLsPolicy() };
<span class="line-modified">!         policyChecker().checkNewWindowPolicy(WTFMove(action), WTFMove(request.resourceRequest()), { }, request.frameName(), [this] (const ResourceRequest&amp; request, WeakPtr&lt;FormState&gt;&amp;&amp; formState, const String&amp; frameName, const NavigationAction&amp; action, PolicyChecker::ShouldContinue shouldContinue) {</span>
              continueLoadAfterNewWindowPolicy(request, formState.get(), frameName, action, shouldContinue, AllowNavigationToInvalidURL::Yes, NewFrameOpenerPolicy::Suppress);
          });
  
          return;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1479,10 ***</span>
<span class="line-new-header">--- 1477,11 ---</span>
      if (!request.hasSubstituteData())
          request.setSubstituteData(defaultSubstituteDataForURL(request.resourceRequest().url()));
  
      Ref&lt;DocumentLoader&gt; loader = m_client.createDocumentLoader(request.resourceRequest(), request.substituteData());
      loader-&gt;setAllowsWebArchiveForMainFrame(request.isRequestFromClientOrUserInput());
<span class="line-added">+     loader-&gt;setAllowsDataURLsForMainFrame(request.isRequestFromClientOrUserInput());</span>
      addSameSiteInfoToRequestIfNeeded(loader-&gt;request());
      applyShouldOpenExternalURLsPolicyToNewDocumentLoader(m_frame, loader, request);
  
      if (request.shouldTreatAsContinuingLoad()) {
          loader-&gt;setClientRedirectSourceForHistory(request.clientRedirectSourceForHistory());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1496,11 ***</span>
      load(loader.get());
  }
  
  void FrameLoader::loadWithNavigationAction(const ResourceRequest&amp; request, NavigationAction&amp;&amp; action, LockHistory lockHistory, FrameLoadType type, RefPtr&lt;FormState&gt;&amp;&amp; formState, AllowNavigationToInvalidURL allowNavigationToInvalidURL, const String&amp; downloadAttribute, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)
  {
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;loadWithNavigationAction: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      Ref&lt;DocumentLoader&gt; loader = m_client.createDocumentLoader(request, defaultSubstituteDataForURL(request.url()));
      loader-&gt;setDownloadAttribute(downloadAttribute);
      applyShouldOpenExternalURLsPolicyToNewDocumentLoader(m_frame, loader, action.initiatedByMainFrame(), action.shouldOpenExternalURLsPolicy());
  
<span class="line-new-header">--- 1495,11 ---</span>
      load(loader.get());
  }
  
  void FrameLoader::loadWithNavigationAction(const ResourceRequest&amp; request, NavigationAction&amp;&amp; action, LockHistory lockHistory, FrameLoadType type, RefPtr&lt;FormState&gt;&amp;&amp; formState, AllowNavigationToInvalidURL allowNavigationToInvalidURL, const String&amp; downloadAttribute, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)
  {
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;loadWithNavigationAction: frame load started&quot;);</span>
  
      Ref&lt;DocumentLoader&gt; loader = m_client.createDocumentLoader(request, defaultSubstituteDataForURL(request.url()));
      loader-&gt;setDownloadAttribute(downloadAttribute);
      applyShouldOpenExternalURLsPolicyToNewDocumentLoader(m_frame, loader, action.initiatedByMainFrame(), action.shouldOpenExternalURLsPolicy());
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1514,11 ***</span>
      loadWithDocumentLoader(loader.ptr(), type, WTFMove(formState), allowNavigationToInvalidURL, ShouldTreatAsContinuingLoad::No, WTFMove(completionHandler));
  }
  
  void FrameLoader::load(DocumentLoader&amp; newDocumentLoader)
  {
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;load (DocumentLoader): frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      ResourceRequest&amp; r = newDocumentLoader.request();
      addExtraFieldsToMainResourceRequest(r);
      FrameLoadType type;
  
<span class="line-new-header">--- 1513,11 ---</span>
      loadWithDocumentLoader(loader.ptr(), type, WTFMove(formState), allowNavigationToInvalidURL, ShouldTreatAsContinuingLoad::No, WTFMove(completionHandler));
  }
  
  void FrameLoader::load(DocumentLoader&amp; newDocumentLoader)
  {
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;load (DocumentLoader): frame load started&quot;);</span>
  
      ResourceRequest&amp; r = newDocumentLoader.request();
      addExtraFieldsToMainResourceRequest(r);
      FrameLoadType type;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1555,11 ***</span>
      loadWithDocumentLoader(&amp;newDocumentLoader, type, nullptr, AllowNavigationToInvalidURL::Yes, ShouldTreatAsContinuingLoad::No);
  }
  
  void FrameLoader::loadWithDocumentLoader(DocumentLoader* loader, FrameLoadType type, RefPtr&lt;FormState&gt;&amp;&amp; formState, AllowNavigationToInvalidURL allowNavigationToInvalidURL, ShouldTreatAsContinuingLoad, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)
  {
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;loadWithDocumentLoader: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      // Retain because dispatchBeforeLoadEvent may release the last reference to it.
      Ref&lt;Frame&gt; protect(m_frame);
  
      CompletionHandlerCallingScope completionHandlerCaller(WTFMove(completionHandler));
<span class="line-new-header">--- 1554,11 ---</span>
      loadWithDocumentLoader(&amp;newDocumentLoader, type, nullptr, AllowNavigationToInvalidURL::Yes, ShouldTreatAsContinuingLoad::No);
  }
  
  void FrameLoader::loadWithDocumentLoader(DocumentLoader* loader, FrameLoadType type, RefPtr&lt;FormState&gt;&amp;&amp; formState, AllowNavigationToInvalidURL allowNavigationToInvalidURL, ShouldTreatAsContinuingLoad, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)
  {
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;loadWithDocumentLoader: frame load started&quot;);</span>
  
      // Retain because dispatchBeforeLoadEvent may release the last reference to it.
      Ref&lt;Frame&gt; protect(m_frame);
  
      CompletionHandlerCallingScope completionHandlerCaller(WTFMove(completionHandler));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1585,11 ***</span>
          m_shouldReportResourceTimingToParentFrame = false;
  
      // Log main frame navigation types.
      if (m_frame.isMainFrame()) {
          if (auto* page = m_frame.page()) {
<span class="line-modified">!             RELEASE_LOG_IF_ALLOWED(&quot;loadWithDocumentLoader: main frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
              page-&gt;mainFrameLoadStarted(newURL, type);
              page-&gt;performanceLogging().didReachPointOfInterest(PerformanceLogging::MainFrameLoadStarted);
          }
      }
  
<span class="line-new-header">--- 1584,11 ---</span>
          m_shouldReportResourceTimingToParentFrame = false;
  
      // Log main frame navigation types.
      if (m_frame.isMainFrame()) {
          if (auto* page = m_frame.page()) {
<span class="line-modified">!             FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;loadWithDocumentLoader: main frame load started&quot;);</span>
              page-&gt;mainFrameLoadStarted(newURL, type);
              page-&gt;performanceLogging().didReachPointOfInterest(PerformanceLogging::MainFrameLoadStarted);
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1653,10 ***</span>
<span class="line-new-header">--- 1652,11 ---</span>
      if (!m_policyDocumentLoader || !m_provisionalDocumentLoader || m_inClearProvisionalLoadForPolicyCheck)
          return;
  
      SetForScope&lt;bool&gt; change(m_inClearProvisionalLoadForPolicyCheck, true);
      m_provisionalDocumentLoader-&gt;stopLoading();
<span class="line-added">+     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;clearProvisionalLoadForPolicyCheck: Clearing provisional document loader (m_provisionalDocumentLoader=%p)&quot;, m_provisionalDocumentLoader.get());</span>
      setProvisionalDocumentLoader(nullptr);
  }
  
  void FrameLoader::reportLocalLoadFailed(Frame* frame, const String&amp; url)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1735,11 ***</span>
  void FrameLoader::reloadWithOverrideEncoding(const String&amp; encoding)
  {
      if (!m_documentLoader)
          return;
  
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;reloadWithOverrideEncoding: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      ResourceRequest request = m_documentLoader-&gt;request();
      URL unreachableURL = m_documentLoader-&gt;unreachableURL();
      if (!unreachableURL.isEmpty())
          request.setURL(unreachableURL);
<span class="line-new-header">--- 1735,11 ---</span>
  void FrameLoader::reloadWithOverrideEncoding(const String&amp; encoding)
  {
      if (!m_documentLoader)
          return;
  
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;reloadWithOverrideEncoding: frame load started&quot;);</span>
  
      ResourceRequest request = m_documentLoader-&gt;request();
      URL unreachableURL = m_documentLoader-&gt;unreachableURL();
      if (!unreachableURL.isEmpty())
          request.setURL(unreachableURL);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1766,11 ***</span>
      // If a window is created by javascript, its main frame can have an empty but non-nil URL.
      // Reloading in this case will lose the current contents (see 4151001).
      if (m_documentLoader-&gt;request().url().isEmpty())
          return;
  
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;reload: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      // Replace error-page URL with the URL we were trying to reach.
      ResourceRequest initialRequest = m_documentLoader-&gt;request();
      URL unreachableURL = m_documentLoader-&gt;unreachableURL();
      if (!unreachableURL.isEmpty())
<span class="line-new-header">--- 1766,11 ---</span>
      // If a window is created by javascript, its main frame can have an empty but non-nil URL.
      // Reloading in this case will lose the current contents (see 4151001).
      if (m_documentLoader-&gt;request().url().isEmpty())
          return;
  
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;reload: frame load started&quot;);</span>
  
      // Replace error-page URL with the URL we were trying to reach.
      ResourceRequest initialRequest = m_documentLoader-&gt;request();
      URL unreachableURL = m_documentLoader-&gt;unreachableURL();
      if (!unreachableURL.isEmpty())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1778,10 ***</span>
<span class="line-new-header">--- 1778,11 ---</span>
  
      // Create a new document loader for the reload, this will become m_documentLoader eventually,
      // but first it has to be the &quot;policy&quot; document loader, and then the &quot;provisional&quot; document loader.
      Ref&lt;DocumentLoader&gt; loader = m_client.createDocumentLoader(initialRequest, defaultSubstituteDataForURL(initialRequest.url()));
      loader-&gt;setAllowsWebArchiveForMainFrame(m_documentLoader-&gt;allowsWebArchiveForMainFrame());
<span class="line-added">+     loader-&gt;setAllowsDataURLsForMainFrame(m_documentLoader-&gt;allowsDataURLsForMainFrame());</span>
      applyShouldOpenExternalURLsPolicyToNewDocumentLoader(m_frame, loader, InitiatedByMainFrame::Unknown, m_documentLoader-&gt;shouldOpenExternalURLsPolicyToPropagate());
  
      loader-&gt;setUserContentExtensionsEnabled(!options.contains(ReloadOption::DisableContentBlockers));
  
      ResourceRequest&amp; request = loader-&gt;request();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1808,11 ***</span>
      loadWithDocumentLoader(loader.ptr(), frameLoadTypeForReloadOptions(options), { }, AllowNavigationToInvalidURL::Yes, ShouldTreatAsContinuingLoad::No);
  }
  
  void FrameLoader::stopAllLoaders(ClearProvisionalItemPolicy clearProvisionalItemPolicy, StopLoadingPolicy stopLoadingPolicy)
  {
<span class="line-modified">!     if (m_frame.document() &amp;&amp; m_frame.document()-&gt;pageCacheState() == Document::InPageCache)</span>
          return;
  
      if (stopLoadingPolicy == StopLoadingPolicy::PreventDuringUnloadEvents &amp;&amp; !isStopLoadingAllowed())
          return;
  
<span class="line-new-header">--- 1809,11 ---</span>
      loadWithDocumentLoader(loader.ptr(), frameLoadTypeForReloadOptions(options), { }, AllowNavigationToInvalidURL::Yes, ShouldTreatAsContinuingLoad::No);
  }
  
  void FrameLoader::stopAllLoaders(ClearProvisionalItemPolicy clearProvisionalItemPolicy, StopLoadingPolicy stopLoadingPolicy)
  {
<span class="line-modified">!     if (m_frame.document() &amp;&amp; m_frame.document()-&gt;backForwardCacheState() == Document::InBackForwardCache)</span>
          return;
  
      if (stopLoadingPolicy == StopLoadingPolicy::PreventDuringUnloadEvents &amp;&amp; !isStopLoadingAllowed())
          return;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1841,15 ***</span>
<span class="line-new-header">--- 1842,39 ---</span>
      if (m_provisionalDocumentLoader)
          m_provisionalDocumentLoader-&gt;stopLoading();
      if (m_documentLoader)
          m_documentLoader-&gt;stopLoading();
  
<span class="line-added">+     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;stopAllLoaders: Clearing provisional document loader (m_provisionalDocumentLoader=%p)&quot;, m_provisionalDocumentLoader.get());</span>
      setProvisionalDocumentLoader(nullptr);
  
      m_inStopAllLoaders = false;
  }
  
<span class="line-added">+ void FrameLoader::stopForBackForwardCache()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     // Stop provisional loads in subframes (The one in the main frame is about to be committed).</span>
<span class="line-added">+     if (!m_frame.isMainFrame()) {</span>
<span class="line-added">+         if (m_provisionalDocumentLoader)</span>
<span class="line-added">+             m_provisionalDocumentLoader-&gt;stopLoading();</span>
<span class="line-added">+         FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;stopForBackForwardCache: Clearing provisional document loader (m_provisionalDocumentLoader=%p)&quot;, m_provisionalDocumentLoader.get());</span>
<span class="line-added">+         setProvisionalDocumentLoader(nullptr);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Stop current loads.</span>
<span class="line-added">+     if (m_documentLoader)</span>
<span class="line-added">+         m_documentLoader-&gt;stopLoading();</span>
<span class="line-added">+ </span>
<span class="line-added">+     for (RefPtr&lt;Frame&gt; child = m_frame.tree().firstChild(); child; child = child-&gt;tree().nextSibling())</span>
<span class="line-added">+         child-&gt;loader().stopForBackForwardCache();</span>
<span class="line-added">+ </span>
<span class="line-added">+     // We cancel pending navigations &amp; policy checks *after* cancelling loads because cancelling loads might end up</span>
<span class="line-added">+     // running script, which could schedule new navigations.</span>
<span class="line-added">+     policyChecker().stopCheck();</span>
<span class="line-added">+     m_frame.navigationScheduler().cancel();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void FrameLoader::stopAllLoadersAndCheckCompleteness()
  {
      stopAllLoaders();
  
      if (!m_checkTimer.isActive())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1947,10 ***</span>
<span class="line-new-header">--- 1972,12 ---</span>
      m_policyDocumentLoader = loader;
  }
  
  void FrameLoader::setProvisionalDocumentLoader(DocumentLoader* loader)
  {
<span class="line-added">+     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;setProvisionalDocumentLoader: Setting provisional document loader (m_provisionalDocumentLoader=%p)&quot;, loader);</span>
<span class="line-added">+ </span>
      ASSERT(!loader || !m_provisionalDocumentLoader);
      ASSERT(!loader || loader-&gt;frameLoader() == this);
  
      if (m_provisionalDocumentLoader &amp;&amp; m_provisionalDocumentLoader != m_documentLoader)
          m_provisionalDocumentLoader-&gt;detachFromFrame();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1968,18 ***</span>
      else if (newState == FrameStateComplete) {
          frameLoadCompleted();
          if (m_documentLoader)
              m_documentLoader-&gt;stopRecordingResponses();
          if (m_frame.isMainFrame() &amp;&amp; oldState != newState) {
<span class="line-modified">!             RELEASE_LOG_IF_ALLOWED(&quot;setState: main frame load completed (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
              m_frame.page()-&gt;performanceLogging().didReachPointOfInterest(PerformanceLogging::MainFrameLoadCompleted);
          }
      }
  }
  
  void FrameLoader::clearProvisionalLoad()
  {
      setProvisionalDocumentLoader(nullptr);
      m_progressTracker-&gt;progressCompleted();
      setState(FrameStateComplete);
  }
  
<span class="line-new-header">--- 1995,19 ---</span>
      else if (newState == FrameStateComplete) {
          frameLoadCompleted();
          if (m_documentLoader)
              m_documentLoader-&gt;stopRecordingResponses();
          if (m_frame.isMainFrame() &amp;&amp; oldState != newState) {
<span class="line-modified">!             FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;setState: main frame load completed&quot;);</span>
              m_frame.page()-&gt;performanceLogging().didReachPointOfInterest(PerformanceLogging::MainFrameLoadCompleted);
          }
      }
  }
  
  void FrameLoader::clearProvisionalLoad()
  {
<span class="line-added">+     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;clearProvisionalLoad: Clearing provisional document loader (m_provisionalDocumentLoader=%p)&quot;, m_provisionalDocumentLoader.get());</span>
      setProvisionalDocumentLoader(nullptr);
      m_progressTracker-&gt;progressCompleted();
      setState(FrameStateComplete);
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1988,22 ***</span>
      RefPtr&lt;DocumentLoader&gt; pdl = m_provisionalDocumentLoader;
      Ref&lt;Frame&gt; protect(m_frame);
  
      std::unique_ptr&lt;CachedPage&gt; cachedPage;
      if (m_loadingFromCachedPage &amp;&amp; history().provisionalItem())
<span class="line-modified">!         cachedPage = PageCache::singleton().take(*history().provisionalItem(), m_frame.page());</span>
  
<span class="line-modified">!     LOG(PageCache, &quot;WebCoreLoading %s: About to commit provisional load from previous URL &#39;%s&#39; to new URL &#39;%s&#39; with cached page %p&quot;, m_frame.tree().uniqueName().string().utf8().data(),</span>
          m_frame.document() ? m_frame.document()-&gt;url().stringCenterEllipsizedToLength().utf8().data() : &quot;&quot;,
          pdl ? pdl-&gt;url().stringCenterEllipsizedToLength().utf8().data() : &quot;&lt;no provisional DocumentLoader&gt;&quot;, cachedPage.get());
  
      willTransitionToCommitted();
  
      if (!m_frame.tree().parent() &amp;&amp; history().currentItem() &amp;&amp; history().currentItem() != history().provisionalItem()) {
          // Check to see if we need to cache the page we are navigating away from into the back/forward cache.
          // We are doing this here because we know for sure that a new page is about to be loaded.
<span class="line-modified">!         PageCache::singleton().addIfCacheable(*history().currentItem(), m_frame.page());</span>
  
          WebCore::jettisonExpensiveObjectsOnTopLevelNavigation();
      }
  
      if (m_loadType != FrameLoadType::Replace)
<span class="line-new-header">--- 2016,22 ---</span>
      RefPtr&lt;DocumentLoader&gt; pdl = m_provisionalDocumentLoader;
      Ref&lt;Frame&gt; protect(m_frame);
  
      std::unique_ptr&lt;CachedPage&gt; cachedPage;
      if (m_loadingFromCachedPage &amp;&amp; history().provisionalItem())
<span class="line-modified">!         cachedPage = BackForwardCache::singleton().take(*history().provisionalItem(), m_frame.page());</span>
  
<span class="line-modified">!     LOG(BackForwardCache, &quot;WebCoreLoading %s: About to commit provisional load from previous URL &#39;%s&#39; to new URL &#39;%s&#39; with cached page %p&quot;, m_frame.tree().uniqueName().string().utf8().data(),</span>
          m_frame.document() ? m_frame.document()-&gt;url().stringCenterEllipsizedToLength().utf8().data() : &quot;&quot;,
          pdl ? pdl-&gt;url().stringCenterEllipsizedToLength().utf8().data() : &quot;&lt;no provisional DocumentLoader&gt;&quot;, cachedPage.get());
  
      willTransitionToCommitted();
  
      if (!m_frame.tree().parent() &amp;&amp; history().currentItem() &amp;&amp; history().currentItem() != history().provisionalItem()) {
          // Check to see if we need to cache the page we are navigating away from into the back/forward cache.
          // We are doing this here because we know for sure that a new page is about to be loaded.
<span class="line-modified">!         BackForwardCache::singleton().addIfCacheable(*history().currentItem(), m_frame.page());</span>
  
          WebCore::jettisonExpensiveObjectsOnTopLevelNavigation();
      }
  
      if (m_loadType != FrameLoadType::Replace)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2076,15 ***</span>
  
      if (m_loadingFromCachedPage) {
          // Note, didReceiveDocType is expected to be called for cached pages. See &lt;rdar://problem/5906758&gt; for more details.
          if (auto* page = m_frame.page())
              page-&gt;chrome().didReceiveDocType(m_frame);
<span class="line-modified">!         m_frame.document()-&gt;resume(ReasonForSuspension::PageCache);</span>
  
          // Force a layout to update view size and thereby update scrollbars.
  #if PLATFORM(IOS_FAMILY)
<span class="line-modified">!         if (!m_client.forceLayoutOnRestoreFromPageCache())</span>
              m_frame.view()-&gt;forceLayout();
  #else
          m_frame.view()-&gt;forceLayout();
  #endif
  
<span class="line-new-header">--- 2104,15 ---</span>
  
      if (m_loadingFromCachedPage) {
          // Note, didReceiveDocType is expected to be called for cached pages. See &lt;rdar://problem/5906758&gt; for more details.
          if (auto* page = m_frame.page())
              page-&gt;chrome().didReceiveDocType(m_frame);
<span class="line-modified">!         m_frame.document()-&gt;resume(ReasonForSuspension::BackForwardCache);</span>
  
          // Force a layout to update view size and thereby update scrollbars.
  #if PLATFORM(IOS_FAMILY)
<span class="line-modified">!         if (!m_client.forceLayoutOnRestoreFromBackForwardCache())</span>
              m_frame.view()-&gt;forceLayout();
  #else
          m_frame.view()-&gt;forceLayout();
  #endif
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2141,10 ***</span>
<span class="line-new-header">--- 2169,11 ---</span>
      // Script can do anything. If the script initiates a new load, we need to abandon the
      // current load or the two will stomp each other.
      setDocumentLoader(m_provisionalDocumentLoader.get());
      if (pdl != m_provisionalDocumentLoader)
          return;
<span class="line-added">+     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;transitionToCommitted: Clearing provisional document loader (m_provisionalDocumentLoader=%p)&quot;, m_provisionalDocumentLoader.get());</span>
      setProvisionalDocumentLoader(nullptr);
  
      // Nothing else can interrupt this commit - set the Provisional-&gt;Committed transition in stone
      setState(FrameStateCommittedPage);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2302,11 ***</span>
      ASSERT(document-&gt;domWindow());
  
      clear(document.ptr(), true, true, cachedFrame.isMainFrame());
  
      document-&gt;attachToCachedFrame(cachedFrame);
<span class="line-modified">!     document-&gt;setPageCacheState(Document::NotInPageCache);</span>
  
      m_needsClear = true;
      m_isComplete = false;
      m_didCallImplicitClose = false;
      setOutgoingReferrer(url);
<span class="line-new-header">--- 2331,11 ---</span>
      ASSERT(document-&gt;domWindow());
  
      clear(document.ptr(), true, true, cachedFrame.isMainFrame());
  
      document-&gt;attachToCachedFrame(cachedFrame);
<span class="line-modified">!     document-&gt;setBackForwardCacheState(Document::NotInBackForwardCache);</span>
  
      m_needsClear = true;
      m_isComplete = false;
      m_didCallImplicitClose = false;
      setOutgoingReferrer(url);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2332,11 ***</span>
      WidgetHierarchyUpdatesSuspensionScope suspendWidgetHierarchyUpdates;
      NavigationDisabler disableNavigation { &amp;m_frame };
  
      m_frame.setDocument(document.copyRef());
  
<span class="line-modified">!     document-&gt;domWindow()-&gt;resumeFromPageCache();</span>
  
      updateFirstPartyForCookies();
  
      cachedFrame.restore();
  }
<span class="line-new-header">--- 2361,11 ---</span>
      WidgetHierarchyUpdatesSuspensionScope suspendWidgetHierarchyUpdates;
      NavigationDisabler disableNavigation { &amp;m_frame };
  
      m_frame.setDocument(document.copyRef());
  
<span class="line-modified">!     document-&gt;domWindow()-&gt;resumeFromBackForwardCache();</span>
  
      updateFirstPartyForCookies();
  
      cachedFrame.restore();
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2386,11 ***</span>
  }
  
  CachePolicy FrameLoader::subresourceCachePolicy(const URL&amp; url) const
  {
      if (Page* page = m_frame.page()) {
<span class="line-modified">!         if (page-&gt;isResourceCachingDisabled())</span>
              return CachePolicyReload;
      }
  
      if (m_isComplete)
          return CachePolicyVerify;
<span class="line-new-header">--- 2415,11 ---</span>
  }
  
  CachePolicy FrameLoader::subresourceCachePolicy(const URL&amp; url) const
  {
      if (Page* page = m_frame.page()) {
<span class="line-modified">!         if (page-&gt;isResourceCachingDisabledByWebInspector())</span>
              return CachePolicyReload;
      }
  
      if (m_isComplete)
          return CachePolicyVerify;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2494,11 ***</span>
                      item = page-&gt;mainFrame().loader().history().currentItem();
  
              // Only reset if we aren&#39;t already going to a new provisional item.
              bool shouldReset = !history().provisionalItem();
              if (!pdl-&gt;isLoadingInAPISense() || pdl-&gt;isStopping()) {
<span class="line-modified">!                 RELEASE_LOG_IF_ALLOWED(&quot;checkLoadCompleteForThisFrame: Failed provisional load (frame = %p, main = %d, isTimeout = %d, isCancellation = %d, errorCode = %d)&quot;, &amp;m_frame, m_frame.isMainFrame(), error.isTimeout(), error.isCancellation(), error.errorCode());</span>
  
                  dispatchDidFailProvisionalLoad(*pdl, error);
                  ASSERT(!pdl-&gt;isLoading());
  
                  // If we&#39;re in the middle of loading multipart data, we need to restore the document loader.
<span class="line-new-header">--- 2523,11 ---</span>
                      item = page-&gt;mainFrame().loader().history().currentItem();
  
              // Only reset if we aren&#39;t already going to a new provisional item.
              bool shouldReset = !history().provisionalItem();
              if (!pdl-&gt;isLoadingInAPISense() || pdl-&gt;isStopping()) {
<span class="line-modified">!                 FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;checkLoadCompleteForThisFrame: Failed provisional load (isTimeout = %d, isCancellation = %d, errorCode = %d)&quot;, error.isTimeout(), error.isCancellation(), error.errorCode());</span>
  
                  dispatchDidFailProvisionalLoad(*pdl, error);
                  ASSERT(!pdl-&gt;isLoading());
  
                  // If we&#39;re in the middle of loading multipart data, we need to restore the document loader.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2556,15 ***</span>
  
              const ResourceError&amp; error = m_documentLoader-&gt;mainDocumentError();
  
              AXObjectCache::AXLoadingEvent loadingEvent;
              if (!error.isNull()) {
<span class="line-modified">!                 RELEASE_LOG_IF_ALLOWED(&quot;checkLoadCompleteForThisFrame: Finished frame load with error (frame = %p, main = %d, isTimeout = %d, isCancellation = %d, errorCode = %d)&quot;, &amp;m_frame, m_frame.isMainFrame(), error.isTimeout(), error.isCancellation(), error.errorCode());</span>
                  m_client.dispatchDidFailLoad(error);
                  loadingEvent = AXObjectCache::AXLoadingFailed;
              } else {
<span class="line-modified">!                 RELEASE_LOG_IF_ALLOWED(&quot;checkLoadCompleteForThisFrame: Finished frame load (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  #if ENABLE(DATA_DETECTION)
                  auto* document = m_frame.document();
                  if (m_frame.settings().dataDetectorTypes() != DataDetectorTypeNone &amp;&amp; document) {
                      if (auto* documentElement = document-&gt;documentElement()) {
                          RefPtr&lt;Range&gt; documentRange = makeRange(firstPositionInNode(documentElement), lastPositionInNode(documentElement));
<span class="line-new-header">--- 2585,15 ---</span>
  
              const ResourceError&amp; error = m_documentLoader-&gt;mainDocumentError();
  
              AXObjectCache::AXLoadingEvent loadingEvent;
              if (!error.isNull()) {
<span class="line-modified">!                 FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;checkLoadCompleteForThisFrame: Finished frame load with error (isTimeout = %d, isCancellation = %d, errorCode = %d)&quot;, error.isTimeout(), error.isCancellation(), error.errorCode());</span>
                  m_client.dispatchDidFailLoad(error);
                  loadingEvent = AXObjectCache::AXLoadingFailed;
              } else {
<span class="line-modified">!                 FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;checkLoadCompleteForThisFrame: Finished frame load&quot;);</span>
  #if ENABLE(DATA_DETECTION)
                  auto* document = m_frame.document();
                  if (m_frame.settings().dataDetectorTypes() != DataDetectorTypeNone &amp;&amp; document) {
                      if (auto* documentElement = document-&gt;documentElement()) {
                          RefPtr&lt;Range&gt; documentRange = makeRange(firstPositionInNode(documentElement), lastPositionInNode(documentElement));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2742,28 ***</span>
  
  String FrameLoader::userAgent(const URL&amp; url) const
  {
      String userAgent;
  
<span class="line-removed">-     if (auto* documentLoader = m_frame.mainFrame().loader().activeDocumentLoader())</span>
<span class="line-removed">-         userAgent = documentLoader-&gt;customUserAgent();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     InspectorInstrumentation::applyUserAgentOverride(m_frame, userAgent);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (!userAgent.isEmpty())</span>
<span class="line-removed">-         return userAgent;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return m_client.userAgent(url);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- String FrameLoader::userAgentForJavaScript(const URL&amp; url) const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     String userAgent;</span>
<span class="line-removed">- </span>
      if (auto* documentLoader = m_frame.mainFrame().loader().activeDocumentLoader()) {
          if (m_frame.settings().needsSiteSpecificQuirks())
<span class="line-modified">!             userAgent = documentLoader-&gt;customJavaScriptUserAgentAsSiteSpecificQuirks();</span>
          if (userAgent.isEmpty())
              userAgent = documentLoader-&gt;customUserAgent();
      }
  
      InspectorInstrumentation::applyUserAgentOverride(m_frame, userAgent);
<span class="line-new-header">--- 2771,13 ---</span>
  
  String FrameLoader::userAgent(const URL&amp; url) const
  {
      String userAgent;
  
      if (auto* documentLoader = m_frame.mainFrame().loader().activeDocumentLoader()) {
          if (m_frame.settings().needsSiteSpecificQuirks())
<span class="line-modified">!             userAgent = documentLoader-&gt;customUserAgentAsSiteSpecificQuirks();</span>
          if (userAgent.isEmpty())
              userAgent = documentLoader-&gt;customUserAgent();
      }
  
      InspectorInstrumentation::applyUserAgentOverride(m_frame, userAgent);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2800,11 ***</span>
      if (m_checkTimer.isActive()) {
          m_checkTimer.stop();
          checkCompletenessNow();
      }
  
<span class="line-modified">!     if (m_frame.document()-&gt;pageCacheState() != Document::InPageCache) {</span>
          stopAllLoadersAndCheckCompleteness();
          m_frame.document()-&gt;stopActiveDOMObjects();
      }
  
      detachFromParent();
<span class="line-new-header">--- 2814,11 ---</span>
      if (m_checkTimer.isActive()) {
          m_checkTimer.stop();
          checkCompletenessNow();
      }
  
<span class="line-modified">!     if (m_frame.document()-&gt;backForwardCacheState() != Document::InBackForwardCache) {</span>
          stopAllLoadersAndCheckCompleteness();
          m_frame.document()-&gt;stopActiveDOMObjects();
      }
  
      detachFromParent();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2816,12 ***</span>
      Ref&lt;Frame&gt; protect(m_frame);
  
      closeURL();
      history().saveScrollPositionAndViewStateToItem(history().currentItem());
      detachChildren();
<span class="line-modified">!     if (m_frame.document()-&gt;pageCacheState() != Document::InPageCache) {</span>
<span class="line-modified">!         // stopAllLoaders() needs to be called after detachChildren() if the document is not in the page cache,</span>
          // because detachedChildren() will trigger the unload event handlers of any child frames, and those event
          // handlers might start a new subresource load in this frame.
          stopAllLoaders(ShouldClearProvisionalItem, StopLoadingPolicy::AlwaysStopLoading);
      }
  
<span class="line-new-header">--- 2830,12 ---</span>
      Ref&lt;Frame&gt; protect(m_frame);
  
      closeURL();
      history().saveScrollPositionAndViewStateToItem(history().currentItem());
      detachChildren();
<span class="line-modified">!     if (m_frame.document()-&gt;backForwardCacheState() != Document::InBackForwardCache) {</span>
<span class="line-modified">!         // stopAllLoaders() needs to be called after detachChildren() if the document is not in the back/forward cache,</span>
          // because detachedChildren() will trigger the unload event handlers of any child frames, and those event
          // handlers might start a new subresource load in this frame.
          stopAllLoaders(ShouldClearProvisionalItem, StopLoadingPolicy::AlwaysStopLoading);
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2927,11 ***</span>
      request.setIsTopSite(isMainFrameMainResource);
  
      Page* page = frame().page();
      bool hasSpecificCachePolicy = request.cachePolicy() != ResourceRequestCachePolicy::UseProtocolCachePolicy;
  
<span class="line-modified">!     if (page &amp;&amp; page-&gt;isResourceCachingDisabled()) {</span>
          request.setCachePolicy(ResourceRequestCachePolicy::ReloadIgnoringCacheData);
          loadType = FrameLoadType::ReloadFromOrigin;
      } else if (!hasSpecificCachePolicy)
          request.setCachePolicy(defaultRequestCachingPolicy(request, loadType, isMainResource));
  
<span class="line-new-header">--- 2941,11 ---</span>
      request.setIsTopSite(isMainFrameMainResource);
  
      Page* page = frame().page();
      bool hasSpecificCachePolicy = request.cachePolicy() != ResourceRequestCachePolicy::UseProtocolCachePolicy;
  
<span class="line-modified">!     if (page &amp;&amp; page-&gt;isResourceCachingDisabledByWebInspector()) {</span>
          request.setCachePolicy(ResourceRequestCachePolicy::ReloadIgnoringCacheData);
          loadType = FrameLoadType::ReloadFromOrigin;
      } else if (!hasSpecificCachePolicy)
          request.setCachePolicy(defaultRequestCachingPolicy(request, loadType, isMainResource));
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2939,14 ***</span>
      if (!request.url().isEmpty() &amp;&amp; !request.url().protocolIsInHTTPFamily())
          return;
  
      if (!hasSpecificCachePolicy &amp;&amp; request.cachePolicy() == ResourceRequestCachePolicy::ReloadIgnoringCacheData) {
          if (loadType == FrameLoadType::Reload)
<span class="line-modified">!             request.setHTTPHeaderField(HTTPHeaderName::CacheControl, &quot;max-age=0&quot;);</span>
          else if (loadType == FrameLoadType::ReloadFromOrigin) {
<span class="line-modified">!             request.setHTTPHeaderField(HTTPHeaderName::CacheControl, &quot;no-cache&quot;);</span>
<span class="line-modified">!             request.setHTTPHeaderField(HTTPHeaderName::Pragma, &quot;no-cache&quot;);</span>
          }
      }
  
      if (m_overrideResourceLoadPriorityForTesting)
          request.setPriority(m_overrideResourceLoadPriorityForTesting.value());
<span class="line-new-header">--- 2953,14 ---</span>
      if (!request.url().isEmpty() &amp;&amp; !request.url().protocolIsInHTTPFamily())
          return;
  
      if (!hasSpecificCachePolicy &amp;&amp; request.cachePolicy() == ResourceRequestCachePolicy::ReloadIgnoringCacheData) {
          if (loadType == FrameLoadType::Reload)
<span class="line-modified">!             request.setHTTPHeaderField(HTTPHeaderName::CacheControl, HTTPHeaderValues::maxAge0());</span>
          else if (loadType == FrameLoadType::ReloadFromOrigin) {
<span class="line-modified">!             request.setHTTPHeaderField(HTTPHeaderName::CacheControl, HTTPHeaderValues::noCache());</span>
<span class="line-modified">!             request.setHTTPHeaderField(HTTPHeaderName::Pragma, HTTPHeaderValues::noCache());</span>
          }
      }
  
      if (m_overrideResourceLoadPriorityForTesting)
          request.setPriority(m_overrideResourceLoadPriorityForTesting.value());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3021,11 ***</span>
      request.setHTTPHeaderField(HTTPHeaderName::UpgradeInsecureRequests, &quot;1&quot;_s);
  }
  
  void FrameLoader::loadPostRequest(FrameLoadRequest&amp;&amp; request, const String&amp; referrer, FrameLoadType loadType, Event* event, RefPtr&lt;FormState&gt;&amp;&amp; formState, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)
  {
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;loadPostRequest: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      String frameName = request.frameName();
      LockHistory lockHistory = request.lockHistory();
      AllowNavigationToInvalidURL allowNavigationToInvalidURL = request.allowNavigationToInvalidURL();
      NewFrameOpenerPolicy openerPolicy = request.newFrameOpenerPolicy();
<span class="line-new-header">--- 3035,11 ---</span>
      request.setHTTPHeaderField(HTTPHeaderName::UpgradeInsecureRequests, &quot;1&quot;_s);
  }
  
  void FrameLoader::loadPostRequest(FrameLoadRequest&amp;&amp; request, const String&amp; referrer, FrameLoadType loadType, Event* event, RefPtr&lt;FormState&gt;&amp;&amp; formState, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)
  {
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;loadPostRequest: frame load started&quot;);</span>
  
      String frameName = request.frameName();
      LockHistory lockHistory = request.lockHistory();
      AllowNavigationToInvalidURL allowNavigationToInvalidURL = request.allowNavigationToInvalidURL();
      NewFrameOpenerPolicy openerPolicy = request.newFrameOpenerPolicy();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3055,11 ***</span>
          if (auto* targetFrame = formState ? nullptr : findFrameForNavigation(frameName)) {
              targetFrame-&gt;loader().loadWithNavigationAction(workingResourceRequest, WTFMove(action), lockHistory, loadType, WTFMove(formState), allowNavigationToInvalidURL, { }, WTFMove(completionHandler));
              return;
          }
  
<span class="line-modified">!         policyChecker().checkNewWindowPolicy(WTFMove(action), WTFMove(workingResourceRequest), WTFMove(formState), frameName, [this, allowNavigationToInvalidURL, openerPolicy, completionHandler = WTFMove(completionHandler)] (const ResourceRequest&amp; request, WeakPtr&lt;FormState&gt;&amp;&amp; formState, const String&amp; frameName, const NavigationAction&amp; action, ShouldContinue shouldContinue) mutable {</span>
              continueLoadAfterNewWindowPolicy(request, formState.get(), frameName, action, shouldContinue, allowNavigationToInvalidURL, openerPolicy);
              completionHandler();
          });
          return;
      }
<span class="line-new-header">--- 3069,11 ---</span>
          if (auto* targetFrame = formState ? nullptr : findFrameForNavigation(frameName)) {
              targetFrame-&gt;loader().loadWithNavigationAction(workingResourceRequest, WTFMove(action), lockHistory, loadType, WTFMove(formState), allowNavigationToInvalidURL, { }, WTFMove(completionHandler));
              return;
          }
  
<span class="line-modified">!         policyChecker().checkNewWindowPolicy(WTFMove(action), WTFMove(workingResourceRequest), WTFMove(formState), frameName, [this, allowNavigationToInvalidURL, openerPolicy, completionHandler = WTFMove(completionHandler)] (const ResourceRequest&amp; request, WeakPtr&lt;FormState&gt;&amp;&amp; formState, const String&amp; frameName, const NavigationAction&amp; action, PolicyChecker::ShouldContinue shouldContinue) mutable {</span>
              continueLoadAfterNewWindowPolicy(request, formState.get(), frameName, action, shouldContinue, allowNavigationToInvalidURL, openerPolicy);
              completionHandler();
          });
          return;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3124,11 ***</span>
          if (!documentLoader()-&gt;applicationCacheHost().maybeLoadSynchronously(newRequest, error, response, data)) {
              Vector&lt;char&gt; buffer;
              platformStrategies()-&gt;loaderStrategy()-&gt;loadResourceSynchronously(*this, identifier, newRequest, clientCredentialPolicy, options, originalRequestHeaders, error, response, buffer);
              data = SharedBuffer::create(WTFMove(buffer));
              documentLoader()-&gt;applicationCacheHost().maybeLoadFallbackSynchronously(newRequest, error, response, data);
<span class="line-modified">!             ResourceLoadObserver::shared().logSubresourceLoading(&amp;m_frame, newRequest, response);</span>
          }
      }
      notifier().sendRemainingDelegateMessages(m_documentLoader.get(), identifier, request, response, data ? data-&gt;data() : nullptr, data ? data-&gt;size() : 0, -1, error);
      return identifier;
  }
<span class="line-new-header">--- 3138,12 ---</span>
          if (!documentLoader()-&gt;applicationCacheHost().maybeLoadSynchronously(newRequest, error, response, data)) {
              Vector&lt;char&gt; buffer;
              platformStrategies()-&gt;loaderStrategy()-&gt;loadResourceSynchronously(*this, identifier, newRequest, clientCredentialPolicy, options, originalRequestHeaders, error, response, buffer);
              data = SharedBuffer::create(WTFMove(buffer));
              documentLoader()-&gt;applicationCacheHost().maybeLoadFallbackSynchronously(newRequest, error, response, data);
<span class="line-modified">!             ResourceLoadObserver::shared().logSubresourceLoading(&amp;m_frame, newRequest, response,</span>
<span class="line-added">+                 (isScriptLikeDestination(options.destination) ? ResourceLoadObserver::FetchDestinationIsScriptLike::Yes : ResourceLoadObserver::FetchDestinationIsScriptLike::No));</span>
          }
      }
      notifier().sendRemainingDelegateMessages(m_documentLoader.get(), identifier, request, response, data ? data-&gt;data() : nullptr, data ? data-&gt;size() : 0, -1, error);
      return identifier;
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3152,11 ***</span>
  
      if (m_state == FrameStateProvisional &amp;&amp; m_provisionalDocumentLoader) {
          if (m_submittedFormURL == m_provisionalDocumentLoader-&gt;originalRequestCopy().url())
              m_submittedFormURL = URL();
  
<span class="line-modified">!         // We might have made a page cache item, but now we&#39;re bailing out due to an error before we ever</span>
          // transitioned to the new page (before WebFrameState == commit).  The goal here is to restore any state
          // so that the existing view (that wenever got far enough to replace) can continue being used.
          history().invalidateCurrentItemCachedPage();
  
          // Call clientRedirectCancelledOrFinished here so that the frame load delegate is notified that the redirect&#39;s
<span class="line-new-header">--- 3167,11 ---</span>
  
      if (m_state == FrameStateProvisional &amp;&amp; m_provisionalDocumentLoader) {
          if (m_submittedFormURL == m_provisionalDocumentLoader-&gt;originalRequestCopy().url())
              m_submittedFormURL = URL();
  
<span class="line-modified">!         // We might have made a back/forward cache item, but now we&#39;re bailing out due to an error before we ever</span>
          // transitioned to the new page (before WebFrameState == commit).  The goal here is to restore any state
          // so that the existing view (that wenever got far enough to replace) can continue being used.
          history().invalidateCurrentItemCachedPage();
  
          // Call clientRedirectCancelledOrFinished here so that the frame load delegate is notified that the redirect&#39;s
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3185,10 ***</span>
<span class="line-new-header">--- 3200,11 ---</span>
      Ref&lt;Frame&gt; protectedFrame(m_frame);
  
      // If we have a provisional request for a different document, a fragment scroll should cancel it.
      if (m_provisionalDocumentLoader &amp;&amp; !equalIgnoringFragmentIdentifier(m_provisionalDocumentLoader-&gt;request().url(), request.url())) {
          m_provisionalDocumentLoader-&gt;stopLoading();
<span class="line-added">+         FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;continueFragmentScrollAfterNavigationPolicy: Clearing provisional document loader (m_provisionalDocumentLoader=%p)&quot;, m_provisionalDocumentLoader.get());</span>
          setProvisionalDocumentLoader(nullptr);
      }
  
      bool isRedirect = m_quickRedirectComing || policyChecker().loadType() == FrameLoadType::RedirectWithLockedBackForwardList;
      loadInSameDocument(request.url(), 0, !isRedirect);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3203,11 ***</span>
      // FIXME: What about load types other than Standard and Reload?
  
      return (!isFormSubmission || equalLettersIgnoringASCIICase(httpMethod, &quot;get&quot;))
          &amp;&amp; !isReload(loadType)
          &amp;&amp; loadType != FrameLoadType::Same
<span class="line-modified">!         &amp;&amp; m_frame.document()-&gt;pageCacheState() != Document::InPageCache</span>
          &amp;&amp; !shouldReload(m_frame.document()-&gt;url(), url)
          // We don&#39;t want to just scroll if a link from within a
          // frameset is trying to reload the frameset into _top.
          &amp;&amp; !m_frame.document()-&gt;isFrameSet();
  }
<span class="line-new-header">--- 3219,11 ---</span>
      // FIXME: What about load types other than Standard and Reload?
  
      return (!isFormSubmission || equalLettersIgnoringASCIICase(httpMethod, &quot;get&quot;))
          &amp;&amp; !isReload(loadType)
          &amp;&amp; loadType != FrameLoadType::Same
<span class="line-modified">!         &amp;&amp; m_frame.document()-&gt;backForwardCacheState() != Document::InBackForwardCache</span>
          &amp;&amp; !shouldReload(m_frame.document()-&gt;url(), url)
          // We don&#39;t want to just scroll if a link from within a
          // frameset is trying to reload the frameset into _top.
          &amp;&amp; !m_frame.document()-&gt;isFrameSet();
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3222,16 ***</span>
      return !isNewNavigation &amp;&amp; !isBackForwardLoadType(loadType);
  }
  
  void FrameLoader::scrollToFragmentWithParentBoundary(const URL&amp; url, bool isNewNavigation)
  {
<span class="line-modified">!     FrameView* view = m_frame.view();</span>
<span class="line-modified">!     if (!view)</span>
          return;
  
<span class="line-modified">!     if (isSameDocumentReload(isNewNavigation, m_loadType) || itemAllowsScrollRestoration(history().currentItem()))</span>
<span class="line-modified">!         view-&gt;scrollToFragment(url);</span>
  }
  
  bool FrameLoader::shouldClose()
  {
      Page* page = m_frame.page();
<span class="line-new-header">--- 3238,23 ---</span>
      return !isNewNavigation &amp;&amp; !isBackForwardLoadType(loadType);
  }
  
  void FrameLoader::scrollToFragmentWithParentBoundary(const URL&amp; url, bool isNewNavigation)
  {
<span class="line-modified">!     auto view = makeRefPtr(m_frame.view());</span>
<span class="line-modified">!     auto document = makeRefPtr(m_frame.document());</span>
<span class="line-added">+     if (!view || !document)</span>
          return;
  
<span class="line-modified">!     if (isSameDocumentReload(isNewNavigation, m_loadType) || itemAllowsScrollRestoration(history().currentItem())) {</span>
<span class="line-modified">!         // https://html.spec.whatwg.org/multipage/browsing-the-web.html#try-to-scroll-to-the-fragment</span>
<span class="line-added">+         if (!document-&gt;haveStylesheetsLoaded())</span>
<span class="line-added">+             document-&gt;setGotoAnchorNeededAfterStylesheetsLoad(true);</span>
<span class="line-added">+         else</span>
<span class="line-added">+             view-&gt;scrollToFragment(url);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
  }
  
  bool FrameLoader::shouldClose()
  {
      Page* page = m_frame.page();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3278,26 ***</span>
      if (m_pageDismissalEventBeingDispatched != PageDismissalType::None)
          return;
  
      // We store the frame&#39;s page in a local variable because the frame might get detached inside dispatchEvent.
      ForbidPromptsScope forbidPrompts(m_frame.page());
      IgnoreOpensDuringUnloadCountIncrementer ignoreOpensDuringUnloadCountIncrementer(m_frame.document());
  
      if (m_didCallImplicitClose &amp;&amp; !m_wasUnloadEventEmitted) {
          auto* currentFocusedElement = m_frame.document()-&gt;focusedElement();
          if (is&lt;HTMLInputElement&gt;(currentFocusedElement))
              downcast&lt;HTMLInputElement&gt;(*currentFocusedElement).endEditing();
          if (m_pageDismissalEventBeingDispatched == PageDismissalType::None) {
              if (unloadEventPolicy == UnloadEventPolicyUnloadAndPageHide) {
                  m_pageDismissalEventBeingDispatched = PageDismissalType::PageHide;
<span class="line-modified">!                 m_frame.document()-&gt;domWindow()-&gt;dispatchEvent(PageTransitionEvent::create(eventNames().pagehideEvent, m_frame.document()-&gt;pageCacheState() == Document::AboutToEnterPageCache), m_frame.document());</span>
              }
  
              // FIXME: update Page Visibility state here.
              // https://bugs.webkit.org/show_bug.cgi?id=116770
  
<span class="line-modified">!             if (m_frame.document()-&gt;pageCacheState() == Document::NotInPageCache) {</span>
                  Ref&lt;Event&gt; unloadEvent(Event::create(eventNames().unloadEvent, Event::CanBubble::No, Event::IsCancelable::No));
                  // The DocumentLoader (and thus its LoadTiming) might get destroyed
                  // while dispatching the event, so protect it to prevent writing the end
                  // time into freed memory.
                  RefPtr&lt;DocumentLoader&gt; documentLoader = m_provisionalDocumentLoader;
<span class="line-new-header">--- 3301,27 ---</span>
      if (m_pageDismissalEventBeingDispatched != PageDismissalType::None)
          return;
  
      // We store the frame&#39;s page in a local variable because the frame might get detached inside dispatchEvent.
      ForbidPromptsScope forbidPrompts(m_frame.page());
<span class="line-added">+     ForbidSynchronousLoadsScope forbidSynchronousLoads(m_frame.page());</span>
      IgnoreOpensDuringUnloadCountIncrementer ignoreOpensDuringUnloadCountIncrementer(m_frame.document());
  
      if (m_didCallImplicitClose &amp;&amp; !m_wasUnloadEventEmitted) {
          auto* currentFocusedElement = m_frame.document()-&gt;focusedElement();
          if (is&lt;HTMLInputElement&gt;(currentFocusedElement))
              downcast&lt;HTMLInputElement&gt;(*currentFocusedElement).endEditing();
          if (m_pageDismissalEventBeingDispatched == PageDismissalType::None) {
              if (unloadEventPolicy == UnloadEventPolicyUnloadAndPageHide) {
                  m_pageDismissalEventBeingDispatched = PageDismissalType::PageHide;
<span class="line-modified">!                 m_frame.document()-&gt;domWindow()-&gt;dispatchEvent(PageTransitionEvent::create(eventNames().pagehideEvent, m_frame.document()-&gt;backForwardCacheState() == Document::AboutToEnterBackForwardCache), m_frame.document());</span>
              }
  
              // FIXME: update Page Visibility state here.
              // https://bugs.webkit.org/show_bug.cgi?id=116770
  
<span class="line-modified">!             if (m_frame.document()-&gt;backForwardCacheState() == Document::NotInBackForwardCache) {</span>
                  Ref&lt;Event&gt; unloadEvent(Event::create(eventNames().unloadEvent, Event::CanBubble::No, Event::IsCancelable::No));
                  // The DocumentLoader (and thus its LoadTiming) might get destroyed
                  // while dispatching the event, so protect it to prevent writing the end
                  // time into freed memory.
                  RefPtr&lt;DocumentLoader&gt; documentLoader = m_provisionalDocumentLoader;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3317,11 ***</span>
  
      // Dispatching the unload event could have made m_frame.document() null.
      if (!m_frame.document())
          return;
  
<span class="line-modified">!     if (m_frame.document()-&gt;pageCacheState() != Document::NotInPageCache)</span>
          return;
  
      // Don&#39;t remove event listeners from a transitional empty document (see bug 28716 for more information).
      bool keepEventListeners = m_stateMachine.isDisplayingInitialEmptyDocument() &amp;&amp; m_provisionalDocumentLoader
          &amp;&amp; m_frame.document()-&gt;isSecureTransitionTo(m_provisionalDocumentLoader-&gt;url());
<span class="line-new-header">--- 3341,11 ---</span>
  
      // Dispatching the unload event could have made m_frame.document() null.
      if (!m_frame.document())
          return;
  
<span class="line-modified">!     if (m_frame.document()-&gt;backForwardCacheState() != Document::NotInBackForwardCache)</span>
          return;
  
      // Don&#39;t remove event listeners from a transitional empty document (see bug 28716 for more information).
      bool keepEventListeners = m_stateMachine.isDisplayingInitialEmptyDocument() &amp;&amp; m_provisionalDocumentLoader
          &amp;&amp; m_frame.document()-&gt;isSecureTransitionTo(m_provisionalDocumentLoader-&gt;url());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3358,10 ***</span>
<span class="line-new-header">--- 3382,11 ---</span>
      Ref&lt;BeforeUnloadEvent&gt; beforeUnloadEvent = BeforeUnloadEvent::create();
  
      {
          SetForScope&lt;PageDismissalType&gt; change(m_pageDismissalEventBeingDispatched, PageDismissalType::BeforeUnload);
          ForbidPromptsScope forbidPrompts(m_frame.page());
<span class="line-added">+         ForbidSynchronousLoadsScope forbidSynchronousLoads(m_frame.page());</span>
          domWindow-&gt;dispatchEvent(beforeUnloadEvent, domWindow-&gt;document());
      }
  
      if (!beforeUnloadEvent-&gt;defaultPrevented())
          document-&gt;defaultEventHandler(beforeUnloadEvent.get());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3417,18 ***</span>
  
      bool urlIsDisallowed = allowNavigationToInvalidURL == AllowNavigationToInvalidURL::No &amp;&amp; !request.url().isValid();
      bool canContinue = navigationPolicyDecision == NavigationPolicyDecision::ContinueLoad &amp;&amp; shouldClose() &amp;&amp; !urlIsDisallowed;
  
      if (!canContinue) {
<span class="line-modified">!         RELEASE_LOG_IF_ALLOWED(&quot;continueLoadAfterNavigationPolicy: can&#39;t continue loading frame due to the following reasons (&quot;</span>
<span class="line-removed">-             &quot;frame = %p, &quot;</span>
<span class="line-removed">-             &quot;main = %d, &quot;</span>
              &quot;allowNavigationToInvalidURL = %d, &quot;
              &quot;requestURLIsValid = %d, &quot;
              &quot;navigationPolicyDecision = %d)&quot;,
<span class="line-removed">-             &amp;m_frame,</span>
<span class="line-removed">-             m_frame.isMainFrame(),</span>
              static_cast&lt;int&gt;(allowNavigationToInvalidURL),
              request.url().isValid(),
              static_cast&lt;int&gt;(navigationPolicyDecision));
  
          // If we were waiting for a quick redirect, but the policy delegate decided to ignore it, then we
<span class="line-new-header">--- 3442,14 ---</span>
  
      bool urlIsDisallowed = allowNavigationToInvalidURL == AllowNavigationToInvalidURL::No &amp;&amp; !request.url().isValid();
      bool canContinue = navigationPolicyDecision == NavigationPolicyDecision::ContinueLoad &amp;&amp; shouldClose() &amp;&amp; !urlIsDisallowed;
  
      if (!canContinue) {
<span class="line-modified">!         FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;continueLoadAfterNavigationPolicy: can&#39;t continue loading frame due to the following reasons (&quot;</span>
              &quot;allowNavigationToInvalidURL = %d, &quot;
              &quot;requestURLIsValid = %d, &quot;
              &quot;navigationPolicyDecision = %d)&quot;,
              static_cast&lt;int&gt;(allowNavigationToInvalidURL),
              request.url().isValid(),
              static_cast&lt;int&gt;(navigationPolicyDecision));
  
          // If we were waiting for a quick redirect, but the policy delegate decided to ignore it, then we
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3465,49 ***</span>
      stopAllLoaders(ShouldNotClearProvisionalItem);
  
      // &lt;rdar://problem/6250856&gt; - In certain circumstances on pages with multiple frames, stopAllLoaders()
      // might detach the current FrameLoader, in which case we should bail on this newly defunct load.
      if (!m_frame.page()) {
<span class="line-modified">!         RELEASE_LOG_IF_ALLOWED(&quot;continueLoadAfterNavigationPolicy: can&#39;t continue loading frame because it became defunct (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
          return;
      }
  
      setProvisionalDocumentLoader(m_policyDocumentLoader.get());
      m_loadType = type;
      setState(FrameStateProvisional);
  
      setPolicyDocumentLoader(nullptr);
  
      if (isBackForwardLoadType(type)) {
          auto&amp; diagnosticLoggingClient = m_frame.page()-&gt;diagnosticLoggingClient();
<span class="line-modified">!         if (history().provisionalItem() &amp;&amp; history().provisionalItem()-&gt;isInPageCache()) {</span>
<span class="line-modified">!             diagnosticLoggingClient.logDiagnosticMessageWithResult(DiagnosticLoggingKeys::pageCacheKey(), DiagnosticLoggingKeys::retrievalKey(), DiagnosticLoggingResultPass, ShouldSample::Yes);</span>
              loadProvisionalItemFromCachedPage();
<span class="line-modified">!             RELEASE_LOG_IF_ALLOWED(&quot;continueLoadAfterNavigationPolicy: can&#39;t continue loading frame because it will be loaded from cache (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
              return;
          }
<span class="line-modified">!         diagnosticLoggingClient.logDiagnosticMessageWithResult(DiagnosticLoggingKeys::pageCacheKey(), DiagnosticLoggingKeys::retrievalKey(), DiagnosticLoggingResultFail, ShouldSample::Yes);</span>
      }
  
      CompletionHandler&lt;void()&gt; completionHandler = [this, protectedFrame = makeRef(m_frame)] () mutable {
          if (!m_provisionalDocumentLoader) {
<span class="line-modified">!             RELEASE_LOG_IF_ALLOWED(&quot;continueLoadAfterNavigationPolicy completionHandler: Frame load canceled #1 (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
              return;
          }
  
          prepareForLoadStart();
  
          // The load might be cancelled inside of prepareForLoadStart(), nulling out the m_provisionalDocumentLoader,
          // so we need to null check it again.
          if (!m_provisionalDocumentLoader) {
<span class="line-modified">!             RELEASE_LOG_IF_ALLOWED(&quot;prepareForLoadStart completionHandler: Frame load canceled #2 (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
              return;
          }
  
          DocumentLoader* activeDocLoader = activeDocumentLoader();
          if (activeDocLoader &amp;&amp; activeDocLoader-&gt;isLoadingMainResource()) {
<span class="line-modified">!             RELEASE_LOG_IF_ALLOWED(&quot;prepareForLoadStart completionHandler: Main frame already being loaded (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
              return;
          }
  
          m_loadingFromCachedPage = false;
  
<span class="line-new-header">--- 3486,50 ---</span>
      stopAllLoaders(ShouldNotClearProvisionalItem);
  
      // &lt;rdar://problem/6250856&gt; - In certain circumstances on pages with multiple frames, stopAllLoaders()
      // might detach the current FrameLoader, in which case we should bail on this newly defunct load.
      if (!m_frame.page()) {
<span class="line-modified">!         FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;continueLoadAfterNavigationPolicy: can&#39;t continue loading frame because it became defunct&quot;);</span>
          return;
      }
  
      setProvisionalDocumentLoader(m_policyDocumentLoader.get());
<span class="line-added">+     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;continueLoadAfterNavigationPolicy: Setting provisional document loader (m_provisionalDocumentLoader=%p)&quot;, m_provisionalDocumentLoader.get());</span>
      m_loadType = type;
      setState(FrameStateProvisional);
  
      setPolicyDocumentLoader(nullptr);
  
      if (isBackForwardLoadType(type)) {
          auto&amp; diagnosticLoggingClient = m_frame.page()-&gt;diagnosticLoggingClient();
<span class="line-modified">!         if (history().provisionalItem() &amp;&amp; history().provisionalItem()-&gt;isInBackForwardCache()) {</span>
<span class="line-modified">!             diagnosticLoggingClient.logDiagnosticMessageWithResult(DiagnosticLoggingKeys::backForwardCacheKey(), DiagnosticLoggingKeys::retrievalKey(), DiagnosticLoggingResultPass, ShouldSample::Yes);</span>
              loadProvisionalItemFromCachedPage();
<span class="line-modified">!             FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;continueLoadAfterNavigationPolicy: can&#39;t continue loading frame because it will be loaded from cache&quot;);</span>
              return;
          }
<span class="line-modified">!         diagnosticLoggingClient.logDiagnosticMessageWithResult(DiagnosticLoggingKeys::backForwardCacheKey(), DiagnosticLoggingKeys::retrievalKey(), DiagnosticLoggingResultFail, ShouldSample::Yes);</span>
      }
  
      CompletionHandler&lt;void()&gt; completionHandler = [this, protectedFrame = makeRef(m_frame)] () mutable {
          if (!m_provisionalDocumentLoader) {
<span class="line-modified">!             FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;continueLoadAfterNavigationPolicy (completionHandler): Frame load canceled - no provisional document loader before prepareForLoadStart&quot;);</span>
              return;
          }
  
          prepareForLoadStart();
  
          // The load might be cancelled inside of prepareForLoadStart(), nulling out the m_provisionalDocumentLoader,
          // so we need to null check it again.
          if (!m_provisionalDocumentLoader) {
<span class="line-modified">!             FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;continueLoadAfterNavigationPolicy (completionHandler): Frame load canceled - no provisional document loader after prepareForLoadStart&quot;);</span>
              return;
          }
  
          DocumentLoader* activeDocLoader = activeDocumentLoader();
          if (activeDocLoader &amp;&amp; activeDocLoader-&gt;isLoadingMainResource()) {
<span class="line-modified">!             FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;continueLoadAfterNavigationPolicy (completionHandler): Main frame already being loaded&quot;);</span>
              return;
          }
  
          m_loadingFromCachedPage = false;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3521,13 ***</span>
  
      m_client.dispatchWillSubmitForm(*formState, WTFMove(completionHandler));
  }
  
  void FrameLoader::continueLoadAfterNewWindowPolicy(const ResourceRequest&amp; request,
<span class="line-modified">!     FormState* formState, const String&amp; frameName, const NavigationAction&amp; action, ShouldContinue shouldContinue, AllowNavigationToInvalidURL allowNavigationToInvalidURL, NewFrameOpenerPolicy openerPolicy)</span>
  {
<span class="line-modified">!     if (shouldContinue != ShouldContinue::Yes)</span>
          return;
  
      Ref&lt;Frame&gt; frame(m_frame);
      RefPtr&lt;Frame&gt; mainFrame = m_client.dispatchCreatePage(action);
      if (!mainFrame)
<span class="line-new-header">--- 3543,13 ---</span>
  
      m_client.dispatchWillSubmitForm(*formState, WTFMove(completionHandler));
  }
  
  void FrameLoader::continueLoadAfterNewWindowPolicy(const ResourceRequest&amp; request,
<span class="line-modified">!     FormState* formState, const String&amp; frameName, const NavigationAction&amp; action, PolicyChecker::ShouldContinue shouldContinue, AllowNavigationToInvalidURL allowNavigationToInvalidURL, NewFrameOpenerPolicy openerPolicy)</span>
  {
<span class="line-modified">!     if (shouldContinue != PolicyChecker::ShouldContinue::Yes)</span>
          return;
  
      Ref&lt;Frame&gt; frame(m_frame);
      RefPtr&lt;Frame&gt; mainFrame = m_client.dispatchCreatePage(action);
      if (!mainFrame)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3652,11 ***</span>
  }
  
  void FrameLoader::loadProvisionalItemFromCachedPage()
  {
      DocumentLoader* provisionalLoader = provisionalDocumentLoader();
<span class="line-modified">!     LOG(PageCache, &quot;WebCorePageCache: Loading provisional DocumentLoader %p with URL &#39;%s&#39; from CachedPage&quot;, provisionalDocumentLoader(), provisionalDocumentLoader()-&gt;url().stringCenterEllipsizedToLength().utf8().data());</span>
  
      prepareForLoadStart();
  
      m_loadingFromCachedPage = true;
  
<span class="line-new-header">--- 3674,11 ---</span>
  }
  
  void FrameLoader::loadProvisionalItemFromCachedPage()
  {
      DocumentLoader* provisionalLoader = provisionalDocumentLoader();
<span class="line-modified">!     LOG(BackForwardCache, &quot;FrameLoader::loadProvisionalItemFromCachedPage Loading provisional DocumentLoader %p with URL &#39;%s&#39; from CachedPage&quot;, provisionalDocumentLoader(), provisionalDocumentLoader()-&gt;url().stringCenterEllipsizedToLength().utf8().data());</span>
  
      prepareForLoadStart();
  
      m_loadingFromCachedPage = true;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3726,11 ***</span>
  // FIXME: This function should really be split into a couple pieces, some of
  // which should be methods of HistoryController and some of which should be
  // methods of FrameLoader.
  void FrameLoader::loadDifferentDocumentItem(HistoryItem&amp; item, HistoryItem* fromItem, FrameLoadType loadType, FormSubmissionCacheLoadPolicy cacheLoadPolicy, ShouldTreatAsContinuingLoad shouldTreatAsContinuingLoad)
  {
<span class="line-modified">!     RELEASE_LOG_IF_ALLOWED(&quot;loadDifferentDocumentItem: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());</span>
  
      Ref&lt;Frame&gt; protectedFrame(m_frame);
  
      // History items should not be reported to the parent.
      m_shouldReportResourceTimingToParentFrame = false;
<span class="line-new-header">--- 3748,11 ---</span>
  // FIXME: This function should really be split into a couple pieces, some of
  // which should be methods of HistoryController and some of which should be
  // methods of FrameLoader.
  void FrameLoader::loadDifferentDocumentItem(HistoryItem&amp; item, HistoryItem* fromItem, FrameLoadType loadType, FormSubmissionCacheLoadPolicy cacheLoadPolicy, ShouldTreatAsContinuingLoad shouldTreatAsContinuingLoad)
  {
<span class="line-modified">!     FRAMELOADER_RELEASE_LOG_IF_ALLOWED(ResourceLoading, &quot;loadDifferentDocumentItem: frame load started&quot;);</span>
  
      Ref&lt;Frame&gt; protectedFrame(m_frame);
  
      // History items should not be reported to the parent.
      m_shouldReportResourceTimingToParentFrame = false;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3740,11 ***</span>
  
      auto initiatedByMainFrame = InitiatedByMainFrame::Unknown;
  
      SetForScope&lt;LoadContinuingState&gt; continuingLoadGuard(m_currentLoadContinuingState, shouldTreatAsContinuingLoad == ShouldTreatAsContinuingLoad::Yes ? LoadContinuingState::ContinuingWithHistoryItem : LoadContinuingState::NotContinuing);
  
<span class="line-modified">!     if (CachedPage* cachedPage = PageCache::singleton().get(item, m_frame.page())) {</span>
          auto documentLoader = cachedPage-&gt;documentLoader();
          m_client.updateCachedDocumentLoader(*documentLoader);
  
          auto action = NavigationAction { *m_frame.document(), documentLoader-&gt;request(), initiatedByMainFrame, loadType, false };
          action.setTargetBackForwardItem(item);
<span class="line-new-header">--- 3762,11 ---</span>
  
      auto initiatedByMainFrame = InitiatedByMainFrame::Unknown;
  
      SetForScope&lt;LoadContinuingState&gt; continuingLoadGuard(m_currentLoadContinuingState, shouldTreatAsContinuingLoad == ShouldTreatAsContinuingLoad::Yes ? LoadContinuingState::ContinuingWithHistoryItem : LoadContinuingState::NotContinuing);
  
<span class="line-modified">!     if (CachedPage* cachedPage = BackForwardCache::singleton().get(item, m_frame.page())) {</span>
          auto documentLoader = cachedPage-&gt;documentLoader();
          m_client.updateCachedDocumentLoader(*documentLoader);
  
          auto action = NavigationAction { *m_frame.document(), documentLoader-&gt;request(), initiatedByMainFrame, loadType, false };
          action.setTargetBackForwardItem(item);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3869,11 ***</span>
      stopAllLoaders(ShouldNotClearProvisionalItem);
      if (item)
          loadDifferentDocumentItem(*item, history().currentItem(), loadType, MayNotAttemptCacheOnlyLoadForFormSubmissionItem, ShouldTreatAsContinuingLoad::No);
      else {
          ASSERT_NOT_REACHED();
<span class="line-modified">!         RELEASE_LOG_ERROR(ResourceLoading, &quot;Retrying load after failed cache-only main resource load failed because there is no provisional history item.&quot;);</span>
      }
  }
  
  ResourceError FrameLoader::cancelledError(const ResourceRequest&amp; request) const
  {
<span class="line-new-header">--- 3891,11 ---</span>
      stopAllLoaders(ShouldNotClearProvisionalItem);
      if (item)
          loadDifferentDocumentItem(*item, history().currentItem(), loadType, MayNotAttemptCacheOnlyLoadForFormSubmissionItem, ShouldTreatAsContinuingLoad::No);
      else {
          ASSERT_NOT_REACHED();
<span class="line-modified">!         FRAMELOADER_RELEASE_LOG_ERROR(ResourceLoading, &quot;retryAfterFailedCacheOnlyMainResourceLoad: Retrying load after failed cache-only main resource load failed because there is no provisional history item.&quot;);</span>
      }
  }
  
  ResourceError FrameLoader::cancelledError(const ResourceRequest&amp; request) const
  {
</pre>
<center><a href="FrameLoadRequest.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FrameLoader.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>