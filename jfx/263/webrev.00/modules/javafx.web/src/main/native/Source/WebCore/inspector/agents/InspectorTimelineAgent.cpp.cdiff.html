<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/InspectorTimelineAgent.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InspectorPageAgent.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="InspectorTimelineAgent.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/InspectorTimelineAgent.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 34,10 ***</span>
<span class="line-new-header">--- 34,11 ---</span>
  #include &quot;InspectorTimelineAgent.h&quot;
  
  #include &quot;DOMWindow.h&quot;
  #include &quot;Event.h&quot;
  #include &quot;Frame.h&quot;
<span class="line-added">+ #include &quot;InspectorAnimationAgent.h&quot;</span>
  #include &quot;InspectorCPUProfilerAgent.h&quot;
  #include &quot;InspectorClient.h&quot;
  #include &quot;InspectorController.h&quot;
  #include &quot;InspectorMemoryAgent.h&quot;
  #include &quot;InspectorPageAgent.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 47,12 ***</span>
  #include &quot;PageScriptDebugServer.h&quot;
  #include &quot;RenderView.h&quot;
  #include &quot;ScriptState.h&quot;
  #include &quot;TimelineRecordFactory.h&quot;
  #include &quot;WebConsoleAgent.h&quot;
  #include &lt;JavaScriptCore/ConsoleMessage.h&gt;
<span class="line-removed">- #include &lt;JavaScriptCore/InspectorDebuggerAgent.h&gt;</span>
  #include &lt;JavaScriptCore/InspectorScriptProfilerAgent.h&gt;
  #include &lt;JavaScriptCore/ScriptBreakpoint.h&gt;
  #include &lt;wtf/Stopwatch.h&gt;
  
  #if PLATFORM(IOS_FAMILY)
<span class="line-new-header">--- 48,12 ---</span>
  #include &quot;PageScriptDebugServer.h&quot;
  #include &quot;RenderView.h&quot;
  #include &quot;ScriptState.h&quot;
  #include &quot;TimelineRecordFactory.h&quot;
  #include &quot;WebConsoleAgent.h&quot;
<span class="line-added">+ #include &quot;WebDebuggerAgent.h&quot;</span>
  #include &lt;JavaScriptCore/ConsoleMessage.h&gt;
  #include &lt;JavaScriptCore/InspectorScriptProfilerAgent.h&gt;
  #include &lt;JavaScriptCore/ScriptBreakpoint.h&gt;
  #include &lt;wtf/Stopwatch.h&gt;
  
  #if PLATFORM(IOS_FAMILY)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 250,11 ***</span>
      // Complete all pending records to prevent discarding events that are currently in progress.
      while (!m_recordStack.isEmpty())
          didCompleteCurrentRecord(m_recordStack.last().type);
  #endif
  
<span class="line-modified">!     clearRecordStack();</span>
  
      m_tracking = false;
      m_startedComposite = false;
      m_autoCapturePhase = AutoCapturePhase::None;
  
<span class="line-new-header">--- 251,11 ---</span>
      // Complete all pending records to prevent discarding events that are currently in progress.
      while (!m_recordStack.isEmpty())
          didCompleteCurrentRecord(m_recordStack.last().type);
  #endif
  
<span class="line-modified">!     m_recordStack.clear();</span>
  
      m_tracking = false;
      m_startedComposite = false;
      m_autoCapturePhase = AutoCapturePhase::None;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 267,11 ***</span>
  double InspectorTimelineAgent::timestamp()
  {
      return m_environment.executionStopwatch()-&gt;elapsedTime().seconds();
  }
  
<span class="line-modified">! void InspectorTimelineAgent::startFromConsole(JSC::ExecState* exec, const String&amp; title)</span>
  {
      // Allow duplicate unnamed profiles. Disallow duplicate named profiles.
      if (!title.isEmpty()) {
          for (const TimelineRecordEntry&amp; record : m_pendingConsoleProfileRecords) {
              String recordTitle;
<span class="line-new-header">--- 268,11 ---</span>
  double InspectorTimelineAgent::timestamp()
  {
      return m_environment.executionStopwatch()-&gt;elapsedTime().seconds();
  }
  
<span class="line-modified">! void InspectorTimelineAgent::startFromConsole(JSC::JSGlobalObject* exec, const String&amp; title)</span>
  {
      // Allow duplicate unnamed profiles. Disallow duplicate named profiles.
      if (!title.isEmpty()) {
          for (const TimelineRecordEntry&amp; record : m_pendingConsoleProfileRecords) {
              String recordTitle;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 291,11 ***</span>
          startProgrammaticCapture();
  
      m_pendingConsoleProfileRecords.append(createRecordEntry(TimelineRecordFactory::createConsoleProfileData(title), TimelineRecordType::ConsoleProfile, true, frameFromExecState(exec)));
  }
  
<span class="line-modified">! void InspectorTimelineAgent::stopFromConsole(JSC::ExecState*, const String&amp; title)</span>
  {
      // Stop profiles in reverse order. If the title is empty, then stop the last profile.
      // Otherwise, match the title of the profile to stop.
      for (int i = m_pendingConsoleProfileRecords.size() - 1; i &gt;= 0; --i) {
          const TimelineRecordEntry&amp; record = m_pendingConsoleProfileRecords[i];
<span class="line-new-header">--- 292,11 ---</span>
          startProgrammaticCapture();
  
      m_pendingConsoleProfileRecords.append(createRecordEntry(TimelineRecordFactory::createConsoleProfileData(title), TimelineRecordType::ConsoleProfile, true, frameFromExecState(exec)));
  }
  
<span class="line-modified">! void InspectorTimelineAgent::stopFromConsole(JSC::JSGlobalObject*, const String&amp; title)</span>
  {
      // Stop profiles in reverse order. If the title is empty, then stop the last profile.
      // Otherwise, match the title of the profile to stop.
      for (int i = m_pendingConsoleProfileRecords.size() - 1; i &gt;= 0; --i) {
          const TimelineRecordEntry&amp; record = m_pendingConsoleProfileRecords[i];
</pre>
<hr />
<pre>
<span class="line-old-header">*** 335,10 ***</span>
<span class="line-new-header">--- 336,13 ---</span>
      pushCurrentRecord(TimelineRecordFactory::createEventDispatchData(event), TimelineRecordType::EventDispatch, false, frame);
  }
  
  void InspectorTimelineAgent::didDispatchEvent(bool defaultPrevented)
  {
<span class="line-added">+     if (m_recordStack.isEmpty())</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
      auto&amp; entry = m_recordStack.last();
      ASSERT(entry.type == TimelineRecordType::EventDispatch);
      entry.data-&gt;setBoolean(&quot;defaultPrevented&quot;_s, defaultPrevented);
  
      didCompleteCurrentRecord(TimelineRecordType::EventDispatch);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 403,10 ***</span>
<span class="line-new-header">--- 407,13 ---</span>
      pushCurrentRecord(JSON::Object::create(), TimelineRecordType::Paint, true, &amp;frame);
  }
  
  void InspectorTimelineAgent::didPaint(RenderObject&amp; renderer, const LayoutRect&amp; clipRect)
  {
<span class="line-added">+     if (m_recordStack.isEmpty())</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
      TimelineRecordEntry&amp; entry = m_recordStack.last();
      ASSERT(entry.type == TimelineRecordType::Paint);
      FloatQuad quad;
      localToPageQuad(renderer, clipRect, &amp;quad);
      entry.data = TimelineRecordFactory::createPaintData(quad);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 470,13 ***</span>
          return;
  
      m_autoCapturePhase = AutoCapturePhase::BeforeLoad;
  
      // Pre-emptively disable breakpoints. The frontend must re-enable them.
<span class="line-modified">!     if (InspectorDebuggerAgent* debuggerAgent = m_instrumentingAgents.inspectorDebuggerAgent()) {</span>
          ErrorString ignored;
<span class="line-modified">!         debuggerAgent-&gt;setBreakpointsActive(ignored, false);</span>
      }
  
      // Inform the frontend we started an auto capture. The frontend must stop capture.
      m_frontendDispatcher-&gt;autoCaptureStarted();
  
<span class="line-new-header">--- 477,13 ---</span>
          return;
  
      m_autoCapturePhase = AutoCapturePhase::BeforeLoad;
  
      // Pre-emptively disable breakpoints. The frontend must re-enable them.
<span class="line-modified">!     if (auto* webDebuggerAgent = m_instrumentingAgents.webDebuggerAgent()) {</span>
          ErrorString ignored;
<span class="line-modified">!         webDebuggerAgent-&gt;setBreakpointsActive(ignored, false);</span>
      }
  
      // Inform the frontend we started an auto capture. The frontend must stop capture.
      m_frontendDispatcher-&gt;autoCaptureStarted();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 495,15 ***</span>
  void InspectorTimelineAgent::startProgrammaticCapture()
  {
      ASSERT(!m_tracking);
  
      // Disable breakpoints during programmatic capture.
<span class="line-modified">!     if (InspectorDebuggerAgent* debuggerAgent = m_instrumentingAgents.inspectorDebuggerAgent()) {</span>
<span class="line-modified">!         m_programmaticCaptureRestoreBreakpointActiveValue = debuggerAgent-&gt;breakpointsActive();</span>
          if (m_programmaticCaptureRestoreBreakpointActiveValue) {
              ErrorString ignored;
<span class="line-modified">!             debuggerAgent-&gt;setBreakpointsActive(ignored, false);</span>
          }
      } else
          m_programmaticCaptureRestoreBreakpointActiveValue = false;
  
      toggleScriptProfilerInstrument(InstrumentState::Start); // Ensure JavaScript samping data.
<span class="line-new-header">--- 502,15 ---</span>
  void InspectorTimelineAgent::startProgrammaticCapture()
  {
      ASSERT(!m_tracking);
  
      // Disable breakpoints during programmatic capture.
<span class="line-modified">!     if (auto* webDebuggerAgent = m_instrumentingAgents.webDebuggerAgent()) {</span>
<span class="line-modified">!         m_programmaticCaptureRestoreBreakpointActiveValue = webDebuggerAgent-&gt;breakpointsActive();</span>
          if (m_programmaticCaptureRestoreBreakpointActiveValue) {
              ErrorString ignored;
<span class="line-modified">!             webDebuggerAgent-&gt;setBreakpointsActive(ignored, false);</span>
          }
      } else
          m_programmaticCaptureRestoreBreakpointActiveValue = false;
  
      toggleScriptProfilerInstrument(InstrumentState::Start); // Ensure JavaScript samping data.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 520,13 ***</span>
      toggleTimelineInstrument(InstrumentState::Stop);
      toggleScriptProfilerInstrument(InstrumentState::Stop);
  
      // Re-enable breakpoints if they were enabled.
      if (m_programmaticCaptureRestoreBreakpointActiveValue) {
<span class="line-modified">!         if (InspectorDebuggerAgent* debuggerAgent = m_instrumentingAgents.inspectorDebuggerAgent()) {</span>
              ErrorString ignored;
<span class="line-modified">!             debuggerAgent-&gt;setBreakpointsActive(ignored, true);</span>
          }
      }
  }
  
  void InspectorTimelineAgent::toggleInstruments(InstrumentState state)
<span class="line-new-header">--- 527,13 ---</span>
      toggleTimelineInstrument(InstrumentState::Stop);
      toggleScriptProfilerInstrument(InstrumentState::Stop);
  
      // Re-enable breakpoints if they were enabled.
      if (m_programmaticCaptureRestoreBreakpointActiveValue) {
<span class="line-modified">!         if (auto* webDebuggerAgent = m_instrumentingAgents.webDebuggerAgent()) {</span>
              ErrorString ignored;
<span class="line-modified">!             webDebuggerAgent-&gt;setBreakpointsActive(ignored, true);</span>
          }
      }
  }
  
  void InspectorTimelineAgent::toggleInstruments(InstrumentState state)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 550,10 ***</span>
<span class="line-new-header">--- 557,13 ---</span>
              break;
          }
          case Inspector::Protocol::Timeline::Instrument::Timeline:
              toggleTimelineInstrument(state);
              break;
<span class="line-added">+         case Inspector::Protocol::Timeline::Instrument::Animation:</span>
<span class="line-added">+             toggleAnimationInstrument(state);</span>
<span class="line-added">+             break;</span>
          }
      }
  }
  
  void InspectorTimelineAgent::toggleScriptProfilerInstrument(InstrumentState state)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 616,10 ***</span>
<span class="line-new-header">--- 626,21 ---</span>
          internalStart();
      else
          internalStop();
  }
  
<span class="line-added">+ void InspectorTimelineAgent::toggleAnimationInstrument(InstrumentState state)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (auto* animationAgent = m_instrumentingAgents.persistentInspectorAnimationAgent()) {</span>
<span class="line-added">+         ErrorString ignored;</span>
<span class="line-added">+         if (state == InstrumentState::Start)</span>
<span class="line-added">+             animationAgent-&gt;startTracking(ignored);</span>
<span class="line-added">+         else</span>
<span class="line-added">+             animationAgent-&gt;stopTracking(ignored);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  void InspectorTimelineAgent::didRequestAnimationFrame(int callbackId, Frame* frame)
  {
      appendRecord(TimelineRecordFactory::createAnimationFrameData(callbackId), TimelineRecordType::RequestAnimationFrame, true, frame);
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 648,13 ***</span>
      didCompleteCurrentRecord(TimelineRecordType::ObserverCallback);
  }
  
  // ScriptDebugListener
  
<span class="line-modified">! void InspectorTimelineAgent::breakpointActionProbe(JSC::ExecState&amp; state, const Inspector::ScriptBreakpointAction&amp; action, unsigned /*batchId*/, unsigned sampleId, JSC::JSValue)</span>
  {
<span class="line-modified">!     appendRecord(TimelineRecordFactory::createProbeSampleData(action, sampleId), TimelineRecordType::ProbeSample, false, frameFromExecState(&amp;state));</span>
  }
  
  static Inspector::Protocol::Timeline::EventType toProtocol(TimelineRecordType type)
  {
      switch (type) {
<span class="line-new-header">--- 669,13 ---</span>
      didCompleteCurrentRecord(TimelineRecordType::ObserverCallback);
  }
  
  // ScriptDebugListener
  
<span class="line-modified">! void InspectorTimelineAgent::breakpointActionProbe(JSC::JSGlobalObject* lexicalGlobalObject, const Inspector::ScriptBreakpointAction&amp; action, unsigned /*batchId*/, unsigned sampleId, JSC::JSValue)</span>
  {
<span class="line-modified">!     appendRecord(TimelineRecordFactory::createProbeSampleData(action, sampleId), TimelineRecordType::ProbeSample, false, frameFromExecState(lexicalGlobalObject));</span>
  }
  
  static Inspector::Protocol::Timeline::EventType toProtocol(TimelineRecordType type)
  {
      switch (type) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 793,16 ***</span>
  void InspectorTimelineAgent::pushCurrentRecord(RefPtr&lt;JSON::Object&gt;&amp;&amp; data, TimelineRecordType type, bool captureCallStack, Frame* frame)
  {
      pushCurrentRecord(createRecordEntry(WTFMove(data), type, captureCallStack, frame));
  }
  
<span class="line-removed">- void InspectorTimelineAgent::clearRecordStack()</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     m_recordStack.clear();</span>
<span class="line-removed">-     m_id++;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  void InspectorTimelineAgent::localToPageQuad(const RenderObject&amp; renderer, const LayoutRect&amp; rect, FloatQuad* quad)
  {
      const FrameView&amp; frameView = renderer.view().frameView();
      FloatQuad absolute = renderer.localToAbsoluteQuad(FloatQuad(rect));
      quad-&gt;setP1(frameView.contentsToRootView(roundedIntPoint(absolute.p1())));
<span class="line-new-header">--- 814,10 ---</span>
</pre>
<center><a href="InspectorPageAgent.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="InspectorTimelineAgent.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>