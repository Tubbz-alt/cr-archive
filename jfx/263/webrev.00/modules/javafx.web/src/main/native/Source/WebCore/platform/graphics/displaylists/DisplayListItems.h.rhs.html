<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/displaylists/DisplayListItems.h</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (C) 2015 Apple Inc. All rights reserved.
   3  *
   4  * Redistribution and use in source and binary forms, with or without
   5  * modification, are permitted provided that the following conditions
   6  * are met:
   7  * 1. Redistributions of source code must retain the above copyright
   8  *    notice, this list of conditions and the following disclaimer.
   9  * 2. Redistributions in binary form must reproduce the above copyright
  10  *    notice, this list of conditions and the following disclaimer in the
  11  *    documentation and/or other materials provided with the distribution.
  12  *
  13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
  14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
  16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
  17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
  18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
  19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
  20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
  21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
  23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  24  */
  25 
  26 #pragma once
  27 
<a name="1" id="anc1"></a><span class="line-added">  28 #include &quot;DisplayList.h&quot;</span>
  29 #include &quot;FloatPoint.h&quot;
<a name="2" id="anc2"></a>
  30 #include &quot;FloatRoundedRect.h&quot;
  31 #include &quot;Font.h&quot;
  32 #include &quot;GlyphBuffer.h&quot;
<a name="3" id="anc3"></a>
  33 #include &quot;Image.h&quot;
<a name="4" id="anc4"></a><span class="line-added">  34 #include &quot;Pattern.h&quot;</span>
  35 #include &lt;wtf/RefCounted.h&gt;
  36 #include &lt;wtf/TypeCasts.h&gt;
  37 
<a name="5" id="anc5"></a>



  38 namespace WTF {
  39 class TextStream;
  40 }
  41 
  42 namespace WebCore {
  43 
  44 struct ImagePaintingOptions;
  45 
  46 namespace DisplayList {
  47 
<a name="6" id="anc6"></a>














































































































  48 class DrawingItem : public Item {
  49 public:
<a name="7" id="anc7"></a><span class="line-modified">  50     WEBCORE_EXPORT explicit DrawingItem(ItemType);</span>
<span class="line-modified">  51 </span>
<span class="line-modified">  52     WEBCORE_EXPORT virtual ~DrawingItem();</span>

  53 
  54     void setExtent(const FloatRect&amp; r) { m_extent = r; }
  55     const FloatRect&amp; extent() const { return m_extent.value(); }
  56 
  57     bool extentKnown() const { return static_cast&lt;bool&gt;(m_extent); }
  58 
  59     // Return bounds of this drawing operation in local coordinates.
  60     // Does not include effets of transform, shadow etc in the state.
  61     virtual Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const { return WTF::nullopt; }
  62 
  63 private:
  64     bool isDrawingItem() const override { return true; }
  65 
  66     Optional&lt;FloatRect&gt; m_extent; // In base coordinates, taking shadows and transforms into account.
  67 };
  68 
  69 class Save : public Item {
  70 public:
  71     static Ref&lt;Save&gt; create()
  72     {
  73         return adoptRef(*new Save);
  74     }
  75 
<a name="8" id="anc8"></a><span class="line-added">  76     WEBCORE_EXPORT virtual ~Save();</span>
<span class="line-added">  77 </span>
  78     // Index in the display list of the corresponding Restore item. 0 if unmatched.
  79     size_t restoreIndex() const { return m_restoreIndex; }
  80     void setRestoreIndex(size_t index) { m_restoreIndex = index; }
  81 
<a name="9" id="anc9"></a><span class="line-added">  82     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">  83     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;Save&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">  84 </span>
  85 private:
<a name="10" id="anc10"></a><span class="line-modified">  86     WEBCORE_EXPORT Save();</span>



  87 
  88     void apply(GraphicsContext&amp;) const override;
  89 
  90     size_t m_restoreIndex { 0 };
  91 };
  92 
<a name="11" id="anc11"></a><span class="line-added">  93 template&lt;class Encoder&gt;</span>
<span class="line-added">  94 void Save::encode(Encoder&amp; encoder) const</span>
<span class="line-added">  95 {</span>
<span class="line-added">  96     encoder &lt;&lt; static_cast&lt;uint64_t&gt;(m_restoreIndex);</span>
<span class="line-added">  97 }</span>
<span class="line-added">  98 </span>
<span class="line-added">  99 template&lt;class Decoder&gt;</span>
<span class="line-added"> 100 Optional&lt;Ref&lt;Save&gt;&gt; Save::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 101 {</span>
<span class="line-added"> 102     Optional&lt;uint64_t&gt; restoreIndex;</span>
<span class="line-added"> 103     decoder &gt;&gt; restoreIndex;</span>
<span class="line-added"> 104     if (!restoreIndex)</span>
<span class="line-added"> 105         return WTF::nullopt;</span>
<span class="line-added"> 106 </span>
<span class="line-added"> 107     // FIXME: Validate restoreIndex? But we don&#39;t have the list context here.</span>
<span class="line-added"> 108     auto save = Save::create();</span>
<span class="line-added"> 109     save-&gt;setRestoreIndex(static_cast&lt;size_t&gt;(*restoreIndex));</span>
<span class="line-added"> 110     return save;</span>
<span class="line-added"> 111 }</span>
<span class="line-added"> 112 </span>
 113 class Restore : public Item {
 114 public:
 115     static Ref&lt;Restore&gt; create()
 116     {
 117         return adoptRef(*new Restore);
 118     }
 119 
<a name="12" id="anc12"></a><span class="line-added"> 120     WEBCORE_EXPORT virtual ~Restore();</span>
<span class="line-added"> 121 </span>
<span class="line-added"> 122     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 123     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;Restore&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 124 </span>
 125 private:
<a name="13" id="anc13"></a><span class="line-modified"> 126     WEBCORE_EXPORT Restore();</span>



 127 
 128     void apply(GraphicsContext&amp;) const override;
 129 };
 130 
<a name="14" id="anc14"></a><span class="line-added"> 131 template&lt;class Encoder&gt;</span>
<span class="line-added"> 132 void Restore::encode(Encoder&amp;) const</span>
<span class="line-added"> 133 {</span>
<span class="line-added"> 134 }</span>
<span class="line-added"> 135 </span>
<span class="line-added"> 136 template&lt;class Decoder&gt;</span>
<span class="line-added"> 137 Optional&lt;Ref&lt;Restore&gt;&gt; Restore::decode(Decoder&amp;)</span>
<span class="line-added"> 138 {</span>
<span class="line-added"> 139     return Restore::create();</span>
<span class="line-added"> 140 }</span>
<span class="line-added"> 141 </span>
 142 class Translate : public Item {
 143 public:
 144     static Ref&lt;Translate&gt; create(float x, float y)
 145     {
 146         return adoptRef(*new Translate(x, y));
 147     }
 148 
<a name="15" id="anc15"></a><span class="line-added"> 149     WEBCORE_EXPORT virtual ~Translate();</span>
<span class="line-added"> 150 </span>
 151     float x() const { return m_x; }
 152     float y() const { return m_y; }
 153 
<a name="16" id="anc16"></a><span class="line-added"> 154     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 155     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;Translate&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 156 </span>
 157 private:
<a name="17" id="anc17"></a><span class="line-modified"> 158     WEBCORE_EXPORT Translate(float x, float y);</span>





 159 
 160     void apply(GraphicsContext&amp;) const override;
 161 
 162     float m_x;
 163     float m_y;
 164 };
 165 
<a name="18" id="anc18"></a><span class="line-added"> 166 template&lt;class Encoder&gt;</span>
<span class="line-added"> 167 void Translate::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 168 {</span>
<span class="line-added"> 169     encoder &lt;&lt; m_x;</span>
<span class="line-added"> 170     encoder &lt;&lt; m_y;</span>
<span class="line-added"> 171 }</span>
<span class="line-added"> 172 </span>
<span class="line-added"> 173 template&lt;class Decoder&gt;</span>
<span class="line-added"> 174 Optional&lt;Ref&lt;Translate&gt;&gt; Translate::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 175 {</span>
<span class="line-added"> 176     Optional&lt;float&gt; x;</span>
<span class="line-added"> 177     decoder &gt;&gt; x;</span>
<span class="line-added"> 178     if (!x)</span>
<span class="line-added"> 179         return WTF::nullopt;</span>
<span class="line-added"> 180 </span>
<span class="line-added"> 181     Optional&lt;float&gt; y;</span>
<span class="line-added"> 182     decoder &gt;&gt; y;</span>
<span class="line-added"> 183     if (!y)</span>
<span class="line-added"> 184         return WTF::nullopt;</span>
<span class="line-added"> 185 </span>
<span class="line-added"> 186     return Translate::create(*x, *y);</span>
<span class="line-added"> 187 }</span>
<span class="line-added"> 188 </span>
 189 class Rotate : public Item {
 190 public:
 191     static Ref&lt;Rotate&gt; create(float angleInRadians)
 192     {
 193         return adoptRef(*new Rotate(angleInRadians));
 194     }
 195 
<a name="19" id="anc19"></a><span class="line-added"> 196     WEBCORE_EXPORT virtual ~Rotate();</span>
<span class="line-added"> 197 </span>
 198     float angle() const { return m_angle; }
 199 
<a name="20" id="anc20"></a><span class="line-added"> 200     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 201     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;Rotate&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 202 </span>
 203 private:
<a name="21" id="anc21"></a><span class="line-modified"> 204     WEBCORE_EXPORT Rotate(float angle);</span>




 205 
 206     void apply(GraphicsContext&amp;) const override;
 207 
 208     float m_angle; // In radians.
 209 };
 210 
<a name="22" id="anc22"></a><span class="line-added"> 211 template&lt;class Encoder&gt;</span>
<span class="line-added"> 212 void Rotate::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 213 {</span>
<span class="line-added"> 214     encoder &lt;&lt; m_angle;</span>
<span class="line-added"> 215 }</span>
<span class="line-added"> 216 </span>
<span class="line-added"> 217 template&lt;class Decoder&gt;</span>
<span class="line-added"> 218 Optional&lt;Ref&lt;Rotate&gt;&gt; Rotate::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 219 {</span>
<span class="line-added"> 220     Optional&lt;float&gt; angle;</span>
<span class="line-added"> 221     decoder &gt;&gt; angle;</span>
<span class="line-added"> 222     if (!angle)</span>
<span class="line-added"> 223         return WTF::nullopt;</span>
<span class="line-added"> 224 </span>
<span class="line-added"> 225     return Rotate::create(*angle);</span>
<span class="line-added"> 226 }</span>
<span class="line-added"> 227 </span>
 228 class Scale : public Item {
 229 public:
 230     static Ref&lt;Scale&gt; create(const FloatSize&amp; size)
 231     {
 232         return adoptRef(*new Scale(size));
 233     }
 234 
<a name="23" id="anc23"></a><span class="line-added"> 235     WEBCORE_EXPORT virtual ~Scale();</span>
<span class="line-added"> 236 </span>
 237     const FloatSize&amp; amount() const { return m_size; }
 238 
<a name="24" id="anc24"></a><span class="line-added"> 239     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 240     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;Scale&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 241 </span>
 242 private:
<a name="25" id="anc25"></a><span class="line-modified"> 243     WEBCORE_EXPORT Scale(const FloatSize&amp;);</span>
<span class="line-modified"> 244 </span>
<span class="line-modified"> 245     void apply(GraphicsContext&amp;) const override;</span>
<span class="line-added"> 246 </span>
<span class="line-added"> 247     FloatSize m_size;</span>
<span class="line-added"> 248 };</span>
<span class="line-added"> 249 </span>
<span class="line-added"> 250 template&lt;class Encoder&gt;</span>
<span class="line-added"> 251 void Scale::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 252 {</span>
<span class="line-added"> 253     encoder &lt;&lt; m_size;</span>
<span class="line-added"> 254 }</span>
<span class="line-added"> 255 </span>
<span class="line-added"> 256 template&lt;class Decoder&gt;</span>
<span class="line-added"> 257 Optional&lt;Ref&lt;Scale&gt;&gt; Scale::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 258 {</span>
<span class="line-added"> 259     Optional&lt;FloatSize&gt; scale;</span>
<span class="line-added"> 260     decoder &gt;&gt; scale;</span>
<span class="line-added"> 261     if (!scale)</span>
<span class="line-added"> 262         return WTF::nullopt;</span>
<span class="line-added"> 263 </span>
<span class="line-added"> 264     return Scale::create(*scale);</span>
<span class="line-added"> 265 }</span>
<span class="line-added"> 266 </span>
<span class="line-added"> 267 class SetCTM : public Item {</span>
<span class="line-added"> 268 public:</span>
<span class="line-added"> 269     static Ref&lt;SetCTM&gt; create(const AffineTransform&amp; matrix)</span>
 270     {
<a name="26" id="anc26"></a><span class="line-added"> 271         return adoptRef(*new SetCTM(matrix));</span>
 272     }
 273 
<a name="27" id="anc27"></a><span class="line-added"> 274     WEBCORE_EXPORT virtual ~SetCTM();</span>
<span class="line-added"> 275 </span>
<span class="line-added"> 276     const AffineTransform&amp; transform() const { return m_transform; }</span>
<span class="line-added"> 277 </span>
<span class="line-added"> 278     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 279     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;SetCTM&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 280 </span>
<span class="line-added"> 281 private:</span>
<span class="line-added"> 282     WEBCORE_EXPORT SetCTM(const AffineTransform&amp;);</span>
<span class="line-added"> 283 </span>
 284     void apply(GraphicsContext&amp;) const override;
 285 
<a name="28" id="anc28"></a><span class="line-modified"> 286     AffineTransform m_transform;</span>
 287 };
 288 
<a name="29" id="anc29"></a><span class="line-added"> 289 template&lt;class Encoder&gt;</span>
<span class="line-added"> 290 void SetCTM::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 291 {</span>
<span class="line-added"> 292     encoder &lt;&lt; m_transform;</span>
<span class="line-added"> 293 }</span>
<span class="line-added"> 294 </span>
<span class="line-added"> 295 template&lt;class Decoder&gt;</span>
<span class="line-added"> 296 Optional&lt;Ref&lt;SetCTM&gt;&gt; SetCTM::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 297 {</span>
<span class="line-added"> 298     Optional&lt;AffineTransform&gt; transform;</span>
<span class="line-added"> 299     decoder &gt;&gt; transform;</span>
<span class="line-added"> 300     if (!transform)</span>
<span class="line-added"> 301         return WTF::nullopt;</span>
<span class="line-added"> 302 </span>
<span class="line-added"> 303     return SetCTM::create(*transform);</span>
<span class="line-added"> 304 }</span>
<span class="line-added"> 305 </span>
 306 class ConcatenateCTM : public Item {
 307 public:
 308     static Ref&lt;ConcatenateCTM&gt; create(const AffineTransform&amp; matrix)
 309     {
 310         return adoptRef(*new ConcatenateCTM(matrix));
 311     }
 312 
<a name="30" id="anc30"></a><span class="line-added"> 313     WEBCORE_EXPORT virtual ~ConcatenateCTM();</span>
<span class="line-added"> 314 </span>
 315     const AffineTransform&amp; transform() const { return m_transform; }
 316 
<a name="31" id="anc31"></a><span class="line-added"> 317     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 318     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;ConcatenateCTM&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 319 </span>
 320 private:
<a name="32" id="anc32"></a><span class="line-modified"> 321     WEBCORE_EXPORT ConcatenateCTM(const AffineTransform&amp;);</span>
 322 
 323     void apply(GraphicsContext&amp;) const override;
 324 
 325     AffineTransform m_transform;
 326 };
 327 
<a name="33" id="anc33"></a><span class="line-added"> 328 template&lt;class Encoder&gt;</span>
<span class="line-added"> 329 void ConcatenateCTM::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 330 {</span>
<span class="line-added"> 331     encoder &lt;&lt; m_transform;</span>
<span class="line-added"> 332 }</span>
<span class="line-added"> 333 </span>
<span class="line-added"> 334 template&lt;class Decoder&gt;</span>
<span class="line-added"> 335 Optional&lt;Ref&lt;ConcatenateCTM&gt;&gt; ConcatenateCTM::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 336 {</span>
<span class="line-added"> 337     Optional&lt;AffineTransform&gt; transform;</span>
<span class="line-added"> 338     decoder &gt;&gt; transform;</span>
<span class="line-added"> 339     if (!transform)</span>
<span class="line-added"> 340         return WTF::nullopt;</span>
<span class="line-added"> 341 </span>
<span class="line-added"> 342     return ConcatenateCTM::create(*transform);</span>
<span class="line-added"> 343 }</span>
<span class="line-added"> 344 </span>
 345 class SetState : public Item {
 346 public:
 347     static Ref&lt;SetState&gt; create(const GraphicsContextState&amp; state, GraphicsContextState::StateChangeFlags flags)
 348     {
 349         return adoptRef(*new SetState(state, flags));
 350     }
 351 
<a name="34" id="anc34"></a><span class="line-added"> 352     static Ref&lt;SetState&gt; create(const GraphicsContextStateChange&amp; stateChange)</span>
<span class="line-added"> 353     {</span>
<span class="line-added"> 354         return adoptRef(*new SetState(stateChange));</span>
<span class="line-added"> 355     }</span>
<span class="line-added"> 356 </span>
<span class="line-added"> 357     WEBCORE_EXPORT virtual ~SetState();</span>
<span class="line-added"> 358 </span>
 359     const GraphicsContextStateChange&amp; state() const { return m_state; }
 360 
 361     void accumulate(const GraphicsContextState&amp;, GraphicsContextState::StateChangeFlags);
 362 
 363     void accumulate(GraphicsContextState&amp;) const;
 364 
<a name="35" id="anc35"></a><span class="line-modified"> 365     static void builderState(GraphicsContext&amp;, const GraphicsContextState&amp;, GraphicsContextState::StateChangeFlags);</span>
 366 
 367     static void dumpStateChanges(WTF::TextStream&amp;, const GraphicsContextState&amp;, GraphicsContextState::StateChangeFlags);
<a name="36" id="anc36"></a><span class="line-added"> 368 </span>
<span class="line-added"> 369     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 370     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;SetState&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 371 </span>
 372 private:
<a name="37" id="anc37"></a><span class="line-modified"> 373     WEBCORE_EXPORT SetState(const GraphicsContextState&amp;, GraphicsContextState::StateChangeFlags);</span>
<span class="line-modified"> 374     WEBCORE_EXPORT SetState(const GraphicsContextStateChange&amp;);</span>



 375 
 376     void apply(GraphicsContext&amp;) const override;
 377 
 378     GraphicsContextStateChange m_state;
 379 };
 380 
<a name="38" id="anc38"></a><span class="line-added"> 381 template&lt;class Encoder&gt;</span>
<span class="line-added"> 382 void SetState::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 383 {</span>
<span class="line-added"> 384     auto changeFlags = m_state.m_changeFlags;</span>
<span class="line-added"> 385     encoder &lt;&lt; changeFlags;</span>
<span class="line-added"> 386 </span>
<span class="line-added"> 387     auto&amp; state = m_state.m_state;</span>
<span class="line-added"> 388 </span>
<span class="line-added"> 389     if (changeFlags.contains(GraphicsContextState::StrokeGradientChange)) {</span>
<span class="line-added"> 390         encoder &lt;&lt; !!state.strokeGradient;</span>
<span class="line-added"> 391         if (state.strokeGradient)</span>
<span class="line-added"> 392             encoder &lt;&lt; *state.strokeGradient;</span>
<span class="line-added"> 393     }</span>
<span class="line-added"> 394 </span>
<span class="line-added"> 395     if (changeFlags.contains(GraphicsContextState::StrokePatternChange)) {</span>
<span class="line-added"> 396         encoder &lt;&lt; !!state.strokePattern;</span>
<span class="line-added"> 397         if (state.strokePattern)</span>
<span class="line-added"> 398             encoder &lt;&lt; *state.strokePattern;</span>
<span class="line-added"> 399     }</span>
<span class="line-added"> 400 </span>
<span class="line-added"> 401     if (changeFlags.contains(GraphicsContextState::FillGradientChange)) {</span>
<span class="line-added"> 402         encoder &lt;&lt; !!state.fillGradient;</span>
<span class="line-added"> 403         if (state.fillGradient)</span>
<span class="line-added"> 404             encoder &lt;&lt; *state.fillGradient;</span>
<span class="line-added"> 405     }</span>
<span class="line-added"> 406 </span>
<span class="line-added"> 407     if (changeFlags.contains(GraphicsContextState::FillPatternChange)) {</span>
<span class="line-added"> 408         encoder &lt;&lt; !!state.fillPattern;</span>
<span class="line-added"> 409         if (state.fillPattern)</span>
<span class="line-added"> 410             encoder &lt;&lt; *state.fillPattern;</span>
<span class="line-added"> 411     }</span>
<span class="line-added"> 412 </span>
<span class="line-added"> 413     if (changeFlags.contains(GraphicsContextState::ShadowChange)) {</span>
<span class="line-added"> 414         encoder &lt;&lt; state.shadowOffset;</span>
<span class="line-added"> 415         encoder &lt;&lt; state.shadowBlur;</span>
<span class="line-added"> 416         encoder &lt;&lt; state.shadowColor;</span>
<span class="line-added"> 417 #if USE(CG)</span>
<span class="line-added"> 418         encoder &lt;&lt; state.shadowsUseLegacyRadius;</span>
<span class="line-added"> 419 #endif // USE(CG)</span>
<span class="line-added"> 420     }</span>
<span class="line-added"> 421 </span>
<span class="line-added"> 422     if (changeFlags.contains(GraphicsContextState::StrokeThicknessChange))</span>
<span class="line-added"> 423         encoder &lt;&lt; state.strokeThickness;</span>
<span class="line-added"> 424 </span>
<span class="line-added"> 425     if (changeFlags.contains(GraphicsContextState::TextDrawingModeChange))</span>
<span class="line-added"> 426         encoder.encodeEnum(state.textDrawingMode);</span>
<span class="line-added"> 427 </span>
<span class="line-added"> 428     if (changeFlags.contains(GraphicsContextState::StrokeColorChange))</span>
<span class="line-added"> 429         encoder &lt;&lt; state.strokeColor;</span>
<span class="line-added"> 430 </span>
<span class="line-added"> 431     if (changeFlags.contains(GraphicsContextState::FillColorChange))</span>
<span class="line-added"> 432         encoder &lt;&lt; state.fillColor;</span>
<span class="line-added"> 433 </span>
<span class="line-added"> 434     if (changeFlags.contains(GraphicsContextState::StrokeStyleChange))</span>
<span class="line-added"> 435         encoder.encodeEnum(state.strokeStyle);</span>
<span class="line-added"> 436 </span>
<span class="line-added"> 437     if (changeFlags.contains(GraphicsContextState::FillRuleChange))</span>
<span class="line-added"> 438         encoder &lt;&lt; state.fillRule;</span>
<span class="line-added"> 439 </span>
<span class="line-added"> 440     if (changeFlags.contains(GraphicsContextState::CompositeOperationChange))</span>
<span class="line-added"> 441         encoder &lt;&lt; state.compositeOperator;</span>
<span class="line-added"> 442 </span>
<span class="line-added"> 443     if (changeFlags.contains(GraphicsContextState::BlendModeChange))</span>
<span class="line-added"> 444         encoder &lt;&lt; state.blendMode;</span>
<span class="line-added"> 445 </span>
<span class="line-added"> 446     if (changeFlags.contains(GraphicsContextState::ImageInterpolationQualityChange))</span>
<span class="line-added"> 447         encoder &lt;&lt; state.imageInterpolationQuality;</span>
<span class="line-added"> 448 </span>
<span class="line-added"> 449     if (changeFlags.contains(GraphicsContextState::AlphaChange))</span>
<span class="line-added"> 450         encoder &lt;&lt; state.alpha;</span>
<span class="line-added"> 451 </span>
<span class="line-added"> 452     if (changeFlags.contains(GraphicsContextState::ShouldAntialiasChange))</span>
<span class="line-added"> 453         encoder &lt;&lt; state.shouldAntialias;</span>
<span class="line-added"> 454 </span>
<span class="line-added"> 455     if (changeFlags.contains(GraphicsContextState::ShouldSmoothFontsChange))</span>
<span class="line-added"> 456         encoder &lt;&lt; state.shouldSmoothFonts;</span>
<span class="line-added"> 457 </span>
<span class="line-added"> 458     if (changeFlags.contains(GraphicsContextState::ShouldSubpixelQuantizeFontsChange))</span>
<span class="line-added"> 459         encoder &lt;&lt; state.shouldSubpixelQuantizeFonts;</span>
<span class="line-added"> 460 </span>
<span class="line-added"> 461     if (changeFlags.contains(GraphicsContextState::ShadowsIgnoreTransformsChange))</span>
<span class="line-added"> 462         encoder &lt;&lt; state.shadowsIgnoreTransforms;</span>
<span class="line-added"> 463 }</span>
<span class="line-added"> 464 </span>
<span class="line-added"> 465 template&lt;class Decoder&gt;</span>
<span class="line-added"> 466 Optional&lt;Ref&lt;SetState&gt;&gt; SetState::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 467 {</span>
<span class="line-added"> 468     Optional&lt;GraphicsContextState::StateChangeFlags&gt; changeFlags;</span>
<span class="line-added"> 469     decoder &gt;&gt; changeFlags;</span>
<span class="line-added"> 470     if (!changeFlags)</span>
<span class="line-added"> 471         return WTF::nullopt;</span>
<span class="line-added"> 472 </span>
<span class="line-added"> 473     GraphicsContextStateChange stateChange;</span>
<span class="line-added"> 474     stateChange.m_changeFlags = *changeFlags;</span>
<span class="line-added"> 475 </span>
<span class="line-added"> 476     if (stateChange.m_changeFlags.contains(GraphicsContextState::StrokeGradientChange)) {</span>
<span class="line-added"> 477         Optional&lt;bool&gt; hasStrokeGradient;</span>
<span class="line-added"> 478         decoder &gt;&gt; hasStrokeGradient;</span>
<span class="line-added"> 479         if (!hasStrokeGradient.hasValue())</span>
<span class="line-added"> 480             return WTF::nullopt;</span>
<span class="line-added"> 481 </span>
<span class="line-added"> 482         if (hasStrokeGradient.value()) {</span>
<span class="line-added"> 483             auto strokeGradient = Gradient::decode(decoder);</span>
<span class="line-added"> 484             if (!strokeGradient)</span>
<span class="line-added"> 485                 return WTF::nullopt;</span>
<span class="line-added"> 486 </span>
<span class="line-added"> 487             stateChange.m_state.strokeGradient = WTFMove(*strokeGradient);</span>
<span class="line-added"> 488         }</span>
<span class="line-added"> 489     }</span>
<span class="line-added"> 490 </span>
<span class="line-added"> 491     if (stateChange.m_changeFlags.contains(GraphicsContextState::StrokePatternChange)) {</span>
<span class="line-added"> 492         Optional&lt;bool&gt; hasStrokePattern;</span>
<span class="line-added"> 493         decoder &gt;&gt; hasStrokePattern;</span>
<span class="line-added"> 494         if (!hasStrokePattern.hasValue())</span>
<span class="line-added"> 495             return WTF::nullopt;</span>
<span class="line-added"> 496 </span>
<span class="line-added"> 497         if (hasStrokePattern.value()) {</span>
<span class="line-added"> 498             auto strokePattern = Pattern::decode(decoder);</span>
<span class="line-added"> 499             if (!strokePattern)</span>
<span class="line-added"> 500                 return WTF::nullopt;</span>
<span class="line-added"> 501 </span>
<span class="line-added"> 502             stateChange.m_state.strokePattern = WTFMove(*strokePattern);</span>
<span class="line-added"> 503         }</span>
<span class="line-added"> 504     }</span>
<span class="line-added"> 505 </span>
<span class="line-added"> 506     if (stateChange.m_changeFlags.contains(GraphicsContextState::FillGradientChange)) {</span>
<span class="line-added"> 507         Optional&lt;bool&gt; hasFillGradient;</span>
<span class="line-added"> 508         decoder &gt;&gt; hasFillGradient;</span>
<span class="line-added"> 509         if (!hasFillGradient.hasValue())</span>
<span class="line-added"> 510             return WTF::nullopt;</span>
<span class="line-added"> 511 </span>
<span class="line-added"> 512         if (hasFillGradient.value()) {</span>
<span class="line-added"> 513             auto fillGradient = Gradient::decode(decoder);</span>
<span class="line-added"> 514             if (!fillGradient)</span>
<span class="line-added"> 515                 return WTF::nullopt;</span>
<span class="line-added"> 516 </span>
<span class="line-added"> 517             stateChange.m_state.fillGradient = WTFMove(*fillGradient);</span>
<span class="line-added"> 518         }</span>
<span class="line-added"> 519     }</span>
<span class="line-added"> 520 </span>
<span class="line-added"> 521     if (stateChange.m_changeFlags.contains(GraphicsContextState::FillPatternChange)) {</span>
<span class="line-added"> 522         Optional&lt;bool&gt; hasFillPattern;</span>
<span class="line-added"> 523         decoder &gt;&gt; hasFillPattern;</span>
<span class="line-added"> 524         if (!hasFillPattern.hasValue())</span>
<span class="line-added"> 525             return WTF::nullopt;</span>
<span class="line-added"> 526 </span>
<span class="line-added"> 527         if (hasFillPattern.value()) {</span>
<span class="line-added"> 528             auto fillPattern = Pattern::decode(decoder);</span>
<span class="line-added"> 529             if (!fillPattern)</span>
<span class="line-added"> 530                 return WTF::nullopt;</span>
<span class="line-added"> 531 </span>
<span class="line-added"> 532             stateChange.m_state.fillPattern = WTFMove(*fillPattern);</span>
<span class="line-added"> 533         }</span>
<span class="line-added"> 534     }</span>
<span class="line-added"> 535 </span>
<span class="line-added"> 536     if (stateChange.m_changeFlags.contains(GraphicsContextState::ShadowChange)) {</span>
<span class="line-added"> 537         Optional&lt;FloatSize&gt; shadowOffset;</span>
<span class="line-added"> 538         decoder &gt;&gt; shadowOffset;</span>
<span class="line-added"> 539         if (!shadowOffset)</span>
<span class="line-added"> 540             return WTF::nullopt;</span>
<span class="line-added"> 541 </span>
<span class="line-added"> 542         stateChange.m_state.shadowOffset = *shadowOffset;</span>
<span class="line-added"> 543 </span>
<span class="line-added"> 544         Optional&lt;float&gt; shadowBlur;</span>
<span class="line-added"> 545         decoder &gt;&gt; shadowBlur;</span>
<span class="line-added"> 546         if (!shadowBlur)</span>
<span class="line-added"> 547             return WTF::nullopt;</span>
<span class="line-added"> 548 </span>
<span class="line-added"> 549         stateChange.m_state.shadowBlur = *shadowBlur;</span>
<span class="line-added"> 550 </span>
<span class="line-added"> 551         Optional&lt;Color&gt; shadowColor;</span>
<span class="line-added"> 552         decoder &gt;&gt; shadowColor;</span>
<span class="line-added"> 553         if (!shadowColor)</span>
<span class="line-added"> 554             return WTF::nullopt;</span>
<span class="line-added"> 555 </span>
<span class="line-added"> 556         stateChange.m_state.shadowColor = *shadowColor;</span>
<span class="line-added"> 557 </span>
<span class="line-added"> 558 #if USE(CG)</span>
<span class="line-added"> 559         Optional&lt;bool&gt; shadowsUseLegacyRadius;</span>
<span class="line-added"> 560         decoder &gt;&gt; shadowsUseLegacyRadius;</span>
<span class="line-added"> 561         if (!shadowsUseLegacyRadius)</span>
<span class="line-added"> 562             return WTF::nullopt;</span>
<span class="line-added"> 563 </span>
<span class="line-added"> 564         stateChange.m_state.shadowsUseLegacyRadius = *shadowsUseLegacyRadius;</span>
<span class="line-added"> 565 #endif // USE(CG)</span>
<span class="line-added"> 566     }</span>
<span class="line-added"> 567 </span>
<span class="line-added"> 568     if (stateChange.m_changeFlags.contains(GraphicsContextState::StrokeThicknessChange)) {</span>
<span class="line-added"> 569         Optional&lt;float&gt; strokeThickness;</span>
<span class="line-added"> 570         decoder &gt;&gt; strokeThickness;</span>
<span class="line-added"> 571         if (!strokeThickness)</span>
<span class="line-added"> 572             return WTF::nullopt;</span>
<span class="line-added"> 573 </span>
<span class="line-added"> 574         stateChange.m_state.strokeThickness = *strokeThickness;</span>
<span class="line-added"> 575     }</span>
<span class="line-added"> 576 </span>
<span class="line-added"> 577     if (stateChange.m_changeFlags.contains(GraphicsContextState::TextDrawingModeChange)) {</span>
<span class="line-added"> 578         TextDrawingModeFlags textDrawingMode;</span>
<span class="line-added"> 579         if (!decoder.decodeEnum(textDrawingMode))</span>
<span class="line-added"> 580             return WTF::nullopt;</span>
<span class="line-added"> 581 </span>
<span class="line-added"> 582         stateChange.m_state.textDrawingMode = textDrawingMode;</span>
<span class="line-added"> 583     }</span>
<span class="line-added"> 584 </span>
<span class="line-added"> 585     if (stateChange.m_changeFlags.contains(GraphicsContextState::StrokeColorChange)) {</span>
<span class="line-added"> 586         Optional&lt;Color&gt; strokeColor;</span>
<span class="line-added"> 587         decoder &gt;&gt; strokeColor;</span>
<span class="line-added"> 588         if (!strokeColor)</span>
<span class="line-added"> 589             return WTF::nullopt;</span>
<span class="line-added"> 590 </span>
<span class="line-added"> 591         stateChange.m_state.strokeColor = *strokeColor;</span>
<span class="line-added"> 592     }</span>
<span class="line-added"> 593 </span>
<span class="line-added"> 594     if (stateChange.m_changeFlags.contains(GraphicsContextState::FillColorChange)) {</span>
<span class="line-added"> 595         Optional&lt;Color&gt; fillColor;</span>
<span class="line-added"> 596         decoder &gt;&gt; fillColor;</span>
<span class="line-added"> 597         if (!fillColor)</span>
<span class="line-added"> 598             return WTF::nullopt;</span>
<span class="line-added"> 599 </span>
<span class="line-added"> 600         stateChange.m_state.fillColor = *fillColor;</span>
<span class="line-added"> 601     }</span>
<span class="line-added"> 602 </span>
<span class="line-added"> 603     if (stateChange.m_changeFlags.contains(GraphicsContextState::StrokeStyleChange)) {</span>
<span class="line-added"> 604         StrokeStyle strokeStyle;</span>
<span class="line-added"> 605         if (!decoder.decodeEnum(strokeStyle))</span>
<span class="line-added"> 606             return WTF::nullopt;</span>
<span class="line-added"> 607 </span>
<span class="line-added"> 608         stateChange.m_state.strokeStyle = strokeStyle;</span>
<span class="line-added"> 609     }</span>
<span class="line-added"> 610 </span>
<span class="line-added"> 611     if (stateChange.m_changeFlags.contains(GraphicsContextState::FillRuleChange)) {</span>
<span class="line-added"> 612         Optional&lt;WindRule&gt; fillRule;</span>
<span class="line-added"> 613         decoder &gt;&gt; fillRule;</span>
<span class="line-added"> 614         if (!fillRule)</span>
<span class="line-added"> 615             return WTF::nullopt;</span>
<span class="line-added"> 616 </span>
<span class="line-added"> 617         stateChange.m_state.fillRule = *fillRule;</span>
<span class="line-added"> 618     }</span>
<span class="line-added"> 619 </span>
<span class="line-added"> 620     if (stateChange.m_changeFlags.contains(GraphicsContextState::CompositeOperationChange)) {</span>
<span class="line-added"> 621         Optional&lt;CompositeOperator&gt; compositeOperator;</span>
<span class="line-added"> 622         decoder &gt;&gt; compositeOperator;</span>
<span class="line-added"> 623         if (!compositeOperator)</span>
<span class="line-added"> 624             return WTF::nullopt;</span>
<span class="line-added"> 625 </span>
<span class="line-added"> 626         stateChange.m_state.compositeOperator = *compositeOperator;</span>
<span class="line-added"> 627     }</span>
<span class="line-added"> 628 </span>
<span class="line-added"> 629     if (stateChange.m_changeFlags.contains(GraphicsContextState::BlendModeChange)) {</span>
<span class="line-added"> 630         Optional&lt;BlendMode&gt; blendMode;</span>
<span class="line-added"> 631         decoder &gt;&gt; blendMode;</span>
<span class="line-added"> 632         if (!blendMode)</span>
<span class="line-added"> 633             return WTF::nullopt;</span>
<span class="line-added"> 634 </span>
<span class="line-added"> 635         stateChange.m_state.blendMode = *blendMode;</span>
<span class="line-added"> 636     }</span>
<span class="line-added"> 637 </span>
<span class="line-added"> 638     if (stateChange.m_changeFlags.contains(GraphicsContextState::ImageInterpolationQualityChange)) {</span>
<span class="line-added"> 639         Optional&lt;InterpolationQuality&gt; imageInterpolationQuality;</span>
<span class="line-added"> 640         decoder &gt;&gt; imageInterpolationQuality;</span>
<span class="line-added"> 641         if (!imageInterpolationQuality)</span>
<span class="line-added"> 642             return WTF::nullopt;</span>
<span class="line-added"> 643 </span>
<span class="line-added"> 644         stateChange.m_state.imageInterpolationQuality = *imageInterpolationQuality;</span>
<span class="line-added"> 645     }</span>
<span class="line-added"> 646 </span>
<span class="line-added"> 647     if (stateChange.m_changeFlags.contains(GraphicsContextState::AlphaChange)) {</span>
<span class="line-added"> 648         Optional&lt;float&gt; alpha;</span>
<span class="line-added"> 649         decoder &gt;&gt; alpha;</span>
<span class="line-added"> 650         if (!alpha)</span>
<span class="line-added"> 651             return WTF::nullopt;</span>
<span class="line-added"> 652 </span>
<span class="line-added"> 653         stateChange.m_state.alpha = *alpha;</span>
<span class="line-added"> 654     }</span>
<span class="line-added"> 655 </span>
<span class="line-added"> 656     if (stateChange.m_changeFlags.contains(GraphicsContextState::ShouldAntialiasChange)) {</span>
<span class="line-added"> 657         Optional&lt;bool&gt; shouldAntialias;</span>
<span class="line-added"> 658         decoder &gt;&gt; shouldAntialias;</span>
<span class="line-added"> 659         if (!shouldAntialias)</span>
<span class="line-added"> 660             return WTF::nullopt;</span>
<span class="line-added"> 661 </span>
<span class="line-added"> 662         stateChange.m_state.shouldAntialias = *shouldAntialias;</span>
<span class="line-added"> 663     }</span>
<span class="line-added"> 664 </span>
<span class="line-added"> 665     if (stateChange.m_changeFlags.contains(GraphicsContextState::ShouldSmoothFontsChange)) {</span>
<span class="line-added"> 666         Optional&lt;bool&gt; shouldSmoothFonts;</span>
<span class="line-added"> 667         decoder &gt;&gt; shouldSmoothFonts;</span>
<span class="line-added"> 668         if (!shouldSmoothFonts)</span>
<span class="line-added"> 669             return WTF::nullopt;</span>
<span class="line-added"> 670 </span>
<span class="line-added"> 671         stateChange.m_state.shouldSmoothFonts = *shouldSmoothFonts;</span>
<span class="line-added"> 672     }</span>
<span class="line-added"> 673 </span>
<span class="line-added"> 674     if (stateChange.m_changeFlags.contains(GraphicsContextState::ShouldSubpixelQuantizeFontsChange)) {</span>
<span class="line-added"> 675         Optional&lt;bool&gt; shouldSubpixelQuantizeFonts;</span>
<span class="line-added"> 676         decoder &gt;&gt; shouldSubpixelQuantizeFonts;</span>
<span class="line-added"> 677         if (!shouldSubpixelQuantizeFonts)</span>
<span class="line-added"> 678             return WTF::nullopt;</span>
<span class="line-added"> 679 </span>
<span class="line-added"> 680         stateChange.m_state.shouldSubpixelQuantizeFonts = *shouldSubpixelQuantizeFonts;</span>
<span class="line-added"> 681     }</span>
<span class="line-added"> 682 </span>
<span class="line-added"> 683     if (stateChange.m_changeFlags.contains(GraphicsContextState::ShadowsIgnoreTransformsChange)) {</span>
<span class="line-added"> 684         Optional&lt;bool&gt; shadowsIgnoreTransforms;</span>
<span class="line-added"> 685         decoder &gt;&gt; shadowsIgnoreTransforms;</span>
<span class="line-added"> 686         if (!shadowsIgnoreTransforms)</span>
<span class="line-added"> 687             return WTF::nullopt;</span>
<span class="line-added"> 688 </span>
<span class="line-added"> 689         stateChange.m_state.shadowsIgnoreTransforms = *shadowsIgnoreTransforms;</span>
<span class="line-added"> 690     }</span>
<span class="line-added"> 691 </span>
<span class="line-added"> 692     return SetState::create(stateChange);</span>
<span class="line-added"> 693 }</span>
<span class="line-added"> 694 </span>
 695 class SetLineCap : public Item {
 696 public:
 697     static Ref&lt;SetLineCap&gt; create(LineCap lineCap)
 698     {
 699         return adoptRef(*new SetLineCap(lineCap));
 700     }
 701 
<a name="39" id="anc39"></a><span class="line-added"> 702     WEBCORE_EXPORT virtual ~SetLineCap();</span>
<span class="line-added"> 703 </span>
 704     LineCap lineCap() const { return m_lineCap; }
 705 
<a name="40" id="anc40"></a><span class="line-added"> 706     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 707     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;SetLineCap&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 708 </span>
 709 private:
<a name="41" id="anc41"></a><span class="line-modified"> 710     WEBCORE_EXPORT SetLineCap(LineCap);</span>




 711 
 712     void apply(GraphicsContext&amp;) const override;
 713 
 714     LineCap m_lineCap;
 715 };
 716 
<a name="42" id="anc42"></a><span class="line-added"> 717 template&lt;class Encoder&gt;</span>
<span class="line-added"> 718 void SetLineCap::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 719 {</span>
<span class="line-added"> 720     encoder &lt;&lt; m_lineCap;</span>
<span class="line-added"> 721 }</span>
<span class="line-added"> 722 </span>
<span class="line-added"> 723 template&lt;class Decoder&gt;</span>
<span class="line-added"> 724 Optional&lt;Ref&lt;SetLineCap&gt;&gt; SetLineCap::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 725 {</span>
<span class="line-added"> 726     Optional&lt;LineCap&gt; lineCap;</span>
<span class="line-added"> 727     decoder &gt;&gt; lineCap;</span>
<span class="line-added"> 728     if (!lineCap)</span>
<span class="line-added"> 729         return WTF::nullopt;</span>
<span class="line-added"> 730 </span>
<span class="line-added"> 731     return SetLineCap::create(*lineCap);</span>
<span class="line-added"> 732 }</span>
<span class="line-added"> 733 </span>
 734 class SetLineDash : public Item {
 735 public:
 736     static Ref&lt;SetLineDash&gt; create(const DashArray&amp; dashArray, float dashOffset)
 737     {
 738         return adoptRef(*new SetLineDash(dashArray, dashOffset));
 739     }
 740 
<a name="43" id="anc43"></a><span class="line-added"> 741     WEBCORE_EXPORT virtual ~SetLineDash();</span>
<span class="line-added"> 742 </span>
 743     const DashArray&amp; dashArray() const { return m_dashArray; }
 744     float dashOffset() const { return m_dashOffset; }
 745 
<a name="44" id="anc44"></a><span class="line-added"> 746     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 747     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;SetLineDash&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 748 </span>
 749 private:
<a name="45" id="anc45"></a><span class="line-modified"> 750     WEBCORE_EXPORT SetLineDash(const DashArray&amp;, float dashOffset);</span>





 751 
 752     void apply(GraphicsContext&amp;) const override;
 753 
 754     DashArray m_dashArray;
 755     float m_dashOffset;
 756 };
 757 
<a name="46" id="anc46"></a><span class="line-added"> 758 template&lt;class Encoder&gt;</span>
<span class="line-added"> 759 void SetLineDash::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 760 {</span>
<span class="line-added"> 761     encoder &lt;&lt; m_dashArray;</span>
<span class="line-added"> 762     encoder &lt;&lt; m_dashOffset;</span>
<span class="line-added"> 763 }</span>
<span class="line-added"> 764 </span>
<span class="line-added"> 765 template&lt;class Decoder&gt;</span>
<span class="line-added"> 766 Optional&lt;Ref&lt;SetLineDash&gt;&gt; SetLineDash::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 767 {</span>
<span class="line-added"> 768     Optional&lt;DashArray&gt; dashArray;</span>
<span class="line-added"> 769     decoder &gt;&gt; dashArray;</span>
<span class="line-added"> 770     if (!dashArray)</span>
<span class="line-added"> 771         return WTF::nullopt;</span>
<span class="line-added"> 772 </span>
<span class="line-added"> 773     Optional&lt;float&gt; dashOffset;</span>
<span class="line-added"> 774     decoder &gt;&gt; dashOffset;</span>
<span class="line-added"> 775     if (!dashOffset)</span>
<span class="line-added"> 776         return WTF::nullopt;</span>
<span class="line-added"> 777 </span>
<span class="line-added"> 778     return SetLineDash::create(*dashArray, *dashOffset);</span>
<span class="line-added"> 779 }</span>
<span class="line-added"> 780 </span>
 781 class SetLineJoin : public Item {
 782 public:
 783     static Ref&lt;SetLineJoin&gt; create(LineJoin lineJoin)
 784     {
 785         return adoptRef(*new SetLineJoin(lineJoin));
 786     }
 787 
<a name="47" id="anc47"></a><span class="line-added"> 788     WEBCORE_EXPORT virtual ~SetLineJoin();</span>
<span class="line-added"> 789 </span>
 790     LineJoin lineJoin() const { return m_lineJoin; }
 791 
<a name="48" id="anc48"></a><span class="line-added"> 792     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 793     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;SetLineJoin&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 794 </span>
 795 private:
<a name="49" id="anc49"></a><span class="line-modified"> 796     WEBCORE_EXPORT SetLineJoin(LineJoin);</span>




 797 
 798     void apply(GraphicsContext&amp;) const override;
 799 
 800     LineJoin m_lineJoin;
 801 };
 802 
<a name="50" id="anc50"></a><span class="line-added"> 803 template&lt;class Encoder&gt;</span>
<span class="line-added"> 804 void SetLineJoin::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 805 {</span>
<span class="line-added"> 806     encoder &lt;&lt; m_lineJoin;</span>
<span class="line-added"> 807 }</span>
<span class="line-added"> 808 </span>
<span class="line-added"> 809 template&lt;class Decoder&gt;</span>
<span class="line-added"> 810 Optional&lt;Ref&lt;SetLineJoin&gt;&gt; SetLineJoin::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 811 {</span>
<span class="line-added"> 812     Optional&lt;LineJoin&gt; lineJoin;</span>
<span class="line-added"> 813     decoder &gt;&gt; lineJoin;</span>
<span class="line-added"> 814     if (!lineJoin)</span>
<span class="line-added"> 815         return WTF::nullopt;</span>
<span class="line-added"> 816 </span>
<span class="line-added"> 817     return SetLineJoin::create(*lineJoin);</span>
<span class="line-added"> 818 }</span>
<span class="line-added"> 819 </span>
 820 class SetMiterLimit : public Item {
 821 public:
 822     static Ref&lt;SetMiterLimit&gt; create(float limit)
 823     {
 824         return adoptRef(*new SetMiterLimit(limit));
 825     }
 826 
<a name="51" id="anc51"></a><span class="line-added"> 827     WEBCORE_EXPORT virtual ~SetMiterLimit();</span>
<span class="line-added"> 828 </span>
 829     float miterLimit() const { return m_miterLimit; }
 830 
<a name="52" id="anc52"></a><span class="line-added"> 831     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 832     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;SetMiterLimit&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 833 </span>
 834 private:
<a name="53" id="anc53"></a><span class="line-modified"> 835     WEBCORE_EXPORT SetMiterLimit(float);</span>




 836 
 837     void apply(GraphicsContext&amp;) const override;
 838 
 839     float m_miterLimit;
 840 };
 841 
<a name="54" id="anc54"></a><span class="line-added"> 842 template&lt;class Encoder&gt;</span>
<span class="line-added"> 843 void SetMiterLimit::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 844 {</span>
<span class="line-added"> 845     encoder &lt;&lt; m_miterLimit;</span>
<span class="line-added"> 846 }</span>
<span class="line-added"> 847 </span>
<span class="line-added"> 848 template&lt;class Decoder&gt;</span>
<span class="line-added"> 849 Optional&lt;Ref&lt;SetMiterLimit&gt;&gt; SetMiterLimit::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 850 {</span>
<span class="line-added"> 851     Optional&lt;float&gt; miterLimit;</span>
<span class="line-added"> 852     decoder &gt;&gt; miterLimit;</span>
<span class="line-added"> 853     if (!miterLimit)</span>
<span class="line-added"> 854         return WTF::nullopt;</span>
<span class="line-added"> 855 </span>
<span class="line-added"> 856     return SetMiterLimit::create(*miterLimit);</span>
<span class="line-added"> 857 }</span>
<span class="line-added"> 858 </span>
 859 class ClearShadow : public Item {
 860 public:
 861     static Ref&lt;ClearShadow&gt; create()
 862     {
 863         return adoptRef(*new ClearShadow);
 864     }
 865 
<a name="55" id="anc55"></a><span class="line-added"> 866     WEBCORE_EXPORT virtual ~ClearShadow();</span>
<span class="line-added"> 867 </span>
<span class="line-added"> 868     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 869     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;ClearShadow&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 870 </span>
 871 private:
<a name="56" id="anc56"></a><span class="line-modified"> 872     WEBCORE_EXPORT ClearShadow();</span>



 873 
 874     void apply(GraphicsContext&amp;) const override;
 875 };
 876 
<a name="57" id="anc57"></a><span class="line-added"> 877 template&lt;class Encoder&gt;</span>
<span class="line-added"> 878 void ClearShadow::encode(Encoder&amp;) const</span>
<span class="line-added"> 879 {</span>
<span class="line-added"> 880 }</span>
<span class="line-added"> 881 </span>
<span class="line-added"> 882 template&lt;class Decoder&gt;</span>
<span class="line-added"> 883 Optional&lt;Ref&lt;ClearShadow&gt;&gt; ClearShadow::decode(Decoder&amp;)</span>
<span class="line-added"> 884 {</span>
<span class="line-added"> 885     return ClearShadow::create();</span>
<span class="line-added"> 886 }</span>
<span class="line-added"> 887 </span>
 888 // FIXME: treat as DrawingItem?
 889 class Clip : public Item {
 890 public:
 891     static Ref&lt;Clip&gt; create(const FloatRect&amp; rect)
 892     {
 893         return adoptRef(*new Clip(rect));
 894     }
 895 
<a name="58" id="anc58"></a><span class="line-added"> 896     WEBCORE_EXPORT virtual ~Clip();</span>
<span class="line-added"> 897 </span>
 898     FloatRect rect() const { return m_rect; }
 899 
<a name="59" id="anc59"></a><span class="line-added"> 900     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 901     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;Clip&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 902 </span>
 903 private:
<a name="60" id="anc60"></a><span class="line-modified"> 904     WEBCORE_EXPORT Clip(const FloatRect&amp;);</span>




 905 
 906     void apply(GraphicsContext&amp;) const override;
 907 
 908     FloatRect m_rect;
 909 };
 910 
<a name="61" id="anc61"></a><span class="line-added"> 911 template&lt;class Encoder&gt;</span>
<span class="line-added"> 912 void Clip::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 913 {</span>
<span class="line-added"> 914     encoder &lt;&lt; m_rect;</span>
<span class="line-added"> 915 }</span>
<span class="line-added"> 916 </span>
<span class="line-added"> 917 template&lt;class Decoder&gt;</span>
<span class="line-added"> 918 Optional&lt;Ref&lt;Clip&gt;&gt; Clip::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 919 {</span>
<span class="line-added"> 920     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added"> 921     decoder &gt;&gt; rect;</span>
<span class="line-added"> 922     if (!rect)</span>
<span class="line-added"> 923         return WTF::nullopt;</span>
<span class="line-added"> 924 </span>
<span class="line-added"> 925     return Clip::create(*rect);</span>
<span class="line-added"> 926 }</span>
<span class="line-added"> 927 </span>
 928 class ClipOut : public Item {
 929 public:
 930     static Ref&lt;ClipOut&gt; create(const FloatRect&amp; rect)
 931     {
 932         return adoptRef(*new ClipOut(rect));
 933     }
 934 
<a name="62" id="anc62"></a><span class="line-added"> 935     WEBCORE_EXPORT virtual ~ClipOut();</span>
<span class="line-added"> 936 </span>
 937     FloatRect rect() const { return m_rect; }
 938 
<a name="63" id="anc63"></a><span class="line-added"> 939     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 940     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;ClipOut&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 941 </span>
 942 private:
<a name="64" id="anc64"></a><span class="line-modified"> 943     WEBCORE_EXPORT ClipOut(const FloatRect&amp;);</span>




 944 
 945     void apply(GraphicsContext&amp;) const override;
 946 
 947     FloatRect m_rect;
 948 };
 949 
<a name="65" id="anc65"></a><span class="line-added"> 950 template&lt;class Encoder&gt;</span>
<span class="line-added"> 951 void ClipOut::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 952 {</span>
<span class="line-added"> 953     encoder &lt;&lt; m_rect;</span>
<span class="line-added"> 954 }</span>
<span class="line-added"> 955 </span>
<span class="line-added"> 956 template&lt;class Decoder&gt;</span>
<span class="line-added"> 957 Optional&lt;Ref&lt;ClipOut&gt;&gt; ClipOut::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 958 {</span>
<span class="line-added"> 959     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added"> 960     decoder &gt;&gt; rect;</span>
<span class="line-added"> 961     if (!rect)</span>
<span class="line-added"> 962         return WTF::nullopt;</span>
<span class="line-added"> 963 </span>
<span class="line-added"> 964     return ClipOut::create(*rect);</span>
<span class="line-added"> 965 }</span>
<span class="line-added"> 966 </span>
 967 class ClipOutToPath : public Item {
 968 public:
 969     static Ref&lt;ClipOutToPath&gt; create(const Path&amp; path)
 970     {
 971         return adoptRef(*new ClipOutToPath(path));
 972     }
 973 
<a name="66" id="anc66"></a><span class="line-added"> 974     WEBCORE_EXPORT virtual ~ClipOutToPath();</span>
<span class="line-added"> 975 </span>
 976     const Path&amp; path() const { return m_path; }
 977 
<a name="67" id="anc67"></a><span class="line-added"> 978     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added"> 979     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;ClipOutToPath&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added"> 980 </span>
 981 private:
<a name="68" id="anc68"></a><span class="line-modified"> 982     WEBCORE_EXPORT ClipOutToPath(const Path&amp;);</span>




 983 
 984     void apply(GraphicsContext&amp;) const override;
 985 
 986     const Path m_path;
 987 };
 988 
<a name="69" id="anc69"></a><span class="line-added"> 989 template&lt;class Encoder&gt;</span>
<span class="line-added"> 990 void ClipOutToPath::encode(Encoder&amp; encoder) const</span>
<span class="line-added"> 991 {</span>
<span class="line-added"> 992     encoder &lt;&lt; m_path;</span>
<span class="line-added"> 993 }</span>
<span class="line-added"> 994 </span>
<span class="line-added"> 995 template&lt;class Decoder&gt;</span>
<span class="line-added"> 996 Optional&lt;Ref&lt;ClipOutToPath&gt;&gt; ClipOutToPath::decode(Decoder&amp; decoder)</span>
<span class="line-added"> 997 {</span>
<span class="line-added"> 998     Optional&lt;Path&gt; path;</span>
<span class="line-added"> 999     decoder &gt;&gt; path;</span>
<span class="line-added">1000     if (!path)</span>
<span class="line-added">1001         return WTF::nullopt;</span>
<span class="line-added">1002 </span>
<span class="line-added">1003     return ClipOutToPath::create(*path);</span>
<span class="line-added">1004 }</span>
<span class="line-added">1005 </span>
1006 class ClipPath : public Item {
1007 public:
1008     static Ref&lt;ClipPath&gt; create(const Path&amp; path, WindRule windRule)
1009     {
1010         return adoptRef(*new ClipPath(path, windRule));
1011     }
1012 
<a name="70" id="anc70"></a><span class="line-added">1013     WEBCORE_EXPORT ~ClipPath();</span>
<span class="line-added">1014 </span>
1015     const Path&amp; path() const { return m_path; }
1016     WindRule windRule() const { return m_windRule; }
1017 
<a name="71" id="anc71"></a><span class="line-added">1018     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1019     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;ClipPath&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1020 </span>
1021 private:
<a name="72" id="anc72"></a><span class="line-modified">1022     WEBCORE_EXPORT ClipPath(const Path&amp;, WindRule);</span>





1023 
1024     void apply(GraphicsContext&amp;) const override;
1025 
1026     const Path m_path;
1027     WindRule m_windRule;
1028 };
1029 
<a name="73" id="anc73"></a><span class="line-added">1030 template&lt;class Encoder&gt;</span>
<span class="line-added">1031 void ClipPath::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1032 {</span>
<span class="line-added">1033     encoder &lt;&lt; m_path;</span>
<span class="line-added">1034     encoder &lt;&lt; m_windRule;</span>
<span class="line-added">1035 }</span>
<span class="line-added">1036 </span>
<span class="line-added">1037 template&lt;class Decoder&gt;</span>
<span class="line-added">1038 Optional&lt;Ref&lt;ClipPath&gt;&gt; ClipPath::decode(Decoder&amp; decoder)</span>
<span class="line-added">1039 {</span>
<span class="line-added">1040     Optional&lt;Path&gt; path;</span>
<span class="line-added">1041     decoder &gt;&gt; path;</span>
<span class="line-added">1042     if (!path)</span>
<span class="line-added">1043         return WTF::nullopt;</span>
<span class="line-added">1044 </span>
<span class="line-added">1045     Optional&lt;WindRule&gt; windRule;</span>
<span class="line-added">1046     decoder &gt;&gt; windRule;</span>
<span class="line-added">1047     if (!windRule)</span>
<span class="line-added">1048         return WTF::nullopt;</span>
<span class="line-added">1049 </span>
<span class="line-added">1050     return ClipPath::create(*path, *windRule);</span>
<span class="line-added">1051 }</span>
<span class="line-added">1052 </span>
1053 class DrawGlyphs : public DrawingItem {
1054 public:
1055     static Ref&lt;DrawGlyphs&gt; create(const Font&amp; font, const GlyphBufferGlyph* glyphs, const GlyphBufferAdvance* advances, unsigned count, const FloatPoint&amp; blockLocation, const FloatSize&amp; localAnchor, FontSmoothingMode smoothingMode)
1056     {
1057         return adoptRef(*new DrawGlyphs(font, glyphs, advances, count, blockLocation, localAnchor, smoothingMode));
1058     }
1059 
<a name="74" id="anc74"></a><span class="line-added">1060     static Ref&lt;DrawGlyphs&gt; create(const Font&amp; font, Vector&lt;GlyphBufferGlyph, 128&gt;&amp;&amp; glyphs, Vector&lt;GlyphBufferAdvance, 128&gt;&amp;&amp; advances, const FloatPoint&amp; blockLocation, const FloatSize&amp; localAnchor, FontSmoothingMode smoothingMode)</span>
<span class="line-added">1061     {</span>
<span class="line-added">1062         return adoptRef(*new DrawGlyphs(font, WTFMove(glyphs), WTFMove(advances), blockLocation, localAnchor, smoothingMode));</span>
<span class="line-added">1063     }</span>
<span class="line-added">1064 </span>
<span class="line-added">1065     WEBCORE_EXPORT virtual ~DrawGlyphs();</span>
<span class="line-added">1066 </span>
1067     const FloatPoint&amp; blockLocation() const { return m_blockLocation; }
1068     void setBlockLocation(const FloatPoint&amp; blockLocation) { m_blockLocation = blockLocation; }
1069 
1070     const FloatSize&amp; localAnchor() const { return m_localAnchor; }
1071 
1072     FloatPoint anchorPoint() const { return m_blockLocation + m_localAnchor; }
1073 
1074     const Vector&lt;GlyphBufferGlyph, 128&gt;&amp; glyphs() const { return m_glyphs; }
1075 
<a name="75" id="anc75"></a><span class="line-added">1076     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1077     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawGlyphs&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1078 </span>
1079 private:
1080     DrawGlyphs(const Font&amp;, const GlyphBufferGlyph*, const GlyphBufferAdvance*, unsigned count, const FloatPoint&amp; blockLocation, const FloatSize&amp; localAnchor, FontSmoothingMode);
<a name="76" id="anc76"></a><span class="line-added">1081     WEBCORE_EXPORT DrawGlyphs(const Font&amp;, Vector&lt;GlyphBufferGlyph, 128&gt;&amp;&amp;, Vector&lt;GlyphBufferAdvance, 128&gt;&amp;&amp;, const FloatPoint&amp; blockLocation, const FloatSize&amp; localAnchor, FontSmoothingMode);</span>
1082 
1083     void computeBounds();
1084 
1085     void apply(GraphicsContext&amp;) const override;
1086 
1087     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override;
1088 
1089     GlyphBuffer generateGlyphBuffer() const;
1090 
1091     Ref&lt;Font&gt; m_font;
1092     Vector&lt;GlyphBufferGlyph, 128&gt; m_glyphs;
1093     Vector&lt;GlyphBufferAdvance, 128&gt; m_advances;
1094     FloatRect m_bounds;
1095     FloatPoint m_blockLocation;
1096     FloatSize m_localAnchor;
1097     FontSmoothingMode m_smoothingMode;
1098 };
1099 
<a name="77" id="anc77"></a><span class="line-added">1100 template&lt;class Encoder&gt;</span>
<span class="line-added">1101 void DrawGlyphs::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1102 {</span>
<span class="line-added">1103     FontHandle handle;</span>
<span class="line-added">1104     handle.font = m_font.ptr();</span>
<span class="line-added">1105     encoder &lt;&lt; handle;</span>
<span class="line-added">1106     encoder &lt;&lt; m_glyphs;</span>
<span class="line-added">1107     encoder &lt;&lt; m_advances;</span>
<span class="line-added">1108     encoder &lt;&lt; m_blockLocation;</span>
<span class="line-added">1109     encoder &lt;&lt; m_localAnchor;</span>
<span class="line-added">1110     encoder &lt;&lt; m_smoothingMode;</span>
<span class="line-added">1111 }</span>
<span class="line-added">1112 </span>
<span class="line-added">1113 template&lt;class Decoder&gt;</span>
<span class="line-added">1114 Optional&lt;Ref&lt;DrawGlyphs&gt;&gt; DrawGlyphs::decode(Decoder&amp; decoder)</span>
<span class="line-added">1115 {</span>
<span class="line-added">1116     Optional&lt;FontHandle&gt; handle;</span>
<span class="line-added">1117     decoder &gt;&gt; handle;</span>
<span class="line-added">1118     if (!handle || !handle-&gt;font)</span>
<span class="line-added">1119         return WTF::nullopt;</span>
<span class="line-added">1120 </span>
<span class="line-added">1121     Optional&lt;Vector&lt;GlyphBufferGlyph, 128&gt;&gt; glyphs;</span>
<span class="line-added">1122     decoder &gt;&gt; glyphs;</span>
<span class="line-added">1123     if (!glyphs)</span>
<span class="line-added">1124         return WTF::nullopt;</span>
<span class="line-added">1125 </span>
<span class="line-added">1126     Optional&lt;Vector&lt;GlyphBufferAdvance, 128&gt;&gt; advances;</span>
<span class="line-added">1127     decoder &gt;&gt; advances;</span>
<span class="line-added">1128     if (!advances)</span>
<span class="line-added">1129         return WTF::nullopt;</span>
<span class="line-added">1130 </span>
<span class="line-added">1131     if (glyphs-&gt;size() != advances-&gt;size())</span>
<span class="line-added">1132         return WTF::nullopt;</span>
<span class="line-added">1133 </span>
<span class="line-added">1134     Optional&lt;FloatPoint&gt; blockLocation;</span>
<span class="line-added">1135     decoder &gt;&gt; blockLocation;</span>
<span class="line-added">1136     if (!blockLocation)</span>
<span class="line-added">1137         return WTF::nullopt;</span>
<span class="line-added">1138 </span>
<span class="line-added">1139     Optional&lt;FloatSize&gt; localAnchor;</span>
<span class="line-added">1140     decoder &gt;&gt; localAnchor;</span>
<span class="line-added">1141     if (!localAnchor)</span>
<span class="line-added">1142         return WTF::nullopt;</span>
<span class="line-added">1143 </span>
<span class="line-added">1144     Optional&lt;FontSmoothingMode&gt; smoothingMode;</span>
<span class="line-added">1145     decoder &gt;&gt; smoothingMode;</span>
<span class="line-added">1146     if (!smoothingMode)</span>
<span class="line-added">1147         return WTF::nullopt;</span>
<span class="line-added">1148 </span>
<span class="line-added">1149     return DrawGlyphs::create(handle-&gt;font.releaseNonNull(), WTFMove(*glyphs), WTFMove(*advances), *blockLocation, *localAnchor, *smoothingMode);</span>
<span class="line-added">1150 }</span>
<span class="line-added">1151 </span>
1152 class DrawImage : public DrawingItem {
1153 public:
1154     static Ref&lt;DrawImage&gt; create(Image&amp; image, const FloatRect&amp; destination, const FloatRect&amp; source, const ImagePaintingOptions&amp; imagePaintingOptions)
1155     {
1156         return adoptRef(*new DrawImage(image, destination, source, imagePaintingOptions));
1157     }
1158 
<a name="78" id="anc78"></a><span class="line-added">1159     WEBCORE_EXPORT virtual ~DrawImage();</span>
<span class="line-added">1160 </span>
1161     const Image&amp; image() const { return m_image.get(); }
1162     FloatRect source() const { return m_source; }
1163     FloatRect destination() const { return m_destination; }
1164 
<a name="79" id="anc79"></a><span class="line-added">1165     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1166     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawImage&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1167 </span>
1168 private:
<a name="80" id="anc80"></a><span class="line-modified">1169     WEBCORE_EXPORT DrawImage(Image&amp;, const FloatRect&amp; destination, const FloatRect&amp; source, const ImagePaintingOptions&amp;);</span>
1170 
1171     void apply(GraphicsContext&amp;) const override;
1172 
1173     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_destination; }
1174 
1175     mutable Ref&lt;Image&gt; m_image; // FIXME: Drawing images can cause their animations to progress. This shouldn&#39;t have to be mutable.
1176     FloatRect m_destination;
1177     FloatRect m_source;
1178     ImagePaintingOptions m_imagePaintingOptions;
1179 };
1180 
<a name="81" id="anc81"></a><span class="line-added">1181 template&lt;class Encoder&gt;</span>
<span class="line-added">1182 void DrawImage::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1183 {</span>
<span class="line-added">1184     ImageHandle imageHandle;</span>
<span class="line-added">1185     imageHandle.image = m_image.ptr();</span>
<span class="line-added">1186 </span>
<span class="line-added">1187     encoder &lt;&lt; imageHandle;</span>
<span class="line-added">1188     encoder &lt;&lt; m_destination;</span>
<span class="line-added">1189     encoder &lt;&lt; m_source;</span>
<span class="line-added">1190     encoder &lt;&lt; m_imagePaintingOptions;</span>
<span class="line-added">1191 }</span>
<span class="line-added">1192 </span>
<span class="line-added">1193 template&lt;class Decoder&gt;</span>
<span class="line-added">1194 Optional&lt;Ref&lt;DrawImage&gt;&gt; DrawImage::decode(Decoder&amp; decoder)</span>
<span class="line-added">1195 {</span>
<span class="line-added">1196     Optional&lt;ImageHandle&gt; imageHandle;</span>
<span class="line-added">1197     decoder &gt;&gt; imageHandle;</span>
<span class="line-added">1198     if (!imageHandle)</span>
<span class="line-added">1199         return WTF::nullopt;</span>
<span class="line-added">1200 </span>
<span class="line-added">1201     Optional&lt;FloatRect&gt; destination;</span>
<span class="line-added">1202     decoder &gt;&gt; destination;</span>
<span class="line-added">1203     if (!destination)</span>
<span class="line-added">1204         return WTF::nullopt;</span>
<span class="line-added">1205 </span>
<span class="line-added">1206     Optional&lt;FloatRect&gt; source;</span>
<span class="line-added">1207     decoder &gt;&gt; source;</span>
<span class="line-added">1208     if (!source)</span>
<span class="line-added">1209         return WTF::nullopt;</span>
<span class="line-added">1210 </span>
<span class="line-added">1211     Optional&lt;ImagePaintingOptions&gt; imagePaintingOptions;</span>
<span class="line-added">1212     decoder &gt;&gt; imagePaintingOptions;</span>
<span class="line-added">1213     if (!imagePaintingOptions)</span>
<span class="line-added">1214         return WTF::nullopt;</span>
<span class="line-added">1215 </span>
<span class="line-added">1216     return DrawImage::create(*imageHandle-&gt;image, *destination, *source, *imagePaintingOptions);</span>
<span class="line-added">1217 }</span>
<span class="line-added">1218 </span>
1219 class DrawTiledImage : public DrawingItem {
1220 public:
1221     static Ref&lt;DrawTiledImage&gt; create(Image&amp; image, const FloatRect&amp; destination, const FloatPoint&amp; source, const FloatSize&amp; tileSize, const FloatSize&amp; spacing, const ImagePaintingOptions&amp; imagePaintingOptions)
1222     {
1223         return adoptRef(*new DrawTiledImage(image, destination, source, tileSize, spacing, imagePaintingOptions));
1224     }
1225 
<a name="82" id="anc82"></a><span class="line-added">1226     WEBCORE_EXPORT virtual ~DrawTiledImage();</span>
<span class="line-added">1227 </span>
1228     const Image&amp; image() const { return m_image.get(); }
1229     FloatPoint source() const { return m_source; }
1230     FloatRect destination() const { return m_destination; }
1231 
1232     FloatSize tileSize() const { return m_tileSize; }
1233     FloatSize spacing() const { return m_spacing; }
1234 
<a name="83" id="anc83"></a><span class="line-added">1235     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1236     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawTiledImage&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1237 </span>
1238 private:
<a name="84" id="anc84"></a><span class="line-modified">1239     WEBCORE_EXPORT DrawTiledImage(Image&amp;, const FloatRect&amp; destination, const FloatPoint&amp; source, const FloatSize&amp; tileSize, const FloatSize&amp; spacing, const ImagePaintingOptions&amp;);</span>
1240 
1241     void apply(GraphicsContext&amp;) const override;
1242 
1243     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_destination; }
1244 
1245     mutable Ref&lt;Image&gt; m_image; // FIXME: Drawing images can cause their animations to progress. This shouldn&#39;t have to be mutable.
1246     FloatRect m_destination;
1247     FloatPoint m_source;
1248     FloatSize m_tileSize;
1249     FloatSize m_spacing;
1250     ImagePaintingOptions m_imagePaintingOptions;
1251 };
1252 
<a name="85" id="anc85"></a><span class="line-added">1253 template&lt;class Encoder&gt;</span>
<span class="line-added">1254 void DrawTiledImage::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1255 {</span>
<span class="line-added">1256     ImageHandle imageHandle;</span>
<span class="line-added">1257     imageHandle.image = m_image.ptr();</span>
<span class="line-added">1258     encoder &lt;&lt; imageHandle;</span>
<span class="line-added">1259     encoder &lt;&lt; m_destination;</span>
<span class="line-added">1260     encoder &lt;&lt; m_source;</span>
<span class="line-added">1261     encoder &lt;&lt; m_tileSize;</span>
<span class="line-added">1262     encoder &lt;&lt; m_spacing;</span>
<span class="line-added">1263     encoder &lt;&lt; m_imagePaintingOptions;</span>
<span class="line-added">1264 }</span>
<span class="line-added">1265 </span>
<span class="line-added">1266 template&lt;class Decoder&gt;</span>
<span class="line-added">1267 Optional&lt;Ref&lt;DrawTiledImage&gt;&gt; DrawTiledImage::decode(Decoder&amp; decoder)</span>
<span class="line-added">1268 {</span>
<span class="line-added">1269     Optional&lt;ImageHandle&gt; imageHandle;</span>
<span class="line-added">1270     decoder &gt;&gt; imageHandle;</span>
<span class="line-added">1271     if (!imageHandle)</span>
<span class="line-added">1272         return WTF::nullopt;</span>
<span class="line-added">1273 </span>
<span class="line-added">1274     Optional&lt;FloatRect&gt; destination;</span>
<span class="line-added">1275     decoder &gt;&gt; destination;</span>
<span class="line-added">1276     if (!destination)</span>
<span class="line-added">1277         return WTF::nullopt;</span>
<span class="line-added">1278 </span>
<span class="line-added">1279     Optional&lt;FloatPoint&gt; source;</span>
<span class="line-added">1280     decoder &gt;&gt; source;</span>
<span class="line-added">1281     if (!source)</span>
<span class="line-added">1282         return WTF::nullopt;</span>
<span class="line-added">1283 </span>
<span class="line-added">1284     Optional&lt;FloatSize&gt; tileSize;</span>
<span class="line-added">1285     decoder &gt;&gt; tileSize;</span>
<span class="line-added">1286     if (!tileSize)</span>
<span class="line-added">1287         return WTF::nullopt;</span>
<span class="line-added">1288 </span>
<span class="line-added">1289     Optional&lt;FloatSize&gt; spacing;</span>
<span class="line-added">1290     decoder &gt;&gt; spacing;</span>
<span class="line-added">1291     if (!spacing)</span>
<span class="line-added">1292         return WTF::nullopt;</span>
<span class="line-added">1293 </span>
<span class="line-added">1294     Optional&lt;ImagePaintingOptions&gt; imagePaintingOptions;</span>
<span class="line-added">1295     decoder &gt;&gt; imagePaintingOptions;</span>
<span class="line-added">1296     if (!imagePaintingOptions)</span>
<span class="line-added">1297         return WTF::nullopt;</span>
<span class="line-added">1298 </span>
<span class="line-added">1299     return DrawTiledImage::create(*imageHandle-&gt;image, *destination, *source, *tileSize, *spacing, *imagePaintingOptions);</span>
<span class="line-added">1300 }</span>
<span class="line-added">1301 </span>
1302 class DrawTiledScaledImage : public DrawingItem {
1303 public:
1304     static Ref&lt;DrawTiledScaledImage&gt; create(Image&amp; image, const FloatRect&amp; destination, const FloatRect&amp; source, const FloatSize&amp; tileScaleFactor, Image::TileRule hRule, Image::TileRule vRule, const ImagePaintingOptions&amp; imagePaintingOptions)
1305     {
1306         return adoptRef(*new DrawTiledScaledImage(image, destination, source, tileScaleFactor, hRule, vRule, imagePaintingOptions));
1307     }
1308 
<a name="86" id="anc86"></a><span class="line-added">1309     WEBCORE_EXPORT virtual ~DrawTiledScaledImage();</span>
<span class="line-added">1310 </span>
1311     const Image&amp; image() const { return m_image.get(); }
1312     FloatRect source() const { return m_source; }
1313     FloatRect destination() const { return m_destination; }
1314 
<a name="87" id="anc87"></a><span class="line-added">1315     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1316     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawTiledScaledImage&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1317 </span>
1318 private:
<a name="88" id="anc88"></a><span class="line-modified">1319     WEBCORE_EXPORT DrawTiledScaledImage(Image&amp;, const FloatRect&amp; destination, const FloatRect&amp; source, const FloatSize&amp; tileScaleFactor, Image::TileRule hRule, Image::TileRule vRule, const ImagePaintingOptions&amp;);</span>
1320 
1321     void apply(GraphicsContext&amp;) const override;
1322 
1323     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_destination; }
1324 
1325     mutable Ref&lt;Image&gt; m_image; // FIXME: Drawing images can cause their animations to progress. This shouldn&#39;t have to be mutable.
1326     FloatRect m_destination;
1327     FloatRect m_source;
1328     FloatSize m_tileScaleFactor;
1329     Image::TileRule m_hRule;
1330     Image::TileRule m_vRule;
1331     ImagePaintingOptions m_imagePaintingOptions;
1332 };
1333 
<a name="89" id="anc89"></a><span class="line-added">1334 template&lt;class Encoder&gt;</span>
<span class="line-added">1335 void DrawTiledScaledImage::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1336 {</span>
<span class="line-added">1337     ImageHandle imageHandle;</span>
<span class="line-added">1338     imageHandle.image = m_image.ptr();</span>
<span class="line-added">1339     encoder &lt;&lt; imageHandle;</span>
<span class="line-added">1340     encoder &lt;&lt; m_destination;</span>
<span class="line-added">1341     encoder &lt;&lt; m_source;</span>
<span class="line-added">1342     encoder &lt;&lt; m_tileScaleFactor;</span>
<span class="line-added">1343     encoder.encodeEnum(m_hRule);</span>
<span class="line-added">1344     encoder.encodeEnum(m_vRule);</span>
<span class="line-added">1345     encoder &lt;&lt; m_imagePaintingOptions;</span>
<span class="line-added">1346 }</span>
<span class="line-added">1347 </span>
<span class="line-added">1348 template&lt;class Decoder&gt;</span>
<span class="line-added">1349 Optional&lt;Ref&lt;DrawTiledScaledImage&gt;&gt; DrawTiledScaledImage::decode(Decoder&amp; decoder)</span>
<span class="line-added">1350 {</span>
<span class="line-added">1351     Optional&lt;ImageHandle&gt; imageHandle;</span>
<span class="line-added">1352     decoder &gt;&gt; imageHandle;</span>
<span class="line-added">1353     if (!imageHandle)</span>
<span class="line-added">1354         return WTF::nullopt;</span>
<span class="line-added">1355 </span>
<span class="line-added">1356     Optional&lt;FloatRect&gt; destination;</span>
<span class="line-added">1357     decoder &gt;&gt; destination;</span>
<span class="line-added">1358     if (!destination)</span>
<span class="line-added">1359         return WTF::nullopt;</span>
<span class="line-added">1360 </span>
<span class="line-added">1361     Optional&lt;FloatRect&gt; source;</span>
<span class="line-added">1362     decoder &gt;&gt; source;</span>
<span class="line-added">1363     if (!source)</span>
<span class="line-added">1364         return WTF::nullopt;</span>
<span class="line-added">1365 </span>
<span class="line-added">1366     Optional&lt;FloatSize&gt; tileScaleFactor;</span>
<span class="line-added">1367     decoder &gt;&gt; tileScaleFactor;</span>
<span class="line-added">1368     if (!tileScaleFactor)</span>
<span class="line-added">1369         return WTF::nullopt;</span>
<span class="line-added">1370 </span>
<span class="line-added">1371     Image::TileRule hRule;</span>
<span class="line-added">1372     if (!decoder.decodeEnum(hRule))</span>
<span class="line-added">1373         return WTF::nullopt;</span>
<span class="line-added">1374 </span>
<span class="line-added">1375     Image::TileRule vRule;</span>
<span class="line-added">1376     if (!decoder.decodeEnum(vRule))</span>
<span class="line-added">1377         return WTF::nullopt;</span>
<span class="line-added">1378 </span>
<span class="line-added">1379     Optional&lt;ImagePaintingOptions&gt; imagePaintingOptions;</span>
<span class="line-added">1380     decoder &gt;&gt; imagePaintingOptions;</span>
<span class="line-added">1381     if (!imagePaintingOptions)</span>
<span class="line-added">1382         return WTF::nullopt;</span>
<span class="line-added">1383 </span>
<span class="line-added">1384     return DrawTiledScaledImage::create(*imageHandle-&gt;image, *destination, *source, *tileScaleFactor, hRule, vRule, *imagePaintingOptions);</span>
<span class="line-added">1385 }</span>
<span class="line-added">1386 </span>
1387 #if USE(CG) || USE(CAIRO) || USE(DIRECT2D)
1388 class DrawNativeImage : public DrawingItem {
1389 public:
1390     static Ref&lt;DrawNativeImage&gt; create(const NativeImagePtr&amp; image, const FloatSize&amp; imageSize, const FloatRect&amp; destRect, const FloatRect&amp; srcRect, const ImagePaintingOptions&amp; options)
1391     {
1392         return adoptRef(*new DrawNativeImage(image, imageSize, destRect, srcRect, options));
1393     }
1394 
<a name="90" id="anc90"></a><span class="line-added">1395     WEBCORE_EXPORT virtual ~DrawNativeImage();</span>
<span class="line-added">1396 </span>
1397     FloatRect source() const { return m_srcRect; }
<a name="91" id="anc91"></a><span class="line-modified">1398     FloatRect destinationRect() const { return m_destinationRect; }</span>
<span class="line-added">1399 </span>
<span class="line-added">1400     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1401     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawNativeImage&gt;&gt; decode(Decoder&amp;);</span>
1402 
1403 private:
<a name="92" id="anc92"></a><span class="line-modified">1404     WEBCORE_EXPORT DrawNativeImage(const NativeImagePtr&amp;, const FloatSize&amp; selfSize, const FloatRect&amp; destRect, const FloatRect&amp; srcRect, const ImagePaintingOptions&amp;);</span>
1405 
1406     void apply(GraphicsContext&amp;) const override;
1407 
<a name="93" id="anc93"></a><span class="line-modified">1408     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_destinationRect; }</span>
1409 
1410 #if USE(CG)
<a name="94" id="anc94"></a><span class="line-modified">1411     NativeImagePtr m_image;</span>
1412 #endif
1413     FloatSize m_imageSize;
<a name="95" id="anc95"></a><span class="line-modified">1414     FloatRect m_destinationRect;</span>
1415     FloatRect m_srcRect;
1416     ImagePaintingOptions m_options;
1417 };
<a name="96" id="anc96"></a><span class="line-added">1418 </span>
<span class="line-added">1419 template&lt;class Encoder&gt;</span>
<span class="line-added">1420 void DrawNativeImage::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1421 {</span>
<span class="line-added">1422 #if USE(CG)</span>
<span class="line-added">1423     NativeImageHandle handle { m_image };</span>
<span class="line-added">1424     encoder &lt;&lt; handle;</span>
<span class="line-added">1425 #endif</span>
<span class="line-added">1426     encoder &lt;&lt; m_imageSize;</span>
<span class="line-added">1427     encoder &lt;&lt; m_destinationRect;</span>
<span class="line-added">1428     encoder &lt;&lt; m_srcRect;</span>
<span class="line-added">1429     encoder &lt;&lt; m_options;</span>
<span class="line-added">1430 }</span>
<span class="line-added">1431 </span>
<span class="line-added">1432 template&lt;class Decoder&gt;</span>
<span class="line-added">1433 Optional&lt;Ref&lt;DrawNativeImage&gt;&gt; DrawNativeImage::decode(Decoder&amp; decoder)</span>
<span class="line-added">1434 {</span>
<span class="line-added">1435 #if USE(CG)</span>
<span class="line-added">1436     Optional&lt;NativeImageHandle&gt; handle;</span>
<span class="line-added">1437     decoder &gt;&gt; handle;</span>
<span class="line-added">1438     if (!handle)</span>
<span class="line-added">1439         return WTF::nullopt;</span>
<span class="line-added">1440 #endif</span>
<span class="line-added">1441 </span>
<span class="line-added">1442     Optional&lt;FloatSize&gt; imageSize;</span>
<span class="line-added">1443     decoder &gt;&gt; imageSize;</span>
<span class="line-added">1444     if (!imageSize)</span>
<span class="line-added">1445         return WTF::nullopt;</span>
<span class="line-added">1446 </span>
<span class="line-added">1447     Optional&lt;FloatRect&gt; destinationRect;</span>
<span class="line-added">1448     decoder &gt;&gt; destinationRect;</span>
<span class="line-added">1449     if (!destinationRect)</span>
<span class="line-added">1450         return WTF::nullopt;</span>
<span class="line-added">1451 </span>
<span class="line-added">1452     Optional&lt;FloatRect&gt; srcRect;</span>
<span class="line-added">1453     decoder &gt;&gt; srcRect;</span>
<span class="line-added">1454     if (!srcRect)</span>
<span class="line-added">1455         return WTF::nullopt;</span>
<span class="line-added">1456 </span>
<span class="line-added">1457     Optional&lt;ImagePaintingOptions&gt; options;</span>
<span class="line-added">1458     decoder &gt;&gt; options;</span>
<span class="line-added">1459     if (!options)</span>
<span class="line-added">1460         return WTF::nullopt;</span>
<span class="line-added">1461 </span>
<span class="line-added">1462 #if USE(CG)</span>
<span class="line-added">1463     NativeImagePtr image = handle-&gt;image;</span>
<span class="line-added">1464 #else</span>
<span class="line-added">1465     NativeImagePtr image = nullptr;</span>
<span class="line-added">1466 #endif</span>
<span class="line-added">1467     return DrawNativeImage::create(image, *imageSize, *destinationRect, *srcRect, *options);</span>
<span class="line-added">1468 }</span>
1469 #endif
1470 
1471 class DrawPattern : public DrawingItem {
1472 public:
1473     static Ref&lt;DrawPattern&gt; create(Image&amp; image, const FloatRect&amp; destRect, const FloatRect&amp; tileRect, const AffineTransform&amp; patternTransform, const FloatPoint&amp; phase, const FloatSize&amp; spacing, const ImagePaintingOptions&amp; options)
1474     {
1475         return adoptRef(*new DrawPattern(image, destRect, tileRect, patternTransform, phase, spacing, options));
1476     }
1477 
<a name="97" id="anc97"></a><span class="line-added">1478     WEBCORE_EXPORT virtual ~DrawPattern();</span>
<span class="line-added">1479 </span>
1480     const Image&amp; image() const { return m_image.get(); }
1481     const AffineTransform&amp; patternTransform() const { return m_patternTransform; }
1482     FloatRect tileRect() const { return m_tileRect; }
1483     FloatRect destRect() const { return m_destination; }
1484     FloatPoint phase() const { return m_phase; }
1485     FloatSize spacing() const { return m_spacing; }
1486 
<a name="98" id="anc98"></a><span class="line-added">1487     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1488     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawPattern&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1489 </span>
1490 private:
<a name="99" id="anc99"></a><span class="line-modified">1491     WEBCORE_EXPORT DrawPattern(Image&amp;, const FloatRect&amp; destRect, const FloatRect&amp; srcRect, const AffineTransform&amp;, const FloatPoint&amp; phase, const FloatSize&amp; spacing, const ImagePaintingOptions&amp; = { });</span>
1492 
1493     void apply(GraphicsContext&amp;) const override;
1494 
1495     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_destination; }
1496 
1497     mutable Ref&lt;Image&gt; m_image; // FIXME: Drawing images can cause their animations to progress. This shouldn&#39;t have to be mutable.
1498     AffineTransform m_patternTransform;
1499     FloatRect m_tileRect;
1500     FloatRect m_destination;
1501     FloatPoint m_phase;
1502     FloatSize m_spacing;
1503     ImagePaintingOptions m_options;
1504 };
1505 
<a name="100" id="anc100"></a><span class="line-added">1506 template&lt;class Encoder&gt;</span>
<span class="line-added">1507 void DrawPattern::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1508 {</span>
<span class="line-added">1509     ImageHandle imageHandle;</span>
<span class="line-added">1510     imageHandle.image = m_image.ptr();</span>
<span class="line-added">1511     encoder &lt;&lt; imageHandle;</span>
<span class="line-added">1512     encoder &lt;&lt; m_patternTransform;</span>
<span class="line-added">1513     encoder &lt;&lt; m_tileRect;</span>
<span class="line-added">1514     encoder &lt;&lt; m_destination;</span>
<span class="line-added">1515     encoder &lt;&lt; m_phase;</span>
<span class="line-added">1516     encoder &lt;&lt; m_spacing;</span>
<span class="line-added">1517     encoder &lt;&lt; m_options;</span>
<span class="line-added">1518 }</span>
<span class="line-added">1519 </span>
<span class="line-added">1520 template&lt;class Decoder&gt;</span>
<span class="line-added">1521 Optional&lt;Ref&lt;DrawPattern&gt;&gt; DrawPattern::decode(Decoder&amp; decoder)</span>
<span class="line-added">1522 {</span>
<span class="line-added">1523     Optional&lt;ImageHandle&gt; imageHandle;</span>
<span class="line-added">1524     decoder &gt;&gt; imageHandle;</span>
<span class="line-added">1525     if (!imageHandle)</span>
<span class="line-added">1526         return WTF::nullopt;</span>
<span class="line-added">1527 </span>
<span class="line-added">1528     Optional&lt;AffineTransform&gt; patternTransform;</span>
<span class="line-added">1529     decoder &gt;&gt; patternTransform;</span>
<span class="line-added">1530     if (!patternTransform)</span>
<span class="line-added">1531         return WTF::nullopt;</span>
<span class="line-added">1532 </span>
<span class="line-added">1533     Optional&lt;FloatRect&gt; tileRect;</span>
<span class="line-added">1534     decoder &gt;&gt; tileRect;</span>
<span class="line-added">1535     if (!tileRect)</span>
<span class="line-added">1536         return WTF::nullopt;</span>
<span class="line-added">1537 </span>
<span class="line-added">1538     Optional&lt;FloatRect&gt; destination;</span>
<span class="line-added">1539     decoder &gt;&gt; destination;</span>
<span class="line-added">1540     if (!destination)</span>
<span class="line-added">1541         return WTF::nullopt;</span>
<span class="line-added">1542 </span>
<span class="line-added">1543     Optional&lt;FloatPoint&gt; phase;</span>
<span class="line-added">1544     decoder &gt;&gt; phase;</span>
<span class="line-added">1545     if (!phase)</span>
<span class="line-added">1546         return WTF::nullopt;</span>
<span class="line-added">1547 </span>
<span class="line-added">1548     Optional&lt;FloatSize&gt; spacing;</span>
<span class="line-added">1549     decoder &gt;&gt; spacing;</span>
<span class="line-added">1550     if (!spacing)</span>
<span class="line-added">1551         return WTF::nullopt;</span>
<span class="line-added">1552 </span>
<span class="line-added">1553     Optional&lt;ImagePaintingOptions&gt; options;</span>
<span class="line-added">1554     decoder &gt;&gt; options;</span>
<span class="line-added">1555     if (!options)</span>
<span class="line-added">1556         return WTF::nullopt;</span>
<span class="line-added">1557 </span>
<span class="line-added">1558     return DrawPattern::create(*imageHandle-&gt;image, *destination, *tileRect, *patternTransform, *phase, *spacing, *options);</span>
<span class="line-added">1559 }</span>
<span class="line-added">1560 </span>
1561 // Is DrawingItem because the size of the transparency layer is implicitly the clip bounds.
1562 class BeginTransparencyLayer : public DrawingItem {
1563 public:
1564     static Ref&lt;BeginTransparencyLayer&gt; create(float opacity)
1565     {
1566         return adoptRef(*new BeginTransparencyLayer(opacity));
1567     }
1568 
<a name="101" id="anc101"></a><span class="line-added">1569     WEBCORE_EXPORT virtual ~BeginTransparencyLayer();</span>
<span class="line-added">1570 </span>
1571     float opacity() const { return m_opacity; }
1572 
<a name="102" id="anc102"></a><span class="line-added">1573     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1574     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;BeginTransparencyLayer&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1575 </span>
1576 private:
<a name="103" id="anc103"></a><span class="line-modified">1577     WEBCORE_EXPORT BeginTransparencyLayer(float opacity);</span>




1578 
1579     void apply(GraphicsContext&amp;) const override;
1580 
1581     float m_opacity;
1582 };
1583 
<a name="104" id="anc104"></a><span class="line-added">1584 template&lt;class Encoder&gt;</span>
<span class="line-added">1585 void BeginTransparencyLayer::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1586 {</span>
<span class="line-added">1587     encoder &lt;&lt; m_opacity;</span>
<span class="line-added">1588 }</span>
<span class="line-added">1589 </span>
<span class="line-added">1590 template&lt;class Decoder&gt;</span>
<span class="line-added">1591 Optional&lt;Ref&lt;BeginTransparencyLayer&gt;&gt; BeginTransparencyLayer::decode(Decoder&amp; decoder)</span>
<span class="line-added">1592 {</span>
<span class="line-added">1593     Optional&lt;float&gt; opacity;</span>
<span class="line-added">1594     decoder &gt;&gt; opacity;</span>
<span class="line-added">1595     if (!opacity)</span>
<span class="line-added">1596         return WTF::nullopt;</span>
<span class="line-added">1597 </span>
<span class="line-added">1598     return BeginTransparencyLayer::create(*opacity);</span>
<span class="line-added">1599 }</span>
<span class="line-added">1600 </span>
1601 class EndTransparencyLayer : public DrawingItem {
1602 public:
1603     static Ref&lt;EndTransparencyLayer&gt; create()
1604     {
1605         return adoptRef(*new EndTransparencyLayer);
1606     }
1607 
<a name="105" id="anc105"></a><span class="line-added">1608     WEBCORE_EXPORT virtual ~EndTransparencyLayer();</span>
<span class="line-added">1609 </span>
<span class="line-added">1610     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1611     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;EndTransparencyLayer&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1612 </span>
1613 private:
<a name="106" id="anc106"></a><span class="line-modified">1614     WEBCORE_EXPORT EndTransparencyLayer();</span>



1615 
1616     void apply(GraphicsContext&amp;) const override;
1617 };
1618 
<a name="107" id="anc107"></a><span class="line-added">1619 template&lt;class Encoder&gt;</span>
<span class="line-added">1620 void EndTransparencyLayer::encode(Encoder&amp;) const</span>
<span class="line-added">1621 {</span>
<span class="line-added">1622 }</span>
<span class="line-added">1623 </span>
<span class="line-added">1624 template&lt;class Decoder&gt;</span>
<span class="line-added">1625 Optional&lt;Ref&lt;EndTransparencyLayer&gt;&gt; EndTransparencyLayer::decode(Decoder&amp;)</span>
<span class="line-added">1626 {</span>
<span class="line-added">1627     return EndTransparencyLayer::create();</span>
<span class="line-added">1628 }</span>
<span class="line-added">1629 </span>
1630 class DrawRect : public DrawingItem {
1631 public:
1632     static Ref&lt;DrawRect&gt; create(const FloatRect&amp; rect, float borderThickness)
1633     {
1634         return adoptRef(*new DrawRect(rect, borderThickness));
1635     }
1636 
<a name="108" id="anc108"></a><span class="line-added">1637     WEBCORE_EXPORT virtual ~DrawRect();</span>
<span class="line-added">1638 </span>
1639     FloatRect rect() const { return m_rect; }
1640     float borderThickness() const { return m_borderThickness; }
1641 
<a name="109" id="anc109"></a><span class="line-added">1642     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1643     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawRect&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1644 </span>
1645 private:
<a name="110" id="anc110"></a><span class="line-modified">1646     WEBCORE_EXPORT DrawRect(const FloatRect&amp;, float borderThickness);</span>





1647 
1648     void apply(GraphicsContext&amp;) const override;
1649     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_rect; }
1650 
1651     FloatRect m_rect;
1652     float m_borderThickness;
1653 };
1654 
<a name="111" id="anc111"></a><span class="line-added">1655 template&lt;class Encoder&gt;</span>
<span class="line-added">1656 void DrawRect::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1657 {</span>
<span class="line-added">1658     encoder &lt;&lt; m_rect;</span>
<span class="line-added">1659     encoder &lt;&lt; m_borderThickness;</span>
<span class="line-added">1660 }</span>
<span class="line-added">1661 </span>
<span class="line-added">1662 template&lt;class Decoder&gt;</span>
<span class="line-added">1663 Optional&lt;Ref&lt;DrawRect&gt;&gt; DrawRect::decode(Decoder&amp; decoder)</span>
<span class="line-added">1664 {</span>
<span class="line-added">1665     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added">1666     decoder &gt;&gt; rect;</span>
<span class="line-added">1667     if (!rect)</span>
<span class="line-added">1668         return WTF::nullopt;</span>
<span class="line-added">1669 </span>
<span class="line-added">1670     Optional&lt;float&gt; borderThickness;</span>
<span class="line-added">1671     decoder &gt;&gt; borderThickness;</span>
<span class="line-added">1672     if (!borderThickness)</span>
<span class="line-added">1673         return WTF::nullopt;</span>
<span class="line-added">1674 </span>
<span class="line-added">1675     return DrawRect::create(*rect, *borderThickness);</span>
<span class="line-added">1676 }</span>
<span class="line-added">1677 </span>
1678 class DrawLine : public DrawingItem {
1679 public:
1680     static Ref&lt;DrawLine&gt; create(const FloatPoint&amp; point1, const FloatPoint&amp; point2)
1681     {
1682         return adoptRef(*new DrawLine(point1, point2));
1683     }
1684 
<a name="112" id="anc112"></a><span class="line-added">1685     WEBCORE_EXPORT virtual ~DrawLine();</span>
<span class="line-added">1686 </span>
1687     FloatPoint point1() const { return m_point1; }
1688     FloatPoint point2() const { return m_point2; }
1689 
<a name="113" id="anc113"></a><span class="line-added">1690     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1691     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawLine&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1692 </span>
1693 private:
<a name="114" id="anc114"></a><span class="line-modified">1694     WEBCORE_EXPORT DrawLine(const FloatPoint&amp;, const FloatPoint&amp;);</span>





1695 
1696     void apply(GraphicsContext&amp;) const override;
1697     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override;
1698 
1699     FloatPoint m_point1;
1700     FloatPoint m_point2;
1701 };
1702 
<a name="115" id="anc115"></a><span class="line-added">1703 template&lt;class Encoder&gt;</span>
<span class="line-added">1704 void DrawLine::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1705 {</span>
<span class="line-added">1706     encoder &lt;&lt; m_point1;</span>
<span class="line-added">1707     encoder &lt;&lt; m_point2;</span>
<span class="line-added">1708 }</span>
<span class="line-added">1709 </span>
<span class="line-added">1710 template&lt;class Decoder&gt;</span>
<span class="line-added">1711 Optional&lt;Ref&lt;DrawLine&gt;&gt; DrawLine::decode(Decoder&amp; decoder)</span>
<span class="line-added">1712 {</span>
<span class="line-added">1713     Optional&lt;FloatPoint&gt; point1;</span>
<span class="line-added">1714     decoder &gt;&gt; point1;</span>
<span class="line-added">1715     if (!point1)</span>
<span class="line-added">1716         return WTF::nullopt;</span>
<span class="line-added">1717 </span>
<span class="line-added">1718     Optional&lt;FloatPoint&gt; point2;</span>
<span class="line-added">1719     decoder &gt;&gt; point2;</span>
<span class="line-added">1720     if (!point2)</span>
<span class="line-added">1721         return WTF::nullopt;</span>
<span class="line-added">1722 </span>
<span class="line-added">1723     return DrawLine::create(*point1, *point2);</span>
<span class="line-added">1724 }</span>
<span class="line-added">1725 </span>
1726 class DrawLinesForText : public DrawingItem {
1727 public:
1728     static Ref&lt;DrawLinesForText&gt; create(const FloatPoint&amp; blockLocation, const FloatSize&amp; localAnchor, float thickness, const DashArray&amp; widths, bool printing, bool doubleLines)
1729     {
1730         return adoptRef(*new DrawLinesForText(blockLocation, localAnchor, thickness, widths, printing, doubleLines));
1731     }
1732 
<a name="116" id="anc116"></a><span class="line-added">1733     WEBCORE_EXPORT virtual ~DrawLinesForText();</span>
<span class="line-added">1734 </span>
1735     void setBlockLocation(const FloatPoint&amp; blockLocation) { m_blockLocation = blockLocation; }
1736     const FloatPoint&amp; blockLocation() const { return m_blockLocation; }
1737     const FloatSize&amp; localAnchor() const { return m_localAnchor; }
1738     FloatPoint point() const { return m_blockLocation + m_localAnchor; }
1739     float thickness() const { return m_thickness; }
1740     const DashArray&amp; widths() const { return m_widths; }
1741     bool isPrinting() const { return m_printing; }
1742     bool doubleLines() const { return m_doubleLines; }
1743 
<a name="117" id="anc117"></a><span class="line-added">1744     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1745     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawLinesForText&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1746 </span>
1747 private:
<a name="118" id="anc118"></a><span class="line-modified">1748     WEBCORE_EXPORT DrawLinesForText(const FloatPoint&amp; blockLocation, const FloatSize&amp; localAnchor, float thickness, const DashArray&amp; widths, bool printing, bool doubleLines);</span>









1749 
1750     void apply(GraphicsContext&amp;) const override;
1751 
1752     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override;
1753 
1754     FloatPoint m_blockLocation;
1755     FloatSize m_localAnchor;
1756     DashArray m_widths;
1757     float m_thickness;
1758     bool m_printing;
1759     bool m_doubleLines;
1760 };
1761 
<a name="119" id="anc119"></a><span class="line-added">1762 template&lt;class Encoder&gt;</span>
<span class="line-added">1763 void DrawLinesForText::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1764 {</span>
<span class="line-added">1765     encoder &lt;&lt; m_blockLocation;</span>
<span class="line-added">1766     encoder &lt;&lt; m_localAnchor;</span>
<span class="line-added">1767     encoder &lt;&lt; m_widths;</span>
<span class="line-added">1768     encoder &lt;&lt; m_thickness;</span>
<span class="line-added">1769     encoder &lt;&lt; m_printing;</span>
<span class="line-added">1770     encoder &lt;&lt; m_doubleLines;</span>
<span class="line-added">1771 }</span>
<span class="line-added">1772 </span>
<span class="line-added">1773 template&lt;class Decoder&gt;</span>
<span class="line-added">1774 Optional&lt;Ref&lt;DrawLinesForText&gt;&gt; DrawLinesForText::decode(Decoder&amp; decoder)</span>
<span class="line-added">1775 {</span>
<span class="line-added">1776     Optional&lt;FloatPoint&gt; blockLocation;</span>
<span class="line-added">1777     decoder &gt;&gt; blockLocation;</span>
<span class="line-added">1778     if (!blockLocation)</span>
<span class="line-added">1779         return WTF::nullopt;</span>
<span class="line-added">1780 </span>
<span class="line-added">1781     Optional&lt;FloatSize&gt; localAnchor;</span>
<span class="line-added">1782     decoder &gt;&gt; localAnchor;</span>
<span class="line-added">1783     if (!localAnchor)</span>
<span class="line-added">1784         return WTF::nullopt;</span>
<span class="line-added">1785 </span>
<span class="line-added">1786     Optional&lt;DashArray&gt; widths;</span>
<span class="line-added">1787     decoder &gt;&gt; widths;</span>
<span class="line-added">1788     if (!widths)</span>
<span class="line-added">1789         return WTF::nullopt;</span>
<span class="line-added">1790 </span>
<span class="line-added">1791     Optional&lt;float&gt; thickness;</span>
<span class="line-added">1792     decoder &gt;&gt; thickness;</span>
<span class="line-added">1793     if (!thickness)</span>
<span class="line-added">1794         return WTF::nullopt;</span>
<span class="line-added">1795 </span>
<span class="line-added">1796     Optional&lt;bool&gt; printing;</span>
<span class="line-added">1797     decoder &gt;&gt; printing;</span>
<span class="line-added">1798     if (!printing)</span>
<span class="line-added">1799         return WTF::nullopt;</span>
<span class="line-added">1800 </span>
<span class="line-added">1801     Optional&lt;bool&gt; doubleLines;</span>
<span class="line-added">1802     decoder &gt;&gt; doubleLines;</span>
<span class="line-added">1803     if (!doubleLines)</span>
<span class="line-added">1804         return WTF::nullopt;</span>
<span class="line-added">1805 </span>
<span class="line-added">1806     return DrawLinesForText::create(*blockLocation, *localAnchor, *thickness, *widths, *printing, *doubleLines);</span>
<span class="line-added">1807 }</span>
<span class="line-added">1808 </span>
1809 class DrawDotsForDocumentMarker : public DrawingItem {
1810 public:
1811     static Ref&lt;DrawDotsForDocumentMarker&gt; create(const FloatRect&amp; rect, DocumentMarkerLineStyle style)
1812     {
1813         return adoptRef(*new DrawDotsForDocumentMarker(rect, style));
1814     }
1815 
<a name="120" id="anc120"></a><span class="line-added">1816     WEBCORE_EXPORT virtual ~DrawDotsForDocumentMarker();</span>
<span class="line-added">1817 </span>
1818     FloatRect rect() const { return m_rect; }
1819 
<a name="121" id="anc121"></a><span class="line-added">1820     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1821     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawDotsForDocumentMarker&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1822 </span>
1823 private:
<a name="122" id="anc122"></a><span class="line-modified">1824     WEBCORE_EXPORT DrawDotsForDocumentMarker(const FloatRect&amp;, DocumentMarkerLineStyle);</span>





1825 
1826     void apply(GraphicsContext&amp;) const override;
1827 
1828     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override;
1829 
1830     FloatRect m_rect;
1831     DocumentMarkerLineStyle m_style;
1832 };
1833 
<a name="123" id="anc123"></a><span class="line-added">1834 template&lt;class Encoder&gt;</span>
<span class="line-added">1835 void DrawDotsForDocumentMarker::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1836 {</span>
<span class="line-added">1837     encoder &lt;&lt; m_rect;</span>
<span class="line-added">1838     encoder &lt;&lt; m_style;</span>
<span class="line-added">1839 }</span>
<span class="line-added">1840 </span>
<span class="line-added">1841 template&lt;class Decoder&gt;</span>
<span class="line-added">1842 Optional&lt;Ref&lt;DrawDotsForDocumentMarker&gt;&gt; DrawDotsForDocumentMarker::decode(Decoder&amp; decoder)</span>
<span class="line-added">1843 {</span>
<span class="line-added">1844     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added">1845     decoder &gt;&gt; rect;</span>
<span class="line-added">1846     if (!rect)</span>
<span class="line-added">1847         return WTF::nullopt;</span>
<span class="line-added">1848 </span>
<span class="line-added">1849     Optional&lt;DocumentMarkerLineStyle&gt; style;</span>
<span class="line-added">1850     decoder &gt;&gt; style;</span>
<span class="line-added">1851     if (!style)</span>
<span class="line-added">1852         return WTF::nullopt;</span>
<span class="line-added">1853 </span>
<span class="line-added">1854     return DrawDotsForDocumentMarker::create(*rect, *style);</span>
<span class="line-added">1855 }</span>
<span class="line-added">1856 </span>
1857 class DrawEllipse : public DrawingItem {
1858 public:
1859     static Ref&lt;DrawEllipse&gt; create(const FloatRect&amp; rect)
1860     {
1861         return adoptRef(*new DrawEllipse(rect));
1862     }
1863 
<a name="124" id="anc124"></a><span class="line-added">1864     WEBCORE_EXPORT ~DrawEllipse();</span>
<span class="line-added">1865 </span>
1866     FloatRect rect() const { return m_rect; }
1867 
<a name="125" id="anc125"></a><span class="line-added">1868     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1869     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawEllipse&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1870 </span>
1871 private:
<a name="126" id="anc126"></a><span class="line-modified">1872     WEBCORE_EXPORT DrawEllipse(const FloatRect&amp;);</span>




1873 
1874     void apply(GraphicsContext&amp;) const override;
1875     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_rect; }
1876 
1877     FloatRect m_rect;
1878 };
1879 
<a name="127" id="anc127"></a><span class="line-added">1880 template&lt;class Encoder&gt;</span>
<span class="line-added">1881 void DrawEllipse::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1882 {</span>
<span class="line-added">1883     encoder &lt;&lt; m_rect;</span>
<span class="line-added">1884 }</span>
<span class="line-added">1885 </span>
<span class="line-added">1886 template&lt;class Decoder&gt;</span>
<span class="line-added">1887 Optional&lt;Ref&lt;DrawEllipse&gt;&gt; DrawEllipse::decode(Decoder&amp; decoder)</span>
<span class="line-added">1888 {</span>
<span class="line-added">1889     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added">1890     decoder &gt;&gt; rect;</span>
<span class="line-added">1891     if (!rect)</span>
<span class="line-added">1892         return WTF::nullopt;</span>
<span class="line-added">1893 </span>
<span class="line-added">1894     return DrawEllipse::create(*rect);</span>
<span class="line-added">1895 }</span>
<span class="line-added">1896 </span>
1897 class DrawPath : public DrawingItem {
1898 public:
1899     static Ref&lt;DrawPath&gt; create(const Path&amp; path)
1900     {
1901         return adoptRef(*new DrawPath(path));
1902     }
1903 
<a name="128" id="anc128"></a><span class="line-added">1904     WEBCORE_EXPORT virtual ~DrawPath();</span>
<span class="line-added">1905 </span>
1906     const Path&amp; path() const { return m_path; }
1907 
<a name="129" id="anc129"></a><span class="line-added">1908     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1909     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawPath&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1910 </span>
1911 private:
<a name="130" id="anc130"></a><span class="line-modified">1912     WEBCORE_EXPORT DrawPath(const Path&amp;);</span>




1913 
1914     void apply(GraphicsContext&amp;) const override;
1915 
1916     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_path.fastBoundingRect(); }
1917 
1918     const Path m_path;
1919 };
1920 
<a name="131" id="anc131"></a><span class="line-added">1921 template&lt;class Encoder&gt;</span>
<span class="line-added">1922 void DrawPath::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1923 {</span>
<span class="line-added">1924     encoder &lt;&lt; m_path;</span>
<span class="line-added">1925 }</span>
<span class="line-added">1926 </span>
<span class="line-added">1927 template&lt;class Decoder&gt;</span>
<span class="line-added">1928 Optional&lt;Ref&lt;DrawPath&gt;&gt; DrawPath::decode(Decoder&amp; decoder)</span>
<span class="line-added">1929 {</span>
<span class="line-added">1930     Optional&lt;Path&gt; path;</span>
<span class="line-added">1931     decoder &gt;&gt; path;</span>
<span class="line-added">1932     if (!path)</span>
<span class="line-added">1933         return WTF::nullopt;</span>
<span class="line-added">1934 </span>
<span class="line-added">1935     return DrawPath::create(*path);</span>
<span class="line-added">1936 }</span>
<span class="line-added">1937 </span>
1938 class DrawFocusRingPath : public DrawingItem {
1939 public:
1940     static Ref&lt;DrawFocusRingPath&gt; create(const Path&amp; path, float width, float offset, const Color&amp; color)
1941     {
1942         return adoptRef(*new DrawFocusRingPath(path, width, offset, color));
1943     }
1944 
<a name="132" id="anc132"></a><span class="line-added">1945     WEBCORE_EXPORT virtual ~DrawFocusRingPath();</span>
<span class="line-added">1946 </span>
1947     const Path&amp; path() const { return m_path; }
1948     float width() const { return m_width; }
1949     float offset() const { return m_offset; }
1950     const Color&amp; color() const { return m_color; }
1951 
<a name="133" id="anc133"></a><span class="line-added">1952     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">1953     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawFocusRingPath&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">1954 </span>
1955 private:
<a name="134" id="anc134"></a><span class="line-modified">1956     WEBCORE_EXPORT DrawFocusRingPath(const Path&amp;, float width, float offset, const Color&amp;);</span>







1957 
1958     void apply(GraphicsContext&amp;) const override;
1959 
1960     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override;
1961 
1962     const Path m_path;
1963     float m_width;
1964     float m_offset;
1965     Color m_color;
1966 };
1967 
<a name="135" id="anc135"></a><span class="line-added">1968 template&lt;class Encoder&gt;</span>
<span class="line-added">1969 void DrawFocusRingPath::encode(Encoder&amp; encoder) const</span>
<span class="line-added">1970 {</span>
<span class="line-added">1971     encoder &lt;&lt; m_path;</span>
<span class="line-added">1972     encoder &lt;&lt; m_width;</span>
<span class="line-added">1973     encoder &lt;&lt; m_offset;</span>
<span class="line-added">1974     encoder &lt;&lt; m_color;</span>
<span class="line-added">1975 }</span>
<span class="line-added">1976 </span>
<span class="line-added">1977 template&lt;class Decoder&gt;</span>
<span class="line-added">1978 Optional&lt;Ref&lt;DrawFocusRingPath&gt;&gt; DrawFocusRingPath::decode(Decoder&amp; decoder)</span>
<span class="line-added">1979 {</span>
<span class="line-added">1980     Optional&lt;Path&gt; path;</span>
<span class="line-added">1981     decoder &gt;&gt; path;</span>
<span class="line-added">1982     if (!path)</span>
<span class="line-added">1983         return WTF::nullopt;</span>
<span class="line-added">1984 </span>
<span class="line-added">1985     Optional&lt;float&gt; width;</span>
<span class="line-added">1986     decoder &gt;&gt; width;</span>
<span class="line-added">1987     if (!width)</span>
<span class="line-added">1988         return WTF::nullopt;</span>
<span class="line-added">1989 </span>
<span class="line-added">1990     Optional&lt;float&gt; offset;</span>
<span class="line-added">1991     decoder &gt;&gt; offset;</span>
<span class="line-added">1992     if (!offset)</span>
<span class="line-added">1993         return WTF::nullopt;</span>
<span class="line-added">1994 </span>
<span class="line-added">1995     Optional&lt;Color&gt; color;</span>
<span class="line-added">1996     decoder &gt;&gt; color;</span>
<span class="line-added">1997     if (!color)</span>
<span class="line-added">1998         return WTF::nullopt;</span>
<span class="line-added">1999 </span>
<span class="line-added">2000     return DrawFocusRingPath::create(*path, *width, *offset, *color);</span>
<span class="line-added">2001 }</span>
<span class="line-added">2002 </span>
2003 class DrawFocusRingRects : public DrawingItem {
2004 public:
2005     static Ref&lt;DrawFocusRingRects&gt; create(const Vector&lt;FloatRect&gt;&amp; rects, float width, float offset, const Color&amp; color)
2006     {
2007         return adoptRef(*new DrawFocusRingRects(rects, width, offset, color));
2008     }
2009 
<a name="136" id="anc136"></a><span class="line-added">2010     WEBCORE_EXPORT virtual ~DrawFocusRingRects();</span>
<span class="line-added">2011 </span>
2012     const Vector&lt;FloatRect&gt; rects() const { return m_rects; }
2013     float width() const { return m_width; }
2014     float offset() const { return m_offset; }
2015     const Color&amp; color() const { return m_color; }
2016 
<a name="137" id="anc137"></a><span class="line-added">2017     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2018     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;DrawFocusRingRects&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2019 </span>
2020 private:
<a name="138" id="anc138"></a><span class="line-modified">2021     WEBCORE_EXPORT DrawFocusRingRects(const Vector&lt;FloatRect&gt;&amp;, float width, float offset, const Color&amp;);</span>







2022 
2023     void apply(GraphicsContext&amp;) const override;
2024 
2025     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override;
2026 
2027     Vector&lt;FloatRect&gt; m_rects;
2028     float m_width;
2029     float m_offset;
2030     Color m_color;
2031 };
2032 
<a name="139" id="anc139"></a><span class="line-added">2033 template&lt;class Encoder&gt;</span>
<span class="line-added">2034 void DrawFocusRingRects::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2035 {</span>
<span class="line-added">2036     encoder &lt;&lt; m_rects;</span>
<span class="line-added">2037     encoder &lt;&lt; m_width;</span>
<span class="line-added">2038     encoder &lt;&lt; m_offset;</span>
<span class="line-added">2039     encoder &lt;&lt; m_color;</span>
<span class="line-added">2040 }</span>
<span class="line-added">2041 </span>
<span class="line-added">2042 template&lt;class Decoder&gt;</span>
<span class="line-added">2043 Optional&lt;Ref&lt;DrawFocusRingRects&gt;&gt; DrawFocusRingRects::decode(Decoder&amp; decoder)</span>
<span class="line-added">2044 {</span>
<span class="line-added">2045     Optional&lt;Vector&lt;FloatRect&gt;&gt; rects;</span>
<span class="line-added">2046     decoder &gt;&gt; rects;</span>
<span class="line-added">2047     if (!rects)</span>
<span class="line-added">2048         return WTF::nullopt;</span>
<span class="line-added">2049 </span>
<span class="line-added">2050     Optional&lt;float&gt; width;</span>
<span class="line-added">2051     decoder &gt;&gt; width;</span>
<span class="line-added">2052     if (!width)</span>
<span class="line-added">2053         return WTF::nullopt;</span>
<span class="line-added">2054 </span>
<span class="line-added">2055     Optional&lt;float&gt; offset;</span>
<span class="line-added">2056     decoder &gt;&gt; offset;</span>
<span class="line-added">2057     if (!offset)</span>
<span class="line-added">2058         return WTF::nullopt;</span>
<span class="line-added">2059 </span>
<span class="line-added">2060     Optional&lt;Color&gt; color;</span>
<span class="line-added">2061     decoder &gt;&gt; color;</span>
<span class="line-added">2062     if (!color)</span>
<span class="line-added">2063         return WTF::nullopt;</span>
<span class="line-added">2064 </span>
<span class="line-added">2065     return DrawFocusRingRects::create(*rects, *width, *offset, *color);</span>
<span class="line-added">2066 }</span>
<span class="line-added">2067 </span>
2068 class FillRect : public DrawingItem {
2069 public:
2070     static Ref&lt;FillRect&gt; create(const FloatRect&amp; rect)
2071     {
2072         return adoptRef(*new FillRect(rect));
2073     }
2074 
<a name="140" id="anc140"></a><span class="line-added">2075     WEBCORE_EXPORT virtual ~FillRect();</span>
<span class="line-added">2076 </span>
2077     FloatRect rect() const { return m_rect; }
2078 
<a name="141" id="anc141"></a><span class="line-added">2079     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2080     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;FillRect&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2081 </span>
2082 private:
<a name="142" id="anc142"></a><span class="line-modified">2083     WEBCORE_EXPORT FillRect(const FloatRect&amp;);</span>




2084 
2085     void apply(GraphicsContext&amp;) const override;
2086     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_rect; }
2087 
2088     FloatRect m_rect;
2089 };
2090 
<a name="143" id="anc143"></a><span class="line-added">2091 template&lt;class Encoder&gt;</span>
<span class="line-added">2092 void FillRect::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2093 {</span>
<span class="line-added">2094     encoder &lt;&lt; m_rect;</span>
<span class="line-added">2095 }</span>
<span class="line-added">2096 </span>
<span class="line-added">2097 template&lt;class Decoder&gt;</span>
<span class="line-added">2098 Optional&lt;Ref&lt;FillRect&gt;&gt; FillRect::decode(Decoder&amp; decoder)</span>
<span class="line-added">2099 {</span>
<span class="line-added">2100     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added">2101     decoder &gt;&gt; rect;</span>
<span class="line-added">2102     if (!rect)</span>
<span class="line-added">2103         return WTF::nullopt;</span>
<span class="line-added">2104 </span>
<span class="line-added">2105     return FillRect::create(*rect);</span>
<span class="line-added">2106 }</span>
<span class="line-added">2107 </span>
2108 // FIXME: Make these inherit from FillRect proper.
2109 class FillRectWithColor : public DrawingItem {
2110 public:
2111     static Ref&lt;FillRectWithColor&gt; create(const FloatRect&amp; rect, const Color&amp; color)
2112     {
2113         return adoptRef(*new FillRectWithColor(rect, color));
2114     }
2115 
<a name="144" id="anc144"></a><span class="line-added">2116     WEBCORE_EXPORT virtual ~FillRectWithColor();</span>
<span class="line-added">2117 </span>
2118     FloatRect rect() const { return m_rect; }
2119     const Color&amp; color() const { return m_color; }
2120 
<a name="145" id="anc145"></a><span class="line-added">2121     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2122     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;FillRectWithColor&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2123 </span>
2124 private:
<a name="146" id="anc146"></a><span class="line-modified">2125     WEBCORE_EXPORT FillRectWithColor(const FloatRect&amp;, const Color&amp;);</span>





2126 
2127     void apply(GraphicsContext&amp;) const override;
2128     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_rect; }
2129 
2130     FloatRect m_rect;
2131     Color m_color;
2132 };
2133 
<a name="147" id="anc147"></a><span class="line-added">2134 template&lt;class Encoder&gt;</span>
<span class="line-added">2135 void FillRectWithColor::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2136 {</span>
<span class="line-added">2137     encoder &lt;&lt; m_rect;</span>
<span class="line-added">2138     encoder &lt;&lt; m_color;</span>
<span class="line-added">2139 }</span>
<span class="line-added">2140 </span>
<span class="line-added">2141 template&lt;class Decoder&gt;</span>
<span class="line-added">2142 Optional&lt;Ref&lt;FillRectWithColor&gt;&gt; FillRectWithColor::decode(Decoder&amp; decoder)</span>
<span class="line-added">2143 {</span>
<span class="line-added">2144     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added">2145     decoder &gt;&gt; rect;</span>
<span class="line-added">2146     if (!rect)</span>
<span class="line-added">2147         return WTF::nullopt;</span>
<span class="line-added">2148 </span>
<span class="line-added">2149     Optional&lt;Color&gt; color;</span>
<span class="line-added">2150     decoder &gt;&gt; color;</span>
<span class="line-added">2151     if (!color)</span>
<span class="line-added">2152         return WTF::nullopt;</span>
<span class="line-added">2153 </span>
<span class="line-added">2154     return FillRectWithColor::create(*rect, *color);</span>
<span class="line-added">2155 }</span>
<span class="line-added">2156 </span>
2157 class FillRectWithGradient : public DrawingItem {
2158 public:
2159     static Ref&lt;FillRectWithGradient&gt; create(const FloatRect&amp; rect, Gradient&amp; gradient)
2160     {
2161         return adoptRef(*new FillRectWithGradient(rect, gradient));
2162     }
2163 
<a name="148" id="anc148"></a><span class="line-added">2164     WEBCORE_EXPORT virtual ~FillRectWithGradient();</span>
<span class="line-added">2165 </span>
2166     FloatRect rect() const { return m_rect; }
2167 
<a name="149" id="anc149"></a><span class="line-added">2168     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2169     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;FillRectWithGradient&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2170 </span>
2171 private:
<a name="150" id="anc150"></a><span class="line-modified">2172     WEBCORE_EXPORT FillRectWithGradient(const FloatRect&amp;, Gradient&amp;);</span>





2173 
2174     void apply(GraphicsContext&amp;) const override;
2175     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_rect; }
2176 
2177     FloatRect m_rect;
2178     mutable Ref&lt;Gradient&gt; m_gradient; // FIXME: Make this not mutable
2179 };
2180 
<a name="151" id="anc151"></a><span class="line-added">2181 template&lt;class Encoder&gt;</span>
<span class="line-added">2182 void FillRectWithGradient::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2183 {</span>
<span class="line-added">2184     encoder &lt;&lt; m_rect;</span>
<span class="line-added">2185     encoder &lt;&lt; m_gradient.get();</span>
<span class="line-added">2186 }</span>
<span class="line-added">2187 </span>
<span class="line-added">2188 template&lt;class Decoder&gt;</span>
<span class="line-added">2189 Optional&lt;Ref&lt;FillRectWithGradient&gt;&gt; FillRectWithGradient::decode(Decoder&amp; decoder)</span>
<span class="line-added">2190 {</span>
<span class="line-added">2191     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added">2192     decoder &gt;&gt; rect;</span>
<span class="line-added">2193     if (!rect)</span>
<span class="line-added">2194         return WTF::nullopt;</span>
<span class="line-added">2195 </span>
<span class="line-added">2196     auto gradient = Gradient::decode(decoder);</span>
<span class="line-added">2197     if (!gradient)</span>
<span class="line-added">2198         return WTF::nullopt;</span>
<span class="line-added">2199 </span>
<span class="line-added">2200     return FillRectWithGradient::create(*rect, gradient-&gt;get());</span>
<span class="line-added">2201 }</span>
<span class="line-added">2202 </span>
2203 class FillCompositedRect : public DrawingItem {
2204 public:
2205     static Ref&lt;FillCompositedRect&gt; create(const FloatRect&amp; rect, const Color&amp; color, CompositeOperator op, BlendMode blendMode)
2206     {
2207         return adoptRef(*new FillCompositedRect(rect, color, op, blendMode));
2208     }
2209 
<a name="152" id="anc152"></a><span class="line-added">2210     WEBCORE_EXPORT virtual ~FillCompositedRect();</span>
<span class="line-added">2211 </span>
2212     FloatRect rect() const { return m_rect; }
2213     const Color&amp; color() const { return m_color; }
2214     CompositeOperator compositeOperator() const { return m_op; }
2215     BlendMode blendMode() const { return m_blendMode; }
2216 
<a name="153" id="anc153"></a><span class="line-added">2217     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2218     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;FillCompositedRect&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2219 </span>
2220 private:
<a name="154" id="anc154"></a><span class="line-modified">2221     WEBCORE_EXPORT FillCompositedRect(const FloatRect&amp;, const Color&amp;, CompositeOperator, BlendMode);</span>







2222 
2223     void apply(GraphicsContext&amp;) const override;
2224     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_rect; }
2225 
2226     FloatRect m_rect;
2227     Color m_color;
2228     CompositeOperator m_op;
2229     BlendMode m_blendMode;
2230 };
2231 
<a name="155" id="anc155"></a><span class="line-added">2232 template&lt;class Encoder&gt;</span>
<span class="line-added">2233 void FillCompositedRect::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2234 {</span>
<span class="line-added">2235     encoder &lt;&lt; m_rect;</span>
<span class="line-added">2236     encoder &lt;&lt; m_color;</span>
<span class="line-added">2237     encoder &lt;&lt; m_op;</span>
<span class="line-added">2238     encoder &lt;&lt; m_blendMode;</span>
<span class="line-added">2239 }</span>
<span class="line-added">2240 </span>
<span class="line-added">2241 template&lt;class Decoder&gt;</span>
<span class="line-added">2242 Optional&lt;Ref&lt;FillCompositedRect&gt;&gt; FillCompositedRect::decode(Decoder&amp; decoder)</span>
<span class="line-added">2243 {</span>
<span class="line-added">2244     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added">2245     decoder &gt;&gt; rect;</span>
<span class="line-added">2246     if (!rect)</span>
<span class="line-added">2247         return WTF::nullopt;</span>
<span class="line-added">2248 </span>
<span class="line-added">2249     Optional&lt;Color&gt; color;</span>
<span class="line-added">2250     decoder &gt;&gt; color;</span>
<span class="line-added">2251     if (!color)</span>
<span class="line-added">2252         return WTF::nullopt;</span>
<span class="line-added">2253 </span>
<span class="line-added">2254     Optional&lt;CompositeOperator&gt; op;</span>
<span class="line-added">2255     decoder &gt;&gt; op;</span>
<span class="line-added">2256     if (!op)</span>
<span class="line-added">2257         return WTF::nullopt;</span>
<span class="line-added">2258 </span>
<span class="line-added">2259     Optional&lt;BlendMode&gt; blendMode;</span>
<span class="line-added">2260     decoder &gt;&gt; blendMode;</span>
<span class="line-added">2261     if (!blendMode)</span>
<span class="line-added">2262         return WTF::nullopt;</span>
<span class="line-added">2263 </span>
<span class="line-added">2264     return FillCompositedRect::create(*rect, *color, *op, *blendMode);</span>
<span class="line-added">2265 }</span>
<span class="line-added">2266 </span>
2267 class FillRoundedRect : public DrawingItem {
2268 public:
2269     static Ref&lt;FillRoundedRect&gt; create(const FloatRoundedRect&amp; rect, const Color&amp; color, BlendMode blendMode)
2270     {
2271         return adoptRef(*new FillRoundedRect(rect, color, blendMode));
2272     }
2273 
<a name="156" id="anc156"></a><span class="line-added">2274     WEBCORE_EXPORT virtual ~FillRoundedRect();</span>
<span class="line-added">2275 </span>
2276     const FloatRoundedRect&amp; roundedRect() const { return m_rect; }
2277     const Color&amp; color() const { return m_color; }
2278     BlendMode blendMode() const { return m_blendMode; }
2279 
<a name="157" id="anc157"></a><span class="line-added">2280     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2281     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;FillRoundedRect&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2282 </span>
2283 private:
<a name="158" id="anc158"></a><span class="line-modified">2284     WEBCORE_EXPORT FillRoundedRect(const FloatRoundedRect&amp;, const Color&amp;, BlendMode);</span>






2285 
2286     void apply(GraphicsContext&amp;) const override;
2287     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_rect.rect(); }
2288 
2289     FloatRoundedRect m_rect;
2290     Color m_color;
2291     BlendMode m_blendMode;
2292 };
2293 
<a name="159" id="anc159"></a><span class="line-added">2294 template&lt;class Encoder&gt;</span>
<span class="line-added">2295 void FillRoundedRect::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2296 {</span>
<span class="line-added">2297     encoder &lt;&lt; m_rect;</span>
<span class="line-added">2298     encoder &lt;&lt; m_color;</span>
<span class="line-added">2299     encoder &lt;&lt; m_blendMode;</span>
<span class="line-added">2300 }</span>
<span class="line-added">2301 </span>
<span class="line-added">2302 template&lt;class Decoder&gt;</span>
<span class="line-added">2303 Optional&lt;Ref&lt;FillRoundedRect&gt;&gt; FillRoundedRect::decode(Decoder&amp; decoder)</span>
<span class="line-added">2304 {</span>
<span class="line-added">2305     Optional&lt;FloatRoundedRect&gt; rect;</span>
<span class="line-added">2306     decoder &gt;&gt; rect;</span>
<span class="line-added">2307     if (!rect)</span>
<span class="line-added">2308         return WTF::nullopt;</span>
<span class="line-added">2309 </span>
<span class="line-added">2310     Optional&lt;Color&gt; color;</span>
<span class="line-added">2311     decoder &gt;&gt; color;</span>
<span class="line-added">2312     if (!color)</span>
<span class="line-added">2313         return WTF::nullopt;</span>
<span class="line-added">2314 </span>
<span class="line-added">2315     Optional&lt;BlendMode&gt; blendMode;</span>
<span class="line-added">2316     decoder &gt;&gt; blendMode;</span>
<span class="line-added">2317     if (!blendMode)</span>
<span class="line-added">2318         return WTF::nullopt;</span>
<span class="line-added">2319 </span>
<span class="line-added">2320     return FillRoundedRect::create(*rect, *color, *blendMode);</span>
<span class="line-added">2321 }</span>
<span class="line-added">2322 </span>
2323 class FillRectWithRoundedHole : public DrawingItem {
2324 public:
2325     static Ref&lt;FillRectWithRoundedHole&gt; create(const FloatRect&amp; rect, const FloatRoundedRect&amp; roundedHoleRect, const Color&amp; color)
2326     {
2327         return adoptRef(*new FillRectWithRoundedHole(rect, roundedHoleRect, color));
2328     }
2329 
<a name="160" id="anc160"></a><span class="line-added">2330     WEBCORE_EXPORT virtual ~FillRectWithRoundedHole();</span>
<span class="line-added">2331 </span>
2332     const FloatRect&amp; rect() const { return m_rect; }
2333     const FloatRoundedRect&amp; roundedHoleRect() const { return m_roundedHoleRect; }
2334     const Color&amp; color() const { return m_color; }
2335 
<a name="161" id="anc161"></a><span class="line-added">2336     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2337     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;FillRectWithRoundedHole&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2338 </span>
2339 private:
<a name="162" id="anc162"></a><span class="line-modified">2340     WEBCORE_EXPORT FillRectWithRoundedHole(const FloatRect&amp;, const FloatRoundedRect&amp;, const Color&amp;);</span>






2341 
2342     void apply(GraphicsContext&amp;) const override;
2343     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_rect; }
2344 
2345     FloatRect m_rect;
2346     FloatRoundedRect m_roundedHoleRect;
2347     Color m_color;
2348 };
2349 
<a name="163" id="anc163"></a><span class="line-added">2350 template&lt;class Encoder&gt;</span>
<span class="line-added">2351 void FillRectWithRoundedHole::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2352 {</span>
<span class="line-added">2353     encoder &lt;&lt; m_rect;</span>
<span class="line-added">2354     encoder &lt;&lt; m_roundedHoleRect;</span>
<span class="line-added">2355     encoder &lt;&lt; m_color;</span>
<span class="line-added">2356 }</span>
<span class="line-added">2357 </span>
<span class="line-added">2358 template&lt;class Decoder&gt;</span>
<span class="line-added">2359 Optional&lt;Ref&lt;FillRectWithRoundedHole&gt;&gt; FillRectWithRoundedHole::decode(Decoder&amp; decoder)</span>
<span class="line-added">2360 {</span>
<span class="line-added">2361     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added">2362     decoder &gt;&gt; rect;</span>
<span class="line-added">2363     if (!rect)</span>
<span class="line-added">2364         return WTF::nullopt;</span>
<span class="line-added">2365 </span>
<span class="line-added">2366     Optional&lt;FloatRoundedRect&gt; roundedHoleRect;</span>
<span class="line-added">2367     decoder &gt;&gt; roundedHoleRect;</span>
<span class="line-added">2368     if (!roundedHoleRect)</span>
<span class="line-added">2369         return WTF::nullopt;</span>
<span class="line-added">2370 </span>
<span class="line-added">2371     Optional&lt;Color&gt; color;</span>
<span class="line-added">2372     decoder &gt;&gt; color;</span>
<span class="line-added">2373     if (!color)</span>
<span class="line-added">2374         return WTF::nullopt;</span>
<span class="line-added">2375 </span>
<span class="line-added">2376     return FillRectWithRoundedHole::create(*rect, *roundedHoleRect, *color);</span>
<span class="line-added">2377 }</span>
<span class="line-added">2378 </span>
2379 class FillPath : public DrawingItem {
2380 public:
2381     static Ref&lt;FillPath&gt; create(const Path&amp; path)
2382     {
2383         return adoptRef(*new FillPath(path));
2384     }
2385 
<a name="164" id="anc164"></a><span class="line-added">2386     WEBCORE_EXPORT virtual ~FillPath();</span>
<span class="line-added">2387 </span>
2388     const Path&amp; path() const { return m_path; }
2389 
<a name="165" id="anc165"></a><span class="line-added">2390     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2391     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;FillPath&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2392 </span>
2393 private:
<a name="166" id="anc166"></a><span class="line-modified">2394     WEBCORE_EXPORT FillPath(const Path&amp;);</span>




2395 
2396     void apply(GraphicsContext&amp;) const override;
2397     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_path.fastBoundingRect(); }
2398 
2399     const Path m_path;
2400 };
2401 
<a name="167" id="anc167"></a><span class="line-added">2402 template&lt;class Encoder&gt;</span>
<span class="line-added">2403 void FillPath::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2404 {</span>
<span class="line-added">2405     encoder &lt;&lt; m_path;</span>
<span class="line-added">2406 }</span>
<span class="line-added">2407 </span>
<span class="line-added">2408 template&lt;class Decoder&gt;</span>
<span class="line-added">2409 Optional&lt;Ref&lt;FillPath&gt;&gt; FillPath::decode(Decoder&amp; decoder)</span>
<span class="line-added">2410 {</span>
<span class="line-added">2411     Optional&lt;Path&gt; path;</span>
<span class="line-added">2412     decoder &gt;&gt; path;</span>
<span class="line-added">2413     if (!path)</span>
<span class="line-added">2414         return WTF::nullopt;</span>
<span class="line-added">2415 </span>
<span class="line-added">2416     return FillPath::create(*path);</span>
<span class="line-added">2417 }</span>
<span class="line-added">2418 </span>
2419 class FillEllipse : public DrawingItem {
2420 public:
2421     static Ref&lt;FillEllipse&gt; create(const FloatRect&amp; rect)
2422     {
2423         return adoptRef(*new FillEllipse(rect));
2424     }
2425 
<a name="168" id="anc168"></a><span class="line-added">2426     WEBCORE_EXPORT virtual ~FillEllipse();</span>
<span class="line-added">2427 </span>
2428     FloatRect rect() const { return m_rect; }
2429 
<a name="169" id="anc169"></a><span class="line-added">2430     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2431     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;FillEllipse&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2432 </span>
2433 private:
<a name="170" id="anc170"></a><span class="line-modified">2434     WEBCORE_EXPORT FillEllipse(const FloatRect&amp;);</span>




2435 
2436     void apply(GraphicsContext&amp;) const override;
2437 
2438     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_rect; }
2439 
2440     FloatRect m_rect;
2441 };
2442 
<a name="171" id="anc171"></a><span class="line-added">2443 template&lt;class Encoder&gt;</span>
<span class="line-added">2444 void FillEllipse::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2445 {</span>
<span class="line-added">2446     encoder &lt;&lt; m_rect;</span>
<span class="line-added">2447 }</span>
<span class="line-added">2448 </span>
<span class="line-added">2449 template&lt;class Decoder&gt;</span>
<span class="line-added">2450 Optional&lt;Ref&lt;FillEllipse&gt;&gt; FillEllipse::decode(Decoder&amp; decoder)</span>
<span class="line-added">2451 {</span>
<span class="line-added">2452     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added">2453     decoder &gt;&gt; rect;</span>
<span class="line-added">2454     if (!rect)</span>
<span class="line-added">2455         return WTF::nullopt;</span>
<span class="line-added">2456 </span>
<span class="line-added">2457     return FillEllipse::create(*rect);</span>
<span class="line-added">2458 }</span>
<span class="line-added">2459 </span>
2460 class StrokeRect : public DrawingItem {
2461 public:
2462     static Ref&lt;StrokeRect&gt; create(const FloatRect&amp; rect, float lineWidth)
2463     {
2464         return adoptRef(*new StrokeRect(rect, lineWidth));
2465     }
2466 
<a name="172" id="anc172"></a><span class="line-added">2467     WEBCORE_EXPORT virtual ~StrokeRect();</span>
<span class="line-added">2468 </span>
2469     FloatRect rect() const { return m_rect; }
2470     float lineWidth() const { return m_lineWidth; }
2471 
<a name="173" id="anc173"></a><span class="line-added">2472     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2473     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;StrokeRect&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2474 </span>
2475 private:
<a name="174" id="anc174"></a><span class="line-modified">2476     WEBCORE_EXPORT StrokeRect(const FloatRect&amp;, float);</span>





2477 
2478     void apply(GraphicsContext&amp;) const override;
2479     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override;
2480 
2481     FloatRect m_rect;
2482     float m_lineWidth;
2483 };
2484 
<a name="175" id="anc175"></a><span class="line-added">2485 template&lt;class Encoder&gt;</span>
<span class="line-added">2486 void StrokeRect::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2487 {</span>
<span class="line-added">2488     encoder &lt;&lt; m_rect;</span>
<span class="line-added">2489     encoder &lt;&lt; m_lineWidth;</span>
<span class="line-added">2490 }</span>
<span class="line-added">2491 </span>
<span class="line-added">2492 template&lt;class Decoder&gt;</span>
<span class="line-added">2493 Optional&lt;Ref&lt;StrokeRect&gt;&gt; StrokeRect::decode(Decoder&amp; decoder)</span>
<span class="line-added">2494 {</span>
<span class="line-added">2495     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added">2496     decoder &gt;&gt; rect;</span>
<span class="line-added">2497     if (!rect)</span>
<span class="line-added">2498         return WTF::nullopt;</span>
<span class="line-added">2499 </span>
<span class="line-added">2500     Optional&lt;float&gt; lineWidth;</span>
<span class="line-added">2501     decoder &gt;&gt; lineWidth;</span>
<span class="line-added">2502     if (!lineWidth)</span>
<span class="line-added">2503         return WTF::nullopt;</span>
<span class="line-added">2504 </span>
<span class="line-added">2505     return StrokeRect::create(*rect, *lineWidth);</span>
<span class="line-added">2506 }</span>
<span class="line-added">2507 </span>
2508 class StrokePath : public DrawingItem {
2509 public:
2510     static Ref&lt;StrokePath&gt; create(const Path&amp; path)
2511     {
2512         return adoptRef(*new StrokePath(path));
2513     }
2514 
<a name="176" id="anc176"></a><span class="line-added">2515     WEBCORE_EXPORT virtual ~StrokePath();</span>
<span class="line-added">2516 </span>
2517     const Path&amp; path() const { return m_path; }
2518 
<a name="177" id="anc177"></a><span class="line-added">2519     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2520     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;StrokePath&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2521 </span>
2522 private:
<a name="178" id="anc178"></a><span class="line-modified">2523     WEBCORE_EXPORT StrokePath(const Path&amp;);</span>




2524 
2525     void apply(GraphicsContext&amp;) const override;
2526     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override;
2527 
2528     const Path m_path;
<a name="179" id="anc179"></a>
2529 };
2530 
<a name="180" id="anc180"></a><span class="line-added">2531 template&lt;class Encoder&gt;</span>
<span class="line-added">2532 void StrokePath::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2533 {</span>
<span class="line-added">2534     encoder &lt;&lt; m_path;</span>
<span class="line-added">2535 }</span>
<span class="line-added">2536 </span>
<span class="line-added">2537 template&lt;class Decoder&gt;</span>
<span class="line-added">2538 Optional&lt;Ref&lt;StrokePath&gt;&gt; StrokePath::decode(Decoder&amp; decoder)</span>
<span class="line-added">2539 {</span>
<span class="line-added">2540     Optional&lt;Path&gt; path;</span>
<span class="line-added">2541     decoder &gt;&gt; path;</span>
<span class="line-added">2542     if (!path)</span>
<span class="line-added">2543         return WTF::nullopt;</span>
<span class="line-added">2544 </span>
<span class="line-added">2545     return StrokePath::create(*path);</span>
<span class="line-added">2546 }</span>
<span class="line-added">2547 </span>
2548 class StrokeEllipse : public DrawingItem {
2549 public:
2550     static Ref&lt;StrokeEllipse&gt; create(const FloatRect&amp; rect)
2551     {
2552         return adoptRef(*new StrokeEllipse(rect));
2553     }
2554 
<a name="181" id="anc181"></a><span class="line-added">2555     WEBCORE_EXPORT ~StrokeEllipse();</span>
<span class="line-added">2556 </span>
2557     FloatRect rect() const { return m_rect; }
2558 
<a name="182" id="anc182"></a><span class="line-added">2559     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2560     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;StrokeEllipse&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2561 </span>
2562 private:
<a name="183" id="anc183"></a><span class="line-modified">2563     WEBCORE_EXPORT StrokeEllipse(const FloatRect&amp;);</span>




2564 
2565     void apply(GraphicsContext&amp;) const override;
2566     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override;
2567 
2568     FloatRect m_rect;
2569 };
2570 
<a name="184" id="anc184"></a><span class="line-added">2571 template&lt;class Encoder&gt;</span>
<span class="line-added">2572 void StrokeEllipse::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2573 {</span>
<span class="line-added">2574     encoder &lt;&lt; m_rect;</span>
<span class="line-added">2575 }</span>
<span class="line-added">2576 </span>
<span class="line-added">2577 template&lt;class Decoder&gt;</span>
<span class="line-added">2578 Optional&lt;Ref&lt;StrokeEllipse&gt;&gt; StrokeEllipse::decode(Decoder&amp; decoder)</span>
<span class="line-added">2579 {</span>
<span class="line-added">2580     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added">2581     decoder &gt;&gt; rect;</span>
<span class="line-added">2582     if (!rect)</span>
<span class="line-added">2583         return WTF::nullopt;</span>
<span class="line-added">2584 </span>
<span class="line-added">2585     return StrokeEllipse::create(*rect);</span>
<span class="line-added">2586 }</span>
<span class="line-added">2587 </span>
2588 class ClearRect : public DrawingItem {
2589 public:
2590     static Ref&lt;ClearRect&gt; create(const FloatRect&amp; rect)
2591     {
2592         return adoptRef(*new ClearRect(rect));
2593     }
2594 
<a name="185" id="anc185"></a><span class="line-added">2595     WEBCORE_EXPORT virtual ~ClearRect();</span>
<span class="line-added">2596 </span>
2597     FloatRect rect() const { return m_rect; }
2598 
<a name="186" id="anc186"></a><span class="line-added">2599     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2600     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;ClearRect&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2601 </span>
2602 private:
<a name="187" id="anc187"></a><span class="line-modified">2603     WEBCORE_EXPORT ClearRect(const FloatRect&amp;);</span>




2604 
2605     void apply(GraphicsContext&amp;) const override;
2606     Optional&lt;FloatRect&gt; localBounds(const GraphicsContext&amp;) const override { return m_rect; }
2607 
2608     FloatRect m_rect;
2609 };
2610 
<a name="188" id="anc188"></a><span class="line-added">2611 template&lt;class Encoder&gt;</span>
<span class="line-added">2612 void ClearRect::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2613 {</span>
<span class="line-added">2614     encoder &lt;&lt; m_rect;</span>
<span class="line-added">2615 }</span>
<span class="line-added">2616 </span>
<span class="line-added">2617 template&lt;class Decoder&gt;</span>
<span class="line-added">2618 Optional&lt;Ref&lt;ClearRect&gt;&gt; ClearRect::decode(Decoder&amp; decoder)</span>
<span class="line-added">2619 {</span>
<span class="line-added">2620     Optional&lt;FloatRect&gt; rect;</span>
<span class="line-added">2621     decoder &gt;&gt; rect;</span>
<span class="line-added">2622     if (!rect)</span>
<span class="line-added">2623         return WTF::nullopt;</span>
<span class="line-added">2624 </span>
<span class="line-added">2625     return ClearRect::create(*rect);</span>
<span class="line-added">2626 }</span>
<span class="line-added">2627 </span>
2628 #if USE(CG)
2629 class ApplyStrokePattern : public Item {
2630 public:
2631     static Ref&lt;ApplyStrokePattern&gt; create()
2632     {
2633         return adoptRef(*new ApplyStrokePattern);
2634     }
2635 
<a name="189" id="anc189"></a><span class="line-added">2636     WEBCORE_EXPORT virtual ~ApplyStrokePattern();</span>
<span class="line-added">2637 </span>
<span class="line-added">2638     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2639     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;ApplyStrokePattern&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2640 </span>
2641 private:
<a name="190" id="anc190"></a><span class="line-modified">2642     WEBCORE_EXPORT ApplyStrokePattern();</span>



2643 
2644     void apply(GraphicsContext&amp;) const override;
2645 };
2646 
<a name="191" id="anc191"></a><span class="line-added">2647 template&lt;class Encoder&gt;</span>
<span class="line-added">2648 void ApplyStrokePattern::encode(Encoder&amp;) const</span>
<span class="line-added">2649 {</span>
<span class="line-added">2650 }</span>
<span class="line-added">2651 </span>
<span class="line-added">2652 template&lt;class Decoder&gt;</span>
<span class="line-added">2653 Optional&lt;Ref&lt;ApplyStrokePattern&gt;&gt; ApplyStrokePattern::decode(Decoder&amp;)</span>
<span class="line-added">2654 {</span>
<span class="line-added">2655     return ApplyStrokePattern::create();</span>
<span class="line-added">2656 }</span>
<span class="line-added">2657 </span>
2658 class ApplyFillPattern : public Item {
2659 public:
2660     static Ref&lt;ApplyFillPattern&gt; create()
2661     {
2662         return adoptRef(*new ApplyFillPattern);
2663     }
2664 
<a name="192" id="anc192"></a><span class="line-added">2665     WEBCORE_EXPORT virtual ~ApplyFillPattern();</span>
<span class="line-added">2666 </span>
<span class="line-added">2667     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2668     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;ApplyFillPattern&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2669 </span>
2670 private:
<a name="193" id="anc193"></a><span class="line-modified">2671     WEBCORE_EXPORT ApplyFillPattern();</span>



2672 
2673     void apply(GraphicsContext&amp;) const override;
2674 };
<a name="194" id="anc194"></a><span class="line-added">2675 </span>
<span class="line-added">2676 template&lt;class Encoder&gt;</span>
<span class="line-added">2677 void ApplyFillPattern::encode(Encoder&amp;) const</span>
<span class="line-added">2678 {</span>
<span class="line-added">2679 }</span>
<span class="line-added">2680 </span>
<span class="line-added">2681 template&lt;class Decoder&gt;</span>
<span class="line-added">2682 Optional&lt;Ref&lt;ApplyFillPattern&gt;&gt; ApplyFillPattern::decode(Decoder&amp;)</span>
<span class="line-added">2683 {</span>
<span class="line-added">2684     return ApplyFillPattern::create();</span>
<span class="line-added">2685 }</span>
2686 #endif
2687 
2688 class ApplyDeviceScaleFactor : public Item {
2689 public:
2690     static Ref&lt;ApplyDeviceScaleFactor&gt; create(float scaleFactor)
2691     {
2692         return adoptRef(*new ApplyDeviceScaleFactor(scaleFactor));
2693     }
2694 
<a name="195" id="anc195"></a><span class="line-added">2695     WEBCORE_EXPORT virtual ~ApplyDeviceScaleFactor();</span>
<span class="line-added">2696 </span>
2697     float scaleFactor() const { return m_scaleFactor; }
2698 
<a name="196" id="anc196"></a><span class="line-added">2699     template&lt;class Encoder&gt; void encode(Encoder&amp;) const;</span>
<span class="line-added">2700     template&lt;class Decoder&gt; static Optional&lt;Ref&lt;ApplyDeviceScaleFactor&gt;&gt; decode(Decoder&amp;);</span>
<span class="line-added">2701 </span>
2702 private:
<a name="197" id="anc197"></a><span class="line-modified">2703     WEBCORE_EXPORT ApplyDeviceScaleFactor(float scaleFactor);</span>




2704 
2705     void apply(GraphicsContext&amp;) const override;
2706 
2707     float m_scaleFactor;
2708 };
2709 
<a name="198" id="anc198"></a><span class="line-added">2710 template&lt;class Encoder&gt;</span>
<span class="line-added">2711 void ApplyDeviceScaleFactor::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2712 {</span>
<span class="line-added">2713     encoder &lt;&lt; m_scaleFactor;</span>
<span class="line-added">2714 }</span>
<span class="line-added">2715 </span>
<span class="line-added">2716 template&lt;class Decoder&gt;</span>
<span class="line-added">2717 Optional&lt;Ref&lt;ApplyDeviceScaleFactor&gt;&gt; ApplyDeviceScaleFactor::decode(Decoder&amp; decoder)</span>
<span class="line-added">2718 {</span>
<span class="line-added">2719     Optional&lt;float&gt; scaleFactor;</span>
<span class="line-added">2720     decoder &gt;&gt; scaleFactor;</span>
<span class="line-added">2721     if (!scaleFactor)</span>
<span class="line-added">2722         return WTF::nullopt;</span>
<span class="line-added">2723 </span>
<span class="line-added">2724     return ApplyDeviceScaleFactor::create(*scaleFactor);</span>
<span class="line-added">2725 }</span>
<span class="line-added">2726 </span>
<span class="line-added">2727 </span>
2728 WTF::TextStream&amp; operator&lt;&lt;(WTF::TextStream&amp;, const Item&amp;);
2729 
<a name="199" id="anc199"></a><span class="line-added">2730 template&lt;class Encoder&gt;</span>
<span class="line-added">2731 void Item::encode(Encoder&amp; encoder) const</span>
<span class="line-added">2732 {</span>
<span class="line-added">2733     encoder &lt;&lt; m_type;</span>
<span class="line-added">2734 </span>
<span class="line-added">2735     switch (m_type) {</span>
<span class="line-added">2736     case ItemType::Save:</span>
<span class="line-added">2737         encoder &lt;&lt; downcast&lt;Save&gt;(*this);</span>
<span class="line-added">2738         break;</span>
<span class="line-added">2739     case ItemType::Restore:</span>
<span class="line-added">2740         encoder &lt;&lt; downcast&lt;Restore&gt;(*this);</span>
<span class="line-added">2741         break;</span>
<span class="line-added">2742     case ItemType::Translate:</span>
<span class="line-added">2743         encoder &lt;&lt; downcast&lt;Translate&gt;(*this);</span>
<span class="line-added">2744         break;</span>
<span class="line-added">2745     case ItemType::Rotate:</span>
<span class="line-added">2746         encoder &lt;&lt; downcast&lt;Rotate&gt;(*this);</span>
<span class="line-added">2747         break;</span>
<span class="line-added">2748     case ItemType::Scale:</span>
<span class="line-added">2749         encoder &lt;&lt; downcast&lt;Scale&gt;(*this);</span>
<span class="line-added">2750         break;</span>
<span class="line-added">2751     case ItemType::SetCTM:</span>
<span class="line-added">2752         encoder &lt;&lt; downcast&lt;SetCTM&gt;(*this);</span>
<span class="line-added">2753         break;</span>
<span class="line-added">2754     case ItemType::ConcatenateCTM:</span>
<span class="line-added">2755         encoder &lt;&lt; downcast&lt;ConcatenateCTM&gt;(*this);</span>
<span class="line-added">2756         break;</span>
<span class="line-added">2757     case ItemType::SetState:</span>
<span class="line-added">2758         encoder &lt;&lt; downcast&lt;SetState&gt;(*this);</span>
<span class="line-added">2759         break;</span>
<span class="line-added">2760     case ItemType::SetLineCap:</span>
<span class="line-added">2761         encoder &lt;&lt; downcast&lt;SetLineCap&gt;(*this);</span>
<span class="line-added">2762         break;</span>
<span class="line-added">2763     case ItemType::SetLineDash:</span>
<span class="line-added">2764         encoder &lt;&lt; downcast&lt;SetLineDash&gt;(*this);</span>
<span class="line-added">2765         break;</span>
<span class="line-added">2766     case ItemType::SetLineJoin:</span>
<span class="line-added">2767         encoder &lt;&lt; downcast&lt;SetLineJoin&gt;(*this);</span>
<span class="line-added">2768         break;</span>
<span class="line-added">2769     case ItemType::SetMiterLimit:</span>
<span class="line-added">2770         encoder &lt;&lt; downcast&lt;SetMiterLimit&gt;(*this);</span>
<span class="line-added">2771         break;</span>
<span class="line-added">2772     case ItemType::ClearShadow:</span>
<span class="line-added">2773         encoder &lt;&lt; downcast&lt;ClearShadow&gt;(*this);</span>
<span class="line-added">2774         break;</span>
<span class="line-added">2775     case ItemType::Clip:</span>
<span class="line-added">2776         encoder &lt;&lt; downcast&lt;Clip&gt;(*this);</span>
<span class="line-added">2777         break;</span>
<span class="line-added">2778     case ItemType::ClipOut:</span>
<span class="line-added">2779         encoder &lt;&lt; downcast&lt;ClipOut&gt;(*this);</span>
<span class="line-added">2780         break;</span>
<span class="line-added">2781     case ItemType::ClipOutToPath:</span>
<span class="line-added">2782         encoder &lt;&lt; downcast&lt;ClipOutToPath&gt;(*this);</span>
<span class="line-added">2783         break;</span>
<span class="line-added">2784     case ItemType::ClipPath:</span>
<span class="line-added">2785         encoder &lt;&lt; downcast&lt;ClipPath&gt;(*this);</span>
<span class="line-added">2786         break;</span>
<span class="line-added">2787     case ItemType::DrawGlyphs:</span>
<span class="line-added">2788         encoder &lt;&lt; downcast&lt;DrawGlyphs&gt;(*this);</span>
<span class="line-added">2789         break;</span>
<span class="line-added">2790     case ItemType::DrawImage:</span>
<span class="line-added">2791         encoder &lt;&lt; downcast&lt;DrawImage&gt;(*this);</span>
<span class="line-added">2792         break;</span>
<span class="line-added">2793     case ItemType::DrawTiledImage:</span>
<span class="line-added">2794         encoder &lt;&lt; downcast&lt;DrawTiledImage&gt;(*this);</span>
<span class="line-added">2795         break;</span>
<span class="line-added">2796     case ItemType::DrawTiledScaledImage:</span>
<span class="line-added">2797         encoder &lt;&lt; downcast&lt;DrawTiledScaledImage&gt;(*this);</span>
<span class="line-added">2798         break;</span>
<span class="line-added">2799 #if USE(CG) || USE(CAIRO) || USE(DIRECT2D)</span>
<span class="line-added">2800     case ItemType::DrawNativeImage:</span>
<span class="line-added">2801         encoder &lt;&lt; downcast&lt;DrawNativeImage&gt;(*this);</span>
<span class="line-added">2802         break;</span>
<span class="line-added">2803 #endif</span>
<span class="line-added">2804     case ItemType::DrawPattern:</span>
<span class="line-added">2805         encoder &lt;&lt; downcast&lt;DrawPattern&gt;(*this);</span>
<span class="line-added">2806         break;</span>
<span class="line-added">2807     case ItemType::DrawRect:</span>
<span class="line-added">2808         encoder &lt;&lt; downcast&lt;DrawRect&gt;(*this);</span>
<span class="line-added">2809         break;</span>
<span class="line-added">2810     case ItemType::DrawLine:</span>
<span class="line-added">2811         encoder &lt;&lt; downcast&lt;DrawLine&gt;(*this);</span>
<span class="line-added">2812         break;</span>
<span class="line-added">2813     case ItemType::DrawLinesForText:</span>
<span class="line-added">2814         encoder &lt;&lt; downcast&lt;DrawLinesForText&gt;(*this);</span>
<span class="line-added">2815         break;</span>
<span class="line-added">2816     case ItemType::DrawDotsForDocumentMarker:</span>
<span class="line-added">2817         encoder &lt;&lt; downcast&lt;DrawDotsForDocumentMarker&gt;(*this);</span>
<span class="line-added">2818         break;</span>
<span class="line-added">2819     case ItemType::DrawEllipse:</span>
<span class="line-added">2820         encoder &lt;&lt; downcast&lt;DrawEllipse&gt;(*this);</span>
<span class="line-added">2821         break;</span>
<span class="line-added">2822     case ItemType::DrawPath:</span>
<span class="line-added">2823         encoder &lt;&lt; downcast&lt;DrawPath&gt;(*this);</span>
<span class="line-added">2824         break;</span>
<span class="line-added">2825     case ItemType::DrawFocusRingPath:</span>
<span class="line-added">2826         encoder &lt;&lt; downcast&lt;DrawFocusRingPath&gt;(*this);</span>
<span class="line-added">2827         break;</span>
<span class="line-added">2828     case ItemType::DrawFocusRingRects:</span>
<span class="line-added">2829         encoder &lt;&lt; downcast&lt;DrawFocusRingRects&gt;(*this);</span>
<span class="line-added">2830         break;</span>
<span class="line-added">2831     case ItemType::FillRect:</span>
<span class="line-added">2832         encoder &lt;&lt; downcast&lt;FillRect&gt;(*this);</span>
<span class="line-added">2833         break;</span>
<span class="line-added">2834     case ItemType::FillRectWithColor:</span>
<span class="line-added">2835         encoder &lt;&lt; downcast&lt;FillRectWithColor&gt;(*this);</span>
<span class="line-added">2836         break;</span>
<span class="line-added">2837     case ItemType::FillRectWithGradient:</span>
<span class="line-added">2838         encoder &lt;&lt; downcast&lt;FillRectWithGradient&gt;(*this);</span>
<span class="line-added">2839         break;</span>
<span class="line-added">2840     case ItemType::FillCompositedRect:</span>
<span class="line-added">2841         encoder &lt;&lt; downcast&lt;FillCompositedRect&gt;(*this);</span>
<span class="line-added">2842         break;</span>
<span class="line-added">2843     case ItemType::FillRoundedRect:</span>
<span class="line-added">2844         encoder &lt;&lt; downcast&lt;FillRoundedRect&gt;(*this);</span>
<span class="line-added">2845         break;</span>
<span class="line-added">2846     case ItemType::FillRectWithRoundedHole:</span>
<span class="line-added">2847         encoder &lt;&lt; downcast&lt;FillRectWithRoundedHole&gt;(*this);</span>
<span class="line-added">2848         break;</span>
<span class="line-added">2849     case ItemType::FillPath:</span>
<span class="line-added">2850         encoder &lt;&lt; downcast&lt;FillPath&gt;(*this);</span>
<span class="line-added">2851         break;</span>
<span class="line-added">2852     case ItemType::FillEllipse:</span>
<span class="line-added">2853         encoder &lt;&lt; downcast&lt;FillEllipse&gt;(*this);</span>
<span class="line-added">2854         break;</span>
<span class="line-added">2855     case ItemType::StrokeRect:</span>
<span class="line-added">2856         encoder &lt;&lt; downcast&lt;StrokeRect&gt;(*this);</span>
<span class="line-added">2857         break;</span>
<span class="line-added">2858     case ItemType::StrokePath:</span>
<span class="line-added">2859         encoder &lt;&lt; downcast&lt;StrokePath&gt;(*this);</span>
<span class="line-added">2860         break;</span>
<span class="line-added">2861     case ItemType::StrokeEllipse:</span>
<span class="line-added">2862         encoder &lt;&lt; downcast&lt;StrokeEllipse&gt;(*this);</span>
<span class="line-added">2863         break;</span>
<span class="line-added">2864     case ItemType::ClearRect:</span>
<span class="line-added">2865         encoder &lt;&lt; downcast&lt;ClearRect&gt;(*this);</span>
<span class="line-added">2866         break;</span>
<span class="line-added">2867     case ItemType::BeginTransparencyLayer:</span>
<span class="line-added">2868         encoder &lt;&lt; downcast&lt;BeginTransparencyLayer&gt;(*this);</span>
<span class="line-added">2869         break;</span>
<span class="line-added">2870     case ItemType::EndTransparencyLayer:</span>
<span class="line-added">2871         encoder &lt;&lt; downcast&lt;EndTransparencyLayer&gt;(*this);</span>
<span class="line-added">2872         break;</span>
<span class="line-added">2873 #if USE(CG)</span>
<span class="line-added">2874     case ItemType::ApplyStrokePattern:</span>
<span class="line-added">2875         encoder &lt;&lt; downcast&lt;ApplyStrokePattern&gt;(*this);</span>
<span class="line-added">2876         break;</span>
<span class="line-added">2877     case ItemType::ApplyFillPattern:</span>
<span class="line-added">2878         encoder &lt;&lt; downcast&lt;ApplyFillPattern&gt;(*this);</span>
<span class="line-added">2879         break;</span>
<span class="line-added">2880 #endif</span>
<span class="line-added">2881     case ItemType::ApplyDeviceScaleFactor:</span>
<span class="line-added">2882         encoder &lt;&lt; downcast&lt;ApplyDeviceScaleFactor&gt;(*this);</span>
<span class="line-added">2883         break;</span>
<span class="line-added">2884     }</span>
<span class="line-added">2885 }</span>
<span class="line-added">2886 </span>
<span class="line-added">2887 template&lt;class Decoder&gt;</span>
<span class="line-added">2888 Optional&lt;Ref&lt;Item&gt;&gt; Item::decode(Decoder&amp; decoder)</span>
<span class="line-added">2889 {</span>
<span class="line-added">2890     Optional&lt;ItemType&gt; itemType;</span>
<span class="line-added">2891     decoder &gt;&gt; itemType;</span>
<span class="line-added">2892     if (!itemType)</span>
<span class="line-added">2893         return WTF::nullopt;</span>
<span class="line-added">2894 </span>
<span class="line-added">2895     switch (*itemType) {</span>
<span class="line-added">2896     case ItemType::Save:</span>
<span class="line-added">2897         if (auto item = Save::decode(decoder))</span>
<span class="line-added">2898             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2899         break;</span>
<span class="line-added">2900     case ItemType::Restore:</span>
<span class="line-added">2901         if (auto item = Restore::decode(decoder))</span>
<span class="line-added">2902             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2903         break;</span>
<span class="line-added">2904     case ItemType::Translate:</span>
<span class="line-added">2905         if (auto item = Translate::decode(decoder))</span>
<span class="line-added">2906             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2907         break;</span>
<span class="line-added">2908     case ItemType::Rotate:</span>
<span class="line-added">2909         if (auto item = Rotate::decode(decoder))</span>
<span class="line-added">2910             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2911         break;</span>
<span class="line-added">2912     case ItemType::Scale:</span>
<span class="line-added">2913         if (auto item = Scale::decode(decoder))</span>
<span class="line-added">2914             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2915         break;</span>
<span class="line-added">2916     case ItemType::SetCTM:</span>
<span class="line-added">2917         if (auto item = SetCTM::decode(decoder))</span>
<span class="line-added">2918             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2919         break;</span>
<span class="line-added">2920     case ItemType::ConcatenateCTM:</span>
<span class="line-added">2921         if (auto item = ConcatenateCTM::decode(decoder))</span>
<span class="line-added">2922             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2923         break;</span>
<span class="line-added">2924     case ItemType::SetState:</span>
<span class="line-added">2925         if (auto item = SetState::decode(decoder))</span>
<span class="line-added">2926             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2927         break;</span>
<span class="line-added">2928     case ItemType::SetLineCap:</span>
<span class="line-added">2929         if (auto item = SetLineCap::decode(decoder))</span>
<span class="line-added">2930             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2931         break;</span>
<span class="line-added">2932     case ItemType::SetLineDash:</span>
<span class="line-added">2933         if (auto item = SetLineDash::decode(decoder))</span>
<span class="line-added">2934             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2935         break;</span>
<span class="line-added">2936     case ItemType::SetLineJoin:</span>
<span class="line-added">2937         if (auto item = SetLineJoin::decode(decoder))</span>
<span class="line-added">2938             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2939         break;</span>
<span class="line-added">2940     case ItemType::SetMiterLimit:</span>
<span class="line-added">2941         if (auto item = SetMiterLimit::decode(decoder))</span>
<span class="line-added">2942             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2943         break;</span>
<span class="line-added">2944     case ItemType::ClearShadow:</span>
<span class="line-added">2945         if (auto item = ClearShadow::decode(decoder))</span>
<span class="line-added">2946             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2947         break;</span>
<span class="line-added">2948     case ItemType::Clip:</span>
<span class="line-added">2949         if (auto item = Clip::decode(decoder))</span>
<span class="line-added">2950             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2951         break;</span>
<span class="line-added">2952     case ItemType::ClipOut:</span>
<span class="line-added">2953         if (auto item = ClipOut::decode(decoder))</span>
<span class="line-added">2954             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2955         break;</span>
<span class="line-added">2956     case ItemType::ClipOutToPath:</span>
<span class="line-added">2957         if (auto item = ClipOutToPath::decode(decoder))</span>
<span class="line-added">2958             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2959         break;</span>
<span class="line-added">2960     case ItemType::ClipPath:</span>
<span class="line-added">2961         if (auto item = ClipPath::decode(decoder))</span>
<span class="line-added">2962             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2963         break;</span>
<span class="line-added">2964     case ItemType::DrawGlyphs:</span>
<span class="line-added">2965         if (auto item = DrawGlyphs::decode(decoder))</span>
<span class="line-added">2966             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2967         break;</span>
<span class="line-added">2968     case ItemType::DrawImage:</span>
<span class="line-added">2969         if (auto item = DrawImage::decode(decoder))</span>
<span class="line-added">2970             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2971         break;</span>
<span class="line-added">2972     case ItemType::DrawTiledImage:</span>
<span class="line-added">2973         if (auto item = DrawTiledImage::decode(decoder))</span>
<span class="line-added">2974             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2975         break;</span>
<span class="line-added">2976     case ItemType::DrawTiledScaledImage:</span>
<span class="line-added">2977         if (auto item = DrawTiledScaledImage::decode(decoder))</span>
<span class="line-added">2978             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2979         break;</span>
<span class="line-added">2980 #if USE(CG) || USE(CAIRO) || USE(DIRECT2D)</span>
<span class="line-added">2981     case ItemType::DrawNativeImage:</span>
<span class="line-added">2982         if (auto item = DrawNativeImage::decode(decoder))</span>
<span class="line-added">2983             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2984         break;</span>
<span class="line-added">2985 #endif</span>
<span class="line-added">2986     case ItemType::DrawPattern:</span>
<span class="line-added">2987         if (auto item = DrawPattern::decode(decoder))</span>
<span class="line-added">2988             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2989         break;</span>
<span class="line-added">2990     case ItemType::DrawRect:</span>
<span class="line-added">2991         if (auto item = DrawRect::decode(decoder))</span>
<span class="line-added">2992             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2993         break;</span>
<span class="line-added">2994     case ItemType::DrawLine:</span>
<span class="line-added">2995         if (auto item = DrawLine::decode(decoder))</span>
<span class="line-added">2996             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">2997         break;</span>
<span class="line-added">2998     case ItemType::DrawLinesForText:</span>
<span class="line-added">2999         if (auto item = DrawLinesForText::decode(decoder))</span>
<span class="line-added">3000             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3001         break;</span>
<span class="line-added">3002     case ItemType::DrawDotsForDocumentMarker:</span>
<span class="line-added">3003         if (auto item = DrawDotsForDocumentMarker::decode(decoder))</span>
<span class="line-added">3004             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3005         break;</span>
<span class="line-added">3006     case ItemType::DrawEllipse:</span>
<span class="line-added">3007         if (auto item = DrawEllipse::decode(decoder))</span>
<span class="line-added">3008             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3009         break;</span>
<span class="line-added">3010     case ItemType::DrawPath:</span>
<span class="line-added">3011         if (auto item = DrawPath::decode(decoder))</span>
<span class="line-added">3012             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3013         break;</span>
<span class="line-added">3014     case ItemType::DrawFocusRingPath:</span>
<span class="line-added">3015         if (auto item = DrawFocusRingPath::decode(decoder))</span>
<span class="line-added">3016             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3017         break;</span>
<span class="line-added">3018     case ItemType::DrawFocusRingRects:</span>
<span class="line-added">3019         if (auto item = DrawFocusRingRects::decode(decoder))</span>
<span class="line-added">3020             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3021         break;</span>
<span class="line-added">3022     case ItemType::FillRect:</span>
<span class="line-added">3023         if (auto item = FillRect::decode(decoder))</span>
<span class="line-added">3024             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3025         break;</span>
<span class="line-added">3026     case ItemType::FillRectWithColor:</span>
<span class="line-added">3027         if (auto item = FillRectWithColor::decode(decoder))</span>
<span class="line-added">3028             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3029         break;</span>
<span class="line-added">3030     case ItemType::FillRectWithGradient:</span>
<span class="line-added">3031         if (auto item = FillRectWithGradient::decode(decoder))</span>
<span class="line-added">3032             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3033         break;</span>
<span class="line-added">3034     case ItemType::FillCompositedRect:</span>
<span class="line-added">3035         if (auto item = FillCompositedRect::decode(decoder))</span>
<span class="line-added">3036             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3037         break;</span>
<span class="line-added">3038     case ItemType::FillRoundedRect:</span>
<span class="line-added">3039         if (auto item = FillRoundedRect::decode(decoder))</span>
<span class="line-added">3040             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3041         break;</span>
<span class="line-added">3042     case ItemType::FillRectWithRoundedHole:</span>
<span class="line-added">3043         if (auto item = FillRectWithRoundedHole::decode(decoder))</span>
<span class="line-added">3044             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3045         break;</span>
<span class="line-added">3046     case ItemType::FillPath:</span>
<span class="line-added">3047         if (auto item = FillPath::decode(decoder))</span>
<span class="line-added">3048             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3049         break;</span>
<span class="line-added">3050     case ItemType::FillEllipse:</span>
<span class="line-added">3051         if (auto item = FillEllipse::decode(decoder))</span>
<span class="line-added">3052             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3053         break;</span>
<span class="line-added">3054     case ItemType::StrokeRect:</span>
<span class="line-added">3055         if (auto item = StrokeRect::decode(decoder))</span>
<span class="line-added">3056             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3057         break;</span>
<span class="line-added">3058     case ItemType::StrokePath:</span>
<span class="line-added">3059         if (auto item = StrokePath::decode(decoder))</span>
<span class="line-added">3060             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3061         break;</span>
<span class="line-added">3062     case ItemType::StrokeEllipse:</span>
<span class="line-added">3063         if (auto item = StrokeEllipse::decode(decoder))</span>
<span class="line-added">3064             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3065         break;</span>
<span class="line-added">3066     case ItemType::ClearRect:</span>
<span class="line-added">3067         if (auto item = ClearRect::decode(decoder))</span>
<span class="line-added">3068             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3069         break;</span>
<span class="line-added">3070     case ItemType::BeginTransparencyLayer:</span>
<span class="line-added">3071         if (auto item = BeginTransparencyLayer::decode(decoder))</span>
<span class="line-added">3072             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3073         break;</span>
<span class="line-added">3074     case ItemType::EndTransparencyLayer:</span>
<span class="line-added">3075         if (auto item = EndTransparencyLayer::decode(decoder))</span>
<span class="line-added">3076             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3077         break;</span>
<span class="line-added">3078 #if USE(CG)</span>
<span class="line-added">3079     case ItemType::ApplyStrokePattern:</span>
<span class="line-added">3080         if (auto item = ApplyStrokePattern::decode(decoder))</span>
<span class="line-added">3081             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3082         break;</span>
<span class="line-added">3083     case ItemType::ApplyFillPattern:</span>
<span class="line-added">3084         if (auto item = ApplyFillPattern::decode(decoder))</span>
<span class="line-added">3085             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3086         break;</span>
<span class="line-added">3087 #endif</span>
<span class="line-added">3088     case ItemType::ApplyDeviceScaleFactor:</span>
<span class="line-added">3089         if (auto item = ApplyDeviceScaleFactor::decode(decoder))</span>
<span class="line-added">3090             return static_reference_cast&lt;Item&gt;(WTFMove(*item));</span>
<span class="line-added">3091         break;</span>
<span class="line-added">3092     }</span>
<span class="line-added">3093 </span>
<span class="line-added">3094     return WTF::nullopt;</span>
<span class="line-added">3095 }</span>
<span class="line-added">3096 </span>
3097 } // namespace DisplayList
3098 } // namespace WebCore
3099 
3100 
3101 #define SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_DRAWINGITEM(ToValueTypeName, predicate) \
3102 SPECIALIZE_TYPE_TRAITS_BEGIN(WebCore::DisplayList::ToValueTypeName) \
3103     static bool isType(const WebCore::DisplayList::Item&amp; object) { return object.predicate; } \
3104 SPECIALIZE_TYPE_TRAITS_END()
3105 
3106 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_DRAWINGITEM(DrawingItem, isDrawingItem())
3107 
3108 #define SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(ToValueTypeName) \
3109 SPECIALIZE_TYPE_TRAITS_BEGIN(WebCore::DisplayList::ToValueTypeName) \
3110     static bool isType(const WebCore::DisplayList::Item&amp; item) { return item.type() == WebCore::DisplayList::ItemType::ToValueTypeName; } \
3111 SPECIALIZE_TYPE_TRAITS_END()
3112 
3113 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(Save)
3114 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(Restore)
3115 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(Translate)
3116 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(Rotate)
3117 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(Scale)
<a name="200" id="anc200"></a><span class="line-added">3118 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(SetCTM)</span>
3119 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(ConcatenateCTM)
3120 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(SetState)
3121 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(SetLineCap)
3122 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(SetLineDash)
3123 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(SetLineJoin)
3124 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(SetMiterLimit)
3125 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(Clip)
3126 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(ClipOut)
3127 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(ClipOutToPath)
3128 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(ClipPath)
3129 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawGlyphs)
3130 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawImage)
3131 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawTiledImage)
3132 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawTiledScaledImage)
3133 #if USE(CG) || USE(CAIRO)
3134 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawNativeImage)
3135 #endif
3136 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawPattern)
3137 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawRect)
3138 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawLine)
3139 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawLinesForText)
3140 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawDotsForDocumentMarker)
3141 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawEllipse)
3142 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawPath)
3143 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawFocusRingPath)
3144 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(DrawFocusRingRects)
3145 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(FillRect)
3146 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(FillRectWithColor)
3147 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(FillRectWithGradient)
3148 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(FillCompositedRect)
3149 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(FillRoundedRect)
3150 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(FillRectWithRoundedHole)
3151 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(FillPath)
3152 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(FillEllipse)
3153 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(StrokeRect)
3154 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(StrokePath)
3155 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(StrokeEllipse)
3156 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(ClearRect)
3157 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(BeginTransparencyLayer)
3158 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(EndTransparencyLayer)
3159 #if USE(CG)
3160 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(ApplyStrokePattern)
3161 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(ApplyFillPattern)
3162 #endif
3163 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(ApplyDeviceScaleFactor)
3164 SPECIALIZE_TYPE_TRAITS_DISPLAYLIST_ITEM(ClearShadow)
3165 
<a name="201" id="anc201"></a><span class="line-added">3166 namespace WTF {</span>
<span class="line-added">3167 </span>
<span class="line-added">3168 template&lt;&gt; struct EnumTraits&lt;WebCore::DisplayList::ItemType&gt; {</span>
<span class="line-added">3169     using values = EnumValues&lt;</span>
<span class="line-added">3170     WebCore::DisplayList::ItemType,</span>
<span class="line-added">3171     WebCore::DisplayList::ItemType::Save,</span>
<span class="line-added">3172     WebCore::DisplayList::ItemType::Restore,</span>
<span class="line-added">3173     WebCore::DisplayList::ItemType::Translate,</span>
<span class="line-added">3174     WebCore::DisplayList::ItemType::Rotate,</span>
<span class="line-added">3175     WebCore::DisplayList::ItemType::Scale,</span>
<span class="line-added">3176     WebCore::DisplayList::ItemType::SetCTM,</span>
<span class="line-added">3177     WebCore::DisplayList::ItemType::ConcatenateCTM,</span>
<span class="line-added">3178     WebCore::DisplayList::ItemType::SetState,</span>
<span class="line-added">3179     WebCore::DisplayList::ItemType::SetLineCap,</span>
<span class="line-added">3180     WebCore::DisplayList::ItemType::SetLineDash,</span>
<span class="line-added">3181     WebCore::DisplayList::ItemType::SetLineJoin,</span>
<span class="line-added">3182     WebCore::DisplayList::ItemType::SetMiterLimit,</span>
<span class="line-added">3183     WebCore::DisplayList::ItemType::ClearShadow,</span>
<span class="line-added">3184     WebCore::DisplayList::ItemType::Clip,</span>
<span class="line-added">3185     WebCore::DisplayList::ItemType::ClipOut,</span>
<span class="line-added">3186     WebCore::DisplayList::ItemType::ClipOutToPath,</span>
<span class="line-added">3187     WebCore::DisplayList::ItemType::ClipPath,</span>
<span class="line-added">3188     WebCore::DisplayList::ItemType::DrawGlyphs,</span>
<span class="line-added">3189     WebCore::DisplayList::ItemType::DrawImage,</span>
<span class="line-added">3190     WebCore::DisplayList::ItemType::DrawTiledImage,</span>
<span class="line-added">3191     WebCore::DisplayList::ItemType::DrawTiledScaledImage,</span>
<span class="line-added">3192 #if USE(CG) || USE(CAIRO) || USE(DIRECT2D)</span>
<span class="line-added">3193     WebCore::DisplayList::ItemType::DrawNativeImage,</span>
<span class="line-added">3194 #endif</span>
<span class="line-added">3195     WebCore::DisplayList::ItemType::DrawPattern,</span>
<span class="line-added">3196     WebCore::DisplayList::ItemType::DrawRect,</span>
<span class="line-added">3197     WebCore::DisplayList::ItemType::DrawLine,</span>
<span class="line-added">3198     WebCore::DisplayList::ItemType::DrawLinesForText,</span>
<span class="line-added">3199     WebCore::DisplayList::ItemType::DrawDotsForDocumentMarker,</span>
<span class="line-added">3200     WebCore::DisplayList::ItemType::DrawEllipse,</span>
<span class="line-added">3201     WebCore::DisplayList::ItemType::DrawPath,</span>
<span class="line-added">3202     WebCore::DisplayList::ItemType::DrawFocusRingPath,</span>
<span class="line-added">3203     WebCore::DisplayList::ItemType::DrawFocusRingRects,</span>
<span class="line-added">3204     WebCore::DisplayList::ItemType::FillRect,</span>
<span class="line-added">3205     WebCore::DisplayList::ItemType::FillRectWithColor,</span>
<span class="line-added">3206     WebCore::DisplayList::ItemType::FillRectWithGradient,</span>
<span class="line-added">3207     WebCore::DisplayList::ItemType::FillCompositedRect,</span>
<span class="line-added">3208     WebCore::DisplayList::ItemType::FillRoundedRect,</span>
<span class="line-added">3209     WebCore::DisplayList::ItemType::FillRectWithRoundedHole,</span>
<span class="line-added">3210     WebCore::DisplayList::ItemType::FillPath,</span>
<span class="line-added">3211     WebCore::DisplayList::ItemType::FillEllipse,</span>
<span class="line-added">3212     WebCore::DisplayList::ItemType::StrokeRect,</span>
<span class="line-added">3213     WebCore::DisplayList::ItemType::StrokePath,</span>
<span class="line-added">3214     WebCore::DisplayList::ItemType::StrokeEllipse,</span>
<span class="line-added">3215     WebCore::DisplayList::ItemType::ClearRect,</span>
<span class="line-added">3216     WebCore::DisplayList::ItemType::BeginTransparencyLayer,</span>
<span class="line-added">3217     WebCore::DisplayList::ItemType::EndTransparencyLayer,</span>
<span class="line-added">3218 #if USE(CG)</span>
<span class="line-added">3219     WebCore::DisplayList::ItemType::ApplyStrokePattern,</span>
<span class="line-added">3220     WebCore::DisplayList::ItemType::ApplyFillPattern,</span>
<span class="line-added">3221 #endif</span>
<span class="line-added">3222     WebCore::DisplayList::ItemType::ApplyDeviceScaleFactor</span>
<span class="line-added">3223     &gt;;</span>
<span class="line-added">3224 };</span>
<span class="line-added">3225 </span>
<span class="line-added">3226 } // namespace WTF</span>
<a name="202" id="anc202"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="202" type="hidden" />
</body>
</html>