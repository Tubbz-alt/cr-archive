<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSDOMPromiseDeferred.h</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSDOMPromiseDeferred.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSDOMWindowBase.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bindings/js/JSDOMPromiseDeferred.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,97 +23,104 @@</span>
   * THE POSSIBILITY OF SUCH DAMAGE.
   */
  
  #pragma once
  
<span class="udiff-line-added">+ #include &quot;EventLoop.h&quot;</span>
  #include &quot;ExceptionOr.h&quot;
  #include &quot;JSDOMConvert.h&quot;
  #include &quot;JSDOMGuardedObject.h&quot;
<span class="udiff-line-added">+ #include &quot;ScriptExecutionContext.h&quot;</span>
  #include &lt;JavaScriptCore/CatchScope.h&gt;
<span class="udiff-line-modified-removed">- #include &lt;JavaScriptCore/JSPromiseDeferred.h&gt;</span>
<span class="udiff-line-modified-added">+ #include &lt;JavaScriptCore/JSPromise.h&gt;</span>
  
  namespace WebCore {
  
  class JSDOMWindow;
  
<span class="udiff-line-modified-removed">- class DeferredPromise : public DOMGuarded&lt;JSC::JSPromiseDeferred&gt; {</span>
<span class="udiff-line-modified-added">+ class DeferredPromise : public DOMGuarded&lt;JSC::JSPromise&gt; {</span>
  public:
      enum class Mode {
          ClearPromiseOnResolve,
          RetainPromiseOnResolve
      };
  
<span class="udiff-line-modified-removed">-     static RefPtr&lt;DeferredPromise&gt; create(JSC::ExecState&amp; state, JSDOMGlobalObject&amp; globalObject, Mode mode = Mode::ClearPromiseOnResolve)</span>
<span class="udiff-line-modified-added">+     static RefPtr&lt;DeferredPromise&gt; create(JSDOMGlobalObject&amp; globalObject, Mode mode = Mode::ClearPromiseOnResolve)</span>
      {
<span class="udiff-line-modified-removed">-         auto* promiseDeferred = JSC::JSPromiseDeferred::tryCreate(&amp;state, &amp;globalObject);</span>
<span class="udiff-line-modified-removed">-         if (!promiseDeferred)</span>
<span class="udiff-line-modified-removed">-             return nullptr;</span>
<span class="udiff-line-modified-removed">-         return adoptRef(new DeferredPromise(globalObject, *promiseDeferred, mode));</span>
<span class="udiff-line-modified-added">+         JSC::VM&amp; vm = JSC::getVM(&amp;globalObject);</span>
<span class="udiff-line-modified-added">+         auto* promise = JSC::JSPromise::create(vm, globalObject.promiseStructure());</span>
<span class="udiff-line-modified-added">+         ASSERT(promise);</span>
<span class="udiff-line-modified-added">+         return adoptRef(new DeferredPromise(globalObject, *promise, mode));</span>
      }
  
<span class="udiff-line-modified-removed">-     static Ref&lt;DeferredPromise&gt; create(JSDOMGlobalObject&amp; globalObject, JSC::JSPromiseDeferred&amp; deferred, Mode mode = Mode::ClearPromiseOnResolve)</span>
<span class="udiff-line-modified-added">+     static Ref&lt;DeferredPromise&gt; create(JSDOMGlobalObject&amp; globalObject, JSC::JSPromise&amp; deferred, Mode mode = Mode::ClearPromiseOnResolve)</span>
      {
          return adoptRef(*new DeferredPromise(globalObject, deferred, mode));
      }
  
      template&lt;class IDLType&gt;
      void resolve(typename IDLType::ParameterType value)
      {
<span class="udiff-line-modified-removed">-         if (isSuspended())</span>
<span class="udiff-line-modified-added">+         if (shouldIgnoreRequestToFulfill())</span>
              return;
<span class="udiff-line-added">+ </span>
          ASSERT(deferred());
          ASSERT(globalObject());
<span class="udiff-line-modified-removed">-         JSC::ExecState* exec = globalObject()-&gt;globalExec();</span>
<span class="udiff-line-modified-removed">-         JSC::JSLockHolder locker(exec);</span>
<span class="udiff-line-modified-removed">-         resolve(*exec, toJS&lt;IDLType&gt;(*exec, *globalObject(), std::forward&lt;typename IDLType::ParameterType&gt;(value)));</span>
<span class="udiff-line-modified-added">+         JSC::JSGlobalObject* lexicalGlobalObject = globalObject();</span>
<span class="udiff-line-modified-added">+         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="udiff-line-modified-added">+         resolve(*lexicalGlobalObject, toJS&lt;IDLType&gt;(*lexicalGlobalObject, *globalObject(), std::forward&lt;typename IDLType::ParameterType&gt;(value)));</span>
      }
  
      void resolve()
      {
<span class="udiff-line-modified-removed">-         if (isSuspended())</span>
<span class="udiff-line-modified-added">+         if (shouldIgnoreRequestToFulfill())</span>
              return;
<span class="udiff-line-added">+ </span>
          ASSERT(deferred());
          ASSERT(globalObject());
<span class="udiff-line-modified-removed">-         JSC::ExecState* exec = globalObject()-&gt;globalExec();</span>
<span class="udiff-line-modified-removed">-         JSC::JSLockHolder locker(exec);</span>
<span class="udiff-line-modified-removed">-         resolve(*exec, JSC::jsUndefined());</span>
<span class="udiff-line-modified-added">+         JSC::JSGlobalObject* lexicalGlobalObject = globalObject();</span>
<span class="udiff-line-modified-added">+         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="udiff-line-modified-added">+         resolve(*lexicalGlobalObject, JSC::jsUndefined());</span>
      }
  
      template&lt;class IDLType&gt;
      void resolveWithNewlyCreated(typename IDLType::ParameterType value)
      {
<span class="udiff-line-modified-removed">-         if (isSuspended())</span>
<span class="udiff-line-modified-added">+         if (shouldIgnoreRequestToFulfill())</span>
              return;
<span class="udiff-line-added">+ </span>
          ASSERT(deferred());
          ASSERT(globalObject());
<span class="udiff-line-modified-removed">-         JSC::ExecState* exec = globalObject()-&gt;globalExec();</span>
<span class="udiff-line-modified-removed">-         JSC::JSLockHolder locker(exec);</span>
<span class="udiff-line-modified-removed">-         resolve(*exec, toJSNewlyCreated&lt;IDLType&gt;(*exec, *globalObject(), std::forward&lt;typename IDLType::ParameterType&gt;(value)));</span>
<span class="udiff-line-modified-added">+         JSC::JSGlobalObject* lexicalGlobalObject = globalObject();</span>
<span class="udiff-line-modified-added">+         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="udiff-line-modified-added">+         resolve(*lexicalGlobalObject, toJSNewlyCreated&lt;IDLType&gt;(*lexicalGlobalObject, *globalObject(), std::forward&lt;typename IDLType::ParameterType&gt;(value)));</span>
      }
  
      template&lt;class IDLType&gt;
      void resolveCallbackValueWithNewlyCreated(const Function&lt;typename IDLType::InnerParameterType(ScriptExecutionContext&amp;)&gt;&amp; createValue)
      {
<span class="udiff-line-modified-removed">-         if (isSuspended())</span>
<span class="udiff-line-modified-added">+         if (shouldIgnoreRequestToFulfill())</span>
              return;
<span class="udiff-line-added">+ </span>
          ASSERT(deferred());
          ASSERT(globalObject());
<span class="udiff-line-modified-removed">-         auto* exec = globalObject()-&gt;globalExec();</span>
<span class="udiff-line-modified-removed">-         JSC::JSLockHolder locker(exec);</span>
<span class="udiff-line-modified-removed">-         resolve(*exec, toJSNewlyCreated&lt;IDLType&gt;(*exec, *globalObject(), createValue(*globalObject()-&gt;scriptExecutionContext())));</span>
<span class="udiff-line-modified-added">+         auto* lexicalGlobalObject = globalObject();</span>
<span class="udiff-line-modified-added">+         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="udiff-line-modified-added">+         resolve(*lexicalGlobalObject, toJSNewlyCreated&lt;IDLType&gt;(*lexicalGlobalObject, *globalObject(), createValue(*globalObject()-&gt;scriptExecutionContext())));</span>
      }
  
      template&lt;class IDLType&gt;
      void reject(typename IDLType::ParameterType value)
      {
<span class="udiff-line-modified-removed">-         if (isSuspended())</span>
<span class="udiff-line-modified-added">+         if (shouldIgnoreRequestToFulfill())</span>
              return;
<span class="udiff-line-added">+ </span>
          ASSERT(deferred());
          ASSERT(globalObject());
<span class="udiff-line-modified-removed">-         JSC::ExecState* exec = globalObject()-&gt;globalExec();</span>
<span class="udiff-line-modified-removed">-         JSC::JSLockHolder locker(exec);</span>
<span class="udiff-line-modified-removed">-         reject(*exec, toJS&lt;IDLType&gt;(*exec, *globalObject(), std::forward&lt;typename IDLType::ParameterType&gt;(value)));</span>
<span class="udiff-line-modified-added">+         JSC::JSGlobalObject* lexicalGlobalObject = globalObject();</span>
<span class="udiff-line-modified-added">+         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="udiff-line-modified-added">+         reject(*lexicalGlobalObject, toJS&lt;IDLType&gt;(*lexicalGlobalObject, *globalObject(), std::forward&lt;typename IDLType::ParameterType&gt;(value)));</span>
      }
  
      void reject();
      void reject(std::nullptr_t);
      void reject(Exception);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -121,102 +128,113 @@</span>
      void reject(const JSC::PrivateName&amp;);
  
      template&lt;typename Callback&gt;
      void resolveWithCallback(Callback callback)
      {
<span class="udiff-line-modified-removed">-         if (isSuspended())</span>
<span class="udiff-line-modified-added">+         if (shouldIgnoreRequestToFulfill())</span>
              return;
<span class="udiff-line-added">+ </span>
          ASSERT(deferred());
          ASSERT(globalObject());
<span class="udiff-line-modified-removed">-         JSC::ExecState* exec = globalObject()-&gt;globalExec();</span>
<span class="udiff-line-modified-removed">-         JSC::JSLockHolder locker(exec);</span>
<span class="udiff-line-modified-removed">-         resolve(*exec, callback(*exec, *globalObject()));</span>
<span class="udiff-line-modified-added">+         JSC::JSGlobalObject* lexicalGlobalObject = globalObject();</span>
<span class="udiff-line-modified-added">+         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="udiff-line-modified-added">+         resolve(*lexicalGlobalObject, callback(*globalObject()));</span>
      }
  
      template&lt;typename Callback&gt;
      void rejectWithCallback(Callback callback)
      {
<span class="udiff-line-modified-removed">-         if (isSuspended())</span>
<span class="udiff-line-modified-added">+         if (shouldIgnoreRequestToFulfill())</span>
              return;
<span class="udiff-line-added">+ </span>
          ASSERT(deferred());
          ASSERT(globalObject());
<span class="udiff-line-modified-removed">-         JSC::ExecState* exec = globalObject()-&gt;globalExec();</span>
<span class="udiff-line-modified-removed">-         JSC::JSLockHolder locker(exec);</span>
<span class="udiff-line-modified-removed">-         reject(*exec, callback(*exec, *globalObject()));</span>
<span class="udiff-line-modified-added">+         JSC::JSGlobalObject* lexicalGlobalObject = globalObject();</span>
<span class="udiff-line-modified-added">+         JSC::JSLockHolder locker(lexicalGlobalObject);</span>
<span class="udiff-line-modified-added">+         reject(*lexicalGlobalObject, callback(*globalObject()));</span>
      }
  
      JSC::JSValue promise() const;
  
<span class="udiff-line-modified-removed">-     void whenSettled(std::function&lt;void()&gt;&amp;&amp;);</span>
<span class="udiff-line-modified-added">+     void whenSettled(Function&lt;void()&gt;&amp;&amp;);</span>
  
  private:
<span class="udiff-line-modified-removed">-     DeferredPromise(JSDOMGlobalObject&amp; globalObject, JSC::JSPromiseDeferred&amp; deferred, Mode mode)</span>
<span class="udiff-line-modified-removed">-         : DOMGuarded&lt;JSC::JSPromiseDeferred&gt;(globalObject, deferred)</span>
<span class="udiff-line-modified-added">+     DeferredPromise(JSDOMGlobalObject&amp; globalObject, JSC::JSPromise&amp; deferred, Mode mode)</span>
<span class="udiff-line-modified-added">+         : DOMGuarded&lt;JSC::JSPromise&gt;(globalObject, deferred)</span>
          , m_mode(mode)
      {
      }
  
<span class="udiff-line-modified-removed">-     JSC::JSPromiseDeferred* deferred() const { return guarded(); }</span>
<span class="udiff-line-modified-added">+     bool shouldIgnoreRequestToFulfill() const { return isEmpty() || activeDOMObjectAreStopped(); }</span>
  
<span class="udiff-line-modified-removed">-     WEBCORE_EXPORT void callFunction(JSC::ExecState&amp;, JSC::JSValue function, JSC::JSValue resolution);</span>
<span class="udiff-line-modified-added">+     JSC::JSPromise* deferred() const { return guarded(); }</span>
  
<span class="udiff-line-modified-removed">-     void resolve(JSC::ExecState&amp; state, JSC::JSValue resolution) { callFunction(state, deferred()-&gt;resolve(), resolution); }</span>
<span class="udiff-line-modified-removed">-     void reject(JSC::ExecState&amp; state, JSC::JSValue resolution) { callFunction(state, deferred()-&gt;reject(), resolution); }</span>
<span class="udiff-line-modified-added">+     enum class ResolveMode { Resolve, Reject };</span>
<span class="udiff-line-modified-added">+     WEBCORE_EXPORT void callFunction(JSC::JSGlobalObject&amp;, ResolveMode, JSC::JSValue resolution);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void resolve(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::JSValue resolution) { callFunction(lexicalGlobalObject, ResolveMode::Resolve, resolution); }</span>
<span class="udiff-line-added">+     void reject(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::JSValue resolution) { callFunction(lexicalGlobalObject, ResolveMode::Reject, resolution); }</span>
  
      Mode m_mode;
  };
  
  class DOMPromiseDeferredBase {
<span class="udiff-line-added">+     WTF_MAKE_FAST_ALLOCATED;</span>
  public:
      DOMPromiseDeferredBase(Ref&lt;DeferredPromise&gt;&amp;&amp; genericPromise)
<span class="udiff-line-modified-removed">-         : m_promiseDeferred(WTFMove(genericPromise))</span>
<span class="udiff-line-modified-added">+         : m_promise(WTFMove(genericPromise))</span>
      {
      }
  
      DOMPromiseDeferredBase(DOMPromiseDeferredBase&amp;&amp; promise)
<span class="udiff-line-modified-removed">-         : m_promiseDeferred(WTFMove(promise.m_promiseDeferred))</span>
<span class="udiff-line-modified-added">+         : m_promise(WTFMove(promise.m_promise))</span>
      {
      }
  
      DOMPromiseDeferredBase(const DOMPromiseDeferredBase&amp; other)
<span class="udiff-line-modified-removed">-         : m_promiseDeferred(other.m_promiseDeferred.copyRef())</span>
<span class="udiff-line-modified-added">+         : m_promise(other.m_promise.copyRef())</span>
      {
      }
  
      DOMPromiseDeferredBase&amp; operator=(const DOMPromiseDeferredBase&amp; other)
      {
<span class="udiff-line-modified-removed">-         m_promiseDeferred = other.m_promiseDeferred.copyRef();</span>
<span class="udiff-line-modified-added">+         m_promise = other.m_promise.copyRef();</span>
          return *this;
      }
  
      DOMPromiseDeferredBase&amp; operator=(DOMPromiseDeferredBase&amp;&amp; other)
      {
<span class="udiff-line-modified-removed">-         m_promiseDeferred = WTFMove(other.m_promiseDeferred);</span>
<span class="udiff-line-modified-added">+         m_promise = WTFMove(other.m_promise);</span>
          return *this;
      }
  
      void reject()
      {
<span class="udiff-line-modified-removed">-         m_promiseDeferred-&gt;reject();</span>
<span class="udiff-line-modified-added">+         m_promise-&gt;reject();</span>
      }
  
      template&lt;typename... ErrorType&gt;
      void reject(ErrorType&amp;&amp;... error)
      {
<span class="udiff-line-modified-removed">-         m_promiseDeferred-&gt;reject(std::forward&lt;ErrorType&gt;(error)...);</span>
<span class="udiff-line-modified-added">+         m_promise-&gt;reject(std::forward&lt;ErrorType&gt;(error)...);</span>
      }
  
      template&lt;typename IDLType&gt;
      void rejectType(typename IDLType::ParameterType value)
      {
<span class="udiff-line-modified-removed">-         m_promiseDeferred-&gt;reject&lt;IDLType&gt;(std::forward&lt;typename IDLType::ParameterType&gt;(value));</span>
<span class="udiff-line-modified-added">+         m_promise-&gt;reject&lt;IDLType&gt;(std::forward&lt;typename IDLType::ParameterType&gt;(value));</span>
      }
  
<span class="udiff-line-modified-removed">-     JSC::JSValue promise() const { return m_promiseDeferred-&gt;promise(); };</span>
<span class="udiff-line-modified-added">+     JSC::JSValue promise() const { return m_promise-&gt;promise(); };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void whenSettled(Function&lt;void()&gt;&amp;&amp; function)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         m_promise-&gt;whenSettled(WTFMove(function));</span>
<span class="udiff-line-added">+     }</span>
  
  protected:
<span class="udiff-line-modified-removed">-     Ref&lt;DeferredPromise&gt; m_promiseDeferred;</span>
<span class="udiff-line-modified-added">+     Ref&lt;DeferredPromise&gt; m_promise;</span>
  };
  
  template&lt;typename IDLType&gt;
  class DOMPromiseDeferred : public DOMPromiseDeferredBase {
  public:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -225,11 +243,11 @@</span>
      using DOMPromiseDeferredBase::promise;
      using DOMPromiseDeferredBase::reject;
  
      void resolve(typename IDLType::ParameterType value)
      {
<span class="udiff-line-modified-removed">-         m_promiseDeferred-&gt;resolve&lt;IDLType&gt;(std::forward&lt;typename IDLType::ParameterType&gt;(value));</span>
<span class="udiff-line-modified-added">+         m_promise-&gt;resolve&lt;IDLType&gt;(std::forward&lt;typename IDLType::ParameterType&gt;(value));</span>
      }
  
      void settle(ExceptionOr&lt;typename IDLType::ParameterType&gt;&amp;&amp; result)
      {
          if (result.hasException()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -247,11 +265,11 @@</span>
      using DOMPromiseDeferredBase::promise;
      using DOMPromiseDeferredBase::reject;
  
      void resolve()
      {
<span class="udiff-line-modified-removed">-         m_promiseDeferred-&gt;resolve();</span>
<span class="udiff-line-modified-added">+         m_promise-&gt;resolve();</span>
      }
  
      void settle(ExceptionOr&lt;void&gt;&amp;&amp; result)
      {
          if (result.hasException()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -261,73 +279,69 @@</span>
          resolve();
      }
  };
  
  
<span class="udiff-line-modified-removed">- Ref&lt;DeferredPromise&gt; createDeferredPromise(JSC::ExecState&amp;, JSDOMWindow&amp;);</span>
<span class="udiff-line-modified-added">+ Ref&lt;DeferredPromise&gt; createDeferredPromise(JSC::JSGlobalObject&amp;, JSDOMWindow&amp;);</span>
  
  void fulfillPromiseWithJSON(Ref&lt;DeferredPromise&gt;&amp;&amp;, const String&amp;);
  void fulfillPromiseWithArrayBuffer(Ref&lt;DeferredPromise&gt;&amp;&amp;, ArrayBuffer*);
  void fulfillPromiseWithArrayBuffer(Ref&lt;DeferredPromise&gt;&amp;&amp;, const void*, size_t);
<span class="udiff-line-modified-removed">- WEBCORE_EXPORT void rejectPromiseWithExceptionIfAny(JSC::ExecState&amp;, JSDOMGlobalObject&amp;, JSC::JSPromiseDeferred&amp;);</span>
<span class="udiff-line-modified-added">+ WEBCORE_EXPORT void rejectPromiseWithExceptionIfAny(JSC::JSGlobalObject&amp;, JSDOMGlobalObject&amp;, JSC::JSPromise&amp;);</span>
  
  enum class RejectedPromiseWithTypeErrorCause { NativeGetter, InvalidThis };
<span class="udiff-line-modified-removed">- JSC::EncodedJSValue createRejectedPromiseWithTypeError(JSC::ExecState&amp;, const String&amp;, RejectedPromiseWithTypeErrorCause);</span>
<span class="udiff-line-modified-added">+ JSC::EncodedJSValue createRejectedPromiseWithTypeError(JSC::JSGlobalObject&amp;, const String&amp;, RejectedPromiseWithTypeErrorCause);</span>
  
<span class="udiff-line-modified-removed">- using PromiseFunction = void(JSC::ExecState&amp;, Ref&lt;DeferredPromise&gt;&amp;&amp;);</span>
<span class="udiff-line-modified-added">+ using PromiseFunction = void(JSC::JSGlobalObject&amp;, JSC::CallFrame&amp;, Ref&lt;DeferredPromise&gt;&amp;&amp;);</span>
  
<span class="udiff-line-modified-removed">- enum class PromiseExecutionScope { WindowOnly, WindowOrWorker };</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">- template&lt;PromiseFunction promiseFunction, PromiseExecutionScope executionScope&gt;</span>
<span class="udiff-line-removed">- inline JSC::JSValue callPromiseFunction(JSC::ExecState&amp; state)</span>
<span class="udiff-line-modified-added">+ template&lt;PromiseFunction promiseFunction&gt;</span>
<span class="udiff-line-modified-added">+ inline JSC::JSValue callPromiseFunction(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::CallFrame&amp; callFrame)</span>
  {
<span class="udiff-line-modified-removed">-     JSC::VM&amp; vm = state.vm();</span>
<span class="udiff-line-modified-added">+     JSC::VM&amp; vm = JSC::getVM(&amp;lexicalGlobalObject);</span>
      auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="udiff-line-modified-removed">-     auto&amp; globalObject = callerGlobalObject(state);</span>
<span class="udiff-line-modified-removed">-     JSC::JSPromiseDeferred* promiseDeferred = JSC::JSPromiseDeferred::tryCreate(&amp;state, &amp;globalObject);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-     // promiseDeferred can be null when terminating a Worker abruptly.</span>
<span class="udiff-line-removed">-     if (executionScope == PromiseExecutionScope::WindowOrWorker &amp;&amp; !promiseDeferred)</span>
<span class="udiff-line-removed">-         return JSC::jsUndefined();</span>
<span class="udiff-line-modified-added">+     auto&amp; globalObject = callerGlobalObject(lexicalGlobalObject, callFrame);</span>
<span class="udiff-line-modified-added">+     auto* promise = JSC::JSPromise::create(vm, globalObject.promiseStructure());</span>
<span class="udiff-line-modified-added">+     ASSERT(promise);</span>
  
<span class="udiff-line-modified-removed">-     promiseFunction(state, DeferredPromise::create(globalObject, *promiseDeferred));</span>
<span class="udiff-line-modified-added">+     promiseFunction(lexicalGlobalObject, callFrame, DeferredPromise::create(globalObject, *promise));</span>
  
<span class="udiff-line-modified-removed">-     rejectPromiseWithExceptionIfAny(state, globalObject, *promiseDeferred);</span>
<span class="udiff-line-modified-removed">-     EXCEPTION_ASSERT_UNUSED(scope, !scope.exception());</span>
<span class="udiff-line-modified-removed">-     return promiseDeferred-&gt;promise();</span>
<span class="udiff-line-modified-added">+     rejectPromiseWithExceptionIfAny(lexicalGlobalObject, globalObject, *promise);</span>
<span class="udiff-line-modified-added">+     // FIXME: We could have error since any JS call can throw stack-overflow errors.</span>
<span class="udiff-line-modified-added">+     // https://bugs.webkit.org/show_bug.cgi?id=203402</span>
<span class="udiff-line-added">+     RETURN_IF_EXCEPTION(scope, JSC::jsUndefined());</span>
<span class="udiff-line-added">+     return promise;</span>
  }
  
<span class="udiff-line-modified-removed">- template&lt;PromiseExecutionScope executionScope, typename PromiseFunctor&gt;</span>
<span class="udiff-line-modified-removed">- inline JSC::JSValue callPromiseFunction(JSC::ExecState&amp; state, PromiseFunctor functor)</span>
<span class="udiff-line-modified-added">+ template&lt;typename PromiseFunctor&gt;</span>
<span class="udiff-line-modified-added">+ inline JSC::JSValue callPromiseFunction(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::CallFrame&amp; callFrame, PromiseFunctor functor)</span>
  {
<span class="udiff-line-modified-removed">-     JSC::VM&amp; vm = state.vm();</span>
<span class="udiff-line-modified-added">+     JSC::VM&amp; vm = JSC::getVM(&amp;lexicalGlobalObject);</span>
      auto scope = DECLARE_CATCH_SCOPE(vm);
  
<span class="udiff-line-modified-removed">-     auto&amp; globalObject = callerGlobalObject(state);</span>
<span class="udiff-line-modified-removed">-     JSC::JSPromiseDeferred* promiseDeferred = JSC::JSPromiseDeferred::tryCreate(&amp;state, &amp;globalObject);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-     // promiseDeferred can be null when terminating a Worker abruptly.</span>
<span class="udiff-line-removed">-     if (executionScope == PromiseExecutionScope::WindowOrWorker &amp;&amp; !promiseDeferred)</span>
<span class="udiff-line-removed">-         return JSC::jsUndefined();</span>
<span class="udiff-line-modified-added">+     auto&amp; globalObject = callerGlobalObject(lexicalGlobalObject, callFrame);</span>
<span class="udiff-line-modified-added">+     auto* promise = JSC::JSPromise::create(vm, globalObject.promiseStructure());</span>
<span class="udiff-line-modified-added">+     ASSERT(promise);</span>
  
<span class="udiff-line-modified-removed">-     functor(state, DeferredPromise::create(globalObject, *promiseDeferred));</span>
<span class="udiff-line-modified-added">+     functor(lexicalGlobalObject, callFrame, DeferredPromise::create(globalObject, *promise));</span>
  
<span class="udiff-line-modified-removed">-     rejectPromiseWithExceptionIfAny(state, globalObject, *promiseDeferred);</span>
<span class="udiff-line-modified-removed">-     EXCEPTION_ASSERT_UNUSED(scope, !scope.exception());</span>
<span class="udiff-line-modified-removed">-     return promiseDeferred-&gt;promise();</span>
<span class="udiff-line-modified-added">+     rejectPromiseWithExceptionIfAny(lexicalGlobalObject, globalObject, *promise);</span>
<span class="udiff-line-modified-added">+     // FIXME: We could have error since any JS call can throw stack-overflow errors.</span>
<span class="udiff-line-modified-added">+     // https://bugs.webkit.org/show_bug.cgi?id=203402</span>
<span class="udiff-line-added">+     RETURN_IF_EXCEPTION(scope, JSC::jsUndefined());</span>
<span class="udiff-line-added">+     return promise;</span>
  }
  
<span class="udiff-line-modified-removed">- using BindingPromiseFunction = JSC::EncodedJSValue(JSC::ExecState*, Ref&lt;DeferredPromise&gt;&amp;&amp;);</span>
<span class="udiff-line-modified-added">+ using BindingPromiseFunction = JSC::EncodedJSValue(JSC::JSGlobalObject*, JSC::CallFrame*, Ref&lt;DeferredPromise&gt;&amp;&amp;);</span>
  template&lt;BindingPromiseFunction bindingFunction&gt;
<span class="udiff-line-modified-removed">- inline void bindingPromiseFunctionAdapter(JSC::ExecState&amp; state, Ref&lt;DeferredPromise&gt;&amp;&amp; promise)</span>
<span class="udiff-line-modified-added">+ inline void bindingPromiseFunctionAdapter(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::CallFrame&amp; callFrame, Ref&lt;DeferredPromise&gt;&amp;&amp; promise)</span>
  {
<span class="udiff-line-modified-removed">-     bindingFunction(&amp;state, WTFMove(promise));</span>
<span class="udiff-line-modified-added">+     bindingFunction(&amp;lexicalGlobalObject, &amp;callFrame, WTFMove(promise));</span>
  }
  
<span class="udiff-line-modified-removed">- template&lt;BindingPromiseFunction bindingPromiseFunction, PromiseExecutionScope executionScope&gt;</span>
<span class="udiff-line-modified-removed">- inline JSC::JSValue callPromiseFunction(JSC::ExecState&amp; state)</span>
<span class="udiff-line-modified-added">+ template&lt;BindingPromiseFunction bindingPromiseFunction&gt;</span>
<span class="udiff-line-modified-added">+ inline JSC::JSValue callPromiseFunction(JSC::JSGlobalObject&amp; lexicalGlobalObject, JSC::CallFrame&amp; callFrame)</span>
  {
<span class="udiff-line-modified-removed">-     return callPromiseFunction&lt;bindingPromiseFunctionAdapter&lt;bindingPromiseFunction&gt;, executionScope&gt;(state);</span>
<span class="udiff-line-modified-added">+     return callPromiseFunction&lt;bindingPromiseFunctionAdapter&lt;bindingPromiseFunction&gt;&gt;(lexicalGlobalObject, callFrame);</span>
  }
  
  } // namespace WebCore
</pre>
<center><a href="JSDOMPromiseDeferred.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSDOMWindowBase.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>