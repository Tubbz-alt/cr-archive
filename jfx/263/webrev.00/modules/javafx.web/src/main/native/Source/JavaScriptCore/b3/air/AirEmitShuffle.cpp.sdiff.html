<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/b3/air/AirEmitShuffle.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AirDisassembler.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="AirFixObviousSpills.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/b3/air/AirEmitShuffle.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (C) 2016-2017 Apple Inc. All rights reserved.</span>
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;AirEmitShuffle.h&quot;
 28 
 29 #if ENABLE(B3_JIT)
 30 
 31 #include &quot;AirCode.h&quot;
 32 #include &quot;AirInstInlines.h&quot;
 33 #include &lt;wtf/GraphNodeWorklist.h&gt;
 34 #include &lt;wtf/ListDump.h&gt;
 35 
 36 namespace JSC { namespace B3 { namespace Air {
 37 
 38 namespace {
 39 
 40 namespace AirEmitShuffleInternal {
<span class="line-modified"> 41 static const bool verbose = false;</span>
 42 }
 43 
 44 template&lt;typename Functor&gt;
 45 Tmp findPossibleScratch(Code&amp; code, Bank bank, const Functor&amp; functor) {
 46     for (Reg reg : code.regsInPriorityOrder(bank)) {
 47         Tmp tmp(reg);
 48         if (functor(tmp))
 49             return tmp;
 50     }
 51     return Tmp();
 52 }
 53 
 54 Tmp findPossibleScratch(Code&amp; code, Bank bank, const Arg&amp; arg1, const Arg&amp; arg2) {
 55     return findPossibleScratch(
 56         code, bank,
 57         [&amp;] (Tmp tmp) -&gt; bool {
 58             return !arg1.usesTmp(tmp) &amp;&amp; !arg2.usesTmp(tmp);
 59         });
 60 }
 61 
</pre>
<hr />
<pre>
122         result.append(pair.src(), pair.dst(), Arg::widthArg(pair.width()));
123     return result;
124 }
125 
126 Vector&lt;Inst&gt; emitShuffle(
127     Code&amp; code, Vector&lt;ShufflePair&gt; pairs, std::array&lt;Arg, 2&gt; scratches, Bank bank,
128     Value* origin)
129 {
130     if (AirEmitShuffleInternal::verbose) {
131         dataLog(
132             &quot;Dealing with pairs: &quot;, listDump(pairs), &quot; and scratches &quot;, scratches[0], &quot;, &quot;,
133             scratches[1], &quot;\n&quot;);
134     }
135 
136     pairs.removeAllMatching(
137         [&amp;] (const ShufflePair&amp; pair) -&gt; bool {
138             return pair.src() == pair.dst();
139         });
140 
141     // First validate that this is the kind of shuffle that we know how to deal with.
<span class="line-modified">142 #if !ASSERT_DISABLED</span>
143     for (const ShufflePair&amp; pair : pairs) {
144         ASSERT(pair.src().isBank(bank));
145         ASSERT(pair.dst().isBank(bank));
146         ASSERT(pair.dst().isTmp() || pair.dst().isMemory());
147     }
<span class="line-modified">148 #endif // !ASSERT_DISABLED</span>
149 
150     // There are two possible kinds of operations that we will do:
151     //
152     // - Shift. Example: (a =&gt; b, b =&gt; c). We emit this as &quot;Move b, c; Move a, b&quot;. This only requires
153     //   scratch registers if there are memory-&gt;memory moves. We want to find as many of these as
154     //   possible because they are cheaper. Note that shifts can involve the same source mentioned
155     //   multiple times. Example: (a =&gt; b, a =&gt; c, b =&gt; d, b =&gt; e).
156     //
157     // - Rotate. Example: (a =&gt; b, b =&gt; a). We want to emit this as &quot;Swap a, b&quot;, but that instruction
158     //   may not be available, in which case we may need a scratch register or a scratch memory
159     //   location. A gnarlier example is (a =&gt; b, b =&gt; c, c =&gt; a). We can emit this as &quot;Swap b, c;
160     //   Swap a, b&quot;. Note that swapping has to be careful about differing widths.
161     //
162     // Note that a rotate can have &quot;fringe&quot;. For example, we might have (a =&gt; b, b =&gt; a, a =&gt;c,
163     // b =&gt; d). This has a rotate loop (a =&gt; b, b =&gt; a) and some fringe (a =&gt; c, b =&gt; d). We treat
164     // the whole thing as a single rotate.
165     //
166     // We will find multiple disjoint such operations. We can execute them in any order.
167 
168     // We interpret these as Moves that should be executed backwards. All shifts are keyed by their
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (C) 2016-2019 Apple Inc. All rights reserved.</span>
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;AirEmitShuffle.h&quot;
 28 
 29 #if ENABLE(B3_JIT)
 30 
 31 #include &quot;AirCode.h&quot;
 32 #include &quot;AirInstInlines.h&quot;
 33 #include &lt;wtf/GraphNodeWorklist.h&gt;
 34 #include &lt;wtf/ListDump.h&gt;
 35 
 36 namespace JSC { namespace B3 { namespace Air {
 37 
 38 namespace {
 39 
 40 namespace AirEmitShuffleInternal {
<span class="line-modified"> 41 static constexpr bool verbose = false;</span>
 42 }
 43 
 44 template&lt;typename Functor&gt;
 45 Tmp findPossibleScratch(Code&amp; code, Bank bank, const Functor&amp; functor) {
 46     for (Reg reg : code.regsInPriorityOrder(bank)) {
 47         Tmp tmp(reg);
 48         if (functor(tmp))
 49             return tmp;
 50     }
 51     return Tmp();
 52 }
 53 
 54 Tmp findPossibleScratch(Code&amp; code, Bank bank, const Arg&amp; arg1, const Arg&amp; arg2) {
 55     return findPossibleScratch(
 56         code, bank,
 57         [&amp;] (Tmp tmp) -&gt; bool {
 58             return !arg1.usesTmp(tmp) &amp;&amp; !arg2.usesTmp(tmp);
 59         });
 60 }
 61 
</pre>
<hr />
<pre>
122         result.append(pair.src(), pair.dst(), Arg::widthArg(pair.width()));
123     return result;
124 }
125 
126 Vector&lt;Inst&gt; emitShuffle(
127     Code&amp; code, Vector&lt;ShufflePair&gt; pairs, std::array&lt;Arg, 2&gt; scratches, Bank bank,
128     Value* origin)
129 {
130     if (AirEmitShuffleInternal::verbose) {
131         dataLog(
132             &quot;Dealing with pairs: &quot;, listDump(pairs), &quot; and scratches &quot;, scratches[0], &quot;, &quot;,
133             scratches[1], &quot;\n&quot;);
134     }
135 
136     pairs.removeAllMatching(
137         [&amp;] (const ShufflePair&amp; pair) -&gt; bool {
138             return pair.src() == pair.dst();
139         });
140 
141     // First validate that this is the kind of shuffle that we know how to deal with.
<span class="line-modified">142 #if ASSERT_ENABLED</span>
143     for (const ShufflePair&amp; pair : pairs) {
144         ASSERT(pair.src().isBank(bank));
145         ASSERT(pair.dst().isBank(bank));
146         ASSERT(pair.dst().isTmp() || pair.dst().isMemory());
147     }
<span class="line-modified">148 #endif // ASSERT_ENABLED</span>
149 
150     // There are two possible kinds of operations that we will do:
151     //
152     // - Shift. Example: (a =&gt; b, b =&gt; c). We emit this as &quot;Move b, c; Move a, b&quot;. This only requires
153     //   scratch registers if there are memory-&gt;memory moves. We want to find as many of these as
154     //   possible because they are cheaper. Note that shifts can involve the same source mentioned
155     //   multiple times. Example: (a =&gt; b, a =&gt; c, b =&gt; d, b =&gt; e).
156     //
157     // - Rotate. Example: (a =&gt; b, b =&gt; a). We want to emit this as &quot;Swap a, b&quot;, but that instruction
158     //   may not be available, in which case we may need a scratch register or a scratch memory
159     //   location. A gnarlier example is (a =&gt; b, b =&gt; c, c =&gt; a). We can emit this as &quot;Swap b, c;
160     //   Swap a, b&quot;. Note that swapping has to be careful about differing widths.
161     //
162     // Note that a rotate can have &quot;fringe&quot;. For example, we might have (a =&gt; b, b =&gt; a, a =&gt;c,
163     // b =&gt; d). This has a rotate loop (a =&gt; b, b =&gt; a) and some fringe (a =&gt; c, b =&gt; d). We treat
164     // the whole thing as a single rotate.
165     //
166     // We will find multiple disjoint such operations. We can execute them in any order.
167 
168     // We interpret these as Moves that should be executed backwards. All shifts are keyed by their
</pre>
</td>
</tr>
</table>
<center><a href="AirDisassembler.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="AirFixObviousSpills.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>