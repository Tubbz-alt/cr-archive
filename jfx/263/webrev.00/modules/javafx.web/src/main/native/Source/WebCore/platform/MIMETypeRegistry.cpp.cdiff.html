<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/platform/MIMETypeRegistry.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Logging.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MIMETypeRegistry.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/MIMETypeRegistry.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 26,10 ***</span>
<span class="line-new-header">--- 26,11 ---</span>
  
  #include &quot;config.h&quot;
  #include &quot;MIMETypeRegistry.h&quot;
  
  #include &quot;MediaPlayer.h&quot;
<span class="line-added">+ #include &quot;ThreadGlobalData.h&quot;</span>
  #include &lt;wtf/HashMap.h&gt;
  #include &lt;wtf/MainThread.h&gt;
  #include &lt;wtf/NeverDestroyed.h&gt;
  #include &lt;wtf/StdLibExtras.h&gt;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 73,10 ***</span>
<span class="line-new-header">--- 74,11 ---</span>
          &quot;image/tiff&quot;_s,
          &quot;image/gif&quot;_s,
          &quot;image/jpeg&quot;_s,
          &quot;image/vnd.microsoft.icon&quot;_s,
          &quot;image/jp2&quot;_s,
<span class="line-added">+         &quot;image/apng&quot;_s,</span>
          &quot;image/png&quot;_s,
          &quot;image/bmp&quot;_s,
  
          &quot;image/x-icon&quot;_s, // Favicons don&#39;t have a MIME type in the registry either.
          &quot;image/pjpeg&quot;_s, //  We only get one MIME type per UTI, hence our need to add these manually
</pre>
<hr />
<pre>
<span class="line-old-header">*** 133,10 ***</span>
<span class="line-new-header">--- 135,13 ---</span>
          &quot;image/gif&quot;_s,
          &quot;image/bmp&quot;_s,
          &quot;image/vnd.microsoft.icon&quot;_s, // ico
          &quot;image/x-icon&quot;_s, // ico
          &quot;image/x-xbitmap&quot;_s, // xbm
<span class="line-added">+ #if ENABLE(APNG)</span>
<span class="line-added">+         &quot;image/apng&quot;_s,</span>
<span class="line-added">+ #endif</span>
  #if USE(OPENJPEG)
          &quot;image/jp2&quot;_s,
          &quot;image/jpeg2000&quot;_s,
  #endif
  #if USE(WEBP)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 164,51 ***</span>
  {
      static NeverDestroyed&lt;HashSet&lt;String, ASCIICaseInsensitiveHash&gt;&gt; additionalSupportedImageMIMETypes;
      return additionalSupportedImageMIMETypes;
  }
  
<span class="line-removed">- static const HashSet&lt;String, ASCIICaseInsensitiveHash&gt;&amp; supportedImageMIMETypesForEncoding()</span>
<span class="line-removed">- {</span>
<span class="line-removed">- #if PLATFORM(COCOA)</span>
<span class="line-removed">-     static const auto supportedImageMIMETypesForEncoding = makeNeverDestroyed([] {</span>
<span class="line-removed">-         RetainPtr&lt;CFArrayRef&gt; supportedTypes = adoptCF(CGImageDestinationCopyTypeIdentifiers());</span>
<span class="line-removed">-         HashSet&lt;String, ASCIICaseInsensitiveHash&gt; supportedImageMIMETypesForEncoding;</span>
<span class="line-removed">-         CFIndex count = CFArrayGetCount(supportedTypes.get());</span>
<span class="line-removed">-         for (CFIndex i = 0; i &lt; count; i++) {</span>
<span class="line-removed">-             CFStringRef supportedType = reinterpret_cast&lt;CFStringRef&gt;(CFArrayGetValueAtIndex(supportedTypes.get(), i));</span>
<span class="line-removed">-             String mimeType = MIMETypeForImageType(supportedType);</span>
<span class="line-removed">-             if (!mimeType.isEmpty())</span>
<span class="line-removed">-                 supportedImageMIMETypesForEncoding.add(mimeType);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return supportedImageMIMETypesForEncoding;</span>
<span class="line-removed">-     }());</span>
<span class="line-removed">- #else</span>
<span class="line-removed">-     static NeverDestroyed&lt;HashSet&lt;String, ASCIICaseInsensitiveHash&gt;&gt; supportedImageMIMETypesForEncoding =std::initializer_list&lt;String&gt; {</span>
<span class="line-removed">- #if USE(CG) || USE(DIRECT2D)</span>
<span class="line-removed">-         // FIXME: Add Windows support for all the supported UTI&#39;s when a way to convert from MIMEType to UTI reliably is found.</span>
<span class="line-removed">-         // For now, only support PNG, JPEG and GIF. See &lt;rdar://problem/6095286&gt;.</span>
<span class="line-removed">-         &quot;image/png&quot;_s,</span>
<span class="line-removed">-         &quot;image/jpeg&quot;_s,</span>
<span class="line-removed">-         &quot;image/gif&quot;_s,</span>
<span class="line-removed">- #elif PLATFORM(JAVA)</span>
<span class="line-removed">-         &quot;image/png&quot;_s,</span>
<span class="line-removed">-         &quot;image/jpeg&quot;_s,</span>
<span class="line-removed">-         &quot;image/bmp&quot;_s,</span>
<span class="line-removed">- #elif PLATFORM(GTK)</span>
<span class="line-removed">-         &quot;image/png&quot;_s,</span>
<span class="line-removed">-         &quot;image/jpeg&quot;_s,</span>
<span class="line-removed">-         &quot;image/tiff&quot;_s,</span>
<span class="line-removed">-         &quot;image/bmp&quot;_s,</span>
<span class="line-removed">-         &quot;image/ico&quot;_s,</span>
<span class="line-removed">- #elif USE(CAIRO)</span>
<span class="line-removed">-         &quot;image/png&quot;_s,</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-     };</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-     return supportedImageMIMETypesForEncoding;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  static const HashSet&lt;String, ASCIICaseInsensitiveHash&gt;&amp; supportedJavaScriptMIMETypes()
  {
      static NeverDestroyed&lt;HashSet&lt;String, ASCIICaseInsensitiveHash&gt;&gt; supportedJavaScriptMIMETypes = std::initializer_list&lt;String&gt; {
          // https://html.spec.whatwg.org/multipage/scripting.html#javascript-mime-type
          &quot;text/javascript&quot;_s,
<span class="line-new-header">--- 169,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 308,102 ***</span>
  #endif
      };
      return unsupportedTextMIMETypes;
  }
  
<span class="line-modified">! static const Vector&lt;String&gt;* typesForCommonExtension(const String&amp; extension)</span>
<span class="line-modified">! {</span>
<span class="line-modified">!     static const auto map = makeNeverDestroyed([] {</span>
<span class="line-modified">!         struct TypeExtensionPair {</span>
<span class="line-modified">!             ASCIILiteral type;</span>
<span class="line-modified">!             ASCIILiteral extension;</span>
<span class="line-modified">!         };</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // A table of common media MIME types and file extentions used when a platform&#39;s</span>
<span class="line-modified">!         // specific MIME type lookup doesn&#39;t have a match for a media file extension.</span>
<span class="line-modified">!         static const TypeExtensionPair commonMediaTypes[] = {</span>
<span class="line-modified">!             // Ogg</span>
<span class="line-modified">!             { &quot;application/ogg&quot;_s, &quot;ogx&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/ogg&quot;_s, &quot;ogg&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/ogg&quot;_s, &quot;oga&quot;_s },</span>
<span class="line-modified">!             { &quot;video/ogg&quot;_s, &quot;ogv&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // Annodex</span>
<span class="line-modified">!             { &quot;application/annodex&quot;_s, &quot;anx&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/annodex&quot;_s, &quot;axa&quot;_s },</span>
<span class="line-modified">!             { &quot;video/annodex&quot;_s, &quot;axv&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/speex&quot;_s, &quot;spx&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // WebM</span>
<span class="line-modified">!             { &quot;video/webm&quot;_s, &quot;webm&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/webm&quot;_s, &quot;webm&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // MPEG</span>
<span class="line-modified">!             { &quot;audio/mpeg&quot;_s, &quot;m1a&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/mpeg&quot;_s, &quot;m2a&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/mpeg&quot;_s, &quot;m1s&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/mpeg&quot;_s, &quot;mpa&quot;_s },</span>
<span class="line-modified">!             { &quot;video/mpeg&quot;_s, &quot;mpg&quot;_s },</span>
<span class="line-modified">!             { &quot;video/mpeg&quot;_s, &quot;m15&quot;_s },</span>
<span class="line-modified">!             { &quot;video/mpeg&quot;_s, &quot;m1s&quot;_s },</span>
<span class="line-modified">!             { &quot;video/mpeg&quot;_s, &quot;m1v&quot;_s },</span>
<span class="line-modified">!             { &quot;video/mpeg&quot;_s, &quot;m75&quot;_s },</span>
<span class="line-modified">!             { &quot;video/mpeg&quot;_s, &quot;mpa&quot;_s },</span>
<span class="line-modified">!             { &quot;video/mpeg&quot;_s, &quot;mpeg&quot;_s },</span>
<span class="line-modified">!             { &quot;video/mpeg&quot;_s, &quot;mpm&quot;_s },</span>
<span class="line-modified">!             { &quot;video/mpeg&quot;_s, &quot;mpv&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // MPEG playlist</span>
<span class="line-modified">!             { &quot;application/vnd.apple.mpegurl&quot;_s, &quot;m3u8&quot;_s },</span>
<span class="line-modified">!             { &quot;application/mpegurl&quot;_s, &quot;m3u8&quot;_s },</span>
<span class="line-modified">!             { &quot;application/x-mpegurl&quot;_s, &quot;m3u8&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/mpegurl&quot;_s, &quot;m3url&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/x-mpegurl&quot;_s, &quot;m3url&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/mpegurl&quot;_s, &quot;m3u&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/x-mpegurl&quot;_s, &quot;m3u&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // MPEG-4</span>
<span class="line-modified">!             { &quot;video/x-m4v&quot;_s, &quot;m4v&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/x-m4a&quot;_s, &quot;m4a&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/x-m4b&quot;_s, &quot;m4b&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/x-m4p&quot;_s, &quot;m4p&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/mp4&quot;_s, &quot;m4a&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // MP3</span>
<span class="line-modified">!             { &quot;audio/mp3&quot;_s, &quot;mp3&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/x-mp3&quot;_s, &quot;mp3&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/x-mpeg&quot;_s, &quot;mp3&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // MPEG-2</span>
<span class="line-modified">!             { &quot;video/x-mpeg2&quot;_s, &quot;mp2&quot;_s },</span>
<span class="line-modified">!             { &quot;video/mpeg2&quot;_s, &quot;vob&quot;_s },</span>
<span class="line-modified">!             { &quot;video/mpeg2&quot;_s, &quot;mod&quot;_s },</span>
<span class="line-modified">!             { &quot;video/m2ts&quot;_s, &quot;m2ts&quot;_s },</span>
<span class="line-modified">!             { &quot;video/x-m2ts&quot;_s, &quot;m2t&quot;_s },</span>
<span class="line-modified">!             { &quot;video/x-m2ts&quot;_s, &quot;ts&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // 3GP/3GP2</span>
<span class="line-modified">!             { &quot;audio/3gpp&quot;_s, &quot;3gpp&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/3gpp2&quot;_s, &quot;3g2&quot;_s },</span>
<span class="line-modified">!             { &quot;application/x-mpeg&quot;_s, &quot;amc&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // AAC</span>
<span class="line-modified">!             { &quot;audio/aac&quot;_s, &quot;aac&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/aac&quot;_s, &quot;adts&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/x-aac&quot;_s, &quot;m4r&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // CoreAudio File</span>
<span class="line-modified">!             { &quot;audio/x-caf&quot;_s, &quot;caf&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/x-gsm&quot;_s, &quot;gsm&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // ADPCM</span>
<span class="line-modified">!             { &quot;audio/x-wav&quot;_s, &quot;wav&quot;_s },</span>
<span class="line-modified">!             { &quot;audio/vnd.wave&quot;_s, &quot;wav&quot;_s },</span>
<span class="line-modified">!         };</span>
  
          HashMap&lt;String, Vector&lt;String&gt;, ASCIICaseInsensitiveHash&gt; map;
<span class="line-modified">!         for (auto&amp; pair : commonMediaTypes) {</span>
              ASCIILiteral type = pair.type;
              ASCIILiteral extension = pair.extension;
              map.ensure(extension, [type, extension] {
                  // First type in the vector must always be the one from getMIMETypeForExtension,
                  // so we can use the map without also calling getMIMETypeForExtension each time.
<span class="line-new-header">--- 272,108 ---</span>
  #endif
      };
      return unsupportedTextMIMETypes;
  }
  
<span class="line-modified">! Optional&lt;HashMap&lt;String, Vector&lt;String&gt;, ASCIICaseInsensitiveHash&gt;&gt;&amp; overriddenMimeTypesMap()</span>
<span class="line-modified">! {</span>
<span class="line-modified">!     static NeverDestroyed&lt;Optional&lt;HashMap&lt;String, Vector&lt;String&gt;, ASCIICaseInsensitiveHash&gt;&gt;&gt; map;</span>
<span class="line-modified">!     return map;</span>
<span class="line-modified">! }</span>
<span class="line-modified">! </span>
<span class="line-modified">! const std::initializer_list&lt;TypeExtensionPair&gt;&amp; commonMediaTypes()</span>
<span class="line-modified">! {</span>
<span class="line-modified">!     // A table of common media MIME types and file extensions used when a platform&#39;s</span>
<span class="line-modified">!     // specific MIME type lookup doesn&#39;t have a match for a media file extension.</span>
<span class="line-modified">!     static std::initializer_list&lt;TypeExtensionPair&gt; commonMediaTypes = {</span>
<span class="line-modified">!         // Ogg</span>
<span class="line-modified">!         { &quot;application/ogg&quot;_s, &quot;ogx&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/ogg&quot;_s, &quot;ogg&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/ogg&quot;_s, &quot;oga&quot;_s },</span>
<span class="line-modified">!         { &quot;video/ogg&quot;_s, &quot;ogv&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // Annodex</span>
<span class="line-modified">!         { &quot;application/annodex&quot;_s, &quot;anx&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/annodex&quot;_s, &quot;axa&quot;_s },</span>
<span class="line-modified">!         { &quot;video/annodex&quot;_s, &quot;axv&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/speex&quot;_s, &quot;spx&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // WebM</span>
<span class="line-modified">!         { &quot;video/webm&quot;_s, &quot;webm&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/webm&quot;_s, &quot;webm&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // MPEG</span>
<span class="line-modified">!         { &quot;audio/mpeg&quot;_s, &quot;m1a&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/mpeg&quot;_s, &quot;m2a&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/mpeg&quot;_s, &quot;m1s&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/mpeg&quot;_s, &quot;mpa&quot;_s },</span>
<span class="line-modified">!         { &quot;video/mpeg&quot;_s, &quot;mpg&quot;_s },</span>
<span class="line-modified">!         { &quot;video/mpeg&quot;_s, &quot;m15&quot;_s },</span>
<span class="line-modified">!         { &quot;video/mpeg&quot;_s, &quot;m1s&quot;_s },</span>
<span class="line-modified">!         { &quot;video/mpeg&quot;_s, &quot;m1v&quot;_s },</span>
<span class="line-modified">!         { &quot;video/mpeg&quot;_s, &quot;m75&quot;_s },</span>
<span class="line-modified">!         { &quot;video/mpeg&quot;_s, &quot;mpa&quot;_s },</span>
<span class="line-modified">!         { &quot;video/mpeg&quot;_s, &quot;mpeg&quot;_s },</span>
<span class="line-modified">!         { &quot;video/mpeg&quot;_s, &quot;mpm&quot;_s },</span>
<span class="line-modified">!         { &quot;video/mpeg&quot;_s, &quot;mpv&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // MPEG playlist</span>
<span class="line-modified">!         { &quot;application/vnd.apple.mpegurl&quot;_s, &quot;m3u8&quot;_s },</span>
<span class="line-modified">!         { &quot;application/mpegurl&quot;_s, &quot;m3u8&quot;_s },</span>
<span class="line-modified">!         { &quot;application/x-mpegurl&quot;_s, &quot;m3u8&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/mpegurl&quot;_s, &quot;m3url&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/x-mpegurl&quot;_s, &quot;m3url&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/mpegurl&quot;_s, &quot;m3u&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/x-mpegurl&quot;_s, &quot;m3u&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // MPEG-4</span>
<span class="line-modified">!         { &quot;video/x-m4v&quot;_s, &quot;m4v&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/x-m4a&quot;_s, &quot;m4a&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/x-m4b&quot;_s, &quot;m4b&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/x-m4p&quot;_s, &quot;m4p&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/mp4&quot;_s, &quot;m4a&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // MP3</span>
<span class="line-modified">!         { &quot;audio/mp3&quot;_s, &quot;mp3&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/x-mp3&quot;_s, &quot;mp3&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/x-mpeg&quot;_s, &quot;mp3&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // MPEG-2</span>
<span class="line-modified">!         { &quot;video/x-mpeg2&quot;_s, &quot;mp2&quot;_s },</span>
<span class="line-modified">!         { &quot;video/mpeg2&quot;_s, &quot;vob&quot;_s },</span>
<span class="line-modified">!         { &quot;video/mpeg2&quot;_s, &quot;mod&quot;_s },</span>
<span class="line-modified">!         { &quot;video/m2ts&quot;_s, &quot;m2ts&quot;_s },</span>
<span class="line-modified">!         { &quot;video/x-m2ts&quot;_s, &quot;m2t&quot;_s },</span>
<span class="line-modified">!         { &quot;video/x-m2ts&quot;_s, &quot;ts&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // 3GP/3GP2</span>
<span class="line-modified">!         { &quot;audio/3gpp&quot;_s, &quot;3gpp&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/3gpp2&quot;_s, &quot;3g2&quot;_s },</span>
<span class="line-modified">!         { &quot;application/x-mpeg&quot;_s, &quot;amc&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // AAC</span>
<span class="line-modified">!         { &quot;audio/aac&quot;_s, &quot;aac&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/aac&quot;_s, &quot;adts&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/x-aac&quot;_s, &quot;m4r&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // CoreAudio File</span>
<span class="line-modified">!         { &quot;audio/x-caf&quot;_s, &quot;caf&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/x-gsm&quot;_s, &quot;gsm&quot;_s },</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // ADPCM</span>
<span class="line-modified">!         { &quot;audio/x-wav&quot;_s, &quot;wav&quot;_s },</span>
<span class="line-modified">!         { &quot;audio/vnd.wave&quot;_s, &quot;wav&quot;_s },</span>
<span class="line-modified">!     };</span>
<span class="line-added">+     return commonMediaTypes;</span>
<span class="line-added">+ }</span>
  
<span class="line-added">+ const HashMap&lt;String, Vector&lt;String&gt;, ASCIICaseInsensitiveHash&gt;&amp; commonMimeTypesMap()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     ASSERT(isMainThread());</span>
<span class="line-added">+     static NeverDestroyed&lt;HashMap&lt;String, Vector&lt;String&gt;, ASCIICaseInsensitiveHash&gt;&gt; mimeTypesMap = [] {</span>
          HashMap&lt;String, Vector&lt;String&gt;, ASCIICaseInsensitiveHash&gt; map;
<span class="line-modified">!         for (auto&amp; pair : commonMediaTypes()) {</span>
              ASCIILiteral type = pair.type;
              ASCIILiteral extension = pair.extension;
              map.ensure(extension, [type, extension] {
                  // First type in the vector must always be the one from getMIMETypeForExtension,
                  // so we can use the map without also calling getMIMETypeForExtension each time.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 413,13 ***</span>
                      synonyms.append(systemType);
                  return synonyms;
              }).iterator-&gt;value.append(type);
          }
          return map;
<span class="line-modified">!     }());</span>
<span class="line-modified">!     auto mapEntry = map.get().find(extension);</span>
<span class="line-modified">!     if (mapEntry == map.get().end())</span>
          return nullptr;
      return &amp;mapEntry-&gt;value;
  }
  
  String MIMETypeRegistry::getMediaMIMETypeForExtension(const String&amp; extension)
<span class="line-new-header">--- 383,24 ---</span>
                      synonyms.append(systemType);
                  return synonyms;
              }).iterator-&gt;value.append(type);
          }
          return map;
<span class="line-modified">!     }();</span>
<span class="line-modified">!     return mimeTypesMap;</span>
<span class="line-modified">! }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static const Vector&lt;String&gt;* typesForCommonExtension(const String&amp; extension)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (overriddenMimeTypesMap().hasValue()) {</span>
<span class="line-added">+         auto mapEntry = overriddenMimeTypesMap()-&gt;find(extension);</span>
<span class="line-added">+         if (mapEntry == overriddenMimeTypesMap()-&gt;end())</span>
<span class="line-added">+             return nullptr;</span>
<span class="line-added">+         return &amp;mapEntry-&gt;value;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     auto mapEntry = commonMimeTypesMap().find(extension);</span>
<span class="line-added">+     if (mapEntry == commonMimeTypesMap().end())</span>
          return nullptr;
      return &amp;mapEntry-&gt;value;
  }
  
  String MIMETypeRegistry::getMediaMIMETypeForExtension(const String&amp; extension)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 465,24 ***</span>
  {
      if (isSupportedImageMIMEType(mimeType) || equalLettersIgnoringASCIICase(mimeType, &quot;image/svg+xml&quot;))
          return true;
  
  #if HAVE(AVASSETREADER)
<span class="line-modified">!     if (ImageDecoderAVFObjC::supportsContentType(ContentType(mimeType)))</span>
          return true;
  #endif
  
      return false;
  }
  
<span class="line-modified">! bool MIMETypeRegistry::isSupportedImageMIMETypeForEncoding(const String&amp; mimeType)</span>
  {
<span class="line-modified">!     ASSERT(isMainThread());</span>
  
      if (mimeType.isEmpty())
          return false;
<span class="line-modified">!     return supportedImageMIMETypesForEncoding().contains(mimeType);</span>
  }
  
  bool MIMETypeRegistry::isSupportedJavaScriptMIMEType(const String&amp; mimeType)
  {
      if (mimeType.isEmpty())
<span class="line-new-header">--- 446,61 ---</span>
  {
      if (isSupportedImageMIMEType(mimeType) || equalLettersIgnoringASCIICase(mimeType, &quot;image/svg+xml&quot;))
          return true;
  
  #if HAVE(AVASSETREADER)
<span class="line-modified">!     if (ImageDecoderAVFObjC::supportsContainerType(mimeType))</span>
          return true;
  #endif
  
      return false;
  }
  
<span class="line-modified">! std::unique_ptr&lt;MIMETypeRegistryThreadGlobalData&gt; MIMETypeRegistry::createMIMETypeRegistryThreadGlobalData()</span>
  {
<span class="line-modified">! #if PLATFORM(COCOA)</span>
<span class="line-added">+     RetainPtr&lt;CFArrayRef&gt; supportedTypes = adoptCF(CGImageDestinationCopyTypeIdentifiers());</span>
<span class="line-added">+     HashSet&lt;String, ASCIICaseInsensitiveHash&gt; supportedImageMIMETypesForEncoding;</span>
<span class="line-added">+     CFIndex count = CFArrayGetCount(supportedTypes.get());</span>
<span class="line-added">+     for (CFIndex i = 0; i &lt; count; i++) {</span>
<span class="line-added">+         CFStringRef supportedType = reinterpret_cast&lt;CFStringRef&gt;(CFArrayGetValueAtIndex(supportedTypes.get(), i));</span>
<span class="line-added">+         if (isSupportedImageType(supportedType)) {</span>
<span class="line-added">+             String mimeType = MIMETypeForImageType(supportedType);</span>
<span class="line-added">+             supportedImageMIMETypesForEncoding.add(mimeType);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     HashSet&lt;String, ASCIICaseInsensitiveHash&gt; supportedImageMIMETypesForEncoding = std::initializer_list&lt;String&gt; {</span>
<span class="line-added">+ #if USE(CG) || USE(DIRECT2D)</span>
<span class="line-added">+         // FIXME: Add Windows support for all the supported UTI&#39;s when a way to convert from MIMEType to UTI reliably is found.</span>
<span class="line-added">+         // For now, only support PNG, JPEG and GIF. See &lt;rdar://problem/6095286&gt;.</span>
<span class="line-added">+         &quot;image/png&quot;_s,</span>
<span class="line-added">+         &quot;image/jpeg&quot;_s,</span>
<span class="line-added">+         &quot;image/gif&quot;_s,</span>
<span class="line-added">+ #elif PLATFORM(JAVA)</span>
<span class="line-added">+         &quot;image/png&quot;_s,</span>
<span class="line-added">+         &quot;image/jpeg&quot;_s,</span>
<span class="line-added">+         &quot;image/bmp&quot;_s,</span>
<span class="line-added">+ #elif PLATFORM(GTK)</span>
<span class="line-added">+         &quot;image/png&quot;_s,</span>
<span class="line-added">+         &quot;image/jpeg&quot;_s,</span>
<span class="line-added">+         &quot;image/tiff&quot;_s,</span>
<span class="line-added">+         &quot;image/bmp&quot;_s,</span>
<span class="line-added">+         &quot;image/ico&quot;_s,</span>
<span class="line-added">+ #elif USE(CAIRO)</span>
<span class="line-added">+         &quot;image/png&quot;_s,</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+     };</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+     return makeUnique&lt;MIMETypeRegistryThreadGlobalData&gt;(WTFMove(supportedImageMIMETypesForEncoding));</span>
<span class="line-added">+ }</span>
  
<span class="line-added">+ bool MIMETypeRegistry::isSupportedImageMIMETypeForEncoding(const String&amp; mimeType)</span>
<span class="line-added">+ {</span>
      if (mimeType.isEmpty())
          return false;
<span class="line-modified">!     return threadGlobalData().mimeTypeRegistryThreadGlobalData().supportedImageMIMETypesForEncoding().contains(mimeType);</span>
  }
  
  bool MIMETypeRegistry::isSupportedJavaScriptMIMEType(const String&amp; mimeType)
  {
      if (mimeType.isEmpty())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 774,16 ***</span>
  String MIMETypeRegistry::appendFileExtensionIfNecessary(const String&amp; filename, const String&amp; mimeType)
  {
      if (filename.isEmpty())
          return emptyString();
  
      if (filename.reverseFind(&#39;.&#39;) != notFound)
          return filename;
  
      String preferredExtension = getPreferredExtensionForMIMEType(mimeType);
      if (preferredExtension.isEmpty())
          return filename;
  
<span class="line-modified">!     return filename + &quot;.&quot; + preferredExtension;</span>
  }
  
  } // namespace WebCore
<span class="line-new-header">--- 792,19 ---</span>
  String MIMETypeRegistry::appendFileExtensionIfNecessary(const String&amp; filename, const String&amp; mimeType)
  {
      if (filename.isEmpty())
          return emptyString();
  
<span class="line-added">+     if (equalIgnoringASCIICase(mimeType, defaultMIMEType()))</span>
<span class="line-added">+         return filename;</span>
<span class="line-added">+ </span>
      if (filename.reverseFind(&#39;.&#39;) != notFound)
          return filename;
  
      String preferredExtension = getPreferredExtensionForMIMEType(mimeType);
      if (preferredExtension.isEmpty())
          return filename;
  
<span class="line-modified">!     return makeString(filename, &#39;.&#39;, preferredExtension);</span>
  }
  
  } // namespace WebCore
</pre>
<center><a href="Logging.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MIMETypeRegistry.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>