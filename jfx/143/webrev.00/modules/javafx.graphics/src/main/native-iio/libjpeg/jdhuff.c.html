<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.graphics/src/main/native-iio/libjpeg/jdhuff.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * jdhuff.c
   3  *
   4  * Copyright (C) 1991-1997, Thomas G. Lane.
   5  * Modified 2006-2019 by Guido Vollbeding.
   6  * This file is part of the Independent JPEG Group&#39;s software.
   7  * For conditions of distribution and use, see the accompanying README file.
   8  *
   9  * This file contains Huffman entropy decoding routines.
  10  * Both sequential and progressive modes are supported in this single module.
  11  *
  12  * Much of the complexity here has to do with supporting input suspension.
  13  * If the data source module demands suspension, we want to be able to back
  14  * up to the start of the current MCU.  To do this, we copy state variables
  15  * into local working storage, and update them back to the permanent
  16  * storage only upon successful completion of an MCU.
  17  */
  18 
  19 #define JPEG_INTERNALS
  20 #include &quot;jinclude.h&quot;
  21 #include &quot;jpeglib.h&quot;
  22 
  23 
  24 /* Derived data constructed for each Huffman table */
  25 
  26 #define HUFF_LOOKAHEAD    8    /* # of bits of lookahead */
  27 
  28 typedef struct {
  29   /* Basic tables: (element [0] of each array is unused) */
  30   INT32 maxcode[18];        /* largest code of length k (-1 if none) */
  31   /* (maxcode[17] is a sentinel to ensure jpeg_huff_decode terminates) */
  32   INT32 valoffset[17];        /* huffval[] offset for codes of length k */
  33   /* valoffset[k] = huffval[] index of 1st symbol of code length k, less
  34    * the smallest code of length k; so given a code of length k, the
  35    * corresponding symbol is huffval[code + valoffset[k]]
  36    */
  37 
  38   /* Link to public Huffman table (needed only in jpeg_huff_decode) */
  39   JHUFF_TBL *pub;
  40 
  41   /* Lookahead tables: indexed by the next HUFF_LOOKAHEAD bits of
  42    * the input data stream.  If the next Huffman code is no more
  43    * than HUFF_LOOKAHEAD bits long, we can obtain its length and
  44    * the corresponding symbol directly from these tables.
  45    */
  46   int look_nbits[1&lt;&lt;HUFF_LOOKAHEAD]; /* # bits, or 0 if too long */
  47   UINT8 look_sym[1&lt;&lt;HUFF_LOOKAHEAD]; /* symbol, or unused */
  48 } d_derived_tbl;
  49 
  50 
  51 /*
  52  * Fetching the next N bits from the input stream is a time-critical operation
  53  * for the Huffman decoders.  We implement it with a combination of inline
  54  * macros and out-of-line subroutines.  Note that N (the number of bits
  55  * demanded at one time) never exceeds 15 for JPEG use.
  56  *
  57  * We read source bytes into get_buffer and dole out bits as needed.
  58  * If get_buffer already contains enough bits, they are fetched in-line
  59  * by the macros CHECK_BIT_BUFFER and GET_BITS.  When there aren&#39;t enough
  60  * bits, jpeg_fill_bit_buffer is called; it will attempt to fill get_buffer
  61  * as full as possible (not just to the number of bits needed; this
  62  * prefetching reduces the overhead cost of calling jpeg_fill_bit_buffer).
  63  * Note that jpeg_fill_bit_buffer may return FALSE to indicate suspension.
  64  * On TRUE return, jpeg_fill_bit_buffer guarantees that get_buffer contains
  65  * at least the requested number of bits --- dummy zeroes are inserted if
  66  * necessary.
  67  */
  68 
  69 typedef INT32 bit_buf_type;    /* type of bit-extraction buffer */
  70 #define BIT_BUF_SIZE  32    /* size of buffer in bits */
  71 
  72 /* If long is &gt; 32 bits on your machine, and shifting/masking longs is
  73  * reasonably fast, making bit_buf_type be long and setting BIT_BUF_SIZE
  74  * appropriately should be a win.  Unfortunately we can&#39;t define the size
  75  * with something like  #define BIT_BUF_SIZE (sizeof(bit_buf_type)*8)
  76  * because not all machines measure sizeof in 8-bit bytes.
  77  */
  78 
  79 typedef struct {        /* Bitreading state saved across MCUs */
  80   bit_buf_type get_buffer;    /* current bit-extraction buffer */
  81   int bits_left;        /* # of unused bits in it */
  82 } bitread_perm_state;
  83 
  84 typedef struct {        /* Bitreading working state within an MCU */
  85   /* Current data source location */
  86   /* We need a copy, rather than munging the original, in case of suspension */
  87   const JOCTET * next_input_byte; /* =&gt; next byte to read from source */
  88   size_t bytes_in_buffer;    /* # of bytes remaining in source buffer */
  89   /* Bit input buffer --- note these values are kept in register variables,
  90    * not in this struct, inside the inner loops.
  91    */
  92   bit_buf_type get_buffer;    /* current bit-extraction buffer */
  93   int bits_left;        /* # of unused bits in it */
  94   /* Pointer needed by jpeg_fill_bit_buffer. */
  95   j_decompress_ptr cinfo;    /* back link to decompress master record */
  96 } bitread_working_state;
  97 
  98 /* Macros to declare and load/save bitread local variables. */
  99 #define BITREAD_STATE_VARS  \
 100     register bit_buf_type get_buffer;  \
 101     register int bits_left;  \
 102     bitread_working_state br_state
 103 
 104 #define BITREAD_LOAD_STATE(cinfop,permstate)  \
 105     br_state.cinfo = cinfop; \
 106     br_state.next_input_byte = cinfop-&gt;src-&gt;next_input_byte; \
 107     br_state.bytes_in_buffer = cinfop-&gt;src-&gt;bytes_in_buffer; \
 108     get_buffer = permstate.get_buffer; \
 109     bits_left = permstate.bits_left;
 110 
 111 #define BITREAD_SAVE_STATE(cinfop,permstate)  \
 112     cinfop-&gt;src-&gt;next_input_byte = br_state.next_input_byte; \
 113     cinfop-&gt;src-&gt;bytes_in_buffer = br_state.bytes_in_buffer; \
 114     permstate.get_buffer = get_buffer; \
 115     permstate.bits_left = bits_left
 116 
 117 /*
 118  * These macros provide the in-line portion of bit fetching.
 119  * Use CHECK_BIT_BUFFER to ensure there are N bits in get_buffer
 120  * before using GET_BITS, PEEK_BITS, or DROP_BITS.
 121  * The variables get_buffer and bits_left are assumed to be locals,
 122  * but the state struct might not be (jpeg_huff_decode needs this).
 123  *    CHECK_BIT_BUFFER(state,n,action);
 124  *        Ensure there are N bits in get_buffer; if suspend, take action.
 125  *      val = GET_BITS(n);
 126  *        Fetch next N bits.
 127  *      val = PEEK_BITS(n);
 128  *        Fetch next N bits without removing them from the buffer.
 129  *    DROP_BITS(n);
 130  *        Discard next N bits.
 131  * The value N should be a simple variable, not an expression, because it
 132  * is evaluated multiple times.
 133  */
 134 
 135 #define CHECK_BIT_BUFFER(state,nbits,action) \
 136     { if (bits_left &lt; (nbits)) {  \
 137         if (! jpeg_fill_bit_buffer(&amp;(state),get_buffer,bits_left,nbits))  \
 138           { action; }  \
 139         get_buffer = (state).get_buffer; bits_left = (state).bits_left; } }
 140 
 141 #define GET_BITS(nbits) \
 142     (((int) (get_buffer &gt;&gt; (bits_left -= (nbits)))) &amp; BIT_MASK(nbits))
 143 
 144 #define PEEK_BITS(nbits) \
 145     (((int) (get_buffer &gt;&gt; (bits_left -  (nbits)))) &amp; BIT_MASK(nbits))
 146 
 147 #define DROP_BITS(nbits) \
 148     (bits_left -= (nbits))
 149 
 150 
 151 /*
 152  * Code for extracting next Huffman-coded symbol from input bit stream.
 153  * Again, this is time-critical and we make the main paths be macros.
 154  *
 155  * We use a lookahead table to process codes of up to HUFF_LOOKAHEAD bits
 156  * without looping.  Usually, more than 95% of the Huffman codes will be 8
 157  * or fewer bits long.  The few overlength codes are handled with a loop,
 158  * which need not be inline code.
 159  *
 160  * Notes about the HUFF_DECODE macro:
 161  * 1. Near the end of the data segment, we may fail to get enough bits
 162  *    for a lookahead.  In that case, we do it the hard way.
 163  * 2. If the lookahead table contains no entry, the next code must be
 164  *    more than HUFF_LOOKAHEAD bits long.
 165  * 3. jpeg_huff_decode returns -1 if forced to suspend.
 166  */
 167 
 168 #define HUFF_DECODE(result,state,htbl,failaction,slowlabel) \
 169 { register int nb, look; \
 170   if (bits_left &lt; HUFF_LOOKAHEAD) { \
 171     if (! jpeg_fill_bit_buffer(&amp;state,get_buffer,bits_left, 0)) {failaction;} \
 172     get_buffer = state.get_buffer; bits_left = state.bits_left; \
 173     if (bits_left &lt; HUFF_LOOKAHEAD) { \
 174       nb = 1; goto slowlabel; \
 175     } \
 176   } \
 177   look = PEEK_BITS(HUFF_LOOKAHEAD); \
 178   if ((nb = htbl-&gt;look_nbits[look]) != 0) { \
 179     DROP_BITS(nb); \
 180     result = htbl-&gt;look_sym[look]; \
 181   } else { \
 182     nb = HUFF_LOOKAHEAD+1; \
 183 slowlabel: \
 184     if ((result=jpeg_huff_decode(&amp;state,get_buffer,bits_left,htbl,nb)) &lt; 0) \
 185     { failaction; } \
 186     get_buffer = state.get_buffer; bits_left = state.bits_left; \
 187   } \
 188 }
 189 
 190 
 191 /*
 192  * Expanded entropy decoder object for Huffman decoding.
 193  *
 194  * The savable_state subrecord contains fields that change within an MCU,
 195  * but must not be updated permanently until we complete the MCU.
 196  */
 197 
 198 typedef struct {
 199   unsigned int EOBRUN;            /* remaining EOBs in EOBRUN */
 200   int last_dc_val[MAX_COMPS_IN_SCAN];    /* last DC coef for each component */
 201 } savable_state;
 202 
 203 /* This macro is to work around compilers with missing or broken
 204  * structure assignment.  You&#39;ll need to fix this code if you have
 205  * such a compiler and you change MAX_COMPS_IN_SCAN.
 206  */
 207 
 208 #ifndef NO_STRUCT_ASSIGN
 209 #define ASSIGN_STATE(dest,src)  ((dest) = (src))
 210 #else
 211 #if MAX_COMPS_IN_SCAN == 4
 212 #define ASSIGN_STATE(dest,src)  \
 213     ((dest).EOBRUN = (src).EOBRUN, \
 214      (dest).last_dc_val[0] = (src).last_dc_val[0], \
 215      (dest).last_dc_val[1] = (src).last_dc_val[1], \
 216      (dest).last_dc_val[2] = (src).last_dc_val[2], \
 217      (dest).last_dc_val[3] = (src).last_dc_val[3])
 218 #endif
 219 #endif
 220 
 221 
 222 typedef struct {
 223   struct jpeg_entropy_decoder pub; /* public fields */
 224 
 225   /* These fields are loaded into local variables at start of each MCU.
 226    * In case of suspension, we exit WITHOUT updating them.
 227    */
 228   bitread_perm_state bitstate;    /* Bit buffer at start of MCU */
 229   savable_state saved;        /* Other state at start of MCU */
 230 
 231   /* These fields are NOT loaded into local working state. */
 232   boolean insufficient_data;    /* set TRUE after emitting warning */
 233   unsigned int restarts_to_go;    /* MCUs left in this restart interval */
 234 
 235   /* Following two fields used only in progressive mode */
 236 
 237   /* Pointers to derived tables (these workspaces have image lifespan) */
 238   d_derived_tbl * derived_tbls[NUM_HUFF_TBLS];
 239 
 240   d_derived_tbl * ac_derived_tbl; /* active table during an AC scan */
 241 
 242   /* Following fields used only in sequential mode */
 243 
 244   /* Pointers to derived tables (these workspaces have image lifespan) */
 245   d_derived_tbl * dc_derived_tbls[NUM_HUFF_TBLS];
 246   d_derived_tbl * ac_derived_tbls[NUM_HUFF_TBLS];
 247 
 248   /* Precalculated info set up by start_pass for use in decode_mcu: */
 249 
 250   /* Pointers to derived tables to be used for each block within an MCU */
 251   d_derived_tbl * dc_cur_tbls[D_MAX_BLOCKS_IN_MCU];
 252   d_derived_tbl * ac_cur_tbls[D_MAX_BLOCKS_IN_MCU];
 253   /* Whether we care about the DC and AC coefficient values for each block */
 254   int coef_limit[D_MAX_BLOCKS_IN_MCU];
 255 } huff_entropy_decoder;
 256 
 257 typedef huff_entropy_decoder * huff_entropy_ptr;
 258 
 259 
 260 static const int jpeg_zigzag_order[8][8] = {
 261   {  0,  1,  5,  6, 14, 15, 27, 28 },
 262   {  2,  4,  7, 13, 16, 26, 29, 42 },
 263   {  3,  8, 12, 17, 25, 30, 41, 43 },
 264   {  9, 11, 18, 24, 31, 40, 44, 53 },
 265   { 10, 19, 23, 32, 39, 45, 52, 54 },
 266   { 20, 22, 33, 38, 46, 51, 55, 60 },
 267   { 21, 34, 37, 47, 50, 56, 59, 61 },
 268   { 35, 36, 48, 49, 57, 58, 62, 63 }
 269 };
 270 
 271 static const int jpeg_zigzag_order7[7][7] = {
 272   {  0,  1,  5,  6, 14, 15, 27 },
 273   {  2,  4,  7, 13, 16, 26, 28 },
 274   {  3,  8, 12, 17, 25, 29, 38 },
 275   {  9, 11, 18, 24, 30, 37, 39 },
 276   { 10, 19, 23, 31, 36, 40, 45 },
 277   { 20, 22, 32, 35, 41, 44, 46 },
 278   { 21, 33, 34, 42, 43, 47, 48 }
 279 };
 280 
 281 static const int jpeg_zigzag_order6[6][6] = {
 282   {  0,  1,  5,  6, 14, 15 },
 283   {  2,  4,  7, 13, 16, 25 },
 284   {  3,  8, 12, 17, 24, 26 },
 285   {  9, 11, 18, 23, 27, 32 },
 286   { 10, 19, 22, 28, 31, 33 },
 287   { 20, 21, 29, 30, 34, 35 }
 288 };
 289 
 290 static const int jpeg_zigzag_order5[5][5] = {
 291   {  0,  1,  5,  6, 14 },
 292   {  2,  4,  7, 13, 15 },
 293   {  3,  8, 12, 16, 21 },
 294   {  9, 11, 17, 20, 22 },
 295   { 10, 18, 19, 23, 24 }
 296 };
 297 
 298 static const int jpeg_zigzag_order4[4][4] = {
 299   { 0,  1,  5,  6 },
 300   { 2,  4,  7, 12 },
 301   { 3,  8, 11, 13 },
 302   { 9, 10, 14, 15 }
 303 };
 304 
 305 static const int jpeg_zigzag_order3[3][3] = {
 306   { 0, 1, 5 },
 307   { 2, 4, 6 },
 308   { 3, 7, 8 }
 309 };
 310 
 311 static const int jpeg_zigzag_order2[2][2] = {
 312   { 0, 1 },
 313   { 2, 3 }
 314 };
 315 
 316 
 317 /*
 318  * Compute the derived values for a Huffman table.
 319  * This routine also performs some validation checks on the table.
 320  */
 321 
 322 LOCAL(void)
 323 jpeg_make_d_derived_tbl (j_decompress_ptr cinfo, boolean isDC, int tblno,
 324              d_derived_tbl ** pdtbl)
 325 {
 326   JHUFF_TBL *htbl;
 327   d_derived_tbl *dtbl;
 328   int p, i, l, si, numsymbols;
 329   int lookbits, ctr;
 330   char huffsize[257];
 331   unsigned int huffcode[257];
 332   unsigned int code;
 333 
 334   MEMZERO(huffsize, SIZEOF(huffsize));
 335   MEMZERO(huffcode, SIZEOF(huffcode));
 336   /* Note that huffsize[] and huffcode[] are filled in code-length order,
 337    * paralleling the order of the symbols themselves in htbl-&gt;huffval[].
 338    */
 339 
 340   /* Find the input Huffman table */
 341   if (tblno &lt; 0 || tblno &gt;= NUM_HUFF_TBLS)
 342     ERREXIT1(cinfo, JERR_NO_HUFF_TABLE, tblno);
 343   htbl =
 344     isDC ? cinfo-&gt;dc_huff_tbl_ptrs[tblno] : cinfo-&gt;ac_huff_tbl_ptrs[tblno];
 345   if (htbl == NULL)
 346     htbl = jpeg_std_huff_table((j_common_ptr) cinfo, isDC, tblno);
 347 
 348   /* Allocate a workspace if we haven&#39;t already done so. */
 349   if (*pdtbl == NULL)
 350     *pdtbl = (d_derived_tbl *) (*cinfo-&gt;mem-&gt;alloc_small)
 351       ((j_common_ptr) cinfo, JPOOL_IMAGE, SIZEOF(d_derived_tbl));
 352   dtbl = *pdtbl;
 353   dtbl-&gt;pub = htbl;        /* fill in back link */
 354 
 355   /* Figure C.1: make table of Huffman code length for each symbol */
 356 
 357   p = 0;
 358   for (l = 1; l &lt;= 16; l++) {
 359     i = (int) htbl-&gt;bits[l];
 360     if (i &lt; 0 || p + i &gt; 256)    /* protect against table overrun */
 361       ERREXIT(cinfo, JERR_BAD_HUFF_TABLE);
 362     while (i--)
 363       huffsize[p++] = (char) l;
 364   }
 365   huffsize[p] = 0;
 366   numsymbols = p;
 367 
 368   /* Figure C.2: generate the codes themselves */
 369   /* We also validate that the counts represent a legal Huffman code tree. */
 370 
 371   code = 0;
 372   si = huffsize[0];
 373   p = 0;
 374   while (huffsize[p]) {
 375     while (((int) huffsize[p]) == si) {
 376       huffcode[p++] = code;
 377       code++;
 378     }
 379     /* code is now 1 more than the last code used for codelength si; but
 380      * it must still fit in si bits, since no code is allowed to be all ones.
 381      */
 382     if (((INT32) code) &gt;= (((INT32) 1) &lt;&lt; si))
 383       ERREXIT(cinfo, JERR_BAD_HUFF_TABLE);
 384     code &lt;&lt;= 1;
 385     si++;
 386   }
 387 
 388   /* Figure F.15: generate decoding tables for bit-sequential decoding */
 389 
 390   p = 0;
 391   for (l = 1; l &lt;= 16; l++) {
 392     if (htbl-&gt;bits[l]) {
 393       /* valoffset[l] = huffval[] index of 1st symbol of code length l,
 394        * minus the minimum code of length l
 395        */
 396       dtbl-&gt;valoffset[l] = (INT32) p - (INT32) huffcode[p];
 397       p += htbl-&gt;bits[l];
 398       dtbl-&gt;maxcode[l] = huffcode[p-1]; /* maximum code of length l */
 399     } else {
 400       dtbl-&gt;maxcode[l] = -1;    /* -1 if no codes of this length */
 401     }
 402   }
 403   dtbl-&gt;maxcode[17] = 0xFFFFFL; /* ensures jpeg_huff_decode terminates */
 404 
 405   /* Compute lookahead tables to speed up decoding.
 406    * First we set all the table entries to 0, indicating &quot;too long&quot;;
 407    * then we iterate through the Huffman codes that are short enough and
 408    * fill in all the entries that correspond to bit sequences starting
 409    * with that code.
 410    */
 411 
 412   MEMZERO(dtbl-&gt;look_nbits, SIZEOF(dtbl-&gt;look_nbits));
 413 
 414   p = 0;
 415   for (l = 1; l &lt;= HUFF_LOOKAHEAD; l++) {
 416     for (i = 1; i &lt;= (int) htbl-&gt;bits[l]; i++, p++) {
 417       /* l = current code&#39;s length, p = its index in huffcode[] &amp; huffval[]. */
 418       /* Generate left-justified code followed by all possible bit sequences */
 419       lookbits = huffcode[p] &lt;&lt; (HUFF_LOOKAHEAD-l);
 420       for (ctr = 1 &lt;&lt; (HUFF_LOOKAHEAD-l); ctr &gt; 0; ctr--) {
 421     dtbl-&gt;look_nbits[lookbits] = l;
 422     dtbl-&gt;look_sym[lookbits] = htbl-&gt;huffval[p];
 423     lookbits++;
 424       }
 425     }
 426   }
 427 
 428   /* Validate symbols as being reasonable.
 429    * For AC tables, we make no check, but accept all byte values 0..255.
 430    * For DC tables, we require the symbols to be in range 0..15.
 431    * (Tighter bounds could be applied depending on the data depth and mode,
 432    * but this is sufficient to ensure safe decoding.)
 433    */
 434   if (isDC) {
 435     for (i = 0; i &lt; numsymbols; i++) {
 436       int sym = htbl-&gt;huffval[i];
 437       if (sym &lt; 0 || sym &gt; 15)
 438     ERREXIT(cinfo, JERR_BAD_HUFF_TABLE);
 439     }
 440   }
 441 }
 442 
 443 
 444 /*
 445  * Out-of-line code for bit fetching.
 446  * Note: current values of get_buffer and bits_left are passed as parameters,
 447  * but are returned in the corresponding fields of the state struct.
 448  *
 449  * On most machines MIN_GET_BITS should be 25 to allow the full 32-bit width
 450  * of get_buffer to be used.  (On machines with wider words, an even larger
 451  * buffer could be used.)  However, on some machines 32-bit shifts are
 452  * quite slow and take time proportional to the number of places shifted.
 453  * (This is true with most PC compilers, for instance.)  In this case it may
 454  * be a win to set MIN_GET_BITS to the minimum value of 15.  This reduces the
 455  * average shift distance at the cost of more calls to jpeg_fill_bit_buffer.
 456  */
 457 
 458 #ifdef SLOW_SHIFT_32
 459 #define MIN_GET_BITS  15    /* minimum allowable value */
 460 #else
 461 #define MIN_GET_BITS  (BIT_BUF_SIZE-7)
 462 #endif
 463 
 464 
 465 LOCAL(boolean)
 466 jpeg_fill_bit_buffer (bitread_working_state * state,
 467               register bit_buf_type get_buffer, register int bits_left,
 468               int nbits)
 469 /* Load up the bit buffer to a depth of at least nbits */
 470 {
 471   /* Copy heavily used state fields into locals (hopefully registers) */
 472   register const JOCTET * next_input_byte = state-&gt;next_input_byte;
 473   register size_t bytes_in_buffer = state-&gt;bytes_in_buffer;
 474   j_decompress_ptr cinfo = state-&gt;cinfo;
 475 
 476   /* Attempt to load at least MIN_GET_BITS bits into get_buffer. */
 477   /* (It is assumed that no request will be for more than that many bits.) */
 478   /* We fail to do so only if we hit a marker or are forced to suspend. */
 479 
 480   if (cinfo-&gt;unread_marker == 0) {    /* cannot advance past a marker */
 481     while (bits_left &lt; MIN_GET_BITS) {
 482       register int c;
 483 
 484       /* Attempt to read a byte */
 485       if (bytes_in_buffer == 0) {
 486     if (! (*cinfo-&gt;src-&gt;fill_input_buffer) (cinfo))
 487       return FALSE;
 488     next_input_byte = cinfo-&gt;src-&gt;next_input_byte;
 489     bytes_in_buffer = cinfo-&gt;src-&gt;bytes_in_buffer;
 490       }
 491       bytes_in_buffer--;
 492       c = GETJOCTET(*next_input_byte++);
 493 
 494       /* If it&#39;s 0xFF, check and discard stuffed zero byte */
 495       if (c == 0xFF) {
 496     /* Loop here to discard any padding FF&#39;s on terminating marker,
 497      * so that we can save a valid unread_marker value.  NOTE: we will
 498      * accept multiple FF&#39;s followed by a 0 as meaning a single FF data
 499      * byte.  This data pattern is not valid according to the standard.
 500      */
 501     do {
 502       if (bytes_in_buffer == 0) {
 503         if (! (*cinfo-&gt;src-&gt;fill_input_buffer) (cinfo))
 504           return FALSE;
 505         next_input_byte = cinfo-&gt;src-&gt;next_input_byte;
 506         bytes_in_buffer = cinfo-&gt;src-&gt;bytes_in_buffer;
 507       }
 508       bytes_in_buffer--;
 509       c = GETJOCTET(*next_input_byte++);
 510     } while (c == 0xFF);
 511 
 512     if (c == 0) {
 513       /* Found FF/00, which represents an FF data byte */
 514       c = 0xFF;
 515     } else {
 516       /* Oops, it&#39;s actually a marker indicating end of compressed data.
 517        * Save the marker code for later use.
 518        * Fine point: it might appear that we should save the marker into
 519        * bitread working state, not straight into permanent state.  But
 520        * once we have hit a marker, we cannot need to suspend within the
 521        * current MCU, because we will read no more bytes from the data
 522        * source.  So it is OK to update permanent state right away.
 523        */
 524       cinfo-&gt;unread_marker = c;
 525       /* See if we need to insert some fake zero bits. */
 526       goto no_more_bytes;
 527     }
 528       }
 529 
 530       /* OK, load c into get_buffer */
 531       get_buffer = (get_buffer &lt;&lt; 8) | c;
 532       bits_left += 8;
 533     } /* end while */
 534   } else {
 535   no_more_bytes:
 536     /* We get here if we&#39;ve read the marker that terminates the compressed
 537      * data segment.  There should be enough bits in the buffer register
 538      * to satisfy the request; if so, no problem.
 539      */
 540     if (nbits &gt; bits_left) {
 541       /* Uh-oh.  Report corrupted data to user and stuff zeroes into
 542        * the data stream, so that we can produce some kind of image.
 543        * We use a nonvolatile flag to ensure that only one warning message
 544        * appears per data segment.
 545        */
 546       if (! ((huff_entropy_ptr) cinfo-&gt;entropy)-&gt;insufficient_data) {
 547     WARNMS(cinfo, JWRN_HIT_MARKER);
 548     ((huff_entropy_ptr) cinfo-&gt;entropy)-&gt;insufficient_data = TRUE;
 549       }
 550       /* Fill the buffer with zero bits */
 551       get_buffer &lt;&lt;= MIN_GET_BITS - bits_left;
 552       bits_left = MIN_GET_BITS;
 553     }
 554   }
 555 
 556   /* Unload the local registers */
 557   state-&gt;next_input_byte = next_input_byte;
 558   state-&gt;bytes_in_buffer = bytes_in_buffer;
 559   state-&gt;get_buffer = get_buffer;
 560   state-&gt;bits_left = bits_left;
 561 
 562   return TRUE;
 563 }
 564 
 565 
 566 /*
 567  * Figure F.12: extend sign bit.
 568  * On some machines, a shift and sub will be faster than a table lookup.
 569  */
 570 
 571 #ifdef AVOID_TABLES
 572 
 573 #define BIT_MASK(nbits)   ((1&lt;&lt;(nbits))-1)
 574 #define HUFF_EXTEND(x,s)  ((x) &lt; (1&lt;&lt;((s)-1)) ? (x) - ((1&lt;&lt;(s))-1) : (x))
 575 
 576 #else
 577 
 578 #define BIT_MASK(nbits)   bmask[nbits]
 579 #define HUFF_EXTEND(x,s)  ((x) &lt;= bmask[(s) - 1] ? (x) - bmask[s] : (x))
 580 
 581 static const int bmask[16] =    /* bmask[n] is mask for n rightmost bits */
 582   { 0, 0x0001, 0x0003, 0x0007, 0x000F, 0x001F, 0x003F, 0x007F, 0x00FF,
 583     0x01FF, 0x03FF, 0x07FF, 0x0FFF, 0x1FFF, 0x3FFF, 0x7FFF };
 584 
 585 #endif /* AVOID_TABLES */
 586 
 587 
 588 /*
 589  * Out-of-line code for Huffman code decoding.
 590  */
 591 
 592 LOCAL(int)
 593 jpeg_huff_decode (bitread_working_state * state,
 594           register bit_buf_type get_buffer, register int bits_left,
 595           d_derived_tbl * htbl, int min_bits)
 596 {
 597   register int l = min_bits;
 598   register INT32 code;
 599 
 600   /* HUFF_DECODE has determined that the code is at least min_bits */
 601   /* bits long, so fetch that many bits in one swoop. */
 602 
 603   CHECK_BIT_BUFFER(*state, l, return -1);
 604   code = GET_BITS(l);
 605 
 606   /* Collect the rest of the Huffman code one bit at a time. */
 607   /* This is per Figure F.16 in the JPEG spec. */
 608 
 609   while (code &gt; htbl-&gt;maxcode[l]) {
 610     code &lt;&lt;= 1;
 611     CHECK_BIT_BUFFER(*state, 1, return -1);
 612     code |= GET_BITS(1);
 613     l++;
 614   }
 615 
 616   /* Unload the local registers */
 617   state-&gt;get_buffer = get_buffer;
 618   state-&gt;bits_left = bits_left;
 619 
 620   /* With garbage input we may reach the sentinel value l = 17. */
 621 
 622   if (l &gt; 16) {
 623     int br_offset = state-&gt;next_input_byte - state-&gt;cinfo-&gt;src-&gt;next_input_byte;
 624     WARNMS(state-&gt;cinfo, JWRN_HUFF_BAD_CODE);
 625     state-&gt;next_input_byte = state-&gt;cinfo-&gt;src-&gt;next_input_byte + br_offset;
 626     return 0;            /* fake a zero as the safest result */
 627   }
 628 
 629   return htbl-&gt;pub-&gt;huffval[ (int) (code + htbl-&gt;valoffset[l]) ];
 630 }
 631 
 632 
 633 /*
 634  * Finish up at the end of a Huffman-compressed scan.
 635  */
 636 
 637 METHODDEF(void)
 638 finish_pass_huff (j_decompress_ptr cinfo)
 639 {
 640   huff_entropy_ptr entropy = (huff_entropy_ptr) cinfo-&gt;entropy;
 641 
 642   /* Throw away any unused bits remaining in bit buffer; */
 643   /* include any full bytes in next_marker&#39;s count of discarded bytes */
 644   cinfo-&gt;marker-&gt;discarded_bytes += entropy-&gt;bitstate.bits_left / 8;
 645   entropy-&gt;bitstate.bits_left = 0;
 646 }
 647 
 648 
 649 /*
 650  * Check for a restart marker &amp; resynchronize decoder.
 651  * Returns FALSE if must suspend.
 652  */
 653 
 654 LOCAL(boolean)
 655 process_restart (j_decompress_ptr cinfo)
 656 {
 657   huff_entropy_ptr entropy = (huff_entropy_ptr) cinfo-&gt;entropy;
 658   int ci;
 659 
 660   finish_pass_huff(cinfo);
 661 
 662   /* Advance past the RSTn marker */
 663   if (! (*cinfo-&gt;marker-&gt;read_restart_marker) (cinfo))
 664     return FALSE;
 665 
 666   /* Re-initialize DC predictions to 0 */
 667   for (ci = 0; ci &lt; cinfo-&gt;comps_in_scan; ci++)
 668     entropy-&gt;saved.last_dc_val[ci] = 0;
 669   /* Re-init EOB run count, too */
 670   entropy-&gt;saved.EOBRUN = 0;
 671 
 672   /* Reset restart counter */
 673   entropy-&gt;restarts_to_go = cinfo-&gt;restart_interval;
 674 
 675   /* Reset out-of-data flag, unless read_restart_marker left us smack up
 676    * against a marker.  In that case we will end up treating the next data
 677    * segment as empty, and we can avoid producing bogus output pixels by
 678    * leaving the flag set.
 679    */
 680   if (cinfo-&gt;unread_marker == 0)
 681     entropy-&gt;insufficient_data = FALSE;
 682 
 683   return TRUE;
 684 }
 685 
 686 
 687 /*
 688  * Huffman MCU decoding.
 689  * Each of these routines decodes and returns one MCU&#39;s worth of
 690  * Huffman-compressed coefficients.
 691  * The coefficients are reordered from zigzag order into natural array order,
 692  * but are not dequantized.
 693  *
 694  * The i&#39;th block of the MCU is stored into the block pointed to by
 695  * MCU_data[i].  WE ASSUME THIS AREA IS INITIALLY ZEROED BY THE CALLER.
 696  * (Wholesale zeroing is usually a little faster than retail...)
 697  *
 698  * We return FALSE if data source requested suspension.  In that case no
 699  * changes have been made to permanent state.  (Exception: some output
 700  * coefficients may already have been assigned.  This is harmless for
 701  * spectral selection, since we&#39;ll just re-assign them on the next call.
 702  * Successive approximation AC refinement has to be more careful, however.)
 703  */
 704 
 705 /*
 706  * MCU decoding for DC initial scan (either spectral selection,
 707  * or first pass of successive approximation).
 708  */
 709 
 710 METHODDEF(boolean)
 711 decode_mcu_DC_first (j_decompress_ptr cinfo, JBLOCKROW *MCU_data)
 712 {
 713   huff_entropy_ptr entropy = (huff_entropy_ptr) cinfo-&gt;entropy;
 714   int Al = cinfo-&gt;Al;
 715   register int s, r;
 716   int blkn, ci;
 717   JBLOCKROW block;
 718   BITREAD_STATE_VARS;
 719   savable_state state;
 720   d_derived_tbl * tbl;
 721   jpeg_component_info * compptr;
 722 
 723   /* Process restart marker if needed; may have to suspend */
 724   if (cinfo-&gt;restart_interval) {
 725     if (entropy-&gt;restarts_to_go == 0)
 726       if (! process_restart(cinfo))
 727     return FALSE;
 728   }
 729 
 730   /* If we&#39;ve run out of data, just leave the MCU set to zeroes.
 731    * This way, we return uniform gray for the remainder of the segment.
 732    */
 733   if (! entropy-&gt;insufficient_data) {
 734 
 735     /* Load up working state */
 736     BITREAD_LOAD_STATE(cinfo, entropy-&gt;bitstate);
 737     ASSIGN_STATE(state, entropy-&gt;saved);
 738 
 739     /* Outer loop handles each block in the MCU */
 740 
 741     for (blkn = 0; blkn &lt; cinfo-&gt;blocks_in_MCU; blkn++) {
 742       block = MCU_data[blkn];
 743       ci = cinfo-&gt;MCU_membership[blkn];
 744       compptr = cinfo-&gt;cur_comp_info[ci];
 745       tbl = entropy-&gt;derived_tbls[compptr-&gt;dc_tbl_no];
 746 
 747       /* Decode a single block&#39;s worth of coefficients */
 748 
 749       /* Section F.2.2.1: decode the DC coefficient difference */
 750       HUFF_DECODE(s, br_state, tbl, return FALSE, label1);
 751       if (s) {
 752     CHECK_BIT_BUFFER(br_state, s, return FALSE);
 753     r = GET_BITS(s);
 754     s = HUFF_EXTEND(r, s);
 755       }
 756 
 757       /* Convert DC difference to actual value, update last_dc_val */
 758       s += state.last_dc_val[ci];
 759       state.last_dc_val[ci] = s;
 760       /* Scale and output the coefficient (assumes jpeg_natural_order[0]=0) */
 761       (*block)[0] = (JCOEF) (s &lt;&lt; Al);
 762     }
 763 
 764     /* Completed MCU, so update state */
 765     BITREAD_SAVE_STATE(cinfo, entropy-&gt;bitstate);
 766     ASSIGN_STATE(entropy-&gt;saved, state);
 767   }
 768 
 769   /* Account for restart interval if using restarts */
 770   if (cinfo-&gt;restart_interval)
 771     entropy-&gt;restarts_to_go--;
 772 
 773   return TRUE;
 774 }
 775 
 776 
 777 /*
 778  * MCU decoding for AC initial scan (either spectral selection,
 779  * or first pass of successive approximation).
 780  */
 781 
 782 METHODDEF(boolean)
 783 decode_mcu_AC_first (j_decompress_ptr cinfo, JBLOCKROW *MCU_data)
 784 {
 785   huff_entropy_ptr entropy = (huff_entropy_ptr) cinfo-&gt;entropy;
 786   register int s, k, r;
 787   unsigned int EOBRUN;
 788   int Se, Al;
 789   const int * natural_order;
 790   JBLOCKROW block;
 791   BITREAD_STATE_VARS;
 792   d_derived_tbl * tbl;
 793 
 794   /* Process restart marker if needed; may have to suspend */
 795   if (cinfo-&gt;restart_interval) {
 796     if (entropy-&gt;restarts_to_go == 0)
 797       if (! process_restart(cinfo))
 798     return FALSE;
 799   }
 800 
 801   /* If we&#39;ve run out of data, just leave the MCU set to zeroes.
 802    * This way, we return uniform gray for the remainder of the segment.
 803    */
 804   if (! entropy-&gt;insufficient_data) {
 805 
 806     /* Load up working state.
 807      * We can avoid loading/saving bitread state if in an EOB run.
 808      */
 809     EOBRUN = entropy-&gt;saved.EOBRUN;    /* only part of saved state we need */
 810 
 811     /* There is always only one block per MCU */
 812 
 813     if (EOBRUN)            /* if it&#39;s a band of zeroes... */
 814       EOBRUN--;            /* ...process it now (we do nothing) */
 815     else {
 816       BITREAD_LOAD_STATE(cinfo, entropy-&gt;bitstate);
 817       Se = cinfo-&gt;Se;
 818       Al = cinfo-&gt;Al;
 819       natural_order = cinfo-&gt;natural_order;
 820       block = MCU_data[0];
 821       tbl = entropy-&gt;ac_derived_tbl;
 822 
 823       for (k = cinfo-&gt;Ss; k &lt;= Se; k++) {
 824     HUFF_DECODE(s, br_state, tbl, return FALSE, label2);
 825     r = s &gt;&gt; 4;
 826     s &amp;= 15;
 827     if (s) {
 828       k += r;
 829       CHECK_BIT_BUFFER(br_state, s, return FALSE);
 830       r = GET_BITS(s);
 831       s = HUFF_EXTEND(r, s);
 832       /* Scale and output coefficient in natural (dezigzagged) order */
 833       (*block)[natural_order[k]] = (JCOEF) (s &lt;&lt; Al);
 834     } else {
 835       if (r != 15) {    /* EOBr, run length is 2^r + appended bits */
 836         if (r) {        /* EOBr, r &gt; 0 */
 837           EOBRUN = 1 &lt;&lt; r;
 838           CHECK_BIT_BUFFER(br_state, r, return FALSE);
 839           r = GET_BITS(r);
 840           EOBRUN += r;
 841           EOBRUN--;        /* this band is processed at this moment */
 842         }
 843         break;        /* force end-of-band */
 844       }
 845       k += 15;        /* ZRL: skip 15 zeroes in band */
 846     }
 847       }
 848 
 849       BITREAD_SAVE_STATE(cinfo, entropy-&gt;bitstate);
 850     }
 851 
 852     /* Completed MCU, so update state */
 853     entropy-&gt;saved.EOBRUN = EOBRUN;    /* only part of saved state we need */
 854   }
 855 
 856   /* Account for restart interval if using restarts */
 857   if (cinfo-&gt;restart_interval)
 858     entropy-&gt;restarts_to_go--;
 859 
 860   return TRUE;
 861 }
 862 
 863 
 864 /*
 865  * MCU decoding for DC successive approximation refinement scan.
 866  * Note: we assume such scans can be multi-component,
 867  * although the spec is not very clear on the point.
 868  */
 869 
 870 METHODDEF(boolean)
 871 decode_mcu_DC_refine (j_decompress_ptr cinfo, JBLOCKROW *MCU_data)
 872 {
 873   huff_entropy_ptr entropy = (huff_entropy_ptr) cinfo-&gt;entropy;
 874   JCOEF p1;
 875   int blkn;
 876   BITREAD_STATE_VARS;
 877 
 878   /* Process restart marker if needed; may have to suspend */
 879   if (cinfo-&gt;restart_interval) {
 880     if (entropy-&gt;restarts_to_go == 0)
 881       if (! process_restart(cinfo))
 882     return FALSE;
 883   }
 884 
 885   /* Not worth the cycles to check insufficient_data here,
 886    * since we will not change the data anyway if we read zeroes.
 887    */
 888 
 889   /* Load up working state */
 890   BITREAD_LOAD_STATE(cinfo, entropy-&gt;bitstate);
 891 
 892   p1 = 1 &lt;&lt; cinfo-&gt;Al;        /* 1 in the bit position being coded */
 893 
 894   /* Outer loop handles each block in the MCU */
 895 
 896   for (blkn = 0; blkn &lt; cinfo-&gt;blocks_in_MCU; blkn++) {
 897     /* Encoded data is simply the next bit of the two&#39;s-complement DC value */
 898     CHECK_BIT_BUFFER(br_state, 1, return FALSE);
 899     if (GET_BITS(1))
 900       MCU_data[blkn][0][0] |= p1;
 901     /* Note: since we use |=, repeating the assignment later is safe */
 902   }
 903 
 904   /* Completed MCU, so update state */
 905   BITREAD_SAVE_STATE(cinfo, entropy-&gt;bitstate);
 906 
 907   /* Account for restart interval if using restarts */
 908   if (cinfo-&gt;restart_interval)
 909     entropy-&gt;restarts_to_go--;
 910 
 911   return TRUE;
 912 }
 913 
 914 
 915 /*
 916  * MCU decoding for AC successive approximation refinement scan.
 917  */
 918 
 919 METHODDEF(boolean)
 920 decode_mcu_AC_refine (j_decompress_ptr cinfo, JBLOCKROW *MCU_data)
 921 {
 922   huff_entropy_ptr entropy = (huff_entropy_ptr) cinfo-&gt;entropy;
 923   register int s, k, r;
 924   unsigned int EOBRUN;
 925   int Se;
 926   JCOEF p1, m1;
 927   const int * natural_order;
 928   JBLOCKROW block;
 929   JCOEFPTR thiscoef;
 930   BITREAD_STATE_VARS;
 931   d_derived_tbl * tbl;
 932   int num_newnz;
 933   int newnz_pos[DCTSIZE2];
 934 
 935   /* Process restart marker if needed; may have to suspend */
 936   if (cinfo-&gt;restart_interval) {
 937     if (entropy-&gt;restarts_to_go == 0)
 938       if (! process_restart(cinfo))
 939     return FALSE;
 940   }
 941 
 942   /* If we&#39;ve run out of data, don&#39;t modify the MCU.
 943    */
 944   if (! entropy-&gt;insufficient_data) {
 945 
 946     Se = cinfo-&gt;Se;
 947     p1 = 1 &lt;&lt; cinfo-&gt;Al;    /* 1 in the bit position being coded */
 948     m1 = -p1;            /* -1 in the bit position being coded */
 949     natural_order = cinfo-&gt;natural_order;
 950 
 951     /* Load up working state */
 952     BITREAD_LOAD_STATE(cinfo, entropy-&gt;bitstate);
 953     EOBRUN = entropy-&gt;saved.EOBRUN; /* only part of saved state we need */
 954 
 955     /* There is always only one block per MCU */
 956     block = MCU_data[0];
 957     tbl = entropy-&gt;ac_derived_tbl;
 958 
 959     /* If we are forced to suspend, we must undo the assignments to any newly
 960      * nonzero coefficients in the block, because otherwise we&#39;d get confused
 961      * next time about which coefficients were already nonzero.
 962      * But we need not undo addition of bits to already-nonzero coefficients;
 963      * instead, we can test the current bit to see if we already did it.
 964      */
 965     num_newnz = 0;
 966 
 967     /* initialize coefficient loop counter to start of band */
 968     k = cinfo-&gt;Ss;
 969 
 970     if (EOBRUN == 0) {
 971       do {
 972     HUFF_DECODE(s, br_state, tbl, goto undoit, label3);
 973     r = s &gt;&gt; 4;
 974     s &amp;= 15;
 975     if (s) {
 976       if (s != 1)        /* size of new coef should always be 1 */
 977         WARNMS(cinfo, JWRN_HUFF_BAD_CODE);
 978       CHECK_BIT_BUFFER(br_state, 1, goto undoit);
 979       if (GET_BITS(1))
 980         s = p1;        /* newly nonzero coef is positive */
 981       else
 982         s = m1;        /* newly nonzero coef is negative */
 983     } else {
 984       if (r != 15) {
 985         EOBRUN = 1 &lt;&lt; r;    /* EOBr, run length is 2^r + appended bits */
 986         if (r) {
 987           CHECK_BIT_BUFFER(br_state, r, goto undoit);
 988           r = GET_BITS(r);
 989           EOBRUN += r;
 990         }
 991         break;        /* rest of block is handled by EOB logic */
 992       }
 993       /* note s = 0 for processing ZRL */
 994     }
 995     /* Advance over already-nonzero coefs and r still-zero coefs,
 996      * appending correction bits to the nonzeroes.  A correction bit is 1
 997      * if the absolute value of the coefficient must be increased.
 998      */
 999     do {
1000       thiscoef = *block + natural_order[k];
1001       if (*thiscoef) {
1002         CHECK_BIT_BUFFER(br_state, 1, goto undoit);
1003         if (GET_BITS(1)) {
1004           if ((*thiscoef &amp; p1) == 0) { /* do nothing if already set it */
1005         if (*thiscoef &gt;= 0)
1006           *thiscoef += p1;
1007         else
1008           *thiscoef += m1;
1009           }
1010         }
1011       } else {
1012         if (--r &lt; 0)
1013           break;        /* reached target zero coefficient */
1014       }
1015       k++;
1016     } while (k &lt;= Se);
1017     if (s) {
1018       int pos = natural_order[k];
1019       /* Output newly nonzero coefficient */
1020       (*block)[pos] = (JCOEF) s;
1021       /* Remember its position in case we have to suspend */
1022       newnz_pos[num_newnz++] = pos;
1023     }
1024     k++;
1025       } while (k &lt;= Se);
1026     }
1027 
1028     if (EOBRUN) {
1029       /* Scan any remaining coefficient positions after the end-of-band
1030        * (the last newly nonzero coefficient, if any).  Append a correction
1031        * bit to each already-nonzero coefficient.  A correction bit is 1
1032        * if the absolute value of the coefficient must be increased.
1033        */
1034       do {
1035     thiscoef = *block + natural_order[k];
1036     if (*thiscoef) {
1037       CHECK_BIT_BUFFER(br_state, 1, goto undoit);
1038       if (GET_BITS(1)) {
1039         if ((*thiscoef &amp; p1) == 0) { /* do nothing if already changed it */
1040           if (*thiscoef &gt;= 0)
1041         *thiscoef += p1;
1042           else
1043         *thiscoef += m1;
1044         }
1045       }
1046     }
1047     k++;
1048       } while (k &lt;= Se);
1049       /* Count one block completed in EOB run */
1050       EOBRUN--;
1051     }
1052 
1053     /* Completed MCU, so update state */
1054     BITREAD_SAVE_STATE(cinfo, entropy-&gt;bitstate);
1055     entropy-&gt;saved.EOBRUN = EOBRUN; /* only part of saved state we need */
1056   }
1057 
1058   /* Account for restart interval if using restarts */
1059   if (cinfo-&gt;restart_interval)
1060     entropy-&gt;restarts_to_go--;
1061 
1062   return TRUE;
1063 
1064 undoit:
1065   /* Re-zero any output coefficients that we made newly nonzero */
1066   while (num_newnz)
1067     (*block)[newnz_pos[--num_newnz]] = 0;
1068 
1069   return FALSE;
1070 }
1071 
1072 
1073 /*
1074  * Decode one MCU&#39;s worth of Huffman-compressed coefficients,
1075  * partial blocks.
1076  */
1077 
1078 METHODDEF(boolean)
1079 decode_mcu_sub (j_decompress_ptr cinfo, JBLOCKROW *MCU_data)
1080 {
1081   huff_entropy_ptr entropy = (huff_entropy_ptr) cinfo-&gt;entropy;
1082   const int * natural_order;
1083   int Se, blkn;
1084   BITREAD_STATE_VARS;
1085   savable_state state;
1086 
1087   /* Process restart marker if needed; may have to suspend */
1088   if (cinfo-&gt;restart_interval) {
1089     if (entropy-&gt;restarts_to_go == 0)
1090       if (! process_restart(cinfo))
1091     return FALSE;
1092   }
1093 
1094   /* If we&#39;ve run out of data, just leave the MCU set to zeroes.
1095    * This way, we return uniform gray for the remainder of the segment.
1096    */
1097   if (! entropy-&gt;insufficient_data) {
1098 
1099     natural_order = cinfo-&gt;natural_order;
1100     Se = cinfo-&gt;lim_Se;
1101 
1102     /* Load up working state */
1103     BITREAD_LOAD_STATE(cinfo, entropy-&gt;bitstate);
1104     ASSIGN_STATE(state, entropy-&gt;saved);
1105 
1106     /* Outer loop handles each block in the MCU */
1107 
1108     for (blkn = 0; blkn &lt; cinfo-&gt;blocks_in_MCU; blkn++) {
1109       JBLOCKROW block = MCU_data[blkn];
1110       d_derived_tbl * htbl;
1111       register int s, k, r;
1112       int coef_limit, ci;
1113 
1114       /* Decode a single block&#39;s worth of coefficients */
1115 
1116       /* Section F.2.2.1: decode the DC coefficient difference */
1117       htbl = entropy-&gt;dc_cur_tbls[blkn];
1118       HUFF_DECODE(s, br_state, htbl, return FALSE, label1);
1119 
1120       htbl = entropy-&gt;ac_cur_tbls[blkn];
1121       k = 1;
1122       coef_limit = entropy-&gt;coef_limit[blkn];
1123       if (coef_limit) {
1124     /* Convert DC difference to actual value, update last_dc_val */
1125     if (s) {
1126       CHECK_BIT_BUFFER(br_state, s, return FALSE);
1127       r = GET_BITS(s);
1128       s = HUFF_EXTEND(r, s);
1129     }
1130     ci = cinfo-&gt;MCU_membership[blkn];
1131     s += state.last_dc_val[ci];
1132     state.last_dc_val[ci] = s;
1133     /* Output the DC coefficient */
1134     (*block)[0] = (JCOEF) s;
1135 
1136     /* Section F.2.2.2: decode the AC coefficients */
1137     /* Since zeroes are skipped, output area must be cleared beforehand */
1138     for (; k &lt; coef_limit; k++) {
1139       HUFF_DECODE(s, br_state, htbl, return FALSE, label2);
1140 
1141       r = s &gt;&gt; 4;
1142       s &amp;= 15;
1143 
1144       if (s) {
1145         k += r;
1146         CHECK_BIT_BUFFER(br_state, s, return FALSE);
1147         r = GET_BITS(s);
1148         s = HUFF_EXTEND(r, s);
1149         /* Output coefficient in natural (dezigzagged) order.
1150          * Note: the extra entries in natural_order[] will save us
1151          * if k &gt; Se, which could happen if the data is corrupted.
1152          */
1153         (*block)[natural_order[k]] = (JCOEF) s;
1154       } else {
1155         if (r != 15)
1156           goto EndOfBlock;
1157         k += 15;
1158       }
1159     }
1160       } else {
1161     if (s) {
1162       CHECK_BIT_BUFFER(br_state, s, return FALSE);
1163       DROP_BITS(s);
1164     }
1165       }
1166 
1167       /* Section F.2.2.2: decode the AC coefficients */
1168       /* In this path we just discard the values */
1169       for (; k &lt;= Se; k++) {
1170     HUFF_DECODE(s, br_state, htbl, return FALSE, label3);
1171 
1172     r = s &gt;&gt; 4;
1173     s &amp;= 15;
1174 
1175     if (s) {
1176       k += r;
1177       CHECK_BIT_BUFFER(br_state, s, return FALSE);
1178       DROP_BITS(s);
1179     } else {
1180       if (r != 15)
1181         break;
1182       k += 15;
1183     }
1184       }
1185 
1186       EndOfBlock: ;
1187     }
1188 
1189     /* Completed MCU, so update state */
1190     BITREAD_SAVE_STATE(cinfo, entropy-&gt;bitstate);
1191     ASSIGN_STATE(entropy-&gt;saved, state);
1192   }
1193 
1194   /* Account for restart interval if using restarts */
1195   if (cinfo-&gt;restart_interval)
1196     entropy-&gt;restarts_to_go--;
1197 
1198   return TRUE;
1199 }
1200 
1201 
1202 /*
1203  * Decode one MCU&#39;s worth of Huffman-compressed coefficients,
1204  * full-size blocks.
1205  */
1206 
1207 METHODDEF(boolean)
1208 decode_mcu (j_decompress_ptr cinfo, JBLOCKROW *MCU_data)
1209 {
1210   huff_entropy_ptr entropy = (huff_entropy_ptr) cinfo-&gt;entropy;
1211   int blkn;
1212   BITREAD_STATE_VARS;
1213   savable_state state;
1214 
1215   /* Process restart marker if needed; may have to suspend */
1216   if (cinfo-&gt;restart_interval) {
1217     if (entropy-&gt;restarts_to_go == 0)
1218       if (! process_restart(cinfo))
1219     return FALSE;
1220   }
1221 
1222   /* If we&#39;ve run out of data, just leave the MCU set to zeroes.
1223    * This way, we return uniform gray for the remainder of the segment.
1224    */
1225   if (! entropy-&gt;insufficient_data) {
1226 
1227     /* Load up working state */
1228     BITREAD_LOAD_STATE(cinfo, entropy-&gt;bitstate);
1229     ASSIGN_STATE(state, entropy-&gt;saved);
1230 
1231     /* Outer loop handles each block in the MCU */
1232 
1233     for (blkn = 0; blkn &lt; cinfo-&gt;blocks_in_MCU; blkn++) {
1234       JBLOCKROW block = MCU_data[blkn];
1235       d_derived_tbl * htbl;
1236       register int s, k, r;
1237       int coef_limit, ci;
1238 
1239       /* Decode a single block&#39;s worth of coefficients */
1240 
1241       /* Section F.2.2.1: decode the DC coefficient difference */
1242       htbl = entropy-&gt;dc_cur_tbls[blkn];
1243       HUFF_DECODE(s, br_state, htbl, return FALSE, label1);
1244 
1245       htbl = entropy-&gt;ac_cur_tbls[blkn];
1246       k = 1;
1247       coef_limit = entropy-&gt;coef_limit[blkn];
1248       if (coef_limit) {
1249     /* Convert DC difference to actual value, update last_dc_val */
1250     if (s) {
1251       CHECK_BIT_BUFFER(br_state, s, return FALSE);
1252       r = GET_BITS(s);
1253       s = HUFF_EXTEND(r, s);
1254     }
1255     ci = cinfo-&gt;MCU_membership[blkn];
1256     s += state.last_dc_val[ci];
1257     state.last_dc_val[ci] = s;
1258     /* Output the DC coefficient */
1259     (*block)[0] = (JCOEF) s;
1260 
1261     /* Section F.2.2.2: decode the AC coefficients */
1262     /* Since zeroes are skipped, output area must be cleared beforehand */
1263     for (; k &lt; coef_limit; k++) {
1264       HUFF_DECODE(s, br_state, htbl, return FALSE, label2);
1265 
1266       r = s &gt;&gt; 4;
1267       s &amp;= 15;
1268 
1269       if (s) {
1270         k += r;
1271         CHECK_BIT_BUFFER(br_state, s, return FALSE);
1272         r = GET_BITS(s);
1273         s = HUFF_EXTEND(r, s);
1274         /* Output coefficient in natural (dezigzagged) order.
1275          * Note: the extra entries in jpeg_natural_order[] will save us
1276          * if k &gt;= DCTSIZE2, which could happen if the data is corrupted.
1277          */
1278         (*block)[jpeg_natural_order[k]] = (JCOEF) s;
1279       } else {
1280         if (r != 15)
1281           goto EndOfBlock;
1282         k += 15;
1283       }
1284     }
1285       } else {
1286     if (s) {
1287       CHECK_BIT_BUFFER(br_state, s, return FALSE);
1288       DROP_BITS(s);
1289     }
1290       }
1291 
1292       /* Section F.2.2.2: decode the AC coefficients */
1293       /* In this path we just discard the values */
1294       for (; k &lt; DCTSIZE2; k++) {
1295     HUFF_DECODE(s, br_state, htbl, return FALSE, label3);
1296 
1297     r = s &gt;&gt; 4;
1298     s &amp;= 15;
1299 
1300     if (s) {
1301       k += r;
1302       CHECK_BIT_BUFFER(br_state, s, return FALSE);
1303       DROP_BITS(s);
1304     } else {
1305       if (r != 15)
1306         break;
1307       k += 15;
1308     }
1309       }
1310 
1311       EndOfBlock: ;
1312     }
1313 
1314     /* Completed MCU, so update state */
1315     BITREAD_SAVE_STATE(cinfo, entropy-&gt;bitstate);
1316     ASSIGN_STATE(entropy-&gt;saved, state);
1317   }
1318 
1319   /* Account for restart interval if using restarts */
1320   if (cinfo-&gt;restart_interval)
1321     entropy-&gt;restarts_to_go--;
1322 
1323   return TRUE;
1324 }
1325 
1326 
1327 /*
1328  * Initialize for a Huffman-compressed scan.
1329  */
1330 
1331 METHODDEF(void)
1332 start_pass_huff_decoder (j_decompress_ptr cinfo)
1333 {
1334   huff_entropy_ptr entropy = (huff_entropy_ptr) cinfo-&gt;entropy;
1335   int ci, blkn, tbl, i;
1336   jpeg_component_info * compptr;
1337 
1338   if (cinfo-&gt;progressive_mode) {
1339     /* Validate progressive scan parameters */
1340     if (cinfo-&gt;Ss == 0) {
1341       if (cinfo-&gt;Se != 0)
1342     goto bad;
1343     } else {
1344       /* need not check Ss/Se &lt; 0 since they came from unsigned bytes */
1345       if (cinfo-&gt;Se &lt; cinfo-&gt;Ss || cinfo-&gt;Se &gt; cinfo-&gt;lim_Se)
1346     goto bad;
1347       /* AC scans may have only one component */
1348       if (cinfo-&gt;comps_in_scan != 1)
1349     goto bad;
1350     }
1351     if (cinfo-&gt;Ah != 0) {
1352       /* Successive approximation refinement scan: must have Al = Ah-1. */
1353       if (cinfo-&gt;Ah-1 != cinfo-&gt;Al)
1354     goto bad;
1355     }
1356     if (cinfo-&gt;Al &gt; 13) {    /* need not check for &lt; 0 */
1357       /* Arguably the maximum Al value should be less than 13 for 8-bit
1358        * precision, but the spec doesn&#39;t say so, and we try to be liberal
1359        * about what we accept.  Note: large Al values could result in
1360        * out-of-range DC coefficients during early scans, leading to bizarre
1361        * displays due to overflows in the IDCT math.  But we won&#39;t crash.
1362        */
1363       bad:
1364       ERREXIT4(cinfo, JERR_BAD_PROGRESSION,
1365            cinfo-&gt;Ss, cinfo-&gt;Se, cinfo-&gt;Ah, cinfo-&gt;Al);
1366     }
1367     /* Update progression status, and verify that scan order is legal.
1368      * Note that inter-scan inconsistencies are treated as warnings
1369      * not fatal errors ... not clear if this is right way to behave.
1370      */
1371     for (ci = 0; ci &lt; cinfo-&gt;comps_in_scan; ci++) {
1372       int coefi, cindex = cinfo-&gt;cur_comp_info[ci]-&gt;component_index;
1373       int *coef_bit_ptr = &amp; cinfo-&gt;coef_bits[cindex][0];
1374       if (cinfo-&gt;Ss &amp;&amp; coef_bit_ptr[0] &lt; 0) /* AC without prior DC scan */
1375     WARNMS2(cinfo, JWRN_BOGUS_PROGRESSION, cindex, 0);
1376       for (coefi = cinfo-&gt;Ss; coefi &lt;= cinfo-&gt;Se; coefi++) {
1377     int expected = (coef_bit_ptr[coefi] &lt; 0) ? 0 : coef_bit_ptr[coefi];
1378     if (cinfo-&gt;Ah != expected)
1379       WARNMS2(cinfo, JWRN_BOGUS_PROGRESSION, cindex, coefi);
1380     coef_bit_ptr[coefi] = cinfo-&gt;Al;
1381       }
1382     }
1383 
1384     /* Select MCU decoding routine */
1385     if (cinfo-&gt;Ah == 0) {
1386       if (cinfo-&gt;Ss == 0)
1387     entropy-&gt;pub.decode_mcu = decode_mcu_DC_first;
1388       else
1389     entropy-&gt;pub.decode_mcu = decode_mcu_AC_first;
1390     } else {
1391       if (cinfo-&gt;Ss == 0)
1392     entropy-&gt;pub.decode_mcu = decode_mcu_DC_refine;
1393       else
1394     entropy-&gt;pub.decode_mcu = decode_mcu_AC_refine;
1395     }
1396 
1397     for (ci = 0; ci &lt; cinfo-&gt;comps_in_scan; ci++) {
1398       compptr = cinfo-&gt;cur_comp_info[ci];
1399       /* Make sure requested tables are present, and compute derived tables.
1400        * We may build same derived table more than once, but it&#39;s not expensive.
1401        */
1402       if (cinfo-&gt;Ss == 0) {
1403     if (cinfo-&gt;Ah == 0) {    /* DC refinement needs no table */
1404       tbl = compptr-&gt;dc_tbl_no;
1405       jpeg_make_d_derived_tbl(cinfo, TRUE, tbl,
1406                   &amp; entropy-&gt;derived_tbls[tbl]);
1407     }
1408       } else {
1409     tbl = compptr-&gt;ac_tbl_no;
1410     jpeg_make_d_derived_tbl(cinfo, FALSE, tbl,
1411                 &amp; entropy-&gt;derived_tbls[tbl]);
1412     /* remember the single active table */
1413     entropy-&gt;ac_derived_tbl = entropy-&gt;derived_tbls[tbl];
1414       }
1415       /* Initialize DC predictions to 0 */
1416       entropy-&gt;saved.last_dc_val[ci] = 0;
1417     }
1418 
1419     /* Initialize private state variables */
1420     entropy-&gt;saved.EOBRUN = 0;
1421   } else {
1422     /* Check that the scan parameters Ss, Se, Ah/Al are OK for sequential JPEG.
1423      * This ought to be an error condition, but we make it a warning because
1424      * there are some baseline files out there with all zeroes in these bytes.
1425      */
1426     if (cinfo-&gt;Ss != 0 || cinfo-&gt;Ah != 0 || cinfo-&gt;Al != 0 ||
1427     ((cinfo-&gt;is_baseline || cinfo-&gt;Se &lt; DCTSIZE2) &amp;&amp;
1428     cinfo-&gt;Se != cinfo-&gt;lim_Se))
1429       WARNMS(cinfo, JWRN_NOT_SEQUENTIAL);
1430 
1431     /* Select MCU decoding routine */
1432     /* We retain the hard-coded case for full-size blocks.
1433      * This is not necessary, but it appears that this version is slightly
1434      * more performant in the given implementation.
1435      * With an improved implementation we would prefer a single optimized
1436      * function.
1437      */
1438     if (cinfo-&gt;lim_Se != DCTSIZE2-1)
1439       entropy-&gt;pub.decode_mcu = decode_mcu_sub;
1440     else
1441       entropy-&gt;pub.decode_mcu = decode_mcu;
1442 
1443     for (ci = 0; ci &lt; cinfo-&gt;comps_in_scan; ci++) {
1444       compptr = cinfo-&gt;cur_comp_info[ci];
1445       /* Compute derived values for Huffman tables */
1446       /* We may do this more than once for a table, but it&#39;s not expensive */
1447       tbl = compptr-&gt;dc_tbl_no;
1448       jpeg_make_d_derived_tbl(cinfo, TRUE, tbl,
1449                   &amp; entropy-&gt;dc_derived_tbls[tbl]);
1450       if (cinfo-&gt;lim_Se) {    /* AC needs no table when not present */
1451     tbl = compptr-&gt;ac_tbl_no;
1452     jpeg_make_d_derived_tbl(cinfo, FALSE, tbl,
1453                 &amp; entropy-&gt;ac_derived_tbls[tbl]);
1454       }
1455       /* Initialize DC predictions to 0 */
1456       entropy-&gt;saved.last_dc_val[ci] = 0;
1457     }
1458 
1459     /* Precalculate decoding info for each block in an MCU of this scan */
1460     for (blkn = 0; blkn &lt; cinfo-&gt;blocks_in_MCU; blkn++) {
1461       ci = cinfo-&gt;MCU_membership[blkn];
1462       compptr = cinfo-&gt;cur_comp_info[ci];
1463       /* Precalculate which table to use for each block */
1464       entropy-&gt;dc_cur_tbls[blkn] = entropy-&gt;dc_derived_tbls[compptr-&gt;dc_tbl_no];
1465       entropy-&gt;ac_cur_tbls[blkn] =    /* AC needs no table when not present */
1466     cinfo-&gt;lim_Se ? entropy-&gt;ac_derived_tbls[compptr-&gt;ac_tbl_no] : NULL;
1467       /* Decide whether we really care about the coefficient values */
1468       if (compptr-&gt;component_needed) {
1469     ci = compptr-&gt;DCT_v_scaled_size;
1470     i = compptr-&gt;DCT_h_scaled_size;
1471     switch (cinfo-&gt;lim_Se) {
1472     case (1*1-1):
1473       entropy-&gt;coef_limit[blkn] = 1;
1474       break;
1475     case (2*2-1):
1476       if (ci &lt;= 0 || ci &gt; 2) ci = 2;
1477       if (i &lt;= 0 || i &gt; 2) i = 2;
1478       entropy-&gt;coef_limit[blkn] = 1 + jpeg_zigzag_order2[ci - 1][i - 1];
1479       break;
1480     case (3*3-1):
1481       if (ci &lt;= 0 || ci &gt; 3) ci = 3;
1482       if (i &lt;= 0 || i &gt; 3) i = 3;
1483       entropy-&gt;coef_limit[blkn] = 1 + jpeg_zigzag_order3[ci - 1][i - 1];
1484       break;
1485     case (4*4-1):
1486       if (ci &lt;= 0 || ci &gt; 4) ci = 4;
1487       if (i &lt;= 0 || i &gt; 4) i = 4;
1488       entropy-&gt;coef_limit[blkn] = 1 + jpeg_zigzag_order4[ci - 1][i - 1];
1489       break;
1490     case (5*5-1):
1491       if (ci &lt;= 0 || ci &gt; 5) ci = 5;
1492       if (i &lt;= 0 || i &gt; 5) i = 5;
1493       entropy-&gt;coef_limit[blkn] = 1 + jpeg_zigzag_order5[ci - 1][i - 1];
1494       break;
1495     case (6*6-1):
1496       if (ci &lt;= 0 || ci &gt; 6) ci = 6;
1497       if (i &lt;= 0 || i &gt; 6) i = 6;
1498       entropy-&gt;coef_limit[blkn] = 1 + jpeg_zigzag_order6[ci - 1][i - 1];
1499       break;
1500     case (7*7-1):
1501       if (ci &lt;= 0 || ci &gt; 7) ci = 7;
1502       if (i &lt;= 0 || i &gt; 7) i = 7;
1503       entropy-&gt;coef_limit[blkn] = 1 + jpeg_zigzag_order7[ci - 1][i - 1];
1504       break;
1505     default:
1506       if (ci &lt;= 0 || ci &gt; 8) ci = 8;
1507       if (i &lt;= 0 || i &gt; 8) i = 8;
1508       entropy-&gt;coef_limit[blkn] = 1 + jpeg_zigzag_order[ci - 1][i - 1];
1509     }
1510       } else {
1511     entropy-&gt;coef_limit[blkn] = 0;
1512       }
1513     }
1514   }
1515 
1516   /* Initialize bitread state variables */
1517   entropy-&gt;bitstate.bits_left = 0;
1518   entropy-&gt;bitstate.get_buffer = 0; /* unnecessary, but keeps Purify quiet */
1519   entropy-&gt;insufficient_data = FALSE;
1520 
1521   /* Initialize restart counter */
1522   entropy-&gt;restarts_to_go = cinfo-&gt;restart_interval;
1523 }
1524 
1525 
1526 /*
1527  * Module initialization routine for Huffman entropy decoding.
1528  */
1529 
1530 GLOBAL(void)
1531 jinit_huff_decoder (j_decompress_ptr cinfo)
1532 {
1533   huff_entropy_ptr entropy;
1534   int i;
1535 
1536   entropy = (huff_entropy_ptr) (*cinfo-&gt;mem-&gt;alloc_small)
1537     ((j_common_ptr) cinfo, JPOOL_IMAGE, SIZEOF(huff_entropy_decoder));
1538   cinfo-&gt;entropy = &amp;entropy-&gt;pub;
1539   entropy-&gt;pub.start_pass = start_pass_huff_decoder;
1540   entropy-&gt;pub.finish_pass = finish_pass_huff;
1541 
1542   if (cinfo-&gt;progressive_mode) {
1543     /* Create progression status table */
1544     int *coef_bit_ptr, ci;
1545     cinfo-&gt;coef_bits = (int (*)[DCTSIZE2]) (*cinfo-&gt;mem-&gt;alloc_small)
1546       ((j_common_ptr) cinfo, JPOOL_IMAGE,
1547        cinfo-&gt;num_components * DCTSIZE2 * SIZEOF(int));
1548     coef_bit_ptr = &amp; cinfo-&gt;coef_bits[0][0];
1549     for (ci = 0; ci &lt; cinfo-&gt;num_components; ci++)
1550       for (i = 0; i &lt; DCTSIZE2; i++)
1551     *coef_bit_ptr++ = -1;
1552 
1553     /* Mark derived tables unallocated */
1554     for (i = 0; i &lt; NUM_HUFF_TBLS; i++) {
1555       entropy-&gt;derived_tbls[i] = NULL;
1556     }
1557   } else {
1558     /* Mark derived tables unallocated */
1559     for (i = 0; i &lt; NUM_HUFF_TBLS; i++) {
1560       entropy-&gt;dc_derived_tbls[i] = entropy-&gt;ac_derived_tbls[i] = NULL;
1561     }
1562   }
1563 }
    </pre>
  </body>
</html>