<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.graphics/src/main/native-prism-d3d/D3DPipeline.cc</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../native-glass/win/Utils.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="D3DShader.cc.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.graphics/src/main/native-prism-d3d/D3DPipeline.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &quot;D3DPipeline.h&quot;
 27 #include &quot;com_sun_prism_d3d_D3DPipeline.h&quot;
 28 #include &quot;D3DPipelineManager.h&quot;
 29 
 30 
 31 // d3d9.dll library dynamic load
 32 HMODULE hLibD3D9 = 0;
 33 typedef IDirect3D9 * WINAPI FnDirect3DCreate9(UINT SDKVersion);
 34 typedef HRESULT WINAPI FnDirect3DCreate9Ex(UINT SDKVersion, IDirect3D9Ex**);
 35 
 36 FnDirect3DCreate9 * pD3D9FactoryFunction = 0;
 37 FnDirect3DCreate9Ex * pD3D9FactoryExFunction = 0;
 38 
<span class="line-modified"> 39 extern jboolean checkAndClearException(JNIEnv *env);</span>
<span class="line-removed"> 40 </span>
<span class="line-removed"> 41 jboolean checkAndClearException(JNIEnv *env) {</span>
 42     if (!env-&gt;ExceptionCheck()) {
 43         return JNI_FALSE;
 44     }
 45     env-&gt;ExceptionClear();
 46     return JNI_TRUE;
 47 }
 48 
 49 void loadD3DLibrary() {
 50     wchar_t path[MAX_PATH];
 51     if (::GetSystemDirectory(path, sizeof(path) / sizeof(wchar_t)) != 0) {
 52         wcscat_s(path, MAX_PATH-1, L&quot;\\d3d9.dll&quot;);
 53         hLibD3D9 = ::LoadLibrary(path);
 54     }
 55     if (hLibD3D9) {
 56         pD3D9FactoryFunction = (FnDirect3DCreate9*)GetProcAddress(hLibD3D9, &quot;Direct3DCreate9&quot;);
 57         pD3D9FactoryExFunction = (FnDirect3DCreate9Ex*)GetProcAddress(hLibD3D9, &quot;Direct3DCreate9Ex&quot;);
 58     }
 59 }
 60 
 61 void freeD3DLibrary() {
 62     if (hLibD3D9) {
 63         ::FreeLibrary(hLibD3D9);
 64         hLibD3D9 = 0;
 65         pD3D9FactoryFunction = 0;
 66         pD3D9FactoryExFunction = 0;
 67     }
 68 }
 69 
 70 IDirect3D9 * Direct3DCreate9() {
 71     return pD3D9FactoryFunction ? pD3D9FactoryFunction(D3D_SDK_VERSION) : 0;
 72 }
 73 
 74 IDirect3D9Ex * Direct3DCreate9Ex() {
 75     IDirect3D9Ex * pD3D = 0;
 76     HRESULT hr = pD3D9FactoryExFunction ? pD3D9FactoryExFunction(D3D_SDK_VERSION, &amp;pD3D) : E_FAIL;
 77     return SUCCEEDED(hr) ? pD3D : 0;
 78 }
 79 

 80 BOOL APIENTRY DllMain( HANDLE hModule,
 81                        DWORD  ul_reason_for_call,
 82                        LPVOID lpReserved)
 83 {
 84     switch (ul_reason_for_call) {
 85     case DLL_PROCESS_ATTACH:
 86         loadD3DLibrary();
 87         break;
 88     case DLL_PROCESS_DETACH:
 89         freeD3DLibrary();
 90         break;
 91     }
 92     return TRUE;
 93 }

 94 
 95 struct ConfigJavaStaticClass : IConfig {
 96     JNIEnv *_env; jclass _psClass;
 97     ConfigJavaStaticClass(JNIEnv *env, jclass psClass)  :
 98     _env(env), _psClass(psClass) {}
 99 
100     virtual int getInt(cstr name) {
101         jfieldID id = _env-&gt;GetStaticFieldID(_psClass, name, &quot;I&quot;);
102         return id ? _env-&gt;GetStaticIntField(_psClass, id) : 0;
103     }
104 
105     virtual bool getBool(cstr name) {
106         jfieldID id = _env-&gt;GetStaticFieldID(_psClass, name, &quot;Z&quot;);
107         return id &amp;&amp; _env-&gt;GetStaticBooleanField(_psClass, id);
108     }
109 
110 };
111 
112 /*
113  * Class:     com_sun_prism_d3d_D3DPipeline
114  * Method:    nInit
115  */
116 
117 JNIEXPORT jboolean JNICALL Java_com_sun_prism_d3d_D3DPipeline_nInit
118   (JNIEnv *env, jclass, jclass psClass)
119 {
120     if (D3DPipelineManager::GetInstance()) {
121         D3DPipelineManager::SetErrorMessage(&quot;Double D3DPipelineManager initialization&quot;);
122         return false;
123     }
124 
125     if (FAILED(D3DPipelineManager::CheckOSVersion())) {
126         D3DPipelineManager::SetErrorMessage(&quot;Wrong operating system version&quot;);
127         return false;
128     }
129 




130     TraceLn(NWT_TRACE_INFO, &quot;D3DPipeline_nInit&quot;);
131     D3DPipelineManager *pMgr = D3DPipelineManager::CreateInstance(ConfigJavaStaticClass(env, psClass));
132 
133     if (!pMgr &amp;&amp; !D3DPipelineManager::GetErrorMessage()) {
134         D3DPipelineManager::SetErrorMessage(&quot;Direct3D initialization failed&quot;);
135     }
136 
137     return pMgr != 0;
138 }
139 
140 
141 JNIEXPORT jstring JNICALL Java_com_sun_prism_d3d_D3DPipeline_nGetErrorMessage(JNIEnv *jEnv, jclass) {
142     const char * msg = D3DPipelineManager::GetErrorMessage();
143     return msg ? jEnv-&gt;NewStringUTF(msg) : 0;
144 }
145 
146 /*
147  * Class:     com_sun_prism_d3d_D3DPipeline
148  * Method:    nDispose
149  */
150 
151 JNIEXPORT void JNICALL Java_com_sun_prism_d3d_D3DPipeline_nDispose(JNIEnv *pEnv, jclass)
152 {
153     TraceLn(NWT_TRACE_INFO, &quot;D3DPipeline_nDispose&quot;);
154     if (D3DPipelineManager::GetInstance()) {
155         D3DPipelineManager::DeleteInstance();
156     }




157 }
158 
159 
160 JNIEXPORT jint JNICALL Java_com_sun_prism_d3d_D3DPipeline_nGetAdapterOrdinal(JNIEnv *, jclass, jlong hMonitor) {
161     D3DPipelineManager *pMgr = D3DPipelineManager::GetInstance();
162     if (!pMgr) {
163         return 0;
164     }
165     return pMgr-&gt;GetAdapterOrdinalByHmon(HMONITOR(hMonitor));
166 }
167 
168 JNIEXPORT jint JNICALL Java_com_sun_prism_d3d_D3DPipeline_nGetAdapterCount(JNIEnv *, jclass) {
169     D3DPipelineManager *pMgr = D3DPipelineManager::GetInstance();
170     if (!pMgr) {
171         return 0;
172     }
173     return pMgr-&gt;GetAdapterCount();
174 }
175 
176 static const char jStringField[]  = &quot;Ljava/lang/String;&quot;;
</pre>
</td>
<td>
<hr />
<pre>
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &quot;D3DPipeline.h&quot;
 27 #include &quot;com_sun_prism_d3d_D3DPipeline.h&quot;
 28 #include &quot;D3DPipelineManager.h&quot;
 29 
 30 
 31 // d3d9.dll library dynamic load
 32 HMODULE hLibD3D9 = 0;
 33 typedef IDirect3D9 * WINAPI FnDirect3DCreate9(UINT SDKVersion);
 34 typedef HRESULT WINAPI FnDirect3DCreate9Ex(UINT SDKVersion, IDirect3D9Ex**);
 35 
 36 FnDirect3DCreate9 * pD3D9FactoryFunction = 0;
 37 FnDirect3DCreate9Ex * pD3D9FactoryExFunction = 0;
 38 
<span class="line-modified"> 39 static jboolean checkAndClearException(JNIEnv *env) {</span>


 40     if (!env-&gt;ExceptionCheck()) {
 41         return JNI_FALSE;
 42     }
 43     env-&gt;ExceptionClear();
 44     return JNI_TRUE;
 45 }
 46 
 47 void loadD3DLibrary() {
 48     wchar_t path[MAX_PATH];
 49     if (::GetSystemDirectory(path, sizeof(path) / sizeof(wchar_t)) != 0) {
 50         wcscat_s(path, MAX_PATH-1, L&quot;\\d3d9.dll&quot;);
 51         hLibD3D9 = ::LoadLibrary(path);
 52     }
 53     if (hLibD3D9) {
 54         pD3D9FactoryFunction = (FnDirect3DCreate9*)GetProcAddress(hLibD3D9, &quot;Direct3DCreate9&quot;);
 55         pD3D9FactoryExFunction = (FnDirect3DCreate9Ex*)GetProcAddress(hLibD3D9, &quot;Direct3DCreate9Ex&quot;);
 56     }
 57 }
 58 
 59 void freeD3DLibrary() {
 60     if (hLibD3D9) {
 61         ::FreeLibrary(hLibD3D9);
 62         hLibD3D9 = 0;
 63         pD3D9FactoryFunction = 0;
 64         pD3D9FactoryExFunction = 0;
 65     }
 66 }
 67 
 68 IDirect3D9 * Direct3DCreate9() {
 69     return pD3D9FactoryFunction ? pD3D9FactoryFunction(D3D_SDK_VERSION) : 0;
 70 }
 71 
 72 IDirect3D9Ex * Direct3DCreate9Ex() {
 73     IDirect3D9Ex * pD3D = 0;
 74     HRESULT hr = pD3D9FactoryExFunction ? pD3D9FactoryExFunction(D3D_SDK_VERSION, &amp;pD3D) : E_FAIL;
 75     return SUCCEEDED(hr) ? pD3D : 0;
 76 }
 77 
<span class="line-added"> 78 #ifndef STATIC_BUILD</span>
 79 BOOL APIENTRY DllMain( HANDLE hModule,
 80                        DWORD  ul_reason_for_call,
 81                        LPVOID lpReserved)
 82 {
 83     switch (ul_reason_for_call) {
 84     case DLL_PROCESS_ATTACH:
 85         loadD3DLibrary();
 86         break;
 87     case DLL_PROCESS_DETACH:
 88         freeD3DLibrary();
 89         break;
 90     }
 91     return TRUE;
 92 }
<span class="line-added"> 93 #endif // STATIC_BUILD</span>
 94 
 95 struct ConfigJavaStaticClass : IConfig {
 96     JNIEnv *_env; jclass _psClass;
 97     ConfigJavaStaticClass(JNIEnv *env, jclass psClass)  :
 98     _env(env), _psClass(psClass) {}
 99 
100     virtual int getInt(cstr name) {
101         jfieldID id = _env-&gt;GetStaticFieldID(_psClass, name, &quot;I&quot;);
102         return id ? _env-&gt;GetStaticIntField(_psClass, id) : 0;
103     }
104 
105     virtual bool getBool(cstr name) {
106         jfieldID id = _env-&gt;GetStaticFieldID(_psClass, name, &quot;Z&quot;);
107         return id &amp;&amp; _env-&gt;GetStaticBooleanField(_psClass, id);
108     }
109 
110 };
111 
112 /*
113  * Class:     com_sun_prism_d3d_D3DPipeline
114  * Method:    nInit
115  */
116 
117 JNIEXPORT jboolean JNICALL Java_com_sun_prism_d3d_D3DPipeline_nInit
118   (JNIEnv *env, jclass, jclass psClass)
119 {
120     if (D3DPipelineManager::GetInstance()) {
121         D3DPipelineManager::SetErrorMessage(&quot;Double D3DPipelineManager initialization&quot;);
122         return false;
123     }
124 
125     if (FAILED(D3DPipelineManager::CheckOSVersion())) {
126         D3DPipelineManager::SetErrorMessage(&quot;Wrong operating system version&quot;);
127         return false;
128     }
129 
<span class="line-added">130 #ifdef STATIC_BUILD</span>
<span class="line-added">131     loadD3DLibrary();</span>
<span class="line-added">132 #endif // STATIC_BUILD</span>
<span class="line-added">133 </span>
134     TraceLn(NWT_TRACE_INFO, &quot;D3DPipeline_nInit&quot;);
135     D3DPipelineManager *pMgr = D3DPipelineManager::CreateInstance(ConfigJavaStaticClass(env, psClass));
136 
137     if (!pMgr &amp;&amp; !D3DPipelineManager::GetErrorMessage()) {
138         D3DPipelineManager::SetErrorMessage(&quot;Direct3D initialization failed&quot;);
139     }
140 
141     return pMgr != 0;
142 }
143 
144 
145 JNIEXPORT jstring JNICALL Java_com_sun_prism_d3d_D3DPipeline_nGetErrorMessage(JNIEnv *jEnv, jclass) {
146     const char * msg = D3DPipelineManager::GetErrorMessage();
147     return msg ? jEnv-&gt;NewStringUTF(msg) : 0;
148 }
149 
150 /*
151  * Class:     com_sun_prism_d3d_D3DPipeline
152  * Method:    nDispose
153  */
154 
155 JNIEXPORT void JNICALL Java_com_sun_prism_d3d_D3DPipeline_nDispose(JNIEnv *pEnv, jclass)
156 {
157     TraceLn(NWT_TRACE_INFO, &quot;D3DPipeline_nDispose&quot;);
158     if (D3DPipelineManager::GetInstance()) {
159         D3DPipelineManager::DeleteInstance();
160     }
<span class="line-added">161 </span>
<span class="line-added">162 #ifdef STATIC_BUILD</span>
<span class="line-added">163     freeD3DLibrary();</span>
<span class="line-added">164 #endif // STATIC_BUILD</span>
165 }
166 
167 
168 JNIEXPORT jint JNICALL Java_com_sun_prism_d3d_D3DPipeline_nGetAdapterOrdinal(JNIEnv *, jclass, jlong hMonitor) {
169     D3DPipelineManager *pMgr = D3DPipelineManager::GetInstance();
170     if (!pMgr) {
171         return 0;
172     }
173     return pMgr-&gt;GetAdapterOrdinalByHmon(HMONITOR(hMonitor));
174 }
175 
176 JNIEXPORT jint JNICALL Java_com_sun_prism_d3d_D3DPipeline_nGetAdapterCount(JNIEnv *, jclass) {
177     D3DPipelineManager *pMgr = D3DPipelineManager::GetInstance();
178     if (!pMgr) {
179         return 0;
180     }
181     return pMgr-&gt;GetAdapterCount();
182 }
183 
184 static const char jStringField[]  = &quot;Ljava/lang/String;&quot;;
</pre>
</td>
</tr>
</table>
<center><a href="../native-glass/win/Utils.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="D3DShader.cc.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>