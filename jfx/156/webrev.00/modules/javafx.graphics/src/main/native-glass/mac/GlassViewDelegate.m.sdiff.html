<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.graphics/src/main/native-glass/mac/GlassViewDelegate.m</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="GlassViewDelegate.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>modules/javafx.graphics/src/main/native-glass/mac/GlassViewDelegate.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  52 #else
  53     #define LOG(MSG, ...) GLASS_LOG(MSG, ## __VA_ARGS__);
  54 #endif
  55 
  56 //#define DNDVERBOSE
  57 #ifndef DNDVERBOSE
  58     #define DNDLOG(MSG, ...)
  59 #else
  60     #define DNDLOG(MSG, ...) GLASS_LOG(MSG, ## __VA_ARGS__);
  61 #endif
  62 
  63 // used Safari as a reference while dragging large images
  64 #define MAX_DRAG_SIZE 400
  65 
  66 // explicitly set image size
  67 #define DEFAULT_DRAG_SIZE 64
  68 
  69 // Tracks pressed modifier keys
  70 static NSUInteger s_modifierFlags = 0;
  71 





  72 // Extracted from class-dump utility output for NSEvent class
  73 @interface NSEvent (hidden)
  74 
  75 - (long long)_scrollPhase;
  76 - (unsigned long long)momentumPhase;
  77 @end
  78 
  79 
  80 static jboolean isInertialScroll(NSEvent *theEvent)
  81 {
  82     enum
  83     {
  84         SelectorNotSet,
  85         MomentumPhaseSelector,
  86         ScrollPhaseSelector,
  87         SelectorNotAvailable
  88     };
  89 
  90     static int selector = SelectorNotSet;
  91 
</pre>
<hr />
<pre>
 133     }
 134     return 0;
 135 }
 136 
 137 
 138 @implementation GlassViewDelegate
 139 
 140 - (id)initWithView:(NSView*)view withJview:(jobject)jview
 141 {
 142     self = [super init];
 143     if (self != nil)
 144     {
 145         GET_MAIN_JENV;
 146 
 147         self-&gt;nsView = view;
 148         self-&gt;jView = (*env)-&gt;NewGlobalRef(env, jview);
 149         self-&gt;mouseIsOver = NO;
 150         self-&gt;mouseDownMask = 0;
 151 
 152         self-&gt;gestureInProgress = NO;

 153 
 154         self-&gt;nativeFullScreenModeWindow = nil;
 155 
 156         // optimization
 157         [self-&gt;nsView allocateGState];
 158 
 159                 // register for drag and drop
 160                 [self-&gt;nsView registerForDraggedTypes:[NSArray arrayWithObjects:        NSPasteboardTypeString,
 161                                                                                 NSPasteboardTypeTIFF,
 162                                                                                    NSPasteboardTypeRTF,
 163                                                                                    NSPasteboardTypeTabularText,
 164                                                                                    NSPasteboardTypeFont,
 165                                                                                    NSPasteboardTypeRuler,
 166                                                                                    NSPasteboardTypeColor,
 167                                                                                    NSPasteboardTypeRTFD,
 168                                                                                    NSPasteboardTypeHTML,
 169                                                                                    NSPasteboardTypePDF,
 170                                                                                    NSPasteboardTypeMultipleTextSelection,
 171                                                                                    (NSString*)kUTTypeURL,
 172                                                                                    (NSString*)kUTTypeFileURL,
</pre>
<hr />
<pre>
 828     NSPoint viewPoint = [nsView convertPoint:[theEvent locationInWindow] fromView:nil]; // convert from window coordinates to view coordinates
 829     CGPoint basePoint = CGEventGetLocation([theEvent CGEvent]);
 830 
 831     jint modifiers = GetJavaModifiers(theEvent);
 832 
 833     GET_MAIN_JENV;
 834     const jclass jGestureSupportClass = [GlassHelper ClassForName:&quot;com.sun.glass.ui.mac.MacGestureSupport&quot;
 835                                                           withEnv:env];
 836     if (jGestureSupportClass)
 837     {
 838         (*env)-&gt;CallStaticVoidMethod(env, jGestureSupportClass,
 839                                      javaIDs.GestureSupport.gestureFinished,
 840                                      self-&gt;jView, modifiers,
 841                                      (jint)viewPoint.x, (jint)viewPoint.y,
 842                                      (jint)basePoint.x, (jint)basePoint.y);
 843 
 844     }
 845     GLASS_CHECK_EXCEPTION(env);
 846 }
 847 


































































 848 - (NSDragOperation)sendJavaDndEvent:(id &lt;NSDraggingInfo&gt;)info type:(jint)type
 849 {
 850     GET_MAIN_JENV;
 851 
 852     NSPoint draggingLocation = [nsView convertPoint:[info draggingLocation] fromView:nil];
 853     int x = (int)draggingLocation.x;
 854     int y = (int)draggingLocation.y;
 855 
 856     int xAbs = (int)([info draggingLocation].x + [self-&gt;nsView window].frame.origin.x);
 857     int yAbs = (int)([[self-&gt;nsView window] screen].frame.size.height - [self-&gt;nsView window].frame.origin.y
 858                      - [info draggingLocation].y);
 859 
 860     int mask;
 861     NSDragOperation operation = [info draggingSourceOperationMask];
 862 
 863     [GlassDragSource setSupportedActions:[GlassDragSource mapNsOperationToJavaMask:operation]];
 864 
 865     jint recommendedAction = [GlassDragSource getRecommendedActionForMask:operation];
 866     switch (type)
 867     {
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  52 #else
  53     #define LOG(MSG, ...) GLASS_LOG(MSG, ## __VA_ARGS__);
  54 #endif
  55 
  56 //#define DNDVERBOSE
  57 #ifndef DNDVERBOSE
  58     #define DNDLOG(MSG, ...)
  59 #else
  60     #define DNDLOG(MSG, ...) GLASS_LOG(MSG, ## __VA_ARGS__);
  61 #endif
  62 
  63 // used Safari as a reference while dragging large images
  64 #define MAX_DRAG_SIZE 400
  65 
  66 // explicitly set image size
  67 #define DEFAULT_DRAG_SIZE 64
  68 
  69 // Tracks pressed modifier keys
  70 static NSUInteger s_modifierFlags = 0;
  71 
<span class="line-added">  72 @interface GlassViewDelegate (hidden)</span>
<span class="line-added">  73 - (void)maybeBeginGestureWithEvent:(NSEvent *)theEvent withMask:(GestureMaskType)theMask;</span>
<span class="line-added">  74 - (void)maybeEndGestureWithEvent:(NSEvent *)theEvent withMask:(GestureMaskType)theMask;</span>
<span class="line-added">  75 @end</span>
<span class="line-added">  76 </span>
  77 // Extracted from class-dump utility output for NSEvent class
  78 @interface NSEvent (hidden)
  79 
  80 - (long long)_scrollPhase;
  81 - (unsigned long long)momentumPhase;
  82 @end
  83 
  84 
  85 static jboolean isInertialScroll(NSEvent *theEvent)
  86 {
  87     enum
  88     {
  89         SelectorNotSet,
  90         MomentumPhaseSelector,
  91         ScrollPhaseSelector,
  92         SelectorNotAvailable
  93     };
  94 
  95     static int selector = SelectorNotSet;
  96 
</pre>
<hr />
<pre>
 138     }
 139     return 0;
 140 }
 141 
 142 
 143 @implementation GlassViewDelegate
 144 
 145 - (id)initWithView:(NSView*)view withJview:(jobject)jview
 146 {
 147     self = [super init];
 148     if (self != nil)
 149     {
 150         GET_MAIN_JENV;
 151 
 152         self-&gt;nsView = view;
 153         self-&gt;jView = (*env)-&gt;NewGlobalRef(env, jview);
 154         self-&gt;mouseIsOver = NO;
 155         self-&gt;mouseDownMask = 0;
 156 
 157         self-&gt;gestureInProgress = NO;
<span class="line-added"> 158         self-&gt;gesturesBeganMask = 0;</span>
 159 
 160         self-&gt;nativeFullScreenModeWindow = nil;
 161 
 162         // optimization
 163         [self-&gt;nsView allocateGState];
 164 
 165                 // register for drag and drop
 166                 [self-&gt;nsView registerForDraggedTypes:[NSArray arrayWithObjects:        NSPasteboardTypeString,
 167                                                                                 NSPasteboardTypeTIFF,
 168                                                                                    NSPasteboardTypeRTF,
 169                                                                                    NSPasteboardTypeTabularText,
 170                                                                                    NSPasteboardTypeFont,
 171                                                                                    NSPasteboardTypeRuler,
 172                                                                                    NSPasteboardTypeColor,
 173                                                                                    NSPasteboardTypeRTFD,
 174                                                                                    NSPasteboardTypeHTML,
 175                                                                                    NSPasteboardTypePDF,
 176                                                                                    NSPasteboardTypeMultipleTextSelection,
 177                                                                                    (NSString*)kUTTypeURL,
 178                                                                                    (NSString*)kUTTypeFileURL,
</pre>
<hr />
<pre>
 834     NSPoint viewPoint = [nsView convertPoint:[theEvent locationInWindow] fromView:nil]; // convert from window coordinates to view coordinates
 835     CGPoint basePoint = CGEventGetLocation([theEvent CGEvent]);
 836 
 837     jint modifiers = GetJavaModifiers(theEvent);
 838 
 839     GET_MAIN_JENV;
 840     const jclass jGestureSupportClass = [GlassHelper ClassForName:&quot;com.sun.glass.ui.mac.MacGestureSupport&quot;
 841                                                           withEnv:env];
 842     if (jGestureSupportClass)
 843     {
 844         (*env)-&gt;CallStaticVoidMethod(env, jGestureSupportClass,
 845                                      javaIDs.GestureSupport.gestureFinished,
 846                                      self-&gt;jView, modifiers,
 847                                      (jint)viewPoint.x, (jint)viewPoint.y,
 848                                      (jint)basePoint.x, (jint)basePoint.y);
 849 
 850     }
 851     GLASS_CHECK_EXCEPTION(env);
 852 }
 853 
<span class="line-added"> 854 /*</span>
<span class="line-added"> 855  * This method is a replacement for the deprecated beginGestureWithEvent</span>
<span class="line-added"> 856  * method, which is no longer delivered to a View by macOS. This</span>
<span class="line-added"> 857  * is called for each gesture event to track the beginning of a</span>
<span class="line-added"> 858  * gesture using the phase of the event. We call sendJavaGestureBeginEvent</span>
<span class="line-added"> 859  * if there are no other gestures active.</span>
<span class="line-added"> 860  */</span>
<span class="line-added"> 861 - (void)maybeBeginGestureWithEvent:(NSEvent *)theEvent withMask:(GestureMaskType)theMask</span>
<span class="line-added"> 862 {</span>
<span class="line-added"> 863     NSEventPhase phase = [theEvent phase];</span>
<span class="line-added"> 864     if (phase == NSEventPhaseBegan) {</span>
<span class="line-added"> 865         if (gesturesBeganMask == 0) {</span>
<span class="line-added"> 866             [self sendJavaGestureBeginEvent:theEvent];</span>
<span class="line-added"> 867         }</span>
<span class="line-added"> 868         gesturesBeganMask |= theMask;</span>
<span class="line-added"> 869     }</span>
<span class="line-added"> 870 }</span>
<span class="line-added"> 871 </span>
<span class="line-added"> 872 /*</span>
<span class="line-added"> 873  * This method is a replacement for the deprecated endGestureWithEvent</span>
<span class="line-added"> 874  * method, which is no longer delivered to a View by macOS. This</span>
<span class="line-added"> 875  * is called for each gesture event to track the end of a</span>
<span class="line-added"> 876  * gesture using the phase of the event. We call sendJavaGestureEndEvent</span>
<span class="line-added"> 877  * if there are no other gestures active.</span>
<span class="line-added"> 878  */</span>
<span class="line-added"> 879 - (void)maybeEndGestureWithEvent:(NSEvent *)theEvent withMask:(GestureMaskType)theMask</span>
<span class="line-added"> 880 {</span>
<span class="line-added"> 881     NSEventPhase phase = [theEvent phase];</span>
<span class="line-added"> 882     if (phase == NSEventPhaseEnded || phase == NSEventPhaseCancelled) {</span>
<span class="line-added"> 883         if ((gesturesBeganMask &amp; theMask) != 0) {</span>
<span class="line-added"> 884             gesturesBeganMask &amp;= ~theMask;</span>
<span class="line-added"> 885             if (gesturesBeganMask == 0) {</span>
<span class="line-added"> 886                 [self sendJavaGestureEndEvent:theEvent];</span>
<span class="line-added"> 887             }</span>
<span class="line-added"> 888         }</span>
<span class="line-added"> 889     }</span>
<span class="line-added"> 890 }</span>
<span class="line-added"> 891 </span>
<span class="line-added"> 892 - (void)doRotateWithEvent:(NSEvent *)theEvent</span>
<span class="line-added"> 893 {</span>
<span class="line-added"> 894     [self maybeBeginGestureWithEvent:theEvent withMask:GESTURE_MASK_ROTATE];</span>
<span class="line-added"> 895     [self sendJavaGestureEvent:theEvent type:com_sun_glass_ui_mac_MacGestureSupport_GESTURE_ROTATE];</span>
<span class="line-added"> 896     [self maybeEndGestureWithEvent:theEvent withMask:GESTURE_MASK_ROTATE];</span>
<span class="line-added"> 897 }</span>
<span class="line-added"> 898 </span>
<span class="line-added"> 899 - (void)doSwipeWithEvent:(NSEvent *)theEvent</span>
<span class="line-added"> 900 {</span>
<span class="line-added"> 901     [self maybeBeginGestureWithEvent:theEvent withMask:GESTURE_MASK_SWIPE];</span>
<span class="line-added"> 902     [self sendJavaGestureEvent:theEvent type:com_sun_glass_ui_mac_MacGestureSupport_GESTURE_SWIPE];</span>
<span class="line-added"> 903     [self maybeEndGestureWithEvent:theEvent withMask:GESTURE_MASK_SWIPE];</span>
<span class="line-added"> 904 }</span>
<span class="line-added"> 905 </span>
<span class="line-added"> 906 - (void)doMagnifyWithEvent:(NSEvent *)theEvent</span>
<span class="line-added"> 907 {</span>
<span class="line-added"> 908     [self maybeBeginGestureWithEvent:theEvent withMask:GESTURE_MASK_MAGNIFY];</span>
<span class="line-added"> 909     [self sendJavaGestureEvent:theEvent type:com_sun_glass_ui_mac_MacGestureSupport_GESTURE_MAGNIFY];</span>
<span class="line-added"> 910     [self maybeEndGestureWithEvent:theEvent withMask:GESTURE_MASK_MAGNIFY];</span>
<span class="line-added"> 911 }</span>
<span class="line-added"> 912 </span>
<span class="line-added"> 913 - (void)doScrollWheel:(NSEvent *)theEvent</span>
<span class="line-added"> 914 {</span>
<span class="line-added"> 915     [self maybeBeginGestureWithEvent:theEvent withMask:GESTURE_MASK_SCROLL];</span>
<span class="line-added"> 916     [self sendJavaMouseEvent:theEvent];</span>
<span class="line-added"> 917     [self maybeEndGestureWithEvent:theEvent withMask:GESTURE_MASK_SCROLL];</span>
<span class="line-added"> 918 }</span>
<span class="line-added"> 919 </span>
 920 - (NSDragOperation)sendJavaDndEvent:(id &lt;NSDraggingInfo&gt;)info type:(jint)type
 921 {
 922     GET_MAIN_JENV;
 923 
 924     NSPoint draggingLocation = [nsView convertPoint:[info draggingLocation] fromView:nil];
 925     int x = (int)draggingLocation.x;
 926     int y = (int)draggingLocation.y;
 927 
 928     int xAbs = (int)([info draggingLocation].x + [self-&gt;nsView window].frame.origin.x);
 929     int yAbs = (int)([[self-&gt;nsView window] screen].frame.size.height - [self-&gt;nsView window].frame.origin.y
 930                      - [info draggingLocation].y);
 931 
 932     int mask;
 933     NSDragOperation operation = [info draggingSourceOperationMask];
 934 
 935     [GlassDragSource setSupportedActions:[GlassDragSource mapNsOperationToJavaMask:operation]];
 936 
 937     jint recommendedAction = [GlassDragSource getRecommendedActionForMask:operation];
 938     switch (type)
 939     {
</pre>
</td>
</tr>
</table>
<center><a href="GlassViewDelegate.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>