<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/java/com/sun/javafx/webkit/theme/ScrollBarThemeImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollBarWidget.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/java/com/sun/javafx/webkit/theme/ScrollBarThemeImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 31 import com.sun.javafx.logging.PlatformLogger.Level;
 32 import javafx.beans.Observable;
 33 import javafx.geometry.Bounds;
 34 import javafx.geometry.Orientation;
 35 import javafx.scene.Node;
 36 import javafx.scene.control.Control;
 37 import javafx.scene.control.ScrollBar;
 38 
 39 import com.sun.webkit.graphics.Ref;
 40 import com.sun.webkit.graphics.ScrollBarTheme;
 41 import com.sun.webkit.graphics.WCGraphicsContext;
 42 import com.sun.javafx.webkit.Accessor;
 43 import com.sun.javafx.webkit.theme.RenderThemeImpl.Pool;
 44 import com.sun.javafx.webkit.theme.RenderThemeImpl.ViewListener;
 45 import com.sun.webkit.graphics.WCSize;
 46 
 47 public final class ScrollBarThemeImpl extends ScrollBarTheme {
 48 
 49     private final static PlatformLogger log = PlatformLogger.getLogger(ScrollBarThemeImpl.class.getName());
 50 
<span class="line-removed"> 51     private WeakReference&lt;ScrollBar&gt; testSBRef = // used for scrollbar thickness calculation</span>
<span class="line-removed"> 52             new WeakReference&lt;ScrollBar&gt;(null);</span>
<span class="line-removed"> 53 </span>
 54     private final Accessor accessor;
 55 
 56     private final Pool&lt;ScrollBarWidget&gt; pool;
 57 
 58     private static final class ScrollBarRef extends Ref {
 59         private final WeakReference&lt;ScrollBarWidget&gt; sbRef;
 60 
 61         private ScrollBarRef(ScrollBarWidget sb) {
 62             this.sbRef = new WeakReference&lt;ScrollBarWidget&gt;(sb);
 63         }
 64 
 65         private Control asControl() {
 66             return sbRef.get();
 67         }
 68     }
 69 
 70     /*
 71      * Note, the class should be instantiated no later than
 72      * the appropriate page is created to ensure &#39;testSB&#39;
 73      * is added to the view before paiting starts.
 74      */
 75     public ScrollBarThemeImpl(final Accessor accessor) {
 76         this.accessor = accessor;
 77         pool = new Pool&lt;ScrollBarWidget&gt;(
 78                 sb -&gt; {
 79                     accessor.removeChild(sb);
 80                 }, ScrollBarWidget.class);
 81         accessor.addViewListener(new ViewListener(pool, accessor) {
 82             @Override public void invalidated(Observable ov) {
 83                 super.invalidated(ov);
<span class="line-modified"> 84                 ScrollBar testSB = new ScrollBarWidget(ScrollBarThemeImpl.this);</span>
 85                 // testSB should be added to the new WebView (if any)
 86                 accessor.addChild(testSB);
<span class="line-removed"> 87                 testSBRef = new WeakReference&lt;ScrollBar&gt;(testSB);</span>
 88             }
 89         });
 90 
 91     }
 92 
<span class="line-removed"> 93     ScrollBar getTestSBRef() {</span>
<span class="line-removed"> 94         return testSBRef.get();</span>
<span class="line-removed"> 95     }</span>
<span class="line-removed"> 96 </span>
 97     private static Orientation convertOrientation(int orientation) {
 98         return orientation == VERTICAL_SCROLLBAR ? Orientation.VERTICAL : Orientation.HORIZONTAL;
 99     }
100 
101     private void adjustScrollBar(ScrollBar sb, int w, int h, int orientation) {
102         Orientation current = convertOrientation(orientation);
103         if (current != sb.getOrientation()) {
104             sb.setOrientation(current);
105         }
106 
107         if (current == Orientation.VERTICAL) {
108             w = ScrollBarTheme.getThickness();
109         } else {
110             h = ScrollBarTheme.getThickness();
111         }
112 
113         if ((w != sb.getWidth()) || (h != sb.getHeight())) {
114             sb.resize(w, h);
115         }
116     }
</pre>
<hr />
<pre>
139         // For FX ScrollBar the following is true:
140         //   [min &lt;= value &lt;= max] &amp; [min &lt;= visibleAmount &lt;= max]
141         // But webkit assumes that:
142         //   [0 &lt;= value &lt;= totalSize - visibleAmount]
143         // So, we calculate a factor from the following equation:
144         //   (totalSize - visibleSize) * factor = totalSize
145         if (totalSize &gt; visibleSize) {
146             float factor = ((float)totalSize) / (totalSize - visibleSize);
147             if (sb.getValue() != value * factor) {
148                 sb.setValue(value * factor); // eventually set &#39;value&#39;
149             }
150         }
151     }
152 
153     @Override protected Ref createWidget(long id, int w, int h, int orientation,
154                                          int value, int visibleSize,
155                                          int totalSize)
156     {
157         ScrollBarWidget sb = pool.get(id);
158         if (sb == null) {
<span class="line-modified">159             sb = new ScrollBarWidget(this);</span>
160             pool.put(id, sb, accessor.getPage().getUpdateContentCycleID());
161             accessor.addChild(sb);
162         }
163         adjustScrollBar(sb, w, h, orientation, value, visibleSize, totalSize);
164         return new ScrollBarRef(sb);
165     }
166 
167     @Override public void paint(WCGraphicsContext g, Ref sbRef,
168                                 int x, int y, int pressedPart, int hoveredPart)
169     {
170         ScrollBar sb = (ScrollBar)((ScrollBarRef)sbRef).asControl();
171         if (sb == null) {
172             return;
173         }
174 
175         if (log.isLoggable(Level.FINEST)) {
176             log.finest(&quot;[{0}, {1} {2}x{3}], {4}&quot;,
177                     new Object[] {x, y, sb.getWidth(), sb.getHeight(),
178                     sb.getOrientation() == Orientation.VERTICAL ? &quot;VERTICAL&quot; : &quot;HORIZONTAL&quot;});
179         }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 31 import com.sun.javafx.logging.PlatformLogger.Level;
 32 import javafx.beans.Observable;
 33 import javafx.geometry.Bounds;
 34 import javafx.geometry.Orientation;
 35 import javafx.scene.Node;
 36 import javafx.scene.control.Control;
 37 import javafx.scene.control.ScrollBar;
 38 
 39 import com.sun.webkit.graphics.Ref;
 40 import com.sun.webkit.graphics.ScrollBarTheme;
 41 import com.sun.webkit.graphics.WCGraphicsContext;
 42 import com.sun.javafx.webkit.Accessor;
 43 import com.sun.javafx.webkit.theme.RenderThemeImpl.Pool;
 44 import com.sun.javafx.webkit.theme.RenderThemeImpl.ViewListener;
 45 import com.sun.webkit.graphics.WCSize;
 46 
 47 public final class ScrollBarThemeImpl extends ScrollBarTheme {
 48 
 49     private final static PlatformLogger log = PlatformLogger.getLogger(ScrollBarThemeImpl.class.getName());
 50 



 51     private final Accessor accessor;
 52 
 53     private final Pool&lt;ScrollBarWidget&gt; pool;
 54 
 55     private static final class ScrollBarRef extends Ref {
 56         private final WeakReference&lt;ScrollBarWidget&gt; sbRef;
 57 
 58         private ScrollBarRef(ScrollBarWidget sb) {
 59             this.sbRef = new WeakReference&lt;ScrollBarWidget&gt;(sb);
 60         }
 61 
 62         private Control asControl() {
 63             return sbRef.get();
 64         }
 65     }
 66 
 67     /*
 68      * Note, the class should be instantiated no later than
 69      * the appropriate page is created to ensure &#39;testSB&#39;
 70      * is added to the view before paiting starts.
 71      */
 72     public ScrollBarThemeImpl(final Accessor accessor) {
 73         this.accessor = accessor;
 74         pool = new Pool&lt;ScrollBarWidget&gt;(
 75                 sb -&gt; {
 76                     accessor.removeChild(sb);
 77                 }, ScrollBarWidget.class);
 78         accessor.addViewListener(new ViewListener(pool, accessor) {
 79             @Override public void invalidated(Observable ov) {
 80                 super.invalidated(ov);
<span class="line-modified"> 81                 ScrollBar testSB = new ScrollBarWidget();</span>
 82                 // testSB should be added to the new WebView (if any)
 83                 accessor.addChild(testSB);

 84             }
 85         });
 86 
 87     }
 88 




 89     private static Orientation convertOrientation(int orientation) {
 90         return orientation == VERTICAL_SCROLLBAR ? Orientation.VERTICAL : Orientation.HORIZONTAL;
 91     }
 92 
 93     private void adjustScrollBar(ScrollBar sb, int w, int h, int orientation) {
 94         Orientation current = convertOrientation(orientation);
 95         if (current != sb.getOrientation()) {
 96             sb.setOrientation(current);
 97         }
 98 
 99         if (current == Orientation.VERTICAL) {
100             w = ScrollBarTheme.getThickness();
101         } else {
102             h = ScrollBarTheme.getThickness();
103         }
104 
105         if ((w != sb.getWidth()) || (h != sb.getHeight())) {
106             sb.resize(w, h);
107         }
108     }
</pre>
<hr />
<pre>
131         // For FX ScrollBar the following is true:
132         //   [min &lt;= value &lt;= max] &amp; [min &lt;= visibleAmount &lt;= max]
133         // But webkit assumes that:
134         //   [0 &lt;= value &lt;= totalSize - visibleAmount]
135         // So, we calculate a factor from the following equation:
136         //   (totalSize - visibleSize) * factor = totalSize
137         if (totalSize &gt; visibleSize) {
138             float factor = ((float)totalSize) / (totalSize - visibleSize);
139             if (sb.getValue() != value * factor) {
140                 sb.setValue(value * factor); // eventually set &#39;value&#39;
141             }
142         }
143     }
144 
145     @Override protected Ref createWidget(long id, int w, int h, int orientation,
146                                          int value, int visibleSize,
147                                          int totalSize)
148     {
149         ScrollBarWidget sb = pool.get(id);
150         if (sb == null) {
<span class="line-modified">151             sb = new ScrollBarWidget();</span>
152             pool.put(id, sb, accessor.getPage().getUpdateContentCycleID());
153             accessor.addChild(sb);
154         }
155         adjustScrollBar(sb, w, h, orientation, value, visibleSize, totalSize);
156         return new ScrollBarRef(sb);
157     }
158 
159     @Override public void paint(WCGraphicsContext g, Ref sbRef,
160                                 int x, int y, int pressedPart, int hoveredPart)
161     {
162         ScrollBar sb = (ScrollBar)((ScrollBarRef)sbRef).asControl();
163         if (sb == null) {
164             return;
165         }
166 
167         if (log.isLoggable(Level.FINEST)) {
168             log.finest(&quot;[{0}, {1} {2}x{3}], {4}&quot;,
169                     new Object[] {x, y, sb.getWidth(), sb.getHeight(),
170                     sb.getOrientation() == Orientation.VERTICAL ? &quot;VERTICAL&quot; : &quot;HORIZONTAL&quot;});
171         }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ScrollBarWidget.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>