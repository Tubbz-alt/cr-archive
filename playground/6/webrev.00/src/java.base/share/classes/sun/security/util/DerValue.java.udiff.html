<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/util/DerValue.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="DerOutputStream.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="NamedCurve.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/util/DerValue.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -60,20 +60,17 @@</span>
      public static final byte TAG_UNIVERSAL = (byte)0x000;
      public static final byte TAG_APPLICATION = (byte)0x040;
      public static final byte TAG_CONTEXT = (byte)0x080;
      public static final byte TAG_PRIVATE = (byte)0x0c0;
  
<span class="udiff-line-modified-removed">-     /** The DER tag of the value; one of the tag_ constants. */</span>
<span class="udiff-line-modified-added">+     // tag of the value</span>
      public byte                 tag;
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+     // A ByteArrayOutputStream of content</span>
      protected DerInputBuffer    buffer;
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * The DER-encoded data of the value, never null</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-modified-added">+     // Always new DerInputStream(buffer)</span>
      public final DerInputStream data;
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+     // The length of the value. Always the same as buffer.count.</span>
      private int                 length;
  
      /*
       * The type starts at the first byte of the encoding, and
       * is one of these tag_* values.  That may be all the type
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -213,12 +210,12 @@</span>
              if (!isPrintableStringChar(value.charAt(i))) {
                  isPrintableString = false;
                  break;
              }
          }
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         data = init(isPrintableString ? tag_PrintableString : tag_UTF8String, value);</span>
<span class="udiff-line-modified-added">+         data = init(isPrintableString</span>
<span class="udiff-line-modified-added">+                 ? tag_PrintableString : tag_UTF8String, value);</span>
      }
  
      /**
       * Creates a string type DER value from a String object
       * @param stringTag the tag for the DER value to create
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -273,11 +270,10 @@</span>
              // indefinite form is encoded by sending a length field with a
              // length of 0. - i.e. [1000|0000].
              // the object is ended by sending two zero bytes.
              in.skip(length + 2);
          } else {
<span class="udiff-line-removed">- </span>
              buffer = in.dup();
              buffer.truncate(length);
              data = new DerInputStream(buffer);
  
              in.skip(length);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -302,11 +298,11 @@</span>
      }
  
      // Get an ASN.1/DER encoded datum from part of a buffer w/ additional
      // arg to control whether DER checks are enforced.
      DerValue(byte[] buf, int offset, int len, boolean allowBER)
<span class="udiff-line-modified-removed">-         throws IOException {</span>
<span class="udiff-line-modified-added">+             throws IOException {</span>
          data = init(true, new ByteArrayInputStream(buf, offset, len), allowBER);
      }
  
      /**
       * Get an ASN.1/DER encoded datum from part of a buffer.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -376,48 +372,53 @@</span>
  
      /*
       * helper routine
       */
      private DerInputStream init(boolean fullyBuffered, InputStream in,
<span class="udiff-line-modified-removed">-         boolean allowBER) throws IOException {</span>
<span class="udiff-line-modified-added">+             boolean allowBER) throws IOException {</span>
  
          tag = (byte)in.read();
          byte lenByte = (byte)in.read();
          length = DerInputStream.getLength(lenByte, in);
          if (length == -1) { // indefinite length encoding found
              in = new ByteArrayInputStream(
                      DerIndefLenConverter.convertStream(in, lenByte, tag));
<span class="udiff-line-modified-removed">-             if (tag != in.read())</span>
<span class="udiff-line-modified-added">+             if (tag != in.read()) {</span>
                  throw new IOException
                          (&quot;Indefinite length encoding not supported&quot;);
<span class="udiff-line-added">+             }</span>
              length = DerInputStream.getDefiniteLength(in);
          }
  
<span class="udiff-line-modified-removed">-         if (fullyBuffered &amp;&amp; in.available() != length)</span>
<span class="udiff-line-modified-added">+         if (fullyBuffered &amp;&amp; in.available() != length) {</span>
              throw new IOException(&quot;extra data given to DerValue constructor&quot;);
<span class="udiff-line-added">+         }</span>
  
          byte[] bytes = IOUtils.readExactlyNBytes(in, length);
  
          buffer = new DerInputBuffer(bytes, allowBER);
          return new DerInputStream(buffer);
      }
  
      /**
       * Encode an ASN1/DER encoded datum onto a DER output stream.
       */
<span class="udiff-line-modified-removed">-     public void encode(DerOutputStream out)</span>
<span class="udiff-line-removed">-     throws IOException {</span>
<span class="udiff-line-modified-added">+     public void encode(DerOutputStream out) {</span>
          out.write(tag);
          out.putLength(length);
<span class="udiff-line-removed">-         // XXX yeech, excess copies ... DerInputBuffer.write(OutStream)</span>
          if (length &gt; 0) {
              byte[] value = new byte[length];
              // always synchronized on data
              synchronized (data) {
                  buffer.reset();
<span class="udiff-line-modified-removed">-                 if (buffer.read(value) != length) {</span>
<span class="udiff-line-modified-removed">-                     throw new IOException(&quot;short DER value read (encode)&quot;);</span>
<span class="udiff-line-modified-added">+                 try {</span>
<span class="udiff-line-modified-added">+                     if (buffer.read(value) != length) {</span>
<span class="udiff-line-added">+                         throw new IOException(&quot;short DER value read (encode)&quot;);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 } catch (IOException e) {</span>
<span class="udiff-line-added">+                     // buffer should always have length bytes</span>
<span class="udiff-line-added">+                     throw new AssertionError(&quot;Should not happen&quot;);</span>
                  }
                  out.write(value);
              }
          }
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -453,18 +454,20 @@</span>
       * Returns an ASN.1 OBJECT IDENTIFIER.
       *
       * @return the OID held in this DER value
       */
      public ObjectIdentifier getOID() throws IOException {
<span class="udiff-line-modified-removed">-         if (tag != tag_ObjectId)</span>
<span class="udiff-line-modified-added">+         if (tag != tag_ObjectId) {</span>
              throw new IOException(&quot;DerValue.getOID, not an OID &quot; + tag);
<span class="udiff-line-added">+         }</span>
          return new ObjectIdentifier(buffer);
      }
  
      private byte[] append(byte[] a, byte[] b) {
<span class="udiff-line-modified-removed">-         if (a == null)</span>
<span class="udiff-line-modified-added">+         if (a == null) {</span>
              return b;
<span class="udiff-line-added">+         }</span>
  
          byte[] ret = new byte[a.length + b.length];
          System.arraycopy(a, 0, ret, 0, a.length);
          System.arraycopy(b, 0, ret, a.length, b.length);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -478,11 +481,11 @@</span>
       */
      public byte[] getOctetString() throws IOException {
  
          if (tag != tag_OctetString &amp;&amp; !isConstructed(tag_OctetString)) {
              throw new IOException(
<span class="udiff-line-modified-removed">-                 &quot;DerValue.getOctetString, not an Octet String: &quot; + tag);</span>
<span class="udiff-line-modified-added">+                     &quot;DerValue.getOctetString, not an Octet String: &quot; + tag);</span>
          }
          // Note: do not attempt to call buffer.read(bytes) at all. There&#39;s a
          // known bug that it returns -1 instead of 0.
          if (length == 0) {
              return new byte[0];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -525,12 +528,13 @@</span>
       * Returns an ASN.1 INTEGER value as a BigInteger.
       *
       * @return the integer held in this DER value as a BigInteger.
       */
      public BigInteger getBigInteger() throws IOException {
<span class="udiff-line-modified-removed">-         if (tag != tag_Integer)</span>
<span class="udiff-line-modified-added">+         if (tag != tag_Integer) {</span>
              throw new IOException(&quot;DerValue.getBigInteger, not an int &quot; + tag);
<span class="udiff-line-added">+         }</span>
          return buffer.getBigInteger(data.available(), false);
      }
  
      /**
       * Returns an ASN.1 INTEGER value as a positive BigInteger.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -538,12 +542,13 @@</span>
       * some values as negative.
       *
       * @return the integer held in this DER value as a BigInteger.
       */
      public BigInteger getPositiveBigInteger() throws IOException {
<span class="udiff-line-modified-removed">-         if (tag != tag_Integer)</span>
<span class="udiff-line-modified-added">+         if (tag != tag_Integer) {</span>
              throw new IOException(&quot;DerValue.getBigInteger, not an int &quot; + tag);
<span class="udiff-line-added">+         }</span>
          return buffer.getBigInteger(data.available(), true);
      }
  
      /**
       * Returns an ASN.1 ENUMERATED value.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -562,54 +567,55 @@</span>
       * Returns an ASN.1 BIT STRING value.  The bit string must be byte-aligned.
       *
       * @return the bit string held in this value
       */
      public byte[] getBitString() throws IOException {
<span class="udiff-line-modified-removed">-         if (tag != tag_BitString)</span>
<span class="udiff-line-modified-added">+         if (tag != tag_BitString) {</span>
              throw new IOException(
<span class="udiff-line-modified-removed">-                 &quot;DerValue.getBitString, not a bit string &quot; + tag);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+                     &quot;DerValue.getBitString, not a bit string &quot; + tag);</span>
<span class="udiff-line-modified-added">+         }</span>
          return buffer.getBitString();
      }
  
      /**
       * Returns an ASN.1 BIT STRING value that need not be byte-aligned.
       *
       * @return a BitArray representing the bit string held in this value
       */
      public BitArray getUnalignedBitString() throws IOException {
<span class="udiff-line-modified-removed">-         if (tag != tag_BitString)</span>
<span class="udiff-line-modified-added">+         if (tag != tag_BitString) {</span>
              throw new IOException(
<span class="udiff-line-modified-removed">-                 &quot;DerValue.getBitString, not a bit string &quot; + tag);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+                     &quot;DerValue.getBitString, not a bit string &quot; + tag);</span>
<span class="udiff-line-modified-added">+         }</span>
          return buffer.getUnalignedBitString();
      }
  
      /**
       * Returns the name component as a Java string, regardless of its
       * encoding restrictions (ASCII, T61, Printable, IA5, BMP, UTF8).
       */
      // TBD: Need encoder for UniversalString before it can be handled.
      public String getAsString() throws IOException {
<span class="udiff-line-modified-removed">-         if (tag == tag_UTF8String)</span>
<span class="udiff-line-modified-added">+         if (tag == tag_UTF8String) {</span>
              return getUTF8String();
<span class="udiff-line-modified-removed">-         else if (tag == tag_PrintableString)</span>
<span class="udiff-line-modified-added">+         } else if (tag == tag_PrintableString) {</span>
              return getPrintableString();
<span class="udiff-line-modified-removed">-         else if (tag == tag_T61String)</span>
<span class="udiff-line-modified-added">+         } else if (tag == tag_T61String) {</span>
              return getT61String();
<span class="udiff-line-modified-removed">-         else if (tag == tag_IA5String)</span>
<span class="udiff-line-modified-added">+         } else if (tag == tag_IA5String) {</span>
              return getIA5String();
          /*
<span class="udiff-line-modified-removed">-           else if (tag == tag_UniversalString)</span>
<span class="udiff-line-modified-added">+           } else if (tag == tag_UniversalString) {</span>
            return getUniversalString();
          */
<span class="udiff-line-modified-removed">-         else if (tag == tag_BMPString)</span>
<span class="udiff-line-modified-added">+         } else if (tag == tag_BMPString) {</span>
              return getBMPString();
<span class="udiff-line-modified-removed">-         else if (tag == tag_GeneralString)</span>
<span class="udiff-line-modified-added">+         } else if (tag == tag_GeneralString) {</span>
              return getGeneralString();
<span class="udiff-line-modified-removed">-         else</span>
<span class="udiff-line-modified-added">+         } else {</span>
              return null;
<span class="udiff-line-added">+         }</span>
      }
  
      /**
       * Returns an ASN.1 BIT STRING value, with the tag assumed implicit
       * based on the parameter.  The bit string must be byte-aligned.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -617,14 +623,15 @@</span>
       * @param tagImplicit if true, the tag is assumed implicit.
       * @return the bit string held in this value
       */
      public byte[] getBitString(boolean tagImplicit) throws IOException {
          if (!tagImplicit) {
<span class="udiff-line-modified-removed">-             if (tag != tag_BitString)</span>
<span class="udiff-line-modified-added">+             if (tag != tag_BitString) {</span>
                  throw new IOException(&quot;DerValue.getBitString, not a bit string &quot;
<span class="udiff-line-modified-removed">-                                        + tag);</span>
<span class="udiff-line-modified-added">+                         + tag);</span>
              }
<span class="udiff-line-added">+         }</span>
          return buffer.getBitString();
      }
  
      /**
       * Returns an ASN.1 BIT STRING value, with the tag assumed implicit
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -632,16 +639,17 @@</span>
       *
       * @param tagImplicit if true, the tag is assumed implicit.
       * @return the bit string held in this value
       */
      public BitArray getUnalignedBitString(boolean tagImplicit)
<span class="udiff-line-modified-removed">-     throws IOException {</span>
<span class="udiff-line-modified-added">+             throws IOException {</span>
          if (!tagImplicit) {
<span class="udiff-line-modified-removed">-             if (tag != tag_BitString)</span>
<span class="udiff-line-modified-added">+             if (tag != tag_BitString) {</span>
                  throw new IOException(&quot;DerValue.getBitString, not a bit string &quot;
<span class="udiff-line-modified-removed">-                                        + tag);</span>
<span class="udiff-line-modified-added">+                         + tag);</span>
              }
<span class="udiff-line-added">+         }</span>
          return buffer.getUnalignedBitString();
      }
  
      /**
       * Helper routine to return all the bytes contained in the
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -659,86 +667,80 @@</span>
      /**
       * Returns an ASN.1 STRING value
       *
       * @return the printable string held in this value
       */
<span class="udiff-line-modified-removed">-     public String getPrintableString()</span>
<span class="udiff-line-modified-removed">-     throws IOException {</span>
<span class="udiff-line-removed">-         if (tag != tag_PrintableString)</span>
<span class="udiff-line-modified-added">+     public String getPrintableString() throws IOException {</span>
<span class="udiff-line-modified-added">+         if (tag != tag_PrintableString) {</span>
              throw new IOException(
<span class="udiff-line-modified-removed">-                 &quot;DerValue.getPrintableString, not a string &quot; + tag);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+                     &quot;DerValue.getPrintableString, not a string &quot; + tag);</span>
<span class="udiff-line-modified-added">+         }</span>
          return new String(getDataBytes(), US_ASCII);
      }
  
      /**
       * Returns an ASN.1 T61 (Teletype) STRING value
       *
       * @return the teletype string held in this value
       */
      public String getT61String() throws IOException {
<span class="udiff-line-modified-removed">-         if (tag != tag_T61String)</span>
<span class="udiff-line-modified-removed">-             throw new IOException(</span>
<span class="udiff-line-modified-removed">-                 &quot;DerValue.getT61String, not T61 &quot; + tag);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+         if (tag != tag_T61String) {</span>
<span class="udiff-line-modified-added">+             throw new IOException(&quot;DerValue.getT61String, not T61 &quot; + tag);</span>
<span class="udiff-line-modified-added">+         }</span>
          return new String(getDataBytes(), ISO_8859_1);
      }
  
      /**
       * Returns an ASN.1 IA5 (ASCII) STRING value
       *
       * @return the ASCII string held in this value
       */
      public String getIA5String() throws IOException {
<span class="udiff-line-modified-removed">-         if (tag != tag_IA5String)</span>
<span class="udiff-line-modified-removed">-             throw new IOException(</span>
<span class="udiff-line-modified-removed">-                 &quot;DerValue.getIA5String, not IA5 &quot; + tag);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+         if (tag != tag_IA5String) {</span>
<span class="udiff-line-modified-added">+             throw new IOException(&quot;DerValue.getIA5String, not IA5 &quot; + tag);</span>
<span class="udiff-line-modified-added">+         }</span>
          return new String(getDataBytes(), US_ASCII);
      }
  
      /**
       * Returns the ASN.1 BMP (Unicode) STRING value as a Java string.
       *
       * @return a string corresponding to the encoded BMPString held in
       * this value
       */
      public String getBMPString() throws IOException {
<span class="udiff-line-modified-removed">-         if (tag != tag_BMPString)</span>
<span class="udiff-line-modified-removed">-             throw new IOException(</span>
<span class="udiff-line-modified-removed">-                 &quot;DerValue.getBMPString, not BMP &quot; + tag);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-         // BMPString is the same as Unicode in big endian, unmarked</span>
<span class="udiff-line-removed">-         // format.</span>
<span class="udiff-line-modified-added">+         if (tag != tag_BMPString) {</span>
<span class="udiff-line-modified-added">+             throw new IOException(&quot;DerValue.getBMPString, not BMP &quot; + tag);</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+         // BMPString is the same as Unicode in big endian, unmarked format.</span>
          return new String(getDataBytes(), UTF_16BE);
      }
  
      /**
       * Returns the ASN.1 UTF-8 STRING value as a Java String.
       *
       * @return a string corresponding to the encoded UTF8String held in
       * this value
       */
      public String getUTF8String() throws IOException {
<span class="udiff-line-modified-removed">-         if (tag != tag_UTF8String)</span>
<span class="udiff-line-modified-removed">-             throw new IOException(</span>
<span class="udiff-line-modified-removed">-                 &quot;DerValue.getUTF8String, not UTF-8 &quot; + tag);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+         if (tag != tag_UTF8String) {</span>
<span class="udiff-line-modified-added">+             throw new IOException(&quot;DerValue.getUTF8String, not UTF-8 &quot; + tag);</span>
<span class="udiff-line-modified-added">+         }</span>
          return new String(getDataBytes(), UTF_8);
      }
  
      /**
       * Returns the ASN.1 GENERAL STRING value as a Java String.
       *
       * @return a string corresponding to the encoded GeneralString held in
       * this value
       */
      public String getGeneralString() throws IOException {
<span class="udiff-line-modified-removed">-         if (tag != tag_GeneralString)</span>
<span class="udiff-line-modified-added">+         if (tag != tag_GeneralString) {</span>
              throw new IOException(
<span class="udiff-line-modified-removed">-                 &quot;DerValue.getGeneralString, not GeneralString &quot; + tag);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+                     &quot;DerValue.getGeneralString, not GeneralString &quot; + tag);</span>
<span class="udiff-line-modified-added">+         }</span>
          return new String(getDataBytes(), US_ASCII);
      }
  
      /**
       * Returns a Date if the DerValue is UtcTime.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -816,21 +818,22 @@</span>
      @Override
      public String toString() {
          try {
  
              String str = getAsString();
<span class="udiff-line-modified-removed">-             if (str != null)</span>
<span class="udiff-line-modified-added">+             if (str != null) {</span>
                  return &quot;\&quot;&quot; + str + &quot;\&quot;&quot;;
<span class="udiff-line-modified-removed">-             if (tag == tag_Null)</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-added">+             if (tag == tag_Null) {</span>
                  return &quot;[DerValue, null]&quot;;
<span class="udiff-line-modified-removed">-             if (tag == tag_ObjectId)</span>
<span class="udiff-line-modified-added">+             } else if (tag == tag_ObjectId) {</span>
                  return &quot;OID.&quot; + getOID();
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-             // integers</span>
<span class="udiff-line-removed">-             else</span>
<span class="udiff-line-modified-added">+             } else {</span>
<span class="udiff-line-modified-added">+                 // integers</span>
                  return &quot;[DerValue, tag = &quot; + tag
                          + &quot;, length = &quot; + length + &quot;]&quot;;
<span class="udiff-line-added">+             }</span>
          } catch (IOException e) {
              throw new IllegalArgumentException(&quot;misformatted DER value&quot;);
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -853,12 +856,13 @@</span>
       * to return a DER stream of the members of the set or sequence.
       * This operation is not supported for primitive types such as
       * integers or bit strings.
       */
      public DerInputStream toDerInputStream() throws IOException {
<span class="udiff-line-modified-removed">-         if (tag == tag_Sequence || tag == tag_Set)</span>
<span class="udiff-line-modified-added">+         if (tag == tag_Sequence || tag == tag_Set) {</span>
              return new DerInputStream(buffer);
<span class="udiff-line-added">+         }</span>
          throw new IOException(&quot;toDerInputStream rejects tag type &quot; + tag);
      }
  
      /**
       * Get the length of the encoded value.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -884,11 +888,11 @@</span>
       *
       * This list is based on X.680 (the ASN.1 spec).
       */
      public static boolean isPrintableStringChar(char ch) {
          if ((ch &gt;= &#39;a&#39; &amp;&amp; ch &lt;= &#39;z&#39;) || (ch &gt;= &#39;A&#39; &amp;&amp; ch &lt;= &#39;Z&#39;) ||
<span class="udiff-line-modified-removed">-             (ch &gt;= &#39;0&#39; &amp;&amp; ch &lt;= &#39;9&#39;)) {</span>
<span class="udiff-line-modified-added">+                 (ch &gt;= &#39;0&#39; &amp;&amp; ch &lt;= &#39;9&#39;)) {</span>
              return true;
          } else {
              switch (ch) {
                  case &#39; &#39;:       /* space */
                  case &#39;\&#39;&#39;:      /* apostrophe */
</pre>
<center><a href="DerOutputStream.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="NamedCurve.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>