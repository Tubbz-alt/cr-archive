<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/x509/X509CertImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="X509CRLImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="X509CertInfo.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/x509/X509CertImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -326,13 +326,15 @@</span>
       *
       * @param out the output stream on which to write the DER encoding.
       *
       * @exception IOException on encoding error.
       */
<span class="udiff-line-modified-removed">-     public void derEncode(OutputStream out) throws IOException {</span>
<span class="udiff-line-modified-removed">-         if (signedCert == null)</span>
<span class="udiff-line-modified-removed">-             throw new IOException(&quot;Null certificate to encode&quot;);</span>
<span class="udiff-line-modified-added">+     @Override</span>
<span class="udiff-line-modified-added">+     public void derEncode(DerOutputStream out) {</span>
<span class="udiff-line-modified-added">+         if (signedCert == null) {</span>
<span class="udiff-line-added">+             throw new IllegalStateException(&quot;Null certificate to encode&quot;);</span>
<span class="udiff-line-added">+         }</span>
          out.write(signedCert.clone());
      }
  
      /**
       * Returns the encoded form of this certificate. It is
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -576,54 +578,49 @@</span>
      public void sign(PrivateKey key, AlgorithmParameterSpec signingParams,
              String algorithm, String provider)
              throws CertificateException, NoSuchAlgorithmException,
              InvalidKeyException, InvalidAlgorithmParameterException,
              NoSuchProviderException, SignatureException {
<span class="udiff-line-modified-removed">-         try {</span>
<span class="udiff-line-modified-removed">-             if (readOnly) {</span>
<span class="udiff-line-modified-removed">-                 throw new CertificateEncodingException(</span>
<span class="udiff-line-modified-removed">-                         &quot;cannot over-write existing certificate&quot;);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             Signature sigEngine = null;</span>
<span class="udiff-line-modified-removed">-             if (provider == null || provider.isEmpty()) {</span>
<span class="udiff-line-modified-removed">-                 sigEngine = Signature.getInstance(algorithm);</span>
<span class="udiff-line-modified-removed">-             } else {</span>
<span class="udiff-line-modified-removed">-                 sigEngine = Signature.getInstance(algorithm, provider);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             SignatureUtil.initSignWithParam(sigEngine, key, signingParams,</span>
<span class="udiff-line-removed">-                     null);</span>
<span class="udiff-line-modified-added">+         if (readOnly) {</span>
<span class="udiff-line-modified-added">+             throw new CertificateEncodingException(</span>
<span class="udiff-line-modified-added">+                     &quot;cannot over-write existing certificate&quot;);</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+         Signature sigEngine = null;</span>
<span class="udiff-line-modified-added">+         if (provider == null || provider.isEmpty()) {</span>
<span class="udiff-line-modified-added">+             sigEngine = Signature.getInstance(algorithm);</span>
<span class="udiff-line-modified-added">+         } else {</span>
<span class="udiff-line-modified-added">+             sigEngine = Signature.getInstance(algorithm, provider);</span>
<span class="udiff-line-modified-added">+         }</span>
  
<span class="udiff-line-modified-removed">-             if (signingParams != null) {</span>
<span class="udiff-line-modified-removed">-                 algId = AlgorithmId.get(sigEngine.getParameters());</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 // in case the name is reset</span>
<span class="udiff-line-removed">-                 algId = AlgorithmId.get(sigEngine.getAlgorithm());</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             DerOutputStream out = new DerOutputStream();</span>
<span class="udiff-line-removed">-             DerOutputStream tmp = new DerOutputStream();</span>
<span class="udiff-line-modified-added">+         SignatureUtil.initSignWithParam(sigEngine, key, signingParams,</span>
<span class="udiff-line-modified-added">+                 null);</span>
  
<span class="udiff-line-modified-removed">-             // encode certificate info</span>
<span class="udiff-line-modified-removed">-             info.encode(tmp);</span>
<span class="udiff-line-modified-removed">-             byte[] rawCert = tmp.toByteArray();</span>
<span class="udiff-line-modified-added">+         if (signingParams != null) {</span>
<span class="udiff-line-modified-added">+             algId = AlgorithmId.get(sigEngine.getParameters());</span>
<span class="udiff-line-modified-added">+         } else {</span>
<span class="udiff-line-added">+             // in case the name is reset</span>
<span class="udiff-line-added">+             algId = AlgorithmId.get(sigEngine.getAlgorithm());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         DerOutputStream out = new DerOutputStream();</span>
<span class="udiff-line-added">+         DerOutputStream tmp = new DerOutputStream();</span>
  
<span class="udiff-line-modified-removed">-             // encode algorithm identifier</span>
<span class="udiff-line-modified-removed">-             algId.encode(tmp);</span>
<span class="udiff-line-modified-added">+         // encode certificate info</span>
<span class="udiff-line-modified-added">+         info.encode(tmp);</span>
<span class="udiff-line-added">+         byte[] rawCert = tmp.toByteArray();</span>
  
<span class="udiff-line-modified-removed">-             // Create and encode the signature itself.</span>
<span class="udiff-line-modified-removed">-             sigEngine.update(rawCert, 0, rawCert.length);</span>
<span class="udiff-line-removed">-             signature = sigEngine.sign();</span>
<span class="udiff-line-removed">-             tmp.putBitString(signature);</span>
<span class="udiff-line-modified-added">+         // encode algorithm identifier</span>
<span class="udiff-line-modified-added">+         algId.derEncode(tmp);</span>
  
<span class="udiff-line-modified-removed">-             // Wrap the signed data in a SEQUENCE { data, algorithm, sig }</span>
<span class="udiff-line-modified-removed">-             out.write(DerValue.tag_Sequence, tmp);</span>
<span class="udiff-line-modified-removed">-             signedCert = out.toByteArray();</span>
<span class="udiff-line-modified-removed">-             readOnly = true;</span>
<span class="udiff-line-modified-added">+         // Create and encode the signature itself.</span>
<span class="udiff-line-modified-added">+         sigEngine.update(rawCert, 0, rawCert.length);</span>
<span class="udiff-line-modified-added">+         signature = sigEngine.sign();</span>
<span class="udiff-line-modified-added">+         tmp.putBitString(signature);</span>
  
<span class="udiff-line-modified-removed">-         } catch (IOException e) {</span>
<span class="udiff-line-modified-removed">-             throw new CertificateEncodingException(e.toString());</span>
<span class="udiff-line-modified-removed">-       }</span>
<span class="udiff-line-modified-added">+         // Wrap the signed data in a SEQUENCE { data, algorithm, sig }</span>
<span class="udiff-line-modified-added">+         out.write(DerValue.tag_Sequence, tmp);</span>
<span class="udiff-line-modified-added">+         signedCert = out.toByteArray();</span>
<span class="udiff-line-added">+         readOnly = true;</span>
      }
  
      /**
       * Checks that the certificate is currently valid, i.e. the current
       * time is within the specified validity period.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1603,17 +1600,11 @@</span>
                  nameEntry.add(((OIDName) name).getOID().toString());
                  break;
              default:
                  // add DER encoded form
                  DerOutputStream derOut = new DerOutputStream();
<span class="udiff-line-modified-removed">-                 try {</span>
<span class="udiff-line-removed">-                     name.encode(derOut);</span>
<span class="udiff-line-removed">-                 } catch (IOException ioe) {</span>
<span class="udiff-line-removed">-                     // should not occur since name has already been decoded</span>
<span class="udiff-line-removed">-                     // from cert (this would indicate a bug in our code)</span>
<span class="udiff-line-removed">-                     throw new RuntimeException(&quot;name cannot be encoded&quot;, ioe);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-modified-added">+                 name.derEncode(derOut);</span>
                  nameEntry.add(derOut.toByteArray());
                  break;
              }
              newNames.add(Collections.unmodifiableList(nameEntry));
          }
</pre>
<center><a href="X509CRLImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="X509CertInfo.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>