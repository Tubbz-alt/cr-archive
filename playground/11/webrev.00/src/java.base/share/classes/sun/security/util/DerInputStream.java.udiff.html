<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/util/DerInputStream.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="DerInputBuffer.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="DerValue.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/util/DerInputStream.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1996, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1996, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,11 +28,13 @@</span>
  import java.io.InputStream;
  import java.io.IOException;
  import java.math.BigInteger;
  import java.nio.charset.Charset;
  import java.util.Date;
<span class="udiff-line-added">+ import java.util.Optional;</span>
  import java.util.Vector;
<span class="udiff-line-added">+ import java.util.function.Predicate;</span>
  
  import static java.nio.charset.StandardCharsets.*;
  
  /**
   * A DER input stream, used for parsing ASN.1 DER-encoded data such as
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -317,10 +319,20 @@</span>
      public void getNull() throws IOException {
          if (buffer.read() != DerValue.tag_Null || buffer.read() != 0)
              throw new IOException(&quot;getNull, bad data&quot;);
      }
  
<span class="udiff-line-added">+     public boolean getBoolean() throws IOException {</span>
<span class="udiff-line-added">+         if (buffer.read() != DerValue.tag_Boolean || buffer.read() != 1)</span>
<span class="udiff-line-added">+             throw new IOException(&quot;getBoolean, bad data&quot;);</span>
<span class="udiff-line-added">+         int next = buffer.read();</span>
<span class="udiff-line-added">+         if (next == -1) {</span>
<span class="udiff-line-added">+             throw new IOException(&quot;Short read of DER Boolean&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return next != 0;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Reads an X.200 style Object Identifier from the stream.
       */
      public ObjectIdentifier getOID() throws IOException {
          return new ObjectIdentifier(this);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -525,10 +537,21 @@</span>
                                    stringName + &quot; string&quot;);
  
          return new String(retval, charset);
      }
  
<span class="udiff-line-added">+     public Date getTime() throws IOException {</span>
<span class="udiff-line-added">+         int tag = buffer.read();</span>
<span class="udiff-line-added">+         if (tag == DerValue.tag_UtcTime) {</span>
<span class="udiff-line-added">+             return buffer.getUTCTime(getDefiniteLength(buffer));</span>
<span class="udiff-line-added">+         } else if (tag == DerValue.tag_GeneralizedTime) {</span>
<span class="udiff-line-added">+             return buffer.getGeneralizedTime(getDefiniteLength(buffer));</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             throw new IOException(&quot;Not a time value &quot; + tag);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Get a UTC encoded time value from the input stream.
       */
      public Date getUTCTime() throws IOException {
          if (buffer.read() != DerValue.tag_UtcTime)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -659,6 +682,120 @@</span>
       * Returns the number of bytes available for reading.
       * This is most useful for testing whether the stream is
       * empty.
       */
      public int available() { return buffer.available(); }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Ensure there is no more data. This can be called when the last</span>
<span class="udiff-line-added">+      * expected field is parsed and we need to make sure no unread is left.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public void atEnd() throws IOException {</span>
<span class="udiff-line-added">+         if (available() != 0) {</span>
<span class="udiff-line-added">+             throw new IOException(&quot;Extra unused bytes&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Detect if the tag of the next DerValue in the stream matches the rule.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * Attention: tag is an integer casted from a byte. i.e. could be negative.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param rule the rule to check for the tag.</span>
<span class="udiff-line-added">+      * @return true if matches, false otherwise or stream is at end.</span>
<span class="udiff-line-added">+      * @throws IOException if an I/O error happens</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public boolean seeOptional(Predicate&lt;Integer&gt; rule) throws IOException {</span>
<span class="udiff-line-added">+         return available() &gt; 0 &amp;&amp; rule.test(peekByte());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Detect if the tag of the next DerValue in the stream is the specified.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param tag the expected tag</span>
<span class="udiff-line-added">+      * @return true if is, false otherwise or stream is at end.</span>
<span class="udiff-line-added">+      * @throws IOException if an I/O error happens</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public boolean seeOptional(byte tag) throws IOException {</span>
<span class="udiff-line-added">+         return seeOptional(t -&gt; t == (tag &amp; 0xff));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Returns the inner DerValue if the next DerValue in the stream is</span>
<span class="udiff-line-added">+      * an EXPLICIT context-specific value tagged by {@code n}.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param n the expected tag</span>
<span class="udiff-line-added">+      * @return the inner DerValue, or empty if not found or stream at end</span>
<span class="udiff-line-added">+      * @throws IOException if an I/O error happens</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public Optional&lt;DerValue&gt; getOptionalExplicitContextSpecific(int n)</span>
<span class="udiff-line-added">+             throws IOException {</span>
<span class="udiff-line-added">+         if (seeOptionalContextSpecific(n)) {</span>
<span class="udiff-line-added">+             DerValue v = getDerValue(); // [n]</span>
<span class="udiff-line-added">+             DerValue sub = v.data.getDerValue(); // inside [n]</span>
<span class="udiff-line-added">+             v.data.atEnd(); // make sure there is only one inner value</span>
<span class="udiff-line-added">+             return Optional.of(sub);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return Optional.empty();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Returns the restored DerValue if the next DerValue in the stream is</span>
<span class="udiff-line-added">+      * an IMPLICIT context-specific value tagged by {@code n}.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param n the expected tag</span>
<span class="udiff-line-added">+      * @param tag the real tag for the IMPLICIT type</span>
<span class="udiff-line-added">+      * @return the restored DerValue, or empty if not found or stream at end</span>
<span class="udiff-line-added">+      * @throws IOException if an I/O error happens</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public Optional&lt;DerValue&gt; getOptionalImplicitContextSpecific(int n, byte tag)</span>
<span class="udiff-line-added">+             throws IOException {</span>
<span class="udiff-line-added">+         if (seeOptionalContextSpecific(n)) {</span>
<span class="udiff-line-added">+             DerValue v = getDerValue(); // [n]</span>
<span class="udiff-line-added">+             v.resetTag(tag); // restore tag because IMPLICIT has overwritten it</span>
<span class="udiff-line-added">+             return Optional.of(v);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return Optional.empty();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Detect if the next DerValue in the stream is a context-specific value</span>
<span class="udiff-line-added">+      * tagged by {@code n}.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param n the expected tag</span>
<span class="udiff-line-added">+      * @return true if is, false otherwise or stream is at end.</span>
<span class="udiff-line-added">+      * @throws IOException if an I/O error happens</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public boolean seeOptionalContextSpecific(int n) throws IOException {</span>
<span class="udiff-line-added">+         return seeOptional(t -&gt; (t &amp; 0x0c0) == 0x080 &amp;&amp; (t &amp; 0x01f) == n);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Skip the next DerValue in the stream. Indefinite length DerValue</span>
<span class="udiff-line-added">+      * is supported.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @throws IOException if an I/O error happens</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public void skipDerValue() throws IOException {</span>
<span class="udiff-line-added">+         int unresolved = 0;</span>
<span class="udiff-line-added">+         while (true) {</span>
<span class="udiff-line-added">+             tag = (byte) buffer.read();</span>
<span class="udiff-line-added">+             byte lenByte = (byte) buffer.read();</span>
<span class="udiff-line-added">+             int length = DerInputStream.getLength(lenByte, buffer);</span>
<span class="udiff-line-added">+             if (tag == 0) { // EOC</span>
<span class="udiff-line-added">+                 unresolved--;</span>
<span class="udiff-line-added">+                 if (unresolved &lt; 0 || length != 0) {</span>
<span class="udiff-line-added">+                     throw new IOException(&quot;Expected EOC&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else if (length == -1) {</span>
<span class="udiff-line-added">+                 unresolved++;</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 buffer.skip(length);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (unresolved == 0) {</span>
<span class="udiff-line-added">+                 break;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="DerInputBuffer.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="DerValue.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>