<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/sun/security/util/DerValue.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="DerInputStream.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../x509/AuthorityKeyIdentifierExtension.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/util/DerValue.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 26,11 ***</span>
<span class="line-new-header">--- 26,13 ---</span>
  package sun.security.util;
  
  import java.io.*;
  import java.math.BigInteger;
  import java.nio.charset.Charset;
<span class="line-added">+ import java.util.ArrayList;</span>
  import java.util.Date;
<span class="line-added">+ import java.util.List;</span>
  
  import static java.nio.charset.StandardCharsets.*;
  
  /**
   * Represents a single DER-encoded value.  DER encoding rules are a subset
</pre>
<hr />
<pre>
<span class="line-old-header">*** 255,10 ***</span>
<span class="line-new-header">--- 257,11 ---</span>
  
          // XXX must also parse BER-encoded constructed
          // values such as sequences, sets...
          tag = (byte)in.read();
          byte lenByte = (byte)in.read();
<span class="line-added">+         llen = lenlen(lenByte);</span>
          length = DerInputStream.getLength(lenByte, in);
          if (length == -1) {  // indefinite length encoding found
              DerInputBuffer inbuf = in.dup();
              inbuf = new DerInputBuffer(
                      DerIndefLenConverter.convertStream(inbuf, lenByte, tag),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 372,19 ***</span>
<span class="line-new-header">--- 375,24 ---</span>
          DerInputStream result = new DerInputStream(buffer);
          result.mark(Integer.MAX_VALUE);
          return result;
      }
  
<span class="line-added">+     int llen = 0;</span>
<span class="line-added">+ </span>
      /*
       * helper routine
       */
      private DerInputStream init(boolean fullyBuffered, InputStream in,
          boolean allowBER) throws IOException {
  
          tag = (byte)in.read();
          byte lenByte = (byte)in.read();
<span class="line-added">+ </span>
<span class="line-added">+         llen = lenlen(lenByte);</span>
          length = DerInputStream.getLength(lenByte, in);
<span class="line-added">+ </span>
          if (length == -1) { // indefinite length encoding found
              in = new ByteArrayInputStream(
                      DerIndefLenConverter.convertStream(in, lenByte, tag));
              if (tag != in.read())
                  throw new IOException
</pre>
<hr />
<pre>
<span class="line-old-header">*** 399,10 ***</span>
<span class="line-new-header">--- 407,18 ---</span>
  
          buffer = new DerInputBuffer(bytes, allowBER);
          return new DerInputStream(buffer);
      }
  
<span class="line-added">+     private int lenlen(byte lenByte) {</span>
<span class="line-added">+         if ((lenByte &amp; 0x080) == 0x00) { // short form, 1 byte datum</span>
<span class="line-added">+             return 1;</span>
<span class="line-added">+         } else {                     // long form or indefinite</span>
<span class="line-added">+             return 1 + (lenByte &amp; 0x7f);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      /**
       * Encode an ASN1/DER encoded datum onto a DER output stream.
       */
      public void encode(DerOutputStream out)
      throws IOException {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 608,10 ***</span>
<span class="line-new-header">--- 624,21 ---</span>
              return getGeneralString();
          else
              return null;
      }
  
<span class="line-added">+     public DerValue[] getSubs(byte type) throws IOException {</span>
<span class="line-added">+         if (tag != type) {</span>
<span class="line-added">+             throw new IOException(&quot;Unexpected tag: &quot; + tag);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         List&lt;DerValue&gt; result = new ArrayList&lt;&gt;();</span>
<span class="line-added">+         while (data.available() &gt; 0) {</span>
<span class="line-added">+             result.add(data.getDerValue());</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return result.toArray(new DerValue[result.size()]);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      /**
       * Returns an ASN.1 BIT STRING value, with the tag assumed implicit
       * based on the parameter.  The bit string must be byte-aligned.
       *
       * @param tagImplicit if true, the tag is assumed implicit.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 943,6 ***</span>
<span class="line-new-header">--- 970,80 ---</span>
       */
      @Override
      public int hashCode() {
          return toString().hashCode();
      }
<span class="line-added">+ </span>
<span class="line-added">+     /**</span>
<span class="line-added">+      * Dump the content of this DerValue into stdout, decomposing the</span>
<span class="line-added">+      * structire in a hierachical style.</span>
<span class="line-added">+      *</span>
<span class="line-added">+      * Note: might not be good at deal with IMPLICIT context-specific values</span>
<span class="line-added">+      * because it has no hint on the original tag.</span>
<span class="line-added">+      *</span>
<span class="line-added">+      * Note: might not work correctly for some types of data if the data</span>
<span class="line-added">+      * inside has been read before. Also, after calling print(), the data</span>
<span class="line-added">+      * inside might be read and subsequent reading on some type of data.</span>
<span class="line-added">+      *</span>
<span class="line-added">+      * @param into if true, try to treat OCTET STRING as another DerValue.</span>
<span class="line-added">+      * @throws IOException if an I/O error occurs.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     public void print(boolean into) throws IOException {</span>
<span class="line-added">+         v0(&quot;&quot;, 0, this, into);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static void v0(String indent, int offset, DerValue v, boolean into)</span>
<span class="line-added">+             throws IOException {</span>
<span class="line-added">+         String label = String.format(&quot;%04x:%04x [%s]   &quot;,</span>
<span class="line-added">+                 offset, 1 + v.llen + v.length, indent);</span>
<span class="line-added">+         String value = switch (v.tag) {</span>
<span class="line-added">+             case DerValue.tag_Null -&gt; &quot;NULL&quot;;</span>
<span class="line-added">+             case DerValue.tag_OctetString -&gt; v.getOctetString().length + &quot; bytes&quot;;</span>
<span class="line-added">+             case DerValue.tag_BitString -&gt; v.getUnalignedBitString().length() + &quot; bits&quot;;</span>
<span class="line-added">+             case DerValue.tag_Integer -&gt; &quot;int &quot; + v.getBigInteger();</span>
<span class="line-added">+             case DerValue.tag_Boolean -&gt; Boolean.toString(v.getBoolean());</span>
<span class="line-added">+             case DerValue.tag_GeneralizedTime -&gt; v.getGeneralizedTime().toString();</span>
<span class="line-added">+             case DerValue.tag_UtcTime -&gt; v.getUTCTime().toString();</span>
<span class="line-added">+             case DerValue.tag_ObjectId -&gt; {</span>
<span class="line-added">+                 String s = v.getOID().toString();</span>
<span class="line-added">+                 KnownOIDs k = KnownOIDs.findMatch(s);</span>
<span class="line-added">+                 yield &quot;OID &quot; + s + (k != null ? (&quot; (&quot; + k.stdName() + &quot;)&quot;) : &quot;&quot;);</span>
<span class="line-added">+             }</span>
<span class="line-added">+             default -&gt; {</span>
<span class="line-added">+                 String s = v.getAsString();</span>
<span class="line-added">+                 yield s == null ? null : (&#39;&quot;&#39; + s + &#39;&quot;&#39;);</span>
<span class="line-added">+             }</span>
<span class="line-added">+         };</span>
<span class="line-added">+         if (value != null) {</span>
<span class="line-added">+             System.out.println(label + value);</span>
<span class="line-added">+             if (v.tag == DerValue.tag_OctetString &amp;&amp; into) {</span>
<span class="line-added">+                 try {</span>
<span class="line-added">+                     v.buffer.reset();</span>
<span class="line-added">+                     DerValue v2 = new DerValue(v.getOctetString());</span>
<span class="line-added">+                     v0(indent + &quot;=&quot;, 0, v2, into);</span>
<span class="line-added">+                 } catch (IOException e) {</span>
<span class="line-added">+                     //</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+         } else if (v.isConstructed()) {</span>
<span class="line-added">+             String type = &quot;sub&quot;;</span>
<span class="line-added">+             if (v.isContextSpecific()) {</span>
<span class="line-added">+                 type = &quot;[&quot; + (v.tag &amp; 0x1f) + &quot;]&quot;;</span>
<span class="line-added">+             } else if (v.isApplication()) {</span>
<span class="line-added">+                 type = &quot;[APPLICATION &quot; + (v.tag &amp; 0x1f) + &quot;]&quot;;</span>
<span class="line-added">+             } else if (v.tag == DerValue.tag_Sequence) {</span>
<span class="line-added">+                 type = &quot;SEQUENCE&quot;;</span>
<span class="line-added">+             } else if (v.tag == DerValue.tag_Set) {</span>
<span class="line-added">+                 type = &quot;SET&quot;;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             System.out.println(label + type);</span>
<span class="line-added">+             int pos = 0;</span>
<span class="line-added">+             offset += 1 + v.llen;</span>
<span class="line-added">+             for (var vv : v.getSubs(v.tag)) {</span>
<span class="line-added">+                 v0(indent + pos++, offset, vv, into);</span>
<span class="line-added">+                 offset += vv.length + vv.llen + 1;</span>
<span class="line-added">+             }</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             System.out.println(label + v);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
  }
</pre>
<center><a href="DerInputStream.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../x509/AuthorityKeyIdentifierExtension.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>