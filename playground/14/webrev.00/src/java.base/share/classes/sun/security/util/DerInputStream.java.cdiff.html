<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/sun/security/util/DerInputStream.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> <a href="DerValue.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/util/DerInputStream.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 25,13 ***</span>
<span class="line-new-header">--- 25,16 ---</span>
  
  package sun.security.util;
  
  import java.io.InputStream;
  import java.io.IOException;
<span class="line-added">+ import java.io.UncheckedIOException;</span>
  import java.math.BigInteger;
  import java.nio.charset.Charset;
<span class="line-added">+ import java.util.Arrays;</span>
  import java.util.Date;
<span class="line-added">+ import java.util.Iterator;</span>
  import java.util.Vector;
  
  import static java.nio.charset.StandardCharsets.*;
  
  /**
</pre>
<hr />
<pre>
<span class="line-old-header">*** 55,522 ***</span>
   * @author David Brownell
   * @author Amit Kapoor
   * @author Hemma Prafullchandra
   */
  
<span class="line-modified">! public class DerInputStream {</span>
  
<span class="line-modified">!     /*</span>
<span class="line-modified">!      * This version only supports fully buffered DER.  This is easy to</span>
<span class="line-modified">!      * work with, though if large objects are manipulated DER becomes</span>
<span class="line-modified">!      * awkward to deal with.  That&#39;s where BER is useful, since BER</span>
<span class="line-modified">!      * handles streaming data relatively well.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     DerInputBuffer      buffer;</span>
  
<span class="line-modified">!     /** The DER tag of the value; one of the tag_ constants. */</span>
<span class="line-modified">!     public byte         tag;</span>
  
<span class="line-modified">!     /**</span>
<span class="line-modified">!      * Create a DER input stream from a data buffer.  The buffer is not</span>
<span class="line-modified">!      * copied, it is shared.  Accordingly, the buffer should be treated</span>
<span class="line-modified">!      * as read-only.</span>
<span class="line-modified">!      *</span>
<span class="line-modified">!      * @param data the buffer from which to create the string (CONSUMED)</span>
<span class="line-modified">!      */</span>
<span class="line-modified">!     public DerInputStream(byte[] data) throws IOException {</span>
<span class="line-modified">!         init(data, 0, data.length, true);</span>
      }
  
<span class="line-modified">!     /**</span>
<span class="line-modified">!      * Create a DER input stream from part of a data buffer with</span>
<span class="line-modified">!      * additional arg to control whether DER checks are enforced.</span>
<span class="line-modified">!      * The buffer is not copied, it is shared.  Accordingly, the</span>
<span class="line-modified">!      * buffer should be treated as read-only.</span>
<span class="line-modified">!      *</span>
<span class="line-removed">-      * @param data the buffer from which to create the string (CONSUMED)</span>
<span class="line-removed">-      * @param offset the first index of &lt;em&gt;data&lt;/em&gt; which will</span>
<span class="line-removed">-      *          be read as DER input in the new stream</span>
<span class="line-removed">-      * @param len how long a chunk of the buffer to use,</span>
<span class="line-removed">-      *          starting at &quot;offset&quot;</span>
<span class="line-removed">-      * @param allowBER whether to allow constructed indefinite-length</span>
<span class="line-removed">-      *          encoding as well as tolerate leading 0s</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     public DerInputStream(byte[] data, int offset, int len,</span>
<span class="line-removed">-         boolean allowBER) throws IOException {</span>
<span class="line-removed">-         init(data, offset, len, allowBER);</span>
      }
  
<span class="line-modified">!     /**</span>
<span class="line-modified">!      * Create a DER input stream from part of a data buffer.</span>
<span class="line-removed">-      * The buffer is not copied, it is shared.  Accordingly, the</span>
<span class="line-removed">-      * buffer should be treated as read-only.</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * @param data the buffer from which to create the string (CONSUMED)</span>
<span class="line-removed">-      * @param offset the first index of &lt;em&gt;data&lt;/em&gt; which will</span>
<span class="line-removed">-      *          be read as DER input in the new stream</span>
<span class="line-removed">-      * @param len how long a chunk of the buffer to use,</span>
<span class="line-removed">-      *          starting at &quot;offset&quot;</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     public DerInputStream(byte[] data, int offset, int len) throws IOException {</span>
<span class="line-removed">-         init(data, offset, len, true);</span>
      }
  
<span class="line-modified">!     /*</span>
<span class="line-modified">!      * private helper routine</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     private void init(byte[] data, int offset, int len, boolean allowBER) throws IOException {</span>
<span class="line-removed">-         if ((offset+2 &gt; data.length) || (offset+len &gt; data.length)) {</span>
<span class="line-removed">-             throw new IOException(&quot;Encoding bytes too short&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         // check for indefinite length encoding</span>
<span class="line-removed">-         if (DerIndefLenConverter.isIndefinite(data[offset+1])) {</span>
<span class="line-removed">-             if (!allowBER) {</span>
<span class="line-removed">-                 throw new IOException(&quot;Indefinite length BER encoding found&quot;);</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 byte[] inData = new byte[len];</span>
<span class="line-removed">-                 System.arraycopy(data, offset, inData, 0, len);</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 DerIndefLenConverter derIn = new DerIndefLenConverter();</span>
<span class="line-removed">-                 byte[] result = derIn.convertBytes(inData);</span>
<span class="line-removed">-                 if (result == null) {</span>
<span class="line-removed">-                     throw new IOException(&quot;not all indef len BER resolved&quot;);</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     buffer = new DerInputBuffer(result, allowBER);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             buffer = new DerInputBuffer(data, offset, len, allowBER);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         buffer.mark(Integer.MAX_VALUE);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     DerInputStream(DerInputBuffer buf) {</span>
<span class="line-removed">-         buffer = buf;</span>
<span class="line-removed">-         buffer.mark(Integer.MAX_VALUE);</span>
      }
  
<span class="line-modified">!     /**</span>
<span class="line-modified">!      * Creates a new DER input stream from part of this input stream.</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * @param len how long a chunk of the current input stream to use,</span>
<span class="line-removed">-      *          starting at the current position.</span>
<span class="line-removed">-      * @param do_skip true if the existing data in the input stream should</span>
<span class="line-removed">-      *          be skipped.  If this value is false, the next data read</span>
<span class="line-removed">-      *          on this stream and the newly created stream will be the</span>
<span class="line-removed">-      *          same.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     public DerInputStream subStream(int len, boolean do_skip)</span>
<span class="line-removed">-     throws IOException {</span>
<span class="line-removed">-         DerInputBuffer newbuf = buffer.dup();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         newbuf.truncate(len);</span>
<span class="line-removed">-         if (do_skip) {</span>
<span class="line-removed">-             buffer.skip(len);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return new DerInputStream(newbuf);</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Return what has been written to this DerInputStream</span>
<span class="line-removed">-      * as a byte array. Useful for debugging.</span>
<span class="line-removed">-      */</span>
      public byte[] toByteArray() {
<span class="line-modified">!         return buffer.toByteArray();</span>
      }
  
<span class="line-removed">-     /*</span>
<span class="line-removed">-      * PRIMITIVES -- these are &quot;universal&quot; ASN.1 simple types.</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      *  INTEGER, ENUMERATED, BIT STRING, OCTET STRING, NULL</span>
<span class="line-removed">-      *  OBJECT IDENTIFIER, SEQUENCE (OF), SET (OF)</span>
<span class="line-removed">-      *  UTF8String, PrintableString, T61String, IA5String, UTCTime,</span>
<span class="line-removed">-      *  GeneralizedTime, BMPString.</span>
<span class="line-removed">-      * Note: UniversalString not supported till encoder is available.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Get an integer from the input stream as an integer.</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * @return the integer held in this DER input stream.</span>
<span class="line-removed">-      */</span>
      public int getInteger() throws IOException {
<span class="line-modified">!         if (buffer.read() != DerValue.tag_Integer) {</span>
<span class="line-removed">-             throw new IOException(&quot;DER input, Integer tag error&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return buffer.getInteger(getDefiniteLength(buffer));</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Get a integer from the input stream as a BigInteger object.</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * @return the integer held in this DER input stream.</span>
<span class="line-removed">-      */</span>
      public BigInteger getBigInteger() throws IOException {
<span class="line-modified">!         if (buffer.read() != DerValue.tag_Integer) {</span>
<span class="line-removed">-             throw new IOException(&quot;DER input, Integer tag error&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return buffer.getBigInteger(getDefiniteLength(buffer), false);</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Returns an ASN.1 INTEGER value as a positive BigInteger.</span>
<span class="line-removed">-      * This is just to deal with implementations that incorrectly encode</span>
<span class="line-removed">-      * some values as negative.</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * @return the integer held in this DER value as a BigInteger.</span>
<span class="line-removed">-      */</span>
      public BigInteger getPositiveBigInteger() throws IOException {
<span class="line-modified">!         if (buffer.read() != DerValue.tag_Integer) {</span>
<span class="line-removed">-             throw new IOException(&quot;DER input, Integer tag error&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return buffer.getBigInteger(getDefiniteLength(buffer), true);</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Get an enumerated from the input stream.</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * @return the integer held in this DER input stream.</span>
<span class="line-removed">-      */</span>
      public int getEnumerated() throws IOException {
<span class="line-modified">!         if (buffer.read() != DerValue.tag_Enumerated) {</span>
<span class="line-removed">-             throw new IOException(&quot;DER input, Enumerated tag error&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return buffer.getInteger(getDefiniteLength(buffer));</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Get a bit string from the input stream. Padded bits (if any)</span>
<span class="line-removed">-      * will be stripped off before the bit string is returned.</span>
<span class="line-removed">-      */</span>
      public byte[] getBitString() throws IOException {
<span class="line-modified">!         if (buffer.read() != DerValue.tag_BitString)</span>
<span class="line-removed">-             throw new IOException(&quot;DER input not an bit string&quot;);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         return buffer.getBitString(getDefiniteLength(buffer));</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Get a bit string from the input stream.  The bit string need</span>
<span class="line-removed">-      * not be byte-aligned.</span>
<span class="line-removed">-      */</span>
      public BitArray getUnalignedBitString() throws IOException {
<span class="line-modified">!         if (buffer.read() != DerValue.tag_BitString) {</span>
<span class="line-removed">-             throw new IOException(&quot;DER input not a bit string&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         int length = getDefiniteLength(buffer);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (length == 0) {</span>
<span class="line-removed">-             return new BitArray(0);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * First byte = number of excess bits in the last octet of the</span>
<span class="line-removed">-          * representation.</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         length--;</span>
<span class="line-removed">-         int excessBits = buffer.read();</span>
<span class="line-removed">-         if (excessBits &lt; 0) {</span>
<span class="line-removed">-             throw new IOException(&quot;Unused bits of bit string invalid&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         int validBits = length*8 - excessBits;</span>
<span class="line-removed">-         if (validBits &lt; 0) {</span>
<span class="line-removed">-             throw new IOException(&quot;Valid bits of bit string invalid&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         byte[] repn = new byte[length];</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if ((length != 0) &amp;&amp; (buffer.read(repn) != length)) {</span>
<span class="line-removed">-             throw new IOException(&quot;Short read of DER bit string&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         return new BitArray(validBits, repn);</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Returns an ASN.1 OCTET STRING from the input stream.</span>
<span class="line-removed">-      */</span>
      public byte[] getOctetString() throws IOException {
<span class="line-modified">!         if (buffer.read() != DerValue.tag_OctetString)</span>
<span class="line-removed">-             throw new IOException(&quot;DER input not an octet string&quot;);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         int length = getDefiniteLength(buffer);</span>
<span class="line-removed">-         byte[] retval = new byte[length];</span>
<span class="line-removed">-         if ((length != 0) &amp;&amp; (buffer.read(retval) != length))</span>
<span class="line-removed">-             throw new IOException(&quot;Short read of DER octet string&quot;);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         return retval;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Returns the asked number of bytes from the input stream.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     public void getBytes(byte[] val) throws IOException {</span>
<span class="line-removed">-         if ((val.length != 0) &amp;&amp; (buffer.read(val) != val.length)) {</span>
<span class="line-removed">-             throw new IOException(&quot;Short read of DER octet string&quot;);</span>
<span class="line-removed">-         }</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Reads an encoded null value from the input stream.</span>
<span class="line-removed">-      */</span>
      public void getNull() throws IOException {
<span class="line-modified">!         if (buffer.read() != DerValue.tag_Null || buffer.read() != 0)</span>
<span class="line-removed">-             throw new IOException(&quot;getNull, bad data&quot;);</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Reads an X.200 style Object Identifier from the stream.</span>
<span class="line-removed">-      */</span>
      public ObjectIdentifier getOID() throws IOException {
<span class="line-modified">!         return new ObjectIdentifier(this);</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Return a sequence of encoded entities.  ASN.1 sequences are</span>
<span class="line-removed">-      * ordered, and they are often used, like a &quot;struct&quot; in C or C++,</span>
<span class="line-removed">-      * to group data values.  They may have optional or context</span>
<span class="line-removed">-      * specific values.</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * @param startLen guess about how long the sequence will be</span>
<span class="line-removed">-      *          (used to initialize an auto-growing data structure)</span>
<span class="line-removed">-      * @return array of the values in the sequence</span>
<span class="line-removed">-      */</span>
      public DerValue[] getSequence(int startLen) throws IOException {
<span class="line-modified">!         tag = (byte)buffer.read();</span>
<span class="line-removed">-         if (tag != DerValue.tag_Sequence)</span>
<span class="line-removed">-             throw new IOException(&quot;Sequence tag error&quot;);</span>
<span class="line-removed">-         return readVector(startLen);</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Return a set of encoded entities.  ASN.1 sets are unordered,</span>
<span class="line-removed">-      * though DER may specify an order for some kinds of sets (such</span>
<span class="line-removed">-      * as the attributes in an X.500 relative distinguished name)</span>
<span class="line-removed">-      * to facilitate binary comparisons of encoded values.</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * @param startLen guess about how large the set will be</span>
<span class="line-removed">-      *          (used to initialize an auto-growing data structure)</span>
<span class="line-removed">-      * @return array of the values in the sequence</span>
<span class="line-removed">-      */</span>
      public DerValue[] getSet(int startLen) throws IOException {
<span class="line-modified">!         tag = (byte)buffer.read();</span>
<span class="line-removed">-         if (tag != DerValue.tag_Set)</span>
<span class="line-removed">-             throw new IOException(&quot;Set tag error&quot;);</span>
<span class="line-removed">-         return readVector(startLen);</span>
      }
  
<span class="line-modified">!     /**</span>
<span class="line-modified">!      * Return a set of encoded entities.  ASN.1 sets are unordered,</span>
<span class="line-removed">-      * though DER may specify an order for some kinds of sets (such</span>
<span class="line-removed">-      * as the attributes in an X.500 relative distinguished name)</span>
<span class="line-removed">-      * to facilitate binary comparisons of encoded values.</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * @param startLen guess about how large the set will be</span>
<span class="line-removed">-      *          (used to initialize an auto-growing data structure)</span>
<span class="line-removed">-      * @param implicit if true tag is assumed implicit.</span>
<span class="line-removed">-      * @return array of the values in the sequence</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     public DerValue[] getSet(int startLen, boolean implicit)</span>
<span class="line-removed">-         throws IOException {</span>
<span class="line-removed">-         tag = (byte)buffer.read();</span>
<span class="line-removed">-         if (!implicit) {</span>
<span class="line-removed">-             if (tag != DerValue.tag_Set) {</span>
<span class="line-removed">-                 throw new IOException(&quot;Set tag error&quot;);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return (readVector(startLen));</span>
      }
  
<span class="line-removed">-     /*</span>
<span class="line-removed">-      * Read a &quot;vector&quot; of values ... set or sequence have the</span>
<span class="line-removed">-      * same encoding, except for the initial tag, so both use</span>
<span class="line-removed">-      * this same helper routine.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     protected DerValue[] readVector(int startLen) throws IOException {</span>
<span class="line-removed">-         DerInputStream  newstr;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         byte lenByte = (byte)buffer.read();</span>
<span class="line-removed">-         int len = getLength(lenByte, buffer);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (len == -1) {</span>
<span class="line-removed">-            // indefinite length encoding found</span>
<span class="line-removed">-            buffer = new DerInputBuffer(</span>
<span class="line-removed">-                    DerIndefLenConverter.convertStream(buffer, lenByte, tag),</span>
<span class="line-removed">-                    buffer.allowBER);</span>
<span class="line-removed">- </span>
<span class="line-removed">-            if (tag != buffer.read())</span>
<span class="line-removed">-                 throw new IOException(&quot;Indefinite length encoding&quot; +</span>
<span class="line-removed">-                         &quot; not supported&quot;);</span>
<span class="line-removed">-            len = DerInputStream.getDefiniteLength(buffer);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (len == 0)</span>
<span class="line-removed">-             // return empty array instead of null, which should be</span>
<span class="line-removed">-             // used only for missing optionals</span>
<span class="line-removed">-             return new DerValue[0];</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * Create a temporary stream from which to read the data,</span>
<span class="line-removed">-          * unless it&#39;s not really needed.</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         if (buffer.available() == len)</span>
<span class="line-removed">-             newstr = this;</span>
<span class="line-removed">-         else</span>
<span class="line-removed">-             newstr = subStream(len, true);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * Pull values out of the stream.</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         Vector&lt;DerValue&gt; vec = new Vector&lt;&gt;(startLen);</span>
<span class="line-removed">-         DerValue value;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         do {</span>
<span class="line-removed">-             value = new DerValue(newstr.buffer, buffer.allowBER);</span>
<span class="line-removed">-             vec.addElement(value);</span>
<span class="line-removed">-         } while (newstr.available() &gt; 0);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (newstr.available() != 0)</span>
<span class="line-removed">-             throw new IOException(&quot;Extra data at end of vector&quot;);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * Now stick them into the array we&#39;re returning.</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         int             i, max = vec.size();</span>
<span class="line-removed">-         DerValue[]      retval = new DerValue[max];</span>
<span class="line-removed">- </span>
<span class="line-removed">-         for (i = 0; i &lt; max; i++)</span>
<span class="line-removed">-             retval[i] = vec.elementAt(i);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         return retval;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Get a single DER-encoded value from the input stream.</span>
<span class="line-removed">-      * It can often be useful to pull a value from the stream</span>
<span class="line-removed">-      * and defer parsing it.  For example, you can pull a nested</span>
<span class="line-removed">-      * sequence out with one call, and only examine its elements</span>
<span class="line-removed">-      * later when you really need to.</span>
<span class="line-removed">-      */</span>
      public DerValue getDerValue() throws IOException {
<span class="line-modified">!         return new DerValue(buffer);</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Read a string that was encoded as a UTF8String DER value.</span>
<span class="line-removed">-      */</span>
      public String getUTF8String() throws IOException {
<span class="line-modified">!         return readString(DerValue.tag_UTF8String, &quot;UTF-8&quot;, UTF_8);</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Read a string that was encoded as a PrintableString DER value.</span>
<span class="line-removed">-      */</span>
      public String getPrintableString() throws IOException {
<span class="line-modified">!         return readString(DerValue.tag_PrintableString, &quot;Printable&quot;,</span>
<span class="line-removed">-                           US_ASCII);</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Read a string that was encoded as a T61String DER value.</span>
<span class="line-removed">-      */</span>
      public String getT61String() throws IOException {
<span class="line-modified">!         /*</span>
<span class="line-removed">-          * Works for common characters between T61 and ASCII.</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         return readString(DerValue.tag_T61String, &quot;T61&quot;, ISO_8859_1);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Read a string that was encoded as a IA5String DER value.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     public String getIA5String() throws IOException {</span>
<span class="line-removed">-         return readString(DerValue.tag_IA5String, &quot;IA5&quot;, US_ASCII);</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Read a string that was encoded as a BMPString DER value.</span>
<span class="line-removed">-      */</span>
      public String getBMPString() throws IOException {
<span class="line-modified">!         return readString(DerValue.tag_BMPString, &quot;BMP&quot;, UTF_16BE);</span>
      }
  
<span class="line-modified">!     /**</span>
<span class="line-modified">!      * Read a string that was encoded as a GeneralString DER value.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     public String getGeneralString() throws IOException {</span>
<span class="line-removed">-         return readString(DerValue.tag_GeneralString, &quot;General&quot;,</span>
<span class="line-removed">-                           US_ASCII);</span>
      }
  
<span class="line-modified">!     /**</span>
<span class="line-modified">!      * Private helper routine to read an encoded string from the input</span>
<span class="line-removed">-      * stream.</span>
<span class="line-removed">-      * @param stringTag the tag for the type of string to read</span>
<span class="line-removed">-      * @param stringName a name to display in error messages</span>
<span class="line-removed">-      * @param enc the encoder to use to interpret the data. Should</span>
<span class="line-removed">-      * correspond to the stringTag above.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     private String readString(byte stringTag, String stringName,</span>
<span class="line-removed">-                               Charset charset) throws IOException {</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (buffer.read() != stringTag)</span>
<span class="line-removed">-             throw new IOException(&quot;DER input not a &quot; +</span>
<span class="line-removed">-                                   stringName + &quot; string&quot;);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         int length = getDefiniteLength(buffer);</span>
<span class="line-removed">-         byte[] retval = new byte[length];</span>
<span class="line-removed">-         if ((length != 0) &amp;&amp; (buffer.read(retval) != length))</span>
<span class="line-removed">-             throw new IOException(&quot;Short read of DER &quot; +</span>
<span class="line-removed">-                                   stringName + &quot; string&quot;);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         return new String(retval, charset);</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Get a UTC encoded time value from the input stream.</span>
<span class="line-removed">-      */</span>
      public Date getUTCTime() throws IOException {
<span class="line-modified">!         if (buffer.read() != DerValue.tag_UtcTime)</span>
<span class="line-removed">-             throw new IOException(&quot;DER input, UTCtime tag invalid &quot;);</span>
<span class="line-removed">-         return buffer.getUTCTime(getDefiniteLength(buffer));</span>
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Get a Generalized encoded time value from the input stream.</span>
<span class="line-removed">-      */</span>
      public Date getGeneralizedTime() throws IOException {
<span class="line-modified">!         if (buffer.read() != DerValue.tag_GeneralizedTime)</span>
<span class="line-removed">-             throw new IOException(&quot;DER input, GeneralizedTime tag invalid &quot;);</span>
<span class="line-removed">-         return buffer.getGeneralizedTime(getDefiniteLength(buffer));</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /*</span>
<span class="line-removed">-      * Get a byte from the input stream.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     // package private</span>
<span class="line-removed">-     int getByte() throws IOException {</span>
<span class="line-removed">-         return (0x00ff &amp; buffer.read());</span>
      }
  
      public int peekByte() throws IOException {
<span class="line-modified">!         return buffer.peek();</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     // package private</span>
<span class="line-removed">-     int getLength() throws IOException {</span>
<span class="line-removed">-         return getLength(buffer);</span>
      }
  
<span class="line-removed">-     /*</span>
<span class="line-removed">-      * Get a length from the input stream, allowing for at most 32 bits of</span>
<span class="line-removed">-      * encoding to be used.  (Not the same as getting a tagged integer!)</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * @return the length or -1 if indefinite length found.</span>
<span class="line-removed">-      * @exception IOException on parsing error or unsupported lengths.</span>
<span class="line-removed">-      */</span>
      static int getLength(InputStream in) throws IOException {
          return getLength(in.read(), in);
      }
  
      /*
<span class="line-new-header">--- 58,157 ---</span>
   * @author David Brownell
   * @author Amit Kapoor
   * @author Hemma Prafullchandra
   */
  
<span class="line-modified">! public class DerInputStream implements Iterable&lt;DerValue&gt; {</span>
  
<span class="line-modified">!     final byte[] data;</span>
<span class="line-modified">!     final int start;</span>
<span class="line-modified">!     final int end;</span>
<span class="line-modified">!     final boolean allowBER;</span>
<span class="line-modified">!     int pos;</span>
  
<span class="line-modified">!     @Override</span>
<span class="line-modified">!     public Iterator&lt;DerValue&gt; iterator() {</span>
<span class="line-added">+         return new Iterator&lt;DerValue&gt;() {</span>
<span class="line-added">+             @Override</span>
<span class="line-added">+             public boolean hasNext() {</span>
<span class="line-added">+                 return pos &lt; end;</span>
<span class="line-added">+             }</span>
  
<span class="line-modified">!             @Override</span>
<span class="line-modified">!             public DerValue next() {</span>
<span class="line-modified">!                 try {</span>
<span class="line-modified">!                     DerValue n = new DerValue(data, pos, end, allowBER, false);</span>
<span class="line-modified">!                     pos = n.end;</span>
<span class="line-modified">!                     return n;</span>
<span class="line-modified">!                 } catch (IOException ioe) {</span>
<span class="line-modified">!                     throw new UncheckedIOException(ioe);</span>
<span class="line-modified">!                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+         };</span>
      }
  
<span class="line-modified">!     public DerInputStream(byte[] data, int start, int length, boolean allowBER) {</span>
<span class="line-modified">!         this.data = data;</span>
<span class="line-modified">!         this.start = start;</span>
<span class="line-modified">!         this.end = start + length;</span>
<span class="line-modified">!         this.allowBER = allowBER;</span>
<span class="line-modified">!         this.pos = start;</span>
      }
  
<span class="line-modified">!     public DerInputStream(DerValue v) {</span>
<span class="line-modified">!         this(v.buffer, v.start, v.end - v.start, v.allowBER);</span>
      }
  
<span class="line-modified">!     public DerInputStream(byte[] data) throws IOException {</span>
<span class="line-modified">!         this(data, 0, data.length, true);</span>
      }
  
<span class="line-modified">!     public DerInputStream(byte[] data, int offset, int len) throws IOException {</span>
<span class="line-modified">!         this(data, offset, len, true);</span>
      }
  
      public byte[] toByteArray() {
<span class="line-modified">!         return Arrays.copyOfRange(data, start, end);</span>
      }
  
      public int getInteger() throws IOException {
<span class="line-modified">!         return getDerValue().getInteger();</span>
      }
  
      public BigInteger getBigInteger() throws IOException {
<span class="line-modified">!         return getDerValue().getBigInteger();</span>
      }
  
      public BigInteger getPositiveBigInteger() throws IOException {
<span class="line-modified">!         return getDerValue().getPositiveBigInteger();</span>
      }
  
      public int getEnumerated() throws IOException {
<span class="line-modified">!         return getDerValue().getEnumerated();</span>
      }
  
      public byte[] getBitString() throws IOException {
<span class="line-modified">!         return getDerValue().getBitString();</span>
      }
  
      public BitArray getUnalignedBitString() throws IOException {
<span class="line-modified">!         return getDerValue().getUnalignedBitString();</span>
      }
  
      public byte[] getOctetString() throws IOException {
<span class="line-modified">!         return getDerValue().getOctetString();</span>
      }
  
      public void getNull() throws IOException {
<span class="line-modified">!         getDerValue().getNull();</span>
      }
  
      public ObjectIdentifier getOID() throws IOException {
<span class="line-modified">!         return getDerValue().getOID();</span>
      }
  
      public DerValue[] getSequence(int startLen) throws IOException {
<span class="line-modified">!         return getDerValue().subs(DerValue.tag_Sequence);</span>
      }
  
      public DerValue[] getSet(int startLen) throws IOException {
<span class="line-modified">!         return getDerValue().subs(DerValue.tag_Set);</span>
      }
  
<span class="line-modified">!     public DerValue[] getSet(int startLen, boolean implicit) throws IOException {</span>
<span class="line-modified">!         return getDerValue().subs((byte)0);</span>
      }
  
      public DerValue getDerValue() throws IOException {
<span class="line-modified">!         DerValue result = new DerValue(</span>
<span class="line-added">+                 this.data, this.pos, this.end - this.pos, this.allowBER, false);</span>
<span class="line-added">+         this.pos = result.end;</span>
<span class="line-added">+         return result;</span>
      }
  
      public String getUTF8String() throws IOException {
<span class="line-modified">!         return getDerValue().getUTF8String();</span>
      }
  
      public String getPrintableString() throws IOException {
<span class="line-modified">!         return getDerValue().getPrintableString();</span>
      }
  
      public String getT61String() throws IOException {
<span class="line-modified">!         return getDerValue().getT61String();</span>
      }
  
      public String getBMPString() throws IOException {
<span class="line-modified">!         return getDerValue().getBMPString();</span>
      }
  
<span class="line-modified">!     public String getIA5String() throws IOException {</span>
<span class="line-modified">!         return getDerValue().getIA5String();</span>
      }
  
<span class="line-modified">!     public String getGeneralString() throws IOException {</span>
<span class="line-modified">!         return getDerValue().getGeneralString();</span>
      }
  
      public Date getUTCTime() throws IOException {
<span class="line-modified">!         return getDerValue().getUTCTime();</span>
      }
  
      public Date getGeneralizedTime() throws IOException {
<span class="line-modified">!         return getDerValue().getGeneralizedTime();</span>
      }
  
      public int peekByte() throws IOException {
<span class="line-modified">!         if (pos == end) {</span>
<span class="line-modified">!             throw new IOException(&quot;At end&quot;);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         return data[pos];</span>
      }
  
      static int getLength(InputStream in) throws IOException {
          return getLength(in.read(), in);
      }
  
      /*
</pre>
<hr />
<pre>
<span class="line-old-header">*** 620,14 ***</span>
              }
          }
          return value;
      }
  
<span class="line-removed">-     int getDefiniteLength() throws IOException {</span>
<span class="line-removed">-         return getDefiniteLength(buffer);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      /*
       * Get a length from the input stream.
       *
       * @return the length
       * @exception IOException on parsing error or if indefinite length found.
<span class="line-new-header">--- 258,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 638,27 ***</span>
              throw new IOException(&quot;Indefinite length encoding not supported&quot;);
          }
          return len;
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * Mark the current position in the buffer, so that</span>
<span class="line-removed">-      * a later call to &lt;code&gt;reset&lt;/code&gt; will return here.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     public void mark(int value) { buffer.mark(value); }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
      /**
       * Return to the position of the last &lt;code&gt;mark&lt;/code&gt;
       * call.  A mark is implicitly set at the beginning of
       * the stream when it is created.
       */
<span class="line-modified">!     public void reset() { buffer.reset(); }</span>
  
  
      /**
       * Returns the number of bytes available for reading.
       * This is most useful for testing whether the stream is
       * empty.
       */
<span class="line-modified">!     public int available() { return buffer.available(); }</span>
  }
<span class="line-new-header">--- 272,21 ---</span>
              throw new IOException(&quot;Indefinite length encoding not supported&quot;);
          }
          return len;
      }
  
      /**
       * Return to the position of the last &lt;code&gt;mark&lt;/code&gt;
       * call.  A mark is implicitly set at the beginning of
       * the stream when it is created.
       */
<span class="line-modified">!     public void reset() { pos = start; }</span>
<span class="line-added">+     public void mark(int dummy) { }</span>
  
  
      /**
       * Returns the number of bytes available for reading.
       * This is most useful for testing whether the stream is
       * empty.
       */
<span class="line-modified">!     public int available() { return end - pos; }</span>
  }
</pre>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> <a href="DerValue.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>