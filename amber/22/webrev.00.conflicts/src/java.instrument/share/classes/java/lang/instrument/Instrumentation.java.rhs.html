<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.instrument/share/classes/java/lang/instrument/Instrumentation.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package java.lang.instrument;
 27 
 28 import java.security.ProtectionDomain;
 29 import java.util.List;
 30 import java.util.Map;
 31 import java.util.Set;
 32 import java.util.jar.JarFile;
 33 
 34 /*
 35  * Copyright 2003 Wily Technology, Inc.
 36  */
 37 
 38 /**
 39  * This class provides services needed to instrument Java
 40  * programming language code.
 41  * Instrumentation is the addition of byte-codes to methods for the
 42  * purpose of gathering data to be utilized by tools.
 43  * Since the changes are purely additive, these tools do not modify
 44  * application state or behavior.
 45  * Examples of such benign tools include monitoring agents, profilers,
 46  * coverage analyzers, and event loggers.
 47  *
 48  * &lt;P&gt;
 49  * There are two ways to obtain an instance of the
 50  * &lt;code&gt;Instrumentation&lt;/code&gt; interface:
 51  *
 52  * &lt;ol&gt;
 53  *   &lt;li&gt;&lt;p&gt; When a JVM is launched in a way that indicates an agent
 54  *     class. In that case an &lt;code&gt;Instrumentation&lt;/code&gt; instance
 55  *     is passed to the &lt;code&gt;premain&lt;/code&gt; method of the agent class.
 56  *     &lt;/p&gt;&lt;/li&gt;
 57  *   &lt;li&gt;&lt;p&gt; When a JVM provides a mechanism to start agents sometime
 58  *     after the JVM is launched. In that case an &lt;code&gt;Instrumentation&lt;/code&gt;
 59  *     instance is passed to the &lt;code&gt;agentmain&lt;/code&gt; method of the
 60  *     agent code. &lt;/p&gt; &lt;/li&gt;
 61  * &lt;/ol&gt;
 62  * &lt;p&gt;
 63  * These mechanisms are described in the
 64  * {@linkplain java.lang.instrument package specification}.
 65  * &lt;p&gt;
 66  * Once an agent acquires an &lt;code&gt;Instrumentation&lt;/code&gt; instance,
 67  * the agent may call methods on the instance at any time.
 68  *
 69  * @apiNote This interface is not intended to be implemented outside of
 70  * the java.instrument module.
 71  *
 72  * @since   1.5
 73  */
 74 public interface Instrumentation {
 75     /**
 76      * Registers the supplied transformer. All future class definitions
 77      * will be seen by the transformer, except definitions of classes upon which any
 78      * registered transformer is dependent.
 79      * The transformer is called when classes are loaded, when they are
 80      * {@linkplain #redefineClasses redefined}. and if &lt;code&gt;canRetransform&lt;/code&gt; is true,
 81      * when they are {@linkplain #retransformClasses retransformed}.
 82      * {@link ClassFileTransformer} defines the order of transform calls.
 83      *
 84      * If a transformer throws
 85      * an exception during execution, the JVM will still call the other registered
 86      * transformers in order. The same transformer may be added more than once,
 87      * but it is strongly discouraged -- avoid this by creating a new instance of
 88      * transformer class.
 89      * &lt;P&gt;
 90      * This method is intended for use in instrumentation, as described in the
 91      * {@linkplain Instrumentation class specification}.
 92      *
 93      * @param transformer          the transformer to register
 94      * @param canRetransform       can this transformer&#39;s transformations be retransformed
 95      * @throws java.lang.NullPointerException if passed a &lt;code&gt;null&lt;/code&gt; transformer
 96      * @throws java.lang.UnsupportedOperationException if &lt;code&gt;canRetransform&lt;/code&gt;
 97      * is true and the current configuration of the JVM does not allow
 98      * retransformation ({@link #isRetransformClassesSupported} is false)
 99      * @since 1.6
100      */
101     void
102     addTransformer(ClassFileTransformer transformer, boolean canRetransform);
103 
104     /**
105      * Registers the supplied transformer.
106      * &lt;P&gt;
107      * Same as &lt;code&gt;addTransformer(transformer, false)&lt;/code&gt;.
108      *
109      * @param transformer          the transformer to register
110      * @throws java.lang.NullPointerException if passed a &lt;code&gt;null&lt;/code&gt; transformer
111      * @see    #addTransformer(ClassFileTransformer,boolean)
112      */
113     void
114     addTransformer(ClassFileTransformer transformer);
115 
116     /**
117      * Unregisters the supplied transformer. Future class definitions will
118      * not be shown to the transformer. Removes the most-recently-added matching
119      * instance of the transformer. Due to the multi-threaded nature of
120      * class loading, it is possible for a transformer to receive calls
121      * after it has been removed. Transformers should be written defensively
122      * to expect this situation.
123      *
124      * @param transformer          the transformer to unregister
125      * @return  true if the transformer was found and removed, false if the
126      *           transformer was not found
127      * @throws java.lang.NullPointerException if passed a &lt;code&gt;null&lt;/code&gt; transformer
128      */
129     boolean
130     removeTransformer(ClassFileTransformer transformer);
131 
132     /**
133      * Returns whether or not the current JVM configuration supports retransformation
134      * of classes.
135      * The ability to retransform an already loaded class is an optional capability
136      * of a JVM.
137      * Retransformation will only be supported if the
138      * &lt;code&gt;Can-Retransform-Classes&lt;/code&gt; manifest attribute is set to
139      * &lt;code&gt;true&lt;/code&gt; in the agent JAR file (as described in the
140      * {@linkplain java.lang.instrument package specification}) and the JVM supports
141      * this capability.
142      * During a single instantiation of a single JVM, multiple calls to this
143      * method will always return the same answer.
144      * @return  true if the current JVM configuration supports retransformation of
145      *          classes, false if not.
146      * @see #retransformClasses
147      * @since 1.6
148      */
149     boolean
150     isRetransformClassesSupported();
151 
152     /**
153      * Retransform the supplied set of classes.
154      *
155      * &lt;P&gt;
156      * This function facilitates the instrumentation
157      * of already loaded classes.
158      * When classes are initially loaded or when they are
159      * {@linkplain #redefineClasses redefined},
160      * the initial class file bytes can be transformed with the
161      * {@link java.lang.instrument.ClassFileTransformer ClassFileTransformer}.
162      * This function reruns the transformation process
163      * (whether or not a transformation has previously occurred).
164      * This retransformation follows these steps:
165      *  &lt;ul&gt;
166      *    &lt;li&gt;starting from the initial class file bytes
167      *    &lt;/li&gt;
168      *    &lt;li&gt;for each transformer that was added with &lt;code&gt;canRetransform&lt;/code&gt;
169      *      false, the bytes returned by
170      *      {@link ClassFileTransformer#transform(Module,ClassLoader,String,Class,ProtectionDomain,byte[])
171      *      transform} during the last class load or redefine are
172      *      reused as the output of the transformation; note that this is
173      *      equivalent to reapplying the previous transformation, unaltered;
174      *      except that {@code transform} method is not called.
175      *    &lt;/li&gt;
176      *    &lt;li&gt;for each transformer that was added with &lt;code&gt;canRetransform&lt;/code&gt;
177      *      true, the
178      *      {@link ClassFileTransformer#transform(Module,ClassLoader,String,Class,ProtectionDomain,byte[])
179      *      transform} method is called in these transformers
180      *    &lt;/li&gt;
181      *    &lt;li&gt;the transformed class file bytes are installed as the new
182      *      definition of the class
183      *    &lt;/li&gt;
184      *  &lt;/ul&gt;
185      * &lt;P&gt;
186      *
187      * The order of transformation is described in {@link ClassFileTransformer}.
188      * This same order is used in the automatic reapplication of
189      * retransformation incapable transforms.
190      * &lt;P&gt;
191      *
192      * The initial class file bytes represent the bytes passed to
193      * {@link java.lang.ClassLoader#defineClass ClassLoader.defineClass} or
194      * {@link #redefineClasses redefineClasses}
195      * (before any transformations
196      *  were applied), however they might not exactly match them.
197      *  The constant pool might not have the same layout or contents.
198      *  The constant pool may have more or fewer entries.
199      *  Constant pool entries may be in a different order; however,
200      *  constant pool indices in the bytecodes of methods will correspond.
201      *  Some attributes may not be present.
202      *  Where order is not meaningful, for example the order of methods,
203      *  order might not be preserved.
204      *
205      * &lt;P&gt;
206      * This method operates on
207      * a set in order to allow interdependent changes to more than one class at the same time
208      * (a retransformation of class A can require a retransformation of class B).
209      *
210      * &lt;P&gt;
211      * If a retransformed method has active stack frames, those active frames continue to
212      * run the bytecodes of the original method.
213      * The retransformed method will be used on new invokes.
214      *
215      * &lt;P&gt;
216      * This method does not cause any initialization except that which would occur
217      * under the customary JVM semantics. In other words, redefining a class
218      * does not cause its initializers to be run. The values of static variables
219      * will remain as they were prior to the call.
220      *
221      * &lt;P&gt;
222      * Instances of the retransformed class are not affected.
223      *
224      * &lt;P&gt;
<a name="1" id="anc1"></a><span class="line-added">225 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span>
226      * The supported class file changes are described in
227      * &lt;a href=&quot;{@docRoot}/../specs/jvmti.html#RetransformClasses&quot;&gt;JVM TI RetransformClasses&lt;/a&gt;.
<a name="2" id="anc2"></a><span class="line-added">228 =======</span>
<span class="line-added">229      * The retransformation may change method bodies, the constant pool and</span>
<span class="line-added">230      * attributes (unless explicitly prohibited).</span>
<span class="line-added">231      * The retransformation must not add, remove or rename fields or methods, change the</span>
<span class="line-added">232      * signatures of methods, or change inheritance.</span>
<span class="line-added">233      * The retransformation must not change the &lt;code&gt;NestHost&lt;/code&gt;, &lt;code&gt;NestMembers&lt;/code&gt;,</span>
<span class="line-added">234      * &lt;code&gt;PermittedSubclasses&lt;/code&gt;, or &lt;code&gt;Record&lt;/code&gt; attributes.</span>
<span class="line-added">235      * These restrictions may be lifted in future versions.</span>
<span class="line-added">236 &gt;&gt;&gt;&gt;&gt;&gt;&gt; 926ea22b56c80bf0e4ce5f1d92bc1d31ac91e978</span>
237      * The class file bytes are not checked, verified and installed
238      * until after the transformations have been applied, if the resultant bytes are in
239      * error this method will throw an exception.
240      *
241      * &lt;P&gt;
242      * If this method throws an exception, no classes have been retransformed.
243      * &lt;P&gt;
244      * This method is intended for use in instrumentation, as described in the
245      * {@linkplain Instrumentation class specification}.
246      *
247      * @param classes array of classes to retransform;
248      *                a zero-length array is allowed, in this case, this method does nothing
249      * @throws java.lang.instrument.UnmodifiableClassException if a specified class cannot be modified
250      * ({@link #isModifiableClass} would return &lt;code&gt;false&lt;/code&gt;)
251      * @throws java.lang.UnsupportedOperationException if the current configuration of the JVM does not allow
252      * retransformation ({@link #isRetransformClassesSupported} is false) or the retransformation attempted
253      * to make unsupported changes
254      * @throws java.lang.ClassFormatError if the data did not contain a valid class
255      * @throws java.lang.NoClassDefFoundError if the name in the class file is not equal to the name of the class
256      * @throws java.lang.UnsupportedClassVersionError if the class file version numbers are not supported
257      * @throws java.lang.ClassCircularityError if the new classes contain a circularity
258      * @throws java.lang.LinkageError if a linkage error occurs
259      * @throws java.lang.NullPointerException if the supplied classes  array or any of its components
260      *                                        is &lt;code&gt;null&lt;/code&gt;.
261      *
262      * @see #isRetransformClassesSupported
263      * @see #addTransformer
264      * @see java.lang.instrument.ClassFileTransformer
265      * @since 1.6
266      */
267     void
268     retransformClasses(Class&lt;?&gt;... classes) throws UnmodifiableClassException;
269 
270     /**
271      * Returns whether or not the current JVM configuration supports redefinition
272      * of classes.
273      * The ability to redefine an already loaded class is an optional capability
274      * of a JVM.
275      * Redefinition will only be supported if the
276      * &lt;code&gt;Can-Redefine-Classes&lt;/code&gt; manifest attribute is set to
277      * &lt;code&gt;true&lt;/code&gt; in the agent JAR file (as described in the
278      * {@linkplain java.lang.instrument package specification}) and the JVM supports
279      * this capability.
280      * During a single instantiation of a single JVM, multiple calls to this
281      * method will always return the same answer.
282      * @return  true if the current JVM configuration supports redefinition of classes,
283      * false if not.
284      * @see #redefineClasses
285      */
286     boolean
287     isRedefineClassesSupported();
288 
289     /**
290      * Redefine the supplied set of classes using the supplied class files.
291      *
292      * &lt;P&gt;
293      * This method is used to replace the definition of a class without reference
294      * to the existing class file bytes, as one might do when recompiling from source
295      * for fix-and-continue debugging.
296      * Where the existing class file bytes are to be transformed (for
297      * example in bytecode instrumentation)
298      * {@link #retransformClasses retransformClasses}
299      * should be used.
300      *
301      * &lt;P&gt;
302      * This method operates on
303      * a set in order to allow interdependent changes to more than one class at the same time
304      * (a redefinition of class A can require a redefinition of class B).
305      *
306      * &lt;P&gt;
307      * If a redefined method has active stack frames, those active frames continue to
308      * run the bytecodes of the original method.
309      * The redefined method will be used on new invokes.
310      *
311      * &lt;P&gt;
312      * This method does not cause any initialization except that which would occur
313      * under the customary JVM semantics. In other words, redefining a class
314      * does not cause its initializers to be run. The values of static variables
315      * will remain as they were prior to the call.
316      *
317      * &lt;P&gt;
318      * Instances of the redefined class are not affected.
319      *
320      * &lt;P&gt;
<a name="3" id="anc3"></a><span class="line-added">321 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span>
322      * The supported class file changes are described in
323      * &lt;a href=&quot;{@docRoot}/../specs/jvmti.html#RedefineClasses&quot;&gt;JVM TI RedefineClasses&lt;/a&gt;.
<a name="4" id="anc4"></a><span class="line-added">324 =======</span>
<span class="line-added">325      * The redefinition may change method bodies, the constant pool and attributes</span>
<span class="line-added">326      * (unless explicitly prohibited).</span>
<span class="line-added">327      * The redefinition must not add, remove or rename fields or methods, change the</span>
<span class="line-added">328      * signatures of methods, or change inheritance.</span>
<span class="line-added">329      * The redefinition must not change the &lt;code&gt;NestHost&lt;/code&gt;, &lt;code&gt;NestMembers&lt;/code&gt;,</span>
<span class="line-added">330      * &lt;code&gt;PermittedSubclasses&lt;/code&gt;, or &lt;code&gt;Record&lt;/code&gt; attributes.</span>
<span class="line-added">331      * These restrictions may be lifted in future versions.</span>
<span class="line-added">332 &gt;&gt;&gt;&gt;&gt;&gt;&gt; 926ea22b56c80bf0e4ce5f1d92bc1d31ac91e978</span>
333      * The class file bytes are not checked, verified and installed
334      * until after the transformations have been applied, if the resultant bytes are in
335      * error this method will throw an exception.
336      *
337      * &lt;P&gt;
338      * If this method throws an exception, no classes have been redefined.
339      * &lt;P&gt;
340      * This method is intended for use in instrumentation, as described in the
341      * {@linkplain Instrumentation class specification}.
342      *
343      * @param definitions array of classes to redefine with corresponding definitions;
344      *                    a zero-length array is allowed, in this case, this method does nothing
345      * @throws java.lang.instrument.UnmodifiableClassException if a specified class cannot be modified
346      * ({@link #isModifiableClass} would return &lt;code&gt;false&lt;/code&gt;)
347      * @throws java.lang.UnsupportedOperationException if the current configuration of the JVM does not allow
348      * redefinition ({@link #isRedefineClassesSupported} is false) or the redefinition attempted
349      * to make unsupported changes
350      * @throws java.lang.ClassFormatError if the data did not contain a valid class
351      * @throws java.lang.NoClassDefFoundError if the name in the class file is not equal to the name of the class
352      * @throws java.lang.UnsupportedClassVersionError if the class file version numbers are not supported
353      * @throws java.lang.ClassCircularityError if the new classes contain a circularity
354      * @throws java.lang.LinkageError if a linkage error occurs
355      * @throws java.lang.NullPointerException if the supplied definitions array or any of its components
356      * is &lt;code&gt;null&lt;/code&gt;
357      * @throws java.lang.ClassNotFoundException Can never be thrown (present for compatibility reasons only)
358      *
359      * @see #isRedefineClassesSupported
360      * @see #addTransformer
361      * @see java.lang.instrument.ClassFileTransformer
362      */
363     void
364     redefineClasses(ClassDefinition... definitions)
365         throws  ClassNotFoundException, UnmodifiableClassException;
366 
367 
368     /**
369      * Tests whether a class is modifiable by
370      * {@linkplain #retransformClasses retransformation}
371      * or {@linkplain #redefineClasses redefinition}.
372      * If a class is modifiable then this method returns &lt;code&gt;true&lt;/code&gt;.
373      * If a class is not modifiable then this method returns &lt;code&gt;false&lt;/code&gt;.
374      * &lt;P&gt;
375      * For a class to be retransformed, {@link #isRetransformClassesSupported} must also be true.
376      * But the value of &lt;code&gt;isRetransformClassesSupported()&lt;/code&gt; does not influence the value
377      * returned by this function.
378      * For a class to be redefined, {@link #isRedefineClassesSupported} must also be true.
379      * But the value of &lt;code&gt;isRedefineClassesSupported()&lt;/code&gt; does not influence the value
380      * returned by this function.
381      * &lt;P&gt;
382      * Primitive classes (for example, &lt;code&gt;java.lang.Integer.TYPE&lt;/code&gt;)
383      * and array classes are never modifiable.
384      *
385      * @param theClass the class to check for being modifiable
386      * @return whether or not the argument class is modifiable
387      * @throws java.lang.NullPointerException if the specified class is &lt;code&gt;null&lt;/code&gt;.
388      *
389      * @see #retransformClasses
390      * @see #isRetransformClassesSupported
391      * @see #redefineClasses
392      * @see #isRedefineClassesSupported
393      * @since 1.6
394      */
395     boolean
396     isModifiableClass(Class&lt;?&gt; theClass);
397 
398     /**
399      * Returns an array of all classes currently loaded by the JVM.
400      * The returned array includes all classes and interfaces, including
401      * {@linkplain Class#isHidden hidden classes or interfaces}, and array classes
402      * of all types.
403      *
404      * @return an array containing all the classes loaded by the JVM, zero-length if there are none
405      */
406     @SuppressWarnings(&quot;rawtypes&quot;)
407     Class[]
408     getAllLoadedClasses();
409 
410     /**
411      * Returns an array of all classes which {@code loader} can find by name
412      * via {@link ClassLoader#loadClass(String, boolean) ClassLoader::loadClass},
413      * {@link Class#forName(String) Class::forName} and bytecode linkage.
414      * That is, all classes for which {@code loader} has been recorded as
415      * an initiating loader. If the supplied {@code loader} is {@code null},
416      * classes that the bootstrap class loader can find by name are returned.
417      * &lt;p&gt;
418      * The returned array does not include {@linkplain Class#isHidden()
419      * hidden classes or interfaces} or array classes whose
420      * {@linkplain Class#componentType() element type} is a
421      * {@linkplain Class#isHidden() hidden class or interface}.
422      * as they cannot be discovered by any class loader.
423      *
424      * @param loader          the loader whose initiated class list will be returned
425      * @return an array containing all classes which {@code loader} can find by name;
426      *          zero-length if there are none
427      */
428     @SuppressWarnings(&quot;rawtypes&quot;)
429     Class[]
430     getInitiatedClasses(ClassLoader loader);
431 
432     /**
433      * Returns an implementation-specific approximation of the amount of storage consumed by
434      * the specified object. The result may include some or all of the object&#39;s overhead,
435      * and thus is useful for comparison within an implementation but not between implementations.
436      *
437      * The estimate may change during a single invocation of the JVM.
438      *
439      * @param objectToSize     the object to size
440      * @return an implementation-specific approximation of the amount of storage consumed by the specified object
441      * @throws java.lang.NullPointerException if the supplied Object is &lt;code&gt;null&lt;/code&gt;.
442      */
443     long
444     getObjectSize(Object objectToSize);
445 
446 
447     /**
448      * Specifies a JAR file with instrumentation classes to be defined by the
449      * bootstrap class loader.
450      *
451      * &lt;p&gt; When the virtual machine&#39;s built-in class loader, known as the &quot;bootstrap
452      * class loader&quot;, unsuccessfully searches for a class, the entries in the {@link
453      * java.util.jar.JarFile JAR file} will be searched as well.
454      *
455      * &lt;p&gt; This method may be used multiple times to add multiple JAR files to be
456      * searched in the order that this method was invoked.
457      *
458      * &lt;p&gt; The agent should take care to ensure that the JAR does not contain any
459      * classes or resources other than those to be defined by the bootstrap
460      * class loader for the purpose of instrumentation.
461      * Failure to observe this warning could result in unexpected
462      * behavior that is difficult to diagnose. For example, suppose there is a
463      * loader L, and L&#39;s parent for delegation is the bootstrap class loader.
464      * Furthermore, a method in class C, a class defined by L, makes reference to
465      * a non-public accessor class C$1. If the JAR file contains a class C$1 then
466      * the delegation to the bootstrap class loader will cause C$1 to be defined
467      * by the bootstrap class loader. In this example an &lt;code&gt;IllegalAccessError&lt;/code&gt;
468      * will be thrown that may cause the application to fail. One approach to
469      * avoiding these types of issues, is to use a unique package name for the
470      * instrumentation classes.
471      *
472      * &lt;p&gt;
473      * &lt;cite&gt;The Java&amp;trade; Virtual Machine Specification&lt;/cite&gt;
474      * specifies that a subsequent attempt to resolve a symbolic
475      * reference that the Java virtual machine has previously unsuccessfully attempted
476      * to resolve always fails with the same error that was thrown as a result of the
477      * initial resolution attempt. Consequently, if the JAR file contains an entry
478      * that corresponds to a class for which the Java virtual machine has
479      * unsuccessfully attempted to resolve a reference, then subsequent attempts to
480      * resolve that reference will fail with the same error as the initial attempt.
481      *
482      * @param   jarfile
483      *          The JAR file to be searched when the bootstrap class loader
484      *          unsuccessfully searches for a class.
485      *
486      * @throws  NullPointerException
487      *          If &lt;code&gt;jarfile&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;.
488      *
489      * @see     #appendToSystemClassLoaderSearch
490      * @see     java.lang.ClassLoader
491      * @see     java.util.jar.JarFile
492      *
493      * @since 1.6
494      */
495     void
496     appendToBootstrapClassLoaderSearch(JarFile jarfile);
497 
498     /**
499      * Specifies a JAR file with instrumentation classes to be defined by the
500      * system class loader.
501      *
502      * When the system class loader for delegation (see
503      * {@link java.lang.ClassLoader#getSystemClassLoader getSystemClassLoader()})
504      * unsuccessfully searches for a class, the entries in the {@link
505      * java.util.jar.JarFile JarFile} will be searched as well.
506      *
507      * &lt;p&gt; This method may be used multiple times to add multiple JAR files to be
508      * searched in the order that this method was invoked.
509      *
510      * &lt;p&gt; The agent should take care to ensure that the JAR does not contain any
511      * classes or resources other than those to be defined by the system class
512      * loader for the purpose of instrumentation.
513      * Failure to observe this warning could result in unexpected
514      * behavior that is difficult to diagnose (see
515      * {@link #appendToBootstrapClassLoaderSearch
516      * appendToBootstrapClassLoaderSearch}).
517      *
518      * &lt;p&gt; The system class loader supports adding a JAR file to be searched if
519      * it implements a method named &lt;code&gt;appendToClassPathForInstrumentation&lt;/code&gt;
520      * which takes a single parameter of type &lt;code&gt;java.lang.String&lt;/code&gt;. The
521      * method is not required to have &lt;code&gt;public&lt;/code&gt; access. The name of
522      * the JAR file is obtained by invoking the {@link java.util.zip.ZipFile#getName
523      * getName()} method on the &lt;code&gt;jarfile&lt;/code&gt; and this is provided as the
524      * parameter to the &lt;code&gt;appendToClassPathForInstrumentation&lt;/code&gt; method.
525      *
526      * &lt;p&gt;
527      * &lt;cite&gt;The Java&amp;trade; Virtual Machine Specification&lt;/cite&gt;
528      * specifies that a subsequent attempt to resolve a symbolic
529      * reference that the Java virtual machine has previously unsuccessfully attempted
530      * to resolve always fails with the same error that was thrown as a result of the
531      * initial resolution attempt. Consequently, if the JAR file contains an entry
532      * that corresponds to a class for which the Java virtual machine has
533      * unsuccessfully attempted to resolve a reference, then subsequent attempts to
534      * resolve that reference will fail with the same error as the initial attempt.
535      *
536      * &lt;p&gt; This method does not change the value of &lt;code&gt;java.class.path&lt;/code&gt;
537      * {@link java.lang.System#getProperties system property}.
538      *
539      * @param   jarfile
540      *          The JAR file to be searched when the system class loader
541      *          unsuccessfully searches for a class.
542      *
543      * @throws  UnsupportedOperationException
544      *          If the system class loader does not support appending a
545      *          a JAR file to be searched.
546      *
547      * @throws  NullPointerException
548      *          If &lt;code&gt;jarfile&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;.
549      *
550      * @see     #appendToBootstrapClassLoaderSearch
551      * @see     java.lang.ClassLoader#getSystemClassLoader
552      * @see     java.util.jar.JarFile
553      * @since 1.6
554      */
555     void
556     appendToSystemClassLoaderSearch(JarFile jarfile);
557 
558     /**
559      * Returns whether the current JVM configuration supports
560      * {@linkplain #setNativeMethodPrefix(ClassFileTransformer,String)
561      * setting a native method prefix}.
562      * The ability to set a native method prefix is an optional
563      * capability of a JVM.
564      * Setting a native method prefix will only be supported if the
565      * &lt;code&gt;Can-Set-Native-Method-Prefix&lt;/code&gt; manifest attribute is set to
566      * &lt;code&gt;true&lt;/code&gt; in the agent JAR file (as described in the
567      * {@linkplain java.lang.instrument package specification}) and the JVM supports
568      * this capability.
569      * During a single instantiation of a single JVM, multiple
570      * calls to this method will always return the same answer.
571      * @return  true if the current JVM configuration supports
572      * setting a native method prefix, false if not.
573      * @see #setNativeMethodPrefix
574      * @since 1.6
575      */
576     boolean
577     isNativeMethodPrefixSupported();
578 
579     /**
580      * This method modifies the failure handling of
581      * native method resolution by allowing retry
582      * with a prefix applied to the name.
583      * When used with the
584      * {@link java.lang.instrument.ClassFileTransformer ClassFileTransformer},
585      * it enables native methods to be
586      * instrumented.
587      * &lt;p&gt;
588      * Since native methods cannot be directly instrumented
589      * (they have no bytecodes), they must be wrapped with
590      * a non-native method which can be instrumented.
591      * For example, if we had:
592      * &lt;pre&gt;
593      *   native boolean foo(int x);&lt;/pre&gt;
594      * &lt;p&gt;
595      * We could transform the class file (with the
596      * ClassFileTransformer during the initial definition
597      * of the class) so that this becomes:
598      * &lt;pre&gt;
599      *   boolean foo(int x) {
600      *     &lt;i&gt;... record entry to foo ...&lt;/i&gt;
601      *     return wrapped_foo(x);
602      *   }
603      *
604      *   native boolean wrapped_foo(int x);&lt;/pre&gt;
605      * &lt;p&gt;
606      * Where &lt;code&gt;foo&lt;/code&gt; becomes a wrapper for the actual native
607      * method with the appended prefix &quot;wrapped_&quot;.  Note that
608      * &quot;wrapped_&quot; would be a poor choice of prefix since it
609      * might conceivably form the name of an existing method
610      * thus something like &quot;$$$MyAgentWrapped$$$_&quot; would be
611      * better but would make these examples less readable.
612      * &lt;p&gt;
613      * The wrapper will allow data to be collected on the native
614      * method call, but now the problem becomes linking up the
615      * wrapped method with the native implementation.
616      * That is, the method &lt;code&gt;wrapped_foo&lt;/code&gt; needs to be
617      * resolved to the native implementation of &lt;code&gt;foo&lt;/code&gt;,
618      * which might be:
619      * &lt;pre&gt;
620      *   Java_somePackage_someClass_foo(JNIEnv* env, jint x)&lt;/pre&gt;
621      * &lt;p&gt;
622      * This function allows the prefix to be specified and the
623      * proper resolution to occur.
624      * Specifically, when the standard resolution fails, the
625      * resolution is retried taking the prefix into consideration.
626      * There are two ways that resolution occurs, explicit
627      * resolution with the JNI function &lt;code&gt;RegisterNatives&lt;/code&gt;
628      * and the normal automatic resolution.  For
629      * &lt;code&gt;RegisterNatives&lt;/code&gt;, the JVM will attempt this
630      * association:
631      * &lt;pre&gt;{@code
632      *   method(foo) -&gt; nativeImplementation(foo)
633      * }&lt;/pre&gt;
634      * &lt;p&gt;
635      * When this fails, the resolution will be retried with
636      * the specified prefix prepended to the method name,
637      * yielding the correct resolution:
638      * &lt;pre&gt;{@code
639      *   method(wrapped_foo) -&gt; nativeImplementation(foo)
640      * }&lt;/pre&gt;
641      * &lt;p&gt;
642      * For automatic resolution, the JVM will attempt:
643      * &lt;pre&gt;{@code
644      *   method(wrapped_foo) -&gt; nativeImplementation(wrapped_foo)
645      * }&lt;/pre&gt;
646      * &lt;p&gt;
647      * When this fails, the resolution will be retried with
648      * the specified prefix deleted from the implementation name,
649      * yielding the correct resolution:
650      * &lt;pre&gt;{@code
651      *   method(wrapped_foo) -&gt; nativeImplementation(foo)
652      * }&lt;/pre&gt;
653      * &lt;p&gt;
654      * Note that since the prefix is only used when standard
655      * resolution fails, native methods can be wrapped selectively.
656      * &lt;p&gt;
657      * Since each &lt;code&gt;ClassFileTransformer&lt;/code&gt;
658      * can do its own transformation of the bytecodes, more
659      * than one layer of wrappers may be applied. Thus each
660      * transformer needs its own prefix.  Since transformations
661      * are applied in order, the prefixes, if applied, will
662      * be applied in the same order
663      * (see {@link #addTransformer(ClassFileTransformer,boolean) addTransformer}).
664      * Thus if three transformers applied
665      * wrappers, &lt;code&gt;foo&lt;/code&gt; might become
666      * &lt;code&gt;$trans3_$trans2_$trans1_foo&lt;/code&gt;.  But if, say,
667      * the second transformer did not apply a wrapper to
668      * &lt;code&gt;foo&lt;/code&gt; it would be just
669      * &lt;code&gt;$trans3_$trans1_foo&lt;/code&gt;.  To be able to
670      * efficiently determine the sequence of prefixes,
671      * an intermediate prefix is only applied if its non-native
672      * wrapper exists.  Thus, in the last example, even though
673      * &lt;code&gt;$trans1_foo&lt;/code&gt; is not a native method, the
674      * &lt;code&gt;$trans1_&lt;/code&gt; prefix is applied since
675      * &lt;code&gt;$trans1_foo&lt;/code&gt; exists.
676      *
677      * @param   transformer
678      *          The ClassFileTransformer which wraps using this prefix.
679      * @param   prefix
680      *          The prefix to apply to wrapped native methods when
681      *          retrying a failed native method resolution. If prefix
682      *          is either &lt;code&gt;null&lt;/code&gt; or the empty string, then
683      *          failed native method resolutions are not retried for
684      *          this transformer.
685      * @throws java.lang.NullPointerException if passed a &lt;code&gt;null&lt;/code&gt; transformer.
686      * @throws java.lang.UnsupportedOperationException if the current configuration of
687      *           the JVM does not allow setting a native method prefix
688      *           ({@link #isNativeMethodPrefixSupported} is false).
689      * @throws java.lang.IllegalArgumentException if the transformer is not registered
690      *           (see {@link #addTransformer(ClassFileTransformer,boolean) addTransformer}).
691      *
692      * @since 1.6
693      */
694     void
695     setNativeMethodPrefix(ClassFileTransformer transformer, String prefix);
696 
697     /**
698      * Redefine a module to expand the set of modules that it reads, the set of
699      * packages that it exports or opens, or the services that it uses or
700      * provides. This method facilitates the instrumentation of code in named
701      * modules where that instrumentation requires changes to the set of modules
702      * that are read, the packages that are exported or open, or the services
703      * that are used or provided.
704      *
705      * &lt;p&gt; This method cannot reduce the set of modules that a module reads, nor
706      * reduce the set of packages that it exports or opens, nor reduce the set
707      * of services that it uses or provides. This method is a no-op when invoked
708      * to redefine an unnamed module. &lt;/p&gt;
709      *
710      * &lt;p&gt; When expanding the services that a module uses or provides then the
711      * onus is on the agent to ensure that the service type will be accessible at
712      * each instrumentation site where the service type is used. This method
713      * does not check if the service type is a member of the module or in a
714      * package exported to the module by another module that it reads. &lt;/p&gt;
715      *
716      * &lt;p&gt; The {@code extraExports} parameter is the map of additional packages
717      * to export. The {@code extraOpens} parameter is the map of additional
718      * packages to open. In both cases, the map key is the fully-qualified name
719      * of the package as defined in section 6.5.3 of
720      * &lt;cite&gt;The Java&amp;trade; Language Specification &lt;/cite&gt;, for example, {@code
721      * &quot;java.lang&quot;}. The map value is the non-empty set of modules that the
722      * package should be exported or opened to. &lt;/p&gt;
723      *
724      * &lt;p&gt; The {@code extraProvides} parameter is the additional service providers
725      * for the module to provide. The map key is the service type. The map value
726      * is the non-empty list of implementation types, each of which is a member
727      * of the module and an implementation of the service. &lt;/p&gt;
728      *
729      * &lt;p&gt; This method is safe for concurrent use and so allows multiple agents
730      * to instrument and update the same module at around the same time. &lt;/p&gt;
731      *
732      * @param module the module to redefine
733      * @param extraReads the possibly-empty set of additional modules to read
734      * @param extraExports the possibly-empty map of additional packages to export
735      * @param extraOpens the possibly-empty map of additional packages to open
736      * @param extraUses the possibly-empty set of additional services to use
737      * @param extraProvides the possibly-empty map of additional services to provide
738      *
739      * @throws IllegalArgumentException
740      *         If {@code extraExports} or {@code extraOpens} contains a key
741      *         that is not a package in the module; if {@code extraExports} or
742      *         {@code extraOpens} maps a key to an empty set; if a value in the
743      *         {@code extraProvides} map contains a service provider type that
744      *         is not a member of the module or an implementation of the service;
745      *         or {@code extraProvides} maps a key to an empty list
746      * @throws UnmodifiableModuleException if the module cannot be modified
747      * @throws NullPointerException if any of the arguments are {@code null} or
748      *         any of the Sets or Maps contains a {@code null} key or value
749      *
750      * @see #isModifiableModule(Module)
751      * @since 9
752      * @spec JPMS
753      */
754     void redefineModule(Module module,
755                         Set&lt;Module&gt; extraReads,
756                         Map&lt;String, Set&lt;Module&gt;&gt; extraExports,
757                         Map&lt;String, Set&lt;Module&gt;&gt; extraOpens,
758                         Set&lt;Class&lt;?&gt;&gt; extraUses,
759                         Map&lt;Class&lt;?&gt;, List&lt;Class&lt;?&gt;&gt;&gt; extraProvides);
760 
761     /**
762      * Tests whether a module can be modified with {@link #redefineModule
763      * redefineModule}. If a module is modifiable then this method returns
764      * {@code true}. If a module is not modifiable then this method returns
765      * {@code false}. This method always returns {@code true} when the module
766      * is an unnamed module (as redefining an unnamed module is a no-op).
767      *
768      * @param module the module to test if it can be modified
769      * @return {@code true} if the module is modifiable, otherwise {@code false}
770      * @throws NullPointerException if the module is {@code null}
771      *
772      * @since 9
773      * @spec JPMS
774      */
775     boolean isModifiableModule(Module module);
776 }
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>