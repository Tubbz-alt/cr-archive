<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/unix/native/libnio/fs/UnixNativeDispatcher.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../libjli/java_md_common.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../windows/native/libjli/java_md.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/native/libnio/fs/UnixNativeDispatcher.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 344     len = strlen(tmpbuf);
 345     bytes = (*env)-&gt;NewByteArray(env, len);
 346     if (bytes != NULL) {
 347         (*env)-&gt;SetByteArrayRegion(env, bytes, 0, len, (jbyte*)tmpbuf);
 348     }
 349     return bytes;
 350 }
 351 
 352 JNIEXPORT jint
 353 Java_sun_nio_fs_UnixNativeDispatcher_dup(JNIEnv* env, jclass this, jint fd) {
 354 
 355     int res = -1;
 356 
 357     RESTARTABLE(dup((int)fd), res);
 358     if (res == -1) {
 359         throwUnixException(env, errno);
 360     }
 361     return (jint)res;
 362 }
 363 
<span class="line-removed"> 364 JNIEXPORT jlong JNICALL</span>
<span class="line-removed"> 365 Java_sun_nio_fs_UnixNativeDispatcher_fopen0(JNIEnv* env, jclass this,</span>
<span class="line-removed"> 366     jlong pathAddress, jlong modeAddress)</span>
<span class="line-removed"> 367 {</span>
<span class="line-removed"> 368     FILE* fp = NULL;</span>
<span class="line-removed"> 369     const char* path = (const char*)jlong_to_ptr(pathAddress);</span>
<span class="line-removed"> 370     const char* mode = (const char*)jlong_to_ptr(modeAddress);</span>
<span class="line-removed"> 371 </span>
<span class="line-removed"> 372     do {</span>
<span class="line-removed"> 373         fp = fopen(path, mode);</span>
<span class="line-removed"> 374     } while (fp == NULL &amp;&amp; errno == EINTR);</span>
<span class="line-removed"> 375 </span>
<span class="line-removed"> 376     if (fp == NULL) {</span>
<span class="line-removed"> 377         throwUnixException(env, errno);</span>
<span class="line-removed"> 378     }</span>
<span class="line-removed"> 379 </span>
<span class="line-removed"> 380     return ptr_to_jlong(fp);</span>
<span class="line-removed"> 381 }</span>
<span class="line-removed"> 382 </span>
<span class="line-removed"> 383 JNIEXPORT void JNICALL</span>
<span class="line-removed"> 384 Java_sun_nio_fs_UnixNativeDispatcher_fclose(JNIEnv* env, jclass this, jlong stream)</span>
<span class="line-removed"> 385 {</span>
<span class="line-removed"> 386     FILE* fp = jlong_to_ptr(stream);</span>
<span class="line-removed"> 387 </span>
<span class="line-removed"> 388     /* NOTE: fclose() wrapper is only used with read-only streams.</span>
<span class="line-removed"> 389      * If it ever is used with write streams, it might be better to add</span>
<span class="line-removed"> 390      * RESTARTABLE(fflush(fp)) before closing, to make sure the stream</span>
<span class="line-removed"> 391      * is completely written even if fclose() failed.</span>
<span class="line-removed"> 392      */</span>
<span class="line-removed"> 393     if (fclose(fp) == EOF &amp;&amp; errno != EINTR) {</span>
<span class="line-removed"> 394         throwUnixException(env, errno);</span>
<span class="line-removed"> 395     }</span>
<span class="line-removed"> 396 }</span>
<span class="line-removed"> 397 </span>
 398 JNIEXPORT void JNICALL
 399 Java_sun_nio_fs_UnixNativeDispatcher_rewind(JNIEnv* env, jclass this, jlong stream)
 400 {
 401     FILE* fp = jlong_to_ptr(stream);
 402     int saved_errno;
 403 
 404     errno = 0;
 405     rewind(fp);
 406     saved_errno = errno;
 407     if (ferror(fp)) {
 408         throwUnixException(env, saved_errno);
 409     }
 410 }
 411 
 412 /**
 413  * This function returns line length without NUL terminator or -1 on EOF.
 414  */
 415 JNIEXPORT jint JNICALL
 416 Java_sun_nio_fs_UnixNativeDispatcher_getlinelen(JNIEnv* env, jclass this, jlong stream)
 417 {
</pre>
<hr />
<pre>
1059         if (buf.f_blocks == ULONG_MAX) {
1060             buf.f_blocks = 0;
1061         }
1062         /* The number of free or available blocks can never exceed the total number of blocks */
1063         if (buf.f_blocks == 0) {
1064             buf.f_bfree = 0;
1065             buf.f_bavail = 0;
1066         }
1067 #endif
1068 #ifdef MACOSX
1069         (*env)-&gt;SetLongField(env, attrs, attrs_f_frsize, long_to_jlong(buf.f_bsize));
1070 #else
1071         (*env)-&gt;SetLongField(env, attrs, attrs_f_frsize, long_to_jlong(buf.f_frsize));
1072 #endif
1073         (*env)-&gt;SetLongField(env, attrs, attrs_f_blocks, long_to_jlong(buf.f_blocks));
1074         (*env)-&gt;SetLongField(env, attrs, attrs_f_bfree,  long_to_jlong(buf.f_bfree));
1075         (*env)-&gt;SetLongField(env, attrs, attrs_f_bavail, long_to_jlong(buf.f_bavail));
1076     }
1077 }
1078 
<span class="line-removed">1079 JNIEXPORT jlong JNICALL</span>
<span class="line-removed">1080 Java_sun_nio_fs_UnixNativeDispatcher_pathconf0(JNIEnv* env, jclass this,</span>
<span class="line-removed">1081     jlong pathAddress, jint name)</span>
<span class="line-removed">1082 {</span>
<span class="line-removed">1083     long err;</span>
<span class="line-removed">1084     const char* path = (const char*)jlong_to_ptr(pathAddress);</span>
<span class="line-removed">1085 </span>
<span class="line-removed">1086     err = pathconf(path, (int)name);</span>
<span class="line-removed">1087     if (err == -1) {</span>
<span class="line-removed">1088         throwUnixException(env, errno);</span>
<span class="line-removed">1089     }</span>
<span class="line-removed">1090     return (jlong)err;</span>
<span class="line-removed">1091 }</span>
<span class="line-removed">1092 </span>
<span class="line-removed">1093 JNIEXPORT jlong JNICALL</span>
<span class="line-removed">1094 Java_sun_nio_fs_UnixNativeDispatcher_fpathconf(JNIEnv* env, jclass this,</span>
<span class="line-removed">1095     jint fd, jint name)</span>
<span class="line-removed">1096 {</span>
<span class="line-removed">1097     long err;</span>
<span class="line-removed">1098 </span>
<span class="line-removed">1099     err = fpathconf((int)fd, (int)name);</span>
<span class="line-removed">1100     if (err == -1) {</span>
<span class="line-removed">1101         throwUnixException(env, errno);</span>
<span class="line-removed">1102     }</span>
<span class="line-removed">1103     return (jlong)err;</span>
<span class="line-removed">1104 }</span>
<span class="line-removed">1105 </span>
1106 JNIEXPORT void JNICALL
1107 Java_sun_nio_fs_UnixNativeDispatcher_mknod0(JNIEnv* env, jclass this,
1108     jlong pathAddress, jint mode, jlong dev)
1109 {
1110     int err;
1111     const char* path = (const char*)jlong_to_ptr(pathAddress);
1112 
1113     RESTARTABLE(mknod(path, (mode_t)mode, (dev_t)dev), err);
1114     if (err == -1) {
1115         throwUnixException(env, errno);
1116     }
1117 }
1118 
1119 JNIEXPORT jbyteArray JNICALL
1120 Java_sun_nio_fs_UnixNativeDispatcher_getpwuid(JNIEnv* env, jclass this, jint uid)
1121 {
1122     jbyteArray result = NULL;
1123     int buflen;
1124     char* pwbuf;
1125 
</pre>
</td>
<td>
<hr />
<pre>
 344     len = strlen(tmpbuf);
 345     bytes = (*env)-&gt;NewByteArray(env, len);
 346     if (bytes != NULL) {
 347         (*env)-&gt;SetByteArrayRegion(env, bytes, 0, len, (jbyte*)tmpbuf);
 348     }
 349     return bytes;
 350 }
 351 
 352 JNIEXPORT jint
 353 Java_sun_nio_fs_UnixNativeDispatcher_dup(JNIEnv* env, jclass this, jint fd) {
 354 
 355     int res = -1;
 356 
 357     RESTARTABLE(dup((int)fd), res);
 358     if (res == -1) {
 359         throwUnixException(env, errno);
 360     }
 361     return (jint)res;
 362 }
 363 


































 364 JNIEXPORT void JNICALL
 365 Java_sun_nio_fs_UnixNativeDispatcher_rewind(JNIEnv* env, jclass this, jlong stream)
 366 {
 367     FILE* fp = jlong_to_ptr(stream);
 368     int saved_errno;
 369 
 370     errno = 0;
 371     rewind(fp);
 372     saved_errno = errno;
 373     if (ferror(fp)) {
 374         throwUnixException(env, saved_errno);
 375     }
 376 }
 377 
 378 /**
 379  * This function returns line length without NUL terminator or -1 on EOF.
 380  */
 381 JNIEXPORT jint JNICALL
 382 Java_sun_nio_fs_UnixNativeDispatcher_getlinelen(JNIEnv* env, jclass this, jlong stream)
 383 {
</pre>
<hr />
<pre>
1025         if (buf.f_blocks == ULONG_MAX) {
1026             buf.f_blocks = 0;
1027         }
1028         /* The number of free or available blocks can never exceed the total number of blocks */
1029         if (buf.f_blocks == 0) {
1030             buf.f_bfree = 0;
1031             buf.f_bavail = 0;
1032         }
1033 #endif
1034 #ifdef MACOSX
1035         (*env)-&gt;SetLongField(env, attrs, attrs_f_frsize, long_to_jlong(buf.f_bsize));
1036 #else
1037         (*env)-&gt;SetLongField(env, attrs, attrs_f_frsize, long_to_jlong(buf.f_frsize));
1038 #endif
1039         (*env)-&gt;SetLongField(env, attrs, attrs_f_blocks, long_to_jlong(buf.f_blocks));
1040         (*env)-&gt;SetLongField(env, attrs, attrs_f_bfree,  long_to_jlong(buf.f_bfree));
1041         (*env)-&gt;SetLongField(env, attrs, attrs_f_bavail, long_to_jlong(buf.f_bavail));
1042     }
1043 }
1044 



























1045 JNIEXPORT void JNICALL
1046 Java_sun_nio_fs_UnixNativeDispatcher_mknod0(JNIEnv* env, jclass this,
1047     jlong pathAddress, jint mode, jlong dev)
1048 {
1049     int err;
1050     const char* path = (const char*)jlong_to_ptr(pathAddress);
1051 
1052     RESTARTABLE(mknod(path, (mode_t)mode, (dev_t)dev), err);
1053     if (err == -1) {
1054         throwUnixException(env, errno);
1055     }
1056 }
1057 
1058 JNIEXPORT jbyteArray JNICALL
1059 Java_sun_nio_fs_UnixNativeDispatcher_getpwuid(JNIEnv* env, jclass this, jint uid)
1060 {
1061     jbyteArray result = NULL;
1062     int buflen;
1063     char* pwbuf;
1064 
</pre>
</td>
</tr>
</table>
<center><a href="../../libjli/java_md_common.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../windows/native/libjli/java_md.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>