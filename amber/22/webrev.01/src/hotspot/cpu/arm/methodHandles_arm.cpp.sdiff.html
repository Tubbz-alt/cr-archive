<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/cpu/arm/methodHandles_arm.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="c1_globals_arm.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../ppc/assembler_ppc.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/cpu/arm/methodHandles_arm.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
471                               intptr_t* saved_bp,
472                               oop mh) {
473   // called as a leaf from native code: do not block the JVM!
474   bool has_mh = (strstr(adaptername, &quot;/static&quot;) == NULL &amp;&amp;
475                  strstr(adaptername, &quot;linkTo&quot;) == NULL);    // static linkers don&#39;t have MH
476   intptr_t* entry_sp = (intptr_t*) &amp;saved_regs[trace_mh_nregs]; // just after the saved regs
477   intptr_t* saved_sp = (intptr_t*)  saved_regs[Rsender_sp-&gt;encoding()]; // save of Rsender_sp
478   intptr_t* last_sp  = (intptr_t*)  saved_bp[frame::interpreter_frame_last_sp_offset];
479   intptr_t* base_sp  = last_sp;
480 
481   intptr_t    mh_reg = (intptr_t)saved_regs[R5_mh-&gt;encoding()];
482   const char* mh_reg_name = &quot;R5_mh&quot;;
483   if (!has_mh)  mh_reg_name = &quot;R5&quot;;
484   tty-&gt;print_cr(&quot;MH %s %s=&quot; PTR_FORMAT &quot; sp=(&quot; PTR_FORMAT &quot;+&quot; INTX_FORMAT &quot;) stack_size=&quot; INTX_FORMAT &quot; bp=&quot; PTR_FORMAT,
485                 adaptername, mh_reg_name, mh_reg,
486                 (intptr_t)entry_sp, (intptr_t)saved_sp - (intptr_t)entry_sp, (intptr_t)(base_sp - last_sp), (intptr_t)saved_bp);
487 
488   if (last_sp != saved_sp &amp;&amp; last_sp != NULL)
489     tty-&gt;print_cr(&quot;*** last_sp=&quot; INTPTR_FORMAT, p2i(last_sp));
490   if (Verbose) {

491     tty-&gt;print(&quot; reg dump: &quot;);
492     int i;
493     for (i = 0; i &lt; trace_mh_nregs; i++) {
494       if (i &gt; 0 &amp;&amp; i % 4 == 0)
495         tty-&gt;print(&quot;\n   + dump: &quot;);
496       const char* reg_name = trace_mh_regs[i]-&gt;name();
497       tty-&gt;print(&quot; %s: &quot; INTPTR_FORMAT, reg_name, p2i((void *)saved_regs[i]));
498     }
499     tty-&gt;cr();
<span class="line-removed">500   }</span>
<span class="line-removed">501 </span>
<span class="line-removed">502   if (Verbose) {</span>
<span class="line-removed">503     // dump last frame (from JavaThread::print_frame_layout)</span>
<span class="line-removed">504 </span>
<span class="line-removed">505     // Note: code is robust but the dumped informationm may not be</span>
<span class="line-removed">506     // 100% correct, particularly with respect to the dumped</span>
<span class="line-removed">507     // &quot;unextended_sp&quot;. Getting it right for all trace_method_handle</span>
<span class="line-removed">508     // call paths is not worth the complexity/risk. The correct slot</span>
<span class="line-removed">509     // will be identified by *Rsender_sp anyway in the dump.</span>
<span class="line-removed">510     JavaThread* p = JavaThread::active();</span>
511 
<span class="line-modified">512     ResourceMark rm;</span>
<span class="line-modified">513     PRESERVE_EXCEPTION_MARK;</span>
<span class="line-modified">514     FrameValues values;</span>
<span class="line-modified">515 </span>
<span class="line-modified">516     intptr_t* dump_fp = (intptr_t *) saved_bp;</span>
<span class="line-modified">517     address dump_pc = (address) saved_regs[trace_mh_nregs-2]; // LR (with LR,PC last in saved_regs)</span>
<span class="line-modified">518     frame dump_frame((intptr_t *)entry_sp, dump_fp, dump_pc);</span>
<span class="line-modified">519 </span>
<span class="line-modified">520     dump_frame.describe(values, 1);</span>
<span class="line-modified">521     // mark Rsender_sp if seems valid</span>
<span class="line-modified">522     if (has_mh) {</span>
<span class="line-modified">523       if ((saved_sp &gt;= entry_sp - UNREASONABLE_STACK_MOVE) &amp;&amp; (saved_sp &lt; dump_fp)) {</span>
<span class="line-modified">524         values.describe(-1, saved_sp, &quot;*Rsender_sp&quot;);</span>










525       }




526     }
527 
<span class="line-removed">528     // Note: the unextended_sp may not be correct</span>
<span class="line-removed">529     tty-&gt;print_cr(&quot;  stack layout:&quot;);</span>
<span class="line-removed">530     values.print(p);</span>
<span class="line-removed">531   }</span>
<span class="line-removed">532   if (Verbose) {</span>
533     if (has_mh &amp;&amp; oopDesc::is_oop(mh)) {
534       mh-&gt;print();
535       if (java_lang_invoke_MethodHandle::is_instance(mh)) {
<span class="line-modified">536         if (java_lang_invoke_MethodHandle::form_offset_in_bytes() != 0)</span>
537           java_lang_invoke_MethodHandle::form(mh)-&gt;print();

538       }
539     }
540   }
541 }
542 
543 void MethodHandles::trace_method_handle(MacroAssembler* _masm, const char* adaptername) {
544   if (!log_is_enabled(Info, methodhandles))  return;
545   BLOCK_COMMENT(&quot;trace_method_handle {&quot;);
546   // register saving
547   //  must correspond to trace_mh_nregs and trace_mh_regs defined above
548   int push_size = __ save_all_registers();
549   assert(trace_mh_nregs*wordSize == push_size,&quot;saved register count mismatch&quot;);
550 
551   __ mov_slow(R0, adaptername);
552   __ mov(R1, SP); // entry_sp (after pushes)
553   __ mov(R2, FP);
554   if (R5_mh != R3) {
555     assert_different_registers(R0, R1, R2, R5_mh);
556     __ mov(R3, R5_mh);
557   }
</pre>
</td>
<td>
<hr />
<pre>
471                               intptr_t* saved_bp,
472                               oop mh) {
473   // called as a leaf from native code: do not block the JVM!
474   bool has_mh = (strstr(adaptername, &quot;/static&quot;) == NULL &amp;&amp;
475                  strstr(adaptername, &quot;linkTo&quot;) == NULL);    // static linkers don&#39;t have MH
476   intptr_t* entry_sp = (intptr_t*) &amp;saved_regs[trace_mh_nregs]; // just after the saved regs
477   intptr_t* saved_sp = (intptr_t*)  saved_regs[Rsender_sp-&gt;encoding()]; // save of Rsender_sp
478   intptr_t* last_sp  = (intptr_t*)  saved_bp[frame::interpreter_frame_last_sp_offset];
479   intptr_t* base_sp  = last_sp;
480 
481   intptr_t    mh_reg = (intptr_t)saved_regs[R5_mh-&gt;encoding()];
482   const char* mh_reg_name = &quot;R5_mh&quot;;
483   if (!has_mh)  mh_reg_name = &quot;R5&quot;;
484   tty-&gt;print_cr(&quot;MH %s %s=&quot; PTR_FORMAT &quot; sp=(&quot; PTR_FORMAT &quot;+&quot; INTX_FORMAT &quot;) stack_size=&quot; INTX_FORMAT &quot; bp=&quot; PTR_FORMAT,
485                 adaptername, mh_reg_name, mh_reg,
486                 (intptr_t)entry_sp, (intptr_t)saved_sp - (intptr_t)entry_sp, (intptr_t)(base_sp - last_sp), (intptr_t)saved_bp);
487 
488   if (last_sp != saved_sp &amp;&amp; last_sp != NULL)
489     tty-&gt;print_cr(&quot;*** last_sp=&quot; INTPTR_FORMAT, p2i(last_sp));
490   if (Verbose) {
<span class="line-added">491     ResourceMark rm;</span>
492     tty-&gt;print(&quot; reg dump: &quot;);
493     int i;
494     for (i = 0; i &lt; trace_mh_nregs; i++) {
495       if (i &gt; 0 &amp;&amp; i % 4 == 0)
496         tty-&gt;print(&quot;\n   + dump: &quot;);
497       const char* reg_name = trace_mh_regs[i]-&gt;name();
498       tty-&gt;print(&quot; %s: &quot; INTPTR_FORMAT, reg_name, p2i((void *)saved_regs[i]));
499     }
500     tty-&gt;cr();











501 
<span class="line-modified">502     {</span>
<span class="line-modified">503       // dump last frame (from JavaThread::print_frame_layout)</span>
<span class="line-modified">504 </span>
<span class="line-modified">505       // Note: code is robust but the dumped informationm may not be</span>
<span class="line-modified">506       // 100% correct, particularly with respect to the dumped</span>
<span class="line-modified">507       // &quot;unextended_sp&quot;. Getting it right for all trace_method_handle</span>
<span class="line-modified">508       // call paths is not worth the complexity/risk. The correct slot</span>
<span class="line-modified">509       // will be identified by *Rsender_sp anyway in the dump.</span>
<span class="line-modified">510       JavaThread* p = JavaThread::active();</span>
<span class="line-modified">511 </span>
<span class="line-modified">512       PRESERVE_EXCEPTION_MARK;</span>
<span class="line-modified">513       FrameValues values;</span>
<span class="line-modified">514 </span>
<span class="line-added">515       intptr_t* dump_fp = (intptr_t *) saved_bp;</span>
<span class="line-added">516       address dump_pc = (address) saved_regs[trace_mh_nregs-2]; // LR (with LR,PC last in saved_regs)</span>
<span class="line-added">517       frame dump_frame((intptr_t *)entry_sp, dump_fp, dump_pc);</span>
<span class="line-added">518 </span>
<span class="line-added">519       dump_frame.describe(values, 1);</span>
<span class="line-added">520       // mark Rsender_sp if seems valid</span>
<span class="line-added">521       if (has_mh) {</span>
<span class="line-added">522         if ((saved_sp &gt;= entry_sp - UNREASONABLE_STACK_MOVE) &amp;&amp; (saved_sp &lt; dump_fp)) {</span>
<span class="line-added">523           values.describe(-1, saved_sp, &quot;*Rsender_sp&quot;);</span>
<span class="line-added">524         }</span>
525       }
<span class="line-added">526 </span>
<span class="line-added">527       // Note: the unextended_sp may not be correct</span>
<span class="line-added">528       tty-&gt;print_cr(&quot;  stack layout:&quot;);</span>
<span class="line-added">529       values.print(p);</span>
530     }
531 





532     if (has_mh &amp;&amp; oopDesc::is_oop(mh)) {
533       mh-&gt;print();
534       if (java_lang_invoke_MethodHandle::is_instance(mh)) {
<span class="line-modified">535         if (java_lang_invoke_MethodHandle::form_offset_in_bytes() != 0) {</span>
536           java_lang_invoke_MethodHandle::form(mh)-&gt;print();
<span class="line-added">537         }</span>
538       }
539     }
540   }
541 }
542 
543 void MethodHandles::trace_method_handle(MacroAssembler* _masm, const char* adaptername) {
544   if (!log_is_enabled(Info, methodhandles))  return;
545   BLOCK_COMMENT(&quot;trace_method_handle {&quot;);
546   // register saving
547   //  must correspond to trace_mh_nregs and trace_mh_regs defined above
548   int push_size = __ save_all_registers();
549   assert(trace_mh_nregs*wordSize == push_size,&quot;saved register count mismatch&quot;);
550 
551   __ mov_slow(R0, adaptername);
552   __ mov(R1, SP); // entry_sp (after pushes)
553   __ mov(R2, FP);
554   if (R5_mh != R3) {
555     assert_different_registers(R0, R1, R2, R5_mh);
556     __ mov(R3, R5_mh);
557   }
</pre>
</td>
</tr>
</table>
<center><a href="c1_globals_arm.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../ppc/assembler_ppc.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>