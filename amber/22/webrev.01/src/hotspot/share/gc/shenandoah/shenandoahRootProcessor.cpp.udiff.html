<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shenandoah/shenandoahRootProcessor.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahPhaseTimings.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahRootProcessor.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahRootProcessor.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -173,17 +173,82 @@</span>
      StringDedupQueue::unlink_or_oops_do(&amp;sd_cl);
      StringDedupTable::unlink_or_oops_do(&amp;sd_cl, worker_id);
    }
  }
  
<span class="udiff-line-added">+ ShenandoahCodeCacheRoots::ShenandoahCodeCacheRoots(ShenandoahPhaseTimings::Phase phase) : _phase(phase) {</span>
<span class="udiff-line-added">+   nmethod::oops_do_marking_prologue();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ShenandoahCodeCacheRoots::code_blobs_do(CodeBlobClosure* blob_cl, uint worker_id) {</span>
<span class="udiff-line-added">+   ShenandoahWorkerTimingsTracker timer(_phase, ShenandoahPhaseTimings::CodeCacheRoots, worker_id);</span>
<span class="udiff-line-added">+   _coderoots_iterator.possibly_parallel_blobs_do(blob_cl);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ShenandoahCodeCacheRoots::~ShenandoahCodeCacheRoots() {</span>
<span class="udiff-line-added">+   nmethod::oops_do_marking_epilogue();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  ShenandoahRootProcessor::ShenandoahRootProcessor(ShenandoahPhaseTimings::Phase phase) :
    _heap(ShenandoahHeap::heap()),
    _phase(phase),
    _worker_phase(phase) {
    assert(SafepointSynchronize::is_at_safepoint(), &quot;Must at safepoint&quot;);
  }
  
<span class="udiff-line-added">+ ShenandoahRootScanner::ShenandoahRootScanner(uint n_workers, ShenandoahPhaseTimings::Phase phase) :</span>
<span class="udiff-line-added">+   ShenandoahRootProcessor(phase),</span>
<span class="udiff-line-added">+   _serial_roots(phase),</span>
<span class="udiff-line-added">+   _thread_roots(phase, n_workers &gt; 1),</span>
<span class="udiff-line-added">+   _code_roots(phase),</span>
<span class="udiff-line-added">+   _vm_roots(phase),</span>
<span class="udiff-line-added">+   _dedup_roots(phase),</span>
<span class="udiff-line-added">+   _cld_roots(phase) {</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ShenandoahRootScanner::roots_do(uint worker_id, OopClosure* oops) {</span>
<span class="udiff-line-added">+   CLDToOopClosure clds_cl(oops, ClassLoaderData::_claim_strong);</span>
<span class="udiff-line-added">+   MarkingCodeBlobClosure blobs_cl(oops, !CodeBlobToOopClosure::FixRelocations);</span>
<span class="udiff-line-added">+   roots_do(worker_id, oops, &amp;clds_cl, &amp;blobs_cl);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ShenandoahRootScanner::strong_roots_do(uint worker_id, OopClosure* oops) {</span>
<span class="udiff-line-added">+   CLDToOopClosure clds_cl(oops, ClassLoaderData::_claim_strong);</span>
<span class="udiff-line-added">+   MarkingCodeBlobClosure blobs_cl(oops, !CodeBlobToOopClosure::FixRelocations);</span>
<span class="udiff-line-added">+   strong_roots_do(worker_id, oops, &amp;clds_cl, &amp;blobs_cl);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ShenandoahRootScanner::roots_do(uint worker_id, OopClosure* oops, CLDClosure* clds, CodeBlobClosure* code, ThreadClosure *tc) {</span>
<span class="udiff-line-added">+   assert(!ShenandoahSafepoint::is_at_shenandoah_safepoint() ||</span>
<span class="udiff-line-added">+          !ShenandoahHeap::heap()-&gt;unload_classes(),</span>
<span class="udiff-line-added">+           &quot;Expect class unloading when Shenandoah cycle is running&quot;);</span>
<span class="udiff-line-added">+   ResourceMark rm;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   _serial_roots.oops_do(oops, worker_id);</span>
<span class="udiff-line-added">+   _vm_roots.oops_do(oops, worker_id);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   assert(clds != NULL, &quot;Only possible with CLD closure&quot;);</span>
<span class="udiff-line-added">+   _cld_roots.cld_do(clds, worker_id);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   ShenandoahParallelOopsDoThreadClosure tc_cl(oops, code, tc);</span>
<span class="udiff-line-added">+   _thread_roots.threads_do(&amp;tc_cl, worker_id);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   AlwaysTrueClosure always_true;</span>
<span class="udiff-line-added">+   _dedup_roots.oops_do(&amp;always_true, oops, worker_id);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ShenandoahRootScanner::strong_roots_do(uint worker_id, OopClosure* oops, CLDClosure* clds, CodeBlobClosure* code, ThreadClosure* tc) {</span>
<span class="udiff-line-added">+   assert(ShenandoahHeap::heap()-&gt;unload_classes(), &quot;Should be used during class unloading&quot;);</span>
<span class="udiff-line-added">+   ShenandoahParallelOopsDoThreadClosure tc_cl(oops, code, tc);</span>
<span class="udiff-line-added">+   ResourceMark rm;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   _serial_roots.oops_do(oops, worker_id);</span>
<span class="udiff-line-added">+   _vm_roots.oops_do(oops, worker_id);</span>
<span class="udiff-line-added">+   _cld_roots.always_strong_cld_do(clds, worker_id);</span>
<span class="udiff-line-added">+   _thread_roots.threads_do(&amp;tc_cl, worker_id);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  ShenandoahRootEvacuator::ShenandoahRootEvacuator(uint n_workers,
                                                   ShenandoahPhaseTimings::Phase phase,
                                                   bool stw_roots_processing,
                                                   bool stw_class_unloading) :
    ShenandoahRootProcessor(phase),
</pre>
<center><a href="shenandoahPhaseTimings.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahRootProcessor.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>