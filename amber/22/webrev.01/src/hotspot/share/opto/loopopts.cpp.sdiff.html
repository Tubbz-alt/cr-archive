<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/opto/loopopts.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="loopnode.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="movenode.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/opto/loopopts.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
2145         set_loop(newuse, use_loop);
2146         set_idom(newuse, nnn, dom_depth(nnn) + 1 );
2147 
2148         // We need a Region to merge the exit from the peeled body and the
2149         // exit from the old loop body.
2150         RegionNode *r = new RegionNode(3);
2151         // Map the old use to the new merge point
2152         old_new.map( use-&gt;_idx, r );
2153         uint dd_r = MIN2(dom_depth(newuse),dom_depth(use));
2154         assert( dd_r &gt;= dom_depth(dom_lca(newuse,use)), &quot;&quot; );
2155 
2156         // The original user of &#39;use&#39; uses &#39;r&#39; instead.
2157         for (DUIterator_Last lmin, l = use-&gt;last_outs(lmin); l &gt;= lmin;) {
2158           Node* useuse = use-&gt;last_out(l);
2159           _igvn.rehash_node_delayed(useuse);
2160           uint uses_found = 0;
2161           if( useuse-&gt;in(0) == use ) {
2162             useuse-&gt;set_req(0, r);
2163             uses_found++;
2164             if( useuse-&gt;is_CFG() ) {
<span class="line-modified">2165               assert( dom_depth(useuse) &gt; dd_r, &quot;&quot; );</span>



2166               set_idom(useuse, r, dom_depth(useuse));
2167             }
2168           }
2169           for( uint k = 1; k &lt; useuse-&gt;req(); k++ ) {
2170             if( useuse-&gt;in(k) == use ) {
2171               useuse-&gt;set_req(k, r);
2172               uses_found++;
2173               if (useuse-&gt;is_Loop() &amp;&amp; k == LoopNode::EntryControl) {
<span class="line-modified">2174                 assert(dom_depth(useuse) &gt; dd_r , &quot;&quot;);</span>



2175                 set_idom(useuse, r, dom_depth(useuse));
2176               }
2177             }
2178           }
2179           l -= uses_found;    // we deleted 1 or more copies of this edge
2180         }
2181 
2182         // Now finish up &#39;r&#39;
2183         r-&gt;set_req( 1, newuse );
2184         r-&gt;set_req( 2,    use );
2185         _igvn.register_new_node_with_optimizer(r);
2186         set_loop(r, use_loop);
2187         set_idom(r, !side_by_side_idom ? newuse-&gt;in(0) : side_by_side_idom, dd_r);
2188       } // End of if a loop-exit test
2189     }
2190   }
2191 
2192   // Step 4: If loop-invariant use is not control, it must be dominated by a
2193   // loop exit IfFalse/IfTrue.  Find &quot;proper&quot; loop exit.  Make a Region
2194   // there if needed.  Make a Phi there merging old and new used values.
</pre>
</td>
<td>
<hr />
<pre>
2145         set_loop(newuse, use_loop);
2146         set_idom(newuse, nnn, dom_depth(nnn) + 1 );
2147 
2148         // We need a Region to merge the exit from the peeled body and the
2149         // exit from the old loop body.
2150         RegionNode *r = new RegionNode(3);
2151         // Map the old use to the new merge point
2152         old_new.map( use-&gt;_idx, r );
2153         uint dd_r = MIN2(dom_depth(newuse),dom_depth(use));
2154         assert( dd_r &gt;= dom_depth(dom_lca(newuse,use)), &quot;&quot; );
2155 
2156         // The original user of &#39;use&#39; uses &#39;r&#39; instead.
2157         for (DUIterator_Last lmin, l = use-&gt;last_outs(lmin); l &gt;= lmin;) {
2158           Node* useuse = use-&gt;last_out(l);
2159           _igvn.rehash_node_delayed(useuse);
2160           uint uses_found = 0;
2161           if( useuse-&gt;in(0) == use ) {
2162             useuse-&gt;set_req(0, r);
2163             uses_found++;
2164             if( useuse-&gt;is_CFG() ) {
<span class="line-modified">2165               // This is not a dom_depth &gt; dd_r because when new</span>
<span class="line-added">2166               // control flow is constructed by a loop opt, a node and</span>
<span class="line-added">2167               // its dominator can end up at the same dom_depth</span>
<span class="line-added">2168               assert(dom_depth(useuse) &gt;= dd_r, &quot;&quot;);</span>
2169               set_idom(useuse, r, dom_depth(useuse));
2170             }
2171           }
2172           for( uint k = 1; k &lt; useuse-&gt;req(); k++ ) {
2173             if( useuse-&gt;in(k) == use ) {
2174               useuse-&gt;set_req(k, r);
2175               uses_found++;
2176               if (useuse-&gt;is_Loop() &amp;&amp; k == LoopNode::EntryControl) {
<span class="line-modified">2177                 // This is not a dom_depth &gt; dd_r because when new</span>
<span class="line-added">2178                 // control flow is constructed by a loop opt, a node</span>
<span class="line-added">2179                 // and its dominator can end up at the same dom_depth</span>
<span class="line-added">2180                 assert(dom_depth(useuse) &gt;= dd_r , &quot;&quot;);</span>
2181                 set_idom(useuse, r, dom_depth(useuse));
2182               }
2183             }
2184           }
2185           l -= uses_found;    // we deleted 1 or more copies of this edge
2186         }
2187 
2188         // Now finish up &#39;r&#39;
2189         r-&gt;set_req( 1, newuse );
2190         r-&gt;set_req( 2,    use );
2191         _igvn.register_new_node_with_optimizer(r);
2192         set_loop(r, use_loop);
2193         set_idom(r, !side_by_side_idom ? newuse-&gt;in(0) : side_by_side_idom, dd_r);
2194       } // End of if a loop-exit test
2195     }
2196   }
2197 
2198   // Step 4: If loop-invariant use is not control, it must be dominated by a
2199   // loop exit IfFalse/IfTrue.  Find &quot;proper&quot; loop exit.  Make a Region
2200   // there if needed.  Make a Phi there merging old and new used values.
</pre>
</td>
</tr>
</table>
<center><a href="loopnode.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="movenode.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>