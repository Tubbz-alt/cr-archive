<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.jdwp.agent/share/native/libjdwp/util.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="transport.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../jdk.jfr/share/classes/jdk/jfr/internal/LongMap.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jdwp.agent/share/native/libjdwp/util.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 24,10 ***</span>
<span class="line-new-header">--- 24,11 ---</span>
   */
  
  #include &lt;ctype.h&gt;
  
  #include &quot;util.h&quot;
<span class="line-added">+ #include &quot;utf_util.h&quot;</span>
  #include &quot;transport.h&quot;
  #include &quot;eventHandler.h&quot;
  #include &quot;threadControl.h&quot;
  #include &quot;outStream.h&quot;
  #include &quot;inStream.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1650,17 ***</span>
      }
  
      /* Create jstrings for property name and value */
      nameString = JNI_FUNC_PTR(env,NewStringUTF)(env, propertyName);
      if (nameString != NULL) {
<span class="line-modified">!         valueString = JNU_NewStringPlatform(env, propertyValue);</span>
<span class="line-modified">!         if (valueString != NULL) {</span>
<span class="line-modified">!             /* invoke Properties.setProperty */</span>
<span class="line-modified">!             JNI_FUNC_PTR(env,CallObjectMethod)</span>
<span class="line-modified">!                 (env, gdata-&gt;agent_properties,</span>
<span class="line-modified">!                  gdata-&gt;setProperty,</span>
<span class="line-modified">!                  nameString, valueString);</span>
          }
      }
      if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {
          JNI_FUNC_PTR(env,ExceptionClear)(env);
      }
<span class="line-new-header">--- 1651,30 ---</span>
      }
  
      /* Create jstrings for property name and value */
      nameString = JNI_FUNC_PTR(env,NewStringUTF)(env, propertyName);
      if (nameString != NULL) {
<span class="line-modified">!         /* convert the value to UTF8 */</span>
<span class="line-modified">!         int len;</span>
<span class="line-modified">!         char *utf8value;</span>
<span class="line-modified">!         int utf8maxSize;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         len = (int)strlen(propertyValue);</span>
<span class="line-modified">!         utf8maxSize = len * 4 + 1;</span>
<span class="line-added">+         utf8value = (char *)jvmtiAllocate(utf8maxSize);</span>
<span class="line-added">+         if (utf8value != NULL) {</span>
<span class="line-added">+             utf8FromPlatform(propertyValue, len, (jbyte *)utf8value, utf8maxSize);</span>
<span class="line-added">+             valueString = JNI_FUNC_PTR(env, NewStringUTF)(env, utf8value);</span>
<span class="line-added">+             jvmtiDeallocate(utf8value);</span>
<span class="line-added">+ </span>
<span class="line-added">+             if (valueString != NULL) {</span>
<span class="line-added">+                 /* invoke Properties.setProperty */</span>
<span class="line-added">+                 JNI_FUNC_PTR(env,CallObjectMethod)</span>
<span class="line-added">+                     (env, gdata-&gt;agent_properties,</span>
<span class="line-added">+                      gdata-&gt;setProperty,</span>
<span class="line-added">+                      nameString, valueString);</span>
<span class="line-added">+             }</span>
          }
      }
      if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {
          JNI_FUNC_PTR(env,ExceptionClear)(env);
      }
</pre>
<center><a href="transport.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../jdk.jfr/share/classes/jdk/jfr/internal/LongMap.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>