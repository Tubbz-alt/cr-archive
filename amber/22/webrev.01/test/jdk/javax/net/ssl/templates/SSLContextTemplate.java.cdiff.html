<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/javax/net/ssl/templates/SSLContextTemplate.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../java/util/stream/test/org/openjdk/tests/java/util/stream/SpliteratorTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SSLSocketTemplate.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/javax/net/ssl/templates/SSLContextTemplate.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 32,40 ***</span>
  import java.security.PrivateKey;
  import java.security.cert.Certificate;
  import java.security.cert.CertificateFactory;
  import java.security.spec.PKCS8EncodedKeySpec;
  import java.util.Base64;
<span class="line-modified">! import javax.net.ssl.KeyManagerFactory;</span>
<span class="line-removed">- import javax.net.ssl.SSLContext;</span>
<span class="line-removed">- import javax.net.ssl.TrustManagerFactory;</span>
  
  /**
   * SSLContext template to speed up JSSE tests.
   */
  public interface SSLContextTemplate {
      /*
       * Create an instance of SSLContext for client use.
       */
      default SSLContext createClientSSLContext() throws Exception {
<span class="line-modified">!         return createSSLContext(trustedCertStrs,</span>
<span class="line-modified">!                 endEntityCertStrs, endEntityPrivateKeys,</span>
<span class="line-modified">!                 endEntityPrivateKeyAlgs,</span>
<span class="line-removed">-                 endEntityPrivateKeyNames,</span>
                  getClientContextParameters());
      }
  
      /*
       * Create an instance of SSLContext for server use.
       */
      default SSLContext createServerSSLContext() throws Exception {
<span class="line-modified">!         return createSSLContext(trustedCertStrs,</span>
<span class="line-modified">!                 endEntityCertStrs, endEntityPrivateKeys,</span>
                  endEntityPrivateKeyAlgs,
                  endEntityPrivateKeyNames,
                  getServerContextParameters());
      }
  
      /*
       * The parameters used to configure SSLContext.
       */
      static final class ContextParameters {
          final String contextProtocol;
<span class="line-new-header">--- 32,77 ---</span>
  import java.security.PrivateKey;
  import java.security.cert.Certificate;
  import java.security.cert.CertificateFactory;
  import java.security.spec.PKCS8EncodedKeySpec;
  import java.util.Base64;
<span class="line-modified">! import javax.net.ssl.*;</span>
  
  /**
   * SSLContext template to speed up JSSE tests.
   */
  public interface SSLContextTemplate {
      /*
       * Create an instance of SSLContext for client use.
       */
      default SSLContext createClientSSLContext() throws Exception {
<span class="line-modified">!         return createSSLContext(</span>
<span class="line-modified">!                 createClientKeyManager(),</span>
<span class="line-modified">!                 createClientTrustManager(),</span>
                  getClientContextParameters());
      }
  
      /*
       * Create an instance of SSLContext for server use.
       */
      default SSLContext createServerSSLContext() throws Exception {
<span class="line-modified">!         return createSSLContext(</span>
<span class="line-modified">!                 createServerKeyManager(),</span>
<span class="line-added">+                 createServerTrustManager(),</span>
<span class="line-added">+                 getServerContextParameters());</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /*</span>
<span class="line-added">+      * Create an instance of KeyManager for client use.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     default KeyManager createClientKeyManager() throws Exception {</span>
<span class="line-added">+         return createKeyManager(</span>
<span class="line-added">+                 endEntityCertStrs,</span>
<span class="line-added">+                 endEntityPrivateKeys,</span>
<span class="line-added">+                 endEntityPrivateKeyAlgs,</span>
<span class="line-added">+                 endEntityPrivateKeyNames,</span>
<span class="line-added">+                 getServerContextParameters());</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /*</span>
<span class="line-added">+      * Create an instance of TrustManager for client use.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     default TrustManager createClientTrustManager() throws Exception {</span>
<span class="line-added">+         return createTrustManager(</span>
<span class="line-added">+                 trustedCertStrs,</span>
<span class="line-added">+                 getServerContextParameters());</span>
<span class="line-added">+     }</span>
<span class="line-added">+     /*</span>
<span class="line-added">+      * Create an instance of KeyManager for server use.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     default KeyManager createServerKeyManager() throws Exception {</span>
<span class="line-added">+         return createKeyManager(</span>
<span class="line-added">+                 endEntityCertStrs,</span>
<span class="line-added">+                 endEntityPrivateKeys,</span>
                  endEntityPrivateKeyAlgs,
                  endEntityPrivateKeyNames,
                  getServerContextParameters());
      }
  
<span class="line-added">+     /*</span>
<span class="line-added">+      * Create an instance of TrustManager for server use.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     default TrustManager createServerTrustManager() throws Exception {</span>
<span class="line-added">+         return createTrustManager(</span>
<span class="line-added">+                 trustedCertStrs,</span>
<span class="line-added">+                 getServerContextParameters());</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      /*
       * The parameters used to configure SSLContext.
       */
      static final class ContextParameters {
          final String contextProtocol;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 419,100 ***</span>
  
      /*
       * Create an instance of SSLContext with the specified trust/key materials.
       */
      private SSLContext createSSLContext(
<span class="line-modified">!             String[] trustedMaterials,</span>
              String[] keyMaterialCerts,
              String[] keyMaterialKeys,
              String[] keyMaterialKeyAlgs,
              String[] keyMaterialKeyNames,
              ContextParameters params) throws Exception {
  
<span class="line-modified">!         KeyStore ts = null;     // trust store</span>
<span class="line-removed">-         KeyStore ks = null;     // key store</span>
<span class="line-removed">-         char passphrase[] = &quot;passphrase&quot;.toCharArray();</span>
  
          // Generate certificate from cert string.
          CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;);
  
<span class="line-removed">-         // Import the trused certs.</span>
<span class="line-removed">-         ByteArrayInputStream is;</span>
<span class="line-removed">-         if (trustedMaterials != null &amp;&amp; trustedMaterials.length != 0) {</span>
<span class="line-removed">-             ts = KeyStore.getInstance(&quot;JKS&quot;);</span>
<span class="line-removed">-             ts.load(null, null);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             Certificate[] trustedCert =</span>
<span class="line-removed">-                     new Certificate[trustedMaterials.length];</span>
<span class="line-removed">-             for (int i = 0; i &lt; trustedMaterials.length; i++) {</span>
<span class="line-removed">-                 String trustedCertStr = trustedMaterials[i];</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 is = new ByteArrayInputStream(trustedCertStr.getBytes());</span>
<span class="line-removed">-                 try {</span>
<span class="line-removed">-                     trustedCert[i] = cf.generateCertificate(is);</span>
<span class="line-removed">-                 } finally {</span>
<span class="line-removed">-                     is.close();</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 ts.setCertificateEntry(&quot;trusted-cert-&quot; + i, trustedCert[i]);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
          // Import the key materials.
          //
<span class="line-modified">!         // Note that certification pathes bigger than one are not supported yet.</span>
<span class="line-modified">!         boolean hasKeyMaterials =</span>
<span class="line-modified">!             (keyMaterialCerts != null) &amp;&amp; (keyMaterialCerts.length != 0) &amp;&amp;</span>
<span class="line-modified">!             (keyMaterialKeys != null) &amp;&amp; (keyMaterialKeys.length != 0) &amp;&amp;</span>
<span class="line-modified">!             (keyMaterialKeyAlgs != null) &amp;&amp; (keyMaterialKeyAlgs.length != 0) &amp;&amp;</span>
<span class="line-modified">!             (keyMaterialCerts.length == keyMaterialKeys.length) &amp;&amp;</span>
<span class="line-modified">!             (keyMaterialCerts.length == keyMaterialKeyAlgs.length);</span>
<span class="line-modified">!         if (hasKeyMaterials) {</span>
<span class="line-modified">!             ks = KeyStore.getInstance(&quot;JKS&quot;);</span>
<span class="line-removed">-             ks.load(null, null);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             for (int i = 0; i &lt; keyMaterialCerts.length; i++) {</span>
<span class="line-removed">-                 String keyCertStr = keyMaterialCerts[i];</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 // generate the private key.</span>
<span class="line-removed">-                 PKCS8EncodedKeySpec priKeySpec = new PKCS8EncodedKeySpec(</span>
                      Base64.getMimeDecoder().decode(keyMaterialKeys[i]));
<span class="line-modified">!                 KeyFactory kf =</span>
                      KeyFactory.getInstance(keyMaterialKeyAlgs[i]);
<span class="line-modified">!                 PrivateKey priKey = kf.generatePrivate(priKeySpec);</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 // generate certificate chain</span>
<span class="line-modified">!                 is = new ByteArrayInputStream(keyCertStr.getBytes());</span>
<span class="line-modified">!                 Certificate keyCert = null;</span>
<span class="line-modified">!                 try {</span>
<span class="line-modified">!                     keyCert = cf.generateCertificate(is);</span>
<span class="line-modified">!                 } finally {</span>
<span class="line-modified">!                     is.close();</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 Certificate[] chain = new Certificate[] { keyCert };</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 // import the key entry.</span>
<span class="line-modified">!                 ks.setKeyEntry(&quot;cert-&quot; + keyMaterialKeyNames[i],</span>
<span class="line-modified">!                         priKey, passphrase, chain);</span>
              }
          }
  
          // Create an SSLContext object.
          TrustManagerFactory tmf =
                  TrustManagerFactory.getInstance(params.tmAlgorithm);
          tmf.init(ts);
  
<span class="line-modified">!         SSLContext context = SSLContext.getInstance(params.contextProtocol);</span>
<span class="line-modified">!         if (hasKeyMaterials &amp;&amp; ks != null) {</span>
<span class="line-removed">-             KeyManagerFactory kmf =</span>
<span class="line-removed">-                     KeyManagerFactory.getInstance(params.kmAlgorithm);</span>
<span class="line-removed">-             kmf.init(ks, passphrase);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             context.init(kmf.getKeyManagers(), tmf.getTrustManagers(), null);</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             context.init(null, tmf.getTrustManagers(), null);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         return context;</span>
      }
  }
<span class="line-new-header">--- 456,117 ---</span>
  
      /*
       * Create an instance of SSLContext with the specified trust/key materials.
       */
      private SSLContext createSSLContext(
<span class="line-modified">!             KeyManager keyManager,</span>
<span class="line-added">+             TrustManager trustManager,</span>
<span class="line-added">+             ContextParameters params) throws Exception {</span>
<span class="line-added">+ </span>
<span class="line-added">+         SSLContext context = SSLContext.getInstance(params.contextProtocol);</span>
<span class="line-added">+         context.init(</span>
<span class="line-added">+                 new KeyManager[] {</span>
<span class="line-added">+                         keyManager</span>
<span class="line-added">+                     },</span>
<span class="line-added">+                 new TrustManager[] {</span>
<span class="line-added">+                         trustManager</span>
<span class="line-added">+                     },</span>
<span class="line-added">+                 null);</span>
<span class="line-added">+ </span>
<span class="line-added">+         return  context;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /*</span>
<span class="line-added">+      * Create an instance of KeyManager with the specified key materials.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     private KeyManager createKeyManager(</span>
              String[] keyMaterialCerts,
              String[] keyMaterialKeys,
              String[] keyMaterialKeyAlgs,
              String[] keyMaterialKeyNames,
              ContextParameters params) throws Exception {
  
<span class="line-modified">!         char[] passphrase = &quot;passphrase&quot;.toCharArray();</span>
  
          // Generate certificate from cert string.
          CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;);
  
          // Import the key materials.
          //
<span class="line-modified">!         // Note that certification paths bigger than one are not supported yet.</span>
<span class="line-modified">!         KeyStore ks = KeyStore.getInstance(&quot;JKS&quot;);</span>
<span class="line-modified">!         ks.load(null, null);</span>
<span class="line-modified">!         ByteArrayInputStream is;</span>
<span class="line-modified">!         for (int i = 0; i &lt; keyMaterialCerts.length; i++) {</span>
<span class="line-modified">!             String keyCertStr = keyMaterialCerts[i];</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // generate the private key.</span>
<span class="line-modified">!             PKCS8EncodedKeySpec priKeySpec = new PKCS8EncodedKeySpec(</span>
                      Base64.getMimeDecoder().decode(keyMaterialKeys[i]));
<span class="line-modified">!             KeyFactory kf =</span>
                      KeyFactory.getInstance(keyMaterialKeyAlgs[i]);
<span class="line-modified">!             PrivateKey priKey = kf.generatePrivate(priKeySpec);</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // generate certificate chain</span>
<span class="line-modified">!             is = new ByteArrayInputStream(keyCertStr.getBytes());</span>
<span class="line-modified">!             Certificate keyCert = null;</span>
<span class="line-modified">!             try {</span>
<span class="line-modified">!                 keyCert = cf.generateCertificate(is);</span>
<span class="line-modified">!             } finally {</span>
<span class="line-modified">!                 is.close();</span>
<span class="line-modified">!             }</span>
<span class="line-modified">! </span>
<span class="line-modified">!             Certificate[] chain = new Certificate[] { keyCert };</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // import the key entry.</span>
<span class="line-modified">!             ks.setKeyEntry(&quot;cert-&quot; + keyMaterialKeyNames[i],</span>
<span class="line-modified">!                     priKey, passphrase, chain);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         KeyManagerFactory kmf =</span>
<span class="line-added">+                 KeyManagerFactory.getInstance(params.kmAlgorithm);</span>
<span class="line-added">+         kmf.init(ks, passphrase);</span>
<span class="line-added">+ </span>
<span class="line-added">+         KeyManager[] km = kmf.getKeyManagers();</span>
<span class="line-added">+ </span>
<span class="line-added">+         return km[0];</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /*</span>
<span class="line-added">+      * Create an instance of TrustManager with the specified trust materials.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     private TrustManager createTrustManager(</span>
<span class="line-added">+             String[] trustedMaterials,</span>
<span class="line-added">+             ContextParameters params) throws Exception {</span>
<span class="line-added">+ </span>
<span class="line-added">+         // Generate certificate from cert string.</span>
<span class="line-added">+         CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+         // Import the trusted certs.</span>
<span class="line-added">+         KeyStore ts = KeyStore.getInstance(&quot;PKCS12&quot;);</span>
<span class="line-added">+         ts.load(null, null);</span>
<span class="line-added">+ </span>
<span class="line-added">+         Certificate[] trustedCert =</span>
<span class="line-added">+                 new Certificate[trustedMaterials.length];</span>
<span class="line-added">+         ByteArrayInputStream is;</span>
<span class="line-added">+         for (int i = 0; i &lt; trustedMaterials.length; i++) {</span>
<span class="line-added">+             String trustedCertStr = trustedMaterials[i];</span>
<span class="line-added">+ </span>
<span class="line-added">+             is = new ByteArrayInputStream(trustedCertStr.getBytes());</span>
<span class="line-added">+             try {</span>
<span class="line-added">+                 trustedCert[i] = cf.generateCertificate(is);</span>
<span class="line-added">+             } finally {</span>
<span class="line-added">+                 is.close();</span>
              }
<span class="line-added">+ </span>
<span class="line-added">+             ts.setCertificateEntry(&quot;trusted-cert-&quot; + i, trustedCert[i]);</span>
          }
  
          // Create an SSLContext object.
          TrustManagerFactory tmf =
                  TrustManagerFactory.getInstance(params.tmAlgorithm);
          tmf.init(ts);
  
<span class="line-modified">!         TrustManager[] tms = tmf.getTrustManagers();</span>
<span class="line-modified">!         return tms[0];</span>
      }
  }
</pre>
<center><a href="../../../../java/util/stream/test/org/openjdk/tests/java/util/stream/SpliteratorTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SSLSocketTemplate.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>