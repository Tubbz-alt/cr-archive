<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/sun/security/tools/keytool/WeakAlg.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2017, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8171319 8177569 8182879 8172404
 27  * @summary keytool should print out warnings when reading or generating
 28   *         cert/cert req using weak algorithms
 29  * @library /test/lib
 30  * @modules java.base/sun.security.tools.keytool
 31  *          java.base/sun.security.tools
 32  *          java.base/sun.security.util
 33  * @build jdk.test.lib.SecurityTools
 34  *        jdk.test.lib.Utils
 35  *        jdk.test.lib.Asserts
 36  *        jdk.test.lib.JDKToolFinder
 37  *        jdk.test.lib.JDKToolLauncher
 38  *        jdk.test.lib.Platform
 39  *        jdk.test.lib.process.*
 40  * @run main/othervm/timeout=600 -Duser.language=en -Duser.country=US WeakAlg
 41  */
 42 
 43 import jdk.test.lib.Asserts;
 44 import jdk.test.lib.SecurityTools;
 45 import jdk.test.lib.process.OutputAnalyzer;
 46 import sun.security.tools.KeyStoreUtil;
 47 import sun.security.util.DisabledAlgorithmConstraints;
 48 
 49 import java.io.ByteArrayInputStream;
 50 import java.io.ByteArrayOutputStream;
 51 import java.io.File;
 52 import java.io.IOException;
 53 import java.io.InputStream;
 54 import java.io.PrintStream;
 55 import java.nio.file.Files;
 56 import java.nio.file.Paths;
 57 import java.nio.file.StandardCopyOption;
 58 import java.security.CryptoPrimitive;
 59 import java.security.KeyStore;
 60 import java.security.cert.X509Certificate;
 61 import java.util.Collections;
 62 import java.util.EnumSet;
 63 import java.util.Set;
 64 import java.util.stream.Collectors;
 65 import java.util.stream.Stream;
 66 
 67 public class WeakAlg {
 68 
 69     public static void main(String[] args) throws Throwable {
 70 
 71         rm(&quot;ks&quot;);
 72 
 73         // Tests for &quot;disabled&quot; algorithms
 74         // -genkeypair, and -printcert, -list -alias, -exportcert
 75         // (w/ different formats)
 76         checkDisabledGenKeyPair(&quot;a&quot;, &quot;-keyalg RSA -sigalg MD5withRSA&quot;, &quot;MD5withRSA&quot;);
 77         checkDisabledGenKeyPair(&quot;b&quot;, &quot;-keyalg RSA -keysize 512&quot;, &quot;512-bit RSA key&quot;);
 78         checkDisabledGenKeyPair(&quot;c&quot;, &quot;-keyalg RSA&quot;, null);
 79 
 80         kt(&quot;-list&quot;)
 81                 .shouldContain(&quot;Warning:&quot;)
 82                 .shouldMatch(&quot;&lt;a&gt;.*MD5withRSA.*is disabled&quot;)
 83                 .shouldMatch(&quot;&lt;b&gt;.*512-bit RSA key.*is disabled&quot;);
 84         kt(&quot;-list -v&quot;)
 85                 .shouldContain(&quot;Warning:&quot;)
 86                 .shouldMatch(&quot;&lt;a&gt;.*MD5withRSA.*is disabled&quot;)
 87                 .shouldContain(&quot;MD5withRSA (disabled)&quot;)
 88                 .shouldMatch(&quot;&lt;b&gt;.*512-bit RSA key.*is disabled&quot;)
 89                 .shouldContain(&quot;512-bit RSA key (disabled)&quot;);
 90 
 91         // Multiple warnings for multiple cert in -printcert
 92         // or -list or -exportcert
 93 
 94         // -certreq, -printcertreq, -gencert
 95         checkDisabledCertReq(&quot;a&quot;, &quot;&quot;, null);
 96         gencert(&quot;c-a&quot;, &quot;&quot;)
 97                 .shouldNotContain(&quot;Warning&quot;); // new sigalg is not weak
 98         gencert(&quot;c-a&quot;, &quot;-sigalg MD2withRSA&quot;)
 99                 .shouldContain(&quot;Warning:&quot;)
100                 .shouldMatch(&quot;The generated certificate.*MD2withRSA.*is disabled&quot;);
101 
102         checkDisabledCertReq(&quot;a&quot;, &quot;-sigalg MD5withRSA&quot;, &quot;MD5withRSA&quot;);
103         gencert(&quot;c-a&quot;, &quot;&quot;)
104                 .shouldContain(&quot;Warning:&quot;)
105                 .shouldMatch(&quot;The certificate request.*MD5withRSA.*is disabled&quot;);
106         gencert(&quot;c-a&quot;, &quot;-sigalg MD2withRSA&quot;)
107                 .shouldContain(&quot;Warning:&quot;)
108                 .shouldMatch(&quot;The certificate request.*MD5withRSA.*is disabled&quot;)
109                 .shouldMatch(&quot;The generated certificate.*MD2withRSA.*is disabled&quot;);
110 
111         checkDisabledCertReq(&quot;b&quot;, &quot;&quot;, &quot;512-bit RSA key&quot;);
112         gencert(&quot;c-b&quot;, &quot;&quot;)
113                 .shouldContain(&quot;Warning:&quot;)
114                 .shouldMatch(&quot;The certificate request.*512-bit RSA key.*is disabled&quot;)
115                 .shouldMatch(&quot;The generated certificate.*512-bit RSA key.*is disabled&quot;);
116 
117         checkDisabledCertReq(&quot;c&quot;, &quot;&quot;, null);
118         gencert(&quot;a-c&quot;, &quot;&quot;)
119                 .shouldContain(&quot;Warning:&quot;)
120                 .shouldMatch(&quot;The issuer.*MD5withRSA.*is disabled&quot;);
121 
122         // but the new cert is not weak
123         kt(&quot;-printcert -file a-c.cert&quot;)
124                 .shouldNotContain(&quot;Warning&quot;)
125                 .shouldNotContain(&quot;(disabled)&quot;);
126 
127         gencert(&quot;b-c&quot;, &quot;&quot;)
128                 .shouldContain(&quot;Warning:&quot;)
129                 .shouldMatch(&quot;The issuer.*512-bit RSA key.*is disabled&quot;);
130 
131         // -importcert
132         checkImport();
133 
134         // -importkeystore
135         checkImportKeyStore();
136 
137         // -gencrl, -printcrl
138 
139         checkDisabledGenCRL(&quot;a&quot;, &quot;&quot;, null);
140         checkDisabledGenCRL(&quot;a&quot;, &quot;-sigalg MD5withRSA&quot;, &quot;MD5withRSA&quot;);
141         checkDisabledGenCRL(&quot;b&quot;, &quot;&quot;, &quot;512-bit RSA key&quot;);
142         checkDisabledGenCRL(&quot;c&quot;, &quot;&quot;, null);
143 
144         kt(&quot;-delete -alias b&quot;);
145         kt(&quot;-printcrl -file b.crl&quot;)
146                 .shouldContain(&quot;WARNING: not verified&quot;);
147 
148         jksTypeCheck();
149 
150         checkInplaceImportKeyStore();
151 
152         rm(&quot;ks&quot;);
153 
154         // Tests for &quot;legacy&quot; algorithms
155         // -genkeypair, and -printcert, -list -alias, -exportcert
156         // (w/ different formats)
157         checkWeakGenKeyPair(&quot;x&quot;, &quot;-keyalg RSA -sigalg SHA1withRSA&quot;, &quot;SHA1withRSA&quot;);
158         checkWeakGenKeyPair(&quot;y&quot;, &quot;-keyalg RSA -keysize 1024&quot;, &quot;1024-bit RSA key&quot;);
159         checkWeakGenKeyPair(&quot;z&quot;, &quot;-keyalg RSA&quot;, null);
160 
161         kt(&quot;-list&quot;)
162                 .shouldContain(&quot;Warning:&quot;)
163                 .shouldMatch(&quot;&lt;x&gt;.*SHA1withRSA.*will be disabled&quot;)
164                 .shouldMatch(&quot;&lt;y&gt;.*1024-bit RSA key.*will be disabled&quot;);
165         kt(&quot;-list -v&quot;)
166                 .shouldContain(&quot;Warning:&quot;)
167                 .shouldMatch(&quot;&lt;x&gt;.*SHA1withRSA.*will be disabled&quot;)
168                 .shouldContain(&quot;SHA1withRSA (weak)&quot;)
169                 .shouldMatch(&quot;&lt;y&gt;.*1024-bit RSA key.*will be disabled&quot;)
170                 .shouldContain(&quot;1024-bit RSA key (weak)&quot;);
171 
172         // Multiple warnings for multiple cert in -printcert
173         // or -list or -exportcert
174 
175         // -certreq, -printcertreq, -gencert
176         checkWeakCertReq(&quot;x&quot;, &quot;&quot;, null);
177         gencert(&quot;z-x&quot;, &quot;&quot;)
178                 .shouldNotContain(&quot;Warning&quot;); // new sigalg is not weak
179         gencert(&quot;z-x&quot;, &quot;-sigalg SHA1withRSA&quot;)
180                 .shouldContain(&quot;Warning:&quot;)
181                 .shouldMatch(&quot;The generated certificate.*SHA1withRSA.*will be disabled&quot;);
182 
183         checkWeakCertReq(&quot;x&quot;, &quot;-sigalg SHA1withRSA&quot;, &quot;SHA1withRSA&quot;);
184         gencert(&quot;z-x&quot;, &quot;&quot;)
185                 .shouldContain(&quot;Warning:&quot;)
186                 .shouldMatch(&quot;The certificate request.*SHA1withRSA.*will be disabled&quot;);
187         gencert(&quot;z-x&quot;, &quot;-sigalg SHA1withRSA&quot;)
188                 .shouldContain(&quot;Warning:&quot;)
189                 .shouldMatch(&quot;The certificate request.*SHA1withRSA.*will be disabled&quot;)
190                 .shouldMatch(&quot;The generated certificate.*SHA1withRSA.*will be disabled&quot;);
191 
192         checkWeakCertReq(&quot;y&quot;, &quot;&quot;, &quot;1024-bit RSA key&quot;);
193         gencert(&quot;z-y&quot;, &quot;&quot;)
194                 .shouldContain(&quot;Warning:&quot;)
195                 .shouldMatch(&quot;The certificate request.*1024-bit RSA key.*will be disabled&quot;)
196                 .shouldMatch(&quot;The generated certificate.*1024-bit RSA key.*will be disabled&quot;);
197 
198         checkWeakCertReq(&quot;z&quot;, &quot;&quot;, null);
199         gencert(&quot;x-z&quot;, &quot;&quot;)
200                 .shouldContain(&quot;Warning:&quot;)
201                 .shouldMatch(&quot;The issuer.*SHA1withRSA.*will be disabled&quot;);
202 
203         // but the new cert is not weak
204         kt(&quot;-printcert -file x-z.cert&quot;)
205                 .shouldNotContain(&quot;Warning&quot;)
206                 .shouldNotContain(&quot;weak&quot;);
207 
208         gencert(&quot;y-z&quot;, &quot;&quot;)
209                 .shouldContain(&quot;Warning:&quot;)
210                 .shouldMatch(&quot;The issuer.*1024-bit RSA key.*will be disabled&quot;);
211 
212         // -gencrl, -printcrl
213         checkWeakGenCRL(&quot;x&quot;, &quot;&quot;, null);
214         checkWeakGenCRL(&quot;x&quot;, &quot;-sigalg SHA1withRSA&quot;, &quot;SHA1withRSA&quot;);
215         checkWeakGenCRL(&quot;y&quot;, &quot;&quot;, &quot;1024-bit RSA key&quot;);
216         checkWeakGenCRL(&quot;z&quot;, &quot;&quot;, null);
217 
218         kt(&quot;-delete -alias y&quot;);
219         kt(&quot;-printcrl -file y.crl&quot;)
220                 .shouldContain(&quot;WARNING: not verified&quot;);
221 
222         jksTypeCheck();
223     }
224 
225     static void jksTypeCheck() throws Exception {
226 
227         // No warning for cacerts, all certs
228         kt0(&quot;-cacerts -list -storepass changeit&quot;)
229                 .shouldNotContain(&quot;proprietary format&quot;);
230 
231         rm(&quot;ks&quot;);
232         rm(&quot;ks2&quot;);
233 
234         kt(&quot;-genkeypair -keyalg DSA -alias a -dname CN=A&quot;)
235                 .shouldNotContain(&quot;Warning:&quot;);
236         kt(&quot;-list&quot;)
237                 .shouldNotContain(&quot;Warning:&quot;);
238         kt(&quot;-list -storetype jks&quot;) // no warning if PKCS12 used as JKS
239                 .shouldNotContain(&quot;Warning:&quot;);
240         kt(&quot;-exportcert -alias a -file a.crt&quot;)
241                 .shouldNotContain(&quot;Warning:&quot;);
242 
243         // warn if migrating to JKS
244         importkeystore(&quot;ks&quot;, &quot;ks2&quot;, &quot;-deststoretype jks&quot;)
245                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;);
246 
247         rm(&quot;ks&quot;);
248         rm(&quot;ks2&quot;);
249         rm(&quot;ks3&quot;);
250 
251         // no warning if all certs
252         kt(&quot;-importcert -alias b -file a.crt -storetype jks -noprompt&quot;)
253                 .shouldNotContain(&quot;Warning:&quot;);
254         kt(&quot;-genkeypair -keyalg DSA -alias a -dname CN=A&quot;)
255                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;);
256         kt(&quot;-list&quot;)
257                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;);
258         kt(&quot;-list -storetype pkcs12&quot;) // warn if JKS used as PKCS12
259                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;);
260         kt(&quot;-exportcert -alias a -file a.crt&quot;)
261                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;);
262         kt(&quot;-printcert -file a.crt&quot;) // no warning if keystore not touched
263                 .shouldNotContain(&quot;Warning:&quot;);
264         kt(&quot;-certreq -alias a -file a.req&quot;)
265                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;);
266         kt(&quot;-printcertreq -file a.req&quot;) // no warning if keystore not touched
267                 .shouldNotContain(&quot;Warning:&quot;);
268 
269         // No warning if migrating from JKS
270         importkeystore(&quot;ks&quot;, &quot;ks2&quot;, &quot;&quot;)
271                 .shouldNotContain(&quot;Warning:&quot;);
272 
273         importkeystore(&quot;ks&quot;, &quot;ks3&quot;, &quot;-deststoretype pkcs12&quot;)
274                 .shouldNotContain(&quot;Warning:&quot;);
275 
276         rm(&quot;ks&quot;);
277 
278         kt(&quot;-genkeypair -keyalg DSA -alias a -dname CN=A -storetype jceks&quot;)
279                 .shouldContain(&quot;JCEKS keystore uses a proprietary format&quot;);
280         kt(&quot;-list&quot;)
281                 .shouldContain(&quot;JCEKS keystore uses a proprietary format&quot;);
282         kt(&quot;-importcert -alias b -file a.crt -noprompt&quot;)
283                 .shouldContain(&quot;JCEKS keystore uses a proprietary format&quot;);
284         kt(&quot;-exportcert -alias a -file a.crt&quot;)
285                 .shouldContain(&quot;JCEKS keystore uses a proprietary format&quot;);
286         kt(&quot;-printcert -file a.crt&quot;)
287                 .shouldNotContain(&quot;Warning:&quot;);
288         kt(&quot;-certreq -alias a -file a.req&quot;)
289                 .shouldContain(&quot;JCEKS keystore uses a proprietary format&quot;);
290         kt(&quot;-printcertreq -file a.req&quot;)
291                 .shouldNotContain(&quot;Warning:&quot;);
292         kt(&quot;-genseckey -alias c -keyalg AES -keysize 128&quot;)
293                 .shouldContain(&quot;JCEKS keystore uses a proprietary format&quot;);
294     }
295 
296     static void checkImportKeyStore() throws Exception {
297 
298         rm(&quot;ks2&quot;);
299         rm(&quot;ks3&quot;);
300 
301         importkeystore(&quot;ks&quot;, &quot;ks2&quot;, &quot;&quot;)
302                 .shouldContain(&quot;3 entries successfully imported&quot;)
303                 .shouldContain(&quot;Warning&quot;)
304                 .shouldMatch(&quot;&lt;b&gt;.*512-bit RSA key.*is disabled&quot;)
305                 .shouldMatch(&quot;&lt;a&gt;.*MD5withRSA.*is disabled&quot;);
306 
307         importkeystore(&quot;ks&quot;, &quot;ks3&quot;, &quot;-srcalias a&quot;)
308                 .shouldContain(&quot;Warning&quot;)
309                 .shouldMatch(&quot;&lt;a&gt;.*MD5withRSA.*is disabled&quot;);
310     }
311 
312     static void checkInplaceImportKeyStore() throws Exception {
313 
314         rm(&quot;ks&quot;);
315         genkeypair(&quot;a&quot;, &quot;-keyalg DSA&quot;);
316 
317         // Same type backup
318         importkeystore(&quot;ks&quot;, &quot;ks&quot;, &quot;&quot;)
319                 .shouldContain(&quot;Warning:&quot;)
320                 .shouldMatch(&quot;original.*ks.old&quot;);
321 
322         importkeystore(&quot;ks&quot;, &quot;ks&quot;, &quot;&quot;)
323                 .shouldContain(&quot;Warning:&quot;)
324                 .shouldMatch(&quot;original.*ks.old2&quot;);
325 
326         importkeystore(&quot;ks&quot;, &quot;ks&quot;, &quot;-srcstoretype jks&quot;) // it knows real type
327                 .shouldContain(&quot;Warning:&quot;)
328                 .shouldMatch(&quot;original.*ks.old3&quot;);
329 
330         String cPath = new File(&quot;ks&quot;).getCanonicalPath();
331 
332         importkeystore(&quot;ks&quot;, cPath, &quot;&quot;)
333                 .shouldContain(&quot;Warning:&quot;)
334                 .shouldMatch(&quot;original.*ks.old4&quot;);
335 
336         // Migration
337         importkeystore(&quot;ks&quot;, &quot;ks&quot;, &quot;-deststoretype jks&quot;)
338                 .shouldContain(&quot;Warning:&quot;)
339                 .shouldContain(&quot;JKS keystore uses a proprietary format&quot;)
340                 .shouldMatch(&quot;Migrated.*JKS.*PKCS12.*ks.old5&quot;);
341 
342         Asserts.assertEQ(
343                 KeyStore.getInstance(
344                         new File(&quot;ks&quot;), &quot;changeit&quot;.toCharArray()).getType(),
345                 &quot;JKS&quot;);
346 
347         importkeystore(&quot;ks&quot;, &quot;ks&quot;, &quot;-srcstoretype PKCS12&quot;)
348                 .shouldContain(&quot;Warning:&quot;)
349                 .shouldNotContain(&quot;proprietary format&quot;)
350                 .shouldMatch(&quot;Migrated.*PKCS12.*JKS.*ks.old6&quot;);
351 
352         Asserts.assertEQ(
353                 KeyStore.getInstance(
354                         new File(&quot;ks&quot;), &quot;changeit&quot;.toCharArray()).getType(),
355                 &quot;PKCS12&quot;);
356 
357         Asserts.assertEQ(
358                 KeyStore.getInstance(
359                         new File(&quot;ks.old6&quot;), &quot;changeit&quot;.toCharArray()).getType(),
360                 &quot;JKS&quot;);
361 
362         // One password prompt is enough for migration
363         kt0(&quot;-importkeystore -srckeystore ks -destkeystore ks&quot;, &quot;changeit&quot;)
364                 .shouldMatch(&quot;original.*ks.old7&quot;);
365 
366         // But three if importing to a different keystore
367         rm(&quot;ks2&quot;);
368         kt0(&quot;-importkeystore -srckeystore ks -destkeystore ks2&quot;,
369                     &quot;changeit&quot;)
370                 .shouldContain(&quot;Keystore password is too short&quot;);
371 
372         kt0(&quot;-importkeystore -srckeystore ks -destkeystore ks2&quot;,
373                 &quot;changeit&quot;, &quot;changeit&quot;, &quot;changeit&quot;)
374                 .shouldContain(&quot;Importing keystore ks to ks2...&quot;)
375                 .shouldNotContain(&quot;original&quot;)
376                 .shouldNotContain(&quot;Migrated&quot;);
377     }
378 
379     static void checkImport() throws Exception {
380 
381         saveStore();
382 
383         // add trusted cert
384 
385         // cert already in
386         kt(&quot;-importcert -alias d -file a.cert&quot;, &quot;no&quot;)
387                 .shouldContain(&quot;Certificate already exists in keystore&quot;)
388                 .shouldContain(&quot;Warning&quot;)
389                 .shouldMatch(&quot;The input.*MD5withRSA.*is disabled&quot;)
390                 .shouldContain(&quot;Do you still want to add it?&quot;);
391         kt(&quot;-importcert -alias d -file a.cert -noprompt&quot;)
392                 .shouldContain(&quot;Warning&quot;)
393                 .shouldMatch(&quot;The input.*MD5withRSA.*is disabled&quot;)
394                 .shouldNotContain(&quot;[no]&quot;);
395 
396         // cert is self-signed
397         kt(&quot;-delete -alias a&quot;);
398         kt(&quot;-delete -alias d&quot;);
399         kt(&quot;-importcert -alias d -file a.cert&quot;, &quot;no&quot;)
400                 .shouldContain(&quot;Warning&quot;)
401                 .shouldContain(&quot;MD5withRSA (disabled)&quot;)
402                 .shouldMatch(&quot;The input.*MD5withRSA.*is disabled&quot;)
403                 .shouldContain(&quot;Trust this certificate?&quot;);
404         kt(&quot;-importcert -alias d -file a.cert -noprompt&quot;)
405                 .shouldContain(&quot;Warning&quot;)
406                 .shouldMatch(&quot;The input.*MD5withRSA.*is disabled&quot;)
407                 .shouldNotContain(&quot;[no]&quot;);
408 
409         // JDK-8177569: no warning for sigalg of trusted cert
410         String weakSigAlgCA = null;
411         KeyStore ks = KeyStoreUtil.getCacertsKeyStore();
412         if (ks != null) {
413             DisabledAlgorithmConstraints disabledCheck =
414                     new DisabledAlgorithmConstraints(
415                             DisabledAlgorithmConstraints.PROPERTY_CERTPATH_DISABLED_ALGS);
416             Set&lt;CryptoPrimitive&gt; sigPrimitiveSet = Collections
417                     .unmodifiableSet(EnumSet.of(CryptoPrimitive.SIGNATURE));
418 
419             for (String s : Collections.list(ks.aliases())) {
420                 if (ks.isCertificateEntry(s)) {
421                     X509Certificate c = (X509Certificate)ks.getCertificate(s);
422                     String sigAlg = c.getSigAlgName();
423                     if (!disabledCheck.permits(sigPrimitiveSet, sigAlg, null)) {
424                         weakSigAlgCA = sigAlg;
425                         Files.write(Paths.get(&quot;ca.cert&quot;),
426                                 ks.getCertificate(s).getEncoded());
427                         break;
428                     }
429                 }
430             }
431         }
432         if (weakSigAlgCA != null) {
433             // The following 2 commands still have a warning on why not using
434             // the -cacerts option directly.
435             kt(&quot;-list -keystore &quot; + KeyStoreUtil.getCacerts())
436                     .shouldNotMatch(&quot;signature algorithm.*risk&quot;);
437             kt(&quot;-list -v -keystore &quot; + KeyStoreUtil.getCacerts())
438                     .shouldNotMatch(&quot;signature algorithm.*risk&quot;);
439 
440             // -printcert will always show warnings
441             kt(&quot;-printcert -file ca.cert&quot;)
442                     .shouldContain(&quot;name: &quot; + weakSigAlgCA + &quot; (disabled)&quot;)
443                     .shouldContain(&quot;Warning&quot;)
444                     .shouldMatch(&quot;The certificate.*&quot; + weakSigAlgCA + &quot;.*is disabled&quot;);
445             kt(&quot;-printcert -file ca.cert -trustcacerts&quot;) // -trustcacerts useless
446                     .shouldContain(&quot;name: &quot; + weakSigAlgCA + &quot; (disabled)&quot;)
447                     .shouldContain(&quot;Warning&quot;)
448                     .shouldMatch(&quot;The certificate.*&quot; + weakSigAlgCA + &quot;.*is disabled&quot;);
449 
450             // Importing with -trustcacerts ignore CA cert&#39;s sig alg
451             kt(&quot;-delete -alias d&quot;);
452             kt(&quot;-importcert -alias d -trustcacerts -file ca.cert&quot;, &quot;no&quot;)
453                     .shouldContain(&quot;Certificate already exists in system-wide CA&quot;)
454                     .shouldNotMatch(&quot;signature algorithm.*risk&quot;)
455                     .shouldContain(&quot;Do you still want to add it to your own keystore?&quot;);
456             kt(&quot;-importcert -alias d -trustcacerts -file ca.cert -noprompt&quot;)
457                     .shouldNotMatch(&quot;signature algorithm.*risk&quot;)
458                     .shouldNotContain(&quot;[no]&quot;);
459 
460             // but not without -trustcacerts
461             kt(&quot;-delete -alias d&quot;);
462             kt(&quot;-importcert -alias d -file ca.cert&quot;, &quot;no&quot;)
463                     .shouldContain(&quot;name: &quot; + weakSigAlgCA + &quot; (disabled)&quot;)
464                     .shouldContain(&quot;Warning&quot;)
465                     .shouldMatch(&quot;The input.*&quot; + weakSigAlgCA + &quot;.*is disabled&quot;)
466                     .shouldContain(&quot;Trust this certificate?&quot;);
467             kt(&quot;-importcert -alias d -file ca.cert -noprompt&quot;)
468                     .shouldContain(&quot;Warning&quot;)
469                     .shouldMatch(&quot;The input.*&quot; + weakSigAlgCA + &quot;.*is disabled&quot;)
470                     .shouldNotContain(&quot;[no]&quot;);
471         }
472 
473         // a non self-signed weak cert
474         reStore();
475         certreq(&quot;b&quot;, &quot;&quot;);
476         gencert(&quot;c-b&quot;, &quot;&quot;);
477         kt(&quot;-importcert -alias d -file c-b.cert&quot;)   // weak only, no prompt
478                 .shouldContain(&quot;Warning&quot;)
479                 .shouldNotContain(&quot;512-bit RSA key (disabled)&quot;)
480                 .shouldMatch(&quot;The input.*512-bit RSA key.*is disabled&quot;)
481                 .shouldNotContain(&quot;[no]&quot;);
482 
483         kt(&quot;-delete -alias b&quot;);
484         kt(&quot;-delete -alias c&quot;);
485         kt(&quot;-delete -alias d&quot;);
486 
487         kt(&quot;-importcert -alias d -file c-b.cert&quot;, &quot;no&quot;) // weak and not trusted
488                 .shouldContain(&quot;Warning&quot;)
489                 .shouldContain(&quot;512-bit RSA key (disabled)&quot;)
490                 .shouldMatch(&quot;The input.*512-bit RSA key.*is disabled&quot;)
491                 .shouldContain(&quot;Trust this certificate?&quot;);
492         kt(&quot;-importcert -alias d -file c-b.cert -noprompt&quot;)
493                 .shouldContain(&quot;Warning&quot;)
494                 .shouldMatch(&quot;The input.*512-bit RSA key.*is disabled&quot;)
495                 .shouldNotContain(&quot;[no]&quot;);
496 
497         // a non self-signed strong cert
498         reStore();
499         certreq(&quot;a&quot;, &quot;&quot;);
500         gencert(&quot;c-a&quot;, &quot;&quot;);
501         kt(&quot;-importcert -alias d -file c-a.cert&quot;) // trusted
502                 .shouldNotContain(&quot;Warning&quot;)
503                 .shouldNotContain(&quot;[no]&quot;);
504 
505         kt(&quot;-delete -alias a&quot;);
506         kt(&quot;-delete -alias c&quot;);
507         kt(&quot;-delete -alias d&quot;);
508 
509         kt(&quot;-importcert -alias d -file c-a.cert&quot;, &quot;no&quot;) // not trusted
510                 .shouldNotContain(&quot;Warning&quot;)
511                 .shouldContain(&quot;Trust this certificate?&quot;);
512         kt(&quot;-importcert -alias d -file c-a.cert -noprompt&quot;)
513                 .shouldNotContain(&quot;Warning&quot;)
514                 .shouldNotContain(&quot;[no]&quot;);
515 
516         // install reply
517 
518         reStore();
519         certreq(&quot;c&quot;, &quot;&quot;);
520         gencert(&quot;a-c&quot;, &quot;&quot;);
521         kt(&quot;-importcert -alias c -file a-c.cert&quot;)
522                 .shouldContain(&quot;Warning&quot;)
523                 .shouldMatch(&quot;Issuer &lt;a&gt;.*MD5withRSA.*is disabled&quot;);
524 
525         // JDK-8177569: no warning for sigalg of trusted cert
526         reStore();
527         // Change a into a TrustedCertEntry
528         kt(&quot;-exportcert -alias a -file a.cert&quot;);
529         kt(&quot;-delete -alias a&quot;);
530         kt(&quot;-importcert -alias a -file a.cert -noprompt&quot;);
531         kt(&quot;-list -alias a -v&quot;)
532                 .shouldNotContain(&quot;disabled&quot;)
533                 .shouldNotContain(&quot;Warning&quot;);
534         // This time a is trusted and no warning on its weak sig alg
535         kt(&quot;-importcert -alias c -file a-c.cert&quot;)
536                 .shouldNotContain(&quot;Warning&quot;);
537 
538         reStore();
539 
540         gencert(&quot;a-b&quot;, &quot;&quot;);
541         gencert(&quot;b-c&quot;, &quot;&quot;);
542 
543         // Full chain with root
544         cat(&quot;a-a-b-c.cert&quot;, &quot;b-c.cert&quot;, &quot;a-b.cert&quot;, &quot;a.cert&quot;);
545         kt(&quot;-importcert -alias c -file a-a-b-c.cert&quot;)   // only weak
546                 .shouldContain(&quot;Warning&quot;)
547                 .shouldMatch(&quot;Reply #2 of 3.*512-bit RSA key.*is disabled&quot;)
548                 .shouldMatch(&quot;Reply #3 of 3.*MD5withRSA.*is disabled&quot;)
549                 .shouldNotContain(&quot;[no]&quot;);
550 
551         // Without root
552         cat(&quot;a-b-c.cert&quot;, &quot;b-c.cert&quot;, &quot;a-b.cert&quot;);
553         kt(&quot;-importcert -alias c -file a-b-c.cert&quot;)     // only weak
554                 .shouldContain(&quot;Warning&quot;)
555                 .shouldMatch(&quot;Reply #2 of 2.*512-bit RSA key.*is disabled&quot;)
556                 .shouldMatch(&quot;Issuer &lt;a&gt;.*MD5withRSA.*is disabled&quot;)
557                 .shouldNotContain(&quot;[no]&quot;);
558 
559         reStore();
560         gencert(&quot;b-a&quot;, &quot;&quot;);
561 
562         kt(&quot;-importcert -alias a -file b-a.cert&quot;)
563                 .shouldContain(&quot;Warning&quot;)
564                 .shouldMatch(&quot;Issuer &lt;b&gt;.*512-bit RSA key.*is disabled&quot;)
565                 .shouldNotContain(&quot;[no]&quot;);
566 
567         kt(&quot;-importcert -alias a -file c-a.cert&quot;)
568                 .shouldNotContain(&quot;Warning&quot;);
569 
570         kt(&quot;-importcert -alias b -file c-b.cert&quot;)
571                 .shouldContain(&quot;Warning&quot;)
572                 .shouldMatch(&quot;The input.*512-bit RSA key.*is disabled&quot;)
573                 .shouldNotContain(&quot;[no]&quot;);
574 
575         reStore();
576         gencert(&quot;b-a&quot;, &quot;&quot;);
577 
578         cat(&quot;c-b-a.cert&quot;, &quot;b-a.cert&quot;, &quot;c-b.cert&quot;);
579 
580         kt(&quot;-printcert -file c-b-a.cert&quot;)
581                 .shouldContain(&quot;Warning&quot;)
582                 .shouldMatch(&quot;The certificate #2 of 2.*512-bit RSA key.*is disabled&quot;);
583 
584         kt(&quot;-delete -alias b&quot;);
585 
586         kt(&quot;-importcert -alias a -file c-b-a.cert&quot;)
587                 .shouldContain(&quot;Warning&quot;)
588                 .shouldMatch(&quot;Reply #2 of 2.*512-bit RSA key.*is disabled&quot;)
589                 .shouldNotContain(&quot;[no]&quot;);
590 
591         kt(&quot;-delete -alias c&quot;);
592         kt(&quot;-importcert -alias a -file c-b-a.cert&quot;, &quot;no&quot;)
593                 .shouldContain(&quot;Top-level certificate in reply:&quot;)
594                 .shouldContain(&quot;512-bit RSA key (disabled)&quot;)
595                 .shouldContain(&quot;Warning&quot;)
596                 .shouldMatch(&quot;Reply #2 of 2.*512-bit RSA key.*is disabled&quot;)
597                 .shouldContain(&quot;Install reply anyway?&quot;);
598         kt(&quot;-importcert -alias a -file c-b-a.cert -noprompt&quot;)
599                 .shouldContain(&quot;Warning&quot;)
600                 .shouldMatch(&quot;Reply #2 of 2.*512-bit RSA key.*is disabled&quot;)
601                 .shouldNotContain(&quot;[no]&quot;);
602 
603         reStore();
604     }
605 
606     private static void cat(String dest, String... src) throws IOException {
607         System.out.println(&quot;---------------------------------------------&quot;);
608         System.out.printf(&quot;$ cat &quot;);
609 
610         ByteArrayOutputStream bout = new ByteArrayOutputStream();
611         for (String s : src) {
612             System.out.printf(s + &quot; &quot;);
613             bout.write(Files.readAllBytes(Paths.get(s)));
614         }
615         Files.write(Paths.get(dest), bout.toByteArray());
616         System.out.println(&quot;&gt; &quot; + dest);
617     }
618 
619     static void checkDisabledGenCRL(String alias, String options, String bad) {
620 
621         OutputAnalyzer oa = kt(&quot;-gencrl -alias &quot; + alias
622                 + &quot; -id 1 -file &quot; + alias + &quot;.crl &quot; + options);
623         if (bad == null) {
624             oa.shouldNotContain(&quot;Warning&quot;);
625         } else {
626             oa.shouldContain(&quot;Warning&quot;)
627                     .shouldMatch(&quot;The generated CRL.*&quot; + bad + &quot;.*is disabled&quot;);
628         }
629 
630         oa = kt(&quot;-printcrl -file &quot; + alias + &quot;.crl&quot;);
631         if (bad == null) {
632             oa.shouldNotContain(&quot;Warning&quot;)
633                     .shouldContain(&quot;Verified by &quot; + alias + &quot; in keystore&quot;)
634                     .shouldNotContain(&quot;(disabled&quot;);
635         } else {
636             oa.shouldContain(&quot;Warning:&quot;)
637                     .shouldMatch(&quot;The CRL.*&quot; + bad + &quot;.*is disabled&quot;)
638                     .shouldContain(&quot;Verified by &quot; + alias + &quot; in keystore&quot;)
639                     .shouldContain(bad + &quot; (disabled)&quot;);
640         }
641     }
642 
643     static void checkDisabledCertReq(
644             String alias, String options, String bad) {
645 
646         OutputAnalyzer oa = certreq(alias, options);
647         if (bad == null) {
648             oa.shouldNotContain(&quot;Warning&quot;);
649         } else {
650             oa.shouldContain(&quot;Warning&quot;)
651                     .shouldMatch(&quot;The generated certificate request.*&quot; + bad + &quot;.*is disabled&quot;);
652         }
653 
654         oa = kt(&quot;-printcertreq -file &quot; + alias + &quot;.req&quot;);
655         if (bad == null) {
656             oa.shouldNotContain(&quot;Warning&quot;)
657                     .shouldNotContain(&quot;(disabled)&quot;);
658         } else {
659             oa.shouldContain(&quot;Warning&quot;)
660                     .shouldMatch(&quot;The certificate request.*&quot; + bad + &quot;.*is disabled&quot;)
661                     .shouldContain(bad + &quot; (disabled)&quot;);
662         }
663     }
664 
665     static void checkDisabledGenKeyPair(
666             String alias, String options, String bad) {
667 
668         OutputAnalyzer oa = genkeypair(alias, options);
669         if (bad == null) {
670             oa.shouldNotContain(&quot;Warning&quot;);
671         } else {
672             oa.shouldContain(&quot;Warning&quot;)
673                     .shouldMatch(&quot;The generated certificate.*&quot; + bad + &quot;.*is disabled&quot;);
674         }
675 
676         oa = kt(&quot;-exportcert -alias &quot; + alias + &quot; -file &quot; + alias + &quot;.cert&quot;);
677         if (bad == null) {
678             oa.shouldNotContain(&quot;Warning&quot;);
679         } else {
680             oa.shouldContain(&quot;Warning&quot;)
681                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*is disabled&quot;);
682         }
683 
684         oa = kt(&quot;-exportcert -rfc -alias &quot; + alias + &quot; -file &quot; + alias + &quot;.cert&quot;);
685         if (bad == null) {
686             oa.shouldNotContain(&quot;Warning&quot;);
687         } else {
688             oa.shouldContain(&quot;Warning&quot;)
689                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*is disabled&quot;);
690         }
691 
692         oa = kt(&quot;-printcert -rfc -file &quot; + alias + &quot;.cert&quot;);
693         if (bad == null) {
694             oa.shouldNotContain(&quot;Warning&quot;);
695         } else {
696             oa.shouldContain(&quot;Warning&quot;)
697                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*is disabled&quot;);
698         }
699 
700         oa = kt(&quot;-list -alias &quot; + alias);
701         if (bad == null) {
702             oa.shouldNotContain(&quot;Warning&quot;);
703         } else {
704             oa.shouldContain(&quot;Warning&quot;)
705                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*is disabled&quot;);
706         }
707 
708         // With cert content
709 
710         oa = kt(&quot;-printcert -file &quot; + alias + &quot;.cert&quot;);
711         if (bad == null) {
712             oa.shouldNotContain(&quot;Warning&quot;);
713         } else {
714             oa.shouldContain(&quot;Warning&quot;)
715                     .shouldContain(bad + &quot; (disabled)&quot;)
716                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*is disabled&quot;);
717         }
718 
719         oa = kt(&quot;-list -v -alias &quot; + alias);
720         if (bad == null) {
721             oa.shouldNotContain(&quot;Warning&quot;);
722         } else {
723             oa.shouldContain(&quot;Warning&quot;)
724                     .shouldContain(bad + &quot; (disabled)&quot;)
725                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*is disabled&quot;);
726         }
727     }
728 
729     static void checkWeakGenKeyPair(
730             String alias, String options, String bad) {
731 
732         OutputAnalyzer oa = genkeypair(alias, options);
733         if (bad == null) {
734             oa.shouldNotContain(&quot;Warning&quot;);
735         } else {
736             oa.shouldContain(&quot;Warning&quot;)
737                     .shouldMatch(&quot;The generated certificate.*&quot; + bad + &quot;.*will be disabled&quot;);
738         }
739 
740         oa = kt(&quot;-exportcert -alias &quot; + alias + &quot; -file &quot; + alias + &quot;.cert&quot;);
741         if (bad == null) {
742             oa.shouldNotContain(&quot;Warning&quot;);
743         } else {
744             oa.shouldContain(&quot;Warning&quot;)
745                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*will be disabled&quot;);
746         }
747 
748         oa = kt(&quot;-exportcert -rfc -alias &quot; + alias + &quot; -file &quot; + alias + &quot;.cert&quot;);
749         if (bad == null) {
750             oa.shouldNotContain(&quot;Warning&quot;);
751         } else {
752             oa.shouldContain(&quot;Warning&quot;)
753                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*will be disabled&quot;);
754         }
755 
756         oa = kt(&quot;-printcert -rfc -file &quot; + alias + &quot;.cert&quot;);
757         if (bad == null) {
758             oa.shouldNotContain(&quot;Warning&quot;);
759         } else {
760             oa.shouldContain(&quot;Warning&quot;)
761                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*will be disabled&quot;);
762         }
763 
764         oa = kt(&quot;-list -alias &quot; + alias);
765         if (bad == null) {
766             oa.shouldNotContain(&quot;Warning&quot;);
767         } else {
768             oa.shouldContain(&quot;Warning&quot;)
769                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*will be disabled&quot;);
770         }
771 
772         // With cert content
773 
774         oa = kt(&quot;-printcert -file &quot; + alias + &quot;.cert&quot;);
775         if (bad == null) {
776             oa.shouldNotContain(&quot;Warning&quot;);
777         } else {
778             oa.shouldContain(&quot;Warning&quot;)
779                     .shouldContain(bad + &quot; (weak)&quot;)
780                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*will be disabled&quot;);
781         }
782 
783         oa = kt(&quot;-list -v -alias &quot; + alias);
784         if (bad == null) {
785             oa.shouldNotContain(&quot;Warning&quot;);
786         } else {
787             oa.shouldContain(&quot;Warning&quot;)
788                     .shouldContain(bad + &quot; (weak)&quot;)
789                     .shouldMatch(&quot;The certificate.*&quot; + bad + &quot;.*will be disabled&quot;);
790         }
791     }
792 
793 
794     static void checkWeakGenCRL(String alias, String options, String bad) {
795 
796         OutputAnalyzer oa = kt(&quot;-gencrl -alias &quot; + alias
797                 + &quot; -id 1 -file &quot; + alias + &quot;.crl &quot; + options);
798         if (bad == null) {
799             oa.shouldNotContain(&quot;Warning&quot;);
800         } else {
801             oa.shouldContain(&quot;Warning&quot;)
802                     .shouldMatch(&quot;The generated CRL.*&quot; + bad + &quot;.*will be disabled&quot;);
803         }
804 
805         oa = kt(&quot;-printcrl -file &quot; + alias + &quot;.crl&quot;);
806         if (bad == null) {
807             oa.shouldNotContain(&quot;Warning&quot;)
808                     .shouldContain(&quot;Verified by &quot; + alias + &quot; in keystore&quot;)
809                     .shouldNotContain(&quot;(weak&quot;);
810         } else {
811             oa.shouldContain(&quot;Warning:&quot;)
812                     .shouldMatch(&quot;The CRL.*&quot; + bad + &quot;.*will be disabled&quot;)
813                     .shouldContain(&quot;Verified by &quot; + alias + &quot; in keystore&quot;)
814                     .shouldContain(bad + &quot; (weak)&quot;);
815         }
816     }
817 
818     static void checkWeakCertReq(
819             String alias, String options, String bad) {
820 
821         OutputAnalyzer oa = certreq(alias, options);
822         if (bad == null) {
823             oa.shouldNotContain(&quot;Warning&quot;);
824         } else {
825             oa.shouldContain(&quot;Warning&quot;)
826                     .shouldMatch(&quot;The generated certificate request.*&quot; + bad + &quot;.*will be disabled&quot;);
827         }
828 
829         oa = kt(&quot;-printcertreq -file &quot; + alias + &quot;.req&quot;);
830         if (bad == null) {
831             oa.shouldNotContain(&quot;Warning&quot;)
832                     .shouldNotContain(&quot;(weak)&quot;);
833         } else {
834             oa.shouldContain(&quot;Warning&quot;)
835                     .shouldMatch(&quot;The certificate request.*&quot; + bad + &quot;.*will be disabled&quot;)
836                     .shouldContain(bad + &quot; (weak)&quot;);
837         }
838     }
839 
840     // This is slow, but real keytool process is launched.
841     static OutputAnalyzer kt1(String cmd, String... input) {
842         cmd = &quot;-keystore ks -storepass changeit &quot; +
843                 &quot;-keypass changeit &quot; + cmd;
844         System.out.println(&quot;---------------------------------------------&quot;);
845         try {
846             SecurityTools.setResponse(input);
847             return SecurityTools.keytool(cmd);
848         } catch (Throwable e) {
849             throw new RuntimeException(e);
850         }
851     }
852 
853     static OutputAnalyzer kt(String cmd, String... input) {
854         return kt0(&quot;-keystore ks -storepass changeit &quot; +
855                 &quot;-keypass changeit &quot; + cmd, input);
856     }
857 
858     // Fast keytool execution by directly calling its main() method
859     static OutputAnalyzer kt0(String cmd, String... input) {
860         PrintStream out = System.out;
861         PrintStream err = System.err;
862         InputStream ins = System.in;
863         ByteArrayOutputStream bout = new ByteArrayOutputStream();
864         ByteArrayOutputStream berr = new ByteArrayOutputStream();
865         boolean succeed = true;
866         String sout;
867         String serr;
868         try {
869             System.out.println(&quot;---------------------------------------------&quot;);
870             System.out.println(&quot;$ keytool &quot; + cmd);
871             System.out.println();
872             String feed = &quot;&quot;;
873             if (input.length &gt; 0) {
874                 feed = Stream.of(input).collect(Collectors.joining(&quot;\n&quot;)) + &quot;\n&quot;;
875             }
876             System.setIn(new ByteArrayInputStream(feed.getBytes()));
877             System.setOut(new PrintStream(bout));
878             System.setErr(new PrintStream(berr));
879             sun.security.tools.keytool.Main.main(
880                     cmd.trim().split(&quot;\\s+&quot;));
881         } catch (Exception e) {
882             // Might be a normal exception when -debug is on or
883             // SecurityException (thrown by jtreg) when System.exit() is called
884             if (!(e instanceof SecurityException)) {
885                 e.printStackTrace();
886             }
887             succeed = false;
888         } finally {
889             System.setOut(out);
890             System.setErr(err);
891             System.setIn(ins);
892             sout = new String(bout.toByteArray());
893             serr = new String(berr.toByteArray());
894             System.out.println(&quot;STDOUT:\n&quot; + sout + &quot;\nSTDERR:\n&quot; + serr);
895         }
896         if (!succeed) {
897             throw new RuntimeException();
898         }
899         return new OutputAnalyzer(sout, serr);
900     }
901 
902     static OutputAnalyzer importkeystore(String src, String dest,
903                                          String options) {
904         return kt0(&quot;-importkeystore &quot;
905                 + &quot;-srckeystore &quot; + src + &quot; -destkeystore &quot; + dest
906                 + &quot; -srcstorepass changeit -deststorepass changeit &quot; + options);
907     }
908 
909     static OutputAnalyzer genkeypair(String alias, String options) {
910         return kt(&quot;-genkeypair -alias &quot; + alias + &quot; -dname CN=&quot; + alias
911                 + &quot; -storetype PKCS12 &quot; + options);
912     }
913 
914     static OutputAnalyzer certreq(String alias, String options) {
915         return kt(&quot;-certreq -alias &quot; + alias
916                 + &quot; -file &quot; + alias + &quot;.req &quot; + options);
917     }
918 
919     static OutputAnalyzer exportcert(String alias) {
920         return kt(&quot;-exportcert -alias &quot; + alias + &quot; -file &quot; + alias + &quot;.cert&quot;);
921     }
922 
923     static OutputAnalyzer gencert(String relation, String options) {
924         int pos = relation.indexOf(&quot;-&quot;);
925         String issuer = relation.substring(0, pos);
926         String subject = relation.substring(pos + 1);
927         return kt(&quot; -gencert -alias &quot; + issuer + &quot; -infile &quot; + subject
928                 + &quot;.req -outfile &quot; + relation + &quot;.cert &quot; + options);
929     }
930 
931     static void saveStore() throws IOException {
932         System.out.println(&quot;---------------------------------------------&quot;);
933         System.out.println(&quot;$ cp ks ks2&quot;);
934         Files.copy(Paths.get(&quot;ks&quot;), Paths.get(&quot;ks2&quot;),
935                 StandardCopyOption.REPLACE_EXISTING);
936     }
937 
938     static void reStore() throws IOException {
939         System.out.println(&quot;---------------------------------------------&quot;);
940         System.out.println(&quot;$ cp ks2 ks&quot;);
941         Files.copy(Paths.get(&quot;ks2&quot;), Paths.get(&quot;ks&quot;),
942                 StandardCopyOption.REPLACE_EXISTING);
943     }
944 
945     static void rm(String s) throws IOException {
946         System.out.println(&quot;---------------------------------------------&quot;);
947         System.out.println(&quot;$ rm &quot; + s);
948         Files.deleteIfExists(Paths.get(s));
949     }
950 }
    </pre>
  </body>
</html>