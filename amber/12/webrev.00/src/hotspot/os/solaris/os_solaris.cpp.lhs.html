<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/os/solaris/os_solaris.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;code/vtableStubs.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;logging/logStream.hpp&quot;
  37 #include &quot;memory/allocation.inline.hpp&quot;
  38 #include &quot;memory/filemap.hpp&quot;
  39 #include &quot;memory/universe.hpp&quot;
  40 #include &quot;oops/oop.inline.hpp&quot;
  41 #include &quot;os_share_solaris.hpp&quot;
  42 #include &quot;os_solaris.inline.hpp&quot;
  43 #include &quot;prims/jniFastGetField.hpp&quot;
  44 #include &quot;prims/jvm_misc.hpp&quot;
  45 #include &quot;runtime/arguments.hpp&quot;
  46 #include &quot;runtime/atomic.hpp&quot;
  47 #include &quot;runtime/extendedPC.hpp&quot;
  48 #include &quot;runtime/globals.hpp&quot;
  49 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  50 #include &quot;runtime/java.hpp&quot;
  51 #include &quot;runtime/javaCalls.hpp&quot;
  52 #include &quot;runtime/mutexLocker.hpp&quot;
  53 #include &quot;runtime/objectMonitor.hpp&quot;
  54 #include &quot;runtime/orderAccess.hpp&quot;
  55 #include &quot;runtime/osThread.hpp&quot;
  56 #include &quot;runtime/perfMemory.hpp&quot;
  57 #include &quot;runtime/sharedRuntime.hpp&quot;
  58 #include &quot;runtime/statSampler.hpp&quot;
  59 #include &quot;runtime/stubRoutines.hpp&quot;
  60 #include &quot;runtime/thread.inline.hpp&quot;
  61 #include &quot;runtime/threadCritical.hpp&quot;
  62 #include &quot;runtime/timer.hpp&quot;
  63 #include &quot;runtime/vm_version.hpp&quot;
  64 #include &quot;semaphore_posix.hpp&quot;
  65 #include &quot;services/attachListener.hpp&quot;
  66 #include &quot;services/memTracker.hpp&quot;
  67 #include &quot;services/runtimeService.hpp&quot;
  68 #include &quot;utilities/align.hpp&quot;
  69 #include &quot;utilities/decoder.hpp&quot;
  70 #include &quot;utilities/defaultStream.hpp&quot;
  71 #include &quot;utilities/events.hpp&quot;
  72 #include &quot;utilities/growableArray.hpp&quot;
  73 #include &quot;utilities/macros.hpp&quot;
  74 #include &quot;utilities/vmError.hpp&quot;
  75 
  76 // put OS-includes here
  77 # include &lt;dlfcn.h&gt;
  78 # include &lt;errno.h&gt;
  79 # include &lt;exception&gt;
  80 # include &lt;link.h&gt;
  81 # include &lt;poll.h&gt;
  82 # include &lt;pthread.h&gt;
  83 # include &lt;setjmp.h&gt;
  84 # include &lt;signal.h&gt;
  85 # include &lt;stdio.h&gt;
  86 # include &lt;alloca.h&gt;
  87 # include &lt;sys/filio.h&gt;
  88 # include &lt;sys/ipc.h&gt;
  89 # include &lt;sys/lwp.h&gt;
  90 # include &lt;sys/machelf.h&gt;     // for elf Sym structure used by dladdr1
  91 # include &lt;sys/mman.h&gt;
  92 # include &lt;sys/processor.h&gt;
  93 # include &lt;sys/procset.h&gt;
  94 # include &lt;sys/pset.h&gt;
  95 # include &lt;sys/resource.h&gt;
  96 # include &lt;sys/shm.h&gt;
  97 # include &lt;sys/socket.h&gt;
  98 # include &lt;sys/stat.h&gt;
  99 # include &lt;sys/systeminfo.h&gt;
 100 # include &lt;sys/time.h&gt;
 101 # include &lt;sys/times.h&gt;
 102 # include &lt;sys/types.h&gt;
 103 # include &lt;sys/wait.h&gt;
 104 # include &lt;sys/utsname.h&gt;
 105 # include &lt;thread.h&gt;
 106 # include &lt;unistd.h&gt;
 107 # include &lt;sys/priocntl.h&gt;
 108 # include &lt;sys/rtpriocntl.h&gt;
 109 # include &lt;sys/tspriocntl.h&gt;
 110 # include &lt;sys/iapriocntl.h&gt;
 111 # include &lt;sys/fxpriocntl.h&gt;
 112 # include &lt;sys/loadavg.h&gt;
 113 # include &lt;string.h&gt;
 114 # include &lt;stdio.h&gt;
 115 
 116 # define _STRUCTURED_PROC 1  //  this gets us the new structured proc interfaces of 5.6 &amp; later
 117 # include &lt;sys/procfs.h&gt;     //  see comment in &lt;sys/procfs.h&gt;
 118 
 119 #define MAX_PATH (2 * K)
 120 
 121 // for timer info max values which include all bits
 122 #define ALL_64_BITS CONST64(0xFFFFFFFFFFFFFFFF)
 123 
 124 
 125 // Here are some liblgrp types from sys/lgrp_user.h to be able to
 126 // compile on older systems without this header file.
 127 
 128 #ifndef MADV_ACCESS_LWP
 129   #define  MADV_ACCESS_LWP   7       /* next LWP to access heavily */
 130 #endif
 131 #ifndef MADV_ACCESS_MANY
 132   #define  MADV_ACCESS_MANY  8       /* many processes to access heavily */
 133 #endif
 134 
 135 #ifndef LGRP_RSRC_CPU
 136   #define LGRP_RSRC_CPU      0       /* CPU resources */
 137 #endif
 138 #ifndef LGRP_RSRC_MEM
 139   #define LGRP_RSRC_MEM      1       /* memory resources */
 140 #endif
 141 
 142 // Values for ThreadPriorityPolicy == 1
 143 int prio_policy1[CriticalPriority+1] = {
 144   -99999,  0, 16,  32,  48,  64,
 145           80, 96, 112, 124, 127, 127 };
 146 
 147 // System parameters used internally
 148 static clock_t clock_tics_per_sec = 100;
 149 
 150 // Track if we have called enable_extended_FILE_stdio (on Solaris 10u4+)
 151 static bool enabled_extended_FILE_stdio = false;
 152 
 153 // For diagnostics to print a message once. see run_periodic_checks
 154 static bool check_addr0_done = false;
 155 static sigset_t check_signal_done;
 156 static bool check_signals = true;
 157 
 158 address os::Solaris::handler_start;  // start pc of thr_sighndlrinfo
 159 address os::Solaris::handler_end;    // end pc of thr_sighndlrinfo
 160 
 161 address os::Solaris::_main_stack_base = NULL;  // 4352906 workaround
 162 
 163 os::Solaris::pthread_setname_np_func_t os::Solaris::_pthread_setname_np = NULL;
 164 
 165 // &quot;default&quot; initializers for missing libc APIs
 166 extern &quot;C&quot; {
 167   static int lwp_mutex_init(mutex_t *mx, int scope, void *arg) { memset(mx, 0, sizeof(mutex_t)); return 0; }
 168   static int lwp_mutex_destroy(mutex_t *mx)                 { return 0; }
 169 
 170   static int lwp_cond_init(cond_t *cv, int scope, void *arg){ memset(cv, 0, sizeof(cond_t)); return 0; }
 171   static int lwp_cond_destroy(cond_t *cv)                   { return 0; }
 172 }
 173 
 174 // &quot;default&quot; initializers for pthread-based synchronization
 175 extern &quot;C&quot; {
 176   static int pthread_mutex_default_init(mutex_t *mx, int scope, void *arg) { memset(mx, 0, sizeof(mutex_t)); return 0; }
 177   static int pthread_cond_default_init(cond_t *cv, int scope, void *arg){ memset(cv, 0, sizeof(cond_t)); return 0; }
 178 }
 179 
 180 static void unpackTime(timespec* absTime, bool isAbsolute, jlong time);
 181 
 182 static inline size_t adjust_stack_size(address base, size_t size) {
 183   if ((ssize_t)size &lt; 0) {
 184     // 4759953: Compensate for ridiculous stack size.
 185     size = max_intx;
 186   }
 187   if (size &gt; (size_t)base) {
 188     // 4812466: Make sure size doesn&#39;t allow the stack to wrap the address space.
 189     size = (size_t)base;
 190   }
 191   return size;
 192 }
 193 
 194 static inline stack_t get_stack_info() {
 195   stack_t st;
 196   int retval = thr_stksegment(&amp;st);
 197   st.ss_size = adjust_stack_size((address)st.ss_sp, st.ss_size);
 198   assert(retval == 0, &quot;incorrect return value from thr_stksegment&quot;);
 199   assert((address)&amp;st &lt; (address)st.ss_sp, &quot;Invalid stack base returned&quot;);
 200   assert((address)&amp;st &gt; (address)st.ss_sp-st.ss_size, &quot;Invalid stack size returned&quot;);
 201   return st;
 202 }
 203 
 204 static void _handle_uncaught_cxx_exception() {
 205   VMError::report_and_die(&quot;An uncaught C++ exception&quot;);
 206 }
 207 
 208 bool os::is_primordial_thread(void) {
 209   int r = thr_main();
 210   guarantee(r == 0 || r == 1, &quot;CR6501650 or CR6493689&quot;);
 211   return r == 1;
 212 }
 213 
 214 address os::current_stack_base() {
 215   bool _is_primordial_thread = is_primordial_thread();
 216 
 217   // Workaround 4352906, avoid calls to thr_stksegment by
 218   // thr_main after the first one (it looks like we trash
 219   // some data, causing the value for ss_sp to be incorrect).
 220   if (!_is_primordial_thread || os::Solaris::_main_stack_base == NULL) {
 221     stack_t st = get_stack_info();
 222     if (_is_primordial_thread) {
 223       // cache initial value of stack base
 224       os::Solaris::_main_stack_base = (address)st.ss_sp;
 225     }
 226     return (address)st.ss_sp;
 227   } else {
 228     guarantee(os::Solaris::_main_stack_base != NULL, &quot;Attempt to use null cached stack base&quot;);
 229     return os::Solaris::_main_stack_base;
 230   }
 231 }
 232 
 233 size_t os::current_stack_size() {
 234   size_t size;
 235 
 236   if (!is_primordial_thread()) {
 237     size = get_stack_info().ss_size;
 238   } else {
 239     struct rlimit limits;
 240     getrlimit(RLIMIT_STACK, &amp;limits);
 241     size = adjust_stack_size(os::Solaris::_main_stack_base, (size_t)limits.rlim_cur);
 242   }
 243   // base may not be page aligned
 244   address base = current_stack_base();
 245   address bottom = align_up(base - size, os::vm_page_size());;
 246   return (size_t)(base - bottom);
 247 }
 248 
 249 struct tm* os::localtime_pd(const time_t* clock, struct tm*  res) {
 250   return localtime_r(clock, res);
 251 }
 252 
 253 void os::Solaris::try_enable_extended_io() {
 254   typedef int (*enable_extended_FILE_stdio_t)(int, int);
 255 
 256   if (!UseExtendedFileIO) {
 257     return;
 258   }
 259 
 260   enable_extended_FILE_stdio_t enabler =
 261     (enable_extended_FILE_stdio_t) dlsym(RTLD_DEFAULT,
 262                                          &quot;enable_extended_FILE_stdio&quot;);
 263   if (enabler) {
 264     enabler(-1, -1);
 265   }
 266 }
 267 
 268 jint os::Solaris::_os_thread_limit = 0;
 269 volatile jint os::Solaris::_os_thread_count = 0;
 270 
 271 julong os::available_memory() {
 272   return Solaris::available_memory();
 273 }
 274 
 275 julong os::Solaris::available_memory() {
 276   return (julong)sysconf(_SC_AVPHYS_PAGES) * os::vm_page_size();
 277 }
 278 
 279 julong os::Solaris::_physical_memory = 0;
 280 
 281 julong os::physical_memory() {
 282   return Solaris::physical_memory();
 283 }
 284 
 285 static hrtime_t first_hrtime = 0;
 286 static const hrtime_t hrtime_hz = 1000*1000*1000;
 287 static volatile hrtime_t max_hrtime = 0;
 288 
 289 
 290 void os::Solaris::initialize_system_info() {
 291   set_processor_count(sysconf(_SC_NPROCESSORS_CONF));
 292   _physical_memory = (julong)sysconf(_SC_PHYS_PAGES) *
 293                                      (julong)sysconf(_SC_PAGESIZE);
 294 }
 295 
 296 uint os::processor_id() {
 297   const processorid_t id = ::getcpuid();
 298   assert(id &gt;= 0 &amp;&amp; id &lt; _processor_count, &quot;Invalid processor id&quot;);
 299   return (uint)id;
 300 }
 301 
 302 int os::active_processor_count() {
 303   // User has overridden the number of active processors
 304   if (ActiveProcessorCount &gt; 0) {
 305     log_trace(os)(&quot;active_processor_count: &quot;
 306                   &quot;active processor count set by user : %d&quot;,
 307                   ActiveProcessorCount);
 308     return ActiveProcessorCount;
 309   }
 310 
 311   int online_cpus = sysconf(_SC_NPROCESSORS_ONLN);
 312   pid_t pid = getpid();
 313   psetid_t pset = PS_NONE;
 314   // Are we running in a processor set or is there any processor set around?
 315   if (pset_bind(PS_QUERY, P_PID, pid, &amp;pset) == 0) {
 316     uint_t pset_cpus;
 317     // Query the number of cpus available to us.
 318     if (pset_info(pset, NULL, &amp;pset_cpus, NULL) == 0) {
 319       assert(pset_cpus &gt; 0 &amp;&amp; pset_cpus &lt;= online_cpus, &quot;sanity check&quot;);
 320       return pset_cpus;
 321     }
 322   }
 323   // Otherwise return number of online cpus
 324   return online_cpus;
 325 }
 326 
 327 void os::set_native_thread_name(const char *name) {
 328   if (Solaris::_pthread_setname_np != NULL) {
 329     // Only the first 31 bytes of &#39;name&#39; are processed by pthread_setname_np
 330     // but we explicitly copy into a size-limited buffer to avoid any
 331     // possible overflow.
 332     char buf[32];
 333     snprintf(buf, sizeof(buf), &quot;%s&quot;, name);
 334     buf[sizeof(buf) - 1] = &#39;\0&#39;;
 335     Solaris::_pthread_setname_np(pthread_self(), buf);
 336   }
 337 }
 338 
 339 bool os::bind_to_processor(uint processor_id) {
 340   // We assume that a processorid_t can be stored in a uint.
 341   assert(sizeof(uint) == sizeof(processorid_t),
 342          &quot;can&#39;t convert uint to processorid_t&quot;);
 343   int bind_result =
 344     processor_bind(P_LWPID,                       // bind LWP.
 345                    P_MYID,                        // bind current LWP.
 346                    (processorid_t) processor_id,  // id.
 347                    NULL);                         // don&#39;t return old binding.
 348   return (bind_result == 0);
 349 }
 350 
 351 // Return true if user is running as root.
 352 
 353 bool os::have_special_privileges() {
 354   static bool init = false;
 355   static bool privileges = false;
 356   if (!init) {
 357     privileges = (getuid() != geteuid()) || (getgid() != getegid());
 358     init = true;
 359   }
 360   return privileges;
 361 }
 362 
 363 
 364 void os::init_system_properties_values() {
 365   // The next steps are taken in the product version:
 366   //
 367   // Obtain the JAVA_HOME value from the location of libjvm.so.
 368   // This library should be located at:
 369   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/{client|server}/libjvm.so.
 370   //
 371   // If &quot;/jre/lib/&quot; appears at the right place in the path, then we
 372   // assume libjvm.so is installed in a JDK and we use this path.
 373   //
 374   // Otherwise exit with message: &quot;Could not create the Java virtual machine.&quot;
 375   //
 376   // The following extra steps are taken in the debugging version:
 377   //
 378   // If &quot;/jre/lib/&quot; does NOT appear at the right place in the path
 379   // instead of exit check for $JAVA_HOME environment variable.
 380   //
 381   // If it is defined and we are able to locate $JAVA_HOME/jre/lib/&lt;arch&gt;,
 382   // then we append a fake suffix &quot;hotspot/libjvm.so&quot; to this path so
 383   // it looks like libjvm.so is installed there
 384   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/hotspot/libjvm.so.
 385   //
 386   // Otherwise exit.
 387   //
 388   // Important note: if the location of libjvm.so changes this
 389   // code needs to be changed accordingly.
 390 
 391 // Base path of extensions installed on the system.
 392 #define SYS_EXT_DIR     &quot;/usr/jdk/packages&quot;
 393 #define EXTENSIONS_DIR  &quot;/lib/ext&quot;
 394 
 395   // Buffer that fits several sprintfs.
 396   // Note that the space for the colon and the trailing null are provided
 397   // by the nulls included by the sizeof operator.
 398   const size_t bufsize =
 399     MAX3((size_t)MAXPATHLEN,  // For dll_dir &amp; friends.
 400          sizeof(SYS_EXT_DIR) + sizeof(&quot;/lib/&quot;), // invariant ld_library_path
 401          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR) + sizeof(SYS_EXT_DIR) + sizeof(EXTENSIONS_DIR)); // extensions dir
 402   char *buf = NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);
 403 
 404   // sysclasspath, java_home, dll_dir
 405   {
 406     char *pslash;
 407     os::jvm_path(buf, bufsize);
 408 
 409     // Found the full path to libjvm.so.
 410     // Now cut the path to &lt;java_home&gt;/jre if we can.
 411     *(strrchr(buf, &#39;/&#39;)) = &#39;\0&#39;; // Get rid of /libjvm.so.
 412     pslash = strrchr(buf, &#39;/&#39;);
 413     if (pslash != NULL) {
 414       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 415     }
 416     Arguments::set_dll_dir(buf);
 417 
 418     if (pslash != NULL) {
 419       pslash = strrchr(buf, &#39;/&#39;);
 420       if (pslash != NULL) {
 421         *pslash = &#39;\0&#39;;        // Get rid of /lib.
 422       }
 423     }
 424     Arguments::set_java_home(buf);
 425     if (!set_boot_path(&#39;/&#39;, &#39;:&#39;)) {
 426       vm_exit_during_initialization(&quot;Failed setting boot class path.&quot;, NULL);
 427     }
 428   }
 429 
 430   // Where to look for native libraries.
 431   {
 432     // Use dlinfo() to determine the correct java.library.path.
 433     //
 434     // If we&#39;re launched by the Java launcher, and the user
 435     // does not set java.library.path explicitly on the commandline,
 436     // the Java launcher sets LD_LIBRARY_PATH for us and unsets
 437     // LD_LIBRARY_PATH_32 and LD_LIBRARY_PATH_64.  In this case
 438     // dlinfo returns LD_LIBRARY_PATH + crle settings (including
 439     // /usr/lib), which is exactly what we want.
 440     //
 441     // If the user does set java.library.path, it completely
 442     // overwrites this setting, and always has.
 443     //
 444     // If we&#39;re not launched by the Java launcher, we may
 445     // get here with any/all of the LD_LIBRARY_PATH[_32|64]
 446     // settings.  Again, dlinfo does exactly what we want.
 447 
 448     Dl_serinfo     info_sz, *info = &amp;info_sz;
 449     Dl_serpath     *path;
 450     char           *library_path;
 451     char           *common_path = buf;
 452 
 453     // Determine search path count and required buffer size.
 454     if (dlinfo(RTLD_SELF, RTLD_DI_SERINFOSIZE, (void *)info) == -1) {
 455       FREE_C_HEAP_ARRAY(char, buf);
 456       vm_exit_during_initialization(&quot;dlinfo SERINFOSIZE request&quot;, dlerror());
 457     }
 458 
 459     // Allocate new buffer and initialize.
 460     info = (Dl_serinfo*)NEW_C_HEAP_ARRAY(char, info_sz.dls_size, mtInternal);
 461     info-&gt;dls_size = info_sz.dls_size;
 462     info-&gt;dls_cnt = info_sz.dls_cnt;
 463 
 464     // Obtain search path information.
 465     if (dlinfo(RTLD_SELF, RTLD_DI_SERINFO, (void *)info) == -1) {
 466       FREE_C_HEAP_ARRAY(char, buf);
 467       FREE_C_HEAP_ARRAY(char, info);
 468       vm_exit_during_initialization(&quot;dlinfo SERINFO request&quot;, dlerror());
 469     }
 470 
 471     path = &amp;info-&gt;dls_serpath[0];
 472 
 473     // Note: Due to a legacy implementation, most of the library path
 474     // is set in the launcher. This was to accomodate linking restrictions
 475     // on legacy Solaris implementations (which are no longer supported).
 476     // Eventually, all the library path setting will be done here.
 477     //
 478     // However, to prevent the proliferation of improperly built native
 479     // libraries, the new path component /usr/jdk/packages is added here.
 480 
 481     // Construct the invariant part of ld_library_path.
 482     sprintf(common_path, SYS_EXT_DIR &quot;/lib&quot;);
 483 
 484     // Struct size is more than sufficient for the path components obtained
 485     // through the dlinfo() call, so only add additional space for the path
 486     // components explicitly added here.
 487     size_t library_path_size = info-&gt;dls_size + strlen(common_path);
 488     library_path = NEW_C_HEAP_ARRAY(char, library_path_size, mtInternal);
 489     library_path[0] = &#39;\0&#39;;
 490 
 491     // Construct the desired Java library path from the linker&#39;s library
 492     // search path.
 493     //
 494     // For compatibility, it is optimal that we insert the additional path
 495     // components specific to the Java VM after those components specified
 496     // in LD_LIBRARY_PATH (if any) but before those added by the ld.so
 497     // infrastructure.
 498     if (info-&gt;dls_cnt == 0) { // Not sure this can happen, but allow for it.
 499       strcpy(library_path, common_path);
 500     } else {
 501       int inserted = 0;
 502       int i;
 503       for (i = 0; i &lt; info-&gt;dls_cnt; i++, path++) {
 504         uint_t flags = path-&gt;dls_flags &amp; LA_SER_MASK;
 505         if (((flags &amp; LA_SER_LIBPATH) == 0) &amp;&amp; !inserted) {
 506           strcat(library_path, common_path);
 507           strcat(library_path, os::path_separator());
 508           inserted = 1;
 509         }
 510         strcat(library_path, path-&gt;dls_name);
 511         strcat(library_path, os::path_separator());
 512       }
 513       // Eliminate trailing path separator.
 514       library_path[strlen(library_path)-1] = &#39;\0&#39;;
 515     }
 516 
 517     // happens before argument parsing - can&#39;t use a trace flag
 518     // tty-&gt;print_raw(&quot;init_system_properties_values: native lib path: &quot;);
 519     // tty-&gt;print_raw_cr(library_path);
 520 
 521     // Callee copies into its own buffer.
 522     Arguments::set_library_path(library_path);
 523 
 524     FREE_C_HEAP_ARRAY(char, library_path);
 525     FREE_C_HEAP_ARRAY(char, info);
 526   }
 527 
 528   // Extensions directories.
 529   sprintf(buf, &quot;%s&quot; EXTENSIONS_DIR &quot;:&quot; SYS_EXT_DIR EXTENSIONS_DIR, Arguments::get_java_home());
 530   Arguments::set_ext_dirs(buf);
 531 
 532   FREE_C_HEAP_ARRAY(char, buf);
 533 
 534 #undef SYS_EXT_DIR
 535 #undef EXTENSIONS_DIR
 536 }
 537 
 538 void os::breakpoint() {
 539   BREAKPOINT;
 540 }
 541 
 542 extern &quot;C&quot; void breakpoint() {
 543   // use debugger to set breakpoint here
 544 }
 545 
 546 static thread_t main_thread;
 547 
 548 // Thread start routine for all newly created threads
 549 extern &quot;C&quot; void* thread_native_entry(void* thread_addr) {
 550 
 551   Thread* thread = (Thread*)thread_addr;
 552 
 553   thread-&gt;record_stack_base_and_size();
 554 
 555   // Try to randomize the cache line index of hot stack frames.
 556   // This helps when threads of the same stack traces evict each other&#39;s
 557   // cache lines. The threads can be either from the same JVM instance, or
 558   // from different JVM instances. The benefit is especially true for
 559   // processors with hyperthreading technology.
 560   static int counter = 0;
 561   int pid = os::current_process_id();
 562   alloca(((pid ^ counter++) &amp; 7) * 128);
 563 
 564   int prio;
 565 
 566   thread-&gt;initialize_thread_current();
 567 
 568   OSThread* osthr = thread-&gt;osthread();
 569 
 570   osthr-&gt;set_lwp_id(_lwp_self());  // Store lwp in case we are bound
 571 
 572   log_info(os, thread)(&quot;Thread is alive (tid: &quot; UINTX_FORMAT &quot;).&quot;,
 573     os::current_thread_id());
 574 
 575   if (UseNUMA) {
 576     int lgrp_id = os::numa_get_group_id();
 577     if (lgrp_id != -1) {
 578       thread-&gt;set_lgrp_id(lgrp_id);
 579     }
 580   }
 581 
 582   // Our priority was set when we were created, and stored in the
 583   // osthread, but couldn&#39;t be passed through to our LWP until now.
 584   // So read back the priority and set it again.
 585 
 586   if (osthr-&gt;thread_id() != -1) {
 587     if (UseThreadPriorities) {
 588       int prio = osthr-&gt;native_priority();
 589       if (ThreadPriorityVerbose) {
 590         tty-&gt;print_cr(&quot;Starting Thread &quot; INTPTR_FORMAT &quot;, LWP is &quot;
 591                       INTPTR_FORMAT &quot;, setting priority: %d\n&quot;,
 592                       osthr-&gt;thread_id(), osthr-&gt;lwp_id(), prio);
 593       }
 594       os::set_native_priority(thread, prio);
 595     }
 596   } else if (ThreadPriorityVerbose) {
 597     warning(&quot;Can&#39;t set priority in _start routine, thread id hasn&#39;t been set\n&quot;);
 598   }
 599 
 600   assert(osthr-&gt;get_state() == RUNNABLE, &quot;invalid os thread state&quot;);
 601 
 602   // initialize signal mask for this thread
 603   os::Solaris::hotspot_sigmask(thread);
 604 
 605   os::Solaris::init_thread_fpu_state();
 606   std::set_terminate(_handle_uncaught_cxx_exception);
 607 
 608   thread-&gt;call_run();
 609 
 610   // Note: at this point the thread object may already have deleted itself.
 611   // Do not dereference it from here on out.
 612 
 613   // One less thread is executing
 614   // When the VMThread gets here, the main thread may have already exited
 615   // which frees the CodeHeap containing the Atomic::dec code
 616   if (thread != VMThread::vm_thread() &amp;&amp; VMThread::vm_thread() != NULL) {
 617     Atomic::dec(&amp;os::Solaris::_os_thread_count);
 618   }
 619 
 620   log_info(os, thread)(&quot;Thread finished (tid: &quot; UINTX_FORMAT &quot;).&quot;, os::current_thread_id());
 621 
 622   if (UseDetachedThreads) {
 623     thr_exit(NULL);
 624     ShouldNotReachHere();
 625   }
 626   return NULL;
 627 }
 628 
 629 static OSThread* create_os_thread(Thread* thread, thread_t thread_id) {
 630   // Allocate the OSThread object
 631   OSThread* osthread = new OSThread(NULL, NULL);
 632   if (osthread == NULL) return NULL;
 633 
 634   // Store info on the Solaris thread into the OSThread
 635   osthread-&gt;set_thread_id(thread_id);
 636   osthread-&gt;set_lwp_id(_lwp_self());
 637 
 638   if (UseNUMA) {
 639     int lgrp_id = os::numa_get_group_id();
 640     if (lgrp_id != -1) {
 641       thread-&gt;set_lgrp_id(lgrp_id);
 642     }
 643   }
 644 
 645   if (ThreadPriorityVerbose) {
 646     tty-&gt;print_cr(&quot;In create_os_thread, Thread &quot; INTPTR_FORMAT &quot;, LWP is &quot; INTPTR_FORMAT &quot;\n&quot;,
 647                   osthread-&gt;thread_id(), osthread-&gt;lwp_id());
 648   }
 649 
 650   // Initial thread state is INITIALIZED, not SUSPENDED
 651   osthread-&gt;set_state(INITIALIZED);
 652 
 653   return osthread;
 654 }
 655 
 656 void os::Solaris::hotspot_sigmask(Thread* thread) {
 657   //Save caller&#39;s signal mask
 658   sigset_t sigmask;
 659   pthread_sigmask(SIG_SETMASK, NULL, &amp;sigmask);
 660   OSThread *osthread = thread-&gt;osthread();
 661   osthread-&gt;set_caller_sigmask(sigmask);
 662 
 663   pthread_sigmask(SIG_UNBLOCK, os::Solaris::unblocked_signals(), NULL);
 664   if (!ReduceSignalUsage) {
 665     if (thread-&gt;is_VM_thread()) {
 666       // Only the VM thread handles BREAK_SIGNAL ...
 667       pthread_sigmask(SIG_UNBLOCK, vm_signals(), NULL);
 668     } else {
 669       // ... all other threads block BREAK_SIGNAL
 670       assert(!sigismember(vm_signals(), SIGINT), &quot;SIGINT should not be blocked&quot;);
 671       pthread_sigmask(SIG_BLOCK, vm_signals(), NULL);
 672     }
 673   }
 674 }
 675 
 676 bool os::create_attached_thread(JavaThread* thread) {
 677 #ifdef ASSERT
 678   thread-&gt;verify_not_published();
 679 #endif
 680   OSThread* osthread = create_os_thread(thread, thr_self());
 681   if (osthread == NULL) {
 682     return false;
 683   }
 684 
 685   // Initial thread state is RUNNABLE
 686   osthread-&gt;set_state(RUNNABLE);
 687   thread-&gt;set_osthread(osthread);
 688 
 689   // initialize signal mask for this thread
 690   // and save the caller&#39;s signal mask
 691   os::Solaris::hotspot_sigmask(thread);
 692 
 693   log_info(os, thread)(&quot;Thread attached (tid: &quot; UINTX_FORMAT &quot;).&quot;,
 694     os::current_thread_id());
 695 
 696   return true;
 697 }
 698 
 699 bool os::create_main_thread(JavaThread* thread) {
 700 #ifdef ASSERT
 701   thread-&gt;verify_not_published();
 702 #endif
 703   if (_starting_thread == NULL) {
 704     _starting_thread = create_os_thread(thread, main_thread);
 705     if (_starting_thread == NULL) {
 706       return false;
 707     }
 708   }
 709 
 710   // The primodial thread is runnable from the start
 711   _starting_thread-&gt;set_state(RUNNABLE);
 712 
 713   thread-&gt;set_osthread(_starting_thread);
 714 
 715   // initialize signal mask for this thread
 716   // and save the caller&#39;s signal mask
 717   os::Solaris::hotspot_sigmask(thread);
 718 
 719   return true;
 720 }
 721 
 722 // Helper function to trace thread attributes, similar to os::Posix::describe_pthread_attr()
 723 static char* describe_thr_create_attributes(char* buf, size_t buflen,
 724                                             size_t stacksize, long flags) {
 725   stringStream ss(buf, buflen);
 726   ss.print(&quot;stacksize: &quot; SIZE_FORMAT &quot;k, &quot;, stacksize / 1024);
 727   ss.print(&quot;flags: &quot;);
 728   #define PRINT_FLAG(f) if (flags &amp; f) ss.print( #f &quot; &quot;);
 729   #define ALL(X) \
 730     X(THR_SUSPENDED) \
 731     X(THR_DETACHED) \
 732     X(THR_BOUND) \
 733     X(THR_NEW_LWP) \
 734     X(THR_DAEMON)
 735   ALL(PRINT_FLAG)
 736   #undef ALL
 737   #undef PRINT_FLAG
 738   return buf;
 739 }
 740 
 741 // return default stack size for thr_type
 742 size_t os::Posix::default_stack_size(os::ThreadType thr_type) {
 743   // default stack size when not specified by caller is 1M (2M for LP64)
 744   size_t s = (BytesPerWord &gt;&gt; 2) * K * K;
 745   return s;
 746 }
 747 
 748 bool os::create_thread(Thread* thread, ThreadType thr_type,
 749                        size_t req_stack_size) {
 750   // Allocate the OSThread object
 751   OSThread* osthread = new OSThread(NULL, NULL);
 752   if (osthread == NULL) {
 753     return false;
 754   }
 755 
 756   if (ThreadPriorityVerbose) {
 757     char *thrtyp;
 758     switch (thr_type) {
 759     case vm_thread:
 760       thrtyp = (char *)&quot;vm&quot;;
 761       break;
 762     case cgc_thread:
 763       thrtyp = (char *)&quot;cgc&quot;;
 764       break;
 765     case pgc_thread:
 766       thrtyp = (char *)&quot;pgc&quot;;
 767       break;
 768     case java_thread:
 769       thrtyp = (char *)&quot;java&quot;;
 770       break;
 771     case compiler_thread:
 772       thrtyp = (char *)&quot;compiler&quot;;
 773       break;
 774     case watcher_thread:
 775       thrtyp = (char *)&quot;watcher&quot;;
 776       break;
 777     default:
 778       thrtyp = (char *)&quot;unknown&quot;;
 779       break;
 780     }
 781     tty-&gt;print_cr(&quot;In create_thread, creating a %s thread\n&quot;, thrtyp);
 782   }
 783 
 784   // calculate stack size if it&#39;s not specified by caller
 785   size_t stack_size = os::Posix::get_initial_stack_size(thr_type, req_stack_size);
 786 
 787   // Initial state is ALLOCATED but not INITIALIZED
 788   osthread-&gt;set_state(ALLOCATED);
 789 
 790   if (os::Solaris::_os_thread_count &gt; os::Solaris::_os_thread_limit) {
 791     // We got lots of threads. Check if we still have some address space left.
 792     // Need to be at least 5Mb of unreserved address space. We do check by
 793     // trying to reserve some.
 794     const size_t VirtualMemoryBangSize = 20*K*K;
 795     char* mem = os::reserve_memory(VirtualMemoryBangSize);
 796     if (mem == NULL) {
 797       delete osthread;
 798       return false;
 799     } else {
 800       // Release the memory again
 801       os::release_memory(mem, VirtualMemoryBangSize);
 802     }
 803   }
 804 
 805   // Setup osthread because the child thread may need it.
 806   thread-&gt;set_osthread(osthread);
 807 
 808   // Create the Solaris thread
 809   thread_t tid = 0;
 810   long     flags = (UseDetachedThreads ? THR_DETACHED : 0) | THR_SUSPENDED;
 811   int      status;
 812 
 813   // Mark that we don&#39;t have an lwp or thread id yet.
 814   // In case we attempt to set the priority before the thread starts.
 815   osthread-&gt;set_lwp_id(-1);
 816   osthread-&gt;set_thread_id(-1);
 817 
 818   status = thr_create(NULL, stack_size, thread_native_entry, thread, flags, &amp;tid);
 819 
 820   char buf[64];
 821   if (status == 0) {
 822     log_info(os, thread)(&quot;Thread started (tid: &quot; UINTX_FORMAT &quot;, attributes: %s). &quot;,
 823       (uintx) tid, describe_thr_create_attributes(buf, sizeof(buf), stack_size, flags));
 824   } else {
 825     log_warning(os, thread)(&quot;Failed to start thread - thr_create failed (%s) for attributes: %s.&quot;,
 826       os::errno_name(status), describe_thr_create_attributes(buf, sizeof(buf), stack_size, flags));
 827     // Log some OS information which might explain why creating the thread failed.
 828     log_info(os, thread)(&quot;Number of threads approx. running in the VM: %d&quot;, Threads::number_of_threads());
 829     LogStream st(Log(os, thread)::info());
 830     os::Posix::print_rlimit_info(&amp;st);
 831     os::print_memory_info(&amp;st);
 832   }
 833 
 834   if (status != 0) {
 835     thread-&gt;set_osthread(NULL);
 836     // Need to clean up stuff we&#39;ve allocated so far
 837     delete osthread;
 838     return false;
 839   }
 840 
 841   Atomic::inc(&amp;os::Solaris::_os_thread_count);
 842 
 843   // Store info on the Solaris thread into the OSThread
 844   osthread-&gt;set_thread_id(tid);
 845 
 846   // Remember that we created this thread so we can set priority on it
 847   osthread-&gt;set_vm_created();
 848 
 849   // Most thread types will set an explicit priority before starting the thread,
 850   // but for those that don&#39;t we need a valid value to read back in thread_native_entry.
 851   osthread-&gt;set_native_priority(NormPriority);
 852 
 853   // Initial thread state is INITIALIZED, not SUSPENDED
 854   osthread-&gt;set_state(INITIALIZED);
 855 
 856   // The thread is returned suspended (in state INITIALIZED), and is started higher up in the call chain
 857   return true;
 858 }
 859 
 860 debug_only(static bool signal_sets_initialized = false);
 861 static sigset_t unblocked_sigs, vm_sigs;
 862 
 863 void os::Solaris::signal_sets_init() {
 864   // Should also have an assertion stating we are still single-threaded.
 865   assert(!signal_sets_initialized, &quot;Already initialized&quot;);
 866   // Fill in signals that are necessarily unblocked for all threads in
 867   // the VM. Currently, we unblock the following signals:
 868   // SHUTDOWN{1,2,3}_SIGNAL: for shutdown hooks support (unless over-ridden
 869   //                         by -Xrs (=ReduceSignalUsage));
 870   // BREAK_SIGNAL which is unblocked only by the VM thread and blocked by all
 871   // other threads. The &quot;ReduceSignalUsage&quot; boolean tells us not to alter
 872   // the dispositions or masks wrt these signals.
 873   // Programs embedding the VM that want to use the above signals for their
 874   // own purposes must, at this time, use the &quot;-Xrs&quot; option to prevent
 875   // interference with shutdown hooks and BREAK_SIGNAL thread dumping.
 876   // (See bug 4345157, and other related bugs).
 877   // In reality, though, unblocking these signals is really a nop, since
 878   // these signals are not blocked by default.
 879   sigemptyset(&amp;unblocked_sigs);
 880   sigaddset(&amp;unblocked_sigs, SIGILL);
 881   sigaddset(&amp;unblocked_sigs, SIGSEGV);
 882   sigaddset(&amp;unblocked_sigs, SIGBUS);
 883   sigaddset(&amp;unblocked_sigs, SIGFPE);
 884   sigaddset(&amp;unblocked_sigs, ASYNC_SIGNAL);
 885 
 886   if (!ReduceSignalUsage) {
 887     if (!os::Posix::is_sig_ignored(SHUTDOWN1_SIGNAL)) {
 888       sigaddset(&amp;unblocked_sigs, SHUTDOWN1_SIGNAL);
 889     }
 890     if (!os::Posix::is_sig_ignored(SHUTDOWN2_SIGNAL)) {
 891       sigaddset(&amp;unblocked_sigs, SHUTDOWN2_SIGNAL);
 892     }
 893     if (!os::Posix::is_sig_ignored(SHUTDOWN3_SIGNAL)) {
 894       sigaddset(&amp;unblocked_sigs, SHUTDOWN3_SIGNAL);
 895     }
 896   }
 897   // Fill in signals that are blocked by all but the VM thread.
 898   sigemptyset(&amp;vm_sigs);
 899   if (!ReduceSignalUsage) {
 900     sigaddset(&amp;vm_sigs, BREAK_SIGNAL);
 901   }
 902   debug_only(signal_sets_initialized = true);
 903 
 904   // For diagnostics only used in run_periodic_checks
 905   sigemptyset(&amp;check_signal_done);
 906 }
 907 
 908 // These are signals that are unblocked while a thread is running Java.
 909 // (For some reason, they get blocked by default.)
 910 sigset_t* os::Solaris::unblocked_signals() {
 911   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 912   return &amp;unblocked_sigs;
 913 }
 914 
 915 // These are the signals that are blocked while a (non-VM) thread is
 916 // running Java. Only the VM thread handles these signals.
 917 sigset_t* os::Solaris::vm_signals() {
 918   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 919   return &amp;vm_sigs;
 920 }
 921 
 922 // CR 7190089: on Solaris, primordial thread&#39;s stack needs adjusting.
 923 // Without the adjustment, stack size is incorrect if stack is set to unlimited (ulimit -s unlimited).
 924 void os::Solaris::correct_stack_boundaries_for_primordial_thread(Thread* thr) {
 925   assert(is_primordial_thread(), &quot;Call only for primordial thread&quot;);
 926 
 927   JavaThread* jt = (JavaThread *)thr;
 928   assert(jt != NULL, &quot;Sanity check&quot;);
 929   size_t stack_size;
 930   address base = jt-&gt;stack_base();
 931   if (Arguments::created_by_java_launcher()) {
 932     // Use 2MB to allow for Solaris 7 64 bit mode.
 933     stack_size = JavaThread::stack_size_at_create() == 0
 934       ? 2048*K : JavaThread::stack_size_at_create();
 935 
 936     // There are rare cases when we may have already used more than
 937     // the basic stack size allotment before this method is invoked.
 938     // Attempt to allow for a normally sized java_stack.
 939     size_t current_stack_offset = (size_t)(base - (address)&amp;stack_size);
 940     stack_size += ReservedSpace::page_align_size_down(current_stack_offset);
 941   } else {
 942     // 6269555: If we were not created by a Java launcher, i.e. if we are
 943     // running embedded in a native application, treat the primordial thread
 944     // as much like a native attached thread as possible.  This means using
 945     // the current stack size from thr_stksegment(), unless it is too large
 946     // to reliably setup guard pages.  A reasonable max size is 8MB.
 947     size_t current_size = os::current_stack_size();
 948     // This should never happen, but just in case....
 949     if (current_size == 0) current_size = 2 * K * K;
 950     stack_size = current_size &gt; (8 * K * K) ? (8 * K * K) : current_size;
 951   }
 952   address bottom = align_up(base - stack_size, os::vm_page_size());;
 953   stack_size = (size_t)(base - bottom);
 954 
 955   assert(stack_size &gt; 0, &quot;Stack size calculation problem&quot;);
 956 
 957   if (stack_size &gt; jt-&gt;stack_size()) {
 958 #ifndef PRODUCT
 959     struct rlimit limits;
 960     getrlimit(RLIMIT_STACK, &amp;limits);
 961     size_t size = adjust_stack_size(base, (size_t)limits.rlim_cur);
 962     assert(size &gt;= jt-&gt;stack_size(), &quot;Stack size problem in main thread&quot;);
 963 #endif
 964     tty-&gt;print_cr(&quot;Stack size of %d Kb exceeds current limit of %d Kb.\n&quot;
 965                   &quot;(Stack sizes are rounded up to a multiple of the system page size.)\n&quot;
 966                   &quot;See limit(1) to increase the stack size limit.&quot;,
 967                   stack_size / K, jt-&gt;stack_size() / K);
 968     vm_exit(1);
 969   }
 970   assert(jt-&gt;stack_size() &gt;= stack_size,
 971          &quot;Attempt to map more stack than was allocated&quot;);
 972   jt-&gt;set_stack_size(stack_size);
 973 
 974 }
 975 
 976 
 977 
 978 // Free Solaris resources related to the OSThread
 979 void os::free_thread(OSThread* osthread) {
 980   assert(osthread != NULL, &quot;os::free_thread but osthread not set&quot;);
 981 
 982   // We are told to free resources of the argument thread,
 983   // but we can only really operate on the current thread.
 984   assert(Thread::current()-&gt;osthread() == osthread,
 985          &quot;os::free_thread but not current thread&quot;);
 986 
 987   // Restore caller&#39;s signal mask
 988   sigset_t sigmask = osthread-&gt;caller_sigmask();
 989   pthread_sigmask(SIG_SETMASK, &amp;sigmask, NULL);
 990 
 991   delete osthread;
 992 }
 993 
 994 void os::pd_start_thread(Thread* thread) {
 995   int status = thr_continue(thread-&gt;osthread()-&gt;thread_id());
 996   assert_status(status == 0, status, &quot;thr_continue failed&quot;);
 997 }
 998 
 999 
1000 intx os::current_thread_id() {
1001   return (intx)thr_self();
1002 }
1003 
1004 static pid_t _initial_pid = 0;
1005 
1006 int os::current_process_id() {
1007   return (int)(_initial_pid ? _initial_pid : getpid());
1008 }
1009 
1010 // gethrtime() should be monotonic according to the documentation,
1011 // but some virtualized platforms are known to break this guarantee.
1012 // getTimeNanos() must be guaranteed not to move backwards, so we
1013 // are forced to add a check here.
1014 inline hrtime_t getTimeNanos() {
1015   const hrtime_t now = gethrtime();
1016   const hrtime_t prev = max_hrtime;
1017   if (now &lt;= prev) {
1018     return prev;   // same or retrograde time;
1019   }
1020   const hrtime_t obsv = Atomic::cmpxchg(&amp;max_hrtime, prev, now);
1021   assert(obsv &gt;= prev, &quot;invariant&quot;);   // Monotonicity
1022   // If the CAS succeeded then we&#39;re done and return &quot;now&quot;.
1023   // If the CAS failed and the observed value &quot;obsv&quot; is &gt;= now then
1024   // we should return &quot;obsv&quot;.  If the CAS failed and now &gt; obsv &gt; prv then
1025   // some other thread raced this thread and installed a new value, in which case
1026   // we could either (a) retry the entire operation, (b) retry trying to install now
1027   // or (c) just return obsv.  We use (c).   No loop is required although in some cases
1028   // we might discard a higher &quot;now&quot; value in deference to a slightly lower but freshly
1029   // installed obsv value.   That&#39;s entirely benign -- it admits no new orderings compared
1030   // to (a) or (b) -- and greatly reduces coherence traffic.
1031   // We might also condition (c) on the magnitude of the delta between obsv and now.
1032   // Avoiding excessive CAS operations to hot RW locations is critical.
1033   // See https://blogs.oracle.com/dave/entry/cas_and_cache_trivia_invalidate
1034   return (prev == obsv) ? now : obsv;
1035 }
1036 
1037 // Time since start-up in seconds to a fine granularity.
1038 // Used by VMSelfDestructTimer and the MemProfiler.
1039 double os::elapsedTime() {
1040   return (double)(getTimeNanos() - first_hrtime) / (double)hrtime_hz;
1041 }
1042 
1043 jlong os::elapsed_counter() {
1044   return (jlong)(getTimeNanos() - first_hrtime);
1045 }
1046 
1047 jlong os::elapsed_frequency() {
1048   return hrtime_hz;
1049 }
1050 
1051 // Return the real, user, and system times in seconds from an
1052 // arbitrary fixed point in the past.
1053 bool os::getTimesSecs(double* process_real_time,
1054                       double* process_user_time,
1055                       double* process_system_time) {
1056   struct tms ticks;
1057   clock_t real_ticks = times(&amp;ticks);
1058 
1059   if (real_ticks == (clock_t) (-1)) {
1060     return false;
1061   } else {
1062     double ticks_per_second = (double) clock_tics_per_sec;
1063     *process_user_time = ((double) ticks.tms_utime) / ticks_per_second;
1064     *process_system_time = ((double) ticks.tms_stime) / ticks_per_second;
1065     // For consistency return the real time from getTimeNanos()
1066     // converted to seconds.
1067     *process_real_time = ((double) getTimeNanos()) / ((double) NANOUNITS);
1068 
1069     return true;
1070   }
1071 }
1072 
1073 bool os::supports_vtime() { return true; }
1074 
1075 double os::elapsedVTime() {
1076   return (double)gethrvtime() / (double)hrtime_hz;
1077 }
1078 
1079 // Must return millis since Jan 1 1970 for JVM_CurrentTimeMillis
1080 jlong os::javaTimeMillis() {
1081   timeval t;
1082   if (gettimeofday(&amp;t, NULL) == -1) {
1083     fatal(&quot;os::javaTimeMillis: gettimeofday (%s)&quot;, os::strerror(errno));
1084   }
1085   return jlong(t.tv_sec) * 1000  +  jlong(t.tv_usec) / 1000;
1086 }
1087 
1088 // Must return seconds+nanos since Jan 1 1970. This must use the same
1089 // time source as javaTimeMillis and can&#39;t use get_nsec_fromepoch as
1090 // we need better than 1ms accuracy
1091 void os::javaTimeSystemUTC(jlong &amp;seconds, jlong &amp;nanos) {
1092   timeval t;
1093   if (gettimeofday(&amp;t, NULL) == -1) {
1094     fatal(&quot;os::javaTimeSystemUTC: gettimeofday (%s)&quot;, os::strerror(errno));
1095   }
1096   seconds = jlong(t.tv_sec);
1097   nanos = jlong(t.tv_usec) * 1000;
1098 }
1099 
1100 
1101 jlong os::javaTimeNanos() {
1102   return (jlong)getTimeNanos();
1103 }
1104 
1105 void os::javaTimeNanos_info(jvmtiTimerInfo *info_ptr) {
1106   info_ptr-&gt;max_value = ALL_64_BITS;      // gethrtime() uses all 64 bits
1107   info_ptr-&gt;may_skip_backward = false;    // not subject to resetting or drifting
1108   info_ptr-&gt;may_skip_forward = false;     // not subject to resetting or drifting
1109   info_ptr-&gt;kind = JVMTI_TIMER_ELAPSED;   // elapsed not CPU time
1110 }
1111 
1112 char * os::local_time_string(char *buf, size_t buflen) {
1113   struct tm t;
1114   time_t long_time;
1115   time(&amp;long_time);
1116   localtime_r(&amp;long_time, &amp;t);
1117   jio_snprintf(buf, buflen, &quot;%d-%02d-%02d %02d:%02d:%02d&quot;,
1118                t.tm_year + 1900, t.tm_mon + 1, t.tm_mday,
1119                t.tm_hour, t.tm_min, t.tm_sec);
1120   return buf;
1121 }
1122 
1123 // Note: os::shutdown() might be called very early during initialization, or
1124 // called from signal handler. Before adding something to os::shutdown(), make
1125 // sure it is async-safe and can handle partially initialized VM.
1126 void os::shutdown() {
1127 
1128   // allow PerfMemory to attempt cleanup of any persistent resources
1129   perfMemory_exit();
1130 
1131   // needs to remove object in file system
1132   AttachListener::abort();
1133 
1134   // flush buffered output, finish log files
1135   ostream_abort();
1136 
1137   // Check for abort hook
1138   abort_hook_t abort_hook = Arguments::abort_hook();
1139   if (abort_hook != NULL) {
1140     abort_hook();
1141   }
1142 }
1143 
1144 // Note: os::abort() might be called very early during initialization, or
1145 // called from signal handler. Before adding something to os::abort(), make
1146 // sure it is async-safe and can handle partially initialized VM.
1147 void os::abort(bool dump_core, void* siginfo, const void* context) {
1148   os::shutdown();
1149   if (dump_core) {
1150 #ifndef PRODUCT
1151     fdStream out(defaultStream::output_fd());
1152     out.print_raw(&quot;Current thread is &quot;);
1153     char buf[16];
1154     jio_snprintf(buf, sizeof(buf), UINTX_FORMAT, os::current_thread_id());
1155     out.print_raw_cr(buf);
1156     out.print_raw_cr(&quot;Dumping core ...&quot;);
1157 #endif
1158     ::abort(); // dump core (for debugging)
1159   }
1160 
1161   ::exit(1);
1162 }
1163 
1164 // Die immediately, no exit hook, no abort hook, no cleanup.
1165 // Dump a core file, if possible, for debugging.
1166 void os::die() {
1167   if (TestUnresponsiveErrorHandler &amp;&amp; !CreateCoredumpOnCrash) {
1168     // For TimeoutInErrorHandlingTest.java, we just kill the VM
1169     // and don&#39;t take the time to generate a core file.
1170     os::signal_raise(SIGKILL);
1171   } else {
1172     ::abort();
1173   }
1174 }
1175 
1176 // DLL functions
1177 
1178 const char* os::dll_file_extension() { return &quot;.so&quot;; }
1179 
1180 // This must be hard coded because it&#39;s the system&#39;s temporary
1181 // directory not the java application&#39;s temp directory, ala java.io.tmpdir.
1182 const char* os::get_temp_directory() { return &quot;/tmp&quot;; }
1183 
1184 // check if addr is inside libjvm.so
1185 bool os::address_is_in_vm(address addr) {
1186   static address libjvm_base_addr;
1187   Dl_info dlinfo;
1188 
1189   if (libjvm_base_addr == NULL) {
1190     if (dladdr(CAST_FROM_FN_PTR(void *, os::address_is_in_vm), &amp;dlinfo) != 0) {
1191       libjvm_base_addr = (address)dlinfo.dli_fbase;
1192     }
1193     assert(libjvm_base_addr !=NULL, &quot;Cannot obtain base address for libjvm&quot;);
1194   }
1195 
1196   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1197     if (libjvm_base_addr == (address)dlinfo.dli_fbase) return true;
1198   }
1199 
1200   return false;
1201 }
1202 
1203 typedef int (*dladdr1_func_type)(void *, Dl_info *, void **, int);
1204 static dladdr1_func_type dladdr1_func = NULL;
1205 
1206 bool os::dll_address_to_function_name(address addr, char *buf,
1207                                       int buflen, int * offset,
1208                                       bool demangle) {
1209   // buf is not optional, but offset is optional
1210   assert(buf != NULL, &quot;sanity check&quot;);
1211 
1212   Dl_info dlinfo;
1213 
1214   // dladdr1_func was initialized in os::init()
1215   if (dladdr1_func != NULL) {
1216     // yes, we have dladdr1
1217 
1218     // Support for dladdr1 is checked at runtime; it may be
1219     // available even if the vm is built on a machine that does
1220     // not have dladdr1 support.  Make sure there is a value for
1221     // RTLD_DL_SYMENT.
1222 #ifndef RTLD_DL_SYMENT
1223   #define RTLD_DL_SYMENT 1
1224 #endif
1225 #ifdef _LP64
1226     Elf64_Sym * info;
1227 #else
1228     Elf32_Sym * info;
1229 #endif
1230     if (dladdr1_func((void *)addr, &amp;dlinfo, (void **)&amp;info,
1231                      RTLD_DL_SYMENT) != 0) {
1232       // see if we have a matching symbol that covers our address
1233       if (dlinfo.dli_saddr != NULL &amp;&amp;
1234           (char *)dlinfo.dli_saddr + info-&gt;st_size &gt; (char *)addr) {
1235         if (dlinfo.dli_sname != NULL) {
1236           if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1237             jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_sname);
1238           }
1239           if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1240           return true;
1241         }
1242       }
1243       // no matching symbol so try for just file info
1244       if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1245         if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1246                             buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1247           return true;
1248         }
1249       }
1250     }
1251     buf[0] = &#39;\0&#39;;
1252     if (offset != NULL) *offset  = -1;
1253     return false;
1254   }
1255 
1256   // no, only dladdr is available
1257   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1258     // see if we have a matching symbol
1259     if (dlinfo.dli_saddr != NULL &amp;&amp; dlinfo.dli_sname != NULL) {
1260       if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1261         jio_snprintf(buf, buflen, dlinfo.dli_sname);
1262       }
1263       if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1264       return true;
1265     }
1266     // no matching symbol so try for just file info
1267     if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1268       if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1269                           buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1270         return true;
1271       }
1272     }
1273   }
1274   buf[0] = &#39;\0&#39;;
1275   if (offset != NULL) *offset  = -1;
1276   return false;
1277 }
1278 
1279 bool os::dll_address_to_library_name(address addr, char* buf,
1280                                      int buflen, int* offset) {
1281   // buf is not optional, but offset is optional
1282   assert(buf != NULL, &quot;sanity check&quot;);
1283 
1284   Dl_info dlinfo;
1285 
1286   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1287     if (dlinfo.dli_fname != NULL) {
1288       jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_fname);
1289     }
1290     if (dlinfo.dli_fbase != NULL &amp;&amp; offset != NULL) {
1291       *offset = addr - (address)dlinfo.dli_fbase;
1292     }
1293     return true;
1294   }
1295 
1296   buf[0] = &#39;\0&#39;;
1297   if (offset) *offset = -1;
1298   return false;
1299 }
1300 
1301 int os::get_loaded_modules_info(os::LoadedModulesCallbackFunc callback, void *param) {
1302   Dl_info dli;
1303   // Sanity check?
1304   if (dladdr(CAST_FROM_FN_PTR(void *, os::get_loaded_modules_info), &amp;dli) == 0 ||
1305       dli.dli_fname == NULL) {
1306     return 1;
1307   }
1308 
1309   void * handle = dlopen(dli.dli_fname, RTLD_LAZY);
1310   if (handle == NULL) {
1311     return 1;
1312   }
1313 
1314   Link_map *map;
1315   dlinfo(handle, RTLD_DI_LINKMAP, &amp;map);
1316   if (map == NULL) {
1317     dlclose(handle);
1318     return 1;
1319   }
1320 
1321   while (map-&gt;l_prev != NULL) {
1322     map = map-&gt;l_prev;
1323   }
1324 
1325   while (map != NULL) {
1326     // Iterate through all map entries and call callback with fields of interest
1327     if(callback(map-&gt;l_name, (address)map-&gt;l_addr, (address)0, param)) {
1328       dlclose(handle);
1329       return 1;
1330     }
1331     map = map-&gt;l_next;
1332   }
1333 
1334   dlclose(handle);
1335   return 0;
1336 }
1337 
1338 int _print_dll_info_cb(const char * name, address base_address, address top_address, void * param) {
1339   outputStream * out = (outputStream *) param;
1340   out-&gt;print_cr(PTR_FORMAT &quot; \t%s&quot;, base_address, name);
1341   return 0;
1342 }
1343 
1344 void os::print_dll_info(outputStream * st) {
1345   st-&gt;print_cr(&quot;Dynamic libraries:&quot;); st-&gt;flush();
1346   if (get_loaded_modules_info(_print_dll_info_cb, (void *)st)) {
1347     st-&gt;print_cr(&quot;Error: Cannot print dynamic libraries.&quot;);
1348   }
1349 }
1350 
1351 static void change_endianness(Elf32_Half&amp; val) {
1352   unsigned char *ptr = (unsigned char *)&amp;val;
1353   unsigned char swp = ptr[0];
1354   ptr[0] = ptr[1];
1355   ptr[1] = swp;
1356 }
1357 
1358 // Loads .dll/.so and
1359 // in case of error it checks if .dll/.so was built for the
1360 // same architecture as Hotspot is running on
1361 
1362 void * os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1363   log_info(os)(&quot;attempting shared library load of %s&quot;, filename);
1364 
1365   void * result= ::dlopen(filename, RTLD_LAZY);
1366   if (result != NULL) {
1367     // Successful loading
1368     Events::log(NULL, &quot;Loaded shared library %s&quot;, filename);
1369     log_info(os)(&quot;shared library load of %s was successful&quot;, filename);
1370     return result;
1371   }
1372 
1373   Elf32_Ehdr elf_head;
1374   const char* error_report = ::dlerror();
1375   if (error_report == NULL) {
1376     error_report = &quot;dlerror returned no error description&quot;;
1377   }
1378   if (ebuf != NULL &amp;&amp; ebuflen &gt; 0) {
1379     ::strncpy(ebuf, error_report, ebuflen-1);
1380     ebuf[ebuflen-1]=&#39;\0&#39;;
1381   }
1382 
1383   Events::log(NULL, &quot;Loading shared library %s failed, %s&quot;, filename, error_report);
1384   log_info(os)(&quot;shared library load of %s failed, %s&quot;, filename, error_report);
1385 
1386   int diag_msg_max_length=ebuflen-strlen(ebuf);
1387   char* diag_msg_buf=ebuf+strlen(ebuf);
1388 
1389   if (diag_msg_max_length==0) {
1390     // No more space in ebuf for additional diagnostics message
1391     return NULL;
1392   }
1393 
1394 
1395   int file_descriptor= ::open(filename, O_RDONLY | O_NONBLOCK);
1396 
1397   if (file_descriptor &lt; 0) {
1398     // Can&#39;t open library, report dlerror() message
1399     return NULL;
1400   }
1401 
1402   bool failed_to_read_elf_head=
1403     (sizeof(elf_head)!=
1404      (::read(file_descriptor, &amp;elf_head,sizeof(elf_head))));
1405 
1406   ::close(file_descriptor);
1407   if (failed_to_read_elf_head) {
1408     // file i/o error - report dlerror() msg
1409     return NULL;
1410   }
1411 
1412   if (elf_head.e_ident[EI_DATA] != LITTLE_ENDIAN_ONLY(ELFDATA2LSB) BIG_ENDIAN_ONLY(ELFDATA2MSB)) {
1413     // handle invalid/out of range endianness values
1414     if (elf_head.e_ident[EI_DATA] == 0 || elf_head.e_ident[EI_DATA] &gt; 2) {
1415       return NULL;
1416     }
1417     change_endianness(elf_head.e_machine);
1418   }
1419 
1420   typedef struct {
1421     Elf32_Half    code;         // Actual value as defined in elf.h
1422     Elf32_Half    compat_class; // Compatibility of archs at VM&#39;s sense
1423     unsigned char elf_class;    // 32 or 64 bit
1424     unsigned char endianess;    // MSB or LSB
1425     char*         name;         // String representation
1426   } arch_t;
1427 
1428 #ifndef EM_AARCH64
1429   #define EM_AARCH64    183               /* ARM AARCH64 */
1430 #endif
1431 
1432   static const arch_t arch_array[]={
1433     {EM_386,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1434     {EM_486,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1435     {EM_IA_64,       EM_IA_64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;IA 64&quot;},
1436     {EM_X86_64,      EM_X86_64,  ELFCLASS64, ELFDATA2LSB, (char*)&quot;AMD 64&quot;},
1437     {EM_SPARC,       EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1438     {EM_SPARC32PLUS, EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1439     {EM_SPARCV9,     EM_SPARCV9, ELFCLASS64, ELFDATA2MSB, (char*)&quot;Sparc v9 64&quot;},
1440     {EM_PPC,         EM_PPC,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;Power PC 32&quot;},
1441     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2MSB, (char*)&quot;Power PC 64&quot;},
1442     {EM_ARM,         EM_ARM,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;ARM&quot;},
1443     // we only support 64 bit z architecture
1444     {EM_S390,        EM_S390,    ELFCLASS64, ELFDATA2MSB, (char*)&quot;IBM System/390&quot;},
1445     {EM_AARCH64,     EM_AARCH64, ELFCLASS64, ELFDATA2LSB, (char*)&quot;AARCH64&quot;}
1446   };
1447 
1448 #if  (defined IA32)
1449   static  Elf32_Half running_arch_code=EM_386;
1450 #elif   (defined AMD64)
1451   static  Elf32_Half running_arch_code=EM_X86_64;
1452 #elif  (defined IA64)
1453   static  Elf32_Half running_arch_code=EM_IA_64;
1454 #elif  (defined __sparc) &amp;&amp; (defined _LP64)
1455   static  Elf32_Half running_arch_code=EM_SPARCV9;
1456 #elif  (defined __sparc) &amp;&amp; (!defined _LP64)
1457   static  Elf32_Half running_arch_code=EM_SPARC;
1458 #elif  (defined __powerpc64__)
1459   static  Elf32_Half running_arch_code=EM_PPC64;
1460 #elif  (defined __powerpc__)
1461   static  Elf32_Half running_arch_code=EM_PPC;
1462 #elif (defined ARM)
1463   static  Elf32_Half running_arch_code=EM_ARM;
1464 #else
1465   #error Method os::dll_load requires that one of following is defined:\
1466        IA32, AMD64, IA64, __sparc, __powerpc__, ARM, ARM
1467 #endif
1468 
1469   // Identify compatibility class for VM&#39;s architecture and library&#39;s architecture
1470   // Obtain string descriptions for architectures
1471 
1472   arch_t lib_arch={elf_head.e_machine,0,elf_head.e_ident[EI_CLASS], elf_head.e_ident[EI_DATA], NULL};
1473   int running_arch_index=-1;
1474 
1475   for (unsigned int i=0; i &lt; ARRAY_SIZE(arch_array); i++) {
1476     if (running_arch_code == arch_array[i].code) {
1477       running_arch_index    = i;
1478     }
1479     if (lib_arch.code == arch_array[i].code) {
1480       lib_arch.compat_class = arch_array[i].compat_class;
1481       lib_arch.name         = arch_array[i].name;
1482     }
1483   }
1484 
1485   assert(running_arch_index != -1,
1486          &quot;Didn&#39;t find running architecture code (running_arch_code) in arch_array&quot;);
1487   if (running_arch_index == -1) {
1488     // Even though running architecture detection failed
1489     // we may still continue with reporting dlerror() message
1490     return NULL;
1491   }
1492 
1493   if (lib_arch.compat_class != arch_array[running_arch_index].compat_class) {
1494     if (lib_arch.name != NULL) {
1495       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1496                  &quot; (Possible cause: can&#39;t load %s .so on a %s platform)&quot;,
1497                  lib_arch.name, arch_array[running_arch_index].name);
1498     } else {
1499       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1500                  &quot; (Possible cause: can&#39;t load this .so (machine code=0x%x) on a %s platform)&quot;,
1501                  lib_arch.code, arch_array[running_arch_index].name);
1502     }
1503     return NULL;
1504   }
1505 
1506   if (lib_arch.endianess != arch_array[running_arch_index].endianess) {
1507     ::snprintf(diag_msg_buf, diag_msg_max_length-1,&quot; (Possible cause: endianness mismatch)&quot;);
1508     return NULL;
1509   }
1510 
1511   // ELF file class/capacity : 0 - invalid, 1 - 32bit, 2 - 64bit
1512   if (lib_arch.elf_class &gt; 2 || lib_arch.elf_class &lt; 1) {
1513     ::snprintf(diag_msg_buf, diag_msg_max_length-1, &quot; (Possible cause: invalid ELF file class)&quot;);
1514     return NULL;
1515   }
1516 
1517   if (lib_arch.elf_class != arch_array[running_arch_index].elf_class) {
1518     ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1519                &quot; (Possible cause: architecture word width mismatch, can&#39;t load %d-bit .so on a %d-bit platform)&quot;,
1520                (int) lib_arch.elf_class * 32, arch_array[running_arch_index].elf_class * 32);
1521     return NULL;
1522   }
1523 
1524   return NULL;
1525 }
1526 
1527 void* os::dll_lookup(void* handle, const char* name) {
1528   return dlsym(handle, name);
1529 }
1530 
1531 void* os::get_default_process_handle() {
1532   return (void*)::dlopen(NULL, RTLD_LAZY);
1533 }
1534 
1535 static inline time_t get_mtime(const char* filename) {
1536   struct stat st;
1537   int ret = os::stat(filename, &amp;st);
1538   assert(ret == 0, &quot;failed to stat() file &#39;%s&#39;: %s&quot;, filename, os::strerror(errno));
1539   return st.st_mtime;
1540 }
1541 
1542 int os::compare_file_modified_times(const char* file1, const char* file2) {
1543   time_t t1 = get_mtime(file1);
1544   time_t t2 = get_mtime(file2);
1545   return t1 - t2;
1546 }
1547 
1548 static bool _print_ascii_file(const char* filename, outputStream* st) {
1549   int fd = ::open(filename, O_RDONLY);
1550   if (fd == -1) {
1551     return false;
1552   }
1553 
1554   char buf[32];
1555   int bytes;
1556   while ((bytes = ::read(fd, buf, sizeof(buf))) &gt; 0) {
1557     st-&gt;print_raw(buf, bytes);
1558   }
1559 
1560   ::close(fd);
1561 
1562   return true;
1563 }
1564 
1565 void os::print_os_info_brief(outputStream* st) {
1566   os::Solaris::print_distro_info(st);
1567 
1568   os::Posix::print_uname_info(st);
1569 
1570   os::Solaris::print_libversion_info(st);
1571 }
1572 
1573 void os::print_os_info(outputStream* st) {
1574   st-&gt;print(&quot;OS:&quot;);
1575 
1576   os::Solaris::print_distro_info(st);
1577 
1578   os::Posix::print_uname_info(st);
1579 
1580   os::Posix::print_uptime_info(st);
1581 
1582   os::Solaris::print_libversion_info(st);
1583 
1584   os::Posix::print_rlimit_info(st);
1585 
1586   os::Posix::print_load_average(st);
1587 }
1588 
1589 void os::Solaris::print_distro_info(outputStream* st) {
1590   if (!_print_ascii_file(&quot;/etc/release&quot;, st)) {
1591     st-&gt;print(&quot;Solaris&quot;);
1592   }
1593   st-&gt;cr();
1594 }
1595 
1596 void os::get_summary_os_info(char* buf, size_t buflen) {
1597   strncpy(buf, &quot;Solaris&quot;, buflen);  // default to plain solaris
1598   FILE* fp = fopen(&quot;/etc/release&quot;, &quot;r&quot;);
1599   if (fp != NULL) {
1600     char tmp[256];
1601     // Only get the first line and chop out everything but the os name.
1602     if (fgets(tmp, sizeof(tmp), fp)) {
1603       char* ptr = tmp;
1604       // skip past whitespace characters
1605       while (*ptr != &#39;\0&#39; &amp;&amp; (*ptr == &#39; &#39; || *ptr == &#39;\t&#39; || *ptr == &#39;\n&#39;)) ptr++;
1606       if (*ptr != &#39;\0&#39;) {
1607         char* nl = strchr(ptr, &#39;\n&#39;);
1608         if (nl != NULL) *nl = &#39;\0&#39;;
1609         strncpy(buf, ptr, buflen);
1610       }
1611     }
1612     fclose(fp);
1613   }
1614 }
1615 
1616 void os::Solaris::print_libversion_info(outputStream* st) {
1617   st-&gt;print(&quot;  (T2 libthread)&quot;);
1618   st-&gt;cr();
1619 }
1620 
1621 static bool check_addr0(outputStream* st) {
1622   jboolean status = false;
1623   const int read_chunk = 200;
1624   int ret = 0;
1625   int nmap = 0;
1626   int fd = ::open(&quot;/proc/self/map&quot;,O_RDONLY);
1627   if (fd &gt;= 0) {
1628     prmap_t *p = NULL;
1629     char *mbuff = (char *) calloc(read_chunk, sizeof(prmap_t));
1630     if (NULL == mbuff) {
1631       ::close(fd);
1632       return status;
1633     }
1634     while ((ret = ::read(fd, mbuff, read_chunk*sizeof(prmap_t))) &gt; 0) {
1635       //check if read() has not read partial data
1636       if( 0 != ret % sizeof(prmap_t)){
1637         break;
1638       }
1639       nmap = ret / sizeof(prmap_t);
1640       p = (prmap_t *)mbuff;
1641       for(int i = 0; i &lt; nmap; i++){
1642         if (p-&gt;pr_vaddr == 0x0) {
1643           st-&gt;print(&quot;Warning: Address: &quot; PTR_FORMAT &quot;, Size: &quot; SIZE_FORMAT &quot;K, &quot;,p-&gt;pr_vaddr, p-&gt;pr_size/1024);
1644           st-&gt;print(&quot;Mapped file: %s, &quot;, p-&gt;pr_mapname[0] == &#39;\0&#39; ? &quot;None&quot; : p-&gt;pr_mapname);
1645           st-&gt;print(&quot;Access: &quot;);
1646           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_READ)  ? &quot;r&quot; : &quot;-&quot;);
1647           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_WRITE) ? &quot;w&quot; : &quot;-&quot;);
1648           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_EXEC)  ? &quot;x&quot; : &quot;-&quot;);
1649           st-&gt;cr();
1650           status = true;
1651         }
1652         p++;
1653       }
1654     }
1655     free(mbuff);
1656     ::close(fd);
1657   }
1658   return status;
1659 }
1660 
1661 void os::get_summary_cpu_info(char* buf, size_t buflen) {
1662   // Get MHz with system call. We don&#39;t seem to already have this.
1663   processor_info_t stats;
1664   processorid_t id = getcpuid();
1665   int clock = 0;
1666   if (processor_info(id, &amp;stats) != -1) {
1667     clock = stats.pi_clock;  // pi_processor_type isn&#39;t more informative than below
1668   }
1669 #ifdef AMD64
1670   snprintf(buf, buflen, &quot;x86 64 bit %d MHz&quot;, clock);
1671 #else
1672   // must be sparc
1673   snprintf(buf, buflen, &quot;Sparcv9 64 bit %d MHz&quot;, clock);
1674 #endif
1675 }
1676 
1677 void os::pd_print_cpu_info(outputStream* st, char* buf, size_t buflen) {
1678   // Nothing to do for now.
1679 }
1680 
1681 void os::print_memory_info(outputStream* st) {
1682   st-&gt;print(&quot;Memory:&quot;);
1683   st-&gt;print(&quot; %dk page&quot;, os::vm_page_size()&gt;&gt;10);
1684   st-&gt;print(&quot;, physical &quot; UINT64_FORMAT &quot;k&quot;, os::physical_memory()&gt;&gt;10);
1685   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;, os::available_memory() &gt;&gt; 10);
1686   st-&gt;cr();
1687   (void) check_addr0(st);
1688 }
1689 
1690 // Moved from whole group, because we need them here for diagnostic
1691 // prints.
1692 static int Maxsignum = 0;
1693 static int *ourSigFlags = NULL;
1694 
1695 int os::Solaris::get_our_sigflags(int sig) {
1696   assert(ourSigFlags!=NULL, &quot;signal data structure not initialized&quot;);
1697   assert(sig &gt; 0 &amp;&amp; sig &lt; Maxsignum, &quot;vm signal out of expected range&quot;);
1698   return ourSigFlags[sig];
1699 }
1700 
1701 void os::Solaris::set_our_sigflags(int sig, int flags) {
1702   assert(ourSigFlags!=NULL, &quot;signal data structure not initialized&quot;);
1703   assert(sig &gt; 0 &amp;&amp; sig &lt; Maxsignum, &quot;vm signal out of expected range&quot;);
1704   ourSigFlags[sig] = flags;
1705 }
1706 
1707 
1708 static const char* get_signal_handler_name(address handler,
1709                                            char* buf, int buflen) {
1710   int offset;
1711   bool found = os::dll_address_to_library_name(handler, buf, buflen, &amp;offset);
1712   if (found) {
1713     // skip directory names
1714     const char *p1, *p2;
1715     p1 = buf;
1716     size_t len = strlen(os::file_separator());
1717     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
1718     jio_snprintf(buf, buflen, &quot;%s+0x%x&quot;, p1, offset);
1719   } else {
1720     jio_snprintf(buf, buflen, PTR_FORMAT, handler);
1721   }
1722   return buf;
1723 }
1724 
1725 static void print_signal_handler(outputStream* st, int sig,
1726                                  char* buf, size_t buflen) {
1727   struct sigaction sa;
1728 
1729   sigaction(sig, NULL, &amp;sa);
1730 
1731   st-&gt;print(&quot;%s: &quot;, os::exception_name(sig, buf, buflen));
1732 
1733   address handler = (sa.sa_flags &amp; SA_SIGINFO)
1734                   ? CAST_FROM_FN_PTR(address, sa.sa_sigaction)
1735                   : CAST_FROM_FN_PTR(address, sa.sa_handler);
1736 
1737   if (handler == CAST_FROM_FN_PTR(address, SIG_DFL)) {
1738     st-&gt;print(&quot;SIG_DFL&quot;);
1739   } else if (handler == CAST_FROM_FN_PTR(address, SIG_IGN)) {
1740     st-&gt;print(&quot;SIG_IGN&quot;);
1741   } else {
1742     st-&gt;print(&quot;[%s]&quot;, get_signal_handler_name(handler, buf, buflen));
1743   }
1744 
1745   st-&gt;print(&quot;, sa_mask[0]=&quot;);
1746   os::Posix::print_signal_set_short(st, &amp;sa.sa_mask);
1747 
1748   address rh = VMError::get_resetted_sighandler(sig);
1749   // May be, handler was resetted by VMError?
1750   if (rh != NULL) {
1751     handler = rh;
1752     sa.sa_flags = VMError::get_resetted_sigflags(sig);
1753   }
1754 
1755   st-&gt;print(&quot;, sa_flags=&quot;);
1756   os::Posix::print_sa_flags(st, sa.sa_flags);
1757 
1758   // Check: is it our handler?
1759   if (handler == CAST_FROM_FN_PTR(address, signalHandler)) {
1760     // It is our signal handler
1761     // check for flags
1762     if (sa.sa_flags != os::Solaris::get_our_sigflags(sig)) {
1763       st-&gt;print(
1764                 &quot;, flags was changed from &quot; PTR32_FORMAT &quot;, consider using jsig library&quot;,
1765                 os::Solaris::get_our_sigflags(sig));
1766     }
1767   }
1768   st-&gt;cr();
1769 }
1770 
1771 void os::print_signal_handlers(outputStream* st, char* buf, size_t buflen) {
1772   st-&gt;print_cr(&quot;Signal Handlers:&quot;);
1773   print_signal_handler(st, SIGSEGV, buf, buflen);
1774   print_signal_handler(st, SIGBUS , buf, buflen);
1775   print_signal_handler(st, SIGFPE , buf, buflen);
1776   print_signal_handler(st, SIGPIPE, buf, buflen);
1777   print_signal_handler(st, SIGXFSZ, buf, buflen);
1778   print_signal_handler(st, SIGILL , buf, buflen);
1779   print_signal_handler(st, ASYNC_SIGNAL, buf, buflen);
1780   print_signal_handler(st, BREAK_SIGNAL, buf, buflen);
1781   print_signal_handler(st, SHUTDOWN1_SIGNAL , buf, buflen);
1782   print_signal_handler(st, SHUTDOWN2_SIGNAL , buf, buflen);
1783   print_signal_handler(st, SHUTDOWN3_SIGNAL, buf, buflen);
1784 }
1785 
1786 static char saved_jvm_path[MAXPATHLEN] = { 0 };
1787 
1788 // Find the full path to the current module, libjvm.so
1789 void os::jvm_path(char *buf, jint buflen) {
1790   // Error checking.
1791   if (buflen &lt; MAXPATHLEN) {
1792     assert(false, &quot;must use a large-enough buffer&quot;);
1793     buf[0] = &#39;\0&#39;;
1794     return;
1795   }
1796   // Lazy resolve the path to current module.
1797   if (saved_jvm_path[0] != 0) {
1798     strcpy(buf, saved_jvm_path);
1799     return;
1800   }
1801 
1802   Dl_info dlinfo;
1803   int ret = dladdr(CAST_FROM_FN_PTR(void *, os::jvm_path), &amp;dlinfo);
1804   assert(ret != 0, &quot;cannot locate libjvm&quot;);
1805   if (ret != 0 &amp;&amp; dlinfo.dli_fname != NULL) {
1806     if (os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen) == NULL) {
1807       return;
1808     }
1809   } else {
1810     buf[0] = &#39;\0&#39;;
1811     return;
1812   }
1813 
1814   if (Arguments::sun_java_launcher_is_altjvm()) {
1815     // Support for the java launcher&#39;s &#39;-XXaltjvm=&lt;path&gt;&#39; option. Typical
1816     // value for buf is &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/&lt;vmtype&gt;/libjvm.so&quot;.
1817     // If &quot;/jre/lib/&quot; appears at the right place in the string, then
1818     // assume we are installed in a JDK and we&#39;re done.  Otherwise, check
1819     // for a JAVA_HOME environment variable and fix up the path so it
1820     // looks like libjvm.so is installed there (append a fake suffix
1821     // hotspot/libjvm.so).
1822     const char *p = buf + strlen(buf) - 1;
1823     for (int count = 0; p &gt; buf &amp;&amp; count &lt; 5; ++count) {
1824       for (--p; p &gt; buf &amp;&amp; *p != &#39;/&#39;; --p)
1825         /* empty */ ;
1826     }
1827 
1828     if (strncmp(p, &quot;/jre/lib/&quot;, 9) != 0) {
1829       // Look for JAVA_HOME in the environment.
1830       char* java_home_var = ::getenv(&quot;JAVA_HOME&quot;);
1831       if (java_home_var != NULL &amp;&amp; java_home_var[0] != 0) {
1832         char* jrelib_p;
1833         int   len;
1834 
1835         // Check the current module name &quot;libjvm.so&quot;.
1836         p = strrchr(buf, &#39;/&#39;);
1837         assert(strstr(p, &quot;/libjvm&quot;) == p, &quot;invalid library name&quot;);
1838 
1839         if (os::Posix::realpath(java_home_var, buf, buflen) == NULL) {
1840           return;
1841         }
1842         // determine if this is a legacy image or modules image
1843         // modules image doesn&#39;t have &quot;jre&quot; subdirectory
1844         len = strlen(buf);
1845         assert(len &lt; buflen, &quot;Ran out of buffer space&quot;);
1846         jrelib_p = buf + len;
1847         snprintf(jrelib_p, buflen-len, &quot;/jre/lib&quot;);
1848         if (0 != access(buf, F_OK)) {
1849           snprintf(jrelib_p, buflen-len, &quot;/lib&quot;);
1850         }
1851 
1852         if (0 == access(buf, F_OK)) {
1853           // Use current module name &quot;libjvm.so&quot;
1854           len = strlen(buf);
1855           snprintf(buf + len, buflen-len, &quot;/hotspot/libjvm.so&quot;);
1856         } else {
1857           // Go back to path of .so
1858           if (os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen) == NULL) {
1859             return;
1860           }
1861         }
1862       }
1863     }
1864   }
1865 
1866   strncpy(saved_jvm_path, buf, MAXPATHLEN);
1867   saved_jvm_path[MAXPATHLEN - 1] = &#39;\0&#39;;
1868 }
1869 
1870 
1871 void os::print_jni_name_prefix_on(outputStream* st, int args_size) {
1872   // no prefix required, not even &quot;_&quot;
1873 }
1874 
1875 
1876 void os::print_jni_name_suffix_on(outputStream* st, int args_size) {
1877   // no suffix required
1878 }
1879 
1880 // sun.misc.Signal
1881 
1882 extern &quot;C&quot; {
1883   static void UserHandler(int sig, void *siginfo, void *context) {
1884     // Ctrl-C is pressed during error reporting, likely because the error
1885     // handler fails to abort. Let VM die immediately.
1886     if (sig == SIGINT &amp;&amp; VMError::is_error_reported()) {
1887       os::die();
1888     }
1889 
1890     os::signal_notify(sig);
1891     // We do not need to reinstate the signal handler each time...
1892   }
1893 }
1894 
1895 void* os::user_handler() {
1896   return CAST_FROM_FN_PTR(void*, UserHandler);
1897 }
1898 
1899 extern &quot;C&quot; {
1900   typedef void (*sa_handler_t)(int);
1901   typedef void (*sa_sigaction_t)(int, siginfo_t *, void *);
1902 }
1903 
1904 void* os::signal(int signal_number, void* handler) {
1905   struct sigaction sigAct, oldSigAct;
1906   sigfillset(&amp;(sigAct.sa_mask));
1907   sigAct.sa_flags = SA_RESTART &amp; ~SA_RESETHAND;
1908   sigAct.sa_flags |= SA_SIGINFO;
1909   sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);
1910 
1911   if (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) {
1912     // -1 means registration failed
1913     return (void *)-1;
1914   }
1915 
1916   return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);
1917 }
1918 
1919 void os::signal_raise(int signal_number) {
1920   raise(signal_number);
1921 }
1922 
1923 // The following code is moved from os.cpp for making this
1924 // code platform specific, which it is by its very nature.
1925 
1926 // a counter for each possible signal value
1927 static int Sigexit = 0;
1928 static jint *pending_signals = NULL;
1929 static int *preinstalled_sigs = NULL;
1930 static struct sigaction *chainedsigactions = NULL;
1931 static Semaphore* sig_sem = NULL;
1932 
1933 int os::sigexitnum_pd() {
1934   assert(Sigexit &gt; 0, &quot;signal memory not yet initialized&quot;);
1935   return Sigexit;
1936 }
1937 
1938 void os::Solaris::init_signal_mem() {
1939   // Initialize signal structures
1940   Maxsignum = SIGRTMAX;
1941   Sigexit = Maxsignum+1;
1942   assert(Maxsignum &gt;0, &quot;Unable to obtain max signal number&quot;);
1943 
1944   // Initialize signal structures
1945   // pending_signals has one int per signal
1946   // The additional signal is for SIGEXIT - exit signal to signal_thread
1947   pending_signals = (jint *)os::malloc(sizeof(jint) * (Sigexit+1), mtInternal);
1948   memset(pending_signals, 0, (sizeof(jint) * (Sigexit+1)));
1949 
1950   if (UseSignalChaining) {
1951     chainedsigactions = (struct sigaction *)malloc(sizeof(struct sigaction)
1952                                                    * (Maxsignum + 1), mtInternal);
1953     memset(chainedsigactions, 0, (sizeof(struct sigaction) * (Maxsignum + 1)));
1954     preinstalled_sigs = (int *)os::malloc(sizeof(int) * (Maxsignum + 1), mtInternal);
1955     memset(preinstalled_sigs, 0, (sizeof(int) * (Maxsignum + 1)));
1956   }
1957   ourSigFlags = (int*)malloc(sizeof(int) * (Maxsignum + 1), mtInternal);
1958   memset(ourSigFlags, 0, sizeof(int) * (Maxsignum + 1));
1959 }
1960 
1961 static void jdk_misc_signal_init() {
1962   // Initialize signal semaphore
1963   sig_sem = new Semaphore();
1964 }
1965 
1966 void os::signal_notify(int sig) {
1967   if (sig_sem != NULL) {
1968     Atomic::inc(&amp;pending_signals[sig]);
1969     sig_sem-&gt;signal();
1970   } else {
1971     // Signal thread is not created with ReduceSignalUsage and jdk_misc_signal_init
1972     // initialization isn&#39;t called.
1973     assert(ReduceSignalUsage, &quot;signal semaphore should be created&quot;);
1974   }
1975 }
1976 
1977 static int check_pending_signals() {
1978   int ret;
1979   while (true) {
1980     for (int i = 0; i &lt; Sigexit + 1; i++) {
1981       jint n = pending_signals[i];
1982       if (n &gt; 0 &amp;&amp; n == Atomic::cmpxchg(&amp;pending_signals[i], n, n - 1)) {
1983         return i;
1984       }
1985     }
1986     JavaThread *thread = JavaThread::current();
1987     ThreadBlockInVM tbivm(thread);
1988 
1989     bool threadIsSuspended;
1990     do {
1991       thread-&gt;set_suspend_equivalent();
1992       sig_sem-&gt;wait();
1993 
1994       // were we externally suspended while we were waiting?
1995       threadIsSuspended = thread-&gt;handle_special_suspend_equivalent_condition();
1996       if (threadIsSuspended) {
1997         // The semaphore has been incremented, but while we were waiting
1998         // another thread suspended us. We don&#39;t want to continue running
1999         // while suspended because that would surprise the thread that
2000         // suspended us.
2001         sig_sem-&gt;signal();
2002 
2003         thread-&gt;java_suspend_self();
2004       }
2005     } while (threadIsSuspended);
2006   }
2007 }
2008 
2009 int os::signal_wait() {
2010   return check_pending_signals();
2011 }
2012 
2013 ////////////////////////////////////////////////////////////////////////////////
2014 // Virtual Memory
2015 
2016 static int page_size = -1;
2017 
2018 int os::vm_page_size() {
2019   assert(page_size != -1, &quot;must call os::init&quot;);
2020   return page_size;
2021 }
2022 
2023 // Solaris allocates memory by pages.
2024 int os::vm_allocation_granularity() {
2025   assert(page_size != -1, &quot;must call os::init&quot;);
2026   return page_size;
2027 }
2028 
2029 static bool recoverable_mmap_error(int err) {
2030   // See if the error is one we can let the caller handle. This
2031   // list of errno values comes from the Solaris mmap(2) man page.
2032   switch (err) {
2033   case EBADF:
2034   case EINVAL:
2035   case ENOTSUP:
2036     // let the caller deal with these errors
2037     return true;
2038 
2039   default:
2040     // Any remaining errors on this OS can cause our reserved mapping
2041     // to be lost. That can cause confusion where different data
2042     // structures think they have the same memory mapped. The worst
2043     // scenario is if both the VM and a library think they have the
2044     // same memory mapped.
2045     return false;
2046   }
2047 }
2048 
2049 static void warn_fail_commit_memory(char* addr, size_t bytes, bool exec,
2050                                     int err) {
2051   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2052           &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, addr, bytes, exec,
2053           os::strerror(err), err);
2054 }
2055 
2056 static void warn_fail_commit_memory(char* addr, size_t bytes,
2057                                     size_t alignment_hint, bool exec,
2058                                     int err) {
2059   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2060           &quot;, &quot; SIZE_FORMAT &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, addr, bytes,
2061           alignment_hint, exec, os::strerror(err), err);
2062 }
2063 
2064 int os::Solaris::commit_memory_impl(char* addr, size_t bytes, bool exec) {
2065   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
2066   size_t size = bytes;
2067   char *res = Solaris::mmap_chunk(addr, size, MAP_PRIVATE|MAP_FIXED, prot);
2068   if (res != NULL) {
2069     if (UseNUMAInterleaving) {
2070         numa_make_global(addr, bytes);
2071     }
2072     return 0;
2073   }
2074 
2075   int err = errno;  // save errno from mmap() call in mmap_chunk()
2076 
2077   if (!recoverable_mmap_error(err)) {
2078     warn_fail_commit_memory(addr, bytes, exec, err);
2079     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;committing reserved memory.&quot;);
2080   }
2081 
2082   return err;
2083 }
2084 
2085 bool os::pd_commit_memory(char* addr, size_t bytes, bool exec) {
2086   return Solaris::commit_memory_impl(addr, bytes, exec) == 0;
2087 }
2088 
2089 void os::pd_commit_memory_or_exit(char* addr, size_t bytes, bool exec,
2090                                   const char* mesg) {
2091   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2092   int err = os::Solaris::commit_memory_impl(addr, bytes, exec);
2093   if (err != 0) {
2094     // the caller wants all commit errors to exit with the specified mesg:
2095     warn_fail_commit_memory(addr, bytes, exec, err);
2096     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2097   }
2098 }
2099 
2100 size_t os::Solaris::page_size_for_alignment(size_t alignment) {
2101   assert(is_aligned(alignment, (size_t) vm_page_size()),
2102          SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT,
2103          alignment, (size_t) vm_page_size());
2104 
2105   for (int i = 0; _page_sizes[i] != 0; i++) {
2106     if (is_aligned(alignment, _page_sizes[i])) {
2107       return _page_sizes[i];
2108     }
2109   }
2110 
2111   return (size_t) vm_page_size();
2112 }
2113 
2114 int os::Solaris::commit_memory_impl(char* addr, size_t bytes,
2115                                     size_t alignment_hint, bool exec) {
2116   int err = Solaris::commit_memory_impl(addr, bytes, exec);
2117   if (err == 0 &amp;&amp; UseLargePages &amp;&amp; alignment_hint &gt; 0) {
2118     assert(is_aligned(bytes, alignment_hint),
2119            SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, bytes, alignment_hint);
2120 
2121     // The syscall memcntl requires an exact page size (see man memcntl for details).
2122     size_t page_size = page_size_for_alignment(alignment_hint);
2123     if (page_size &gt; (size_t) vm_page_size()) {
2124       (void)Solaris::setup_large_pages(addr, bytes, page_size);
2125     }
2126   }
2127   return err;
2128 }
2129 
2130 bool os::pd_commit_memory(char* addr, size_t bytes, size_t alignment_hint,
2131                           bool exec) {
2132   return Solaris::commit_memory_impl(addr, bytes, alignment_hint, exec) == 0;
2133 }
2134 
2135 void os::pd_commit_memory_or_exit(char* addr, size_t bytes,
2136                                   size_t alignment_hint, bool exec,
2137                                   const char* mesg) {
2138   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2139   int err = os::Solaris::commit_memory_impl(addr, bytes, alignment_hint, exec);
2140   if (err != 0) {
2141     // the caller wants all commit errors to exit with the specified mesg:
2142     warn_fail_commit_memory(addr, bytes, alignment_hint, exec, err);
2143     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2144   }
2145 }
2146 
2147 // Uncommit the pages in a specified region.
2148 void os::pd_free_memory(char* addr, size_t bytes, size_t alignment_hint) {
2149   if (madvise(addr, bytes, MADV_FREE) &lt; 0) {
2150     debug_only(warning(&quot;MADV_FREE failed.&quot;));
2151     return;
2152   }
2153 }
2154 
2155 bool os::pd_create_stack_guard_pages(char* addr, size_t size) {
2156   return os::commit_memory(addr, size, !ExecMem);
2157 }
2158 
2159 bool os::remove_stack_guard_pages(char* addr, size_t size) {
2160   return os::uncommit_memory(addr, size);
2161 }
2162 
2163 // Change the page size in a given range.
2164 void os::pd_realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
2165   assert((intptr_t)addr % alignment_hint == 0, &quot;Address should be aligned.&quot;);
2166   assert((intptr_t)(addr + bytes) % alignment_hint == 0, &quot;End should be aligned.&quot;);
2167   if (UseLargePages) {
2168     size_t page_size = Solaris::page_size_for_alignment(alignment_hint);
2169     if (page_size &gt; (size_t) vm_page_size()) {
2170       Solaris::setup_large_pages(addr, bytes, page_size);
2171     }
2172   }
2173 }
2174 
2175 // Tell the OS to make the range local to the first-touching LWP
2176 void os::numa_make_local(char *addr, size_t bytes, int lgrp_hint) {
2177   assert((intptr_t)addr % os::vm_page_size() == 0, &quot;Address should be page-aligned.&quot;);
2178   if (madvise(addr, bytes, MADV_ACCESS_LWP) &lt; 0) {
2179     debug_only(warning(&quot;MADV_ACCESS_LWP failed.&quot;));
2180   }
2181 }
2182 
2183 // Tell the OS that this range would be accessed from different LWPs.
2184 void os::numa_make_global(char *addr, size_t bytes) {
2185   assert((intptr_t)addr % os::vm_page_size() == 0, &quot;Address should be page-aligned.&quot;);
2186   if (madvise(addr, bytes, MADV_ACCESS_MANY) &lt; 0) {
2187     debug_only(warning(&quot;MADV_ACCESS_MANY failed.&quot;));
2188   }
2189 }
2190 
2191 // Get the number of the locality groups.
2192 size_t os::numa_get_groups_num() {
2193   size_t n = Solaris::lgrp_nlgrps(Solaris::lgrp_cookie());
2194   return n != -1 ? n : 1;
2195 }
2196 
2197 // Get a list of leaf locality groups. A leaf lgroup is group that
2198 // doesn&#39;t have any children. Typical leaf group is a CPU or a CPU/memory
2199 // board. An LWP is assigned to one of these groups upon creation.
2200 size_t os::numa_get_leaf_groups(int *ids, size_t size) {
2201   if ((ids[0] = Solaris::lgrp_root(Solaris::lgrp_cookie())) == -1) {
2202     ids[0] = 0;
2203     return 1;
2204   }
2205   int result_size = 0, top = 1, bottom = 0, cur = 0;
2206   for (int k = 0; k &lt; size; k++) {
2207     int r = Solaris::lgrp_children(Solaris::lgrp_cookie(), ids[cur],
2208                                    (Solaris::lgrp_id_t*)&amp;ids[top], size - top);
2209     if (r == -1) {
2210       ids[0] = 0;
2211       return 1;
2212     }
2213     if (!r) {
2214       // That&#39;s a leaf node.
2215       assert(bottom &lt;= cur, &quot;Sanity check&quot;);
2216       // Check if the node has memory
2217       if (Solaris::lgrp_resources(Solaris::lgrp_cookie(), ids[cur],
2218                                   NULL, 0, LGRP_RSRC_MEM) &gt; 0) {
2219         ids[bottom++] = ids[cur];
2220       }
2221     }
2222     top += r;
2223     cur++;
2224   }
2225   if (bottom == 0) {
2226     // Handle a situation, when the OS reports no memory available.
2227     // Assume UMA architecture.
2228     ids[0] = 0;
2229     return 1;
2230   }
2231   return bottom;
2232 }
2233 
2234 // Detect the topology change. Typically happens during CPU plugging-unplugging.
2235 bool os::numa_topology_changed() {
2236   int is_stale = Solaris::lgrp_cookie_stale(Solaris::lgrp_cookie());
2237   if (is_stale != -1 &amp;&amp; is_stale) {
2238     Solaris::lgrp_fini(Solaris::lgrp_cookie());
2239     Solaris::lgrp_cookie_t c = Solaris::lgrp_init(Solaris::LGRP_VIEW_CALLER);
2240     assert(c != 0, &quot;Failure to initialize LGRP API&quot;);
2241     Solaris::set_lgrp_cookie(c);
2242     return true;
2243   }
2244   return false;
2245 }
2246 
2247 // Get the group id of the current LWP.
2248 int os::numa_get_group_id() {
2249   int lgrp_id = Solaris::lgrp_home(P_LWPID, P_MYID);
2250   if (lgrp_id == -1) {
2251     return 0;
2252   }
2253   const int size = os::numa_get_groups_num();
2254   int *ids = (int*)alloca(size * sizeof(int));
2255 
2256   // Get the ids of all lgroups with memory; r is the count.
2257   int r = Solaris::lgrp_resources(Solaris::lgrp_cookie(), lgrp_id,
2258                                   (Solaris::lgrp_id_t*)ids, size, LGRP_RSRC_MEM);
2259   if (r &lt;= 0) {
2260     return 0;
2261   }
2262   return ids[os::random() % r];
2263 }
2264 
2265 int os::numa_get_group_id_for_address(const void* address) {
2266   return 0;
2267 }
2268 
2269 // Request information about the page.
2270 bool os::get_page_info(char *start, page_info* info) {
2271   const uint_t info_types[] = { MEMINFO_VLGRP, MEMINFO_VPAGESIZE };
2272   uint64_t addr = (uintptr_t)start;
2273   uint64_t outdata[2];
2274   uint_t validity = 0;
2275 
2276   if (meminfo(&amp;addr, 1, info_types, 2, outdata, &amp;validity) &lt; 0) {
2277     return false;
2278   }
2279 
2280   info-&gt;size = 0;
2281   info-&gt;lgrp_id = -1;
2282 
2283   if ((validity &amp; 1) != 0) {
2284     if ((validity &amp; 2) != 0) {
2285       info-&gt;lgrp_id = outdata[0];
2286     }
2287     if ((validity &amp; 4) != 0) {
2288       info-&gt;size = outdata[1];
2289     }
2290     return true;
2291   }
2292   return false;
2293 }
2294 
2295 // Scan the pages from start to end until a page different than
2296 // the one described in the info parameter is encountered.
2297 char *os::scan_pages(char *start, char* end, page_info* page_expected,
2298                      page_info* page_found) {
2299   const uint_t info_types[] = { MEMINFO_VLGRP, MEMINFO_VPAGESIZE };
2300   const size_t types = sizeof(info_types) / sizeof(info_types[0]);
2301   uint64_t addrs[MAX_MEMINFO_CNT], outdata[types * MAX_MEMINFO_CNT + 1];
2302   uint_t validity[MAX_MEMINFO_CNT];
2303 
2304   size_t page_size = MAX2((size_t)os::vm_page_size(), page_expected-&gt;size);
2305   uint64_t p = (uint64_t)start;
2306   while (p &lt; (uint64_t)end) {
2307     addrs[0] = p;
2308     size_t addrs_count = 1;
2309     while (addrs_count &lt; MAX_MEMINFO_CNT &amp;&amp; addrs[addrs_count - 1] + page_size &lt; (uint64_t)end) {
2310       addrs[addrs_count] = addrs[addrs_count - 1] + page_size;
2311       addrs_count++;
2312     }
2313 
2314     if (meminfo(addrs, addrs_count, info_types, types, outdata, validity) &lt; 0) {
2315       return NULL;
2316     }
2317 
2318     size_t i = 0;
2319     for (; i &lt; addrs_count; i++) {
2320       if ((validity[i] &amp; 1) != 0) {
2321         if ((validity[i] &amp; 4) != 0) {
2322           if (outdata[types * i + 1] != page_expected-&gt;size) {
2323             break;
2324           }
2325         } else if (page_expected-&gt;size != 0) {
2326           break;
2327         }
2328 
2329         if ((validity[i] &amp; 2) != 0 &amp;&amp; page_expected-&gt;lgrp_id &gt; 0) {
2330           if (outdata[types * i] != page_expected-&gt;lgrp_id) {
2331             break;
2332           }
2333         }
2334       } else {
2335         return NULL;
2336       }
2337     }
2338 
2339     if (i &lt; addrs_count) {
2340       if ((validity[i] &amp; 2) != 0) {
2341         page_found-&gt;lgrp_id = outdata[types * i];
2342       } else {
2343         page_found-&gt;lgrp_id = -1;
2344       }
2345       if ((validity[i] &amp; 4) != 0) {
2346         page_found-&gt;size = outdata[types * i + 1];
2347       } else {
2348         page_found-&gt;size = 0;
2349       }
2350       return (char*)addrs[i];
2351     }
2352 
2353     p = addrs[addrs_count - 1] + page_size;
2354   }
2355   return end;
2356 }
2357 
2358 bool os::pd_uncommit_memory(char* addr, size_t bytes) {
2359   size_t size = bytes;
2360   // Map uncommitted pages PROT_NONE so we fail early if we touch an
2361   // uncommitted page. Otherwise, the read/write might succeed if we
2362   // have enough swap space to back the physical page.
2363   return
2364     NULL != Solaris::mmap_chunk(addr, size,
2365                                 MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE,
2366                                 PROT_NONE);
2367 }
2368 
2369 char* os::Solaris::mmap_chunk(char *addr, size_t size, int flags, int prot) {
2370   char *b = (char *)mmap(addr, size, prot, flags, os::Solaris::_dev_zero_fd, 0);
2371 
2372   if (b == MAP_FAILED) {
2373     return NULL;
2374   }
2375   return b;
2376 }
2377 
2378 char* os::Solaris::anon_mmap(char* requested_addr, size_t bytes,
2379                              size_t alignment_hint, bool fixed) {
2380   char* addr = requested_addr;
2381   int flags = MAP_PRIVATE | MAP_NORESERVE;
2382 
2383   assert(!(fixed &amp;&amp; (alignment_hint &gt; 0)),
2384          &quot;alignment hint meaningless with fixed mmap&quot;);
2385 
2386   if (fixed) {
2387     flags |= MAP_FIXED;
2388   } else if (alignment_hint &gt; (size_t) vm_page_size()) {
2389     flags |= MAP_ALIGN;
2390     addr = (char*) alignment_hint;
2391   }
2392 
2393   // Map uncommitted pages PROT_NONE so we fail early if we touch an
2394   // uncommitted page. Otherwise, the read/write might succeed if we
2395   // have enough swap space to back the physical page.
2396   return mmap_chunk(addr, bytes, flags, PROT_NONE);
2397 }
2398 
2399 char* os::pd_reserve_memory(size_t bytes, char* requested_addr,
2400                             size_t alignment_hint) {
2401   char* addr = Solaris::anon_mmap(requested_addr, bytes, alignment_hint,
2402                                   (requested_addr != NULL));
2403 
2404   guarantee(requested_addr == NULL || requested_addr == addr,
2405             &quot;OS failed to return requested mmap address.&quot;);
2406   return addr;
2407 }
2408 
2409 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {
2410   assert(file_desc &gt;= 0, &quot;file_desc is not valid&quot;);
2411   char* result = pd_attempt_reserve_memory_at(bytes, requested_addr);
2412   if (result != NULL) {
2413     if (replace_existing_mapping_with_file_mapping(result, bytes, file_desc) == NULL) {
2414       vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory&quot;));
2415     }
2416   }
2417   return result;
2418 }
2419 
2420 // Reserve memory at an arbitrary address, only if that area is
2421 // available (and not reserved for something else).
2422 
2423 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {
2424   // Assert only that the size is a multiple of the page size, since
2425   // that&#39;s all that mmap requires, and since that&#39;s all we really know
2426   // about at this low abstraction level.  If we need higher alignment,
2427   // we can either pass an alignment to this method or verify alignment
2428   // in one of the methods further up the call chain.  See bug 5044738.
2429   assert(bytes % os::vm_page_size() == 0, &quot;reserving unexpected size block&quot;);
2430 
2431   // Since snv_84, Solaris attempts to honor the address hint - see 5003415.
2432   char* addr = Solaris::anon_mmap(requested_addr, bytes, 0, false);
2433 
2434   volatile int err = errno;
2435   if (addr == requested_addr) {
2436     return addr;
2437   }
2438 
2439   if (addr != NULL) {
2440     pd_unmap_memory(addr, bytes);
2441   }
2442 
2443   return NULL;
2444 }
2445 
2446 bool os::pd_release_memory(char* addr, size_t bytes) {
2447   size_t size = bytes;
2448   return munmap(addr, size) == 0;
2449 }
2450 
2451 static bool solaris_mprotect(char* addr, size_t bytes, int prot) {
2452   assert(addr == (char*)align_down((uintptr_t)addr, os::vm_page_size()),
2453          &quot;addr must be page aligned&quot;);
2454   Events::log(NULL, &quot;Protecting memory [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] with protection modes %x&quot;, p2i(addr), p2i(addr+bytes), prot);
2455   int retVal = mprotect(addr, bytes, prot);
2456   return retVal == 0;
2457 }
2458 
2459 // Protect memory (Used to pass readonly pages through
2460 // JNI GetArray&lt;type&gt;Elements with empty arrays.)
2461 // Also, used for serialization page and for compressed oops null pointer
2462 // checking.
2463 bool os::protect_memory(char* addr, size_t bytes, ProtType prot,
2464                         bool is_committed) {
2465   unsigned int p = 0;
2466   switch (prot) {
2467   case MEM_PROT_NONE: p = PROT_NONE; break;
2468   case MEM_PROT_READ: p = PROT_READ; break;
2469   case MEM_PROT_RW:   p = PROT_READ|PROT_WRITE; break;
2470   case MEM_PROT_RWX:  p = PROT_READ|PROT_WRITE|PROT_EXEC; break;
2471   default:
2472     ShouldNotReachHere();
2473   }
2474   // is_committed is unused.
2475   return solaris_mprotect(addr, bytes, p);
2476 }
2477 
2478 // guard_memory and unguard_memory only happens within stack guard pages.
2479 // Since ISM pertains only to the heap, guard and unguard memory should not
2480 /// happen with an ISM region.
2481 bool os::guard_memory(char* addr, size_t bytes) {
2482   return solaris_mprotect(addr, bytes, PROT_NONE);
2483 }
2484 
2485 bool os::unguard_memory(char* addr, size_t bytes) {
2486   return solaris_mprotect(addr, bytes, PROT_READ|PROT_WRITE);
2487 }
2488 
2489 // Large page support
2490 static size_t _large_page_size = 0;
2491 
2492 // Insertion sort for small arrays (descending order).
2493 static void insertion_sort_descending(size_t* array, int len) {
2494   for (int i = 0; i &lt; len; i++) {
2495     size_t val = array[i];
2496     for (size_t key = i; key &gt; 0 &amp;&amp; array[key - 1] &lt; val; --key) {
2497       size_t tmp = array[key];
2498       array[key] = array[key - 1];
2499       array[key - 1] = tmp;
2500     }
2501   }
2502 }
2503 
2504 bool os::Solaris::mpss_sanity_check(bool warn, size_t* page_size) {
2505   const unsigned int usable_count = VM_Version::page_size_count();
2506   if (usable_count == 1) {
2507     return false;
2508   }
2509 
2510   // Find the right getpagesizes interface.  When solaris 11 is the minimum
2511   // build platform, getpagesizes() (without the &#39;2&#39;) can be called directly.
2512   typedef int (*gps_t)(size_t[], int);
2513   gps_t gps_func = CAST_TO_FN_PTR(gps_t, dlsym(RTLD_DEFAULT, &quot;getpagesizes2&quot;));
2514   if (gps_func == NULL) {
2515     gps_func = CAST_TO_FN_PTR(gps_t, dlsym(RTLD_DEFAULT, &quot;getpagesizes&quot;));
2516     if (gps_func == NULL) {
2517       if (warn) {
2518         warning(&quot;MPSS is not supported by the operating system.&quot;);
2519       }
2520       return false;
2521     }
2522   }
2523 
2524   // Fill the array of page sizes.
2525   int n = (*gps_func)(_page_sizes, page_sizes_max);
2526   assert(n &gt; 0, &quot;Solaris bug?&quot;);
2527 
2528   if (n == page_sizes_max) {
2529     // Add a sentinel value (necessary only if the array was completely filled
2530     // since it is static (zeroed at initialization)).
2531     _page_sizes[--n] = 0;
2532     DEBUG_ONLY(warning(&quot;increase the size of the os::_page_sizes array.&quot;);)
2533   }
2534   assert(_page_sizes[n] == 0, &quot;missing sentinel&quot;);
2535   trace_page_sizes(&quot;available page sizes&quot;, _page_sizes, n);
2536 
2537   if (n == 1) return false;     // Only one page size available.
2538 
2539   // Skip sizes larger than 4M (or LargePageSizeInBytes if it was set) and
2540   // select up to usable_count elements.  First sort the array, find the first
2541   // acceptable value, then copy the usable sizes to the top of the array and
2542   // trim the rest.  Make sure to include the default page size :-).
2543   //
2544   // A better policy could get rid of the 4M limit by taking the sizes of the
2545   // important VM memory regions (java heap and possibly the code cache) into
2546   // account.
2547   insertion_sort_descending(_page_sizes, n);
2548   const size_t size_limit =
2549     FLAG_IS_DEFAULT(LargePageSizeInBytes) ? 4 * M : LargePageSizeInBytes;
2550   int beg;
2551   for (beg = 0; beg &lt; n &amp;&amp; _page_sizes[beg] &gt; size_limit; ++beg) /* empty */;
2552   const int end = MIN2((int)usable_count, n) - 1;
2553   for (int cur = 0; cur &lt; end; ++cur, ++beg) {
2554     _page_sizes[cur] = _page_sizes[beg];
2555   }
2556   _page_sizes[end] = vm_page_size();
2557   _page_sizes[end + 1] = 0;
2558 
2559   if (_page_sizes[end] &gt; _page_sizes[end - 1]) {
2560     // Default page size is not the smallest; sort again.
2561     insertion_sort_descending(_page_sizes, end + 1);
2562   }
2563   *page_size = _page_sizes[0];
2564 
2565   trace_page_sizes(&quot;usable page sizes&quot;, _page_sizes, end + 1);
2566   return true;
2567 }
2568 
2569 void os::large_page_init() {
2570   if (UseLargePages) {
2571     // print a warning if any large page related flag is specified on command line
2572     bool warn_on_failure = !FLAG_IS_DEFAULT(UseLargePages)        ||
2573                            !FLAG_IS_DEFAULT(LargePageSizeInBytes);
2574 
2575     UseLargePages = Solaris::mpss_sanity_check(warn_on_failure, &amp;_large_page_size);
2576   }
2577 }
2578 
2579 bool os::Solaris::is_valid_page_size(size_t bytes) {
2580   for (int i = 0; _page_sizes[i] != 0; i++) {
2581     if (_page_sizes[i] == bytes) {
2582       return true;
2583     }
2584   }
2585   return false;
2586 }
2587 
2588 bool os::Solaris::setup_large_pages(caddr_t start, size_t bytes, size_t align) {
2589   assert(is_valid_page_size(align), SIZE_FORMAT &quot; is not a valid page size&quot;, align);
2590   assert(is_aligned((void*) start, align),
2591          PTR_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, p2i((void*) start), align);
2592   assert(is_aligned(bytes, align),
2593          SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, bytes, align);
2594 
2595   // Signal to OS that we want large pages for addresses
2596   // from addr, addr + bytes
2597   struct memcntl_mha mpss_struct;
2598   mpss_struct.mha_cmd = MHA_MAPSIZE_VA;
2599   mpss_struct.mha_pagesize = align;
2600   mpss_struct.mha_flags = 0;
2601   // Upon successful completion, memcntl() returns 0
2602   if (memcntl(start, bytes, MC_HAT_ADVISE, (caddr_t) &amp;mpss_struct, 0, 0)) {
2603     debug_only(warning(&quot;Attempt to use MPSS failed.&quot;));
2604     return false;
2605   }
2606   return true;
2607 }
2608 
<a name="1" id="anc1"></a><span class="line-modified">2609 char* os::reserve_memory_special(size_t size, size_t alignment, char* addr, bool exec) {</span>
2610   fatal(&quot;os::reserve_memory_special should not be called on Solaris.&quot;);
2611   return NULL;
2612 }
2613 
<a name="2" id="anc2"></a><span class="line-modified">2614 bool os::release_memory_special(char* base, size_t bytes) {</span>
2615   fatal(&quot;os::release_memory_special should not be called on Solaris.&quot;);
2616   return false;
2617 }
2618 
2619 size_t os::large_page_size() {
2620   return _large_page_size;
2621 }
2622 
2623 // MPSS allows application to commit large page memory on demand; with ISM
2624 // the entire memory region must be allocated as shared memory.
2625 bool os::can_commit_large_page_memory() {
2626   return true;
2627 }
2628 
2629 bool os::can_execute_large_page_memory() {
2630   return true;
2631 }
2632 
2633 // Sleep forever; naked call to OS-specific sleep; use with CAUTION
2634 void os::infinite_sleep() {
2635   while (true) {    // sleep forever ...
2636     ::sleep(100);   // ... 100 seconds at a time
2637   }
2638 }
2639 
2640 // Used to convert frequent JVM_Yield() to nops
2641 bool os::dont_yield() {
2642   if (DontYieldALot) {
2643     static hrtime_t last_time = 0;
2644     hrtime_t diff = getTimeNanos() - last_time;
2645 
2646     if (diff &lt; DontYieldALotInterval * 1000000) {
2647       return true;
2648     }
2649 
2650     last_time += diff;
2651 
2652     return false;
2653   } else {
2654     return false;
2655   }
2656 }
2657 
2658 // Note that yield semantics are defined by the scheduling class to which
2659 // the thread currently belongs.  Typically, yield will _not yield to
2660 // other equal or higher priority threads that reside on the dispatch queues
2661 // of other CPUs.
2662 
2663 void os::naked_yield() {
2664   thr_yield();
2665 }
2666 
2667 // Interface for setting lwp priorities.  We are using T2 libthread,
2668 // which forces the use of bound threads, so all of our threads will
2669 // be assigned to real lwp&#39;s.  Using the thr_setprio function is
2670 // meaningless in this mode so we must adjust the real lwp&#39;s priority.
2671 // The routines below implement the getting and setting of lwp priorities.
2672 //
2673 // Note: There are three priority scales used on Solaris.  Java priotities
2674 //       which range from 1 to 10, libthread &quot;thr_setprio&quot; scale which range
2675 //       from 0 to 127, and the current scheduling class of the process we
2676 //       are running in.  This is typically from -60 to +60.
2677 //       The setting of the lwp priorities in done after a call to thr_setprio
2678 //       so Java priorities are mapped to libthread priorities and we map from
2679 //       the latter to lwp priorities.  We don&#39;t keep priorities stored in
2680 //       Java priorities since some of our worker threads want to set priorities
2681 //       higher than all Java threads.
2682 //
2683 // For related information:
2684 // (1)  man -s 2 priocntl
2685 // (2)  man -s 4 priocntl
2686 // (3)  man dispadmin
2687 // =    librt.so
2688 // =    libthread/common/rtsched.c - thrp_setlwpprio().
2689 // =    ps -cL &lt;pid&gt; ... to validate priority.
2690 // =    sched_get_priority_min and _max
2691 //              pthread_create
2692 //              sched_setparam
2693 //              pthread_setschedparam
2694 //
2695 // Assumptions:
2696 // +    We assume that all threads in the process belong to the same
2697 //              scheduling class.   IE. an homogenous process.
2698 // +    Must be root or in IA group to change change &quot;interactive&quot; attribute.
2699 //              Priocntl() will fail silently.  The only indication of failure is when
2700 //              we read-back the value and notice that it hasn&#39;t changed.
2701 // +    Interactive threads enter the runq at the head, non-interactive at the tail.
2702 // +    For RT, change timeslice as well.  Invariant:
2703 //              constant &quot;priority integral&quot;
2704 //              Konst == TimeSlice * (60-Priority)
2705 //              Given a priority, compute appropriate timeslice.
2706 // +    Higher numerical values have higher priority.
2707 
2708 // sched class attributes
2709 typedef struct {
2710   int   schedPolicy;              // classID
2711   int   maxPrio;
2712   int   minPrio;
2713 } SchedInfo;
2714 
2715 
2716 static SchedInfo tsLimits, iaLimits, rtLimits, fxLimits;
2717 
2718 #ifdef ASSERT
2719 static int  ReadBackValidate = 1;
2720 #endif
2721 static int  myClass     = 0;
2722 static int  myMin       = 0;
2723 static int  myMax       = 0;
2724 static int  myCur       = 0;
2725 static bool priocntl_enable = false;
2726 
2727 static const int criticalPrio = FXCriticalPriority;
2728 static int java_MaxPriority_to_os_priority = 0; // Saved mapping
2729 
2730 
2731 // lwp_priocntl_init
2732 //
2733 // Try to determine the priority scale for our process.
2734 //
2735 // Return errno or 0 if OK.
2736 //
2737 static int lwp_priocntl_init() {
2738   int rslt;
2739   pcinfo_t ClassInfo;
2740   pcparms_t ParmInfo;
2741   int i;
2742 
2743   if (!UseThreadPriorities) return 0;
2744 
2745   // If ThreadPriorityPolicy is 1, switch tables
2746   if (ThreadPriorityPolicy == 1) {
2747     for (i = 0; i &lt; CriticalPriority+1; i++)
2748       os::java_to_os_priority[i] = prio_policy1[i];
2749   }
2750   if (UseCriticalJavaThreadPriority) {
2751     // MaxPriority always maps to the FX scheduling class and criticalPrio.
2752     // See set_native_priority() and set_lwp_class_and_priority().
2753     // Save original MaxPriority mapping in case attempt to
2754     // use critical priority fails.
2755     java_MaxPriority_to_os_priority = os::java_to_os_priority[MaxPriority];
2756     // Set negative to distinguish from other priorities
2757     os::java_to_os_priority[MaxPriority] = -criticalPrio;
2758   }
2759 
2760   // Get IDs for a set of well-known scheduling classes.
2761   // TODO-FIXME: GETCLINFO returns the current # of classes in the
2762   // the system.  We should have a loop that iterates over the
2763   // classID values, which are known to be &quot;small&quot; integers.
2764 
2765   strcpy(ClassInfo.pc_clname, &quot;TS&quot;);
2766   ClassInfo.pc_cid = -1;
2767   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2768   if (rslt &lt; 0) return errno;
2769   assert(ClassInfo.pc_cid != -1, &quot;cid for TS class is -1&quot;);
2770   tsLimits.schedPolicy = ClassInfo.pc_cid;
2771   tsLimits.maxPrio = ((tsinfo_t*)ClassInfo.pc_clinfo)-&gt;ts_maxupri;
2772   tsLimits.minPrio = -tsLimits.maxPrio;
2773 
2774   strcpy(ClassInfo.pc_clname, &quot;IA&quot;);
2775   ClassInfo.pc_cid = -1;
2776   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2777   if (rslt &lt; 0) return errno;
2778   assert(ClassInfo.pc_cid != -1, &quot;cid for IA class is -1&quot;);
2779   iaLimits.schedPolicy = ClassInfo.pc_cid;
2780   iaLimits.maxPrio = ((iainfo_t*)ClassInfo.pc_clinfo)-&gt;ia_maxupri;
2781   iaLimits.minPrio = -iaLimits.maxPrio;
2782 
2783   strcpy(ClassInfo.pc_clname, &quot;RT&quot;);
2784   ClassInfo.pc_cid = -1;
2785   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2786   if (rslt &lt; 0) return errno;
2787   assert(ClassInfo.pc_cid != -1, &quot;cid for RT class is -1&quot;);
2788   rtLimits.schedPolicy = ClassInfo.pc_cid;
2789   rtLimits.maxPrio = ((rtinfo_t*)ClassInfo.pc_clinfo)-&gt;rt_maxpri;
2790   rtLimits.minPrio = 0;
2791 
2792   strcpy(ClassInfo.pc_clname, &quot;FX&quot;);
2793   ClassInfo.pc_cid = -1;
2794   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2795   if (rslt &lt; 0) return errno;
2796   assert(ClassInfo.pc_cid != -1, &quot;cid for FX class is -1&quot;);
2797   fxLimits.schedPolicy = ClassInfo.pc_cid;
2798   fxLimits.maxPrio = ((fxinfo_t*)ClassInfo.pc_clinfo)-&gt;fx_maxupri;
2799   fxLimits.minPrio = 0;
2800 
2801   // Query our &quot;current&quot; scheduling class.
2802   // This will normally be IA, TS or, rarely, FX or RT.
2803   memset(&amp;ParmInfo, 0, sizeof(ParmInfo));
2804   ParmInfo.pc_cid = PC_CLNULL;
2805   rslt = priocntl(P_PID, P_MYID, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
2806   if (rslt &lt; 0) return errno;
2807   myClass = ParmInfo.pc_cid;
2808 
2809   // We now know our scheduling classId, get specific information
2810   // about the class.
2811   ClassInfo.pc_cid = myClass;
2812   ClassInfo.pc_clname[0] = 0;
2813   rslt = priocntl((idtype)0, 0, PC_GETCLINFO, (caddr_t)&amp;ClassInfo);
2814   if (rslt &lt; 0) return errno;
2815 
2816   if (ThreadPriorityVerbose) {
2817     tty-&gt;print_cr(&quot;lwp_priocntl_init: Class=%d(%s)...&quot;, myClass, ClassInfo.pc_clname);
2818   }
2819 
2820   memset(&amp;ParmInfo, 0, sizeof(pcparms_t));
2821   ParmInfo.pc_cid = PC_CLNULL;
2822   rslt = priocntl(P_PID, P_MYID, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
2823   if (rslt &lt; 0) return errno;
2824 
2825   if (ParmInfo.pc_cid == rtLimits.schedPolicy) {
2826     myMin = rtLimits.minPrio;
2827     myMax = rtLimits.maxPrio;
2828   } else if (ParmInfo.pc_cid == iaLimits.schedPolicy) {
2829     iaparms_t *iaInfo  = (iaparms_t*)ParmInfo.pc_clparms;
2830     myMin = iaLimits.minPrio;
2831     myMax = iaLimits.maxPrio;
2832     myMax = MIN2(myMax, (int)iaInfo-&gt;ia_uprilim);       // clamp - restrict
2833   } else if (ParmInfo.pc_cid == tsLimits.schedPolicy) {
2834     tsparms_t *tsInfo  = (tsparms_t*)ParmInfo.pc_clparms;
2835     myMin = tsLimits.minPrio;
2836     myMax = tsLimits.maxPrio;
2837     myMax = MIN2(myMax, (int)tsInfo-&gt;ts_uprilim);       // clamp - restrict
2838   } else if (ParmInfo.pc_cid == fxLimits.schedPolicy) {
2839     fxparms_t *fxInfo = (fxparms_t*)ParmInfo.pc_clparms;
2840     myMin = fxLimits.minPrio;
2841     myMax = fxLimits.maxPrio;
2842     myMax = MIN2(myMax, (int)fxInfo-&gt;fx_uprilim);       // clamp - restrict
2843   } else {
2844     // No clue - punt
2845     if (ThreadPriorityVerbose) {
2846       tty-&gt;print_cr(&quot;Unknown scheduling class: %s ... \n&quot;,
2847                     ClassInfo.pc_clname);
2848     }
2849     return EINVAL;      // no clue, punt
2850   }
2851 
2852   if (ThreadPriorityVerbose) {
2853     tty-&gt;print_cr(&quot;Thread priority Range: [%d..%d]\n&quot;, myMin, myMax);
2854   }
2855 
2856   priocntl_enable = true;  // Enable changing priorities
2857   return 0;
2858 }
2859 
2860 #define IAPRI(x)        ((iaparms_t *)((x).pc_clparms))
2861 #define RTPRI(x)        ((rtparms_t *)((x).pc_clparms))
2862 #define TSPRI(x)        ((tsparms_t *)((x).pc_clparms))
2863 #define FXPRI(x)        ((fxparms_t *)((x).pc_clparms))
2864 
2865 
2866 // scale_to_lwp_priority
2867 //
2868 // Convert from the libthread &quot;thr_setprio&quot; scale to our current
2869 // lwp scheduling class scale.
2870 //
2871 static int scale_to_lwp_priority(int rMin, int rMax, int x) {
2872   int v;
2873 
2874   if (x == 127) return rMax;            // avoid round-down
2875   v = (((x*(rMax-rMin)))/128)+rMin;
2876   return v;
2877 }
2878 
2879 
2880 // set_lwp_class_and_priority
2881 int set_lwp_class_and_priority(int ThreadID, int lwpid,
2882                                int newPrio, int new_class, bool scale) {
2883   int rslt;
2884   int Actual, Expected, prv;
2885   pcparms_t ParmInfo;                   // for GET-SET
2886 #ifdef ASSERT
2887   pcparms_t ReadBack;                   // for readback
2888 #endif
2889 
2890   // Set priority via PC_GETPARMS, update, PC_SETPARMS
2891   // Query current values.
2892   // TODO: accelerate this by eliminating the PC_GETPARMS call.
2893   // Cache &quot;pcparms_t&quot; in global ParmCache.
2894   // TODO: elide set-to-same-value
2895 
2896   // If something went wrong on init, don&#39;t change priorities.
2897   if (!priocntl_enable) {
2898     if (ThreadPriorityVerbose) {
2899       tty-&gt;print_cr(&quot;Trying to set priority but init failed, ignoring&quot;);
2900     }
2901     return EINVAL;
2902   }
2903 
2904   // If lwp hasn&#39;t started yet, just return
2905   // the _start routine will call us again.
2906   if (lwpid &lt;= 0) {
2907     if (ThreadPriorityVerbose) {
2908       tty-&gt;print_cr(&quot;deferring the set_lwp_class_and_priority of thread &quot;
2909                     INTPTR_FORMAT &quot; to %d, lwpid not set&quot;,
2910                     ThreadID, newPrio);
2911     }
2912     return 0;
2913   }
2914 
2915   if (ThreadPriorityVerbose) {
2916     tty-&gt;print_cr (&quot;set_lwp_class_and_priority(&quot;
2917                    INTPTR_FORMAT &quot;@&quot; INTPTR_FORMAT &quot; %d) &quot;,
2918                    ThreadID, lwpid, newPrio);
2919   }
2920 
2921   memset(&amp;ParmInfo, 0, sizeof(pcparms_t));
2922   ParmInfo.pc_cid = PC_CLNULL;
2923   rslt = priocntl(P_LWPID, lwpid, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
2924   if (rslt &lt; 0) return errno;
2925 
2926   int cur_class = ParmInfo.pc_cid;
2927   ParmInfo.pc_cid = (id_t)new_class;
2928 
2929   if (new_class == rtLimits.schedPolicy) {
2930     rtparms_t *rtInfo  = (rtparms_t*)ParmInfo.pc_clparms;
2931     rtInfo-&gt;rt_pri     = scale ? scale_to_lwp_priority(rtLimits.minPrio,
2932                                                        rtLimits.maxPrio, newPrio)
2933                                : newPrio;
2934     rtInfo-&gt;rt_tqsecs  = RT_NOCHANGE;
2935     rtInfo-&gt;rt_tqnsecs = RT_NOCHANGE;
2936     if (ThreadPriorityVerbose) {
2937       tty-&gt;print_cr(&quot;RT: %d-&gt;%d\n&quot;, newPrio, rtInfo-&gt;rt_pri);
2938     }
2939   } else if (new_class == iaLimits.schedPolicy) {
2940     iaparms_t* iaInfo  = (iaparms_t*)ParmInfo.pc_clparms;
2941     int maxClamped     = MIN2(iaLimits.maxPrio,
2942                               cur_class == new_class
2943                               ? (int)iaInfo-&gt;ia_uprilim : iaLimits.maxPrio);
2944     iaInfo-&gt;ia_upri    = scale ? scale_to_lwp_priority(iaLimits.minPrio,
2945                                                        maxClamped, newPrio)
2946                                : newPrio;
2947     iaInfo-&gt;ia_uprilim = cur_class == new_class
2948                            ? IA_NOCHANGE : (pri_t)iaLimits.maxPrio;
2949     iaInfo-&gt;ia_mode    = IA_NOCHANGE;
2950     if (ThreadPriorityVerbose) {
2951       tty-&gt;print_cr(&quot;IA: [%d...%d] %d-&gt;%d\n&quot;,
2952                     iaLimits.minPrio, maxClamped, newPrio, iaInfo-&gt;ia_upri);
2953     }
2954   } else if (new_class == tsLimits.schedPolicy) {
2955     tsparms_t* tsInfo  = (tsparms_t*)ParmInfo.pc_clparms;
2956     int maxClamped     = MIN2(tsLimits.maxPrio,
2957                               cur_class == new_class
2958                               ? (int)tsInfo-&gt;ts_uprilim : tsLimits.maxPrio);
2959     tsInfo-&gt;ts_upri    = scale ? scale_to_lwp_priority(tsLimits.minPrio,
2960                                                        maxClamped, newPrio)
2961                                : newPrio;
2962     tsInfo-&gt;ts_uprilim = cur_class == new_class
2963                            ? TS_NOCHANGE : (pri_t)tsLimits.maxPrio;
2964     if (ThreadPriorityVerbose) {
2965       tty-&gt;print_cr(&quot;TS: [%d...%d] %d-&gt;%d\n&quot;,
2966                     tsLimits.minPrio, maxClamped, newPrio, tsInfo-&gt;ts_upri);
2967     }
2968   } else if (new_class == fxLimits.schedPolicy) {
2969     fxparms_t* fxInfo  = (fxparms_t*)ParmInfo.pc_clparms;
2970     int maxClamped     = MIN2(fxLimits.maxPrio,
2971                               cur_class == new_class
2972                               ? (int)fxInfo-&gt;fx_uprilim : fxLimits.maxPrio);
2973     fxInfo-&gt;fx_upri    = scale ? scale_to_lwp_priority(fxLimits.minPrio,
2974                                                        maxClamped, newPrio)
2975                                : newPrio;
2976     fxInfo-&gt;fx_uprilim = cur_class == new_class
2977                            ? FX_NOCHANGE : (pri_t)fxLimits.maxPrio;
2978     fxInfo-&gt;fx_tqsecs  = FX_NOCHANGE;
2979     fxInfo-&gt;fx_tqnsecs = FX_NOCHANGE;
2980     if (ThreadPriorityVerbose) {
2981       tty-&gt;print_cr(&quot;FX: [%d...%d] %d-&gt;%d\n&quot;,
2982                     fxLimits.minPrio, maxClamped, newPrio, fxInfo-&gt;fx_upri);
2983     }
2984   } else {
2985     if (ThreadPriorityVerbose) {
2986       tty-&gt;print_cr(&quot;Unknown new scheduling class %d\n&quot;, new_class);
2987     }
2988     return EINVAL;    // no clue, punt
2989   }
2990 
2991   rslt = priocntl(P_LWPID, lwpid, PC_SETPARMS, (caddr_t)&amp;ParmInfo);
2992   if (ThreadPriorityVerbose &amp;&amp; rslt) {
2993     tty-&gt;print_cr (&quot;PC_SETPARMS -&gt;%d %d\n&quot;, rslt, errno);
2994   }
2995   if (rslt &lt; 0) return errno;
2996 
2997 #ifdef ASSERT
2998   // Sanity check: read back what we just attempted to set.
2999   // In theory it could have changed in the interim ...
3000   //
3001   // The priocntl system call is tricky.
3002   // Sometimes it&#39;ll validate the priority value argument and
3003   // return EINVAL if unhappy.  At other times it fails silently.
3004   // Readbacks are prudent.
3005 
3006   if (!ReadBackValidate) return 0;
3007 
3008   memset(&amp;ReadBack, 0, sizeof(pcparms_t));
3009   ReadBack.pc_cid = PC_CLNULL;
3010   rslt = priocntl(P_LWPID, lwpid, PC_GETPARMS, (caddr_t)&amp;ReadBack);
3011   assert(rslt &gt;= 0, &quot;priocntl failed&quot;);
3012   Actual = Expected = 0xBAD;
3013   assert(ParmInfo.pc_cid == ReadBack.pc_cid, &quot;cid&#39;s don&#39;t match&quot;);
3014   if (ParmInfo.pc_cid == rtLimits.schedPolicy) {
3015     Actual   = RTPRI(ReadBack)-&gt;rt_pri;
3016     Expected = RTPRI(ParmInfo)-&gt;rt_pri;
3017   } else if (ParmInfo.pc_cid == iaLimits.schedPolicy) {
3018     Actual   = IAPRI(ReadBack)-&gt;ia_upri;
3019     Expected = IAPRI(ParmInfo)-&gt;ia_upri;
3020   } else if (ParmInfo.pc_cid == tsLimits.schedPolicy) {
3021     Actual   = TSPRI(ReadBack)-&gt;ts_upri;
3022     Expected = TSPRI(ParmInfo)-&gt;ts_upri;
3023   } else if (ParmInfo.pc_cid == fxLimits.schedPolicy) {
3024     Actual   = FXPRI(ReadBack)-&gt;fx_upri;
3025     Expected = FXPRI(ParmInfo)-&gt;fx_upri;
3026   } else {
3027     if (ThreadPriorityVerbose) {
3028       tty-&gt;print_cr(&quot;set_lwp_class_and_priority: unexpected class in readback: %d\n&quot;,
3029                     ParmInfo.pc_cid);
3030     }
3031   }
3032 
3033   if (Actual != Expected) {
3034     if (ThreadPriorityVerbose) {
3035       tty-&gt;print_cr (&quot;set_lwp_class_and_priority(%d %d) Class=%d: actual=%d vs expected=%d\n&quot;,
3036                      lwpid, newPrio, ReadBack.pc_cid, Actual, Expected);
3037     }
3038   }
3039 #endif
3040 
3041   return 0;
3042 }
3043 
3044 // Solaris only gives access to 128 real priorities at a time,
3045 // so we expand Java&#39;s ten to fill this range.  This would be better
3046 // if we dynamically adjusted relative priorities.
3047 //
3048 // The ThreadPriorityPolicy option allows us to select 2 different
3049 // priority scales.
3050 //
3051 // ThreadPriorityPolicy=0
3052 // Since the Solaris&#39; default priority is MaximumPriority, we do not
3053 // set a priority lower than Max unless a priority lower than
3054 // NormPriority is requested.
3055 //
3056 // ThreadPriorityPolicy=1
3057 // This mode causes the priority table to get filled with
3058 // linear values.  NormPriority get&#39;s mapped to 50% of the
3059 // Maximum priority an so on.  This will cause VM threads
3060 // to get unfair treatment against other Solaris processes
3061 // which do not explicitly alter their thread priorities.
3062 
3063 int os::java_to_os_priority[CriticalPriority + 1] = {
3064   -99999,         // 0 Entry should never be used
3065 
3066   0,              // 1 MinPriority
3067   32,             // 2
3068   64,             // 3
3069 
3070   96,             // 4
3071   127,            // 5 NormPriority
3072   127,            // 6
3073 
3074   127,            // 7
3075   127,            // 8
3076   127,            // 9 NearMaxPriority
3077 
3078   127,            // 10 MaxPriority
3079 
3080   -criticalPrio   // 11 CriticalPriority
3081 };
3082 
3083 OSReturn os::set_native_priority(Thread* thread, int newpri) {
3084   OSThread* osthread = thread-&gt;osthread();
3085 
3086   // Save requested priority in case the thread hasn&#39;t been started
3087   osthread-&gt;set_native_priority(newpri);
3088 
3089   // Check for critical priority request
3090   bool fxcritical = false;
3091   if (newpri == -criticalPrio) {
3092     fxcritical = true;
3093     newpri = criticalPrio;
3094   }
3095 
3096   assert(newpri &gt;= MinimumPriority &amp;&amp; newpri &lt;= MaximumPriority, &quot;bad priority mapping&quot;);
3097   if (!UseThreadPriorities) return OS_OK;
3098 
3099   int status = 0;
3100 
3101   if (!fxcritical) {
3102     // Use thr_setprio only if we have a priority that thr_setprio understands
3103     status = thr_setprio(thread-&gt;osthread()-&gt;thread_id(), newpri);
3104   }
3105 
3106   int lwp_status =
3107           set_lwp_class_and_priority(osthread-&gt;thread_id(),
3108                                      osthread-&gt;lwp_id(),
3109                                      newpri,
3110                                      fxcritical ? fxLimits.schedPolicy : myClass,
3111                                      !fxcritical);
3112   if (lwp_status != 0 &amp;&amp; fxcritical) {
3113     // Try again, this time without changing the scheduling class
3114     newpri = java_MaxPriority_to_os_priority;
3115     lwp_status = set_lwp_class_and_priority(osthread-&gt;thread_id(),
3116                                             osthread-&gt;lwp_id(),
3117                                             newpri, myClass, false);
3118   }
3119   status |= lwp_status;
3120   return (status == 0) ? OS_OK : OS_ERR;
3121 }
3122 
3123 
3124 OSReturn os::get_native_priority(const Thread* const thread,
3125                                  int *priority_ptr) {
3126   int p;
3127   if (!UseThreadPriorities) {
3128     *priority_ptr = NormalPriority;
3129     return OS_OK;
3130   }
3131   int status = thr_getprio(thread-&gt;osthread()-&gt;thread_id(), &amp;p);
3132   if (status != 0) {
3133     return OS_ERR;
3134   }
3135   *priority_ptr = p;
3136   return OS_OK;
3137 }
3138 
3139 ////////////////////////////////////////////////////////////////////////////////
3140 // suspend/resume support
3141 
3142 //  The low-level signal-based suspend/resume support is a remnant from the
3143 //  old VM-suspension that used to be for java-suspension, safepoints etc,
3144 //  within hotspot. Currently used by JFR&#39;s OSThreadSampler
3145 //
3146 //  The remaining code is greatly simplified from the more general suspension
3147 //  code that used to be used.
3148 //
3149 //  The protocol is quite simple:
3150 //  - suspend:
3151 //      - sends a signal to the target thread
3152 //      - polls the suspend state of the osthread using a yield loop
3153 //      - target thread signal handler (SR_handler) sets suspend state
3154 //        and blocks in sigsuspend until continued
3155 //  - resume:
3156 //      - sets target osthread state to continue
3157 //      - sends signal to end the sigsuspend loop in the SR_handler
3158 //
3159 //  Note that the SR_lock plays no role in this suspend/resume protocol,
3160 //  but is checked for NULL in SR_handler as a thread termination indicator.
3161 //  The SR_lock is, however, used by JavaThread::java_suspend()/java_resume() APIs.
3162 //
3163 //  Note that resume_clear_context() and suspend_save_context() are needed
3164 //  by SR_handler(), so that fetch_frame_from_ucontext() works,
3165 //  which in part is used by:
3166 //    - Forte Analyzer: AsyncGetCallTrace()
3167 //    - StackBanging: get_frame_at_stack_banging_point()
3168 //    - JFR: get_topframe()--&gt;....--&gt;get_valid_uc_in_signal_handler()
3169 
3170 static void resume_clear_context(OSThread *osthread) {
3171   osthread-&gt;set_ucontext(NULL);
3172 }
3173 
3174 static void suspend_save_context(OSThread *osthread, ucontext_t* context) {
3175   osthread-&gt;set_ucontext(context);
3176 }
3177 
3178 static PosixSemaphore sr_semaphore;
3179 
3180 void os::Solaris::SR_handler(Thread* thread, ucontext_t* context) {
3181   // Save and restore errno to avoid confusing native code with EINTR
3182   // after sigsuspend.
3183   int old_errno = errno;
3184 
3185   OSThread* osthread = thread-&gt;osthread();
3186   assert(thread-&gt;is_VM_thread() || thread-&gt;is_Java_thread(), &quot;Must be VMThread or JavaThread&quot;);
3187 
3188   os::SuspendResume::State current = osthread-&gt;sr.state();
3189   if (current == os::SuspendResume::SR_SUSPEND_REQUEST) {
3190     suspend_save_context(osthread, context);
3191 
3192     // attempt to switch the state, we assume we had a SUSPEND_REQUEST
3193     os::SuspendResume::State state = osthread-&gt;sr.suspended();
3194     if (state == os::SuspendResume::SR_SUSPENDED) {
3195       sigset_t suspend_set;  // signals for sigsuspend()
3196 
3197       // get current set of blocked signals and unblock resume signal
3198       pthread_sigmask(SIG_BLOCK, NULL, &amp;suspend_set);
3199       sigdelset(&amp;suspend_set, ASYNC_SIGNAL);
3200 
3201       sr_semaphore.signal();
3202       // wait here until we are resumed
3203       while (1) {
3204         sigsuspend(&amp;suspend_set);
3205 
3206         os::SuspendResume::State result = osthread-&gt;sr.running();
3207         if (result == os::SuspendResume::SR_RUNNING) {
3208           sr_semaphore.signal();
3209           break;
3210         }
3211       }
3212 
3213     } else if (state == os::SuspendResume::SR_RUNNING) {
3214       // request was cancelled, continue
3215     } else {
3216       ShouldNotReachHere();
3217     }
3218 
3219     resume_clear_context(osthread);
3220   } else if (current == os::SuspendResume::SR_RUNNING) {
3221     // request was cancelled, continue
3222   } else if (current == os::SuspendResume::SR_WAKEUP_REQUEST) {
3223     // ignore
3224   } else {
3225     // ignore
3226   }
3227 
3228   errno = old_errno;
3229 }
3230 
3231 void os::print_statistics() {
3232 }
3233 
3234 bool os::message_box(const char* title, const char* message) {
3235   int i;
3236   fdStream err(defaultStream::error_fd());
3237   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3238   err.cr();
3239   err.print_raw_cr(title);
3240   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;-&quot;);
3241   err.cr();
3242   err.print_raw_cr(message);
3243   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3244   err.cr();
3245 
3246   char buf[16];
3247   // Prevent process from exiting upon &quot;read error&quot; without consuming all CPU
3248   while (::read(0, buf, sizeof(buf)) &lt;= 0) { ::sleep(100); }
3249 
3250   return buf[0] == &#39;y&#39; || buf[0] == &#39;Y&#39;;
3251 }
3252 
3253 static int sr_notify(OSThread* osthread) {
3254   int status = thr_kill(osthread-&gt;thread_id(), ASYNC_SIGNAL);
3255   assert_status(status == 0, status, &quot;thr_kill&quot;);
3256   return status;
3257 }
3258 
3259 // &quot;Randomly&quot; selected value for how long we want to spin
3260 // before bailing out on suspending a thread, also how often
3261 // we send a signal to a thread we want to resume
3262 static const int RANDOMLY_LARGE_INTEGER = 1000000;
3263 static const int RANDOMLY_LARGE_INTEGER2 = 100;
3264 
3265 static bool do_suspend(OSThread* osthread) {
3266   assert(osthread-&gt;sr.is_running(), &quot;thread should be running&quot;);
3267   assert(!sr_semaphore.trywait(), &quot;semaphore has invalid state&quot;);
3268 
3269   // mark as suspended and send signal
3270   if (osthread-&gt;sr.request_suspend() != os::SuspendResume::SR_SUSPEND_REQUEST) {
3271     // failed to switch, state wasn&#39;t running?
3272     ShouldNotReachHere();
3273     return false;
3274   }
3275 
3276   if (sr_notify(osthread) != 0) {
3277     ShouldNotReachHere();
3278   }
3279 
3280   // managed to send the signal and switch to SUSPEND_REQUEST, now wait for SUSPENDED
3281   while (true) {
3282     if (sr_semaphore.timedwait(2000)) {
3283       break;
3284     } else {
3285       // timeout
3286       os::SuspendResume::State cancelled = osthread-&gt;sr.cancel_suspend();
3287       if (cancelled == os::SuspendResume::SR_RUNNING) {
3288         return false;
3289       } else if (cancelled == os::SuspendResume::SR_SUSPENDED) {
3290         // make sure that we consume the signal on the semaphore as well
3291         sr_semaphore.wait();
3292         break;
3293       } else {
3294         ShouldNotReachHere();
3295         return false;
3296       }
3297     }
3298   }
3299 
3300   guarantee(osthread-&gt;sr.is_suspended(), &quot;Must be suspended&quot;);
3301   return true;
3302 }
3303 
3304 static void do_resume(OSThread* osthread) {
3305   assert(osthread-&gt;sr.is_suspended(), &quot;thread should be suspended&quot;);
3306   assert(!sr_semaphore.trywait(), &quot;invalid semaphore state&quot;);
3307 
3308   if (osthread-&gt;sr.request_wakeup() != os::SuspendResume::SR_WAKEUP_REQUEST) {
3309     // failed to switch to WAKEUP_REQUEST
3310     ShouldNotReachHere();
3311     return;
3312   }
3313 
3314   while (true) {
3315     if (sr_notify(osthread) == 0) {
3316       if (sr_semaphore.timedwait(2)) {
3317         if (osthread-&gt;sr.is_running()) {
3318           return;
3319         }
3320       }
3321     } else {
3322       ShouldNotReachHere();
3323     }
3324   }
3325 
3326   guarantee(osthread-&gt;sr.is_running(), &quot;Must be running!&quot;);
3327 }
3328 
3329 void os::SuspendedThreadTask::internal_do_task() {
3330   if (do_suspend(_thread-&gt;osthread())) {
3331     SuspendedThreadTaskContext context(_thread, _thread-&gt;osthread()-&gt;ucontext());
3332     do_task(context);
3333     do_resume(_thread-&gt;osthread());
3334   }
3335 }
3336 
3337 // This does not do anything on Solaris. This is basically a hook for being
3338 // able to use structured exception handling (thread-local exception filters) on, e.g., Win32.
3339 void os::os_exception_wrapper(java_call_t f, JavaValue* value,
3340                               const methodHandle&amp; method, JavaCallArguments* args,
3341                               Thread* thread) {
3342   f(value, method, args, thread);
3343 }
3344 
3345 // This routine may be used by user applications as a &quot;hook&quot; to catch signals.
3346 // The user-defined signal handler must pass unrecognized signals to this
3347 // routine, and if it returns true (non-zero), then the signal handler must
3348 // return immediately.  If the flag &quot;abort_if_unrecognized&quot; is true, then this
3349 // routine will never retun false (zero), but instead will execute a VM panic
3350 // routine kill the process.
3351 //
3352 // If this routine returns false, it is OK to call it again.  This allows
3353 // the user-defined signal handler to perform checks either before or after
3354 // the VM performs its own checks.  Naturally, the user code would be making
3355 // a serious error if it tried to handle an exception (such as a null check
3356 // or breakpoint) that the VM was generating for its own correct operation.
3357 //
3358 // This routine may recognize any of the following kinds of signals:
3359 // SIGBUS, SIGSEGV, SIGILL, SIGFPE, BREAK_SIGNAL, SIGPIPE, SIGXFSZ,
3360 // ASYNC_SIGNAL.
3361 // It should be consulted by handlers for any of those signals.
3362 //
3363 // The caller of this routine must pass in the three arguments supplied
3364 // to the function referred to in the &quot;sa_sigaction&quot; (not the &quot;sa_handler&quot;)
3365 // field of the structure passed to sigaction().  This routine assumes that
3366 // the sa_flags field passed to sigaction() includes SA_SIGINFO and SA_RESTART.
3367 //
3368 // Note that the VM will print warnings if it detects conflicting signal
3369 // handlers, unless invoked with the option &quot;-XX:+AllowUserSignalHandlers&quot;.
3370 //
3371 extern &quot;C&quot; JNIEXPORT int JVM_handle_solaris_signal(int signo,
3372                                                    siginfo_t* siginfo,
3373                                                    void* ucontext,
3374                                                    int abort_if_unrecognized);
3375 
3376 
3377 void signalHandler(int sig, siginfo_t* info, void* ucVoid) {
3378   int orig_errno = errno;  // Preserve errno value over signal handler.
3379   JVM_handle_solaris_signal(sig, info, ucVoid, true);
3380   errno = orig_errno;
3381 }
3382 
3383 // This boolean allows users to forward their own non-matching signals
3384 // to JVM_handle_solaris_signal, harmlessly.
3385 bool os::Solaris::signal_handlers_are_installed = false;
3386 
3387 // For signal-chaining
3388 bool os::Solaris::libjsig_is_loaded = false;
3389 typedef struct sigaction *(*get_signal_t)(int);
3390 get_signal_t os::Solaris::get_signal_action = NULL;
3391 
3392 struct sigaction* os::Solaris::get_chained_signal_action(int sig) {
3393   struct sigaction *actp = NULL;
3394 
3395   if ((libjsig_is_loaded)  &amp;&amp; (sig &lt;= Maxsignum)) {
3396     // Retrieve the old signal handler from libjsig
3397     actp = (*get_signal_action)(sig);
3398   }
3399   if (actp == NULL) {
3400     // Retrieve the preinstalled signal handler from jvm
3401     actp = get_preinstalled_handler(sig);
3402   }
3403 
3404   return actp;
3405 }
3406 
3407 static bool call_chained_handler(struct sigaction *actp, int sig,
3408                                  siginfo_t *siginfo, void *context) {
3409   // Call the old signal handler
3410   if (actp-&gt;sa_handler == SIG_DFL) {
3411     // It&#39;s more reasonable to let jvm treat it as an unexpected exception
3412     // instead of taking the default action.
3413     return false;
3414   } else if (actp-&gt;sa_handler != SIG_IGN) {
3415     if ((actp-&gt;sa_flags &amp; SA_NODEFER) == 0) {
3416       // automaticlly block the signal
3417       sigaddset(&amp;(actp-&gt;sa_mask), sig);
3418     }
3419 
3420     sa_handler_t hand;
3421     sa_sigaction_t sa;
3422     bool siginfo_flag_set = (actp-&gt;sa_flags &amp; SA_SIGINFO) != 0;
3423     // retrieve the chained handler
3424     if (siginfo_flag_set) {
3425       sa = actp-&gt;sa_sigaction;
3426     } else {
3427       hand = actp-&gt;sa_handler;
3428     }
3429 
3430     if ((actp-&gt;sa_flags &amp; SA_RESETHAND) != 0) {
3431       actp-&gt;sa_handler = SIG_DFL;
3432     }
3433 
3434     // try to honor the signal mask
3435     sigset_t oset;
3436     pthread_sigmask(SIG_SETMASK, &amp;(actp-&gt;sa_mask), &amp;oset);
3437 
3438     // call into the chained handler
3439     if (siginfo_flag_set) {
3440       (*sa)(sig, siginfo, context);
3441     } else {
3442       (*hand)(sig);
3443     }
3444 
3445     // restore the signal mask
3446     pthread_sigmask(SIG_SETMASK, &amp;oset, 0);
3447   }
3448   // Tell jvm&#39;s signal handler the signal is taken care of.
3449   return true;
3450 }
3451 
3452 bool os::Solaris::chained_handler(int sig, siginfo_t* siginfo, void* context) {
3453   bool chained = false;
3454   // signal-chaining
3455   if (UseSignalChaining) {
3456     struct sigaction *actp = get_chained_signal_action(sig);
3457     if (actp != NULL) {
3458       chained = call_chained_handler(actp, sig, siginfo, context);
3459     }
3460   }
3461   return chained;
3462 }
3463 
3464 struct sigaction* os::Solaris::get_preinstalled_handler(int sig) {
3465   assert((chainedsigactions != (struct sigaction *)NULL) &amp;&amp;
3466          (preinstalled_sigs != (int *)NULL), &quot;signals not yet initialized&quot;);
3467   if (preinstalled_sigs[sig] != 0) {
3468     return &amp;chainedsigactions[sig];
3469   }
3470   return NULL;
3471 }
3472 
3473 void os::Solaris::save_preinstalled_handler(int sig,
3474                                             struct sigaction&amp; oldAct) {
3475   assert(sig &gt; 0 &amp;&amp; sig &lt;= Maxsignum, &quot;vm signal out of expected range&quot;);
3476   assert((chainedsigactions != (struct sigaction *)NULL) &amp;&amp;
3477          (preinstalled_sigs != (int *)NULL), &quot;signals not yet initialized&quot;);
3478   chainedsigactions[sig] = oldAct;
3479   preinstalled_sigs[sig] = 1;
3480 }
3481 
3482 void os::Solaris::set_signal_handler(int sig, bool set_installed,
3483                                      bool oktochain) {
3484   // Check for overwrite.
3485   struct sigaction oldAct;
3486   sigaction(sig, (struct sigaction*)NULL, &amp;oldAct);
3487   void* oldhand =
3488       oldAct.sa_sigaction ? CAST_FROM_FN_PTR(void*,  oldAct.sa_sigaction)
3489                           : CAST_FROM_FN_PTR(void*,  oldAct.sa_handler);
3490   if (oldhand != CAST_FROM_FN_PTR(void*, SIG_DFL) &amp;&amp;
3491       oldhand != CAST_FROM_FN_PTR(void*, SIG_IGN) &amp;&amp;
3492       oldhand != CAST_FROM_FN_PTR(void*, signalHandler)) {
3493     if (AllowUserSignalHandlers || !set_installed) {
3494       // Do not overwrite; user takes responsibility to forward to us.
3495       return;
3496     } else if (UseSignalChaining) {
3497       if (oktochain) {
3498         // save the old handler in jvm
3499         save_preinstalled_handler(sig, oldAct);
3500       } else {
3501         vm_exit_during_initialization(&quot;Signal chaining not allowed for VM interrupt signal.&quot;);
3502       }
3503       // libjsig also interposes the sigaction() call below and saves the
3504       // old sigaction on it own.
3505     } else {
3506       fatal(&quot;Encountered unexpected pre-existing sigaction handler &quot;
3507             &quot;%#lx for signal %d.&quot;, (long)oldhand, sig);
3508     }
3509   }
3510 
3511   struct sigaction sigAct;
3512   sigfillset(&amp;(sigAct.sa_mask));
3513   sigAct.sa_handler = SIG_DFL;
3514 
3515   sigAct.sa_sigaction = signalHandler;
3516   // Handle SIGSEGV on alternate signal stack if
3517   // not using stack banging
3518   if (!UseStackBanging &amp;&amp; sig == SIGSEGV) {
3519     sigAct.sa_flags = SA_SIGINFO | SA_RESTART | SA_ONSTACK;
3520   } else {
3521     sigAct.sa_flags = SA_SIGINFO | SA_RESTART;
3522   }
3523   os::Solaris::set_our_sigflags(sig, sigAct.sa_flags);
3524 
3525   sigaction(sig, &amp;sigAct, &amp;oldAct);
3526 
3527   void* oldhand2 = oldAct.sa_sigaction ? CAST_FROM_FN_PTR(void*, oldAct.sa_sigaction)
3528                                        : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
3529   assert(oldhand2 == oldhand, &quot;no concurrent signal handler installation&quot;);
3530 }
3531 
3532 
3533 #define DO_SIGNAL_CHECK(sig)                      \
3534   do {                                            \
3535     if (!sigismember(&amp;check_signal_done, sig)) {  \
3536       os::Solaris::check_signal_handler(sig);     \
3537     }                                             \
3538   } while (0)
3539 
3540 // This method is a periodic task to check for misbehaving JNI applications
3541 // under CheckJNI, we can add any periodic checks here
3542 
3543 void os::run_periodic_checks() {
3544   // A big source of grief is hijacking virt. addr 0x0 on Solaris,
3545   // thereby preventing a NULL checks.
3546   if (!check_addr0_done) check_addr0_done = check_addr0(tty);
3547 
3548   if (check_signals == false) return;
3549 
3550   // SEGV and BUS if overridden could potentially prevent
3551   // generation of hs*.log in the event of a crash, debugging
3552   // such a case can be very challenging, so we absolutely
3553   // check for the following for a good measure:
3554   DO_SIGNAL_CHECK(SIGSEGV);
3555   DO_SIGNAL_CHECK(SIGILL);
3556   DO_SIGNAL_CHECK(SIGFPE);
3557   DO_SIGNAL_CHECK(SIGBUS);
3558   DO_SIGNAL_CHECK(SIGPIPE);
3559   DO_SIGNAL_CHECK(SIGXFSZ);
3560   DO_SIGNAL_CHECK(ASYNC_SIGNAL);
3561 
3562   // ReduceSignalUsage allows the user to override these handlers
3563   // see comments at the very top and jvm_solaris.h
3564   if (!ReduceSignalUsage) {
3565     DO_SIGNAL_CHECK(SHUTDOWN1_SIGNAL);
3566     DO_SIGNAL_CHECK(SHUTDOWN2_SIGNAL);
3567     DO_SIGNAL_CHECK(SHUTDOWN3_SIGNAL);
3568     DO_SIGNAL_CHECK(BREAK_SIGNAL);
3569   }
3570 }
3571 
3572 typedef int (*os_sigaction_t)(int, const struct sigaction *, struct sigaction *);
3573 
3574 static os_sigaction_t os_sigaction = NULL;
3575 
3576 void os::Solaris::check_signal_handler(int sig) {
3577   char buf[O_BUFLEN];
3578   address jvmHandler = NULL;
3579 
3580   struct sigaction act;
3581   if (os_sigaction == NULL) {
3582     // only trust the default sigaction, in case it has been interposed
3583     os_sigaction = (os_sigaction_t)dlsym(RTLD_DEFAULT, &quot;sigaction&quot;);
3584     if (os_sigaction == NULL) return;
3585   }
3586 
3587   os_sigaction(sig, (struct sigaction*)NULL, &amp;act);
3588 
3589   address thisHandler = (act.sa_flags &amp; SA_SIGINFO)
3590     ? CAST_FROM_FN_PTR(address, act.sa_sigaction)
3591     : CAST_FROM_FN_PTR(address, act.sa_handler);
3592 
3593 
3594   switch (sig) {
3595   case SIGSEGV:
3596   case SIGBUS:
3597   case SIGFPE:
3598   case SIGPIPE:
3599   case SIGXFSZ:
3600   case SIGILL:
3601   case ASYNC_SIGNAL:
3602     jvmHandler = CAST_FROM_FN_PTR(address, signalHandler);
3603     break;
3604 
3605   case SHUTDOWN1_SIGNAL:
3606   case SHUTDOWN2_SIGNAL:
3607   case SHUTDOWN3_SIGNAL:
3608   case BREAK_SIGNAL:
3609     jvmHandler = (address)user_handler();
3610     break;
3611 
3612   default:
3613       return;
3614   }
3615 
3616   if (thisHandler != jvmHandler) {
3617     tty-&gt;print(&quot;Warning: %s handler &quot;, exception_name(sig, buf, O_BUFLEN));
3618     tty-&gt;print(&quot;expected:%s&quot;, get_signal_handler_name(jvmHandler, buf, O_BUFLEN));
3619     tty-&gt;print_cr(&quot;  found:%s&quot;, get_signal_handler_name(thisHandler, buf, O_BUFLEN));
3620     // No need to check this sig any longer
3621     sigaddset(&amp;check_signal_done, sig);
3622     // Running under non-interactive shell, SHUTDOWN2_SIGNAL will be reassigned SIG_IGN
3623     if (sig == SHUTDOWN2_SIGNAL &amp;&amp; !isatty(fileno(stdin))) {
3624       tty-&gt;print_cr(&quot;Running in non-interactive shell, %s handler is replaced by shell&quot;,
3625                     exception_name(sig, buf, O_BUFLEN));
3626     }
3627   } else if(os::Solaris::get_our_sigflags(sig) != 0 &amp;&amp; act.sa_flags != os::Solaris::get_our_sigflags(sig)) {
3628     tty-&gt;print(&quot;Warning: %s handler flags &quot;, exception_name(sig, buf, O_BUFLEN));
3629     tty-&gt;print(&quot;expected:&quot;);
3630     os::Posix::print_sa_flags(tty, os::Solaris::get_our_sigflags(sig));
3631     tty-&gt;cr();
3632     tty-&gt;print(&quot;  found:&quot;);
3633     os::Posix::print_sa_flags(tty, act.sa_flags);
3634     tty-&gt;cr();
3635     // No need to check this sig any longer
3636     sigaddset(&amp;check_signal_done, sig);
3637   }
3638 
3639   // Print all the signal handler state
3640   if (sigismember(&amp;check_signal_done, sig)) {
3641     print_signal_handlers(tty, buf, O_BUFLEN);
3642   }
3643 
3644 }
3645 
3646 void os::Solaris::install_signal_handlers() {
3647   signal_handlers_are_installed = true;
3648 
3649   // signal-chaining
3650   typedef void (*signal_setting_t)();
3651   signal_setting_t begin_signal_setting = NULL;
3652   signal_setting_t end_signal_setting = NULL;
3653   begin_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
3654                                         dlsym(RTLD_DEFAULT, &quot;JVM_begin_signal_setting&quot;));
3655   if (begin_signal_setting != NULL) {
3656     end_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
3657                                         dlsym(RTLD_DEFAULT, &quot;JVM_end_signal_setting&quot;));
3658     get_signal_action = CAST_TO_FN_PTR(get_signal_t,
3659                                        dlsym(RTLD_DEFAULT, &quot;JVM_get_signal_action&quot;));
3660     libjsig_is_loaded = true;
3661     assert(UseSignalChaining, &quot;should enable signal-chaining&quot;);
3662   }
3663   if (libjsig_is_loaded) {
3664     // Tell libjsig jvm is setting signal handlers
3665     (*begin_signal_setting)();
3666   }
3667 
3668   set_signal_handler(SIGSEGV, true, true);
3669   set_signal_handler(SIGPIPE, true, true);
3670   set_signal_handler(SIGXFSZ, true, true);
3671   set_signal_handler(SIGBUS, true, true);
3672   set_signal_handler(SIGILL, true, true);
3673   set_signal_handler(SIGFPE, true, true);
3674   set_signal_handler(ASYNC_SIGNAL, true, true);
3675 
3676   if (libjsig_is_loaded) {
3677     // Tell libjsig jvm finishes setting signal handlers
3678     (*end_signal_setting)();
3679   }
3680 
3681   // We don&#39;t activate signal checker if libjsig is in place, we trust ourselves
3682   // and if UserSignalHandler is installed all bets are off.
3683   // Log that signal checking is off only if -verbose:jni is specified.
3684   if (CheckJNICalls) {
3685     if (libjsig_is_loaded) {
3686       log_debug(jni, resolve)(&quot;Info: libjsig is activated, all active signal checking is disabled&quot;);
3687       check_signals = false;
3688     }
3689     if (AllowUserSignalHandlers) {
3690       log_debug(jni, resolve)(&quot;Info: AllowUserSignalHandlers is activated, all active signal checking is disabled&quot;);
3691       check_signals = false;
3692     }
3693   }
3694 }
3695 
3696 
3697 void report_error(const char* file_name, int line_no, const char* title,
3698                   const char* format, ...);
3699 
3700 // (Static) wrappers for the liblgrp API
3701 os::Solaris::lgrp_home_func_t os::Solaris::_lgrp_home;
3702 os::Solaris::lgrp_init_func_t os::Solaris::_lgrp_init;
3703 os::Solaris::lgrp_fini_func_t os::Solaris::_lgrp_fini;
3704 os::Solaris::lgrp_root_func_t os::Solaris::_lgrp_root;
3705 os::Solaris::lgrp_children_func_t os::Solaris::_lgrp_children;
3706 os::Solaris::lgrp_resources_func_t os::Solaris::_lgrp_resources;
3707 os::Solaris::lgrp_nlgrps_func_t os::Solaris::_lgrp_nlgrps;
3708 os::Solaris::lgrp_cookie_stale_func_t os::Solaris::_lgrp_cookie_stale;
3709 os::Solaris::lgrp_cookie_t os::Solaris::_lgrp_cookie = 0;
3710 
3711 static address resolve_symbol_lazy(const char* name) {
3712   address addr = (address) dlsym(RTLD_DEFAULT, name);
3713   if (addr == NULL) {
3714     // RTLD_DEFAULT was not defined on some early versions of 2.5.1
3715     addr = (address) dlsym(RTLD_NEXT, name);
3716   }
3717   return addr;
3718 }
3719 
3720 static address resolve_symbol(const char* name) {
3721   address addr = resolve_symbol_lazy(name);
3722   if (addr == NULL) {
3723     fatal(dlerror());
3724   }
3725   return addr;
3726 }
3727 
3728 void os::Solaris::libthread_init() {
3729   address func = (address)dlsym(RTLD_DEFAULT, &quot;_thr_suspend_allmutators&quot;);
3730 
3731   lwp_priocntl_init();
3732 
3733   // RTLD_DEFAULT was not defined on some early versions of 5.5.1
3734   if (func == NULL) {
3735     func = (address) dlsym(RTLD_NEXT, &quot;_thr_suspend_allmutators&quot;);
3736     // Guarantee that this VM is running on an new enough OS (5.6 or
3737     // later) that it will have a new enough libthread.so.
3738     guarantee(func != NULL, &quot;libthread.so is too old.&quot;);
3739   }
3740 
3741   int size;
3742   void (*handler_info_func)(address *, int *);
3743   handler_info_func = CAST_TO_FN_PTR(void (*)(address *, int *), resolve_symbol(&quot;thr_sighndlrinfo&quot;));
3744   handler_info_func(&amp;handler_start, &amp;size);
3745   handler_end = handler_start + size;
3746 }
3747 
3748 
3749 int_fnP_mutex_tP os::Solaris::_mutex_lock;
3750 int_fnP_mutex_tP os::Solaris::_mutex_trylock;
3751 int_fnP_mutex_tP os::Solaris::_mutex_unlock;
3752 int_fnP_mutex_tP_i_vP os::Solaris::_mutex_init;
3753 int_fnP_mutex_tP os::Solaris::_mutex_destroy;
3754 int os::Solaris::_mutex_scope = USYNC_THREAD;
3755 
3756 int_fnP_cond_tP_mutex_tP_timestruc_tP os::Solaris::_cond_timedwait;
3757 int_fnP_cond_tP_mutex_tP os::Solaris::_cond_wait;
3758 int_fnP_cond_tP os::Solaris::_cond_signal;
3759 int_fnP_cond_tP os::Solaris::_cond_broadcast;
3760 int_fnP_cond_tP_i_vP os::Solaris::_cond_init;
3761 int_fnP_cond_tP os::Solaris::_cond_destroy;
3762 int os::Solaris::_cond_scope = USYNC_THREAD;
3763 bool os::Solaris::_synchronization_initialized;
3764 
3765 void os::Solaris::synchronization_init() {
3766   if (UseLWPSynchronization) {
3767     os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_lock&quot;)));
3768     os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_trylock&quot;)));
3769     os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_unlock&quot;)));
3770     os::Solaris::set_mutex_init(lwp_mutex_init);
3771     os::Solaris::set_mutex_destroy(lwp_mutex_destroy);
3772     os::Solaris::set_mutex_scope(USYNC_THREAD);
3773 
3774     os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;_lwp_cond_timedwait&quot;)));
3775     os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;_lwp_cond_wait&quot;)));
3776     os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;_lwp_cond_signal&quot;)));
3777     os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;_lwp_cond_broadcast&quot;)));
3778     os::Solaris::set_cond_init(lwp_cond_init);
3779     os::Solaris::set_cond_destroy(lwp_cond_destroy);
3780     os::Solaris::set_cond_scope(USYNC_THREAD);
3781   } else {
3782     os::Solaris::set_mutex_scope(USYNC_THREAD);
3783     os::Solaris::set_cond_scope(USYNC_THREAD);
3784 
3785     if (UsePthreads) {
3786       os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_lock&quot;)));
3787       os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_trylock&quot;)));
3788       os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_unlock&quot;)));
3789       os::Solaris::set_mutex_init(pthread_mutex_default_init);
3790       os::Solaris::set_mutex_destroy(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_destroy&quot;)));
3791 
3792       os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;pthread_cond_timedwait&quot;)));
3793       os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;pthread_cond_wait&quot;)));
3794       os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_signal&quot;)));
3795       os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_broadcast&quot;)));
3796       os::Solaris::set_cond_init(pthread_cond_default_init);
3797       os::Solaris::set_cond_destroy(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_destroy&quot;)));
3798     } else {
3799       os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_lock&quot;)));
3800       os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_trylock&quot;)));
3801       os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_unlock&quot;)));
3802       os::Solaris::set_mutex_init(::mutex_init);
3803       os::Solaris::set_mutex_destroy(::mutex_destroy);
3804 
3805       os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;cond_timedwait&quot;)));
3806       os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;cond_wait&quot;)));
3807       os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;cond_signal&quot;)));
3808       os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;cond_broadcast&quot;)));
3809       os::Solaris::set_cond_init(::cond_init);
3810       os::Solaris::set_cond_destroy(::cond_destroy);
3811     }
3812   }
3813   _synchronization_initialized = true;
3814 }
3815 
3816 bool os::Solaris::liblgrp_init() {
3817   void *handle = dlopen(&quot;liblgrp.so.1&quot;, RTLD_LAZY);
3818   if (handle != NULL) {
3819     os::Solaris::set_lgrp_home(CAST_TO_FN_PTR(lgrp_home_func_t, dlsym(handle, &quot;lgrp_home&quot;)));
3820     os::Solaris::set_lgrp_init(CAST_TO_FN_PTR(lgrp_init_func_t, dlsym(handle, &quot;lgrp_init&quot;)));
3821     os::Solaris::set_lgrp_fini(CAST_TO_FN_PTR(lgrp_fini_func_t, dlsym(handle, &quot;lgrp_fini&quot;)));
3822     os::Solaris::set_lgrp_root(CAST_TO_FN_PTR(lgrp_root_func_t, dlsym(handle, &quot;lgrp_root&quot;)));
3823     os::Solaris::set_lgrp_children(CAST_TO_FN_PTR(lgrp_children_func_t, dlsym(handle, &quot;lgrp_children&quot;)));
3824     os::Solaris::set_lgrp_resources(CAST_TO_FN_PTR(lgrp_resources_func_t, dlsym(handle, &quot;lgrp_resources&quot;)));
3825     os::Solaris::set_lgrp_nlgrps(CAST_TO_FN_PTR(lgrp_nlgrps_func_t, dlsym(handle, &quot;lgrp_nlgrps&quot;)));
3826     os::Solaris::set_lgrp_cookie_stale(CAST_TO_FN_PTR(lgrp_cookie_stale_func_t,
3827                                                       dlsym(handle, &quot;lgrp_cookie_stale&quot;)));
3828 
3829     lgrp_cookie_t c = lgrp_init(LGRP_VIEW_CALLER);
3830     set_lgrp_cookie(c);
3831     return true;
3832   }
3833   return false;
3834 }
3835 
3836 // int pset_getloadavg(psetid_t pset, double loadavg[], int nelem);
3837 typedef long (*pset_getloadavg_type)(psetid_t pset, double loadavg[], int nelem);
3838 static pset_getloadavg_type pset_getloadavg_ptr = NULL;
3839 
3840 void init_pset_getloadavg_ptr(void) {
3841   pset_getloadavg_ptr =
3842     (pset_getloadavg_type)dlsym(RTLD_DEFAULT, &quot;pset_getloadavg&quot;);
3843   if (pset_getloadavg_ptr == NULL) {
3844     log_warning(os)(&quot;pset_getloadavg function not found&quot;);
3845   }
3846 }
3847 
3848 int os::Solaris::_dev_zero_fd = -1;
3849 
3850 // this is called _before_ the global arguments have been parsed
3851 void os::init(void) {
3852   _initial_pid = getpid();
3853 
3854   max_hrtime = first_hrtime = gethrtime();
3855 
3856   init_random(1234567);
3857 
3858   page_size = sysconf(_SC_PAGESIZE);
3859   if (page_size == -1) {
3860     fatal(&quot;os_solaris.cpp: os::init: sysconf failed (%s)&quot;, os::strerror(errno));
3861   }
3862   init_page_sizes((size_t) page_size);
3863 
3864   Solaris::initialize_system_info();
3865 
3866   int fd = ::open(&quot;/dev/zero&quot;, O_RDWR);
3867   if (fd &lt; 0) {
3868     fatal(&quot;os::init: cannot open /dev/zero (%s)&quot;, os::strerror(errno));
3869   } else {
3870     Solaris::set_dev_zero_fd(fd);
3871 
3872     // Close on exec, child won&#39;t inherit.
3873     fcntl(fd, F_SETFD, FD_CLOEXEC);
3874   }
3875 
3876   clock_tics_per_sec = CLK_TCK;
3877 
3878   // check if dladdr1() exists; dladdr1 can provide more information than
3879   // dladdr for os::dll_address_to_function_name. It comes with SunOS 5.9
3880   // and is available on linker patches for 5.7 and 5.8.
3881   // libdl.so must have been loaded, this call is just an entry lookup
3882   void * hdl = dlopen(&quot;libdl.so&quot;, RTLD_NOW);
3883   if (hdl) {
3884     dladdr1_func = CAST_TO_FN_PTR(dladdr1_func_type, dlsym(hdl, &quot;dladdr1&quot;));
3885   }
3886 
3887   // main_thread points to the thread that created/loaded the JVM.
3888   main_thread = thr_self();
3889 
3890   // dynamic lookup of functions that may not be available in our lowest
3891   // supported Solaris release
3892   void * handle = dlopen(&quot;libc.so.1&quot;, RTLD_LAZY);
3893   if (handle != NULL) {
3894     Solaris::_pthread_setname_np =  // from 11.3
3895         (Solaris::pthread_setname_np_func_t)dlsym(handle, &quot;pthread_setname_np&quot;);
3896   }
3897 
3898   // Shared Posix initialization
3899   os::Posix::init();
3900 }
3901 
3902 // To install functions for atexit system call
3903 extern &quot;C&quot; {
3904   static void perfMemory_exit_helper() {
3905     perfMemory_exit();
3906   }
3907 }
3908 
3909 // this is called _after_ the global arguments have been parsed
3910 jint os::init_2(void) {
3911   // try to enable extended file IO ASAP, see 6431278
3912   os::Solaris::try_enable_extended_io();
3913 
3914   // Check and sets minimum stack sizes against command line options
3915   if (Posix::set_minimum_stack_sizes() == JNI_ERR) {
3916     return JNI_ERR;
3917   }
3918 
3919   Solaris::libthread_init();
3920 
3921   if (UseNUMA) {
3922     if (!Solaris::liblgrp_init()) {
3923       UseNUMA = false;
3924     } else {
3925       size_t lgrp_limit = os::numa_get_groups_num();
3926       int *lgrp_ids = NEW_C_HEAP_ARRAY(int, lgrp_limit, mtInternal);
3927       size_t lgrp_num = os::numa_get_leaf_groups(lgrp_ids, lgrp_limit);
3928       FREE_C_HEAP_ARRAY(int, lgrp_ids);
3929       if (lgrp_num &lt; 2) {
3930         // There&#39;s only one locality group, disable NUMA unless
3931         // user explicilty forces NUMA optimizations on single-node/UMA systems
3932         UseNUMA = ForceNUMA;
3933       }
3934     }
3935   }
3936 
3937   Solaris::signal_sets_init();
3938   Solaris::init_signal_mem();
3939   Solaris::install_signal_handlers();
3940   // Initialize data for jdk.internal.misc.Signal
3941   if (!ReduceSignalUsage) {
3942     jdk_misc_signal_init();
3943   }
3944 
3945   // initialize synchronization primitives to use either thread or
3946   // lwp synchronization (controlled by UseLWPSynchronization)
3947   Solaris::synchronization_init();
3948   DEBUG_ONLY(os::set_mutex_init_done();)
3949 
3950   if (MaxFDLimit) {
3951     // set the number of file descriptors to max. print out error
3952     // if getrlimit/setrlimit fails but continue regardless.
3953     struct rlimit nbr_files;
3954     int status = getrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3955     if (status != 0) {
3956       log_info(os)(&quot;os::init_2 getrlimit failed: %s&quot;, os::strerror(errno));
3957     } else {
3958       nbr_files.rlim_cur = nbr_files.rlim_max;
3959       status = setrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3960       if (status != 0) {
3961         log_info(os)(&quot;os::init_2 setrlimit failed: %s&quot;, os::strerror(errno));
3962       }
3963     }
3964   }
3965 
3966   // Calculate theoretical max. size of Threads to guard gainst
3967   // artifical out-of-memory situations, where all available address-
3968   // space has been reserved by thread stacks. Default stack size is 1Mb.
3969   size_t pre_thread_stack_size = (JavaThread::stack_size_at_create()) ?
3970     JavaThread::stack_size_at_create() : (1*K*K);
3971   assert(pre_thread_stack_size != 0, &quot;Must have a stack&quot;);
3972   // Solaris has a maximum of 4Gb of user programs. Calculate the thread limit when
3973   // we should start doing Virtual Memory banging. Currently when the threads will
3974   // have used all but 200Mb of space.
3975   size_t max_address_space = ((unsigned int)4 * K * K * K) - (200 * K * K);
3976   Solaris::_os_thread_limit = max_address_space / pre_thread_stack_size;
3977 
3978   // at-exit methods are called in the reverse order of their registration.
3979   // In Solaris 7 and earlier, atexit functions are called on return from
3980   // main or as a result of a call to exit(3C). There can be only 32 of
3981   // these functions registered and atexit() does not set errno. In Solaris
3982   // 8 and later, there is no limit to the number of functions registered
3983   // and atexit() sets errno. In addition, in Solaris 8 and later, atexit
3984   // functions are called upon dlclose(3DL) in addition to return from main
3985   // and exit(3C).
3986 
3987   if (PerfAllowAtExitRegistration) {
3988     // only register atexit functions if PerfAllowAtExitRegistration is set.
3989     // atexit functions can be delayed until process exit time, which
3990     // can be problematic for embedded VM situations. Embedded VMs should
3991     // call DestroyJavaVM() to assure that VM resources are released.
3992 
3993     // note: perfMemory_exit_helper atexit function may be removed in
3994     // the future if the appropriate cleanup code can be added to the
3995     // VM_Exit VMOperation&#39;s doit method.
3996     if (atexit(perfMemory_exit_helper) != 0) {
3997       warning(&quot;os::init2 atexit(perfMemory_exit_helper) failed&quot;);
3998     }
3999   }
4000 
4001   // Init pset_loadavg function pointer
4002   init_pset_getloadavg_ptr();
4003 
4004   // Shared Posix initialization
4005   os::Posix::init_2();
4006 
4007   return JNI_OK;
4008 }
4009 
<a name="3" id="anc3"></a><span class="line-removed">4010 // Mark the polling page as unreadable</span>
<span class="line-removed">4011 void os::make_polling_page_unreadable(void) {</span>
<span class="line-removed">4012   Events::log(NULL, &quot;Protecting polling page &quot; INTPTR_FORMAT &quot; with PROT_NONE&quot;, p2i(_polling_page));</span>
<span class="line-removed">4013   if (mprotect((char *)_polling_page, page_size, PROT_NONE) != 0) {</span>
<span class="line-removed">4014     fatal(&quot;Could not disable polling page&quot;);</span>
<span class="line-removed">4015   }</span>
<span class="line-removed">4016 }</span>
<span class="line-removed">4017 </span>
<span class="line-removed">4018 // Mark the polling page as readable</span>
<span class="line-removed">4019 void os::make_polling_page_readable(void) {</span>
<span class="line-removed">4020   Events::log(NULL, &quot;Protecting polling page &quot; INTPTR_FORMAT &quot; with PROT_READ&quot;, p2i(_polling_page));</span>
<span class="line-removed">4021   if (mprotect((char *)_polling_page, page_size, PROT_READ) != 0) {</span>
<span class="line-removed">4022     fatal(&quot;Could not enable polling page&quot;);</span>
<span class="line-removed">4023   }</span>
<span class="line-removed">4024 }</span>
<span class="line-removed">4025 </span>
4026 // Is a (classpath) directory empty?
4027 bool os::dir_is_empty(const char* path) {
4028   DIR *dir = NULL;
4029   struct dirent *ptr;
4030 
4031   dir = opendir(path);
4032   if (dir == NULL) return true;
4033 
4034   // Scan the directory
4035   bool result = true;
4036   while (result &amp;&amp; (ptr = readdir(dir)) != NULL) {
4037     if (strcmp(ptr-&gt;d_name, &quot;.&quot;) != 0 &amp;&amp; strcmp(ptr-&gt;d_name, &quot;..&quot;) != 0) {
4038       result = false;
4039     }
4040   }
4041   closedir(dir);
4042   return result;
4043 }
4044 
4045 // This code originates from JDK&#39;s sysOpen and open64_w
4046 // from src/solaris/hpi/src/system_md.c
4047 
4048 int os::open(const char *path, int oflag, int mode) {
4049   if (strlen(path) &gt; MAX_PATH - 1) {
4050     errno = ENAMETOOLONG;
4051     return -1;
4052   }
4053   int fd;
4054 
4055   fd = ::open64(path, oflag, mode);
4056   if (fd == -1) return -1;
4057 
4058   // If the open succeeded, the file might still be a directory
4059   {
4060     struct stat64 buf64;
4061     int ret = ::fstat64(fd, &amp;buf64);
4062     int st_mode = buf64.st_mode;
4063 
4064     if (ret != -1) {
4065       if ((st_mode &amp; S_IFMT) == S_IFDIR) {
4066         errno = EISDIR;
4067         ::close(fd);
4068         return -1;
4069       }
4070     } else {
4071       ::close(fd);
4072       return -1;
4073     }
4074   }
4075 
4076   // 32-bit Solaris systems suffer from:
4077   //
4078   // - an historical default soft limit of 256 per-process file
4079   //   descriptors that is too low for many Java programs.
4080   //
4081   // - a design flaw where file descriptors created using stdio
4082   //   fopen must be less than 256, _even_ when the first limit above
4083   //   has been raised.  This can cause calls to fopen (but not calls to
4084   //   open, for example) to fail mysteriously, perhaps in 3rd party
4085   //   native code (although the JDK itself uses fopen).  One can hardly
4086   //   criticize them for using this most standard of all functions.
4087   //
4088   // We attempt to make everything work anyways by:
4089   //
4090   // - raising the soft limit on per-process file descriptors beyond
4091   //   256
4092   //
4093   // - As of Solaris 10u4, we can request that Solaris raise the 256
4094   //   stdio fopen limit by calling function enable_extended_FILE_stdio.
4095   //   This is done in init_2 and recorded in enabled_extended_FILE_stdio
4096   //
4097   // - If we are stuck on an old (pre 10u4) Solaris system, we can
4098   //   workaround the bug by remapping non-stdio file descriptors below
4099   //   256 to ones beyond 256, which is done below.
4100   //
4101   // See:
4102   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
4103   // 6533291: Work around 32-bit Solaris stdio limit of 256 open files
4104   // 6431278: Netbeans crash on 32 bit Solaris: need to call
4105   //          enable_extended_FILE_stdio() in VM initialisation
4106   // Giri Mandalika&#39;s blog
4107   // http://technopark02.blogspot.com/2005_05_01_archive.html
4108   //
4109 #ifndef  _LP64
4110   if ((!enabled_extended_FILE_stdio) &amp;&amp; fd &lt; 256) {
4111     int newfd = ::fcntl(fd, F_DUPFD, 256);
4112     if (newfd != -1) {
4113       ::close(fd);
4114       fd = newfd;
4115     }
4116   }
4117 #endif // 32-bit Solaris
4118 
4119   // All file descriptors that are opened in the JVM and not
4120   // specifically destined for a subprocess should have the
4121   // close-on-exec flag set.  If we don&#39;t set it, then careless 3rd
4122   // party native code might fork and exec without closing all
4123   // appropriate file descriptors (e.g. as we do in closeDescriptors in
4124   // UNIXProcess.c), and this in turn might:
4125   //
4126   // - cause end-of-file to fail to be detected on some file
4127   //   descriptors, resulting in mysterious hangs, or
4128   //
4129   // - might cause an fopen in the subprocess to fail on a system
4130   //   suffering from bug 1085341.
4131   //
4132   // (Yes, the default setting of the close-on-exec flag is a Unix
4133   // design flaw)
4134   //
4135   // See:
4136   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
4137   // 4843136: (process) pipe file descriptor from Runtime.exec not being closed
4138   // 6339493: (process) Runtime.exec does not close all file descriptors on Solaris 9
4139   //
4140 #ifdef FD_CLOEXEC
4141   {
4142     int flags = ::fcntl(fd, F_GETFD);
4143     if (flags != -1) {
4144       ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);
4145     }
4146   }
4147 #endif
4148 
4149   return fd;
4150 }
4151 
4152 // create binary file, rewriting existing file if required
4153 int os::create_binary_file(const char* path, bool rewrite_existing) {
4154   int oflags = O_WRONLY | O_CREAT;
4155   if (!rewrite_existing) {
4156     oflags |= O_EXCL;
4157   }
4158   return ::open64(path, oflags, S_IREAD | S_IWRITE);
4159 }
4160 
4161 // return current position of file pointer
4162 jlong os::current_file_offset(int fd) {
4163   return (jlong)::lseek64(fd, (off64_t)0, SEEK_CUR);
4164 }
4165 
4166 // move file pointer to the specified offset
4167 jlong os::seek_to_file_offset(int fd, jlong offset) {
4168   return (jlong)::lseek64(fd, (off64_t)offset, SEEK_SET);
4169 }
4170 
4171 jlong os::lseek(int fd, jlong offset, int whence) {
4172   return (jlong) ::lseek64(fd, offset, whence);
4173 }
4174 
4175 int os::ftruncate(int fd, jlong length) {
4176   return ::ftruncate64(fd, length);
4177 }
4178 
4179 int os::fsync(int fd)  {
4180   RESTARTABLE_RETURN_INT(::fsync(fd));
4181 }
4182 
4183 int os::available(int fd, jlong *bytes) {
4184   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
4185          &quot;Assumed _thread_in_native&quot;);
4186   jlong cur, end;
4187   int mode;
4188   struct stat64 buf64;
4189 
4190   if (::fstat64(fd, &amp;buf64) &gt;= 0) {
4191     mode = buf64.st_mode;
4192     if (S_ISCHR(mode) || S_ISFIFO(mode) || S_ISSOCK(mode)) {
4193       int n,ioctl_return;
4194 
4195       RESTARTABLE(::ioctl(fd, FIONREAD, &amp;n), ioctl_return);
4196       if (ioctl_return&gt;= 0) {
4197         *bytes = n;
4198         return 1;
4199       }
4200     }
4201   }
4202   if ((cur = ::lseek64(fd, 0L, SEEK_CUR)) == -1) {
4203     return 0;
4204   } else if ((end = ::lseek64(fd, 0L, SEEK_END)) == -1) {
4205     return 0;
4206   } else if (::lseek64(fd, cur, SEEK_SET) == -1) {
4207     return 0;
4208   }
4209   *bytes = end - cur;
4210   return 1;
4211 }
4212 
4213 // Map a block of memory.
4214 char* os::pd_map_memory(int fd, const char* file_name, size_t file_offset,
4215                         char *addr, size_t bytes, bool read_only,
4216                         bool allow_exec) {
4217   int prot;
4218   int flags;
4219 
4220   if (read_only) {
4221     prot = PROT_READ;
4222     flags = MAP_SHARED;
4223   } else {
4224     prot = PROT_READ | PROT_WRITE;
4225     flags = MAP_PRIVATE;
4226   }
4227 
4228   if (allow_exec) {
4229     prot |= PROT_EXEC;
4230   }
4231 
4232   if (addr != NULL) {
4233     flags |= MAP_FIXED;
4234   }
4235 
4236   char* mapped_address = (char*)mmap(addr, (size_t)bytes, prot, flags,
4237                                      fd, file_offset);
4238   if (mapped_address == MAP_FAILED) {
4239     return NULL;
4240   }
4241   return mapped_address;
4242 }
4243 
4244 
4245 // Remap a block of memory.
4246 char* os::pd_remap_memory(int fd, const char* file_name, size_t file_offset,
4247                           char *addr, size_t bytes, bool read_only,
4248                           bool allow_exec) {
4249   // same as map_memory() on this OS
4250   return os::map_memory(fd, file_name, file_offset, addr, bytes, read_only,
4251                         allow_exec);
4252 }
4253 
4254 
4255 // Unmap a block of memory.
4256 bool os::pd_unmap_memory(char* addr, size_t bytes) {
4257   return munmap(addr, bytes) == 0;
4258 }
4259 
4260 void os::pause() {
4261   char filename[MAX_PATH];
4262   if (PauseAtStartupFile &amp;&amp; PauseAtStartupFile[0]) {
4263     jio_snprintf(filename, MAX_PATH, &quot;%s&quot;, PauseAtStartupFile);
4264   } else {
4265     jio_snprintf(filename, MAX_PATH, &quot;./vm.paused.%d&quot;, current_process_id());
4266   }
4267 
4268   int fd = ::open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0666);
4269   if (fd != -1) {
4270     struct stat buf;
4271     ::close(fd);
4272     while (::stat(filename, &amp;buf) == 0) {
4273       (void)::poll(NULL, 0, 100);
4274     }
4275   } else {
4276     jio_fprintf(stderr,
4277                 &quot;Could not open pause file &#39;%s&#39;, continuing immediately.\n&quot;, filename);
4278   }
4279 }
4280 
4281 #ifndef PRODUCT
4282 #ifdef INTERPOSE_ON_SYSTEM_SYNCH_FUNCTIONS
4283 // Turn this on if you need to trace synch operations.
4284 // Set RECORD_SYNCH_LIMIT to a large-enough value,
4285 // and call record_synch_enable and record_synch_disable
4286 // around the computation of interest.
4287 
4288 void record_synch(char* name, bool returning);  // defined below
4289 
4290 class RecordSynch {
4291   char* _name;
4292  public:
4293   RecordSynch(char* name) :_name(name) { record_synch(_name, false); }
4294   ~RecordSynch()                       { record_synch(_name, true); }
4295 };
4296 
4297 #define CHECK_SYNCH_OP(ret, name, params, args, inner)          \
4298 extern &quot;C&quot; ret name params {                                    \
4299   typedef ret name##_t params;                                  \
4300   static name##_t* implem = NULL;                               \
4301   static int callcount = 0;                                     \
4302   if (implem == NULL) {                                         \
4303     implem = (name##_t*) dlsym(RTLD_NEXT, #name);               \
4304     if (implem == NULL)  fatal(dlerror());                      \
4305   }                                                             \
4306   ++callcount;                                                  \
4307   RecordSynch _rs(#name);                                       \
4308   inner;                                                        \
4309   return implem args;                                           \
4310 }
4311 // in dbx, examine callcounts this way:
4312 // for n in $(eval whereis callcount | awk &#39;{print $2}&#39;); do print $n; done
4313 
4314 #define CHECK_POINTER_OK(p) \
4315   (!Universe::is_fully_initialized() || !Universe::is_reserved_heap((oop)(p)))
4316 #define CHECK_MU \
4317   if (!CHECK_POINTER_OK(mu)) fatal(&quot;Mutex must be in C heap only.&quot;);
4318 #define CHECK_CV \
4319   if (!CHECK_POINTER_OK(cv)) fatal(&quot;Condvar must be in C heap only.&quot;);
4320 #define CHECK_P(p) \
4321   if (!CHECK_POINTER_OK(p))  fatal(false,  &quot;Pointer must be in C heap only.&quot;);
4322 
4323 #define CHECK_MUTEX(mutex_op) \
4324   CHECK_SYNCH_OP(int, mutex_op, (mutex_t *mu), (mu), CHECK_MU);
4325 
4326 CHECK_MUTEX(   mutex_lock)
4327 CHECK_MUTEX(  _mutex_lock)
4328 CHECK_MUTEX( mutex_unlock)
4329 CHECK_MUTEX(_mutex_unlock)
4330 CHECK_MUTEX( mutex_trylock)
4331 CHECK_MUTEX(_mutex_trylock)
4332 
4333 #define CHECK_COND(cond_op) \
4334   CHECK_SYNCH_OP(int, cond_op, (cond_t *cv, mutex_t *mu), (cv, mu), CHECK_MU; CHECK_CV);
4335 
4336 CHECK_COND( cond_wait);
4337 CHECK_COND(_cond_wait);
4338 CHECK_COND(_cond_wait_cancel);
4339 
4340 #define CHECK_COND2(cond_op) \
4341   CHECK_SYNCH_OP(int, cond_op, (cond_t *cv, mutex_t *mu, timestruc_t* ts), (cv, mu, ts), CHECK_MU; CHECK_CV);
4342 
4343 CHECK_COND2( cond_timedwait);
4344 CHECK_COND2(_cond_timedwait);
4345 CHECK_COND2(_cond_timedwait_cancel);
4346 
4347 // do the _lwp_* versions too
4348 #define mutex_t lwp_mutex_t
4349 #define cond_t  lwp_cond_t
4350 CHECK_MUTEX(  _lwp_mutex_lock)
4351 CHECK_MUTEX(  _lwp_mutex_unlock)
4352 CHECK_MUTEX(  _lwp_mutex_trylock)
4353 CHECK_MUTEX( __lwp_mutex_lock)
4354 CHECK_MUTEX( __lwp_mutex_unlock)
4355 CHECK_MUTEX( __lwp_mutex_trylock)
4356 CHECK_MUTEX(___lwp_mutex_lock)
4357 CHECK_MUTEX(___lwp_mutex_unlock)
4358 
4359 CHECK_COND(  _lwp_cond_wait);
4360 CHECK_COND( __lwp_cond_wait);
4361 CHECK_COND(___lwp_cond_wait);
4362 
4363 CHECK_COND2(  _lwp_cond_timedwait);
4364 CHECK_COND2( __lwp_cond_timedwait);
4365 #undef mutex_t
4366 #undef cond_t
4367 
4368 CHECK_SYNCH_OP(int, _lwp_suspend2,       (int lwp, int *n), (lwp, n), 0);
4369 CHECK_SYNCH_OP(int,__lwp_suspend2,       (int lwp, int *n), (lwp, n), 0);
4370 CHECK_SYNCH_OP(int, _lwp_kill,           (int lwp, int n),  (lwp, n), 0);
4371 CHECK_SYNCH_OP(int,__lwp_kill,           (int lwp, int n),  (lwp, n), 0);
4372 CHECK_SYNCH_OP(int, _lwp_sema_wait,      (lwp_sema_t* p),   (p),  CHECK_P(p));
4373 CHECK_SYNCH_OP(int,__lwp_sema_wait,      (lwp_sema_t* p),   (p),  CHECK_P(p));
4374 CHECK_SYNCH_OP(int, _lwp_cond_broadcast, (lwp_cond_t* cv),  (cv), CHECK_CV);
4375 CHECK_SYNCH_OP(int,__lwp_cond_broadcast, (lwp_cond_t* cv),  (cv), CHECK_CV);
4376 
4377 
4378 // recording machinery:
4379 
4380 enum { RECORD_SYNCH_LIMIT = 200 };
4381 char* record_synch_name[RECORD_SYNCH_LIMIT];
4382 void* record_synch_arg0ptr[RECORD_SYNCH_LIMIT];
4383 bool record_synch_returning[RECORD_SYNCH_LIMIT];
4384 thread_t record_synch_thread[RECORD_SYNCH_LIMIT];
4385 int record_synch_count = 0;
4386 bool record_synch_enabled = false;
4387 
4388 // in dbx, examine recorded data this way:
4389 // for n in name arg0ptr returning thread; do print record_synch_$n[0..record_synch_count-1]; done
4390 
4391 void record_synch(char* name, bool returning) {
4392   if (record_synch_enabled) {
4393     if (record_synch_count &lt; RECORD_SYNCH_LIMIT) {
4394       record_synch_name[record_synch_count] = name;
4395       record_synch_returning[record_synch_count] = returning;
4396       record_synch_thread[record_synch_count] = thr_self();
4397       record_synch_arg0ptr[record_synch_count] = &amp;name;
4398       record_synch_count++;
4399     }
4400     // put more checking code here:
4401     // ...
4402   }
4403 }
4404 
4405 void record_synch_enable() {
4406   // start collecting trace data, if not already doing so
4407   if (!record_synch_enabled)  record_synch_count = 0;
4408   record_synch_enabled = true;
4409 }
4410 
4411 void record_synch_disable() {
4412   // stop collecting trace data
4413   record_synch_enabled = false;
4414 }
4415 
4416 #endif // INTERPOSE_ON_SYSTEM_SYNCH_FUNCTIONS
4417 #endif // PRODUCT
4418 
4419 const intptr_t thr_time_off  = (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_utime);
4420 const intptr_t thr_time_size = (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_ttime) -
4421                                (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_utime);
4422 
4423 
4424 // JVMTI &amp; JVM monitoring and management support
4425 // The thread_cpu_time() and current_thread_cpu_time() are only
4426 // supported if is_thread_cpu_time_supported() returns true.
4427 // They are not supported on Solaris T1.
4428 
4429 // current_thread_cpu_time(bool) and thread_cpu_time(Thread*, bool)
4430 // are used by JVM M&amp;M and JVMTI to get user+sys or user CPU time
4431 // of a thread.
4432 //
4433 // current_thread_cpu_time() and thread_cpu_time(Thread *)
4434 // returns the fast estimate available on the platform.
4435 
4436 // hrtime_t gethrvtime() return value includes
4437 // user time but does not include system time
4438 jlong os::current_thread_cpu_time() {
4439   return (jlong) gethrvtime();
4440 }
4441 
4442 jlong os::thread_cpu_time(Thread *thread) {
4443   // return user level CPU time only to be consistent with
4444   // what current_thread_cpu_time returns.
4445   // thread_cpu_time_info() must be changed if this changes
4446   return os::thread_cpu_time(thread, false /* user time only */);
4447 }
4448 
4449 jlong os::current_thread_cpu_time(bool user_sys_cpu_time) {
4450   if (user_sys_cpu_time) {
4451     return os::thread_cpu_time(Thread::current(), user_sys_cpu_time);
4452   } else {
4453     return os::current_thread_cpu_time();
4454   }
4455 }
4456 
4457 jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
4458   char proc_name[64];
4459   int count;
4460   prusage_t prusage;
4461   jlong lwp_time;
4462   int fd;
4463 
4464   sprintf(proc_name, &quot;/proc/%d/lwp/%d/lwpusage&quot;,
4465           getpid(),
4466           thread-&gt;osthread()-&gt;lwp_id());
4467   fd = ::open(proc_name, O_RDONLY);
4468   if (fd == -1) return -1;
4469 
4470   do {
4471     count = ::pread(fd,
4472                     (void *)&amp;prusage.pr_utime,
4473                     thr_time_size,
4474                     thr_time_off);
4475   } while (count &lt; 0 &amp;&amp; errno == EINTR);
4476   ::close(fd);
4477   if (count &lt; 0) return -1;
4478 
4479   if (user_sys_cpu_time) {
4480     // user + system CPU time
4481     lwp_time = (((jlong)prusage.pr_stime.tv_sec +
4482                  (jlong)prusage.pr_utime.tv_sec) * (jlong)1000000000) +
4483                  (jlong)prusage.pr_stime.tv_nsec +
4484                  (jlong)prusage.pr_utime.tv_nsec;
4485   } else {
4486     // user level CPU time only
4487     lwp_time = ((jlong)prusage.pr_utime.tv_sec * (jlong)1000000000) +
4488                 (jlong)prusage.pr_utime.tv_nsec;
4489   }
4490 
4491   return (lwp_time);
4492 }
4493 
4494 void os::current_thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
4495   info_ptr-&gt;max_value = ALL_64_BITS;      // will not wrap in less than 64 bits
4496   info_ptr-&gt;may_skip_backward = false;    // elapsed time not wall time
4497   info_ptr-&gt;may_skip_forward = false;     // elapsed time not wall time
4498   info_ptr-&gt;kind = JVMTI_TIMER_USER_CPU;  // only user time is returned
4499 }
4500 
4501 void os::thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
4502   info_ptr-&gt;max_value = ALL_64_BITS;      // will not wrap in less than 64 bits
4503   info_ptr-&gt;may_skip_backward = false;    // elapsed time not wall time
4504   info_ptr-&gt;may_skip_forward = false;     // elapsed time not wall time
4505   info_ptr-&gt;kind = JVMTI_TIMER_USER_CPU;  // only user time is returned
4506 }
4507 
4508 bool os::is_thread_cpu_time_supported() {
4509   return true;
4510 }
4511 
4512 // System loadavg support.  Returns -1 if load average cannot be obtained.
4513 // Return the load average for our processor set if the primitive exists
4514 // (Solaris 9 and later).  Otherwise just return system wide loadavg.
4515 int os::loadavg(double loadavg[], int nelem) {
4516   if (pset_getloadavg_ptr != NULL) {
4517     return (*pset_getloadavg_ptr)(PS_MYID, loadavg, nelem);
4518   } else {
4519     return ::getloadavg(loadavg, nelem);
4520   }
4521 }
4522 
4523 //---------------------------------------------------------------------------------
4524 
4525 bool os::find(address addr, outputStream* st) {
4526   Dl_info dlinfo;
4527   memset(&amp;dlinfo, 0, sizeof(dlinfo));
4528   if (dladdr(addr, &amp;dlinfo) != 0) {
4529     st-&gt;print(PTR_FORMAT &quot;: &quot;, addr);
4530     if (dlinfo.dli_sname != NULL &amp;&amp; dlinfo.dli_saddr != NULL) {
4531       st-&gt;print(&quot;%s+%#lx&quot;, dlinfo.dli_sname, addr-(intptr_t)dlinfo.dli_saddr);
4532     } else if (dlinfo.dli_fbase != NULL) {
4533       st-&gt;print(&quot;&lt;offset %#lx&gt;&quot;, addr-(intptr_t)dlinfo.dli_fbase);
4534     } else {
4535       st-&gt;print(&quot;&lt;absolute address&gt;&quot;);
4536     }
4537     if (dlinfo.dli_fname != NULL) {
4538       st-&gt;print(&quot; in %s&quot;, dlinfo.dli_fname);
4539     }
4540     if (dlinfo.dli_fbase != NULL) {
4541       st-&gt;print(&quot; at &quot; PTR_FORMAT, dlinfo.dli_fbase);
4542     }
4543     st-&gt;cr();
4544 
4545     if (Verbose) {
4546       // decode some bytes around the PC
4547       address begin = clamp_address_in_page(addr-40, addr, os::vm_page_size());
4548       address end   = clamp_address_in_page(addr+40, addr, os::vm_page_size());
4549       address       lowest = (address) dlinfo.dli_sname;
4550       if (!lowest)  lowest = (address) dlinfo.dli_fbase;
4551       if (begin &lt; lowest)  begin = lowest;
4552       Dl_info dlinfo2;
4553       if (dladdr(end, &amp;dlinfo2) != 0 &amp;&amp; dlinfo2.dli_saddr != dlinfo.dli_saddr
4554           &amp;&amp; end &gt; dlinfo2.dli_saddr &amp;&amp; dlinfo2.dli_saddr &gt; begin) {
4555         end = (address) dlinfo2.dli_saddr;
4556       }
4557       Disassembler::decode(begin, end, st);
4558     }
4559     return true;
4560   }
4561   return false;
4562 }
4563 
4564 // Following function has been added to support HotSparc&#39;s libjvm.so running
4565 // under Solaris production JDK 1.2.2 / 1.3.0.  These came from
4566 // src/solaris/hpi/native_threads in the EVM codebase.
4567 //
4568 // NOTE: This is no longer needed in the 1.3.1 and 1.4 production release
4569 // libraries and should thus be removed. We will leave it behind for a while
4570 // until we no longer want to able to run on top of 1.3.0 Solaris production
4571 // JDK. See 4341971.
4572 
4573 #define STACK_SLACK 0x800
4574 
4575 extern &quot;C&quot; {
4576   intptr_t sysThreadAvailableStackWithSlack() {
4577     stack_t st;
4578     intptr_t retval, stack_top;
4579     retval = thr_stksegment(&amp;st);
4580     assert(retval == 0, &quot;incorrect return value from thr_stksegment&quot;);
4581     assert((address)&amp;st &lt; (address)st.ss_sp, &quot;Invalid stack base returned&quot;);
4582     assert((address)&amp;st &gt; (address)st.ss_sp-st.ss_size, &quot;Invalid stack size returned&quot;);
4583     stack_top=(intptr_t)st.ss_sp-st.ss_size;
4584     return ((intptr_t)&amp;stack_top - stack_top - STACK_SLACK);
4585   }
4586 }
4587 
4588 // ObjectMonitor park-unpark infrastructure ...
4589 //
4590 // We implement Solaris and Linux PlatformEvents with the
4591 // obvious condvar-mutex-flag triple.
4592 // Another alternative that works quite well is pipes:
4593 // Each PlatformEvent consists of a pipe-pair.
4594 // The thread associated with the PlatformEvent
4595 // calls park(), which reads from the input end of the pipe.
4596 // Unpark() writes into the other end of the pipe.
4597 // The write-side of the pipe must be set NDELAY.
4598 // Unfortunately pipes consume a large # of handles.
4599 // Native solaris lwp_park() and lwp_unpark() work nicely, too.
4600 // Using pipes for the 1st few threads might be workable, however.
4601 //
4602 // park() is permitted to return spuriously.
4603 // Callers of park() should wrap the call to park() in
4604 // an appropriate loop.  A litmus test for the correct
4605 // usage of park is the following: if park() were modified
4606 // to immediately return 0 your code should still work,
4607 // albeit degenerating to a spin loop.
4608 //
4609 // In a sense, park()-unpark() just provides more polite spinning
4610 // and polling with the key difference over naive spinning being
4611 // that a parked thread needs to be explicitly unparked() in order
4612 // to wake up and to poll the underlying condition.
4613 //
4614 // Assumption:
4615 //    Only one parker can exist on an event, which is why we allocate
4616 //    them per-thread. Multiple unparkers can coexist.
4617 //
4618 // _Event transitions in park()
4619 //   -1 =&gt; -1 : illegal
4620 //    1 =&gt;  0 : pass - return immediately
4621 //    0 =&gt; -1 : block; then set _Event to 0 before returning
4622 //
4623 // _Event transitions in unpark()
4624 //    0 =&gt; 1 : just return
4625 //    1 =&gt; 1 : just return
4626 //   -1 =&gt; either 0 or 1; must signal target thread
4627 //         That is, we can safely transition _Event from -1 to either
4628 //         0 or 1.
4629 //
4630 // _Event serves as a restricted-range semaphore.
4631 //   -1 : thread is blocked, i.e. there is a waiter
4632 //    0 : neutral: thread is running or ready,
4633 //        could have been signaled after a wait started
4634 //    1 : signaled - thread is running or ready
4635 //
4636 // Another possible encoding of _Event would be with
4637 // explicit &quot;PARKED&quot; == 01b and &quot;SIGNALED&quot; == 10b bits.
4638 //
4639 // TODO-FIXME: add DTRACE probes for:
4640 // 1.   Tx parks
4641 // 2.   Ty unparks Tx
4642 // 3.   Tx resumes from park
4643 
4644 
4645 // value determined through experimentation
4646 #define ROUNDINGFIX 11
4647 
4648 // utility to compute the abstime argument to timedwait.
4649 // TODO-FIXME: switch from compute_abstime() to unpackTime().
4650 
4651 static timestruc_t* compute_abstime(timestruc_t* abstime, jlong millis) {
4652   // millis is the relative timeout time
4653   // abstime will be the absolute timeout time
4654   if (millis &lt; 0)  millis = 0;
4655   struct timeval now;
4656   int status = gettimeofday(&amp;now, NULL);
4657   assert(status == 0, &quot;gettimeofday&quot;);
4658   jlong seconds = millis / 1000;
4659   jlong max_wait_period;
4660 
4661   if (UseLWPSynchronization) {
4662     // forward port of fix for 4275818 (not sleeping long enough)
4663     // There was a bug in Solaris 6, 7 and pre-patch 5 of 8 where
4664     // _lwp_cond_timedwait() used a round_down algorithm rather
4665     // than a round_up. For millis less than our roundfactor
4666     // it rounded down to 0 which doesn&#39;t meet the spec.
4667     // For millis &gt; roundfactor we may return a bit sooner, but
4668     // since we can not accurately identify the patch level and
4669     // this has already been fixed in Solaris 9 and 8 we will
4670     // leave it alone rather than always rounding down.
4671 
4672     if (millis &gt; 0 &amp;&amp; millis &lt; ROUNDINGFIX) millis = ROUNDINGFIX;
4673     // It appears that when we go directly through Solaris _lwp_cond_timedwait()
4674     // the acceptable max time threshold is smaller than for libthread on 2.5.1 and 2.6
4675     max_wait_period = 21000000;
4676   } else {
4677     max_wait_period = 50000000;
4678   }
4679   millis %= 1000;
4680   if (seconds &gt; max_wait_period) {      // see man cond_timedwait(3T)
4681     seconds = max_wait_period;
4682   }
4683   abstime-&gt;tv_sec = now.tv_sec  + seconds;
4684   long       usec = now.tv_usec + millis * 1000;
4685   if (usec &gt;= 1000000) {
4686     abstime-&gt;tv_sec += 1;
4687     usec -= 1000000;
4688   }
4689   abstime-&gt;tv_nsec = usec * 1000;
4690   return abstime;
4691 }
4692 
4693 void os::PlatformEvent::park() {           // AKA: down()
4694   // Transitions for _Event:
4695   //   -1 =&gt; -1 : illegal
4696   //    1 =&gt;  0 : pass - return immediately
4697   //    0 =&gt; -1 : block; then set _Event to 0 before returning
4698 
4699   // Invariant: Only the thread associated with the Event/PlatformEvent
4700   // may call park().
4701   assert(_nParked == 0, &quot;invariant&quot;);
4702 
4703   int v;
4704   for (;;) {
4705     v = _Event;
4706     if (Atomic::cmpxchg(&amp;_Event, v, v-1) == v) break;
4707   }
4708   guarantee(v &gt;= 0, &quot;invariant&quot;);
4709   if (v == 0) {
4710     // Do this the hard way by blocking ...
4711     // See http://monaco.sfbay/detail.jsf?cr=5094058.
4712     int status = os::Solaris::mutex_lock(_mutex);
4713     assert_status(status == 0, status, &quot;mutex_lock&quot;);
4714     guarantee(_nParked == 0, &quot;invariant&quot;);
4715     ++_nParked;
4716     while (_Event &lt; 0) {
4717       // for some reason, under 2.7 lwp_cond_wait() may return ETIME ...
4718       // Treat this the same as if the wait was interrupted
4719       // With usr/lib/lwp going to kernel, always handle ETIME
4720       status = os::Solaris::cond_wait(_cond, _mutex);
4721       if (status == ETIME) status = EINTR;
4722       assert_status(status == 0 || status == EINTR, status, &quot;cond_wait&quot;);
4723     }
4724     --_nParked;
4725     _Event = 0;
4726     status = os::Solaris::mutex_unlock(_mutex);
4727     assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4728     // Paranoia to ensure our locked and lock-free paths interact
4729     // correctly with each other.
4730     OrderAccess::fence();
4731   }
4732 }
4733 
4734 int os::PlatformEvent::park(jlong millis) {
4735   // Transitions for _Event:
4736   //   -1 =&gt; -1 : illegal
4737   //    1 =&gt;  0 : pass - return immediately
4738   //    0 =&gt; -1 : block; then set _Event to 0 before returning
4739 
4740   guarantee(_nParked == 0, &quot;invariant&quot;);
4741   int v;
4742   for (;;) {
4743     v = _Event;
4744     if (Atomic::cmpxchg(&amp;_Event, v, v-1) == v) break;
4745   }
4746   guarantee(v &gt;= 0, &quot;invariant&quot;);
4747   if (v != 0) return OS_OK;
4748 
4749   int ret = OS_TIMEOUT;
4750   timestruc_t abst;
4751   compute_abstime(&amp;abst, millis);
4752 
4753   // See http://monaco.sfbay/detail.jsf?cr=5094058.
4754   int status = os::Solaris::mutex_lock(_mutex);
4755   assert_status(status == 0, status, &quot;mutex_lock&quot;);
4756   guarantee(_nParked == 0, &quot;invariant&quot;);
4757   ++_nParked;
4758   while (_Event &lt; 0) {
4759     int status = os::Solaris::cond_timedwait(_cond, _mutex, &amp;abst);
4760     assert_status(status == 0 || status == EINTR ||
4761                   status == ETIME || status == ETIMEDOUT,
4762                   status, &quot;cond_timedwait&quot;);
4763     if (!FilterSpuriousWakeups) break;                // previous semantics
4764     if (status == ETIME || status == ETIMEDOUT) break;
4765     // We consume and ignore EINTR and spurious wakeups.
4766   }
4767   --_nParked;
4768   if (_Event &gt;= 0) ret = OS_OK;
4769   _Event = 0;
4770   status = os::Solaris::mutex_unlock(_mutex);
4771   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4772   // Paranoia to ensure our locked and lock-free paths interact
4773   // correctly with each other.
4774   OrderAccess::fence();
4775   return ret;
4776 }
4777 
4778 void os::PlatformEvent::unpark() {
4779   // Transitions for _Event:
4780   //    0 =&gt; 1 : just return
4781   //    1 =&gt; 1 : just return
4782   //   -1 =&gt; either 0 or 1; must signal target thread
4783   //         That is, we can safely transition _Event from -1 to either
4784   //         0 or 1.
4785   // See also: &quot;Semaphores in Plan 9&quot; by Mullender &amp; Cox
4786   //
4787   // Note: Forcing a transition from &quot;-1&quot; to &quot;1&quot; on an unpark() means
4788   // that it will take two back-to-back park() calls for the owning
4789   // thread to block. This has the benefit of forcing a spurious return
4790   // from the first park() call after an unpark() call which will help
4791   // shake out uses of park() and unpark() without condition variables.
4792 
4793   if (Atomic::xchg(&amp;_Event, 1) &gt;= 0) return;
4794 
4795   // If the thread associated with the event was parked, wake it.
4796   // Wait for the thread assoc with the PlatformEvent to vacate.
4797   int status = os::Solaris::mutex_lock(_mutex);
4798   assert_status(status == 0, status, &quot;mutex_lock&quot;);
4799   int AnyWaiters = _nParked;
4800   status = os::Solaris::mutex_unlock(_mutex);
4801   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4802   guarantee(AnyWaiters == 0 || AnyWaiters == 1, &quot;invariant&quot;);
4803   if (AnyWaiters != 0) {
4804     // Note that we signal() *after* dropping the lock for &quot;immortal&quot; Events.
4805     // This is safe and avoids a common class of  futile wakeups.  In rare
4806     // circumstances this can cause a thread to return prematurely from
4807     // cond_{timed}wait() but the spurious wakeup is benign and the victim
4808     // will simply re-test the condition and re-park itself.
4809     // This provides particular benefit if the underlying platform does not
4810     // provide wait morphing.
4811     status = os::Solaris::cond_signal(_cond);
4812     assert_status(status == 0, status, &quot;cond_signal&quot;);
4813   }
4814 }
4815 
4816 // JSR166
4817 // -------------------------------------------------------
4818 
4819 // The solaris and linux implementations of park/unpark are fairly
4820 // conservative for now, but can be improved. They currently use a
4821 // mutex/condvar pair, plus _counter.
4822 // Park decrements _counter if &gt; 0, else does a condvar wait.  Unpark
4823 // sets count to 1 and signals condvar.  Only one thread ever waits
4824 // on the condvar. Contention seen when trying to park implies that someone
4825 // is unparking you, so don&#39;t wait. And spurious returns are fine, so there
4826 // is no need to track notifications.
4827 
4828 #define MAX_SECS 100000000
4829 
4830 // This code is common to linux and solaris and will be moved to a
4831 // common place in dolphin.
4832 //
4833 // The passed in time value is either a relative time in nanoseconds
4834 // or an absolute time in milliseconds. Either way it has to be unpacked
4835 // into suitable seconds and nanoseconds components and stored in the
4836 // given timespec structure.
4837 // Given time is a 64-bit value and the time_t used in the timespec is only
4838 // a signed-32-bit value (except on 64-bit Linux) we have to watch for
4839 // overflow if times way in the future are given. Further on Solaris versions
4840 // prior to 10 there is a restriction (see cond_timedwait) that the specified
4841 // number of seconds, in abstime, is less than current_time  + 100,000,000.
4842 // As it will be 28 years before &quot;now + 100000000&quot; will overflow we can
4843 // ignore overflow and just impose a hard-limit on seconds using the value
4844 // of &quot;now + 100,000,000&quot;. This places a limit on the timeout of about 3.17
4845 // years from &quot;now&quot;.
4846 //
4847 static void unpackTime(timespec* absTime, bool isAbsolute, jlong time) {
4848   assert(time &gt; 0, &quot;convertTime&quot;);
4849 
4850   struct timeval now;
4851   int status = gettimeofday(&amp;now, NULL);
4852   assert(status == 0, &quot;gettimeofday&quot;);
4853 
4854   time_t max_secs = now.tv_sec + MAX_SECS;
4855 
4856   if (isAbsolute) {
4857     jlong secs = time / 1000;
4858     if (secs &gt; max_secs) {
4859       absTime-&gt;tv_sec = max_secs;
4860     } else {
4861       absTime-&gt;tv_sec = secs;
4862     }
4863     absTime-&gt;tv_nsec = (time % 1000) * NANOSECS_PER_MILLISEC;
4864   } else {
4865     jlong secs = time / NANOSECS_PER_SEC;
4866     if (secs &gt;= MAX_SECS) {
4867       absTime-&gt;tv_sec = max_secs;
4868       absTime-&gt;tv_nsec = 0;
4869     } else {
4870       absTime-&gt;tv_sec = now.tv_sec + secs;
4871       absTime-&gt;tv_nsec = (time % NANOSECS_PER_SEC) + now.tv_usec*1000;
4872       if (absTime-&gt;tv_nsec &gt;= NANOSECS_PER_SEC) {
4873         absTime-&gt;tv_nsec -= NANOSECS_PER_SEC;
4874         ++absTime-&gt;tv_sec; // note: this must be &lt;= max_secs
4875       }
4876     }
4877   }
4878   assert(absTime-&gt;tv_sec &gt;= 0, &quot;tv_sec &lt; 0&quot;);
4879   assert(absTime-&gt;tv_sec &lt;= max_secs, &quot;tv_sec &gt; max_secs&quot;);
4880   assert(absTime-&gt;tv_nsec &gt;= 0, &quot;tv_nsec &lt; 0&quot;);
4881   assert(absTime-&gt;tv_nsec &lt; NANOSECS_PER_SEC, &quot;tv_nsec &gt;= nanos_per_sec&quot;);
4882 }
4883 
4884 void Parker::park(bool isAbsolute, jlong time) {
4885   // Ideally we&#39;d do something useful while spinning, such
4886   // as calling unpackTime().
4887 
4888   // Optional fast-path check:
4889   // Return immediately if a permit is available.
4890   // We depend on Atomic::xchg() having full barrier semantics
4891   // since we are doing a lock-free update to _counter.
4892   if (Atomic::xchg(&amp;_counter, 0) &gt; 0) return;
4893 
4894   // Optional fast-exit: Check interrupt before trying to wait
4895   Thread* thread = Thread::current();
4896   assert(thread-&gt;is_Java_thread(), &quot;Must be JavaThread&quot;);
4897   JavaThread *jt = (JavaThread *)thread;
4898   if (jt-&gt;is_interrupted(false)) {
4899     return;
4900   }
4901 
4902   // First, demultiplex/decode time arguments
4903   timespec absTime;
4904   if (time &lt; 0 || (isAbsolute &amp;&amp; time == 0)) { // don&#39;t wait at all
4905     return;
4906   }
4907   if (time &gt; 0) {
4908     // Warning: this code might be exposed to the old Solaris time
4909     // round-down bugs.  Grep &quot;roundingFix&quot; for details.
4910     unpackTime(&amp;absTime, isAbsolute, time);
4911   }
4912 
4913   // Enter safepoint region
4914   // Beware of deadlocks such as 6317397.
4915   // The per-thread Parker:: _mutex is a classic leaf-lock.
4916   // In particular a thread must never block on the Threads_lock while
4917   // holding the Parker:: mutex.  If safepoints are pending both the
4918   // the ThreadBlockInVM() CTOR and DTOR may grab Threads_lock.
4919   ThreadBlockInVM tbivm(jt);
4920 
4921   // Can&#39;t access interrupt state now that we are _thread_blocked. If we&#39;ve
4922   // been interrupted since we checked above then _counter will be &gt; 0.
4923 
4924   // Don&#39;t wait if cannot get lock since interference arises from
4925   // unblocking.
4926   if (os::Solaris::mutex_trylock(_mutex) != 0) {
4927     return;
4928   }
4929 
4930   int status;
4931 
4932   if (_counter &gt; 0)  { // no wait needed
4933     _counter = 0;
4934     status = os::Solaris::mutex_unlock(_mutex);
4935     assert(status == 0, &quot;invariant&quot;);
4936     // Paranoia to ensure our locked and lock-free paths interact
4937     // correctly with each other and Java-level accesses.
4938     OrderAccess::fence();
4939     return;
4940   }
4941 
4942   OSThreadWaitState osts(thread-&gt;osthread(), false /* not Object.wait() */);
4943   jt-&gt;set_suspend_equivalent();
4944   // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
4945 
4946   // Do this the hard way by blocking ...
4947   // See http://monaco.sfbay/detail.jsf?cr=5094058.
4948   if (time == 0) {
4949     status = os::Solaris::cond_wait(_cond, _mutex);
4950   } else {
4951     status = os::Solaris::cond_timedwait (_cond, _mutex, &amp;absTime);
4952   }
4953   // Note that an untimed cond_wait() can sometimes return ETIME on older
4954   // versions of the Solaris.
4955   assert_status(status == 0 || status == EINTR ||
4956                 status == ETIME || status == ETIMEDOUT,
4957                 status, &quot;cond_timedwait&quot;);
4958 
4959   _counter = 0;
4960   status = os::Solaris::mutex_unlock(_mutex);
4961   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4962   // Paranoia to ensure our locked and lock-free paths interact
4963   // correctly with each other and Java-level accesses.
4964   OrderAccess::fence();
4965 
4966   // If externally suspended while waiting, re-suspend
4967   if (jt-&gt;handle_special_suspend_equivalent_condition()) {
4968     jt-&gt;java_suspend_self();
4969   }
4970 }
4971 
4972 void Parker::unpark() {
4973   int status = os::Solaris::mutex_lock(_mutex);
4974   assert(status == 0, &quot;invariant&quot;);
4975   const int s = _counter;
4976   _counter = 1;
4977   status = os::Solaris::mutex_unlock(_mutex);
4978   assert(status == 0, &quot;invariant&quot;);
4979 
4980   if (s &lt; 1) {
4981     status = os::Solaris::cond_signal(_cond);
4982     assert(status == 0, &quot;invariant&quot;);
4983   }
4984 }
4985 
4986 // Platform Mutex/Monitor implementations
4987 
4988 os::PlatformMutex::PlatformMutex() {
4989   int status = os::Solaris::mutex_init(&amp;_mutex);
4990   assert_status(status == 0, status, &quot;mutex_init&quot;);
4991 }
4992 
4993 os::PlatformMutex::~PlatformMutex() {
4994   int status = os::Solaris::mutex_destroy(&amp;_mutex);
4995   assert_status(status == 0, status, &quot;mutex_destroy&quot;);
4996 }
4997 
4998 void os::PlatformMutex::lock() {
4999   int status = os::Solaris::mutex_lock(&amp;_mutex);
5000   assert_status(status == 0, status, &quot;mutex_lock&quot;);
5001 }
5002 
5003 void os::PlatformMutex::unlock() {
5004   int status = os::Solaris::mutex_unlock(&amp;_mutex);
5005   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
5006 }
5007 
5008 bool os::PlatformMutex::try_lock() {
5009   int status = os::Solaris::mutex_trylock(&amp;_mutex);
5010   assert_status(status == 0 || status == EBUSY, status, &quot;mutex_trylock&quot;);
5011   return status == 0;
5012 }
5013 
5014 os::PlatformMonitor::PlatformMonitor() {
5015   int status = os::Solaris::cond_init(&amp;_cond);
5016   assert_status(status == 0, status, &quot;cond_init&quot;);
5017 }
5018 
5019 os::PlatformMonitor::~PlatformMonitor() {
5020   int status = os::Solaris::cond_destroy(&amp;_cond);
5021   assert_status(status == 0, status, &quot;cond_destroy&quot;);
5022 }
5023 
5024 // Must already be locked
5025 int os::PlatformMonitor::wait(jlong millis) {
5026   assert(millis &gt;= 0, &quot;negative timeout&quot;);
5027   if (millis &gt; 0) {
5028     timestruc_t abst;
5029     int ret = OS_TIMEOUT;
5030     compute_abstime(&amp;abst, millis);
5031     int status = os::Solaris::cond_timedwait(&amp;_cond, &amp;_mutex, &amp;abst);
5032     assert_status(status == 0 || status == EINTR ||
5033                   status == ETIME || status == ETIMEDOUT,
5034                   status, &quot;cond_timedwait&quot;);
5035     // EINTR acts as spurious wakeup - which is permitted anyway
5036     if (status == 0 || status == EINTR) {
5037       ret = OS_OK;
5038     }
5039     return ret;
5040   } else {
5041     int status = os::Solaris::cond_wait(&amp;_cond, &amp;_mutex);
5042     assert_status(status == 0 || status == EINTR,
5043                   status, &quot;cond_wait&quot;);
5044     return OS_OK;
5045   }
5046 }
5047 
5048 void os::PlatformMonitor::notify() {
5049   int status = os::Solaris::cond_signal(&amp;_cond);
5050   assert_status(status == 0, status, &quot;cond_signal&quot;);
5051 }
5052 
5053 void os::PlatformMonitor::notify_all() {
5054   int status = os::Solaris::cond_broadcast(&amp;_cond);
5055   assert_status(status == 0, status, &quot;cond_broadcast&quot;);
5056 }
5057 
5058 extern char** environ;
5059 
5060 // Run the specified command in a separate process. Return its exit value,
5061 // or -1 on failure (e.g. can&#39;t fork a new process).
5062 // Unlike system(), this function can be called from signal handler. It
5063 // doesn&#39;t block SIGINT et al.
5064 int os::fork_and_exec(char* cmd, bool use_vfork_if_available) {
5065   char * argv[4];
5066   argv[0] = (char *)&quot;sh&quot;;
5067   argv[1] = (char *)&quot;-c&quot;;
5068   argv[2] = cmd;
5069   argv[3] = NULL;
5070 
5071   // fork is async-safe, fork1 is not so can&#39;t use in signal handler
5072   pid_t pid;
5073   Thread* t = Thread::current_or_null_safe();
5074   if (t != NULL &amp;&amp; t-&gt;is_inside_signal_handler()) {
5075     pid = fork();
5076   } else {
5077     pid = fork1();
5078   }
5079 
5080   if (pid &lt; 0) {
5081     // fork failed
5082     warning(&quot;fork failed: %s&quot;, os::strerror(errno));
5083     return -1;
5084 
5085   } else if (pid == 0) {
5086     // child process
5087 
5088     // try to be consistent with system(), which uses &quot;/usr/bin/sh&quot; on Solaris
5089     execve(&quot;/usr/bin/sh&quot;, argv, environ);
5090 
5091     // execve failed
5092     _exit(-1);
5093 
5094   } else  {
5095     // copied from J2SE ..._waitForProcessExit() in UNIXProcess_md.c; we don&#39;t
5096     // care about the actual exit code, for now.
5097 
5098     int status;
5099 
5100     // Wait for the child process to exit.  This returns immediately if
5101     // the child has already exited. */
5102     while (waitpid(pid, &amp;status, 0) &lt; 0) {
5103       switch (errno) {
5104       case ECHILD: return 0;
5105       case EINTR: break;
5106       default: return -1;
5107       }
5108     }
5109 
5110     if (WIFEXITED(status)) {
5111       // The child exited normally; get its exit code.
5112       return WEXITSTATUS(status);
5113     } else if (WIFSIGNALED(status)) {
5114       // The child exited because of a signal
5115       // The best value to return is 0x80 + signal number,
5116       // because that is what all Unix shells do, and because
5117       // it allows callers to distinguish between process exit and
5118       // process death by signal.
5119       return 0x80 + WTERMSIG(status);
5120     } else {
5121       // Unknown exit code; pass it through
5122       return status;
5123     }
5124   }
5125 }
5126 
5127 size_t os::write(int fd, const void *buf, unsigned int nBytes) {
5128   size_t res;
5129   RESTARTABLE((size_t) ::write(fd, buf, (size_t) nBytes), res);
5130   return res;
5131 }
5132 
5133 int os::close(int fd) {
5134   return ::close(fd);
5135 }
5136 
5137 int os::socket_close(int fd) {
5138   return ::close(fd);
5139 }
5140 
5141 int os::recv(int fd, char* buf, size_t nBytes, uint flags) {
5142   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
5143          &quot;Assumed _thread_in_native&quot;);
5144   RESTARTABLE_RETURN_INT((int)::recv(fd, buf, nBytes, flags));
5145 }
5146 
5147 int os::send(int fd, char* buf, size_t nBytes, uint flags) {
5148   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
5149          &quot;Assumed _thread_in_native&quot;);
5150   RESTARTABLE_RETURN_INT((int)::send(fd, buf, nBytes, flags));
5151 }
5152 
5153 int os::raw_send(int fd, char* buf, size_t nBytes, uint flags) {
5154   RESTARTABLE_RETURN_INT((int)::send(fd, buf, nBytes, flags));
5155 }
5156 
5157 // As both poll and select can be interrupted by signals, we have to be
5158 // prepared to restart the system call after updating the timeout, unless
5159 // a poll() is done with timeout == -1, in which case we repeat with this
5160 // &quot;wait forever&quot; value.
5161 
5162 int os::connect(int fd, struct sockaddr *him, socklen_t len) {
5163   int _result;
5164   _result = ::connect(fd, him, len);
5165 
5166   // On Solaris, when a connect() call is interrupted, the connection
5167   // can be established asynchronously (see 6343810). Subsequent calls
5168   // to connect() must check the errno value which has the semantic
5169   // described below (copied from the connect() man page). Handling
5170   // of asynchronously established connections is required for both
5171   // blocking and non-blocking sockets.
5172   //     EINTR            The  connection  attempt  was   interrupted
5173   //                      before  any data arrived by the delivery of
5174   //                      a signal. The connection, however, will  be
5175   //                      established asynchronously.
5176   //
5177   //     EINPROGRESS      The socket is non-blocking, and the connec-
5178   //                      tion  cannot  be completed immediately.
5179   //
5180   //     EALREADY         The socket is non-blocking,  and a previous
5181   //                      connection  attempt  has  not yet been com-
5182   //                      pleted.
5183   //
5184   //     EISCONN          The socket is already connected.
5185   if (_result == OS_ERR &amp;&amp; errno == EINTR) {
5186     // restarting a connect() changes its errno semantics
5187     RESTARTABLE(::connect(fd, him, len), _result);
5188     // undo these changes
5189     if (_result == OS_ERR) {
5190       if (errno == EALREADY) {
5191         errno = EINPROGRESS; // fall through
5192       } else if (errno == EISCONN) {
5193         errno = 0;
5194         return OS_OK;
5195       }
5196     }
5197   }
5198   return _result;
5199 }
5200 
5201 // Get the default path to the core file
5202 // Returns the length of the string
5203 int os::get_core_path(char* buffer, size_t bufferSize) {
5204   const char* p = get_current_directory(buffer, bufferSize);
5205 
5206   if (p == NULL) {
5207     assert(p != NULL, &quot;failed to get current directory&quot;);
5208     return 0;
5209   }
5210 
5211   jio_snprintf(buffer, bufferSize, &quot;%s/core or core.%d&quot;,
5212                                               p, current_process_id());
5213 
5214   return strlen(buffer);
5215 }
5216 
5217 bool os::supports_map_sync() {
5218   return false;
5219 }
5220 
5221 #ifndef PRODUCT
5222 void TestReserveMemorySpecial_test() {
5223   // No tests available for this platform
5224 }
5225 #endif
5226 
5227 bool os::start_debugging(char *buf, int buflen) {
5228   int len = (int)strlen(buf);
5229   char *p = &amp;buf[len];
5230 
5231   jio_snprintf(p, buflen-len,
5232                &quot;\n\n&quot;
5233                &quot;Do you want to debug the problem?\n\n&quot;
5234                &quot;To debug, run &#39;dbx - %d&#39;; then switch to thread &quot; INTX_FORMAT &quot;\n&quot;
5235                &quot;Enter &#39;yes&#39; to launch dbx automatically (PATH must include dbx)\n&quot;
5236                &quot;Otherwise, press RETURN to abort...&quot;,
5237                os::current_process_id(), os::current_thread_id());
5238 
5239   bool yes = os::message_box(&quot;Unexpected Error&quot;, buf);
5240 
5241   if (yes) {
5242     // yes, user asked VM to launch debugger
5243     jio_snprintf(buf, sizeof(buf), &quot;dbx - %d&quot;, os::current_process_id());
5244 
5245     os::fork_and_exec(buf);
5246     yes = false;
5247   }
5248   return yes;
5249 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>