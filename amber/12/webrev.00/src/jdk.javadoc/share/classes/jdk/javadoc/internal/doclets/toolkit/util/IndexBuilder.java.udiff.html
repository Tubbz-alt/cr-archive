<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.javadoc/share/classes/jdk/javadoc/internal/doclets/toolkit/util/IndexBuilder.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Group.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="TypeElementCatalog.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.javadoc/share/classes/jdk/javadoc/internal/doclets/toolkit/util/IndexBuilder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -31,10 +31,11 @@</span>
  import javax.lang.model.element.Element;
  import javax.lang.model.element.ModuleElement;
  import javax.lang.model.element.PackageElement;
  import javax.lang.model.element.TypeElement;
  
<span class="udiff-line-added">+ import jdk.javadoc.internal.doclets.formats.html.SearchIndexItem;</span>
  import jdk.javadoc.internal.doclets.toolkit.BaseConfiguration;
  import jdk.javadoc.internal.doclets.toolkit.Messages;
  
  import static jdk.javadoc.internal.doclets.toolkit.util.VisibleMemberTable.Kind.*;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -50,11 +51,11 @@</span>
  
      /**
       * Sets of elements keyed by the first character of the names of the
       * elements in those sets.
       */
<span class="udiff-line-modified-removed">-     private final Map&lt;Character, SortedSet&lt;Element&gt;&gt; indexMap;</span>
<span class="udiff-line-modified-added">+     private final Map&lt;Character, SortedSet&lt;IndexItem&gt;&gt; indexMap;</span>
  
      /**
       * Don&#39;t generate deprecated information if true.
       */
      private final boolean noDeprecated;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -64,11 +65,11 @@</span>
       */
      private final boolean classesOnly;
  
      private final BaseConfiguration configuration;
      private final Utils utils;
<span class="udiff-line-modified-removed">-     private final Comparator&lt;Element&gt; comparator;</span>
<span class="udiff-line-modified-added">+     private final Comparator&lt;IndexItem&gt; comparator;</span>
  
      /**
       * Creates a new {@code IndexBuilder}.
       *
       * @param configuration the current configuration of the doclet
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -104,22 +105,20 @@</span>
          }
  
          this.noDeprecated = noDeprecated;
          this.classesOnly = classesOnly;
          this.indexMap = new TreeMap&lt;&gt;();
<span class="udiff-line-modified-removed">-         comparator = classesOnly</span>
<span class="udiff-line-removed">-                 ? utils.makeAllClassesComparator()</span>
<span class="udiff-line-removed">-                 : utils.makeIndexUseComparator();</span>
<span class="udiff-line-modified-added">+         comparator = utils.comparators.makeIndexComparator(classesOnly);</span>
          buildIndex();
      }
  
      /**
       * Indexes all the members in all the packages and all the classes.
       */
      private void buildIndex()  {
          Set&lt;TypeElement&gt; classes = configuration.getIncludedTypeElements();
<span class="udiff-line-modified-removed">-         indexElements(classes);</span>
<span class="udiff-line-modified-added">+         indexTypeElements(classes);</span>
          if (classesOnly) {
              return;
          }
          Set&lt;PackageElement&gt; packages = configuration.getSpecifiedPackageElements();
          if (packages.isEmpty()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -127,11 +126,11 @@</span>
                      .stream()
                      .map(utils::containingPackage)
                      .filter(_package -&gt; _package != null &amp;&amp; !_package.isUnnamed())
                      .collect(Collectors.toSet());
          }
<span class="udiff-line-modified-removed">-         indexElements(packages);</span>
<span class="udiff-line-modified-added">+         packages.forEach(this::indexPackage);</span>
          classes.stream()
                 .filter(this::shouldIndex)
                 .forEach(this::indexMembers);
  
          if (configuration.showModules) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -145,31 +144,46 @@</span>
       *
       * @param te TypeElement whose members are to be indexed
       */
      private void indexMembers(TypeElement te) {
          VisibleMemberTable vmt = configuration.getVisibleMemberTable(te);
<span class="udiff-line-modified-removed">-         indexElements(vmt.getMembers(ANNOTATION_TYPE_FIELDS));</span>
<span class="udiff-line-modified-removed">-         indexElements(vmt.getMembers(FIELDS));</span>
<span class="udiff-line-modified-removed">-         indexElements(vmt.getMembers(METHODS));</span>
<span class="udiff-line-modified-removed">-         indexElements(vmt.getMembers(CONSTRUCTORS));</span>
<span class="udiff-line-modified-removed">-         indexElements(vmt.getMembers(ENUM_CONSTANTS));</span>
<span class="udiff-line-modified-added">+         indexElements(vmt.getVisibleMembers(FIELDS), te);</span>
<span class="udiff-line-modified-added">+         indexElements(vmt.getVisibleMembers(ANNOTATION_TYPE_MEMBER_OPTIONAL), te);</span>
<span class="udiff-line-modified-added">+         indexElements(vmt.getVisibleMembers(ANNOTATION_TYPE_MEMBER_REQUIRED), te);</span>
<span class="udiff-line-modified-added">+         indexElements(vmt.getVisibleMembers(METHODS), te);</span>
<span class="udiff-line-modified-added">+         indexElements(vmt.getVisibleMembers(CONSTRUCTORS), te);</span>
<span class="udiff-line-added">+         indexElements(vmt.getVisibleMembers(ENUM_CONSTANTS), te);</span>
      }
  
      /**
       * Indexes the provided elements.
       *
       * @param elements a collection of elements
       */
<span class="udiff-line-modified-removed">-     private void indexElements(Iterable&lt;? extends Element&gt; elements) {</span>
<span class="udiff-line-modified-added">+     private void indexElements(Iterable&lt;? extends Element&gt; elements, TypeElement typeElement) {</span>
          for (Element element : elements) {
              if (shouldIndex(element)) {
<span class="udiff-line-modified-removed">-                 String name = utils.isPackage(element)</span>
<span class="udiff-line-removed">-                         ? utils.getPackageName((PackageElement) element)</span>
<span class="udiff-line-removed">-                         : utils.getSimpleName(element);</span>
<span class="udiff-line-modified-added">+                 String name = utils.getSimpleName(element);</span>
                  Character ch = keyCharacter(name);
<span class="udiff-line-modified-removed">-                 SortedSet&lt;Element&gt; set = indexMap.computeIfAbsent(ch, c -&gt; new TreeSet&lt;&gt;(comparator));</span>
<span class="udiff-line-modified-removed">-                 set.add(element);</span>
<span class="udiff-line-modified-added">+                 SortedSet&lt;IndexItem&gt; set = indexMap.computeIfAbsent(ch, c -&gt; new TreeSet&lt;&gt;(comparator));</span>
<span class="udiff-line-modified-added">+                 set.add(new IndexItem(element, typeElement, configuration.utils));</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Index the given type elements.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param elements type elements</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private void indexTypeElements(Iterable&lt;TypeElement&gt; elements) {</span>
<span class="udiff-line-added">+         for (TypeElement typeElement : elements) {</span>
<span class="udiff-line-added">+             if (shouldIndex(typeElement)) {</span>
<span class="udiff-line-added">+                 String name = utils.getSimpleName(typeElement);</span>
<span class="udiff-line-added">+                 Character ch = keyCharacter(name);</span>
<span class="udiff-line-added">+                 SortedSet&lt;IndexItem&gt; set = indexMap.computeIfAbsent(ch, c -&gt; new TreeSet&lt;&gt;(comparator));</span>
<span class="udiff-line-added">+                 set.add(new IndexItem(typeElement, configuration.utils));</span>
              }
          }
      }
  
      private static Character keyCharacter(String s) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -180,12 +194,25 @@</span>
       * Indexes all the modules.
       */
      private void indexModules() {
          for (ModuleElement m : configuration.modules) {
              Character ch = keyCharacter(m.getQualifiedName().toString());
<span class="udiff-line-modified-removed">-             SortedSet&lt;Element&gt; set = indexMap.computeIfAbsent(ch, c -&gt; new TreeSet&lt;&gt;(comparator));</span>
<span class="udiff-line-modified-removed">-             set.add(m);</span>
<span class="udiff-line-modified-added">+             SortedSet&lt;IndexItem&gt; set = indexMap.computeIfAbsent(ch, c -&gt; new TreeSet&lt;&gt;(comparator));</span>
<span class="udiff-line-modified-added">+             set.add(new IndexItem(m, configuration.utils));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Index the given package element.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param packageElement the package element</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private void indexPackage(PackageElement packageElement) {</span>
<span class="udiff-line-added">+         if (shouldIndex(packageElement)) {</span>
<span class="udiff-line-added">+             Character ch = keyCharacter(utils.getPackageName(packageElement));</span>
<span class="udiff-line-added">+             SortedSet&lt;IndexItem&gt; set = indexMap.computeIfAbsent(ch, c -&gt; new TreeSet&lt;&gt;(comparator));</span>
<span class="udiff-line-added">+             set.add(new IndexItem(packageElement, configuration.utils));</span>
          }
      }
  
      /**
       * Should this element be added to the index?
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -212,23 +239,23 @@</span>
      /**
       * Returns a map representation of this index.
       *
       * @return map
       */
<span class="udiff-line-modified-removed">-     public Map&lt;Character, SortedSet&lt;Element&gt;&gt; asMap() {</span>
<span class="udiff-line-modified-added">+     public Map&lt;Character, SortedSet&lt;IndexItem&gt;&gt; asMap() {</span>
          return indexMap;
      }
  
      /**
       * Returns a sorted list of elements whose names start with the
       * provided character.
       *
       * @param key index key
       * @return list of elements keyed by the provided character
       */
<span class="udiff-line-modified-removed">-     public List&lt;? extends Element&gt; getMemberList(Character key) {</span>
<span class="udiff-line-modified-removed">-         SortedSet&lt;Element&gt; set = indexMap.get(key);</span>
<span class="udiff-line-modified-added">+     public List&lt;IndexItem&gt; getMemberList(Character key) {</span>
<span class="udiff-line-modified-added">+         SortedSet&lt;IndexItem&gt; set = indexMap.get(key);</span>
          if (set == null) {
              return null;
          }
          return new ArrayList&lt;&gt;(set);
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -237,6 +264,20 @@</span>
       * Returns a list of index keys.
       */
      public List&lt;Character&gt; keys() {
          return new ArrayList&lt;&gt;(indexMap.keySet());
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Add search tags for the key {@code key}.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param key the index key</span>
<span class="udiff-line-added">+      * @param searchTags the search tags</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public void addSearchTags(char key, List&lt;SearchIndexItem&gt; searchTags) {</span>
<span class="udiff-line-added">+         searchTags.forEach(searchTag -&gt; {</span>
<span class="udiff-line-added">+             SortedSet&lt;IndexItem&gt; set = indexMap.computeIfAbsent(key, c -&gt; new TreeSet&lt;&gt;(comparator));</span>
<span class="udiff-line-added">+             set.add(new IndexItem(searchTag));</span>
<span class="udiff-line-added">+         });</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
  }
</pre>
<center><a href="Group.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="TypeElementCatalog.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>