<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/langtools/tools/javac/annotations/typeAnnotations/classfile/Patterns.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2009, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @summary Verify type annotation on binding patterns
 27  * @library /tools/lib
 28  * @modules java.compiler
 29  *          jdk.jdeps/com.sun.tools.javap
 30  * @build toolbox.JavapTask
 31  * @compile --enable-preview -source ${jdk.version} Patterns.java
 32  * @run main/othervm --enable-preview Patterns
 33  */
 34 
 35 import java.lang.annotation.*;
 36 import java.util.regex.Matcher;
 37 import java.util.regex.Pattern;
 38 import java.util.stream.Collectors;
 39 
 40 import toolbox.JavapTask;
 41 import toolbox.Task;
 42 import toolbox.ToolBox;
 43 
 44 public class Patterns {
 45 
 46     private ToolBox tb = new ToolBox();
 47 
 48     public static void main(String[] args) throws Exception {
 49         new Patterns().runBinding();
 50         new Patterns().runDeconstruction();
 51     }
 52 
 53     public void runBinding() throws Exception {
 54         String out = new JavapTask(tb)
 55                 .options(&quot;-private&quot;,
 56                          &quot;-verbose&quot;)
 57                 .classpath(System.getProperty(&quot;test.classes&quot;))
 58                 .classes(&quot;Patterns$SimpleBindingPattern&quot;)
 59                 .run()
 60                 .getOutputLines(Task.OutputKind.DIRECT)
 61                 .stream()
 62                 .collect(Collectors.joining(&quot;\n&quot;));
 63 
 64         String constantPool = out.substring(0, out.indexOf(&#39;{&#39;));
 65 
 66         out = out.replaceAll(&quot;(?ms) *Code:.*?\n( *RuntimeInvisibleTypeAnnotations:)&quot;, &quot;$1&quot;);
 67         out = out.substring(out.indexOf(&#39;{&#39;));
 68         out = out.substring(0, out.lastIndexOf(&#39;}&#39;) + 1);
 69 
 70         String A = snipCPNumber(constantPool, &quot;LPatterns$SimpleBindingPattern$A;&quot;);
 71         String CA = snipCPNumber(constantPool, &quot;LPatterns$SimpleBindingPattern$CA;&quot;);
 72         String value = snipCPNumber(constantPool, &quot;value&quot;);
 73 
 74         String expected = &quot;&quot;&quot;
 75                           {
 76                             private static final java.lang.Object o;
 77                               descriptor: Ljava/lang/Object;
 78                               flags: (0x001a) ACC_PRIVATE, ACC_STATIC, ACC_FINAL
 79 
 80                             private static final boolean B1s;
 81                               descriptor: Z
 82                               flags: (0x001a) ACC_PRIVATE, ACC_STATIC, ACC_FINAL
 83 
 84                             private static final boolean B1m;
 85                               descriptor: Z
 86                               flags: (0x001a) ACC_PRIVATE, ACC_STATIC, ACC_FINAL
 87 
 88                             private final boolean B2s;
 89                               descriptor: Z
 90                               flags: (0x0012) ACC_PRIVATE, ACC_FINAL
 91 
 92                             private final boolean B2m;
 93                               descriptor: Z
 94                               flags: (0x0012) ACC_PRIVATE, ACC_FINAL
 95 
 96                             public Patterns$SimpleBindingPattern();
 97                               descriptor: ()V
 98                               flags: (0x0001) ACC_PUBLIC
 99                                 RuntimeInvisibleTypeAnnotations:
100                                   0: #_A_(): LOCAL_VARIABLE, {start_pc=206, length=11, index=2}
101                                     Patterns$SimpleBindingPattern$A
102                                   1: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=238, length=11, index=3}
103                                     Patterns$SimpleBindingPattern$CA(
104                                       value=[@Patterns$SimpleBindingPattern$A,@Patterns$SimpleBindingPattern$A]
105                                     )
106                                   2: #_A_(): LOCAL_VARIABLE, {start_pc=21, length=11, index=1}
107                                     Patterns$SimpleBindingPattern$A
108                                   3: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=53, length=11, index=1}
109                                     Patterns$SimpleBindingPattern$CA(
110                                       value=[@Patterns$SimpleBindingPattern$A,@Patterns$SimpleBindingPattern$A]
111                                     )
112                                   4: #_A_(): LOCAL_VARIABLE, {start_pc=84, length=11, index=2}
113                                     Patterns$SimpleBindingPattern$A
114                                   5: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=116, length=11, index=3}
115                                     Patterns$SimpleBindingPattern$CA(
116                                       value=[@Patterns$SimpleBindingPattern$A,@Patterns$SimpleBindingPattern$A]
117                                     )
118                                   6: #_A_(): LOCAL_VARIABLE, {start_pc=145, length=11, index=2}
119                                     Patterns$SimpleBindingPattern$A
120                                   7: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=177, length=11, index=3}
121                                     Patterns$SimpleBindingPattern$CA(
122                                       value=[@Patterns$SimpleBindingPattern$A,@Patterns$SimpleBindingPattern$A]
123                                     )
124 
125                             void testPatterns();
126                               descriptor: ()V
127                               flags: (0x0000)
128                                 RuntimeInvisibleTypeAnnotations:
129                                   0: #_A_(): LOCAL_VARIABLE, {start_pc=16, length=11, index=2}
130                                     Patterns$SimpleBindingPattern$A
131                                   1: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=48, length=11, index=3}
132                                     Patterns$SimpleBindingPattern$CA(
133                                       value=[@Patterns$SimpleBindingPattern$A,@Patterns$SimpleBindingPattern$A]
134                                     )
135 
136                             void testPatternsDesugared();
137                               descriptor: ()V
138                               flags: (0x0000)
139                                 RuntimeInvisibleTypeAnnotations:
140                                   0: #_A_(): LOCAL_VARIABLE, {start_pc=17, length=15, index=1; start_pc=51, length=15, index=1}
141                                     Patterns$SimpleBindingPattern$A
142 
143                             static {};
144                               descriptor: ()V
145                               flags: (0x0008) ACC_STATIC
146                                 RuntimeInvisibleTypeAnnotations:
147                                   0: #_A_(): LOCAL_VARIABLE, {start_pc=21, length=11, index=0}
148                                     Patterns$SimpleBindingPattern$A
149                                   1: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=52, length=11, index=0}
150                                     Patterns$SimpleBindingPattern$CA(
151                                       value=[@Patterns$SimpleBindingPattern$A,@Patterns$SimpleBindingPattern$A]
152                                     )
153                                   2: #_A_(): LOCAL_VARIABLE, {start_pc=83, length=11, index=1}
154                                     Patterns$SimpleBindingPattern$A
155                                   3: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=112, length=11, index=2}
156                                     Patterns$SimpleBindingPattern$CA(
157                                       value=[@Patterns$SimpleBindingPattern$A,@Patterns$SimpleBindingPattern$A]
158                                     )
159                           }&quot;&quot;&quot;.replace(&quot;_A_&quot;, A).replace(&quot;_CA_&quot;, CA).replace(&quot;_value_&quot;, value);
160 
161         if (!expected.equals(out)) {
162             throw new AssertionError(&quot;Unexpected output:\n&quot; + out + &quot;\nexpected:\n&quot; + expected);
163         }
164     }
165 
166     public void runDeconstruction() throws Exception {
167         String out = new JavapTask(tb)
168                 .options(&quot;-private&quot;,
169                          &quot;-verbose&quot;)
170                 .classpath(System.getProperty(&quot;test.classes&quot;))
171                 .classes(&quot;Patterns$DeconstructionPattern&quot;)
172                 .run()
173                 .getOutputLines(Task.OutputKind.DIRECT)
174                 .stream()
175                 .collect(Collectors.joining(&quot;\n&quot;));
176 
177         String constantPool = out.substring(0, out.indexOf(&#39;{&#39;));
178 
179         out = out.replaceAll(&quot;(?ms) *Code:.*?\n( *RuntimeInvisibleTypeAnnotations:)&quot;, &quot;$1&quot;);
180         out = out.substring(out.indexOf(&#39;{&#39;));
181         out = out.substring(0, out.lastIndexOf(&#39;}&#39;) + 1);
182 
183         String A = snipCPNumber(constantPool, &quot;LPatterns$DeconstructionPattern$A;&quot;);
184         String CA = snipCPNumber(constantPool, &quot;LPatterns$DeconstructionPattern$CA;&quot;);
185         String value = snipCPNumber(constantPool, &quot;value&quot;);
186 
187         String expected = &quot;&quot;&quot;
188                           {
189                             private static final java.lang.Object o;
190                               descriptor: Ljava/lang/Object;
191                               flags: (0x001a) ACC_PRIVATE, ACC_STATIC, ACC_FINAL
192 
193                             private static final boolean B1s;
194                               descriptor: Z
195                               flags: (0x001a) ACC_PRIVATE, ACC_STATIC, ACC_FINAL
196 
197                             private static final boolean B1m;
198                               descriptor: Z
199                               flags: (0x001a) ACC_PRIVATE, ACC_STATIC, ACC_FINAL
200 
201                             private final boolean B2s;
202                               descriptor: Z
203                               flags: (0x0012) ACC_PRIVATE, ACC_FINAL
204 
205                             private final boolean B2m;
206                               descriptor: Z
207                               flags: (0x0012) ACC_PRIVATE, ACC_FINAL
208 
209                             public Patterns$DeconstructionPattern();
210                               descriptor: ()V
211                               flags: (0x0001) ACC_PUBLIC
212                                 RuntimeInvisibleTypeAnnotations:
213                                   0: #_A_(): LOCAL_VARIABLE, {start_pc=284, length=11, index=2}
214                                     Patterns$DeconstructionPattern$A
215                                   1: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=328, length=11, index=3}
216                                     Patterns$DeconstructionPattern$CA(
217                                       value=[@Patterns$DeconstructionPattern$A,@Patterns$DeconstructionPattern$A]
218                                     )
219                                   2: #_A_(): LOCAL_VARIABLE, {start_pc=30, length=11, index=1}
220                                     Patterns$DeconstructionPattern$A
221                                   3: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=71, length=11, index=1}
222                                     Patterns$DeconstructionPattern$CA(
223                                       value=[@Patterns$DeconstructionPattern$A,@Patterns$DeconstructionPattern$A]
224                                     )
225                                   4: #_A_(): LOCAL_VARIABLE, {start_pc=114, length=11, index=2}
226                                     Patterns$DeconstructionPattern$A
227                                   5: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=158, length=11, index=3}
228                                     Patterns$DeconstructionPattern$CA(
229                                       value=[@Patterns$DeconstructionPattern$A,@Patterns$DeconstructionPattern$A]
230                                     )
231                                   6: #_A_(): LOCAL_VARIABLE, {start_pc=199, length=11, index=2}
232                                     Patterns$DeconstructionPattern$A
233                                   7: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=243, length=11, index=3}
234                                     Patterns$DeconstructionPattern$CA(
235                                       value=[@Patterns$DeconstructionPattern$A,@Patterns$DeconstructionPattern$A]
236                                     )
237 
238                             void testPatterns();
239                               descriptor: ()V
240                               flags: (0x0000)
241                                 RuntimeInvisibleTypeAnnotations:
242                                   0: #_A_(): LOCAL_VARIABLE, {start_pc=28, length=11, index=2}
243                                     Patterns$DeconstructionPattern$A
244                                   1: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=72, length=11, index=3}
245                                     Patterns$DeconstructionPattern$CA(
246                                       value=[@Patterns$DeconstructionPattern$A,@Patterns$DeconstructionPattern$A]
247                                     )
248 
249                             static {};
250                               descriptor: ()V
251                               flags: (0x0008) ACC_STATIC
252                                 RuntimeInvisibleTypeAnnotations:
253                                   0: #_A_(): LOCAL_VARIABLE, {start_pc=30, length=11, index=0}
254                                     Patterns$DeconstructionPattern$A
255                                   1: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=70, length=11, index=0}
256                                     Patterns$DeconstructionPattern$CA(
257                                       value=[@Patterns$DeconstructionPattern$A,@Patterns$DeconstructionPattern$A]
258                                     )
259                                   2: #_A_(): LOCAL_VARIABLE, {start_pc=110, length=11, index=1}
260                                     Patterns$DeconstructionPattern$A
261                                   3: #_CA_(#_value_=[@#_A_(),@#_A_()]): LOCAL_VARIABLE, {start_pc=151, length=11, index=2}
262                                     Patterns$DeconstructionPattern$CA(
263                                       value=[@Patterns$DeconstructionPattern$A,@Patterns$DeconstructionPattern$A]
264                                     )
265                           }&quot;&quot;&quot;.replace(&quot;_A_&quot;, A).replace(&quot;_CA_&quot;, CA).replace(&quot;_value_&quot;, value);
266 
267         if (!expected.equals(out)) {
268             throw new AssertionError(&quot;Unexpected output:\n&quot; + out + &quot;\nexpected:\n&quot; + expected);
269         }
270     }
271 
272     private String snipCPNumber(String constantPool, String expectedConstant) {
273         Matcher m = Pattern.compile(&quot;#([0-9]+).*&quot; + Pattern.quote(expectedConstant))
274                            .matcher(constantPool);
275         if (!m.find()) {
276             throw new AssertionError(&quot;Cannot find constant pool item&quot;);
277         }
278 
279         return m.group(1);
280     }
281 
282     /*********************** Test class *************************/
283     static class SimpleBindingPattern {
284         @Target(ElementType.TYPE_USE)
285         @Repeatable(CA.class)
286         @interface A {}
287         @Target(ElementType.TYPE_USE)
288         @interface CA {
289             public A[] value();
290         }
291 
292         private static final Object o = &quot;&quot;;
293         private static final boolean B1s = o instanceof @A String s &amp;&amp; s.isEmpty();
294         private static final boolean B1m = o instanceof @A @A String s &amp;&amp; s.isEmpty();
295         private final boolean B2s = o instanceof @A String s &amp;&amp; s.isEmpty();
296         private final boolean B2m = o instanceof @A @A String s &amp;&amp; s.isEmpty();
297 
298         static {
299             boolean B3s = o instanceof @A String s &amp;&amp; s.isEmpty();
300             boolean B3m = o instanceof @A @A String s &amp;&amp; s.isEmpty();
301         }
302 
303         {
304             boolean B4s = o instanceof @A String s &amp;&amp; s.isEmpty();
305             boolean B4m = o instanceof @A @A String s &amp;&amp; s.isEmpty();
306         }
307 
308         {
309             boolean B5s = o instanceof @A String s &amp;&amp; s.isEmpty();
310             boolean B5m = o instanceof @A @A String s &amp;&amp; s.isEmpty();
311         }
312 
313         public SimpleBindingPattern() {
314             boolean B6s = o instanceof @A String s &amp;&amp; s.isEmpty();
315             boolean B6m = o instanceof @A @A String s &amp;&amp; s.isEmpty();
316         }
317 
318         void testPatterns() {
319             boolean B7s = o instanceof @A String s &amp;&amp; s.isEmpty();
320             boolean B7m = o instanceof @A @A String s &amp;&amp; s.isEmpty();
321         }
322 
323         void testPatternsDesugared() {
324             @A String s;
325             boolean B8s = o instanceof String &amp;&amp; (s = (String) o) == s &amp;&amp; s.isEmpty();
326             boolean B8sx = o instanceof String &amp;&amp; (s = (String) o) == s &amp;&amp; s.isEmpty();
327         }
328     }
329 
330     static class DeconstructionPattern {
331         @Target(ElementType.TYPE_USE)
332         @Repeatable(CA.class)
333         @interface A {}
334         @Target(ElementType.TYPE_USE)
335         @interface CA {
336             public A[] value();
337         }
338 
339         private static final Object o = &quot;&quot;;
340         private static final boolean B1s = o instanceof R(@A String s) &amp;&amp; s.isEmpty();
341         private static final boolean B1m = o instanceof R(@A @A String s) &amp;&amp; s.isEmpty();
342         private final boolean B2s = o instanceof R(@A String s) &amp;&amp; s.isEmpty();
343         private final boolean B2m = o instanceof R(@A @A String s) &amp;&amp; s.isEmpty();
344 
345         static {
346             boolean B3s = o instanceof R(@A String s) &amp;&amp; s.isEmpty();
347             boolean B3m = o instanceof R(@A @A String s) &amp;&amp; s.isEmpty();
348         }
349 
350         {
351             boolean B4s = o instanceof R(@A String s) &amp;&amp; s.isEmpty();
352             boolean B4m = o instanceof R(@A @A String s) &amp;&amp; s.isEmpty();
353         }
354 
355         {
356             boolean B5s = o instanceof R(@A String s) &amp;&amp; s.isEmpty();
357             boolean B5m = o instanceof R(@A @A String s) &amp;&amp; s.isEmpty();
358         }
359 
360         public DeconstructionPattern() {
361             boolean B6s = o instanceof R(@A String s) &amp;&amp; s.isEmpty();
362             boolean B6m = o instanceof R(@A @A String s) &amp;&amp; s.isEmpty();
363         }
364 
365         void testPatterns() {
366             boolean B7s = o instanceof R(@A String s) &amp;&amp; s.isEmpty();
367             boolean B7m = o instanceof R(@A @A String s) &amp;&amp; s.isEmpty();
368         }
369 
370         record R(String s) {}
371     }
372 }
    </pre>
  </body>
</html>