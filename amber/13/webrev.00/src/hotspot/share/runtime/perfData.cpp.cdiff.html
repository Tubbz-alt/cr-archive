<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/runtime/perfData.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="os.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="perfData.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/perfData.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 274,10 ***</span>
<span class="line-new-header">--- 274,13 ---</span>
    // 1) leak the PerfData memory or 2) do some form of synchronized
    // access or check before every PerfData operation.
    _has_PerfData = false;
    os::naked_short_sleep(1);  // 1ms sleep to let other thread(s) run
  
<span class="line-added">+   log_debug(perf, datacreation)(&quot;Total = %d, Sampled = %d, Constants = %d&quot;,</span>
<span class="line-added">+                                 _all-&gt;length(), _sampled-&gt;length(), _constants-&gt;length());</span>
<span class="line-added">+ </span>
    for (int index = 0; index &lt; _all-&gt;length(); index++) {
      PerfData* p = _all-&gt;at(index);
      delete p;
    }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 292,45 ***</span>
  
  void PerfDataManager::add_item(PerfData* p, bool sampled) {
  
    MutexLocker ml(PerfDataManager_lock);
  
    if (_all == NULL) {
<span class="line-modified">!     _all = new PerfDataList(100);</span>
      _has_PerfData = true;
    }
  
    assert(!_all-&gt;contains(p-&gt;name()), &quot;duplicate name added&quot;);
  
    // add to the list of all perf data items
    _all-&gt;append(p);
  
    if (p-&gt;variability() == PerfData::V_Constant) {
      if (_constants == NULL) {
<span class="line-modified">!       _constants = new PerfDataList(25);</span>
      }
      _constants-&gt;append(p);
      return;
    }
  
    if (sampled) {
      if (_sampled == NULL) {
<span class="line-modified">!       _sampled = new PerfDataList(25);</span>
      }
      _sampled-&gt;append(p);
    }
  }
  
<span class="line-removed">- PerfData* PerfDataManager::find_by_name(const char* name) {</span>
<span class="line-removed">-   // if add_item hasn&#39;t been called the list won&#39;t be initialized</span>
<span class="line-removed">-   if (_all != NULL) {</span>
<span class="line-removed">-     return _all-&gt;find_by_name(name);</span>
<span class="line-removed">-   } else {</span>
<span class="line-removed">-     return NULL;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  PerfDataList* PerfDataManager::all() {
  
    MutexLocker ml(PerfDataManager_lock);
  
    if (_all == NULL)
<span class="line-new-header">--- 295,37 ---</span>
  
  void PerfDataManager::add_item(PerfData* p, bool sampled) {
  
    MutexLocker ml(PerfDataManager_lock);
  
<span class="line-added">+   // Default sizes determined using -Xlog:perf+datacreation=debug</span>
    if (_all == NULL) {
<span class="line-modified">!     _all = new PerfDataList(191);</span>
      _has_PerfData = true;
    }
  
    assert(!_all-&gt;contains(p-&gt;name()), &quot;duplicate name added&quot;);
  
    // add to the list of all perf data items
    _all-&gt;append(p);
  
    if (p-&gt;variability() == PerfData::V_Constant) {
      if (_constants == NULL) {
<span class="line-modified">!       _constants = new PerfDataList(51);</span>
      }
      _constants-&gt;append(p);
      return;
    }
  
    if (sampled) {
      if (_sampled == NULL) {
<span class="line-modified">!       _sampled = new PerfDataList(1);</span>
      }
      _sampled-&gt;append(p);
    }
  }
  
  PerfDataList* PerfDataManager::all() {
  
    MutexLocker ml(PerfDataManager_lock);
  
    if (_all == NULL)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 610,10 ***</span>
  
    return copy;
  }
  
  PerfTraceTime::~PerfTraceTime() {
<span class="line-modified">!   if (!UsePerfData || (_recursion_counter != NULL &amp;&amp;</span>
<span class="line-removed">-       --(*_recursion_counter) &gt; 0)) return;</span>
    _t.stop();
    _timerp-&gt;inc(_t.ticks());
  }
<span class="line-new-header">--- 605,9 ---</span>
  
    return copy;
  }
  
  PerfTraceTime::~PerfTraceTime() {
<span class="line-modified">!   if (!UsePerfData) return;</span>
    _t.stop();
    _timerp-&gt;inc(_t.ticks());
  }
</pre>
<center><a href="os.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="perfData.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>