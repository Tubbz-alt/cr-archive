<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/gc/g1/g1CollectedHeap.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;classfile/metadataOnStackMark.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;code/codeCache.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;gc/g1/g1Allocator.inline.hpp&quot;
  32 #include &quot;gc/g1/g1Arguments.hpp&quot;
  33 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  34 #include &quot;gc/g1/g1CardTableEntryClosure.hpp&quot;
  35 #include &quot;gc/g1/g1CollectedHeap.inline.hpp&quot;
  36 #include &quot;gc/g1/g1CollectionSet.hpp&quot;
  37 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  38 #include &quot;gc/g1/g1ConcurrentRefine.hpp&quot;
  39 #include &quot;gc/g1/g1ConcurrentRefineThread.hpp&quot;
  40 #include &quot;gc/g1/g1ConcurrentMarkThread.inline.hpp&quot;
  41 #include &quot;gc/g1/g1DirtyCardQueue.hpp&quot;
  42 #include &quot;gc/g1/g1EvacStats.inline.hpp&quot;
  43 #include &quot;gc/g1/g1FullCollector.hpp&quot;
  44 #include &quot;gc/g1/g1GCPhaseTimes.hpp&quot;
  45 #include &quot;gc/g1/g1HeapSizingPolicy.hpp&quot;
  46 #include &quot;gc/g1/g1HeapTransition.hpp&quot;
  47 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  48 #include &quot;gc/g1/g1HotCardCache.hpp&quot;
  49 #include &quot;gc/g1/g1MemoryPool.hpp&quot;
  50 #include &quot;gc/g1/g1OopClosures.inline.hpp&quot;
  51 #include &quot;gc/g1/g1ParallelCleaning.hpp&quot;
  52 #include &quot;gc/g1/g1ParScanThreadState.inline.hpp&quot;
  53 #include &quot;gc/g1/g1Policy.hpp&quot;
  54 #include &quot;gc/g1/g1RedirtyCardsQueue.hpp&quot;
  55 #include &quot;gc/g1/g1RegionToSpaceMapper.hpp&quot;
  56 #include &quot;gc/g1/g1RemSet.hpp&quot;
  57 #include &quot;gc/g1/g1RootClosures.hpp&quot;
  58 #include &quot;gc/g1/g1RootProcessor.hpp&quot;
  59 #include &quot;gc/g1/g1SATBMarkQueueSet.hpp&quot;
  60 #include &quot;gc/g1/g1StringDedup.hpp&quot;
  61 #include &quot;gc/g1/g1ThreadLocalData.hpp&quot;
  62 #include &quot;gc/g1/g1Trace.hpp&quot;
  63 #include &quot;gc/g1/g1YCTypes.hpp&quot;
  64 #include &quot;gc/g1/g1YoungRemSetSamplingThread.hpp&quot;
  65 #include &quot;gc/g1/g1VMOperations.hpp&quot;
  66 #include &quot;gc/g1/heapRegion.inline.hpp&quot;
  67 #include &quot;gc/g1/heapRegionRemSet.hpp&quot;
  68 #include &quot;gc/g1/heapRegionSet.inline.hpp&quot;
<a name="1" id="anc1"></a><span class="line-added">  69 #include &quot;gc/shared/concurrentGCBreakpoints.hpp&quot;</span>
  70 #include &quot;gc/shared/gcBehaviours.hpp&quot;
  71 #include &quot;gc/shared/gcHeapSummary.hpp&quot;
  72 #include &quot;gc/shared/gcId.hpp&quot;
  73 #include &quot;gc/shared/gcLocker.hpp&quot;
  74 #include &quot;gc/shared/gcTimer.hpp&quot;
  75 #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
  76 #include &quot;gc/shared/generationSpec.hpp&quot;
  77 #include &quot;gc/shared/isGCActiveMark.hpp&quot;
  78 #include &quot;gc/shared/locationPrinter.inline.hpp&quot;
  79 #include &quot;gc/shared/oopStorageParState.hpp&quot;
  80 #include &quot;gc/shared/preservedMarks.inline.hpp&quot;
  81 #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
  82 #include &quot;gc/shared/referenceProcessor.inline.hpp&quot;
  83 #include &quot;gc/shared/taskTerminator.hpp&quot;
  84 #include &quot;gc/shared/taskqueue.inline.hpp&quot;
  85 #include &quot;gc/shared/weakProcessor.inline.hpp&quot;
  86 #include &quot;gc/shared/workerPolicy.hpp&quot;
  87 #include &quot;logging/log.hpp&quot;
  88 #include &quot;memory/allocation.hpp&quot;
  89 #include &quot;memory/iterator.hpp&quot;
  90 #include &quot;memory/resourceArea.hpp&quot;
  91 #include &quot;memory/universe.hpp&quot;
  92 #include &quot;oops/access.inline.hpp&quot;
  93 #include &quot;oops/compressedOops.inline.hpp&quot;
  94 #include &quot;oops/oop.inline.hpp&quot;
  95 #include &quot;runtime/atomic.hpp&quot;
  96 #include &quot;runtime/flags/flagSetting.hpp&quot;
  97 #include &quot;runtime/handles.inline.hpp&quot;
  98 #include &quot;runtime/init.hpp&quot;
  99 #include &quot;runtime/orderAccess.hpp&quot;
 100 #include &quot;runtime/threadSMR.hpp&quot;
 101 #include &quot;runtime/vmThread.hpp&quot;
 102 #include &quot;utilities/align.hpp&quot;
 103 #include &quot;utilities/bitMap.inline.hpp&quot;
 104 #include &quot;utilities/globalDefinitions.hpp&quot;
 105 #include &quot;utilities/stack.inline.hpp&quot;
 106 
 107 size_t G1CollectedHeap::_humongous_object_threshold_in_words = 0;
 108 
 109 // INVARIANTS/NOTES
 110 //
 111 // All allocation activity covered by the G1CollectedHeap interface is
 112 // serialized by acquiring the HeapLock.  This happens in mem_allocate
 113 // and allocate_new_tlab, which are the &quot;entry&quot; points to the
 114 // allocation code from the rest of the JVM.  (Note that this does not
 115 // apply to TLAB allocation, which is not part of this interface: it
 116 // is done by clients of this interface.)
 117 
 118 class RedirtyLoggedCardTableEntryClosure : public G1CardTableEntryClosure {
 119  private:
 120   size_t _num_dirtied;
 121   G1CollectedHeap* _g1h;
 122   G1CardTable* _g1_ct;
 123 
 124   HeapRegion* region_for_card(CardValue* card_ptr) const {
 125     return _g1h-&gt;heap_region_containing(_g1_ct-&gt;addr_for(card_ptr));
 126   }
 127 
 128   bool will_become_free(HeapRegion* hr) const {
 129     // A region will be freed by free_collection_set if the region is in the
 130     // collection set and has not had an evacuation failure.
 131     return _g1h-&gt;is_in_cset(hr) &amp;&amp; !hr-&gt;evacuation_failed();
 132   }
 133 
 134  public:
 135   RedirtyLoggedCardTableEntryClosure(G1CollectedHeap* g1h) : G1CardTableEntryClosure(),
 136     _num_dirtied(0), _g1h(g1h), _g1_ct(g1h-&gt;card_table()) { }
 137 
 138   void do_card_ptr(CardValue* card_ptr, uint worker_id) {
 139     HeapRegion* hr = region_for_card(card_ptr);
 140 
 141     // Should only dirty cards in regions that won&#39;t be freed.
 142     if (!will_become_free(hr)) {
 143       *card_ptr = G1CardTable::dirty_card_val();
 144       _num_dirtied++;
 145     }
 146   }
 147 
 148   size_t num_dirtied()   const { return _num_dirtied; }
 149 };
 150 
 151 
 152 void G1RegionMappingChangedListener::reset_from_card_cache(uint start_idx, size_t num_regions) {
 153   HeapRegionRemSet::invalidate_from_card_cache(start_idx, num_regions);
 154 }
 155 
 156 void G1RegionMappingChangedListener::on_commit(uint start_idx, size_t num_regions, bool zero_filled) {
 157   // The from card cache is not the memory that is actually committed. So we cannot
 158   // take advantage of the zero_filled parameter.
 159   reset_from_card_cache(start_idx, num_regions);
 160 }
 161 
 162 Tickspan G1CollectedHeap::run_task(AbstractGangTask* task) {
 163   Ticks start = Ticks::now();
 164   workers()-&gt;run_task(task, workers()-&gt;active_workers());
 165   return Ticks::now() - start;
 166 }
 167 
 168 HeapRegion* G1CollectedHeap::new_heap_region(uint hrs_index,
 169                                              MemRegion mr) {
 170   return new HeapRegion(hrs_index, bot(), mr);
 171 }
 172 
 173 // Private methods.
 174 
 175 HeapRegion* G1CollectedHeap::new_region(size_t word_size,
 176                                         HeapRegionType type,
 177                                         bool do_expand,
 178                                         uint node_index) {
 179   assert(!is_humongous(word_size) || word_size &lt;= HeapRegion::GrainWords,
 180          &quot;the only time we use this to allocate a humongous region is &quot;
 181          &quot;when we are allocating a single humongous region&quot;);
 182 
 183   HeapRegion* res = _hrm-&gt;allocate_free_region(type, node_index);
 184 
 185   if (res == NULL &amp;&amp; do_expand &amp;&amp; _expand_heap_after_alloc_failure) {
 186     // Currently, only attempts to allocate GC alloc regions set
 187     // do_expand to true. So, we should only reach here during a
 188     // safepoint. If this assumption changes we might have to
 189     // reconsider the use of _expand_heap_after_alloc_failure.
 190     assert(SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 191 
 192     log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (region allocation request failed). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
 193                               word_size * HeapWordSize);
 194 
 195     assert(word_size * HeapWordSize &lt; HeapRegion::GrainBytes,
 196            &quot;This kind of expansion should never be more than one region. Size: &quot; SIZE_FORMAT,
 197            word_size * HeapWordSize);
 198     if (expand_single_region(node_index)) {
 199       // Given that expand_single_region() succeeded in expanding the heap, and we
 200       // always expand the heap by an amount aligned to the heap
 201       // region size, the free list should in theory not be empty.
 202       // In either case allocate_free_region() will check for NULL.
 203       res = _hrm-&gt;allocate_free_region(type, node_index);
 204     } else {
 205       _expand_heap_after_alloc_failure = false;
 206     }
 207   }
 208   return res;
 209 }
 210 
 211 HeapWord*
<a name="2" id="anc2"></a><span class="line-modified"> 212 G1CollectedHeap::humongous_obj_allocate_initialize_regions(HeapRegion* first_hr,</span>
 213                                                            uint num_regions,
 214                                                            size_t word_size) {
<a name="3" id="anc3"></a><span class="line-modified"> 215   assert(first_hr != NULL, &quot;pre-condition&quot;);</span>
 216   assert(is_humongous(word_size), &quot;word_size should be humongous&quot;);
 217   assert(num_regions * HeapRegion::GrainWords &gt;= word_size, &quot;pre-condition&quot;);
 218 
 219   // Index of last region in the series.
<a name="4" id="anc4"></a><span class="line-added"> 220   uint first = first_hr-&gt;hrm_index();</span>
 221   uint last = first + num_regions - 1;
 222 
 223   // We need to initialize the region(s) we just discovered. This is
 224   // a bit tricky given that it can happen concurrently with
 225   // refinement threads refining cards on these regions and
 226   // potentially wanting to refine the BOT as they are scanning
 227   // those cards (this can happen shortly after a cleanup; see CR
 228   // 6991377). So we have to set up the region(s) carefully and in
 229   // a specific order.
 230 
 231   // The word size sum of all the regions we will allocate.
 232   size_t word_size_sum = (size_t) num_regions * HeapRegion::GrainWords;
 233   assert(word_size &lt;= word_size_sum, &quot;sanity&quot;);
 234 
<a name="5" id="anc5"></a><span class="line-modified"> 235   // The passed in hr will be the &quot;starts humongous&quot; region. The header</span>
<span class="line-modified"> 236   // of the new object will be placed at the bottom of this region.</span>


 237   HeapWord* new_obj = first_hr-&gt;bottom();
 238   // This will be the new top of the new object.
 239   HeapWord* obj_top = new_obj + word_size;
 240 
 241   // First, we need to zero the header of the space that we will be
 242   // allocating. When we update top further down, some refinement
 243   // threads might try to scan the region. By zeroing the header we
 244   // ensure that any thread that will try to scan the region will
 245   // come across the zero klass word and bail out.
 246   //
 247   // NOTE: It would not have been correct to have used
 248   // CollectedHeap::fill_with_object() and make the space look like
 249   // an int array. The thread that is doing the allocation will
 250   // later update the object header to a potentially different array
 251   // type and, for a very short period of time, the klass and length
 252   // fields will be inconsistent. This could cause a refinement
 253   // thread to calculate the object size incorrectly.
 254   Copy::fill_to_words(new_obj, oopDesc::header_size(), 0);
 255 
 256   // Next, pad out the unused tail of the last region with filler
 257   // objects, for improved usage accounting.
 258   // How many words we use for filler objects.
 259   size_t word_fill_size = word_size_sum - word_size;
 260 
 261   // How many words memory we &quot;waste&quot; which cannot hold a filler object.
 262   size_t words_not_fillable = 0;
 263 
 264   if (word_fill_size &gt;= min_fill_size()) {
 265     fill_with_objects(obj_top, word_fill_size);
 266   } else if (word_fill_size &gt; 0) {
 267     // We have space to fill, but we cannot fit an object there.
 268     words_not_fillable = word_fill_size;
 269     word_fill_size = 0;
 270   }
 271 
 272   // We will set up the first region as &quot;starts humongous&quot;. This
 273   // will also update the BOT covering all the regions to reflect
 274   // that there is a single object that starts at the bottom of the
 275   // first region.
 276   first_hr-&gt;set_starts_humongous(obj_top, word_fill_size);
 277   _policy-&gt;remset_tracker()-&gt;update_at_allocate(first_hr);
 278   // Then, if there are any, we will set up the &quot;continues
 279   // humongous&quot; regions.
 280   HeapRegion* hr = NULL;
 281   for (uint i = first + 1; i &lt;= last; ++i) {
 282     hr = region_at(i);
 283     hr-&gt;set_continues_humongous(first_hr);
 284     _policy-&gt;remset_tracker()-&gt;update_at_allocate(hr);
 285   }
 286 
 287   // Up to this point no concurrent thread would have been able to
 288   // do any scanning on any region in this series. All the top
 289   // fields still point to bottom, so the intersection between
 290   // [bottom,top] and [card_start,card_end] will be empty. Before we
 291   // update the top fields, we&#39;ll do a storestore to make sure that
 292   // no thread sees the update to top before the zeroing of the
 293   // object header and the BOT initialization.
 294   OrderAccess::storestore();
 295 
 296   // Now, we will update the top fields of the &quot;continues humongous&quot;
 297   // regions except the last one.
 298   for (uint i = first; i &lt; last; ++i) {
 299     hr = region_at(i);
 300     hr-&gt;set_top(hr-&gt;end());
 301   }
 302 
 303   hr = region_at(last);
 304   // If we cannot fit a filler object, we must set top to the end
 305   // of the humongous object, otherwise we cannot iterate the heap
 306   // and the BOT will not be complete.
 307   hr-&gt;set_top(hr-&gt;end() - words_not_fillable);
 308 
 309   assert(hr-&gt;bottom() &lt; obj_top &amp;&amp; obj_top &lt;= hr-&gt;end(),
 310          &quot;obj_top should be in last region&quot;);
 311 
 312   _verifier-&gt;check_bitmaps(&quot;Humongous Region Allocation&quot;, first_hr);
 313 
 314   assert(words_not_fillable == 0 ||
 315          first_hr-&gt;bottom() + word_size_sum - words_not_fillable == hr-&gt;top(),
 316          &quot;Miscalculation in humongous allocation&quot;);
 317 
 318   increase_used((word_size_sum - words_not_fillable) * HeapWordSize);
 319 
 320   for (uint i = first; i &lt;= last; ++i) {
 321     hr = region_at(i);
 322     _humongous_set.add(hr);
 323     _hr_printer.alloc(hr);
 324   }
 325 
 326   return new_obj;
 327 }
 328 
 329 size_t G1CollectedHeap::humongous_obj_size_in_regions(size_t word_size) {
 330   assert(is_humongous(word_size), &quot;Object of size &quot; SIZE_FORMAT &quot; must be humongous here&quot;, word_size);
 331   return align_up(word_size, HeapRegion::GrainWords) / HeapRegion::GrainWords;
 332 }
 333 
 334 // If could fit into free regions w/o expansion, try.
 335 // Otherwise, if can expand, do so.
 336 // Otherwise, if using ex regions might help, try with ex given back.
 337 HeapWord* G1CollectedHeap::humongous_obj_allocate(size_t word_size) {
 338   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
 339 
 340   _verifier-&gt;verify_region_sets_optional();
 341 
<a name="6" id="anc6"></a>
 342   uint obj_regions = (uint) humongous_obj_size_in_regions(word_size);
 343 
<a name="7" id="anc7"></a><span class="line-modified"> 344   // Policy: First try to allocate a humongous object in the free list.</span>
<span class="line-modified"> 345   HeapRegion* humongous_start = _hrm-&gt;allocate_humongous(obj_regions);</span>
<span class="line-modified"> 346   if (humongous_start == NULL) {</span>















 347     // Policy: We could not find enough regions for the humongous object in the
 348     // free list. Look through the heap to find a mix of free and uncommitted regions.
<a name="8" id="anc8"></a><span class="line-modified"> 349     // If so, expand the heap and allocate the humongous object.</span>
<span class="line-modified"> 350     humongous_start = _hrm-&gt;expand_and_allocate_humongous(obj_regions);</span>
<span class="line-modified"> 351     if (humongous_start != NULL) {</span>
<span class="line-modified"> 352       // We managed to find a region by expanding the heap.</span>
<span class="line-modified"> 353       log_debug(gc, ergo, heap)(&quot;Heap expansion (humongous allocation request). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,</span>
<span class="line-modified"> 354                                 word_size * HeapWordSize);</span>



 355       policy()-&gt;record_new_heap_size(num_regions());
<a name="9" id="anc9"></a>









 356     } else {
 357       // Policy: Potentially trigger a defragmentation GC.
 358     }
 359   }
 360 
 361   HeapWord* result = NULL;
<a name="10" id="anc10"></a><span class="line-modified"> 362   if (humongous_start != NULL) {</span>
<span class="line-modified"> 363     result = humongous_obj_allocate_initialize_regions(humongous_start, obj_regions, word_size);</span>
 364     assert(result != NULL, &quot;it should always return a valid result&quot;);
 365 
 366     // A successful humongous object allocation changes the used space
 367     // information of the old generation so we need to recalculate the
 368     // sizes and update the jstat counters here.
 369     g1mm()-&gt;update_sizes();
 370   }
 371 
 372   _verifier-&gt;verify_region_sets_optional();
 373 
 374   return result;
 375 }
 376 
 377 HeapWord* G1CollectedHeap::allocate_new_tlab(size_t min_size,
 378                                              size_t requested_size,
 379                                              size_t* actual_size) {
 380   assert_heap_not_locked_and_not_at_safepoint();
 381   assert(!is_humongous(requested_size), &quot;we do not allow humongous TLABs&quot;);
 382 
 383   return attempt_allocation(min_size, requested_size, actual_size);
 384 }
 385 
 386 HeapWord*
 387 G1CollectedHeap::mem_allocate(size_t word_size,
 388                               bool*  gc_overhead_limit_was_exceeded) {
 389   assert_heap_not_locked_and_not_at_safepoint();
 390 
 391   if (is_humongous(word_size)) {
 392     return attempt_allocation_humongous(word_size);
 393   }
 394   size_t dummy = 0;
 395   return attempt_allocation(word_size, word_size, &amp;dummy);
 396 }
 397 
 398 HeapWord* G1CollectedHeap::attempt_allocation_slow(size_t word_size) {
 399   ResourceMark rm; // For retrieving the thread names in log messages.
 400 
 401   // Make sure you read the note in attempt_allocation_humongous().
 402 
 403   assert_heap_not_locked_and_not_at_safepoint();
 404   assert(!is_humongous(word_size), &quot;attempt_allocation_slow() should not &quot;
 405          &quot;be called for humongous allocation requests&quot;);
 406 
 407   // We should only get here after the first-level allocation attempt
 408   // (attempt_allocation()) failed to allocate.
 409 
 410   // We will loop until a) we manage to successfully perform the
 411   // allocation or b) we successfully schedule a collection which
 412   // fails to perform the allocation. b) is the only case when we&#39;ll
 413   // return NULL.
 414   HeapWord* result = NULL;
 415   for (uint try_count = 1, gclocker_retry_count = 0; /* we&#39;ll return */; try_count += 1) {
 416     bool should_try_gc;
 417     uint gc_count_before;
 418 
 419     {
 420       MutexLocker x(Heap_lock);
 421       result = _allocator-&gt;attempt_allocation_locked(word_size);
 422       if (result != NULL) {
 423         return result;
 424       }
 425 
 426       // If the GCLocker is active and we are bound for a GC, try expanding young gen.
 427       // This is different to when only GCLocker::needs_gc() is set: try to avoid
 428       // waiting because the GCLocker is active to not wait too long.
 429       if (GCLocker::is_active_and_needs_gc() &amp;&amp; policy()-&gt;can_expand_young_list()) {
 430         // No need for an ergo message here, can_expand_young_list() does this when
 431         // it returns true.
 432         result = _allocator-&gt;attempt_allocation_force(word_size);
 433         if (result != NULL) {
 434           return result;
 435         }
 436       }
 437       // Only try a GC if the GCLocker does not signal the need for a GC. Wait until
 438       // the GCLocker initiated GC has been performed and then retry. This includes
 439       // the case when the GC Locker is not active but has not been performed.
 440       should_try_gc = !GCLocker::needs_gc();
 441       // Read the GC count while still holding the Heap_lock.
 442       gc_count_before = total_collections();
 443     }
 444 
 445     if (should_try_gc) {
 446       bool succeeded;
 447       result = do_collection_pause(word_size, gc_count_before, &amp;succeeded,
 448                                    GCCause::_g1_inc_collection_pause);
 449       if (result != NULL) {
 450         assert(succeeded, &quot;only way to get back a non-NULL result&quot;);
 451         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection returning &quot; PTR_FORMAT,
 452                              Thread::current()-&gt;name(), p2i(result));
 453         return result;
 454       }
 455 
 456       if (succeeded) {
 457         // We successfully scheduled a collection which failed to allocate. No
 458         // point in trying to allocate further. We&#39;ll just return NULL.
 459         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection failing to allocate &quot;
 460                              SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 461         return NULL;
 462       }
 463       log_trace(gc, alloc)(&quot;%s: Unsuccessfully scheduled collection allocating &quot; SIZE_FORMAT &quot; words&quot;,
 464                            Thread::current()-&gt;name(), word_size);
 465     } else {
 466       // Failed to schedule a collection.
 467       if (gclocker_retry_count &gt; GCLockerRetryAllocationCount) {
 468         log_warning(gc, alloc)(&quot;%s: Retried waiting for GCLocker too often allocating &quot;
 469                                SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 470         return NULL;
 471       }
 472       log_trace(gc, alloc)(&quot;%s: Stall until clear&quot;, Thread::current()-&gt;name());
 473       // The GCLocker is either active or the GCLocker initiated
 474       // GC has not yet been performed. Stall until it is and
 475       // then retry the allocation.
 476       GCLocker::stall_until_clear();
 477       gclocker_retry_count += 1;
 478     }
 479 
 480     // We can reach here if we were unsuccessful in scheduling a
 481     // collection (because another thread beat us to it) or if we were
 482     // stalled due to the GC locker. In either can we should retry the
 483     // allocation attempt in case another thread successfully
 484     // performed a collection and reclaimed enough space. We do the
 485     // first attempt (without holding the Heap_lock) here and the
 486     // follow-on attempt will be at the start of the next loop
 487     // iteration (after taking the Heap_lock).
 488     size_t dummy = 0;
 489     result = _allocator-&gt;attempt_allocation(word_size, word_size, &amp;dummy);
 490     if (result != NULL) {
 491       return result;
 492     }
 493 
 494     // Give a warning if we seem to be looping forever.
 495     if ((QueuedAllocationWarningCount &gt; 0) &amp;&amp;
 496         (try_count % QueuedAllocationWarningCount == 0)) {
 497       log_warning(gc, alloc)(&quot;%s:  Retried allocation %u times for &quot; SIZE_FORMAT &quot; words&quot;,
 498                              Thread::current()-&gt;name(), try_count, word_size);
 499     }
 500   }
 501 
 502   ShouldNotReachHere();
 503   return NULL;
 504 }
 505 
 506 void G1CollectedHeap::begin_archive_alloc_range(bool open) {
 507   assert_at_safepoint_on_vm_thread();
 508   if (_archive_allocator == NULL) {
 509     _archive_allocator = G1ArchiveAllocator::create_allocator(this, open);
 510   }
 511 }
 512 
 513 bool G1CollectedHeap::is_archive_alloc_too_large(size_t word_size) {
 514   // Allocations in archive regions cannot be of a size that would be considered
 515   // humongous even for a minimum-sized region, because G1 region sizes/boundaries
 516   // may be different at archive-restore time.
 517   return word_size &gt;= humongous_threshold_for(HeapRegion::min_region_size_in_words());
 518 }
 519 
 520 HeapWord* G1CollectedHeap::archive_mem_allocate(size_t word_size) {
 521   assert_at_safepoint_on_vm_thread();
 522   assert(_archive_allocator != NULL, &quot;_archive_allocator not initialized&quot;);
 523   if (is_archive_alloc_too_large(word_size)) {
 524     return NULL;
 525   }
 526   return _archive_allocator-&gt;archive_mem_allocate(word_size);
 527 }
 528 
 529 void G1CollectedHeap::end_archive_alloc_range(GrowableArray&lt;MemRegion&gt;* ranges,
 530                                               size_t end_alignment_in_bytes) {
 531   assert_at_safepoint_on_vm_thread();
 532   assert(_archive_allocator != NULL, &quot;_archive_allocator not initialized&quot;);
 533 
 534   // Call complete_archive to do the real work, filling in the MemRegion
 535   // array with the archive regions.
 536   _archive_allocator-&gt;complete_archive(ranges, end_alignment_in_bytes);
 537   delete _archive_allocator;
 538   _archive_allocator = NULL;
 539 }
 540 
 541 bool G1CollectedHeap::check_archive_addresses(MemRegion* ranges, size_t count) {
 542   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 543   assert(count != 0, &quot;No MemRegions provided&quot;);
 544   MemRegion reserved = _hrm-&gt;reserved();
 545   for (size_t i = 0; i &lt; count; i++) {
 546     if (!reserved.contains(ranges[i].start()) || !reserved.contains(ranges[i].last())) {
 547       return false;
 548     }
 549   }
 550   return true;
 551 }
 552 
 553 bool G1CollectedHeap::alloc_archive_regions(MemRegion* ranges,
 554                                             size_t count,
 555                                             bool open) {
 556   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 557   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 558   assert(count != 0, &quot;No MemRegions provided&quot;);
 559   MutexLocker x(Heap_lock);
 560 
 561   MemRegion reserved = _hrm-&gt;reserved();
 562   HeapWord* prev_last_addr = NULL;
 563   HeapRegion* prev_last_region = NULL;
 564 
 565   // Temporarily disable pretouching of heap pages. This interface is used
 566   // when mmap&#39;ing archived heap data in, so pre-touching is wasted.
 567   FlagSetting fs(AlwaysPreTouch, false);
 568 
 569   // Enable archive object checking used by G1MarkSweep. We have to let it know
 570   // about each archive range, so that objects in those ranges aren&#39;t marked.
 571   G1ArchiveAllocator::enable_archive_object_check();
 572 
 573   // For each specified MemRegion range, allocate the corresponding G1
 574   // regions and mark them as archive regions. We expect the ranges
 575   // in ascending starting address order, without overlap.
 576   for (size_t i = 0; i &lt; count; i++) {
 577     MemRegion curr_range = ranges[i];
 578     HeapWord* start_address = curr_range.start();
 579     size_t word_size = curr_range.word_size();
 580     HeapWord* last_address = curr_range.last();
 581     size_t commits = 0;
 582 
 583     guarantee(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 584               &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 585               p2i(start_address), p2i(last_address));
 586     guarantee(start_address &gt; prev_last_addr,
 587               &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 588               p2i(start_address), p2i(prev_last_addr));
 589     prev_last_addr = last_address;
 590 
 591     // Check for ranges that start in the same G1 region in which the previous
 592     // range ended, and adjust the start address so we don&#39;t try to allocate
 593     // the same region again. If the current range is entirely within that
 594     // region, skip it, just adjusting the recorded top.
 595     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 596     if ((prev_last_region != NULL) &amp;&amp; (start_region == prev_last_region)) {
 597       start_address = start_region-&gt;end();
 598       if (start_address &gt; last_address) {
 599         increase_used(word_size * HeapWordSize);
 600         start_region-&gt;set_top(last_address + 1);
 601         continue;
 602       }
 603       start_region-&gt;set_top(start_address);
 604       curr_range = MemRegion(start_address, last_address + 1);
 605       start_region = _hrm-&gt;addr_to_region(start_address);
 606     }
 607 
 608     // Perform the actual region allocation, exiting if it fails.
 609     // Then note how much new space we have allocated.
 610     if (!_hrm-&gt;allocate_containing_regions(curr_range, &amp;commits, workers())) {
 611       return false;
 612     }
 613     increase_used(word_size * HeapWordSize);
 614     if (commits != 0) {
 615       log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (allocate archive regions). Total size: &quot; SIZE_FORMAT &quot;B&quot;,
 616                                 HeapRegion::GrainWords * HeapWordSize * commits);
 617 
 618     }
 619 
 620     // Mark each G1 region touched by the range as archive, add it to
 621     // the old set, and set top.
 622     HeapRegion* curr_region = _hrm-&gt;addr_to_region(start_address);
 623     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 624     prev_last_region = last_region;
 625 
 626     while (curr_region != NULL) {
 627       assert(curr_region-&gt;is_empty() &amp;&amp; !curr_region-&gt;is_pinned(),
 628              &quot;Region already in use (index %u)&quot;, curr_region-&gt;hrm_index());
 629       if (open) {
 630         curr_region-&gt;set_open_archive();
 631       } else {
 632         curr_region-&gt;set_closed_archive();
 633       }
 634       _hr_printer.alloc(curr_region);
 635       _archive_set.add(curr_region);
 636       HeapWord* top;
 637       HeapRegion* next_region;
 638       if (curr_region != last_region) {
 639         top = curr_region-&gt;end();
 640         next_region = _hrm-&gt;next_region_in_heap(curr_region);
 641       } else {
 642         top = last_address + 1;
 643         next_region = NULL;
 644       }
 645       curr_region-&gt;set_top(top);
 646       curr_region = next_region;
 647     }
 648 
 649     // Notify mark-sweep of the archive
 650     G1ArchiveAllocator::set_range_archive(curr_range, open);
 651   }
 652   return true;
 653 }
 654 
 655 void G1CollectedHeap::fill_archive_regions(MemRegion* ranges, size_t count) {
 656   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 657   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 658   assert(count != 0, &quot;No MemRegions provided&quot;);
 659   MemRegion reserved = _hrm-&gt;reserved();
 660   HeapWord *prev_last_addr = NULL;
 661   HeapRegion* prev_last_region = NULL;
 662 
 663   // For each MemRegion, create filler objects, if needed, in the G1 regions
 664   // that contain the address range. The address range actually within the
 665   // MemRegion will not be modified. That is assumed to have been initialized
 666   // elsewhere, probably via an mmap of archived heap data.
 667   MutexLocker x(Heap_lock);
 668   for (size_t i = 0; i &lt; count; i++) {
 669     HeapWord* start_address = ranges[i].start();
 670     HeapWord* last_address = ranges[i].last();
 671 
 672     assert(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 673            &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 674            p2i(start_address), p2i(last_address));
 675     assert(start_address &gt; prev_last_addr,
 676            &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 677            p2i(start_address), p2i(prev_last_addr));
 678 
 679     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 680     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 681     HeapWord* bottom_address = start_region-&gt;bottom();
 682 
 683     // Check for a range beginning in the same region in which the
 684     // previous one ended.
 685     if (start_region == prev_last_region) {
 686       bottom_address = prev_last_addr + 1;
 687     }
 688 
 689     // Verify that the regions were all marked as archive regions by
 690     // alloc_archive_regions.
 691     HeapRegion* curr_region = start_region;
 692     while (curr_region != NULL) {
 693       guarantee(curr_region-&gt;is_archive(),
 694                 &quot;Expected archive region at index %u&quot;, curr_region-&gt;hrm_index());
 695       if (curr_region != last_region) {
 696         curr_region = _hrm-&gt;next_region_in_heap(curr_region);
 697       } else {
 698         curr_region = NULL;
 699       }
 700     }
 701 
 702     prev_last_addr = last_address;
 703     prev_last_region = last_region;
 704 
 705     // Fill the memory below the allocated range with dummy object(s),
 706     // if the region bottom does not match the range start, or if the previous
 707     // range ended within the same G1 region, and there is a gap.
 708     if (start_address != bottom_address) {
 709       size_t fill_size = pointer_delta(start_address, bottom_address);
 710       G1CollectedHeap::fill_with_objects(bottom_address, fill_size);
 711       increase_used(fill_size * HeapWordSize);
 712     }
 713   }
 714 }
 715 
 716 inline HeapWord* G1CollectedHeap::attempt_allocation(size_t min_word_size,
 717                                                      size_t desired_word_size,
 718                                                      size_t* actual_word_size) {
 719   assert_heap_not_locked_and_not_at_safepoint();
 720   assert(!is_humongous(desired_word_size), &quot;attempt_allocation() should not &quot;
 721          &quot;be called for humongous allocation requests&quot;);
 722 
 723   HeapWord* result = _allocator-&gt;attempt_allocation(min_word_size, desired_word_size, actual_word_size);
 724 
 725   if (result == NULL) {
 726     *actual_word_size = desired_word_size;
 727     result = attempt_allocation_slow(desired_word_size);
 728   }
 729 
 730   assert_heap_not_locked();
 731   if (result != NULL) {
 732     assert(*actual_word_size != 0, &quot;Actual size must have been set here&quot;);
 733     dirty_young_block(result, *actual_word_size);
 734   } else {
 735     *actual_word_size = 0;
 736   }
 737 
 738   return result;
 739 }
 740 
 741 void G1CollectedHeap::dealloc_archive_regions(MemRegion* ranges, size_t count) {
 742   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 743   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 744   assert(count != 0, &quot;No MemRegions provided&quot;);
 745   MemRegion reserved = _hrm-&gt;reserved();
 746   HeapWord* prev_last_addr = NULL;
 747   HeapRegion* prev_last_region = NULL;
 748   size_t size_used = 0;
 749   size_t uncommitted_regions = 0;
 750 
 751   // For each Memregion, free the G1 regions that constitute it, and
 752   // notify mark-sweep that the range is no longer to be considered &#39;archive.&#39;
 753   MutexLocker x(Heap_lock);
 754   for (size_t i = 0; i &lt; count; i++) {
 755     HeapWord* start_address = ranges[i].start();
 756     HeapWord* last_address = ranges[i].last();
 757 
 758     assert(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 759            &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 760            p2i(start_address), p2i(last_address));
 761     assert(start_address &gt; prev_last_addr,
 762            &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 763            p2i(start_address), p2i(prev_last_addr));
 764     size_used += ranges[i].byte_size();
 765     prev_last_addr = last_address;
 766 
 767     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 768     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 769 
 770     // Check for ranges that start in the same G1 region in which the previous
 771     // range ended, and adjust the start address so we don&#39;t try to free
 772     // the same region again. If the current range is entirely within that
 773     // region, skip it.
 774     if (start_region == prev_last_region) {
 775       start_address = start_region-&gt;end();
 776       if (start_address &gt; last_address) {
 777         continue;
 778       }
 779       start_region = _hrm-&gt;addr_to_region(start_address);
 780     }
 781     prev_last_region = last_region;
 782 
 783     // After verifying that each region was marked as an archive region by
 784     // alloc_archive_regions, set it free and empty and uncommit it.
 785     HeapRegion* curr_region = start_region;
 786     while (curr_region != NULL) {
 787       guarantee(curr_region-&gt;is_archive(),
 788                 &quot;Expected archive region at index %u&quot;, curr_region-&gt;hrm_index());
 789       uint curr_index = curr_region-&gt;hrm_index();
 790       _archive_set.remove(curr_region);
 791       curr_region-&gt;set_free();
 792       curr_region-&gt;set_top(curr_region-&gt;bottom());
 793       if (curr_region != last_region) {
 794         curr_region = _hrm-&gt;next_region_in_heap(curr_region);
 795       } else {
 796         curr_region = NULL;
 797       }
 798       _hrm-&gt;shrink_at(curr_index, 1);
 799       uncommitted_regions++;
 800     }
 801 
 802     // Notify mark-sweep that this is no longer an archive range.
 803     G1ArchiveAllocator::clear_range_archive(ranges[i]);
 804   }
 805 
 806   if (uncommitted_regions != 0) {
 807     log_debug(gc, ergo, heap)(&quot;Attempt heap shrinking (uncommitted archive regions). Total size: &quot; SIZE_FORMAT &quot;B&quot;,
 808                               HeapRegion::GrainWords * HeapWordSize * uncommitted_regions);
 809   }
 810   decrease_used(size_used);
 811 }
 812 
 813 oop G1CollectedHeap::materialize_archived_object(oop obj) {
 814   assert(obj != NULL, &quot;archived obj is NULL&quot;);
 815   assert(G1ArchiveAllocator::is_archived_object(obj), &quot;must be archived object&quot;);
 816 
 817   // Loading an archived object makes it strongly reachable. If it is
 818   // loaded during concurrent marking, it must be enqueued to the SATB
 819   // queue, shading the previously white object gray.
 820   G1BarrierSet::enqueue(obj);
 821 
 822   return obj;
 823 }
 824 
 825 HeapWord* G1CollectedHeap::attempt_allocation_humongous(size_t word_size) {
 826   ResourceMark rm; // For retrieving the thread names in log messages.
 827 
 828   // The structure of this method has a lot of similarities to
 829   // attempt_allocation_slow(). The reason these two were not merged
 830   // into a single one is that such a method would require several &quot;if
 831   // allocation is not humongous do this, otherwise do that&quot;
 832   // conditional paths which would obscure its flow. In fact, an early
 833   // version of this code did use a unified method which was harder to
 834   // follow and, as a result, it had subtle bugs that were hard to
 835   // track down. So keeping these two methods separate allows each to
 836   // be more readable. It will be good to keep these two in sync as
 837   // much as possible.
 838 
 839   assert_heap_not_locked_and_not_at_safepoint();
 840   assert(is_humongous(word_size), &quot;attempt_allocation_humongous() &quot;
 841          &quot;should only be called for humongous allocations&quot;);
 842 
 843   // Humongous objects can exhaust the heap quickly, so we should check if we
 844   // need to start a marking cycle at each humongous object allocation. We do
 845   // the check before we do the actual allocation. The reason for doing it
 846   // before the allocation is that we avoid having to keep track of the newly
 847   // allocated memory while we do a GC.
 848   if (policy()-&gt;need_to_start_conc_mark(&quot;concurrent humongous allocation&quot;,
 849                                            word_size)) {
 850     collect(GCCause::_g1_humongous_allocation);
 851   }
 852 
 853   // We will loop until a) we manage to successfully perform the
 854   // allocation or b) we successfully schedule a collection which
 855   // fails to perform the allocation. b) is the only case when we&#39;ll
 856   // return NULL.
 857   HeapWord* result = NULL;
 858   for (uint try_count = 1, gclocker_retry_count = 0; /* we&#39;ll return */; try_count += 1) {
 859     bool should_try_gc;
 860     uint gc_count_before;
 861 
 862 
 863     {
 864       MutexLocker x(Heap_lock);
 865 
 866       // Given that humongous objects are not allocated in young
 867       // regions, we&#39;ll first try to do the allocation without doing a
 868       // collection hoping that there&#39;s enough space in the heap.
 869       result = humongous_obj_allocate(word_size);
 870       if (result != NULL) {
 871         size_t size_in_regions = humongous_obj_size_in_regions(word_size);
 872         policy()-&gt;add_bytes_allocated_in_old_since_last_gc(size_in_regions * HeapRegion::GrainBytes);
 873         return result;
 874       }
 875 
 876       // Only try a GC if the GCLocker does not signal the need for a GC. Wait until
 877       // the GCLocker initiated GC has been performed and then retry. This includes
 878       // the case when the GC Locker is not active but has not been performed.
 879       should_try_gc = !GCLocker::needs_gc();
 880       // Read the GC count while still holding the Heap_lock.
 881       gc_count_before = total_collections();
 882     }
 883 
 884     if (should_try_gc) {
 885       bool succeeded;
 886       result = do_collection_pause(word_size, gc_count_before, &amp;succeeded,
 887                                    GCCause::_g1_humongous_allocation);
 888       if (result != NULL) {
 889         assert(succeeded, &quot;only way to get back a non-NULL result&quot;);
 890         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection returning &quot; PTR_FORMAT,
 891                              Thread::current()-&gt;name(), p2i(result));
 892         return result;
 893       }
 894 
 895       if (succeeded) {
 896         // We successfully scheduled a collection which failed to allocate. No
 897         // point in trying to allocate further. We&#39;ll just return NULL.
 898         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection failing to allocate &quot;
 899                              SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 900         return NULL;
 901       }
 902       log_trace(gc, alloc)(&quot;%s: Unsuccessfully scheduled collection allocating &quot; SIZE_FORMAT &quot;&quot;,
 903                            Thread::current()-&gt;name(), word_size);
 904     } else {
 905       // Failed to schedule a collection.
 906       if (gclocker_retry_count &gt; GCLockerRetryAllocationCount) {
 907         log_warning(gc, alloc)(&quot;%s: Retried waiting for GCLocker too often allocating &quot;
 908                                SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 909         return NULL;
 910       }
 911       log_trace(gc, alloc)(&quot;%s: Stall until clear&quot;, Thread::current()-&gt;name());
 912       // The GCLocker is either active or the GCLocker initiated
 913       // GC has not yet been performed. Stall until it is and
 914       // then retry the allocation.
 915       GCLocker::stall_until_clear();
 916       gclocker_retry_count += 1;
 917     }
 918 
 919 
 920     // We can reach here if we were unsuccessful in scheduling a
 921     // collection (because another thread beat us to it) or if we were
 922     // stalled due to the GC locker. In either can we should retry the
 923     // allocation attempt in case another thread successfully
 924     // performed a collection and reclaimed enough space.
 925     // Humongous object allocation always needs a lock, so we wait for the retry
 926     // in the next iteration of the loop, unlike for the regular iteration case.
 927     // Give a warning if we seem to be looping forever.
 928 
 929     if ((QueuedAllocationWarningCount &gt; 0) &amp;&amp;
 930         (try_count % QueuedAllocationWarningCount == 0)) {
 931       log_warning(gc, alloc)(&quot;%s: Retried allocation %u times for &quot; SIZE_FORMAT &quot; words&quot;,
 932                              Thread::current()-&gt;name(), try_count, word_size);
 933     }
 934   }
 935 
 936   ShouldNotReachHere();
 937   return NULL;
 938 }
 939 
 940 HeapWord* G1CollectedHeap::attempt_allocation_at_safepoint(size_t word_size,
 941                                                            bool expect_null_mutator_alloc_region) {
 942   assert_at_safepoint_on_vm_thread();
 943   assert(!_allocator-&gt;has_mutator_alloc_region() || !expect_null_mutator_alloc_region,
 944          &quot;the current alloc region was unexpectedly found to be non-NULL&quot;);
 945 
 946   if (!is_humongous(word_size)) {
 947     return _allocator-&gt;attempt_allocation_locked(word_size);
 948   } else {
 949     HeapWord* result = humongous_obj_allocate(word_size);
 950     if (result != NULL &amp;&amp; policy()-&gt;need_to_start_conc_mark(&quot;STW humongous allocation&quot;)) {
 951       collector_state()-&gt;set_initiate_conc_mark_if_possible(true);
 952     }
 953     return result;
 954   }
 955 
 956   ShouldNotReachHere();
 957 }
 958 
 959 class PostCompactionPrinterClosure: public HeapRegionClosure {
 960 private:
 961   G1HRPrinter* _hr_printer;
 962 public:
 963   bool do_heap_region(HeapRegion* hr) {
 964     assert(!hr-&gt;is_young(), &quot;not expecting to find young regions&quot;);
 965     _hr_printer-&gt;post_compaction(hr);
 966     return false;
 967   }
 968 
 969   PostCompactionPrinterClosure(G1HRPrinter* hr_printer)
 970     : _hr_printer(hr_printer) { }
 971 };
 972 
 973 void G1CollectedHeap::print_hrm_post_compaction() {
 974   if (_hr_printer.is_active()) {
 975     PostCompactionPrinterClosure cl(hr_printer());
 976     heap_region_iterate(&amp;cl);
 977   }
 978 }
 979 
 980 void G1CollectedHeap::abort_concurrent_cycle() {
 981   // If we start the compaction before the CM threads finish
 982   // scanning the root regions we might trip them over as we&#39;ll
 983   // be moving objects / updating references. So let&#39;s wait until
 984   // they are done. By telling them to abort, they should complete
 985   // early.
 986   _cm-&gt;root_regions()-&gt;abort();
 987   _cm-&gt;root_regions()-&gt;wait_until_scan_finished();
 988 
 989   // Disable discovery and empty the discovered lists
 990   // for the CM ref processor.
 991   _ref_processor_cm-&gt;disable_discovery();
 992   _ref_processor_cm-&gt;abandon_partial_discovery();
 993   _ref_processor_cm-&gt;verify_no_references_recorded();
 994 
 995   // Abandon current iterations of concurrent marking and concurrent
 996   // refinement, if any are in progress.
 997   concurrent_mark()-&gt;concurrent_cycle_abort();
 998 }
 999 
1000 void G1CollectedHeap::prepare_heap_for_full_collection() {
1001   // Make sure we&#39;ll choose a new allocation region afterwards.
1002   _allocator-&gt;release_mutator_alloc_regions();
1003   _allocator-&gt;abandon_gc_alloc_regions();
1004 
1005   // We may have added regions to the current incremental collection
1006   // set between the last GC or pause and now. We need to clear the
1007   // incremental collection set and then start rebuilding it afresh
1008   // after this full GC.
1009   abandon_collection_set(collection_set());
1010 
1011   tear_down_region_sets(false /* free_list_only */);
1012 
1013   hrm()-&gt;prepare_for_full_collection_start();
1014 }
1015 
1016 void G1CollectedHeap::verify_before_full_collection(bool explicit_gc) {
1017   assert(!GCCause::is_user_requested_gc(gc_cause()) || explicit_gc, &quot;invariant&quot;);
1018   assert_used_and_recalculate_used_equal(this);
1019   _verifier-&gt;verify_region_sets_optional();
1020   _verifier-&gt;verify_before_gc(G1HeapVerifier::G1VerifyFull);
1021   _verifier-&gt;check_bitmaps(&quot;Full GC Start&quot;);
1022 }
1023 
1024 void G1CollectedHeap::prepare_heap_for_mutators() {
1025   hrm()-&gt;prepare_for_full_collection_end();
1026 
1027   // Delete metaspaces for unloaded class loaders and clean up loader_data graph
1028   ClassLoaderDataGraph::purge();
1029   MetaspaceUtils::verify_metrics();
1030 
1031   // Prepare heap for normal collections.
1032   assert(num_free_regions() == 0, &quot;we should not have added any free regions&quot;);
1033   rebuild_region_sets(false /* free_list_only */);
1034   abort_refinement();
1035   resize_heap_if_necessary();
1036 
1037   // Rebuild the strong code root lists for each region
1038   rebuild_strong_code_roots();
1039 
1040   // Purge code root memory
1041   purge_code_root_memory();
1042 
1043   // Start a new incremental collection set for the next pause
1044   start_new_collection_set();
1045 
1046   _allocator-&gt;init_mutator_alloc_regions();
1047 
1048   // Post collection state updates.
1049   MetaspaceGC::compute_new_size();
1050 }
1051 
1052 void G1CollectedHeap::abort_refinement() {
1053   if (_hot_card_cache-&gt;use_cache()) {
1054     _hot_card_cache-&gt;reset_hot_cache();
1055   }
1056 
1057   // Discard all remembered set updates.
1058   G1BarrierSet::dirty_card_queue_set().abandon_logs();
1059   assert(G1BarrierSet::dirty_card_queue_set().num_cards() == 0,
1060          &quot;DCQS should be empty&quot;);
1061 }
1062 
1063 void G1CollectedHeap::verify_after_full_collection() {
1064   _hrm-&gt;verify_optional();
1065   _verifier-&gt;verify_region_sets_optional();
1066   _verifier-&gt;verify_after_gc(G1HeapVerifier::G1VerifyFull);
1067   // Clear the previous marking bitmap, if needed for bitmap verification.
1068   // Note we cannot do this when we clear the next marking bitmap in
1069   // G1ConcurrentMark::abort() above since VerifyDuringGC verifies the
1070   // objects marked during a full GC against the previous bitmap.
1071   // But we need to clear it before calling check_bitmaps below since
1072   // the full GC has compacted objects and updated TAMS but not updated
1073   // the prev bitmap.
1074   if (G1VerifyBitmaps) {
1075     GCTraceTime(Debug, gc) tm(&quot;Clear Prev Bitmap for Verification&quot;);
1076     _cm-&gt;clear_prev_bitmap(workers());
1077   }
1078   // This call implicitly verifies that the next bitmap is clear after Full GC.
1079   _verifier-&gt;check_bitmaps(&quot;Full GC End&quot;);
1080 
1081   // At this point there should be no regions in the
1082   // entire heap tagged as young.
1083   assert(check_young_list_empty(), &quot;young list should be empty at this point&quot;);
1084 
1085   // Note: since we&#39;ve just done a full GC, concurrent
1086   // marking is no longer active. Therefore we need not
1087   // re-enable reference discovery for the CM ref processor.
1088   // That will be done at the start of the next marking cycle.
1089   // We also know that the STW processor should no longer
1090   // discover any new references.
1091   assert(!_ref_processor_stw-&gt;discovery_enabled(), &quot;Postcondition&quot;);
1092   assert(!_ref_processor_cm-&gt;discovery_enabled(), &quot;Postcondition&quot;);
1093   _ref_processor_stw-&gt;verify_no_references_recorded();
1094   _ref_processor_cm-&gt;verify_no_references_recorded();
1095 }
1096 
1097 void G1CollectedHeap::print_heap_after_full_collection(G1HeapTransition* heap_transition) {
1098   // Post collection logging.
1099   // We should do this after we potentially resize the heap so
1100   // that all the COMMIT / UNCOMMIT events are generated before
1101   // the compaction events.
1102   print_hrm_post_compaction();
1103   heap_transition-&gt;print();
1104   print_heap_after_gc();
1105   print_heap_regions();
1106 }
1107 
1108 bool G1CollectedHeap::do_full_collection(bool explicit_gc,
1109                                          bool clear_all_soft_refs) {
1110   assert_at_safepoint_on_vm_thread();
1111 
1112   if (GCLocker::check_active_before_gc()) {
1113     // Full GC was not completed.
1114     return false;
1115   }
1116 
1117   const bool do_clear_all_soft_refs = clear_all_soft_refs ||
1118       soft_ref_policy()-&gt;should_clear_all_soft_refs();
1119 
1120   G1FullCollector collector(this, explicit_gc, do_clear_all_soft_refs);
1121   GCTraceTime(Info, gc) tm(&quot;Pause Full&quot;, NULL, gc_cause(), true);
1122 
1123   collector.prepare_collection();
1124   collector.collect();
1125   collector.complete_collection();
1126 
1127   // Full collection was successfully completed.
1128   return true;
1129 }
1130 
1131 void G1CollectedHeap::do_full_collection(bool clear_all_soft_refs) {
1132   // Currently, there is no facility in the do_full_collection(bool) API to notify
1133   // the caller that the collection did not succeed (e.g., because it was locked
1134   // out by the GC locker). So, right now, we&#39;ll ignore the return value.
1135   bool dummy = do_full_collection(true,                /* explicit_gc */
1136                                   clear_all_soft_refs);
1137 }
1138 
1139 void G1CollectedHeap::resize_heap_if_necessary() {
1140   assert_at_safepoint_on_vm_thread();
1141 
1142   // Capacity, free and used after the GC counted as full regions to
1143   // include the waste in the following calculations.
1144   const size_t capacity_after_gc = capacity();
1145   const size_t used_after_gc = capacity_after_gc - unused_committed_regions_in_bytes();
1146 
1147   // This is enforced in arguments.cpp.
1148   assert(MinHeapFreeRatio &lt;= MaxHeapFreeRatio,
1149          &quot;otherwise the code below doesn&#39;t make sense&quot;);
1150 
1151   // We don&#39;t have floating point command-line arguments
1152   const double minimum_free_percentage = (double) MinHeapFreeRatio / 100.0;
1153   const double maximum_used_percentage = 1.0 - minimum_free_percentage;
1154   const double maximum_free_percentage = (double) MaxHeapFreeRatio / 100.0;
1155   const double minimum_used_percentage = 1.0 - maximum_free_percentage;
1156 
1157   // We have to be careful here as these two calculations can overflow
1158   // 32-bit size_t&#39;s.
1159   double used_after_gc_d = (double) used_after_gc;
1160   double minimum_desired_capacity_d = used_after_gc_d / maximum_used_percentage;
1161   double maximum_desired_capacity_d = used_after_gc_d / minimum_used_percentage;
1162 
1163   // Let&#39;s make sure that they are both under the max heap size, which
1164   // by default will make them fit into a size_t.
1165   double desired_capacity_upper_bound = (double) MaxHeapSize;
1166   minimum_desired_capacity_d = MIN2(minimum_desired_capacity_d,
1167                                     desired_capacity_upper_bound);
1168   maximum_desired_capacity_d = MIN2(maximum_desired_capacity_d,
1169                                     desired_capacity_upper_bound);
1170 
1171   // We can now safely turn them into size_t&#39;s.
1172   size_t minimum_desired_capacity = (size_t) minimum_desired_capacity_d;
1173   size_t maximum_desired_capacity = (size_t) maximum_desired_capacity_d;
1174 
1175   // This assert only makes sense here, before we adjust them
1176   // with respect to the min and max heap size.
1177   assert(minimum_desired_capacity &lt;= maximum_desired_capacity,
1178          &quot;minimum_desired_capacity = &quot; SIZE_FORMAT &quot;, &quot;
1179          &quot;maximum_desired_capacity = &quot; SIZE_FORMAT,
1180          minimum_desired_capacity, maximum_desired_capacity);
1181 
1182   // Should not be greater than the heap max size. No need to adjust
1183   // it with respect to the heap min size as it&#39;s a lower bound (i.e.,
1184   // we&#39;ll try to make the capacity larger than it, not smaller).
1185   minimum_desired_capacity = MIN2(minimum_desired_capacity, MaxHeapSize);
1186   // Should not be less than the heap min size. No need to adjust it
1187   // with respect to the heap max size as it&#39;s an upper bound (i.e.,
1188   // we&#39;ll try to make the capacity smaller than it, not greater).
1189   maximum_desired_capacity =  MAX2(maximum_desired_capacity, MinHeapSize);
1190 
1191   if (capacity_after_gc &lt; minimum_desired_capacity) {
1192     // Don&#39;t expand unless it&#39;s significant
1193     size_t expand_bytes = minimum_desired_capacity - capacity_after_gc;
1194 
1195     log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (capacity lower than min desired capacity). &quot;
1196                               &quot;Capacity: &quot; SIZE_FORMAT &quot;B occupancy: &quot; SIZE_FORMAT &quot;B live: &quot; SIZE_FORMAT &quot;B &quot;
1197                               &quot;min_desired_capacity: &quot; SIZE_FORMAT &quot;B (&quot; UINTX_FORMAT &quot; %%)&quot;,
1198                               capacity_after_gc, used_after_gc, used(), minimum_desired_capacity, MinHeapFreeRatio);
1199 
1200     expand(expand_bytes, _workers);
1201 
1202     // No expansion, now see if we want to shrink
1203   } else if (capacity_after_gc &gt; maximum_desired_capacity) {
1204     // Capacity too large, compute shrinking size
1205     size_t shrink_bytes = capacity_after_gc - maximum_desired_capacity;
1206 
1207     log_debug(gc, ergo, heap)(&quot;Attempt heap shrinking (capacity higher than max desired capacity). &quot;
1208                               &quot;Capacity: &quot; SIZE_FORMAT &quot;B occupancy: &quot; SIZE_FORMAT &quot;B live: &quot; SIZE_FORMAT &quot;B &quot;
1209                               &quot;maximum_desired_capacity: &quot; SIZE_FORMAT &quot;B (&quot; UINTX_FORMAT &quot; %%)&quot;,
1210                               capacity_after_gc, used_after_gc, used(), maximum_desired_capacity, MaxHeapFreeRatio);
1211 
1212     shrink(shrink_bytes);
1213   }
1214 }
1215 
1216 HeapWord* G1CollectedHeap::satisfy_failed_allocation_helper(size_t word_size,
1217                                                             bool do_gc,
1218                                                             bool clear_all_soft_refs,
1219                                                             bool expect_null_mutator_alloc_region,
1220                                                             bool* gc_succeeded) {
1221   *gc_succeeded = true;
1222   // Let&#39;s attempt the allocation first.
1223   HeapWord* result =
1224     attempt_allocation_at_safepoint(word_size,
1225                                     expect_null_mutator_alloc_region);
1226   if (result != NULL) {
1227     return result;
1228   }
1229 
1230   // In a G1 heap, we&#39;re supposed to keep allocation from failing by
1231   // incremental pauses.  Therefore, at least for now, we&#39;ll favor
1232   // expansion over collection.  (This might change in the future if we can
1233   // do something smarter than full collection to satisfy a failed alloc.)
1234   result = expand_and_allocate(word_size);
1235   if (result != NULL) {
1236     return result;
1237   }
1238 
1239   if (do_gc) {
1240     // Expansion didn&#39;t work, we&#39;ll try to do a Full GC.
1241     *gc_succeeded = do_full_collection(false, /* explicit_gc */
1242                                        clear_all_soft_refs);
1243   }
1244 
1245   return NULL;
1246 }
1247 
1248 HeapWord* G1CollectedHeap::satisfy_failed_allocation(size_t word_size,
1249                                                      bool* succeeded) {
1250   assert_at_safepoint_on_vm_thread();
1251 
1252   // Attempts to allocate followed by Full GC.
1253   HeapWord* result =
1254     satisfy_failed_allocation_helper(word_size,
1255                                      true,  /* do_gc */
1256                                      false, /* clear_all_soft_refs */
1257                                      false, /* expect_null_mutator_alloc_region */
1258                                      succeeded);
1259 
1260   if (result != NULL || !*succeeded) {
1261     return result;
1262   }
1263 
1264   // Attempts to allocate followed by Full GC that will collect all soft references.
1265   result = satisfy_failed_allocation_helper(word_size,
1266                                             true, /* do_gc */
1267                                             true, /* clear_all_soft_refs */
1268                                             true, /* expect_null_mutator_alloc_region */
1269                                             succeeded);
1270 
1271   if (result != NULL || !*succeeded) {
1272     return result;
1273   }
1274 
1275   // Attempts to allocate, no GC
1276   result = satisfy_failed_allocation_helper(word_size,
1277                                             false, /* do_gc */
1278                                             false, /* clear_all_soft_refs */
1279                                             true,  /* expect_null_mutator_alloc_region */
1280                                             succeeded);
1281 
1282   if (result != NULL) {
1283     return result;
1284   }
1285 
1286   assert(!soft_ref_policy()-&gt;should_clear_all_soft_refs(),
1287          &quot;Flag should have been handled and cleared prior to this point&quot;);
1288 
1289   // What else?  We might try synchronous finalization later.  If the total
1290   // space available is large enough for the allocation, then a more
1291   // complete compaction phase than we&#39;ve tried so far might be
1292   // appropriate.
1293   return NULL;
1294 }
1295 
1296 // Attempting to expand the heap sufficiently
1297 // to support an allocation of the given &quot;word_size&quot;.  If
1298 // successful, perform the allocation and return the address of the
1299 // allocated block, or else &quot;NULL&quot;.
1300 
1301 HeapWord* G1CollectedHeap::expand_and_allocate(size_t word_size) {
1302   assert_at_safepoint_on_vm_thread();
1303 
1304   _verifier-&gt;verify_region_sets_optional();
1305 
1306   size_t expand_bytes = MAX2(word_size * HeapWordSize, MinHeapDeltaBytes);
1307   log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (allocation request failed). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
1308                             word_size * HeapWordSize);
1309 
1310 
1311   if (expand(expand_bytes, _workers)) {
1312     _hrm-&gt;verify_optional();
1313     _verifier-&gt;verify_region_sets_optional();
1314     return attempt_allocation_at_safepoint(word_size,
1315                                            false /* expect_null_mutator_alloc_region */);
1316   }
1317   return NULL;
1318 }
1319 
1320 bool G1CollectedHeap::expand(size_t expand_bytes, WorkGang* pretouch_workers, double* expand_time_ms) {
1321   size_t aligned_expand_bytes = ReservedSpace::page_align_size_up(expand_bytes);
1322   aligned_expand_bytes = align_up(aligned_expand_bytes,
1323                                        HeapRegion::GrainBytes);
1324 
1325   log_debug(gc, ergo, heap)(&quot;Expand the heap. requested expansion amount: &quot; SIZE_FORMAT &quot;B expansion amount: &quot; SIZE_FORMAT &quot;B&quot;,
1326                             expand_bytes, aligned_expand_bytes);
1327 
1328   if (is_maximal_no_gc()) {
1329     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap already fully expanded)&quot;);
1330     return false;
1331   }
1332 
1333   double expand_heap_start_time_sec = os::elapsedTime();
1334   uint regions_to_expand = (uint)(aligned_expand_bytes / HeapRegion::GrainBytes);
1335   assert(regions_to_expand &gt; 0, &quot;Must expand by at least one region&quot;);
1336 
1337   uint expanded_by = _hrm-&gt;expand_by(regions_to_expand, pretouch_workers);
1338   if (expand_time_ms != NULL) {
1339     *expand_time_ms = (os::elapsedTime() - expand_heap_start_time_sec) * MILLIUNITS;
1340   }
1341 
1342   if (expanded_by &gt; 0) {
1343     size_t actual_expand_bytes = expanded_by * HeapRegion::GrainBytes;
1344     assert(actual_expand_bytes &lt;= aligned_expand_bytes, &quot;post-condition&quot;);
1345     policy()-&gt;record_new_heap_size(num_regions());
1346   } else {
1347     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap expansion operation failed)&quot;);
1348 
1349     // The expansion of the virtual storage space was unsuccessful.
1350     // Let&#39;s see if it was because we ran out of swap.
1351     if (G1ExitOnExpansionFailure &amp;&amp;
1352         _hrm-&gt;available() &gt;= regions_to_expand) {
1353       // We had head room...
1354       vm_exit_out_of_memory(aligned_expand_bytes, OOM_MMAP_ERROR, &quot;G1 heap expansion&quot;);
1355     }
1356   }
1357   return regions_to_expand &gt; 0;
1358 }
1359 
1360 bool G1CollectedHeap::expand_single_region(uint node_index) {
1361   uint expanded_by = _hrm-&gt;expand_on_preferred_node(node_index);
1362 
1363   if (expanded_by == 0) {
1364     assert(is_maximal_no_gc(), &quot;Should be no regions left, available: %u&quot;, _hrm-&gt;available());
1365     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap already fully expanded)&quot;);
1366     return false;
1367   }
1368 
1369   policy()-&gt;record_new_heap_size(num_regions());
1370   return true;
1371 }
1372 
1373 void G1CollectedHeap::shrink_helper(size_t shrink_bytes) {
1374   size_t aligned_shrink_bytes =
1375     ReservedSpace::page_align_size_down(shrink_bytes);
1376   aligned_shrink_bytes = align_down(aligned_shrink_bytes,
1377                                          HeapRegion::GrainBytes);
1378   uint num_regions_to_remove = (uint)(shrink_bytes / HeapRegion::GrainBytes);
1379 
1380   uint num_regions_removed = _hrm-&gt;shrink_by(num_regions_to_remove);
1381   size_t shrunk_bytes = num_regions_removed * HeapRegion::GrainBytes;
1382 
1383   log_debug(gc, ergo, heap)(&quot;Shrink the heap. requested shrinking amount: &quot; SIZE_FORMAT &quot;B aligned shrinking amount: &quot; SIZE_FORMAT &quot;B attempted shrinking amount: &quot; SIZE_FORMAT &quot;B&quot;,
1384                             shrink_bytes, aligned_shrink_bytes, shrunk_bytes);
1385   if (num_regions_removed &gt; 0) {
1386     policy()-&gt;record_new_heap_size(num_regions());
1387   } else {
1388     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap shrinking operation failed)&quot;);
1389   }
1390 }
1391 
1392 void G1CollectedHeap::shrink(size_t shrink_bytes) {
1393   _verifier-&gt;verify_region_sets_optional();
1394 
1395   // We should only reach here at the end of a Full GC or during Remark which
1396   // means we should not not be holding to any GC alloc regions. The method
1397   // below will make sure of that and do any remaining clean up.
1398   _allocator-&gt;abandon_gc_alloc_regions();
1399 
1400   // Instead of tearing down / rebuilding the free lists here, we
1401   // could instead use the remove_all_pending() method on free_list to
1402   // remove only the ones that we need to remove.
1403   tear_down_region_sets(true /* free_list_only */);
1404   shrink_helper(shrink_bytes);
1405   rebuild_region_sets(true /* free_list_only */);
1406 
1407   _hrm-&gt;verify_optional();
1408   _verifier-&gt;verify_region_sets_optional();
1409 }
1410 
1411 class OldRegionSetChecker : public HeapRegionSetChecker {
1412 public:
1413   void check_mt_safety() {
1414     // Master Old Set MT safety protocol:
1415     // (a) If we&#39;re at a safepoint, operations on the master old set
1416     // should be invoked:
1417     // - by the VM thread (which will serialize them), or
1418     // - by the GC workers while holding the FreeList_lock, if we&#39;re
1419     //   at a safepoint for an evacuation pause (this lock is taken
1420     //   anyway when an GC alloc region is retired so that a new one
1421     //   is allocated from the free list), or
1422     // - by the GC workers while holding the OldSets_lock, if we&#39;re at a
1423     //   safepoint for a cleanup pause.
1424     // (b) If we&#39;re not at a safepoint, operations on the master old set
1425     // should be invoked while holding the Heap_lock.
1426 
1427     if (SafepointSynchronize::is_at_safepoint()) {
1428       guarantee(Thread::current()-&gt;is_VM_thread() ||
1429                 FreeList_lock-&gt;owned_by_self() || OldSets_lock-&gt;owned_by_self(),
1430                 &quot;master old set MT safety protocol at a safepoint&quot;);
1431     } else {
1432       guarantee(Heap_lock-&gt;owned_by_self(), &quot;master old set MT safety protocol outside a safepoint&quot;);
1433     }
1434   }
1435   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_old(); }
1436   const char* get_description() { return &quot;Old Regions&quot;; }
1437 };
1438 
1439 class ArchiveRegionSetChecker : public HeapRegionSetChecker {
1440 public:
1441   void check_mt_safety() {
1442     guarantee(!Universe::is_fully_initialized() || SafepointSynchronize::is_at_safepoint(),
1443               &quot;May only change archive regions during initialization or safepoint.&quot;);
1444   }
1445   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_archive(); }
1446   const char* get_description() { return &quot;Archive Regions&quot;; }
1447 };
1448 
1449 class HumongousRegionSetChecker : public HeapRegionSetChecker {
1450 public:
1451   void check_mt_safety() {
1452     // Humongous Set MT safety protocol:
1453     // (a) If we&#39;re at a safepoint, operations on the master humongous
1454     // set should be invoked by either the VM thread (which will
1455     // serialize them) or by the GC workers while holding the
1456     // OldSets_lock.
1457     // (b) If we&#39;re not at a safepoint, operations on the master
1458     // humongous set should be invoked while holding the Heap_lock.
1459 
1460     if (SafepointSynchronize::is_at_safepoint()) {
1461       guarantee(Thread::current()-&gt;is_VM_thread() ||
1462                 OldSets_lock-&gt;owned_by_self(),
1463                 &quot;master humongous set MT safety protocol at a safepoint&quot;);
1464     } else {
1465       guarantee(Heap_lock-&gt;owned_by_self(),
1466                 &quot;master humongous set MT safety protocol outside a safepoint&quot;);
1467     }
1468   }
1469   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_humongous(); }
1470   const char* get_description() { return &quot;Humongous Regions&quot;; }
1471 };
1472 
1473 G1CollectedHeap::G1CollectedHeap() :
1474   CollectedHeap(),
1475   _young_gen_sampling_thread(NULL),
1476   _workers(NULL),
1477   _card_table(NULL),
1478   _soft_ref_policy(),
1479   _old_set(&quot;Old Region Set&quot;, new OldRegionSetChecker()),
1480   _archive_set(&quot;Archive Region Set&quot;, new ArchiveRegionSetChecker()),
1481   _humongous_set(&quot;Humongous Region Set&quot;, new HumongousRegionSetChecker()),
1482   _bot(NULL),
1483   _listener(),
1484   _numa(G1NUMA::create()),
1485   _hrm(NULL),
1486   _allocator(NULL),
1487   _verifier(NULL),
1488   _summary_bytes_used(0),
1489   _bytes_used_during_gc(0),
1490   _archive_allocator(NULL),
1491   _survivor_evac_stats(&quot;Young&quot;, YoungPLABSize, PLABWeight),
1492   _old_evac_stats(&quot;Old&quot;, OldPLABSize, PLABWeight),
1493   _expand_heap_after_alloc_failure(true),
1494   _g1mm(NULL),
1495   _humongous_reclaim_candidates(),
1496   _has_humongous_reclaim_candidates(false),
1497   _hr_printer(),
1498   _collector_state(),
1499   _old_marking_cycles_started(0),
1500   _old_marking_cycles_completed(0),
1501   _eden(),
1502   _survivor(),
1503   _gc_timer_stw(new (ResourceObj::C_HEAP, mtGC) STWGCTimer()),
1504   _gc_tracer_stw(new (ResourceObj::C_HEAP, mtGC) G1NewTracer()),
1505   _policy(G1Policy::create_policy(_gc_timer_stw)),
1506   _heap_sizing_policy(NULL),
1507   _collection_set(this, _policy),
1508   _hot_card_cache(NULL),
1509   _rem_set(NULL),
1510   _cm(NULL),
1511   _cm_thread(NULL),
1512   _cr(NULL),
1513   _task_queues(NULL),
1514   _evacuation_failed(false),
1515   _evacuation_failed_info_array(NULL),
1516   _preserved_marks_set(true /* in_c_heap */),
1517 #ifndef PRODUCT
1518   _evacuation_failure_alot_for_current_gc(false),
1519   _evacuation_failure_alot_gc_number(0),
1520   _evacuation_failure_alot_count(0),
1521 #endif
1522   _ref_processor_stw(NULL),
1523   _is_alive_closure_stw(this),
1524   _is_subject_to_discovery_stw(this),
1525   _ref_processor_cm(NULL),
1526   _is_alive_closure_cm(this),
1527   _is_subject_to_discovery_cm(this),
1528   _region_attr() {
1529 
1530   _verifier = new G1HeapVerifier(this);
1531 
1532   _allocator = new G1Allocator(this);
1533 
1534   _heap_sizing_policy = G1HeapSizingPolicy::create(this, _policy-&gt;analytics());
1535 
1536   _humongous_object_threshold_in_words = humongous_threshold_for(HeapRegion::GrainWords);
1537 
1538   // Override the default _filler_array_max_size so that no humongous filler
1539   // objects are created.
1540   _filler_array_max_size = _humongous_object_threshold_in_words;
1541 
1542   uint n_queues = ParallelGCThreads;
1543   _task_queues = new RefToScanQueueSet(n_queues);
1544 
1545   _evacuation_failed_info_array = NEW_C_HEAP_ARRAY(EvacuationFailedInfo, n_queues, mtGC);
1546 
1547   for (uint i = 0; i &lt; n_queues; i++) {
1548     RefToScanQueue* q = new RefToScanQueue();
1549     q-&gt;initialize();
1550     _task_queues-&gt;register_queue(i, q);
1551     ::new (&amp;_evacuation_failed_info_array[i]) EvacuationFailedInfo();
1552   }
1553 
1554   // Initialize the G1EvacuationFailureALot counters and flags.
1555   NOT_PRODUCT(reset_evacuation_should_fail();)
1556   _gc_tracer_stw-&gt;initialize();
1557 
1558   guarantee(_task_queues != NULL, &quot;task_queues allocation failure.&quot;);
1559 }
1560 
1561 static size_t actual_reserved_page_size(ReservedSpace rs) {
1562   size_t page_size = os::vm_page_size();
1563   if (UseLargePages) {
1564     // There are two ways to manage large page memory.
1565     // 1. OS supports committing large page memory.
1566     // 2. OS doesn&#39;t support committing large page memory so ReservedSpace manages it.
1567     //    And ReservedSpace calls it &#39;special&#39;. If we failed to set &#39;special&#39;,
1568     //    we reserved memory without large page.
1569     if (os::can_commit_large_page_memory() || rs.special()) {
1570       // An alignment at ReservedSpace comes from preferred page size or
1571       // heap alignment, and if the alignment came from heap alignment, it could be
1572       // larger than large pages size. So need to cap with the large page size.
1573       page_size = MIN2(rs.alignment(), os::large_page_size());
1574     }
1575   }
1576 
1577   return page_size;
1578 }
1579 
1580 G1RegionToSpaceMapper* G1CollectedHeap::create_aux_memory_mapper(const char* description,
1581                                                                  size_t size,
1582                                                                  size_t translation_factor) {
1583   size_t preferred_page_size = os::page_size_for_region_unaligned(size, 1);
1584   // Allocate a new reserved space, preferring to use large pages.
1585   ReservedSpace rs(size, preferred_page_size);
1586   size_t page_size = actual_reserved_page_size(rs);
1587   G1RegionToSpaceMapper* result  =
1588     G1RegionToSpaceMapper::create_mapper(rs,
1589                                          size,
1590                                          page_size,
1591                                          HeapRegion::GrainBytes,
1592                                          translation_factor,
1593                                          mtGC);
1594 
1595   os::trace_page_sizes_for_requested_size(description,
1596                                           size,
1597                                           preferred_page_size,
1598                                           page_size,
1599                                           rs.base(),
1600                                           rs.size());
1601 
1602   return result;
1603 }
1604 
1605 jint G1CollectedHeap::initialize_concurrent_refinement() {
1606   jint ecode = JNI_OK;
1607   _cr = G1ConcurrentRefine::create(&amp;ecode);
1608   return ecode;
1609 }
1610 
1611 jint G1CollectedHeap::initialize_young_gen_sampling_thread() {
1612   _young_gen_sampling_thread = new G1YoungRemSetSamplingThread();
1613   if (_young_gen_sampling_thread-&gt;osthread() == NULL) {
1614     vm_shutdown_during_initialization(&quot;Could not create G1YoungRemSetSamplingThread&quot;);
1615     return JNI_ENOMEM;
1616   }
1617   return JNI_OK;
1618 }
1619 
1620 jint G1CollectedHeap::initialize() {
1621 
1622   // Necessary to satisfy locking discipline assertions.
1623 
1624   MutexLocker x(Heap_lock);
1625 
1626   // While there are no constraints in the GC code that HeapWordSize
1627   // be any particular value, there are multiple other areas in the
1628   // system which believe this to be true (e.g. oop-&gt;object_size in some
1629   // cases incorrectly returns the size in wordSize units rather than
1630   // HeapWordSize).
1631   guarantee(HeapWordSize == wordSize, &quot;HeapWordSize must equal wordSize&quot;);
1632 
1633   size_t init_byte_size = InitialHeapSize;
1634   size_t reserved_byte_size = G1Arguments::heap_reserved_size_bytes();
1635 
1636   // Ensure that the sizes are properly aligned.
1637   Universe::check_alignment(init_byte_size, HeapRegion::GrainBytes, &quot;g1 heap&quot;);
1638   Universe::check_alignment(reserved_byte_size, HeapRegion::GrainBytes, &quot;g1 heap&quot;);
1639   Universe::check_alignment(reserved_byte_size, HeapAlignment, &quot;g1 heap&quot;);
1640 
1641   // Reserve the maximum.
1642 
1643   // When compressed oops are enabled, the preferred heap base
1644   // is calculated by subtracting the requested size from the
1645   // 32Gb boundary and using the result as the base address for
1646   // heap reservation. If the requested size is not aligned to
1647   // HeapRegion::GrainBytes (i.e. the alignment that is passed
1648   // into the ReservedHeapSpace constructor) then the actual
1649   // base of the reserved heap may end up differing from the
1650   // address that was requested (i.e. the preferred heap base).
1651   // If this happens then we could end up using a non-optimal
1652   // compressed oops mode.
1653 
1654   ReservedHeapSpace heap_rs = Universe::reserve_heap(reserved_byte_size,
1655                                                      HeapAlignment);
1656 
1657   initialize_reserved_region(heap_rs);
1658 
1659   // Create the barrier set for the entire reserved region.
1660   G1CardTable* ct = new G1CardTable(heap_rs.region());
1661   ct-&gt;initialize();
1662   G1BarrierSet* bs = new G1BarrierSet(ct);
1663   bs-&gt;initialize();
1664   assert(bs-&gt;is_a(BarrierSet::G1BarrierSet), &quot;sanity&quot;);
1665   BarrierSet::set_barrier_set(bs);
1666   _card_table = ct;
1667 
1668   {
1669     G1SATBMarkQueueSet&amp; satbqs = bs-&gt;satb_mark_queue_set();
1670     satbqs.set_process_completed_buffers_threshold(G1SATBProcessCompletedThreshold);
1671     satbqs.set_buffer_enqueue_threshold_percentage(G1SATBBufferEnqueueingThresholdPercent);
1672   }
1673 
1674   // Create the hot card cache.
1675   _hot_card_cache = new G1HotCardCache(this);
1676 
1677   // Carve out the G1 part of the heap.
1678   ReservedSpace g1_rs = heap_rs.first_part(reserved_byte_size);
1679   size_t page_size = actual_reserved_page_size(heap_rs);
1680   G1RegionToSpaceMapper* heap_storage =
1681     G1RegionToSpaceMapper::create_heap_mapper(g1_rs,
1682                                               g1_rs.size(),
1683                                               page_size,
1684                                               HeapRegion::GrainBytes,
1685                                               1,
1686                                               mtJavaHeap);
1687   if(heap_storage == NULL) {
1688     vm_shutdown_during_initialization(&quot;Could not initialize G1 heap&quot;);
1689     return JNI_ERR;
1690   }
1691 
1692   os::trace_page_sizes(&quot;Heap&quot;,
1693                        MinHeapSize,
1694                        reserved_byte_size,
1695                        page_size,
1696                        heap_rs.base(),
1697                        heap_rs.size());
1698   heap_storage-&gt;set_mapping_changed_listener(&amp;_listener);
1699 
1700   // Create storage for the BOT, card table, card counts table (hot card cache) and the bitmaps.
1701   G1RegionToSpaceMapper* bot_storage =
1702     create_aux_memory_mapper(&quot;Block Offset Table&quot;,
1703                              G1BlockOffsetTable::compute_size(g1_rs.size() / HeapWordSize),
1704                              G1BlockOffsetTable::heap_map_factor());
1705 
1706   G1RegionToSpaceMapper* cardtable_storage =
1707     create_aux_memory_mapper(&quot;Card Table&quot;,
1708                              G1CardTable::compute_size(g1_rs.size() / HeapWordSize),
1709                              G1CardTable::heap_map_factor());
1710 
1711   G1RegionToSpaceMapper* card_counts_storage =
1712     create_aux_memory_mapper(&quot;Card Counts Table&quot;,
1713                              G1CardCounts::compute_size(g1_rs.size() / HeapWordSize),
1714                              G1CardCounts::heap_map_factor());
1715 
1716   size_t bitmap_size = G1CMBitMap::compute_size(g1_rs.size());
1717   G1RegionToSpaceMapper* prev_bitmap_storage =
1718     create_aux_memory_mapper(&quot;Prev Bitmap&quot;, bitmap_size, G1CMBitMap::heap_map_factor());
1719   G1RegionToSpaceMapper* next_bitmap_storage =
1720     create_aux_memory_mapper(&quot;Next Bitmap&quot;, bitmap_size, G1CMBitMap::heap_map_factor());
1721 
1722   _hrm = HeapRegionManager::create_manager(this);
1723 
1724   _hrm-&gt;initialize(heap_storage, prev_bitmap_storage, next_bitmap_storage, bot_storage, cardtable_storage, card_counts_storage);
1725   _card_table-&gt;initialize(cardtable_storage);
1726 
1727   // Do later initialization work for concurrent refinement.
1728   _hot_card_cache-&gt;initialize(card_counts_storage);
1729 
1730   // 6843694 - ensure that the maximum region index can fit
1731   // in the remembered set structures.
1732   const uint max_region_idx = (1U &lt;&lt; (sizeof(RegionIdx_t)*BitsPerByte-1)) - 1;
1733   guarantee((max_regions() - 1) &lt;= max_region_idx, &quot;too many regions&quot;);
1734 
1735   // The G1FromCardCache reserves card with value 0 as &quot;invalid&quot;, so the heap must not
1736   // start within the first card.
1737   guarantee(g1_rs.base() &gt;= (char*)G1CardTable::card_size, &quot;Java heap must not start within the first card.&quot;);
1738   // Also create a G1 rem set.
1739   _rem_set = new G1RemSet(this, _card_table, _hot_card_cache);
1740   _rem_set-&gt;initialize(max_reserved_capacity(), max_regions());
1741 
1742   size_t max_cards_per_region = ((size_t)1 &lt;&lt; (sizeof(CardIdx_t)*BitsPerByte-1)) - 1;
1743   guarantee(HeapRegion::CardsPerRegion &gt; 0, &quot;make sure it&#39;s initialized&quot;);
1744   guarantee(HeapRegion::CardsPerRegion &lt; max_cards_per_region,
1745             &quot;too many cards per region&quot;);
1746 
1747   FreeRegionList::set_unrealistically_long_length(max_expandable_regions() + 1);
1748 
1749   _bot = new G1BlockOffsetTable(reserved_region(), bot_storage);
1750 
1751   {
1752     HeapWord* start = _hrm-&gt;reserved().start();
1753     HeapWord* end = _hrm-&gt;reserved().end();
1754     size_t granularity = HeapRegion::GrainBytes;
1755 
1756     _region_attr.initialize(start, end, granularity);
1757     _humongous_reclaim_candidates.initialize(start, end, granularity);
1758   }
1759 
1760   _workers = new WorkGang(&quot;GC Thread&quot;, ParallelGCThreads,
1761                           true /* are_GC_task_threads */,
1762                           false /* are_ConcurrentGC_threads */);
1763   if (_workers == NULL) {
1764     return JNI_ENOMEM;
1765   }
1766   _workers-&gt;initialize_workers();
1767 
1768   _numa-&gt;set_region_info(HeapRegion::GrainBytes, page_size);
1769 
1770   // Create the G1ConcurrentMark data structure and thread.
1771   // (Must do this late, so that &quot;max_regions&quot; is defined.)
1772   _cm = new G1ConcurrentMark(this, prev_bitmap_storage, next_bitmap_storage);
<a name="11" id="anc11"></a>



1773   _cm_thread = _cm-&gt;cm_thread();
1774 
1775   // Now expand into the initial heap size.
1776   if (!expand(init_byte_size, _workers)) {
1777     vm_shutdown_during_initialization(&quot;Failed to allocate initial heap.&quot;);
1778     return JNI_ENOMEM;
1779   }
1780 
1781   // Perform any initialization actions delegated to the policy.
1782   policy()-&gt;init(this, &amp;_collection_set);
1783 
1784   jint ecode = initialize_concurrent_refinement();
1785   if (ecode != JNI_OK) {
1786     return ecode;
1787   }
1788 
1789   ecode = initialize_young_gen_sampling_thread();
1790   if (ecode != JNI_OK) {
1791     return ecode;
1792   }
1793 
1794   {
1795     G1DirtyCardQueueSet&amp; dcqs = G1BarrierSet::dirty_card_queue_set();
1796     dcqs.set_process_cards_threshold(concurrent_refine()-&gt;yellow_zone());
1797     dcqs.set_max_cards(concurrent_refine()-&gt;red_zone());
1798   }
1799 
1800   // Here we allocate the dummy HeapRegion that is required by the
1801   // G1AllocRegion class.
1802   HeapRegion* dummy_region = _hrm-&gt;get_dummy_region();
1803 
1804   // We&#39;ll re-use the same region whether the alloc region will
1805   // require BOT updates or not and, if it doesn&#39;t, then a non-young
1806   // region will complain that it cannot support allocations without
1807   // BOT updates. So we&#39;ll tag the dummy region as eden to avoid that.
1808   dummy_region-&gt;set_eden();
1809   // Make sure it&#39;s full.
1810   dummy_region-&gt;set_top(dummy_region-&gt;end());
1811   G1AllocRegion::setup(this, dummy_region);
1812 
1813   _allocator-&gt;init_mutator_alloc_regions();
1814 
1815   // Do create of the monitoring and management support so that
1816   // values in the heap have been properly initialized.
1817   _g1mm = new G1MonitoringSupport(this);
1818 
1819   G1StringDedup::initialize();
1820 
1821   _preserved_marks_set.init(ParallelGCThreads);
1822 
1823   _collection_set.initialize(max_regions());
1824 
1825   return JNI_OK;
1826 }
1827 
1828 void G1CollectedHeap::stop() {
1829   // Stop all concurrent threads. We do this to make sure these threads
1830   // do not continue to execute and access resources (e.g. logging)
1831   // that are destroyed during shutdown.
1832   _cr-&gt;stop();
1833   _young_gen_sampling_thread-&gt;stop();
1834   _cm_thread-&gt;stop();
1835   if (G1StringDedup::is_enabled()) {
1836     G1StringDedup::stop();
1837   }
1838 }
1839 
1840 void G1CollectedHeap::safepoint_synchronize_begin() {
1841   SuspendibleThreadSet::synchronize();
1842 }
1843 
1844 void G1CollectedHeap::safepoint_synchronize_end() {
1845   SuspendibleThreadSet::desynchronize();
1846 }
1847 
1848 void G1CollectedHeap::post_initialize() {
1849   CollectedHeap::post_initialize();
1850   ref_processing_init();
1851 }
1852 
1853 void G1CollectedHeap::ref_processing_init() {
1854   // Reference processing in G1 currently works as follows:
1855   //
1856   // * There are two reference processor instances. One is
1857   //   used to record and process discovered references
1858   //   during concurrent marking; the other is used to
1859   //   record and process references during STW pauses
1860   //   (both full and incremental).
1861   // * Both ref processors need to &#39;span&#39; the entire heap as
1862   //   the regions in the collection set may be dotted around.
1863   //
1864   // * For the concurrent marking ref processor:
1865   //   * Reference discovery is enabled at initial marking.
1866   //   * Reference discovery is disabled and the discovered
1867   //     references processed etc during remarking.
1868   //   * Reference discovery is MT (see below).
1869   //   * Reference discovery requires a barrier (see below).
1870   //   * Reference processing may or may not be MT
1871   //     (depending on the value of ParallelRefProcEnabled
1872   //     and ParallelGCThreads).
1873   //   * A full GC disables reference discovery by the CM
1874   //     ref processor and abandons any entries on it&#39;s
1875   //     discovered lists.
1876   //
1877   // * For the STW processor:
1878   //   * Non MT discovery is enabled at the start of a full GC.
1879   //   * Processing and enqueueing during a full GC is non-MT.
1880   //   * During a full GC, references are processed after marking.
1881   //
1882   //   * Discovery (may or may not be MT) is enabled at the start
1883   //     of an incremental evacuation pause.
1884   //   * References are processed near the end of a STW evacuation pause.
1885   //   * For both types of GC:
1886   //     * Discovery is atomic - i.e. not concurrent.
1887   //     * Reference discovery will not need a barrier.
1888 
1889   bool mt_processing = ParallelRefProcEnabled &amp;&amp; (ParallelGCThreads &gt; 1);
1890 
1891   // Concurrent Mark ref processor
1892   _ref_processor_cm =
1893     new ReferenceProcessor(&amp;_is_subject_to_discovery_cm,
1894                            mt_processing,                                  // mt processing
1895                            ParallelGCThreads,                              // degree of mt processing
1896                            (ParallelGCThreads &gt; 1) || (ConcGCThreads &gt; 1), // mt discovery
1897                            MAX2(ParallelGCThreads, ConcGCThreads),         // degree of mt discovery
1898                            false,                                          // Reference discovery is not atomic
1899                            &amp;_is_alive_closure_cm,                          // is alive closure
1900                            true);                                          // allow changes to number of processing threads
1901 
1902   // STW ref processor
1903   _ref_processor_stw =
1904     new ReferenceProcessor(&amp;_is_subject_to_discovery_stw,
1905                            mt_processing,                        // mt processing
1906                            ParallelGCThreads,                    // degree of mt processing
1907                            (ParallelGCThreads &gt; 1),              // mt discovery
1908                            ParallelGCThreads,                    // degree of mt discovery
1909                            true,                                 // Reference discovery is atomic
1910                            &amp;_is_alive_closure_stw,               // is alive closure
1911                            true);                                // allow changes to number of processing threads
1912 }
1913 
1914 SoftRefPolicy* G1CollectedHeap::soft_ref_policy() {
1915   return &amp;_soft_ref_policy;
1916 }
1917 
1918 size_t G1CollectedHeap::capacity() const {
1919   return _hrm-&gt;length() * HeapRegion::GrainBytes;
1920 }
1921 
1922 size_t G1CollectedHeap::unused_committed_regions_in_bytes() const {
1923   return _hrm-&gt;total_free_bytes();
1924 }
1925 
1926 void G1CollectedHeap::iterate_hcc_closure(G1CardTableEntryClosure* cl, uint worker_id) {
1927   _hot_card_cache-&gt;drain(cl, worker_id);
1928 }
1929 
1930 // Computes the sum of the storage used by the various regions.
1931 size_t G1CollectedHeap::used() const {
1932   size_t result = _summary_bytes_used + _allocator-&gt;used_in_alloc_regions();
1933   if (_archive_allocator != NULL) {
1934     result += _archive_allocator-&gt;used();
1935   }
1936   return result;
1937 }
1938 
1939 size_t G1CollectedHeap::used_unlocked() const {
1940   return _summary_bytes_used;
1941 }
1942 
1943 class SumUsedClosure: public HeapRegionClosure {
1944   size_t _used;
1945 public:
1946   SumUsedClosure() : _used(0) {}
1947   bool do_heap_region(HeapRegion* r) {
1948     _used += r-&gt;used();
1949     return false;
1950   }
1951   size_t result() { return _used; }
1952 };
1953 
1954 size_t G1CollectedHeap::recalculate_used() const {
1955   SumUsedClosure blk;
1956   heap_region_iterate(&amp;blk);
1957   return blk.result();
1958 }
1959 
1960 bool  G1CollectedHeap::is_user_requested_concurrent_full_gc(GCCause::Cause cause) {
1961   switch (cause) {
1962     case GCCause::_java_lang_system_gc:                 return ExplicitGCInvokesConcurrent;
1963     case GCCause::_dcmd_gc_run:                         return ExplicitGCInvokesConcurrent;
1964     case GCCause::_wb_conc_mark:                        return true;
1965     default :                                           return false;
1966   }
1967 }
1968 
1969 bool G1CollectedHeap::should_do_concurrent_full_gc(GCCause::Cause cause) {
1970   switch (cause) {
1971     case GCCause::_g1_humongous_allocation: return true;
1972     case GCCause::_g1_periodic_collection:  return G1PeriodicGCInvokesConcurrent;
<a name="12" id="anc12"></a><span class="line-added">1973     case GCCause::_wb_breakpoint:           return true;</span>
1974     default:                                return is_user_requested_concurrent_full_gc(cause);
1975   }
1976 }
1977 
1978 bool G1CollectedHeap::should_upgrade_to_full_gc(GCCause::Cause cause) {
1979   if (policy()-&gt;force_upgrade_to_full()) {
1980     return true;
1981   } else if (should_do_concurrent_full_gc(_gc_cause)) {
1982     return false;
1983   } else if (has_regions_left_for_allocation()) {
1984     return false;
1985   } else {
1986     return true;
1987   }
1988 }
1989 
1990 #ifndef PRODUCT
1991 void G1CollectedHeap::allocate_dummy_regions() {
1992   // Let&#39;s fill up most of the region
1993   size_t word_size = HeapRegion::GrainWords - 1024;
1994   // And as a result the region we&#39;ll allocate will be humongous.
1995   guarantee(is_humongous(word_size), &quot;sanity&quot;);
1996 
1997   // _filler_array_max_size is set to humongous object threshold
1998   // but temporarily change it to use CollectedHeap::fill_with_object().
1999   SizeTFlagSetting fs(_filler_array_max_size, word_size);
2000 
2001   for (uintx i = 0; i &lt; G1DummyRegionsPerGC; ++i) {
2002     // Let&#39;s use the existing mechanism for the allocation
2003     HeapWord* dummy_obj = humongous_obj_allocate(word_size);
2004     if (dummy_obj != NULL) {
2005       MemRegion mr(dummy_obj, word_size);
2006       CollectedHeap::fill_with_object(mr);
2007     } else {
2008       // If we can&#39;t allocate once, we probably cannot allocate
2009       // again. Let&#39;s get out of the loop.
2010       break;
2011     }
2012   }
2013 }
2014 #endif // !PRODUCT
2015 
2016 void G1CollectedHeap::increment_old_marking_cycles_started() {
2017   assert(_old_marking_cycles_started == _old_marking_cycles_completed ||
2018          _old_marking_cycles_started == _old_marking_cycles_completed + 1,
2019          &quot;Wrong marking cycle count (started: %d, completed: %d)&quot;,
2020          _old_marking_cycles_started, _old_marking_cycles_completed);
2021 
2022   _old_marking_cycles_started++;
2023 }
2024 
2025 void G1CollectedHeap::increment_old_marking_cycles_completed(bool concurrent) {
2026   MonitorLocker ml(G1OldGCCount_lock, Mutex::_no_safepoint_check_flag);
2027 
2028   // We assume that if concurrent == true, then the caller is a
2029   // concurrent thread that was joined the Suspendible Thread
2030   // Set. If there&#39;s ever a cheap way to check this, we should add an
2031   // assert here.
2032 
2033   // Given that this method is called at the end of a Full GC or of a
2034   // concurrent cycle, and those can be nested (i.e., a Full GC can
2035   // interrupt a concurrent cycle), the number of full collections
2036   // completed should be either one (in the case where there was no
2037   // nesting) or two (when a Full GC interrupted a concurrent cycle)
2038   // behind the number of full collections started.
2039 
2040   // This is the case for the inner caller, i.e. a Full GC.
2041   assert(concurrent ||
2042          (_old_marking_cycles_started == _old_marking_cycles_completed + 1) ||
2043          (_old_marking_cycles_started == _old_marking_cycles_completed + 2),
2044          &quot;for inner caller (Full GC): _old_marking_cycles_started = %u &quot;
2045          &quot;is inconsistent with _old_marking_cycles_completed = %u&quot;,
2046          _old_marking_cycles_started, _old_marking_cycles_completed);
2047 
2048   // This is the case for the outer caller, i.e. the concurrent cycle.
2049   assert(!concurrent ||
2050          (_old_marking_cycles_started == _old_marking_cycles_completed + 1),
2051          &quot;for outer caller (concurrent cycle): &quot;
2052          &quot;_old_marking_cycles_started = %u &quot;
2053          &quot;is inconsistent with _old_marking_cycles_completed = %u&quot;,
2054          _old_marking_cycles_started, _old_marking_cycles_completed);
2055 
2056   _old_marking_cycles_completed += 1;
2057 
2058   // We need to clear the &quot;in_progress&quot; flag in the CM thread before
2059   // we wake up any waiters (especially when ExplicitInvokesConcurrent
2060   // is set) so that if a waiter requests another System.gc() it doesn&#39;t
2061   // incorrectly see that a marking cycle is still in progress.
2062   if (concurrent) {
2063     _cm_thread-&gt;set_idle();
2064   }
2065 
2066   // Notify threads waiting in System.gc() (with ExplicitGCInvokesConcurrent)
2067   // for a full GC to finish that their wait is over.
2068   ml.notify_all();
2069 }
2070 
2071 void G1CollectedHeap::collect(GCCause::Cause cause) {
2072   try_collect(cause);
2073 }
2074 
2075 // Return true if (x &lt; y) with allowance for wraparound.
2076 static bool gc_counter_less_than(uint x, uint y) {
2077   return (x - y) &gt; (UINT_MAX/2);
2078 }
2079 
2080 // LOG_COLLECT_CONCURRENTLY(cause, msg, args...)
2081 // Macro so msg printing is format-checked.
2082 #define LOG_COLLECT_CONCURRENTLY(cause, ...)                            \
2083   do {                                                                  \
2084     LogTarget(Trace, gc) LOG_COLLECT_CONCURRENTLY_lt;                   \
2085     if (LOG_COLLECT_CONCURRENTLY_lt.is_enabled()) {                     \
2086       ResourceMark rm; /* For thread name. */                           \
2087       LogStream LOG_COLLECT_CONCURRENTLY_s(&amp;LOG_COLLECT_CONCURRENTLY_lt); \
2088       LOG_COLLECT_CONCURRENTLY_s.print(&quot;%s: Try Collect Concurrently (%s): &quot;, \
2089                                        Thread::current()-&gt;name(),       \
2090                                        GCCause::to_string(cause));      \
2091       LOG_COLLECT_CONCURRENTLY_s.print(__VA_ARGS__);                    \
2092     }                                                                   \
2093   } while (0)
2094 
2095 #define LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, result) \
2096   LOG_COLLECT_CONCURRENTLY(cause, &quot;complete %s&quot;, BOOL_TO_STR(result))
2097 
2098 bool G1CollectedHeap::try_collect_concurrently(GCCause::Cause cause,
2099                                                uint gc_counter,
2100                                                uint old_marking_started_before) {
2101   assert_heap_not_locked();
2102   assert(should_do_concurrent_full_gc(cause),
2103          &quot;Non-concurrent cause %s&quot;, GCCause::to_string(cause));
2104 
2105   for (uint i = 1; true; ++i) {
2106     // Try to schedule an initial-mark evacuation pause that will
2107     // start a concurrent cycle.
2108     LOG_COLLECT_CONCURRENTLY(cause, &quot;attempt %u&quot;, i);
2109     VM_G1TryInitiateConcMark op(gc_counter,
2110                                 cause,
2111                                 policy()-&gt;max_pause_time_ms());
2112     VMThread::execute(&amp;op);
2113 
2114     // Request is trivially finished.
2115     if (cause == GCCause::_g1_periodic_collection) {
2116       LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, op.gc_succeeded());
2117       return op.gc_succeeded();
2118     }
2119 
2120     // If VMOp skipped initiating concurrent marking cycle because
2121     // we&#39;re terminating, then we&#39;re done.
2122     if (op.terminating()) {
2123       LOG_COLLECT_CONCURRENTLY(cause, &quot;skipped: terminating&quot;);
2124       return false;
2125     }
2126 
2127     // Lock to get consistent set of values.
2128     uint old_marking_started_after;
2129     uint old_marking_completed_after;
2130     {
2131       MutexLocker ml(Heap_lock);
2132       // Update gc_counter for retrying VMOp if needed. Captured here to be
2133       // consistent with the values we use below for termination tests.  If
2134       // a retry is needed after a possible wait, and another collection
2135       // occurs in the meantime, it will cause our retry to be skipped and
2136       // we&#39;ll recheck for termination with updated conditions from that
2137       // more recent collection.  That&#39;s what we want, rather than having
2138       // our retry possibly perform an unnecessary collection.
2139       gc_counter = total_collections();
2140       old_marking_started_after = _old_marking_cycles_started;
2141       old_marking_completed_after = _old_marking_cycles_completed;
2142     }
2143 
<a name="13" id="anc13"></a><span class="line-modified">2144     if (cause == GCCause::_wb_breakpoint) {</span>
<span class="line-added">2145       if (op.gc_succeeded()) {</span>
<span class="line-added">2146         LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, true);</span>
<span class="line-added">2147         return true;</span>
<span class="line-added">2148       }</span>
<span class="line-added">2149       // When _wb_breakpoint there can&#39;t be another cycle or deferred.</span>
<span class="line-added">2150       assert(!op.cycle_already_in_progress(), &quot;invariant&quot;);</span>
<span class="line-added">2151       assert(!op.whitebox_attached(), &quot;invariant&quot;);</span>
<span class="line-added">2152       // Concurrent cycle attempt might have been cancelled by some other</span>
<span class="line-added">2153       // collection, so retry.  Unlike other cases below, we want to retry</span>
<span class="line-added">2154       // even if cancelled by a STW full collection, because we really want</span>
<span class="line-added">2155       // to start a concurrent cycle.</span>
<span class="line-added">2156       if (old_marking_started_before != old_marking_started_after) {</span>
<span class="line-added">2157         LOG_COLLECT_CONCURRENTLY(cause, &quot;ignoring STW full GC&quot;);</span>
<span class="line-added">2158         old_marking_started_before = old_marking_started_after;</span>
<span class="line-added">2159       }</span>
<span class="line-added">2160     } else if (!GCCause::is_user_requested_gc(cause)) {</span>
2161       // For an &quot;automatic&quot; (not user-requested) collection, we just need to
2162       // ensure that progress is made.
2163       //
2164       // Request is finished if any of
2165       // (1) the VMOp successfully performed a GC,
2166       // (2) a concurrent cycle was already in progress,
<a name="14" id="anc14"></a><span class="line-modified">2167       // (3) whitebox is controlling concurrent cycles,</span>
<span class="line-modified">2168       // (4) a new cycle was started (by this thread or some other), or</span>
<span class="line-modified">2169       // (5) a Full GC was performed.</span>
<span class="line-added">2170       // Cases (4) and (5) are detected together by a change to</span>
2171       // _old_marking_cycles_started.
2172       //
<a name="15" id="anc15"></a><span class="line-modified">2173       // Note that (1) does not imply (4).  If we&#39;re still in the mixed</span>
2174       // phase of an earlier concurrent collection, the request to make the
2175       // collection an initial-mark won&#39;t be honored.  If we don&#39;t check for
2176       // both conditions we&#39;ll spin doing back-to-back collections.
2177       if (op.gc_succeeded() ||
2178           op.cycle_already_in_progress() ||
<a name="16" id="anc16"></a><span class="line-added">2179           op.whitebox_attached() ||</span>
2180           (old_marking_started_before != old_marking_started_after)) {
2181         LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, true);
2182         return true;
2183       }
2184     } else {                    // User-requested GC.
2185       // For a user-requested collection, we want to ensure that a complete
2186       // full collection has been performed before returning, but without
2187       // waiting for more than needed.
2188 
2189       // For user-requested GCs (unlike non-UR), a successful VMOp implies a
2190       // new cycle was started.  That&#39;s good, because it&#39;s not clear what we
2191       // should do otherwise.  Trying again just does back to back GCs.
2192       // Can&#39;t wait for someone else to start a cycle.  And returning fails
2193       // to meet the goal of ensuring a full collection was performed.
2194       assert(!op.gc_succeeded() ||
2195              (old_marking_started_before != old_marking_started_after),
2196              &quot;invariant: succeeded %s, started before %u, started after %u&quot;,
2197              BOOL_TO_STR(op.gc_succeeded()),
2198              old_marking_started_before, old_marking_started_after);
2199 
2200       // Request is finished if a full collection (concurrent or stw)
2201       // was started after this request and has completed, e.g.
2202       // started_before &lt; completed_after.
2203       if (gc_counter_less_than(old_marking_started_before,
2204                                old_marking_completed_after)) {
2205         LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, true);
2206         return true;
2207       }
2208 
2209       if (old_marking_started_after != old_marking_completed_after) {
2210         // If there is an in-progress cycle (possibly started by us), then
2211         // wait for that cycle to complete, e.g.
2212         // while completed_now &lt; started_after.
2213         LOG_COLLECT_CONCURRENTLY(cause, &quot;wait&quot;);
2214         MonitorLocker ml(G1OldGCCount_lock);
2215         while (gc_counter_less_than(_old_marking_cycles_completed,
2216                                     old_marking_started_after)) {
2217           ml.wait();
2218         }
2219         // Request is finished if the collection we just waited for was
2220         // started after this request.
2221         if (old_marking_started_before != old_marking_started_after) {
2222           LOG_COLLECT_CONCURRENTLY(cause, &quot;complete after wait&quot;);
2223           return true;
2224         }
2225       }
2226 
2227       // If VMOp was successful then it started a new cycle that the above
2228       // wait &amp;etc should have recognized as finishing this request.  This
2229       // differs from a non-user-request, where gc_succeeded does not imply
2230       // a new cycle was started.
2231       assert(!op.gc_succeeded(), &quot;invariant&quot;);
2232 
<a name="17" id="anc17"></a>


2233       if (op.cycle_already_in_progress()) {
<a name="18" id="anc18"></a><span class="line-added">2234         // If VMOp failed because a cycle was already in progress, it</span>
<span class="line-added">2235         // is now complete.  But it didn&#39;t finish this user-requested</span>
<span class="line-added">2236         // GC, so try again.</span>
2237         LOG_COLLECT_CONCURRENTLY(cause, &quot;retry after in-progress&quot;);
2238         continue;
<a name="19" id="anc19"></a><span class="line-added">2239       } else if (op.whitebox_attached()) {</span>
<span class="line-added">2240         // If WhiteBox wants control, wait for notification of a state</span>
<span class="line-added">2241         // change in the controller, then try again.  Don&#39;t wait for</span>
<span class="line-added">2242         // release of control, since collections may complete while in</span>
<span class="line-added">2243         // control.  Note: This won&#39;t recognize a STW full collection</span>
<span class="line-added">2244         // while waiting; we can&#39;t wait on multiple monitors.</span>
<span class="line-added">2245         LOG_COLLECT_CONCURRENTLY(cause, &quot;whitebox control stall&quot;);</span>
<span class="line-added">2246         MonitorLocker ml(ConcurrentGCBreakpoints::monitor());</span>
<span class="line-added">2247         if (ConcurrentGCBreakpoints::is_controlled()) {</span>
<span class="line-added">2248           ml.wait();</span>
<span class="line-added">2249         }</span>
<span class="line-added">2250         continue;</span>
2251       }
2252     }
2253 
2254     // Collection failed and should be retried.
2255     assert(op.transient_failure(), &quot;invariant&quot;);
2256 
<a name="20" id="anc20"></a>
2257     if (GCLocker::is_active_and_needs_gc()) {
<a name="21" id="anc21"></a><span class="line-added">2258       // If GCLocker is active, wait until clear before retrying.</span>
2259       LOG_COLLECT_CONCURRENTLY(cause, &quot;gc-locker stall&quot;);
2260       GCLocker::stall_until_clear();
2261     }
2262 
2263     LOG_COLLECT_CONCURRENTLY(cause, &quot;retry&quot;);
2264   }
2265 }
2266 
2267 bool G1CollectedHeap::try_collect(GCCause::Cause cause) {
2268   assert_heap_not_locked();
2269 
2270   // Lock to get consistent set of values.
2271   uint gc_count_before;
2272   uint full_gc_count_before;
2273   uint old_marking_started_before;
2274   {
2275     MutexLocker ml(Heap_lock);
2276     gc_count_before = total_collections();
2277     full_gc_count_before = total_full_collections();
2278     old_marking_started_before = _old_marking_cycles_started;
2279   }
2280 
2281   if (should_do_concurrent_full_gc(cause)) {
2282     return try_collect_concurrently(cause,
2283                                     gc_count_before,
2284                                     old_marking_started_before);
2285   } else if (GCLocker::should_discard(cause, gc_count_before)) {
2286     // Indicate failure to be consistent with VMOp failure due to
2287     // another collection slipping in after our gc_count but before
2288     // our request is processed.
2289     return false;
2290   } else if (cause == GCCause::_gc_locker || cause == GCCause::_wb_young_gc
2291              DEBUG_ONLY(|| cause == GCCause::_scavenge_alot)) {
2292 
2293     // Schedule a standard evacuation pause. We&#39;re setting word_size
2294     // to 0 which means that we are not requesting a post-GC allocation.
2295     VM_G1CollectForAllocation op(0,     /* word_size */
2296                                  gc_count_before,
2297                                  cause,
2298                                  policy()-&gt;max_pause_time_ms());
2299     VMThread::execute(&amp;op);
2300     return op.gc_succeeded();
2301   } else {
2302     // Schedule a Full GC.
2303     VM_G1CollectFull op(gc_count_before, full_gc_count_before, cause);
2304     VMThread::execute(&amp;op);
2305     return op.gc_succeeded();
2306   }
2307 }
2308 
2309 bool G1CollectedHeap::is_in(const void* p) const {
2310   if (_hrm-&gt;reserved().contains(p)) {
2311     // Given that we know that p is in the reserved space,
2312     // heap_region_containing() should successfully
2313     // return the containing region.
2314     HeapRegion* hr = heap_region_containing(p);
2315     return hr-&gt;is_in(p);
2316   } else {
2317     return false;
2318   }
2319 }
2320 
2321 #ifdef ASSERT
2322 bool G1CollectedHeap::is_in_exact(const void* p) const {
2323   bool contains = reserved_region().contains(p);
2324   bool available = _hrm-&gt;is_available(addr_to_region((HeapWord*)p));
2325   if (contains &amp;&amp; available) {
2326     return true;
2327   } else {
2328     return false;
2329   }
2330 }
2331 #endif
2332 
2333 // Iteration functions.
2334 
2335 // Iterates an ObjectClosure over all objects within a HeapRegion.
2336 
2337 class IterateObjectClosureRegionClosure: public HeapRegionClosure {
2338   ObjectClosure* _cl;
2339 public:
2340   IterateObjectClosureRegionClosure(ObjectClosure* cl) : _cl(cl) {}
2341   bool do_heap_region(HeapRegion* r) {
2342     if (!r-&gt;is_continues_humongous()) {
2343       r-&gt;object_iterate(_cl);
2344     }
2345     return false;
2346   }
2347 };
2348 
2349 void G1CollectedHeap::object_iterate(ObjectClosure* cl) {
2350   IterateObjectClosureRegionClosure blk(cl);
2351   heap_region_iterate(&amp;blk);
2352 }
2353 
2354 void G1CollectedHeap::keep_alive(oop obj) {
2355   G1BarrierSet::enqueue(obj);
2356 }
2357 
2358 void G1CollectedHeap::heap_region_iterate(HeapRegionClosure* cl) const {
2359   _hrm-&gt;iterate(cl);
2360 }
2361 
2362 void G1CollectedHeap::heap_region_par_iterate_from_worker_offset(HeapRegionClosure* cl,
2363                                                                  HeapRegionClaimer *hrclaimer,
2364                                                                  uint worker_id) const {
2365   _hrm-&gt;par_iterate(cl, hrclaimer, hrclaimer-&gt;offset_for_worker(worker_id));
2366 }
2367 
2368 void G1CollectedHeap::heap_region_par_iterate_from_start(HeapRegionClosure* cl,
2369                                                          HeapRegionClaimer *hrclaimer) const {
2370   _hrm-&gt;par_iterate(cl, hrclaimer, 0);
2371 }
2372 
2373 void G1CollectedHeap::collection_set_iterate_all(HeapRegionClosure* cl) {
2374   _collection_set.iterate(cl);
2375 }
2376 
2377 void G1CollectedHeap::collection_set_par_iterate_all(HeapRegionClosure* cl, HeapRegionClaimer* hr_claimer, uint worker_id) {
2378   _collection_set.par_iterate(cl, hr_claimer, worker_id, workers()-&gt;active_workers());
2379 }
2380 
2381 void G1CollectedHeap::collection_set_iterate_increment_from(HeapRegionClosure *cl, HeapRegionClaimer* hr_claimer, uint worker_id) {
2382   _collection_set.iterate_incremental_part_from(cl, hr_claimer, worker_id, workers()-&gt;active_workers());
2383 }
2384 
2385 HeapWord* G1CollectedHeap::block_start(const void* addr) const {
2386   HeapRegion* hr = heap_region_containing(addr);
2387   return hr-&gt;block_start(addr);
2388 }
2389 
2390 bool G1CollectedHeap::block_is_obj(const HeapWord* addr) const {
2391   HeapRegion* hr = heap_region_containing(addr);
2392   return hr-&gt;block_is_obj(addr);
2393 }
2394 
2395 bool G1CollectedHeap::supports_tlab_allocation() const {
2396   return true;
2397 }
2398 
2399 size_t G1CollectedHeap::tlab_capacity(Thread* ignored) const {
2400   return (_policy-&gt;young_list_target_length() - _survivor.length()) * HeapRegion::GrainBytes;
2401 }
2402 
2403 size_t G1CollectedHeap::tlab_used(Thread* ignored) const {
2404   return _eden.length() * HeapRegion::GrainBytes;
2405 }
2406 
2407 // For G1 TLABs should not contain humongous objects, so the maximum TLAB size
2408 // must be equal to the humongous object limit.
2409 size_t G1CollectedHeap::max_tlab_size() const {
2410   return align_down(_humongous_object_threshold_in_words, MinObjAlignment);
2411 }
2412 
2413 size_t G1CollectedHeap::unsafe_max_tlab_alloc(Thread* ignored) const {
2414   return _allocator-&gt;unsafe_max_tlab_alloc();
2415 }
2416 
2417 size_t G1CollectedHeap::max_capacity() const {
2418   return _hrm-&gt;max_expandable_length() * HeapRegion::GrainBytes;
2419 }
2420 
2421 size_t G1CollectedHeap::max_reserved_capacity() const {
2422   return _hrm-&gt;max_length() * HeapRegion::GrainBytes;
2423 }
2424 
2425 jlong G1CollectedHeap::millis_since_last_gc() {
2426   // See the notes in GenCollectedHeap::millis_since_last_gc()
2427   // for more information about the implementation.
2428   jlong ret_val = (os::javaTimeNanos() / NANOSECS_PER_MILLISEC) -
2429                   _policy-&gt;collection_pause_end_millis();
2430   if (ret_val &lt; 0) {
2431     log_warning(gc)(&quot;millis_since_last_gc() would return : &quot; JLONG_FORMAT
2432       &quot;. returning zero instead.&quot;, ret_val);
2433     return 0;
2434   }
2435   return ret_val;
2436 }
2437 
2438 void G1CollectedHeap::deduplicate_string(oop str) {
2439   assert(java_lang_String::is_instance(str), &quot;invariant&quot;);
2440 
2441   if (G1StringDedup::is_enabled()) {
2442     G1StringDedup::deduplicate(str);
2443   }
2444 }
2445 
2446 void G1CollectedHeap::prepare_for_verify() {
2447   _verifier-&gt;prepare_for_verify();
2448 }
2449 
2450 void G1CollectedHeap::verify(VerifyOption vo) {
2451   _verifier-&gt;verify(vo);
2452 }
2453 
<a name="22" id="anc22"></a><span class="line-modified">2454 bool G1CollectedHeap::supports_concurrent_gc_breakpoints() const {</span>
2455   return true;
2456 }
2457 
<a name="23" id="anc23"></a>



2458 bool G1CollectedHeap::is_heterogeneous_heap() const {
2459   return G1Arguments::is_heterogeneous_heap();
2460 }
2461 
2462 class PrintRegionClosure: public HeapRegionClosure {
2463   outputStream* _st;
2464 public:
2465   PrintRegionClosure(outputStream* st) : _st(st) {}
2466   bool do_heap_region(HeapRegion* r) {
2467     r-&gt;print_on(_st);
2468     return false;
2469   }
2470 };
2471 
2472 bool G1CollectedHeap::is_obj_dead_cond(const oop obj,
2473                                        const HeapRegion* hr,
2474                                        const VerifyOption vo) const {
2475   switch (vo) {
2476   case VerifyOption_G1UsePrevMarking: return is_obj_dead(obj, hr);
2477   case VerifyOption_G1UseNextMarking: return is_obj_ill(obj, hr);
2478   case VerifyOption_G1UseFullMarking: return is_obj_dead_full(obj, hr);
2479   default:                            ShouldNotReachHere();
2480   }
2481   return false; // keep some compilers happy
2482 }
2483 
2484 bool G1CollectedHeap::is_obj_dead_cond(const oop obj,
2485                                        const VerifyOption vo) const {
2486   switch (vo) {
2487   case VerifyOption_G1UsePrevMarking: return is_obj_dead(obj);
2488   case VerifyOption_G1UseNextMarking: return is_obj_ill(obj);
2489   case VerifyOption_G1UseFullMarking: return is_obj_dead_full(obj);
2490   default:                            ShouldNotReachHere();
2491   }
2492   return false; // keep some compilers happy
2493 }
2494 
2495 void G1CollectedHeap::print_heap_regions() const {
2496   LogTarget(Trace, gc, heap, region) lt;
2497   if (lt.is_enabled()) {
2498     LogStream ls(lt);
2499     print_regions_on(&amp;ls);
2500   }
2501 }
2502 
2503 void G1CollectedHeap::print_on(outputStream* st) const {
2504   st-&gt;print(&quot; %-20s&quot;, &quot;garbage-first heap&quot;);
2505   st-&gt;print(&quot; total &quot; SIZE_FORMAT &quot;K, used &quot; SIZE_FORMAT &quot;K&quot;,
2506             capacity()/K, used_unlocked()/K);
2507   st-&gt;print(&quot; [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;)&quot;,
2508             p2i(_hrm-&gt;reserved().start()),
2509             p2i(_hrm-&gt;reserved().end()));
2510   st-&gt;cr();
2511   st-&gt;print(&quot;  region size &quot; SIZE_FORMAT &quot;K, &quot;, HeapRegion::GrainBytes / K);
2512   uint young_regions = young_regions_count();
2513   st-&gt;print(&quot;%u young (&quot; SIZE_FORMAT &quot;K), &quot;, young_regions,
2514             (size_t) young_regions * HeapRegion::GrainBytes / K);
2515   uint survivor_regions = survivor_regions_count();
2516   st-&gt;print(&quot;%u survivors (&quot; SIZE_FORMAT &quot;K)&quot;, survivor_regions,
2517             (size_t) survivor_regions * HeapRegion::GrainBytes / K);
2518   st-&gt;cr();
2519   if (_numa-&gt;is_enabled()) {
2520     uint num_nodes = _numa-&gt;num_active_nodes();
2521     st-&gt;print(&quot;  remaining free region(s) on each NUMA node: &quot;);
2522     const int* node_ids = _numa-&gt;node_ids();
2523     for (uint node_index = 0; node_index &lt; num_nodes; node_index++) {
2524       st-&gt;print(&quot;%d=%u &quot;, node_ids[node_index], _hrm-&gt;num_free_regions(node_index));
2525     }
2526     st-&gt;cr();
2527   }
2528   MetaspaceUtils::print_on(st);
2529 }
2530 
2531 void G1CollectedHeap::print_regions_on(outputStream* st) const {
2532   st-&gt;print_cr(&quot;Heap Regions: E=young(eden), S=young(survivor), O=old, &quot;
2533                &quot;HS=humongous(starts), HC=humongous(continues), &quot;
2534                &quot;CS=collection set, F=free, &quot;
2535                &quot;OA=open archive, CA=closed archive, &quot;
2536                &quot;TAMS=top-at-mark-start (previous, next)&quot;);
2537   PrintRegionClosure blk(st);
2538   heap_region_iterate(&amp;blk);
2539 }
2540 
2541 void G1CollectedHeap::print_extended_on(outputStream* st) const {
2542   print_on(st);
2543 
2544   // Print the per-region information.
2545   print_regions_on(st);
2546 }
2547 
2548 void G1CollectedHeap::print_on_error(outputStream* st) const {
2549   this-&gt;CollectedHeap::print_on_error(st);
2550 
2551   if (_cm != NULL) {
2552     st-&gt;cr();
2553     _cm-&gt;print_on_error(st);
2554   }
2555 }
2556 
2557 void G1CollectedHeap::print_gc_threads_on(outputStream* st) const {
2558   workers()-&gt;print_worker_threads_on(st);
2559   _cm_thread-&gt;print_on(st);
2560   st-&gt;cr();
2561   _cm-&gt;print_worker_threads_on(st);
2562   _cr-&gt;print_threads_on(st);
2563   _young_gen_sampling_thread-&gt;print_on(st);
2564   if (G1StringDedup::is_enabled()) {
2565     G1StringDedup::print_worker_threads_on(st);
2566   }
2567 }
2568 
2569 void G1CollectedHeap::gc_threads_do(ThreadClosure* tc) const {
2570   workers()-&gt;threads_do(tc);
2571   tc-&gt;do_thread(_cm_thread);
2572   _cm-&gt;threads_do(tc);
2573   _cr-&gt;threads_do(tc);
2574   tc-&gt;do_thread(_young_gen_sampling_thread);
2575   if (G1StringDedup::is_enabled()) {
2576     G1StringDedup::threads_do(tc);
2577   }
2578 }
2579 
2580 void G1CollectedHeap::print_tracing_info() const {
2581   rem_set()-&gt;print_summary_info();
2582   concurrent_mark()-&gt;print_summary_info();
2583 }
2584 
2585 #ifndef PRODUCT
2586 // Helpful for debugging RSet issues.
2587 
2588 class PrintRSetsClosure : public HeapRegionClosure {
2589 private:
2590   const char* _msg;
2591   size_t _occupied_sum;
2592 
2593 public:
2594   bool do_heap_region(HeapRegion* r) {
2595     HeapRegionRemSet* hrrs = r-&gt;rem_set();
2596     size_t occupied = hrrs-&gt;occupied();
2597     _occupied_sum += occupied;
2598 
2599     tty-&gt;print_cr(&quot;Printing RSet for region &quot; HR_FORMAT, HR_FORMAT_PARAMS(r));
2600     if (occupied == 0) {
2601       tty-&gt;print_cr(&quot;  RSet is empty&quot;);
2602     } else {
2603       hrrs-&gt;print();
2604     }
2605     tty-&gt;print_cr(&quot;----------&quot;);
2606     return false;
2607   }
2608 
2609   PrintRSetsClosure(const char* msg) : _msg(msg), _occupied_sum(0) {
2610     tty-&gt;cr();
2611     tty-&gt;print_cr(&quot;========================================&quot;);
2612     tty-&gt;print_cr(&quot;%s&quot;, msg);
2613     tty-&gt;cr();
2614   }
2615 
2616   ~PrintRSetsClosure() {
2617     tty-&gt;print_cr(&quot;Occupied Sum: &quot; SIZE_FORMAT, _occupied_sum);
2618     tty-&gt;print_cr(&quot;========================================&quot;);
2619     tty-&gt;cr();
2620   }
2621 };
2622 
2623 void G1CollectedHeap::print_cset_rsets() {
2624   PrintRSetsClosure cl(&quot;Printing CSet RSets&quot;);
2625   collection_set_iterate_all(&amp;cl);
2626 }
2627 
2628 void G1CollectedHeap::print_all_rsets() {
2629   PrintRSetsClosure cl(&quot;Printing All RSets&quot;);;
2630   heap_region_iterate(&amp;cl);
2631 }
2632 #endif // PRODUCT
2633 
2634 bool G1CollectedHeap::print_location(outputStream* st, void* addr) const {
2635   return BlockLocationPrinter&lt;G1CollectedHeap&gt;::print_location(st, addr);
2636 }
2637 
2638 G1HeapSummary G1CollectedHeap::create_g1_heap_summary() {
2639 
2640   size_t eden_used_bytes = _eden.used_bytes();
2641   size_t survivor_used_bytes = _survivor.used_bytes();
2642   size_t heap_used = Heap_lock-&gt;owned_by_self() ? used() : used_unlocked();
2643 
2644   size_t eden_capacity_bytes =
2645     (policy()-&gt;young_list_target_length() * HeapRegion::GrainBytes) - survivor_used_bytes;
2646 
2647   VirtualSpaceSummary heap_summary = create_heap_space_summary();
2648   return G1HeapSummary(heap_summary, heap_used, eden_used_bytes,
2649                        eden_capacity_bytes, survivor_used_bytes, num_regions());
2650 }
2651 
2652 G1EvacSummary G1CollectedHeap::create_g1_evac_summary(G1EvacStats* stats) {
2653   return G1EvacSummary(stats-&gt;allocated(), stats-&gt;wasted(), stats-&gt;undo_wasted(),
2654                        stats-&gt;unused(), stats-&gt;used(), stats-&gt;region_end_waste(),
2655                        stats-&gt;regions_filled(), stats-&gt;direct_allocated(),
2656                        stats-&gt;failure_used(), stats-&gt;failure_waste());
2657 }
2658 
2659 void G1CollectedHeap::trace_heap(GCWhen::Type when, const GCTracer* gc_tracer) {
2660   const G1HeapSummary&amp; heap_summary = create_g1_heap_summary();
2661   gc_tracer-&gt;report_gc_heap_summary(when, heap_summary);
2662 
2663   const MetaspaceSummary&amp; metaspace_summary = create_metaspace_summary();
2664   gc_tracer-&gt;report_metaspace_summary(when, metaspace_summary);
2665 }
2666 
2667 G1CollectedHeap* G1CollectedHeap::heap() {
2668   CollectedHeap* heap = Universe::heap();
2669   assert(heap != NULL, &quot;Uninitialized access to G1CollectedHeap::heap()&quot;);
2670   assert(heap-&gt;kind() == CollectedHeap::G1, &quot;Invalid name&quot;);
2671   return (G1CollectedHeap*)heap;
2672 }
2673 
2674 void G1CollectedHeap::gc_prologue(bool full) {
2675   assert(InlineCacheBuffer::is_empty(), &quot;should have cleaned up ICBuffer&quot;);
2676 
2677   // This summary needs to be printed before incrementing total collections.
2678   rem_set()-&gt;print_periodic_summary_info(&quot;Before GC RS summary&quot;, total_collections());
2679 
2680   // Update common counters.
2681   increment_total_collections(full /* full gc */);
2682   if (full || collector_state()-&gt;in_initial_mark_gc()) {
2683     increment_old_marking_cycles_started();
2684   }
2685 
2686   // Fill TLAB&#39;s and such
2687   double start = os::elapsedTime();
2688   ensure_parsability(true);
2689   phase_times()-&gt;record_prepare_tlab_time_ms((os::elapsedTime() - start) * 1000.0);
2690 }
2691 
2692 void G1CollectedHeap::gc_epilogue(bool full) {
2693   // Update common counters.
2694   if (full) {
2695     // Update the number of full collections that have been completed.
2696     increment_old_marking_cycles_completed(false /* concurrent */);
2697   }
2698 
2699   // We are at the end of the GC. Total collections has already been increased.
2700   rem_set()-&gt;print_periodic_summary_info(&quot;After GC RS summary&quot;, total_collections() - 1);
2701 
2702   // FIXME: what is this about?
2703   // I&#39;m ignoring the &quot;fill_newgen()&quot; call if &quot;alloc_event_enabled&quot;
2704   // is set.
2705 #if COMPILER2_OR_JVMCI
2706   assert(DerivedPointerTable::is_empty(), &quot;derived pointer present&quot;);
2707 #endif
2708 
2709   double start = os::elapsedTime();
2710   resize_all_tlabs();
2711   phase_times()-&gt;record_resize_tlab_time_ms((os::elapsedTime() - start) * 1000.0);
2712 
2713   MemoryService::track_memory_usage();
2714   // We have just completed a GC. Update the soft reference
2715   // policy with the new heap occupancy
2716   Universe::update_heap_info_at_gc();
2717 
2718   // Print NUMA statistics.
2719   _numa-&gt;print_statistics();
2720 }
2721 
2722 void G1CollectedHeap::verify_numa_regions(const char* desc) {
2723   LogTarget(Trace, gc, heap, verify) lt;
2724 
2725   if (lt.is_enabled()) {
2726     LogStream ls(lt);
2727     // Iterate all heap regions to print matching between preferred numa id and actual numa id.
2728     G1NodeIndexCheckClosure cl(desc, _numa, &amp;ls);
2729     heap_region_iterate(&amp;cl);
2730   }
2731 }
2732 
2733 HeapWord* G1CollectedHeap::do_collection_pause(size_t word_size,
2734                                                uint gc_count_before,
2735                                                bool* succeeded,
2736                                                GCCause::Cause gc_cause) {
2737   assert_heap_not_locked_and_not_at_safepoint();
2738   VM_G1CollectForAllocation op(word_size,
2739                                gc_count_before,
2740                                gc_cause,
2741                                policy()-&gt;max_pause_time_ms());
2742   VMThread::execute(&amp;op);
2743 
2744   HeapWord* result = op.result();
2745   bool ret_succeeded = op.prologue_succeeded() &amp;&amp; op.gc_succeeded();
2746   assert(result == NULL || ret_succeeded,
2747          &quot;the result should be NULL if the VM did not succeed&quot;);
2748   *succeeded = ret_succeeded;
2749 
2750   assert_heap_not_locked();
2751   return result;
2752 }
2753 
2754 void G1CollectedHeap::do_concurrent_mark() {
2755   MutexLocker x(CGC_lock, Mutex::_no_safepoint_check_flag);
2756   if (!_cm_thread-&gt;in_progress()) {
2757     _cm_thread-&gt;set_started();
2758     CGC_lock-&gt;notify();
2759   }
2760 }
2761 
2762 size_t G1CollectedHeap::pending_card_num() {
2763   struct CountCardsClosure : public ThreadClosure {
2764     size_t _cards;
2765     CountCardsClosure() : _cards(0) {}
2766     virtual void do_thread(Thread* t) {
2767       _cards += G1ThreadLocalData::dirty_card_queue(t).size();
2768     }
2769   } count_from_threads;
2770   Threads::threads_do(&amp;count_from_threads);
2771 
2772   G1DirtyCardQueueSet&amp; dcqs = G1BarrierSet::dirty_card_queue_set();
2773   return dcqs.num_cards() + count_from_threads._cards;
2774 }
2775 
2776 bool G1CollectedHeap::is_potential_eager_reclaim_candidate(HeapRegion* r) const {
2777   // We don&#39;t nominate objects with many remembered set entries, on
2778   // the assumption that such objects are likely still live.
2779   HeapRegionRemSet* rem_set = r-&gt;rem_set();
2780 
2781   return G1EagerReclaimHumongousObjectsWithStaleRefs ?
2782          rem_set-&gt;occupancy_less_or_equal_than(G1RSetSparseRegionEntries) :
2783          G1EagerReclaimHumongousObjects &amp;&amp; rem_set-&gt;is_empty();
2784 }
2785 
2786 #ifndef PRODUCT
2787 void G1CollectedHeap::verify_region_attr_remset_update() {
2788   class VerifyRegionAttrRemSet : public HeapRegionClosure {
2789   public:
2790     virtual bool do_heap_region(HeapRegion* r) {
2791       G1CollectedHeap* g1h = G1CollectedHeap::heap();
2792       bool const needs_remset_update = g1h-&gt;region_attr(r-&gt;bottom()).needs_remset_update();
2793       assert(r-&gt;rem_set()-&gt;is_tracked() == needs_remset_update,
2794              &quot;Region %u remset tracking status (%s) different to region attribute (%s)&quot;,
2795              r-&gt;hrm_index(), BOOL_TO_STR(r-&gt;rem_set()-&gt;is_tracked()), BOOL_TO_STR(needs_remset_update));
2796       return false;
2797     }
2798   } cl;
2799   heap_region_iterate(&amp;cl);
2800 }
2801 #endif
2802 
2803 class VerifyRegionRemSetClosure : public HeapRegionClosure {
2804   public:
2805     bool do_heap_region(HeapRegion* hr) {
2806       if (!hr-&gt;is_archive() &amp;&amp; !hr-&gt;is_continues_humongous()) {
2807         hr-&gt;verify_rem_set();
2808       }
2809       return false;
2810     }
2811 };
2812 
2813 uint G1CollectedHeap::num_task_queues() const {
2814   return _task_queues-&gt;size();
2815 }
2816 
2817 #if TASKQUEUE_STATS
2818 void G1CollectedHeap::print_taskqueue_stats_hdr(outputStream* const st) {
2819   st-&gt;print_raw_cr(&quot;GC Task Stats&quot;);
2820   st-&gt;print_raw(&quot;thr &quot;); TaskQueueStats::print_header(1, st); st-&gt;cr();
2821   st-&gt;print_raw(&quot;--- &quot;); TaskQueueStats::print_header(2, st); st-&gt;cr();
2822 }
2823 
2824 void G1CollectedHeap::print_taskqueue_stats() const {
2825   if (!log_is_enabled(Trace, gc, task, stats)) {
2826     return;
2827   }
2828   Log(gc, task, stats) log;
2829   ResourceMark rm;
2830   LogStream ls(log.trace());
2831   outputStream* st = &amp;ls;
2832 
2833   print_taskqueue_stats_hdr(st);
2834 
2835   TaskQueueStats totals;
2836   const uint n = num_task_queues();
2837   for (uint i = 0; i &lt; n; ++i) {
2838     st-&gt;print(&quot;%3u &quot;, i); task_queue(i)-&gt;stats.print(st); st-&gt;cr();
2839     totals += task_queue(i)-&gt;stats;
2840   }
2841   st-&gt;print_raw(&quot;tot &quot;); totals.print(st); st-&gt;cr();
2842 
2843   DEBUG_ONLY(totals.verify());
2844 }
2845 
2846 void G1CollectedHeap::reset_taskqueue_stats() {
2847   const uint n = num_task_queues();
2848   for (uint i = 0; i &lt; n; ++i) {
2849     task_queue(i)-&gt;stats.reset();
2850   }
2851 }
2852 #endif // TASKQUEUE_STATS
2853 
2854 void G1CollectedHeap::wait_for_root_region_scanning() {
2855   double scan_wait_start = os::elapsedTime();
2856   // We have to wait until the CM threads finish scanning the
2857   // root regions as it&#39;s the only way to ensure that all the
2858   // objects on them have been correctly scanned before we start
2859   // moving them during the GC.
2860   bool waited = _cm-&gt;root_regions()-&gt;wait_until_scan_finished();
2861   double wait_time_ms = 0.0;
2862   if (waited) {
2863     double scan_wait_end = os::elapsedTime();
2864     wait_time_ms = (scan_wait_end - scan_wait_start) * 1000.0;
2865   }
2866   phase_times()-&gt;record_root_region_scan_wait_time(wait_time_ms);
2867 }
2868 
2869 class G1PrintCollectionSetClosure : public HeapRegionClosure {
2870 private:
2871   G1HRPrinter* _hr_printer;
2872 public:
2873   G1PrintCollectionSetClosure(G1HRPrinter* hr_printer) : HeapRegionClosure(), _hr_printer(hr_printer) { }
2874 
2875   virtual bool do_heap_region(HeapRegion* r) {
2876     _hr_printer-&gt;cset(r);
2877     return false;
2878   }
2879 };
2880 
2881 void G1CollectedHeap::start_new_collection_set() {
2882   double start = os::elapsedTime();
2883 
2884   collection_set()-&gt;start_incremental_building();
2885 
2886   clear_region_attr();
2887 
2888   guarantee(_eden.length() == 0, &quot;eden should have been cleared&quot;);
2889   policy()-&gt;transfer_survivors_to_cset(survivor());
2890 
2891   // We redo the verification but now wrt to the new CSet which
2892   // has just got initialized after the previous CSet was freed.
2893   _cm-&gt;verify_no_collection_set_oops();
2894 
2895   phase_times()-&gt;record_start_new_cset_time_ms((os::elapsedTime() - start) * 1000.0);
2896 }
2897 
2898 void G1CollectedHeap::calculate_collection_set(G1EvacuationInfo&amp; evacuation_info, double target_pause_time_ms) {
2899 
2900   _collection_set.finalize_initial_collection_set(target_pause_time_ms, &amp;_survivor);
2901   evacuation_info.set_collectionset_regions(collection_set()-&gt;region_length() +
2902                                             collection_set()-&gt;optional_region_length());
2903 
2904   _cm-&gt;verify_no_collection_set_oops();
2905 
2906   if (_hr_printer.is_active()) {
2907     G1PrintCollectionSetClosure cl(&amp;_hr_printer);
2908     _collection_set.iterate(&amp;cl);
2909     _collection_set.iterate_optional(&amp;cl);
2910   }
2911 }
2912 
2913 G1HeapVerifier::G1VerifyType G1CollectedHeap::young_collection_verify_type() const {
2914   if (collector_state()-&gt;in_initial_mark_gc()) {
2915     return G1HeapVerifier::G1VerifyConcurrentStart;
2916   } else if (collector_state()-&gt;in_young_only_phase()) {
2917     return G1HeapVerifier::G1VerifyYoungNormal;
2918   } else {
2919     return G1HeapVerifier::G1VerifyMixed;
2920   }
2921 }
2922 
2923 void G1CollectedHeap::verify_before_young_collection(G1HeapVerifier::G1VerifyType type) {
2924   if (VerifyRememberedSets) {
2925     log_info(gc, verify)(&quot;[Verifying RemSets before GC]&quot;);
2926     VerifyRegionRemSetClosure v_cl;
2927     heap_region_iterate(&amp;v_cl);
2928   }
2929   _verifier-&gt;verify_before_gc(type);
2930   _verifier-&gt;check_bitmaps(&quot;GC Start&quot;);
2931   verify_numa_regions(&quot;GC Start&quot;);
2932 }
2933 
2934 void G1CollectedHeap::verify_after_young_collection(G1HeapVerifier::G1VerifyType type) {
2935   if (VerifyRememberedSets) {
2936     log_info(gc, verify)(&quot;[Verifying RemSets after GC]&quot;);
2937     VerifyRegionRemSetClosure v_cl;
2938     heap_region_iterate(&amp;v_cl);
2939   }
2940   _verifier-&gt;verify_after_gc(type);
2941   _verifier-&gt;check_bitmaps(&quot;GC End&quot;);
2942   verify_numa_regions(&quot;GC End&quot;);
2943 }
2944 
2945 void G1CollectedHeap::expand_heap_after_young_collection(){
2946   size_t expand_bytes = _heap_sizing_policy-&gt;expansion_amount();
2947   if (expand_bytes &gt; 0) {
2948     // No need for an ergo logging here,
2949     // expansion_amount() does this when it returns a value &gt; 0.
2950     double expand_ms;
2951     if (!expand(expand_bytes, _workers, &amp;expand_ms)) {
2952       // We failed to expand the heap. Cannot do anything about it.
2953     }
2954     phase_times()-&gt;record_expand_heap_time(expand_ms);
2955   }
2956 }
2957 
2958 const char* G1CollectedHeap::young_gc_name() const {
2959   if (collector_state()-&gt;in_initial_mark_gc()) {
2960     return &quot;Pause Young (Concurrent Start)&quot;;
2961   } else if (collector_state()-&gt;in_young_only_phase()) {
2962     if (collector_state()-&gt;in_young_gc_before_mixed()) {
2963       return &quot;Pause Young (Prepare Mixed)&quot;;
2964     } else {
2965       return &quot;Pause Young (Normal)&quot;;
2966     }
2967   } else {
2968     return &quot;Pause Young (Mixed)&quot;;
2969   }
2970 }
2971 
2972 bool G1CollectedHeap::do_collection_pause_at_safepoint(double target_pause_time_ms) {
2973   assert_at_safepoint_on_vm_thread();
2974   guarantee(!is_gc_active(), &quot;collection is not reentrant&quot;);
2975 
2976   if (GCLocker::check_active_before_gc()) {
2977     return false;
2978   }
2979 
2980   do_collection_pause_at_safepoint_helper(target_pause_time_ms);
2981   if (should_upgrade_to_full_gc(gc_cause())) {
2982     log_info(gc, ergo)(&quot;Attempting maximally compacting collection&quot;);
2983     bool result = do_full_collection(false /* explicit gc */,
2984                                      true /* clear_all_soft_refs */);
2985     // do_full_collection only fails if blocked by GC locker, but
2986     // we&#39;ve already checked for that above.
2987     assert(result, &quot;invariant&quot;);
2988   }
2989   return true;
2990 }
2991 
2992 void G1CollectedHeap::do_collection_pause_at_safepoint_helper(double target_pause_time_ms) {
2993   GCIdMark gc_id_mark;
2994 
2995   SvcGCMarker sgcm(SvcGCMarker::MINOR);
2996   ResourceMark rm;
2997 
2998   policy()-&gt;note_gc_start();
2999 
3000   _gc_timer_stw-&gt;register_gc_start();
3001   _gc_tracer_stw-&gt;report_gc_start(gc_cause(), _gc_timer_stw-&gt;gc_start());
3002 
3003   wait_for_root_region_scanning();
3004 
3005   print_heap_before_gc();
3006   print_heap_regions();
3007   trace_heap_before_gc(_gc_tracer_stw);
3008 
3009   _verifier-&gt;verify_region_sets_optional();
3010   _verifier-&gt;verify_dirty_young_regions();
3011 
3012   // We should not be doing initial mark unless the conc mark thread is running
3013   if (!_cm_thread-&gt;should_terminate()) {
3014     // This call will decide whether this pause is an initial-mark
3015     // pause. If it is, in_initial_mark_gc() will return true
3016     // for the duration of this pause.
3017     policy()-&gt;decide_on_conc_mark_initiation();
3018   }
3019 
3020   // We do not allow initial-mark to be piggy-backed on a mixed GC.
3021   assert(!collector_state()-&gt;in_initial_mark_gc() ||
3022          collector_state()-&gt;in_young_only_phase(), &quot;sanity&quot;);
3023   // We also do not allow mixed GCs during marking.
3024   assert(!collector_state()-&gt;mark_or_rebuild_in_progress() || collector_state()-&gt;in_young_only_phase(), &quot;sanity&quot;);
3025 
3026   // Record whether this pause is an initial mark. When the current
3027   // thread has completed its logging output and it&#39;s safe to signal
3028   // the CM thread, the flag&#39;s value in the policy has been reset.
3029   bool should_start_conc_mark = collector_state()-&gt;in_initial_mark_gc();
3030   if (should_start_conc_mark) {
3031     _cm-&gt;gc_tracer_cm()-&gt;set_gc_cause(gc_cause());
3032   }
3033 
3034   // Inner scope for scope based logging, timers, and stats collection
3035   {
3036     G1EvacuationInfo evacuation_info;
3037 
3038     _gc_tracer_stw-&gt;report_yc_type(collector_state()-&gt;yc_type());
3039 
3040     GCTraceCPUTime tcpu;
3041 
3042     GCTraceTime(Info, gc) tm(young_gc_name(), NULL, gc_cause(), true);
3043 
3044     uint active_workers = WorkerPolicy::calc_active_workers(workers()-&gt;total_workers(),
3045                                                             workers()-&gt;active_workers(),
3046                                                             Threads::number_of_non_daemon_threads());
3047     active_workers = workers()-&gt;update_active_workers(active_workers);
3048     log_info(gc,task)(&quot;Using %u workers of %u for evacuation&quot;, active_workers, workers()-&gt;total_workers());
3049 
3050     G1MonitoringScope ms(g1mm(),
3051                          false /* full_gc */,
3052                          collector_state()-&gt;yc_type() == Mixed /* all_memory_pools_affected */);
3053 
3054     G1HeapTransition heap_transition(this);
3055 
3056     {
3057       IsGCActiveMark x;
3058 
3059       gc_prologue(false);
3060 
3061       G1HeapVerifier::G1VerifyType verify_type = young_collection_verify_type();
3062       verify_before_young_collection(verify_type);
3063 
3064       {
3065         // The elapsed time induced by the start time below deliberately elides
3066         // the possible verification above.
3067         double sample_start_time_sec = os::elapsedTime();
3068 
3069         // Please see comment in g1CollectedHeap.hpp and
3070         // G1CollectedHeap::ref_processing_init() to see how
3071         // reference processing currently works in G1.
3072         _ref_processor_stw-&gt;enable_discovery();
3073 
3074         // We want to temporarily turn off discovery by the
3075         // CM ref processor, if necessary, and turn it back on
3076         // on again later if we do. Using a scoped
3077         // NoRefDiscovery object will do this.
3078         NoRefDiscovery no_cm_discovery(_ref_processor_cm);
3079 
3080         policy()-&gt;record_collection_pause_start(sample_start_time_sec);
3081 
3082         // Forget the current allocation region (we might even choose it to be part
3083         // of the collection set!).
3084         _allocator-&gt;release_mutator_alloc_regions();
3085 
3086         calculate_collection_set(evacuation_info, target_pause_time_ms);
3087 
3088         G1RedirtyCardsQueueSet rdcqs(G1BarrierSet::dirty_card_queue_set().allocator());
3089         G1ParScanThreadStateSet per_thread_states(this,
3090                                                   &amp;rdcqs,
3091                                                   workers()-&gt;active_workers(),
3092                                                   collection_set()-&gt;young_region_length(),
3093                                                   collection_set()-&gt;optional_region_length());
3094         pre_evacuate_collection_set(evacuation_info, &amp;per_thread_states);
3095 
3096         // Actually do the work...
3097         evacuate_initial_collection_set(&amp;per_thread_states);
3098 
3099         if (_collection_set.optional_region_length() != 0) {
3100           evacuate_optional_collection_set(&amp;per_thread_states);
3101         }
3102         post_evacuate_collection_set(evacuation_info, &amp;rdcqs, &amp;per_thread_states);
3103 
3104         start_new_collection_set();
3105 
3106         _survivor_evac_stats.adjust_desired_plab_sz();
3107         _old_evac_stats.adjust_desired_plab_sz();
3108 
3109         if (should_start_conc_mark) {
3110           // We have to do this before we notify the CM threads that
3111           // they can start working to make sure that all the
3112           // appropriate initialization is done on the CM object.
3113           concurrent_mark()-&gt;post_initial_mark();
3114           // Note that we don&#39;t actually trigger the CM thread at
3115           // this point. We do that later when we&#39;re sure that
3116           // the current thread has completed its logging output.
3117         }
3118 
3119         allocate_dummy_regions();
3120 
3121         _allocator-&gt;init_mutator_alloc_regions();
3122 
3123         expand_heap_after_young_collection();
3124 
3125         double sample_end_time_sec = os::elapsedTime();
3126         double pause_time_ms = (sample_end_time_sec - sample_start_time_sec) * MILLIUNITS;
3127         policy()-&gt;record_collection_pause_end(pause_time_ms);
3128       }
3129 
3130       verify_after_young_collection(verify_type);
3131 
3132       gc_epilogue(false);
3133     }
3134 
3135     // Print the remainder of the GC log output.
3136     if (evacuation_failed()) {
3137       log_info(gc)(&quot;To-space exhausted&quot;);
3138     }
3139 
3140     policy()-&gt;print_phases();
3141     heap_transition.print();
3142 
3143     _hrm-&gt;verify_optional();
3144     _verifier-&gt;verify_region_sets_optional();
3145 
3146     TASKQUEUE_STATS_ONLY(print_taskqueue_stats());
3147     TASKQUEUE_STATS_ONLY(reset_taskqueue_stats());
3148 
3149     print_heap_after_gc();
3150     print_heap_regions();
3151     trace_heap_after_gc(_gc_tracer_stw);
3152 
3153     // We must call G1MonitoringSupport::update_sizes() in the same scoping level
3154     // as an active TraceMemoryManagerStats object (i.e. before the destructor for the
3155     // TraceMemoryManagerStats is called) so that the G1 memory pools are updated
3156     // before any GC notifications are raised.
3157     g1mm()-&gt;update_sizes();
3158 
3159     _gc_tracer_stw-&gt;report_evacuation_info(&amp;evacuation_info);
3160     _gc_tracer_stw-&gt;report_tenuring_threshold(_policy-&gt;tenuring_threshold());
3161     _gc_timer_stw-&gt;register_gc_end();
3162     _gc_tracer_stw-&gt;report_gc_end(_gc_timer_stw-&gt;gc_end(), _gc_timer_stw-&gt;time_partitions());
3163   }
3164   // It should now be safe to tell the concurrent mark thread to start
3165   // without its logging output interfering with the logging output
3166   // that came from the pause.
3167 
3168   if (should_start_conc_mark) {
3169     // CAUTION: after the doConcurrentMark() call below, the concurrent marking
3170     // thread(s) could be running concurrently with us. Make sure that anything
3171     // after this point does not assume that we are the only GC thread running.
3172     // Note: of course, the actual marking work will not start until the safepoint
3173     // itself is released in SuspendibleThreadSet::desynchronize().
3174     do_concurrent_mark();
<a name="24" id="anc24"></a><span class="line-added">3175     ConcurrentGCBreakpoints::notify_idle_to_active();</span>
3176   }
3177 }
3178 
3179 void G1CollectedHeap::remove_self_forwarding_pointers(G1RedirtyCardsQueueSet* rdcqs) {
3180   G1ParRemoveSelfForwardPtrsTask rsfp_task(rdcqs);
3181   workers()-&gt;run_task(&amp;rsfp_task);
3182 }
3183 
3184 void G1CollectedHeap::restore_after_evac_failure(G1RedirtyCardsQueueSet* rdcqs) {
3185   double remove_self_forwards_start = os::elapsedTime();
3186 
3187   remove_self_forwarding_pointers(rdcqs);
3188   _preserved_marks_set.restore(workers());
3189 
3190   phase_times()-&gt;record_evac_fail_remove_self_forwards((os::elapsedTime() - remove_self_forwards_start) * 1000.0);
3191 }
3192 
3193 void G1CollectedHeap::preserve_mark_during_evac_failure(uint worker_id, oop obj, markWord m) {
3194   if (!_evacuation_failed) {
3195     _evacuation_failed = true;
3196   }
3197 
3198   _evacuation_failed_info_array[worker_id].register_copy_failure(obj-&gt;size());
3199   _preserved_marks_set.get(worker_id)-&gt;push_if_necessary(obj, m);
3200 }
3201 
3202 bool G1ParEvacuateFollowersClosure::offer_termination() {
3203   EventGCPhaseParallel event;
3204   G1ParScanThreadState* const pss = par_scan_state();
3205   start_term_time();
3206   const bool res = terminator()-&gt;offer_termination();
3207   end_term_time();
3208   event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(G1GCPhaseTimes::Termination));
3209   return res;
3210 }
3211 
3212 void G1ParEvacuateFollowersClosure::do_void() {
3213   EventGCPhaseParallel event;
3214   G1ParScanThreadState* const pss = par_scan_state();
3215   pss-&gt;trim_queue();
3216   event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(_phase));
3217   do {
3218     EventGCPhaseParallel event;
3219     pss-&gt;steal_and_trim_queue(queues());
3220     event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(_phase));
3221   } while (!offer_termination());
3222 }
3223 
3224 void G1CollectedHeap::complete_cleaning(BoolObjectClosure* is_alive,
3225                                         bool class_unloading_occurred) {
3226   uint num_workers = workers()-&gt;active_workers();
3227   G1ParallelCleaningTask unlink_task(is_alive, num_workers, class_unloading_occurred, false);
3228   workers()-&gt;run_task(&amp;unlink_task);
3229 }
3230 
3231 // Clean string dedup data structures.
3232 // Ideally we would prefer to use a StringDedupCleaningTask here, but we want to
3233 // record the durations of the phases. Hence the almost-copy.
3234 class G1StringDedupCleaningTask : public AbstractGangTask {
3235   BoolObjectClosure* _is_alive;
3236   OopClosure* _keep_alive;
3237   G1GCPhaseTimes* _phase_times;
3238 
3239 public:
3240   G1StringDedupCleaningTask(BoolObjectClosure* is_alive,
3241                             OopClosure* keep_alive,
3242                             G1GCPhaseTimes* phase_times) :
3243     AbstractGangTask(&quot;Partial Cleaning Task&quot;),
3244     _is_alive(is_alive),
3245     _keep_alive(keep_alive),
3246     _phase_times(phase_times)
3247   {
3248     assert(G1StringDedup::is_enabled(), &quot;String deduplication disabled.&quot;);
3249     StringDedup::gc_prologue(true);
3250   }
3251 
3252   ~G1StringDedupCleaningTask() {
3253     StringDedup::gc_epilogue();
3254   }
3255 
3256   void work(uint worker_id) {
3257     StringDedupUnlinkOrOopsDoClosure cl(_is_alive, _keep_alive);
3258     {
3259       G1GCParPhaseTimesTracker x(_phase_times, G1GCPhaseTimes::StringDedupQueueFixup, worker_id);
3260       StringDedupQueue::unlink_or_oops_do(&amp;cl);
3261     }
3262     {
3263       G1GCParPhaseTimesTracker x(_phase_times, G1GCPhaseTimes::StringDedupTableFixup, worker_id);
3264       StringDedupTable::unlink_or_oops_do(&amp;cl, worker_id);
3265     }
3266   }
3267 };
3268 
3269 void G1CollectedHeap::string_dedup_cleaning(BoolObjectClosure* is_alive,
3270                                             OopClosure* keep_alive,
3271                                             G1GCPhaseTimes* phase_times) {
3272   G1StringDedupCleaningTask cl(is_alive, keep_alive, phase_times);
3273   workers()-&gt;run_task(&amp;cl);
3274 }
3275 
3276 class G1RedirtyLoggedCardsTask : public AbstractGangTask {
3277  private:
3278   G1RedirtyCardsQueueSet* _qset;
3279   G1CollectedHeap* _g1h;
3280   BufferNode* volatile _nodes;
3281 
3282   void par_apply(RedirtyLoggedCardTableEntryClosure* cl, uint worker_id) {
3283     size_t buffer_size = _qset-&gt;buffer_size();
3284     BufferNode* next = Atomic::load(&amp;_nodes);
3285     while (next != NULL) {
3286       BufferNode* node = next;
3287       next = Atomic::cmpxchg(&amp;_nodes, node, node-&gt;next());
3288       if (next == node) {
3289         cl-&gt;apply_to_buffer(node, buffer_size, worker_id);
3290         next = node-&gt;next();
3291       }
3292     }
3293   }
3294 
3295  public:
3296   G1RedirtyLoggedCardsTask(G1RedirtyCardsQueueSet* qset, G1CollectedHeap* g1h) :
3297     AbstractGangTask(&quot;Redirty Cards&quot;),
3298     _qset(qset), _g1h(g1h), _nodes(qset-&gt;all_completed_buffers()) { }
3299 
3300   virtual void work(uint worker_id) {
3301     G1GCPhaseTimes* p = _g1h-&gt;phase_times();
3302     G1GCParPhaseTimesTracker x(p, G1GCPhaseTimes::RedirtyCards, worker_id);
3303 
3304     RedirtyLoggedCardTableEntryClosure cl(_g1h);
3305     par_apply(&amp;cl, worker_id);
3306 
3307     p-&gt;record_thread_work_item(G1GCPhaseTimes::RedirtyCards, worker_id, cl.num_dirtied());
3308   }
3309 };
3310 
3311 void G1CollectedHeap::redirty_logged_cards(G1RedirtyCardsQueueSet* rdcqs) {
3312   double redirty_logged_cards_start = os::elapsedTime();
3313 
3314   G1RedirtyLoggedCardsTask redirty_task(rdcqs, this);
3315   workers()-&gt;run_task(&amp;redirty_task);
3316 
3317   G1DirtyCardQueueSet&amp; dcq = G1BarrierSet::dirty_card_queue_set();
3318   dcq.merge_bufferlists(rdcqs);
3319 
3320   phase_times()-&gt;record_redirty_logged_cards_time_ms((os::elapsedTime() - redirty_logged_cards_start) * 1000.0);
3321 }
3322 
3323 // Weak Reference Processing support
3324 
3325 bool G1STWIsAliveClosure::do_object_b(oop p) {
3326   // An object is reachable if it is outside the collection set,
3327   // or is inside and copied.
3328   return !_g1h-&gt;is_in_cset(p) || p-&gt;is_forwarded();
3329 }
3330 
3331 bool G1STWSubjectToDiscoveryClosure::do_object_b(oop obj) {
3332   assert(obj != NULL, &quot;must not be NULL&quot;);
3333   assert(_g1h-&gt;is_in_reserved(obj), &quot;Trying to discover obj &quot; PTR_FORMAT &quot; not in heap&quot;, p2i(obj));
3334   // The areas the CM and STW ref processor manage must be disjoint. The is_in_cset() below
3335   // may falsely indicate that this is not the case here: however the collection set only
3336   // contains old regions when concurrent mark is not running.
3337   return _g1h-&gt;is_in_cset(obj) || _g1h-&gt;heap_region_containing(obj)-&gt;is_survivor();
3338 }
3339 
3340 // Non Copying Keep Alive closure
3341 class G1KeepAliveClosure: public OopClosure {
3342   G1CollectedHeap*_g1h;
3343 public:
3344   G1KeepAliveClosure(G1CollectedHeap* g1h) :_g1h(g1h) {}
3345   void do_oop(narrowOop* p) { guarantee(false, &quot;Not needed&quot;); }
3346   void do_oop(oop* p) {
3347     oop obj = *p;
3348     assert(obj != NULL, &quot;the caller should have filtered out NULL values&quot;);
3349 
3350     const G1HeapRegionAttr region_attr =_g1h-&gt;region_attr(obj);
3351     if (!region_attr.is_in_cset_or_humongous()) {
3352       return;
3353     }
3354     if (region_attr.is_in_cset()) {
3355       assert( obj-&gt;is_forwarded(), &quot;invariant&quot; );
3356       *p = obj-&gt;forwardee();
3357     } else {
3358       assert(!obj-&gt;is_forwarded(), &quot;invariant&quot; );
3359       assert(region_attr.is_humongous(),
3360              &quot;Only allowed G1HeapRegionAttr state is IsHumongous, but is %d&quot;, region_attr.type());
3361      _g1h-&gt;set_humongous_is_live(obj);
3362     }
3363   }
3364 };
3365 
3366 // Copying Keep Alive closure - can be called from both
3367 // serial and parallel code as long as different worker
3368 // threads utilize different G1ParScanThreadState instances
3369 // and different queues.
3370 
3371 class G1CopyingKeepAliveClosure: public OopClosure {
3372   G1CollectedHeap*         _g1h;
3373   G1ParScanThreadState*    _par_scan_state;
3374 
3375 public:
3376   G1CopyingKeepAliveClosure(G1CollectedHeap* g1h,
3377                             G1ParScanThreadState* pss):
3378     _g1h(g1h),
3379     _par_scan_state(pss)
3380   {}
3381 
3382   virtual void do_oop(narrowOop* p) { do_oop_work(p); }
3383   virtual void do_oop(      oop* p) { do_oop_work(p); }
3384 
3385   template &lt;class T&gt; void do_oop_work(T* p) {
3386     oop obj = RawAccess&lt;&gt;::oop_load(p);
3387 
3388     if (_g1h-&gt;is_in_cset_or_humongous(obj)) {
3389       // If the referent object has been forwarded (either copied
3390       // to a new location or to itself in the event of an
3391       // evacuation failure) then we need to update the reference
3392       // field and, if both reference and referent are in the G1
3393       // heap, update the RSet for the referent.
3394       //
3395       // If the referent has not been forwarded then we have to keep
3396       // it alive by policy. Therefore we have copy the referent.
3397       //
3398       // When the queue is drained (after each phase of reference processing)
3399       // the object and it&#39;s followers will be copied, the reference field set
3400       // to point to the new location, and the RSet updated.
3401       _par_scan_state-&gt;push_on_queue(p);
3402     }
3403   }
3404 };
3405 
3406 // Serial drain queue closure. Called as the &#39;complete_gc&#39;
3407 // closure for each discovered list in some of the
3408 // reference processing phases.
3409 
3410 class G1STWDrainQueueClosure: public VoidClosure {
3411 protected:
3412   G1CollectedHeap* _g1h;
3413   G1ParScanThreadState* _par_scan_state;
3414 
3415   G1ParScanThreadState*   par_scan_state() { return _par_scan_state; }
3416 
3417 public:
3418   G1STWDrainQueueClosure(G1CollectedHeap* g1h, G1ParScanThreadState* pss) :
3419     _g1h(g1h),
3420     _par_scan_state(pss)
3421   { }
3422 
3423   void do_void() {
3424     G1ParScanThreadState* const pss = par_scan_state();
3425     pss-&gt;trim_queue();
3426   }
3427 };
3428 
3429 // Parallel Reference Processing closures
3430 
3431 // Implementation of AbstractRefProcTaskExecutor for parallel reference
3432 // processing during G1 evacuation pauses.
3433 
3434 class G1STWRefProcTaskExecutor: public AbstractRefProcTaskExecutor {
3435 private:
3436   G1CollectedHeap*          _g1h;
3437   G1ParScanThreadStateSet*  _pss;
3438   RefToScanQueueSet*        _queues;
3439   WorkGang*                 _workers;
3440 
3441 public:
3442   G1STWRefProcTaskExecutor(G1CollectedHeap* g1h,
3443                            G1ParScanThreadStateSet* per_thread_states,
3444                            WorkGang* workers,
3445                            RefToScanQueueSet *task_queues) :
3446     _g1h(g1h),
3447     _pss(per_thread_states),
3448     _queues(task_queues),
3449     _workers(workers)
3450   {
3451     g1h-&gt;ref_processor_stw()-&gt;set_active_mt_degree(workers-&gt;active_workers());
3452   }
3453 
3454   // Executes the given task using concurrent marking worker threads.
3455   virtual void execute(ProcessTask&amp; task, uint ergo_workers);
3456 };
3457 
3458 // Gang task for possibly parallel reference processing
3459 
3460 class G1STWRefProcTaskProxy: public AbstractGangTask {
3461   typedef AbstractRefProcTaskExecutor::ProcessTask ProcessTask;
3462   ProcessTask&amp;     _proc_task;
3463   G1CollectedHeap* _g1h;
3464   G1ParScanThreadStateSet* _pss;
3465   RefToScanQueueSet* _task_queues;
3466   TaskTerminator* _terminator;
3467 
3468 public:
3469   G1STWRefProcTaskProxy(ProcessTask&amp; proc_task,
3470                         G1CollectedHeap* g1h,
3471                         G1ParScanThreadStateSet* per_thread_states,
3472                         RefToScanQueueSet *task_queues,
3473                         TaskTerminator* terminator) :
3474     AbstractGangTask(&quot;Process reference objects in parallel&quot;),
3475     _proc_task(proc_task),
3476     _g1h(g1h),
3477     _pss(per_thread_states),
3478     _task_queues(task_queues),
3479     _terminator(terminator)
3480   {}
3481 
3482   virtual void work(uint worker_id) {
3483     // The reference processing task executed by a single worker.
3484     ResourceMark rm;
3485     HandleMark   hm;
3486 
3487     G1STWIsAliveClosure is_alive(_g1h);
3488 
3489     G1ParScanThreadState* pss = _pss-&gt;state_for_worker(worker_id);
3490     pss-&gt;set_ref_discoverer(NULL);
3491 
3492     // Keep alive closure.
3493     G1CopyingKeepAliveClosure keep_alive(_g1h, pss);
3494 
3495     // Complete GC closure
3496     G1ParEvacuateFollowersClosure drain_queue(_g1h, pss, _task_queues, _terminator, G1GCPhaseTimes::ObjCopy);
3497 
3498     // Call the reference processing task&#39;s work routine.
3499     _proc_task.work(worker_id, is_alive, keep_alive, drain_queue);
3500 
3501     // Note we cannot assert that the refs array is empty here as not all
3502     // of the processing tasks (specifically phase2 - pp2_work) execute
3503     // the complete_gc closure (which ordinarily would drain the queue) so
3504     // the queue may not be empty.
3505   }
3506 };
3507 
3508 // Driver routine for parallel reference processing.
3509 // Creates an instance of the ref processing gang
3510 // task and has the worker threads execute it.
3511 void G1STWRefProcTaskExecutor::execute(ProcessTask&amp; proc_task, uint ergo_workers) {
3512   assert(_workers != NULL, &quot;Need parallel worker threads.&quot;);
3513 
3514   assert(_workers-&gt;active_workers() &gt;= ergo_workers,
3515          &quot;Ergonomically chosen workers (%u) should be less than or equal to active workers (%u)&quot;,
3516          ergo_workers, _workers-&gt;active_workers());
3517   TaskTerminator terminator(ergo_workers, _queues);
3518   G1STWRefProcTaskProxy proc_task_proxy(proc_task, _g1h, _pss, _queues, &amp;terminator);
3519 
3520   _workers-&gt;run_task(&amp;proc_task_proxy, ergo_workers);
3521 }
3522 
3523 // End of weak reference support closures
3524 
3525 void G1CollectedHeap::process_discovered_references(G1ParScanThreadStateSet* per_thread_states) {
3526   double ref_proc_start = os::elapsedTime();
3527 
3528   ReferenceProcessor* rp = _ref_processor_stw;
3529   assert(rp-&gt;discovery_enabled(), &quot;should have been enabled&quot;);
3530 
3531   // Closure to test whether a referent is alive.
3532   G1STWIsAliveClosure is_alive(this);
3533 
3534   // Even when parallel reference processing is enabled, the processing
3535   // of JNI refs is serial and performed serially by the current thread
3536   // rather than by a worker. The following PSS will be used for processing
3537   // JNI refs.
3538 
3539   // Use only a single queue for this PSS.
3540   G1ParScanThreadState*          pss = per_thread_states-&gt;state_for_worker(0);
3541   pss-&gt;set_ref_discoverer(NULL);
3542   assert(pss-&gt;queue_is_empty(), &quot;pre-condition&quot;);
3543 
3544   // Keep alive closure.
3545   G1CopyingKeepAliveClosure keep_alive(this, pss);
3546 
3547   // Serial Complete GC closure
3548   G1STWDrainQueueClosure drain_queue(this, pss);
3549 
3550   // Setup the soft refs policy...
3551   rp-&gt;setup_policy(false);
3552 
3553   ReferenceProcessorPhaseTimes* pt = phase_times()-&gt;ref_phase_times();
3554 
3555   ReferenceProcessorStats stats;
3556   if (!rp-&gt;processing_is_mt()) {
3557     // Serial reference processing...
3558     stats = rp-&gt;process_discovered_references(&amp;is_alive,
3559                                               &amp;keep_alive,
3560                                               &amp;drain_queue,
3561                                               NULL,
3562                                               pt);
3563   } else {
3564     uint no_of_gc_workers = workers()-&gt;active_workers();
3565 
3566     // Parallel reference processing
3567     assert(no_of_gc_workers &lt;= rp-&gt;max_num_queues(),
3568            &quot;Mismatch between the number of GC workers %u and the maximum number of Reference process queues %u&quot;,
3569            no_of_gc_workers,  rp-&gt;max_num_queues());
3570 
3571     G1STWRefProcTaskExecutor par_task_executor(this, per_thread_states, workers(), _task_queues);
3572     stats = rp-&gt;process_discovered_references(&amp;is_alive,
3573                                               &amp;keep_alive,
3574                                               &amp;drain_queue,
3575                                               &amp;par_task_executor,
3576                                               pt);
3577   }
3578 
3579   _gc_tracer_stw-&gt;report_gc_reference_stats(stats);
3580 
3581   // We have completed copying any necessary live referent objects.
3582   assert(pss-&gt;queue_is_empty(), &quot;both queue and overflow should be empty&quot;);
3583 
3584   make_pending_list_reachable();
3585 
3586   assert(!rp-&gt;discovery_enabled(), &quot;Postcondition&quot;);
3587   rp-&gt;verify_no_references_recorded();
3588 
3589   double ref_proc_time = os::elapsedTime() - ref_proc_start;
3590   phase_times()-&gt;record_ref_proc_time(ref_proc_time * 1000.0);
3591 }
3592 
3593 void G1CollectedHeap::make_pending_list_reachable() {
3594   if (collector_state()-&gt;in_initial_mark_gc()) {
3595     oop pll_head = Universe::reference_pending_list();
3596     if (pll_head != NULL) {
3597       // Any valid worker id is fine here as we are in the VM thread and single-threaded.
3598       _cm-&gt;mark_in_next_bitmap(0 /* worker_id */, pll_head);
3599     }
3600   }
3601 }
3602 
3603 void G1CollectedHeap::merge_per_thread_state_info(G1ParScanThreadStateSet* per_thread_states) {
3604   Ticks start = Ticks::now();
3605   per_thread_states-&gt;flush();
3606   phase_times()-&gt;record_or_add_time_secs(G1GCPhaseTimes::MergePSS, 0 /* worker_id */, (Ticks::now() - start).seconds());
3607 }
3608 
3609 class G1PrepareEvacuationTask : public AbstractGangTask {
3610   class G1PrepareRegionsClosure : public HeapRegionClosure {
3611     G1CollectedHeap* _g1h;
3612     G1PrepareEvacuationTask* _parent_task;
3613     size_t _worker_humongous_total;
3614     size_t _worker_humongous_candidates;
3615 
3616     bool humongous_region_is_candidate(HeapRegion* region) const {
3617       assert(region-&gt;is_starts_humongous(), &quot;Must start a humongous object&quot;);
3618 
3619       oop obj = oop(region-&gt;bottom());
3620 
3621       // Dead objects cannot be eager reclaim candidates. Due to class
3622       // unloading it is unsafe to query their classes so we return early.
3623       if (_g1h-&gt;is_obj_dead(obj, region)) {
3624         return false;
3625       }
3626 
3627       // If we do not have a complete remembered set for the region, then we can
3628       // not be sure that we have all references to it.
3629       if (!region-&gt;rem_set()-&gt;is_complete()) {
3630         return false;
3631       }
3632       // Candidate selection must satisfy the following constraints
3633       // while concurrent marking is in progress:
3634       //
3635       // * In order to maintain SATB invariants, an object must not be
3636       // reclaimed if it was allocated before the start of marking and
3637       // has not had its references scanned.  Such an object must have
3638       // its references (including type metadata) scanned to ensure no
3639       // live objects are missed by the marking process.  Objects
3640       // allocated after the start of concurrent marking don&#39;t need to
3641       // be scanned.
3642       //
3643       // * An object must not be reclaimed if it is on the concurrent
3644       // mark stack.  Objects allocated after the start of concurrent
3645       // marking are never pushed on the mark stack.
3646       //
3647       // Nominating only objects allocated after the start of concurrent
3648       // marking is sufficient to meet both constraints.  This may miss
3649       // some objects that satisfy the constraints, but the marking data
3650       // structures don&#39;t support efficiently performing the needed
3651       // additional tests or scrubbing of the mark stack.
3652       //
3653       // However, we presently only nominate is_typeArray() objects.
3654       // A humongous object containing references induces remembered
3655       // set entries on other regions.  In order to reclaim such an
3656       // object, those remembered sets would need to be cleaned up.
3657       //
3658       // We also treat is_typeArray() objects specially, allowing them
3659       // to be reclaimed even if allocated before the start of
3660       // concurrent mark.  For this we rely on mark stack insertion to
3661       // exclude is_typeArray() objects, preventing reclaiming an object
3662       // that is in the mark stack.  We also rely on the metadata for
3663       // such objects to be built-in and so ensured to be kept live.
3664       // Frequent allocation and drop of large binary blobs is an
3665       // important use case for eager reclaim, and this special handling
3666       // may reduce needed headroom.
3667 
3668       return obj-&gt;is_typeArray() &amp;&amp;
3669              _g1h-&gt;is_potential_eager_reclaim_candidate(region);
3670     }
3671 
3672   public:
3673     G1PrepareRegionsClosure(G1CollectedHeap* g1h, G1PrepareEvacuationTask* parent_task) :
3674       _g1h(g1h),
3675       _parent_task(parent_task),
3676       _worker_humongous_total(0),
3677       _worker_humongous_candidates(0) { }
3678 
3679     ~G1PrepareRegionsClosure() {
3680       _parent_task-&gt;add_humongous_candidates(_worker_humongous_candidates);
3681       _parent_task-&gt;add_humongous_total(_worker_humongous_total);
3682     }
3683 
3684     virtual bool do_heap_region(HeapRegion* hr) {
3685       // First prepare the region for scanning
3686       _g1h-&gt;rem_set()-&gt;prepare_region_for_scan(hr);
3687 
3688       // Now check if region is a humongous candidate
3689       if (!hr-&gt;is_starts_humongous()) {
3690         _g1h-&gt;register_region_with_region_attr(hr);
3691         return false;
3692       }
3693 
3694       uint index = hr-&gt;hrm_index();
3695       if (humongous_region_is_candidate(hr)) {
3696         _g1h-&gt;set_humongous_reclaim_candidate(index, true);
3697         _g1h-&gt;register_humongous_region_with_region_attr(index);
3698         _worker_humongous_candidates++;
3699         // We will later handle the remembered sets of these regions.
3700       } else {
3701         _g1h-&gt;set_humongous_reclaim_candidate(index, false);
3702         _g1h-&gt;register_region_with_region_attr(hr);
3703       }
3704       _worker_humongous_total++;
3705 
3706       return false;
3707     }
3708   };
3709 
3710   G1CollectedHeap* _g1h;
3711   HeapRegionClaimer _claimer;
3712   volatile size_t _humongous_total;
3713   volatile size_t _humongous_candidates;
3714 public:
3715   G1PrepareEvacuationTask(G1CollectedHeap* g1h) :
3716     AbstractGangTask(&quot;Prepare Evacuation&quot;),
3717     _g1h(g1h),
3718     _claimer(_g1h-&gt;workers()-&gt;active_workers()),
3719     _humongous_total(0),
3720     _humongous_candidates(0) { }
3721 
3722   ~G1PrepareEvacuationTask() {
3723     _g1h-&gt;set_has_humongous_reclaim_candidate(_humongous_candidates &gt; 0);
3724   }
3725 
3726   void work(uint worker_id) {
3727     G1PrepareRegionsClosure cl(_g1h, this);
3728     _g1h-&gt;heap_region_par_iterate_from_worker_offset(&amp;cl, &amp;_claimer, worker_id);
3729   }
3730 
3731   void add_humongous_candidates(size_t candidates) {
3732     Atomic::add(&amp;_humongous_candidates, candidates);
3733   }
3734 
3735   void add_humongous_total(size_t total) {
3736     Atomic::add(&amp;_humongous_total, total);
3737   }
3738 
3739   size_t humongous_candidates() {
3740     return _humongous_candidates;
3741   }
3742 
3743   size_t humongous_total() {
3744     return _humongous_total;
3745   }
3746 };
3747 
3748 void G1CollectedHeap::pre_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info, G1ParScanThreadStateSet* per_thread_states) {
3749   _bytes_used_during_gc = 0;
3750 
3751   _expand_heap_after_alloc_failure = true;
3752   _evacuation_failed = false;
3753 
3754   // Disable the hot card cache.
3755   _hot_card_cache-&gt;reset_hot_cache_claimed_index();
3756   _hot_card_cache-&gt;set_use_cache(false);
3757 
3758   // Initialize the GC alloc regions.
3759   _allocator-&gt;init_gc_alloc_regions(evacuation_info);
3760 
3761   {
3762     Ticks start = Ticks::now();
3763     rem_set()-&gt;prepare_for_scan_heap_roots();
3764     phase_times()-&gt;record_prepare_heap_roots_time_ms((Ticks::now() - start).seconds() * 1000.0);
3765   }
3766 
3767   {
3768     G1PrepareEvacuationTask g1_prep_task(this);
3769     Tickspan task_time = run_task(&amp;g1_prep_task);
3770 
3771     phase_times()-&gt;record_register_regions(task_time.seconds() * 1000.0,
3772                                            g1_prep_task.humongous_total(),
3773                                            g1_prep_task.humongous_candidates());
3774   }
3775 
3776   assert(_verifier-&gt;check_region_attr_table(), &quot;Inconsistency in the region attributes table.&quot;);
3777   _preserved_marks_set.assert_empty();
3778 
3779 #if COMPILER2_OR_JVMCI
3780   DerivedPointerTable::clear();
3781 #endif
3782 
3783   // InitialMark needs claim bits to keep track of the marked-through CLDs.
3784   if (collector_state()-&gt;in_initial_mark_gc()) {
3785     concurrent_mark()-&gt;pre_initial_mark();
3786 
3787     double start_clear_claimed_marks = os::elapsedTime();
3788 
3789     ClassLoaderDataGraph::clear_claimed_marks();
3790 
3791     double recorded_clear_claimed_marks_time_ms = (os::elapsedTime() - start_clear_claimed_marks) * 1000.0;
3792     phase_times()-&gt;record_clear_claimed_marks_time_ms(recorded_clear_claimed_marks_time_ms);
3793   }
3794 
3795   // Should G1EvacuationFailureALot be in effect for this GC?
3796   NOT_PRODUCT(set_evacuation_failure_alot_for_current_gc();)
3797 }
3798 
3799 class G1EvacuateRegionsBaseTask : public AbstractGangTask {
3800 protected:
3801   G1CollectedHeap* _g1h;
3802   G1ParScanThreadStateSet* _per_thread_states;
3803   RefToScanQueueSet* _task_queues;
3804   TaskTerminator _terminator;
3805   uint _num_workers;
3806 
3807   void evacuate_live_objects(G1ParScanThreadState* pss,
3808                              uint worker_id,
3809                              G1GCPhaseTimes::GCParPhases objcopy_phase,
3810                              G1GCPhaseTimes::GCParPhases termination_phase) {
3811     G1GCPhaseTimes* p = _g1h-&gt;phase_times();
3812 
3813     Ticks start = Ticks::now();
3814     G1ParEvacuateFollowersClosure cl(_g1h, pss, _task_queues, &amp;_terminator, objcopy_phase);
3815     cl.do_void();
3816 
3817     assert(pss-&gt;queue_is_empty(), &quot;should be empty&quot;);
3818 
3819     Tickspan evac_time = (Ticks::now() - start);
3820     p-&gt;record_or_add_time_secs(objcopy_phase, worker_id, evac_time.seconds() - cl.term_time());
3821 
3822     if (termination_phase == G1GCPhaseTimes::Termination) {
3823       p-&gt;record_time_secs(termination_phase, worker_id, cl.term_time());
3824       p-&gt;record_thread_work_item(termination_phase, worker_id, cl.term_attempts());
3825     } else {
3826       p-&gt;record_or_add_time_secs(termination_phase, worker_id, cl.term_time());
3827       p-&gt;record_or_add_thread_work_item(termination_phase, worker_id, cl.term_attempts());
3828     }
3829     assert(pss-&gt;trim_ticks().seconds() == 0.0, &quot;Unexpected partial trimming during evacuation&quot;);
3830   }
3831 
3832   virtual void start_work(uint worker_id) { }
3833 
3834   virtual void end_work(uint worker_id) { }
3835 
3836   virtual void scan_roots(G1ParScanThreadState* pss, uint worker_id) = 0;
3837 
3838   virtual void evacuate_live_objects(G1ParScanThreadState* pss, uint worker_id) = 0;
3839 
3840 public:
3841   G1EvacuateRegionsBaseTask(const char* name, G1ParScanThreadStateSet* per_thread_states, RefToScanQueueSet* task_queues, uint num_workers) :
3842     AbstractGangTask(name),
3843     _g1h(G1CollectedHeap::heap()),
3844     _per_thread_states(per_thread_states),
3845     _task_queues(task_queues),
3846     _terminator(num_workers, _task_queues),
3847     _num_workers(num_workers)
3848   { }
3849 
3850   void work(uint worker_id) {
3851     start_work(worker_id);
3852 
3853     {
3854       ResourceMark rm;
3855       HandleMark   hm;
3856 
3857       G1ParScanThreadState* pss = _per_thread_states-&gt;state_for_worker(worker_id);
3858       pss-&gt;set_ref_discoverer(_g1h-&gt;ref_processor_stw());
3859 
3860       scan_roots(pss, worker_id);
3861       evacuate_live_objects(pss, worker_id);
3862     }
3863 
3864     end_work(worker_id);
3865   }
3866 };
3867 
3868 class G1EvacuateRegionsTask : public G1EvacuateRegionsBaseTask {
3869   G1RootProcessor* _root_processor;
3870 
3871   void scan_roots(G1ParScanThreadState* pss, uint worker_id) {
3872     _root_processor-&gt;evacuate_roots(pss, worker_id);
3873     _g1h-&gt;rem_set()-&gt;scan_heap_roots(pss, worker_id, G1GCPhaseTimes::ScanHR, G1GCPhaseTimes::ObjCopy);
3874     _g1h-&gt;rem_set()-&gt;scan_collection_set_regions(pss, worker_id, G1GCPhaseTimes::ScanHR, G1GCPhaseTimes::CodeRoots, G1GCPhaseTimes::ObjCopy);
3875   }
3876 
3877   void evacuate_live_objects(G1ParScanThreadState* pss, uint worker_id) {
3878     G1EvacuateRegionsBaseTask::evacuate_live_objects(pss, worker_id, G1GCPhaseTimes::ObjCopy, G1GCPhaseTimes::Termination);
3879   }
3880 
3881   void start_work(uint worker_id) {
3882     _g1h-&gt;phase_times()-&gt;record_time_secs(G1GCPhaseTimes::GCWorkerStart, worker_id, Ticks::now().seconds());
3883   }
3884 
3885   void end_work(uint worker_id) {
3886     _g1h-&gt;phase_times()-&gt;record_time_secs(G1GCPhaseTimes::GCWorkerEnd, worker_id, Ticks::now().seconds());
3887   }
3888 
3889 public:
3890   G1EvacuateRegionsTask(G1CollectedHeap* g1h,
3891                         G1ParScanThreadStateSet* per_thread_states,
3892                         RefToScanQueueSet* task_queues,
3893                         G1RootProcessor* root_processor,
3894                         uint num_workers) :
3895     G1EvacuateRegionsBaseTask(&quot;G1 Evacuate Regions&quot;, per_thread_states, task_queues, num_workers),
3896     _root_processor(root_processor)
3897   { }
3898 };
3899 
3900 void G1CollectedHeap::evacuate_initial_collection_set(G1ParScanThreadStateSet* per_thread_states) {
3901   G1GCPhaseTimes* p = phase_times();
3902 
3903   {
3904     Ticks start = Ticks::now();
3905     rem_set()-&gt;merge_heap_roots(true /* initial_evacuation */);
3906     p-&gt;record_merge_heap_roots_time((Ticks::now() - start).seconds() * 1000.0);
3907   }
3908 
3909   Tickspan task_time;
3910   const uint num_workers = workers()-&gt;active_workers();
3911 
3912   Ticks start_processing = Ticks::now();
3913   {
3914     G1RootProcessor root_processor(this, num_workers);
3915     G1EvacuateRegionsTask g1_par_task(this, per_thread_states, _task_queues, &amp;root_processor, num_workers);
3916     task_time = run_task(&amp;g1_par_task);
3917     // Closing the inner scope will execute the destructor for the G1RootProcessor object.
3918     // To extract its code root fixup time we measure total time of this scope and
3919     // subtract from the time the WorkGang task took.
3920   }
3921   Tickspan total_processing = Ticks::now() - start_processing;
3922 
3923   p-&gt;record_initial_evac_time(task_time.seconds() * 1000.0);
3924   p-&gt;record_or_add_code_root_fixup_time((total_processing - task_time).seconds() * 1000.0);
3925 }
3926 
3927 class G1EvacuateOptionalRegionsTask : public G1EvacuateRegionsBaseTask {
3928 
3929   void scan_roots(G1ParScanThreadState* pss, uint worker_id) {
3930     _g1h-&gt;rem_set()-&gt;scan_heap_roots(pss, worker_id, G1GCPhaseTimes::OptScanHR, G1GCPhaseTimes::OptObjCopy);
3931     _g1h-&gt;rem_set()-&gt;scan_collection_set_regions(pss, worker_id, G1GCPhaseTimes::OptScanHR, G1GCPhaseTimes::OptCodeRoots, G1GCPhaseTimes::OptObjCopy);
3932   }
3933 
3934   void evacuate_live_objects(G1ParScanThreadState* pss, uint worker_id) {
3935     G1EvacuateRegionsBaseTask::evacuate_live_objects(pss, worker_id, G1GCPhaseTimes::OptObjCopy, G1GCPhaseTimes::OptTermination);
3936   }
3937 
3938 public:
3939   G1EvacuateOptionalRegionsTask(G1ParScanThreadStateSet* per_thread_states,
3940                                 RefToScanQueueSet* queues,
3941                                 uint num_workers) :
3942     G1EvacuateRegionsBaseTask(&quot;G1 Evacuate Optional Regions&quot;, per_thread_states, queues, num_workers) {
3943   }
3944 };
3945 
3946 void G1CollectedHeap::evacuate_next_optional_regions(G1ParScanThreadStateSet* per_thread_states) {
3947   class G1MarkScope : public MarkScope { };
3948 
3949   Tickspan task_time;
3950 
3951   Ticks start_processing = Ticks::now();
3952   {
3953     G1MarkScope code_mark_scope;
3954     G1EvacuateOptionalRegionsTask task(per_thread_states, _task_queues, workers()-&gt;active_workers());
3955     task_time = run_task(&amp;task);
3956     // See comment in evacuate_collection_set() for the reason of the scope.
3957   }
3958   Tickspan total_processing = Ticks::now() - start_processing;
3959 
3960   G1GCPhaseTimes* p = phase_times();
3961   p-&gt;record_or_add_code_root_fixup_time((total_processing - task_time).seconds() * 1000.0);
3962 }
3963 
3964 void G1CollectedHeap::evacuate_optional_collection_set(G1ParScanThreadStateSet* per_thread_states) {
3965   const double gc_start_time_ms = phase_times()-&gt;cur_collection_start_sec() * 1000.0;
3966 
3967   while (!evacuation_failed() &amp;&amp; _collection_set.optional_region_length() &gt; 0) {
3968 
3969     double time_used_ms = os::elapsedTime() * 1000.0 - gc_start_time_ms;
3970     double time_left_ms = MaxGCPauseMillis - time_used_ms;
3971 
3972     if (time_left_ms &lt; 0 ||
3973         !_collection_set.finalize_optional_for_evacuation(time_left_ms * policy()-&gt;optional_evacuation_fraction())) {
3974       log_trace(gc, ergo, cset)(&quot;Skipping evacuation of %u optional regions, no more regions can be evacuated in %.3fms&quot;,
3975                                 _collection_set.optional_region_length(), time_left_ms);
3976       break;
3977     }
3978 
3979     {
3980       Ticks start = Ticks::now();
3981       rem_set()-&gt;merge_heap_roots(false /* initial_evacuation */);
3982       phase_times()-&gt;record_or_add_optional_merge_heap_roots_time((Ticks::now() - start).seconds() * 1000.0);
3983     }
3984 
3985     {
3986       Ticks start = Ticks::now();
3987       evacuate_next_optional_regions(per_thread_states);
3988       phase_times()-&gt;record_or_add_optional_evac_time((Ticks::now() - start).seconds() * 1000.0);
3989     }
3990   }
3991 
3992   _collection_set.abandon_optional_collection_set(per_thread_states);
3993 }
3994 
3995 void G1CollectedHeap::post_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info,
3996                                                    G1RedirtyCardsQueueSet* rdcqs,
3997                                                    G1ParScanThreadStateSet* per_thread_states) {
3998   G1GCPhaseTimes* p = phase_times();
3999 
4000   rem_set()-&gt;cleanup_after_scan_heap_roots();
4001 
4002   // Process any discovered reference objects - we have
4003   // to do this _before_ we retire the GC alloc regions
4004   // as we may have to copy some &#39;reachable&#39; referent
4005   // objects (and their reachable sub-graphs) that were
4006   // not copied during the pause.
4007   process_discovered_references(per_thread_states);
4008 
4009   G1STWIsAliveClosure is_alive(this);
4010   G1KeepAliveClosure keep_alive(this);
4011 
4012   WeakProcessor::weak_oops_do(workers(), &amp;is_alive, &amp;keep_alive, p-&gt;weak_phase_times());
4013 
4014   if (G1StringDedup::is_enabled()) {
4015     double string_dedup_time_ms = os::elapsedTime();
4016 
4017     string_dedup_cleaning(&amp;is_alive, &amp;keep_alive, p);
4018 
4019     double string_cleanup_time_ms = (os::elapsedTime() - string_dedup_time_ms) * 1000.0;
4020     p-&gt;record_string_deduplication_time(string_cleanup_time_ms);
4021   }
4022 
4023   _allocator-&gt;release_gc_alloc_regions(evacuation_info);
4024 
4025   if (evacuation_failed()) {
4026     restore_after_evac_failure(rdcqs);
4027 
4028     // Reset the G1EvacuationFailureALot counters and flags
4029     NOT_PRODUCT(reset_evacuation_should_fail();)
4030 
4031     double recalculate_used_start = os::elapsedTime();
4032     set_used(recalculate_used());
4033     p-&gt;record_evac_fail_recalc_used_time((os::elapsedTime() - recalculate_used_start) * 1000.0);
4034 
4035     if (_archive_allocator != NULL) {
4036       _archive_allocator-&gt;clear_used();
4037     }
4038     for (uint i = 0; i &lt; ParallelGCThreads; i++) {
4039       if (_evacuation_failed_info_array[i].has_failed()) {
4040         _gc_tracer_stw-&gt;report_evacuation_failed(_evacuation_failed_info_array[i]);
4041       }
4042     }
4043   } else {
4044     // The &quot;used&quot; of the the collection set have already been subtracted
4045     // when they were freed.  Add in the bytes used.
4046     increase_used(_bytes_used_during_gc);
4047   }
4048 
4049   _preserved_marks_set.assert_empty();
4050 
4051   merge_per_thread_state_info(per_thread_states);
4052 
4053   // Reset and re-enable the hot card cache.
4054   // Note the counts for the cards in the regions in the
4055   // collection set are reset when the collection set is freed.
4056   _hot_card_cache-&gt;reset_hot_cache();
4057   _hot_card_cache-&gt;set_use_cache(true);
4058 
4059   purge_code_root_memory();
4060 
4061   redirty_logged_cards(rdcqs);
4062 
4063   free_collection_set(&amp;_collection_set, evacuation_info, per_thread_states-&gt;surviving_young_words());
4064 
4065   eagerly_reclaim_humongous_regions();
4066 
4067   record_obj_copy_mem_stats();
4068 
4069   evacuation_info.set_collectionset_used_before(collection_set()-&gt;bytes_used_before());
4070   evacuation_info.set_bytes_used(_bytes_used_during_gc);
4071 
4072 #if COMPILER2_OR_JVMCI
4073   double start = os::elapsedTime();
4074   DerivedPointerTable::update_pointers();
4075   phase_times()-&gt;record_derived_pointer_table_update_time((os::elapsedTime() - start) * 1000.0);
4076 #endif
4077   policy()-&gt;print_age_table();
4078 }
4079 
4080 void G1CollectedHeap::record_obj_copy_mem_stats() {
4081   policy()-&gt;add_bytes_allocated_in_old_since_last_gc(_old_evac_stats.allocated() * HeapWordSize);
4082 
4083   _gc_tracer_stw-&gt;report_evacuation_statistics(create_g1_evac_summary(&amp;_survivor_evac_stats),
4084                                                create_g1_evac_summary(&amp;_old_evac_stats));
4085 }
4086 
4087 void G1CollectedHeap::free_region(HeapRegion* hr, FreeRegionList* free_list) {
4088   assert(!hr-&gt;is_free(), &quot;the region should not be free&quot;);
4089   assert(!hr-&gt;is_empty(), &quot;the region should not be empty&quot;);
4090   assert(_hrm-&gt;is_available(hr-&gt;hrm_index()), &quot;region should be committed&quot;);
4091 
4092   if (G1VerifyBitmaps) {
4093     MemRegion mr(hr-&gt;bottom(), hr-&gt;end());
4094     concurrent_mark()-&gt;clear_range_in_prev_bitmap(mr);
4095   }
4096 
4097   // Clear the card counts for this region.
4098   // Note: we only need to do this if the region is not young
4099   // (since we don&#39;t refine cards in young regions).
4100   if (!hr-&gt;is_young()) {
4101     _hot_card_cache-&gt;reset_card_counts(hr);
4102   }
4103 
4104   // Reset region metadata to allow reuse.
4105   hr-&gt;hr_clear(true /* clear_space */);
4106   _policy-&gt;remset_tracker()-&gt;update_at_free(hr);
4107 
4108   if (free_list != NULL) {
4109     free_list-&gt;add_ordered(hr);
4110   }
4111 }
4112 
4113 void G1CollectedHeap::free_humongous_region(HeapRegion* hr,
4114                                             FreeRegionList* free_list) {
4115   assert(hr-&gt;is_humongous(), &quot;this is only for humongous regions&quot;);
4116   assert(free_list != NULL, &quot;pre-condition&quot;);
4117   hr-&gt;clear_humongous();
4118   free_region(hr, free_list);
4119 }
4120 
4121 void G1CollectedHeap::remove_from_old_sets(const uint old_regions_removed,
4122                                            const uint humongous_regions_removed) {
4123   if (old_regions_removed &gt; 0 || humongous_regions_removed &gt; 0) {
4124     MutexLocker x(OldSets_lock, Mutex::_no_safepoint_check_flag);
4125     _old_set.bulk_remove(old_regions_removed);
4126     _humongous_set.bulk_remove(humongous_regions_removed);
4127   }
4128 
4129 }
4130 
4131 void G1CollectedHeap::prepend_to_freelist(FreeRegionList* list) {
4132   assert(list != NULL, &quot;list can&#39;t be null&quot;);
4133   if (!list-&gt;is_empty()) {
4134     MutexLocker x(FreeList_lock, Mutex::_no_safepoint_check_flag);
4135     _hrm-&gt;insert_list_into_free_list(list);
4136   }
4137 }
4138 
4139 void G1CollectedHeap::decrement_summary_bytes(size_t bytes) {
4140   decrease_used(bytes);
4141 }
4142 
4143 class G1FreeCollectionSetTask : public AbstractGangTask {
4144   // Helper class to keep statistics for the collection set freeing
4145   class FreeCSetStats {
4146     size_t _before_used_bytes;   // Usage in regions successfully evacutate
4147     size_t _after_used_bytes;    // Usage in regions failing evacuation
4148     size_t _bytes_allocated_in_old_since_last_gc; // Size of young regions turned into old
4149     size_t _failure_used_words;  // Live size in failed regions
4150     size_t _failure_waste_words; // Wasted size in failed regions
4151     size_t _rs_length;           // Remembered set size
4152     uint _regions_freed;         // Number of regions freed
4153   public:
4154     FreeCSetStats() :
4155         _before_used_bytes(0),
4156         _after_used_bytes(0),
4157         _bytes_allocated_in_old_since_last_gc(0),
4158         _failure_used_words(0),
4159         _failure_waste_words(0),
4160         _rs_length(0),
4161         _regions_freed(0) { }
4162 
4163     void merge_stats(FreeCSetStats* other) {
4164       assert(other != NULL, &quot;invariant&quot;);
4165       _before_used_bytes += other-&gt;_before_used_bytes;
4166       _after_used_bytes += other-&gt;_after_used_bytes;
4167       _bytes_allocated_in_old_since_last_gc += other-&gt;_bytes_allocated_in_old_since_last_gc;
4168       _failure_used_words += other-&gt;_failure_used_words;
4169       _failure_waste_words += other-&gt;_failure_waste_words;
4170       _rs_length += other-&gt;_rs_length;
4171       _regions_freed += other-&gt;_regions_freed;
4172     }
4173 
4174     void report(G1CollectedHeap* g1h, G1EvacuationInfo* evacuation_info) {
4175       evacuation_info-&gt;set_regions_freed(_regions_freed);
4176       evacuation_info-&gt;increment_collectionset_used_after(_after_used_bytes);
4177 
4178       g1h-&gt;decrement_summary_bytes(_before_used_bytes);
4179       g1h-&gt;alloc_buffer_stats(G1HeapRegionAttr::Old)-&gt;add_failure_used_and_waste(_failure_used_words, _failure_waste_words);
4180 
4181       G1Policy *policy = g1h-&gt;policy();
4182       policy-&gt;add_bytes_allocated_in_old_since_last_gc(_bytes_allocated_in_old_since_last_gc);
4183       policy-&gt;record_rs_length(_rs_length);
4184       policy-&gt;cset_regions_freed();
4185     }
4186 
4187     void account_failed_region(HeapRegion* r) {
4188       size_t used_words = r-&gt;marked_bytes() / HeapWordSize;
4189       _failure_used_words += used_words;
4190       _failure_waste_words += HeapRegion::GrainWords - used_words;
4191       _after_used_bytes += r-&gt;used();
4192 
4193       // When moving a young gen region to old gen, we &quot;allocate&quot; that whole
4194       // region there. This is in addition to any already evacuated objects.
4195       // Notify the policy about that. Old gen regions do not cause an
4196       // additional allocation: both the objects still in the region and the
4197       // ones already moved are accounted for elsewhere.
4198       if (r-&gt;is_young()) {
4199         _bytes_allocated_in_old_since_last_gc += HeapRegion::GrainBytes;
4200       }
4201     }
4202 
4203     void account_evacuated_region(HeapRegion* r) {
4204       _before_used_bytes += r-&gt;used();
4205       _regions_freed += 1;
4206     }
4207 
4208     void account_rs_length(HeapRegion* r) {
4209       _rs_length += r-&gt;rem_set()-&gt;occupied();
4210     }
4211   };
4212 
4213   // Closure applied to all regions in the collection set.
4214   class FreeCSetClosure : public HeapRegionClosure {
4215     // Helper to send JFR events for regions.
4216     class JFREventForRegion {
4217       EventGCPhaseParallel _event;
4218     public:
4219       JFREventForRegion(HeapRegion* region, uint worker_id) : _event() {
4220         _event.set_gcId(GCId::current());
4221         _event.set_gcWorkerId(worker_id);
4222         if (region-&gt;is_young()) {
4223           _event.set_name(G1GCPhaseTimes::phase_name(G1GCPhaseTimes::YoungFreeCSet));
4224         } else {
4225           _event.set_name(G1GCPhaseTimes::phase_name(G1GCPhaseTimes::NonYoungFreeCSet));
4226         }
4227       }
4228 
4229       ~JFREventForRegion() {
4230         _event.commit();
4231       }
4232     };
4233 
4234     // Helper to do timing for region work.
4235     class TimerForRegion {
4236       Tickspan&amp; _time;
4237       Ticks     _start_time;
4238     public:
4239       TimerForRegion(Tickspan&amp; time) : _time(time), _start_time(Ticks::now()) { }
4240       ~TimerForRegion() {
4241         _time += Ticks::now() - _start_time;
4242       }
4243     };
4244 
4245     // FreeCSetClosure members
4246     G1CollectedHeap* _g1h;
4247     const size_t*    _surviving_young_words;
4248     uint             _worker_id;
4249     Tickspan         _young_time;
4250     Tickspan         _non_young_time;
4251     FreeCSetStats*   _stats;
4252 
4253     void assert_in_cset(HeapRegion* r) {
4254       assert(r-&gt;young_index_in_cset() != 0 &amp;&amp;
4255              (uint)r-&gt;young_index_in_cset() &lt;= _g1h-&gt;collection_set()-&gt;young_region_length(),
4256              &quot;Young index %u is wrong for region %u of type %s with %u young regions&quot;,
4257              r-&gt;young_index_in_cset(), r-&gt;hrm_index(), r-&gt;get_type_str(), _g1h-&gt;collection_set()-&gt;young_region_length());
4258     }
4259 
4260     void handle_evacuated_region(HeapRegion* r) {
4261       assert(!r-&gt;is_empty(), &quot;Region %u is an empty region in the collection set.&quot;, r-&gt;hrm_index());
4262       stats()-&gt;account_evacuated_region(r);
4263 
4264       // Free the region and and its remembered set.
4265       _g1h-&gt;free_region(r, NULL);
4266     }
4267 
4268     void handle_failed_region(HeapRegion* r) {
4269       // Do some allocation statistics accounting. Regions that failed evacuation
4270       // are always made old, so there is no need to update anything in the young
4271       // gen statistics, but we need to update old gen statistics.
4272       stats()-&gt;account_failed_region(r);
4273 
4274       // Update the region state due to the failed evacuation.
4275       r-&gt;handle_evacuation_failure();
4276 
4277       // Add region to old set, need to hold lock.
4278       MutexLocker x(OldSets_lock, Mutex::_no_safepoint_check_flag);
4279       _g1h-&gt;old_set_add(r);
4280     }
4281 
4282     Tickspan&amp; timer_for_region(HeapRegion* r) {
4283       return r-&gt;is_young() ? _young_time : _non_young_time;
4284     }
4285 
4286     FreeCSetStats* stats() {
4287       return _stats;
4288     }
4289   public:
4290     FreeCSetClosure(const size_t* surviving_young_words,
4291                     uint worker_id,
4292                     FreeCSetStats* stats) :
4293         HeapRegionClosure(),
4294         _g1h(G1CollectedHeap::heap()),
4295         _surviving_young_words(surviving_young_words),
4296         _worker_id(worker_id),
4297         _young_time(),
4298         _non_young_time(),
4299         _stats(stats) { }
4300 
4301     virtual bool do_heap_region(HeapRegion* r) {
4302       assert(r-&gt;in_collection_set(), &quot;Invariant: %u missing from CSet&quot;, r-&gt;hrm_index());
4303       JFREventForRegion event(r, _worker_id);
4304       TimerForRegion timer(timer_for_region(r));
4305 
4306       _g1h-&gt;clear_region_attr(r);
4307       stats()-&gt;account_rs_length(r);
4308 
4309       if (r-&gt;is_young()) {
4310         assert_in_cset(r);
4311         r-&gt;record_surv_words_in_group(_surviving_young_words[r-&gt;young_index_in_cset()]);
4312       }
4313 
4314       if (r-&gt;evacuation_failed()) {
4315         handle_failed_region(r);
4316       } else {
4317         handle_evacuated_region(r);
4318       }
4319       assert(!_g1h-&gt;is_on_master_free_list(r), &quot;sanity&quot;);
4320 
4321       return false;
4322     }
4323 
4324     void report_timing(Tickspan parallel_time) {
4325       G1GCPhaseTimes* pt = _g1h-&gt;phase_times();
4326       pt-&gt;record_time_secs(G1GCPhaseTimes::ParFreeCSet, _worker_id, parallel_time.seconds());
4327       if (_young_time.value() &gt; 0) {
4328         pt-&gt;record_time_secs(G1GCPhaseTimes::YoungFreeCSet, _worker_id, _young_time.seconds());
4329       }
4330       if (_non_young_time.value() &gt; 0) {
4331         pt-&gt;record_time_secs(G1GCPhaseTimes::NonYoungFreeCSet, _worker_id, _non_young_time.seconds());
4332       }
4333     }
4334   };
4335 
4336   // G1FreeCollectionSetTask members
4337   G1CollectedHeap*  _g1h;
4338   G1EvacuationInfo* _evacuation_info;
4339   FreeCSetStats*    _worker_stats;
4340   HeapRegionClaimer _claimer;
4341   const size_t*     _surviving_young_words;
4342   uint              _active_workers;
4343 
4344   FreeCSetStats* worker_stats(uint worker) {
4345     return &amp;_worker_stats[worker];
4346   }
4347 
4348   void report_statistics() {
4349     // Merge the accounting
4350     FreeCSetStats total_stats;
4351     for (uint worker = 0; worker &lt; _active_workers; worker++) {
4352       total_stats.merge_stats(worker_stats(worker));
4353     }
4354     total_stats.report(_g1h, _evacuation_info);
4355   }
4356 
4357 public:
4358   G1FreeCollectionSetTask(G1EvacuationInfo* evacuation_info, const size_t* surviving_young_words, uint active_workers) :
4359       AbstractGangTask(&quot;G1 Free Collection Set&quot;),
4360       _g1h(G1CollectedHeap::heap()),
4361       _evacuation_info(evacuation_info),
4362       _worker_stats(NEW_C_HEAP_ARRAY(FreeCSetStats, active_workers, mtGC)),
4363       _claimer(active_workers),
4364       _surviving_young_words(surviving_young_words),
4365       _active_workers(active_workers) {
4366     for (uint worker = 0; worker &lt; active_workers; worker++) {
4367       ::new (&amp;_worker_stats[worker]) FreeCSetStats();
4368     }
4369   }
4370 
4371   ~G1FreeCollectionSetTask() {
4372     Ticks serial_time = Ticks::now();
4373     report_statistics();
4374     for (uint worker = 0; worker &lt; _active_workers; worker++) {
4375       _worker_stats[worker].~FreeCSetStats();
4376     }
4377     FREE_C_HEAP_ARRAY(FreeCSetStats, _worker_stats);
4378     _g1h-&gt;phase_times()-&gt;record_serial_free_cset_time_ms((Ticks::now() - serial_time).seconds() * 1000.0);
4379   }
4380 
4381   virtual void work(uint worker_id) {
4382     EventGCPhaseParallel event;
4383     Ticks start = Ticks::now();
4384     FreeCSetClosure cl(_surviving_young_words, worker_id, worker_stats(worker_id));
4385     _g1h-&gt;collection_set_par_iterate_all(&amp;cl, &amp;_claimer, worker_id);
4386 
4387     // Report the total parallel time along with some more detailed metrics.
4388     cl.report_timing(Ticks::now() - start);
4389     event.commit(GCId::current(), worker_id, G1GCPhaseTimes::phase_name(G1GCPhaseTimes::ParFreeCSet));
4390   }
4391 };
4392 
4393 void G1CollectedHeap::free_collection_set(G1CollectionSet* collection_set, G1EvacuationInfo&amp; evacuation_info, const size_t* surviving_young_words) {
4394   _eden.clear();
4395 
4396   // The free collections set is split up in two tasks, the first
4397   // frees the collection set and records what regions are free,
4398   // and the second one rebuilds the free list. This proved to be
4399   // more efficient than adding a sorted list to another.
4400 
4401   Ticks free_cset_start_time = Ticks::now();
4402   {
4403     uint const num_cs_regions = _collection_set.region_length();
4404     uint const num_workers = clamp(num_cs_regions, 1u, workers()-&gt;active_workers());
4405     G1FreeCollectionSetTask cl(&amp;evacuation_info, surviving_young_words, num_workers);
4406 
4407     log_debug(gc, ergo)(&quot;Running %s using %u workers for collection set length %u (%u)&quot;,
4408                         cl.name(), num_workers, num_cs_regions, num_regions());
4409     workers()-&gt;run_task(&amp;cl, num_workers);
4410   }
4411 
4412   Ticks free_cset_end_time = Ticks::now();
4413   phase_times()-&gt;record_total_free_cset_time_ms((free_cset_end_time - free_cset_start_time).seconds() * 1000.0);
4414 
4415   // Now rebuild the free region list.
4416   hrm()-&gt;rebuild_free_list(workers());
4417   phase_times()-&gt;record_total_rebuild_freelist_time_ms((Ticks::now() - free_cset_end_time).seconds() * 1000.0);
4418 
4419   collection_set-&gt;clear();
4420 }
4421 
4422 class G1FreeHumongousRegionClosure : public HeapRegionClosure {
4423  private:
4424   FreeRegionList* _free_region_list;
4425   HeapRegionSet* _proxy_set;
4426   uint _humongous_objects_reclaimed;
4427   uint _humongous_regions_reclaimed;
4428   size_t _freed_bytes;
4429  public:
4430 
4431   G1FreeHumongousRegionClosure(FreeRegionList* free_region_list) :
4432     _free_region_list(free_region_list), _proxy_set(NULL), _humongous_objects_reclaimed(0), _humongous_regions_reclaimed(0), _freed_bytes(0) {
4433   }
4434 
4435   virtual bool do_heap_region(HeapRegion* r) {
4436     if (!r-&gt;is_starts_humongous()) {
4437       return false;
4438     }
4439 
4440     G1CollectedHeap* g1h = G1CollectedHeap::heap();
4441 
4442     oop obj = (oop)r-&gt;bottom();
4443     G1CMBitMap* next_bitmap = g1h-&gt;concurrent_mark()-&gt;next_mark_bitmap();
4444 
4445     // The following checks whether the humongous object is live are sufficient.
4446     // The main additional check (in addition to having a reference from the roots
4447     // or the young gen) is whether the humongous object has a remembered set entry.
4448     //
4449     // A humongous object cannot be live if there is no remembered set for it
4450     // because:
4451     // - there can be no references from within humongous starts regions referencing
4452     // the object because we never allocate other objects into them.
4453     // (I.e. there are no intra-region references that may be missed by the
4454     // remembered set)
4455     // - as soon there is a remembered set entry to the humongous starts region
4456     // (i.e. it has &quot;escaped&quot; to an old object) this remembered set entry will stay
4457     // until the end of a concurrent mark.
4458     //
4459     // It is not required to check whether the object has been found dead by marking
4460     // or not, in fact it would prevent reclamation within a concurrent cycle, as
4461     // all objects allocated during that time are considered live.
4462     // SATB marking is even more conservative than the remembered set.
4463     // So if at this point in the collection there is no remembered set entry,
4464     // nobody has a reference to it.
4465     // At the start of collection we flush all refinement logs, and remembered sets
4466     // are completely up-to-date wrt to references to the humongous object.
4467     //
4468     // Other implementation considerations:
4469     // - never consider object arrays at this time because they would pose
4470     // considerable effort for cleaning up the the remembered sets. This is
4471     // required because stale remembered sets might reference locations that
4472     // are currently allocated into.
4473     uint region_idx = r-&gt;hrm_index();
4474     if (!g1h-&gt;is_humongous_reclaim_candidate(region_idx) ||
4475         !r-&gt;rem_set()-&gt;is_empty()) {
4476       log_debug(gc, humongous)(&quot;Live humongous region %u object size &quot; SIZE_FORMAT &quot; start &quot; PTR_FORMAT &quot;  with remset &quot; SIZE_FORMAT &quot; code roots &quot; SIZE_FORMAT &quot; is marked %d reclaim candidate %d type array %d&quot;,
4477                                region_idx,
4478                                (size_t)obj-&gt;size() * HeapWordSize,
4479                                p2i(r-&gt;bottom()),
4480                                r-&gt;rem_set()-&gt;occupied(),
4481                                r-&gt;rem_set()-&gt;strong_code_roots_list_length(),
4482                                next_bitmap-&gt;is_marked(r-&gt;bottom()),
4483                                g1h-&gt;is_humongous_reclaim_candidate(region_idx),
4484                                obj-&gt;is_typeArray()
4485                               );
4486       return false;
4487     }
4488 
4489     guarantee(obj-&gt;is_typeArray(),
4490               &quot;Only eagerly reclaiming type arrays is supported, but the object &quot;
4491               PTR_FORMAT &quot; is not.&quot;, p2i(r-&gt;bottom()));
4492 
4493     log_debug(gc, humongous)(&quot;Dead humongous region %u object size &quot; SIZE_FORMAT &quot; start &quot; PTR_FORMAT &quot; with remset &quot; SIZE_FORMAT &quot; code roots &quot; SIZE_FORMAT &quot; is marked %d reclaim candidate %d type array %d&quot;,
4494                              region_idx,
4495                              (size_t)obj-&gt;size() * HeapWordSize,
4496                              p2i(r-&gt;bottom()),
4497                              r-&gt;rem_set()-&gt;occupied(),
4498                              r-&gt;rem_set()-&gt;strong_code_roots_list_length(),
4499                              next_bitmap-&gt;is_marked(r-&gt;bottom()),
4500                              g1h-&gt;is_humongous_reclaim_candidate(region_idx),
4501                              obj-&gt;is_typeArray()
4502                             );
4503 
4504     G1ConcurrentMark* const cm = g1h-&gt;concurrent_mark();
4505     cm-&gt;humongous_object_eagerly_reclaimed(r);
4506     assert(!cm-&gt;is_marked_in_prev_bitmap(obj) &amp;&amp; !cm-&gt;is_marked_in_next_bitmap(obj),
4507            &quot;Eagerly reclaimed humongous region %u should not be marked at all but is in prev %s next %s&quot;,
4508            region_idx,
4509            BOOL_TO_STR(cm-&gt;is_marked_in_prev_bitmap(obj)),
4510            BOOL_TO_STR(cm-&gt;is_marked_in_next_bitmap(obj)));
4511     _humongous_objects_reclaimed++;
4512     do {
4513       HeapRegion* next = g1h-&gt;next_region_in_humongous(r);
4514       _freed_bytes += r-&gt;used();
4515       r-&gt;set_containing_set(NULL);
4516       _humongous_regions_reclaimed++;
4517       g1h-&gt;free_humongous_region(r, _free_region_list);
4518       r = next;
4519     } while (r != NULL);
4520 
4521     return false;
4522   }
4523 
4524   uint humongous_objects_reclaimed() {
4525     return _humongous_objects_reclaimed;
4526   }
4527 
4528   uint humongous_regions_reclaimed() {
4529     return _humongous_regions_reclaimed;
4530   }
4531 
4532   size_t bytes_freed() const {
4533     return _freed_bytes;
4534   }
4535 };
4536 
4537 void G1CollectedHeap::eagerly_reclaim_humongous_regions() {
4538   assert_at_safepoint_on_vm_thread();
4539 
4540   if (!G1EagerReclaimHumongousObjects ||
4541       (!_has_humongous_reclaim_candidates &amp;&amp; !log_is_enabled(Debug, gc, humongous))) {
4542     phase_times()-&gt;record_fast_reclaim_humongous_time_ms(0.0, 0);
4543     return;
4544   }
4545 
4546   double start_time = os::elapsedTime();
4547 
4548   FreeRegionList local_cleanup_list(&quot;Local Humongous Cleanup List&quot;);
4549 
4550   G1FreeHumongousRegionClosure cl(&amp;local_cleanup_list);
4551   heap_region_iterate(&amp;cl);
4552 
4553   remove_from_old_sets(0, cl.humongous_regions_reclaimed());
4554 
4555   G1HRPrinter* hrp = hr_printer();
4556   if (hrp-&gt;is_active()) {
4557     FreeRegionListIterator iter(&amp;local_cleanup_list);
4558     while (iter.more_available()) {
4559       HeapRegion* hr = iter.get_next();
4560       hrp-&gt;cleanup(hr);
4561     }
4562   }
4563 
4564   prepend_to_freelist(&amp;local_cleanup_list);
4565   decrement_summary_bytes(cl.bytes_freed());
4566 
4567   phase_times()-&gt;record_fast_reclaim_humongous_time_ms((os::elapsedTime() - start_time) * 1000.0,
4568                                                        cl.humongous_objects_reclaimed());
4569 }
4570 
4571 class G1AbandonCollectionSetClosure : public HeapRegionClosure {
4572 public:
4573   virtual bool do_heap_region(HeapRegion* r) {
4574     assert(r-&gt;in_collection_set(), &quot;Region %u must have been in collection set&quot;, r-&gt;hrm_index());
4575     G1CollectedHeap::heap()-&gt;clear_region_attr(r);
4576     r-&gt;clear_young_index_in_cset();
4577     return false;
4578   }
4579 };
4580 
4581 void G1CollectedHeap::abandon_collection_set(G1CollectionSet* collection_set) {
4582   G1AbandonCollectionSetClosure cl;
4583   collection_set_iterate_all(&amp;cl);
4584 
4585   collection_set-&gt;clear();
4586   collection_set-&gt;stop_incremental_building();
4587 }
4588 
4589 bool G1CollectedHeap::is_old_gc_alloc_region(HeapRegion* hr) {
4590   return _allocator-&gt;is_retained_old_region(hr);
4591 }
4592 
4593 void G1CollectedHeap::set_region_short_lived_locked(HeapRegion* hr) {
4594   _eden.add(hr);
4595   _policy-&gt;set_region_eden(hr);
4596 }
4597 
4598 #ifdef ASSERT
4599 
4600 class NoYoungRegionsClosure: public HeapRegionClosure {
4601 private:
4602   bool _success;
4603 public:
4604   NoYoungRegionsClosure() : _success(true) { }
4605   bool do_heap_region(HeapRegion* r) {
4606     if (r-&gt;is_young()) {
4607       log_error(gc, verify)(&quot;Region [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;) tagged as young&quot;,
4608                             p2i(r-&gt;bottom()), p2i(r-&gt;end()));
4609       _success = false;
4610     }
4611     return false;
4612   }
4613   bool success() { return _success; }
4614 };
4615 
4616 bool G1CollectedHeap::check_young_list_empty() {
4617   bool ret = (young_regions_count() == 0);
4618 
4619   NoYoungRegionsClosure closure;
4620   heap_region_iterate(&amp;closure);
4621   ret = ret &amp;&amp; closure.success();
4622 
4623   return ret;
4624 }
4625 
4626 #endif // ASSERT
4627 
4628 class TearDownRegionSetsClosure : public HeapRegionClosure {
4629   HeapRegionSet *_old_set;
4630 
4631 public:
4632   TearDownRegionSetsClosure(HeapRegionSet* old_set) : _old_set(old_set) { }
4633 
4634   bool do_heap_region(HeapRegion* r) {
4635     if (r-&gt;is_old()) {
4636       _old_set-&gt;remove(r);
4637     } else if(r-&gt;is_young()) {
4638       r-&gt;uninstall_surv_rate_group();
4639     } else {
4640       // We ignore free regions, we&#39;ll empty the free list afterwards.
4641       // We ignore humongous and archive regions, we&#39;re not tearing down these
4642       // sets.
4643       assert(r-&gt;is_archive() || r-&gt;is_free() || r-&gt;is_humongous(),
4644              &quot;it cannot be another type&quot;);
4645     }
4646     return false;
4647   }
4648 
4649   ~TearDownRegionSetsClosure() {
4650     assert(_old_set-&gt;is_empty(), &quot;post-condition&quot;);
4651   }
4652 };
4653 
4654 void G1CollectedHeap::tear_down_region_sets(bool free_list_only) {
4655   assert_at_safepoint_on_vm_thread();
4656 
4657   if (!free_list_only) {
4658     TearDownRegionSetsClosure cl(&amp;_old_set);
4659     heap_region_iterate(&amp;cl);
4660 
4661     // Note that emptying the _young_list is postponed and instead done as
4662     // the first step when rebuilding the regions sets again. The reason for
4663     // this is that during a full GC string deduplication needs to know if
4664     // a collected region was young or old when the full GC was initiated.
4665   }
4666   _hrm-&gt;remove_all_free_regions();
4667 }
4668 
4669 void G1CollectedHeap::increase_used(size_t bytes) {
4670   _summary_bytes_used += bytes;
4671 }
4672 
4673 void G1CollectedHeap::decrease_used(size_t bytes) {
4674   assert(_summary_bytes_used &gt;= bytes,
4675          &quot;invariant: _summary_bytes_used: &quot; SIZE_FORMAT &quot; should be &gt;= bytes: &quot; SIZE_FORMAT,
4676          _summary_bytes_used, bytes);
4677   _summary_bytes_used -= bytes;
4678 }
4679 
4680 void G1CollectedHeap::set_used(size_t bytes) {
4681   _summary_bytes_used = bytes;
4682 }
4683 
4684 class RebuildRegionSetsClosure : public HeapRegionClosure {
4685 private:
4686   bool _free_list_only;
4687 
4688   HeapRegionSet* _old_set;
4689   HeapRegionManager* _hrm;
4690 
4691   size_t _total_used;
4692 
4693 public:
4694   RebuildRegionSetsClosure(bool free_list_only,
4695                            HeapRegionSet* old_set,
4696                            HeapRegionManager* hrm) :
4697     _free_list_only(free_list_only),
4698     _old_set(old_set), _hrm(hrm), _total_used(0) {
4699     assert(_hrm-&gt;num_free_regions() == 0, &quot;pre-condition&quot;);
4700     if (!free_list_only) {
4701       assert(_old_set-&gt;is_empty(), &quot;pre-condition&quot;);
4702     }
4703   }
4704 
4705   bool do_heap_region(HeapRegion* r) {
4706     if (r-&gt;is_empty()) {
4707       assert(r-&gt;rem_set()-&gt;is_empty(), &quot;Empty regions should have empty remembered sets.&quot;);
4708       // Add free regions to the free list
4709       r-&gt;set_free();
4710       _hrm-&gt;insert_into_free_list(r);
4711     } else if (!_free_list_only) {
4712       assert(r-&gt;rem_set()-&gt;is_empty(), &quot;At this point remembered sets must have been cleared.&quot;);
4713 
4714       if (r-&gt;is_archive() || r-&gt;is_humongous()) {
4715         // We ignore archive and humongous regions. We left these sets unchanged.
4716       } else {
4717         assert(r-&gt;is_young() || r-&gt;is_free() || r-&gt;is_old(), &quot;invariant&quot;);
4718         // We now move all (non-humongous, non-old, non-archive) regions to old gen, and register them as such.
4719         r-&gt;move_to_old();
4720         _old_set-&gt;add(r);
4721       }
4722       _total_used += r-&gt;used();
4723     }
4724 
4725     return false;
4726   }
4727 
4728   size_t total_used() {
4729     return _total_used;
4730   }
4731 };
4732 
4733 void G1CollectedHeap::rebuild_region_sets(bool free_list_only) {
4734   assert_at_safepoint_on_vm_thread();
4735 
4736   if (!free_list_only) {
4737     _eden.clear();
4738     _survivor.clear();
4739   }
4740 
4741   RebuildRegionSetsClosure cl(free_list_only, &amp;_old_set, _hrm);
4742   heap_region_iterate(&amp;cl);
4743 
4744   if (!free_list_only) {
4745     set_used(cl.total_used());
4746     if (_archive_allocator != NULL) {
4747       _archive_allocator-&gt;clear_used();
4748     }
4749   }
4750   assert_used_and_recalculate_used_equal(this);
4751 }
4752 
4753 // Methods for the mutator alloc region
4754 
4755 HeapRegion* G1CollectedHeap::new_mutator_alloc_region(size_t word_size,
4756                                                       bool force,
4757                                                       uint node_index) {
4758   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
4759   bool should_allocate = policy()-&gt;should_allocate_mutator_region();
4760   if (force || should_allocate) {
4761     HeapRegion* new_alloc_region = new_region(word_size,
4762                                               HeapRegionType::Eden,
4763                                               false /* do_expand */,
4764                                               node_index);
4765     if (new_alloc_region != NULL) {
4766       set_region_short_lived_locked(new_alloc_region);
4767       _hr_printer.alloc(new_alloc_region, !should_allocate);
4768       _verifier-&gt;check_bitmaps(&quot;Mutator Region Allocation&quot;, new_alloc_region);
4769       _policy-&gt;remset_tracker()-&gt;update_at_allocate(new_alloc_region);
4770       return new_alloc_region;
4771     }
4772   }
4773   return NULL;
4774 }
4775 
4776 void G1CollectedHeap::retire_mutator_alloc_region(HeapRegion* alloc_region,
4777                                                   size_t allocated_bytes) {
4778   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
4779   assert(alloc_region-&gt;is_eden(), &quot;all mutator alloc regions should be eden&quot;);
4780 
4781   collection_set()-&gt;add_eden_region(alloc_region);
4782   increase_used(allocated_bytes);
4783   _eden.add_used_bytes(allocated_bytes);
4784   _hr_printer.retire(alloc_region);
4785 
4786   // We update the eden sizes here, when the region is retired,
4787   // instead of when it&#39;s allocated, since this is the point that its
4788   // used space has been recorded in _summary_bytes_used.
4789   g1mm()-&gt;update_eden_size();
4790 }
4791 
4792 // Methods for the GC alloc regions
4793 
4794 bool G1CollectedHeap::has_more_regions(G1HeapRegionAttr dest) {
4795   if (dest.is_old()) {
4796     return true;
4797   } else {
4798     return survivor_regions_count() &lt; policy()-&gt;max_survivor_regions();
4799   }
4800 }
4801 
4802 HeapRegion* G1CollectedHeap::new_gc_alloc_region(size_t word_size, G1HeapRegionAttr dest, uint node_index) {
4803   assert(FreeList_lock-&gt;owned_by_self(), &quot;pre-condition&quot;);
4804 
4805   if (!has_more_regions(dest)) {
4806     return NULL;
4807   }
4808 
4809   HeapRegionType type;
4810   if (dest.is_young()) {
4811     type = HeapRegionType::Survivor;
4812   } else {
4813     type = HeapRegionType::Old;
4814   }
4815 
4816   HeapRegion* new_alloc_region = new_region(word_size,
4817                                             type,
4818                                             true /* do_expand */,
4819                                             node_index);
4820 
4821   if (new_alloc_region != NULL) {
4822     if (type.is_survivor()) {
4823       new_alloc_region-&gt;set_survivor();
4824       _survivor.add(new_alloc_region);
4825       _verifier-&gt;check_bitmaps(&quot;Survivor Region Allocation&quot;, new_alloc_region);
4826     } else {
4827       new_alloc_region-&gt;set_old();
4828       _verifier-&gt;check_bitmaps(&quot;Old Region Allocation&quot;, new_alloc_region);
4829     }
4830     _policy-&gt;remset_tracker()-&gt;update_at_allocate(new_alloc_region);
4831     register_region_with_region_attr(new_alloc_region);
4832     _hr_printer.alloc(new_alloc_region);
4833     return new_alloc_region;
4834   }
4835   return NULL;
4836 }
4837 
4838 void G1CollectedHeap::retire_gc_alloc_region(HeapRegion* alloc_region,
4839                                              size_t allocated_bytes,
4840                                              G1HeapRegionAttr dest) {
4841   _bytes_used_during_gc += allocated_bytes;
4842   if (dest.is_old()) {
4843     old_set_add(alloc_region);
4844   } else {
4845     assert(dest.is_young(), &quot;Retiring alloc region should be young (%d)&quot;, dest.type());
4846     _survivor.add_used_bytes(allocated_bytes);
4847   }
4848 
4849   bool const during_im = collector_state()-&gt;in_initial_mark_gc();
4850   if (during_im &amp;&amp; allocated_bytes &gt; 0) {
4851     _cm-&gt;root_regions()-&gt;add(alloc_region-&gt;next_top_at_mark_start(), alloc_region-&gt;top());
4852   }
4853   _hr_printer.retire(alloc_region);
4854 }
4855 
4856 HeapRegion* G1CollectedHeap::alloc_highest_free_region() {
4857   bool expanded = false;
4858   uint index = _hrm-&gt;find_highest_free(&amp;expanded);
4859 
4860   if (index != G1_NO_HRM_INDEX) {
4861     if (expanded) {
4862       log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (requested address range outside heap bounds). region size: &quot; SIZE_FORMAT &quot;B&quot;,
4863                                 HeapRegion::GrainWords * HeapWordSize);
4864     }
<a name="25" id="anc25"></a><span class="line-modified">4865     return _hrm-&gt;allocate_free_regions_starting_at(index, 1);</span>

4866   }
4867   return NULL;
4868 }
4869 
4870 // Optimized nmethod scanning
4871 
4872 class RegisterNMethodOopClosure: public OopClosure {
4873   G1CollectedHeap* _g1h;
4874   nmethod* _nm;
4875 
4876   template &lt;class T&gt; void do_oop_work(T* p) {
4877     T heap_oop = RawAccess&lt;&gt;::oop_load(p);
4878     if (!CompressedOops::is_null(heap_oop)) {
4879       oop obj = CompressedOops::decode_not_null(heap_oop);
4880       HeapRegion* hr = _g1h-&gt;heap_region_containing(obj);
4881       assert(!hr-&gt;is_continues_humongous(),
4882              &quot;trying to add code root &quot; PTR_FORMAT &quot; in continuation of humongous region &quot; HR_FORMAT
4883              &quot; starting at &quot; HR_FORMAT,
4884              p2i(_nm), HR_FORMAT_PARAMS(hr), HR_FORMAT_PARAMS(hr-&gt;humongous_start_region()));
4885 
4886       // HeapRegion::add_strong_code_root_locked() avoids adding duplicate entries.
4887       hr-&gt;add_strong_code_root_locked(_nm);
4888     }
4889   }
4890 
4891 public:
4892   RegisterNMethodOopClosure(G1CollectedHeap* g1h, nmethod* nm) :
4893     _g1h(g1h), _nm(nm) {}
4894 
4895   void do_oop(oop* p)       { do_oop_work(p); }
4896   void do_oop(narrowOop* p) { do_oop_work(p); }
4897 };
4898 
4899 class UnregisterNMethodOopClosure: public OopClosure {
4900   G1CollectedHeap* _g1h;
4901   nmethod* _nm;
4902 
4903   template &lt;class T&gt; void do_oop_work(T* p) {
4904     T heap_oop = RawAccess&lt;&gt;::oop_load(p);
4905     if (!CompressedOops::is_null(heap_oop)) {
4906       oop obj = CompressedOops::decode_not_null(heap_oop);
4907       HeapRegion* hr = _g1h-&gt;heap_region_containing(obj);
4908       assert(!hr-&gt;is_continues_humongous(),
4909              &quot;trying to remove code root &quot; PTR_FORMAT &quot; in continuation of humongous region &quot; HR_FORMAT
4910              &quot; starting at &quot; HR_FORMAT,
4911              p2i(_nm), HR_FORMAT_PARAMS(hr), HR_FORMAT_PARAMS(hr-&gt;humongous_start_region()));
4912 
4913       hr-&gt;remove_strong_code_root(_nm);
4914     }
4915   }
4916 
4917 public:
4918   UnregisterNMethodOopClosure(G1CollectedHeap* g1h, nmethod* nm) :
4919     _g1h(g1h), _nm(nm) {}
4920 
4921   void do_oop(oop* p)       { do_oop_work(p); }
4922   void do_oop(narrowOop* p) { do_oop_work(p); }
4923 };
4924 
4925 void G1CollectedHeap::register_nmethod(nmethod* nm) {
4926   guarantee(nm != NULL, &quot;sanity&quot;);
4927   RegisterNMethodOopClosure reg_cl(this, nm);
4928   nm-&gt;oops_do(&amp;reg_cl);
4929 }
4930 
4931 void G1CollectedHeap::unregister_nmethod(nmethod* nm) {
4932   guarantee(nm != NULL, &quot;sanity&quot;);
4933   UnregisterNMethodOopClosure reg_cl(this, nm);
4934   nm-&gt;oops_do(&amp;reg_cl, true);
4935 }
4936 
4937 void G1CollectedHeap::purge_code_root_memory() {
4938   double purge_start = os::elapsedTime();
4939   G1CodeRootSet::purge();
4940   double purge_time_ms = (os::elapsedTime() - purge_start) * 1000.0;
4941   phase_times()-&gt;record_strong_code_root_purge_time(purge_time_ms);
4942 }
4943 
4944 class RebuildStrongCodeRootClosure: public CodeBlobClosure {
4945   G1CollectedHeap* _g1h;
4946 
4947 public:
4948   RebuildStrongCodeRootClosure(G1CollectedHeap* g1h) :
4949     _g1h(g1h) {}
4950 
4951   void do_code_blob(CodeBlob* cb) {
4952     nmethod* nm = (cb != NULL) ? cb-&gt;as_nmethod_or_null() : NULL;
4953     if (nm == NULL) {
4954       return;
4955     }
4956 
4957     _g1h-&gt;register_nmethod(nm);
4958   }
4959 };
4960 
4961 void G1CollectedHeap::rebuild_strong_code_roots() {
4962   RebuildStrongCodeRootClosure blob_cl(this);
4963   CodeCache::blobs_do(&amp;blob_cl);
4964 }
4965 
4966 void G1CollectedHeap::initialize_serviceability() {
4967   _g1mm-&gt;initialize_serviceability();
4968 }
4969 
4970 MemoryUsage G1CollectedHeap::memory_usage() {
4971   return _g1mm-&gt;memory_usage();
4972 }
4973 
4974 GrowableArray&lt;GCMemoryManager*&gt; G1CollectedHeap::memory_managers() {
4975   return _g1mm-&gt;memory_managers();
4976 }
4977 
4978 GrowableArray&lt;MemoryPool*&gt; G1CollectedHeap::memory_pools() {
4979   return _g1mm-&gt;memory_pools();
4980 }
<a name="26" id="anc26"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="26" type="hidden" />
</body>
</html>