<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/jvmci/jvmciCompilerToVM.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="jvmciCodeInstaller.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmciCompilerToVMInit.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jvmci/jvmciCompilerToVM.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 #include &quot;precompiled.hpp&quot;
  25 #include &quot;classfile/classLoaderData.inline.hpp&quot;
  26 #include &quot;classfile/javaClasses.inline.hpp&quot;
  27 #include &quot;classfile/stringTable.hpp&quot;
  28 #include &quot;classfile/symbolTable.hpp&quot;
  29 #include &quot;code/scopeDesc.hpp&quot;
  30 #include &quot;compiler/compileBroker.hpp&quot;

  31 #include &quot;compiler/disassembler.hpp&quot;
  32 #include &quot;interpreter/linkResolver.hpp&quot;
  33 #include &quot;interpreter/bytecodeStream.hpp&quot;
  34 #include &quot;jvmci/jvmciCompilerToVM.hpp&quot;
  35 #include &quot;jvmci/jvmciCodeInstaller.hpp&quot;
  36 #include &quot;jvmci/jvmciRuntime.hpp&quot;
  37 #include &quot;logging/log.hpp&quot;
  38 #include &quot;logging/logTag.hpp&quot;
  39 #include &quot;memory/oopFactory.hpp&quot;
  40 #include &quot;memory/universe.hpp&quot;
  41 #include &quot;oops/constantPool.inline.hpp&quot;
  42 #include &quot;oops/method.inline.hpp&quot;
  43 #include &quot;oops/typeArrayOop.inline.hpp&quot;
  44 #include &quot;prims/nativeLookup.hpp&quot;
  45 #include &quot;runtime/atomic.hpp&quot;
  46 #include &quot;runtime/deoptimization.hpp&quot;
  47 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  48 #include &quot;runtime/frame.inline.hpp&quot;
  49 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  50 #include &quot;runtime/jniHandles.inline.hpp&quot;
</pre>
<hr />
<pre>
2611 C2V_VMENTRY_0(jboolean, addFailedSpeculation, (JNIEnv* env, jobject, jlong failed_speculations_address, jbyteArray speculation_obj))
2612   JVMCIPrimitiveArray speculation_handle = JVMCIENV-&gt;wrap(speculation_obj);
2613   int speculation_len = JVMCIENV-&gt;get_length(speculation_handle);
2614   char* speculation = NEW_RESOURCE_ARRAY(char, speculation_len);
2615   JVMCIENV-&gt;copy_bytes_to(speculation_handle, (jbyte*) speculation, 0, speculation_len);
2616   return FailedSpeculation::add_failed_speculation(NULL, (FailedSpeculation**)(address) failed_speculations_address, (address) speculation, speculation_len);
2617 }
2618 
2619 C2V_VMENTRY(void, callSystemExit, (JNIEnv* env, jobject, jint status))
2620   JavaValue result(T_VOID);
2621   JavaCallArguments jargs(1);
2622   jargs.push_int(status);
2623   JavaCalls::call_static(&amp;result,
2624                        SystemDictionary::System_klass(),
2625                        vmSymbols::exit_method_name(),
2626                        vmSymbols::int_void_signature(),
2627                        &amp;jargs,
2628                        CHECK);
2629 }
2630 







































2631 #define CC (char*)  /*cast a literal from (const char*)*/
2632 #define FN_PTR(f) CAST_FROM_FN_PTR(void*, &amp;(c2v_ ## f))
2633 
2634 #define STRING                  &quot;Ljava/lang/String;&quot;
2635 #define OBJECT                  &quot;Ljava/lang/Object;&quot;
2636 #define CLASS                   &quot;Ljava/lang/Class;&quot;
2637 #define OBJECTCONSTANT          &quot;Ljdk/vm/ci/hotspot/HotSpotObjectConstantImpl;&quot;
2638 #define HANDLECONSTANT          &quot;Ljdk/vm/ci/hotspot/IndirectHotSpotObjectConstantImpl;&quot;
2639 #define EXECUTABLE              &quot;Ljava/lang/reflect/Executable;&quot;
2640 #define STACK_TRACE_ELEMENT     &quot;Ljava/lang/StackTraceElement;&quot;
2641 #define INSTALLED_CODE          &quot;Ljdk/vm/ci/code/InstalledCode;&quot;
2642 #define TARGET_DESCRIPTION      &quot;Ljdk/vm/ci/code/TargetDescription;&quot;
2643 #define BYTECODE_FRAME          &quot;Ljdk/vm/ci/code/BytecodeFrame;&quot;
2644 #define JAVACONSTANT            &quot;Ljdk/vm/ci/meta/JavaConstant;&quot;
2645 #define INSPECTED_FRAME_VISITOR &quot;Ljdk/vm/ci/code/stack/InspectedFrameVisitor;&quot;
2646 #define RESOLVED_METHOD         &quot;Ljdk/vm/ci/meta/ResolvedJavaMethod;&quot;
2647 #define HS_RESOLVED_METHOD      &quot;Ljdk/vm/ci/hotspot/HotSpotResolvedJavaMethodImpl;&quot;
2648 #define HS_RESOLVED_KLASS       &quot;Ljdk/vm/ci/hotspot/HotSpotResolvedObjectTypeImpl;&quot;
2649 #define HS_RESOLVED_TYPE        &quot;Ljdk/vm/ci/hotspot/HotSpotResolvedJavaType;&quot;
2650 #define HS_RESOLVED_FIELD       &quot;Ljdk/vm/ci/hotspot/HotSpotResolvedJavaField;&quot;
</pre>
<hr />
<pre>
2758   {CC &quot;getInt&quot;,                                       CC &quot;(&quot; OBJECTCONSTANT &quot;J)I&quot;,                                                          FN_PTR(getInt)},
2759   {CC &quot;getLong&quot;,                                      CC &quot;(&quot; OBJECTCONSTANT &quot;J)J&quot;,                                                          FN_PTR(getLong)},
2760   {CC &quot;getObject&quot;,                                    CC &quot;(&quot; OBJECTCONSTANT &quot;J)&quot; OBJECTCONSTANT,                                            FN_PTR(getObject)},
2761   {CC &quot;deleteGlobalHandle&quot;,                           CC &quot;(J)V&quot;,                                                                            FN_PTR(deleteGlobalHandle)},
2762   {CC &quot;registerNativeMethods&quot;,                        CC &quot;(&quot; CLASS &quot;)[J&quot;,                                                                   FN_PTR(registerNativeMethods)},
2763   {CC &quot;isCurrentThreadAttached&quot;,                      CC &quot;()Z&quot;,                                                                             FN_PTR(isCurrentThreadAttached)},
2764   {CC &quot;getCurrentJavaThread&quot;,                         CC &quot;()J&quot;,                                                                             FN_PTR(getCurrentJavaThread)},
2765   {CC &quot;attachCurrentThread&quot;,                          CC &quot;(Z)Z&quot;,                                                                            FN_PTR(attachCurrentThread)},
2766   {CC &quot;detachCurrentThread&quot;,                          CC &quot;()V&quot;,                                                                             FN_PTR(detachCurrentThread)},
2767   {CC &quot;translate&quot;,                                    CC &quot;(&quot; OBJECT &quot;)J&quot;,                                                                   FN_PTR(translate)},
2768   {CC &quot;unhand&quot;,                                       CC &quot;(J)&quot; OBJECT,                                                                      FN_PTR(unhand)},
2769   {CC &quot;updateHotSpotNmethod&quot;,                         CC &quot;(&quot; HS_NMETHOD &quot;)V&quot;,                                                               FN_PTR(updateHotSpotNmethod)},
2770   {CC &quot;getCode&quot;,                                      CC &quot;(&quot; HS_INSTALLED_CODE &quot;)[B&quot;,                                                       FN_PTR(getCode)},
2771   {CC &quot;asReflectionExecutable&quot;,                       CC &quot;(&quot; HS_RESOLVED_METHOD &quot;)&quot; REFLECTION_EXECUTABLE,                                  FN_PTR(asReflectionExecutable)},
2772   {CC &quot;asReflectionField&quot;,                            CC &quot;(&quot; HS_RESOLVED_KLASS &quot;I)&quot; REFLECTION_FIELD,                                       FN_PTR(asReflectionField)},
2773   {CC &quot;getFailedSpeculations&quot;,                        CC &quot;(J[[B)[[B&quot;,                                                                       FN_PTR(getFailedSpeculations)},
2774   {CC &quot;getFailedSpeculationsAddress&quot;,                 CC &quot;(&quot; HS_RESOLVED_METHOD &quot;)J&quot;,                                                       FN_PTR(getFailedSpeculationsAddress)},
2775   {CC &quot;releaseFailedSpeculations&quot;,                    CC &quot;(J)V&quot;,                                                                            FN_PTR(releaseFailedSpeculations)},
2776   {CC &quot;addFailedSpeculation&quot;,                         CC &quot;(J[B)Z&quot;,                                                                          FN_PTR(addFailedSpeculation)},
2777   {CC &quot;callSystemExit&quot;,                               CC &quot;(I)V&quot;,                                                                            FN_PTR(callSystemExit)},




2778 };
2779 
2780 int CompilerToVM::methods_count() {
2781   return sizeof(methods) / sizeof(JNINativeMethod);
2782 }
</pre>
</td>
<td>
<hr />
<pre>
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 #include &quot;precompiled.hpp&quot;
  25 #include &quot;classfile/classLoaderData.inline.hpp&quot;
  26 #include &quot;classfile/javaClasses.inline.hpp&quot;
  27 #include &quot;classfile/stringTable.hpp&quot;
  28 #include &quot;classfile/symbolTable.hpp&quot;
  29 #include &quot;code/scopeDesc.hpp&quot;
  30 #include &quot;compiler/compileBroker.hpp&quot;
<span class="line-added">  31 #include &quot;compiler/compilerEvent.hpp&quot;</span>
  32 #include &quot;compiler/disassembler.hpp&quot;
  33 #include &quot;interpreter/linkResolver.hpp&quot;
  34 #include &quot;interpreter/bytecodeStream.hpp&quot;
  35 #include &quot;jvmci/jvmciCompilerToVM.hpp&quot;
  36 #include &quot;jvmci/jvmciCodeInstaller.hpp&quot;
  37 #include &quot;jvmci/jvmciRuntime.hpp&quot;
  38 #include &quot;logging/log.hpp&quot;
  39 #include &quot;logging/logTag.hpp&quot;
  40 #include &quot;memory/oopFactory.hpp&quot;
  41 #include &quot;memory/universe.hpp&quot;
  42 #include &quot;oops/constantPool.inline.hpp&quot;
  43 #include &quot;oops/method.inline.hpp&quot;
  44 #include &quot;oops/typeArrayOop.inline.hpp&quot;
  45 #include &quot;prims/nativeLookup.hpp&quot;
  46 #include &quot;runtime/atomic.hpp&quot;
  47 #include &quot;runtime/deoptimization.hpp&quot;
  48 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  49 #include &quot;runtime/frame.inline.hpp&quot;
  50 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  51 #include &quot;runtime/jniHandles.inline.hpp&quot;
</pre>
<hr />
<pre>
2612 C2V_VMENTRY_0(jboolean, addFailedSpeculation, (JNIEnv* env, jobject, jlong failed_speculations_address, jbyteArray speculation_obj))
2613   JVMCIPrimitiveArray speculation_handle = JVMCIENV-&gt;wrap(speculation_obj);
2614   int speculation_len = JVMCIENV-&gt;get_length(speculation_handle);
2615   char* speculation = NEW_RESOURCE_ARRAY(char, speculation_len);
2616   JVMCIENV-&gt;copy_bytes_to(speculation_handle, (jbyte*) speculation, 0, speculation_len);
2617   return FailedSpeculation::add_failed_speculation(NULL, (FailedSpeculation**)(address) failed_speculations_address, (address) speculation, speculation_len);
2618 }
2619 
2620 C2V_VMENTRY(void, callSystemExit, (JNIEnv* env, jobject, jint status))
2621   JavaValue result(T_VOID);
2622   JavaCallArguments jargs(1);
2623   jargs.push_int(status);
2624   JavaCalls::call_static(&amp;result,
2625                        SystemDictionary::System_klass(),
2626                        vmSymbols::exit_method_name(),
2627                        vmSymbols::int_void_signature(),
2628                        &amp;jargs,
2629                        CHECK);
2630 }
2631 
<span class="line-added">2632 C2V_VMENTRY_0(jlong, ticksNow, (JNIEnv* env, jobject))</span>
<span class="line-added">2633   return CompilerEvent::ticksNow();</span>
<span class="line-added">2634 }</span>
<span class="line-added">2635 </span>
<span class="line-added">2636 C2V_VMENTRY_0(jint, registerCompilerPhases, (JNIEnv* env, jobject, jobjectArray jphases))</span>
<span class="line-added">2637 #if INCLUDE_JFR</span>
<span class="line-added">2638   if (jphases == NULL) {</span>
<span class="line-added">2639     return -1;</span>
<span class="line-added">2640   }</span>
<span class="line-added">2641   JVMCIObjectArray phases = JVMCIENV-&gt;wrap(jphases);</span>
<span class="line-added">2642   int len = JVMCIENV-&gt;get_length(phases);</span>
<span class="line-added">2643   GrowableArray&lt;const char*&gt;* jvmci_phase_names = new GrowableArray&lt;const char*&gt;(len);</span>
<span class="line-added">2644   for (int i = 0; i &lt; len; i++) {</span>
<span class="line-added">2645     JVMCIObject phase = JVMCIENV-&gt;get_object_at(phases, i);</span>
<span class="line-added">2646     jvmci_phase_names-&gt;append(strdup(JVMCIENV-&gt;as_utf8_string(phase)));</span>
<span class="line-added">2647   }</span>
<span class="line-added">2648   return CompilerEvent::PhaseEvent::register_phases(jvmci_phase_names);</span>
<span class="line-added">2649 #else</span>
<span class="line-added">2650   return -1;</span>
<span class="line-added">2651 #endif // !INCLUDE_JFR</span>
<span class="line-added">2652 }</span>
<span class="line-added">2653 </span>
<span class="line-added">2654 C2V_VMENTRY(void, notifyCompilerPhaseEvent, (JNIEnv* env, jobject, jlong startTime, jint phase, jint compileId, jint level))</span>
<span class="line-added">2655   EventCompilerPhase event;</span>
<span class="line-added">2656   if (event.should_commit()) {</span>
<span class="line-added">2657     CompilerEvent::PhaseEvent::post(event, startTime, phase, compileId, level);</span>
<span class="line-added">2658   }</span>
<span class="line-added">2659 }</span>
<span class="line-added">2660 </span>
<span class="line-added">2661 C2V_VMENTRY(void, notifyCompilerInliningEvent, (JNIEnv* env, jobject, jint compileId, jobject caller, jobject callee, jboolean succeeded, jstring jmessage, jint bci))</span>
<span class="line-added">2662   EventCompilerInlining event;</span>
<span class="line-added">2663   if (event.should_commit()) {</span>
<span class="line-added">2664     Method* caller_method = JVMCIENV-&gt;asMethod(caller);</span>
<span class="line-added">2665     Method* callee_method = JVMCIENV-&gt;asMethod(callee);</span>
<span class="line-added">2666     JVMCIObject message = JVMCIENV-&gt;wrap(jmessage);</span>
<span class="line-added">2667     CompilerEvent::InlineEvent::post(event, compileId, caller_method, callee_method, succeeded, JVMCIENV-&gt;as_utf8_string(message), bci);</span>
<span class="line-added">2668   }</span>
<span class="line-added">2669 }</span>
<span class="line-added">2670 </span>
2671 #define CC (char*)  /*cast a literal from (const char*)*/
2672 #define FN_PTR(f) CAST_FROM_FN_PTR(void*, &amp;(c2v_ ## f))
2673 
2674 #define STRING                  &quot;Ljava/lang/String;&quot;
2675 #define OBJECT                  &quot;Ljava/lang/Object;&quot;
2676 #define CLASS                   &quot;Ljava/lang/Class;&quot;
2677 #define OBJECTCONSTANT          &quot;Ljdk/vm/ci/hotspot/HotSpotObjectConstantImpl;&quot;
2678 #define HANDLECONSTANT          &quot;Ljdk/vm/ci/hotspot/IndirectHotSpotObjectConstantImpl;&quot;
2679 #define EXECUTABLE              &quot;Ljava/lang/reflect/Executable;&quot;
2680 #define STACK_TRACE_ELEMENT     &quot;Ljava/lang/StackTraceElement;&quot;
2681 #define INSTALLED_CODE          &quot;Ljdk/vm/ci/code/InstalledCode;&quot;
2682 #define TARGET_DESCRIPTION      &quot;Ljdk/vm/ci/code/TargetDescription;&quot;
2683 #define BYTECODE_FRAME          &quot;Ljdk/vm/ci/code/BytecodeFrame;&quot;
2684 #define JAVACONSTANT            &quot;Ljdk/vm/ci/meta/JavaConstant;&quot;
2685 #define INSPECTED_FRAME_VISITOR &quot;Ljdk/vm/ci/code/stack/InspectedFrameVisitor;&quot;
2686 #define RESOLVED_METHOD         &quot;Ljdk/vm/ci/meta/ResolvedJavaMethod;&quot;
2687 #define HS_RESOLVED_METHOD      &quot;Ljdk/vm/ci/hotspot/HotSpotResolvedJavaMethodImpl;&quot;
2688 #define HS_RESOLVED_KLASS       &quot;Ljdk/vm/ci/hotspot/HotSpotResolvedObjectTypeImpl;&quot;
2689 #define HS_RESOLVED_TYPE        &quot;Ljdk/vm/ci/hotspot/HotSpotResolvedJavaType;&quot;
2690 #define HS_RESOLVED_FIELD       &quot;Ljdk/vm/ci/hotspot/HotSpotResolvedJavaField;&quot;
</pre>
<hr />
<pre>
2798   {CC &quot;getInt&quot;,                                       CC &quot;(&quot; OBJECTCONSTANT &quot;J)I&quot;,                                                          FN_PTR(getInt)},
2799   {CC &quot;getLong&quot;,                                      CC &quot;(&quot; OBJECTCONSTANT &quot;J)J&quot;,                                                          FN_PTR(getLong)},
2800   {CC &quot;getObject&quot;,                                    CC &quot;(&quot; OBJECTCONSTANT &quot;J)&quot; OBJECTCONSTANT,                                            FN_PTR(getObject)},
2801   {CC &quot;deleteGlobalHandle&quot;,                           CC &quot;(J)V&quot;,                                                                            FN_PTR(deleteGlobalHandle)},
2802   {CC &quot;registerNativeMethods&quot;,                        CC &quot;(&quot; CLASS &quot;)[J&quot;,                                                                   FN_PTR(registerNativeMethods)},
2803   {CC &quot;isCurrentThreadAttached&quot;,                      CC &quot;()Z&quot;,                                                                             FN_PTR(isCurrentThreadAttached)},
2804   {CC &quot;getCurrentJavaThread&quot;,                         CC &quot;()J&quot;,                                                                             FN_PTR(getCurrentJavaThread)},
2805   {CC &quot;attachCurrentThread&quot;,                          CC &quot;(Z)Z&quot;,                                                                            FN_PTR(attachCurrentThread)},
2806   {CC &quot;detachCurrentThread&quot;,                          CC &quot;()V&quot;,                                                                             FN_PTR(detachCurrentThread)},
2807   {CC &quot;translate&quot;,                                    CC &quot;(&quot; OBJECT &quot;)J&quot;,                                                                   FN_PTR(translate)},
2808   {CC &quot;unhand&quot;,                                       CC &quot;(J)&quot; OBJECT,                                                                      FN_PTR(unhand)},
2809   {CC &quot;updateHotSpotNmethod&quot;,                         CC &quot;(&quot; HS_NMETHOD &quot;)V&quot;,                                                               FN_PTR(updateHotSpotNmethod)},
2810   {CC &quot;getCode&quot;,                                      CC &quot;(&quot; HS_INSTALLED_CODE &quot;)[B&quot;,                                                       FN_PTR(getCode)},
2811   {CC &quot;asReflectionExecutable&quot;,                       CC &quot;(&quot; HS_RESOLVED_METHOD &quot;)&quot; REFLECTION_EXECUTABLE,                                  FN_PTR(asReflectionExecutable)},
2812   {CC &quot;asReflectionField&quot;,                            CC &quot;(&quot; HS_RESOLVED_KLASS &quot;I)&quot; REFLECTION_FIELD,                                       FN_PTR(asReflectionField)},
2813   {CC &quot;getFailedSpeculations&quot;,                        CC &quot;(J[[B)[[B&quot;,                                                                       FN_PTR(getFailedSpeculations)},
2814   {CC &quot;getFailedSpeculationsAddress&quot;,                 CC &quot;(&quot; HS_RESOLVED_METHOD &quot;)J&quot;,                                                       FN_PTR(getFailedSpeculationsAddress)},
2815   {CC &quot;releaseFailedSpeculations&quot;,                    CC &quot;(J)V&quot;,                                                                            FN_PTR(releaseFailedSpeculations)},
2816   {CC &quot;addFailedSpeculation&quot;,                         CC &quot;(J[B)Z&quot;,                                                                          FN_PTR(addFailedSpeculation)},
2817   {CC &quot;callSystemExit&quot;,                               CC &quot;(I)V&quot;,                                                                            FN_PTR(callSystemExit)},
<span class="line-added">2818   {CC &quot;ticksNow&quot;,                                     CC &quot;()J&quot;,                                                                             FN_PTR(ticksNow)},</span>
<span class="line-added">2819   {CC &quot;registerCompilerPhases&quot;,                       CC &quot;([&quot; STRING &quot;)I&quot;,                                                                  FN_PTR(registerCompilerPhases)},</span>
<span class="line-added">2820   {CC &quot;notifyCompilerPhaseEvent&quot;,                     CC &quot;(JIII)V&quot;,                                                                         FN_PTR(notifyCompilerPhaseEvent)},</span>
<span class="line-added">2821   {CC &quot;notifyCompilerInliningEvent&quot;,                  CC &quot;(I&quot; HS_RESOLVED_METHOD HS_RESOLVED_METHOD &quot;ZLjava/lang/String;I)V&quot;,               FN_PTR(notifyCompilerInliningEvent)},</span>
2822 };
2823 
2824 int CompilerToVM::methods_count() {
2825   return sizeof(methods) / sizeof(JNINativeMethod);
2826 }
</pre>
</td>
</tr>
</table>
<center><a href="jvmciCodeInstaller.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmciCompilerToVMInit.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>