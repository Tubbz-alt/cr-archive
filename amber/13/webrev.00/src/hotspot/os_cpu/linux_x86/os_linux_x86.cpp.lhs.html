<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/os_cpu/linux_x86/os_linux_x86.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 // no precompiled headers
 26 #include &quot;jvm.h&quot;
 27 #include &quot;asm/macroAssembler.hpp&quot;
 28 #include &quot;classfile/classLoader.hpp&quot;
 29 #include &quot;classfile/systemDictionary.hpp&quot;
 30 #include &quot;classfile/vmSymbols.hpp&quot;
 31 #include &quot;code/codeCache.hpp&quot;
 32 #include &quot;code/icBuffer.hpp&quot;
 33 #include &quot;code/vtableStubs.hpp&quot;
 34 #include &quot;interpreter/interpreter.hpp&quot;
 35 #include &quot;logging/log.hpp&quot;
 36 #include &quot;memory/allocation.inline.hpp&quot;
 37 #include &quot;os_share_linux.hpp&quot;
 38 #include &quot;prims/jniFastGetField.hpp&quot;
 39 #include &quot;prims/jvm_misc.hpp&quot;
 40 #include &quot;runtime/arguments.hpp&quot;
 41 #include &quot;runtime/extendedPC.hpp&quot;
 42 #include &quot;runtime/frame.inline.hpp&quot;
 43 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
 44 #include &quot;runtime/java.hpp&quot;
 45 #include &quot;runtime/javaCalls.hpp&quot;
 46 #include &quot;runtime/mutexLocker.hpp&quot;
 47 #include &quot;runtime/osThread.hpp&quot;
<a name="1" id="anc1"></a>
 48 #include &quot;runtime/sharedRuntime.hpp&quot;
 49 #include &quot;runtime/stubRoutines.hpp&quot;
 50 #include &quot;runtime/thread.inline.hpp&quot;
 51 #include &quot;runtime/timer.hpp&quot;
 52 #include &quot;services/memTracker.hpp&quot;
 53 #include &quot;utilities/align.hpp&quot;
 54 #include &quot;utilities/debug.hpp&quot;
 55 #include &quot;utilities/events.hpp&quot;
 56 #include &quot;utilities/vmError.hpp&quot;
 57 
 58 // put OS-includes here
 59 # include &lt;sys/types.h&gt;
 60 # include &lt;sys/mman.h&gt;
 61 # include &lt;pthread.h&gt;
 62 # include &lt;signal.h&gt;
 63 # include &lt;errno.h&gt;
 64 # include &lt;dlfcn.h&gt;
 65 # include &lt;stdlib.h&gt;
 66 # include &lt;stdio.h&gt;
 67 # include &lt;unistd.h&gt;
 68 # include &lt;sys/resource.h&gt;
 69 # include &lt;pthread.h&gt;
 70 # include &lt;sys/stat.h&gt;
 71 # include &lt;sys/time.h&gt;
 72 # include &lt;sys/utsname.h&gt;
 73 # include &lt;sys/socket.h&gt;
 74 # include &lt;sys/wait.h&gt;
 75 # include &lt;pwd.h&gt;
 76 # include &lt;poll.h&gt;
 77 # include &lt;ucontext.h&gt;
 78 #ifndef AMD64
 79 # include &lt;fpu_control.h&gt;
 80 #endif
 81 
 82 #ifdef AMD64
 83 #define REG_SP REG_RSP
 84 #define REG_PC REG_RIP
 85 #define REG_FP REG_RBP
 86 #define SPELL_REG_SP &quot;rsp&quot;
 87 #define SPELL_REG_FP &quot;rbp&quot;
 88 #else
 89 #define REG_SP REG_UESP
 90 #define REG_PC REG_EIP
 91 #define REG_FP REG_EBP
 92 #define SPELL_REG_SP &quot;esp&quot;
 93 #define SPELL_REG_FP &quot;ebp&quot;
 94 #endif // AMD64
 95 
 96 address os::current_stack_pointer() {
 97 #ifdef SPARC_WORKS
 98   void *esp;
 99   __asm__(&quot;mov %%&quot; SPELL_REG_SP &quot;, %0&quot;:&quot;=r&quot;(esp));
100   return (address) ((char*)esp + sizeof(long)*2);
<a name="2" id="anc2"></a><span class="line-removed">101 #elif defined(__clang__)</span>
<span class="line-removed">102   void* esp;</span>
<span class="line-removed">103   __asm__ __volatile__ (&quot;mov %%&quot; SPELL_REG_SP &quot;, %0&quot;:&quot;=r&quot;(esp):);</span>
<span class="line-removed">104   return (address) esp;</span>
105 #else
<a name="3" id="anc3"></a><span class="line-modified">106   register void *esp __asm__ (SPELL_REG_SP);</span>
<span class="line-removed">107   return (address) esp;</span>
108 #endif
109 }
110 
111 char* os::non_memory_address_word() {
112   // Must never look like an address returned by reserve_memory,
113   // even in its subfields (as defined by the CPU immediate fields,
114   // if the CPU splits constants across multiple instructions).
115 
116   return (char*) -1;
117 }
118 
119 address os::Linux::ucontext_get_pc(const ucontext_t * uc) {
120   return (address)uc-&gt;uc_mcontext.gregs[REG_PC];
121 }
122 
123 void os::Linux::ucontext_set_pc(ucontext_t * uc, address pc) {
124   uc-&gt;uc_mcontext.gregs[REG_PC] = (intptr_t)pc;
125 }
126 
127 intptr_t* os::Linux::ucontext_get_sp(const ucontext_t * uc) {
128   return (intptr_t*)uc-&gt;uc_mcontext.gregs[REG_SP];
129 }
130 
131 intptr_t* os::Linux::ucontext_get_fp(const ucontext_t * uc) {
132   return (intptr_t*)uc-&gt;uc_mcontext.gregs[REG_FP];
133 }
134 
135 // For Forte Analyzer AsyncGetCallTrace profiling support - thread
136 // is currently interrupted by SIGPROF.
137 // os::Solaris::fetch_frame_from_ucontext() tries to skip nested signal
138 // frames. Currently we don&#39;t do that on Linux, so it&#39;s the same as
139 // os::fetch_frame_from_context().
140 // This method is also used for stack overflow signal handling.
141 ExtendedPC os::Linux::fetch_frame_from_ucontext(Thread* thread,
142   const ucontext_t* uc, intptr_t** ret_sp, intptr_t** ret_fp) {
143 
144   assert(thread != NULL, &quot;just checking&quot;);
145   assert(ret_sp != NULL, &quot;just checking&quot;);
146   assert(ret_fp != NULL, &quot;just checking&quot;);
147 
148   return os::fetch_frame_from_context(uc, ret_sp, ret_fp);
149 }
150 
151 ExtendedPC os::fetch_frame_from_context(const void* ucVoid,
152                     intptr_t** ret_sp, intptr_t** ret_fp) {
153 
154   ExtendedPC  epc;
155   const ucontext_t* uc = (const ucontext_t*)ucVoid;
156 
157   if (uc != NULL) {
158     epc = ExtendedPC(os::Linux::ucontext_get_pc(uc));
159     if (ret_sp) *ret_sp = os::Linux::ucontext_get_sp(uc);
160     if (ret_fp) *ret_fp = os::Linux::ucontext_get_fp(uc);
161   } else {
162     // construct empty ExtendedPC for return value checking
163     epc = ExtendedPC(NULL);
164     if (ret_sp) *ret_sp = (intptr_t *)NULL;
165     if (ret_fp) *ret_fp = (intptr_t *)NULL;
166   }
167 
168   return epc;
169 }
170 
171 frame os::fetch_frame_from_context(const void* ucVoid) {
172   intptr_t* sp;
173   intptr_t* fp;
174   ExtendedPC epc = fetch_frame_from_context(ucVoid, &amp;sp, &amp;fp);
175   return frame(sp, fp, epc.pc());
176 }
177 
178 frame os::fetch_frame_from_ucontext(Thread* thread, void* ucVoid) {
179   intptr_t* sp;
180   intptr_t* fp;
181   ExtendedPC epc = os::Linux::fetch_frame_from_ucontext(thread, (ucontext_t*)ucVoid, &amp;sp, &amp;fp);
182   return frame(sp, fp, epc.pc());
183 }
184 
185 bool os::Linux::get_frame_at_stack_banging_point(JavaThread* thread, ucontext_t* uc, frame* fr) {
186   address pc = (address) os::Linux::ucontext_get_pc(uc);
187   if (Interpreter::contains(pc)) {
188     // interpreter performs stack banging after the fixed frame header has
189     // been generated while the compilers perform it before. To maintain
190     // semantic consistency between interpreted and compiled frames, the
191     // method returns the Java sender of the current frame.
192     *fr = os::fetch_frame_from_ucontext(thread, uc);
193     if (!fr-&gt;is_first_java_frame()) {
194       // get_frame_at_stack_banging_point() is only called when we
195       // have well defined stacks so java_sender() calls do not need
196       // to assert safe_for_sender() first.
197       *fr = fr-&gt;java_sender();
198     }
199   } else {
200     // more complex code with compiled code
201     assert(!Interpreter::contains(pc), &quot;Interpreted methods should have been handled above&quot;);
202     CodeBlob* cb = CodeCache::find_blob(pc);
203     if (cb == NULL || !cb-&gt;is_nmethod() || cb-&gt;is_frame_complete_at(pc)) {
204       // Not sure where the pc points to, fallback to default
205       // stack overflow handling
206       return false;
207     } else {
208       // in compiled code, the stack banging is performed just after the return pc
209       // has been pushed on the stack
210       intptr_t* fp = os::Linux::ucontext_get_fp(uc);
211       intptr_t* sp = os::Linux::ucontext_get_sp(uc);
212       *fr = frame(sp + 1, fp, (address)*sp);
213       if (!fr-&gt;is_java_frame()) {
214         assert(!fr-&gt;is_first_frame(), &quot;Safety check&quot;);
215         // See java_sender() comment above.
216         *fr = fr-&gt;java_sender();
217       }
218     }
219   }
220   assert(fr-&gt;is_java_frame(), &quot;Safety check&quot;);
221   return true;
222 }
223 
224 // By default, gcc always save frame pointer (%ebp/%rbp) on stack. It may get
225 // turned off by -fomit-frame-pointer,
226 frame os::get_sender_for_C_frame(frame* fr) {
227   return frame(fr-&gt;sender_sp(), fr-&gt;link(), fr-&gt;sender_pc());
228 }
229 
230 intptr_t* _get_previous_fp() {
231 #ifdef SPARC_WORKS
232   intptr_t **ebp;
233   __asm__(&quot;mov %%&quot; SPELL_REG_FP &quot;, %0&quot;:&quot;=r&quot;(ebp));
234 #elif defined(__clang__)
235   intptr_t **ebp;
236   __asm__ __volatile__ (&quot;mov %%&quot; SPELL_REG_FP &quot;, %0&quot;:&quot;=r&quot;(ebp):);
237 #else
238   register intptr_t **ebp __asm__ (SPELL_REG_FP);
239 #endif
240   // ebp is for this frame (_get_previous_fp). We want the ebp for the
241   // caller of os::current_frame*(), so go up two frames. However, for
242   // optimized builds, _get_previous_fp() will be inlined, so only go
243   // up 1 frame in that case.
244 #ifdef _NMT_NOINLINE_
245   return **(intptr_t***)ebp;
246 #else
247   return *ebp;
248 #endif
249 }
250 
251 
252 frame os::current_frame() {
253   intptr_t* fp = _get_previous_fp();
254   frame myframe((intptr_t*)os::current_stack_pointer(),
255                 (intptr_t*)fp,
256                 CAST_FROM_FN_PTR(address, os::current_frame));
257   if (os::is_first_C_frame(&amp;myframe)) {
258     // stack is not walkable
259     return frame();
260   } else {
261     return os::get_sender_for_C_frame(&amp;myframe);
262   }
263 }
264 
265 // Utility functions
266 
267 // From IA32 System Programming Guide
268 enum {
269   trap_page_fault = 0xE
270 };
271 
272 extern &quot;C&quot; JNIEXPORT int
273 JVM_handle_linux_signal(int sig,
274                         siginfo_t* info,
275                         void* ucVoid,
276                         int abort_if_unrecognized) {
277   ucontext_t* uc = (ucontext_t*) ucVoid;
278 
279   Thread* t = Thread::current_or_null_safe();
280 
281   // Must do this before SignalHandlerMark, if crash protection installed we will longjmp away
282   // (no destructors can be run)
283   os::ThreadCrashProtection::check_crash_protection(sig, t);
284 
285   SignalHandlerMark shm(t);
286 
287   // Note: it&#39;s not uncommon that JNI code uses signal/sigset to install
288   // then restore certain signal handler (e.g. to temporarily block SIGPIPE,
289   // or have a SIGILL handler when detecting CPU type). When that happens,
290   // JVM_handle_linux_signal() might be invoked with junk info/ucVoid. To
291   // avoid unnecessary crash when libjsig is not preloaded, try handle signals
292   // that do not require siginfo/ucontext first.
293 
294   if (sig == SIGPIPE || sig == SIGXFSZ) {
295     // allow chained handler to go first
296     if (os::Linux::chained_handler(sig, info, ucVoid)) {
297       return true;
298     } else {
299       // Ignoring SIGPIPE/SIGXFSZ - see bugs 4229104 or 6499219
300       return true;
301     }
302   }
303 
304 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
305   if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp; info != NULL &amp;&amp; info-&gt;si_addr == g_assert_poison) {
306     if (handle_assert_poison_fault(ucVoid, info-&gt;si_addr)) {
307       return 1;
308     }
309   }
310 #endif
311 
312   JavaThread* thread = NULL;
313   VMThread* vmthread = NULL;
314   if (os::Linux::signal_handlers_are_installed) {
315     if (t != NULL ){
316       if(t-&gt;is_Java_thread()) {
317         thread = (JavaThread*)t;
318       }
319       else if(t-&gt;is_VM_thread()){
320         vmthread = (VMThread *)t;
321       }
322     }
323   }
324 /*
325   NOTE: does not seem to work on linux.
326   if (info == NULL || info-&gt;si_code &lt;= 0 || info-&gt;si_code == SI_NOINFO) {
327     // can&#39;t decode this kind of signal
328     info = NULL;
329   } else {
330     assert(sig == info-&gt;si_signo, &quot;bad siginfo&quot;);
331   }
332 */
333   // decide if this trap can be handled by a stub
334   address stub = NULL;
335 
336   address pc          = NULL;
337 
338   //%note os_trap_1
339   if (info != NULL &amp;&amp; uc != NULL &amp;&amp; thread != NULL) {
340     pc = (address) os::Linux::ucontext_get_pc(uc);
341 
342     if (StubRoutines::is_safefetch_fault(pc)) {
343       os::Linux::ucontext_set_pc(uc, StubRoutines::continuation_for_safefetch_fault(pc));
344       return 1;
345     }
346 
347 #ifndef AMD64
348     // Halt if SI_KERNEL before more crashes get misdiagnosed as Java bugs
349     // This can happen in any running code (currently more frequently in
350     // interpreter code but has been seen in compiled code)
351     if (sig == SIGSEGV &amp;&amp; info-&gt;si_addr == 0 &amp;&amp; info-&gt;si_code == SI_KERNEL) {
352       fatal(&quot;An irrecoverable SI_KERNEL SIGSEGV has occurred due &quot;
353             &quot;to unstable signal handling in this distribution.&quot;);
354     }
355 #endif // AMD64
356 
357     // Handle ALL stack overflow variations here
358     if (sig == SIGSEGV) {
359       address addr = (address) info-&gt;si_addr;
360 
361       // check if fault address is within thread stack
362       if (thread-&gt;is_in_full_stack(addr)) {
363         // stack overflow
364         if (thread-&gt;in_stack_yellow_reserved_zone(addr)) {
365           if (thread-&gt;thread_state() == _thread_in_Java) {
366             if (thread-&gt;in_stack_reserved_zone(addr)) {
367               frame fr;
368               if (os::Linux::get_frame_at_stack_banging_point(thread, uc, &amp;fr)) {
369                 assert(fr.is_java_frame(), &quot;Must be a Java frame&quot;);
370                 frame activation =
371                   SharedRuntime::look_for_reserved_stack_annotated_method(thread, fr);
372                 if (activation.sp() != NULL) {
373                   thread-&gt;disable_stack_reserved_zone();
374                   if (activation.is_interpreted_frame()) {
375                     thread-&gt;set_reserved_stack_activation((address)(
376                       activation.fp() + frame::interpreter_frame_initial_sp_offset));
377                   } else {
378                     thread-&gt;set_reserved_stack_activation((address)activation.unextended_sp());
379                   }
380                   return 1;
381                 }
382               }
383             }
384             // Throw a stack overflow exception.  Guard pages will be reenabled
385             // while unwinding the stack.
386             thread-&gt;disable_stack_yellow_reserved_zone();
387             stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::STACK_OVERFLOW);
388           } else {
389             // Thread was in the vm or native code.  Return and try to finish.
390             thread-&gt;disable_stack_yellow_reserved_zone();
391             return 1;
392           }
393         } else if (thread-&gt;in_stack_red_zone(addr)) {
394           // Fatal red zone violation.  Disable the guard pages and fall through
395           // to handle_unexpected_exception way down below.
396           thread-&gt;disable_stack_red_zone();
397           tty-&gt;print_raw_cr(&quot;An irrecoverable stack overflow has occurred.&quot;);
398 
399           // This is a likely cause, but hard to verify. Let&#39;s just print
400           // it as a hint.
401           tty-&gt;print_raw_cr(&quot;Please check if any of your loaded .so files has &quot;
402                             &quot;enabled executable stack (see man page execstack(8))&quot;);
403         } else {
404           // Accessing stack address below sp may cause SEGV if current
405           // thread has MAP_GROWSDOWN stack. This should only happen when
406           // current thread was created by user code with MAP_GROWSDOWN flag
407           // and then attached to VM. See notes in os_linux.cpp.
408           if (thread-&gt;osthread()-&gt;expanding_stack() == 0) {
409              thread-&gt;osthread()-&gt;set_expanding_stack();
410              if (os::Linux::manually_expand_stack(thread, addr)) {
411                thread-&gt;osthread()-&gt;clear_expanding_stack();
412                return 1;
413              }
414              thread-&gt;osthread()-&gt;clear_expanding_stack();
415           } else {
416              fatal(&quot;recursive segv. expanding stack.&quot;);
417           }
418         }
419       }
420     }
421 
422     if ((sig == SIGSEGV) &amp;&amp; VM_Version::is_cpuinfo_segv_addr(pc)) {
423       // Verify that OS save/restore AVX registers.
424       stub = VM_Version::cpuinfo_cont_addr();
425     }
426 
427     if (thread-&gt;thread_state() == _thread_in_Java) {
428       // Java thread running in Java code =&gt; find exception handler if any
429       // a fault inside compiled code, the interpreter, or a stub
430 
<a name="4" id="anc4"></a><span class="line-modified">431       if (sig == SIGSEGV &amp;&amp; os::is_poll_address((address)info-&gt;si_addr)) {</span>
432         stub = SharedRuntime::get_poll_stub(pc);
433       } else if (sig == SIGBUS /* &amp;&amp; info-&gt;si_code == BUS_OBJERR */) {
434         // BugId 4454115: A read from a MappedByteBuffer can fault
435         // here if the underlying file has been truncated.
436         // Do not crash the VM in such a case.
437         CodeBlob* cb = CodeCache::find_blob_unsafe(pc);
438         CompiledMethod* nm = (cb != NULL) ? cb-&gt;as_compiled_method_or_null() : NULL;
439         bool is_unsafe_arraycopy = thread-&gt;doing_unsafe_access() &amp;&amp; UnsafeCopyMemory::contains_pc(pc);
440         if ((nm != NULL &amp;&amp; nm-&gt;has_unsafe_access()) || is_unsafe_arraycopy) {
441           address next_pc = Assembler::locate_next_instruction(pc);
442           if (is_unsafe_arraycopy) {
443             next_pc = UnsafeCopyMemory::page_error_continue_pc(pc);
444           }
445           stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
446         }
447       }
448       else
449 
450 #ifdef AMD64
451       if (sig == SIGFPE  &amp;&amp;
452           (info-&gt;si_code == FPE_INTDIV || info-&gt;si_code == FPE_FLTDIV)) {
453         stub =
454           SharedRuntime::
455           continuation_for_implicit_exception(thread,
456                                               pc,
457                                               SharedRuntime::
458                                               IMPLICIT_DIVIDE_BY_ZERO);
459 #else
460       if (sig == SIGFPE /* &amp;&amp; info-&gt;si_code == FPE_INTDIV */) {
461         // HACK: si_code does not work on linux 2.2.12-20!!!
462         int op = pc[0];
463         if (op == 0xDB) {
464           // FIST
465           // TODO: The encoding of D2I in i486.ad can cause an exception
466           // prior to the fist instruction if there was an invalid operation
467           // pending. We want to dismiss that exception. From the win_32
468           // side it also seems that if it really was the fist causing
469           // the exception that we do the d2i by hand with different
470           // rounding. Seems kind of weird.
471           // NOTE: that we take the exception at the NEXT floating point instruction.
472           assert(pc[0] == 0xDB, &quot;not a FIST opcode&quot;);
473           assert(pc[1] == 0x14, &quot;not a FIST opcode&quot;);
474           assert(pc[2] == 0x24, &quot;not a FIST opcode&quot;);
475           return true;
476         } else if (op == 0xF7) {
477           // IDIV
478           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_DIVIDE_BY_ZERO);
479         } else {
480           // TODO: handle more cases if we are using other x86 instructions
481           //   that can generate SIGFPE signal on linux.
482           tty-&gt;print_cr(&quot;unknown opcode 0x%X with SIGFPE.&quot;, op);
483           fatal(&quot;please update this code.&quot;);
484         }
485 #endif // AMD64
486       } else if (sig == SIGSEGV &amp;&amp;
487                  MacroAssembler::uses_implicit_null_check(info-&gt;si_addr)) {
488           // Determination of interpreter/vtable stub/compiled code null exception
489           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_NULL);
490       }
491     } else if ((thread-&gt;thread_state() == _thread_in_vm ||
492                 thread-&gt;thread_state() == _thread_in_native) &amp;&amp;
493                (sig == SIGBUS &amp;&amp; /* info-&gt;si_code == BUS_OBJERR &amp;&amp; */
494                thread-&gt;doing_unsafe_access())) {
495         address next_pc = Assembler::locate_next_instruction(pc);
496         if (UnsafeCopyMemory::contains_pc(pc)) {
497           next_pc = UnsafeCopyMemory::page_error_continue_pc(pc);
498         }
499         stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
500     }
501 
502     // jni_fast_Get&lt;Primitive&gt;Field can trap at certain pc&#39;s if a GC kicks in
503     // and the heap gets shrunk before the field access.
504     if ((sig == SIGSEGV) || (sig == SIGBUS)) {
505       address addr = JNI_FastGetField::find_slowcase_pc(pc);
506       if (addr != (address)-1) {
507         stub = addr;
508       }
509     }
510   }
511 
512 #ifndef AMD64
513   // Execution protection violation
514   //
515   // This should be kept as the last step in the triage.  We don&#39;t
516   // have a dedicated trap number for a no-execute fault, so be
517   // conservative and allow other handlers the first shot.
518   //
519   // Note: We don&#39;t test that info-&gt;si_code == SEGV_ACCERR here.
520   // this si_code is so generic that it is almost meaningless; and
521   // the si_code for this condition may change in the future.
522   // Furthermore, a false-positive should be harmless.
523   if (UnguardOnExecutionViolation &gt; 0 &amp;&amp;
524       (sig == SIGSEGV || sig == SIGBUS) &amp;&amp;
525       uc-&gt;uc_mcontext.gregs[REG_TRAPNO] == trap_page_fault) {
526     int page_size = os::vm_page_size();
527     address addr = (address) info-&gt;si_addr;
528     address pc = os::Linux::ucontext_get_pc(uc);
529     // Make sure the pc and the faulting address are sane.
530     //
531     // If an instruction spans a page boundary, and the page containing
532     // the beginning of the instruction is executable but the following
533     // page is not, the pc and the faulting address might be slightly
534     // different - we still want to unguard the 2nd page in this case.
535     //
536     // 15 bytes seems to be a (very) safe value for max instruction size.
537     bool pc_is_near_addr =
538       (pointer_delta((void*) addr, (void*) pc, sizeof(char)) &lt; 15);
539     bool instr_spans_page_boundary =
540       (align_down((intptr_t) pc ^ (intptr_t) addr,
541                        (intptr_t) page_size) &gt; 0);
542 
543     if (pc == addr || (pc_is_near_addr &amp;&amp; instr_spans_page_boundary)) {
544       static volatile address last_addr =
545         (address) os::non_memory_address_word();
546 
547       // In conservative mode, don&#39;t unguard unless the address is in the VM
548       if (addr != last_addr &amp;&amp;
549           (UnguardOnExecutionViolation &gt; 1 || os::address_is_in_vm(addr))) {
550 
551         // Set memory to RWX and retry
552         address page_start = align_down(addr, page_size);
553         bool res = os::protect_memory((char*) page_start, page_size,
554                                       os::MEM_PROT_RWX);
555 
556         log_debug(os)(&quot;Execution protection violation &quot;
557                       &quot;at &quot; INTPTR_FORMAT
558                       &quot;, unguarding &quot; INTPTR_FORMAT &quot;: %s, errno=%d&quot;, p2i(addr),
559                       p2i(page_start), (res ? &quot;success&quot; : &quot;failed&quot;), errno);
560         stub = pc;
561 
562         // Set last_addr so if we fault again at the same address, we don&#39;t end
563         // up in an endless loop.
564         //
565         // There are two potential complications here.  Two threads trapping at
566         // the same address at the same time could cause one of the threads to
567         // think it already unguarded, and abort the VM.  Likely very rare.
568         //
569         // The other race involves two threads alternately trapping at
570         // different addresses and failing to unguard the page, resulting in
571         // an endless loop.  This condition is probably even more unlikely than
572         // the first.
573         //
574         // Although both cases could be avoided by using locks or thread local
575         // last_addr, these solutions are unnecessary complication: this
576         // handler is a best-effort safety net, not a complete solution.  It is
577         // disabled by default and should only be used as a workaround in case
578         // we missed any no-execute-unsafe VM code.
579 
580         last_addr = addr;
581       }
582     }
583   }
584 #endif // !AMD64
585 
586   if (stub != NULL) {
587     // save all thread context in case we need to restore it
588     if (thread != NULL) thread-&gt;set_saved_exception_pc(pc);
589 
590     os::Linux::ucontext_set_pc(uc, stub);
591     return true;
592   }
593 
594   // signal-chaining
595   if (os::Linux::chained_handler(sig, info, ucVoid)) {
596      return true;
597   }
598 
599   if (!abort_if_unrecognized) {
600     // caller wants another chance, so give it to him
601     return false;
602   }
603 
604   if (pc == NULL &amp;&amp; uc != NULL) {
605     pc = os::Linux::ucontext_get_pc(uc);
606   }
607 
608   // unmask current signal
609   sigset_t newset;
610   sigemptyset(&amp;newset);
611   sigaddset(&amp;newset, sig);
612   sigprocmask(SIG_UNBLOCK, &amp;newset, NULL);
613 
614   VMError::report_and_die(t, sig, pc, info, ucVoid);
615 
616   ShouldNotReachHere();
617   return true; // Mute compiler
618 }
619 
620 void os::Linux::init_thread_fpu_state(void) {
621 #ifndef AMD64
622   // set fpu to 53 bit precision
623   set_fpu_control_word(0x27f);
624 #endif // !AMD64
625 }
626 
627 int os::Linux::get_fpu_control_word(void) {
628 #ifdef AMD64
629   return 0;
630 #else
631   int fpu_control;
632   _FPU_GETCW(fpu_control);
633   return fpu_control &amp; 0xffff;
634 #endif // AMD64
635 }
636 
637 void os::Linux::set_fpu_control_word(int fpu_control) {
638 #ifndef AMD64
639   _FPU_SETCW(fpu_control);
640 #endif // !AMD64
641 }
642 
643 // Check that the linux kernel version is 2.4 or higher since earlier
644 // versions do not support SSE without patches.
645 bool os::supports_sse() {
646 #ifdef AMD64
647   return true;
648 #else
649   struct utsname uts;
650   if( uname(&amp;uts) != 0 ) return false; // uname fails?
651   char *minor_string;
652   int major = strtol(uts.release,&amp;minor_string,10);
653   int minor = strtol(minor_string+1,NULL,10);
654   bool result = (major &gt; 2 || (major==2 &amp;&amp; minor &gt;= 4));
655   log_info(os)(&quot;OS version is %d.%d, which %s support SSE/SSE2&quot;,
656                major,minor, result ? &quot;DOES&quot; : &quot;does NOT&quot;);
657   return result;
658 #endif // AMD64
659 }
660 
661 bool os::is_allocatable(size_t bytes) {
662 #ifdef AMD64
663   // unused on amd64?
664   return true;
665 #else
666 
667   if (bytes &lt; 2 * G) {
668     return true;
669   }
670 
671   char* addr = reserve_memory(bytes, NULL);
672 
673   if (addr != NULL) {
674     release_memory(addr, bytes);
675   }
676 
677   return addr != NULL;
678 #endif // AMD64
679 }
680 
681 ////////////////////////////////////////////////////////////////////////////////
682 // thread stack
683 
684 // Minimum usable stack sizes required to get to user code. Space for
685 // HotSpot guard pages is added later.
686 size_t os::Posix::_compiler_thread_min_stack_allowed = 48 * K;
687 size_t os::Posix::_java_thread_min_stack_allowed = 40 * K;
688 #ifdef _LP64
689 size_t os::Posix::_vm_internal_thread_min_stack_allowed = 64 * K;
690 #else
691 size_t os::Posix::_vm_internal_thread_min_stack_allowed = (48 DEBUG_ONLY(+ 4)) * K;
692 #endif // _LP64
693 
694 // return default stack size for thr_type
695 size_t os::Posix::default_stack_size(os::ThreadType thr_type) {
696   // default stack size (compiler thread needs larger stack)
697 #ifdef AMD64
698   size_t s = (thr_type == os::compiler_thread ? 4 * M : 1 * M);
699 #else
700   size_t s = (thr_type == os::compiler_thread ? 2 * M : 512 * K);
701 #endif // AMD64
702   return s;
703 }
704 
705 /////////////////////////////////////////////////////////////////////////////
706 // helper functions for fatal error handler
707 
708 void os::print_context(outputStream *st, const void *context) {
709   if (context == NULL) return;
710 
711   const ucontext_t *uc = (const ucontext_t*)context;
712   st-&gt;print_cr(&quot;Registers:&quot;);
713 #ifdef AMD64
714   st-&gt;print(  &quot;RAX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_RAX]);
715   st-&gt;print(&quot;, RBX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_RBX]);
716   st-&gt;print(&quot;, RCX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_RCX]);
717   st-&gt;print(&quot;, RDX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_RDX]);
718   st-&gt;cr();
719   st-&gt;print(  &quot;RSP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_RSP]);
720   st-&gt;print(&quot;, RBP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_RBP]);
721   st-&gt;print(&quot;, RSI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_RSI]);
722   st-&gt;print(&quot;, RDI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_RDI]);
723   st-&gt;cr();
724   st-&gt;print(  &quot;R8 =&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_R8]);
725   st-&gt;print(&quot;, R9 =&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_R9]);
726   st-&gt;print(&quot;, R10=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_R10]);
727   st-&gt;print(&quot;, R11=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_R11]);
728   st-&gt;cr();
729   st-&gt;print(  &quot;R12=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_R12]);
730   st-&gt;print(&quot;, R13=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_R13]);
731   st-&gt;print(&quot;, R14=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_R14]);
732   st-&gt;print(&quot;, R15=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_R15]);
733   st-&gt;cr();
734   st-&gt;print(  &quot;RIP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_RIP]);
735   st-&gt;print(&quot;, EFLAGS=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_EFL]);
736   st-&gt;print(&quot;, CSGSFS=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_CSGSFS]);
737   st-&gt;print(&quot;, ERR=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_ERR]);
738   st-&gt;cr();
739   st-&gt;print(&quot;  TRAPNO=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;uc_mcontext.gregs[REG_TRAPNO]);
740 #else
741   st-&gt;print(  &quot;EAX=&quot; INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_EAX]);
742   st-&gt;print(&quot;, EBX=&quot; INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_EBX]);
743   st-&gt;print(&quot;, ECX=&quot; INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_ECX]);
744   st-&gt;print(&quot;, EDX=&quot; INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_EDX]);
745   st-&gt;cr();
746   st-&gt;print(  &quot;ESP=&quot; INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_UESP]);
747   st-&gt;print(&quot;, EBP=&quot; INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_EBP]);
748   st-&gt;print(&quot;, ESI=&quot; INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_ESI]);
749   st-&gt;print(&quot;, EDI=&quot; INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_EDI]);
750   st-&gt;cr();
751   st-&gt;print(  &quot;EIP=&quot; INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_EIP]);
752   st-&gt;print(&quot;, EFLAGS=&quot; INTPTR_FORMAT, uc-&gt;uc_mcontext.gregs[REG_EFL]);
753   st-&gt;print(&quot;, CR2=&quot; PTR64_FORMAT, (uint64_t)uc-&gt;uc_mcontext.cr2);
754 #endif // AMD64
755   st-&gt;cr();
756   st-&gt;cr();
757 
758   intptr_t *sp = (intptr_t *)os::Linux::ucontext_get_sp(uc);
759   st-&gt;print_cr(&quot;Top of Stack: (sp=&quot; PTR_FORMAT &quot;)&quot;, p2i(sp));
760   print_hex_dump(st, (address)sp, (address)(sp + 8), sizeof(intptr_t));
761   st-&gt;cr();
762 
763   // Note: it may be unsafe to inspect memory near pc. For example, pc may
764   // point to garbage if entry point in an nmethod is corrupted. Leave
765   // this at the end, and hope for the best.
766   address pc = os::Linux::ucontext_get_pc(uc);
767   print_instructions(st, pc, sizeof(char));
768   st-&gt;cr();
769 }
770 
771 void os::print_register_info(outputStream *st, const void *context) {
772   if (context == NULL) return;
773 
774   const ucontext_t *uc = (const ucontext_t*)context;
775 
776   st-&gt;print_cr(&quot;Register to memory mapping:&quot;);
777   st-&gt;cr();
778 
779   // this is horrendously verbose but the layout of the registers in the
780   // context does not match how we defined our abstract Register set, so
781   // we can&#39;t just iterate through the gregs area
782 
783   // this is only for the &quot;general purpose&quot; registers
784 
785 #ifdef AMD64
786   st-&gt;print(&quot;RAX=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RAX]);
787   st-&gt;print(&quot;RBX=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RBX]);
788   st-&gt;print(&quot;RCX=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RCX]);
789   st-&gt;print(&quot;RDX=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RDX]);
790   st-&gt;print(&quot;RSP=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RSP]);
791   st-&gt;print(&quot;RBP=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RBP]);
792   st-&gt;print(&quot;RSI=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RSI]);
793   st-&gt;print(&quot;RDI=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_RDI]);
794   st-&gt;print(&quot;R8 =&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R8]);
795   st-&gt;print(&quot;R9 =&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R9]);
796   st-&gt;print(&quot;R10=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R10]);
797   st-&gt;print(&quot;R11=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R11]);
798   st-&gt;print(&quot;R12=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R12]);
799   st-&gt;print(&quot;R13=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R13]);
800   st-&gt;print(&quot;R14=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R14]);
801   st-&gt;print(&quot;R15=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_R15]);
802 #else
803   st-&gt;print(&quot;EAX=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_EAX]);
804   st-&gt;print(&quot;EBX=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_EBX]);
805   st-&gt;print(&quot;ECX=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_ECX]);
806   st-&gt;print(&quot;EDX=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_EDX]);
807   st-&gt;print(&quot;ESP=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_ESP]);
808   st-&gt;print(&quot;EBP=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_EBP]);
809   st-&gt;print(&quot;ESI=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_ESI]);
810   st-&gt;print(&quot;EDI=&quot;); print_location(st, uc-&gt;uc_mcontext.gregs[REG_EDI]);
811 #endif // AMD64
812 
813   st-&gt;cr();
814 }
815 
816 void os::setup_fpu() {
817 #ifndef AMD64
818   address fpu_cntrl = StubRoutines::addr_fpu_cntrl_wrd_std();
819   __asm__ volatile (  &quot;fldcw (%0)&quot; :
820                       : &quot;r&quot; (fpu_cntrl) : &quot;memory&quot;);
821 #endif // !AMD64
822 }
823 
824 #ifndef PRODUCT
825 void os::verify_stack_alignment() {
826 #ifdef AMD64
827   assert(((intptr_t)os::current_stack_pointer() &amp; (StackAlignmentInBytes-1)) == 0, &quot;incorrect stack alignment&quot;);
828 #endif
829 }
830 #endif
831 
832 
833 /*
834  * IA32 only: execute code at a high address in case buggy NX emulation is present. I.e. avoid CS limit
835  * updates (JDK-8023956).
836  */
837 void os::workaround_expand_exec_shield_cs_limit() {
838 #if defined(IA32)
839   assert(Linux::initial_thread_stack_bottom() != NULL, &quot;sanity&quot;);
840   size_t page_size = os::vm_page_size();
841 
842   /*
843    * JDK-8197429
844    *
845    * Expand the stack mapping to the end of the initial stack before
846    * attempting to install the codebuf.  This is needed because newer
847    * Linux kernels impose a distance of a megabyte between stack
848    * memory and other memory regions.  If we try to install the
849    * codebuf before expanding the stack the installation will appear
850    * to succeed but we&#39;ll get a segfault later if we expand the stack
851    * in Java code.
852    *
853    */
854   if (os::is_primordial_thread()) {
855     address limit = Linux::initial_thread_stack_bottom();
856     if (! DisablePrimordialThreadGuardPages) {
857       limit += JavaThread::stack_red_zone_size() +
858         JavaThread::stack_yellow_zone_size();
859     }
860     os::Linux::expand_stack_to(limit);
861   }
862 
863   /*
864    * Take the highest VA the OS will give us and exec
865    *
866    * Although using -(pagesz) as mmap hint works on newer kernel as you would
867    * think, older variants affected by this work-around don&#39;t (search forward only).
868    *
869    * On the affected distributions, we understand the memory layout to be:
870    *
871    *   TASK_LIMIT= 3G, main stack base close to TASK_LIMT.
872    *
873    * A few pages south main stack will do it.
874    *
875    * If we are embedded in an app other than launcher (initial != main stack),
876    * we don&#39;t have much control or understanding of the address space, just let it slide.
877    */
878   char* hint = (char*)(Linux::initial_thread_stack_bottom() -
879                        (JavaThread::stack_guard_zone_size() + page_size));
880   char* codebuf = os::attempt_reserve_memory_at(page_size, hint);
881 
882   if (codebuf == NULL) {
883     // JDK-8197429: There may be a stack gap of one megabyte between
884     // the limit of the stack and the nearest memory region: this is a
885     // Linux kernel workaround for CVE-2017-1000364.  If we failed to
886     // map our codebuf, try again at an address one megabyte lower.
887     hint -= 1 * M;
888     codebuf = os::attempt_reserve_memory_at(page_size, hint);
889   }
890 
891   if ((codebuf == NULL) || (!os::commit_memory(codebuf, page_size, true))) {
892     return; // No matter, we tried, best effort.
893   }
894 
895   MemTracker::record_virtual_memory_type((address)codebuf, mtInternal);
896 
897   log_info(os)(&quot;[CS limit NX emulation work-around, exec code at: %p]&quot;, codebuf);
898 
899   // Some code to exec: the &#39;ret&#39; instruction
900   codebuf[0] = 0xC3;
901 
902   // Call the code in the codebuf
903   __asm__ volatile(&quot;call *%0&quot; : : &quot;r&quot;(codebuf));
904 
905   // keep the page mapped so CS limit isn&#39;t reduced.
906 #endif
907 }
908 
909 int os::extra_bang_size_in_bytes() {
910   // JDK-8050147 requires the full cache line bang for x86.
911   return VM_Version::L1_line_size();
912 }
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>