<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/cpu/arm/interp_masm_arm.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2008, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;asm/macroAssembler.inline.hpp&quot;
  28 #include &quot;gc/shared/barrierSet.hpp&quot;
  29 #include &quot;gc/shared/cardTable.hpp&quot;
  30 #include &quot;gc/shared/cardTableBarrierSet.inline.hpp&quot;
  31 #include &quot;gc/shared/collectedHeap.hpp&quot;
  32 #include &quot;interp_masm_arm.hpp&quot;
  33 #include &quot;interpreter/interpreter.hpp&quot;
  34 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;oops/arrayOop.hpp&quot;
  37 #include &quot;oops/markWord.hpp&quot;
  38 #include &quot;oops/method.hpp&quot;
  39 #include &quot;oops/methodData.hpp&quot;
  40 #include &quot;prims/jvmtiExport.hpp&quot;
  41 #include &quot;prims/jvmtiThreadState.hpp&quot;
  42 #include &quot;runtime/basicLock.hpp&quot;
  43 #include &quot;runtime/biasedLocking.hpp&quot;
  44 #include &quot;runtime/frame.inline.hpp&quot;
  45 #include &quot;runtime/safepointMechanism.hpp&quot;
  46 #include &quot;runtime/sharedRuntime.hpp&quot;
  47 #include &quot;utilities/powerOfTwo.hpp&quot;
  48 
  49 //--------------------------------------------------------------------
  50 // Implementation of InterpreterMacroAssembler
  51 
  52 
  53 
  54 
  55 InterpreterMacroAssembler::InterpreterMacroAssembler(CodeBuffer* code) : MacroAssembler(code) {
  56 }
  57 
  58 void InterpreterMacroAssembler::call_VM_helper(Register oop_result, address entry_point, int number_of_arguments, bool check_exceptions) {
  59 #ifdef ASSERT
  60   // Ensure that last_sp is not filled.
  61   { Label L;
  62     ldr(Rtemp, Address(FP, frame::interpreter_frame_last_sp_offset * wordSize));
  63     cbz(Rtemp, L);
  64     stop(&quot;InterpreterMacroAssembler::call_VM_helper: last_sp != NULL&quot;);
  65     bind(L);
  66   }
  67 #endif // ASSERT
  68 
  69   // Rbcp must be saved/restored since it may change due to GC.
  70   save_bcp();
  71 
  72 
  73   // super call
  74   MacroAssembler::call_VM_helper(oop_result, entry_point, number_of_arguments, check_exceptions);
  75 
  76 
  77   // Restore interpreter specific registers.
  78   restore_bcp();
  79   restore_method();
  80 }
  81 
  82 void InterpreterMacroAssembler::jump_to_entry(address entry) {
  83   assert(entry, &quot;Entry must have been generated by now&quot;);
  84   b(entry);
  85 }
  86 
  87 void InterpreterMacroAssembler::check_and_handle_popframe() {
  88   if (can_pop_frame()) {
  89     Label L;
  90     const Register popframe_cond = R2_tmp;
  91 
  92     // Initiate popframe handling only if it is not already being processed.  If the flag
  93     // has the popframe_processing bit set, it means that this code is called *during* popframe
  94     // handling - we don&#39;t want to reenter.
  95 
  96     ldr_s32(popframe_cond, Address(Rthread, JavaThread::popframe_condition_offset()));
  97     tbz(popframe_cond, exact_log2(JavaThread::popframe_pending_bit), L);
  98     tbnz(popframe_cond, exact_log2(JavaThread::popframe_processing_bit), L);
  99 
 100     // Call Interpreter::remove_activation_preserving_args_entry() to get the
 101     // address of the same-named entrypoint in the generated interpreter code.
 102     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_preserving_args_entry));
 103 
 104     // Call indirectly to avoid generation ordering problem.
 105     jump(R0);
 106 
 107     bind(L);
 108   }
 109 }
 110 
 111 
 112 // Blows R2, Rtemp. Sets TOS cached value.
 113 void InterpreterMacroAssembler::load_earlyret_value(TosState state) {
 114   const Register thread_state = R2_tmp;
 115 
 116   ldr(thread_state, Address(Rthread, JavaThread::jvmti_thread_state_offset()));
 117 
 118   const Address tos_addr(thread_state, JvmtiThreadState::earlyret_tos_offset());
 119   const Address oop_addr(thread_state, JvmtiThreadState::earlyret_oop_offset());
 120   const Address val_addr(thread_state, JvmtiThreadState::earlyret_value_offset());
 121   const Address val_addr_hi(thread_state, JvmtiThreadState::earlyret_value_offset()
 122                              + in_ByteSize(wordSize));
 123 
 124   Register zero = zero_register(Rtemp);
 125 
 126   switch (state) {
 127     case atos: ldr(R0_tos, oop_addr);
 128                str(zero, oop_addr);
 129                interp_verify_oop(R0_tos, state, __FILE__, __LINE__);
 130                break;
 131 
 132     case ltos: ldr(R1_tos_hi, val_addr_hi);        // fall through
 133     case btos:                                     // fall through
 134     case ztos:                                     // fall through
 135     case ctos:                                     // fall through
 136     case stos:                                     // fall through
 137     case itos: ldr_s32(R0_tos, val_addr);          break;
 138 #ifdef __SOFTFP__
 139     case dtos: ldr(R1_tos_hi, val_addr_hi);        // fall through
 140     case ftos: ldr(R0_tos, val_addr);              break;
 141 #else
 142     case ftos: ldr_float (S0_tos, val_addr);       break;
 143     case dtos: ldr_double(D0_tos, val_addr);       break;
 144 #endif // __SOFTFP__
 145     case vtos: /* nothing to do */                 break;
 146     default  : ShouldNotReachHere();
 147   }
 148   // Clean up tos value in the thread object
 149   str(zero, val_addr);
 150   str(zero, val_addr_hi);
 151 
 152   mov(Rtemp, (int) ilgl);
 153   str_32(Rtemp, tos_addr);
 154 }
 155 
 156 
 157 // Blows R2, Rtemp.
 158 void InterpreterMacroAssembler::check_and_handle_earlyret() {
 159   if (can_force_early_return()) {
 160     Label L;
 161     const Register thread_state = R2_tmp;
 162 
 163     ldr(thread_state, Address(Rthread, JavaThread::jvmti_thread_state_offset()));
 164     cbz(thread_state, L); // if (thread-&gt;jvmti_thread_state() == NULL) exit;
 165 
 166     // Initiate earlyret handling only if it is not already being processed.
 167     // If the flag has the earlyret_processing bit set, it means that this code
 168     // is called *during* earlyret handling - we don&#39;t want to reenter.
 169 
 170     ldr_s32(Rtemp, Address(thread_state, JvmtiThreadState::earlyret_state_offset()));
 171     cmp(Rtemp, JvmtiThreadState::earlyret_pending);
 172     b(L, ne);
 173 
 174     // Call Interpreter::remove_activation_early_entry() to get the address of the
 175     // same-named entrypoint in the generated interpreter code.
 176 
 177     ldr_s32(R0, Address(thread_state, JvmtiThreadState::earlyret_tos_offset()));
 178     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry), R0);
 179 
 180     jump(R0);
 181 
 182     bind(L);
 183   }
 184 }
 185 
 186 
 187 // Sets reg. Blows Rtemp.
 188 void InterpreterMacroAssembler::get_unsigned_2_byte_index_at_bcp(Register reg, int bcp_offset) {
 189   assert(bcp_offset &gt;= 0, &quot;bcp is still pointing to start of bytecode&quot;);
 190   assert(reg != Rtemp, &quot;should be different registers&quot;);
 191 
 192   ldrb(Rtemp, Address(Rbcp, bcp_offset));
 193   ldrb(reg, Address(Rbcp, bcp_offset+1));
 194   orr(reg, reg, AsmOperand(Rtemp, lsl, BitsPerByte));
 195 }
 196 
 197 void InterpreterMacroAssembler::get_index_at_bcp(Register index, int bcp_offset, Register tmp_reg, size_t index_size) {
 198   assert_different_registers(index, tmp_reg);
 199   if (index_size == sizeof(u2)) {
 200     // load bytes of index separately to avoid unaligned access
 201     ldrb(index, Address(Rbcp, bcp_offset+1));
 202     ldrb(tmp_reg, Address(Rbcp, bcp_offset));
 203     orr(index, tmp_reg, AsmOperand(index, lsl, BitsPerByte));
 204   } else if (index_size == sizeof(u4)) {
 205     ldrb(index, Address(Rbcp, bcp_offset+3));
 206     ldrb(tmp_reg, Address(Rbcp, bcp_offset+2));
 207     orr(index, tmp_reg, AsmOperand(index, lsl, BitsPerByte));
 208     ldrb(tmp_reg, Address(Rbcp, bcp_offset+1));
 209     orr(index, tmp_reg, AsmOperand(index, lsl, BitsPerByte));
 210     ldrb(tmp_reg, Address(Rbcp, bcp_offset));
 211     orr(index, tmp_reg, AsmOperand(index, lsl, BitsPerByte));
 212     // Check if the secondary index definition is still ~x, otherwise
 213     // we have to change the following assembler code to calculate the
 214     // plain index.
 215     assert(ConstantPool::decode_invokedynamic_index(~123) == 123, &quot;else change next line&quot;);
 216     mvn_32(index, index);  // convert to plain index
 217   } else if (index_size == sizeof(u1)) {
 218     ldrb(index, Address(Rbcp, bcp_offset));
 219   } else {
 220     ShouldNotReachHere();
 221   }
 222 }
 223 
 224 // Sets cache, index.
 225 void InterpreterMacroAssembler::get_cache_and_index_at_bcp(Register cache, Register index, int bcp_offset, size_t index_size) {
 226   assert(bcp_offset &gt; 0, &quot;bcp is still pointing to start of bytecode&quot;);
 227   assert_different_registers(cache, index);
 228 
 229   get_index_at_bcp(index, bcp_offset, cache, index_size);
 230 
 231   // load constant pool cache pointer
 232   ldr(cache, Address(FP, frame::interpreter_frame_cache_offset * wordSize));
 233 
 234   // convert from field index to ConstantPoolCacheEntry index
 235   assert(sizeof(ConstantPoolCacheEntry) == 4*wordSize, &quot;adjust code below&quot;);
 236   logical_shift_left(index, index, 2);
 237 }
 238 
 239 // Sets cache, index, bytecode.
 240 void InterpreterMacroAssembler::get_cache_and_index_and_bytecode_at_bcp(Register cache, Register index, Register bytecode, int byte_no, int bcp_offset, size_t index_size) {
 241   get_cache_and_index_at_bcp(cache, index, bcp_offset, index_size);
 242   // caution index and bytecode can be the same
 243   add(bytecode, cache, AsmOperand(index, lsl, LogBytesPerWord));
 244   ldrb(bytecode, Address(bytecode, (1 + byte_no) + in_bytes(ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::indices_offset())));
 245   TemplateTable::volatile_barrier(MacroAssembler::LoadLoad, noreg, true);
 246 }
 247 
 248 // Sets cache. Blows reg_tmp.
 249 void InterpreterMacroAssembler::get_cache_entry_pointer_at_bcp(Register cache, Register reg_tmp, int bcp_offset, size_t index_size) {
 250   assert(bcp_offset &gt; 0, &quot;bcp is still pointing to start of bytecode&quot;);
 251   assert_different_registers(cache, reg_tmp);
 252 
 253   get_index_at_bcp(reg_tmp, bcp_offset, cache, index_size);
 254 
 255   // load constant pool cache pointer
 256   ldr(cache, Address(FP, frame::interpreter_frame_cache_offset * wordSize));
 257 
 258   // skip past the header
 259   add(cache, cache, in_bytes(ConstantPoolCache::base_offset()));
 260   // convert from field index to ConstantPoolCacheEntry index
 261   // and from word offset to byte offset
 262   assert(sizeof(ConstantPoolCacheEntry) == 4*wordSize, &quot;adjust code below&quot;);
 263   add(cache, cache, AsmOperand(reg_tmp, lsl, 2 + LogBytesPerWord));
 264 }
 265 
 266 // Load object from cpool-&gt;resolved_references(index)
 267 void InterpreterMacroAssembler::load_resolved_reference_at_index(
 268                                            Register result, Register index) {
 269   assert_different_registers(result, index);
 270   get_constant_pool(result);
 271 
 272   Register cache = result;
 273   // load pointer for resolved_references[] objArray
 274   ldr(cache, Address(result, ConstantPool::cache_offset_in_bytes()));
 275   ldr(cache, Address(result, ConstantPoolCache::resolved_references_offset_in_bytes()));
 276   resolve_oop_handle(cache);
 277   // Add in the index
 278   // convert from field index to resolved_references() index and from
 279   // word index to byte offset. Since this is a java object, it can be compressed
 280   logical_shift_left(index, index, LogBytesPerHeapOop);
 281   add(index, index, arrayOopDesc::base_offset_in_bytes(T_OBJECT));
 282   load_heap_oop(result, Address(cache, index));
 283 }
 284 
 285 void InterpreterMacroAssembler::load_resolved_klass_at_offset(
 286                                            Register Rcpool, Register Rindex, Register Rklass) {
 287   add(Rtemp, Rcpool, AsmOperand(Rindex, lsl, LogBytesPerWord));
 288   ldrh(Rtemp, Address(Rtemp, sizeof(ConstantPool))); // Rtemp = resolved_klass_index
 289   ldr(Rklass, Address(Rcpool,  ConstantPool::resolved_klasses_offset_in_bytes())); // Rklass = cpool-&gt;_resolved_klasses
 290   add(Rklass, Rklass, AsmOperand(Rtemp, lsl, LogBytesPerWord));
 291   ldr(Rklass, Address(Rklass, Array&lt;Klass*&gt;::base_offset_in_bytes()));
 292 }
 293 
 294 // Generate a subtype check: branch to not_subtype if sub_klass is
 295 // not a subtype of super_klass.
 296 // Profiling code for the subtype check failure (profile_typecheck_failed)
 297 // should be explicitly generated by the caller in the not_subtype case.
 298 // Blows Rtemp, tmp1, tmp2.
 299 void InterpreterMacroAssembler::gen_subtype_check(Register Rsub_klass,
 300                                                   Register Rsuper_klass,
 301                                                   Label &amp;not_subtype,
 302                                                   Register tmp1,
 303                                                   Register tmp2) {
 304 
 305   assert_different_registers(Rsub_klass, Rsuper_klass, tmp1, tmp2, Rtemp);
 306   Label ok_is_subtype, loop, update_cache;
 307 
 308   const Register super_check_offset = tmp1;
 309   const Register cached_super = tmp2;
 310 
 311   // Profile the not-null value&#39;s klass.
 312   profile_typecheck(tmp1, Rsub_klass);
 313 
 314   // Load the super-klass&#39;s check offset into
 315   ldr_u32(super_check_offset, Address(Rsuper_klass, Klass::super_check_offset_offset()));
 316 
 317   // Check for self
 318   cmp(Rsub_klass, Rsuper_klass);
 319 
 320   // Load from the sub-klass&#39;s super-class display list, or a 1-word cache of
 321   // the secondary superclass list, or a failing value with a sentinel offset
 322   // if the super-klass is an interface or exceptionally deep in the Java
 323   // hierarchy and we have to scan the secondary superclass list the hard way.
 324   // See if we get an immediate positive hit
 325   ldr(cached_super, Address(Rsub_klass, super_check_offset));
 326 
 327   cond_cmp(Rsuper_klass, cached_super, ne);
 328   b(ok_is_subtype, eq);
 329 
 330   // Check for immediate negative hit
 331   cmp(super_check_offset, in_bytes(Klass::secondary_super_cache_offset()));
 332   b(not_subtype, ne);
 333 
 334   // Now do a linear scan of the secondary super-klass chain.
 335   const Register supers_arr = tmp1;
 336   const Register supers_cnt = tmp2;
 337   const Register cur_super  = Rtemp;
 338 
 339   // Load objArrayOop of secondary supers.
 340   ldr(supers_arr, Address(Rsub_klass, Klass::secondary_supers_offset()));
 341 
 342   ldr_u32(supers_cnt, Address(supers_arr, Array&lt;Klass*&gt;::length_offset_in_bytes())); // Load the array length
 343   cmp(supers_cnt, 0);
 344 
 345   // Skip to the start of array elements and prefetch the first super-klass.
 346   ldr(cur_super, Address(supers_arr, Array&lt;Klass*&gt;::base_offset_in_bytes(), pre_indexed), ne);
 347   b(not_subtype, eq);
 348 
 349   bind(loop);
 350 
 351 
 352   cmp(cur_super, Rsuper_klass);
 353   b(update_cache, eq);
 354 
 355   subs(supers_cnt, supers_cnt, 1);
 356 
 357   ldr(cur_super, Address(supers_arr, wordSize, pre_indexed), ne);
 358 
 359   b(loop, ne);
 360 
 361   b(not_subtype);
 362 
 363   bind(update_cache);
 364   // Must be equal but missed in cache.  Update cache.
 365   str(Rsuper_klass, Address(Rsub_klass, Klass::secondary_super_cache_offset()));
 366 
 367   bind(ok_is_subtype);
 368 }
 369 
 370 
 371 //////////////////////////////////////////////////////////////////////////////////
 372 
 373 
 374 // Java Expression Stack
 375 
 376 void InterpreterMacroAssembler::pop_ptr(Register r) {
 377   assert(r != Rstack_top, &quot;unpredictable instruction&quot;);
 378   ldr(r, Address(Rstack_top, wordSize, post_indexed));
 379 }
 380 
 381 void InterpreterMacroAssembler::pop_i(Register r) {
 382   assert(r != Rstack_top, &quot;unpredictable instruction&quot;);
 383   ldr_s32(r, Address(Rstack_top, wordSize, post_indexed));
 384   zap_high_non_significant_bits(r);
 385 }
 386 
 387 void InterpreterMacroAssembler::pop_l(Register lo, Register hi) {
 388   assert_different_registers(lo, hi);
 389   assert(lo &lt; hi, &quot;lo must be &lt; hi&quot;);
 390   pop(RegisterSet(lo) | RegisterSet(hi));
 391 }
 392 
 393 void InterpreterMacroAssembler::pop_f(FloatRegister fd) {
 394   fpops(fd);
 395 }
 396 
 397 void InterpreterMacroAssembler::pop_d(FloatRegister fd) {
 398   fpopd(fd);
 399 }
 400 
 401 
 402 // Transition vtos -&gt; state. Blows R0, R1. Sets TOS cached value.
 403 void InterpreterMacroAssembler::pop(TosState state) {
 404   switch (state) {
 405     case atos: pop_ptr(R0_tos);                              break;
 406     case btos:                                               // fall through
 407     case ztos:                                               // fall through
 408     case ctos:                                               // fall through
 409     case stos:                                               // fall through
 410     case itos: pop_i(R0_tos);                                break;
 411     case ltos: pop_l(R0_tos_lo, R1_tos_hi);                  break;
 412 #ifdef __SOFTFP__
 413     case ftos: pop_i(R0_tos);                                break;
 414     case dtos: pop_l(R0_tos_lo, R1_tos_hi);                  break;
 415 #else
 416     case ftos: pop_f(S0_tos);                                break;
 417     case dtos: pop_d(D0_tos);                                break;
 418 #endif // __SOFTFP__
 419     case vtos: /* nothing to do */                           break;
 420     default  : ShouldNotReachHere();
 421   }
 422   interp_verify_oop(R0_tos, state, __FILE__, __LINE__);
 423 }
 424 
 425 void InterpreterMacroAssembler::push_ptr(Register r) {
 426   assert(r != Rstack_top, &quot;unpredictable instruction&quot;);
 427   str(r, Address(Rstack_top, -wordSize, pre_indexed));
 428   check_stack_top_on_expansion();
 429 }
 430 
 431 void InterpreterMacroAssembler::push_i(Register r) {
 432   assert(r != Rstack_top, &quot;unpredictable instruction&quot;);
 433   str_32(r, Address(Rstack_top, -wordSize, pre_indexed));
 434   check_stack_top_on_expansion();
 435 }
 436 
 437 void InterpreterMacroAssembler::push_l(Register lo, Register hi) {
 438   assert_different_registers(lo, hi);
 439   assert(lo &lt; hi, &quot;lo must be &lt; hi&quot;);
 440   push(RegisterSet(lo) | RegisterSet(hi));
 441 }
 442 
 443 void InterpreterMacroAssembler::push_f() {
 444   fpushs(S0_tos);
 445 }
 446 
 447 void InterpreterMacroAssembler::push_d() {
 448   fpushd(D0_tos);
 449 }
 450 
 451 // Transition state -&gt; vtos. Blows Rtemp.
 452 void InterpreterMacroAssembler::push(TosState state) {
 453   interp_verify_oop(R0_tos, state, __FILE__, __LINE__);
 454   switch (state) {
 455     case atos: push_ptr(R0_tos);                              break;
 456     case btos:                                                // fall through
 457     case ztos:                                                // fall through
 458     case ctos:                                                // fall through
 459     case stos:                                                // fall through
 460     case itos: push_i(R0_tos);                                break;
 461     case ltos: push_l(R0_tos_lo, R1_tos_hi);                  break;
 462 #ifdef __SOFTFP__
 463     case ftos: push_i(R0_tos);                                break;
 464     case dtos: push_l(R0_tos_lo, R1_tos_hi);                  break;
 465 #else
 466     case ftos: push_f();                                      break;
 467     case dtos: push_d();                                      break;
 468 #endif // __SOFTFP__
 469     case vtos: /* nothing to do */                            break;
 470     default  : ShouldNotReachHere();
 471   }
 472 }
 473 
 474 
 475 
 476 // Converts return value in R0/R1 (interpreter calling conventions) to TOS cached value.
 477 void InterpreterMacroAssembler::convert_retval_to_tos(TosState state) {
 478 #if (!defined __SOFTFP__ &amp;&amp; !defined __ABI_HARD__)
 479   // According to interpreter calling conventions, result is returned in R0/R1,
 480   // but templates expect ftos in S0, and dtos in D0.
 481   if (state == ftos) {
 482     fmsr(S0_tos, R0);
 483   } else if (state == dtos) {
 484     fmdrr(D0_tos, R0, R1);
 485   }
 486 #endif // !__SOFTFP__ &amp;&amp; !__ABI_HARD__
 487 }
 488 
 489 // Converts TOS cached value to return value in R0/R1 (according to interpreter calling conventions).
 490 void InterpreterMacroAssembler::convert_tos_to_retval(TosState state) {
 491 #if (!defined __SOFTFP__ &amp;&amp; !defined __ABI_HARD__)
 492   // According to interpreter calling conventions, result is returned in R0/R1,
 493   // so ftos (S0) and dtos (D0) are moved to R0/R1.
 494   if (state == ftos) {
 495     fmrs(R0, S0_tos);
 496   } else if (state == dtos) {
 497     fmrrd(R0, R1, D0_tos);
 498   }
 499 #endif // !__SOFTFP__ &amp;&amp; !__ABI_HARD__
 500 }
 501 
 502 
 503 
 504 // Helpers for swap and dup
 505 void InterpreterMacroAssembler::load_ptr(int n, Register val) {
 506   ldr(val, Address(Rstack_top, Interpreter::expr_offset_in_bytes(n)));
 507 }
 508 
 509 void InterpreterMacroAssembler::store_ptr(int n, Register val) {
 510   str(val, Address(Rstack_top, Interpreter::expr_offset_in_bytes(n)));
 511 }
 512 
 513 
 514 void InterpreterMacroAssembler::prepare_to_jump_from_interpreted() {
 515 
 516   // set sender sp
 517   mov(Rsender_sp, SP);
 518 
 519   // record last_sp
 520   str(Rsender_sp, Address(FP, frame::interpreter_frame_last_sp_offset * wordSize));
 521 }
 522 
 523 // Jump to from_interpreted entry of a call unless single stepping is possible
 524 // in this thread in which case we must call the i2i entry
 525 void InterpreterMacroAssembler::jump_from_interpreted(Register method) {
 526   assert_different_registers(method, Rtemp);
 527 
 528   prepare_to_jump_from_interpreted();
 529 
 530   if (can_post_interpreter_events()) {
 531     // JVMTI events, such as single-stepping, are implemented partly by avoiding running
 532     // compiled code in threads for which the event is enabled.  Check here for
 533     // interp_only_mode if these events CAN be enabled.
 534 
 535     ldr_s32(Rtemp, Address(Rthread, JavaThread::interp_only_mode_offset()));
 536     cmp(Rtemp, 0);
 537     ldr(PC, Address(method, Method::interpreter_entry_offset()), ne);
 538   }
 539 
 540   indirect_jump(Address(method, Method::from_interpreted_offset()), Rtemp);
 541 }
 542 
 543 
 544 void InterpreterMacroAssembler::restore_dispatch() {
 545   mov_slow(RdispatchTable, (address)Interpreter::dispatch_table(vtos));
 546 }
 547 
 548 
 549 // The following two routines provide a hook so that an implementation
 550 // can schedule the dispatch in two parts.
 551 void InterpreterMacroAssembler::dispatch_prolog(TosState state, int step) {
 552   // Nothing ARM-specific to be done here.
 553 }
 554 
 555 void InterpreterMacroAssembler::dispatch_epilog(TosState state, int step) {
 556   dispatch_next(state, step);
 557 }
 558 
 559 void InterpreterMacroAssembler::dispatch_base(TosState state,
 560                                               DispatchTableMode table_mode,
 561                                               bool verifyoop, bool generate_poll) {
 562   if (VerifyActivationFrameSize) {
 563     Label L;
 564     sub(Rtemp, FP, SP);
 565     int min_frame_size = (frame::link_offset - frame::interpreter_frame_initial_sp_offset) * wordSize;
 566     cmp(Rtemp, min_frame_size);
 567     b(L, ge);
 568     stop(&quot;broken stack frame&quot;);
 569     bind(L);
 570   }
 571 
 572   if (verifyoop) {
 573     interp_verify_oop(R0_tos, state, __FILE__, __LINE__);
 574   }
 575 
 576   Label safepoint;
 577   address* const safepoint_table = Interpreter::safept_table(state);
 578   address* const table           = Interpreter::dispatch_table(state);
 579   bool needs_thread_local_poll = generate_poll &amp;&amp;
 580     SafepointMechanism::uses_thread_local_poll() &amp;&amp; table != safepoint_table;
 581 
 582   if (needs_thread_local_poll) {
 583     NOT_PRODUCT(block_comment(&quot;Thread-local Safepoint poll&quot;));
 584     ldr(Rtemp, Address(Rthread, Thread::polling_page_offset()));
 585     tbnz(Rtemp, exact_log2(SafepointMechanism::poll_bit()), safepoint);
 586   }
 587 
 588   if((state == itos) || (state == btos) || (state == ztos) || (state == ctos) || (state == stos)) {
 589     zap_high_non_significant_bits(R0_tos);
 590   }
 591 
 592 #ifdef ASSERT
 593   Label L;
 594   mov_slow(Rtemp, (address)Interpreter::dispatch_table(vtos));
 595   cmp(Rtemp, RdispatchTable);
 596   b(L, eq);
 597   stop(&quot;invalid RdispatchTable&quot;);
 598   bind(L);
 599 #endif
 600 
 601   if (table_mode == DispatchDefault) {
 602     if (state == vtos) {
 603       indirect_jump(Address::indexed_ptr(RdispatchTable, R3_bytecode), Rtemp);
 604     } else {
 605       // on 32-bit ARM this method is faster than the one above.
 606       sub(Rtemp, RdispatchTable, (Interpreter::distance_from_dispatch_table(vtos) -
 607                            Interpreter::distance_from_dispatch_table(state)) * wordSize);
 608       indirect_jump(Address::indexed_ptr(Rtemp, R3_bytecode), Rtemp);
 609     }
 610   } else {
 611     assert(table_mode == DispatchNormal, &quot;invalid dispatch table mode&quot;);
 612     address table = (address) Interpreter::normal_table(state);
 613     mov_slow(Rtemp, table);
 614     indirect_jump(Address::indexed_ptr(Rtemp, R3_bytecode), Rtemp);
 615   }
 616 
 617   if (needs_thread_local_poll) {
 618     bind(safepoint);
 619     lea(Rtemp, ExternalAddress((address)safepoint_table));
 620     indirect_jump(Address::indexed_ptr(Rtemp, R3_bytecode), Rtemp);
 621   }
 622 
 623   nop(); // to avoid filling CPU pipeline with invalid instructions
 624   nop();
 625 }
 626 
 627 void InterpreterMacroAssembler::dispatch_only(TosState state, bool generate_poll) {
 628   dispatch_base(state, DispatchDefault, true, generate_poll);
 629 }
 630 
 631 
 632 void InterpreterMacroAssembler::dispatch_only_normal(TosState state) {
 633   dispatch_base(state, DispatchNormal);
 634 }
 635 
 636 void InterpreterMacroAssembler::dispatch_only_noverify(TosState state) {
 637   dispatch_base(state, DispatchNormal, false);
 638 }
 639 
 640 void InterpreterMacroAssembler::dispatch_next(TosState state, int step, bool generate_poll) {
 641   // load next bytecode and advance Rbcp
 642   ldrb(R3_bytecode, Address(Rbcp, step, pre_indexed));
 643   dispatch_base(state, DispatchDefault, true, generate_poll);
 644 }
 645 
 646 void InterpreterMacroAssembler::narrow(Register result) {
 647   // mask integer result to narrower return type.
 648   const Register Rtmp = R2;
 649 
 650   // get method type
 651   ldr(Rtmp, Address(Rmethod, Method::const_offset()));
 652   ldrb(Rtmp, Address(Rtmp, ConstMethod::result_type_offset()));
 653 
 654   Label notBool, notByte, notChar, done;
 655   cmp(Rtmp, T_INT);
 656   b(done, eq);
 657 
 658   cmp(Rtmp, T_BOOLEAN);
 659   b(notBool, ne);
 660   and_32(result, result, 1);
 661   b(done);
 662 
 663   bind(notBool);
 664   cmp(Rtmp, T_BYTE);
 665   b(notByte, ne);
 666   sign_extend(result, result, 8);
 667   b(done);
 668 
 669   bind(notByte);
 670   cmp(Rtmp, T_CHAR);
 671   b(notChar, ne);
 672   zero_extend(result, result, 16);
 673   b(done);
 674 
 675   bind(notChar);
 676   // cmp(Rtmp, T_SHORT);
 677   // b(done, ne);
 678   sign_extend(result, result, 16);
 679 
 680   // Nothing to do
 681   bind(done);
 682 }
 683 
 684 // remove activation
 685 //
 686 // Unlock the receiver if this is a synchronized method.
 687 // Unlock any Java monitors from syncronized blocks.
 688 // Remove the activation from the stack.
 689 //
 690 // If there are locked Java monitors
 691 //    If throw_monitor_exception
 692 //       throws IllegalMonitorStateException
 693 //    Else if install_monitor_exception
 694 //       installs IllegalMonitorStateException
 695 //    Else
 696 //       no error processing
 697 void InterpreterMacroAssembler::remove_activation(TosState state, Register ret_addr,
 698                                                   bool throw_monitor_exception,
 699                                                   bool install_monitor_exception,
 700                                                   bool notify_jvmdi) {
 701   Label unlock, unlocked, no_unlock;
 702 
 703   // Note: Registers R0, R1, S0 and D0 (TOS cached value) may be in use for the result.
 704 
 705   const Address do_not_unlock_if_synchronized(Rthread,
 706                          JavaThread::do_not_unlock_if_synchronized_offset());
 707 
 708   const Register Rflag = R2;
 709   const Register Raccess_flags = R3;
 710 
 711   restore_method();
 712 
 713   ldrb(Rflag, do_not_unlock_if_synchronized);
 714 
 715   // get method access flags
 716   ldr_u32(Raccess_flags, Address(Rmethod, Method::access_flags_offset()));
 717 
 718   strb(zero_register(Rtemp), do_not_unlock_if_synchronized); // reset the flag
 719 
 720   // check if method is synchronized
 721 
 722   tbz(Raccess_flags, JVM_ACC_SYNCHRONIZED_BIT, unlocked);
 723 
 724   // Don&#39;t unlock anything if the _do_not_unlock_if_synchronized flag is set.
 725   cbnz(Rflag, no_unlock);
 726 
 727   // unlock monitor
 728   push(state);                                   // save result
 729 
 730   // BasicObjectLock will be first in list, since this is a synchronized method. However, need
 731   // to check that the object has not been unlocked by an explicit monitorexit bytecode.
 732 
 733   const Register Rmonitor = R1;                  // fixed in unlock_object()
 734   const Register Robj = R2;
 735 
 736   // address of first monitor
 737   sub(Rmonitor, FP, - frame::interpreter_frame_monitor_block_bottom_offset * wordSize + (int)sizeof(BasicObjectLock));
 738 
 739   ldr(Robj, Address(Rmonitor, BasicObjectLock::obj_offset_in_bytes()));
 740   cbnz(Robj, unlock);
 741 
 742   pop(state);
 743 
 744   if (throw_monitor_exception) {
 745     // Entry already unlocked, need to throw exception
 746     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_illegal_monitor_state_exception));
 747     should_not_reach_here();
 748   } else {
 749     // Monitor already unlocked during a stack unroll.
 750     // If requested, install an illegal_monitor_state_exception.
 751     // Continue with stack unrolling.
 752     if (install_monitor_exception) {
 753       call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::new_illegal_monitor_state_exception));
 754     }
 755     b(unlocked);
 756   }
 757 
 758 
 759   // Exception case for the check that all monitors are unlocked.
 760   const Register Rcur = R2;
 761   Label restart_check_monitors_unlocked, exception_monitor_is_still_locked;
 762 
 763   bind(exception_monitor_is_still_locked);
 764   // Monitor entry is still locked, need to throw exception.
 765   // Rcur: monitor entry.
 766 
 767   if (throw_monitor_exception) {
 768     // Throw exception
 769     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_illegal_monitor_state_exception));
 770     should_not_reach_here();
 771   } else {
 772     // Stack unrolling. Unlock object and install illegal_monitor_exception
 773     // Unlock does not block, so don&#39;t have to worry about the frame
 774 
 775     push(state);
 776     mov(R1, Rcur);
 777     unlock_object(R1);
 778 
 779     if (install_monitor_exception) {
 780       call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::new_illegal_monitor_state_exception));
 781     }
 782 
 783     pop(state);
 784     b(restart_check_monitors_unlocked);
 785   }
 786 
 787   bind(unlock);
 788   unlock_object(Rmonitor);
 789   pop(state);
 790 
 791   // Check that for block-structured locking (i.e., that all locked objects has been unlocked)
 792   bind(unlocked);
 793 
 794   // Check that all monitors are unlocked
 795   {
 796     Label loop;
 797 
 798     const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
 799     const Register Rbottom = R3;
 800     const Register Rcur_obj = Rtemp;
 801 
 802     bind(restart_check_monitors_unlocked);
 803 
 804     ldr(Rcur, Address(FP, frame::interpreter_frame_monitor_block_top_offset * wordSize));
 805                                  // points to current entry, starting with top-most entry
 806     sub(Rbottom, FP, -frame::interpreter_frame_monitor_block_bottom_offset * wordSize);
 807                                  // points to word before bottom of monitor block
 808 
 809     cmp(Rcur, Rbottom);          // check if there are no monitors
 810     ldr(Rcur_obj, Address(Rcur, BasicObjectLock::obj_offset_in_bytes()), ne);
 811                                  // prefetch monitor&#39;s object
 812     b(no_unlock, eq);
 813 
 814     bind(loop);
 815     // check if current entry is used
 816     cbnz(Rcur_obj, exception_monitor_is_still_locked);
 817 
 818     add(Rcur, Rcur, entry_size);      // otherwise advance to next entry
 819     cmp(Rcur, Rbottom);               // check if bottom reached
 820     ldr(Rcur_obj, Address(Rcur, BasicObjectLock::obj_offset_in_bytes()), ne);
 821                                       // prefetch monitor&#39;s object
 822     b(loop, ne);                      // if not at bottom then check this entry
 823   }
 824 
 825   bind(no_unlock);
 826 
 827   // jvmti support
 828   if (notify_jvmdi) {
 829     notify_method_exit(state, NotifyJVMTI);     // preserve TOSCA
 830   } else {
 831     notify_method_exit(state, SkipNotifyJVMTI); // preserve TOSCA
 832   }
 833 
 834   // remove activation
 835   mov(Rtemp, FP);
 836   ldmia(FP, RegisterSet(FP) | RegisterSet(LR));
 837   ldr(SP, Address(Rtemp, frame::interpreter_frame_sender_sp_offset * wordSize));
 838 
 839   if (ret_addr != LR) {
 840     mov(ret_addr, LR);
 841   }
 842 }
 843 
 844 
 845 // At certain points in the method invocation the monitor of
 846 // synchronized methods hasn&#39;t been entered yet.
 847 // To correctly handle exceptions at these points, we set the thread local
 848 // variable _do_not_unlock_if_synchronized to true. The remove_activation will
 849 // check this flag.
 850 void InterpreterMacroAssembler::set_do_not_unlock_if_synchronized(bool flag, Register tmp) {
 851   const Address do_not_unlock_if_synchronized(Rthread,
 852                          JavaThread::do_not_unlock_if_synchronized_offset());
 853   if (flag) {
 854     mov(tmp, 1);
 855     strb(tmp, do_not_unlock_if_synchronized);
 856   } else {
 857     strb(zero_register(tmp), do_not_unlock_if_synchronized);
 858   }
 859 }
 860 
 861 // Lock object
 862 //
 863 // Argument: R1 : Points to BasicObjectLock to be used for locking.
 864 // Must be initialized with object to lock.
 865 // Blows volatile registers R0-R3, Rtemp, LR. Calls VM.
 866 void InterpreterMacroAssembler::lock_object(Register Rlock) {
 867   assert(Rlock == R1, &quot;the second argument&quot;);
 868 
 869   if (UseHeavyMonitors) {
 870     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter), Rlock);
 871   } else {
 872     Label done;
 873 
 874     const Register Robj = R2;
 875     const Register Rmark = R3;
 876     assert_different_registers(Robj, Rmark, Rlock, R0, Rtemp);
 877 
 878     const int obj_offset = BasicObjectLock::obj_offset_in_bytes();
 879     const int lock_offset = BasicObjectLock::lock_offset_in_bytes ();
 880     const int mark_offset = lock_offset + BasicLock::displaced_header_offset_in_bytes();
 881 
 882     Label already_locked, slow_case;
 883 
 884     // Load object pointer
 885     ldr(Robj, Address(Rlock, obj_offset));
 886 
 887     if (UseBiasedLocking) {
 888       biased_locking_enter(Robj, Rmark/*scratched*/, R0, false, Rtemp, done, slow_case);
 889     }
 890 
 891 
 892     // On MP platforms the next load could return a &#39;stale&#39; value if the memory location has been modified by another thread.
 893     // That would be acceptable as ether CAS or slow case path is taken in that case.
 894     // Exception to that is if the object is locked by the calling thread, then the recursive test will pass (guaranteed as
 895     // loads are satisfied from a store queue if performed on the same processor).
 896 
 897     assert(oopDesc::mark_offset_in_bytes() == 0, &quot;must be&quot;);
 898     ldr(Rmark, Address(Robj, oopDesc::mark_offset_in_bytes()));
 899 
 900     // Test if object is already locked
 901     tst(Rmark, markWord::unlocked_value);
 902     b(already_locked, eq);
 903 
 904     // Save old object-&gt;mark() into BasicLock&#39;s displaced header
 905     str(Rmark, Address(Rlock, mark_offset));
 906 
 907     cas_for_lock_acquire(Rmark, Rlock, Robj, Rtemp, slow_case);
 908 
 909 #ifndef PRODUCT
 910     if (PrintBiasedLockingStatistics) {
 911       cond_atomic_inc32(al, BiasedLocking::fast_path_entry_count_addr());
 912     }
 913 #endif //!PRODUCT
 914 
 915     b(done);
 916 
 917     // If we got here that means the object is locked by ether calling thread or another thread.
 918     bind(already_locked);
 919     // Handling of locked objects: recursive locks and slow case.
 920 
 921     // Fast check for recursive lock.
 922     //
 923     // Can apply the optimization only if this is a stack lock
 924     // allocated in this thread. For efficiency, we can focus on
 925     // recently allocated stack locks (instead of reading the stack
 926     // base and checking whether &#39;mark&#39; points inside the current
 927     // thread stack):
 928     //  1) (mark &amp; 3) == 0
 929     //  2) SP &lt;= mark &lt; SP + os::pagesize()
 930     //
 931     // Warning: SP + os::pagesize can overflow the stack base. We must
 932     // neither apply the optimization for an inflated lock allocated
 933     // just above the thread stack (this is why condition 1 matters)
 934     // nor apply the optimization if the stack lock is inside the stack
 935     // of another thread. The latter is avoided even in case of overflow
 936     // because we have guard pages at the end of all stacks. Hence, if
 937     // we go over the stack base and hit the stack of another thread,
 938     // this should not be in a writeable area that could contain a
 939     // stack lock allocated by that thread. As a consequence, a stack
 940     // lock less than page size away from SP is guaranteed to be
 941     // owned by the current thread.
 942     //
 943     // Note: assuming SP is aligned, we can check the low bits of
 944     // (mark-SP) instead of the low bits of mark. In that case,
 945     // assuming page size is a power of 2, we can merge the two
 946     // conditions into a single test:
 947     // =&gt; ((mark - SP) &amp; (3 - os::pagesize())) == 0
 948 
 949     // (3 - os::pagesize()) cannot be encoded as an ARM immediate operand.
 950     // Check independently the low bits and the distance to SP.
 951     // -1- test low 2 bits
 952     movs(R0, AsmOperand(Rmark, lsl, 30));
 953     // -2- test (mark - SP) if the low two bits are 0
 954     sub(R0, Rmark, SP, eq);
 955     movs(R0, AsmOperand(R0, lsr, exact_log2(os::vm_page_size())), eq);
 956     // If still &#39;eq&#39; then recursive locking OK: store 0 into lock record
 957     str(R0, Address(Rlock, mark_offset), eq);
 958 
 959 
 960 #ifndef PRODUCT
 961     if (PrintBiasedLockingStatistics) {
 962       cond_atomic_inc32(eq, BiasedLocking::fast_path_entry_count_addr());
 963     }
 964 #endif // !PRODUCT
 965 
 966     b(done, eq);
 967 
 968     bind(slow_case);
 969 
 970     // Call the runtime routine for slow case
 971     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter), Rlock);
 972 
 973     bind(done);
 974   }
 975 }
 976 
 977 
 978 // Unlocks an object. Used in monitorexit bytecode and remove_activation.
 979 //
 980 // Argument: R1: Points to BasicObjectLock structure for lock
 981 // Throw an IllegalMonitorException if object is not locked by current thread
 982 // Blows volatile registers R0-R3, Rtemp, LR. Calls VM.
 983 void InterpreterMacroAssembler::unlock_object(Register Rlock) {
 984   assert(Rlock == R1, &quot;the second argument&quot;);
 985 
 986   if (UseHeavyMonitors) {
 987     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit), Rlock);
 988   } else {
 989     Label done, slow_case;
 990 
 991     const Register Robj = R2;
 992     const Register Rmark = R3;
 993     const Register Rresult = R0;
 994     assert_different_registers(Robj, Rmark, Rlock, R0, Rtemp);
 995 
 996     const int obj_offset = BasicObjectLock::obj_offset_in_bytes();
 997     const int lock_offset = BasicObjectLock::lock_offset_in_bytes ();
 998     const int mark_offset = lock_offset + BasicLock::displaced_header_offset_in_bytes();
 999 
1000     const Register Rzero = zero_register(Rtemp);
1001 
1002     // Load oop into Robj
1003     ldr(Robj, Address(Rlock, obj_offset));
1004 
1005     // Free entry
1006     str(Rzero, Address(Rlock, obj_offset));
1007 
1008     if (UseBiasedLocking) {
1009       biased_locking_exit(Robj, Rmark, done);
1010     }
1011 
1012     // Load the old header from BasicLock structure
1013     ldr(Rmark, Address(Rlock, mark_offset));
1014 
1015     // Test for recursion (zero mark in BasicLock)
1016     cbz(Rmark, done);
1017 
1018     bool allow_fallthrough_on_failure = true;
1019 
1020     cas_for_lock_release(Rlock, Rmark, Robj, Rtemp, slow_case, allow_fallthrough_on_failure);
1021 
1022     b(done, eq);
1023 
1024     bind(slow_case);
1025 
1026     // Call the runtime routine for slow case.
1027     str(Robj, Address(Rlock, obj_offset)); // restore obj
1028     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit), Rlock);
1029 
1030     bind(done);
1031   }
1032 }
1033 
1034 
1035 // Test ImethodDataPtr.  If it is null, continue at the specified label
1036 void InterpreterMacroAssembler::test_method_data_pointer(Register mdp, Label&amp; zero_continue) {
1037   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1038   ldr(mdp, Address(FP, frame::interpreter_frame_mdp_offset * wordSize));
1039   cbz(mdp, zero_continue);
1040 }
1041 
1042 
1043 // Set the method data pointer for the current bcp.
1044 // Blows volatile registers R0-R3, Rtemp, LR.
1045 void InterpreterMacroAssembler::set_method_data_pointer_for_bcp() {
1046   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1047   Label set_mdp;
1048 
1049   // Test MDO to avoid the call if it is NULL.
1050   ldr(Rtemp, Address(Rmethod, Method::method_data_offset()));
1051   cbz(Rtemp, set_mdp);
1052 
1053   mov(R0, Rmethod);
1054   mov(R1, Rbcp);
1055   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::bcp_to_di), R0, R1);
1056   // R0/W0: mdi
1057 
1058   // mdo is guaranteed to be non-zero here, we checked for it before the call.
1059   ldr(Rtemp, Address(Rmethod, Method::method_data_offset()));
1060   add(Rtemp, Rtemp, in_bytes(MethodData::data_offset()));
1061   add_ptr_scaled_int32(Rtemp, Rtemp, R0, 0);
1062 
1063   bind(set_mdp);
1064   str(Rtemp, Address(FP, frame::interpreter_frame_mdp_offset * wordSize));
1065 }
1066 
1067 
1068 void InterpreterMacroAssembler::verify_method_data_pointer() {
1069   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1070 #ifdef ASSERT
1071   Label verify_continue;
1072   save_caller_save_registers();
1073 
1074   const Register Rmdp = R2;
1075   test_method_data_pointer(Rmdp, verify_continue); // If mdp is zero, continue
1076 
1077   // If the mdp is valid, it will point to a DataLayout header which is
1078   // consistent with the bcp.  The converse is highly probable also.
1079 
1080   ldrh(R3, Address(Rmdp, DataLayout::bci_offset()));
1081   ldr(Rtemp, Address(Rmethod, Method::const_offset()));
1082   add(R3, R3, Rtemp);
1083   add(R3, R3, in_bytes(ConstMethod::codes_offset()));
1084   cmp(R3, Rbcp);
1085   b(verify_continue, eq);
1086 
1087   mov(R0, Rmethod);
1088   mov(R1, Rbcp);
1089   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::verify_mdp), R0, R1, Rmdp);
1090 
1091   bind(verify_continue);
1092   restore_caller_save_registers();
1093 #endif // ASSERT
1094 }
1095 
1096 
1097 void InterpreterMacroAssembler::set_mdp_data_at(Register mdp_in, int offset, Register value) {
1098   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1099   assert_different_registers(mdp_in, value);
1100   str(value, Address(mdp_in, offset));
1101 }
1102 
1103 
1104 // Increments mdp data. Sets bumped_count register to adjusted counter.
1105 void InterpreterMacroAssembler::increment_mdp_data_at(Register mdp_in,
1106                                                       int offset,
1107                                                       Register bumped_count,
1108                                                       bool decrement) {
1109   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1110 
1111   // Counter address
1112   Address data(mdp_in, offset);
1113   assert_different_registers(mdp_in, bumped_count);
1114 
1115   increment_mdp_data_at(data, bumped_count, decrement);
1116 }
1117 
1118 void InterpreterMacroAssembler::set_mdp_flag_at(Register mdp_in, int flag_byte_constant) {
1119   assert_different_registers(mdp_in, Rtemp);
1120   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1121   assert((0 &lt; flag_byte_constant) &amp;&amp; (flag_byte_constant &lt; (1 &lt;&lt; BitsPerByte)), &quot;flag mask is out of range&quot;);
1122 
1123   // Set the flag
1124   ldrb(Rtemp, Address(mdp_in, in_bytes(DataLayout::flags_offset())));
1125   orr(Rtemp, Rtemp, (unsigned)flag_byte_constant);
1126   strb(Rtemp, Address(mdp_in, in_bytes(DataLayout::flags_offset())));
1127 }
1128 
1129 
1130 // Increments mdp data. Sets bumped_count register to adjusted counter.
1131 void InterpreterMacroAssembler::increment_mdp_data_at(Address data,
1132                                                       Register bumped_count,
1133                                                       bool decrement) {
1134   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1135 
1136   ldr(bumped_count, data);
1137   if (decrement) {
1138     // Decrement the register. Set condition codes.
1139     subs(bumped_count, bumped_count, DataLayout::counter_increment);
1140     // Avoid overflow.
1141     add(bumped_count, bumped_count, DataLayout::counter_increment, pl);
1142   } else {
1143     // Increment the register. Set condition codes.
1144     adds(bumped_count, bumped_count, DataLayout::counter_increment);
1145     // Avoid overflow.
1146     sub(bumped_count, bumped_count, DataLayout::counter_increment, mi);
1147   }
1148   str(bumped_count, data);
1149 }
1150 
1151 
1152 void InterpreterMacroAssembler::test_mdp_data_at(Register mdp_in,
1153                                                  int offset,
1154                                                  Register value,
1155                                                  Register test_value_out,
1156                                                  Label&amp; not_equal_continue) {
1157   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1158   assert_different_registers(mdp_in, test_value_out, value);
1159 
1160   ldr(test_value_out, Address(mdp_in, offset));
1161   cmp(test_value_out, value);
1162 
1163   b(not_equal_continue, ne);
1164 }
1165 
1166 
1167 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in, int offset_of_disp, Register reg_temp) {
1168   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1169   assert_different_registers(mdp_in, reg_temp);
1170 
1171   ldr(reg_temp, Address(mdp_in, offset_of_disp));
1172   add(mdp_in, mdp_in, reg_temp);
1173   str(mdp_in, Address(FP, frame::interpreter_frame_mdp_offset * wordSize));
1174 }
1175 
1176 
1177 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in, Register reg_offset, Register reg_tmp) {
1178   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1179   assert_different_registers(mdp_in, reg_offset, reg_tmp);
1180 
1181   ldr(reg_tmp, Address(mdp_in, reg_offset));
1182   add(mdp_in, mdp_in, reg_tmp);
1183   str(mdp_in, Address(FP, frame::interpreter_frame_mdp_offset * wordSize));
1184 }
1185 
1186 
1187 void InterpreterMacroAssembler::update_mdp_by_constant(Register mdp_in, int constant) {
1188   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1189   add(mdp_in, mdp_in, constant);
1190   str(mdp_in, Address(FP, frame::interpreter_frame_mdp_offset * wordSize));
1191 }
1192 
1193 
1194 // Blows volatile registers R0-R3, Rtemp, LR).
1195 void InterpreterMacroAssembler::update_mdp_for_ret(Register return_bci) {
1196   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1197   assert_different_registers(return_bci, R0, R1, R2, R3, Rtemp);
1198 
1199   mov(R1, return_bci);
1200   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::update_mdp_for_ret), R1);
1201 }
1202 
1203 
1204 // Sets mdp, bumped_count registers, blows Rtemp.
1205 void InterpreterMacroAssembler::profile_taken_branch(Register mdp, Register bumped_count) {
1206   assert_different_registers(mdp, bumped_count);
1207 
1208   if (ProfileInterpreter) {
1209     Label profile_continue;
1210 
1211     // If no method data exists, go to profile_continue.
1212     // Otherwise, assign to mdp
1213     test_method_data_pointer(mdp, profile_continue);
1214 
1215     // We are taking a branch. Increment the taken count.
1216     increment_mdp_data_at(mdp, in_bytes(JumpData::taken_offset()), bumped_count);
1217 
1218     // The method data pointer needs to be updated to reflect the new target.
1219     update_mdp_by_offset(mdp, in_bytes(JumpData::displacement_offset()), Rtemp);
1220 
1221     bind (profile_continue);
1222   }
1223 }
1224 
1225 
1226 // Sets mdp, blows Rtemp.
1227 void InterpreterMacroAssembler::profile_not_taken_branch(Register mdp) {
1228   assert_different_registers(mdp, Rtemp);
1229 
1230   if (ProfileInterpreter) {
1231     Label profile_continue;
1232 
1233     // If no method data exists, go to profile_continue.
1234     test_method_data_pointer(mdp, profile_continue);
1235 
1236     // We are taking a branch.  Increment the not taken count.
1237     increment_mdp_data_at(mdp, in_bytes(BranchData::not_taken_offset()), Rtemp);
1238 
1239     // The method data pointer needs to be updated to correspond to the next bytecode
1240     update_mdp_by_constant(mdp, in_bytes(BranchData::branch_data_size()));
1241 
1242     bind (profile_continue);
1243   }
1244 }
1245 
1246 
1247 // Sets mdp, blows Rtemp.
1248 void InterpreterMacroAssembler::profile_call(Register mdp) {
1249   assert_different_registers(mdp, Rtemp);
1250 
1251   if (ProfileInterpreter) {
1252     Label profile_continue;
1253 
1254     // If no method data exists, go to profile_continue.
1255     test_method_data_pointer(mdp, profile_continue);
1256 
1257     // We are making a call.  Increment the count.
1258     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()), Rtemp);
1259 
1260     // The method data pointer needs to be updated to reflect the new target.
1261     update_mdp_by_constant(mdp, in_bytes(CounterData::counter_data_size()));
1262 
1263     bind (profile_continue);
1264   }
1265 }
1266 
1267 
1268 // Sets mdp, blows Rtemp.
1269 void InterpreterMacroAssembler::profile_final_call(Register mdp) {
1270   if (ProfileInterpreter) {
1271     Label profile_continue;
1272 
1273     // If no method data exists, go to profile_continue.
1274     test_method_data_pointer(mdp, profile_continue);
1275 
1276     // We are making a call.  Increment the count.
1277     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()), Rtemp);
1278 
1279     // The method data pointer needs to be updated to reflect the new target.
1280     update_mdp_by_constant(mdp, in_bytes(VirtualCallData::virtual_call_data_size()));
1281 
1282     bind (profile_continue);
1283   }
1284 }
1285 
1286 
1287 // Sets mdp, blows Rtemp.
1288 void InterpreterMacroAssembler::profile_virtual_call(Register mdp, Register receiver, bool receiver_can_be_null) {
1289   assert_different_registers(mdp, receiver, Rtemp);
1290 
1291   if (ProfileInterpreter) {
1292     Label profile_continue;
1293 
1294     // If no method data exists, go to profile_continue.
1295     test_method_data_pointer(mdp, profile_continue);
1296 
1297     Label skip_receiver_profile;
1298     if (receiver_can_be_null) {
1299       Label not_null;
1300       cbnz(receiver, not_null);
1301       // We are making a call.  Increment the count for null receiver.
1302       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()), Rtemp);
1303       b(skip_receiver_profile);
1304       bind(not_null);
1305     }
1306 
1307     // Record the receiver type.
1308     record_klass_in_profile(receiver, mdp, Rtemp, true);
1309     bind(skip_receiver_profile);
1310 
1311     // The method data pointer needs to be updated to reflect the new target.
1312     update_mdp_by_constant(mdp, in_bytes(VirtualCallData::virtual_call_data_size()));
1313     bind(profile_continue);
1314   }
1315 }
1316 
1317 
1318 void InterpreterMacroAssembler::record_klass_in_profile_helper(
1319                                         Register receiver, Register mdp,
1320                                         Register reg_tmp,
1321                                         int start_row, Label&amp; done, bool is_virtual_call) {
1322   if (TypeProfileWidth == 0)
1323     return;
1324 
1325   assert_different_registers(receiver, mdp, reg_tmp);
1326 
1327   int last_row = VirtualCallData::row_limit() - 1;
1328   assert(start_row &lt;= last_row, &quot;must be work left to do&quot;);
1329   // Test this row for both the receiver and for null.
1330   // Take any of three different outcomes:
1331   //   1. found receiver =&gt; increment count and goto done
1332   //   2. found null =&gt; keep looking for case 1, maybe allocate this cell
1333   //   3. found something else =&gt; keep looking for cases 1 and 2
1334   // Case 3 is handled by a recursive call.
1335   for (int row = start_row; row &lt;= last_row; row++) {
1336     Label next_test;
1337 
1338     // See if the receiver is receiver[n].
1339     int recvr_offset = in_bytes(VirtualCallData::receiver_offset(row));
1340 
1341     test_mdp_data_at(mdp, recvr_offset, receiver, reg_tmp, next_test);
1342 
1343     // The receiver is receiver[n].  Increment count[n].
1344     int count_offset = in_bytes(VirtualCallData::receiver_count_offset(row));
1345     increment_mdp_data_at(mdp, count_offset, reg_tmp);
1346     b(done);
1347 
1348     bind(next_test);
1349     // reg_tmp now contains the receiver from the CallData.
1350 
1351     if (row == start_row) {
1352       Label found_null;
1353       // Failed the equality check on receiver[n]...  Test for null.
1354       if (start_row == last_row) {
1355         // The only thing left to do is handle the null case.
1356         if (is_virtual_call) {
1357           cbz(reg_tmp, found_null);
1358           // Receiver did not match any saved receiver and there is no empty row for it.
1359           // Increment total counter to indicate polymorphic case.
1360           increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()), reg_tmp);
1361           b(done);
1362           bind(found_null);
1363         } else {
1364           cbnz(reg_tmp, done);
1365         }
1366         break;
1367       }
1368       // Since null is rare, make it be the branch-taken case.
1369       cbz(reg_tmp, found_null);
1370 
1371       // Put all the &quot;Case 3&quot; tests here.
1372       record_klass_in_profile_helper(receiver, mdp, reg_tmp, start_row + 1, done, is_virtual_call);
1373 
1374       // Found a null.  Keep searching for a matching receiver,
1375       // but remember that this is an empty (unused) slot.
1376       bind(found_null);
1377     }
1378   }
1379 
1380   // In the fall-through case, we found no matching receiver, but we
1381   // observed the receiver[start_row] is NULL.
1382 
1383   // Fill in the receiver field and increment the count.
1384   int recvr_offset = in_bytes(VirtualCallData::receiver_offset(start_row));
1385   set_mdp_data_at(mdp, recvr_offset, receiver);
1386   int count_offset = in_bytes(VirtualCallData::receiver_count_offset(start_row));
1387   mov(reg_tmp, DataLayout::counter_increment);
1388   set_mdp_data_at(mdp, count_offset, reg_tmp);
1389   if (start_row &gt; 0) {
1390     b(done);
1391   }
1392 }
1393 
1394 void InterpreterMacroAssembler::record_klass_in_profile(Register receiver,
1395                                                         Register mdp,
1396                                                         Register reg_tmp,
1397                                                         bool is_virtual_call) {
1398   assert(ProfileInterpreter, &quot;must be profiling&quot;);
1399   assert_different_registers(receiver, mdp, reg_tmp);
1400 
1401   Label done;
1402 
1403   record_klass_in_profile_helper(receiver, mdp, reg_tmp, 0, done, is_virtual_call);
1404 
1405   bind (done);
1406 }
1407 
1408 // Sets mdp, blows volatile registers R0-R3, Rtemp, LR).
1409 void InterpreterMacroAssembler::profile_ret(Register mdp, Register return_bci) {
1410   assert_different_registers(mdp, return_bci, Rtemp, R0, R1, R2, R3);
1411 
1412   if (ProfileInterpreter) {
1413     Label profile_continue;
1414     uint row;
1415 
1416     // If no method data exists, go to profile_continue.
1417     test_method_data_pointer(mdp, profile_continue);
1418 
1419     // Update the total ret count.
1420     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()), Rtemp);
1421 
1422     for (row = 0; row &lt; RetData::row_limit(); row++) {
1423       Label next_test;
1424 
1425       // See if return_bci is equal to bci[n]:
1426       test_mdp_data_at(mdp, in_bytes(RetData::bci_offset(row)), return_bci,
1427                        Rtemp, next_test);
1428 
1429       // return_bci is equal to bci[n].  Increment the count.
1430       increment_mdp_data_at(mdp, in_bytes(RetData::bci_count_offset(row)), Rtemp);
1431 
1432       // The method data pointer needs to be updated to reflect the new target.
1433       update_mdp_by_offset(mdp, in_bytes(RetData::bci_displacement_offset(row)), Rtemp);
1434       b(profile_continue);
1435       bind(next_test);
1436     }
1437 
1438     update_mdp_for_ret(return_bci);
1439 
1440     bind(profile_continue);
1441   }
1442 }
1443 
1444 
1445 // Sets mdp.
1446 void InterpreterMacroAssembler::profile_null_seen(Register mdp) {
1447   if (ProfileInterpreter) {
1448     Label profile_continue;
1449 
1450     // If no method data exists, go to profile_continue.
1451     test_method_data_pointer(mdp, profile_continue);
1452 
1453     set_mdp_flag_at(mdp, BitData::null_seen_byte_constant());
1454 
1455     // The method data pointer needs to be updated.
1456     int mdp_delta = in_bytes(BitData::bit_data_size());
1457     if (TypeProfileCasts) {
1458       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1459     }
1460     update_mdp_by_constant(mdp, mdp_delta);
1461 
1462     bind (profile_continue);
1463   }
1464 }
1465 
1466 
1467 // Sets mdp, blows Rtemp.
1468 void InterpreterMacroAssembler::profile_typecheck_failed(Register mdp) {
1469   assert_different_registers(mdp, Rtemp);
1470 
1471   if (ProfileInterpreter &amp;&amp; TypeProfileCasts) {
1472     Label profile_continue;
1473 
1474     // If no method data exists, go to profile_continue.
1475     test_method_data_pointer(mdp, profile_continue);
1476 
1477     int count_offset = in_bytes(CounterData::count_offset());
1478     // Back up the address, since we have already bumped the mdp.
1479     count_offset -= in_bytes(VirtualCallData::virtual_call_data_size());
1480 
1481     // *Decrement* the counter.  We expect to see zero or small negatives.
1482     increment_mdp_data_at(mdp, count_offset, Rtemp, true);
1483 
1484     bind (profile_continue);
1485   }
1486 }
1487 
1488 
1489 // Sets mdp, blows Rtemp.
1490 void InterpreterMacroAssembler::profile_typecheck(Register mdp, Register klass)
1491 {
1492   assert_different_registers(mdp, klass, Rtemp);
1493 
1494   if (ProfileInterpreter) {
1495     Label profile_continue;
1496 
1497     // If no method data exists, go to profile_continue.
1498     test_method_data_pointer(mdp, profile_continue);
1499 
1500     // The method data pointer needs to be updated.
1501     int mdp_delta = in_bytes(BitData::bit_data_size());
1502     if (TypeProfileCasts) {
1503       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1504 
1505       // Record the object type.
1506       record_klass_in_profile(klass, mdp, Rtemp, false);
1507     }
1508     update_mdp_by_constant(mdp, mdp_delta);
1509 
1510     bind(profile_continue);
1511   }
1512 }
1513 
1514 
1515 // Sets mdp, blows Rtemp.
1516 void InterpreterMacroAssembler::profile_switch_default(Register mdp) {
1517   assert_different_registers(mdp, Rtemp);
1518 
1519   if (ProfileInterpreter) {
1520     Label profile_continue;
1521 
1522     // If no method data exists, go to profile_continue.
1523     test_method_data_pointer(mdp, profile_continue);
1524 
1525     // Update the default case count
1526     increment_mdp_data_at(mdp, in_bytes(MultiBranchData::default_count_offset()), Rtemp);
1527 
1528     // The method data pointer needs to be updated.
1529     update_mdp_by_offset(mdp, in_bytes(MultiBranchData::default_displacement_offset()), Rtemp);
1530 
1531     bind(profile_continue);
1532   }
1533 }
1534 
1535 
1536 // Sets mdp. Blows reg_tmp1, reg_tmp2. Index could be the same as reg_tmp2.
1537 void InterpreterMacroAssembler::profile_switch_case(Register mdp, Register index, Register reg_tmp1, Register reg_tmp2) {
1538   assert_different_registers(mdp, reg_tmp1, reg_tmp2);
1539   assert_different_registers(mdp, reg_tmp1, index);
1540 
1541   if (ProfileInterpreter) {
1542     Label profile_continue;
1543 
1544     const int count_offset = in_bytes(MultiBranchData::case_array_offset()) +
1545                               in_bytes(MultiBranchData::relative_count_offset());
1546 
1547     const int displacement_offset = in_bytes(MultiBranchData::case_array_offset()) +
1548                               in_bytes(MultiBranchData::relative_displacement_offset());
1549 
1550     // If no method data exists, go to profile_continue.
1551     test_method_data_pointer(mdp, profile_continue);
1552 
1553     // Build the base (index * per_case_size_in_bytes())
1554     logical_shift_left(reg_tmp1, index, exact_log2(in_bytes(MultiBranchData::per_case_size())));
1555 
1556     // Update the case count
1557     add(reg_tmp1, reg_tmp1, count_offset);
1558     increment_mdp_data_at(Address(mdp, reg_tmp1), reg_tmp2);
1559 
1560     // The method data pointer needs to be updated.
1561     add(reg_tmp1, reg_tmp1, displacement_offset - count_offset);
1562     update_mdp_by_offset(mdp, reg_tmp1, reg_tmp2);
1563 
1564     bind (profile_continue);
1565   }
1566 }
1567 
1568 
1569 void InterpreterMacroAssembler::byteswap_u32(Register r, Register rtmp1, Register rtmp2) {
1570   if (VM_Version::supports_rev()) {
1571     rev(r, r);
1572   } else {
1573     eor(rtmp1, r, AsmOperand(r, ror, 16));
1574     mvn(rtmp2, 0x0000ff00);
1575     andr(rtmp1, rtmp2, AsmOperand(rtmp1, lsr, 8));
1576     eor(r, rtmp1, AsmOperand(r, ror, 8));
1577   }
1578 }
1579 
1580 
1581 void InterpreterMacroAssembler::inc_global_counter(address address_of_counter, int offset, Register tmp1, Register tmp2, bool avoid_overflow) {
1582   const intx addr = (intx) (address_of_counter + offset);
1583 
1584   assert ((addr &amp; 0x3) == 0, &quot;address of counter should be aligned&quot;);
1585   const intx offset_mask = right_n_bits(12);
1586 
1587   const address base = (address) (addr &amp; ~offset_mask);
1588   const int offs = (int) (addr &amp; offset_mask);
1589 
1590   const Register addr_base = tmp1;
1591   const Register val = tmp2;
1592 
1593   mov_slow(addr_base, base);
1594   ldr_s32(val, Address(addr_base, offs));
1595 
1596   if (avoid_overflow) {
1597     adds_32(val, val, 1);
1598     str(val, Address(addr_base, offs), pl);
1599   } else {
1600     add_32(val, val, 1);
1601     str_32(val, Address(addr_base, offs));
1602   }
1603 }
1604 
1605 void InterpreterMacroAssembler::interp_verify_oop(Register reg, TosState state, const char *file, int line) {
1606   if (state == atos) { MacroAssembler::_verify_oop(reg, &quot;broken oop&quot;, file, line); }
1607 }
1608 
1609 // Inline assembly for:
1610 //
1611 // if (thread is in interp_only_mode) {
1612 //   InterpreterRuntime::post_method_entry();
1613 // }
1614 // if (DTraceMethodProbes) {
1615 //   SharedRuntime::dtrace_method_entry(method, receiver);
1616 // }
1617 // if (RC_TRACE_IN_RANGE(0x00001000, 0x00002000)) {
1618 //   SharedRuntime::rc_trace_method_entry(method, receiver);
1619 // }
1620 
1621 void InterpreterMacroAssembler::notify_method_entry() {
1622   // Whenever JVMTI is interp_only_mode, method entry/exit events are sent to
1623   // track stack depth.  If it is possible to enter interp_only_mode we add
1624   // the code to check if the event should be sent.
1625   if (can_post_interpreter_events()) {
1626     Label L;
1627 
1628     ldr_s32(Rtemp, Address(Rthread, JavaThread::interp_only_mode_offset()));
1629     cbz(Rtemp, L);
1630 
1631     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_entry));
1632 
1633     bind(L);
1634   }
1635 
1636   // Note: Disable DTrace runtime check for now to eliminate overhead on each method entry
1637   if (DTraceMethodProbes) {
1638     Label Lcontinue;
1639 
1640     ldrb_global(Rtemp, (address)&amp;DTraceMethodProbes);
1641     cbz(Rtemp, Lcontinue);
1642 
1643     mov(R0, Rthread);
1644     mov(R1, Rmethod);
1645     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_entry), R0, R1);
1646 
1647     bind(Lcontinue);
1648   }
1649   // RedefineClasses() tracing support for obsolete method entry
1650   if (log_is_enabled(Trace, redefine, class, obsolete)) {
1651     mov(R0, Rthread);
1652     mov(R1, Rmethod);
1653     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::rc_trace_method_entry),
1654                  R0, R1);
1655   }
1656 }
1657 
1658 
1659 void InterpreterMacroAssembler::notify_method_exit(
1660                  TosState state, NotifyMethodExitMode mode,
1661                  bool native, Register result_lo, Register result_hi, FloatRegister result_fp) {
1662   // Whenever JVMTI is interp_only_mode, method entry/exit events are sent to
1663   // track stack depth.  If it is possible to enter interp_only_mode we add
1664   // the code to check if the event should be sent.
1665   if (mode == NotifyJVMTI &amp;&amp; can_post_interpreter_events()) {
1666     Label L;
1667     // Note: frame::interpreter_frame_result has a dependency on how the
1668     // method result is saved across the call to post_method_exit. If this
1669     // is changed then the interpreter_frame_result implementation will
1670     // need to be updated too.
1671 
1672     ldr_s32(Rtemp, Address(Rthread, JavaThread::interp_only_mode_offset()));
1673     cbz(Rtemp, L);
1674 
1675     if (native) {
1676       // For c++ and template interpreter push both result registers on the
1677       // stack in native, we don&#39;t know the state.
1678       // See frame::interpreter_frame_result for code that gets the result values from here.
1679       assert(result_lo != noreg, &quot;result registers should be defined&quot;);
1680 
1681       assert(result_hi != noreg, &quot;result registers should be defined&quot;);
1682 
1683 #ifdef __ABI_HARD__
1684       assert(result_fp != fnoreg, &quot;FP result register must be defined&quot;);
1685       sub(SP, SP, 2 * wordSize);
1686       fstd(result_fp, Address(SP));
1687 #endif // __ABI_HARD__
1688 
1689       push(RegisterSet(result_lo) | RegisterSet(result_hi));
1690 
1691       call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_exit));
1692 
1693       pop(RegisterSet(result_lo) | RegisterSet(result_hi));
1694 #ifdef __ABI_HARD__
1695       fldd(result_fp, Address(SP));
1696       add(SP, SP, 2 * wordSize);
1697 #endif // __ABI_HARD__
1698 
1699     } else {
1700       // For the template interpreter, the value on tos is the size of the
1701       // state. (c++ interpreter calls jvmti somewhere else).
1702       push(state);
1703       call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_exit));
1704       pop(state);
1705     }
1706 
1707     bind(L);
1708   }
1709 
1710   // Note: Disable DTrace runtime check for now to eliminate overhead on each method exit
1711   if (DTraceMethodProbes) {
1712     Label Lcontinue;
1713 
1714     ldrb_global(Rtemp, (address)&amp;DTraceMethodProbes);
1715     cbz(Rtemp, Lcontinue);
1716 
1717     push(state);
1718 
1719     mov(R0, Rthread);
1720     mov(R1, Rmethod);
1721 
1722     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_exit), R0, R1);
1723 
1724     pop(state);
1725 
1726     bind(Lcontinue);
1727   }
1728 }
1729 
1730 
1731 #ifndef PRODUCT
1732 
1733 void InterpreterMacroAssembler::trace_state(const char* msg) {
1734   int push_size = save_caller_save_registers();
1735 
1736   Label Lcontinue;
1737   InlinedString Lmsg0(&quot;%s: FP=&quot; INTPTR_FORMAT &quot;, SP=&quot; INTPTR_FORMAT &quot;\n&quot;);
1738   InlinedString Lmsg(msg);
1739   InlinedAddress Lprintf((address)printf);
1740 
1741   ldr_literal(R0, Lmsg0);
1742   ldr_literal(R1, Lmsg);
1743   mov(R2, FP);
1744   add(R3, SP, push_size);  // original SP (without saved registers)
1745   ldr_literal(Rtemp, Lprintf);
1746   call(Rtemp);
1747 
1748   b(Lcontinue);
1749 
1750   bind_literal(Lmsg0);
1751   bind_literal(Lmsg);
1752   bind_literal(Lprintf);
1753 
1754 
1755   bind(Lcontinue);
1756 
1757   restore_caller_save_registers();
1758 }
1759 
1760 #endif
1761 
1762 // Jump if ((*counter_addr += increment) &amp; mask) satisfies the condition.
1763 void InterpreterMacroAssembler::increment_mask_and_jump(Address counter_addr,
1764                                                         int increment, Address mask_addr,
1765                                                         Register scratch, Register scratch2,
1766                                                         AsmCondition cond, Label* where) {
1767   // caution: scratch2 and base address of counter_addr can be the same
1768   assert_different_registers(scratch, scratch2);
1769   ldr_u32(scratch, counter_addr);
1770   add(scratch, scratch, increment);
1771   str_32(scratch, counter_addr);
1772 
1773   ldr(scratch2, mask_addr);
1774   andrs(scratch, scratch, scratch2);
1775   b(*where, cond);
1776 }
1777 
1778 void InterpreterMacroAssembler::get_method_counters(Register method,
1779                                                     Register Rcounters,
1780                                                     Label&amp; skip,
1781                                                     bool saveRegs,
1782                                                     Register reg1,
1783                                                     Register reg2,
1784                                                     Register reg3) {
1785   const Address method_counters(method, Method::method_counters_offset());
1786   Label has_counters;
1787 
1788   ldr(Rcounters, method_counters);
1789   cbnz(Rcounters, has_counters);
1790 
1791   if (saveRegs) {
1792     // Save and restore in use caller-saved registers since they will be trashed by call_VM
1793     assert(reg1 != noreg, &quot;must specify reg1&quot;);
1794     assert(reg2 != noreg, &quot;must specify reg2&quot;);
1795     assert(reg3 == noreg, &quot;must not specify reg3&quot;);
1796     push(RegisterSet(reg1) | RegisterSet(reg2));
1797   }
1798 
1799   mov(R1, method);
1800   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::build_method_counters), R1);
1801 
1802   if (saveRegs) {
1803     pop(RegisterSet(reg1) | RegisterSet(reg2));
1804   }
1805 
1806   ldr(Rcounters, method_counters);
1807   cbz(Rcounters, skip); // No MethodCounters created, OutOfMemory
1808 
1809   bind(has_counters);
1810 }
    </pre>
  </body>
</html>