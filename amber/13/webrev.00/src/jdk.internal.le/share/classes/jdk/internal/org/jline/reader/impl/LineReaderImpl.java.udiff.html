<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.le/share/classes/jdk/internal/org/jline/reader/impl/LineReaderImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DefaultParser.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="completer/ArgumentCompleter.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.le/share/classes/jdk/internal/org/jline/reader/impl/LineReaderImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,25 +1,29 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2002-2019, the original author or authors.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2002-2020, the original author or authors.</span>
   *
   * This software is distributable under the BSD license. See the terms of the
   * BSD license in the documentation provided with this software.
   *
   * https://opensource.org/licenses/BSD-3-Clause
   */
  package jdk.internal.org.jline.reader.impl;
  
<span class="udiff-line-added">+ import java.io.BufferedReader;</span>
<span class="udiff-line-added">+ import java.io.File;</span>
<span class="udiff-line-added">+ import java.io.FileReader;</span>
<span class="udiff-line-added">+ import java.io.FileWriter;</span>
  import java.io.Flushable;
  import java.io.IOError;
  import java.io.IOException;
  import java.io.InputStream;
  import java.io.InterruptedIOException;
<span class="udiff-line-added">+ import java.lang.reflect.Constructor;</span>
  import java.time.Instant;
  import java.util.*;
  import java.util.Map.Entry;
  import java.util.concurrent.atomic.AtomicBoolean;
<span class="udiff-line-removed">- import java.util.concurrent.locks.Lock;</span>
  import java.util.concurrent.locks.ReentrantLock;
  import java.util.function.*;
  import java.util.regex.Matcher;
  import java.util.regex.Pattern;
  import java.util.stream.Collectors;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -84,10 +88,12 @@</span>
      public static final String DEFAULT_ORIGINAL_GROUP_NAME = &quot;original&quot;;
      public static final String DEFAULT_COMPLETION_STYLE_STARTING = &quot;36&quot;;    // cyan
      public static final String DEFAULT_COMPLETION_STYLE_DESCRIPTION = &quot;90&quot;; // dark gray
      public static final String DEFAULT_COMPLETION_STYLE_GROUP = &quot;35;1&quot;;     // magenta
      public static final String DEFAULT_COMPLETION_STYLE_SELECTION = &quot;7&quot;;    // inverted
<span class="udiff-line-added">+     public static final int    DEFAULT_INDENTATION = 0;</span>
<span class="udiff-line-added">+     public static final int    DEFAULT_FEATURES_MAX_BUFFER_SIZE = 1000;</span>
  
      private static final int MIN_ROWS = 3;
  
      public static final String BRACKETED_PASTE_ON = &quot;\033[?2004h&quot;;
      public static final String BRACKETED_PASTE_OFF = &quot;\033[?2004l&quot;;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -107,10 +113,14 @@</span>
          NORMAL,
          /**
           * readLine should exit and return the buffer content
           */
          DONE,
<span class="udiff-line-added">+         /**</span>
<span class="udiff-line-added">+          * readLine should exit and return empty String</span>
<span class="udiff-line-added">+          */</span>
<span class="udiff-line-added">+         IGNORE,</span>
          /**
           * readLine should exit and throw an EOFException
           */
          EOF,
          /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -158,10 +168,12 @@</span>
      //
  
      protected final Map&lt;Option, Boolean&gt; options = new HashMap&lt;&gt;();
  
      protected final Buffer buf = new BufferImpl();
<span class="udiff-line-added">+     protected String tailTip = &quot;&quot;;</span>
<span class="udiff-line-added">+     protected SuggestionType autosuggestion = SuggestionType.NONE;</span>
  
      protected final Size size = new Size();
  
      protected AttributedString prompt = AttributedString.EMPTY;
      protected AttributedString rightPrompt = AttributedString.EMPTY;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -173,10 +185,11 @@</span>
      protected CharSequence searchBuffer;
      protected StringBuffer searchTerm = null;
      protected boolean searchFailing;
      protected boolean searchBackward;
      protected int searchIndex = -1;
<span class="udiff-line-added">+     protected boolean doAutosuggestion;</span>
  
  
      // Reading buffers
      protected final BindingReader bindingReader;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -244,17 +257,20 @@</span>
      protected boolean overTyping = false;
  
      protected String keyMap;
  
      protected int smallTerminalOffset = 0;
<span class="udiff-line-removed">- </span>
      /*
       * accept-and-infer-next-history, accept-and-hold &amp; accept-line-and-down-history
       */
      protected boolean nextCommandFromHistory = false;
      protected int nextHistoryId = -1;
  
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * execute commands from commandsBuffer</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     protected List&lt;String&gt; commandsBuffer = new ArrayList&lt;&gt;();</span>
  
      public LineReaderImpl(Terminal terminal) throws IOException {
          this(terminal, null, null);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -311,10 +327,30 @@</span>
      @Override
      public Buffer getBuffer() {
          return buf;
      }
  
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public void setAutosuggestion(SuggestionType type) {</span>
<span class="udiff-line-added">+         this.autosuggestion = type;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public SuggestionType getAutosuggestion() {</span>
<span class="udiff-line-added">+         return autosuggestion;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public String getTailTip() {</span>
<span class="udiff-line-added">+         return tailTip;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public void setTailTip(String tailTip) {</span>
<span class="udiff-line-added">+         this.tailTip = tailTip;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      @Override
      public void runMacro(String macro) {
          bindingReader.runMacro(macro);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -469,10 +505,36 @@</span>
       */
      public String readLine(String prompt, String rightPrompt, MaskingCallback maskingCallback, String buffer) throws UserInterruptException, EndOfFileException {
          // prompt may be null
          // maskingCallback may be null
          // buffer may be null
<span class="udiff-line-added">+         if (!commandsBuffer.isEmpty()) {</span>
<span class="udiff-line-added">+             String cmd = commandsBuffer.remove(0);</span>
<span class="udiff-line-added">+             boolean done = false;</span>
<span class="udiff-line-added">+             do {</span>
<span class="udiff-line-added">+                 try {</span>
<span class="udiff-line-added">+                     parser.parse(cmd, cmd.length() + 1, ParseContext.ACCEPT_LINE);</span>
<span class="udiff-line-added">+                     done = true;</span>
<span class="udiff-line-added">+                 } catch (EOFError e) {</span>
<span class="udiff-line-added">+                     if (commandsBuffer.isEmpty()) {</span>
<span class="udiff-line-added">+                         throw new IllegalArgumentException(&quot;Incompleted command: \n&quot; + cmd);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     cmd += &quot;\n&quot;;</span>
<span class="udiff-line-added">+                     cmd += commandsBuffer.remove(0);</span>
<span class="udiff-line-added">+                 } catch (SyntaxError e) {</span>
<span class="udiff-line-added">+                     done = true;</span>
<span class="udiff-line-added">+                 } catch (Exception e) {</span>
<span class="udiff-line-added">+                     commandsBuffer.clear();</span>
<span class="udiff-line-added">+                     throw new IllegalArgumentException(e.getMessage());</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } while (!done);</span>
<span class="udiff-line-added">+             AttributedStringBuilder sb = new AttributedStringBuilder();</span>
<span class="udiff-line-added">+             sb.styled(AttributedStyle::bold, cmd);</span>
<span class="udiff-line-added">+             sb.toAttributedString().println(terminal);</span>
<span class="udiff-line-added">+             terminal.flush();</span>
<span class="udiff-line-added">+             return finish(cmd);</span>
<span class="udiff-line-added">+         }</span>
  
          if (!startedReading.compareAndSet(false, true)) {
              throw new IllegalStateException();
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -596,22 +658,25 @@</span>
                  }
  
                  try {
                      lock.lock();
                      // Get executable widget
<span class="udiff-line-modified-removed">-                     Buffer copy = buf.copy();</span>
<span class="udiff-line-modified-added">+                     Buffer copy = buf.length() &lt;= getInt(FEATURES_MAX_BUFFER_SIZE, DEFAULT_FEATURES_MAX_BUFFER_SIZE) ? buf.copy() : null;</span>
                      Widget w = getWidget(o);
                      if (!w.apply()) {
                          beep();
                      }
<span class="udiff-line-modified-removed">-                     if (!isUndo &amp;&amp; !copy.toString().equals(buf.toString())) {</span>
<span class="udiff-line-modified-added">+                     if (!isUndo &amp;&amp; copy != null &amp;&amp; buf.length() &lt;= getInt(FEATURES_MAX_BUFFER_SIZE, DEFAULT_FEATURES_MAX_BUFFER_SIZE)</span>
<span class="udiff-line-added">+                             &amp;&amp; !copy.toString().equals(buf.toString())) {</span>
                          undo.newState(buf.copy());
                      }
  
                      switch (state) {
                          case DONE:
                              return finishBuffer();
<span class="udiff-line-added">+                         case IGNORE:</span>
<span class="udiff-line-added">+                             return &quot;&quot;;</span>
                          case EOF:
                              throw new EndOfFileException();
                          case INTERRUPT:
                              throw new UserInterruptException(buf.toString());
                      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -663,16 +728,16 @@</span>
              }
              startedReading.set(false);
          }
      }
  
<span class="udiff-line-modified-removed">-     private boolean isTerminalDumb(){</span>
<span class="udiff-line-modified-added">+     private boolean isTerminalDumb() {</span>
          return Terminal.TYPE_DUMB.equals(terminal.getType())
                  || Terminal.TYPE_DUMB_COLOR.equals(terminal.getType());
      }
  
<span class="udiff-line-modified-removed">-     private void doDisplay(){</span>
<span class="udiff-line-modified-added">+     private void doDisplay() {</span>
          // Cache terminal size for the duration of the call to readLine()
          // It will eventually be updated with WINCH signals
          size.copy(terminal.getBufferSize());
  
          display = new Display(terminal, false);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -847,10 +912,23 @@</span>
          } else {
              return bindingReader.readBinding(keys, local);
          }
      }
  
<span class="udiff-line-added">+     protected String doReadStringUntil(String sequence) {</span>
<span class="udiff-line-added">+         if (lock.isHeldByCurrentThread()) {</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 lock.unlock();</span>
<span class="udiff-line-added">+                 return bindingReader.readStringUntil(sequence);</span>
<span class="udiff-line-added">+             } finally {</span>
<span class="udiff-line-added">+                 lock.lock();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return bindingReader.readStringUntil(sequence);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Read from the input stream and decode an operation from the key map.
       *
       * The input stream will be read character by character until a matching
       * binding can be found.  Characters that can&#39;t possibly be matched to
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -887,14 +965,16 @@</span>
      @Override
      public ParsedLine getParsedLine() {
          return parsedLine;
      }
  
<span class="udiff-line-added">+     @Override</span>
      public String getLastBinding() {
          return bindingReader.getLastBinding();
      }
  
<span class="udiff-line-added">+     @Override</span>
      public String getSearchTerm() {
          return searchTerm != null ? searchTerm.toString() : null;
      }
  
      @Override
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -981,11 +1061,30 @@</span>
      @Override
      public void unsetOpt(Option option) {
          options.put(option, Boolean.FALSE);
      }
  
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public void addCommandsInBuffer(Collection&lt;String&gt; commands) {</span>
<span class="udiff-line-added">+         commandsBuffer.addAll(commands);</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public void editAndAddInBuffer(File file) throws Exception {</span>
<span class="udiff-line-added">+         Constructor&lt;?&gt; ctor = Class.forName(&quot;org.jline.builtins.Nano&quot;).getConstructor(Terminal.class, File.class);</span>
<span class="udiff-line-added">+         Editor editor = (Editor) ctor.newInstance(terminal, new File(file.getParent()));</span>
<span class="udiff-line-added">+         editor.setRestricted(true);</span>
<span class="udiff-line-added">+         editor.open(Arrays.asList(file.getName()));</span>
<span class="udiff-line-added">+         editor.run();</span>
<span class="udiff-line-added">+         BufferedReader br = new BufferedReader(new FileReader(file));</span>
<span class="udiff-line-added">+         String line;</span>
<span class="udiff-line-added">+         commandsBuffer.clear();</span>
<span class="udiff-line-added">+         while ((line = br.readLine()) != null) {</span>
<span class="udiff-line-added">+             commandsBuffer.add(line);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         br.close();</span>
<span class="udiff-line-added">+     }</span>
  
      //
      // Widget implementation
      //
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -993,11 +1092,14 @@</span>
       * Clear the buffer and add its contents to the history.
       *
       * @return the former contents of the buffer.
       */
      protected String finishBuffer() {
<span class="udiff-line-modified-removed">-         String str = buf.toString();</span>
<span class="udiff-line-modified-added">+         return finish(buf.toString());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     protected String finish(String str) {</span>
          String historyLine = str;
  
          if (!isSet(Option.DISABLE_EVENT_EXPANSION)) {
              StringBuilder sb = new StringBuilder();
              boolean escaped = false;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1027,18 +1129,20 @@</span>
          }
          return str;
      }
  
      protected void handleSignal(Signal signal) {
<span class="udiff-line-added">+         doAutosuggestion = false;</span>
          if (signal == Signal.WINCH) {
              Status status = Status.getStatus(terminal, false);
              if (status != null) {
                  status.hardReset();
              }
              size.copy(terminal.getBufferSize());
              display.resize(size.getRows(), size.getColumns());
<span class="udiff-line-modified-removed">-             redrawLine();</span>
<span class="udiff-line-modified-added">+             // restores prompt but also prevents scrolling in consoleZ, see #492</span>
<span class="udiff-line-added">+             // redrawLine();</span>
              redisplay();
          }
          else if (signal == Signal.CONT) {
              terminal.enterRawMode();
              size.copy(terminal.getBufferSize());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2070,25 +2174,47 @@</span>
      protected boolean insertClose(String s) {
          putString(s);
  
          long blink = getLong(BLINK_MATCHING_PAREN, DEFAULT_BLINK_MATCHING_PAREN);
          if (blink &lt;= 0) {
<span class="udiff-line-added">+             removeIndentation();</span>
              return true;
          }
  
          int closePosition = buf.cursor();
  
          buf.move(-1);
          doViMatchBracket();
          redisplay();
  
          peekCharacter(blink);
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+         int blinkPosition = buf.cursor();</span>
          buf.cursor(closePosition);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (blinkPosition != closePosition - 1) {</span>
<span class="udiff-line-added">+             removeIndentation();</span>
<span class="udiff-line-added">+         }</span>
          return true;
      }
  
<span class="udiff-line-added">+     private void removeIndentation() {</span>
<span class="udiff-line-added">+         int indent = getInt(INDENTATION, DEFAULT_INDENTATION);</span>
<span class="udiff-line-added">+         if (indent &gt; 0) {</span>
<span class="udiff-line-added">+             buf.move(-1);</span>
<span class="udiff-line-added">+             for (int i = 0; i &lt; indent; i++) {</span>
<span class="udiff-line-added">+                 buf.move(-1);</span>
<span class="udiff-line-added">+                 if (buf.currChar() == &#39; &#39;) {</span>
<span class="udiff-line-added">+                     buf.delete();</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     buf.move(1);</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             buf.move(1);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      protected boolean viMatchBracket() {
          return doViMatchBracket();
      }
  
      protected boolean undefinedKey() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2422,10 +2548,11 @@</span>
  
      protected void doCleanup(boolean nl) {
          buf.cursor(buf.length());
          post = null;
          if (size.getColumns() &gt; 0 || size.getRows() &gt; 0) {
<span class="udiff-line-added">+             doAutosuggestion = false;</span>
              redisplay(false);
              if (nl) {
                  println();
              }
              terminal.puts(Capability.keypad_local);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2833,10 +2960,11 @@</span>
          return nextCommandFromHistory;
      }
  
      protected boolean acceptLine() {
          parsedLine = null;
<span class="udiff-line-added">+         int curPos = 0;</span>
          if (!isSet(Option.DISABLE_EVENT_EXPANSION)) {
              try {
                  String str = buf.toString();
                  String exp = expander.expandHistory(history, str);
                  if (!exp.equals(str)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2849,22 +2977,39 @@</span>
              } catch (IllegalArgumentException e) {
                  // Ignore
              }
          }
          try {
<span class="udiff-line-added">+             curPos = buf.cursor();</span>
              parsedLine = parser.parse(buf.toString(), buf.cursor(), ParseContext.ACCEPT_LINE);
          } catch (EOFError e) {
<span class="udiff-line-modified-removed">-             buf.write(&quot;\n&quot;);</span>
<span class="udiff-line-modified-added">+             StringBuilder sb = new StringBuilder(&quot;\n&quot;);</span>
<span class="udiff-line-added">+             indention(e.getOpenBrackets(), sb);</span>
<span class="udiff-line-added">+             int curMove = sb.length();</span>
<span class="udiff-line-added">+             if (isSet(Option.INSERT_BRACKET) &amp;&amp; e.getOpenBrackets() &gt; 1 &amp;&amp; e.getNextClosingBracket() != null) {</span>
<span class="udiff-line-added">+                 sb.append(&#39;\n&#39;);</span>
<span class="udiff-line-added">+                 indention(e.getOpenBrackets() - 1, sb);</span>
<span class="udiff-line-added">+                 sb.append(e.getNextClosingBracket());</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             buf.write(sb.toString());</span>
<span class="udiff-line-added">+             buf.cursor(curPos + curMove);</span>
              return true;
          } catch (SyntaxError e) {
              // do nothing
          }
          callWidget(CALLBACK_FINISH);
          state = State.DONE;
          return true;
      }
  
<span class="udiff-line-added">+     void indention(int nb, StringBuilder sb) {</span>
<span class="udiff-line-added">+         int indent = getInt(INDENTATION, DEFAULT_INDENTATION)*nb;</span>
<span class="udiff-line-added">+         for (int i = 0; i &lt; indent; i++) {</span>
<span class="udiff-line-added">+             sb.append(&#39; &#39;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      protected boolean selfInsert() {
          for (int count = this.count; count &gt; 0; count--) {
              putString(getLastBinding());
          }
          return true;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3462,10 +3607,31 @@</span>
              return sb.toAttributedString();
          };
          return true;
      }
  
<span class="udiff-line-added">+     protected boolean editAndExecute() {</span>
<span class="udiff-line-added">+         boolean out = true;</span>
<span class="udiff-line-added">+         File file = null;</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             file = File.createTempFile(&quot;jline-execute-&quot;, null);</span>
<span class="udiff-line-added">+             FileWriter writer = new FileWriter(file);</span>
<span class="udiff-line-added">+             writer.write(buf.toString());</span>
<span class="udiff-line-added">+             writer.close();</span>
<span class="udiff-line-added">+             editAndAddInBuffer(file);</span>
<span class="udiff-line-added">+         } catch (Exception e) {</span>
<span class="udiff-line-added">+             e.printStackTrace(terminal.writer());</span>
<span class="udiff-line-added">+             out = false;</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             state = State.IGNORE;</span>
<span class="udiff-line-added">+             if (file != null &amp;&amp; file.exists()) {</span>
<span class="udiff-line-added">+                 file.delete();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return out;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      protected Map&lt;String, Widget&gt; builtinWidgets() {
          Map&lt;String, Widget&gt; widgets = new HashMap&lt;&gt;();
          addBuiltinWidget(widgets, ACCEPT_AND_INFER_NEXT_HISTORY, this::acceptAndInferNextHistory);
          addBuiltinWidget(widgets, ACCEPT_AND_HOLD, this::acceptAndHold);
          addBuiltinWidget(widgets, ACCEPT_LINE, this::acceptLine);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3497,10 +3663,11 @@</span>
          addBuiltinWidget(widgets, DOWN_CASE_WORD, this::downCaseWord);
          addBuiltinWidget(widgets, DOWN_LINE, this::downLine);
          addBuiltinWidget(widgets, DOWN_LINE_OR_HISTORY, this::downLineOrHistory);
          addBuiltinWidget(widgets, DOWN_LINE_OR_SEARCH, this::downLineOrSearch);
          addBuiltinWidget(widgets, DOWN_HISTORY, this::downHistory);
<span class="udiff-line-added">+         addBuiltinWidget(widgets, EDIT_AND_EXECUTE_COMMAND, this::editAndExecute);</span>
          addBuiltinWidget(widgets, EMACS_EDITING_MODE, this::emacsEditingMode);
          addBuiltinWidget(widgets, EMACS_BACKWARD_WORD, this::emacsBackwardWord);
          addBuiltinWidget(widgets, EMACS_FORWARD_WORD, this::emacsForwardWord);
          addBuiltinWidget(widgets, END_OF_BUFFER_OR_HISTORY, this::endOfBufferOrHistory);
          addBuiltinWidget(widgets, END_OF_HISTORY, this::endOfHistory);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3614,11 +3781,11 @@</span>
          addBuiltinWidget(widgets, FOCUS_OUT, this::focusOut);
          return widgets;
      }
  
      private void addBuiltinWidget(Map&lt;String, Widget&gt; widgets, String name, Widget widget) {
<span class="udiff-line-modified-removed">-         widgets.put(name, namedWidget(name, widget));</span>
<span class="udiff-line-modified-added">+         widgets.put(name, namedWidget(&quot;.&quot; + name, widget));</span>
      }
  
      private Widget namedWidget(String name, Widget widget) {
          return new Widget() {
              @Override
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3789,10 +3956,42 @@</span>
              }
          }
          sb.append(lines.get(lines.size() - 1));
      }
  
<span class="udiff-line-added">+     private String matchPreviousCommand(String buffer) {</span>
<span class="udiff-line-added">+         if (buffer.length() == 0) {</span>
<span class="udiff-line-added">+             return &quot;&quot;;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         History history = getHistory();</span>
<span class="udiff-line-added">+         StringBuilder sb = new StringBuilder();</span>
<span class="udiff-line-added">+         char prev = &#39;0&#39;;</span>
<span class="udiff-line-added">+         for (char c: buffer.toCharArray()) {</span>
<span class="udiff-line-added">+             if ((c == &#39;(&#39; || c == &#39;)&#39; || c == &#39;[&#39; || c == &#39;]&#39; || c == &#39;{&#39; || c == &#39;}&#39; || c == &#39;^&#39;) &amp;&amp; prev != &#39;\\&#39; ) {</span>
<span class="udiff-line-added">+                 sb.append(&#39;\\&#39;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             sb.append(c);</span>
<span class="udiff-line-added">+             prev = c;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         Pattern pattern = Pattern.compile(sb.toString() + &quot;.*&quot;, Pattern.DOTALL);</span>
<span class="udiff-line-added">+         Iterator&lt;History.Entry&gt; iter = history.reverseIterator(history.last());</span>
<span class="udiff-line-added">+         String suggestion = &quot;&quot;;</span>
<span class="udiff-line-added">+         int tot = 0;</span>
<span class="udiff-line-added">+         while (iter.hasNext()) {</span>
<span class="udiff-line-added">+             History.Entry entry = iter.next();</span>
<span class="udiff-line-added">+             Matcher matcher = pattern.matcher(entry.line());</span>
<span class="udiff-line-added">+             if (matcher.matches()) {</span>
<span class="udiff-line-added">+                 suggestion = entry.line().substring(buffer.length());</span>
<span class="udiff-line-added">+                 break;</span>
<span class="udiff-line-added">+             } else if (tot &gt; 200) {</span>
<span class="udiff-line-added">+                 break;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             tot++;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return suggestion;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Compute the full string to be displayed with the left, right and secondary prompts
       * @param secondaryPrompts a list to store the secondary prompts
       * @return the displayed string including the buffer, left prompts and the help below
       */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3801,22 +4000,64 @@</span>
  
          AttributedString tNewBuf = insertSecondaryPrompts(attBuf, secondaryPrompts);
          AttributedStringBuilder full = new AttributedStringBuilder().tabs(TAB_WIDTH);
          full.append(prompt);
          full.append(tNewBuf);
<span class="udiff-line-added">+         if (doAutosuggestion) {</span>
<span class="udiff-line-added">+             String lastBinding = getLastBinding() != null ? getLastBinding() : &quot;&quot;;</span>
<span class="udiff-line-added">+             if (autosuggestion == SuggestionType.HISTORY) {</span>
<span class="udiff-line-added">+                 AttributedStringBuilder sb = new AttributedStringBuilder();</span>
<span class="udiff-line-added">+                 tailTip = matchPreviousCommand(buf.toString());</span>
<span class="udiff-line-added">+                 sb.styled(AttributedStyle::faint, tailTip);</span>
<span class="udiff-line-added">+                 full.append(sb.toAttributedString());</span>
<span class="udiff-line-added">+             } else if (autosuggestion == SuggestionType.COMPLETER) {</span>
<span class="udiff-line-added">+                 if (buf.length() &gt; 0 &amp;&amp; buf.length() == buf.cursor()</span>
<span class="udiff-line-added">+                     &amp;&amp; (!lastBinding.equals(&quot;\t&quot;) || buf.prevChar() == &#39; &#39; || buf.prevChar() == &#39;=&#39;)) {</span>
<span class="udiff-line-added">+                     clearChoices();</span>
<span class="udiff-line-added">+                     listChoices(true);</span>
<span class="udiff-line-added">+                 } else if (!lastBinding.equals(&quot;\t&quot;)) {</span>
<span class="udiff-line-added">+                     clearChoices();</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else if (autosuggestion == SuggestionType.TAIL_TIP) {</span>
<span class="udiff-line-added">+                 if (buf.length() == buf.cursor()) {</span>
<span class="udiff-line-added">+                     if (!lastBinding.equals(&quot;\t&quot;) || buf.prevChar() == &#39; &#39;) {</span>
<span class="udiff-line-added">+                         clearChoices();</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     AttributedStringBuilder sb = new AttributedStringBuilder();</span>
<span class="udiff-line-added">+                     if (buf.prevChar() != &#39; &#39;) {</span>
<span class="udiff-line-added">+                         if (!tailTip.startsWith(&quot;[&quot;)) {</span>
<span class="udiff-line-added">+                             int idx = tailTip.indexOf(&#39; &#39;);</span>
<span class="udiff-line-added">+                             int idb = buf.toString().lastIndexOf(&#39; &#39;);</span>
<span class="udiff-line-added">+                             int idd = buf.toString().lastIndexOf(&#39;-&#39;);</span>
<span class="udiff-line-added">+                             if (idx &gt; 0 &amp;&amp; ((idb == -1 &amp;&amp; idb == idd) || (idb &gt;= 0 &amp;&amp; idb &gt; idd))) {</span>
<span class="udiff-line-added">+                                 tailTip = tailTip.substring(idx);</span>
<span class="udiff-line-added">+                             } else if (idb &gt;= 0 &amp;&amp; idb &lt; idd) {</span>
<span class="udiff-line-added">+                                 sb.append(&quot; &quot;);</span>
<span class="udiff-line-added">+                             }</span>
<span class="udiff-line-added">+                         } else {</span>
<span class="udiff-line-added">+                             sb.append(&quot; &quot;);</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     sb.styled(AttributedStyle::faint, tailTip);</span>
<span class="udiff-line-added">+                     full.append(sb.toAttributedString());</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
          if (post != null) {
              full.append(&quot;\n&quot;);
              full.append(post.get());
          }
<span class="udiff-line-added">+         doAutosuggestion = true;</span>
          return full.toAttributedString();
      }
  
      private AttributedString getHighlightedBuffer(String buffer) {
          if (maskingCallback != null) {
              buffer = maskingCallback.display(buffer);
          }
<span class="udiff-line-modified-removed">-         if (highlighter != null &amp;&amp; !isSet(Option.DISABLE_HIGHLIGHTER)) {</span>
<span class="udiff-line-modified-added">+         if (highlighter != null &amp;&amp; !isSet(Option.DISABLE_HIGHLIGHTER)</span>
<span class="udiff-line-added">+                 &amp;&amp; buffer.length() &lt; getInt(FEATURES_MAX_BUFFER_SIZE, DEFAULT_FEATURES_MAX_BUFFER_SIZE)) {</span>
              return highlighter.highlight(this, buffer);
          }
          return new AttributedString(buffer);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3934,11 +4175,12 @@</span>
      private AttributedString insertSecondaryPrompts(AttributedString strAtt, List&lt;AttributedString&gt; prompts, boolean computePrompts) {
          Objects.requireNonNull(prompts);
          List&lt;AttributedString&gt; lines = strAtt.columnSplitLength(Integer.MAX_VALUE);
          AttributedStringBuilder sb = new AttributedStringBuilder();
          String secondaryPromptPattern = getString(SECONDARY_PROMPT_PATTERN, DEFAULT_SECONDARY_PROMPT_PATTERN);
<span class="udiff-line-modified-removed">-         boolean needsMessage = secondaryPromptPattern.contains(&quot;%M&quot;);</span>
<span class="udiff-line-modified-added">+         boolean needsMessage = secondaryPromptPattern.contains(&quot;%M&quot;)</span>
<span class="udiff-line-added">+                 &amp;&amp; strAtt.length() &lt; getInt(FEATURES_MAX_BUFFER_SIZE, DEFAULT_FEATURES_MAX_BUFFER_SIZE);</span>
          AttributedStringBuilder buf = new AttributedStringBuilder();
          int width = 0;
          List&lt;String&gt; missings = new ArrayList&lt;&gt;();
          if (computePrompts &amp;&amp; secondaryPromptPattern.contains(&quot;%P&quot;)) {
              width = prompt.columnLength();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4100,11 +4342,15 @@</span>
              return doComplete(CompletionType.Complete, isSet(Option.MENU_COMPLETE), true);
          }
      }
  
      protected boolean listChoices() {
<span class="udiff-line-modified-removed">-         return doComplete(CompletionType.List, isSet(Option.MENU_COMPLETE), false);</span>
<span class="udiff-line-modified-added">+         return listChoices(false);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private boolean listChoices(boolean forSuggestion) {</span>
<span class="udiff-line-added">+         return doComplete(CompletionType.List, isSet(Option.MENU_COMPLETE), false, forSuggestion);</span>
      }
  
      protected boolean deleteCharOrList() {
          if (buf.cursor() != buf.length() || buf.length() == 0) {
              return deleteChar();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4112,10 +4358,14 @@</span>
              return doComplete(CompletionType.List, isSet(Option.MENU_COMPLETE), false);
          }
      }
  
      protected boolean doComplete(CompletionType lst, boolean useMenu, boolean prefix) {
<span class="udiff-line-added">+         return doComplete(lst, useMenu, prefix, false);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     protected boolean doComplete(CompletionType lst, boolean useMenu, boolean prefix, boolean forSuggestion) {</span>
          // If completion is disabled, just bail out
          if (getBoolean(DISABLE_COMPLETION, false)) {
              return true;
          }
          // Try to expand history first
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4210,15 +4460,21 @@</span>
              );
              exact = s -&gt; caseInsensitive ? s.equalsIgnoreCase(wd) : s.equals(wd);
          } else {
              String wd = line.word();
              String wdi = caseInsensitive ? wd.toLowerCase() : wd;
<span class="udiff-line-modified-removed">-             matchers = Arrays.asList(</span>
<span class="udiff-line-modified-removed">-                     simpleMatcher(s -&gt; (caseInsensitive ? s.toLowerCase() : s).startsWith(wdi)),</span>
<span class="udiff-line-modified-removed">-                     simpleMatcher(s -&gt; (caseInsensitive ? s.toLowerCase() : s).contains(wdi)),</span>
<span class="udiff-line-modified-removed">-                     typoMatcher(wdi, errors, caseInsensitive)</span>
<span class="udiff-line-modified-removed">-             );</span>
<span class="udiff-line-modified-added">+             if (isSet(Option.EMPTY_WORD_OPTIONS) || wd.length() &gt; 0) {</span>
<span class="udiff-line-modified-added">+                 matchers = Arrays.asList(</span>
<span class="udiff-line-modified-added">+                         simpleMatcher(s -&gt; (caseInsensitive ? s.toLowerCase() : s).startsWith(wdi)),</span>
<span class="udiff-line-modified-added">+                         simpleMatcher(s -&gt; (caseInsensitive ? s.toLowerCase() : s).contains(wdi)),</span>
<span class="udiff-line-modified-added">+                         typoMatcher(wdi, errors, caseInsensitive)</span>
<span class="udiff-line-added">+                 );</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 matchers = Arrays.asList(</span>
<span class="udiff-line-added">+                         simpleMatcher(s -&gt; !s.startsWith(&quot;-&quot;))</span>
<span class="udiff-line-added">+                 );</span>
<span class="udiff-line-added">+             }</span>
              exact = s -&gt; caseInsensitive ? s.equalsIgnoreCase(wd) : s.equals(wd);
          }
          // Find matching candidates
          Map&lt;String, List&lt;Candidate&gt;&gt; matching = Collections.emptyMap();
          for (Function&lt;Map&lt;String, List&lt;Candidate&gt;&gt;,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4238,11 +4494,11 @@</span>
              // If we only need to display the list, do it now
              if (lst == CompletionType.List) {
                  List&lt;Candidate&gt; possible = matching.entrySet().stream()
                          .flatMap(e -&gt; e.getValue().stream())
                          .collect(Collectors.toList());
<span class="udiff-line-modified-removed">-                 doList(possible, line.word(), false, line::escape);</span>
<span class="udiff-line-modified-added">+                 doList(possible, line.word(), false, line::escape, forSuggestion);</span>
                  return !possible.isEmpty();
              }
  
              // Check if there&#39;s a single possible match
              Candidate completion = null;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4321,10 +4577,11 @@</span>
              boolean hasUnambiguous = commonPrefix.startsWith(current) &amp;&amp; !commonPrefix.equals(current);
  
              if (hasUnambiguous) {
                  buf.backspace(line.rawWordLength());
                  buf.write(line.escape(commonPrefix, false));
<span class="udiff-line-added">+                 callWidget(REDISPLAY);</span>
                  current = commonPrefix;
                  if ((!isSet(Option.AUTO_LIST) &amp;&amp; isSet(Option.AUTO_MENU))
                          || (isSet(Option.AUTO_LIST) &amp;&amp; isSet(Option.LIST_AMBIGUOUS))) {
                      if (!nextBindingIsComplete()) {
                          return true;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4385,11 +4642,10 @@</span>
      protected Comparator&lt;Candidate&gt; getCandidateComparator(boolean caseInsensitive, String word) {
          String wdi = caseInsensitive ? word.toLowerCase() : word;
          ToIntFunction&lt;String&gt; wordDistance = w -&gt; distance(wdi, caseInsensitive ? w.toLowerCase() : w);
          return Comparator
                  .comparing(Candidate::value, Comparator.comparingInt(wordDistance))
<span class="udiff-line-removed">-                 .thenComparing(Candidate::value, Comparator.comparingInt(String::length))</span>
                  .thenComparing(Comparator.naturalOrder());
      }
  
      protected String getOthersGroupName() {
          return getString(OTHERS_GROUP_NAME, DEFAULT_OTHERS_GROUP_NAME);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4594,12 +4850,14 @@</span>
  
              // Compute displayed prompt
              PostResult pr = computePost(possible, completion(), null, completed);
              AttributedString text = insertSecondaryPrompts(AttributedStringBuilder.append(prompt, buf.toString()), new ArrayList&lt;&gt;());
              int promptLines = text.columnSplitLength(size.getColumns(), false, display.delayLineWrap()).size();
<span class="udiff-line-modified-removed">-             if (pr.lines &gt; size.getRows() - promptLines) {</span>
<span class="udiff-line-modified-removed">-                 int displayed = size.getRows() - promptLines - 1;</span>
<span class="udiff-line-modified-added">+             Status status = Status.getStatus(terminal, false);</span>
<span class="udiff-line-modified-added">+             int displaySize = size.getRows() - (status != null ? status.size() : 0) - promptLines;</span>
<span class="udiff-line-added">+             if (pr.lines &gt; displaySize) {</span>
<span class="udiff-line-added">+                 int displayed = displaySize - 1;</span>
                  if (pr.selectedLine &gt;= 0) {
                      if (pr.selectedLine &lt; topLine) {
                          topLine = pr.selectedLine;
                      } else if (pr.selectedLine &gt;= topLine + displayed) {
                          topLine = pr.selectedLine - displayed + 1;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4646,11 +4904,11 @@</span>
          computePost(original, null, possible, completed);
  
          // Build menu support
          MenuSupport menuSupport = new MenuSupport(original, completed, escaper);
          post = menuSupport;
<span class="udiff-line-modified-removed">-         redisplay();</span>
<span class="udiff-line-modified-added">+         callWidget(REDISPLAY);</span>
  
          // Loop
          KeyMap&lt;Binding&gt; keyMap = keyMaps.get(MENU);
          Binding operation;
          while ((operation = readBinding(getKeys(), keyMap)) != null) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4702,16 +4960,28 @@</span>
                      }
                      post = null;
                      return true;
                  }
              }
<span class="udiff-line-modified-removed">-             redisplay();</span>
<span class="udiff-line-modified-added">+             doAutosuggestion = false;</span>
<span class="udiff-line-added">+             callWidget(REDISPLAY);</span>
          }
          return false;
      }
  
<span class="udiff-line-modified-removed">-     protected boolean doList(List&lt;Candidate&gt; possible, String completed, boolean runLoop, BiFunction&lt;CharSequence, Boolean, CharSequence&gt; escaper) {</span>
<span class="udiff-line-modified-added">+     protected boolean clearChoices() {</span>
<span class="udiff-line-added">+         return doList(new ArrayList&lt;Candidate&gt;(), &quot;&quot;, false, null, false);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     protected boolean doList(List&lt;Candidate&gt; possible</span>
<span class="udiff-line-added">+                            , String completed, boolean runLoop, BiFunction&lt;CharSequence, Boolean, CharSequence&gt; escaper) {</span>
<span class="udiff-line-added">+         return doList(possible, completed, runLoop, escaper, false);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     protected boolean doList(List&lt;Candidate&gt; possible</span>
<span class="udiff-line-added">+                            , String completed</span>
<span class="udiff-line-added">+                            , boolean runLoop, BiFunction&lt;CharSequence, Boolean, CharSequence&gt; escaper, boolean forSuggestion) {</span>
          // If we list only and if there&#39;s a big
          // number of items, we should ask the user
          // for confirmation, display the list
          // and redraw the line at the bottom
          mergeCandidates(possible);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4720,17 +4990,21 @@</span>
          PostResult postResult = computePost(possible, null, null, completed);
          int lines = postResult.lines;
          int listMax = getInt(LIST_MAX, DEFAULT_LIST_MAX);
          if (listMax &gt; 0 &amp;&amp; possible.size() &gt;= listMax
                  || lines &gt;= size.getRows() - promptLines) {
<span class="udiff-line-modified-removed">-             // prompt</span>
<span class="udiff-line-modified-removed">-             post = () -&gt; new AttributedString(getAppName() + &quot;: do you wish to see all &quot; + possible.size()</span>
<span class="udiff-line-modified-removed">-                     + &quot; possibilities (&quot; + lines + &quot; lines)?&quot;);</span>
<span class="udiff-line-modified-removed">-             redisplay(true);</span>
<span class="udiff-line-modified-removed">-             int c = readCharacter();</span>
<span class="udiff-line-modified-removed">-             if (c != &#39;y&#39; &amp;&amp; c != &#39;Y&#39; &amp;&amp; c != &#39;\t&#39;) {</span>
<span class="udiff-line-modified-removed">-                 post = null;</span>
<span class="udiff-line-modified-added">+             if (!forSuggestion) {</span>
<span class="udiff-line-modified-added">+                 // prompt</span>
<span class="udiff-line-modified-added">+                 post = () -&gt; new AttributedString(getAppName() + &quot;: do you wish to see all &quot; + possible.size()</span>
<span class="udiff-line-modified-added">+                         + &quot; possibilities (&quot; + lines + &quot; lines)?&quot;);</span>
<span class="udiff-line-modified-added">+                 redisplay(true);</span>
<span class="udiff-line-modified-added">+                 int c = readCharacter();</span>
<span class="udiff-line-modified-added">+                 if (c != &#39;y&#39; &amp;&amp; c != &#39;Y&#39; &amp;&amp; c != &#39;\t&#39;) {</span>
<span class="udiff-line-added">+                     post = null;</span>
<span class="udiff-line-added">+                     return false;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else {</span>
                  return false;
              }
          }
  
          boolean caseInsensitive = isSet(Option.CASE_INSENSITIVE);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4787,11 +5061,11 @@</span>
                          sb.setLength(sb.length() - 1);
                          buf.backspace();
                      }
                  } else if (SELF_INSERT.equals(name)) {
                      sb.append(getLastBinding());
<span class="udiff-line-modified-removed">-                     buf.write(getLastBinding());</span>
<span class="udiff-line-modified-added">+                     callWidget(name);</span>
                      if (cands.isEmpty()) {
                          post = null;
                          return false;
                      }
                  } else if (&quot;\t&quot;.equals(getLastBinding())) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5368,32 +5642,14 @@</span>
          }
          return true;
      }
  
      public boolean beginPaste() {
<span class="udiff-line-modified-removed">-         final Object SELF_INSERT = new Object();</span>
<span class="udiff-line-removed">-         final Object END_PASTE = new Object();</span>
<span class="udiff-line-removed">-         KeyMap&lt;Object&gt; keyMap = new KeyMap&lt;&gt;();</span>
<span class="udiff-line-removed">-         keyMap.setUnicode(SELF_INSERT);</span>
<span class="udiff-line-removed">-         keyMap.setNomatch(SELF_INSERT);</span>
<span class="udiff-line-removed">-         keyMap.setAmbiguousTimeout(0);</span>
<span class="udiff-line-removed">-         keyMap.bind(END_PASTE, BRACKETED_PASTE_END);</span>
<span class="udiff-line-removed">-         StringBuilder sb = new StringBuilder();</span>
<span class="udiff-line-removed">-         while (true) {</span>
<span class="udiff-line-removed">-             Object b = doReadBinding(keyMap, null);</span>
<span class="udiff-line-removed">-             if (b == END_PASTE) {</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             String s = getLastBinding();</span>
<span class="udiff-line-removed">-             if (&quot;\r&quot;.equals(s)) {</span>
<span class="udiff-line-removed">-                 s = &quot;\n&quot;;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             sb.append(s);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         String str = doReadStringUntil(BRACKETED_PASTE_END);</span>
          regionActive = RegionType.PASTE;
          regionMark = getBuffer().cursor();
<span class="udiff-line-modified-removed">-         getBuffer().write(sb);</span>
<span class="udiff-line-modified-added">+         getBuffer().write(str.replace(&#39;\r&#39;, &#39;\n&#39;));</span>
          return true;
      }
  
      public boolean focusIn() {
          return false;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5585,10 +5841,11 @@</span>
          bind(emacs, INSERT_CLOSE_SQUARE,                    &quot;]&quot;);
          bind(emacs, INSERT_CLOSE_CURLY,                     &quot;}&quot;);
          bind(emacs, BACKWARD_DELETE_CHAR,                   del());
          bind(emacs, VI_MATCH_BRACKET,                       translate(&quot;^X^B&quot;));
          bind(emacs, SEND_BREAK,                             translate(&quot;^X^G&quot;));
<span class="udiff-line-added">+         bind(emacs, EDIT_AND_EXECUTE_COMMAND,               translate(&quot;^X^E&quot;));</span>
          bind(emacs, VI_FIND_NEXT_CHAR,                      translate(&quot;^X^F&quot;));
          bind(emacs, VI_JOIN,                                translate(&quot;^X^J&quot;));
          bind(emacs, KILL_BUFFER,                            translate(&quot;^X^K&quot;));
          bind(emacs, INFER_NEXT_HISTORY,                     translate(&quot;^X^N&quot;));
          bind(emacs, OVERWRITE_MODE,                         translate(&quot;^X^O&quot;));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5885,7 +6142,6 @@</span>
              bind(keyMap, SELF_INSERT, prevBinding);
              keyMap.bind(ref, Character.toString(newBinding));
          }
      }
  
<span class="udiff-line-removed">- </span>
  }
</pre>
<center><a href="DefaultParser.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="completer/ArgumentCompleter.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>