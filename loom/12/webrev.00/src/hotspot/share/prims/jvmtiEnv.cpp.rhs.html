<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/prims/jvmtiEnv.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderExt.hpp&quot;
  27 #include &quot;classfile/javaClasses.inline.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;classfile/modules.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;classfile/vmSymbols.hpp&quot;
  32 #include &quot;interpreter/bytecodeStream.hpp&quot;
  33 #include &quot;interpreter/interpreter.hpp&quot;
  34 #include &quot;jfr/jfrEvents.hpp&quot;
  35 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  36 #include &quot;logging/log.hpp&quot;
  37 #include &quot;logging/logConfiguration.hpp&quot;
  38 #include &quot;memory/resourceArea.hpp&quot;
  39 #include &quot;memory/universe.hpp&quot;
  40 #include &quot;oops/instanceKlass.hpp&quot;
  41 #include &quot;oops/objArrayOop.inline.hpp&quot;
  42 #include &quot;oops/oop.inline.hpp&quot;
  43 #include &quot;prims/jniCheck.hpp&quot;
  44 #include &quot;prims/jvm_misc.hpp&quot;
  45 #include &quot;prims/jvmtiAgentThread.hpp&quot;
  46 #include &quot;prims/jvmtiClassFileReconstituter.hpp&quot;
  47 #include &quot;prims/jvmtiCodeBlobEvents.hpp&quot;
  48 #include &quot;prims/jvmtiExtensions.hpp&quot;
  49 #include &quot;prims/jvmtiGetLoadedClasses.hpp&quot;
  50 #include &quot;prims/jvmtiImpl.hpp&quot;
  51 #include &quot;prims/jvmtiManageCapabilities.hpp&quot;
  52 #include &quot;prims/jvmtiRawMonitor.hpp&quot;
  53 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  54 #include &quot;prims/jvmtiTagMap.hpp&quot;
  55 #include &quot;prims/jvmtiThreadState.inline.hpp&quot;
  56 #include &quot;prims/jvmtiUtil.hpp&quot;
  57 #include &quot;runtime/arguments.hpp&quot;
  58 #include &quot;runtime/deoptimization.hpp&quot;
  59 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  60 #include &quot;runtime/handles.inline.hpp&quot;
  61 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  62 #include &quot;runtime/javaCalls.hpp&quot;
  63 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  64 #include &quot;runtime/jniHandles.inline.hpp&quot;
  65 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  66 #include &quot;runtime/osThread.hpp&quot;
  67 #include &quot;runtime/reflectionUtils.hpp&quot;
  68 #include &quot;runtime/signature.hpp&quot;
  69 #include &quot;runtime/thread.inline.hpp&quot;
  70 #include &quot;runtime/threadHeapSampler.hpp&quot;
  71 #include &quot;runtime/threadSMR.hpp&quot;
  72 #include &quot;runtime/timerTrace.hpp&quot;
  73 #include &quot;runtime/vframe.inline.hpp&quot;
  74 #include &quot;runtime/vmThread.hpp&quot;
  75 #include &quot;services/threadService.hpp&quot;
  76 #include &quot;utilities/exceptions.hpp&quot;
  77 #include &quot;utilities/preserveException.hpp&quot;
  78 #include &quot;utilities/utf8.hpp&quot;
  79 
  80 
  81 #define FIXLATER 0 // REMOVE this when completed.
  82 
  83  // FIXLATER: hook into JvmtiTrace
  84 #define TraceJVMTICalls false
  85 
  86 JvmtiEnv::JvmtiEnv(jint version) : JvmtiEnvBase(version) {
  87 }
  88 
  89 JvmtiEnv::~JvmtiEnv() {
  90 }
  91 
  92 JvmtiEnv*
  93 JvmtiEnv::create_a_jvmti(jint version) {
  94   return new JvmtiEnv(version);
  95 }
  96 
  97 // VM operation class to copy jni function table at safepoint.
  98 // More than one java threads or jvmti agents may be reading/
  99 // modifying jni function tables. To reduce the risk of bad
 100 // interaction b/w these threads it is copied at safepoint.
 101 class VM_JNIFunctionTableCopier : public VM_Operation {
 102  private:
 103   const struct JNINativeInterface_ *_function_table;
 104  public:
 105   VM_JNIFunctionTableCopier(const struct JNINativeInterface_ *func_tbl) {
 106     _function_table = func_tbl;
 107   };
 108 
 109   VMOp_Type type() const { return VMOp_JNIFunctionTableCopier; }
 110   void doit() {
 111     copy_jni_function_table(_function_table);
 112   };
 113 };
 114 
 115 //
 116 // Do not change the &quot;prefix&quot; marker below, everything above it is copied
 117 // unchanged into the filled stub, everything below is controlled by the
 118 // stub filler (only method bodies are carried forward, and then only for
 119 // functionality still in the spec).
 120 //
 121 // end file prefix
 122 
 123   //
 124   // Memory Management functions
 125   //
 126 
 127 // mem_ptr - pre-checked for NULL
 128 jvmtiError
 129 JvmtiEnv::Allocate(jlong size, unsigned char** mem_ptr) {
 130   return allocate(size, mem_ptr);
 131 } /* end Allocate */
 132 
 133 
 134 // mem - NULL is a valid value, must be checked
 135 jvmtiError
 136 JvmtiEnv::Deallocate(unsigned char* mem) {
 137   return deallocate(mem);
 138 } /* end Deallocate */
 139 
 140 // Threads_lock NOT held, java_thread not protected by lock
 141 // java_thread - pre-checked
 142 // data - NULL is a valid value, must be checked
 143 jvmtiError
 144 JvmtiEnv::SetThreadLocalStorage(JavaThread* java_thread, const void* data) {
 145   JvmtiThreadState* state = java_thread-&gt;jvmti_thread_state();
 146   if (state == NULL) {
 147     if (data == NULL) {
 148       // leaving state unset same as data set to NULL
 149       return JVMTI_ERROR_NONE;
 150     }
 151     // otherwise, create the state
 152     state = JvmtiThreadState::state_for(java_thread);
 153     if (state == NULL) {
 154       return JVMTI_ERROR_THREAD_NOT_ALIVE;
 155     }
 156   }
 157   state-&gt;env_thread_state(this)-&gt;set_agent_thread_local_storage_data((void*)data);
 158   return JVMTI_ERROR_NONE;
 159 } /* end SetThreadLocalStorage */
 160 
 161 
 162 // Threads_lock NOT held
 163 // thread - NOT pre-checked
 164 // data_ptr - pre-checked for NULL
 165 jvmtiError
 166 JvmtiEnv::GetThreadLocalStorage(jthread thread, void** data_ptr) {
 167   JavaThread* current_thread = JavaThread::current();
 168   if (thread == NULL) {
 169     JvmtiThreadState* state = current_thread-&gt;jvmti_thread_state();
 170     *data_ptr = (state == NULL) ? NULL :
 171       state-&gt;env_thread_state(this)-&gt;get_agent_thread_local_storage_data();
 172   } else {
 173     // jvmti_GetThreadLocalStorage is &quot;in native&quot; and doesn&#39;t transition
 174     // the thread to _thread_in_vm. However, when the TLS for a thread
 175     // other than the current thread is required we need to transition
 176     // from native so as to resolve the jthread.
 177 
 178     ThreadInVMfromNative __tiv(current_thread);
 179     VM_ENTRY_BASE(jvmtiError, JvmtiEnv::GetThreadLocalStorage , current_thread)
 180     debug_only(VMNativeEntryWrapper __vew;)
 181 
 182     JavaThread* java_thread = NULL;
 183     ThreadsListHandle tlh(current_thread);
 184     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, NULL);
 185     if (err != JVMTI_ERROR_NONE) {
 186       return err;
 187     }
 188 
 189     JvmtiThreadState* state = java_thread-&gt;jvmti_thread_state();
 190     *data_ptr = (state == NULL) ? NULL :
 191       state-&gt;env_thread_state(this)-&gt;get_agent_thread_local_storage_data();
 192   }
 193   return JVMTI_ERROR_NONE;
 194 } /* end GetThreadLocalStorage */
 195 
 196   //
 197   // Module functions
 198   //
 199 
 200 // module_count_ptr - pre-checked for NULL
 201 // modules_ptr - pre-checked for NULL
 202 jvmtiError
 203 JvmtiEnv::GetAllModules(jint* module_count_ptr, jobject** modules_ptr) {
 204     JvmtiModuleClosure jmc;
 205 
 206     return jmc.get_all_modules(this, module_count_ptr, modules_ptr);
 207 } /* end GetAllModules */
 208 
 209 
 210 // class_loader - NULL is a valid value, must be pre-checked
 211 // package_name - pre-checked for NULL
 212 // module_ptr - pre-checked for NULL
 213 jvmtiError
 214 JvmtiEnv::GetNamedModule(jobject class_loader, const char* package_name, jobject* module_ptr) {
 215   JavaThread* THREAD = JavaThread::current(); // pass to macros
 216   ResourceMark rm(THREAD);
 217 
 218   Handle h_loader (THREAD, JNIHandles::resolve(class_loader));
 219   // Check that loader is a subclass of java.lang.ClassLoader.
 220   if (h_loader.not_null() &amp;&amp; !java_lang_ClassLoader::is_subclass(h_loader-&gt;klass())) {
 221     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 222   }
 223   jobject module = Modules::get_named_module(h_loader, package_name, THREAD);
 224   if (HAS_PENDING_EXCEPTION) {
 225     CLEAR_PENDING_EXCEPTION;
 226     return JVMTI_ERROR_INTERNAL; // unexpected exception
 227   }
 228   *module_ptr = module;
 229   return JVMTI_ERROR_NONE;
 230 } /* end GetNamedModule */
 231 
 232 
 233 // module - pre-checked for NULL
 234 // to_module - pre-checked for NULL
 235 jvmtiError
 236 JvmtiEnv::AddModuleReads(jobject module, jobject to_module) {
 237   JavaThread* THREAD = JavaThread::current();
 238 
 239   // check module
 240   Handle h_module(THREAD, JNIHandles::resolve(module));
 241   if (!java_lang_Module::is_instance(h_module())) {
 242     return JVMTI_ERROR_INVALID_MODULE;
 243   }
 244   // check to_module
 245   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 246   if (!java_lang_Module::is_instance(h_to_module())) {
 247     return JVMTI_ERROR_INVALID_MODULE;
 248   }
 249   return JvmtiExport::add_module_reads(h_module, h_to_module, THREAD);
 250 } /* end AddModuleReads */
 251 
 252 
 253 // module - pre-checked for NULL
 254 // pkg_name - pre-checked for NULL
 255 // to_module - pre-checked for NULL
 256 jvmtiError
 257 JvmtiEnv::AddModuleExports(jobject module, const char* pkg_name, jobject to_module) {
 258   JavaThread* THREAD = JavaThread::current();
 259   Handle h_pkg = java_lang_String::create_from_str(pkg_name, THREAD);
 260 
 261   // check module
 262   Handle h_module(THREAD, JNIHandles::resolve(module));
 263   if (!java_lang_Module::is_instance(h_module())) {
 264     return JVMTI_ERROR_INVALID_MODULE;
 265   }
 266   // check to_module
 267   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 268   if (!java_lang_Module::is_instance(h_to_module())) {
 269     return JVMTI_ERROR_INVALID_MODULE;
 270   }
 271   return JvmtiExport::add_module_exports(h_module, h_pkg, h_to_module, THREAD);
 272 } /* end AddModuleExports */
 273 
 274 
 275 // module - pre-checked for NULL
 276 // pkg_name - pre-checked for NULL
 277 // to_module - pre-checked for NULL
 278 jvmtiError
 279 JvmtiEnv::AddModuleOpens(jobject module, const char* pkg_name, jobject to_module) {
 280   JavaThread* THREAD = JavaThread::current();
 281   Handle h_pkg = java_lang_String::create_from_str(pkg_name, THREAD);
 282 
 283   // check module
 284   Handle h_module(THREAD, JNIHandles::resolve(module));
 285   if (!java_lang_Module::is_instance(h_module())) {
 286     return JVMTI_ERROR_INVALID_MODULE;
 287   }
 288   // check to_module
 289   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 290   if (!java_lang_Module::is_instance(h_to_module())) {
 291     return JVMTI_ERROR_INVALID_MODULE;
 292   }
 293   return JvmtiExport::add_module_opens(h_module, h_pkg, h_to_module, THREAD);
 294 } /* end AddModuleOpens */
 295 
 296 
 297 // module - pre-checked for NULL
 298 // service - pre-checked for NULL
 299 jvmtiError
 300 JvmtiEnv::AddModuleUses(jobject module, jclass service) {
 301   JavaThread* THREAD = JavaThread::current();
 302 
 303   // check module
 304   Handle h_module(THREAD, JNIHandles::resolve(module));
 305   if (!java_lang_Module::is_instance(h_module())) {
 306     return JVMTI_ERROR_INVALID_MODULE;
 307   }
 308   // check service
 309   Handle h_service(THREAD, JNIHandles::resolve_external_guard(service));
 310   if (!java_lang_Class::is_instance(h_service()) ||
 311       java_lang_Class::is_primitive(h_service())) {
 312     return JVMTI_ERROR_INVALID_CLASS;
 313   }
 314   return JvmtiExport::add_module_uses(h_module, h_service, THREAD);
 315 } /* end AddModuleUses */
 316 
 317 
 318 // module - pre-checked for NULL
 319 // service - pre-checked for NULL
 320 // impl_class - pre-checked for NULL
 321 jvmtiError
 322 JvmtiEnv::AddModuleProvides(jobject module, jclass service, jclass impl_class) {
 323   JavaThread* THREAD = JavaThread::current();
 324 
 325   // check module
 326   Handle h_module(THREAD, JNIHandles::resolve(module));
 327   if (!java_lang_Module::is_instance(h_module())) {
 328     return JVMTI_ERROR_INVALID_MODULE;
 329   }
 330   // check service
 331   Handle h_service(THREAD, JNIHandles::resolve_external_guard(service));
 332   if (!java_lang_Class::is_instance(h_service()) ||
 333       java_lang_Class::is_primitive(h_service())) {
 334     return JVMTI_ERROR_INVALID_CLASS;
 335   }
 336   // check impl_class
 337   Handle h_impl_class(THREAD, JNIHandles::resolve_external_guard(impl_class));
 338   if (!java_lang_Class::is_instance(h_impl_class()) ||
 339       java_lang_Class::is_primitive(h_impl_class())) {
 340     return JVMTI_ERROR_INVALID_CLASS;
 341   }
 342   return JvmtiExport::add_module_provides(h_module, h_service, h_impl_class, THREAD);
 343 } /* end AddModuleProvides */
 344 
 345 // module - pre-checked for NULL
 346 // is_modifiable_class_ptr - pre-checked for NULL
 347 jvmtiError
 348 JvmtiEnv::IsModifiableModule(jobject module, jboolean* is_modifiable_module_ptr) {
 349   JavaThread* THREAD = JavaThread::current();
 350 
 351   // check module
 352   Handle h_module(THREAD, JNIHandles::resolve(module));
 353   if (!java_lang_Module::is_instance(h_module())) {
 354     return JVMTI_ERROR_INVALID_MODULE;
 355   }
 356 
 357   *is_modifiable_module_ptr = JNI_TRUE;
 358   return JVMTI_ERROR_NONE;
 359 } /* end IsModifiableModule */
 360 
 361 
 362   //
 363   // Class functions
 364   //
 365 
 366 // class_count_ptr - pre-checked for NULL
 367 // classes_ptr - pre-checked for NULL
 368 jvmtiError
 369 JvmtiEnv::GetLoadedClasses(jint* class_count_ptr, jclass** classes_ptr) {
 370   return JvmtiGetLoadedClasses::getLoadedClasses(this, class_count_ptr, classes_ptr);
 371 } /* end GetLoadedClasses */
 372 
 373 
 374 // initiating_loader - NULL is a valid value, must be checked
 375 // class_count_ptr - pre-checked for NULL
 376 // classes_ptr - pre-checked for NULL
 377 jvmtiError
 378 JvmtiEnv::GetClassLoaderClasses(jobject initiating_loader, jint* class_count_ptr, jclass** classes_ptr) {
 379   return JvmtiGetLoadedClasses::getClassLoaderClasses(this, initiating_loader,
 380                                                   class_count_ptr, classes_ptr);
 381 } /* end GetClassLoaderClasses */
 382 
 383 // k_mirror - may be primitive, this must be checked
 384 // is_modifiable_class_ptr - pre-checked for NULL
 385 jvmtiError
 386 JvmtiEnv::IsModifiableClass(oop k_mirror, jboolean* is_modifiable_class_ptr) {
 387   *is_modifiable_class_ptr = VM_RedefineClasses::is_modifiable_class(k_mirror)?
 388                                                        JNI_TRUE : JNI_FALSE;
 389   return JVMTI_ERROR_NONE;
 390 } /* end IsModifiableClass */
 391 
 392 // class_count - pre-checked to be greater than or equal to 0
 393 // classes - pre-checked for NULL
 394 jvmtiError
 395 JvmtiEnv::RetransformClasses(jint class_count, const jclass* classes) {
 396 //TODO: add locking
 397 
 398   int index;
 399   JavaThread* current_thread = JavaThread::current();
 400   ResourceMark rm(current_thread);
 401 
 402   jvmtiClassDefinition* class_definitions =
 403                             NEW_RESOURCE_ARRAY(jvmtiClassDefinition, class_count);
 404   NULL_CHECK(class_definitions, JVMTI_ERROR_OUT_OF_MEMORY);
 405 
 406   for (index = 0; index &lt; class_count; index++) {
 407     HandleMark hm(current_thread);
 408 
 409     jclass jcls = classes[index];
 410     oop k_mirror = JNIHandles::resolve_external_guard(jcls);
 411     if (k_mirror == NULL) {
 412       return JVMTI_ERROR_INVALID_CLASS;
 413     }
 414     if (!k_mirror-&gt;is_a(SystemDictionary::Class_klass())) {
 415       return JVMTI_ERROR_INVALID_CLASS;
 416     }
 417 
 418     if (!VM_RedefineClasses::is_modifiable_class(k_mirror)) {
 419       return JVMTI_ERROR_UNMODIFIABLE_CLASS;
 420     }
 421 
 422     Klass* klass = java_lang_Class::as_Klass(k_mirror);
 423 
 424     jint status = klass-&gt;jvmti_class_status();
 425     if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
 426       return JVMTI_ERROR_INVALID_CLASS;
 427     }
 428 
 429     InstanceKlass* ik = InstanceKlass::cast(klass);
 430     if (ik-&gt;get_cached_class_file_bytes() == NULL) {
 431       // Not cached, we need to reconstitute the class file from the
 432       // VM representation. We don&#39;t attach the reconstituted class
 433       // bytes to the InstanceKlass here because they have not been
 434       // validated and we&#39;re not at a safepoint.
 435       JvmtiClassFileReconstituter reconstituter(ik);
 436       if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
 437         return reconstituter.get_error();
 438       }
 439 
 440       class_definitions[index].class_byte_count = (jint)reconstituter.class_file_size();
 441       class_definitions[index].class_bytes      = (unsigned char*)
 442                                                        reconstituter.class_file_bytes();
 443     } else {
 444       // it is cached, get it from the cache
 445       class_definitions[index].class_byte_count = ik-&gt;get_cached_class_file_len();
 446       class_definitions[index].class_bytes      = ik-&gt;get_cached_class_file_bytes();
 447     }
 448     class_definitions[index].klass              = jcls;
 449   }
 450   EventRetransformClasses event;
 451   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_retransform);
 452   VMThread::execute(&amp;op);
 453   jvmtiError error = op.check_error();
 454   if (error == JVMTI_ERROR_NONE) {
 455     event.set_classCount(class_count);
 456     event.set_redefinitionId(op.id());
 457     event.commit();
 458   }
 459   return error;
 460 } /* end RetransformClasses */
 461 
 462 
 463 // class_count - pre-checked to be greater than or equal to 0
 464 // class_definitions - pre-checked for NULL
 465 jvmtiError
 466 JvmtiEnv::RedefineClasses(jint class_count, const jvmtiClassDefinition* class_definitions) {
 467 //TODO: add locking
 468   EventRedefineClasses event;
 469   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_redefine);
 470   VMThread::execute(&amp;op);
 471   jvmtiError error = op.check_error();
 472   if (error == JVMTI_ERROR_NONE) {
 473     event.set_classCount(class_count);
 474     event.set_redefinitionId(op.id());
 475     event.commit();
 476   }
 477   return error;
 478 } /* end RedefineClasses */
 479 
 480 
 481   //
 482   // Object functions
 483   //
 484 
 485 // size_ptr - pre-checked for NULL
 486 jvmtiError
 487 JvmtiEnv::GetObjectSize(jobject object, jlong* size_ptr) {
 488   oop mirror = JNIHandles::resolve_external_guard(object);
 489   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
 490   *size_ptr = (jlong)Universe::heap()-&gt;obj_size(mirror) * wordSize;
 491   return JVMTI_ERROR_NONE;
 492 } /* end GetObjectSize */
 493 
 494   //
 495   // Method functions
 496   //
 497 
 498 // prefix - NULL is a valid value, must be checked
 499 jvmtiError
 500 JvmtiEnv::SetNativeMethodPrefix(const char* prefix) {
 501   return prefix == NULL?
 502               SetNativeMethodPrefixes(0, NULL) :
 503               SetNativeMethodPrefixes(1, (char**)&amp;prefix);
 504 } /* end SetNativeMethodPrefix */
 505 
 506 
 507 // prefix_count - pre-checked to be greater than or equal to 0
 508 // prefixes - pre-checked for NULL
 509 jvmtiError
 510 JvmtiEnv::SetNativeMethodPrefixes(jint prefix_count, char** prefixes) {
 511   // Have to grab JVMTI thread state lock to be sure that some thread
 512   // isn&#39;t accessing the prefixes at the same time we are setting them.
 513   // No locks during VM bring-up.
 514   if (Threads::number_of_threads() == 0) {
 515     return set_native_method_prefixes(prefix_count, prefixes);
 516   } else {
 517     MutexLocker mu(JvmtiThreadState_lock);
 518     return set_native_method_prefixes(prefix_count, prefixes);
 519   }
 520 } /* end SetNativeMethodPrefixes */
 521 
 522   //
 523   // Event Management functions
 524   //
 525 
 526 // callbacks - NULL is a valid value, must be checked
 527 // size_of_callbacks - pre-checked to be greater than or equal to 0
 528 jvmtiError
 529 JvmtiEnv::SetEventCallbacks(const jvmtiEventCallbacks* callbacks, jint size_of_callbacks) {
 530   JvmtiEventController::set_event_callbacks(this, callbacks, size_of_callbacks);
 531   return JVMTI_ERROR_NONE;
 532 } /* end SetEventCallbacks */
 533 
 534 
 535 // event_thread - NULL is a valid value, must be checked
 536 jvmtiError
 537 JvmtiEnv::SetEventNotificationMode(jvmtiEventMode mode, jvmtiEvent event_type, jthread event_thread,   ...) {
 538   if (event_thread == NULL) {
 539     // Can be called at Agent_OnLoad() time with event_thread == NULL
 540     // when Thread::current() does not work yet so we cannot create a
 541     // ThreadsListHandle that is common to both thread-specific and
 542     // global code paths.
 543 
 544     // event_type must be valid
 545     if (!JvmtiEventController::is_valid_event_type(event_type)) {
 546       return JVMTI_ERROR_INVALID_EVENT_TYPE;
 547     }
 548 
 549     bool enabled = (mode == JVMTI_ENABLE);
 550 
 551     // assure that needed capabilities are present
 552     if (enabled &amp;&amp; !JvmtiUtil::has_event_capability(event_type, get_capabilities())) {
 553       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 554     }
 555 
 556     if (event_type == JVMTI_EVENT_CLASS_FILE_LOAD_HOOK &amp;&amp; enabled) {
 557       record_class_file_load_hook_enabled();
 558     }
 559 
 560     JvmtiEventController::set_user_enabled(this, (JavaThread*) NULL, event_type, enabled);
 561   } else {
 562     // We have a specified event_thread.
 563     JavaThread* java_thread = NULL;
 564     ThreadsListHandle tlh;
 565     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), event_thread, &amp;java_thread, NULL);
 566     if (err != JVMTI_ERROR_NONE) {
 567       return err;
 568     }
 569 
 570     // event_type must be valid
 571     if (!JvmtiEventController::is_valid_event_type(event_type)) {
 572       return JVMTI_ERROR_INVALID_EVENT_TYPE;
 573     }
 574 
 575     // global events cannot be controlled at thread level.
 576     if (JvmtiEventController::is_global_event(event_type)) {
 577       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 578     }
 579 
 580     bool enabled = (mode == JVMTI_ENABLE);
 581 
 582     // assure that needed capabilities are present
 583     if (enabled &amp;&amp; !JvmtiUtil::has_event_capability(event_type, get_capabilities())) {
 584       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 585     }
 586 
 587     if (event_type == JVMTI_EVENT_CLASS_FILE_LOAD_HOOK &amp;&amp; enabled) {
 588       record_class_file_load_hook_enabled();
 589     }
 590     JvmtiEventController::set_user_enabled(this, java_thread, event_type, enabled);
 591   }
 592 
 593   return JVMTI_ERROR_NONE;
 594 } /* end SetEventNotificationMode */
 595 
 596   //
 597   // Capability functions
 598   //
 599 
 600 // capabilities_ptr - pre-checked for NULL
 601 jvmtiError
 602 JvmtiEnv::GetPotentialCapabilities(jvmtiCapabilities* capabilities_ptr) {
 603   JvmtiManageCapabilities::get_potential_capabilities(get_capabilities(),
 604                                                       get_prohibited_capabilities(),
 605                                                       capabilities_ptr);
 606   return JVMTI_ERROR_NONE;
 607 } /* end GetPotentialCapabilities */
 608 
 609 
 610 // capabilities_ptr - pre-checked for NULL
 611 jvmtiError
 612 JvmtiEnv::AddCapabilities(const jvmtiCapabilities* capabilities_ptr) {
 613   return JvmtiManageCapabilities::add_capabilities(get_capabilities(),
 614                                                    get_prohibited_capabilities(),
 615                                                    capabilities_ptr,
 616                                                    get_capabilities());
 617 } /* end AddCapabilities */
 618 
 619 
 620 // capabilities_ptr - pre-checked for NULL
 621 jvmtiError
 622 JvmtiEnv::RelinquishCapabilities(const jvmtiCapabilities* capabilities_ptr) {
 623   JvmtiManageCapabilities::relinquish_capabilities(get_capabilities(), capabilities_ptr, get_capabilities());
 624   return JVMTI_ERROR_NONE;
 625 } /* end RelinquishCapabilities */
 626 
 627 
 628 // capabilities_ptr - pre-checked for NULL
 629 jvmtiError
 630 JvmtiEnv::GetCapabilities(jvmtiCapabilities* capabilities_ptr) {
 631   JvmtiManageCapabilities::copy_capabilities(get_capabilities(), capabilities_ptr);
 632   return JVMTI_ERROR_NONE;
 633 } /* end GetCapabilities */
 634 
 635   //
 636   // Class Loader Search functions
 637   //
 638 
 639 // segment - pre-checked for NULL
 640 jvmtiError
 641 JvmtiEnv::AddToBootstrapClassLoaderSearch(const char* segment) {
 642   jvmtiPhase phase = get_phase();
 643   if (phase == JVMTI_PHASE_ONLOAD) {
 644     Arguments::append_sysclasspath(segment);
 645     return JVMTI_ERROR_NONE;
 646   } else if (use_version_1_0_semantics()) {
 647     // This JvmtiEnv requested version 1.0 semantics and this function
 648     // is only allowed in the ONLOAD phase in version 1.0 so we need to
 649     // return an error here.
 650     return JVMTI_ERROR_WRONG_PHASE;
 651   } else if (phase == JVMTI_PHASE_LIVE) {
 652     // The phase is checked by the wrapper that called this function,
 653     // but this thread could be racing with the thread that is
 654     // terminating the VM so we check one more time.
 655 
 656     // create the zip entry
 657     ClassPathZipEntry* zip_entry = ClassLoader::create_class_path_zip_entry(segment, true);
 658     if (zip_entry == NULL) {
 659       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 660     }
 661 
 662     // lock the loader
 663     Thread* thread = Thread::current();
 664     HandleMark hm;
 665     Handle loader_lock = Handle(thread, SystemDictionary::system_loader_lock());
 666 
 667     ObjectLocker ol(loader_lock, thread);
 668 
 669     // add the jar file to the bootclasspath
 670     log_info(class, load)(&quot;opened: %s&quot;, zip_entry-&gt;name());
 671 #if INCLUDE_CDS
 672     ClassLoaderExt::append_boot_classpath(zip_entry);
 673 #else
 674     ClassLoader::add_to_boot_append_entries(zip_entry);
 675 #endif
 676     return JVMTI_ERROR_NONE;
 677   } else {
 678     return JVMTI_ERROR_WRONG_PHASE;
 679   }
 680 
 681 } /* end AddToBootstrapClassLoaderSearch */
 682 
 683 
 684 // segment - pre-checked for NULL
 685 jvmtiError
 686 JvmtiEnv::AddToSystemClassLoaderSearch(const char* segment) {
 687   jvmtiPhase phase = get_phase();
 688 
 689   if (phase == JVMTI_PHASE_ONLOAD) {
 690     for (SystemProperty* p = Arguments::system_properties(); p != NULL; p = p-&gt;next()) {
 691       if (strcmp(&quot;java.class.path&quot;, p-&gt;key()) == 0) {
 692         p-&gt;append_value(segment);
 693         break;
 694       }
 695     }
 696     return JVMTI_ERROR_NONE;
 697   } else if (phase == JVMTI_PHASE_LIVE) {
 698     // The phase is checked by the wrapper that called this function,
 699     // but this thread could be racing with the thread that is
 700     // terminating the VM so we check one more time.
 701     HandleMark hm;
 702 
 703     // create the zip entry (which will open the zip file and hence
 704     // check that the segment is indeed a zip file).
 705     ClassPathZipEntry* zip_entry = ClassLoader::create_class_path_zip_entry(segment, false);
 706     if (zip_entry == NULL) {
 707       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 708     }
 709     delete zip_entry;   // no longer needed
 710 
 711     // lock the loader
 712     Thread* THREAD = Thread::current();
 713     Handle loader = Handle(THREAD, SystemDictionary::java_system_loader());
 714 
 715     ObjectLocker ol(loader, THREAD);
 716 
 717     // need the path as java.lang.String
 718     Handle path = java_lang_String::create_from_platform_dependent_str(segment, THREAD);
 719     if (HAS_PENDING_EXCEPTION) {
 720       CLEAR_PENDING_EXCEPTION;
 721       return JVMTI_ERROR_INTERNAL;
 722     }
 723 
 724     // Invoke the appendToClassPathForInstrumentation method - if the method
 725     // is not found it means the loader doesn&#39;t support adding to the class path
 726     // in the live phase.
 727     {
 728       JavaValue res(T_VOID);
 729       JavaCalls::call_special(&amp;res,
 730                               loader,
 731                               loader-&gt;klass(),
 732                               vmSymbols::appendToClassPathForInstrumentation_name(),
 733                               vmSymbols::appendToClassPathForInstrumentation_signature(),
 734                               path,
 735                               THREAD);
 736       if (HAS_PENDING_EXCEPTION) {
 737         Symbol* ex_name = PENDING_EXCEPTION-&gt;klass()-&gt;name();
 738         CLEAR_PENDING_EXCEPTION;
 739 
 740         if (ex_name == vmSymbols::java_lang_NoSuchMethodError()) {
 741           return JVMTI_ERROR_CLASS_LOADER_UNSUPPORTED;
 742         } else {
 743           return JVMTI_ERROR_INTERNAL;
 744         }
 745       }
 746     }
 747 
 748     return JVMTI_ERROR_NONE;
 749   } else {
 750     return JVMTI_ERROR_WRONG_PHASE;
 751   }
 752 } /* end AddToSystemClassLoaderSearch */
 753 
 754   //
 755   // General functions
 756   //
 757 
 758 // phase_ptr - pre-checked for NULL
 759 jvmtiError
 760 JvmtiEnv::GetPhase(jvmtiPhase* phase_ptr) {
 761   *phase_ptr = phase();
 762   return JVMTI_ERROR_NONE;
 763 } /* end GetPhase */
 764 
 765 
 766 jvmtiError
 767 JvmtiEnv::DisposeEnvironment() {
 768   dispose();
 769   return JVMTI_ERROR_NONE;
 770 } /* end DisposeEnvironment */
 771 
 772 
 773 // data - NULL is a valid value, must be checked
 774 jvmtiError
 775 JvmtiEnv::SetEnvironmentLocalStorage(const void* data) {
 776   set_env_local_storage(data);
 777   return JVMTI_ERROR_NONE;
 778 } /* end SetEnvironmentLocalStorage */
 779 
 780 
 781 // data_ptr - pre-checked for NULL
 782 jvmtiError
 783 JvmtiEnv::GetEnvironmentLocalStorage(void** data_ptr) {
 784   *data_ptr = (void*)get_env_local_storage();
 785   return JVMTI_ERROR_NONE;
 786 } /* end GetEnvironmentLocalStorage */
 787 
 788 // version_ptr - pre-checked for NULL
 789 jvmtiError
 790 JvmtiEnv::GetVersionNumber(jint* version_ptr) {
 791   *version_ptr = JVMTI_VERSION;
 792   return JVMTI_ERROR_NONE;
 793 } /* end GetVersionNumber */
 794 
 795 
 796 // name_ptr - pre-checked for NULL
 797 jvmtiError
 798 JvmtiEnv::GetErrorName(jvmtiError error, char** name_ptr) {
 799   if (error &lt; JVMTI_ERROR_NONE || error &gt; JVMTI_ERROR_MAX) {
 800     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 801   }
 802   const char *name = JvmtiUtil::error_name(error);
 803   if (name == NULL) {
 804     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 805   }
 806   size_t len = strlen(name) + 1;
 807   jvmtiError err = allocate(len, (unsigned char**)name_ptr);
 808   if (err == JVMTI_ERROR_NONE) {
 809     memcpy(*name_ptr, name, len);
 810   }
 811   return err;
 812 } /* end GetErrorName */
 813 
 814 
 815 jvmtiError
 816 JvmtiEnv::SetVerboseFlag(jvmtiVerboseFlag flag, jboolean value) {
 817   LogLevelType level = value == 0 ? LogLevel::Off : LogLevel::Info;
 818   switch (flag) {
 819   case JVMTI_VERBOSE_OTHER:
 820     // ignore
 821     break;
 822   case JVMTI_VERBOSE_CLASS:
 823     LogConfiguration::configure_stdout(level, false, LOG_TAGS(class, unload));
 824     LogConfiguration::configure_stdout(level, false, LOG_TAGS(class, load));
 825     break;
 826   case JVMTI_VERBOSE_GC:
 827     LogConfiguration::configure_stdout(level, true, LOG_TAGS(gc));
 828     break;
 829   case JVMTI_VERBOSE_JNI:
 830     level = value == 0 ? LogLevel::Off : LogLevel::Debug;
 831     LogConfiguration::configure_stdout(level, true, LOG_TAGS(jni, resolve));
 832     break;
 833   default:
 834     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 835   };
 836   return JVMTI_ERROR_NONE;
 837 } /* end SetVerboseFlag */
 838 
 839 
 840 // format_ptr - pre-checked for NULL
 841 jvmtiError
 842 JvmtiEnv::GetJLocationFormat(jvmtiJlocationFormat* format_ptr) {
 843   *format_ptr = JVMTI_JLOCATION_JVMBCI;
 844   return JVMTI_ERROR_NONE;
 845 } /* end GetJLocationFormat */
 846 
 847   //
 848   // Functions supporting virtual threads
 849   //
 850 
 851 // object - pre-checked for NULL
 852 // is_vthread_ptr - pre-checked for NULL
 853 jvmtiError
 854 JvmtiEnv::IsVirtualThread(jthread thread, jboolean* is_vthread_ptr) {
 855   oop thread_obj = JNIHandles::resolve_external_guard(thread);
 856 
 857   *is_vthread_ptr = java_lang_VirtualThread::is_instance(thread_obj);
 858   return JVMTI_ERROR_NONE;
 859 } /* end IsVirtualThread */
 860 
 861 
 862 // java_thread - pre-checked
 863 // vthread_ptr - pre-checked for NULL
 864 jvmtiError
 865 JvmtiEnv::GetVirtualThread(JavaThread* java_thread, jthread* vthread_ptr) {
 866   JavaThread* current_thread  = JavaThread::current();
 867   ResourceMark rm(current_thread);
 868   oop vthread_oop = NULL;
 869   uint32_t debug_bits = 0;
 870 
 871   JvmtiThreadState *state = JvmtiThreadState::state_for(java_thread);
 872   if (state == NULL) {
 873     return JVMTI_ERROR_THREAD_NOT_ALIVE;
 874   }
 875   if (!java_thread-&gt;is_thread_fully_suspended(true, &amp;debug_bits)) {
 876     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
 877   }
 878   vthread_oop = java_lang_Thread::vthread(java_thread-&gt;threadObj());
 879   *vthread_ptr = (jthread)JNIHandles::make_local(current_thread, vthread_oop);
 880   return JVMTI_ERROR_NONE;
 881 } /* end GetVirtualThread */
 882 
 883 // thread_ptr - pre-checked for NULL
 884 jvmtiError
 885 JvmtiEnv::GetCarrierThread(jthread vthread, jthread* thread_ptr) {
 886   JavaThread* current_thread  = JavaThread::current();
 887   HandleMark hm(current_thread);
 888   oop vthread_obj = JNIHandles::resolve_external_guard(vthread);
 889 
 890   if (!java_lang_VirtualThread::is_instance(vthread_obj)) {
 891     return JVMTI_ERROR_INVALID_THREAD;
 892   }
 893 
 894   VM_VirtualThreadGetThread op(current_thread, Handle(current_thread, vthread_obj), thread_ptr);
 895   VMThread::execute(&amp;op);
 896 
 897   return op.result();
 898 } /* end GetCarrierThread */
 899 
 900   //
 901   // Thread functions
 902   //
 903 
 904 // Threads_lock NOT held
 905 // thread - NOT pre-checked
 906 // thread_state_ptr - pre-checked for NULL
 907 jvmtiError
 908 JvmtiEnv::GetThreadState(jthread thread, jint* thread_state_ptr) {
 909   JavaThread* current_thread = JavaThread::current();
 910   JavaThread* java_thread = NULL;
 911   oop thread_oop = NULL;
 912   ThreadsListHandle tlh(current_thread);
 913 
 914   if (thread == NULL) {
 915     java_thread = current_thread;
 916     thread_oop = java_thread-&gt;threadObj();
 917 
 918     if (thread_oop == NULL || !thread_oop-&gt;is_a(SystemDictionary::Thread_klass())) {
 919       return JVMTI_ERROR_INVALID_THREAD;
 920     }
 921   } else {
 922     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
 923     if (err != JVMTI_ERROR_NONE) {
 924       // We got an error code so we don&#39;t have a JavaThread *, but
 925       // only return an error from here if we didn&#39;t get a valid
 926       // thread_oop.
 927       // In avthread case the cv_external_thread_to_JavaThread is expected to correctly set
 928       // the thread_oop and return JVMTI_ERROR_INVALID_THREAD which we ignore here.
 929       if (thread_oop == NULL) {
 930         return err;
 931       }
 932       // We have a valid thread_oop so we can return some thread state.
 933     }
 934   }
 935 
 936   // Support for virtual thread
 937   if (java_lang_VirtualThread::is_instance(thread_oop)) {
 938     if (!get_capabilities()-&gt;can_support_virtual_threads) {
 939       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 940     }
 941     jshort vthread_state = java_lang_VirtualThread::state(thread_oop);
 942 
 943     if (vthread_state != java_lang_VirtualThread::RUNNING) {
 944       jint state = (jint) java_lang_VirtualThread::map_state_to_thread_status(vthread_state);
 945       if (java_lang_Thread::interrupted(thread_oop)) {
 946         state |= JVMTI_THREAD_STATE_INTERRUPTED;
 947       }
 948       *thread_state_ptr = state;
 949       return JVMTI_ERROR_NONE;
 950     }
 951 
 952     // Need a coordination with carrier thread and state recheck in a VM op.
 953     VM_VirtualThreadGetThreadState op(Handle(current_thread, thread_oop), thread_state_ptr);
 954     VMThread::execute(&amp;op);
 955 
 956     return op.result();
 957   }
 958 
 959   // get most state bits
 960   jint state = (jint)java_lang_Thread::get_thread_status(thread_oop);
 961 
 962   if (java_thread != NULL) {
 963     // We have a JavaThread* so add more state bits.
 964     JavaThreadState jts = java_thread-&gt;thread_state();
 965 
 966     if (java_thread-&gt;is_being_ext_suspended()) {
 967       state |= JVMTI_THREAD_STATE_SUSPENDED;
 968     }
 969     if (jts == _thread_in_native) {
 970       state |= JVMTI_THREAD_STATE_IN_NATIVE;
 971     }
 972     if (java_thread-&gt;is_interrupted(false)) {
 973       state |= JVMTI_THREAD_STATE_INTERRUPTED;
 974     }
 975   }
 976 
 977   *thread_state_ptr = state;
 978   return JVMTI_ERROR_NONE;
 979 } /* end GetThreadState */
 980 
 981 
 982 // thread_ptr - pre-checked for NULL
 983 jvmtiError
 984 JvmtiEnv::GetCurrentThread(jthread* thread_ptr) {
 985   JavaThread* current_thread  = JavaThread::current();
 986   *thread_ptr = (jthread)JNIHandles::make_local(current_thread, current_thread-&gt;threadObj());
 987   return JVMTI_ERROR_NONE;
 988 } /* end GetCurrentThread */
 989 
 990 
 991 // threads_count_ptr - pre-checked for NULL
 992 // threads_ptr - pre-checked for NULL
 993 jvmtiError
 994 JvmtiEnv::GetAllThreads(jint* threads_count_ptr, jthread** threads_ptr) {
 995   int nthreads        = 0;
 996   Handle *thread_objs = NULL;
 997   ResourceMark rm;
 998   HandleMark hm;
 999 
1000   // enumerate threads (including agent threads)
1001   ThreadsListEnumerator tle(Thread::current(), true);
1002   nthreads = tle.num_threads();
1003   *threads_count_ptr = nthreads;
1004 
1005   if (nthreads == 0) {
1006     *threads_ptr = NULL;
1007     return JVMTI_ERROR_NONE;
1008   }
1009 
1010   thread_objs = NEW_RESOURCE_ARRAY(Handle, nthreads);
1011   NULL_CHECK(thread_objs, JVMTI_ERROR_OUT_OF_MEMORY);
1012 
1013   for (int i = 0; i &lt; nthreads; i++) {
1014     thread_objs[i] = Handle(tle.get_threadObj(i));
1015   }
1016 
1017   jthread *jthreads  = new_jthreadArray(nthreads, thread_objs);
1018   NULL_CHECK(jthreads, JVMTI_ERROR_OUT_OF_MEMORY);
1019 
1020   *threads_ptr = jthreads;
1021   return JVMTI_ERROR_NONE;
1022 } /* end GetAllThreads */
1023 
1024 
1025 // Threads_lock NOT held, java_thread not protected by lock
1026 // java_thread - pre-checked
1027 jvmtiError
1028 JvmtiEnv::SuspendThread(JavaThread* java_thread) {
1029   // don&#39;t allow hidden thread suspend request.
1030   if (java_thread-&gt;is_hidden_from_external_view()) {
1031     return (JVMTI_ERROR_NONE);
1032   }
1033 
1034   {
1035     MutexLocker ml(java_thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);
1036     if (java_thread-&gt;is_external_suspend()) {
1037       // don&#39;t allow nested external suspend requests.
1038       return (JVMTI_ERROR_THREAD_SUSPENDED);
1039     }
1040     if (java_thread-&gt;is_exiting()) { // thread is in the process of exiting
1041       return (JVMTI_ERROR_THREAD_NOT_ALIVE);
1042     }
1043     java_thread-&gt;set_external_suspend();
1044   }
1045 
1046   if (!JvmtiSuspendControl::suspend(java_thread)) {
1047     // the thread was in the process of exiting
1048     return (JVMTI_ERROR_THREAD_NOT_ALIVE);
1049   }
1050   return JVMTI_ERROR_NONE;
1051 } /* end SuspendThread */
1052 
1053 
1054 // request_count - pre-checked to be greater than or equal to 0
1055 // request_list - pre-checked for NULL
1056 // results - pre-checked for NULL
1057 jvmtiError
1058 JvmtiEnv::SuspendThreadList(jint request_count, const jthread* request_list, jvmtiError* results) {
1059   int needSafepoint = 0;  // &gt; 0 if we need a safepoint
1060   ThreadsListHandle tlh;
1061   for (int i = 0; i &lt; request_count; i++) {
1062     JavaThread *java_thread = NULL;
1063     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), request_list[i], &amp;java_thread, NULL);
1064     if (err != JVMTI_ERROR_NONE) {
1065       results[i] = err;
1066       continue;
1067     }
1068     // don&#39;t allow hidden thread suspend request.
1069     if (java_thread-&gt;is_hidden_from_external_view()) {
1070       results[i] = JVMTI_ERROR_NONE;  // indicate successful suspend
1071       continue;
1072     }
1073 
1074     {
1075       MutexLocker ml(java_thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);
1076       if (java_thread-&gt;is_external_suspend()) {
1077         // don&#39;t allow nested external suspend requests.
1078         results[i] = JVMTI_ERROR_THREAD_SUSPENDED;
1079         continue;
1080       }
1081       if (java_thread-&gt;is_exiting()) { // thread is in the process of exiting
1082         results[i] = JVMTI_ERROR_THREAD_NOT_ALIVE;
1083         continue;
1084       }
1085       java_thread-&gt;set_external_suspend();
1086     }
1087     if (java_thread-&gt;thread_state() == _thread_in_native) {
1088       // We need to try and suspend native threads here. Threads in
1089       // other states will self-suspend on their next transition.
1090       if (!JvmtiSuspendControl::suspend(java_thread)) {
1091         // The thread was in the process of exiting. Force another
1092         // safepoint to make sure that this thread transitions.
1093         needSafepoint++;
1094         results[i] = JVMTI_ERROR_THREAD_NOT_ALIVE;
1095         continue;
1096       }
1097     } else {
1098       needSafepoint++;
1099     }
1100     results[i] = JVMTI_ERROR_NONE;  // indicate successful suspend
1101   }
1102   if (needSafepoint &gt; 0) {
1103     VM_ThreadsSuspendJVMTI tsj;
1104     VMThread::execute(&amp;tsj);
1105   }
1106   // per-thread suspend results returned via results parameter
1107   return JVMTI_ERROR_NONE;
1108 } /* end SuspendThreadList */
1109 
1110 
1111 // Threads_lock NOT held, java_thread not protected by lock
1112 // java_thread - pre-checked
1113 jvmtiError
1114 JvmtiEnv::ResumeThread(JavaThread* java_thread) {
1115   // don&#39;t allow hidden thread resume request.
1116   if (java_thread-&gt;is_hidden_from_external_view()) {
1117     return JVMTI_ERROR_NONE;
1118   }
1119 
1120   if (!java_thread-&gt;is_being_ext_suspended()) {
1121     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1122   }
1123 
1124   if (!JvmtiSuspendControl::resume(java_thread)) {
1125     return JVMTI_ERROR_INTERNAL;
1126   }
1127   return JVMTI_ERROR_NONE;
1128 } /* end ResumeThread */
1129 
1130 
1131 // request_count - pre-checked to be greater than or equal to 0
1132 // request_list - pre-checked for NULL
1133 // results - pre-checked for NULL
1134 jvmtiError
1135 JvmtiEnv::ResumeThreadList(jint request_count, const jthread* request_list, jvmtiError* results) {
1136   ThreadsListHandle tlh;
1137   for (int i = 0; i &lt; request_count; i++) {
1138     JavaThread* java_thread = NULL;
1139     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), request_list[i], &amp;java_thread, NULL);
1140     if (err != JVMTI_ERROR_NONE) {
1141       results[i] = err;
1142       continue;
1143     }
1144     // don&#39;t allow hidden thread resume request.
1145     if (java_thread-&gt;is_hidden_from_external_view()) {
1146       results[i] = JVMTI_ERROR_NONE;  // indicate successful resume
1147       continue;
1148     }
1149     if (!java_thread-&gt;is_being_ext_suspended()) {
1150       results[i] = JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1151       continue;
1152     }
1153 
1154     if (!JvmtiSuspendControl::resume(java_thread)) {
1155       results[i] = JVMTI_ERROR_INTERNAL;
1156       continue;
1157     }
1158 
1159     results[i] = JVMTI_ERROR_NONE;  // indicate successful resume
1160   }
1161   // per-thread resume results returned via results parameter
1162   return JVMTI_ERROR_NONE;
1163 } /* end ResumeThreadList */
1164 
1165 
1166 // Threads_lock NOT held, java_thread not protected by lock
1167 // java_thread - pre-checked
1168 jvmtiError
1169 JvmtiEnv::StopThread(JavaThread* java_thread, jobject exception) {
1170   oop e = JNIHandles::resolve_external_guard(exception);
1171   NULL_CHECK(e, JVMTI_ERROR_NULL_POINTER);
1172 
1173   JavaThread::send_async_exception(java_thread-&gt;threadObj(), e);
1174 
1175   return JVMTI_ERROR_NONE;
1176 
1177 } /* end StopThread */
1178 
1179 
1180 // Threads_lock NOT held
1181 // thread - NOT pre-checked
1182 jvmtiError
1183 JvmtiEnv::InterruptThread(jthread thread) {
1184   JavaThread* current_thread  = JavaThread::current();
1185   JavaThread* java_thread = NULL;
1186   ThreadsListHandle tlh(current_thread);
1187   jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, NULL);
1188   if (err != JVMTI_ERROR_NONE) {
1189     return err;
1190   }
1191   // Really this should be a Java call to Thread.interrupt to ensure the same
1192   // semantics, however historically this has not been done for some reason.
1193   // So we continue with that (which means we don&#39;t interact with any Java-level
1194   // Interruptible object) but we must set the Java-level interrupted state.
1195   java_lang_Thread::set_interrupted(JNIHandles::resolve(thread), true);
1196   java_thread-&gt;interrupt();
1197 
1198   return JVMTI_ERROR_NONE;
1199 } /* end InterruptThread */
1200 
1201 
1202 // Threads_lock NOT held
1203 // thread - NOT pre-checked
1204 // info_ptr - pre-checked for NULL
1205 jvmtiError
1206 JvmtiEnv::GetThreadInfo(jthread thread, jvmtiThreadInfo* info_ptr) {
1207   ResourceMark rm;
1208   HandleMark hm;
1209 
1210   JavaThread* current_thread = JavaThread::current();
1211   ThreadsListHandle tlh(current_thread);
1212 
1213   // if thread is NULL the current thread is used
1214   oop thread_oop = NULL;
1215   if (thread == NULL) {
1216     thread_oop = current_thread-&gt;threadObj();
1217     if (thread_oop == NULL || !thread_oop-&gt;is_a(SystemDictionary::Thread_klass())) {
1218       return JVMTI_ERROR_INVALID_THREAD;
1219     }
1220   } else {
1221     JavaThread* java_thread = NULL;
1222     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
1223     if (err != JVMTI_ERROR_NONE) {
1224       // We got an error code so we don&#39;t have a JavaThread *, but
1225       // only return an error from here if we didn&#39;t get a valid
1226       // thread_oop.
1227       // In the virtual thread case the cv_external_thread_to_JavaThread is expected to correctly set
1228       // the thread_oop and return JVMTI_ERROR_INVALID_THREAD which we ignore here.
1229       if (thread_oop == NULL) {
1230         return err;
1231       }
1232       // We have a valid thread_oop so we can return some thread info.
1233     }
1234   }
1235 
1236   Handle thread_obj(current_thread, thread_oop);
1237   Handle name;
1238   ThreadPriority priority;
1239   Handle     thread_group;
1240   Handle context_class_loader;
1241   bool          is_daemon;
1242 
1243   name = Handle(current_thread, java_lang_Thread::name(thread_obj()));
1244 
1245   // Support for virtual threads
1246   if (java_lang_VirtualThread::is_instance(thread_obj())) {
1247     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1248       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1249     }
1250     priority = (ThreadPriority)JVMTI_THREAD_NORM_PRIORITY;
1251     is_daemon = true;
<a name="1" id="anc1"></a><span class="line-modified">1252     if (java_lang_VirtualThread::state(thread_obj()) == java_lang_VirtualThread::TERMINATED) {</span>
<span class="line-added">1253       thread_group = Handle(current_thread, NULL);</span>
<span class="line-added">1254     } else {</span>
<span class="line-added">1255       thread_group = Handle(current_thread, java_lang_Thread_VirtualThreads::get_THREAD_GROUP());</span>
<span class="line-added">1256     }</span>
1257   } else {
1258     priority = java_lang_Thread::priority(thread_obj());
1259     is_daemon = java_lang_Thread::is_daemon(thread_obj());
<a name="2" id="anc2"></a><span class="line-modified">1260     if (java_lang_Thread::get_thread_status(thread_obj()) == java_lang_Thread::TERMINATED) {</span>
<span class="line-added">1261       thread_group = Handle(current_thread, NULL);</span>
<span class="line-added">1262     } else {</span>
<span class="line-added">1263       thread_group = Handle(current_thread, java_lang_Thread::threadGroup(thread_obj()));</span>
<span class="line-added">1264     }</span>
1265   }
1266 
1267   oop loader = java_lang_Thread::context_class_loader(thread_obj());
1268   context_class_loader = Handle(current_thread, loader);
1269 
1270   { const char *n;
1271 
1272     if (name() != NULL) {
1273       n = java_lang_String::as_utf8_string(name());
1274     } else {
1275       int utf8_length = 0;
1276       n = UNICODE::as_utf8((jchar*) NULL, utf8_length);
1277     }
1278 
1279     info_ptr-&gt;name = (char *) jvmtiMalloc(strlen(n)+1);
1280     if (info_ptr-&gt;name == NULL)
1281       return JVMTI_ERROR_OUT_OF_MEMORY;
1282 
1283     strcpy(info_ptr-&gt;name, n);
1284   }
1285   info_ptr-&gt;is_daemon = is_daemon;
1286   info_ptr-&gt;priority  = priority;
1287 
1288   info_ptr-&gt;context_class_loader = (context_class_loader.is_null()) ? NULL :
1289                                     jni_reference(context_class_loader);
1290   info_ptr-&gt;thread_group = jni_reference(thread_group);
1291 
1292   return JVMTI_ERROR_NONE;
1293 } /* end GetThreadInfo */
1294 
1295 
1296 // Threads_lock NOT held
1297 // thread - NOT pre-checked
1298 // owned_monitor_count_ptr - pre-checked for NULL
1299 // owned_monitors_ptr - pre-checked for NULL
1300 jvmtiError
1301 JvmtiEnv::GetOwnedMonitorInfo(jthread thread, jint* owned_monitor_count_ptr, jobject** owned_monitors_ptr) {
1302   jvmtiError err = JVMTI_ERROR_NONE;
1303   JavaThread* calling_thread = JavaThread::current();
1304   HandleMark hm(calling_thread);
1305   oop thread_obj = JNIHandles::resolve_external_guard(thread);
1306 
1307   // growable array of jvmti monitors info on the C-heap
1308   GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list =
1309       new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;(1, true);
1310 
1311   // Support for virtual threads
1312   if (java_lang_VirtualThread::is_instance(thread_obj)) {
1313     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1314       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1315     }
1316     VM_VirtualThreadGetOwnedMonitorInfo op(this,
1317                                            calling_thread,
1318                                            Handle(calling_thread, thread_obj),
1319                                            owned_monitors_list);
1320     VMThread::execute(&amp;op);
1321     err = op.result();
1322   } else {
1323     // Support for ordinary threads
1324     JavaThread* java_thread = NULL;
1325     ThreadsListHandle tlh(calling_thread);
1326 
1327     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
1328     if (err != JVMTI_ERROR_NONE) {
1329       delete owned_monitors_list;
1330       return err;
1331     }
1332 
1333     // It is only safe to perform the direct operation on the current
1334     // thread. All other usage needs to use a vm-safepoint-op for safety.
1335     if (java_thread == calling_thread) {
1336       err = get_owned_monitors(calling_thread, java_thread, owned_monitors_list);
1337     } else {
1338       // JVMTI get monitors info at safepoint.
1339       // Do not require target thread to
1340       VM_GetOwnedMonitorInfo op(this, calling_thread, java_thread, owned_monitors_list);
1341       VMThread::execute(&amp;op);
1342       err = op.result();
1343     }
1344   }
1345   jint owned_monitor_count = owned_monitors_list-&gt;length();
1346   if (err == JVMTI_ERROR_NONE) {
1347     if ((err = allocate(owned_monitor_count * sizeof(jobject *),
1348                       (unsigned char**)owned_monitors_ptr)) == JVMTI_ERROR_NONE) {
1349       // copy into the returned array
1350       for (int i = 0; i &lt; owned_monitor_count; i++) {
1351         (*owned_monitors_ptr)[i] =
1352           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;monitor;
1353       }
1354       *owned_monitor_count_ptr = owned_monitor_count;
1355     }
1356   }
1357   // clean up.
1358   for (int i = 0; i &lt; owned_monitor_count; i++) {
1359     deallocate((unsigned char*)owned_monitors_list-&gt;at(i));
1360   }
1361   delete owned_monitors_list;
1362 
1363   return err;
1364 } /* end GetOwnedMonitorInfo */
1365 
1366 
1367 // Threads_lock NOT held
1368 // thread - NOT pre-checked
1369 // monitor_info_count_ptr - pre-checked for NULL
1370 // monitor_info_ptr - pre-checked for NULL
1371 jvmtiError
1372 JvmtiEnv::GetOwnedMonitorStackDepthInfo(jthread thread, jint* monitor_info_count_ptr, jvmtiMonitorStackDepthInfo** monitor_info_ptr) {
1373   jvmtiError err = JVMTI_ERROR_NONE;
1374   JavaThread* calling_thread = JavaThread::current();
1375   HandleMark hm(calling_thread);
1376   oop thread_obj = JNIHandles::resolve_external_guard(thread);
1377 
1378   // growable array of jvmti monitors info on the C-heap
1379   GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list =
1380          new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;(1, true);
1381 
1382   // Support for virtual threads
1383   if (java_lang_VirtualThread::is_instance(thread_obj)) {
1384     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1385       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1386     }
1387     VM_VirtualThreadGetOwnedMonitorInfo op(this,
1388                                    calling_thread,
1389                                    Handle(calling_thread, thread_obj),
1390                                    owned_monitors_list);
1391     VMThread::execute(&amp;op);
1392     err = op.result();
1393   } else {
1394     // Support for ordinary threads
1395     JavaThread* java_thread = NULL;
1396     ThreadsListHandle tlh(calling_thread);
1397 
1398     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
1399     if (err != JVMTI_ERROR_NONE) {
1400       delete owned_monitors_list;
1401       return err;
1402     }
1403 
1404     // It is only safe to perform the direct operation on the current
1405     // thread. All other usage needs to use a vm-safepoint-op for safety.
1406     if (java_thread == calling_thread) {
1407       err = get_owned_monitors(calling_thread, java_thread, owned_monitors_list);
1408     } else {
1409       // JVMTI get owned monitors info at safepoint.
1410       // Do not require target thread to be suspended.
1411       VM_GetOwnedMonitorInfo op(this, calling_thread, java_thread, owned_monitors_list);
1412       VMThread::execute(&amp;op);
1413       err = op.result();
1414     }
1415   }
1416   jint owned_monitor_count = owned_monitors_list-&gt;length();
1417   if (err == JVMTI_ERROR_NONE) {
1418     if ((err = allocate(owned_monitor_count * sizeof(jvmtiMonitorStackDepthInfo),
1419                         (unsigned char**)monitor_info_ptr)) == JVMTI_ERROR_NONE) {
1420       // copy to output array.
1421       for (int i = 0; i &lt; owned_monitor_count; i++) {
1422         (*monitor_info_ptr)[i].monitor =
1423           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;monitor;
1424         (*monitor_info_ptr)[i].stack_depth =
1425           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;stack_depth;
1426       }
1427     }
1428     *monitor_info_count_ptr = owned_monitor_count;
1429   }
1430 
1431   // clean up.
1432   for (int i = 0; i &lt; owned_monitor_count; i++) {
1433     deallocate((unsigned char*)owned_monitors_list-&gt;at(i));
1434   }
1435   delete owned_monitors_list;
1436 
1437   return err;
1438 } /* end GetOwnedMonitorStackDepthInfo */
1439 
1440 
1441 // Threads_lock NOT held
1442 // thread - NOT pre-checked
1443 // monitor_ptr - pre-checked for NULL
1444 jvmtiError
1445 JvmtiEnv::GetCurrentContendedMonitor(jthread thread, jobject* monitor_ptr) {
1446   jvmtiError err = JVMTI_ERROR_NONE;
1447   JavaThread* calling_thread = JavaThread::current();
1448   HandleMark hm(calling_thread);
1449   oop thread_obj = JNIHandles::resolve_external_guard(thread);
1450 
1451   // Support for virtual threads
1452   if (java_lang_VirtualThread::is_instance(thread_obj)) {
1453     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1454       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1455     }
1456     VM_VirtualThreadGetCurrentContendedMonitor op(this, calling_thread,
1457                                           Handle(calling_thread, thread_obj),
1458                                           monitor_ptr);
1459     VMThread::execute(&amp;op);
1460     err = op.result();
1461     return err;
1462   }
1463   // Support for ordinary threads
1464   ThreadsListHandle tlh(calling_thread);
1465   JavaThread* java_thread = NULL;
1466 
1467   err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
1468   if (err != JVMTI_ERROR_NONE) {
1469     return err;
1470   }
1471   // It is only safe to perform the direct operation on the current
1472   // thread. All other usage needs to use a vm-safepoint-op for safety.
1473   if (java_thread == calling_thread) {
1474     err = get_current_contended_monitor(calling_thread, java_thread, monitor_ptr);
1475   } else {
1476     // get contended monitor information at safepoint.
1477     VM_GetCurrentContendedMonitor op(this, calling_thread, java_thread, monitor_ptr);
1478     VMThread::execute(&amp;op);
1479     err = op.result();
1480   }
1481   return err;
1482 } /* end GetCurrentContendedMonitor */
1483 
1484 
1485 // Threads_lock NOT held
1486 // thread - NOT pre-checked
1487 // proc - pre-checked for NULL
1488 // arg - NULL is a valid value, must be checked
1489 jvmtiError
1490 JvmtiEnv::RunAgentThread(jthread thread, jvmtiStartFunction proc, const void* arg, jint priority) {
1491   JavaThread* current_thread = JavaThread::current();
1492 
1493   JavaThread* java_thread = NULL;
1494   oop thread_oop = NULL;
1495   ThreadsListHandle tlh(current_thread);
1496   jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
1497   if (err != JVMTI_ERROR_NONE) {
1498     // We got an error code so we don&#39;t have a JavaThread *, but
1499     // only return an error from here if we didn&#39;t get a valid
1500     // thread_oop.
1501     if (thread_oop == NULL) {
1502       return err;
1503     }
1504     // We have a valid thread_oop.
1505   }
1506 
1507   if (java_thread != NULL) {
1508     // &#39;thread&#39; refers to an existing JavaThread.
1509     return JVMTI_ERROR_INVALID_THREAD;
1510   }
1511 
1512   if (priority &lt; JVMTI_THREAD_MIN_PRIORITY || priority &gt; JVMTI_THREAD_MAX_PRIORITY) {
1513     return JVMTI_ERROR_INVALID_PRIORITY;
1514   }
1515 
1516   Handle thread_hndl(current_thread, thread_oop);
1517   {
1518     MutexLocker mu(current_thread, Threads_lock); // grab Threads_lock
1519 
1520     JvmtiAgentThread *new_thread = new JvmtiAgentThread(this, proc, arg);
1521 
1522     // At this point it may be possible that no osthread was created for the
1523     // JavaThread due to lack of memory.
1524     if (new_thread == NULL || new_thread-&gt;osthread() == NULL) {
1525       if (new_thread != NULL) {
1526         new_thread-&gt;smr_delete();
1527       }
1528       return JVMTI_ERROR_OUT_OF_MEMORY;
1529     }
1530 
1531     java_lang_Thread::set_thread(thread_hndl(), new_thread);
1532     java_lang_Thread::set_priority(thread_hndl(), (ThreadPriority)priority);
1533     java_lang_Thread::set_daemon(thread_hndl());
1534 
1535     new_thread-&gt;set_threadObj(thread_hndl());
1536     Threads::add(new_thread);
1537     Thread::start(new_thread);
1538   } // unlock Threads_lock
1539 
1540   return JVMTI_ERROR_NONE;
1541 } /* end RunAgentThread */
1542 
1543   //
1544   // Thread Group functions
1545   //
1546 
1547 // group_count_ptr - pre-checked for NULL
1548 // groups_ptr - pre-checked for NULL
1549 jvmtiError
1550 JvmtiEnv::GetTopThreadGroups(jint* group_count_ptr, jthreadGroup** groups_ptr) {
1551   JavaThread* current_thread = JavaThread::current();
1552 
1553   // Only one top level thread group now.
1554   *group_count_ptr = 1;
1555 
1556   // Allocate memory to store global-refs to the thread groups.
1557   // Assume this area is freed by caller.
1558   *groups_ptr = (jthreadGroup *) jvmtiMalloc((sizeof(jthreadGroup)) * (*group_count_ptr));
1559 
1560   NULL_CHECK(*groups_ptr, JVMTI_ERROR_OUT_OF_MEMORY);
1561 
1562   // Convert oop to Handle, then convert Handle to global-ref.
1563   {
1564     HandleMark hm(current_thread);
1565     Handle system_thread_group(current_thread, Universe::system_thread_group());
1566     *groups_ptr[0] = jni_reference(system_thread_group);
1567   }
1568 
1569   return JVMTI_ERROR_NONE;
1570 } /* end GetTopThreadGroups */
1571 
1572 
1573 // info_ptr - pre-checked for NULL
1574 jvmtiError
1575 JvmtiEnv::GetThreadGroupInfo(jthreadGroup group, jvmtiThreadGroupInfo* info_ptr) {
1576   ResourceMark rm;
1577   HandleMark hm;
1578 
1579   JavaThread* current_thread = JavaThread::current();
1580 
1581   Handle group_obj (current_thread, JNIHandles::resolve_external_guard(group));
1582   NULL_CHECK(group_obj(), JVMTI_ERROR_INVALID_THREAD_GROUP);
1583 
1584   const char* name;
1585   Handle parent_group;
1586   bool is_daemon;
1587   ThreadPriority max_priority;
1588 
1589   name         = java_lang_ThreadGroup::name(group_obj());
1590   parent_group = Handle(current_thread, java_lang_ThreadGroup::parent(group_obj()));
1591   is_daemon    = java_lang_ThreadGroup::is_daemon(group_obj());
1592   max_priority = java_lang_ThreadGroup::maxPriority(group_obj());
1593 
1594   info_ptr-&gt;is_daemon    = is_daemon;
1595   info_ptr-&gt;max_priority = max_priority;
1596   info_ptr-&gt;parent       = jni_reference(parent_group);
1597 
1598   if (name != NULL) {
1599     info_ptr-&gt;name = (char*)jvmtiMalloc(strlen(name)+1);
1600     NULL_CHECK(info_ptr-&gt;name, JVMTI_ERROR_OUT_OF_MEMORY);
1601     strcpy(info_ptr-&gt;name, name);
1602   } else {
1603     info_ptr-&gt;name = NULL;
1604   }
1605 
1606   return JVMTI_ERROR_NONE;
1607 } /* end GetThreadGroupInfo */
1608 
1609 
1610 // thread_count_ptr - pre-checked for NULL
1611 // threads_ptr - pre-checked for NULL
1612 // group_count_ptr - pre-checked for NULL
1613 // groups_ptr - pre-checked for NULL
1614 jvmtiError
1615 JvmtiEnv::GetThreadGroupChildren(jthreadGroup group, jint* thread_count_ptr, jthread** threads_ptr, jint* group_count_ptr, jthreadGroup** groups_ptr) {
1616   JavaThread* current_thread = JavaThread::current();
1617   oop group_obj = (oop) JNIHandles::resolve_external_guard(group);
1618   NULL_CHECK(group_obj, JVMTI_ERROR_INVALID_THREAD_GROUP);
1619 
1620   Handle *thread_objs = NULL;
1621   Handle *group_objs  = NULL;
1622   int nthreads = 0;
1623   int ngroups = 0;
1624   int hidden_threads = 0;
1625 
1626   ResourceMark rm(current_thread);
1627   HandleMark hm(current_thread);
1628 
1629   Handle group_hdl(current_thread, group_obj);
1630 
1631   { // Cannot allow thread or group counts to change.
1632     ObjectLocker ol(group_hdl, current_thread);
1633 
1634     nthreads = java_lang_ThreadGroup::nthreads(group_hdl());
1635     ngroups  = java_lang_ThreadGroup::ngroups(group_hdl());
1636 
1637     if (nthreads &gt; 0) {
1638       ThreadsListHandle tlh(current_thread);
1639       objArrayOop threads = java_lang_ThreadGroup::threads(group_hdl());
1640       assert(nthreads &lt;= threads-&gt;length(), &quot;too many threads&quot;);
1641       thread_objs = NEW_RESOURCE_ARRAY(Handle,nthreads);
1642       for (int i = 0, j = 0; i &lt; nthreads; i++) {
1643         oop thread_obj = threads-&gt;obj_at(i);
1644         assert(thread_obj != NULL, &quot;thread_obj is NULL&quot;);
1645         JavaThread *java_thread = NULL;
1646         jvmtiError err = JvmtiExport::cv_oop_to_JavaThread(tlh.list(), thread_obj, &amp;java_thread);
1647         if (err == JVMTI_ERROR_NONE) {
1648           // Have a valid JavaThread*.
1649           if (java_thread-&gt;is_hidden_from_external_view()) {
1650             // Filter out hidden java threads.
1651             hidden_threads++;
1652             continue;
1653           }
1654         } else {
1655           // We couldn&#39;t convert thread_obj into a JavaThread*.
1656           if (err == JVMTI_ERROR_INVALID_THREAD) {
1657             // The thread_obj does not refer to a java.lang.Thread object
1658             // so skip it.
1659             hidden_threads++;
1660             continue;
1661           }
1662           // We have a valid thread_obj, but no JavaThread*; the caller
1663           // can still have limited use for the thread_obj.
1664         }
1665         thread_objs[j++] = Handle(current_thread, thread_obj);
1666       }
1667       nthreads -= hidden_threads;
1668     } // ThreadsListHandle is destroyed here.
1669 
1670     if (ngroups &gt; 0) {
1671       objArrayOop groups = java_lang_ThreadGroup::groups(group_hdl());
1672       assert(ngroups &lt;= groups-&gt;length(), &quot;too many groups&quot;);
1673       group_objs = NEW_RESOURCE_ARRAY(Handle,ngroups);
1674       for (int i = 0; i &lt; ngroups; i++) {
1675         oop group_obj = groups-&gt;obj_at(i);
1676         assert(group_obj != NULL, &quot;group_obj != NULL&quot;);
1677         group_objs[i] = Handle(current_thread, group_obj);
1678       }
1679     }
1680   } // ThreadGroup unlocked here
1681 
1682   *group_count_ptr  = ngroups;
1683   *thread_count_ptr = nthreads;
1684   *threads_ptr     = new_jthreadArray(nthreads, thread_objs);
1685   *groups_ptr      = new_jthreadGroupArray(ngroups, group_objs);
1686   if ((nthreads &gt; 0) &amp;&amp; (*threads_ptr == NULL)) {
1687     return JVMTI_ERROR_OUT_OF_MEMORY;
1688   }
1689   if ((ngroups &gt; 0) &amp;&amp; (*groups_ptr == NULL)) {
1690     return JVMTI_ERROR_OUT_OF_MEMORY;
1691   }
1692 
1693   return JVMTI_ERROR_NONE;
1694 } /* end GetThreadGroupChildren */
1695 
1696 
1697   //
1698   // Stack Frame functions
1699   //
1700 
1701 // Threads_lock NOT held
1702 // thread - NOT pre-checked
1703 // max_frame_count - pre-checked to be greater than or equal to 0
1704 // frame_buffer - pre-checked for NULL
1705 // count_ptr - pre-checked for NULL
1706 jvmtiError
1707 JvmtiEnv::GetStackTrace(jthread thread, jint start_depth, jint max_frame_count, jvmtiFrameInfo* frame_buffer, jint* count_ptr) {
1708   jvmtiError err = JVMTI_ERROR_NONE;
1709   JavaThread* java_thread = NULL;
1710   JavaThread* current_thread = JavaThread::current();
1711   HandleMark hm(current_thread);
1712   oop thread_obj = JNIHandles::resolve_external_guard(thread);
1713 
1714   // Support for virtual threads
1715   if (java_lang_VirtualThread::is_instance(thread_obj)) {
1716     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1717       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1718     }
1719     VM_VirtualThreadGetStackTrace op(this, Handle(current_thread, thread_obj),
1720                              start_depth, max_frame_count, frame_buffer, count_ptr);
1721     VMThread::execute(&amp;op);
1722     return op.result();
1723   }
1724 
1725   // Support for ordinary threads
1726   ThreadsListHandle tlh(current_thread);
1727   err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
1728   if (err != JVMTI_ERROR_NONE) {
1729     return err;
1730   }
1731 
1732   // It is only safe to perform the direct operation on the current
1733   // thread. All other usage needs to use a vm-safepoint-op for safety.
1734   if (java_thread == JavaThread::current()) {
1735     err = get_stack_trace(java_thread, start_depth, max_frame_count, frame_buffer, count_ptr);
1736   } else {
1737     // JVMTI get stack trace at safepoint. Do not require target thread to
1738     // be suspended.
1739     VM_GetStackTrace op(this, java_thread, start_depth, max_frame_count, frame_buffer, count_ptr);
1740     VMThread::execute(&amp;op);
1741     err = op.result();
1742   }
1743 
1744   return err;
1745 } /* end GetStackTrace */
1746 
1747 
1748 // max_frame_count - pre-checked to be greater than or equal to 0
1749 // stack_info_ptr - pre-checked for NULL
1750 // thread_count_ptr - pre-checked for NULL
1751 jvmtiError
1752 JvmtiEnv::GetAllStackTraces(jint max_frame_count, jvmtiStackInfo** stack_info_ptr, jint* thread_count_ptr) {
1753   jvmtiError err = JVMTI_ERROR_NONE;
1754   JavaThread* calling_thread = JavaThread::current();
1755 
1756   // JVMTI get stack traces at safepoint.
1757   VM_GetAllStackTraces op(this, calling_thread, max_frame_count);
1758   VMThread::execute(&amp;op);
1759   *thread_count_ptr = op.final_thread_count();
1760   *stack_info_ptr = op.stack_info();
1761   err = op.result();
1762   return err;
1763 } /* end GetAllStackTraces */
1764 
1765 
1766 // thread_count - pre-checked to be greater than or equal to 0
1767 // thread_list - pre-checked for NULL
1768 // max_frame_count - pre-checked to be greater than or equal to 0
1769 // stack_info_ptr - pre-checked for NULL
1770 jvmtiError
1771 JvmtiEnv::GetThreadListStackTraces(jint thread_count, const jthread* thread_list, jint max_frame_count, jvmtiStackInfo** stack_info_ptr) {
1772   jvmtiError err = JVMTI_ERROR_NONE;
1773   // JVMTI get stack traces at safepoint.
1774   VM_GetThreadListStackTraces op(this, thread_count, thread_list, max_frame_count);
1775   VMThread::execute(&amp;op);
1776   err = op.result();
1777   if (err == JVMTI_ERROR_NONE) {
1778     *stack_info_ptr = op.stack_info();
1779   }
1780   return err;
1781 } /* end GetThreadListStackTraces */
1782 
1783 
1784 // Threads_lock NOT held
1785 // thread - NOT pre-checked
1786 // count_ptr - pre-checked for NULL
1787 jvmtiError
1788 JvmtiEnv::GetFrameCount(jthread thread, jint* count_ptr) {
1789   jvmtiError err = JVMTI_ERROR_NONE;
1790   JavaThread* java_thread = NULL;
1791   JavaThread* current_thread = JavaThread::current();
1792   HandleMark hm(current_thread);
1793   oop thread_obj = JNIHandles::resolve_external_guard(thread);
1794 
1795   // Support for virtual threads
1796   if (java_lang_VirtualThread::is_instance(thread_obj)) {
1797     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1798       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1799     }
1800     VM_VirtualThreadGetFrameCount op(this, Handle(current_thread, thread_obj), count_ptr);
1801     VMThread::execute(&amp;op);
1802     return op.result();
1803   }
1804 
1805   // Support for ordinary threads
1806   ThreadsListHandle tlh(current_thread);
1807   err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
1808   if (err != JVMTI_ERROR_NONE) {
1809     return err;
1810   }
1811 
1812   // retrieve or create JvmtiThreadState.
1813   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1814   if (state == NULL) {
1815     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1816   }
1817 
1818   // It is only safe to perform the direct operation on the current
1819   // thread. All other usage needs to use a vm-safepoint-op for safety.
1820   if (java_thread == JavaThread::current()) {
1821     err = get_frame_count(state, count_ptr);
1822   } else {
1823     // get java stack frame count at safepoint.
1824     VM_GetFrameCount op(this, state, count_ptr);
1825     VMThread::execute(&amp;op);
1826     err = op.result();
1827   }
1828   return err;
1829 } /* end GetFrameCount */
1830 
1831 
1832 // Threads_lock NOT held, java_thread not protected by lock
1833 // java_thread - pre-checked
1834 jvmtiError
1835 JvmtiEnv::PopFrame(JavaThread* java_thread) {
1836   JavaThread* current_thread  = JavaThread::current();
1837   HandleMark hm(current_thread);
1838   uint32_t debug_bits = 0;
1839 
1840   // retrieve or create the state
1841   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1842   if (state == NULL) {
1843     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1844   }
1845 
1846   // Check if java_thread is fully suspended
1847   if (!java_thread-&gt;is_thread_fully_suspended(true /* wait for suspend completion */, &amp;debug_bits)) {
1848     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1849   }
1850   // Check to see if a PopFrame was already in progress
1851   if (java_thread-&gt;popframe_condition() != JavaThread::popframe_inactive) {
1852     // Probably possible for JVMTI clients to trigger this, but the
1853     // JPDA backend shouldn&#39;t allow this to happen
1854     return JVMTI_ERROR_INTERNAL;
1855   }
1856 
1857   {
1858     // Was workaround bug
1859     //    4812902: popFrame hangs if the method is waiting at a synchronize
1860     // Catch this condition and return an error to avoid hanging.
1861     // Now JVMTI spec allows an implementation to bail out with an opaque frame error.
1862     OSThread* osThread = java_thread-&gt;osthread();
1863     if (osThread-&gt;get_state() == MONITOR_WAIT) {
1864       return JVMTI_ERROR_OPAQUE_FRAME;
1865     }
1866   }
1867 
1868   {
1869     ResourceMark rm(current_thread);
1870     // Check if there are more than one Java frame in this thread, that the top two frames
1871     // are Java (not native) frames, and that there is no intervening VM frame
1872     int frame_count = 0;
1873     bool is_interpreted[2];
1874     intptr_t *frame_sp[2];
1875     // The 2-nd arg of constructor is needed to stop iterating at java entry frame.
1876     for (vframeStream vfs(java_thread, true); !vfs.at_end(); vfs.next()) {
1877       methodHandle mh(current_thread, vfs.method());
1878       if (mh-&gt;is_native()) return(JVMTI_ERROR_OPAQUE_FRAME);
1879       is_interpreted[frame_count] = vfs.is_interpreted_frame();
1880       frame_sp[frame_count] = vfs.frame_id();
1881       if (++frame_count &gt; 1) break;
1882     }
1883     if (frame_count &lt; 2)  {
1884       // We haven&#39;t found two adjacent non-native Java frames on the top.
1885       // There can be two situations here:
1886       //  1. There are no more java frames
1887       //  2. Two top java frames are separated by non-java native frames
1888       if(vframeFor(java_thread, 1) == NULL) {
1889         return JVMTI_ERROR_NO_MORE_FRAMES;
1890       } else {
1891         // Intervening non-java native or VM frames separate java frames.
1892         // Current implementation does not support this. See bug #5031735.
1893         // In theory it is possible to pop frames in such cases.
1894         return JVMTI_ERROR_OPAQUE_FRAME;
1895       }
1896     }
1897 
1898     // If any of the top 2 frames is a compiled one, need to deoptimize it
1899     for (int i = 0; i &lt; 2; i++) {
1900       if (!is_interpreted[i]) {
1901         Deoptimization::deoptimize_frame(java_thread, frame_sp[i]);
1902       }
1903     }
1904 
1905     // Update the thread state to reflect that the top frame is popped
1906     // so that cur_stack_depth is maintained properly and all frameIDs
1907     // are invalidated.
1908     // The current frame will be popped later when the suspended thread
1909     // is resumed and right before returning from VM to Java.
1910     // (see call_VM_base() in assembler_&lt;cpu&gt;.cpp).
1911 
1912     // It&#39;s fine to update the thread state here because no JVMTI events
1913     // shall be posted for this PopFrame.
1914 
1915     // It is only safe to perform the direct operation on the current
1916     // thread. All other usage needs to use a vm-safepoint-op for safety.
1917     if (java_thread == JavaThread::current()) {
1918       state-&gt;update_for_pop_top_frame();
1919     } else {
1920       VM_UpdateForPopTopFrame op(state);
1921       VMThread::execute(&amp;op);
1922       jvmtiError err = op.result();
1923       if (err != JVMTI_ERROR_NONE) {
1924         return err;
1925       }
1926     }
1927 
1928     java_thread-&gt;set_popframe_condition(JavaThread::popframe_pending_bit);
1929     // Set pending step flag for this popframe and it is cleared when next
1930     // step event is posted.
1931     state-&gt;set_pending_step_for_popframe();
1932   }
1933 
1934   return JVMTI_ERROR_NONE;
1935 } /* end PopFrame */
1936 
1937 
1938 // Threads_lock NOT held
1939 // thread - NOT pre-checked
1940 // depth - pre-checked as non-negative
1941 // method_ptr - pre-checked for NULL
1942 // location_ptr - pre-checked for NULL
1943 jvmtiError
1944 JvmtiEnv::GetFrameLocation(jthread thread, jint depth, jmethodID* method_ptr, jlocation* location_ptr) {
1945   jvmtiError err = JVMTI_ERROR_NONE;
1946   JavaThread* java_thread = NULL;
1947   JavaThread* current_thread = JavaThread::current();
1948   HandleMark hm(current_thread);
1949   oop thread_obj = JNIHandles::resolve_external_guard(thread);
1950 
1951   // Support for virtual threads
1952   if (java_lang_VirtualThread::is_instance(thread_obj)) {
1953     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1954       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1955     }
1956     VM_VirtualThreadGetFrameLocation op(this, Handle(current_thread, thread_obj),
1957                                 depth, method_ptr, location_ptr);
1958     VMThread::execute(&amp;op);
1959     return op.result();
1960   }
1961 
1962   // Support for ordinary threads
1963   ThreadsListHandle tlh(current_thread);
1964   err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
1965   if (err != JVMTI_ERROR_NONE) {
1966     return err;
1967   }
1968 
1969   // It is only safe to perform the direct operation on the current
1970   // thread. All other usage needs to use a vm-safepoint-op for safety.
1971   if (java_thread == JavaThread::current()) {
1972     err = get_frame_location(java_thread, depth, method_ptr, location_ptr);
1973   } else {
1974     // JVMTI get java stack frame location at safepoint.
1975     VM_GetFrameLocation op(this, java_thread, depth, method_ptr, location_ptr);
1976     VMThread::execute(&amp;op);
1977     err = op.result();
1978   }
1979   return err;
1980 } /* end GetFrameLocation */
1981 
1982 
1983 // Threads_lock NOT held, java_thread not protected by lock
1984 // java_thread - pre-checked
1985 // java_thread - unchecked
1986 // depth - pre-checked as non-negative
1987 jvmtiError
1988 JvmtiEnv::NotifyFramePop(JavaThread* java_thread, jint depth) {
1989   jvmtiError err = JVMTI_ERROR_NONE;
1990   ResourceMark rm;
1991   uint32_t debug_bits = 0;
1992 
1993   JvmtiThreadState *state = JvmtiThreadState::state_for(java_thread);
1994   if (state == NULL) {
1995     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1996   }
1997 
1998   if (!java_thread-&gt;is_thread_fully_suspended(true, &amp;debug_bits)) {
1999     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
2000   }
2001 
2002   if (TraceJVMTICalls) {
2003     JvmtiSuspendControl::print();
2004   }
2005 
2006   vframe *vf = vframeFor(java_thread, depth);
2007   if (vf == NULL) {
2008     return JVMTI_ERROR_NO_MORE_FRAMES;
2009   }
2010 
2011   if (!vf-&gt;is_java_frame() || ((javaVFrame*) vf)-&gt;method()-&gt;is_native()) {
2012     return JVMTI_ERROR_OPAQUE_FRAME;
2013   }
2014 
2015   assert(vf-&gt;frame_pointer() != NULL, &quot;frame pointer mustn&#39;t be NULL&quot;);
2016 
2017   // It is only safe to perform the direct operation on the current
2018   // thread. All other usage needs to use a vm-safepoint-op for safety.
2019   if (java_thread == JavaThread::current()) {
2020     int frame_number = state-&gt;count_frames() - depth;
2021     state-&gt;env_thread_state(this)-&gt;set_frame_pop(frame_number);
2022   } else {
2023     VM_SetFramePop op(this, state, depth);
2024     VMThread::execute(&amp;op);
2025     err = op.result();
2026   }
2027   return err;
2028 } /* end NotifyFramePop */
2029 
2030 
2031   //
2032   // Force Early Return functions
2033   //
2034 
2035 // Threads_lock NOT held, java_thread not protected by lock
2036 // java_thread - pre-checked
2037 jvmtiError
2038 JvmtiEnv::ForceEarlyReturnObject(JavaThread* java_thread, jobject value) {
2039   jvalue val;
2040   val.l = value;
2041   return force_early_return(java_thread, val, atos);
2042 } /* end ForceEarlyReturnObject */
2043 
2044 
2045 // Threads_lock NOT held, java_thread not protected by lock
2046 // java_thread - pre-checked
2047 jvmtiError
2048 JvmtiEnv::ForceEarlyReturnInt(JavaThread* java_thread, jint value) {
2049   jvalue val;
2050   val.i = value;
2051   return force_early_return(java_thread, val, itos);
2052 } /* end ForceEarlyReturnInt */
2053 
2054 
2055 // Threads_lock NOT held, java_thread not protected by lock
2056 // java_thread - pre-checked
2057 jvmtiError
2058 JvmtiEnv::ForceEarlyReturnLong(JavaThread* java_thread, jlong value) {
2059   jvalue val;
2060   val.j = value;
2061   return force_early_return(java_thread, val, ltos);
2062 } /* end ForceEarlyReturnLong */
2063 
2064 
2065 // Threads_lock NOT held, java_thread not protected by lock
2066 // java_thread - pre-checked
2067 jvmtiError
2068 JvmtiEnv::ForceEarlyReturnFloat(JavaThread* java_thread, jfloat value) {
2069   jvalue val;
2070   val.f = value;
2071   return force_early_return(java_thread, val, ftos);
2072 } /* end ForceEarlyReturnFloat */
2073 
2074 
2075 // Threads_lock NOT held, java_thread not protected by lock
2076 // java_thread - pre-checked
2077 jvmtiError
2078 JvmtiEnv::ForceEarlyReturnDouble(JavaThread* java_thread, jdouble value) {
2079   jvalue val;
2080   val.d = value;
2081   return force_early_return(java_thread, val, dtos);
2082 } /* end ForceEarlyReturnDouble */
2083 
2084 
2085 // Threads_lock NOT held, java_thread not protected by lock
2086 // java_thread - pre-checked
2087 jvmtiError
2088 JvmtiEnv::ForceEarlyReturnVoid(JavaThread* java_thread) {
2089   jvalue val;
2090   val.j = 0L;
2091   return force_early_return(java_thread, val, vtos);
2092 } /* end ForceEarlyReturnVoid */
2093 
2094 
2095   //
2096   // Heap functions
2097   //
2098 
2099 // klass - NULL is a valid value, must be checked
2100 // initial_object - NULL is a valid value, must be checked
2101 // callbacks - pre-checked for NULL
2102 // user_data - NULL is a valid value, must be checked
2103 jvmtiError
2104 JvmtiEnv::FollowReferences(jint heap_filter, jclass klass, jobject initial_object, const jvmtiHeapCallbacks* callbacks, const void* user_data) {
2105   // check klass if provided
2106   Klass* k = NULL;
2107   if (klass != NULL) {
2108     oop k_mirror = JNIHandles::resolve_external_guard(klass);
2109     if (k_mirror == NULL) {
2110       return JVMTI_ERROR_INVALID_CLASS;
2111     }
2112     if (java_lang_Class::is_primitive(k_mirror)) {
2113       return JVMTI_ERROR_NONE;
2114     }
2115     k = java_lang_Class::as_Klass(k_mirror);
2116     if (klass == NULL) {
2117       return JVMTI_ERROR_INVALID_CLASS;
2118     }
2119   }
2120 
2121   if (initial_object != NULL) {
2122     oop init_obj = JNIHandles::resolve_external_guard(initial_object);
2123     if (init_obj == NULL) {
2124       return JVMTI_ERROR_INVALID_OBJECT;
2125     }
2126   }
2127 
2128   Thread *thread = Thread::current();
2129   HandleMark hm(thread);
2130 
2131   TraceTime t(&quot;FollowReferences&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2132   JvmtiTagMap::tag_map_for(this)-&gt;follow_references(heap_filter, k, initial_object, callbacks, user_data);
2133   return JVMTI_ERROR_NONE;
2134 } /* end FollowReferences */
2135 
2136 
2137 // klass - NULL is a valid value, must be checked
2138 // callbacks - pre-checked for NULL
2139 // user_data - NULL is a valid value, must be checked
2140 jvmtiError
2141 JvmtiEnv::IterateThroughHeap(jint heap_filter, jclass klass, const jvmtiHeapCallbacks* callbacks, const void* user_data) {
2142   // check klass if provided
2143   Klass* k = NULL;
2144   if (klass != NULL) {
2145     oop k_mirror = JNIHandles::resolve_external_guard(klass);
2146     if (k_mirror == NULL) {
2147       return JVMTI_ERROR_INVALID_CLASS;
2148     }
2149     if (java_lang_Class::is_primitive(k_mirror)) {
2150       return JVMTI_ERROR_NONE;
2151     }
2152     k = java_lang_Class::as_Klass(k_mirror);
2153     if (k == NULL) {
2154       return JVMTI_ERROR_INVALID_CLASS;
2155     }
2156   }
2157 
2158   TraceTime t(&quot;IterateThroughHeap&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2159   JvmtiTagMap::tag_map_for(this)-&gt;iterate_through_heap(heap_filter, k, callbacks, user_data);
2160   return JVMTI_ERROR_NONE;
2161 } /* end IterateThroughHeap */
2162 
2163 
2164 // tag_ptr - pre-checked for NULL
2165 jvmtiError
2166 JvmtiEnv::GetTag(jobject object, jlong* tag_ptr) {
2167   oop o = JNIHandles::resolve_external_guard(object);
2168   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
2169   *tag_ptr = JvmtiTagMap::tag_map_for(this)-&gt;get_tag(object);
2170   return JVMTI_ERROR_NONE;
2171 } /* end GetTag */
2172 
2173 
2174 jvmtiError
2175 JvmtiEnv::SetTag(jobject object, jlong tag) {
2176   oop o = JNIHandles::resolve_external_guard(object);
2177   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
2178   JvmtiTagMap::tag_map_for(this)-&gt;set_tag(object, tag);
2179   return JVMTI_ERROR_NONE;
2180 } /* end SetTag */
2181 
2182 
2183 // tag_count - pre-checked to be greater than or equal to 0
2184 // tags - pre-checked for NULL
2185 // count_ptr - pre-checked for NULL
2186 // object_result_ptr - NULL is a valid value, must be checked
2187 // tag_result_ptr - NULL is a valid value, must be checked
2188 jvmtiError
2189 JvmtiEnv::GetObjectsWithTags(jint tag_count, const jlong* tags, jint* count_ptr, jobject** object_result_ptr, jlong** tag_result_ptr) {
2190   TraceTime t(&quot;GetObjectsWithTags&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2191   return JvmtiTagMap::tag_map_for(this)-&gt;get_objects_with_tags((jlong*)tags, tag_count, count_ptr, object_result_ptr, tag_result_ptr);
2192 } /* end GetObjectsWithTags */
2193 
2194 
2195 jvmtiError
2196 JvmtiEnv::ForceGarbageCollection() {
2197   Universe::heap()-&gt;collect(GCCause::_jvmti_force_gc);
2198   return JVMTI_ERROR_NONE;
2199 } /* end ForceGarbageCollection */
2200 
2201 
2202   //
2203   // Heap (1.0) functions
2204   //
2205 
2206 // object_reference_callback - pre-checked for NULL
2207 // user_data - NULL is a valid value, must be checked
2208 jvmtiError
2209 JvmtiEnv::IterateOverObjectsReachableFromObject(jobject object, jvmtiObjectReferenceCallback object_reference_callback, const void* user_data) {
2210   oop o = JNIHandles::resolve_external_guard(object);
2211   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
2212   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_objects_reachable_from_object(object, object_reference_callback, user_data);
2213   return JVMTI_ERROR_NONE;
2214 } /* end IterateOverObjectsReachableFromObject */
2215 
2216 
2217 // heap_root_callback - NULL is a valid value, must be checked
2218 // stack_ref_callback - NULL is a valid value, must be checked
2219 // object_ref_callback - NULL is a valid value, must be checked
2220 // user_data - NULL is a valid value, must be checked
2221 jvmtiError
2222 JvmtiEnv::IterateOverReachableObjects(jvmtiHeapRootCallback heap_root_callback, jvmtiStackReferenceCallback stack_ref_callback, jvmtiObjectReferenceCallback object_ref_callback, const void* user_data) {
2223   TraceTime t(&quot;IterateOverReachableObjects&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2224   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_reachable_objects(heap_root_callback, stack_ref_callback, object_ref_callback, user_data);
2225   return JVMTI_ERROR_NONE;
2226 } /* end IterateOverReachableObjects */
2227 
2228 
2229 // heap_object_callback - pre-checked for NULL
2230 // user_data - NULL is a valid value, must be checked
2231 jvmtiError
2232 JvmtiEnv::IterateOverHeap(jvmtiHeapObjectFilter object_filter, jvmtiHeapObjectCallback heap_object_callback, const void* user_data) {
2233   TraceTime t(&quot;IterateOverHeap&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2234   Thread *thread = Thread::current();
2235   HandleMark hm(thread);
2236   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_heap(object_filter, NULL, heap_object_callback, user_data);
2237   return JVMTI_ERROR_NONE;
2238 } /* end IterateOverHeap */
2239 
2240 
2241 // k_mirror - may be primitive, this must be checked
2242 // heap_object_callback - pre-checked for NULL
2243 // user_data - NULL is a valid value, must be checked
2244 jvmtiError
2245 JvmtiEnv::IterateOverInstancesOfClass(oop k_mirror, jvmtiHeapObjectFilter object_filter, jvmtiHeapObjectCallback heap_object_callback, const void* user_data) {
2246   if (java_lang_Class::is_primitive(k_mirror)) {
2247     // DO PRIMITIVE CLASS PROCESSING
2248     return JVMTI_ERROR_NONE;
2249   }
2250   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2251   if (klass == NULL) {
2252     return JVMTI_ERROR_INVALID_CLASS;
2253   }
2254   TraceTime t(&quot;IterateOverInstancesOfClass&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2255   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_heap(object_filter, klass, heap_object_callback, user_data);
2256   return JVMTI_ERROR_NONE;
2257 } /* end IterateOverInstancesOfClass */
2258 
2259 
2260   //
2261   // Local Variable functions
2262   //
2263 
2264 // Threads_lock NOT held
2265 // thread - NOT pre-checked
2266 // depth - pre-checked as non-negative
2267 // value_ptr - pre-checked for NULL
2268 jvmtiError
2269 JvmtiEnv::GetLocalObject(jthread thread, jint depth, jint slot, jobject* value_ptr) {
2270   jvmtiError err = JVMTI_ERROR_NONE;
2271   JavaThread* java_thread = NULL;
2272   JavaThread* current_thread = JavaThread::current();
2273   // rm object is created to clean up the javaVFrame created in
2274   // doit_prologue(), but after doit() is finished with it.
2275   ResourceMark rm(current_thread);
2276   HandleMark hm(current_thread);
2277   oop thread_obj = JNIHandles::resolve_external_guard(thread);
2278 
2279   if (java_lang_VirtualThread::is_instance(thread_obj)) {
2280     // Support for virtual threads
2281     if (!get_capabilities()-&gt;can_support_virtual_threads) {
2282       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
2283     }
2284     VM_VirtualThreadGetOrSetLocal op(this, Handle(current_thread, thread_obj),
2285                                    current_thread, depth, slot);
2286     VMThread::execute(&amp;op);
2287     err = op.result();
2288     if (err == JVMTI_ERROR_NONE) {
2289       *value_ptr = op.value().l;
2290     }
2291   } else {
2292     // Support for ordinary threads
2293     ThreadsListHandle tlh(current_thread);
2294     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
2295     if (err != JVMTI_ERROR_NONE) {
2296       return err;
2297     }
2298     VM_GetOrSetLocal op(java_thread, current_thread, depth, slot);
2299     VMThread::execute(&amp;op);
2300     err = op.result();
2301     if (err == JVMTI_ERROR_NONE) {
2302       *value_ptr = op.value().l;
2303     }
2304   }
2305   return err;
2306 } /* end GetLocalObject */
2307 
2308 // Threads_lock NOT held
2309 // thread - NOT pre-checked
2310 // depth - pre-checked as non-negative
2311 // value - pre-checked for NULL
2312 jvmtiError
2313 JvmtiEnv::GetLocalInstance(jthread thread, jint depth, jobject* value_ptr){
2314   jvmtiError err = JVMTI_ERROR_NONE;
2315   JavaThread* java_thread = NULL;
2316   JavaThread* current_thread = JavaThread::current();
2317   // rm object is created to clean up the javaVFrame created in
2318   // doit_prologue(), but after doit() is finished with it.
2319   ResourceMark rm(current_thread);
2320   HandleMark hm(current_thread);
2321   oop thread_obj = JNIHandles::resolve_external_guard(thread);
2322 
2323   if (java_lang_VirtualThread::is_instance(thread_obj)) {
2324     // Support for virtual threads
2325     if (!get_capabilities()-&gt;can_support_virtual_threads) {
2326       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
2327     }
2328     VM_VirtualThreadGetReceiver op(this, Handle(current_thread, thread_obj),
2329                                  current_thread, depth);
2330     VMThread::execute(&amp;op);
2331     err = op.result();
<a name="3" id="anc3"></a><span class="line-modified">2332     if (err == JVMTI_ERROR_NONE) {</span>
2333       *value_ptr = op.value().l;
2334     }
2335   } else {
2336     // Support for ordinary threads
2337     ThreadsListHandle tlh(current_thread);
2338     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
2339     if (err != JVMTI_ERROR_NONE) {
2340       return err;
2341     }
2342     VM_GetReceiver op(java_thread, current_thread, depth);
2343     VMThread::execute(&amp;op);
2344     err = op.result();
<a name="4" id="anc4"></a><span class="line-modified">2345     if (err == JVMTI_ERROR_NONE) {</span>
2346       *value_ptr = op.value().l;
2347     }
2348   }
2349   return err;
2350 } /* end GetLocalInstance */
2351 
2352 
2353 // Threads_lock NOT held
2354 // thread - NOT pre-checked
2355 // depth - pre-checked as non-negative
2356 // value_ptr - pre-checked for NULL
2357 jvmtiError
2358 JvmtiEnv::GetLocalInt(jthread thread, jint depth, jint slot, jint* value_ptr) {
2359   jvmtiError err = JVMTI_ERROR_NONE;
2360   JavaThread* java_thread = NULL;
2361   JavaThread* current_thread = JavaThread::current();
2362   // rm object is created to clean up the javaVFrame created in
2363   // doit_prologue(), but after doit() is finished with it.
2364   ResourceMark rm(current_thread);
2365   HandleMark hm(current_thread);
2366   oop thread_obj = JNIHandles::resolve_external_guard(thread);
2367 
2368   if (java_lang_VirtualThread::is_instance(thread_obj)) {
2369     // Support for virtual threads
2370     if (!get_capabilities()-&gt;can_support_virtual_threads) {
2371       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
2372     }
2373     VM_VirtualThreadGetOrSetLocal op(this, Handle(current_thread, thread_obj),
2374                                    depth, slot, T_INT);
2375     VMThread::execute(&amp;op);
2376     err = op.result();
2377     if (err == JVMTI_ERROR_NONE) {
2378       *value_ptr = op.value().i;
2379     }
2380   } else {
2381     // Support for ordinary threads
2382     ThreadsListHandle tlh(current_thread);
2383     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
2384     if (err != JVMTI_ERROR_NONE) {
2385       return err;
2386     }
2387     VM_GetOrSetLocal op(java_thread, depth, slot, T_INT);
2388     VMThread::execute(&amp;op);
2389     err = op.result();
2390     if (err == JVMTI_ERROR_NONE) {
2391       *value_ptr = op.value().i;
2392     }
2393   }
2394   return err;
2395 } /* end GetLocalInt */
2396 
2397 
2398 // Threads_lock NOT held
2399 // thread - NOT pre-checked
2400 // depth - pre-checked as non-negative
2401 // value_ptr - pre-checked for NULL
2402 jvmtiError
2403 JvmtiEnv::GetLocalLong(jthread thread, jint depth, jint slot, jlong* value_ptr) {
2404   jvmtiError err = JVMTI_ERROR_NONE;
2405   JavaThread* java_thread = NULL;
2406   JavaThread* current_thread = JavaThread::current();
2407   // rm object is created to clean up the javaVFrame created in
2408   // doit_prologue(), but after doit() is finished with it.
2409   ResourceMark rm(current_thread);
2410   HandleMark hm(current_thread);
2411   oop thread_obj = JNIHandles::resolve_external_guard(thread);
2412 
2413   if (java_lang_VirtualThread::is_instance(thread_obj)) {
2414     // Support for virtual threads
2415     if (!get_capabilities()-&gt;can_support_virtual_threads) {
2416       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
2417     }
2418     VM_VirtualThreadGetOrSetLocal op(this, Handle(current_thread, thread_obj),
2419                                    depth, slot, T_LONG);
2420     VMThread::execute(&amp;op);
2421     err = op.result();
2422     if (err == JVMTI_ERROR_NONE) {
2423       *value_ptr = op.value().j;
2424     }
2425   } else {
2426     // Support for ordinary threads
2427     ThreadsListHandle tlh(current_thread);
2428     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
2429     if (err != JVMTI_ERROR_NONE) {
2430       return err;
2431     }
2432     VM_GetOrSetLocal op(java_thread, depth, slot, T_LONG);
2433     VMThread::execute(&amp;op);
2434     err = op.result();
2435     if (err == JVMTI_ERROR_NONE) {
2436       *value_ptr = op.value().j;
2437     }
2438   }
2439   return err;
2440 } /* end GetLocalLong */
2441 
2442 
2443 // Threads_lock NOT held
2444 // thread - NOT pre-checked
2445 // depth - pre-checked as non-negative
2446 // value_ptr - pre-checked for NULL
2447 jvmtiError
2448 JvmtiEnv::GetLocalFloat(jthread thread, jint depth, jint slot, jfloat* value_ptr) {
2449   jvmtiError err = JVMTI_ERROR_NONE;
2450   JavaThread* java_thread = NULL;
2451   JavaThread* current_thread = JavaThread::current();
2452   // rm object is created to clean up the javaVFrame created in
2453   // doit_prologue(), but after doit() is finished with it.
2454   ResourceMark rm(current_thread);
2455   HandleMark hm(current_thread);
2456   oop thread_obj = JNIHandles::resolve_external_guard(thread);
2457 
2458   if (java_lang_VirtualThread::is_instance(thread_obj)) {
2459     // Support for virtual threads
2460     if (!get_capabilities()-&gt;can_support_virtual_threads) {
2461       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
2462     }
2463     VM_VirtualThreadGetOrSetLocal op(this, Handle(current_thread, thread_obj),
2464                                    depth, slot, T_FLOAT);
2465     VMThread::execute(&amp;op);
2466     err = op.result();
2467     if (err == JVMTI_ERROR_NONE) {
2468       *value_ptr = op.value().f;
2469     }
2470   } else {
2471     // Support for ordinary threads
2472     ThreadsListHandle tlh(current_thread);
2473     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
2474     if (err != JVMTI_ERROR_NONE) {
2475       return err;
2476     }
2477     VM_GetOrSetLocal op(java_thread, depth, slot, T_FLOAT);
2478     VMThread::execute(&amp;op);
2479     err = op.result();
2480     if (err == JVMTI_ERROR_NONE) {
2481       *value_ptr = op.value().f;
2482     }
2483   }
2484   return err;
2485 } /* end GetLocalFloat */
2486 
2487 
2488 // Threads_lock NOT held
2489 // thread - NOT pre-checked
2490 // depth - pre-checked as non-negative
2491 // value_ptr - pre-checked for NULL
2492 jvmtiError
2493 JvmtiEnv::GetLocalDouble(jthread thread, jint depth, jint slot, jdouble* value_ptr) {
2494   jvmtiError err = JVMTI_ERROR_NONE;
2495   JavaThread* java_thread = NULL;
2496   JavaThread* current_thread = JavaThread::current();
2497   // rm object is created to clean up the javaVFrame created in
2498   // doit_prologue(), but after doit() is finished with it.
2499   ResourceMark rm(current_thread);
2500   HandleMark hm(current_thread);
2501   oop thread_obj = JNIHandles::resolve_external_guard(thread);
2502 
2503   if (java_lang_VirtualThread::is_instance(thread_obj)) {
2504     // Support for virtual threads
2505     if (!get_capabilities()-&gt;can_support_virtual_threads) {
2506       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
2507     }
2508     VM_VirtualThreadGetOrSetLocal op(this, Handle(current_thread, thread_obj),
2509                                    depth, slot, T_DOUBLE);
2510     VMThread::execute(&amp;op);
2511     err = op.result();
2512     if (err == JVMTI_ERROR_NONE) {
2513       *value_ptr = op.value().d;
2514     }
2515   } else {
2516     // Support for ordinary threads
2517     ThreadsListHandle tlh(current_thread);
2518     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
2519     if (err != JVMTI_ERROR_NONE) {
2520       return err;
2521     }
2522     VM_GetOrSetLocal op(java_thread, depth, slot, T_DOUBLE);
2523     VMThread::execute(&amp;op);
2524     err = op.result();
2525     if (err == JVMTI_ERROR_NONE) {
2526       *value_ptr = op.value().d;
2527     }
2528   }
2529   return err;
2530 } /* end GetLocalDouble */
2531 
2532 
2533 // Threads_lock NOT held, java_thread not protected by lock
2534 // java_thread - pre-checked
2535 // java_thread - unchecked
2536 // depth - pre-checked as non-negative
2537 jvmtiError
2538 JvmtiEnv::SetLocalObject(JavaThread* java_thread, jint depth, jint slot, jobject value) {
2539   // rm object is created to clean up the javaVFrame created in
2540   // doit_prologue(), but after doit() is finished with it.
2541   ResourceMark rm;
2542   jvalue val;
2543   val.l = value;
2544   VM_GetOrSetLocal op(java_thread, depth, slot, T_OBJECT, val);
2545   VMThread::execute(&amp;op);
2546   return op.result();
2547 } /* end SetLocalObject */
2548 
2549 
2550 // Threads_lock NOT held, java_thread not protected by lock
2551 // java_thread - pre-checked
2552 // java_thread - unchecked
2553 // depth - pre-checked as non-negative
2554 jvmtiError
2555 JvmtiEnv::SetLocalInt(JavaThread* java_thread, jint depth, jint slot, jint value) {
2556   // rm object is created to clean up the javaVFrame created in
2557   // doit_prologue(), but after doit() is finished with it.
2558   ResourceMark rm;
2559   jvalue val;
2560   val.i = value;
2561   VM_GetOrSetLocal op(java_thread, depth, slot, T_INT, val);
2562   VMThread::execute(&amp;op);
2563   return op.result();
2564 } /* end SetLocalInt */
2565 
2566 
2567 // Threads_lock NOT held, java_thread not protected by lock
2568 // java_thread - pre-checked
2569 // java_thread - unchecked
2570 // depth - pre-checked as non-negative
2571 jvmtiError
2572 JvmtiEnv::SetLocalLong(JavaThread* java_thread, jint depth, jint slot, jlong value) {
2573   // rm object is created to clean up the javaVFrame created in
2574   // doit_prologue(), but after doit() is finished with it.
2575   ResourceMark rm;
2576   jvalue val;
2577   val.j = value;
2578   VM_GetOrSetLocal op(java_thread, depth, slot, T_LONG, val);
2579   VMThread::execute(&amp;op);
2580   return op.result();
2581 } /* end SetLocalLong */
2582 
2583 
2584 // Threads_lock NOT held, java_thread not protected by lock
2585 // java_thread - pre-checked
2586 // java_thread - unchecked
2587 // depth - pre-checked as non-negative
2588 jvmtiError
2589 JvmtiEnv::SetLocalFloat(JavaThread* java_thread, jint depth, jint slot, jfloat value) {
2590   // rm object is created to clean up the javaVFrame created in
2591   // doit_prologue(), but after doit() is finished with it.
2592   ResourceMark rm;
2593   jvalue val;
2594   val.f = value;
2595   VM_GetOrSetLocal op(java_thread, depth, slot, T_FLOAT, val);
2596   VMThread::execute(&amp;op);
2597   return op.result();
2598 } /* end SetLocalFloat */
2599 
2600 
2601 // Threads_lock NOT held, java_thread not protected by lock
2602 // java_thread - pre-checked
2603 // java_thread - unchecked
2604 // depth - pre-checked as non-negative
2605 jvmtiError
2606 JvmtiEnv::SetLocalDouble(JavaThread* java_thread, jint depth, jint slot, jdouble value) {
2607   // rm object is created to clean up the javaVFrame created in
2608   // doit_prologue(), but after doit() is finished with it.
2609   ResourceMark rm;
2610   jvalue val;
2611   val.d = value;
2612   VM_GetOrSetLocal op(java_thread, depth, slot, T_DOUBLE, val);
2613   VMThread::execute(&amp;op);
2614   return op.result();
2615 } /* end SetLocalDouble */
2616 
2617 
2618   //
2619   // Breakpoint functions
2620   //
2621 
2622 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2623 jvmtiError
2624 JvmtiEnv::SetBreakpoint(Method* method_oop, jlocation location) {
2625   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2626   if (location &lt; 0) {   // simple invalid location check first
2627     return JVMTI_ERROR_INVALID_LOCATION;
2628   }
2629   // verify that the breakpoint is not past the end of the method
2630   if (location &gt;= (jlocation) method_oop-&gt;code_size()) {
2631     return JVMTI_ERROR_INVALID_LOCATION;
2632   }
2633 
2634   ResourceMark rm;
2635   JvmtiBreakpoint bp(method_oop, location);
2636   JvmtiBreakpoints&amp; jvmti_breakpoints = JvmtiCurrentBreakpoints::get_jvmti_breakpoints();
2637   if (jvmti_breakpoints.set(bp) == JVMTI_ERROR_DUPLICATE)
2638     return JVMTI_ERROR_DUPLICATE;
2639 
2640   if (TraceJVMTICalls) {
2641     jvmti_breakpoints.print();
2642   }
2643 
2644   return JVMTI_ERROR_NONE;
2645 } /* end SetBreakpoint */
2646 
2647 
2648 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2649 jvmtiError
2650 JvmtiEnv::ClearBreakpoint(Method* method_oop, jlocation location) {
2651   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2652 
2653   if (location &lt; 0) {   // simple invalid location check first
2654     return JVMTI_ERROR_INVALID_LOCATION;
2655   }
2656 
2657   // verify that the breakpoint is not past the end of the method
2658   if (location &gt;= (jlocation) method_oop-&gt;code_size()) {
2659     return JVMTI_ERROR_INVALID_LOCATION;
2660   }
2661 
2662   JvmtiBreakpoint bp(method_oop, location);
2663 
2664   JvmtiBreakpoints&amp; jvmti_breakpoints = JvmtiCurrentBreakpoints::get_jvmti_breakpoints();
2665   if (jvmti_breakpoints.clear(bp) == JVMTI_ERROR_NOT_FOUND)
2666     return JVMTI_ERROR_NOT_FOUND;
2667 
2668   if (TraceJVMTICalls) {
2669     jvmti_breakpoints.print();
2670   }
2671 
2672   return JVMTI_ERROR_NONE;
2673 } /* end ClearBreakpoint */
2674 
2675 
2676   //
2677   // Watched Field functions
2678   //
2679 
2680 jvmtiError
2681 JvmtiEnv::SetFieldAccessWatch(fieldDescriptor* fdesc_ptr) {
2682   // make sure we haven&#39;t set this watch before
2683   if (fdesc_ptr-&gt;is_field_access_watched()) return JVMTI_ERROR_DUPLICATE;
2684   fdesc_ptr-&gt;set_is_field_access_watched(true);
2685 
2686   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_ACCESS, true);
2687 
2688   return JVMTI_ERROR_NONE;
2689 } /* end SetFieldAccessWatch */
2690 
2691 
2692 jvmtiError
2693 JvmtiEnv::ClearFieldAccessWatch(fieldDescriptor* fdesc_ptr) {
2694   // make sure we have a watch to clear
2695   if (!fdesc_ptr-&gt;is_field_access_watched()) return JVMTI_ERROR_NOT_FOUND;
2696   fdesc_ptr-&gt;set_is_field_access_watched(false);
2697 
2698   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_ACCESS, false);
2699 
2700   return JVMTI_ERROR_NONE;
2701 } /* end ClearFieldAccessWatch */
2702 
2703 
2704 jvmtiError
2705 JvmtiEnv::SetFieldModificationWatch(fieldDescriptor* fdesc_ptr) {
2706   // make sure we haven&#39;t set this watch before
2707   if (fdesc_ptr-&gt;is_field_modification_watched()) return JVMTI_ERROR_DUPLICATE;
2708   fdesc_ptr-&gt;set_is_field_modification_watched(true);
2709 
2710   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_MODIFICATION, true);
2711 
2712   return JVMTI_ERROR_NONE;
2713 } /* end SetFieldModificationWatch */
2714 
2715 
2716 jvmtiError
2717 JvmtiEnv::ClearFieldModificationWatch(fieldDescriptor* fdesc_ptr) {
2718    // make sure we have a watch to clear
2719   if (!fdesc_ptr-&gt;is_field_modification_watched()) return JVMTI_ERROR_NOT_FOUND;
2720   fdesc_ptr-&gt;set_is_field_modification_watched(false);
2721 
2722   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_MODIFICATION, false);
2723 
2724   return JVMTI_ERROR_NONE;
2725 } /* end ClearFieldModificationWatch */
2726 
2727   //
2728   // Class functions
2729   //
2730 
2731 
2732 // k_mirror - may be primitive, this must be checked
2733 // signature_ptr - NULL is a valid value, must be checked
2734 // generic_ptr - NULL is a valid value, must be checked
2735 jvmtiError
2736 JvmtiEnv::GetClassSignature(oop k_mirror, char** signature_ptr, char** generic_ptr) {
2737   ResourceMark rm;
2738   bool isPrimitive = java_lang_Class::is_primitive(k_mirror);
2739   Klass* k = NULL;
2740   if (!isPrimitive) {
2741     k = java_lang_Class::as_Klass(k_mirror);
2742     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2743   }
2744   if (signature_ptr != NULL) {
2745     char* result = NULL;
2746     if (isPrimitive) {
2747       char tchar = type2char(java_lang_Class::primitive_type(k_mirror));
2748       result = (char*) jvmtiMalloc(2);
2749       result[0] = tchar;
2750       result[1] = &#39;\0&#39;;
2751     } else {
2752       const char* class_sig = k-&gt;signature_name();
2753       result = (char *) jvmtiMalloc(strlen(class_sig)+1);
2754       strcpy(result, class_sig);
2755     }
2756     *signature_ptr = result;
2757   }
2758   if (generic_ptr != NULL) {
2759     *generic_ptr = NULL;
2760     if (!isPrimitive &amp;&amp; k-&gt;is_instance_klass()) {
2761       Symbol* soo = InstanceKlass::cast(k)-&gt;generic_signature();
2762       if (soo != NULL) {
2763         const char *gen_sig = soo-&gt;as_C_string();
2764         if (gen_sig != NULL) {
2765           char* gen_result;
2766           jvmtiError err = allocate(strlen(gen_sig) + 1,
2767                                     (unsigned char **)&amp;gen_result);
2768           if (err != JVMTI_ERROR_NONE) {
2769             return err;
2770           }
2771           strcpy(gen_result, gen_sig);
2772           *generic_ptr = gen_result;
2773         }
2774       }
2775     }
2776   }
2777   return JVMTI_ERROR_NONE;
2778 } /* end GetClassSignature */
2779 
2780 
2781 // k_mirror - may be primitive, this must be checked
2782 // status_ptr - pre-checked for NULL
2783 jvmtiError
2784 JvmtiEnv::GetClassStatus(oop k_mirror, jint* status_ptr) {
2785   jint result = 0;
2786   if (java_lang_Class::is_primitive(k_mirror)) {
2787     result |= JVMTI_CLASS_STATUS_PRIMITIVE;
2788   } else {
2789     Klass* k = java_lang_Class::as_Klass(k_mirror);
2790     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2791     result = k-&gt;jvmti_class_status();
2792   }
2793   *status_ptr = result;
2794 
2795   return JVMTI_ERROR_NONE;
2796 } /* end GetClassStatus */
2797 
2798 
2799 // k_mirror - may be primitive, this must be checked
2800 // source_name_ptr - pre-checked for NULL
2801 jvmtiError
2802 JvmtiEnv::GetSourceFileName(oop k_mirror, char** source_name_ptr) {
2803   if (java_lang_Class::is_primitive(k_mirror)) {
2804      return JVMTI_ERROR_ABSENT_INFORMATION;
2805   }
2806   Klass* k_klass = java_lang_Class::as_Klass(k_mirror);
2807   NULL_CHECK(k_klass, JVMTI_ERROR_INVALID_CLASS);
2808 
2809   if (!k_klass-&gt;is_instance_klass()) {
2810     return JVMTI_ERROR_ABSENT_INFORMATION;
2811   }
2812 
2813   Symbol* sfnOop = InstanceKlass::cast(k_klass)-&gt;source_file_name();
2814   NULL_CHECK(sfnOop, JVMTI_ERROR_ABSENT_INFORMATION);
2815   {
2816     JavaThread* current_thread  = JavaThread::current();
2817     ResourceMark rm(current_thread);
2818     const char* sfncp = (const char*) sfnOop-&gt;as_C_string();
2819     *source_name_ptr = (char *) jvmtiMalloc(strlen(sfncp)+1);
2820     strcpy(*source_name_ptr, sfncp);
2821   }
2822 
2823   return JVMTI_ERROR_NONE;
2824 } /* end GetSourceFileName */
2825 
2826 
2827 // k_mirror - may be primitive, this must be checked
2828 // modifiers_ptr - pre-checked for NULL
2829 jvmtiError
2830 JvmtiEnv::GetClassModifiers(oop k_mirror, jint* modifiers_ptr) {
2831   JavaThread* current_thread  = JavaThread::current();
2832   jint result = 0;
2833   if (!java_lang_Class::is_primitive(k_mirror)) {
2834     Klass* k = java_lang_Class::as_Klass(k_mirror);
2835     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2836     result = k-&gt;compute_modifier_flags(current_thread);
2837     JavaThread* THREAD = current_thread; // pass to macros
2838     if (HAS_PENDING_EXCEPTION) {
2839       CLEAR_PENDING_EXCEPTION;
2840       return JVMTI_ERROR_INTERNAL;
2841     };
2842 
2843     // Reset the deleted  ACC_SUPER bit ( deleted in compute_modifier_flags()).
2844     if(k-&gt;is_super()) {
2845       result |= JVM_ACC_SUPER;
2846     }
2847   } else {
2848     result = (JVM_ACC_ABSTRACT | JVM_ACC_FINAL | JVM_ACC_PUBLIC);
2849   }
2850   *modifiers_ptr = result;
2851 
2852   return JVMTI_ERROR_NONE;
2853 } /* end GetClassModifiers */
2854 
2855 
2856 // k_mirror - may be primitive, this must be checked
2857 // method_count_ptr - pre-checked for NULL
2858 // methods_ptr - pre-checked for NULL
2859 jvmtiError
2860 JvmtiEnv::GetClassMethods(oop k_mirror, jint* method_count_ptr, jmethodID** methods_ptr) {
2861   JavaThread* current_thread  = JavaThread::current();
2862   HandleMark hm(current_thread);
2863 
2864   if (java_lang_Class::is_primitive(k_mirror)) {
2865     *method_count_ptr = 0;
2866     *methods_ptr = (jmethodID*) jvmtiMalloc(0 * sizeof(jmethodID));
2867     return JVMTI_ERROR_NONE;
2868   }
2869   Klass* k = java_lang_Class::as_Klass(k_mirror);
2870   NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2871 
2872   // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2873   if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) )) {
2874     return JVMTI_ERROR_CLASS_NOT_PREPARED;
2875   }
2876 
2877   if (!k-&gt;is_instance_klass()) {
2878     *method_count_ptr = 0;
2879     *methods_ptr = (jmethodID*) jvmtiMalloc(0 * sizeof(jmethodID));
2880     return JVMTI_ERROR_NONE;
2881   }
2882   InstanceKlass* ik = InstanceKlass::cast(k);
2883   // Allocate the result and fill it in
2884   int result_length = ik-&gt;methods()-&gt;length();
2885   jmethodID* result_list = (jmethodID*)jvmtiMalloc(result_length * sizeof(jmethodID));
2886   int index;
2887   bool jmethodids_found = true;
2888 
2889   if (JvmtiExport::can_maintain_original_method_order()) {
2890     // Use the original method ordering indices stored in the class, so we can emit
2891     // jmethodIDs in the order they appeared in the class file
2892     for (index = 0; index &lt; result_length; index++) {
2893       Method* m = ik-&gt;methods()-&gt;at(index);
2894       int original_index = ik-&gt;method_ordering()-&gt;at(index);
2895       assert(original_index &gt;= 0 &amp;&amp; original_index &lt; result_length, &quot;invalid original method index&quot;);
2896       jmethodID id;
2897       if (jmethodids_found) {
2898         id = m-&gt;find_jmethod_id_or_null();
2899         if (id == NULL) {
2900           // If we find an uninitialized value, make sure there is
2901           // enough space for all the uninitialized values we might
2902           // find.
2903           ik-&gt;ensure_space_for_methodids(index);
2904           jmethodids_found = false;
2905           id = m-&gt;jmethod_id();
2906         }
2907       } else {
2908         id = m-&gt;jmethod_id();
2909       }
2910       result_list[original_index] = id;
2911     }
2912   } else {
2913     // otherwise just copy in any order
2914     for (index = 0; index &lt; result_length; index++) {
2915       Method* m = ik-&gt;methods()-&gt;at(index);
2916       jmethodID id;
2917       if (jmethodids_found) {
2918         id = m-&gt;find_jmethod_id_or_null();
2919         if (id == NULL) {
2920           // If we find an uninitialized value, make sure there is
2921           // enough space for all the uninitialized values we might
2922           // find.
2923           ik-&gt;ensure_space_for_methodids(index);
2924           jmethodids_found = false;
2925           id = m-&gt;jmethod_id();
2926         }
2927       } else {
2928         id = m-&gt;jmethod_id();
2929       }
2930       result_list[index] = id;
2931     }
2932   }
2933   // Fill in return value.
2934   *method_count_ptr = result_length;
2935   *methods_ptr = result_list;
2936 
2937   return JVMTI_ERROR_NONE;
2938 } /* end GetClassMethods */
2939 
2940 
2941 // k_mirror - may be primitive, this must be checked
2942 // field_count_ptr - pre-checked for NULL
2943 // fields_ptr - pre-checked for NULL
2944 jvmtiError
2945 JvmtiEnv::GetClassFields(oop k_mirror, jint* field_count_ptr, jfieldID** fields_ptr) {
2946   if (java_lang_Class::is_primitive(k_mirror)) {
2947     *field_count_ptr = 0;
2948     *fields_ptr = (jfieldID*) jvmtiMalloc(0 * sizeof(jfieldID));
2949     return JVMTI_ERROR_NONE;
2950   }
2951   JavaThread* current_thread = JavaThread::current();
2952   HandleMark hm(current_thread);
2953   Klass* k = java_lang_Class::as_Klass(k_mirror);
2954   NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2955 
2956   // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2957   if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) )) {
2958     return JVMTI_ERROR_CLASS_NOT_PREPARED;
2959   }
2960 
2961   if (!k-&gt;is_instance_klass()) {
2962     *field_count_ptr = 0;
2963     *fields_ptr = (jfieldID*) jvmtiMalloc(0 * sizeof(jfieldID));
2964     return JVMTI_ERROR_NONE;
2965   }
2966 
2967 
2968   InstanceKlass* ik = InstanceKlass::cast(k);
2969 
2970   int result_count = 0;
2971   // First, count the fields.
2972   FilteredFieldStream flds(ik, true, true);
2973   result_count = flds.field_count();
2974 
2975   // Allocate the result and fill it in
2976   jfieldID* result_list = (jfieldID*) jvmtiMalloc(result_count * sizeof(jfieldID));
2977   // The JVMTI spec requires fields in the order they occur in the class file,
2978   // this is the reverse order of what FieldStream hands out.
2979   int id_index = (result_count - 1);
2980 
2981   for (FilteredFieldStream src_st(ik, true, true); !src_st.eos(); src_st.next()) {
2982     result_list[id_index--] = jfieldIDWorkaround::to_jfieldID(
2983                                             ik, src_st.offset(),
2984                                             src_st.access_flags().is_static());
2985   }
2986   assert(id_index == -1, &quot;just checking&quot;);
2987   // Fill in the results
2988   *field_count_ptr = result_count;
2989   *fields_ptr = result_list;
2990 
2991   return JVMTI_ERROR_NONE;
2992 } /* end GetClassFields */
2993 
2994 
2995 // k_mirror - may be primitive, this must be checked
2996 // interface_count_ptr - pre-checked for NULL
2997 // interfaces_ptr - pre-checked for NULL
2998 jvmtiError
2999 JvmtiEnv::GetImplementedInterfaces(oop k_mirror, jint* interface_count_ptr, jclass** interfaces_ptr) {
3000   {
3001     if (java_lang_Class::is_primitive(k_mirror)) {
3002       *interface_count_ptr = 0;
3003       *interfaces_ptr = (jclass*) jvmtiMalloc(0 * sizeof(jclass));
3004       return JVMTI_ERROR_NONE;
3005     }
3006     JavaThread* current_thread = JavaThread::current();
3007     HandleMark hm(current_thread);
3008     Klass* k = java_lang_Class::as_Klass(k_mirror);
3009     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
3010 
3011     // Return CLASS_NOT_PREPARED error as per JVMTI spec.
3012     if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) ))
3013       return JVMTI_ERROR_CLASS_NOT_PREPARED;
3014 
3015     if (!k-&gt;is_instance_klass()) {
3016       *interface_count_ptr = 0;
3017       *interfaces_ptr = (jclass*) jvmtiMalloc(0 * sizeof(jclass));
3018       return JVMTI_ERROR_NONE;
3019     }
3020 
3021     Array&lt;InstanceKlass*&gt;* interface_list = InstanceKlass::cast(k)-&gt;local_interfaces();
3022     const int result_length = (interface_list == NULL ? 0 : interface_list-&gt;length());
3023     jclass* result_list = (jclass*) jvmtiMalloc(result_length * sizeof(jclass));
3024     for (int i_index = 0; i_index &lt; result_length; i_index += 1) {
3025       InstanceKlass* klass_at = interface_list-&gt;at(i_index);
3026       assert(klass_at-&gt;is_klass(), &quot;interfaces must be Klass*s&quot;);
3027       assert(klass_at-&gt;is_interface(), &quot;interfaces must be interfaces&quot;);
3028       oop mirror_at = klass_at-&gt;java_mirror();
3029       Handle handle_at = Handle(current_thread, mirror_at);
3030       result_list[i_index] = (jclass) jni_reference(handle_at);
3031     }
3032     *interface_count_ptr = result_length;
3033     *interfaces_ptr = result_list;
3034   }
3035 
3036   return JVMTI_ERROR_NONE;
3037 } /* end GetImplementedInterfaces */
3038 
3039 
3040 // k_mirror - may be primitive, this must be checked
3041 // minor_version_ptr - pre-checked for NULL
3042 // major_version_ptr - pre-checked for NULL
3043 jvmtiError
3044 JvmtiEnv::GetClassVersionNumbers(oop k_mirror, jint* minor_version_ptr, jint* major_version_ptr) {
3045   if (java_lang_Class::is_primitive(k_mirror)) {
3046     return JVMTI_ERROR_ABSENT_INFORMATION;
3047   }
3048   Klass* klass = java_lang_Class::as_Klass(k_mirror);
3049 
3050   jint status = klass-&gt;jvmti_class_status();
3051   if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
3052     return JVMTI_ERROR_INVALID_CLASS;
3053   }
3054   if (status &amp; (JVMTI_CLASS_STATUS_ARRAY)) {
3055     return JVMTI_ERROR_ABSENT_INFORMATION;
3056   }
3057 
3058   InstanceKlass* ik = InstanceKlass::cast(klass);
3059   *minor_version_ptr = ik-&gt;minor_version();
3060   *major_version_ptr = ik-&gt;major_version();
3061 
3062   return JVMTI_ERROR_NONE;
3063 } /* end GetClassVersionNumbers */
3064 
3065 
3066 // k_mirror - may be primitive, this must be checked
3067 // constant_pool_count_ptr - pre-checked for NULL
3068 // constant_pool_byte_count_ptr - pre-checked for NULL
3069 // constant_pool_bytes_ptr - pre-checked for NULL
3070 jvmtiError
3071 JvmtiEnv::GetConstantPool(oop k_mirror, jint* constant_pool_count_ptr, jint* constant_pool_byte_count_ptr, unsigned char** constant_pool_bytes_ptr) {
3072   if (java_lang_Class::is_primitive(k_mirror)) {
3073     return JVMTI_ERROR_ABSENT_INFORMATION;
3074   }
3075 
3076   Klass* klass = java_lang_Class::as_Klass(k_mirror);
3077   Thread *thread = Thread::current();
3078   ResourceMark rm(thread);
3079 
3080   jint status = klass-&gt;jvmti_class_status();
3081   if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
3082     return JVMTI_ERROR_INVALID_CLASS;
3083   }
3084   if (status &amp; (JVMTI_CLASS_STATUS_ARRAY)) {
3085     return JVMTI_ERROR_ABSENT_INFORMATION;
3086   }
3087 
3088   InstanceKlass* ik = InstanceKlass::cast(klass);
3089   JvmtiConstantPoolReconstituter reconstituter(ik);
3090   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
3091     return reconstituter.get_error();
3092   }
3093 
3094   unsigned char *cpool_bytes;
3095   int cpool_size = reconstituter.cpool_size();
3096   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
3097     return reconstituter.get_error();
3098   }
3099   jvmtiError res = allocate(cpool_size, &amp;cpool_bytes);
3100   if (res != JVMTI_ERROR_NONE) {
3101     return res;
3102   }
3103   reconstituter.copy_cpool_bytes(cpool_bytes);
3104   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
3105     return reconstituter.get_error();
3106   }
3107 
3108   constantPoolHandle  constants(thread, ik-&gt;constants());
3109   *constant_pool_count_ptr      = constants-&gt;length();
3110   *constant_pool_byte_count_ptr = cpool_size;
3111   *constant_pool_bytes_ptr      = cpool_bytes;
3112 
3113   return JVMTI_ERROR_NONE;
3114 } /* end GetConstantPool */
3115 
3116 
3117 // k_mirror - may be primitive, this must be checked
3118 // is_interface_ptr - pre-checked for NULL
3119 jvmtiError
3120 JvmtiEnv::IsInterface(oop k_mirror, jboolean* is_interface_ptr) {
3121   {
3122     bool result = false;
3123     if (!java_lang_Class::is_primitive(k_mirror)) {
3124       Klass* k = java_lang_Class::as_Klass(k_mirror);
3125       if (k != NULL &amp;&amp; k-&gt;is_interface()) {
3126         result = true;
3127       }
3128     }
3129     *is_interface_ptr = result;
3130   }
3131 
3132   return JVMTI_ERROR_NONE;
3133 } /* end IsInterface */
3134 
3135 
3136 // k_mirror - may be primitive, this must be checked
3137 // is_array_class_ptr - pre-checked for NULL
3138 jvmtiError
3139 JvmtiEnv::IsArrayClass(oop k_mirror, jboolean* is_array_class_ptr) {
3140   {
3141     bool result = false;
3142     if (!java_lang_Class::is_primitive(k_mirror)) {
3143       Klass* k = java_lang_Class::as_Klass(k_mirror);
3144       if (k != NULL &amp;&amp; k-&gt;is_array_klass()) {
3145         result = true;
3146       }
3147     }
3148     *is_array_class_ptr = result;
3149   }
3150 
3151   return JVMTI_ERROR_NONE;
3152 } /* end IsArrayClass */
3153 
3154 
3155 // k_mirror - may be primitive, this must be checked
3156 // classloader_ptr - pre-checked for NULL
3157 jvmtiError
3158 JvmtiEnv::GetClassLoader(oop k_mirror, jobject* classloader_ptr) {
3159   {
3160     if (java_lang_Class::is_primitive(k_mirror)) {
3161       *classloader_ptr = (jclass) jni_reference(Handle());
3162       return JVMTI_ERROR_NONE;
3163     }
3164     JavaThread* current_thread = JavaThread::current();
3165     HandleMark hm(current_thread);
3166     Klass* k = java_lang_Class::as_Klass(k_mirror);
3167     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
3168 
3169     oop result_oop = k-&gt;class_loader();
3170     if (result_oop == NULL) {
3171       *classloader_ptr = (jclass) jni_reference(Handle());
3172       return JVMTI_ERROR_NONE;
3173     }
3174     Handle result_handle = Handle(current_thread, result_oop);
3175     jclass result_jnihandle = (jclass) jni_reference(result_handle);
3176     *classloader_ptr = result_jnihandle;
3177   }
3178   return JVMTI_ERROR_NONE;
3179 } /* end GetClassLoader */
3180 
3181 
3182 // k_mirror - may be primitive, this must be checked
3183 // source_debug_extension_ptr - pre-checked for NULL
3184 jvmtiError
3185 JvmtiEnv::GetSourceDebugExtension(oop k_mirror, char** source_debug_extension_ptr) {
3186   {
3187     if (java_lang_Class::is_primitive(k_mirror)) {
3188       return JVMTI_ERROR_ABSENT_INFORMATION;
3189     }
3190     Klass* k = java_lang_Class::as_Klass(k_mirror);
3191     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
3192     if (!k-&gt;is_instance_klass()) {
3193       return JVMTI_ERROR_ABSENT_INFORMATION;
3194     }
3195     const char* sde = InstanceKlass::cast(k)-&gt;source_debug_extension();
3196     NULL_CHECK(sde, JVMTI_ERROR_ABSENT_INFORMATION);
3197 
3198     {
3199       *source_debug_extension_ptr = (char *) jvmtiMalloc(strlen(sde)+1);
3200       strcpy(*source_debug_extension_ptr, sde);
3201     }
3202   }
3203 
3204   return JVMTI_ERROR_NONE;
3205 } /* end GetSourceDebugExtension */
3206 
3207   //
3208   // Object functions
3209   //
3210 
3211 // hash_code_ptr - pre-checked for NULL
3212 jvmtiError
3213 JvmtiEnv::GetObjectHashCode(jobject object, jint* hash_code_ptr) {
3214   oop mirror = JNIHandles::resolve_external_guard(object);
3215   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
3216   NULL_CHECK(hash_code_ptr, JVMTI_ERROR_NULL_POINTER);
3217 
3218   {
3219     jint result = (jint) mirror-&gt;identity_hash();
3220     *hash_code_ptr = result;
3221   }
3222   return JVMTI_ERROR_NONE;
3223 } /* end GetObjectHashCode */
3224 
3225 
3226 // info_ptr - pre-checked for NULL
3227 jvmtiError
3228 JvmtiEnv::GetObjectMonitorUsage(jobject object, jvmtiMonitorUsage* info_ptr) {
3229   JavaThread* calling_thread = JavaThread::current();
3230   jvmtiError err = get_object_monitor_usage(calling_thread, object, info_ptr);
3231   if (err == JVMTI_ERROR_THREAD_NOT_SUSPENDED) {
3232     // Some of the critical threads were not suspended. go to a safepoint and try again
3233     VM_GetObjectMonitorUsage op(this, calling_thread, object, info_ptr);
3234     VMThread::execute(&amp;op);
3235     err = op.result();
3236   }
3237   return err;
3238 } /* end GetObjectMonitorUsage */
3239 
3240 
3241   //
3242   // Field functions
3243   //
3244 
3245 // name_ptr - NULL is a valid value, must be checked
3246 // signature_ptr - NULL is a valid value, must be checked
3247 // generic_ptr - NULL is a valid value, must be checked
3248 jvmtiError
3249 JvmtiEnv::GetFieldName(fieldDescriptor* fdesc_ptr, char** name_ptr, char** signature_ptr, char** generic_ptr) {
3250   JavaThread* current_thread  = JavaThread::current();
3251   ResourceMark rm(current_thread);
3252   if (name_ptr == NULL) {
3253     // just don&#39;t return the name
3254   } else {
3255     const char* fieldName = fdesc_ptr-&gt;name()-&gt;as_C_string();
3256     *name_ptr =  (char*) jvmtiMalloc(strlen(fieldName) + 1);
3257     if (*name_ptr == NULL)
3258       return JVMTI_ERROR_OUT_OF_MEMORY;
3259     strcpy(*name_ptr, fieldName);
3260   }
3261   if (signature_ptr== NULL) {
3262     // just don&#39;t return the signature
3263   } else {
3264     const char* fieldSignature = fdesc_ptr-&gt;signature()-&gt;as_C_string();
3265     *signature_ptr = (char*) jvmtiMalloc(strlen(fieldSignature) + 1);
3266     if (*signature_ptr == NULL)
3267       return JVMTI_ERROR_OUT_OF_MEMORY;
3268     strcpy(*signature_ptr, fieldSignature);
3269   }
3270   if (generic_ptr != NULL) {
3271     *generic_ptr = NULL;
3272     Symbol* soop = fdesc_ptr-&gt;generic_signature();
3273     if (soop != NULL) {
3274       const char* gen_sig = soop-&gt;as_C_string();
3275       if (gen_sig != NULL) {
3276         jvmtiError err = allocate(strlen(gen_sig) + 1, (unsigned char **)generic_ptr);
3277         if (err != JVMTI_ERROR_NONE) {
3278           return err;
3279         }
3280         strcpy(*generic_ptr, gen_sig);
3281       }
3282     }
3283   }
3284   return JVMTI_ERROR_NONE;
3285 } /* end GetFieldName */
3286 
3287 
3288 // declaring_class_ptr - pre-checked for NULL
3289 jvmtiError
3290 JvmtiEnv::GetFieldDeclaringClass(fieldDescriptor* fdesc_ptr, jclass* declaring_class_ptr) {
3291 
3292   *declaring_class_ptr = get_jni_class_non_null(fdesc_ptr-&gt;field_holder());
3293   return JVMTI_ERROR_NONE;
3294 } /* end GetFieldDeclaringClass */
3295 
3296 
3297 // modifiers_ptr - pre-checked for NULL
3298 jvmtiError
3299 JvmtiEnv::GetFieldModifiers(fieldDescriptor* fdesc_ptr, jint* modifiers_ptr) {
3300 
3301   AccessFlags resultFlags = fdesc_ptr-&gt;access_flags();
3302   jint result = resultFlags.as_int();
3303   *modifiers_ptr = result;
3304 
3305   return JVMTI_ERROR_NONE;
3306 } /* end GetFieldModifiers */
3307 
3308 
3309 // is_synthetic_ptr - pre-checked for NULL
3310 jvmtiError
3311 JvmtiEnv::IsFieldSynthetic(fieldDescriptor* fdesc_ptr, jboolean* is_synthetic_ptr) {
3312   *is_synthetic_ptr = fdesc_ptr-&gt;is_synthetic();
3313   return JVMTI_ERROR_NONE;
3314 } /* end IsFieldSynthetic */
3315 
3316 
3317   //
3318   // Method functions
3319   //
3320 
3321 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3322 // name_ptr - NULL is a valid value, must be checked
3323 // signature_ptr - NULL is a valid value, must be checked
3324 // generic_ptr - NULL is a valid value, must be checked
3325 jvmtiError
3326 JvmtiEnv::GetMethodName(Method* method_oop, char** name_ptr, char** signature_ptr, char** generic_ptr) {
3327   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3328   JavaThread* current_thread  = JavaThread::current();
3329 
3330   ResourceMark rm(current_thread); // get the utf8 name and signature
3331   if (name_ptr == NULL) {
3332     // just don&#39;t return the name
3333   } else {
3334     const char* utf8_name = (const char *) method_oop-&gt;name()-&gt;as_utf8();
3335     *name_ptr = (char *) jvmtiMalloc(strlen(utf8_name)+1);
3336     strcpy(*name_ptr, utf8_name);
3337   }
3338   if (signature_ptr == NULL) {
3339     // just don&#39;t return the signature
3340   } else {
3341     const char* utf8_signature = (const char *) method_oop-&gt;signature()-&gt;as_utf8();
3342     *signature_ptr = (char *) jvmtiMalloc(strlen(utf8_signature) + 1);
3343     strcpy(*signature_ptr, utf8_signature);
3344   }
3345 
3346   if (generic_ptr != NULL) {
3347     *generic_ptr = NULL;
3348     Symbol* soop = method_oop-&gt;generic_signature();
3349     if (soop != NULL) {
3350       const char* gen_sig = soop-&gt;as_C_string();
3351       if (gen_sig != NULL) {
3352         jvmtiError err = allocate(strlen(gen_sig) + 1, (unsigned char **)generic_ptr);
3353         if (err != JVMTI_ERROR_NONE) {
3354           return err;
3355         }
3356         strcpy(*generic_ptr, gen_sig);
3357       }
3358     }
3359   }
3360   return JVMTI_ERROR_NONE;
3361 } /* end GetMethodName */
3362 
3363 
3364 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3365 // declaring_class_ptr - pre-checked for NULL
3366 jvmtiError
3367 JvmtiEnv::GetMethodDeclaringClass(Method* method_oop, jclass* declaring_class_ptr) {
3368   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3369   (*declaring_class_ptr) = get_jni_class_non_null(method_oop-&gt;method_holder());
3370   return JVMTI_ERROR_NONE;
3371 } /* end GetMethodDeclaringClass */
3372 
3373 
3374 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3375 // modifiers_ptr - pre-checked for NULL
3376 jvmtiError
3377 JvmtiEnv::GetMethodModifiers(Method* method_oop, jint* modifiers_ptr) {
3378   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3379   (*modifiers_ptr) = method_oop-&gt;access_flags().as_int() &amp; JVM_RECOGNIZED_METHOD_MODIFIERS;
3380   return JVMTI_ERROR_NONE;
3381 } /* end GetMethodModifiers */
3382 
3383 
3384 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3385 // max_ptr - pre-checked for NULL
3386 jvmtiError
3387 JvmtiEnv::GetMaxLocals(Method* method_oop, jint* max_ptr) {
3388   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3389   // get max stack
3390   (*max_ptr) = method_oop-&gt;max_locals();
3391   return JVMTI_ERROR_NONE;
3392 } /* end GetMaxLocals */
3393 
3394 
3395 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3396 // size_ptr - pre-checked for NULL
3397 jvmtiError
3398 JvmtiEnv::GetArgumentsSize(Method* method_oop, jint* size_ptr) {
3399   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3400   // get size of arguments
3401 
3402   (*size_ptr) = method_oop-&gt;size_of_parameters();
3403   return JVMTI_ERROR_NONE;
3404 } /* end GetArgumentsSize */
3405 
3406 
3407 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3408 // entry_count_ptr - pre-checked for NULL
3409 // table_ptr - pre-checked for NULL
3410 jvmtiError
3411 JvmtiEnv::GetLineNumberTable(Method* method_oop, jint* entry_count_ptr, jvmtiLineNumberEntry** table_ptr) {
3412   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3413   if (!method_oop-&gt;has_linenumber_table()) {
3414     return (JVMTI_ERROR_ABSENT_INFORMATION);
3415   }
3416 
3417   // The line number table is compressed so we don&#39;t know how big it is until decompressed.
3418   // Decompression is really fast so we just do it twice.
3419 
3420   // Compute size of table
3421   jint num_entries = 0;
3422   CompressedLineNumberReadStream stream(method_oop-&gt;compressed_linenumber_table());
3423   while (stream.read_pair()) {
3424     num_entries++;
3425   }
3426   jvmtiLineNumberEntry *jvmti_table =
3427             (jvmtiLineNumberEntry *)jvmtiMalloc(num_entries * (sizeof(jvmtiLineNumberEntry)));
3428 
3429   // Fill jvmti table
3430   if (num_entries &gt; 0) {
3431     int index = 0;
3432     CompressedLineNumberReadStream stream(method_oop-&gt;compressed_linenumber_table());
3433     while (stream.read_pair()) {
3434       jvmti_table[index].start_location = (jlocation) stream.bci();
3435       jvmti_table[index].line_number = (jint) stream.line();
3436       index++;
3437     }
3438     assert(index == num_entries, &quot;sanity check&quot;);
3439   }
3440 
3441   // Set up results
3442   (*entry_count_ptr) = num_entries;
3443   (*table_ptr) = jvmti_table;
3444 
3445   return JVMTI_ERROR_NONE;
3446 } /* end GetLineNumberTable */
3447 
3448 
3449 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3450 // start_location_ptr - pre-checked for NULL
3451 // end_location_ptr - pre-checked for NULL
3452 jvmtiError
3453 JvmtiEnv::GetMethodLocation(Method* method_oop, jlocation* start_location_ptr, jlocation* end_location_ptr) {
3454 
3455   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3456   // get start and end location
3457   (*end_location_ptr) = (jlocation) (method_oop-&gt;code_size() - 1);
3458   if (method_oop-&gt;code_size() == 0) {
3459     // there is no code so there is no start location
3460     (*start_location_ptr) = (jlocation)(-1);
3461   } else {
3462     (*start_location_ptr) = (jlocation)(0);
3463   }
3464 
3465   return JVMTI_ERROR_NONE;
3466 } /* end GetMethodLocation */
3467 
3468 
3469 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3470 // entry_count_ptr - pre-checked for NULL
3471 // table_ptr - pre-checked for NULL
3472 jvmtiError
3473 JvmtiEnv::GetLocalVariableTable(Method* method_oop, jint* entry_count_ptr, jvmtiLocalVariableEntry** table_ptr) {
3474 
3475   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3476   JavaThread* current_thread  = JavaThread::current();
3477 
3478   // does the klass have any local variable information?
3479   InstanceKlass* ik = method_oop-&gt;method_holder();
3480   if (!ik-&gt;access_flags().has_localvariable_table()) {
3481     return (JVMTI_ERROR_ABSENT_INFORMATION);
3482   }
3483 
3484   ConstantPool* constants = method_oop-&gt;constants();
3485   NULL_CHECK(constants, JVMTI_ERROR_ABSENT_INFORMATION);
3486 
3487   // in the vm localvariable table representation, 6 consecutive elements in the table
3488   // represent a 6-tuple of shorts
3489   // [start_pc, length, name_index, descriptor_index, signature_index, index]
3490   jint num_entries = method_oop-&gt;localvariable_table_length();
3491   jvmtiLocalVariableEntry *jvmti_table = (jvmtiLocalVariableEntry *)
3492                 jvmtiMalloc(num_entries * (sizeof(jvmtiLocalVariableEntry)));
3493 
3494   if (num_entries &gt; 0) {
3495     LocalVariableTableElement* table = method_oop-&gt;localvariable_table_start();
3496     for (int i = 0; i &lt; num_entries; i++) {
3497       // get the 5 tuple information from the vm table
3498       jlocation start_location = (jlocation) table[i].start_bci;
3499       jint length = (jint) table[i].length;
3500       int name_index = (int) table[i].name_cp_index;
3501       int signature_index = (int) table[i].descriptor_cp_index;
3502       int generic_signature_index = (int) table[i].signature_cp_index;
3503       jint slot = (jint) table[i].slot;
3504 
3505       // get utf8 name and signature
3506       char *name_buf = NULL;
3507       char *sig_buf = NULL;
3508       char *gen_sig_buf = NULL;
3509       {
3510         ResourceMark rm(current_thread);
3511 
3512         const char *utf8_name = (const char *) constants-&gt;symbol_at(name_index)-&gt;as_utf8();
3513         name_buf = (char *) jvmtiMalloc(strlen(utf8_name)+1);
3514         strcpy(name_buf, utf8_name);
3515 
3516         const char *utf8_signature = (const char *) constants-&gt;symbol_at(signature_index)-&gt;as_utf8();
3517         sig_buf = (char *) jvmtiMalloc(strlen(utf8_signature)+1);
3518         strcpy(sig_buf, utf8_signature);
3519 
3520         if (generic_signature_index &gt; 0) {
3521           const char *utf8_gen_sign = (const char *)
3522                                        constants-&gt;symbol_at(generic_signature_index)-&gt;as_utf8();
3523           gen_sig_buf = (char *) jvmtiMalloc(strlen(utf8_gen_sign)+1);
3524           strcpy(gen_sig_buf, utf8_gen_sign);
3525         }
3526       }
3527 
3528       // fill in the jvmti local variable table
3529       jvmti_table[i].start_location = start_location;
3530       jvmti_table[i].length = length;
3531       jvmti_table[i].name = name_buf;
3532       jvmti_table[i].signature = sig_buf;
3533       jvmti_table[i].generic_signature = gen_sig_buf;
3534       jvmti_table[i].slot = slot;
3535     }
3536   }
3537 
3538   // set results
3539   (*entry_count_ptr) = num_entries;
3540   (*table_ptr) = jvmti_table;
3541 
3542   return JVMTI_ERROR_NONE;
3543 } /* end GetLocalVariableTable */
3544 
3545 
3546 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3547 // bytecode_count_ptr - pre-checked for NULL
3548 // bytecodes_ptr - pre-checked for NULL
3549 jvmtiError
3550 JvmtiEnv::GetBytecodes(Method* method_oop, jint* bytecode_count_ptr, unsigned char** bytecodes_ptr) {
3551   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3552 
3553   HandleMark hm;
3554   methodHandle method(Thread::current(), method_oop);
3555   jint size = (jint)method-&gt;code_size();
3556   jvmtiError err = allocate(size, bytecodes_ptr);
3557   if (err != JVMTI_ERROR_NONE) {
3558     return err;
3559   }
3560 
3561   (*bytecode_count_ptr) = size;
3562   // get byte codes
3563   JvmtiClassFileReconstituter::copy_bytecodes(method, *bytecodes_ptr);
3564 
3565   return JVMTI_ERROR_NONE;
3566 } /* end GetBytecodes */
3567 
3568 
3569 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3570 // is_native_ptr - pre-checked for NULL
3571 jvmtiError
3572 JvmtiEnv::IsMethodNative(Method* method_oop, jboolean* is_native_ptr) {
3573   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3574   (*is_native_ptr) = method_oop-&gt;is_native();
3575   return JVMTI_ERROR_NONE;
3576 } /* end IsMethodNative */
3577 
3578 
3579 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3580 // is_synthetic_ptr - pre-checked for NULL
3581 jvmtiError
3582 JvmtiEnv::IsMethodSynthetic(Method* method_oop, jboolean* is_synthetic_ptr) {
3583   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3584   (*is_synthetic_ptr) = method_oop-&gt;is_synthetic();
3585   return JVMTI_ERROR_NONE;
3586 } /* end IsMethodSynthetic */
3587 
3588 
3589 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3590 // is_obsolete_ptr - pre-checked for NULL
3591 jvmtiError
3592 JvmtiEnv::IsMethodObsolete(Method* method_oop, jboolean* is_obsolete_ptr) {
3593   if (use_version_1_0_semantics() &amp;&amp;
3594       get_capabilities()-&gt;can_redefine_classes == 0) {
3595     // This JvmtiEnv requested version 1.0 semantics and this function
3596     // requires the can_redefine_classes capability in version 1.0 so
3597     // we need to return an error here.
3598     return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
3599   }
3600 
3601   if (method_oop == NULL || method_oop-&gt;is_obsolete()) {
3602     *is_obsolete_ptr = true;
3603   } else {
3604     *is_obsolete_ptr = false;
3605   }
3606   return JVMTI_ERROR_NONE;
3607 } /* end IsMethodObsolete */
3608 
3609   //
3610   // Raw Monitor functions
3611   //
3612 
3613 // name - pre-checked for NULL
3614 // monitor_ptr - pre-checked for NULL
3615 jvmtiError
3616 JvmtiEnv::CreateRawMonitor(const char* name, jrawMonitorID* monitor_ptr) {
3617   JvmtiRawMonitor* rmonitor = new JvmtiRawMonitor(name);
3618   NULL_CHECK(rmonitor, JVMTI_ERROR_OUT_OF_MEMORY);
3619 
3620   *monitor_ptr = (jrawMonitorID)rmonitor;
3621 
3622   return JVMTI_ERROR_NONE;
3623 } /* end CreateRawMonitor */
3624 
3625 
3626 // rmonitor - pre-checked for validity
3627 jvmtiError
3628 JvmtiEnv::DestroyRawMonitor(JvmtiRawMonitor * rmonitor) {
3629   if (Threads::number_of_threads() == 0) {
3630     // Remove this monitor from pending raw monitors list
3631     // if it has entered in onload or start phase.
3632     JvmtiPendingMonitors::destroy(rmonitor);
3633   } else {
3634     Thread* thread  = Thread::current();
3635     if (rmonitor-&gt;owner() == thread) {
3636       // The caller owns this monitor which we are about to destroy.
3637       // We exit the underlying synchronization object so that the
3638       // &quot;delete monitor&quot; call below can work without an assertion
3639       // failure on systems that don&#39;t like destroying synchronization
3640       // objects that are locked.
3641       int r;
3642       int recursion = rmonitor-&gt;recursions();
3643       for (int i = 0; i &lt;= recursion; i++) {
3644         r = rmonitor-&gt;raw_exit(thread);
3645         assert(r == JvmtiRawMonitor::M_OK, &quot;raw_exit should have worked&quot;);
3646         if (r != JvmtiRawMonitor::M_OK) {  // robustness
3647           return JVMTI_ERROR_INTERNAL;
3648         }
3649       }
3650     }
3651     if (rmonitor-&gt;owner() != NULL) {
3652       // The caller is trying to destroy a monitor that is locked by
3653       // someone else. While this is not forbidden by the JVMTI
3654       // spec, it will cause an assertion failure on systems that don&#39;t
3655       // like destroying synchronization objects that are locked.
3656       // We indicate a problem with the error return (and leak the
3657       // monitor&#39;s memory).
3658       return JVMTI_ERROR_NOT_MONITOR_OWNER;
3659     }
3660   }
3661 
3662   delete rmonitor;
3663 
3664   return JVMTI_ERROR_NONE;
3665 } /* end DestroyRawMonitor */
3666 
3667 
3668 // rmonitor - pre-checked for validity
3669 jvmtiError
3670 JvmtiEnv::RawMonitorEnter(JvmtiRawMonitor * rmonitor) {
3671   if (Threads::number_of_threads() == 0) {
3672     // No JavaThreads exist so JvmtiRawMonitor enter cannot be
3673     // used, add this raw monitor to the pending list.
3674     // The pending monitors will be actually entered when
3675     // the VM is setup.
3676     // See transition_pending_raw_monitors in create_vm()
3677     // in thread.cpp.
3678     JvmtiPendingMonitors::enter(rmonitor);
3679   } else {
3680     Thread* thread = Thread::current();
3681     if (thread-&gt;is_Java_thread()) {
3682       JavaThread* current_thread = (JavaThread*)thread;
3683 
3684       /* Transition to thread_blocked without entering vm state          */
3685       /* This is really evil. Normally you can&#39;t undo _thread_blocked    */
3686       /* transitions like this because it would cause us to miss a       */
3687       /* safepoint but since the thread was already in _thread_in_native */
3688       /* the thread is not leaving a safepoint safe state and it will    */
3689       /* block when it tries to return from native. We can&#39;t safepoint   */
3690       /* block in here because we could deadlock the vmthread. Blech.    */
3691 
3692       JavaThreadState state = current_thread-&gt;thread_state();
3693       assert(state == _thread_in_native, &quot;Must be _thread_in_native&quot;);
3694       // frame should already be walkable since we are in native
3695       assert(!current_thread-&gt;has_last_Java_frame() ||
3696              current_thread-&gt;frame_anchor()-&gt;walkable(), &quot;Must be walkable&quot;);
3697       current_thread-&gt;set_thread_state(_thread_blocked);
3698 
3699       rmonitor-&gt;raw_enter(current_thread);
3700       // restore state, still at a safepoint safe state
3701       current_thread-&gt;set_thread_state(state);
3702     } else {
3703       rmonitor-&gt;raw_enter(thread);
3704     }
3705   }
3706   return JVMTI_ERROR_NONE;
3707 } /* end RawMonitorEnter */
3708 
3709 
3710 // rmonitor - pre-checked for validity
3711 jvmtiError
3712 JvmtiEnv::RawMonitorExit(JvmtiRawMonitor * rmonitor) {
3713   jvmtiError err = JVMTI_ERROR_NONE;
3714 
3715   if (Threads::number_of_threads() == 0) {
3716     // No JavaThreads exist so just remove this monitor from the pending list.
3717     // Bool value from exit is false if rmonitor is not in the list.
3718     if (!JvmtiPendingMonitors::exit(rmonitor)) {
3719       err = JVMTI_ERROR_NOT_MONITOR_OWNER;
3720     }
3721   } else {
3722     Thread* thread = Thread::current();
3723     int r = rmonitor-&gt;raw_exit(thread);
3724     if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3725       err = JVMTI_ERROR_NOT_MONITOR_OWNER;
3726     }
3727   }
3728   return err;
3729 } /* end RawMonitorExit */
3730 
3731 
3732 // rmonitor - pre-checked for validity
3733 jvmtiError
3734 JvmtiEnv::RawMonitorWait(JvmtiRawMonitor * rmonitor, jlong millis) {
3735   Thread* thread = Thread::current();
3736   int r = rmonitor-&gt;raw_wait(millis, thread);
3737 
3738   switch (r) {
3739   case JvmtiRawMonitor::M_INTERRUPTED:
3740     return JVMTI_ERROR_INTERRUPT;
3741   case JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE:
3742     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3743   default:
3744     return JVMTI_ERROR_NONE;
3745   }
3746 } /* end RawMonitorWait */
3747 
3748 
3749 // rmonitor - pre-checked for validity
3750 jvmtiError
3751 JvmtiEnv::RawMonitorNotify(JvmtiRawMonitor * rmonitor) {
3752   Thread* thread = Thread::current();
3753   int r = rmonitor-&gt;raw_notify(thread);
3754 
3755   if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3756     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3757   }
3758   return JVMTI_ERROR_NONE;
3759 } /* end RawMonitorNotify */
3760 
3761 
3762 // rmonitor - pre-checked for validity
3763 jvmtiError
3764 JvmtiEnv::RawMonitorNotifyAll(JvmtiRawMonitor * rmonitor) {
3765   Thread* thread = Thread::current();
3766   int r = rmonitor-&gt;raw_notifyAll(thread);
3767 
3768   if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3769     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3770   }
3771   return JVMTI_ERROR_NONE;
3772 } /* end RawMonitorNotifyAll */
3773 
3774 
3775   //
3776   // JNI Function Interception functions
3777   //
3778 
3779 
3780 // function_table - pre-checked for NULL
3781 jvmtiError
3782 JvmtiEnv::SetJNIFunctionTable(const jniNativeInterface* function_table) {
3783   // Copy jni function table at safepoint.
3784   VM_JNIFunctionTableCopier copier(function_table);
3785   VMThread::execute(&amp;copier);
3786 
3787   return JVMTI_ERROR_NONE;
3788 } /* end SetJNIFunctionTable */
3789 
3790 
3791 // function_table - pre-checked for NULL
3792 jvmtiError
3793 JvmtiEnv::GetJNIFunctionTable(jniNativeInterface** function_table) {
3794   *function_table=(jniNativeInterface*)jvmtiMalloc(sizeof(jniNativeInterface));
3795   if (*function_table == NULL)
3796     return JVMTI_ERROR_OUT_OF_MEMORY;
3797   memcpy(*function_table,(JavaThread::current())-&gt;get_jni_functions(),sizeof(jniNativeInterface));
3798   return JVMTI_ERROR_NONE;
3799 } /* end GetJNIFunctionTable */
3800 
3801 
3802   //
3803   // Event Management functions
3804   //
3805 
3806 jvmtiError
3807 JvmtiEnv::GenerateEvents(jvmtiEvent event_type) {
3808   // can only generate two event types
3809   if (event_type != JVMTI_EVENT_COMPILED_METHOD_LOAD &amp;&amp;
3810       event_type != JVMTI_EVENT_DYNAMIC_CODE_GENERATED) {
3811     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
3812   }
3813 
3814   // for compiled_method_load events we must check that the environment
3815   // has the can_generate_compiled_method_load_events capability.
3816   if (event_type == JVMTI_EVENT_COMPILED_METHOD_LOAD) {
3817     if (get_capabilities()-&gt;can_generate_compiled_method_load_events == 0) {
3818       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
3819     }
3820     return JvmtiCodeBlobEvents::generate_compiled_method_load_events(this);
3821   } else {
3822     return JvmtiCodeBlobEvents::generate_dynamic_code_events(this);
3823   }
3824 
3825 } /* end GenerateEvents */
3826 
3827 
3828   //
3829   // Extension Mechanism functions
3830   //
3831 
3832 // extension_count_ptr - pre-checked for NULL
3833 // extensions - pre-checked for NULL
3834 jvmtiError
3835 JvmtiEnv::GetExtensionFunctions(jint* extension_count_ptr, jvmtiExtensionFunctionInfo** extensions) {
3836   return JvmtiExtensions::get_functions(this, extension_count_ptr, extensions);
3837 } /* end GetExtensionFunctions */
3838 
3839 
3840 // extension_count_ptr - pre-checked for NULL
3841 // extensions - pre-checked for NULL
3842 jvmtiError
3843 JvmtiEnv::GetExtensionEvents(jint* extension_count_ptr, jvmtiExtensionEventInfo** extensions) {
3844   return JvmtiExtensions::get_events(this, extension_count_ptr, extensions);
3845 } /* end GetExtensionEvents */
3846 
3847 
3848 // callback - NULL is a valid value, must be checked
3849 jvmtiError
3850 JvmtiEnv::SetExtensionEventCallback(jint extension_event_index, jvmtiExtensionEvent callback) {
3851   return JvmtiExtensions::set_event_callback(this, extension_event_index, callback);
3852 } /* end SetExtensionEventCallback */
3853 
3854   //
3855   // Timers functions
3856   //
3857 
3858 // info_ptr - pre-checked for NULL
3859 jvmtiError
3860 JvmtiEnv::GetCurrentThreadCpuTimerInfo(jvmtiTimerInfo* info_ptr) {
3861   os::current_thread_cpu_time_info(info_ptr);
3862   return JVMTI_ERROR_NONE;
3863 } /* end GetCurrentThreadCpuTimerInfo */
3864 
3865 
3866 // nanos_ptr - pre-checked for NULL
3867 jvmtiError
3868 JvmtiEnv::GetCurrentThreadCpuTime(jlong* nanos_ptr) {
3869   *nanos_ptr = os::current_thread_cpu_time();
3870   return JVMTI_ERROR_NONE;
3871 } /* end GetCurrentThreadCpuTime */
3872 
3873 
3874 // info_ptr - pre-checked for NULL
3875 jvmtiError
3876 JvmtiEnv::GetThreadCpuTimerInfo(jvmtiTimerInfo* info_ptr) {
3877   os::thread_cpu_time_info(info_ptr);
3878   return JVMTI_ERROR_NONE;
3879 } /* end GetThreadCpuTimerInfo */
3880 
3881 
3882 // Threads_lock NOT held, java_thread not protected by lock
3883 // java_thread - pre-checked
3884 // nanos_ptr - pre-checked for NULL
3885 jvmtiError
3886 JvmtiEnv::GetThreadCpuTime(JavaThread* java_thread, jlong* nanos_ptr) {
3887   *nanos_ptr = os::thread_cpu_time(java_thread);
3888   return JVMTI_ERROR_NONE;
3889 } /* end GetThreadCpuTime */
3890 
3891 
3892 // info_ptr - pre-checked for NULL
3893 jvmtiError
3894 JvmtiEnv::GetTimerInfo(jvmtiTimerInfo* info_ptr) {
3895   os::javaTimeNanos_info(info_ptr);
3896   return JVMTI_ERROR_NONE;
3897 } /* end GetTimerInfo */
3898 
3899 
3900 // nanos_ptr - pre-checked for NULL
3901 jvmtiError
3902 JvmtiEnv::GetTime(jlong* nanos_ptr) {
3903   *nanos_ptr = os::javaTimeNanos();
3904   return JVMTI_ERROR_NONE;
3905 } /* end GetTime */
3906 
3907 
3908 // processor_count_ptr - pre-checked for NULL
3909 jvmtiError
3910 JvmtiEnv::GetAvailableProcessors(jint* processor_count_ptr) {
3911   *processor_count_ptr = os::active_processor_count();
3912   return JVMTI_ERROR_NONE;
3913 } /* end GetAvailableProcessors */
3914 
3915 jvmtiError
3916 JvmtiEnv::SetHeapSamplingInterval(jint sampling_interval) {
3917   if (sampling_interval &lt; 0) {
3918     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
3919   }
3920   ThreadHeapSampler::set_sampling_interval(sampling_interval);
3921   return JVMTI_ERROR_NONE;
3922 } /* end SetHeapSamplingInterval */
3923 
3924   //
3925   // System Properties functions
3926   //
3927 
3928 // count_ptr - pre-checked for NULL
3929 // property_ptr - pre-checked for NULL
3930 jvmtiError
3931 JvmtiEnv::GetSystemProperties(jint* count_ptr, char*** property_ptr) {
3932   jvmtiError err = JVMTI_ERROR_NONE;
3933 
3934   // Get the number of readable properties.
3935   *count_ptr = Arguments::PropertyList_readable_count(Arguments::system_properties());
3936 
3937   // Allocate memory to hold the exact number of readable properties.
3938   err = allocate(*count_ptr * sizeof(char *), (unsigned char **)property_ptr);
3939   if (err != JVMTI_ERROR_NONE) {
3940     return err;
3941   }
3942   int readable_count = 0;
3943   // Loop through the system properties until all the readable properties are found.
3944   for (SystemProperty* p = Arguments::system_properties(); p != NULL &amp;&amp; readable_count &lt; *count_ptr; p = p-&gt;next()) {
3945     if (p-&gt;is_readable()) {
3946       const char *key = p-&gt;key();
3947       char **tmp_value = *property_ptr+readable_count;
3948       readable_count++;
3949       err = allocate((strlen(key)+1) * sizeof(char), (unsigned char**)tmp_value);
3950       if (err == JVMTI_ERROR_NONE) {
3951         strcpy(*tmp_value, key);
3952       } else {
3953         // clean up previously allocated memory.
3954         for (int j = 0; j &lt; readable_count; j++) {
3955           Deallocate((unsigned char*)*property_ptr+j);
3956         }
3957         Deallocate((unsigned char*)property_ptr);
3958         break;
3959       }
3960     }
3961   }
3962   assert(err != JVMTI_ERROR_NONE || readable_count == *count_ptr, &quot;Bad readable property count&quot;);
3963   return err;
3964 } /* end GetSystemProperties */
3965 
3966 
3967 // property - pre-checked for NULL
3968 // value_ptr - pre-checked for NULL
3969 jvmtiError
3970 JvmtiEnv::GetSystemProperty(const char* property, char** value_ptr) {
3971   jvmtiError err = JVMTI_ERROR_NONE;
3972   const char *value;
3973 
3974   // Return JVMTI_ERROR_NOT_AVAILABLE if property is not readable or doesn&#39;t exist.
3975   value = Arguments::PropertyList_get_readable_value(Arguments::system_properties(), property);
3976   if (value == NULL) {
3977     err =  JVMTI_ERROR_NOT_AVAILABLE;
3978   } else {
3979     err = allocate((strlen(value)+1) * sizeof(char), (unsigned char **)value_ptr);
3980     if (err == JVMTI_ERROR_NONE) {
3981       strcpy(*value_ptr, value);
3982     }
3983   }
3984   return err;
3985 } /* end GetSystemProperty */
3986 
3987 
3988 // property - pre-checked for NULL
3989 // value - NULL is a valid value, must be checked
3990 jvmtiError
3991 JvmtiEnv::SetSystemProperty(const char* property, const char* value_ptr) {
3992   jvmtiError err =JVMTI_ERROR_NOT_AVAILABLE;
3993 
3994   for (SystemProperty* p = Arguments::system_properties(); p != NULL; p = p-&gt;next()) {
3995     if (strcmp(property, p-&gt;key()) == 0) {
3996       if (p-&gt;set_writeable_value(value_ptr)) {
3997         err =  JVMTI_ERROR_NONE;
3998       }
3999     }
4000   }
4001   return err;
4002 } /* end SetSystemProperty */
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>