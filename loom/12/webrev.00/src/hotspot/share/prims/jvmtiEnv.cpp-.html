<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/prims/jvmtiEnv.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderExt.hpp&quot;
  27 #include &quot;classfile/javaClasses.inline.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;classfile/modules.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;classfile/vmSymbols.hpp&quot;
  32 #include &quot;interpreter/bytecodeStream.hpp&quot;
  33 #include &quot;interpreter/interpreter.hpp&quot;
  34 #include &quot;jfr/jfrEvents.hpp&quot;
  35 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  36 #include &quot;logging/log.hpp&quot;
  37 #include &quot;logging/logConfiguration.hpp&quot;
  38 #include &quot;memory/resourceArea.hpp&quot;
  39 #include &quot;memory/universe.hpp&quot;
  40 #include &quot;oops/instanceKlass.hpp&quot;
  41 #include &quot;oops/objArrayOop.inline.hpp&quot;
  42 #include &quot;oops/oop.inline.hpp&quot;
  43 #include &quot;prims/jniCheck.hpp&quot;
  44 #include &quot;prims/jvm_misc.hpp&quot;
  45 #include &quot;prims/jvmtiAgentThread.hpp&quot;
  46 #include &quot;prims/jvmtiClassFileReconstituter.hpp&quot;
  47 #include &quot;prims/jvmtiCodeBlobEvents.hpp&quot;
  48 #include &quot;prims/jvmtiExtensions.hpp&quot;
  49 #include &quot;prims/jvmtiGetLoadedClasses.hpp&quot;
  50 #include &quot;prims/jvmtiImpl.hpp&quot;
  51 #include &quot;prims/jvmtiManageCapabilities.hpp&quot;
  52 #include &quot;prims/jvmtiRawMonitor.hpp&quot;
  53 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  54 #include &quot;prims/jvmtiTagMap.hpp&quot;
  55 #include &quot;prims/jvmtiThreadState.inline.hpp&quot;
  56 #include &quot;prims/jvmtiUtil.hpp&quot;
  57 #include &quot;runtime/arguments.hpp&quot;
  58 #include &quot;runtime/deoptimization.hpp&quot;
  59 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  60 #include &quot;runtime/handles.inline.hpp&quot;
  61 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  62 #include &quot;runtime/javaCalls.hpp&quot;
  63 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  64 #include &quot;runtime/jniHandles.inline.hpp&quot;
  65 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  66 #include &quot;runtime/osThread.hpp&quot;
  67 #include &quot;runtime/reflectionUtils.hpp&quot;
  68 #include &quot;runtime/signature.hpp&quot;
  69 #include &quot;runtime/thread.inline.hpp&quot;
  70 #include &quot;runtime/threadHeapSampler.hpp&quot;
  71 #include &quot;runtime/threadSMR.hpp&quot;
  72 #include &quot;runtime/timerTrace.hpp&quot;
  73 #include &quot;runtime/vframe.inline.hpp&quot;
  74 #include &quot;runtime/vmThread.hpp&quot;
  75 #include &quot;services/threadService.hpp&quot;
  76 #include &quot;utilities/exceptions.hpp&quot;
  77 #include &quot;utilities/preserveException.hpp&quot;
  78 #include &quot;utilities/utf8.hpp&quot;
  79 
  80 
  81 #define FIXLATER 0 // REMOVE this when completed.
  82 
  83  // FIXLATER: hook into JvmtiTrace
  84 #define TraceJVMTICalls false
  85 
  86 JvmtiEnv::JvmtiEnv(jint version) : JvmtiEnvBase(version) {
  87 }
  88 
  89 JvmtiEnv::~JvmtiEnv() {
  90 }
  91 
  92 JvmtiEnv*
  93 JvmtiEnv::create_a_jvmti(jint version) {
  94   return new JvmtiEnv(version);
  95 }
  96 
  97 // VM operation class to copy jni function table at safepoint.
  98 // More than one java threads or jvmti agents may be reading/
  99 // modifying jni function tables. To reduce the risk of bad
 100 // interaction b/w these threads it is copied at safepoint.
 101 class VM_JNIFunctionTableCopier : public VM_Operation {
 102  private:
 103   const struct JNINativeInterface_ *_function_table;
 104  public:
 105   VM_JNIFunctionTableCopier(const struct JNINativeInterface_ *func_tbl) {
 106     _function_table = func_tbl;
 107   };
 108 
 109   VMOp_Type type() const { return VMOp_JNIFunctionTableCopier; }
 110   void doit() {
 111     copy_jni_function_table(_function_table);
 112   };
 113 };
 114 
 115 //
 116 // Do not change the &quot;prefix&quot; marker below, everything above it is copied
 117 // unchanged into the filled stub, everything below is controlled by the
 118 // stub filler (only method bodies are carried forward, and then only for
 119 // functionality still in the spec).
 120 //
 121 // end file prefix
 122 
 123   //
 124   // Memory Management functions
 125   //
 126 
 127 // mem_ptr - pre-checked for NULL
 128 jvmtiError
 129 JvmtiEnv::Allocate(jlong size, unsigned char** mem_ptr) {
 130   return allocate(size, mem_ptr);
 131 } /* end Allocate */
 132 
 133 
 134 // mem - NULL is a valid value, must be checked
 135 jvmtiError
 136 JvmtiEnv::Deallocate(unsigned char* mem) {
 137   return deallocate(mem);
 138 } /* end Deallocate */
 139 
 140 // Threads_lock NOT held, java_thread not protected by lock
 141 // java_thread - pre-checked
 142 // data - NULL is a valid value, must be checked
 143 jvmtiError
 144 JvmtiEnv::SetThreadLocalStorage(JavaThread* java_thread, const void* data) {
 145   JvmtiThreadState* state = java_thread-&gt;jvmti_thread_state();
 146   if (state == NULL) {
 147     if (data == NULL) {
 148       // leaving state unset same as data set to NULL
 149       return JVMTI_ERROR_NONE;
 150     }
 151     // otherwise, create the state
 152     state = JvmtiThreadState::state_for(java_thread);
 153     if (state == NULL) {
 154       return JVMTI_ERROR_THREAD_NOT_ALIVE;
 155     }
 156   }
 157   state-&gt;env_thread_state(this)-&gt;set_agent_thread_local_storage_data((void*)data);
 158   return JVMTI_ERROR_NONE;
 159 } /* end SetThreadLocalStorage */
 160 
 161 
 162 // Threads_lock NOT held
 163 // thread - NOT pre-checked
 164 // data_ptr - pre-checked for NULL
 165 jvmtiError
 166 JvmtiEnv::GetThreadLocalStorage(jthread thread, void** data_ptr) {
 167   JavaThread* current_thread = JavaThread::current();
 168   if (thread == NULL) {
 169     JvmtiThreadState* state = current_thread-&gt;jvmti_thread_state();
 170     *data_ptr = (state == NULL) ? NULL :
 171       state-&gt;env_thread_state(this)-&gt;get_agent_thread_local_storage_data();
 172   } else {
 173     // jvmti_GetThreadLocalStorage is &quot;in native&quot; and doesn&#39;t transition
 174     // the thread to _thread_in_vm. However, when the TLS for a thread
 175     // other than the current thread is required we need to transition
 176     // from native so as to resolve the jthread.
 177 
 178     ThreadInVMfromNative __tiv(current_thread);
 179     VM_ENTRY_BASE(jvmtiError, JvmtiEnv::GetThreadLocalStorage , current_thread)
 180     debug_only(VMNativeEntryWrapper __vew;)
 181 
 182     JavaThread* java_thread = NULL;
 183     ThreadsListHandle tlh(current_thread);
 184     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, NULL);
 185     if (err != JVMTI_ERROR_NONE) {
 186       return err;
 187     }
 188 
 189     JvmtiThreadState* state = java_thread-&gt;jvmti_thread_state();
 190     *data_ptr = (state == NULL) ? NULL :
 191       state-&gt;env_thread_state(this)-&gt;get_agent_thread_local_storage_data();
 192   }
 193   return JVMTI_ERROR_NONE;
 194 } /* end GetThreadLocalStorage */
 195 
 196   //
 197   // Module functions
 198   //
 199 
 200 // module_count_ptr - pre-checked for NULL
 201 // modules_ptr - pre-checked for NULL
 202 jvmtiError
 203 JvmtiEnv::GetAllModules(jint* module_count_ptr, jobject** modules_ptr) {
 204     JvmtiModuleClosure jmc;
 205 
 206     return jmc.get_all_modules(this, module_count_ptr, modules_ptr);
 207 } /* end GetAllModules */
 208 
 209 
 210 // class_loader - NULL is a valid value, must be pre-checked
 211 // package_name - pre-checked for NULL
 212 // module_ptr - pre-checked for NULL
 213 jvmtiError
 214 JvmtiEnv::GetNamedModule(jobject class_loader, const char* package_name, jobject* module_ptr) {
 215   JavaThread* THREAD = JavaThread::current(); // pass to macros
 216   ResourceMark rm(THREAD);
 217 
 218   Handle h_loader (THREAD, JNIHandles::resolve(class_loader));
 219   // Check that loader is a subclass of java.lang.ClassLoader.
 220   if (h_loader.not_null() &amp;&amp; !java_lang_ClassLoader::is_subclass(h_loader-&gt;klass())) {
 221     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 222   }
 223   jobject module = Modules::get_named_module(h_loader, package_name, THREAD);
 224   if (HAS_PENDING_EXCEPTION) {
 225     CLEAR_PENDING_EXCEPTION;
 226     return JVMTI_ERROR_INTERNAL; // unexpected exception
 227   }
 228   *module_ptr = module;
 229   return JVMTI_ERROR_NONE;
 230 } /* end GetNamedModule */
 231 
 232 
 233 // module - pre-checked for NULL
 234 // to_module - pre-checked for NULL
 235 jvmtiError
 236 JvmtiEnv::AddModuleReads(jobject module, jobject to_module) {
 237   JavaThread* THREAD = JavaThread::current();
 238 
 239   // check module
 240   Handle h_module(THREAD, JNIHandles::resolve(module));
 241   if (!java_lang_Module::is_instance(h_module())) {
 242     return JVMTI_ERROR_INVALID_MODULE;
 243   }
 244   // check to_module
 245   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 246   if (!java_lang_Module::is_instance(h_to_module())) {
 247     return JVMTI_ERROR_INVALID_MODULE;
 248   }
 249   return JvmtiExport::add_module_reads(h_module, h_to_module, THREAD);
 250 } /* end AddModuleReads */
 251 
 252 
 253 // module - pre-checked for NULL
 254 // pkg_name - pre-checked for NULL
 255 // to_module - pre-checked for NULL
 256 jvmtiError
 257 JvmtiEnv::AddModuleExports(jobject module, const char* pkg_name, jobject to_module) {
 258   JavaThread* THREAD = JavaThread::current();
 259   Handle h_pkg = java_lang_String::create_from_str(pkg_name, THREAD);
 260 
 261   // check module
 262   Handle h_module(THREAD, JNIHandles::resolve(module));
 263   if (!java_lang_Module::is_instance(h_module())) {
 264     return JVMTI_ERROR_INVALID_MODULE;
 265   }
 266   // check to_module
 267   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 268   if (!java_lang_Module::is_instance(h_to_module())) {
 269     return JVMTI_ERROR_INVALID_MODULE;
 270   }
 271   return JvmtiExport::add_module_exports(h_module, h_pkg, h_to_module, THREAD);
 272 } /* end AddModuleExports */
 273 
 274 
 275 // module - pre-checked for NULL
 276 // pkg_name - pre-checked for NULL
 277 // to_module - pre-checked for NULL
 278 jvmtiError
 279 JvmtiEnv::AddModuleOpens(jobject module, const char* pkg_name, jobject to_module) {
 280   JavaThread* THREAD = JavaThread::current();
 281   Handle h_pkg = java_lang_String::create_from_str(pkg_name, THREAD);
 282 
 283   // check module
 284   Handle h_module(THREAD, JNIHandles::resolve(module));
 285   if (!java_lang_Module::is_instance(h_module())) {
 286     return JVMTI_ERROR_INVALID_MODULE;
 287   }
 288   // check to_module
 289   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 290   if (!java_lang_Module::is_instance(h_to_module())) {
 291     return JVMTI_ERROR_INVALID_MODULE;
 292   }
 293   return JvmtiExport::add_module_opens(h_module, h_pkg, h_to_module, THREAD);
 294 } /* end AddModuleOpens */
 295 
 296 
 297 // module - pre-checked for NULL
 298 // service - pre-checked for NULL
 299 jvmtiError
 300 JvmtiEnv::AddModuleUses(jobject module, jclass service) {
 301   JavaThread* THREAD = JavaThread::current();
 302 
 303   // check module
 304   Handle h_module(THREAD, JNIHandles::resolve(module));
 305   if (!java_lang_Module::is_instance(h_module())) {
 306     return JVMTI_ERROR_INVALID_MODULE;
 307   }
 308   // check service
 309   Handle h_service(THREAD, JNIHandles::resolve_external_guard(service));
 310   if (!java_lang_Class::is_instance(h_service()) ||
 311       java_lang_Class::is_primitive(h_service())) {
 312     return JVMTI_ERROR_INVALID_CLASS;
 313   }
 314   return JvmtiExport::add_module_uses(h_module, h_service, THREAD);
 315 } /* end AddModuleUses */
 316 
 317 
 318 // module - pre-checked for NULL
 319 // service - pre-checked for NULL
 320 // impl_class - pre-checked for NULL
 321 jvmtiError
 322 JvmtiEnv::AddModuleProvides(jobject module, jclass service, jclass impl_class) {
 323   JavaThread* THREAD = JavaThread::current();
 324 
 325   // check module
 326   Handle h_module(THREAD, JNIHandles::resolve(module));
 327   if (!java_lang_Module::is_instance(h_module())) {
 328     return JVMTI_ERROR_INVALID_MODULE;
 329   }
 330   // check service
 331   Handle h_service(THREAD, JNIHandles::resolve_external_guard(service));
 332   if (!java_lang_Class::is_instance(h_service()) ||
 333       java_lang_Class::is_primitive(h_service())) {
 334     return JVMTI_ERROR_INVALID_CLASS;
 335   }
 336   // check impl_class
 337   Handle h_impl_class(THREAD, JNIHandles::resolve_external_guard(impl_class));
 338   if (!java_lang_Class::is_instance(h_impl_class()) ||
 339       java_lang_Class::is_primitive(h_impl_class())) {
 340     return JVMTI_ERROR_INVALID_CLASS;
 341   }
 342   return JvmtiExport::add_module_provides(h_module, h_service, h_impl_class, THREAD);
 343 } /* end AddModuleProvides */
 344 
 345 // module - pre-checked for NULL
 346 // is_modifiable_class_ptr - pre-checked for NULL
 347 jvmtiError
 348 JvmtiEnv::IsModifiableModule(jobject module, jboolean* is_modifiable_module_ptr) {
 349   JavaThread* THREAD = JavaThread::current();
 350 
 351   // check module
 352   Handle h_module(THREAD, JNIHandles::resolve(module));
 353   if (!java_lang_Module::is_instance(h_module())) {
 354     return JVMTI_ERROR_INVALID_MODULE;
 355   }
 356 
 357   *is_modifiable_module_ptr = JNI_TRUE;
 358   return JVMTI_ERROR_NONE;
 359 } /* end IsModifiableModule */
 360 
 361 
 362   //
 363   // Class functions
 364   //
 365 
 366 // class_count_ptr - pre-checked for NULL
 367 // classes_ptr - pre-checked for NULL
 368 jvmtiError
 369 JvmtiEnv::GetLoadedClasses(jint* class_count_ptr, jclass** classes_ptr) {
 370   return JvmtiGetLoadedClasses::getLoadedClasses(this, class_count_ptr, classes_ptr);
 371 } /* end GetLoadedClasses */
 372 
 373 
 374 // initiating_loader - NULL is a valid value, must be checked
 375 // class_count_ptr - pre-checked for NULL
 376 // classes_ptr - pre-checked for NULL
 377 jvmtiError
 378 JvmtiEnv::GetClassLoaderClasses(jobject initiating_loader, jint* class_count_ptr, jclass** classes_ptr) {
 379   return JvmtiGetLoadedClasses::getClassLoaderClasses(this, initiating_loader,
 380                                                   class_count_ptr, classes_ptr);
 381 } /* end GetClassLoaderClasses */
 382 
 383 // k_mirror - may be primitive, this must be checked
 384 // is_modifiable_class_ptr - pre-checked for NULL
 385 jvmtiError
 386 JvmtiEnv::IsModifiableClass(oop k_mirror, jboolean* is_modifiable_class_ptr) {
 387   *is_modifiable_class_ptr = VM_RedefineClasses::is_modifiable_class(k_mirror)?
 388                                                        JNI_TRUE : JNI_FALSE;
 389   return JVMTI_ERROR_NONE;
 390 } /* end IsModifiableClass */
 391 
 392 // class_count - pre-checked to be greater than or equal to 0
 393 // classes - pre-checked for NULL
 394 jvmtiError
 395 JvmtiEnv::RetransformClasses(jint class_count, const jclass* classes) {
 396 //TODO: add locking
 397 
 398   int index;
 399   JavaThread* current_thread = JavaThread::current();
 400   ResourceMark rm(current_thread);
 401 
 402   jvmtiClassDefinition* class_definitions =
 403                             NEW_RESOURCE_ARRAY(jvmtiClassDefinition, class_count);
 404   NULL_CHECK(class_definitions, JVMTI_ERROR_OUT_OF_MEMORY);
 405 
 406   for (index = 0; index &lt; class_count; index++) {
 407     HandleMark hm(current_thread);
 408 
 409     jclass jcls = classes[index];
 410     oop k_mirror = JNIHandles::resolve_external_guard(jcls);
 411     if (k_mirror == NULL) {
 412       return JVMTI_ERROR_INVALID_CLASS;
 413     }
 414     if (!k_mirror-&gt;is_a(SystemDictionary::Class_klass())) {
 415       return JVMTI_ERROR_INVALID_CLASS;
 416     }
 417 
 418     if (!VM_RedefineClasses::is_modifiable_class(k_mirror)) {
 419       return JVMTI_ERROR_UNMODIFIABLE_CLASS;
 420     }
 421 
 422     Klass* klass = java_lang_Class::as_Klass(k_mirror);
 423 
 424     jint status = klass-&gt;jvmti_class_status();
 425     if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
 426       return JVMTI_ERROR_INVALID_CLASS;
 427     }
 428 
 429     InstanceKlass* ik = InstanceKlass::cast(klass);
 430     if (ik-&gt;get_cached_class_file_bytes() == NULL) {
 431       // Not cached, we need to reconstitute the class file from the
 432       // VM representation. We don&#39;t attach the reconstituted class
 433       // bytes to the InstanceKlass here because they have not been
 434       // validated and we&#39;re not at a safepoint.
 435       JvmtiClassFileReconstituter reconstituter(ik);
 436       if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
 437         return reconstituter.get_error();
 438       }
 439 
 440       class_definitions[index].class_byte_count = (jint)reconstituter.class_file_size();
 441       class_definitions[index].class_bytes      = (unsigned char*)
 442                                                        reconstituter.class_file_bytes();
 443     } else {
 444       // it is cached, get it from the cache
 445       class_definitions[index].class_byte_count = ik-&gt;get_cached_class_file_len();
 446       class_definitions[index].class_bytes      = ik-&gt;get_cached_class_file_bytes();
 447     }
 448     class_definitions[index].klass              = jcls;
 449   }
 450   EventRetransformClasses event;
 451   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_retransform);
 452   VMThread::execute(&amp;op);
 453   jvmtiError error = op.check_error();
 454   if (error == JVMTI_ERROR_NONE) {
 455     event.set_classCount(class_count);
 456     event.set_redefinitionId(op.id());
 457     event.commit();
 458   }
 459   return error;
 460 } /* end RetransformClasses */
 461 
 462 
 463 // class_count - pre-checked to be greater than or equal to 0
 464 // class_definitions - pre-checked for NULL
 465 jvmtiError
 466 JvmtiEnv::RedefineClasses(jint class_count, const jvmtiClassDefinition* class_definitions) {
 467 //TODO: add locking
 468   EventRedefineClasses event;
 469   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_redefine);
 470   VMThread::execute(&amp;op);
 471   jvmtiError error = op.check_error();
 472   if (error == JVMTI_ERROR_NONE) {
 473     event.set_classCount(class_count);
 474     event.set_redefinitionId(op.id());
 475     event.commit();
 476   }
 477   return error;
 478 } /* end RedefineClasses */
 479 
 480 
 481   //
 482   // Object functions
 483   //
 484 
 485 // size_ptr - pre-checked for NULL
 486 jvmtiError
 487 JvmtiEnv::GetObjectSize(jobject object, jlong* size_ptr) {
 488   oop mirror = JNIHandles::resolve_external_guard(object);
 489   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
 490   *size_ptr = (jlong)Universe::heap()-&gt;obj_size(mirror) * wordSize;
 491   return JVMTI_ERROR_NONE;
 492 } /* end GetObjectSize */
 493 
 494   //
 495   // Method functions
 496   //
 497 
 498 // prefix - NULL is a valid value, must be checked
 499 jvmtiError
 500 JvmtiEnv::SetNativeMethodPrefix(const char* prefix) {
 501   return prefix == NULL?
 502               SetNativeMethodPrefixes(0, NULL) :
 503               SetNativeMethodPrefixes(1, (char**)&amp;prefix);
 504 } /* end SetNativeMethodPrefix */
 505 
 506 
 507 // prefix_count - pre-checked to be greater than or equal to 0
 508 // prefixes - pre-checked for NULL
 509 jvmtiError
 510 JvmtiEnv::SetNativeMethodPrefixes(jint prefix_count, char** prefixes) {
 511   // Have to grab JVMTI thread state lock to be sure that some thread
 512   // isn&#39;t accessing the prefixes at the same time we are setting them.
 513   // No locks during VM bring-up.
 514   if (Threads::number_of_threads() == 0) {
 515     return set_native_method_prefixes(prefix_count, prefixes);
 516   } else {
 517     MutexLocker mu(JvmtiThreadState_lock);
 518     return set_native_method_prefixes(prefix_count, prefixes);
 519   }
 520 } /* end SetNativeMethodPrefixes */
 521 
 522   //
 523   // Event Management functions
 524   //
 525 
 526 // callbacks - NULL is a valid value, must be checked
 527 // size_of_callbacks - pre-checked to be greater than or equal to 0
 528 jvmtiError
 529 JvmtiEnv::SetEventCallbacks(const jvmtiEventCallbacks* callbacks, jint size_of_callbacks) {
 530   JvmtiEventController::set_event_callbacks(this, callbacks, size_of_callbacks);
 531   return JVMTI_ERROR_NONE;
 532 } /* end SetEventCallbacks */
 533 
 534 
 535 // event_thread - NULL is a valid value, must be checked
 536 jvmtiError
 537 JvmtiEnv::SetEventNotificationMode(jvmtiEventMode mode, jvmtiEvent event_type, jthread event_thread,   ...) {
 538   if (event_thread == NULL) {
 539     // Can be called at Agent_OnLoad() time with event_thread == NULL
 540     // when Thread::current() does not work yet so we cannot create a
 541     // ThreadsListHandle that is common to both thread-specific and
 542     // global code paths.
 543 
 544     // event_type must be valid
 545     if (!JvmtiEventController::is_valid_event_type(event_type)) {
 546       return JVMTI_ERROR_INVALID_EVENT_TYPE;
 547     }
 548 
 549     bool enabled = (mode == JVMTI_ENABLE);
 550 
 551     // assure that needed capabilities are present
 552     if (enabled &amp;&amp; !JvmtiUtil::has_event_capability(event_type, get_capabilities())) {
 553       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 554     }
 555 
 556     if (event_type == JVMTI_EVENT_CLASS_FILE_LOAD_HOOK &amp;&amp; enabled) {
 557       record_class_file_load_hook_enabled();
 558     }
 559 
 560     JvmtiEventController::set_user_enabled(this, (JavaThread*) NULL, event_type, enabled);
 561   } else {
 562     // We have a specified event_thread.
 563     JavaThread* java_thread = NULL;
 564     ThreadsListHandle tlh;
 565     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), event_thread, &amp;java_thread, NULL);
 566     if (err != JVMTI_ERROR_NONE) {
 567       return err;
 568     }
 569 
 570     // event_type must be valid
 571     if (!JvmtiEventController::is_valid_event_type(event_type)) {
 572       return JVMTI_ERROR_INVALID_EVENT_TYPE;
 573     }
 574 
 575     // global events cannot be controlled at thread level.
 576     if (JvmtiEventController::is_global_event(event_type)) {
 577       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 578     }
 579 
 580     bool enabled = (mode == JVMTI_ENABLE);
 581 
 582     // assure that needed capabilities are present
 583     if (enabled &amp;&amp; !JvmtiUtil::has_event_capability(event_type, get_capabilities())) {
 584       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 585     }
 586 
 587     if (event_type == JVMTI_EVENT_CLASS_FILE_LOAD_HOOK &amp;&amp; enabled) {
 588       record_class_file_load_hook_enabled();
 589     }
 590     JvmtiEventController::set_user_enabled(this, java_thread, event_type, enabled);
 591   }
 592 
 593   return JVMTI_ERROR_NONE;
 594 } /* end SetEventNotificationMode */
 595 
 596   //
 597   // Capability functions
 598   //
 599 
 600 // capabilities_ptr - pre-checked for NULL
 601 jvmtiError
 602 JvmtiEnv::GetPotentialCapabilities(jvmtiCapabilities* capabilities_ptr) {
 603   JvmtiManageCapabilities::get_potential_capabilities(get_capabilities(),
 604                                                       get_prohibited_capabilities(),
 605                                                       capabilities_ptr);
 606   return JVMTI_ERROR_NONE;
 607 } /* end GetPotentialCapabilities */
 608 
 609 
 610 // capabilities_ptr - pre-checked for NULL
 611 jvmtiError
 612 JvmtiEnv::AddCapabilities(const jvmtiCapabilities* capabilities_ptr) {
 613   return JvmtiManageCapabilities::add_capabilities(get_capabilities(),
 614                                                    get_prohibited_capabilities(),
 615                                                    capabilities_ptr,
 616                                                    get_capabilities());
 617 } /* end AddCapabilities */
 618 
 619 
 620 // capabilities_ptr - pre-checked for NULL
 621 jvmtiError
 622 JvmtiEnv::RelinquishCapabilities(const jvmtiCapabilities* capabilities_ptr) {
 623   JvmtiManageCapabilities::relinquish_capabilities(get_capabilities(), capabilities_ptr, get_capabilities());
 624   return JVMTI_ERROR_NONE;
 625 } /* end RelinquishCapabilities */
 626 
 627 
 628 // capabilities_ptr - pre-checked for NULL
 629 jvmtiError
 630 JvmtiEnv::GetCapabilities(jvmtiCapabilities* capabilities_ptr) {
 631   JvmtiManageCapabilities::copy_capabilities(get_capabilities(), capabilities_ptr);
 632   return JVMTI_ERROR_NONE;
 633 } /* end GetCapabilities */
 634 
 635   //
 636   // Class Loader Search functions
 637   //
 638 
 639 // segment - pre-checked for NULL
 640 jvmtiError
 641 JvmtiEnv::AddToBootstrapClassLoaderSearch(const char* segment) {
 642   jvmtiPhase phase = get_phase();
 643   if (phase == JVMTI_PHASE_ONLOAD) {
 644     Arguments::append_sysclasspath(segment);
 645     return JVMTI_ERROR_NONE;
 646   } else if (use_version_1_0_semantics()) {
 647     // This JvmtiEnv requested version 1.0 semantics and this function
 648     // is only allowed in the ONLOAD phase in version 1.0 so we need to
 649     // return an error here.
 650     return JVMTI_ERROR_WRONG_PHASE;
 651   } else if (phase == JVMTI_PHASE_LIVE) {
 652     // The phase is checked by the wrapper that called this function,
 653     // but this thread could be racing with the thread that is
 654     // terminating the VM so we check one more time.
 655 
 656     // create the zip entry
 657     ClassPathZipEntry* zip_entry = ClassLoader::create_class_path_zip_entry(segment, true);
 658     if (zip_entry == NULL) {
 659       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 660     }
 661 
 662     // lock the loader
 663     Thread* thread = Thread::current();
 664     HandleMark hm;
 665     Handle loader_lock = Handle(thread, SystemDictionary::system_loader_lock());
 666 
 667     ObjectLocker ol(loader_lock, thread);
 668 
 669     // add the jar file to the bootclasspath
 670     log_info(class, load)(&quot;opened: %s&quot;, zip_entry-&gt;name());
 671 #if INCLUDE_CDS
 672     ClassLoaderExt::append_boot_classpath(zip_entry);
 673 #else
 674     ClassLoader::add_to_boot_append_entries(zip_entry);
 675 #endif
 676     return JVMTI_ERROR_NONE;
 677   } else {
 678     return JVMTI_ERROR_WRONG_PHASE;
 679   }
 680 
 681 } /* end AddToBootstrapClassLoaderSearch */
 682 
 683 
 684 // segment - pre-checked for NULL
 685 jvmtiError
 686 JvmtiEnv::AddToSystemClassLoaderSearch(const char* segment) {
 687   jvmtiPhase phase = get_phase();
 688 
 689   if (phase == JVMTI_PHASE_ONLOAD) {
 690     for (SystemProperty* p = Arguments::system_properties(); p != NULL; p = p-&gt;next()) {
 691       if (strcmp(&quot;java.class.path&quot;, p-&gt;key()) == 0) {
 692         p-&gt;append_value(segment);
 693         break;
 694       }
 695     }
 696     return JVMTI_ERROR_NONE;
 697   } else if (phase == JVMTI_PHASE_LIVE) {
 698     // The phase is checked by the wrapper that called this function,
 699     // but this thread could be racing with the thread that is
 700     // terminating the VM so we check one more time.
 701     HandleMark hm;
 702 
 703     // create the zip entry (which will open the zip file and hence
 704     // check that the segment is indeed a zip file).
 705     ClassPathZipEntry* zip_entry = ClassLoader::create_class_path_zip_entry(segment, false);
 706     if (zip_entry == NULL) {
 707       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 708     }
 709     delete zip_entry;   // no longer needed
 710 
 711     // lock the loader
 712     Thread* THREAD = Thread::current();
 713     Handle loader = Handle(THREAD, SystemDictionary::java_system_loader());
 714 
 715     ObjectLocker ol(loader, THREAD);
 716 
 717     // need the path as java.lang.String
 718     Handle path = java_lang_String::create_from_platform_dependent_str(segment, THREAD);
 719     if (HAS_PENDING_EXCEPTION) {
 720       CLEAR_PENDING_EXCEPTION;
 721       return JVMTI_ERROR_INTERNAL;
 722     }
 723 
 724     // Invoke the appendToClassPathForInstrumentation method - if the method
 725     // is not found it means the loader doesn&#39;t support adding to the class path
 726     // in the live phase.
 727     {
 728       JavaValue res(T_VOID);
 729       JavaCalls::call_special(&amp;res,
 730                               loader,
 731                               loader-&gt;klass(),
 732                               vmSymbols::appendToClassPathForInstrumentation_name(),
 733                               vmSymbols::appendToClassPathForInstrumentation_signature(),
 734                               path,
 735                               THREAD);
 736       if (HAS_PENDING_EXCEPTION) {
 737         Symbol* ex_name = PENDING_EXCEPTION-&gt;klass()-&gt;name();
 738         CLEAR_PENDING_EXCEPTION;
 739 
 740         if (ex_name == vmSymbols::java_lang_NoSuchMethodError()) {
 741           return JVMTI_ERROR_CLASS_LOADER_UNSUPPORTED;
 742         } else {
 743           return JVMTI_ERROR_INTERNAL;
 744         }
 745       }
 746     }
 747 
 748     return JVMTI_ERROR_NONE;
 749   } else {
 750     return JVMTI_ERROR_WRONG_PHASE;
 751   }
 752 } /* end AddToSystemClassLoaderSearch */
 753 
 754   //
 755   // General functions
 756   //
 757 
 758 // phase_ptr - pre-checked for NULL
 759 jvmtiError
 760 JvmtiEnv::GetPhase(jvmtiPhase* phase_ptr) {
 761   *phase_ptr = phase();
 762   return JVMTI_ERROR_NONE;
 763 } /* end GetPhase */
 764 
 765 
 766 jvmtiError
 767 JvmtiEnv::DisposeEnvironment() {
 768   dispose();
 769   return JVMTI_ERROR_NONE;
 770 } /* end DisposeEnvironment */
 771 
 772 
 773 // data - NULL is a valid value, must be checked
 774 jvmtiError
 775 JvmtiEnv::SetEnvironmentLocalStorage(const void* data) {
 776   set_env_local_storage(data);
 777   return JVMTI_ERROR_NONE;
 778 } /* end SetEnvironmentLocalStorage */
 779 
 780 
 781 // data_ptr - pre-checked for NULL
 782 jvmtiError
 783 JvmtiEnv::GetEnvironmentLocalStorage(void** data_ptr) {
 784   *data_ptr = (void*)get_env_local_storage();
 785   return JVMTI_ERROR_NONE;
 786 } /* end GetEnvironmentLocalStorage */
 787 
 788 // version_ptr - pre-checked for NULL
 789 jvmtiError
 790 JvmtiEnv::GetVersionNumber(jint* version_ptr) {
 791   *version_ptr = JVMTI_VERSION;
 792   return JVMTI_ERROR_NONE;
 793 } /* end GetVersionNumber */
 794 
 795 
 796 // name_ptr - pre-checked for NULL
 797 jvmtiError
 798 JvmtiEnv::GetErrorName(jvmtiError error, char** name_ptr) {
 799   if (error &lt; JVMTI_ERROR_NONE || error &gt; JVMTI_ERROR_MAX) {
 800     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 801   }
 802   const char *name = JvmtiUtil::error_name(error);
 803   if (name == NULL) {
 804     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 805   }
 806   size_t len = strlen(name) + 1;
 807   jvmtiError err = allocate(len, (unsigned char**)name_ptr);
 808   if (err == JVMTI_ERROR_NONE) {
 809     memcpy(*name_ptr, name, len);
 810   }
 811   return err;
 812 } /* end GetErrorName */
 813 
 814 
 815 jvmtiError
 816 JvmtiEnv::SetVerboseFlag(jvmtiVerboseFlag flag, jboolean value) {
 817   LogLevelType level = value == 0 ? LogLevel::Off : LogLevel::Info;
 818   switch (flag) {
 819   case JVMTI_VERBOSE_OTHER:
 820     // ignore
 821     break;
 822   case JVMTI_VERBOSE_CLASS:
 823     LogConfiguration::configure_stdout(level, false, LOG_TAGS(class, unload));
 824     LogConfiguration::configure_stdout(level, false, LOG_TAGS(class, load));
 825     break;
 826   case JVMTI_VERBOSE_GC:
 827     LogConfiguration::configure_stdout(level, true, LOG_TAGS(gc));
 828     break;
 829   case JVMTI_VERBOSE_JNI:
 830     level = value == 0 ? LogLevel::Off : LogLevel::Debug;
 831     LogConfiguration::configure_stdout(level, true, LOG_TAGS(jni, resolve));
 832     break;
 833   default:
 834     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 835   };
 836   return JVMTI_ERROR_NONE;
 837 } /* end SetVerboseFlag */
 838 
 839 
 840 // format_ptr - pre-checked for NULL
 841 jvmtiError
 842 JvmtiEnv::GetJLocationFormat(jvmtiJlocationFormat* format_ptr) {
 843   *format_ptr = JVMTI_JLOCATION_JVMBCI;
 844   return JVMTI_ERROR_NONE;
 845 } /* end GetJLocationFormat */
 846 
 847   //
 848   // Functions supporting virtual threads
 849   //
 850 
 851 // object - pre-checked for NULL
 852 // is_vthread_ptr - pre-checked for NULL
 853 jvmtiError
 854 JvmtiEnv::IsVirtualThread(jthread thread, jboolean* is_vthread_ptr) {
 855   oop thread_obj = JNIHandles::resolve_external_guard(thread);
 856 
 857   *is_vthread_ptr = java_lang_VirtualThread::is_instance(thread_obj);
 858   return JVMTI_ERROR_NONE;
 859 } /* end IsVirtualThread */
 860 
 861 
 862 // java_thread - pre-checked
 863 // vthread_ptr - pre-checked for NULL
 864 jvmtiError
 865 JvmtiEnv::GetVirtualThread(JavaThread* java_thread, jthread* vthread_ptr) {
 866   JavaThread* current_thread  = JavaThread::current();
 867   ResourceMark rm(current_thread);
 868   oop vthread_oop = NULL;
 869   uint32_t debug_bits = 0;
 870 
 871   JvmtiThreadState *state = JvmtiThreadState::state_for(java_thread);
 872   if (state == NULL) {
 873     return JVMTI_ERROR_THREAD_NOT_ALIVE;
 874   }
 875   if (!java_thread-&gt;is_thread_fully_suspended(true, &amp;debug_bits)) {
 876     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
 877   }
 878   vthread_oop = java_lang_Thread::vthread(java_thread-&gt;threadObj());
 879   *vthread_ptr = (jthread)JNIHandles::make_local(current_thread, vthread_oop);
 880   return JVMTI_ERROR_NONE;
 881 } /* end GetVirtualThread */
 882 
 883 // thread_ptr - pre-checked for NULL
 884 jvmtiError
 885 JvmtiEnv::GetCarrierThread(jthread vthread, jthread* thread_ptr) {
 886   JavaThread* current_thread  = JavaThread::current();
 887   HandleMark hm(current_thread);
 888   oop vthread_obj = JNIHandles::resolve_external_guard(vthread);
 889 
 890   if (!java_lang_VirtualThread::is_instance(vthread_obj)) {
 891     return JVMTI_ERROR_INVALID_THREAD;
 892   }
 893 
 894   VM_VirtualThreadGetThread op(current_thread, Handle(current_thread, vthread_obj), thread_ptr);
 895   VMThread::execute(&amp;op);
 896 
 897   return op.result();
 898 } /* end GetCarrierThread */
 899 
 900   //
 901   // Thread functions
 902   //
 903 
 904 // Threads_lock NOT held
 905 // thread - NOT pre-checked
 906 // thread_state_ptr - pre-checked for NULL
 907 jvmtiError
 908 JvmtiEnv::GetThreadState(jthread thread, jint* thread_state_ptr) {
 909   JavaThread* current_thread = JavaThread::current();
 910   JavaThread* java_thread = NULL;
 911   oop thread_oop = NULL;
 912   ThreadsListHandle tlh(current_thread);
 913 
 914   if (thread == NULL) {
 915     java_thread = current_thread;
 916     thread_oop = java_thread-&gt;threadObj();
 917 
 918     if (thread_oop == NULL || !thread_oop-&gt;is_a(SystemDictionary::Thread_klass())) {
 919       return JVMTI_ERROR_INVALID_THREAD;
 920     }
 921   } else {
 922     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
 923     if (err != JVMTI_ERROR_NONE) {
 924       // We got an error code so we don&#39;t have a JavaThread *, but
 925       // only return an error from here if we didn&#39;t get a valid
 926       // thread_oop.
 927       // In avthread case the cv_external_thread_to_JavaThread is expected to correctly set
 928       // the thread_oop and return JVMTI_ERROR_INVALID_THREAD which we ignore here.
 929       if (thread_oop == NULL) {
 930         return err;
 931       }
 932       // We have a valid thread_oop so we can return some thread state.
 933     }
 934   }
 935 
 936   // Support for virtual thread
 937   if (java_lang_VirtualThread::is_instance(thread_oop)) {
 938     if (!get_capabilities()-&gt;can_support_virtual_threads) {
 939       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 940     }
 941     jshort vthread_state = java_lang_VirtualThread::state(thread_oop);
 942 
 943     if (vthread_state != java_lang_VirtualThread::RUNNING) {
 944       jint state = (jint) java_lang_VirtualThread::map_state_to_thread_status(vthread_state);
 945       if (java_lang_Thread::interrupted(thread_oop)) {
 946         state |= JVMTI_THREAD_STATE_INTERRUPTED;
 947       }
 948       *thread_state_ptr = state;
 949       return JVMTI_ERROR_NONE;
 950     }
 951 
 952     // Need a coordination with carrier thread and state recheck in a VM op.
 953     VM_VirtualThreadGetThreadState op(Handle(current_thread, thread_oop), thread_state_ptr);
 954     VMThread::execute(&amp;op);
 955 
 956     return op.result();
 957   }
 958 
 959   // get most state bits
 960   jint state = (jint)java_lang_Thread::get_thread_status(thread_oop);
 961 
 962   if (java_thread != NULL) {
 963     // We have a JavaThread* so add more state bits.
 964     JavaThreadState jts = java_thread-&gt;thread_state();
 965 
 966     if (java_thread-&gt;is_being_ext_suspended()) {
 967       state |= JVMTI_THREAD_STATE_SUSPENDED;
 968     }
 969     if (jts == _thread_in_native) {
 970       state |= JVMTI_THREAD_STATE_IN_NATIVE;
 971     }
 972     if (java_thread-&gt;is_interrupted(false)) {
 973       state |= JVMTI_THREAD_STATE_INTERRUPTED;
 974     }
 975   }
 976 
 977   *thread_state_ptr = state;
 978   return JVMTI_ERROR_NONE;
 979 } /* end GetThreadState */
 980 
 981 
 982 // thread_ptr - pre-checked for NULL
 983 jvmtiError
 984 JvmtiEnv::GetCurrentThread(jthread* thread_ptr) {
 985   JavaThread* current_thread  = JavaThread::current();
 986   *thread_ptr = (jthread)JNIHandles::make_local(current_thread, current_thread-&gt;threadObj());
 987   return JVMTI_ERROR_NONE;
 988 } /* end GetCurrentThread */
 989 
 990 
 991 // threads_count_ptr - pre-checked for NULL
 992 // threads_ptr - pre-checked for NULL
 993 jvmtiError
 994 JvmtiEnv::GetAllThreads(jint* threads_count_ptr, jthread** threads_ptr) {
 995   int nthreads        = 0;
 996   Handle *thread_objs = NULL;
 997   ResourceMark rm;
 998   HandleMark hm;
 999 
1000   // enumerate threads (including agent threads)
1001   ThreadsListEnumerator tle(Thread::current(), true);
1002   nthreads = tle.num_threads();
1003   *threads_count_ptr = nthreads;
1004 
1005   if (nthreads == 0) {
1006     *threads_ptr = NULL;
1007     return JVMTI_ERROR_NONE;
1008   }
1009 
1010   thread_objs = NEW_RESOURCE_ARRAY(Handle, nthreads);
1011   NULL_CHECK(thread_objs, JVMTI_ERROR_OUT_OF_MEMORY);
1012 
1013   for (int i = 0; i &lt; nthreads; i++) {
1014     thread_objs[i] = Handle(tle.get_threadObj(i));
1015   }
1016 
1017   jthread *jthreads  = new_jthreadArray(nthreads, thread_objs);
1018   NULL_CHECK(jthreads, JVMTI_ERROR_OUT_OF_MEMORY);
1019 
1020   *threads_ptr = jthreads;
1021   return JVMTI_ERROR_NONE;
1022 } /* end GetAllThreads */
1023 
1024 
1025 // Threads_lock NOT held, java_thread not protected by lock
1026 // java_thread - pre-checked
1027 jvmtiError
1028 JvmtiEnv::SuspendThread(JavaThread* java_thread) {
1029   // don&#39;t allow hidden thread suspend request.
1030   if (java_thread-&gt;is_hidden_from_external_view()) {
1031     return (JVMTI_ERROR_NONE);
1032   }
1033 
1034   {
1035     MutexLocker ml(java_thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);
1036     if (java_thread-&gt;is_external_suspend()) {
1037       // don&#39;t allow nested external suspend requests.
1038       return (JVMTI_ERROR_THREAD_SUSPENDED);
1039     }
1040     if (java_thread-&gt;is_exiting()) { // thread is in the process of exiting
1041       return (JVMTI_ERROR_THREAD_NOT_ALIVE);
1042     }
1043     java_thread-&gt;set_external_suspend();
1044   }
1045 
1046   if (!JvmtiSuspendControl::suspend(java_thread)) {
1047     // the thread was in the process of exiting
1048     return (JVMTI_ERROR_THREAD_NOT_ALIVE);
1049   }
1050   return JVMTI_ERROR_NONE;
1051 } /* end SuspendThread */
1052 
1053 
1054 // request_count - pre-checked to be greater than or equal to 0
1055 // request_list - pre-checked for NULL
1056 // results - pre-checked for NULL
1057 jvmtiError
1058 JvmtiEnv::SuspendThreadList(jint request_count, const jthread* request_list, jvmtiError* results) {
1059   int needSafepoint = 0;  // &gt; 0 if we need a safepoint
1060   ThreadsListHandle tlh;
1061   for (int i = 0; i &lt; request_count; i++) {
1062     JavaThread *java_thread = NULL;
1063     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), request_list[i], &amp;java_thread, NULL);
1064     if (err != JVMTI_ERROR_NONE) {
1065       results[i] = err;
1066       continue;
1067     }
1068     // don&#39;t allow hidden thread suspend request.
1069     if (java_thread-&gt;is_hidden_from_external_view()) {
1070       results[i] = JVMTI_ERROR_NONE;  // indicate successful suspend
1071       continue;
1072     }
1073 
1074     {
1075       MutexLocker ml(java_thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);
1076       if (java_thread-&gt;is_external_suspend()) {
1077         // don&#39;t allow nested external suspend requests.
1078         results[i] = JVMTI_ERROR_THREAD_SUSPENDED;
1079         continue;
1080       }
1081       if (java_thread-&gt;is_exiting()) { // thread is in the process of exiting
1082         results[i] = JVMTI_ERROR_THREAD_NOT_ALIVE;
1083         continue;
1084       }
1085       java_thread-&gt;set_external_suspend();
1086     }
1087     if (java_thread-&gt;thread_state() == _thread_in_native) {
1088       // We need to try and suspend native threads here. Threads in
1089       // other states will self-suspend on their next transition.
1090       if (!JvmtiSuspendControl::suspend(java_thread)) {
1091         // The thread was in the process of exiting. Force another
1092         // safepoint to make sure that this thread transitions.
1093         needSafepoint++;
1094         results[i] = JVMTI_ERROR_THREAD_NOT_ALIVE;
1095         continue;
1096       }
1097     } else {
1098       needSafepoint++;
1099     }
1100     results[i] = JVMTI_ERROR_NONE;  // indicate successful suspend
1101   }
1102   if (needSafepoint &gt; 0) {
1103     VM_ThreadsSuspendJVMTI tsj;
1104     VMThread::execute(&amp;tsj);
1105   }
1106   // per-thread suspend results returned via results parameter
1107   return JVMTI_ERROR_NONE;
1108 } /* end SuspendThreadList */
1109 
1110 
1111 // Threads_lock NOT held, java_thread not protected by lock
1112 // java_thread - pre-checked
1113 jvmtiError
1114 JvmtiEnv::ResumeThread(JavaThread* java_thread) {
1115   // don&#39;t allow hidden thread resume request.
1116   if (java_thread-&gt;is_hidden_from_external_view()) {
1117     return JVMTI_ERROR_NONE;
1118   }
1119 
1120   if (!java_thread-&gt;is_being_ext_suspended()) {
1121     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1122   }
1123 
1124   if (!JvmtiSuspendControl::resume(java_thread)) {
1125     return JVMTI_ERROR_INTERNAL;
1126   }
1127   return JVMTI_ERROR_NONE;
1128 } /* end ResumeThread */
1129 
1130 
1131 // request_count - pre-checked to be greater than or equal to 0
1132 // request_list - pre-checked for NULL
1133 // results - pre-checked for NULL
1134 jvmtiError
1135 JvmtiEnv::ResumeThreadList(jint request_count, const jthread* request_list, jvmtiError* results) {
1136   ThreadsListHandle tlh;
1137   for (int i = 0; i &lt; request_count; i++) {
1138     JavaThread* java_thread = NULL;
1139     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), request_list[i], &amp;java_thread, NULL);
1140     if (err != JVMTI_ERROR_NONE) {
1141       results[i] = err;
1142       continue;
1143     }
1144     // don&#39;t allow hidden thread resume request.
1145     if (java_thread-&gt;is_hidden_from_external_view()) {
1146       results[i] = JVMTI_ERROR_NONE;  // indicate successful resume
1147       continue;
1148     }
1149     if (!java_thread-&gt;is_being_ext_suspended()) {
1150       results[i] = JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1151       continue;
1152     }
1153 
1154     if (!JvmtiSuspendControl::resume(java_thread)) {
1155       results[i] = JVMTI_ERROR_INTERNAL;
1156       continue;
1157     }
1158 
1159     results[i] = JVMTI_ERROR_NONE;  // indicate successful resume
1160   }
1161   // per-thread resume results returned via results parameter
1162   return JVMTI_ERROR_NONE;
1163 } /* end ResumeThreadList */
1164 
1165 
1166 // Threads_lock NOT held, java_thread not protected by lock
1167 // java_thread - pre-checked
1168 jvmtiError
1169 JvmtiEnv::StopThread(JavaThread* java_thread, jobject exception) {
1170   oop e = JNIHandles::resolve_external_guard(exception);
1171   NULL_CHECK(e, JVMTI_ERROR_NULL_POINTER);
1172 
1173   JavaThread::send_async_exception(java_thread-&gt;threadObj(), e);
1174 
1175   return JVMTI_ERROR_NONE;
1176 
1177 } /* end StopThread */
1178 
1179 
1180 // Threads_lock NOT held
1181 // thread - NOT pre-checked
1182 jvmtiError
1183 JvmtiEnv::InterruptThread(jthread thread) {
1184   JavaThread* current_thread  = JavaThread::current();
1185   JavaThread* java_thread = NULL;
1186   ThreadsListHandle tlh(current_thread);
1187   jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, NULL);
1188   if (err != JVMTI_ERROR_NONE) {
1189     return err;
1190   }
1191   // Really this should be a Java call to Thread.interrupt to ensure the same
1192   // semantics, however historically this has not been done for some reason.
1193   // So we continue with that (which means we don&#39;t interact with any Java-level
1194   // Interruptible object) but we must set the Java-level interrupted state.
1195   java_lang_Thread::set_interrupted(JNIHandles::resolve(thread), true);
1196   java_thread-&gt;interrupt();
1197 
1198   return JVMTI_ERROR_NONE;
1199 } /* end InterruptThread */
1200 
1201 
1202 // Threads_lock NOT held
1203 // thread - NOT pre-checked
1204 // info_ptr - pre-checked for NULL
1205 jvmtiError
1206 JvmtiEnv::GetThreadInfo(jthread thread, jvmtiThreadInfo* info_ptr) {
1207   ResourceMark rm;
1208   HandleMark hm;
1209 
1210   JavaThread* current_thread = JavaThread::current();
1211   ThreadsListHandle tlh(current_thread);
1212 
1213   // if thread is NULL the current thread is used
1214   oop thread_oop = NULL;
1215   if (thread == NULL) {
1216     thread_oop = current_thread-&gt;threadObj();
1217     if (thread_oop == NULL || !thread_oop-&gt;is_a(SystemDictionary::Thread_klass())) {
1218       return JVMTI_ERROR_INVALID_THREAD;
1219     }
1220   } else {
1221     JavaThread* java_thread = NULL;
1222     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
1223     if (err != JVMTI_ERROR_NONE) {
1224       // We got an error code so we don&#39;t have a JavaThread *, but
1225       // only return an error from here if we didn&#39;t get a valid
1226       // thread_oop.
1227       // In the virtual thread case the cv_external_thread_to_JavaThread is expected to correctly set
1228       // the thread_oop and return JVMTI_ERROR_INVALID_THREAD which we ignore here.
1229       if (thread_oop == NULL) {
1230         return err;
1231       }
1232       // We have a valid thread_oop so we can return some thread info.
1233     }
1234   }
1235 
1236   Handle thread_obj(current_thread, thread_oop);
1237   Handle name;
1238   ThreadPriority priority;
1239   Handle     thread_group;
1240   Handle context_class_loader;
1241   bool          is_daemon;
1242 
1243   name = Handle(current_thread, java_lang_Thread::name(thread_obj()));
1244 
1245   // Support for virtual threads
1246   if (java_lang_VirtualThread::is_instance(thread_obj())) {
1247     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1248       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1249     }
1250     priority = (ThreadPriority)JVMTI_THREAD_NORM_PRIORITY;
1251     is_daemon = true;
1252     thread_group = Handle(current_thread, java_lang_Thread_VirtualThreads::get_THREAD_GROUP());
1253   } else {
1254     priority = java_lang_Thread::priority(thread_obj());
1255     is_daemon = java_lang_Thread::is_daemon(thread_obj());
1256     thread_group = Handle(current_thread, java_lang_Thread::threadGroup(thread_obj()));
1257   }
1258 
1259   oop loader = java_lang_Thread::context_class_loader(thread_obj());
1260   context_class_loader = Handle(current_thread, loader);
1261 
1262   { const char *n;
1263 
1264     if (name() != NULL) {
1265       n = java_lang_String::as_utf8_string(name());
1266     } else {
1267       int utf8_length = 0;
1268       n = UNICODE::as_utf8((jchar*) NULL, utf8_length);
1269     }
1270 
1271     info_ptr-&gt;name = (char *) jvmtiMalloc(strlen(n)+1);
1272     if (info_ptr-&gt;name == NULL)
1273       return JVMTI_ERROR_OUT_OF_MEMORY;
1274 
1275     strcpy(info_ptr-&gt;name, n);
1276   }
1277   info_ptr-&gt;is_daemon = is_daemon;
1278   info_ptr-&gt;priority  = priority;
1279 
1280   info_ptr-&gt;context_class_loader = (context_class_loader.is_null()) ? NULL :
1281                                     jni_reference(context_class_loader);
1282   info_ptr-&gt;thread_group = jni_reference(thread_group);
1283 
1284   return JVMTI_ERROR_NONE;
1285 } /* end GetThreadInfo */
1286 
1287 
1288 // Threads_lock NOT held
1289 // thread - NOT pre-checked
1290 // owned_monitor_count_ptr - pre-checked for NULL
1291 // owned_monitors_ptr - pre-checked for NULL
1292 jvmtiError
1293 JvmtiEnv::GetOwnedMonitorInfo(jthread thread, jint* owned_monitor_count_ptr, jobject** owned_monitors_ptr) {
1294   jvmtiError err = JVMTI_ERROR_NONE;
1295   JavaThread* calling_thread = JavaThread::current();
1296   HandleMark hm(calling_thread);
1297   oop thread_obj = JNIHandles::resolve_external_guard(thread);
1298 
1299   // growable array of jvmti monitors info on the C-heap
1300   GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list =
1301       new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;(1, true);
1302 
1303   // Support for virtual threads
1304   if (java_lang_VirtualThread::is_instance(thread_obj)) {
1305     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1306       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1307     }
1308     VM_VirtualThreadGetOwnedMonitorInfo op(this,
1309                                            calling_thread,
1310                                            Handle(calling_thread, thread_obj),
1311                                            owned_monitors_list);
1312     VMThread::execute(&amp;op);
1313     err = op.result();
1314   } else {
1315     // Support for ordinary threads
1316     JavaThread* java_thread = NULL;
1317     ThreadsListHandle tlh(calling_thread);
1318 
1319     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
1320     if (err != JVMTI_ERROR_NONE) {
1321       delete owned_monitors_list;
1322       return err;
1323     }
1324 
1325     // It is only safe to perform the direct operation on the current
1326     // thread. All other usage needs to use a vm-safepoint-op for safety.
1327     if (java_thread == calling_thread) {
1328       err = get_owned_monitors(calling_thread, java_thread, owned_monitors_list);
1329     } else {
1330       // JVMTI get monitors info at safepoint.
1331       // Do not require target thread to
1332       VM_GetOwnedMonitorInfo op(this, calling_thread, java_thread, owned_monitors_list);
1333       VMThread::execute(&amp;op);
1334       err = op.result();
1335     }
1336   }
1337   jint owned_monitor_count = owned_monitors_list-&gt;length();
1338   if (err == JVMTI_ERROR_NONE) {
1339     if ((err = allocate(owned_monitor_count * sizeof(jobject *),
1340                       (unsigned char**)owned_monitors_ptr)) == JVMTI_ERROR_NONE) {
1341       // copy into the returned array
1342       for (int i = 0; i &lt; owned_monitor_count; i++) {
1343         (*owned_monitors_ptr)[i] =
1344           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;monitor;
1345       }
1346       *owned_monitor_count_ptr = owned_monitor_count;
1347     }
1348   }
1349   // clean up.
1350   for (int i = 0; i &lt; owned_monitor_count; i++) {
1351     deallocate((unsigned char*)owned_monitors_list-&gt;at(i));
1352   }
1353   delete owned_monitors_list;
1354 
1355   return err;
1356 } /* end GetOwnedMonitorInfo */
1357 
1358 
1359 // Threads_lock NOT held
1360 // thread - NOT pre-checked
1361 // monitor_info_count_ptr - pre-checked for NULL
1362 // monitor_info_ptr - pre-checked for NULL
1363 jvmtiError
1364 JvmtiEnv::GetOwnedMonitorStackDepthInfo(jthread thread, jint* monitor_info_count_ptr, jvmtiMonitorStackDepthInfo** monitor_info_ptr) {
1365   jvmtiError err = JVMTI_ERROR_NONE;
1366   JavaThread* calling_thread = JavaThread::current();
1367   HandleMark hm(calling_thread);
1368   oop thread_obj = JNIHandles::resolve_external_guard(thread);
1369 
1370   // growable array of jvmti monitors info on the C-heap
1371   GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list =
1372          new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;(1, true);
1373 
1374   // Support for virtual threads
1375   if (java_lang_VirtualThread::is_instance(thread_obj)) {
1376     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1377       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1378     }
1379     VM_VirtualThreadGetOwnedMonitorInfo op(this,
1380                                    calling_thread,
1381                                    Handle(calling_thread, thread_obj),
1382                                    owned_monitors_list);
1383     VMThread::execute(&amp;op);
1384     err = op.result();
1385   } else {
1386     // Support for ordinary threads
1387     JavaThread* java_thread = NULL;
1388     ThreadsListHandle tlh(calling_thread);
1389 
1390     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
1391     if (err != JVMTI_ERROR_NONE) {
1392       delete owned_monitors_list;
1393       return err;
1394     }
1395 
1396     // It is only safe to perform the direct operation on the current
1397     // thread. All other usage needs to use a vm-safepoint-op for safety.
1398     if (java_thread == calling_thread) {
1399       err = get_owned_monitors(calling_thread, java_thread, owned_monitors_list);
1400     } else {
1401       // JVMTI get owned monitors info at safepoint.
1402       // Do not require target thread to be suspended.
1403       VM_GetOwnedMonitorInfo op(this, calling_thread, java_thread, owned_monitors_list);
1404       VMThread::execute(&amp;op);
1405       err = op.result();
1406     }
1407   }
1408   jint owned_monitor_count = owned_monitors_list-&gt;length();
1409   if (err == JVMTI_ERROR_NONE) {
1410     if ((err = allocate(owned_monitor_count * sizeof(jvmtiMonitorStackDepthInfo),
1411                         (unsigned char**)monitor_info_ptr)) == JVMTI_ERROR_NONE) {
1412       // copy to output array.
1413       for (int i = 0; i &lt; owned_monitor_count; i++) {
1414         (*monitor_info_ptr)[i].monitor =
1415           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;monitor;
1416         (*monitor_info_ptr)[i].stack_depth =
1417           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;stack_depth;
1418       }
1419     }
1420     *monitor_info_count_ptr = owned_monitor_count;
1421   }
1422 
1423   // clean up.
1424   for (int i = 0; i &lt; owned_monitor_count; i++) {
1425     deallocate((unsigned char*)owned_monitors_list-&gt;at(i));
1426   }
1427   delete owned_monitors_list;
1428 
1429   return err;
1430 } /* end GetOwnedMonitorStackDepthInfo */
1431 
1432 
1433 // Threads_lock NOT held
1434 // thread - NOT pre-checked
1435 // monitor_ptr - pre-checked for NULL
1436 jvmtiError
1437 JvmtiEnv::GetCurrentContendedMonitor(jthread thread, jobject* monitor_ptr) {
1438   jvmtiError err = JVMTI_ERROR_NONE;
1439   JavaThread* calling_thread = JavaThread::current();
1440   HandleMark hm(calling_thread);
1441   oop thread_obj = JNIHandles::resolve_external_guard(thread);
1442 
1443   // Support for virtual threads
1444   if (java_lang_VirtualThread::is_instance(thread_obj)) {
1445     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1446       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1447     }
1448     VM_VirtualThreadGetCurrentContendedMonitor op(this, calling_thread,
1449                                           Handle(calling_thread, thread_obj),
1450                                           monitor_ptr);
1451     VMThread::execute(&amp;op);
1452     err = op.result();
1453     return err;
1454   }
1455   // Support for ordinary threads
1456   ThreadsListHandle tlh(calling_thread);
1457   JavaThread* java_thread = NULL;
1458 
1459   err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
1460   if (err != JVMTI_ERROR_NONE) {
1461     return err;
1462   }
1463   // It is only safe to perform the direct operation on the current
1464   // thread. All other usage needs to use a vm-safepoint-op for safety.
1465   if (java_thread == calling_thread) {
1466     err = get_current_contended_monitor(calling_thread, java_thread, monitor_ptr);
1467   } else {
1468     // get contended monitor information at safepoint.
1469     VM_GetCurrentContendedMonitor op(this, calling_thread, java_thread, monitor_ptr);
1470     VMThread::execute(&amp;op);
1471     err = op.result();
1472   }
1473   return err;
1474 } /* end GetCurrentContendedMonitor */
1475 
1476 
1477 // Threads_lock NOT held
1478 // thread - NOT pre-checked
1479 // proc - pre-checked for NULL
1480 // arg - NULL is a valid value, must be checked
1481 jvmtiError
1482 JvmtiEnv::RunAgentThread(jthread thread, jvmtiStartFunction proc, const void* arg, jint priority) {
1483   JavaThread* current_thread = JavaThread::current();
1484 
1485   JavaThread* java_thread = NULL;
1486   oop thread_oop = NULL;
1487   ThreadsListHandle tlh(current_thread);
1488   jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
1489   if (err != JVMTI_ERROR_NONE) {
1490     // We got an error code so we don&#39;t have a JavaThread *, but
1491     // only return an error from here if we didn&#39;t get a valid
1492     // thread_oop.
1493     if (thread_oop == NULL) {
1494       return err;
1495     }
1496     // We have a valid thread_oop.
1497   }
1498 
1499   if (java_thread != NULL) {
1500     // &#39;thread&#39; refers to an existing JavaThread.
1501     return JVMTI_ERROR_INVALID_THREAD;
1502   }
1503 
1504   if (priority &lt; JVMTI_THREAD_MIN_PRIORITY || priority &gt; JVMTI_THREAD_MAX_PRIORITY) {
1505     return JVMTI_ERROR_INVALID_PRIORITY;
1506   }
1507 
1508   Handle thread_hndl(current_thread, thread_oop);
1509   {
1510     MutexLocker mu(current_thread, Threads_lock); // grab Threads_lock
1511 
1512     JvmtiAgentThread *new_thread = new JvmtiAgentThread(this, proc, arg);
1513 
1514     // At this point it may be possible that no osthread was created for the
1515     // JavaThread due to lack of memory.
1516     if (new_thread == NULL || new_thread-&gt;osthread() == NULL) {
1517       if (new_thread != NULL) {
1518         new_thread-&gt;smr_delete();
1519       }
1520       return JVMTI_ERROR_OUT_OF_MEMORY;
1521     }
1522 
1523     java_lang_Thread::set_thread(thread_hndl(), new_thread);
1524     java_lang_Thread::set_priority(thread_hndl(), (ThreadPriority)priority);
1525     java_lang_Thread::set_daemon(thread_hndl());
1526 
1527     new_thread-&gt;set_threadObj(thread_hndl());
1528     Threads::add(new_thread);
1529     Thread::start(new_thread);
1530   } // unlock Threads_lock
1531 
1532   return JVMTI_ERROR_NONE;
1533 } /* end RunAgentThread */
1534 
1535   //
1536   // Thread Group functions
1537   //
1538 
1539 // group_count_ptr - pre-checked for NULL
1540 // groups_ptr - pre-checked for NULL
1541 jvmtiError
1542 JvmtiEnv::GetTopThreadGroups(jint* group_count_ptr, jthreadGroup** groups_ptr) {
1543   JavaThread* current_thread = JavaThread::current();
1544 
1545   // Only one top level thread group now.
1546   *group_count_ptr = 1;
1547 
1548   // Allocate memory to store global-refs to the thread groups.
1549   // Assume this area is freed by caller.
1550   *groups_ptr = (jthreadGroup *) jvmtiMalloc((sizeof(jthreadGroup)) * (*group_count_ptr));
1551 
1552   NULL_CHECK(*groups_ptr, JVMTI_ERROR_OUT_OF_MEMORY);
1553 
1554   // Convert oop to Handle, then convert Handle to global-ref.
1555   {
1556     HandleMark hm(current_thread);
1557     Handle system_thread_group(current_thread, Universe::system_thread_group());
1558     *groups_ptr[0] = jni_reference(system_thread_group);
1559   }
1560 
1561   return JVMTI_ERROR_NONE;
1562 } /* end GetTopThreadGroups */
1563 
1564 
1565 // info_ptr - pre-checked for NULL
1566 jvmtiError
1567 JvmtiEnv::GetThreadGroupInfo(jthreadGroup group, jvmtiThreadGroupInfo* info_ptr) {
1568   ResourceMark rm;
1569   HandleMark hm;
1570 
1571   JavaThread* current_thread = JavaThread::current();
1572 
1573   Handle group_obj (current_thread, JNIHandles::resolve_external_guard(group));
1574   NULL_CHECK(group_obj(), JVMTI_ERROR_INVALID_THREAD_GROUP);
1575 
1576   const char* name;
1577   Handle parent_group;
1578   bool is_daemon;
1579   ThreadPriority max_priority;
1580 
1581   name         = java_lang_ThreadGroup::name(group_obj());
1582   parent_group = Handle(current_thread, java_lang_ThreadGroup::parent(group_obj()));
1583   is_daemon    = java_lang_ThreadGroup::is_daemon(group_obj());
1584   max_priority = java_lang_ThreadGroup::maxPriority(group_obj());
1585 
1586   info_ptr-&gt;is_daemon    = is_daemon;
1587   info_ptr-&gt;max_priority = max_priority;
1588   info_ptr-&gt;parent       = jni_reference(parent_group);
1589 
1590   if (name != NULL) {
1591     info_ptr-&gt;name = (char*)jvmtiMalloc(strlen(name)+1);
1592     NULL_CHECK(info_ptr-&gt;name, JVMTI_ERROR_OUT_OF_MEMORY);
1593     strcpy(info_ptr-&gt;name, name);
1594   } else {
1595     info_ptr-&gt;name = NULL;
1596   }
1597 
1598   return JVMTI_ERROR_NONE;
1599 } /* end GetThreadGroupInfo */
1600 
1601 
1602 // thread_count_ptr - pre-checked for NULL
1603 // threads_ptr - pre-checked for NULL
1604 // group_count_ptr - pre-checked for NULL
1605 // groups_ptr - pre-checked for NULL
1606 jvmtiError
1607 JvmtiEnv::GetThreadGroupChildren(jthreadGroup group, jint* thread_count_ptr, jthread** threads_ptr, jint* group_count_ptr, jthreadGroup** groups_ptr) {
1608   JavaThread* current_thread = JavaThread::current();
1609   oop group_obj = (oop) JNIHandles::resolve_external_guard(group);
1610   NULL_CHECK(group_obj, JVMTI_ERROR_INVALID_THREAD_GROUP);
1611 
1612   Handle *thread_objs = NULL;
1613   Handle *group_objs  = NULL;
1614   int nthreads = 0;
1615   int ngroups = 0;
1616   int hidden_threads = 0;
1617 
1618   ResourceMark rm(current_thread);
1619   HandleMark hm(current_thread);
1620 
1621   Handle group_hdl(current_thread, group_obj);
1622 
1623   { // Cannot allow thread or group counts to change.
1624     ObjectLocker ol(group_hdl, current_thread);
1625 
1626     nthreads = java_lang_ThreadGroup::nthreads(group_hdl());
1627     ngroups  = java_lang_ThreadGroup::ngroups(group_hdl());
1628 
1629     if (nthreads &gt; 0) {
1630       ThreadsListHandle tlh(current_thread);
1631       objArrayOop threads = java_lang_ThreadGroup::threads(group_hdl());
1632       assert(nthreads &lt;= threads-&gt;length(), &quot;too many threads&quot;);
1633       thread_objs = NEW_RESOURCE_ARRAY(Handle,nthreads);
1634       for (int i = 0, j = 0; i &lt; nthreads; i++) {
1635         oop thread_obj = threads-&gt;obj_at(i);
1636         assert(thread_obj != NULL, &quot;thread_obj is NULL&quot;);
1637         JavaThread *java_thread = NULL;
1638         jvmtiError err = JvmtiExport::cv_oop_to_JavaThread(tlh.list(), thread_obj, &amp;java_thread);
1639         if (err == JVMTI_ERROR_NONE) {
1640           // Have a valid JavaThread*.
1641           if (java_thread-&gt;is_hidden_from_external_view()) {
1642             // Filter out hidden java threads.
1643             hidden_threads++;
1644             continue;
1645           }
1646         } else {
1647           // We couldn&#39;t convert thread_obj into a JavaThread*.
1648           if (err == JVMTI_ERROR_INVALID_THREAD) {
1649             // The thread_obj does not refer to a java.lang.Thread object
1650             // so skip it.
1651             hidden_threads++;
1652             continue;
1653           }
1654           // We have a valid thread_obj, but no JavaThread*; the caller
1655           // can still have limited use for the thread_obj.
1656         }
1657         thread_objs[j++] = Handle(current_thread, thread_obj);
1658       }
1659       nthreads -= hidden_threads;
1660     } // ThreadsListHandle is destroyed here.
1661 
1662     if (ngroups &gt; 0) {
1663       objArrayOop groups = java_lang_ThreadGroup::groups(group_hdl());
1664       assert(ngroups &lt;= groups-&gt;length(), &quot;too many groups&quot;);
1665       group_objs = NEW_RESOURCE_ARRAY(Handle,ngroups);
1666       for (int i = 0; i &lt; ngroups; i++) {
1667         oop group_obj = groups-&gt;obj_at(i);
1668         assert(group_obj != NULL, &quot;group_obj != NULL&quot;);
1669         group_objs[i] = Handle(current_thread, group_obj);
1670       }
1671     }
1672   } // ThreadGroup unlocked here
1673 
1674   *group_count_ptr  = ngroups;
1675   *thread_count_ptr = nthreads;
1676   *threads_ptr     = new_jthreadArray(nthreads, thread_objs);
1677   *groups_ptr      = new_jthreadGroupArray(ngroups, group_objs);
1678   if ((nthreads &gt; 0) &amp;&amp; (*threads_ptr == NULL)) {
1679     return JVMTI_ERROR_OUT_OF_MEMORY;
1680   }
1681   if ((ngroups &gt; 0) &amp;&amp; (*groups_ptr == NULL)) {
1682     return JVMTI_ERROR_OUT_OF_MEMORY;
1683   }
1684 
1685   return JVMTI_ERROR_NONE;
1686 } /* end GetThreadGroupChildren */
1687 
1688 
1689   //
1690   // Stack Frame functions
1691   //
1692 
1693 // Threads_lock NOT held
1694 // thread - NOT pre-checked
1695 // max_frame_count - pre-checked to be greater than or equal to 0
1696 // frame_buffer - pre-checked for NULL
1697 // count_ptr - pre-checked for NULL
1698 jvmtiError
1699 JvmtiEnv::GetStackTrace(jthread thread, jint start_depth, jint max_frame_count, jvmtiFrameInfo* frame_buffer, jint* count_ptr) {
1700   jvmtiError err = JVMTI_ERROR_NONE;
1701   JavaThread* java_thread = NULL;
1702   JavaThread* current_thread = JavaThread::current();
1703   HandleMark hm(current_thread);
1704   oop thread_obj = JNIHandles::resolve_external_guard(thread);
1705 
1706   // Support for virtual threads
1707   if (java_lang_VirtualThread::is_instance(thread_obj)) {
1708     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1709       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1710     }
1711     VM_VirtualThreadGetStackTrace op(this, Handle(current_thread, thread_obj),
1712                              start_depth, max_frame_count, frame_buffer, count_ptr);
1713     VMThread::execute(&amp;op);
1714     return op.result();
1715   }
1716 
1717   // Support for ordinary threads
1718   ThreadsListHandle tlh(current_thread);
1719   err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
1720   if (err != JVMTI_ERROR_NONE) {
1721     return err;
1722   }
1723 
1724   // It is only safe to perform the direct operation on the current
1725   // thread. All other usage needs to use a vm-safepoint-op for safety.
1726   if (java_thread == JavaThread::current()) {
1727     err = get_stack_trace(java_thread, start_depth, max_frame_count, frame_buffer, count_ptr);
1728   } else {
1729     // JVMTI get stack trace at safepoint. Do not require target thread to
1730     // be suspended.
1731     VM_GetStackTrace op(this, java_thread, start_depth, max_frame_count, frame_buffer, count_ptr);
1732     VMThread::execute(&amp;op);
1733     err = op.result();
1734   }
1735 
1736   return err;
1737 } /* end GetStackTrace */
1738 
1739 
1740 // max_frame_count - pre-checked to be greater than or equal to 0
1741 // stack_info_ptr - pre-checked for NULL
1742 // thread_count_ptr - pre-checked for NULL
1743 jvmtiError
1744 JvmtiEnv::GetAllStackTraces(jint max_frame_count, jvmtiStackInfo** stack_info_ptr, jint* thread_count_ptr) {
1745   jvmtiError err = JVMTI_ERROR_NONE;
1746   JavaThread* calling_thread = JavaThread::current();
1747 
1748   // JVMTI get stack traces at safepoint.
1749   VM_GetAllStackTraces op(this, calling_thread, max_frame_count);
1750   VMThread::execute(&amp;op);
1751   *thread_count_ptr = op.final_thread_count();
1752   *stack_info_ptr = op.stack_info();
1753   err = op.result();
1754   return err;
1755 } /* end GetAllStackTraces */
1756 
1757 
1758 // thread_count - pre-checked to be greater than or equal to 0
1759 // thread_list - pre-checked for NULL
1760 // max_frame_count - pre-checked to be greater than or equal to 0
1761 // stack_info_ptr - pre-checked for NULL
1762 jvmtiError
1763 JvmtiEnv::GetThreadListStackTraces(jint thread_count, const jthread* thread_list, jint max_frame_count, jvmtiStackInfo** stack_info_ptr) {
1764   jvmtiError err = JVMTI_ERROR_NONE;
1765   // JVMTI get stack traces at safepoint.
1766   VM_GetThreadListStackTraces op(this, thread_count, thread_list, max_frame_count);
1767   VMThread::execute(&amp;op);
1768   err = op.result();
1769   if (err == JVMTI_ERROR_NONE) {
1770     *stack_info_ptr = op.stack_info();
1771   }
1772   return err;
1773 } /* end GetThreadListStackTraces */
1774 
1775 
1776 // Threads_lock NOT held
1777 // thread - NOT pre-checked
1778 // count_ptr - pre-checked for NULL
1779 jvmtiError
1780 JvmtiEnv::GetFrameCount(jthread thread, jint* count_ptr) {
1781   jvmtiError err = JVMTI_ERROR_NONE;
1782   JavaThread* java_thread = NULL;
1783   JavaThread* current_thread = JavaThread::current();
1784   HandleMark hm(current_thread);
1785   oop thread_obj = JNIHandles::resolve_external_guard(thread);
1786 
1787   // Support for virtual threads
1788   if (java_lang_VirtualThread::is_instance(thread_obj)) {
1789     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1790       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1791     }
1792     VM_VirtualThreadGetFrameCount op(this, Handle(current_thread, thread_obj), count_ptr);
1793     VMThread::execute(&amp;op);
1794     return op.result();
1795   }
1796 
1797   // Support for ordinary threads
1798   ThreadsListHandle tlh(current_thread);
1799   err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
1800   if (err != JVMTI_ERROR_NONE) {
1801     return err;
1802   }
1803 
1804   // retrieve or create JvmtiThreadState.
1805   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1806   if (state == NULL) {
1807     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1808   }
1809 
1810   // It is only safe to perform the direct operation on the current
1811   // thread. All other usage needs to use a vm-safepoint-op for safety.
1812   if (java_thread == JavaThread::current()) {
1813     err = get_frame_count(state, count_ptr);
1814   } else {
1815     // get java stack frame count at safepoint.
1816     VM_GetFrameCount op(this, state, count_ptr);
1817     VMThread::execute(&amp;op);
1818     err = op.result();
1819   }
1820   return err;
1821 } /* end GetFrameCount */
1822 
1823 
1824 // Threads_lock NOT held, java_thread not protected by lock
1825 // java_thread - pre-checked
1826 jvmtiError
1827 JvmtiEnv::PopFrame(JavaThread* java_thread) {
1828   JavaThread* current_thread  = JavaThread::current();
1829   HandleMark hm(current_thread);
1830   uint32_t debug_bits = 0;
1831 
1832   // retrieve or create the state
1833   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1834   if (state == NULL) {
1835     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1836   }
1837 
1838   // Check if java_thread is fully suspended
1839   if (!java_thread-&gt;is_thread_fully_suspended(true /* wait for suspend completion */, &amp;debug_bits)) {
1840     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1841   }
1842   // Check to see if a PopFrame was already in progress
1843   if (java_thread-&gt;popframe_condition() != JavaThread::popframe_inactive) {
1844     // Probably possible for JVMTI clients to trigger this, but the
1845     // JPDA backend shouldn&#39;t allow this to happen
1846     return JVMTI_ERROR_INTERNAL;
1847   }
1848 
1849   {
1850     // Was workaround bug
1851     //    4812902: popFrame hangs if the method is waiting at a synchronize
1852     // Catch this condition and return an error to avoid hanging.
1853     // Now JVMTI spec allows an implementation to bail out with an opaque frame error.
1854     OSThread* osThread = java_thread-&gt;osthread();
1855     if (osThread-&gt;get_state() == MONITOR_WAIT) {
1856       return JVMTI_ERROR_OPAQUE_FRAME;
1857     }
1858   }
1859 
1860   {
1861     ResourceMark rm(current_thread);
1862     // Check if there are more than one Java frame in this thread, that the top two frames
1863     // are Java (not native) frames, and that there is no intervening VM frame
1864     int frame_count = 0;
1865     bool is_interpreted[2];
1866     intptr_t *frame_sp[2];
1867     // The 2-nd arg of constructor is needed to stop iterating at java entry frame.
1868     for (vframeStream vfs(java_thread, true); !vfs.at_end(); vfs.next()) {
1869       methodHandle mh(current_thread, vfs.method());
1870       if (mh-&gt;is_native()) return(JVMTI_ERROR_OPAQUE_FRAME);
1871       is_interpreted[frame_count] = vfs.is_interpreted_frame();
1872       frame_sp[frame_count] = vfs.frame_id();
1873       if (++frame_count &gt; 1) break;
1874     }
1875     if (frame_count &lt; 2)  {
1876       // We haven&#39;t found two adjacent non-native Java frames on the top.
1877       // There can be two situations here:
1878       //  1. There are no more java frames
1879       //  2. Two top java frames are separated by non-java native frames
1880       if(vframeFor(java_thread, 1) == NULL) {
1881         return JVMTI_ERROR_NO_MORE_FRAMES;
1882       } else {
1883         // Intervening non-java native or VM frames separate java frames.
1884         // Current implementation does not support this. See bug #5031735.
1885         // In theory it is possible to pop frames in such cases.
1886         return JVMTI_ERROR_OPAQUE_FRAME;
1887       }
1888     }
1889 
1890     // If any of the top 2 frames is a compiled one, need to deoptimize it
1891     for (int i = 0; i &lt; 2; i++) {
1892       if (!is_interpreted[i]) {
1893         Deoptimization::deoptimize_frame(java_thread, frame_sp[i]);
1894       }
1895     }
1896 
1897     // Update the thread state to reflect that the top frame is popped
1898     // so that cur_stack_depth is maintained properly and all frameIDs
1899     // are invalidated.
1900     // The current frame will be popped later when the suspended thread
1901     // is resumed and right before returning from VM to Java.
1902     // (see call_VM_base() in assembler_&lt;cpu&gt;.cpp).
1903 
1904     // It&#39;s fine to update the thread state here because no JVMTI events
1905     // shall be posted for this PopFrame.
1906 
1907     // It is only safe to perform the direct operation on the current
1908     // thread. All other usage needs to use a vm-safepoint-op for safety.
1909     if (java_thread == JavaThread::current()) {
1910       state-&gt;update_for_pop_top_frame();
1911     } else {
1912       VM_UpdateForPopTopFrame op(state);
1913       VMThread::execute(&amp;op);
1914       jvmtiError err = op.result();
1915       if (err != JVMTI_ERROR_NONE) {
1916         return err;
1917       }
1918     }
1919 
1920     java_thread-&gt;set_popframe_condition(JavaThread::popframe_pending_bit);
1921     // Set pending step flag for this popframe and it is cleared when next
1922     // step event is posted.
1923     state-&gt;set_pending_step_for_popframe();
1924   }
1925 
1926   return JVMTI_ERROR_NONE;
1927 } /* end PopFrame */
1928 
1929 
1930 // Threads_lock NOT held
1931 // thread - NOT pre-checked
1932 // depth - pre-checked as non-negative
1933 // method_ptr - pre-checked for NULL
1934 // location_ptr - pre-checked for NULL
1935 jvmtiError
1936 JvmtiEnv::GetFrameLocation(jthread thread, jint depth, jmethodID* method_ptr, jlocation* location_ptr) {
1937   jvmtiError err = JVMTI_ERROR_NONE;
1938   JavaThread* java_thread = NULL;
1939   JavaThread* current_thread = JavaThread::current();
1940   HandleMark hm(current_thread);
1941   oop thread_obj = JNIHandles::resolve_external_guard(thread);
1942 
1943   // Support for virtual threads
1944   if (java_lang_VirtualThread::is_instance(thread_obj)) {
1945     if (!get_capabilities()-&gt;can_support_virtual_threads) {
1946       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
1947     }
1948     VM_VirtualThreadGetFrameLocation op(this, Handle(current_thread, thread_obj),
1949                                 depth, method_ptr, location_ptr);
1950     VMThread::execute(&amp;op);
1951     return op.result();
1952   }
1953 
1954   // Support for ordinary threads
1955   ThreadsListHandle tlh(current_thread);
1956   err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
1957   if (err != JVMTI_ERROR_NONE) {
1958     return err;
1959   }
1960 
1961   // It is only safe to perform the direct operation on the current
1962   // thread. All other usage needs to use a vm-safepoint-op for safety.
1963   if (java_thread == JavaThread::current()) {
1964     err = get_frame_location(java_thread, depth, method_ptr, location_ptr);
1965   } else {
1966     // JVMTI get java stack frame location at safepoint.
1967     VM_GetFrameLocation op(this, java_thread, depth, method_ptr, location_ptr);
1968     VMThread::execute(&amp;op);
1969     err = op.result();
1970   }
1971   return err;
1972 } /* end GetFrameLocation */
1973 
1974 
1975 // Threads_lock NOT held, java_thread not protected by lock
1976 // java_thread - pre-checked
1977 // java_thread - unchecked
1978 // depth - pre-checked as non-negative
1979 jvmtiError
1980 JvmtiEnv::NotifyFramePop(JavaThread* java_thread, jint depth) {
1981   jvmtiError err = JVMTI_ERROR_NONE;
1982   ResourceMark rm;
1983   uint32_t debug_bits = 0;
1984 
1985   JvmtiThreadState *state = JvmtiThreadState::state_for(java_thread);
1986   if (state == NULL) {
1987     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1988   }
1989 
1990   if (!java_thread-&gt;is_thread_fully_suspended(true, &amp;debug_bits)) {
1991     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1992   }
1993 
1994   if (TraceJVMTICalls) {
1995     JvmtiSuspendControl::print();
1996   }
1997 
1998   vframe *vf = vframeFor(java_thread, depth);
1999   if (vf == NULL) {
2000     return JVMTI_ERROR_NO_MORE_FRAMES;
2001   }
2002 
2003   if (!vf-&gt;is_java_frame() || ((javaVFrame*) vf)-&gt;method()-&gt;is_native()) {
2004     return JVMTI_ERROR_OPAQUE_FRAME;
2005   }
2006 
2007   assert(vf-&gt;frame_pointer() != NULL, &quot;frame pointer mustn&#39;t be NULL&quot;);
2008 
2009   // It is only safe to perform the direct operation on the current
2010   // thread. All other usage needs to use a vm-safepoint-op for safety.
2011   if (java_thread == JavaThread::current()) {
2012     int frame_number = state-&gt;count_frames() - depth;
2013     state-&gt;env_thread_state(this)-&gt;set_frame_pop(frame_number);
2014   } else {
2015     VM_SetFramePop op(this, state, depth);
2016     VMThread::execute(&amp;op);
2017     err = op.result();
2018   }
2019   return err;
2020 } /* end NotifyFramePop */
2021 
2022 
2023   //
2024   // Force Early Return functions
2025   //
2026 
2027 // Threads_lock NOT held, java_thread not protected by lock
2028 // java_thread - pre-checked
2029 jvmtiError
2030 JvmtiEnv::ForceEarlyReturnObject(JavaThread* java_thread, jobject value) {
2031   jvalue val;
2032   val.l = value;
2033   return force_early_return(java_thread, val, atos);
2034 } /* end ForceEarlyReturnObject */
2035 
2036 
2037 // Threads_lock NOT held, java_thread not protected by lock
2038 // java_thread - pre-checked
2039 jvmtiError
2040 JvmtiEnv::ForceEarlyReturnInt(JavaThread* java_thread, jint value) {
2041   jvalue val;
2042   val.i = value;
2043   return force_early_return(java_thread, val, itos);
2044 } /* end ForceEarlyReturnInt */
2045 
2046 
2047 // Threads_lock NOT held, java_thread not protected by lock
2048 // java_thread - pre-checked
2049 jvmtiError
2050 JvmtiEnv::ForceEarlyReturnLong(JavaThread* java_thread, jlong value) {
2051   jvalue val;
2052   val.j = value;
2053   return force_early_return(java_thread, val, ltos);
2054 } /* end ForceEarlyReturnLong */
2055 
2056 
2057 // Threads_lock NOT held, java_thread not protected by lock
2058 // java_thread - pre-checked
2059 jvmtiError
2060 JvmtiEnv::ForceEarlyReturnFloat(JavaThread* java_thread, jfloat value) {
2061   jvalue val;
2062   val.f = value;
2063   return force_early_return(java_thread, val, ftos);
2064 } /* end ForceEarlyReturnFloat */
2065 
2066 
2067 // Threads_lock NOT held, java_thread not protected by lock
2068 // java_thread - pre-checked
2069 jvmtiError
2070 JvmtiEnv::ForceEarlyReturnDouble(JavaThread* java_thread, jdouble value) {
2071   jvalue val;
2072   val.d = value;
2073   return force_early_return(java_thread, val, dtos);
2074 } /* end ForceEarlyReturnDouble */
2075 
2076 
2077 // Threads_lock NOT held, java_thread not protected by lock
2078 // java_thread - pre-checked
2079 jvmtiError
2080 JvmtiEnv::ForceEarlyReturnVoid(JavaThread* java_thread) {
2081   jvalue val;
2082   val.j = 0L;
2083   return force_early_return(java_thread, val, vtos);
2084 } /* end ForceEarlyReturnVoid */
2085 
2086 
2087   //
2088   // Heap functions
2089   //
2090 
2091 // klass - NULL is a valid value, must be checked
2092 // initial_object - NULL is a valid value, must be checked
2093 // callbacks - pre-checked for NULL
2094 // user_data - NULL is a valid value, must be checked
2095 jvmtiError
2096 JvmtiEnv::FollowReferences(jint heap_filter, jclass klass, jobject initial_object, const jvmtiHeapCallbacks* callbacks, const void* user_data) {
2097   // check klass if provided
2098   Klass* k = NULL;
2099   if (klass != NULL) {
2100     oop k_mirror = JNIHandles::resolve_external_guard(klass);
2101     if (k_mirror == NULL) {
2102       return JVMTI_ERROR_INVALID_CLASS;
2103     }
2104     if (java_lang_Class::is_primitive(k_mirror)) {
2105       return JVMTI_ERROR_NONE;
2106     }
2107     k = java_lang_Class::as_Klass(k_mirror);
2108     if (klass == NULL) {
2109       return JVMTI_ERROR_INVALID_CLASS;
2110     }
2111   }
2112 
2113   if (initial_object != NULL) {
2114     oop init_obj = JNIHandles::resolve_external_guard(initial_object);
2115     if (init_obj == NULL) {
2116       return JVMTI_ERROR_INVALID_OBJECT;
2117     }
2118   }
2119 
2120   Thread *thread = Thread::current();
2121   HandleMark hm(thread);
2122 
2123   TraceTime t(&quot;FollowReferences&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2124   JvmtiTagMap::tag_map_for(this)-&gt;follow_references(heap_filter, k, initial_object, callbacks, user_data);
2125   return JVMTI_ERROR_NONE;
2126 } /* end FollowReferences */
2127 
2128 
2129 // klass - NULL is a valid value, must be checked
2130 // callbacks - pre-checked for NULL
2131 // user_data - NULL is a valid value, must be checked
2132 jvmtiError
2133 JvmtiEnv::IterateThroughHeap(jint heap_filter, jclass klass, const jvmtiHeapCallbacks* callbacks, const void* user_data) {
2134   // check klass if provided
2135   Klass* k = NULL;
2136   if (klass != NULL) {
2137     oop k_mirror = JNIHandles::resolve_external_guard(klass);
2138     if (k_mirror == NULL) {
2139       return JVMTI_ERROR_INVALID_CLASS;
2140     }
2141     if (java_lang_Class::is_primitive(k_mirror)) {
2142       return JVMTI_ERROR_NONE;
2143     }
2144     k = java_lang_Class::as_Klass(k_mirror);
2145     if (k == NULL) {
2146       return JVMTI_ERROR_INVALID_CLASS;
2147     }
2148   }
2149 
2150   TraceTime t(&quot;IterateThroughHeap&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2151   JvmtiTagMap::tag_map_for(this)-&gt;iterate_through_heap(heap_filter, k, callbacks, user_data);
2152   return JVMTI_ERROR_NONE;
2153 } /* end IterateThroughHeap */
2154 
2155 
2156 // tag_ptr - pre-checked for NULL
2157 jvmtiError
2158 JvmtiEnv::GetTag(jobject object, jlong* tag_ptr) {
2159   oop o = JNIHandles::resolve_external_guard(object);
2160   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
2161   *tag_ptr = JvmtiTagMap::tag_map_for(this)-&gt;get_tag(object);
2162   return JVMTI_ERROR_NONE;
2163 } /* end GetTag */
2164 
2165 
2166 jvmtiError
2167 JvmtiEnv::SetTag(jobject object, jlong tag) {
2168   oop o = JNIHandles::resolve_external_guard(object);
2169   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
2170   JvmtiTagMap::tag_map_for(this)-&gt;set_tag(object, tag);
2171   return JVMTI_ERROR_NONE;
2172 } /* end SetTag */
2173 
2174 
2175 // tag_count - pre-checked to be greater than or equal to 0
2176 // tags - pre-checked for NULL
2177 // count_ptr - pre-checked for NULL
2178 // object_result_ptr - NULL is a valid value, must be checked
2179 // tag_result_ptr - NULL is a valid value, must be checked
2180 jvmtiError
2181 JvmtiEnv::GetObjectsWithTags(jint tag_count, const jlong* tags, jint* count_ptr, jobject** object_result_ptr, jlong** tag_result_ptr) {
2182   TraceTime t(&quot;GetObjectsWithTags&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2183   return JvmtiTagMap::tag_map_for(this)-&gt;get_objects_with_tags((jlong*)tags, tag_count, count_ptr, object_result_ptr, tag_result_ptr);
2184 } /* end GetObjectsWithTags */
2185 
2186 
2187 jvmtiError
2188 JvmtiEnv::ForceGarbageCollection() {
2189   Universe::heap()-&gt;collect(GCCause::_jvmti_force_gc);
2190   return JVMTI_ERROR_NONE;
2191 } /* end ForceGarbageCollection */
2192 
2193 
2194   //
2195   // Heap (1.0) functions
2196   //
2197 
2198 // object_reference_callback - pre-checked for NULL
2199 // user_data - NULL is a valid value, must be checked
2200 jvmtiError
2201 JvmtiEnv::IterateOverObjectsReachableFromObject(jobject object, jvmtiObjectReferenceCallback object_reference_callback, const void* user_data) {
2202   oop o = JNIHandles::resolve_external_guard(object);
2203   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
2204   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_objects_reachable_from_object(object, object_reference_callback, user_data);
2205   return JVMTI_ERROR_NONE;
2206 } /* end IterateOverObjectsReachableFromObject */
2207 
2208 
2209 // heap_root_callback - NULL is a valid value, must be checked
2210 // stack_ref_callback - NULL is a valid value, must be checked
2211 // object_ref_callback - NULL is a valid value, must be checked
2212 // user_data - NULL is a valid value, must be checked
2213 jvmtiError
2214 JvmtiEnv::IterateOverReachableObjects(jvmtiHeapRootCallback heap_root_callback, jvmtiStackReferenceCallback stack_ref_callback, jvmtiObjectReferenceCallback object_ref_callback, const void* user_data) {
2215   TraceTime t(&quot;IterateOverReachableObjects&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2216   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_reachable_objects(heap_root_callback, stack_ref_callback, object_ref_callback, user_data);
2217   return JVMTI_ERROR_NONE;
2218 } /* end IterateOverReachableObjects */
2219 
2220 
2221 // heap_object_callback - pre-checked for NULL
2222 // user_data - NULL is a valid value, must be checked
2223 jvmtiError
2224 JvmtiEnv::IterateOverHeap(jvmtiHeapObjectFilter object_filter, jvmtiHeapObjectCallback heap_object_callback, const void* user_data) {
2225   TraceTime t(&quot;IterateOverHeap&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2226   Thread *thread = Thread::current();
2227   HandleMark hm(thread);
2228   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_heap(object_filter, NULL, heap_object_callback, user_data);
2229   return JVMTI_ERROR_NONE;
2230 } /* end IterateOverHeap */
2231 
2232 
2233 // k_mirror - may be primitive, this must be checked
2234 // heap_object_callback - pre-checked for NULL
2235 // user_data - NULL is a valid value, must be checked
2236 jvmtiError
2237 JvmtiEnv::IterateOverInstancesOfClass(oop k_mirror, jvmtiHeapObjectFilter object_filter, jvmtiHeapObjectCallback heap_object_callback, const void* user_data) {
2238   if (java_lang_Class::is_primitive(k_mirror)) {
2239     // DO PRIMITIVE CLASS PROCESSING
2240     return JVMTI_ERROR_NONE;
2241   }
2242   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2243   if (klass == NULL) {
2244     return JVMTI_ERROR_INVALID_CLASS;
2245   }
2246   TraceTime t(&quot;IterateOverInstancesOfClass&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2247   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_heap(object_filter, klass, heap_object_callback, user_data);
2248   return JVMTI_ERROR_NONE;
2249 } /* end IterateOverInstancesOfClass */
2250 
2251 
2252   //
2253   // Local Variable functions
2254   //
2255 
2256 // Threads_lock NOT held
2257 // thread - NOT pre-checked
2258 // depth - pre-checked as non-negative
2259 // value_ptr - pre-checked for NULL
2260 jvmtiError
2261 JvmtiEnv::GetLocalObject(jthread thread, jint depth, jint slot, jobject* value_ptr) {
2262   jvmtiError err = JVMTI_ERROR_NONE;
2263   JavaThread* java_thread = NULL;
2264   JavaThread* current_thread = JavaThread::current();
2265   // rm object is created to clean up the javaVFrame created in
2266   // doit_prologue(), but after doit() is finished with it.
2267   ResourceMark rm(current_thread);
2268   HandleMark hm(current_thread);
2269   oop thread_obj = JNIHandles::resolve_external_guard(thread);
2270 
2271   if (java_lang_VirtualThread::is_instance(thread_obj)) {
2272     // Support for virtual threads
2273     if (!get_capabilities()-&gt;can_support_virtual_threads) {
2274       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
2275     }
2276     VM_VirtualThreadGetOrSetLocal op(this, Handle(current_thread, thread_obj),
2277                                    current_thread, depth, slot);
2278     VMThread::execute(&amp;op);
2279     err = op.result();
2280     if (err == JVMTI_ERROR_NONE) {
2281       *value_ptr = op.value().l;
2282     }
2283   } else {
2284     // Support for ordinary threads
2285     ThreadsListHandle tlh(current_thread);
2286     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
2287     if (err != JVMTI_ERROR_NONE) {
2288       return err;
2289     }
2290     VM_GetOrSetLocal op(java_thread, current_thread, depth, slot);
2291     VMThread::execute(&amp;op);
2292     err = op.result();
2293     if (err == JVMTI_ERROR_NONE) {
2294       *value_ptr = op.value().l;
2295     }
2296   }
2297   return err;
2298 } /* end GetLocalObject */
2299 
2300 // Threads_lock NOT held
2301 // thread - NOT pre-checked
2302 // depth - pre-checked as non-negative
2303 // value - pre-checked for NULL
2304 jvmtiError
2305 JvmtiEnv::GetLocalInstance(jthread thread, jint depth, jobject* value_ptr){
2306   jvmtiError err = JVMTI_ERROR_NONE;
2307   JavaThread* java_thread = NULL;
2308   JavaThread* current_thread = JavaThread::current();
2309   // rm object is created to clean up the javaVFrame created in
2310   // doit_prologue(), but after doit() is finished with it.
2311   ResourceMark rm(current_thread);
2312   HandleMark hm(current_thread);
2313   oop thread_obj = JNIHandles::resolve_external_guard(thread);
2314 
2315   if (java_lang_VirtualThread::is_instance(thread_obj)) {
2316     // Support for virtual threads
2317     if (!get_capabilities()-&gt;can_support_virtual_threads) {
2318       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
2319     }
2320     VM_VirtualThreadGetReceiver op(this, Handle(current_thread, thread_obj),
2321                                  current_thread, depth);
2322     VMThread::execute(&amp;op);
2323     err = op.result();
2324     if (err == JVMTI_ERROR_NONE) { 
2325       *value_ptr = op.value().l;
2326     }
2327   } else {
2328     // Support for ordinary threads
2329     ThreadsListHandle tlh(current_thread);
2330     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
2331     if (err != JVMTI_ERROR_NONE) {
2332       return err;
2333     }
2334     VM_GetReceiver op(java_thread, current_thread, depth);
2335     VMThread::execute(&amp;op);
2336     err = op.result();
2337     if (err == JVMTI_ERROR_NONE) { 
2338       *value_ptr = op.value().l;
2339     }
2340   }
2341   return err;
2342 } /* end GetLocalInstance */
2343 
2344 
2345 // Threads_lock NOT held
2346 // thread - NOT pre-checked
2347 // depth - pre-checked as non-negative
2348 // value_ptr - pre-checked for NULL
2349 jvmtiError
2350 JvmtiEnv::GetLocalInt(jthread thread, jint depth, jint slot, jint* value_ptr) {
2351   jvmtiError err = JVMTI_ERROR_NONE;
2352   JavaThread* java_thread = NULL;
2353   JavaThread* current_thread = JavaThread::current();
2354   // rm object is created to clean up the javaVFrame created in
2355   // doit_prologue(), but after doit() is finished with it.
2356   ResourceMark rm(current_thread);
2357   HandleMark hm(current_thread);
2358   oop thread_obj = JNIHandles::resolve_external_guard(thread);
2359 
2360   if (java_lang_VirtualThread::is_instance(thread_obj)) {
2361     // Support for virtual threads
2362     if (!get_capabilities()-&gt;can_support_virtual_threads) {
2363       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
2364     }
2365     VM_VirtualThreadGetOrSetLocal op(this, Handle(current_thread, thread_obj),
2366                                    depth, slot, T_INT);
2367     VMThread::execute(&amp;op);
2368     err = op.result();
2369     if (err == JVMTI_ERROR_NONE) {
2370       *value_ptr = op.value().i;
2371     }
2372   } else {
2373     // Support for ordinary threads
2374     ThreadsListHandle tlh(current_thread);
2375     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
2376     if (err != JVMTI_ERROR_NONE) {
2377       return err;
2378     }
2379     VM_GetOrSetLocal op(java_thread, depth, slot, T_INT);
2380     VMThread::execute(&amp;op);
2381     err = op.result();
2382     if (err == JVMTI_ERROR_NONE) {
2383       *value_ptr = op.value().i;
2384     }
2385   }
2386   return err;
2387 } /* end GetLocalInt */
2388 
2389 
2390 // Threads_lock NOT held
2391 // thread - NOT pre-checked
2392 // depth - pre-checked as non-negative
2393 // value_ptr - pre-checked for NULL
2394 jvmtiError
2395 JvmtiEnv::GetLocalLong(jthread thread, jint depth, jint slot, jlong* value_ptr) {
2396   jvmtiError err = JVMTI_ERROR_NONE;
2397   JavaThread* java_thread = NULL;
2398   JavaThread* current_thread = JavaThread::current();
2399   // rm object is created to clean up the javaVFrame created in
2400   // doit_prologue(), but after doit() is finished with it.
2401   ResourceMark rm(current_thread);
2402   HandleMark hm(current_thread);
2403   oop thread_obj = JNIHandles::resolve_external_guard(thread);
2404 
2405   if (java_lang_VirtualThread::is_instance(thread_obj)) {
2406     // Support for virtual threads
2407     if (!get_capabilities()-&gt;can_support_virtual_threads) {
2408       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
2409     }
2410     VM_VirtualThreadGetOrSetLocal op(this, Handle(current_thread, thread_obj),
2411                                    depth, slot, T_LONG);
2412     VMThread::execute(&amp;op);
2413     err = op.result();
2414     if (err == JVMTI_ERROR_NONE) {
2415       *value_ptr = op.value().j;
2416     }
2417   } else {
2418     // Support for ordinary threads
2419     ThreadsListHandle tlh(current_thread);
2420     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
2421     if (err != JVMTI_ERROR_NONE) {
2422       return err;
2423     }
2424     VM_GetOrSetLocal op(java_thread, depth, slot, T_LONG);
2425     VMThread::execute(&amp;op);
2426     err = op.result();
2427     if (err == JVMTI_ERROR_NONE) {
2428       *value_ptr = op.value().j;
2429     }
2430   }
2431   return err;
2432 } /* end GetLocalLong */
2433 
2434 
2435 // Threads_lock NOT held
2436 // thread - NOT pre-checked
2437 // depth - pre-checked as non-negative
2438 // value_ptr - pre-checked for NULL
2439 jvmtiError
2440 JvmtiEnv::GetLocalFloat(jthread thread, jint depth, jint slot, jfloat* value_ptr) {
2441   jvmtiError err = JVMTI_ERROR_NONE;
2442   JavaThread* java_thread = NULL;
2443   JavaThread* current_thread = JavaThread::current();
2444   // rm object is created to clean up the javaVFrame created in
2445   // doit_prologue(), but after doit() is finished with it.
2446   ResourceMark rm(current_thread);
2447   HandleMark hm(current_thread);
2448   oop thread_obj = JNIHandles::resolve_external_guard(thread);
2449 
2450   if (java_lang_VirtualThread::is_instance(thread_obj)) {
2451     // Support for virtual threads
2452     if (!get_capabilities()-&gt;can_support_virtual_threads) {
2453       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
2454     }
2455     VM_VirtualThreadGetOrSetLocal op(this, Handle(current_thread, thread_obj),
2456                                    depth, slot, T_FLOAT);
2457     VMThread::execute(&amp;op);
2458     err = op.result();
2459     if (err == JVMTI_ERROR_NONE) {
2460       *value_ptr = op.value().f;
2461     }
2462   } else {
2463     // Support for ordinary threads
2464     ThreadsListHandle tlh(current_thread);
2465     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
2466     if (err != JVMTI_ERROR_NONE) {
2467       return err;
2468     }
2469     VM_GetOrSetLocal op(java_thread, depth, slot, T_FLOAT);
2470     VMThread::execute(&amp;op);
2471     err = op.result();
2472     if (err == JVMTI_ERROR_NONE) {
2473       *value_ptr = op.value().f;
2474     }
2475   }
2476   return err;
2477 } /* end GetLocalFloat */
2478 
2479 
2480 // Threads_lock NOT held
2481 // thread - NOT pre-checked
2482 // depth - pre-checked as non-negative
2483 // value_ptr - pre-checked for NULL
2484 jvmtiError
2485 JvmtiEnv::GetLocalDouble(jthread thread, jint depth, jint slot, jdouble* value_ptr) {
2486   jvmtiError err = JVMTI_ERROR_NONE;
2487   JavaThread* java_thread = NULL;
2488   JavaThread* current_thread = JavaThread::current();
2489   // rm object is created to clean up the javaVFrame created in
2490   // doit_prologue(), but after doit() is finished with it.
2491   ResourceMark rm(current_thread);
2492   HandleMark hm(current_thread);
2493   oop thread_obj = JNIHandles::resolve_external_guard(thread);
2494 
2495   if (java_lang_VirtualThread::is_instance(thread_obj)) {
2496     // Support for virtual threads
2497     if (!get_capabilities()-&gt;can_support_virtual_threads) {
2498       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
2499     }
2500     VM_VirtualThreadGetOrSetLocal op(this, Handle(current_thread, thread_obj),
2501                                    depth, slot, T_DOUBLE);
2502     VMThread::execute(&amp;op);
2503     err = op.result();
2504     if (err == JVMTI_ERROR_NONE) {
2505       *value_ptr = op.value().d;
2506     }
2507   } else {
2508     // Support for ordinary threads
2509     ThreadsListHandle tlh(current_thread);
2510     err = get_JavaThread(tlh.list(), thread, &amp;java_thread);
2511     if (err != JVMTI_ERROR_NONE) {
2512       return err;
2513     }
2514     VM_GetOrSetLocal op(java_thread, depth, slot, T_DOUBLE);
2515     VMThread::execute(&amp;op);
2516     err = op.result();
2517     if (err == JVMTI_ERROR_NONE) {
2518       *value_ptr = op.value().d;
2519     }
2520   }
2521   return err;
2522 } /* end GetLocalDouble */
2523 
2524 
2525 // Threads_lock NOT held, java_thread not protected by lock
2526 // java_thread - pre-checked
2527 // java_thread - unchecked
2528 // depth - pre-checked as non-negative
2529 jvmtiError
2530 JvmtiEnv::SetLocalObject(JavaThread* java_thread, jint depth, jint slot, jobject value) {
2531   // rm object is created to clean up the javaVFrame created in
2532   // doit_prologue(), but after doit() is finished with it.
2533   ResourceMark rm;
2534   jvalue val;
2535   val.l = value;
2536   VM_GetOrSetLocal op(java_thread, depth, slot, T_OBJECT, val);
2537   VMThread::execute(&amp;op);
2538   return op.result();
2539 } /* end SetLocalObject */
2540 
2541 
2542 // Threads_lock NOT held, java_thread not protected by lock
2543 // java_thread - pre-checked
2544 // java_thread - unchecked
2545 // depth - pre-checked as non-negative
2546 jvmtiError
2547 JvmtiEnv::SetLocalInt(JavaThread* java_thread, jint depth, jint slot, jint value) {
2548   // rm object is created to clean up the javaVFrame created in
2549   // doit_prologue(), but after doit() is finished with it.
2550   ResourceMark rm;
2551   jvalue val;
2552   val.i = value;
2553   VM_GetOrSetLocal op(java_thread, depth, slot, T_INT, val);
2554   VMThread::execute(&amp;op);
2555   return op.result();
2556 } /* end SetLocalInt */
2557 
2558 
2559 // Threads_lock NOT held, java_thread not protected by lock
2560 // java_thread - pre-checked
2561 // java_thread - unchecked
2562 // depth - pre-checked as non-negative
2563 jvmtiError
2564 JvmtiEnv::SetLocalLong(JavaThread* java_thread, jint depth, jint slot, jlong value) {
2565   // rm object is created to clean up the javaVFrame created in
2566   // doit_prologue(), but after doit() is finished with it.
2567   ResourceMark rm;
2568   jvalue val;
2569   val.j = value;
2570   VM_GetOrSetLocal op(java_thread, depth, slot, T_LONG, val);
2571   VMThread::execute(&amp;op);
2572   return op.result();
2573 } /* end SetLocalLong */
2574 
2575 
2576 // Threads_lock NOT held, java_thread not protected by lock
2577 // java_thread - pre-checked
2578 // java_thread - unchecked
2579 // depth - pre-checked as non-negative
2580 jvmtiError
2581 JvmtiEnv::SetLocalFloat(JavaThread* java_thread, jint depth, jint slot, jfloat value) {
2582   // rm object is created to clean up the javaVFrame created in
2583   // doit_prologue(), but after doit() is finished with it.
2584   ResourceMark rm;
2585   jvalue val;
2586   val.f = value;
2587   VM_GetOrSetLocal op(java_thread, depth, slot, T_FLOAT, val);
2588   VMThread::execute(&amp;op);
2589   return op.result();
2590 } /* end SetLocalFloat */
2591 
2592 
2593 // Threads_lock NOT held, java_thread not protected by lock
2594 // java_thread - pre-checked
2595 // java_thread - unchecked
2596 // depth - pre-checked as non-negative
2597 jvmtiError
2598 JvmtiEnv::SetLocalDouble(JavaThread* java_thread, jint depth, jint slot, jdouble value) {
2599   // rm object is created to clean up the javaVFrame created in
2600   // doit_prologue(), but after doit() is finished with it.
2601   ResourceMark rm;
2602   jvalue val;
2603   val.d = value;
2604   VM_GetOrSetLocal op(java_thread, depth, slot, T_DOUBLE, val);
2605   VMThread::execute(&amp;op);
2606   return op.result();
2607 } /* end SetLocalDouble */
2608 
2609 
2610   //
2611   // Breakpoint functions
2612   //
2613 
2614 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2615 jvmtiError
2616 JvmtiEnv::SetBreakpoint(Method* method_oop, jlocation location) {
2617   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2618   if (location &lt; 0) {   // simple invalid location check first
2619     return JVMTI_ERROR_INVALID_LOCATION;
2620   }
2621   // verify that the breakpoint is not past the end of the method
2622   if (location &gt;= (jlocation) method_oop-&gt;code_size()) {
2623     return JVMTI_ERROR_INVALID_LOCATION;
2624   }
2625 
2626   ResourceMark rm;
2627   JvmtiBreakpoint bp(method_oop, location);
2628   JvmtiBreakpoints&amp; jvmti_breakpoints = JvmtiCurrentBreakpoints::get_jvmti_breakpoints();
2629   if (jvmti_breakpoints.set(bp) == JVMTI_ERROR_DUPLICATE)
2630     return JVMTI_ERROR_DUPLICATE;
2631 
2632   if (TraceJVMTICalls) {
2633     jvmti_breakpoints.print();
2634   }
2635 
2636   return JVMTI_ERROR_NONE;
2637 } /* end SetBreakpoint */
2638 
2639 
2640 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2641 jvmtiError
2642 JvmtiEnv::ClearBreakpoint(Method* method_oop, jlocation location) {
2643   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2644 
2645   if (location &lt; 0) {   // simple invalid location check first
2646     return JVMTI_ERROR_INVALID_LOCATION;
2647   }
2648 
2649   // verify that the breakpoint is not past the end of the method
2650   if (location &gt;= (jlocation) method_oop-&gt;code_size()) {
2651     return JVMTI_ERROR_INVALID_LOCATION;
2652   }
2653 
2654   JvmtiBreakpoint bp(method_oop, location);
2655 
2656   JvmtiBreakpoints&amp; jvmti_breakpoints = JvmtiCurrentBreakpoints::get_jvmti_breakpoints();
2657   if (jvmti_breakpoints.clear(bp) == JVMTI_ERROR_NOT_FOUND)
2658     return JVMTI_ERROR_NOT_FOUND;
2659 
2660   if (TraceJVMTICalls) {
2661     jvmti_breakpoints.print();
2662   }
2663 
2664   return JVMTI_ERROR_NONE;
2665 } /* end ClearBreakpoint */
2666 
2667 
2668   //
2669   // Watched Field functions
2670   //
2671 
2672 jvmtiError
2673 JvmtiEnv::SetFieldAccessWatch(fieldDescriptor* fdesc_ptr) {
2674   // make sure we haven&#39;t set this watch before
2675   if (fdesc_ptr-&gt;is_field_access_watched()) return JVMTI_ERROR_DUPLICATE;
2676   fdesc_ptr-&gt;set_is_field_access_watched(true);
2677 
2678   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_ACCESS, true);
2679 
2680   return JVMTI_ERROR_NONE;
2681 } /* end SetFieldAccessWatch */
2682 
2683 
2684 jvmtiError
2685 JvmtiEnv::ClearFieldAccessWatch(fieldDescriptor* fdesc_ptr) {
2686   // make sure we have a watch to clear
2687   if (!fdesc_ptr-&gt;is_field_access_watched()) return JVMTI_ERROR_NOT_FOUND;
2688   fdesc_ptr-&gt;set_is_field_access_watched(false);
2689 
2690   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_ACCESS, false);
2691 
2692   return JVMTI_ERROR_NONE;
2693 } /* end ClearFieldAccessWatch */
2694 
2695 
2696 jvmtiError
2697 JvmtiEnv::SetFieldModificationWatch(fieldDescriptor* fdesc_ptr) {
2698   // make sure we haven&#39;t set this watch before
2699   if (fdesc_ptr-&gt;is_field_modification_watched()) return JVMTI_ERROR_DUPLICATE;
2700   fdesc_ptr-&gt;set_is_field_modification_watched(true);
2701 
2702   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_MODIFICATION, true);
2703 
2704   return JVMTI_ERROR_NONE;
2705 } /* end SetFieldModificationWatch */
2706 
2707 
2708 jvmtiError
2709 JvmtiEnv::ClearFieldModificationWatch(fieldDescriptor* fdesc_ptr) {
2710    // make sure we have a watch to clear
2711   if (!fdesc_ptr-&gt;is_field_modification_watched()) return JVMTI_ERROR_NOT_FOUND;
2712   fdesc_ptr-&gt;set_is_field_modification_watched(false);
2713 
2714   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_MODIFICATION, false);
2715 
2716   return JVMTI_ERROR_NONE;
2717 } /* end ClearFieldModificationWatch */
2718 
2719   //
2720   // Class functions
2721   //
2722 
2723 
2724 // k_mirror - may be primitive, this must be checked
2725 // signature_ptr - NULL is a valid value, must be checked
2726 // generic_ptr - NULL is a valid value, must be checked
2727 jvmtiError
2728 JvmtiEnv::GetClassSignature(oop k_mirror, char** signature_ptr, char** generic_ptr) {
2729   ResourceMark rm;
2730   bool isPrimitive = java_lang_Class::is_primitive(k_mirror);
2731   Klass* k = NULL;
2732   if (!isPrimitive) {
2733     k = java_lang_Class::as_Klass(k_mirror);
2734     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2735   }
2736   if (signature_ptr != NULL) {
2737     char* result = NULL;
2738     if (isPrimitive) {
2739       char tchar = type2char(java_lang_Class::primitive_type(k_mirror));
2740       result = (char*) jvmtiMalloc(2);
2741       result[0] = tchar;
2742       result[1] = &#39;\0&#39;;
2743     } else {
2744       const char* class_sig = k-&gt;signature_name();
2745       result = (char *) jvmtiMalloc(strlen(class_sig)+1);
2746       strcpy(result, class_sig);
2747     }
2748     *signature_ptr = result;
2749   }
2750   if (generic_ptr != NULL) {
2751     *generic_ptr = NULL;
2752     if (!isPrimitive &amp;&amp; k-&gt;is_instance_klass()) {
2753       Symbol* soo = InstanceKlass::cast(k)-&gt;generic_signature();
2754       if (soo != NULL) {
2755         const char *gen_sig = soo-&gt;as_C_string();
2756         if (gen_sig != NULL) {
2757           char* gen_result;
2758           jvmtiError err = allocate(strlen(gen_sig) + 1,
2759                                     (unsigned char **)&amp;gen_result);
2760           if (err != JVMTI_ERROR_NONE) {
2761             return err;
2762           }
2763           strcpy(gen_result, gen_sig);
2764           *generic_ptr = gen_result;
2765         }
2766       }
2767     }
2768   }
2769   return JVMTI_ERROR_NONE;
2770 } /* end GetClassSignature */
2771 
2772 
2773 // k_mirror - may be primitive, this must be checked
2774 // status_ptr - pre-checked for NULL
2775 jvmtiError
2776 JvmtiEnv::GetClassStatus(oop k_mirror, jint* status_ptr) {
2777   jint result = 0;
2778   if (java_lang_Class::is_primitive(k_mirror)) {
2779     result |= JVMTI_CLASS_STATUS_PRIMITIVE;
2780   } else {
2781     Klass* k = java_lang_Class::as_Klass(k_mirror);
2782     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2783     result = k-&gt;jvmti_class_status();
2784   }
2785   *status_ptr = result;
2786 
2787   return JVMTI_ERROR_NONE;
2788 } /* end GetClassStatus */
2789 
2790 
2791 // k_mirror - may be primitive, this must be checked
2792 // source_name_ptr - pre-checked for NULL
2793 jvmtiError
2794 JvmtiEnv::GetSourceFileName(oop k_mirror, char** source_name_ptr) {
2795   if (java_lang_Class::is_primitive(k_mirror)) {
2796      return JVMTI_ERROR_ABSENT_INFORMATION;
2797   }
2798   Klass* k_klass = java_lang_Class::as_Klass(k_mirror);
2799   NULL_CHECK(k_klass, JVMTI_ERROR_INVALID_CLASS);
2800 
2801   if (!k_klass-&gt;is_instance_klass()) {
2802     return JVMTI_ERROR_ABSENT_INFORMATION;
2803   }
2804 
2805   Symbol* sfnOop = InstanceKlass::cast(k_klass)-&gt;source_file_name();
2806   NULL_CHECK(sfnOop, JVMTI_ERROR_ABSENT_INFORMATION);
2807   {
2808     JavaThread* current_thread  = JavaThread::current();
2809     ResourceMark rm(current_thread);
2810     const char* sfncp = (const char*) sfnOop-&gt;as_C_string();
2811     *source_name_ptr = (char *) jvmtiMalloc(strlen(sfncp)+1);
2812     strcpy(*source_name_ptr, sfncp);
2813   }
2814 
2815   return JVMTI_ERROR_NONE;
2816 } /* end GetSourceFileName */
2817 
2818 
2819 // k_mirror - may be primitive, this must be checked
2820 // modifiers_ptr - pre-checked for NULL
2821 jvmtiError
2822 JvmtiEnv::GetClassModifiers(oop k_mirror, jint* modifiers_ptr) {
2823   JavaThread* current_thread  = JavaThread::current();
2824   jint result = 0;
2825   if (!java_lang_Class::is_primitive(k_mirror)) {
2826     Klass* k = java_lang_Class::as_Klass(k_mirror);
2827     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2828     result = k-&gt;compute_modifier_flags(current_thread);
2829     JavaThread* THREAD = current_thread; // pass to macros
2830     if (HAS_PENDING_EXCEPTION) {
2831       CLEAR_PENDING_EXCEPTION;
2832       return JVMTI_ERROR_INTERNAL;
2833     };
2834 
2835     // Reset the deleted  ACC_SUPER bit ( deleted in compute_modifier_flags()).
2836     if(k-&gt;is_super()) {
2837       result |= JVM_ACC_SUPER;
2838     }
2839   } else {
2840     result = (JVM_ACC_ABSTRACT | JVM_ACC_FINAL | JVM_ACC_PUBLIC);
2841   }
2842   *modifiers_ptr = result;
2843 
2844   return JVMTI_ERROR_NONE;
2845 } /* end GetClassModifiers */
2846 
2847 
2848 // k_mirror - may be primitive, this must be checked
2849 // method_count_ptr - pre-checked for NULL
2850 // methods_ptr - pre-checked for NULL
2851 jvmtiError
2852 JvmtiEnv::GetClassMethods(oop k_mirror, jint* method_count_ptr, jmethodID** methods_ptr) {
2853   JavaThread* current_thread  = JavaThread::current();
2854   HandleMark hm(current_thread);
2855 
2856   if (java_lang_Class::is_primitive(k_mirror)) {
2857     *method_count_ptr = 0;
2858     *methods_ptr = (jmethodID*) jvmtiMalloc(0 * sizeof(jmethodID));
2859     return JVMTI_ERROR_NONE;
2860   }
2861   Klass* k = java_lang_Class::as_Klass(k_mirror);
2862   NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2863 
2864   // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2865   if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) )) {
2866     return JVMTI_ERROR_CLASS_NOT_PREPARED;
2867   }
2868 
2869   if (!k-&gt;is_instance_klass()) {
2870     *method_count_ptr = 0;
2871     *methods_ptr = (jmethodID*) jvmtiMalloc(0 * sizeof(jmethodID));
2872     return JVMTI_ERROR_NONE;
2873   }
2874   InstanceKlass* ik = InstanceKlass::cast(k);
2875   // Allocate the result and fill it in
2876   int result_length = ik-&gt;methods()-&gt;length();
2877   jmethodID* result_list = (jmethodID*)jvmtiMalloc(result_length * sizeof(jmethodID));
2878   int index;
2879   bool jmethodids_found = true;
2880 
2881   if (JvmtiExport::can_maintain_original_method_order()) {
2882     // Use the original method ordering indices stored in the class, so we can emit
2883     // jmethodIDs in the order they appeared in the class file
2884     for (index = 0; index &lt; result_length; index++) {
2885       Method* m = ik-&gt;methods()-&gt;at(index);
2886       int original_index = ik-&gt;method_ordering()-&gt;at(index);
2887       assert(original_index &gt;= 0 &amp;&amp; original_index &lt; result_length, &quot;invalid original method index&quot;);
2888       jmethodID id;
2889       if (jmethodids_found) {
2890         id = m-&gt;find_jmethod_id_or_null();
2891         if (id == NULL) {
2892           // If we find an uninitialized value, make sure there is
2893           // enough space for all the uninitialized values we might
2894           // find.
2895           ik-&gt;ensure_space_for_methodids(index);
2896           jmethodids_found = false;
2897           id = m-&gt;jmethod_id();
2898         }
2899       } else {
2900         id = m-&gt;jmethod_id();
2901       }
2902       result_list[original_index] = id;
2903     }
2904   } else {
2905     // otherwise just copy in any order
2906     for (index = 0; index &lt; result_length; index++) {
2907       Method* m = ik-&gt;methods()-&gt;at(index);
2908       jmethodID id;
2909       if (jmethodids_found) {
2910         id = m-&gt;find_jmethod_id_or_null();
2911         if (id == NULL) {
2912           // If we find an uninitialized value, make sure there is
2913           // enough space for all the uninitialized values we might
2914           // find.
2915           ik-&gt;ensure_space_for_methodids(index);
2916           jmethodids_found = false;
2917           id = m-&gt;jmethod_id();
2918         }
2919       } else {
2920         id = m-&gt;jmethod_id();
2921       }
2922       result_list[index] = id;
2923     }
2924   }
2925   // Fill in return value.
2926   *method_count_ptr = result_length;
2927   *methods_ptr = result_list;
2928 
2929   return JVMTI_ERROR_NONE;
2930 } /* end GetClassMethods */
2931 
2932 
2933 // k_mirror - may be primitive, this must be checked
2934 // field_count_ptr - pre-checked for NULL
2935 // fields_ptr - pre-checked for NULL
2936 jvmtiError
2937 JvmtiEnv::GetClassFields(oop k_mirror, jint* field_count_ptr, jfieldID** fields_ptr) {
2938   if (java_lang_Class::is_primitive(k_mirror)) {
2939     *field_count_ptr = 0;
2940     *fields_ptr = (jfieldID*) jvmtiMalloc(0 * sizeof(jfieldID));
2941     return JVMTI_ERROR_NONE;
2942   }
2943   JavaThread* current_thread = JavaThread::current();
2944   HandleMark hm(current_thread);
2945   Klass* k = java_lang_Class::as_Klass(k_mirror);
2946   NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2947 
2948   // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2949   if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) )) {
2950     return JVMTI_ERROR_CLASS_NOT_PREPARED;
2951   }
2952 
2953   if (!k-&gt;is_instance_klass()) {
2954     *field_count_ptr = 0;
2955     *fields_ptr = (jfieldID*) jvmtiMalloc(0 * sizeof(jfieldID));
2956     return JVMTI_ERROR_NONE;
2957   }
2958 
2959 
2960   InstanceKlass* ik = InstanceKlass::cast(k);
2961 
2962   int result_count = 0;
2963   // First, count the fields.
2964   FilteredFieldStream flds(ik, true, true);
2965   result_count = flds.field_count();
2966 
2967   // Allocate the result and fill it in
2968   jfieldID* result_list = (jfieldID*) jvmtiMalloc(result_count * sizeof(jfieldID));
2969   // The JVMTI spec requires fields in the order they occur in the class file,
2970   // this is the reverse order of what FieldStream hands out.
2971   int id_index = (result_count - 1);
2972 
2973   for (FilteredFieldStream src_st(ik, true, true); !src_st.eos(); src_st.next()) {
2974     result_list[id_index--] = jfieldIDWorkaround::to_jfieldID(
2975                                             ik, src_st.offset(),
2976                                             src_st.access_flags().is_static());
2977   }
2978   assert(id_index == -1, &quot;just checking&quot;);
2979   // Fill in the results
2980   *field_count_ptr = result_count;
2981   *fields_ptr = result_list;
2982 
2983   return JVMTI_ERROR_NONE;
2984 } /* end GetClassFields */
2985 
2986 
2987 // k_mirror - may be primitive, this must be checked
2988 // interface_count_ptr - pre-checked for NULL
2989 // interfaces_ptr - pre-checked for NULL
2990 jvmtiError
2991 JvmtiEnv::GetImplementedInterfaces(oop k_mirror, jint* interface_count_ptr, jclass** interfaces_ptr) {
2992   {
2993     if (java_lang_Class::is_primitive(k_mirror)) {
2994       *interface_count_ptr = 0;
2995       *interfaces_ptr = (jclass*) jvmtiMalloc(0 * sizeof(jclass));
2996       return JVMTI_ERROR_NONE;
2997     }
2998     JavaThread* current_thread = JavaThread::current();
2999     HandleMark hm(current_thread);
3000     Klass* k = java_lang_Class::as_Klass(k_mirror);
3001     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
3002 
3003     // Return CLASS_NOT_PREPARED error as per JVMTI spec.
3004     if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) ))
3005       return JVMTI_ERROR_CLASS_NOT_PREPARED;
3006 
3007     if (!k-&gt;is_instance_klass()) {
3008       *interface_count_ptr = 0;
3009       *interfaces_ptr = (jclass*) jvmtiMalloc(0 * sizeof(jclass));
3010       return JVMTI_ERROR_NONE;
3011     }
3012 
3013     Array&lt;InstanceKlass*&gt;* interface_list = InstanceKlass::cast(k)-&gt;local_interfaces();
3014     const int result_length = (interface_list == NULL ? 0 : interface_list-&gt;length());
3015     jclass* result_list = (jclass*) jvmtiMalloc(result_length * sizeof(jclass));
3016     for (int i_index = 0; i_index &lt; result_length; i_index += 1) {
3017       InstanceKlass* klass_at = interface_list-&gt;at(i_index);
3018       assert(klass_at-&gt;is_klass(), &quot;interfaces must be Klass*s&quot;);
3019       assert(klass_at-&gt;is_interface(), &quot;interfaces must be interfaces&quot;);
3020       oop mirror_at = klass_at-&gt;java_mirror();
3021       Handle handle_at = Handle(current_thread, mirror_at);
3022       result_list[i_index] = (jclass) jni_reference(handle_at);
3023     }
3024     *interface_count_ptr = result_length;
3025     *interfaces_ptr = result_list;
3026   }
3027 
3028   return JVMTI_ERROR_NONE;
3029 } /* end GetImplementedInterfaces */
3030 
3031 
3032 // k_mirror - may be primitive, this must be checked
3033 // minor_version_ptr - pre-checked for NULL
3034 // major_version_ptr - pre-checked for NULL
3035 jvmtiError
3036 JvmtiEnv::GetClassVersionNumbers(oop k_mirror, jint* minor_version_ptr, jint* major_version_ptr) {
3037   if (java_lang_Class::is_primitive(k_mirror)) {
3038     return JVMTI_ERROR_ABSENT_INFORMATION;
3039   }
3040   Klass* klass = java_lang_Class::as_Klass(k_mirror);
3041 
3042   jint status = klass-&gt;jvmti_class_status();
3043   if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
3044     return JVMTI_ERROR_INVALID_CLASS;
3045   }
3046   if (status &amp; (JVMTI_CLASS_STATUS_ARRAY)) {
3047     return JVMTI_ERROR_ABSENT_INFORMATION;
3048   }
3049 
3050   InstanceKlass* ik = InstanceKlass::cast(klass);
3051   *minor_version_ptr = ik-&gt;minor_version();
3052   *major_version_ptr = ik-&gt;major_version();
3053 
3054   return JVMTI_ERROR_NONE;
3055 } /* end GetClassVersionNumbers */
3056 
3057 
3058 // k_mirror - may be primitive, this must be checked
3059 // constant_pool_count_ptr - pre-checked for NULL
3060 // constant_pool_byte_count_ptr - pre-checked for NULL
3061 // constant_pool_bytes_ptr - pre-checked for NULL
3062 jvmtiError
3063 JvmtiEnv::GetConstantPool(oop k_mirror, jint* constant_pool_count_ptr, jint* constant_pool_byte_count_ptr, unsigned char** constant_pool_bytes_ptr) {
3064   if (java_lang_Class::is_primitive(k_mirror)) {
3065     return JVMTI_ERROR_ABSENT_INFORMATION;
3066   }
3067 
3068   Klass* klass = java_lang_Class::as_Klass(k_mirror);
3069   Thread *thread = Thread::current();
3070   ResourceMark rm(thread);
3071 
3072   jint status = klass-&gt;jvmti_class_status();
3073   if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
3074     return JVMTI_ERROR_INVALID_CLASS;
3075   }
3076   if (status &amp; (JVMTI_CLASS_STATUS_ARRAY)) {
3077     return JVMTI_ERROR_ABSENT_INFORMATION;
3078   }
3079 
3080   InstanceKlass* ik = InstanceKlass::cast(klass);
3081   JvmtiConstantPoolReconstituter reconstituter(ik);
3082   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
3083     return reconstituter.get_error();
3084   }
3085 
3086   unsigned char *cpool_bytes;
3087   int cpool_size = reconstituter.cpool_size();
3088   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
3089     return reconstituter.get_error();
3090   }
3091   jvmtiError res = allocate(cpool_size, &amp;cpool_bytes);
3092   if (res != JVMTI_ERROR_NONE) {
3093     return res;
3094   }
3095   reconstituter.copy_cpool_bytes(cpool_bytes);
3096   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
3097     return reconstituter.get_error();
3098   }
3099 
3100   constantPoolHandle  constants(thread, ik-&gt;constants());
3101   *constant_pool_count_ptr      = constants-&gt;length();
3102   *constant_pool_byte_count_ptr = cpool_size;
3103   *constant_pool_bytes_ptr      = cpool_bytes;
3104 
3105   return JVMTI_ERROR_NONE;
3106 } /* end GetConstantPool */
3107 
3108 
3109 // k_mirror - may be primitive, this must be checked
3110 // is_interface_ptr - pre-checked for NULL
3111 jvmtiError
3112 JvmtiEnv::IsInterface(oop k_mirror, jboolean* is_interface_ptr) {
3113   {
3114     bool result = false;
3115     if (!java_lang_Class::is_primitive(k_mirror)) {
3116       Klass* k = java_lang_Class::as_Klass(k_mirror);
3117       if (k != NULL &amp;&amp; k-&gt;is_interface()) {
3118         result = true;
3119       }
3120     }
3121     *is_interface_ptr = result;
3122   }
3123 
3124   return JVMTI_ERROR_NONE;
3125 } /* end IsInterface */
3126 
3127 
3128 // k_mirror - may be primitive, this must be checked
3129 // is_array_class_ptr - pre-checked for NULL
3130 jvmtiError
3131 JvmtiEnv::IsArrayClass(oop k_mirror, jboolean* is_array_class_ptr) {
3132   {
3133     bool result = false;
3134     if (!java_lang_Class::is_primitive(k_mirror)) {
3135       Klass* k = java_lang_Class::as_Klass(k_mirror);
3136       if (k != NULL &amp;&amp; k-&gt;is_array_klass()) {
3137         result = true;
3138       }
3139     }
3140     *is_array_class_ptr = result;
3141   }
3142 
3143   return JVMTI_ERROR_NONE;
3144 } /* end IsArrayClass */
3145 
3146 
3147 // k_mirror - may be primitive, this must be checked
3148 // classloader_ptr - pre-checked for NULL
3149 jvmtiError
3150 JvmtiEnv::GetClassLoader(oop k_mirror, jobject* classloader_ptr) {
3151   {
3152     if (java_lang_Class::is_primitive(k_mirror)) {
3153       *classloader_ptr = (jclass) jni_reference(Handle());
3154       return JVMTI_ERROR_NONE;
3155     }
3156     JavaThread* current_thread = JavaThread::current();
3157     HandleMark hm(current_thread);
3158     Klass* k = java_lang_Class::as_Klass(k_mirror);
3159     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
3160 
3161     oop result_oop = k-&gt;class_loader();
3162     if (result_oop == NULL) {
3163       *classloader_ptr = (jclass) jni_reference(Handle());
3164       return JVMTI_ERROR_NONE;
3165     }
3166     Handle result_handle = Handle(current_thread, result_oop);
3167     jclass result_jnihandle = (jclass) jni_reference(result_handle);
3168     *classloader_ptr = result_jnihandle;
3169   }
3170   return JVMTI_ERROR_NONE;
3171 } /* end GetClassLoader */
3172 
3173 
3174 // k_mirror - may be primitive, this must be checked
3175 // source_debug_extension_ptr - pre-checked for NULL
3176 jvmtiError
3177 JvmtiEnv::GetSourceDebugExtension(oop k_mirror, char** source_debug_extension_ptr) {
3178   {
3179     if (java_lang_Class::is_primitive(k_mirror)) {
3180       return JVMTI_ERROR_ABSENT_INFORMATION;
3181     }
3182     Klass* k = java_lang_Class::as_Klass(k_mirror);
3183     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
3184     if (!k-&gt;is_instance_klass()) {
3185       return JVMTI_ERROR_ABSENT_INFORMATION;
3186     }
3187     const char* sde = InstanceKlass::cast(k)-&gt;source_debug_extension();
3188     NULL_CHECK(sde, JVMTI_ERROR_ABSENT_INFORMATION);
3189 
3190     {
3191       *source_debug_extension_ptr = (char *) jvmtiMalloc(strlen(sde)+1);
3192       strcpy(*source_debug_extension_ptr, sde);
3193     }
3194   }
3195 
3196   return JVMTI_ERROR_NONE;
3197 } /* end GetSourceDebugExtension */
3198 
3199   //
3200   // Object functions
3201   //
3202 
3203 // hash_code_ptr - pre-checked for NULL
3204 jvmtiError
3205 JvmtiEnv::GetObjectHashCode(jobject object, jint* hash_code_ptr) {
3206   oop mirror = JNIHandles::resolve_external_guard(object);
3207   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
3208   NULL_CHECK(hash_code_ptr, JVMTI_ERROR_NULL_POINTER);
3209 
3210   {
3211     jint result = (jint) mirror-&gt;identity_hash();
3212     *hash_code_ptr = result;
3213   }
3214   return JVMTI_ERROR_NONE;
3215 } /* end GetObjectHashCode */
3216 
3217 
3218 // info_ptr - pre-checked for NULL
3219 jvmtiError
3220 JvmtiEnv::GetObjectMonitorUsage(jobject object, jvmtiMonitorUsage* info_ptr) {
3221   JavaThread* calling_thread = JavaThread::current();
3222   jvmtiError err = get_object_monitor_usage(calling_thread, object, info_ptr);
3223   if (err == JVMTI_ERROR_THREAD_NOT_SUSPENDED) {
3224     // Some of the critical threads were not suspended. go to a safepoint and try again
3225     VM_GetObjectMonitorUsage op(this, calling_thread, object, info_ptr);
3226     VMThread::execute(&amp;op);
3227     err = op.result();
3228   }
3229   return err;
3230 } /* end GetObjectMonitorUsage */
3231 
3232 
3233   //
3234   // Field functions
3235   //
3236 
3237 // name_ptr - NULL is a valid value, must be checked
3238 // signature_ptr - NULL is a valid value, must be checked
3239 // generic_ptr - NULL is a valid value, must be checked
3240 jvmtiError
3241 JvmtiEnv::GetFieldName(fieldDescriptor* fdesc_ptr, char** name_ptr, char** signature_ptr, char** generic_ptr) {
3242   JavaThread* current_thread  = JavaThread::current();
3243   ResourceMark rm(current_thread);
3244   if (name_ptr == NULL) {
3245     // just don&#39;t return the name
3246   } else {
3247     const char* fieldName = fdesc_ptr-&gt;name()-&gt;as_C_string();
3248     *name_ptr =  (char*) jvmtiMalloc(strlen(fieldName) + 1);
3249     if (*name_ptr == NULL)
3250       return JVMTI_ERROR_OUT_OF_MEMORY;
3251     strcpy(*name_ptr, fieldName);
3252   }
3253   if (signature_ptr== NULL) {
3254     // just don&#39;t return the signature
3255   } else {
3256     const char* fieldSignature = fdesc_ptr-&gt;signature()-&gt;as_C_string();
3257     *signature_ptr = (char*) jvmtiMalloc(strlen(fieldSignature) + 1);
3258     if (*signature_ptr == NULL)
3259       return JVMTI_ERROR_OUT_OF_MEMORY;
3260     strcpy(*signature_ptr, fieldSignature);
3261   }
3262   if (generic_ptr != NULL) {
3263     *generic_ptr = NULL;
3264     Symbol* soop = fdesc_ptr-&gt;generic_signature();
3265     if (soop != NULL) {
3266       const char* gen_sig = soop-&gt;as_C_string();
3267       if (gen_sig != NULL) {
3268         jvmtiError err = allocate(strlen(gen_sig) + 1, (unsigned char **)generic_ptr);
3269         if (err != JVMTI_ERROR_NONE) {
3270           return err;
3271         }
3272         strcpy(*generic_ptr, gen_sig);
3273       }
3274     }
3275   }
3276   return JVMTI_ERROR_NONE;
3277 } /* end GetFieldName */
3278 
3279 
3280 // declaring_class_ptr - pre-checked for NULL
3281 jvmtiError
3282 JvmtiEnv::GetFieldDeclaringClass(fieldDescriptor* fdesc_ptr, jclass* declaring_class_ptr) {
3283 
3284   *declaring_class_ptr = get_jni_class_non_null(fdesc_ptr-&gt;field_holder());
3285   return JVMTI_ERROR_NONE;
3286 } /* end GetFieldDeclaringClass */
3287 
3288 
3289 // modifiers_ptr - pre-checked for NULL
3290 jvmtiError
3291 JvmtiEnv::GetFieldModifiers(fieldDescriptor* fdesc_ptr, jint* modifiers_ptr) {
3292 
3293   AccessFlags resultFlags = fdesc_ptr-&gt;access_flags();
3294   jint result = resultFlags.as_int();
3295   *modifiers_ptr = result;
3296 
3297   return JVMTI_ERROR_NONE;
3298 } /* end GetFieldModifiers */
3299 
3300 
3301 // is_synthetic_ptr - pre-checked for NULL
3302 jvmtiError
3303 JvmtiEnv::IsFieldSynthetic(fieldDescriptor* fdesc_ptr, jboolean* is_synthetic_ptr) {
3304   *is_synthetic_ptr = fdesc_ptr-&gt;is_synthetic();
3305   return JVMTI_ERROR_NONE;
3306 } /* end IsFieldSynthetic */
3307 
3308 
3309   //
3310   // Method functions
3311   //
3312 
3313 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3314 // name_ptr - NULL is a valid value, must be checked
3315 // signature_ptr - NULL is a valid value, must be checked
3316 // generic_ptr - NULL is a valid value, must be checked
3317 jvmtiError
3318 JvmtiEnv::GetMethodName(Method* method_oop, char** name_ptr, char** signature_ptr, char** generic_ptr) {
3319   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3320   JavaThread* current_thread  = JavaThread::current();
3321 
3322   ResourceMark rm(current_thread); // get the utf8 name and signature
3323   if (name_ptr == NULL) {
3324     // just don&#39;t return the name
3325   } else {
3326     const char* utf8_name = (const char *) method_oop-&gt;name()-&gt;as_utf8();
3327     *name_ptr = (char *) jvmtiMalloc(strlen(utf8_name)+1);
3328     strcpy(*name_ptr, utf8_name);
3329   }
3330   if (signature_ptr == NULL) {
3331     // just don&#39;t return the signature
3332   } else {
3333     const char* utf8_signature = (const char *) method_oop-&gt;signature()-&gt;as_utf8();
3334     *signature_ptr = (char *) jvmtiMalloc(strlen(utf8_signature) + 1);
3335     strcpy(*signature_ptr, utf8_signature);
3336   }
3337 
3338   if (generic_ptr != NULL) {
3339     *generic_ptr = NULL;
3340     Symbol* soop = method_oop-&gt;generic_signature();
3341     if (soop != NULL) {
3342       const char* gen_sig = soop-&gt;as_C_string();
3343       if (gen_sig != NULL) {
3344         jvmtiError err = allocate(strlen(gen_sig) + 1, (unsigned char **)generic_ptr);
3345         if (err != JVMTI_ERROR_NONE) {
3346           return err;
3347         }
3348         strcpy(*generic_ptr, gen_sig);
3349       }
3350     }
3351   }
3352   return JVMTI_ERROR_NONE;
3353 } /* end GetMethodName */
3354 
3355 
3356 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3357 // declaring_class_ptr - pre-checked for NULL
3358 jvmtiError
3359 JvmtiEnv::GetMethodDeclaringClass(Method* method_oop, jclass* declaring_class_ptr) {
3360   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3361   (*declaring_class_ptr) = get_jni_class_non_null(method_oop-&gt;method_holder());
3362   return JVMTI_ERROR_NONE;
3363 } /* end GetMethodDeclaringClass */
3364 
3365 
3366 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3367 // modifiers_ptr - pre-checked for NULL
3368 jvmtiError
3369 JvmtiEnv::GetMethodModifiers(Method* method_oop, jint* modifiers_ptr) {
3370   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3371   (*modifiers_ptr) = method_oop-&gt;access_flags().as_int() &amp; JVM_RECOGNIZED_METHOD_MODIFIERS;
3372   return JVMTI_ERROR_NONE;
3373 } /* end GetMethodModifiers */
3374 
3375 
3376 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3377 // max_ptr - pre-checked for NULL
3378 jvmtiError
3379 JvmtiEnv::GetMaxLocals(Method* method_oop, jint* max_ptr) {
3380   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3381   // get max stack
3382   (*max_ptr) = method_oop-&gt;max_locals();
3383   return JVMTI_ERROR_NONE;
3384 } /* end GetMaxLocals */
3385 
3386 
3387 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3388 // size_ptr - pre-checked for NULL
3389 jvmtiError
3390 JvmtiEnv::GetArgumentsSize(Method* method_oop, jint* size_ptr) {
3391   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3392   // get size of arguments
3393 
3394   (*size_ptr) = method_oop-&gt;size_of_parameters();
3395   return JVMTI_ERROR_NONE;
3396 } /* end GetArgumentsSize */
3397 
3398 
3399 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3400 // entry_count_ptr - pre-checked for NULL
3401 // table_ptr - pre-checked for NULL
3402 jvmtiError
3403 JvmtiEnv::GetLineNumberTable(Method* method_oop, jint* entry_count_ptr, jvmtiLineNumberEntry** table_ptr) {
3404   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3405   if (!method_oop-&gt;has_linenumber_table()) {
3406     return (JVMTI_ERROR_ABSENT_INFORMATION);
3407   }
3408 
3409   // The line number table is compressed so we don&#39;t know how big it is until decompressed.
3410   // Decompression is really fast so we just do it twice.
3411 
3412   // Compute size of table
3413   jint num_entries = 0;
3414   CompressedLineNumberReadStream stream(method_oop-&gt;compressed_linenumber_table());
3415   while (stream.read_pair()) {
3416     num_entries++;
3417   }
3418   jvmtiLineNumberEntry *jvmti_table =
3419             (jvmtiLineNumberEntry *)jvmtiMalloc(num_entries * (sizeof(jvmtiLineNumberEntry)));
3420 
3421   // Fill jvmti table
3422   if (num_entries &gt; 0) {
3423     int index = 0;
3424     CompressedLineNumberReadStream stream(method_oop-&gt;compressed_linenumber_table());
3425     while (stream.read_pair()) {
3426       jvmti_table[index].start_location = (jlocation) stream.bci();
3427       jvmti_table[index].line_number = (jint) stream.line();
3428       index++;
3429     }
3430     assert(index == num_entries, &quot;sanity check&quot;);
3431   }
3432 
3433   // Set up results
3434   (*entry_count_ptr) = num_entries;
3435   (*table_ptr) = jvmti_table;
3436 
3437   return JVMTI_ERROR_NONE;
3438 } /* end GetLineNumberTable */
3439 
3440 
3441 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3442 // start_location_ptr - pre-checked for NULL
3443 // end_location_ptr - pre-checked for NULL
3444 jvmtiError
3445 JvmtiEnv::GetMethodLocation(Method* method_oop, jlocation* start_location_ptr, jlocation* end_location_ptr) {
3446 
3447   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3448   // get start and end location
3449   (*end_location_ptr) = (jlocation) (method_oop-&gt;code_size() - 1);
3450   if (method_oop-&gt;code_size() == 0) {
3451     // there is no code so there is no start location
3452     (*start_location_ptr) = (jlocation)(-1);
3453   } else {
3454     (*start_location_ptr) = (jlocation)(0);
3455   }
3456 
3457   return JVMTI_ERROR_NONE;
3458 } /* end GetMethodLocation */
3459 
3460 
3461 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3462 // entry_count_ptr - pre-checked for NULL
3463 // table_ptr - pre-checked for NULL
3464 jvmtiError
3465 JvmtiEnv::GetLocalVariableTable(Method* method_oop, jint* entry_count_ptr, jvmtiLocalVariableEntry** table_ptr) {
3466 
3467   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3468   JavaThread* current_thread  = JavaThread::current();
3469 
3470   // does the klass have any local variable information?
3471   InstanceKlass* ik = method_oop-&gt;method_holder();
3472   if (!ik-&gt;access_flags().has_localvariable_table()) {
3473     return (JVMTI_ERROR_ABSENT_INFORMATION);
3474   }
3475 
3476   ConstantPool* constants = method_oop-&gt;constants();
3477   NULL_CHECK(constants, JVMTI_ERROR_ABSENT_INFORMATION);
3478 
3479   // in the vm localvariable table representation, 6 consecutive elements in the table
3480   // represent a 6-tuple of shorts
3481   // [start_pc, length, name_index, descriptor_index, signature_index, index]
3482   jint num_entries = method_oop-&gt;localvariable_table_length();
3483   jvmtiLocalVariableEntry *jvmti_table = (jvmtiLocalVariableEntry *)
3484                 jvmtiMalloc(num_entries * (sizeof(jvmtiLocalVariableEntry)));
3485 
3486   if (num_entries &gt; 0) {
3487     LocalVariableTableElement* table = method_oop-&gt;localvariable_table_start();
3488     for (int i = 0; i &lt; num_entries; i++) {
3489       // get the 5 tuple information from the vm table
3490       jlocation start_location = (jlocation) table[i].start_bci;
3491       jint length = (jint) table[i].length;
3492       int name_index = (int) table[i].name_cp_index;
3493       int signature_index = (int) table[i].descriptor_cp_index;
3494       int generic_signature_index = (int) table[i].signature_cp_index;
3495       jint slot = (jint) table[i].slot;
3496 
3497       // get utf8 name and signature
3498       char *name_buf = NULL;
3499       char *sig_buf = NULL;
3500       char *gen_sig_buf = NULL;
3501       {
3502         ResourceMark rm(current_thread);
3503 
3504         const char *utf8_name = (const char *) constants-&gt;symbol_at(name_index)-&gt;as_utf8();
3505         name_buf = (char *) jvmtiMalloc(strlen(utf8_name)+1);
3506         strcpy(name_buf, utf8_name);
3507 
3508         const char *utf8_signature = (const char *) constants-&gt;symbol_at(signature_index)-&gt;as_utf8();
3509         sig_buf = (char *) jvmtiMalloc(strlen(utf8_signature)+1);
3510         strcpy(sig_buf, utf8_signature);
3511 
3512         if (generic_signature_index &gt; 0) {
3513           const char *utf8_gen_sign = (const char *)
3514                                        constants-&gt;symbol_at(generic_signature_index)-&gt;as_utf8();
3515           gen_sig_buf = (char *) jvmtiMalloc(strlen(utf8_gen_sign)+1);
3516           strcpy(gen_sig_buf, utf8_gen_sign);
3517         }
3518       }
3519 
3520       // fill in the jvmti local variable table
3521       jvmti_table[i].start_location = start_location;
3522       jvmti_table[i].length = length;
3523       jvmti_table[i].name = name_buf;
3524       jvmti_table[i].signature = sig_buf;
3525       jvmti_table[i].generic_signature = gen_sig_buf;
3526       jvmti_table[i].slot = slot;
3527     }
3528   }
3529 
3530   // set results
3531   (*entry_count_ptr) = num_entries;
3532   (*table_ptr) = jvmti_table;
3533 
3534   return JVMTI_ERROR_NONE;
3535 } /* end GetLocalVariableTable */
3536 
3537 
3538 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3539 // bytecode_count_ptr - pre-checked for NULL
3540 // bytecodes_ptr - pre-checked for NULL
3541 jvmtiError
3542 JvmtiEnv::GetBytecodes(Method* method_oop, jint* bytecode_count_ptr, unsigned char** bytecodes_ptr) {
3543   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3544 
3545   HandleMark hm;
3546   methodHandle method(Thread::current(), method_oop);
3547   jint size = (jint)method-&gt;code_size();
3548   jvmtiError err = allocate(size, bytecodes_ptr);
3549   if (err != JVMTI_ERROR_NONE) {
3550     return err;
3551   }
3552 
3553   (*bytecode_count_ptr) = size;
3554   // get byte codes
3555   JvmtiClassFileReconstituter::copy_bytecodes(method, *bytecodes_ptr);
3556 
3557   return JVMTI_ERROR_NONE;
3558 } /* end GetBytecodes */
3559 
3560 
3561 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3562 // is_native_ptr - pre-checked for NULL
3563 jvmtiError
3564 JvmtiEnv::IsMethodNative(Method* method_oop, jboolean* is_native_ptr) {
3565   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3566   (*is_native_ptr) = method_oop-&gt;is_native();
3567   return JVMTI_ERROR_NONE;
3568 } /* end IsMethodNative */
3569 
3570 
3571 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3572 // is_synthetic_ptr - pre-checked for NULL
3573 jvmtiError
3574 JvmtiEnv::IsMethodSynthetic(Method* method_oop, jboolean* is_synthetic_ptr) {
3575   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3576   (*is_synthetic_ptr) = method_oop-&gt;is_synthetic();
3577   return JVMTI_ERROR_NONE;
3578 } /* end IsMethodSynthetic */
3579 
3580 
3581 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3582 // is_obsolete_ptr - pre-checked for NULL
3583 jvmtiError
3584 JvmtiEnv::IsMethodObsolete(Method* method_oop, jboolean* is_obsolete_ptr) {
3585   if (use_version_1_0_semantics() &amp;&amp;
3586       get_capabilities()-&gt;can_redefine_classes == 0) {
3587     // This JvmtiEnv requested version 1.0 semantics and this function
3588     // requires the can_redefine_classes capability in version 1.0 so
3589     // we need to return an error here.
3590     return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
3591   }
3592 
3593   if (method_oop == NULL || method_oop-&gt;is_obsolete()) {
3594     *is_obsolete_ptr = true;
3595   } else {
3596     *is_obsolete_ptr = false;
3597   }
3598   return JVMTI_ERROR_NONE;
3599 } /* end IsMethodObsolete */
3600 
3601   //
3602   // Raw Monitor functions
3603   //
3604 
3605 // name - pre-checked for NULL
3606 // monitor_ptr - pre-checked for NULL
3607 jvmtiError
3608 JvmtiEnv::CreateRawMonitor(const char* name, jrawMonitorID* monitor_ptr) {
3609   JvmtiRawMonitor* rmonitor = new JvmtiRawMonitor(name);
3610   NULL_CHECK(rmonitor, JVMTI_ERROR_OUT_OF_MEMORY);
3611 
3612   *monitor_ptr = (jrawMonitorID)rmonitor;
3613 
3614   return JVMTI_ERROR_NONE;
3615 } /* end CreateRawMonitor */
3616 
3617 
3618 // rmonitor - pre-checked for validity
3619 jvmtiError
3620 JvmtiEnv::DestroyRawMonitor(JvmtiRawMonitor * rmonitor) {
3621   if (Threads::number_of_threads() == 0) {
3622     // Remove this monitor from pending raw monitors list
3623     // if it has entered in onload or start phase.
3624     JvmtiPendingMonitors::destroy(rmonitor);
3625   } else {
3626     Thread* thread  = Thread::current();
3627     if (rmonitor-&gt;owner() == thread) {
3628       // The caller owns this monitor which we are about to destroy.
3629       // We exit the underlying synchronization object so that the
3630       // &quot;delete monitor&quot; call below can work without an assertion
3631       // failure on systems that don&#39;t like destroying synchronization
3632       // objects that are locked.
3633       int r;
3634       int recursion = rmonitor-&gt;recursions();
3635       for (int i = 0; i &lt;= recursion; i++) {
3636         r = rmonitor-&gt;raw_exit(thread);
3637         assert(r == JvmtiRawMonitor::M_OK, &quot;raw_exit should have worked&quot;);
3638         if (r != JvmtiRawMonitor::M_OK) {  // robustness
3639           return JVMTI_ERROR_INTERNAL;
3640         }
3641       }
3642     }
3643     if (rmonitor-&gt;owner() != NULL) {
3644       // The caller is trying to destroy a monitor that is locked by
3645       // someone else. While this is not forbidden by the JVMTI
3646       // spec, it will cause an assertion failure on systems that don&#39;t
3647       // like destroying synchronization objects that are locked.
3648       // We indicate a problem with the error return (and leak the
3649       // monitor&#39;s memory).
3650       return JVMTI_ERROR_NOT_MONITOR_OWNER;
3651     }
3652   }
3653 
3654   delete rmonitor;
3655 
3656   return JVMTI_ERROR_NONE;
3657 } /* end DestroyRawMonitor */
3658 
3659 
3660 // rmonitor - pre-checked for validity
3661 jvmtiError
3662 JvmtiEnv::RawMonitorEnter(JvmtiRawMonitor * rmonitor) {
3663   if (Threads::number_of_threads() == 0) {
3664     // No JavaThreads exist so JvmtiRawMonitor enter cannot be
3665     // used, add this raw monitor to the pending list.
3666     // The pending monitors will be actually entered when
3667     // the VM is setup.
3668     // See transition_pending_raw_monitors in create_vm()
3669     // in thread.cpp.
3670     JvmtiPendingMonitors::enter(rmonitor);
3671   } else {
3672     Thread* thread = Thread::current();
3673     if (thread-&gt;is_Java_thread()) {
3674       JavaThread* current_thread = (JavaThread*)thread;
3675 
3676       /* Transition to thread_blocked without entering vm state          */
3677       /* This is really evil. Normally you can&#39;t undo _thread_blocked    */
3678       /* transitions like this because it would cause us to miss a       */
3679       /* safepoint but since the thread was already in _thread_in_native */
3680       /* the thread is not leaving a safepoint safe state and it will    */
3681       /* block when it tries to return from native. We can&#39;t safepoint   */
3682       /* block in here because we could deadlock the vmthread. Blech.    */
3683 
3684       JavaThreadState state = current_thread-&gt;thread_state();
3685       assert(state == _thread_in_native, &quot;Must be _thread_in_native&quot;);
3686       // frame should already be walkable since we are in native
3687       assert(!current_thread-&gt;has_last_Java_frame() ||
3688              current_thread-&gt;frame_anchor()-&gt;walkable(), &quot;Must be walkable&quot;);
3689       current_thread-&gt;set_thread_state(_thread_blocked);
3690 
3691       rmonitor-&gt;raw_enter(current_thread);
3692       // restore state, still at a safepoint safe state
3693       current_thread-&gt;set_thread_state(state);
3694     } else {
3695       rmonitor-&gt;raw_enter(thread);
3696     }
3697   }
3698   return JVMTI_ERROR_NONE;
3699 } /* end RawMonitorEnter */
3700 
3701 
3702 // rmonitor - pre-checked for validity
3703 jvmtiError
3704 JvmtiEnv::RawMonitorExit(JvmtiRawMonitor * rmonitor) {
3705   jvmtiError err = JVMTI_ERROR_NONE;
3706 
3707   if (Threads::number_of_threads() == 0) {
3708     // No JavaThreads exist so just remove this monitor from the pending list.
3709     // Bool value from exit is false if rmonitor is not in the list.
3710     if (!JvmtiPendingMonitors::exit(rmonitor)) {
3711       err = JVMTI_ERROR_NOT_MONITOR_OWNER;
3712     }
3713   } else {
3714     Thread* thread = Thread::current();
3715     int r = rmonitor-&gt;raw_exit(thread);
3716     if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3717       err = JVMTI_ERROR_NOT_MONITOR_OWNER;
3718     }
3719   }
3720   return err;
3721 } /* end RawMonitorExit */
3722 
3723 
3724 // rmonitor - pre-checked for validity
3725 jvmtiError
3726 JvmtiEnv::RawMonitorWait(JvmtiRawMonitor * rmonitor, jlong millis) {
3727   Thread* thread = Thread::current();
3728   int r = rmonitor-&gt;raw_wait(millis, thread);
3729 
3730   switch (r) {
3731   case JvmtiRawMonitor::M_INTERRUPTED:
3732     return JVMTI_ERROR_INTERRUPT;
3733   case JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE:
3734     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3735   default:
3736     return JVMTI_ERROR_NONE;
3737   }
3738 } /* end RawMonitorWait */
3739 
3740 
3741 // rmonitor - pre-checked for validity
3742 jvmtiError
3743 JvmtiEnv::RawMonitorNotify(JvmtiRawMonitor * rmonitor) {
3744   Thread* thread = Thread::current();
3745   int r = rmonitor-&gt;raw_notify(thread);
3746 
3747   if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3748     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3749   }
3750   return JVMTI_ERROR_NONE;
3751 } /* end RawMonitorNotify */
3752 
3753 
3754 // rmonitor - pre-checked for validity
3755 jvmtiError
3756 JvmtiEnv::RawMonitorNotifyAll(JvmtiRawMonitor * rmonitor) {
3757   Thread* thread = Thread::current();
3758   int r = rmonitor-&gt;raw_notifyAll(thread);
3759 
3760   if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3761     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3762   }
3763   return JVMTI_ERROR_NONE;
3764 } /* end RawMonitorNotifyAll */
3765 
3766 
3767   //
3768   // JNI Function Interception functions
3769   //
3770 
3771 
3772 // function_table - pre-checked for NULL
3773 jvmtiError
3774 JvmtiEnv::SetJNIFunctionTable(const jniNativeInterface* function_table) {
3775   // Copy jni function table at safepoint.
3776   VM_JNIFunctionTableCopier copier(function_table);
3777   VMThread::execute(&amp;copier);
3778 
3779   return JVMTI_ERROR_NONE;
3780 } /* end SetJNIFunctionTable */
3781 
3782 
3783 // function_table - pre-checked for NULL
3784 jvmtiError
3785 JvmtiEnv::GetJNIFunctionTable(jniNativeInterface** function_table) {
3786   *function_table=(jniNativeInterface*)jvmtiMalloc(sizeof(jniNativeInterface));
3787   if (*function_table == NULL)
3788     return JVMTI_ERROR_OUT_OF_MEMORY;
3789   memcpy(*function_table,(JavaThread::current())-&gt;get_jni_functions(),sizeof(jniNativeInterface));
3790   return JVMTI_ERROR_NONE;
3791 } /* end GetJNIFunctionTable */
3792 
3793 
3794   //
3795   // Event Management functions
3796   //
3797 
3798 jvmtiError
3799 JvmtiEnv::GenerateEvents(jvmtiEvent event_type) {
3800   // can only generate two event types
3801   if (event_type != JVMTI_EVENT_COMPILED_METHOD_LOAD &amp;&amp;
3802       event_type != JVMTI_EVENT_DYNAMIC_CODE_GENERATED) {
3803     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
3804   }
3805 
3806   // for compiled_method_load events we must check that the environment
3807   // has the can_generate_compiled_method_load_events capability.
3808   if (event_type == JVMTI_EVENT_COMPILED_METHOD_LOAD) {
3809     if (get_capabilities()-&gt;can_generate_compiled_method_load_events == 0) {
3810       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
3811     }
3812     return JvmtiCodeBlobEvents::generate_compiled_method_load_events(this);
3813   } else {
3814     return JvmtiCodeBlobEvents::generate_dynamic_code_events(this);
3815   }
3816 
3817 } /* end GenerateEvents */
3818 
3819 
3820   //
3821   // Extension Mechanism functions
3822   //
3823 
3824 // extension_count_ptr - pre-checked for NULL
3825 // extensions - pre-checked for NULL
3826 jvmtiError
3827 JvmtiEnv::GetExtensionFunctions(jint* extension_count_ptr, jvmtiExtensionFunctionInfo** extensions) {
3828   return JvmtiExtensions::get_functions(this, extension_count_ptr, extensions);
3829 } /* end GetExtensionFunctions */
3830 
3831 
3832 // extension_count_ptr - pre-checked for NULL
3833 // extensions - pre-checked for NULL
3834 jvmtiError
3835 JvmtiEnv::GetExtensionEvents(jint* extension_count_ptr, jvmtiExtensionEventInfo** extensions) {
3836   return JvmtiExtensions::get_events(this, extension_count_ptr, extensions);
3837 } /* end GetExtensionEvents */
3838 
3839 
3840 // callback - NULL is a valid value, must be checked
3841 jvmtiError
3842 JvmtiEnv::SetExtensionEventCallback(jint extension_event_index, jvmtiExtensionEvent callback) {
3843   return JvmtiExtensions::set_event_callback(this, extension_event_index, callback);
3844 } /* end SetExtensionEventCallback */
3845 
3846   //
3847   // Timers functions
3848   //
3849 
3850 // info_ptr - pre-checked for NULL
3851 jvmtiError
3852 JvmtiEnv::GetCurrentThreadCpuTimerInfo(jvmtiTimerInfo* info_ptr) {
3853   os::current_thread_cpu_time_info(info_ptr);
3854   return JVMTI_ERROR_NONE;
3855 } /* end GetCurrentThreadCpuTimerInfo */
3856 
3857 
3858 // nanos_ptr - pre-checked for NULL
3859 jvmtiError
3860 JvmtiEnv::GetCurrentThreadCpuTime(jlong* nanos_ptr) {
3861   *nanos_ptr = os::current_thread_cpu_time();
3862   return JVMTI_ERROR_NONE;
3863 } /* end GetCurrentThreadCpuTime */
3864 
3865 
3866 // info_ptr - pre-checked for NULL
3867 jvmtiError
3868 JvmtiEnv::GetThreadCpuTimerInfo(jvmtiTimerInfo* info_ptr) {
3869   os::thread_cpu_time_info(info_ptr);
3870   return JVMTI_ERROR_NONE;
3871 } /* end GetThreadCpuTimerInfo */
3872 
3873 
3874 // Threads_lock NOT held, java_thread not protected by lock
3875 // java_thread - pre-checked
3876 // nanos_ptr - pre-checked for NULL
3877 jvmtiError
3878 JvmtiEnv::GetThreadCpuTime(JavaThread* java_thread, jlong* nanos_ptr) {
3879   *nanos_ptr = os::thread_cpu_time(java_thread);
3880   return JVMTI_ERROR_NONE;
3881 } /* end GetThreadCpuTime */
3882 
3883 
3884 // info_ptr - pre-checked for NULL
3885 jvmtiError
3886 JvmtiEnv::GetTimerInfo(jvmtiTimerInfo* info_ptr) {
3887   os::javaTimeNanos_info(info_ptr);
3888   return JVMTI_ERROR_NONE;
3889 } /* end GetTimerInfo */
3890 
3891 
3892 // nanos_ptr - pre-checked for NULL
3893 jvmtiError
3894 JvmtiEnv::GetTime(jlong* nanos_ptr) {
3895   *nanos_ptr = os::javaTimeNanos();
3896   return JVMTI_ERROR_NONE;
3897 } /* end GetTime */
3898 
3899 
3900 // processor_count_ptr - pre-checked for NULL
3901 jvmtiError
3902 JvmtiEnv::GetAvailableProcessors(jint* processor_count_ptr) {
3903   *processor_count_ptr = os::active_processor_count();
3904   return JVMTI_ERROR_NONE;
3905 } /* end GetAvailableProcessors */
3906 
3907 jvmtiError
3908 JvmtiEnv::SetHeapSamplingInterval(jint sampling_interval) {
3909   if (sampling_interval &lt; 0) {
3910     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
3911   }
3912   ThreadHeapSampler::set_sampling_interval(sampling_interval);
3913   return JVMTI_ERROR_NONE;
3914 } /* end SetHeapSamplingInterval */
3915 
3916   //
3917   // System Properties functions
3918   //
3919 
3920 // count_ptr - pre-checked for NULL
3921 // property_ptr - pre-checked for NULL
3922 jvmtiError
3923 JvmtiEnv::GetSystemProperties(jint* count_ptr, char*** property_ptr) {
3924   jvmtiError err = JVMTI_ERROR_NONE;
3925 
3926   // Get the number of readable properties.
3927   *count_ptr = Arguments::PropertyList_readable_count(Arguments::system_properties());
3928 
3929   // Allocate memory to hold the exact number of readable properties.
3930   err = allocate(*count_ptr * sizeof(char *), (unsigned char **)property_ptr);
3931   if (err != JVMTI_ERROR_NONE) {
3932     return err;
3933   }
3934   int readable_count = 0;
3935   // Loop through the system properties until all the readable properties are found.
3936   for (SystemProperty* p = Arguments::system_properties(); p != NULL &amp;&amp; readable_count &lt; *count_ptr; p = p-&gt;next()) {
3937     if (p-&gt;is_readable()) {
3938       const char *key = p-&gt;key();
3939       char **tmp_value = *property_ptr+readable_count;
3940       readable_count++;
3941       err = allocate((strlen(key)+1) * sizeof(char), (unsigned char**)tmp_value);
3942       if (err == JVMTI_ERROR_NONE) {
3943         strcpy(*tmp_value, key);
3944       } else {
3945         // clean up previously allocated memory.
3946         for (int j = 0; j &lt; readable_count; j++) {
3947           Deallocate((unsigned char*)*property_ptr+j);
3948         }
3949         Deallocate((unsigned char*)property_ptr);
3950         break;
3951       }
3952     }
3953   }
3954   assert(err != JVMTI_ERROR_NONE || readable_count == *count_ptr, &quot;Bad readable property count&quot;);
3955   return err;
3956 } /* end GetSystemProperties */
3957 
3958 
3959 // property - pre-checked for NULL
3960 // value_ptr - pre-checked for NULL
3961 jvmtiError
3962 JvmtiEnv::GetSystemProperty(const char* property, char** value_ptr) {
3963   jvmtiError err = JVMTI_ERROR_NONE;
3964   const char *value;
3965 
3966   // Return JVMTI_ERROR_NOT_AVAILABLE if property is not readable or doesn&#39;t exist.
3967   value = Arguments::PropertyList_get_readable_value(Arguments::system_properties(), property);
3968   if (value == NULL) {
3969     err =  JVMTI_ERROR_NOT_AVAILABLE;
3970   } else {
3971     err = allocate((strlen(value)+1) * sizeof(char), (unsigned char **)value_ptr);
3972     if (err == JVMTI_ERROR_NONE) {
3973       strcpy(*value_ptr, value);
3974     }
3975   }
3976   return err;
3977 } /* end GetSystemProperty */
3978 
3979 
3980 // property - pre-checked for NULL
3981 // value - NULL is a valid value, must be checked
3982 jvmtiError
3983 JvmtiEnv::SetSystemProperty(const char* property, const char* value_ptr) {
3984   jvmtiError err =JVMTI_ERROR_NOT_AVAILABLE;
3985 
3986   for (SystemProperty* p = Arguments::system_properties(); p != NULL; p = p-&gt;next()) {
3987     if (strcmp(property, p-&gt;key()) == 0) {
3988       if (p-&gt;set_writeable_value(value_ptr)) {
3989         err =  JVMTI_ERROR_NONE;
3990       }
3991     }
3992   }
3993   return err;
3994 } /* end SetSystemProperty */
    </pre>
  </body>
</html>