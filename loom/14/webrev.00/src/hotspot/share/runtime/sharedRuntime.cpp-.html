<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/runtime/sharedRuntime.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;aot/aotLoader.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;classfile/systemDictionary.hpp&quot;
  30 #include &quot;classfile/vmSymbols.hpp&quot;
  31 #include &quot;code/codeCache.hpp&quot;
  32 #include &quot;code/compiledIC.hpp&quot;
  33 #include &quot;code/icBuffer.hpp&quot;
  34 #include &quot;code/compiledMethod.inline.hpp&quot;
  35 #include &quot;code/scopeDesc.hpp&quot;
  36 #include &quot;code/vtableStubs.hpp&quot;
  37 #include &quot;compiler/abstractCompiler.hpp&quot;
  38 #include &quot;compiler/compileBroker.hpp&quot;
  39 #include &quot;compiler/disassembler.hpp&quot;
  40 #include &quot;gc/shared/barrierSet.hpp&quot;
  41 #include &quot;gc/shared/gcLocker.inline.hpp&quot;
  42 #include &quot;interpreter/interpreter.hpp&quot;
  43 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  44 #include &quot;jfr/jfrEvents.hpp&quot;
  45 #include &quot;logging/log.hpp&quot;
  46 #include &quot;memory/metaspaceShared.hpp&quot;
  47 #include &quot;memory/resourceArea.hpp&quot;
  48 #include &quot;memory/universe.hpp&quot;
  49 #include &quot;oops/klass.hpp&quot;
  50 #include &quot;oops/method.inline.hpp&quot;
  51 #include &quot;oops/objArrayKlass.hpp&quot;
  52 #include &quot;oops/oop.inline.hpp&quot;
  53 #include &quot;prims/forte.hpp&quot;
  54 #include &quot;prims/jvmtiExport.hpp&quot;
  55 #include &quot;prims/methodHandles.hpp&quot;
  56 #include &quot;prims/nativeLookup.hpp&quot;
  57 #include &quot;runtime/arguments.hpp&quot;
  58 #include &quot;runtime/atomic.hpp&quot;
  59 #include &quot;runtime/biasedLocking.hpp&quot;
  60 #include &quot;runtime/frame.inline.hpp&quot;
  61 #include &quot;runtime/handles.inline.hpp&quot;
  62 #include &quot;runtime/init.hpp&quot;
  63 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  64 #include &quot;runtime/java.hpp&quot;
  65 #include &quot;runtime/javaCalls.hpp&quot;
  66 #include &quot;runtime/sharedRuntime.hpp&quot;
  67 #include &quot;runtime/stubRoutines.hpp&quot;
  68 #include &quot;runtime/synchronizer.hpp&quot;
  69 #include &quot;runtime/vframe.inline.hpp&quot;
  70 #include &quot;runtime/vframeArray.hpp&quot;
  71 #include &quot;utilities/copy.hpp&quot;
  72 #include &quot;utilities/dtrace.hpp&quot;
  73 #include &quot;utilities/events.hpp&quot;
  74 #include &quot;utilities/hashtable.inline.hpp&quot;
  75 #include &quot;utilities/macros.hpp&quot;
  76 #include &quot;utilities/xmlstream.hpp&quot;
  77 #ifdef COMPILER1
  78 #include &quot;c1/c1_Runtime1.hpp&quot;
  79 #endif
  80 
  81 // Shared stub locations
  82 RuntimeStub*        SharedRuntime::_wrong_method_blob;
  83 RuntimeStub*        SharedRuntime::_wrong_method_abstract_blob;
  84 RuntimeStub*        SharedRuntime::_ic_miss_blob;
  85 RuntimeStub*        SharedRuntime::_resolve_opt_virtual_call_blob;
  86 RuntimeStub*        SharedRuntime::_resolve_virtual_call_blob;
  87 RuntimeStub*        SharedRuntime::_resolve_static_call_blob;
  88 address             SharedRuntime::_resolve_static_call_entry;
  89 
  90 DeoptimizationBlob* SharedRuntime::_deopt_blob;
  91 SafepointBlob*      SharedRuntime::_polling_page_vectors_safepoint_handler_blob;
  92 SafepointBlob*      SharedRuntime::_polling_page_safepoint_handler_blob;
  93 SafepointBlob*      SharedRuntime::_polling_page_return_handler_blob;
  94 
  95 #ifdef COMPILER2
  96 UncommonTrapBlob*   SharedRuntime::_uncommon_trap_blob;
  97 #endif // COMPILER2
  98 
  99 
 100 //----------------------------generate_stubs-----------------------------------
 101 void SharedRuntime::generate_stubs() {
 102   _wrong_method_blob                   = generate_resolve_blob(CAST_FROM_FN_PTR(address, SharedRuntime::handle_wrong_method),          &quot;wrong_method_stub&quot;);
 103   _wrong_method_abstract_blob          = generate_resolve_blob(CAST_FROM_FN_PTR(address, SharedRuntime::handle_wrong_method_abstract), &quot;wrong_method_abstract_stub&quot;);
 104   _ic_miss_blob                        = generate_resolve_blob(CAST_FROM_FN_PTR(address, SharedRuntime::handle_wrong_method_ic_miss),  &quot;ic_miss_stub&quot;);
 105   _resolve_opt_virtual_call_blob       = generate_resolve_blob(CAST_FROM_FN_PTR(address, SharedRuntime::resolve_opt_virtual_call_C),   &quot;resolve_opt_virtual_call&quot;);
 106   _resolve_virtual_call_blob           = generate_resolve_blob(CAST_FROM_FN_PTR(address, SharedRuntime::resolve_virtual_call_C),       &quot;resolve_virtual_call&quot;);
 107   _resolve_static_call_blob            = generate_resolve_blob(CAST_FROM_FN_PTR(address, SharedRuntime::resolve_static_call_C),        &quot;resolve_static_call&quot;);
 108   _resolve_static_call_entry           = _resolve_static_call_blob-&gt;entry_point();
 109 
 110 #if COMPILER2_OR_JVMCI
 111   // Vectors are generated only by C2 and JVMCI.
 112   bool support_wide = is_wide_vector(MaxVectorSize);
 113   if (support_wide) {
 114     _polling_page_vectors_safepoint_handler_blob = generate_handler_blob(CAST_FROM_FN_PTR(address, SafepointSynchronize::handle_polling_page_exception), POLL_AT_VECTOR_LOOP);
 115   }
 116 #endif // COMPILER2_OR_JVMCI
 117   _polling_page_safepoint_handler_blob = generate_handler_blob(CAST_FROM_FN_PTR(address, SafepointSynchronize::handle_polling_page_exception), POLL_AT_LOOP);
 118   _polling_page_return_handler_blob    = generate_handler_blob(CAST_FROM_FN_PTR(address, SafepointSynchronize::handle_polling_page_exception), POLL_AT_RETURN);
 119 
 120   generate_deopt_blob();
 121 
 122 #ifdef COMPILER2
 123   generate_uncommon_trap_blob();
 124 #endif // COMPILER2
 125 }
 126 
 127 #include &lt;math.h&gt;
 128 
 129 // Implementation of SharedRuntime
 130 
 131 #ifndef PRODUCT
 132 // For statistics
 133 int SharedRuntime::_ic_miss_ctr = 0;
 134 int SharedRuntime::_wrong_method_ctr = 0;
 135 int SharedRuntime::_resolve_static_ctr = 0;
 136 int SharedRuntime::_resolve_virtual_ctr = 0;
 137 int SharedRuntime::_resolve_opt_virtual_ctr = 0;
 138 int SharedRuntime::_implicit_null_throws = 0;
 139 int SharedRuntime::_implicit_div0_throws = 0;
 140 int SharedRuntime::_throw_null_ctr = 0;
 141 
 142 int SharedRuntime::_nof_normal_calls = 0;
 143 int SharedRuntime::_nof_optimized_calls = 0;
 144 int SharedRuntime::_nof_inlined_calls = 0;
 145 int SharedRuntime::_nof_megamorphic_calls = 0;
 146 int SharedRuntime::_nof_static_calls = 0;
 147 int SharedRuntime::_nof_inlined_static_calls = 0;
 148 int SharedRuntime::_nof_interface_calls = 0;
 149 int SharedRuntime::_nof_optimized_interface_calls = 0;
 150 int SharedRuntime::_nof_inlined_interface_calls = 0;
 151 int SharedRuntime::_nof_megamorphic_interface_calls = 0;
 152 int SharedRuntime::_nof_removable_exceptions = 0;
 153 
 154 int SharedRuntime::_new_instance_ctr=0;
 155 int SharedRuntime::_new_array_ctr=0;
 156 int SharedRuntime::_multi1_ctr=0;
 157 int SharedRuntime::_multi2_ctr=0;
 158 int SharedRuntime::_multi3_ctr=0;
 159 int SharedRuntime::_multi4_ctr=0;
 160 int SharedRuntime::_multi5_ctr=0;
 161 int SharedRuntime::_mon_enter_stub_ctr=0;
 162 int SharedRuntime::_mon_exit_stub_ctr=0;
 163 int SharedRuntime::_mon_enter_ctr=0;
 164 int SharedRuntime::_mon_exit_ctr=0;
 165 int SharedRuntime::_partial_subtype_ctr=0;
 166 int SharedRuntime::_jbyte_array_copy_ctr=0;
 167 int SharedRuntime::_jshort_array_copy_ctr=0;
 168 int SharedRuntime::_jint_array_copy_ctr=0;
 169 int SharedRuntime::_jlong_array_copy_ctr=0;
 170 int SharedRuntime::_oop_array_copy_ctr=0;
 171 int SharedRuntime::_checkcast_array_copy_ctr=0;
 172 int SharedRuntime::_unsafe_array_copy_ctr=0;
 173 int SharedRuntime::_generic_array_copy_ctr=0;
 174 int SharedRuntime::_slow_array_copy_ctr=0;
 175 int SharedRuntime::_find_handler_ctr=0;
 176 int SharedRuntime::_rethrow_ctr=0;
 177 
 178 int     SharedRuntime::_ICmiss_index                    = 0;
 179 int     SharedRuntime::_ICmiss_count[SharedRuntime::maxICmiss_count];
 180 address SharedRuntime::_ICmiss_at[SharedRuntime::maxICmiss_count];
 181 
 182 
 183 void SharedRuntime::trace_ic_miss(address at) {
 184   for (int i = 0; i &lt; _ICmiss_index; i++) {
 185     if (_ICmiss_at[i] == at) {
 186       _ICmiss_count[i]++;
 187       return;
 188     }
 189   }
 190   int index = _ICmiss_index++;
 191   if (_ICmiss_index &gt;= maxICmiss_count) _ICmiss_index = maxICmiss_count - 1;
 192   _ICmiss_at[index] = at;
 193   _ICmiss_count[index] = 1;
 194 }
 195 
 196 void SharedRuntime::print_ic_miss_histogram() {
 197   if (ICMissHistogram) {
 198     tty-&gt;print_cr(&quot;IC Miss Histogram:&quot;);
 199     int tot_misses = 0;
 200     for (int i = 0; i &lt; _ICmiss_index; i++) {
 201       tty-&gt;print_cr(&quot;  at: &quot; INTPTR_FORMAT &quot;  nof: %d&quot;, p2i(_ICmiss_at[i]), _ICmiss_count[i]);
 202       tot_misses += _ICmiss_count[i];
 203     }
 204     tty-&gt;print_cr(&quot;Total IC misses: %7d&quot;, tot_misses);
 205   }
 206 }
 207 #endif // PRODUCT
 208 
 209 
 210 JRT_LEAF(jlong, SharedRuntime::lmul(jlong y, jlong x))
 211   return x * y;
 212 JRT_END
 213 
 214 
 215 JRT_LEAF(jlong, SharedRuntime::ldiv(jlong y, jlong x))
 216   if (x == min_jlong &amp;&amp; y == CONST64(-1)) {
 217     return x;
 218   } else {
 219     return x / y;
 220   }
 221 JRT_END
 222 
 223 
 224 JRT_LEAF(jlong, SharedRuntime::lrem(jlong y, jlong x))
 225   if (x == min_jlong &amp;&amp; y == CONST64(-1)) {
 226     return 0;
 227   } else {
 228     return x % y;
 229   }
 230 JRT_END
 231 
 232 
 233 const juint  float_sign_mask  = 0x7FFFFFFF;
 234 const juint  float_infinity   = 0x7F800000;
 235 const julong double_sign_mask = CONST64(0x7FFFFFFFFFFFFFFF);
 236 const julong double_infinity  = CONST64(0x7FF0000000000000);
 237 
 238 JRT_LEAF(jfloat, SharedRuntime::frem(jfloat  x, jfloat  y))
 239 #ifdef _WIN64
 240   // 64-bit Windows on amd64 returns the wrong values for
 241   // infinity operands.
 242   union { jfloat f; juint i; } xbits, ybits;
 243   xbits.f = x;
 244   ybits.f = y;
 245   // x Mod Infinity == x unless x is infinity
 246   if (((xbits.i &amp; float_sign_mask) != float_infinity) &amp;&amp;
 247        ((ybits.i &amp; float_sign_mask) == float_infinity) ) {
 248     return x;
 249   }
 250   return ((jfloat)fmod_winx64((double)x, (double)y));
 251 #else
 252   return ((jfloat)fmod((double)x,(double)y));
 253 #endif
 254 JRT_END
 255 
 256 
 257 JRT_LEAF(jdouble, SharedRuntime::drem(jdouble x, jdouble y))
 258 #ifdef _WIN64
 259   union { jdouble d; julong l; } xbits, ybits;
 260   xbits.d = x;
 261   ybits.d = y;
 262   // x Mod Infinity == x unless x is infinity
 263   if (((xbits.l &amp; double_sign_mask) != double_infinity) &amp;&amp;
 264        ((ybits.l &amp; double_sign_mask) == double_infinity) ) {
 265     return x;
 266   }
 267   return ((jdouble)fmod_winx64((double)x, (double)y));
 268 #else
 269   return ((jdouble)fmod((double)x,(double)y));
 270 #endif
 271 JRT_END
 272 
 273 #ifdef __SOFTFP__
 274 JRT_LEAF(jfloat, SharedRuntime::fadd(jfloat x, jfloat y))
 275   return x + y;
 276 JRT_END
 277 
 278 JRT_LEAF(jfloat, SharedRuntime::fsub(jfloat x, jfloat y))
 279   return x - y;
 280 JRT_END
 281 
 282 JRT_LEAF(jfloat, SharedRuntime::fmul(jfloat x, jfloat y))
 283   return x * y;
 284 JRT_END
 285 
 286 JRT_LEAF(jfloat, SharedRuntime::fdiv(jfloat x, jfloat y))
 287   return x / y;
 288 JRT_END
 289 
 290 JRT_LEAF(jdouble, SharedRuntime::dadd(jdouble x, jdouble y))
 291   return x + y;
 292 JRT_END
 293 
 294 JRT_LEAF(jdouble, SharedRuntime::dsub(jdouble x, jdouble y))
 295   return x - y;
 296 JRT_END
 297 
 298 JRT_LEAF(jdouble, SharedRuntime::dmul(jdouble x, jdouble y))
 299   return x * y;
 300 JRT_END
 301 
 302 JRT_LEAF(jdouble, SharedRuntime::ddiv(jdouble x, jdouble y))
 303   return x / y;
 304 JRT_END
 305 
 306 JRT_LEAF(jfloat, SharedRuntime::i2f(jint x))
 307   return (jfloat)x;
 308 JRT_END
 309 
 310 JRT_LEAF(jdouble, SharedRuntime::i2d(jint x))
 311   return (jdouble)x;
 312 JRT_END
 313 
 314 JRT_LEAF(jdouble, SharedRuntime::f2d(jfloat x))
 315   return (jdouble)x;
 316 JRT_END
 317 
 318 JRT_LEAF(int,  SharedRuntime::fcmpl(float x, float y))
 319   return x&gt;y ? 1 : (x==y ? 0 : -1);  /* x&lt;y or is_nan*/
 320 JRT_END
 321 
 322 JRT_LEAF(int,  SharedRuntime::fcmpg(float x, float y))
 323   return x&lt;y ? -1 : (x==y ? 0 : 1);  /* x&gt;y or is_nan */
 324 JRT_END
 325 
 326 JRT_LEAF(int,  SharedRuntime::dcmpl(double x, double y))
 327   return x&gt;y ? 1 : (x==y ? 0 : -1); /* x&lt;y or is_nan */
 328 JRT_END
 329 
 330 JRT_LEAF(int,  SharedRuntime::dcmpg(double x, double y))
 331   return x&lt;y ? -1 : (x==y ? 0 : 1);  /* x&gt;y or is_nan */
 332 JRT_END
 333 
 334 // Functions to return the opposite of the aeabi functions for nan.
 335 JRT_LEAF(int, SharedRuntime::unordered_fcmplt(float x, float y))
 336   return (x &lt; y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 337 JRT_END
 338 
 339 JRT_LEAF(int, SharedRuntime::unordered_dcmplt(double x, double y))
 340   return (x &lt; y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 341 JRT_END
 342 
 343 JRT_LEAF(int, SharedRuntime::unordered_fcmple(float x, float y))
 344   return (x &lt;= y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 345 JRT_END
 346 
 347 JRT_LEAF(int, SharedRuntime::unordered_dcmple(double x, double y))
 348   return (x &lt;= y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 349 JRT_END
 350 
 351 JRT_LEAF(int, SharedRuntime::unordered_fcmpge(float x, float y))
 352   return (x &gt;= y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 353 JRT_END
 354 
 355 JRT_LEAF(int, SharedRuntime::unordered_dcmpge(double x, double y))
 356   return (x &gt;= y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 357 JRT_END
 358 
 359 JRT_LEAF(int, SharedRuntime::unordered_fcmpgt(float x, float y))
 360   return (x &gt; y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 361 JRT_END
 362 
 363 JRT_LEAF(int, SharedRuntime::unordered_dcmpgt(double x, double y))
 364   return (x &gt; y) ? 1 : ((g_isnan(x) || g_isnan(y)) ? 1 : 0);
 365 JRT_END
 366 
 367 // Intrinsics make gcc generate code for these.
 368 float  SharedRuntime::fneg(float f)   {
 369   return -f;
 370 }
 371 
 372 double SharedRuntime::dneg(double f)  {
 373   return -f;
 374 }
 375 
 376 #endif // __SOFTFP__
 377 
 378 #if defined(__SOFTFP__) || defined(E500V2)
 379 // Intrinsics make gcc generate code for these.
 380 double SharedRuntime::dabs(double f)  {
 381   return (f &lt;= (double)0.0) ? (double)0.0 - f : f;
 382 }
 383 
 384 #endif
 385 
 386 #if defined(__SOFTFP__) || defined(PPC)
 387 double SharedRuntime::dsqrt(double f) {
 388   return sqrt(f);
 389 }
 390 #endif
 391 
 392 JRT_LEAF(jint, SharedRuntime::f2i(jfloat  x))
 393   if (g_isnan(x))
 394     return 0;
 395   if (x &gt;= (jfloat) max_jint)
 396     return max_jint;
 397   if (x &lt;= (jfloat) min_jint)
 398     return min_jint;
 399   return (jint) x;
 400 JRT_END
 401 
 402 
 403 JRT_LEAF(jlong, SharedRuntime::f2l(jfloat  x))
 404   if (g_isnan(x))
 405     return 0;
 406   if (x &gt;= (jfloat) max_jlong)
 407     return max_jlong;
 408   if (x &lt;= (jfloat) min_jlong)
 409     return min_jlong;
 410   return (jlong) x;
 411 JRT_END
 412 
 413 
 414 JRT_LEAF(jint, SharedRuntime::d2i(jdouble x))
 415   if (g_isnan(x))
 416     return 0;
 417   if (x &gt;= (jdouble) max_jint)
 418     return max_jint;
 419   if (x &lt;= (jdouble) min_jint)
 420     return min_jint;
 421   return (jint) x;
 422 JRT_END
 423 
 424 
 425 JRT_LEAF(jlong, SharedRuntime::d2l(jdouble x))
 426   if (g_isnan(x))
 427     return 0;
 428   if (x &gt;= (jdouble) max_jlong)
 429     return max_jlong;
 430   if (x &lt;= (jdouble) min_jlong)
 431     return min_jlong;
 432   return (jlong) x;
 433 JRT_END
 434 
 435 
 436 JRT_LEAF(jfloat, SharedRuntime::d2f(jdouble x))
 437   return (jfloat)x;
 438 JRT_END
 439 
 440 
 441 JRT_LEAF(jfloat, SharedRuntime::l2f(jlong x))
 442   return (jfloat)x;
 443 JRT_END
 444 
 445 
 446 JRT_LEAF(jdouble, SharedRuntime::l2d(jlong x))
 447   return (jdouble)x;
 448 JRT_END
 449 
 450 // Exception handling across interpreter/compiler boundaries
 451 //
 452 // exception_handler_for_return_address(...) returns the continuation address.
 453 // The continuation address is the entry point of the exception handler of the
 454 // previous frame depending on the return address.
 455 
 456 address SharedRuntime::raw_exception_handler_for_return_address(JavaThread* thread, address return_address) {
 457   assert(frame::verify_return_pc(return_address), &quot;must be a return address: &quot; INTPTR_FORMAT, p2i(return_address));
 458   assert(thread-&gt;frames_to_pop_failed_realloc() == 0 || Interpreter::contains(return_address), &quot;missed frames to pop?&quot;);
 459 
 460   // Reset method handle flag.
 461   thread-&gt;set_is_method_handle_return(false);
 462 
 463 #if INCLUDE_JVMCI
 464   // JVMCI&#39;s ExceptionHandlerStub expects the thread local exception PC to be clear
 465   // and other exception handler continuations do not read it
 466   thread-&gt;set_exception_pc(NULL);
 467 #endif // INCLUDE_JVMCI
 468 
 469   if (Continuation::is_return_barrier_entry(return_address)) {
 470     return StubRoutines::cont_returnBarrierExc();
 471   }
 472   
 473   // The fastest case first
 474   CodeBlob* blob = CodeCache::find_blob(return_address);
 475   CompiledMethod* nm = (blob != NULL) ? blob-&gt;as_compiled_method_or_null() : NULL;
 476   if (nm != NULL) {
 477     // Set flag if return address is a method handle call site.
 478     thread-&gt;set_is_method_handle_return(nm-&gt;is_method_handle_return(return_address));
 479     // native nmethods don&#39;t have exception handlers
 480     assert(!nm-&gt;is_native_method() || nm-&gt;method()-&gt;is_continuation_enter_intrinsic(), &quot;no exception handler&quot;);
 481     assert(nm-&gt;header_begin() != nm-&gt;exception_begin(), &quot;no exception handler&quot;);
 482     if (nm-&gt;is_deopt_pc(return_address)) {
 483       // If we come here because of a stack overflow, the stack may be
 484       // unguarded. Reguard the stack otherwise if we return to the
 485       // deopt blob and the stack bang causes a stack overflow we
 486       // crash.
 487       bool guard_pages_enabled = thread-&gt;stack_guards_enabled();
 488       if (!guard_pages_enabled) guard_pages_enabled = thread-&gt;reguard_stack();
 489       if (thread-&gt;reserved_stack_activation() != thread-&gt;stack_base()) {
 490         thread-&gt;set_reserved_stack_activation(thread-&gt;stack_base());
 491       }
 492       assert(guard_pages_enabled, &quot;stack banging in deopt blob may cause crash&quot;);
 493       return SharedRuntime::deopt_blob()-&gt;unpack_with_exception();
 494     } else {
 495       return nm-&gt;exception_begin();
 496     }
 497   }
 498 
 499   // Entry code
 500   if (StubRoutines::returns_to_call_stub(return_address)) {
 501     return StubRoutines::catch_exception_entry();
 502   }
 503   // Interpreted code
 504   if (Interpreter::contains(return_address)) {
 505     return Interpreter::rethrow_exception_entry();
 506   }
 507 
 508   guarantee(blob == NULL || !blob-&gt;is_runtime_stub(), &quot;caller should have skipped stub&quot;);
 509   guarantee(!VtableStubs::contains(return_address), &quot;NULL exceptions in vtables should have been handled already!&quot;);
 510 
 511 #ifndef PRODUCT
 512   { ResourceMark rm;
 513     tty-&gt;print_cr(&quot;No exception handler found for exception at &quot; INTPTR_FORMAT &quot; - potential problems:&quot;, p2i(return_address));
 514     os::print_location(tty, (intptr_t)return_address);
 515     tty-&gt;print_cr(&quot;a) exception happened in (new?) code stubs/buffers that is not handled here&quot;);
 516     tty-&gt;print_cr(&quot;b) other problem&quot;);
 517   }
 518 #endif // PRODUCT
 519 
 520   ShouldNotReachHere();
 521   return NULL;
 522 }
 523 
 524 
 525 JRT_LEAF(address, SharedRuntime::exception_handler_for_return_address(JavaThread* thread, address return_address))
 526   return raw_exception_handler_for_return_address(thread, return_address);
 527 JRT_END
 528 
 529 
 530 address SharedRuntime::get_poll_stub(address pc) {
 531   address stub;
 532   // Look up the code blob
 533   CodeBlob *cb = CodeCache::find_blob(pc);
 534 
 535   // Should be an nmethod
 536   guarantee(cb != NULL &amp;&amp; cb-&gt;is_compiled(), &quot;safepoint polling: pc must refer to an nmethod&quot;);
 537 
 538   // Look up the relocation information
 539   assert(((CompiledMethod*)cb)-&gt;is_at_poll_or_poll_return(pc),
 540       &quot;safepoint polling: type must be poll at pc &quot; INTPTR_FORMAT, p2i(pc));
 541 
 542 #ifdef ASSERT
 543   if (!((NativeInstruction*)pc)-&gt;is_safepoint_poll()) {
 544     tty-&gt;print_cr(&quot;bad pc: &quot; PTR_FORMAT, p2i(pc));
 545     Disassembler::decode(cb);
 546     fatal(&quot;Only polling locations are used for safepoint&quot;);
 547   }
 548 #endif
 549 
 550   bool at_poll_return = ((CompiledMethod*)cb)-&gt;is_at_poll_return(pc);
 551   bool has_wide_vectors = ((CompiledMethod*)cb)-&gt;has_wide_vectors();
 552   if (at_poll_return) {
 553     assert(SharedRuntime::polling_page_return_handler_blob() != NULL,
 554            &quot;polling page return stub not created yet&quot;);
 555     stub = SharedRuntime::polling_page_return_handler_blob()-&gt;entry_point();
 556   } else if (has_wide_vectors) {
 557     assert(SharedRuntime::polling_page_vectors_safepoint_handler_blob() != NULL,
 558            &quot;polling page vectors safepoint stub not created yet&quot;);
 559     stub = SharedRuntime::polling_page_vectors_safepoint_handler_blob()-&gt;entry_point();
 560   } else {
 561     assert(SharedRuntime::polling_page_safepoint_handler_blob() != NULL,
 562            &quot;polling page safepoint stub not created yet&quot;);
 563     stub = SharedRuntime::polling_page_safepoint_handler_blob()-&gt;entry_point();
 564   }
 565   log_debug(safepoint)(&quot;... found polling page %s exception at pc = &quot;
 566                        INTPTR_FORMAT &quot;, stub =&quot; INTPTR_FORMAT,
 567                        at_poll_return ? &quot;return&quot; : &quot;loop&quot;,
 568                        (intptr_t)pc, (intptr_t)stub);
 569   return stub;
 570 }
 571 
 572 
 573 oop SharedRuntime::retrieve_receiver( Symbol* sig, frame caller ) {
 574   assert(caller.is_interpreted_frame(), &quot;&quot;);
 575   int args_size = ArgumentSizeComputer(sig).size() + 1;
 576   assert(args_size &lt;= caller.interpreter_frame_expression_stack_size(), &quot;receiver must be on interpreter stack&quot;);
 577   oop result = cast_to_oop(*caller.interpreter_frame_tos_at(args_size - 1));
 578   assert(Universe::heap()-&gt;is_in(result) &amp;&amp; oopDesc::is_oop(result), &quot;receiver must be an oop&quot;);
 579   return result;
 580 }
 581 
 582 
 583 void SharedRuntime::throw_and_post_jvmti_exception(JavaThread *thread, Handle h_exception) {
 584   if (JvmtiExport::can_post_on_exceptions()) {
 585     vframeStream vfst(thread, true);
 586     methodHandle method = methodHandle(thread, vfst.method());
 587     address bcp = method()-&gt;bcp_from(vfst.bci());
 588     JvmtiExport::post_exception_throw(thread, method(), bcp, h_exception());
 589   }
 590   Exceptions::_throw(thread, __FILE__, __LINE__, h_exception);
 591 }
 592 
 593 void SharedRuntime::throw_and_post_jvmti_exception(JavaThread *thread, Symbol* name, const char *message) {
 594   Handle h_exception = Exceptions::new_exception(thread, name, message);
 595   throw_and_post_jvmti_exception(thread, h_exception);
 596 }
 597 
 598 // The interpreter code to call this tracing function is only
 599 // called/generated when UL is on for redefine, class and has the right level
 600 // and tags. Since obsolete methods are never compiled, we don&#39;t have
 601 // to modify the compilers to generate calls to this function.
 602 //
 603 JRT_LEAF(int, SharedRuntime::rc_trace_method_entry(
 604     JavaThread* thread, Method* method))
 605   if (method-&gt;is_obsolete()) {
 606     // We are calling an obsolete method, but this is not necessarily
 607     // an error. Our method could have been redefined just after we
 608     // fetched the Method* from the constant pool.
 609     ResourceMark rm;
 610     log_trace(redefine, class, obsolete)(&quot;calling obsolete method &#39;%s&#39;&quot;, method-&gt;name_and_sig_as_C_string());
 611   }
 612   return 0;
 613 JRT_END
 614 
 615 // ret_pc points into caller; we are returning caller&#39;s exception handler
 616 // for given exception
 617 address SharedRuntime::compute_compiled_exc_handler(CompiledMethod* cm, address ret_pc, Handle&amp; exception,
 618                                                     bool force_unwind, bool top_frame_only, bool&amp; recursive_exception_occurred) {
 619   assert(cm != NULL, &quot;must exist&quot;);
 620   ResourceMark rm;
 621 
 622 #if INCLUDE_JVMCI
 623   if (cm-&gt;is_compiled_by_jvmci()) {
 624     // lookup exception handler for this pc
 625     int catch_pco = ret_pc - cm-&gt;code_begin();
 626     ExceptionHandlerTable table(cm);
 627     HandlerTableEntry *t = table.entry_for(catch_pco, -1, 0);
 628     if (t != NULL) {
 629       return cm-&gt;code_begin() + t-&gt;pco();
 630     } else {
 631       return Deoptimization::deoptimize_for_missing_exception_handler(cm);
 632     }
 633   }
 634 #endif // INCLUDE_JVMCI
 635 
 636   nmethod* nm = cm-&gt;as_nmethod();
 637   ScopeDesc* sd = nm-&gt;scope_desc_at(ret_pc);
 638   // determine handler bci, if any
 639   EXCEPTION_MARK;
 640 
 641   int handler_bci = -1;
 642   int scope_depth = 0;
 643   if (!force_unwind) {
 644     int bci = sd-&gt;bci();
 645     bool recursive_exception = false;
 646     do {
 647       bool skip_scope_increment = false;
 648       // exception handler lookup
 649       Klass* ek = exception-&gt;klass();
 650       methodHandle mh(THREAD, sd-&gt;method());
 651       handler_bci = Method::fast_exception_handler_bci_for(mh, ek, bci, THREAD);
 652       if (HAS_PENDING_EXCEPTION) {
 653         recursive_exception = true;
 654         // We threw an exception while trying to find the exception handler.
 655         // Transfer the new exception to the exception handle which will
 656         // be set into thread local storage, and do another lookup for an
 657         // exception handler for this exception, this time starting at the
 658         // BCI of the exception handler which caused the exception to be
 659         // thrown (bugs 4307310 and 4546590). Set &quot;exception&quot; reference
 660         // argument to ensure that the correct exception is thrown (4870175).
 661         recursive_exception_occurred = true;
 662         exception = Handle(THREAD, PENDING_EXCEPTION);
 663         CLEAR_PENDING_EXCEPTION;
 664         if (handler_bci &gt;= 0) {
 665           bci = handler_bci;
 666           handler_bci = -1;
 667           skip_scope_increment = true;
 668         }
 669       }
 670       else {
 671         recursive_exception = false;
 672       }
 673       if (!top_frame_only &amp;&amp; handler_bci &lt; 0 &amp;&amp; !skip_scope_increment) {
 674         sd = sd-&gt;sender();
 675         if (sd != NULL) {
 676           bci = sd-&gt;bci();
 677         }
 678         ++scope_depth;
 679       }
 680     } while (recursive_exception || (!top_frame_only &amp;&amp; handler_bci &lt; 0 &amp;&amp; sd != NULL));
 681   }
 682 
 683   // found handling method =&gt; lookup exception handler
 684   int catch_pco = ret_pc - nm-&gt;code_begin();
 685 
 686   ExceptionHandlerTable table(nm);
 687   HandlerTableEntry *t = table.entry_for(catch_pco, handler_bci, scope_depth);
 688   if (t == NULL &amp;&amp; (nm-&gt;is_compiled_by_c1() || handler_bci != -1)) {
 689     // Allow abbreviated catch tables.  The idea is to allow a method
 690     // to materialize its exceptions without committing to the exact
 691     // routing of exceptions.  In particular this is needed for adding
 692     // a synthetic handler to unlock monitors when inlining
 693     // synchronized methods since the unlock path isn&#39;t represented in
 694     // the bytecodes.
 695     t = table.entry_for(catch_pco, -1, 0);
 696   }
 697 
 698 #ifdef COMPILER1
 699   if (t == NULL &amp;&amp; nm-&gt;is_compiled_by_c1()) {
 700     assert(nm-&gt;unwind_handler_begin() != NULL, &quot;&quot;);
 701     return nm-&gt;unwind_handler_begin();
 702   }
 703 #endif
 704 
 705   if (t == NULL) {
 706     ttyLocker ttyl;
 707     tty-&gt;print_cr(&quot;MISSING EXCEPTION HANDLER for pc &quot; INTPTR_FORMAT &quot; and handler bci %d, catch_pco: %d&quot;, p2i(ret_pc), handler_bci, catch_pco);
 708     tty-&gt;print_cr(&quot;   Exception:&quot;);
 709     exception-&gt;print();
 710     tty-&gt;cr();
 711     tty-&gt;print_cr(&quot; Compiled exception table :&quot;);
 712     table.print();
 713     nm-&gt;print();
 714     // nm-&gt;print_code();
 715     guarantee(false, &quot;missing exception handler&quot;);
 716     return NULL;
 717   }
 718 
 719   return nm-&gt;code_begin() + t-&gt;pco();
 720 }
 721 
 722 JRT_ENTRY(void, SharedRuntime::throw_AbstractMethodError(JavaThread* thread))
 723   // These errors occur only at call sites
 724   throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_AbstractMethodError());
 725 JRT_END
 726 
 727 JRT_ENTRY(void, SharedRuntime::throw_IncompatibleClassChangeError(JavaThread* thread))
 728   // These errors occur only at call sites
 729   throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_IncompatibleClassChangeError(), &quot;vtable stub&quot;);
 730 JRT_END
 731 
 732 JRT_ENTRY(void, SharedRuntime::throw_ArithmeticException(JavaThread* thread))
 733   throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_ArithmeticException(), &quot;/ by zero&quot;);
 734 JRT_END
 735 
 736 JRT_ENTRY(void, SharedRuntime::throw_NullPointerException(JavaThread* thread))
 737   throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_NullPointerException());
 738 JRT_END
 739 
 740 JRT_ENTRY(void, SharedRuntime::throw_NullPointerException_at_call(JavaThread* thread))
 741   // This entry point is effectively only used for NullPointerExceptions which occur at inline
 742   // cache sites (when the callee activation is not yet set up) so we are at a call site
 743   throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_NullPointerException());
 744 JRT_END
 745 
 746 JRT_ENTRY(void, SharedRuntime::throw_StackOverflowError(JavaThread* thread))
 747   throw_StackOverflowError_common(thread, false);
 748 JRT_END
 749 
 750 JRT_ENTRY(void, SharedRuntime::throw_delayed_StackOverflowError(JavaThread* thread))
 751   throw_StackOverflowError_common(thread, true);
 752 JRT_END
 753 
 754 void SharedRuntime::throw_StackOverflowError_common(JavaThread* thread, bool delayed) {
 755   // We avoid using the normal exception construction in this case because
 756   // it performs an upcall to Java, and we&#39;re already out of stack space.
 757   Thread* THREAD = thread;
 758   Klass* k = SystemDictionary::StackOverflowError_klass();
 759   oop exception_oop = InstanceKlass::cast(k)-&gt;allocate_instance(CHECK);
 760   if (delayed) {
 761     java_lang_Throwable::set_message(exception_oop,
 762                                      Universe::delayed_stack_overflow_error_message());
 763   }
 764   Handle exception (thread, exception_oop);
 765   if (StackTraceInThrowable) {
 766     java_lang_Throwable::fill_in_stack_trace(exception);
 767   }
 768   // Increment counter for hs_err file reporting
 769   Atomic::inc(&amp;Exceptions::_stack_overflow_errors);
 770   throw_and_post_jvmti_exception(thread, exception);
 771 }
 772 
 773 address SharedRuntime::continuation_for_implicit_exception(JavaThread* thread,
 774                                                            address pc,
 775                                                            ImplicitExceptionKind exception_kind)
 776 {
 777   address target_pc = NULL;
 778 
 779   if (Interpreter::contains(pc)) {
 780     switch (exception_kind) {
 781       case IMPLICIT_NULL:           return Interpreter::throw_NullPointerException_entry();
 782       case IMPLICIT_DIVIDE_BY_ZERO: return Interpreter::throw_ArithmeticException_entry();
 783       case STACK_OVERFLOW:          return Interpreter::throw_StackOverflowError_entry();
 784       default:                      ShouldNotReachHere();
 785     }
 786   } else {
 787     switch (exception_kind) {
 788       case STACK_OVERFLOW: {
 789         // Stack overflow only occurs upon frame setup; the callee is
 790         // going to be unwound. Dispatch to a shared runtime stub
 791         // which will cause the StackOverflowError to be fabricated
 792         // and processed.
 793         // Stack overflow should never occur during deoptimization:
 794         // the compiled method bangs the stack by as much as the
 795         // interpreter would need in case of a deoptimization. The
 796         // deoptimization blob and uncommon trap blob bang the stack
 797         // in a debug VM to verify the correctness of the compiled
 798         // method stack banging.
 799         assert(thread-&gt;deopt_mark() == NULL, &quot;no stack overflow from deopt blob/uncommon trap&quot;);
 800         Events::log_exception(thread, &quot;StackOverflowError at &quot; INTPTR_FORMAT, p2i(pc));
 801         return StubRoutines::throw_StackOverflowError_entry();
 802       }
 803 
 804       case IMPLICIT_NULL: {
 805         if (VtableStubs::contains(pc)) {
 806           // We haven&#39;t yet entered the callee frame. Fabricate an
 807           // exception and begin dispatching it in the caller. Since
 808           // the caller was at a call site, it&#39;s safe to destroy all
 809           // caller-saved registers, as these entry points do.
 810           VtableStub* vt_stub = VtableStubs::stub_containing(pc);
 811 
 812           // If vt_stub is NULL, then return NULL to signal handler to report the SEGV error.
 813           if (vt_stub == NULL) return NULL;
 814 
 815           if (vt_stub-&gt;is_abstract_method_error(pc)) {
 816             assert(!vt_stub-&gt;is_vtable_stub(), &quot;should never see AbstractMethodErrors from vtable-type VtableStubs&quot;);
 817             Events::log_exception(thread, &quot;AbstractMethodError at &quot; INTPTR_FORMAT, p2i(pc));
 818             // Instead of throwing the abstract method error here directly, we re-resolve
 819             // and will throw the AbstractMethodError during resolve. As a result, we&#39;ll
 820             // get a more detailed error message.
 821             return SharedRuntime::get_handle_wrong_method_stub();
 822           } else {
 823             Events::log_exception(thread, &quot;NullPointerException at vtable entry &quot; INTPTR_FORMAT, p2i(pc));
 824             // Assert that the signal comes from the expected location in stub code.
 825             assert(vt_stub-&gt;is_null_pointer_exception(pc),
 826                    &quot;obtained signal from unexpected location in stub code&quot;);
 827             return StubRoutines::throw_NullPointerException_at_call_entry();
 828           }
 829         } else {
 830           CodeBlob* cb = CodeCache::find_blob(pc);
 831 
 832           // If code blob is NULL, then return NULL to signal handler to report the SEGV error.
 833           if (cb == NULL) return NULL;
 834 
 835           // Exception happened in CodeCache. Must be either:
 836           // 1. Inline-cache check in C2I handler blob,
 837           // 2. Inline-cache check in nmethod, or
 838           // 3. Implicit null exception in nmethod
 839 
 840           if (!cb-&gt;is_compiled()) {
 841             bool is_in_blob = cb-&gt;is_adapter_blob() || cb-&gt;is_method_handles_adapter_blob();
 842             if (!is_in_blob) {
 843               // Allow normal crash reporting to handle this
 844               return NULL;
 845             }
 846             Events::log_exception(thread, &quot;NullPointerException in code blob at &quot; INTPTR_FORMAT, p2i(pc));
 847             // There is no handler here, so we will simply unwind.
 848             return StubRoutines::throw_NullPointerException_at_call_entry();
 849           }
 850 
 851           // Otherwise, it&#39;s a compiled method.  Consult its exception handlers.
 852           CompiledMethod* cm = (CompiledMethod*)cb;
 853           if (cm-&gt;inlinecache_check_contains(pc)) {
 854             // exception happened inside inline-cache check code
 855             // =&gt; the nmethod is not yet active (i.e., the frame
 856             // is not set up yet) =&gt; use return address pushed by
 857             // caller =&gt; don&#39;t push another return address
 858             Events::log_exception(thread, &quot;NullPointerException in IC check &quot; INTPTR_FORMAT, p2i(pc));
 859             return StubRoutines::throw_NullPointerException_at_call_entry();
 860           }
 861 
 862           if (cm-&gt;method()-&gt;is_method_handle_intrinsic()) {
 863             // exception happened inside MH dispatch code, similar to a vtable stub
 864             Events::log_exception(thread, &quot;NullPointerException in MH adapter &quot; INTPTR_FORMAT, p2i(pc));
 865             return StubRoutines::throw_NullPointerException_at_call_entry();
 866           }
 867 
 868 #ifndef PRODUCT
 869           _implicit_null_throws++;
 870 #endif
 871           target_pc = cm-&gt;continuation_for_implicit_null_exception(pc);
 872           // If there&#39;s an unexpected fault, target_pc might be NULL,
 873           // in which case we want to fall through into the normal
 874           // error handling code.
 875         }
 876 
 877         break; // fall through
 878       }
 879 
 880 
 881       case IMPLICIT_DIVIDE_BY_ZERO: {
 882         CompiledMethod* cm = CodeCache::find_compiled(pc);
 883         guarantee(cm != NULL, &quot;must have containing compiled method for implicit division-by-zero exceptions&quot;);
 884 #ifndef PRODUCT
 885         _implicit_div0_throws++;
 886 #endif
 887         target_pc = cm-&gt;continuation_for_implicit_div0_exception(pc);
 888         // If there&#39;s an unexpected fault, target_pc might be NULL,
 889         // in which case we want to fall through into the normal
 890         // error handling code.
 891         break; // fall through
 892       }
 893 
 894       default: ShouldNotReachHere();
 895     }
 896 
 897     assert(exception_kind == IMPLICIT_NULL || exception_kind == IMPLICIT_DIVIDE_BY_ZERO, &quot;wrong implicit exception kind&quot;);
 898 
 899     if (exception_kind == IMPLICIT_NULL) {
 900 #ifndef PRODUCT
 901       // for AbortVMOnException flag
 902       Exceptions::debug_check_abort(&quot;java.lang.NullPointerException&quot;);
 903 #endif //PRODUCT
 904       Events::log_exception(thread, &quot;Implicit null exception at &quot; INTPTR_FORMAT &quot; to &quot; INTPTR_FORMAT, p2i(pc), p2i(target_pc));
 905     } else {
 906 #ifndef PRODUCT
 907       // for AbortVMOnException flag
 908       Exceptions::debug_check_abort(&quot;java.lang.ArithmeticException&quot;);
 909 #endif //PRODUCT
 910       Events::log_exception(thread, &quot;Implicit division by zero exception at &quot; INTPTR_FORMAT &quot; to &quot; INTPTR_FORMAT, p2i(pc), p2i(target_pc));
 911     }
 912     return target_pc;
 913   }
 914 
 915   ShouldNotReachHere();
 916   return NULL;
 917 }
 918 
 919 
 920 /**
 921  * Throws an java/lang/UnsatisfiedLinkError.  The address of this method is
 922  * installed in the native function entry of all native Java methods before
 923  * they get linked to their actual native methods.
 924  *
 925  * \note
 926  * This method actually never gets called!  The reason is because
 927  * the interpreter&#39;s native entries call NativeLookup::lookup() which
 928  * throws the exception when the lookup fails.  The exception is then
 929  * caught and forwarded on the return from NativeLookup::lookup() call
 930  * before the call to the native function.  This might change in the future.
 931  */
 932 JNI_ENTRY(void*, throw_unsatisfied_link_error(JNIEnv* env, ...))
 933 {
 934   // We return a bad value here to make sure that the exception is
 935   // forwarded before we look at the return value.
 936   THROW_(vmSymbols::java_lang_UnsatisfiedLinkError(), (void*)badAddress);
 937 }
 938 JNI_END
 939 
 940 address SharedRuntime::native_method_throw_unsatisfied_link_error_entry() {
 941   return CAST_FROM_FN_PTR(address, &amp;throw_unsatisfied_link_error);
 942 }
 943 
 944 JRT_ENTRY_NO_ASYNC(void, SharedRuntime::register_finalizer(JavaThread* thread, oopDesc* obj))
 945 #if INCLUDE_JVMCI
 946   if (!obj-&gt;klass()-&gt;has_finalizer()) {
 947     return;
 948   }
 949 #endif // INCLUDE_JVMCI
 950   assert(oopDesc::is_oop(obj), &quot;must be a valid oop&quot;);
 951   assert(obj-&gt;klass()-&gt;has_finalizer(), &quot;shouldn&#39;t be here otherwise&quot;);
 952   InstanceKlass::register_finalizer(instanceOop(obj), CHECK);
 953 JRT_END
 954 
 955 
 956 jlong SharedRuntime::get_java_tid(Thread* thread) {
 957   if (thread != NULL) {
 958     if (thread-&gt;is_Java_thread()) {
 959       oop obj = ((JavaThread*)thread)-&gt;threadObj();
 960       return (obj == NULL) ? 0 : java_lang_Thread::thread_id(obj);
 961     }
 962   }
 963   return 0;
 964 }
 965 
 966 /**
 967  * This function ought to be a void function, but cannot be because
 968  * it gets turned into a tail-call on sparc, which runs into dtrace bug
 969  * 6254741.  Once that is fixed we can remove the dummy return value.
 970  */
 971 int SharedRuntime::dtrace_object_alloc(oopDesc* o, int size) {
 972   return dtrace_object_alloc_base(Thread::current(), o, size);
 973 }
 974 
 975 int SharedRuntime::dtrace_object_alloc_base(Thread* thread, oopDesc* o, int size) {
 976   assert(DTraceAllocProbes, &quot;wrong call&quot;);
 977   Klass* klass = o-&gt;klass();
 978   Symbol* name = klass-&gt;name();
 979   HOTSPOT_OBJECT_ALLOC(
 980                    get_java_tid(thread),
 981                    (char *) name-&gt;bytes(), name-&gt;utf8_length(), size * HeapWordSize);
 982   return 0;
 983 }
 984 
 985 JRT_LEAF(int, SharedRuntime::dtrace_method_entry(
 986     JavaThread* thread, Method* method))
 987   assert(DTraceMethodProbes, &quot;wrong call&quot;);
 988   Symbol* kname = method-&gt;klass_name();
 989   Symbol* name = method-&gt;name();
 990   Symbol* sig = method-&gt;signature();
 991   HOTSPOT_METHOD_ENTRY(
 992       get_java_tid(thread),
 993       (char *) kname-&gt;bytes(), kname-&gt;utf8_length(),
 994       (char *) name-&gt;bytes(), name-&gt;utf8_length(),
 995       (char *) sig-&gt;bytes(), sig-&gt;utf8_length());
 996   return 0;
 997 JRT_END
 998 
 999 JRT_LEAF(int, SharedRuntime::dtrace_method_exit(
1000     JavaThread* thread, Method* method))
1001   assert(DTraceMethodProbes, &quot;wrong call&quot;);
1002   Symbol* kname = method-&gt;klass_name();
1003   Symbol* name = method-&gt;name();
1004   Symbol* sig = method-&gt;signature();
1005   HOTSPOT_METHOD_RETURN(
1006       get_java_tid(thread),
1007       (char *) kname-&gt;bytes(), kname-&gt;utf8_length(),
1008       (char *) name-&gt;bytes(), name-&gt;utf8_length(),
1009       (char *) sig-&gt;bytes(), sig-&gt;utf8_length());
1010   return 0;
1011 JRT_END
1012 
1013 
1014 // Finds receiver, CallInfo (i.e. receiver method), and calling bytecode)
1015 // for a call current in progress, i.e., arguments has been pushed on stack
1016 // put callee has not been invoked yet.  Used by: resolve virtual/static,
1017 // vtable updates, etc.  Caller frame must be compiled.
1018 Handle SharedRuntime::find_callee_info(JavaThread* thread, Bytecodes::Code&amp; bc, CallInfo&amp; callinfo, TRAPS) {
1019   ResourceMark rm(THREAD);
1020 
1021   // last java frame on stack (which includes native call frames)
1022   vframeStream vfst(thread, true);  // Do not skip and javaCalls
1023 
1024   return find_callee_info_helper(thread, vfst, bc, callinfo, THREAD);
1025 }
1026 
1027 Method* SharedRuntime::extract_attached_method(vframeStream&amp; vfst) {
1028   CompiledMethod* caller = vfst.nm();
1029 
1030   nmethodLocker caller_lock(caller);
1031 
1032   address pc = vfst.frame_pc();
1033   { // Get call instruction under lock because another thread may be busy patching it.
1034     CompiledICLocker ic_locker(caller);
1035     return caller-&gt;attached_method_before_pc(pc);
1036   }
1037   return NULL;
1038 }
1039 
1040 // Finds receiver, CallInfo (i.e. receiver method), and calling bytecode
1041 // for a call current in progress, i.e., arguments has been pushed on stack
1042 // but callee has not been invoked yet.  Caller frame must be compiled.
1043 Handle SharedRuntime::find_callee_info_helper(JavaThread* thread,
1044                                               vframeStream&amp; vfst,
1045                                               Bytecodes::Code&amp; bc,
1046                                               CallInfo&amp; callinfo, TRAPS) {
1047   Handle receiver;
1048   Handle nullHandle;  //create a handy null handle for exception returns
1049 
1050   assert(!vfst.at_end(), &quot;Java frame must exist&quot;);
1051 
1052   // Find caller and bci from vframe
1053   methodHandle caller(THREAD, vfst.method());
1054   int          bci   = vfst.bci();
1055 
1056   if (caller-&gt;is_continuation_enter_intrinsic()) {
1057     bc = Bytecodes::_invokestatic;
1058     LinkResolver::resolve_continuation_enter(callinfo, CHECK_NH);
1059     return receiver;
1060   }
1061 
1062   Bytecode_invoke bytecode(caller, bci);
1063   int bytecode_index = bytecode.index();
1064   bc = bytecode.invoke_code();
1065 
1066   methodHandle attached_method(THREAD, extract_attached_method(vfst));
1067   if (attached_method.not_null()) {
1068     Method* callee = bytecode.static_target(CHECK_NH);
1069     vmIntrinsics::ID id = callee-&gt;intrinsic_id();
1070     // When VM replaces MH.invokeBasic/linkTo* call with a direct/virtual call,
1071     // it attaches statically resolved method to the call site.
1072     if (MethodHandles::is_signature_polymorphic(id) &amp;&amp;
1073         MethodHandles::is_signature_polymorphic_intrinsic(id)) {
1074       bc = MethodHandles::signature_polymorphic_intrinsic_bytecode(id);
1075 
1076       // Adjust invocation mode according to the attached method.
1077       switch (bc) {
1078         case Bytecodes::_invokevirtual:
1079           if (attached_method-&gt;method_holder()-&gt;is_interface()) {
1080             bc = Bytecodes::_invokeinterface;
1081           }
1082           break;
1083         case Bytecodes::_invokeinterface:
1084           if (!attached_method-&gt;method_holder()-&gt;is_interface()) {
1085             bc = Bytecodes::_invokevirtual;
1086           }
1087           break;
1088         case Bytecodes::_invokehandle:
1089           if (!MethodHandles::is_signature_polymorphic_method(attached_method())) {
1090             bc = attached_method-&gt;is_static() ? Bytecodes::_invokestatic
1091                                               : Bytecodes::_invokevirtual;
1092           }
1093           break;
1094         default:
1095           break;
1096       }
1097     }
1098   }
1099 
1100   assert(bc != Bytecodes::_illegal, &quot;not initialized&quot;);
1101 
1102   bool has_receiver = bc != Bytecodes::_invokestatic &amp;&amp;
1103                       bc != Bytecodes::_invokedynamic &amp;&amp;
1104                       bc != Bytecodes::_invokehandle;
1105 
1106   // Find receiver for non-static call
1107   if (has_receiver) {
1108     // This register map must be update since we need to find the receiver for
1109     // compiled frames. The receiver might be in a register.
1110     RegisterMap reg_map2(thread);
1111     frame stubFrame   = thread-&gt;last_frame();
1112     // Caller-frame is a compiled frame
1113     frame callerFrame = stubFrame.sender(&amp;reg_map2);
1114 
1115     if (attached_method.is_null()) {
1116       Method* callee = bytecode.static_target(CHECK_NH);
1117       if (callee == NULL) {
1118         THROW_(vmSymbols::java_lang_NoSuchMethodException(), nullHandle);
1119       }
1120     }
1121 
1122     // Retrieve from a compiled argument list
1123     receiver = Handle(THREAD, callerFrame.retrieve_receiver(&amp;reg_map2));
1124 
1125     if (receiver.is_null()) {
1126       THROW_(vmSymbols::java_lang_NullPointerException(), nullHandle);
1127     }
1128   }
1129 
1130   // Resolve method
1131   if (attached_method.not_null()) {
1132     // Parameterized by attached method.
1133     LinkResolver::resolve_invoke(callinfo, receiver, attached_method, bc, CHECK_NH);
1134   } else {
1135     // Parameterized by bytecode.
1136     constantPoolHandle constants(THREAD, caller-&gt;constants());
1137     LinkResolver::resolve_invoke(callinfo, receiver, constants, bytecode_index, bc, CHECK_NH);
1138   }
1139 
1140 #ifdef ASSERT
1141   // Check that the receiver klass is of the right subtype and that it is initialized for virtual calls
1142   if (has_receiver) {
1143     assert(receiver.not_null(), &quot;should have thrown exception&quot;);
1144     Klass* receiver_klass = receiver-&gt;klass();
1145     Klass* rk = NULL;
1146     if (attached_method.not_null()) {
1147       // In case there&#39;s resolved method attached, use its holder during the check.
1148       rk = attached_method-&gt;method_holder();
1149     } else {
1150       // Klass is already loaded.
1151       constantPoolHandle constants(THREAD, caller-&gt;constants());
1152       rk = constants-&gt;klass_ref_at(bytecode_index, CHECK_NH);
1153     }
1154     Klass* static_receiver_klass = rk;
1155     assert(receiver_klass-&gt;is_subtype_of(static_receiver_klass),
1156            &quot;actual receiver must be subclass of static receiver klass&quot;);
1157     if (receiver_klass-&gt;is_instance_klass()) {
1158       if (InstanceKlass::cast(receiver_klass)-&gt;is_not_initialized()) {
1159         tty-&gt;print_cr(&quot;ERROR: Klass not yet initialized!!&quot;);
1160         receiver_klass-&gt;print();
1161       }
1162       assert(!InstanceKlass::cast(receiver_klass)-&gt;is_not_initialized(), &quot;receiver_klass must be initialized&quot;);
1163     }
1164   }
1165 #endif
1166 
1167   return receiver;
1168 }
1169 
1170 methodHandle SharedRuntime::find_callee_method(JavaThread* thread, TRAPS) {
1171   ResourceMark rm(THREAD);
1172   // We need first to check if any Java activations (compiled, interpreted)
1173   // exist on the stack since last JavaCall.  If not, we need
1174   // to get the target method from the JavaCall wrapper.
1175   vframeStream vfst(thread, true);  // Do not skip any javaCalls
1176   methodHandle callee_method;
1177   if (vfst.at_end()) {
1178     // No Java frames were found on stack since we did the JavaCall.
1179     // Hence the stack can only contain an entry_frame.  We need to
1180     // find the target method from the stub frame.
1181     RegisterMap reg_map(thread, false);
1182     frame fr = thread-&gt;last_frame();
1183     assert(fr.is_runtime_frame(), &quot;must be a runtimeStub&quot;);
1184     fr = fr.sender(&amp;reg_map);
1185     assert(fr.is_entry_frame(), &quot;must be&quot;);
1186     // fr is now pointing to the entry frame.
1187     callee_method = methodHandle(THREAD, fr.entry_frame_call_wrapper()-&gt;callee_method());
1188   } else {
1189     Bytecodes::Code bc;
1190     CallInfo callinfo;
1191     find_callee_info_helper(thread, vfst, bc, callinfo, CHECK_(methodHandle()));
1192     callee_method = methodHandle(THREAD, callinfo.selected_method());
1193   }
1194   assert(callee_method()-&gt;is_method(), &quot;must be&quot;);
1195   return callee_method;
1196 }
1197 
1198 // Resolves a call.
1199 methodHandle SharedRuntime::resolve_helper(JavaThread *thread,
1200                                            bool is_virtual,
1201                                            bool is_optimized, TRAPS) {
1202   methodHandle callee_method;
1203   callee_method = resolve_sub_helper(thread, is_virtual, is_optimized, THREAD);
1204   if (JvmtiExport::can_hotswap_or_post_breakpoint()) {
1205     int retry_count = 0;
1206     while (!HAS_PENDING_EXCEPTION &amp;&amp; callee_method-&gt;is_old() &amp;&amp;
1207            callee_method-&gt;method_holder() != SystemDictionary::Object_klass()) {
1208       // If has a pending exception then there is no need to re-try to
1209       // resolve this method.
1210       // If the method has been redefined, we need to try again.
1211       // Hack: we have no way to update the vtables of arrays, so don&#39;t
1212       // require that java.lang.Object has been updated.
1213 
1214       // It is very unlikely that method is redefined more than 100 times
1215       // in the middle of resolve. If it is looping here more than 100 times
1216       // means then there could be a bug here.
1217       guarantee((retry_count++ &lt; 100),
1218                 &quot;Could not resolve to latest version of redefined method&quot;);
1219       // method is redefined in the middle of resolve so re-try.
1220       callee_method = resolve_sub_helper(thread, is_virtual, is_optimized, THREAD);
1221     }
1222   }
1223   return callee_method;
1224 }
1225 
1226 // This fails if resolution required refilling of IC stubs
1227 bool SharedRuntime::resolve_sub_helper_internal(methodHandle callee_method, const frame&amp; caller_frame,
1228                                                 CompiledMethod* caller_nm, bool is_virtual, bool is_optimized,
1229                                                 Handle receiver, CallInfo&amp; call_info, Bytecodes::Code invoke_code, TRAPS) {
1230   StaticCallInfo static_call_info;
1231   CompiledICInfo virtual_call_info;
1232 
1233   // Make sure the callee nmethod does not get deoptimized and removed before
1234   // we are done patching the code.
1235   CompiledMethod* callee = callee_method-&gt;code();
1236 
1237   if (callee != NULL) {
1238     assert(callee-&gt;is_compiled(), &quot;must be nmethod for patching&quot;);
1239   }
1240 
1241   if (callee != NULL &amp;&amp; !callee-&gt;is_in_use()) {
1242     // Patch call site to C2I adapter if callee nmethod is deoptimized or unloaded.
1243     callee = NULL;
1244   }
1245   nmethodLocker nl_callee(callee);
1246 #ifdef ASSERT
1247   address dest_entry_point = callee == NULL ? 0 : callee-&gt;entry_point(); // used below
1248 #endif
1249 
1250   bool is_nmethod = caller_nm-&gt;is_nmethod();
1251 
1252   if (is_virtual) {
1253     assert(receiver.not_null() || invoke_code == Bytecodes::_invokehandle, &quot;sanity check&quot;);
1254     bool static_bound = call_info.resolved_method()-&gt;can_be_statically_bound();
1255     Klass* klass = invoke_code == Bytecodes::_invokehandle ? NULL : receiver-&gt;klass();
1256     CompiledIC::compute_monomorphic_entry(callee_method, klass,
1257                      is_optimized, static_bound, is_nmethod, virtual_call_info,
1258                      CHECK_false);
1259   } else {
1260     // static call
1261     CompiledStaticCall::compute_entry(callee_method, is_nmethod, static_call_info);
1262   }
1263 
1264   // grab lock, check for deoptimization and potentially patch caller
1265   {
1266     CompiledICLocker ml(caller_nm);
1267 
1268     // Lock blocks for safepoint during which both nmethods can change state.
1269 
1270     // Now that we are ready to patch if the Method* was redefined then
1271     // don&#39;t update call site and let the caller retry.
1272     // Don&#39;t update call site if callee nmethod was unloaded or deoptimized.
1273     // Don&#39;t update call site if callee nmethod was replaced by an other nmethod
1274     // which may happen when multiply alive nmethod (tiered compilation)
1275     // will be supported.
1276     if (!callee_method-&gt;is_old() &amp;&amp;
1277         (callee == NULL || (callee-&gt;is_in_use() &amp;&amp; callee_method-&gt;code() == callee))) {
1278       NoSafepointVerifier nsv;
1279 #ifdef ASSERT
1280       // We must not try to patch to jump to an already unloaded method.
1281       if (dest_entry_point != 0) {
1282         CodeBlob* cb = CodeCache::find_blob(dest_entry_point);
1283         assert((cb != NULL) &amp;&amp; cb-&gt;is_compiled() &amp;&amp; (((CompiledMethod*)cb) == callee),
1284                &quot;should not call unloaded nmethod&quot;);
1285       }
1286 #endif
1287       if (is_virtual) {
1288         CompiledIC* inline_cache = CompiledIC_before(caller_nm, caller_frame.pc());
1289         if (inline_cache-&gt;is_clean()) {
1290           if (!inline_cache-&gt;set_to_monomorphic(virtual_call_info)) {
1291             return false;
1292           }
1293         }
1294       } else {
1295         if (VM_Version::supports_fast_class_init_checks() &amp;&amp;
1296             invoke_code == Bytecodes::_invokestatic &amp;&amp;
1297             callee_method-&gt;needs_clinit_barrier() &amp;&amp;
1298             callee != NULL &amp;&amp; (callee-&gt;is_compiled_by_jvmci() || callee-&gt;is_aot())) {
1299           return true; // skip patching for JVMCI or AOT code
1300         }
1301         CompiledStaticCall* ssc = caller_nm-&gt;compiledStaticCall_before(caller_frame.pc());
1302         if (ssc-&gt;is_clean()) ssc-&gt;set(static_call_info);
1303       }
1304     }
1305   } // unlock CompiledICLocker
1306   return true;
1307 }
1308 
1309 // Resolves a call.  The compilers generate code for calls that go here
1310 // and are patched with the real destination of the call.
1311 methodHandle SharedRuntime::resolve_sub_helper(JavaThread *thread,
1312                                                bool is_virtual,
1313                                                bool is_optimized, TRAPS) {
1314 
1315   ResourceMark rm(thread);
1316   RegisterMap cbl_map(thread, false);
1317   frame caller_frame = thread-&gt;last_frame().sender(&amp;cbl_map);
1318 
1319   CodeBlob* caller_cb = caller_frame.cb();
1320   guarantee(caller_cb != NULL &amp;&amp; caller_cb-&gt;is_compiled(), &quot;must be called from compiled method&quot;);
1321   CompiledMethod* caller_nm = caller_cb-&gt;as_compiled_method_or_null();
1322 
1323   // make sure caller is not getting deoptimized
1324   // and removed before we are done with it.
1325   // CLEANUP - with lazy deopt shouldn&#39;t need this lock
1326   nmethodLocker caller_lock(caller_nm);
1327 
1328   // determine call info &amp; receiver
1329   // note: a) receiver is NULL for static calls
1330   //       b) an exception is thrown if receiver is NULL for non-static calls
1331   CallInfo call_info;
1332   Bytecodes::Code invoke_code = Bytecodes::_illegal;
1333   Handle receiver = find_callee_info(thread, invoke_code,
1334                                      call_info, CHECK_(methodHandle()));
1335   methodHandle callee_method(THREAD, call_info.selected_method());
1336 
1337   assert((!is_virtual &amp;&amp; invoke_code == Bytecodes::_invokestatic ) ||
1338          (!is_virtual &amp;&amp; invoke_code == Bytecodes::_invokespecial) ||
1339          (!is_virtual &amp;&amp; invoke_code == Bytecodes::_invokehandle ) ||
1340          (!is_virtual &amp;&amp; invoke_code == Bytecodes::_invokedynamic) ||
1341          ( is_virtual &amp;&amp; invoke_code != Bytecodes::_invokestatic ), &quot;inconsistent bytecode&quot;);
1342 
1343   assert(caller_nm-&gt;is_alive() &amp;&amp; !caller_nm-&gt;is_unloading(), &quot;It should be alive&quot;);
1344 
1345 #ifndef PRODUCT
1346   // tracing/debugging/statistics
1347   int *addr = (is_optimized) ? (&amp;_resolve_opt_virtual_ctr) :
1348                 (is_virtual) ? (&amp;_resolve_virtual_ctr) :
1349                                (&amp;_resolve_static_ctr);
1350   Atomic::inc(addr);
1351 
1352   if (TraceCallFixup) {
1353     ResourceMark rm(thread);
1354     tty-&gt;print(&quot;resolving %s%s (%s) call to&quot;,
1355       (is_optimized) ? &quot;optimized &quot; : &quot;&quot;, (is_virtual) ? &quot;virtual&quot; : &quot;static&quot;,
1356       Bytecodes::name(invoke_code));
1357     callee_method-&gt;print_short_name(tty);
1358     tty-&gt;print_cr(&quot; at pc: &quot; INTPTR_FORMAT &quot; to code: &quot; INTPTR_FORMAT,
1359                   p2i(caller_frame.pc()), p2i(callee_method-&gt;code()));
1360   }
1361 #endif
1362 
1363   if (invoke_code == Bytecodes::_invokestatic) {
1364     assert(callee_method-&gt;method_holder()-&gt;is_initialized() ||
1365            callee_method-&gt;method_holder()-&gt;is_reentrant_initialization(thread),
1366            &quot;invalid class initialization state for invoke_static&quot;);
1367     if (!VM_Version::supports_fast_class_init_checks() &amp;&amp; callee_method-&gt;needs_clinit_barrier()) {
1368       // In order to keep class initialization check, do not patch call
1369       // site for static call when the class is not fully initialized.
1370       // Proper check is enforced by call site re-resolution on every invocation.
1371       //
1372       // When fast class initialization checks are supported (VM_Version::supports_fast_class_init_checks() == true),
1373       // explicit class initialization check is put in nmethod entry (VEP).
1374       assert(callee_method-&gt;method_holder()-&gt;is_linked(), &quot;must be&quot;);
1375       return callee_method;
1376     }
1377   }
1378 
1379   // JSR 292 key invariant:
1380   // If the resolved method is a MethodHandle invoke target, the call
1381   // site must be a MethodHandle call site, because the lambda form might tail-call
1382   // leaving the stack in a state unknown to either caller or callee
1383   // TODO detune for now but we might need it again
1384 //  assert(!callee_method-&gt;is_compiled_lambda_form() ||
1385 //         caller_nm-&gt;is_method_handle_return(caller_frame.pc()), &quot;must be MH call site&quot;);
1386 
1387   // Compute entry points. This might require generation of C2I converter
1388   // frames, so we cannot be holding any locks here. Furthermore, the
1389   // computation of the entry points is independent of patching the call.  We
1390   // always return the entry-point, but we only patch the stub if the call has
1391   // not been deoptimized.  Return values: For a virtual call this is an
1392   // (cached_oop, destination address) pair. For a static call/optimized
1393   // virtual this is just a destination address.
1394 
1395   // Patching IC caches may fail if we run out if transition stubs.
1396   // We refill the ic stubs then and try again.
1397   for (;;) {
1398     ICRefillVerifier ic_refill_verifier;
1399     bool successful = resolve_sub_helper_internal(callee_method, caller_frame, caller_nm,
1400                                                   is_virtual, is_optimized, receiver,
1401                                                   call_info, invoke_code, CHECK_(methodHandle()));
1402     if (successful) {
1403       return callee_method;
1404     } else {
1405       InlineCacheBuffer::refill_ic_stubs();
1406     }
1407   }
1408 
1409 }
1410 
1411 
1412 // Inline caches exist only in compiled code
1413 JRT_BLOCK_ENTRY(address, SharedRuntime::handle_wrong_method_ic_miss(JavaThread* thread))
1414 #ifdef ASSERT
1415   RegisterMap reg_map(thread, false);
1416   frame stub_frame = thread-&gt;last_frame();
1417   assert(stub_frame.is_runtime_frame(), &quot;sanity check&quot;);
1418   frame caller_frame = stub_frame.sender(&amp;reg_map);
1419   assert(!caller_frame.is_interpreted_frame() &amp;&amp; !caller_frame.is_entry_frame(), &quot;unexpected frame&quot;);
1420 #endif /* ASSERT */
1421 
1422   methodHandle callee_method;
1423   JRT_BLOCK
1424     callee_method = SharedRuntime::handle_ic_miss_helper(thread, CHECK_NULL);
1425     // Return Method* through TLS
1426     thread-&gt;set_vm_result_2(callee_method());
1427   JRT_BLOCK_END
1428   // return compiled code entry point after potential safepoints
1429   assert(callee_method-&gt;verified_code_entry() != NULL, &quot; Jump to zero!&quot;);
1430   return callee_method-&gt;verified_code_entry();
1431 JRT_END
1432 
1433 
1434 // Handle call site that has been made non-entrant
1435 JRT_BLOCK_ENTRY(address, SharedRuntime::handle_wrong_method(JavaThread* thread))
1436   // 6243940 We might end up in here if the callee is deoptimized
1437   // as we race to call it.  We don&#39;t want to take a safepoint if
1438   // the caller was interpreted because the caller frame will look
1439   // interpreted to the stack walkers and arguments are now
1440   // &quot;compiled&quot; so it is much better to make this transition
1441   // invisible to the stack walking code. The i2c path will
1442   // place the callee method in the callee_target. It is stashed
1443   // there because if we try and find the callee by normal means a
1444   // safepoint is possible and have trouble gc&#39;ing the compiled args.
1445   RegisterMap reg_map(thread, false);
1446   frame stub_frame = thread-&gt;last_frame();
1447   assert(stub_frame.is_runtime_frame(), &quot;sanity check&quot;);
1448   frame caller_frame = stub_frame.sender(&amp;reg_map);
1449 
1450   if (caller_frame.is_interpreted_frame() ||
1451       caller_frame.is_entry_frame()) {
1452     Method* callee = thread-&gt;callee_target();
1453     guarantee(callee != NULL &amp;&amp; callee-&gt;is_method(), &quot;bad handshake&quot;);
1454     thread-&gt;set_vm_result_2(callee);
1455     thread-&gt;set_callee_target(NULL);
1456     if (caller_frame.is_entry_frame() &amp;&amp; VM_Version::supports_fast_class_init_checks()) {
1457       // Bypass class initialization checks in c2i when caller is in native.
1458       // JNI calls to static methods don&#39;t have class initialization checks.
1459       // Fast class initialization checks are present in c2i adapters and call into
1460       // SharedRuntime::handle_wrong_method() on the slow path.
1461       //
1462       // JVM upcalls may land here as well, but there&#39;s a proper check present in
1463       // LinkResolver::resolve_static_call (called from JavaCalls::call_static),
1464       // so bypassing it in c2i adapter is benign.
1465       return callee-&gt;get_c2i_no_clinit_check_entry();
1466     } else {
1467       return callee-&gt;get_c2i_entry();
1468     }
1469   }
1470 
1471   // Must be compiled to compiled path which is safe to stackwalk
1472   methodHandle callee_method;
1473   JRT_BLOCK
1474     // Force resolving of caller (if we called from compiled frame)
1475     callee_method = SharedRuntime::reresolve_call_site(thread, CHECK_NULL);
1476     thread-&gt;set_vm_result_2(callee_method());
1477   JRT_BLOCK_END
1478   // return compiled code entry point after potential safepoints
1479   assert(callee_method-&gt;verified_code_entry() != NULL, &quot; Jump to zero!&quot;);
1480   return callee_method-&gt;verified_code_entry();
1481 JRT_END
1482 
1483 // Handle abstract method call
1484 JRT_BLOCK_ENTRY(address, SharedRuntime::handle_wrong_method_abstract(JavaThread* thread))
1485   // Verbose error message for AbstractMethodError.
1486   // Get the called method from the invoke bytecode.
1487   vframeStream vfst(thread, true);
1488   assert(!vfst.at_end(), &quot;Java frame must exist&quot;);
1489   methodHandle caller(thread, vfst.method());
1490   Bytecode_invoke invoke(caller, vfst.bci());
1491   DEBUG_ONLY( invoke.verify(); )
1492 
1493   // Find the compiled caller frame.
1494   RegisterMap reg_map(thread);
1495   frame stubFrame = thread-&gt;last_frame();
1496   assert(stubFrame.is_runtime_frame(), &quot;must be&quot;);
1497   frame callerFrame = stubFrame.sender(&amp;reg_map);
1498   assert(callerFrame.is_compiled_frame(), &quot;must be&quot;);
1499 
1500   // Install exception and return forward entry.
1501   address res = StubRoutines::throw_AbstractMethodError_entry();
1502   JRT_BLOCK
1503     methodHandle callee(thread, invoke.static_target(thread));
1504     if (!callee.is_null()) {
1505       oop recv = callerFrame.retrieve_receiver(&amp;reg_map);
1506       Klass *recv_klass = (recv != NULL) ? recv-&gt;klass() : NULL;
1507       LinkResolver::throw_abstract_method_error(callee, recv_klass, thread);
1508       res = StubRoutines::forward_exception_entry();
1509     }
1510   JRT_BLOCK_END
1511   return res;
1512 JRT_END
1513 
1514 
1515 // resolve a static call and patch code
1516 JRT_BLOCK_ENTRY(address, SharedRuntime::resolve_static_call_C(JavaThread *thread ))
1517   methodHandle callee_method;
1518   JRT_BLOCK
1519     callee_method = SharedRuntime::resolve_helper(thread, false, false, CHECK_NULL);
1520     thread-&gt;set_vm_result_2(callee_method());
1521   JRT_BLOCK_END
1522   // return compiled code entry point after potential safepoints
1523   assert(callee_method-&gt;verified_code_entry() != NULL, &quot; Jump to zero!&quot;);
1524   return callee_method-&gt;verified_code_entry();
1525 JRT_END
1526 
1527 
1528 // resolve virtual call and update inline cache to monomorphic
1529 JRT_BLOCK_ENTRY(address, SharedRuntime::resolve_virtual_call_C(JavaThread *thread ))
1530   methodHandle callee_method;
1531   JRT_BLOCK
1532     callee_method = SharedRuntime::resolve_helper(thread, true, false, CHECK_NULL);
1533     thread-&gt;set_vm_result_2(callee_method());
1534   JRT_BLOCK_END
1535   // return compiled code entry point after potential safepoints
1536   assert(callee_method-&gt;verified_code_entry() != NULL, &quot; Jump to zero!&quot;);
1537   return callee_method-&gt;verified_code_entry();
1538 JRT_END
1539 
1540 
1541 // Resolve a virtual call that can be statically bound (e.g., always
1542 // monomorphic, so it has no inline cache).  Patch code to resolved target.
1543 JRT_BLOCK_ENTRY(address, SharedRuntime::resolve_opt_virtual_call_C(JavaThread *thread))
1544   methodHandle callee_method;
1545   JRT_BLOCK
1546     callee_method = SharedRuntime::resolve_helper(thread, true, true, CHECK_NULL);
1547     thread-&gt;set_vm_result_2(callee_method());
1548   JRT_BLOCK_END
1549   // return compiled code entry point after potential safepoints
1550   assert(callee_method-&gt;verified_code_entry() != NULL, &quot; Jump to zero!&quot;);
1551   return callee_method-&gt;verified_code_entry();
1552 JRT_END
1553 
1554 // The handle_ic_miss_helper_internal function returns false if it failed due
1555 // to either running out of vtable stubs or ic stubs due to IC transitions
1556 // to transitional states. The needs_ic_stub_refill value will be set if
1557 // the failure was due to running out of IC stubs, in which case handle_ic_miss_helper
1558 // refills the IC stubs and tries again.
1559 bool SharedRuntime::handle_ic_miss_helper_internal(Handle receiver, CompiledMethod* caller_nm,
1560                                                    const frame&amp; caller_frame, methodHandle callee_method,
1561                                                    Bytecodes::Code bc, CallInfo&amp; call_info,
1562                                                    bool&amp; needs_ic_stub_refill, TRAPS) {
1563   CompiledICLocker ml(caller_nm);
1564   CompiledIC* inline_cache = CompiledIC_before(caller_nm, caller_frame.pc());
1565   bool should_be_mono = false;
1566   if (inline_cache-&gt;is_optimized()) {
1567     if (TraceCallFixup) {
1568       ResourceMark rm(THREAD);
1569       tty-&gt;print(&quot;OPTIMIZED IC miss (%s) call to&quot;, Bytecodes::name(bc));
1570       callee_method-&gt;print_short_name(tty);
1571       tty-&gt;print_cr(&quot; code: &quot; INTPTR_FORMAT, p2i(callee_method-&gt;code()));
1572     }
1573     should_be_mono = true;
1574   } else if (inline_cache-&gt;is_icholder_call()) {
1575     CompiledICHolder* ic_oop = inline_cache-&gt;cached_icholder();
1576     if (ic_oop != NULL) {
1577       if (!ic_oop-&gt;is_loader_alive()) {
1578         // Deferred IC cleaning due to concurrent class unloading
1579         if (!inline_cache-&gt;set_to_clean()) {
1580           needs_ic_stub_refill = true;
1581           return false;
1582         }
1583       } else if (receiver()-&gt;klass() == ic_oop-&gt;holder_klass()) {
1584         // This isn&#39;t a real miss. We must have seen that compiled code
1585         // is now available and we want the call site converted to a
1586         // monomorphic compiled call site.
1587         // We can&#39;t assert for callee_method-&gt;code() != NULL because it
1588         // could have been deoptimized in the meantime
1589         if (TraceCallFixup) {
1590           ResourceMark rm(THREAD);
1591           tty-&gt;print(&quot;FALSE IC miss (%s) converting to compiled call to&quot;, Bytecodes::name(bc));
1592           callee_method-&gt;print_short_name(tty);
1593           tty-&gt;print_cr(&quot; code: &quot; INTPTR_FORMAT, p2i(callee_method-&gt;code()));
1594         }
1595         should_be_mono = true;
1596       }
1597     }
1598   }
1599 
1600   if (should_be_mono) {
1601     // We have a path that was monomorphic but was going interpreted
1602     // and now we have (or had) a compiled entry. We correct the IC
1603     // by using a new icBuffer.
1604     CompiledICInfo info;
1605     Klass* receiver_klass = receiver()-&gt;klass();
1606     inline_cache-&gt;compute_monomorphic_entry(callee_method,
1607                                             receiver_klass,
1608                                             inline_cache-&gt;is_optimized(),
1609                                             false, caller_nm-&gt;is_nmethod(),
1610                                             info, CHECK_false);
1611     if (!inline_cache-&gt;set_to_monomorphic(info)) {
1612       needs_ic_stub_refill = true;
1613       return false;
1614     }
1615   } else if (!inline_cache-&gt;is_megamorphic() &amp;&amp; !inline_cache-&gt;is_clean()) {
1616     // Potential change to megamorphic
1617 
1618     bool successful = inline_cache-&gt;set_to_megamorphic(&amp;call_info, bc, needs_ic_stub_refill, CHECK_false);
1619     if (needs_ic_stub_refill) {
1620       return false;
1621     }
1622     if (!successful) {
1623       if (!inline_cache-&gt;set_to_clean()) {
1624         needs_ic_stub_refill = true;
1625         return false;
1626       }
1627     }
1628   } else {
1629     // Either clean or megamorphic
1630   }
1631   return true;
1632 }
1633 
1634 methodHandle SharedRuntime::handle_ic_miss_helper(JavaThread *thread, TRAPS) {
1635   ResourceMark rm(thread);
1636   CallInfo call_info;
1637   Bytecodes::Code bc;
1638 
1639   // receiver is NULL for static calls. An exception is thrown for NULL
1640   // receivers for non-static calls
1641   Handle receiver = find_callee_info(thread, bc, call_info,
1642                                      CHECK_(methodHandle()));
1643   // Compiler1 can produce virtual call sites that can actually be statically bound
1644   // If we fell thru to below we would think that the site was going megamorphic
1645   // when in fact the site can never miss. Worse because we&#39;d think it was megamorphic
1646   // we&#39;d try and do a vtable dispatch however methods that can be statically bound
1647   // don&#39;t have vtable entries (vtable_index &lt; 0) and we&#39;d blow up. So we force a
1648   // reresolution of the  call site (as if we did a handle_wrong_method and not an
1649   // plain ic_miss) and the site will be converted to an optimized virtual call site
1650   // never to miss again. I don&#39;t believe C2 will produce code like this but if it
1651   // did this would still be the correct thing to do for it too, hence no ifdef.
1652   //
1653   if (call_info.resolved_method()-&gt;can_be_statically_bound()) {
1654     methodHandle callee_method = SharedRuntime::reresolve_call_site(thread, CHECK_(methodHandle()));
1655     if (TraceCallFixup) {
1656       RegisterMap reg_map(thread, false);
1657       frame caller_frame = thread-&gt;last_frame().sender(&amp;reg_map);
1658       ResourceMark rm(thread);
1659       tty-&gt;print(&quot;converting IC miss to reresolve (%s) call to&quot;, Bytecodes::name(bc));
1660       callee_method-&gt;print_short_name(tty);
1661       tty-&gt;print_cr(&quot; from pc: &quot; INTPTR_FORMAT, p2i(caller_frame.pc()));
1662       tty-&gt;print_cr(&quot; code: &quot; INTPTR_FORMAT, p2i(callee_method-&gt;code()));
1663     }
1664     return callee_method;
1665   }
1666 
1667   methodHandle callee_method(thread, call_info.selected_method());
1668 
1669 #ifndef PRODUCT
1670   Atomic::inc(&amp;_ic_miss_ctr);
1671 
1672   // Statistics &amp; Tracing
1673   if (TraceCallFixup) {
1674     ResourceMark rm(thread);
1675     tty-&gt;print(&quot;IC miss (%s) call to&quot;, Bytecodes::name(bc));
1676     callee_method-&gt;print_short_name(tty);
1677     tty-&gt;print_cr(&quot; code: &quot; INTPTR_FORMAT, p2i(callee_method-&gt;code()));
1678   }
1679 
1680   if (ICMissHistogram) {
1681     MutexLocker m(VMStatistic_lock);
1682     RegisterMap reg_map(thread, false);
1683     frame f = thread-&gt;last_frame().real_sender(&amp;reg_map);// skip runtime stub
1684     // produce statistics under the lock
1685     trace_ic_miss(f.pc());
1686   }
1687 #endif
1688 
1689   // install an event collector so that when a vtable stub is created the
1690   // profiler can be notified via a DYNAMIC_CODE_GENERATED event. The
1691   // event can&#39;t be posted when the stub is created as locks are held
1692   // - instead the event will be deferred until the event collector goes
1693   // out of scope.
1694   JvmtiDynamicCodeEventCollector event_collector;
1695 
1696   // Update inline cache to megamorphic. Skip update if we are called from interpreted.
1697   // Transitioning IC caches may require transition stubs. If we run out
1698   // of transition stubs, we have to drop locks and perform a safepoint
1699   // that refills them.
1700   RegisterMap reg_map(thread, false);
1701   frame caller_frame = thread-&gt;last_frame().sender(&amp;reg_map);
1702   CodeBlob* cb = caller_frame.cb();
1703   CompiledMethod* caller_nm = cb-&gt;as_compiled_method();
1704 
1705   for (;;) {
1706     ICRefillVerifier ic_refill_verifier;
1707     bool needs_ic_stub_refill = false;
1708     bool successful = handle_ic_miss_helper_internal(receiver, caller_nm, caller_frame, callee_method,
1709                                                      bc, call_info, needs_ic_stub_refill, CHECK_(methodHandle()));
1710     if (successful || !needs_ic_stub_refill) {
1711       return callee_method;
1712     } else {
1713       InlineCacheBuffer::refill_ic_stubs();
1714     }
1715   }
1716 }
1717 
1718 static bool clear_ic_at_addr(CompiledMethod* caller_nm, address call_addr, bool is_static_call) {
1719   CompiledICLocker ml(caller_nm);
1720   if (is_static_call) {
1721     CompiledStaticCall* ssc = caller_nm-&gt;compiledStaticCall_at(call_addr);
1722     if (!ssc-&gt;is_clean()) {
1723       return ssc-&gt;set_to_clean();
1724     }
1725   } else {
1726     // compiled, dispatched call (which used to call an interpreted method)
1727     CompiledIC* inline_cache = CompiledIC_at(caller_nm, call_addr);
1728     if (!inline_cache-&gt;is_clean()) {
1729       return inline_cache-&gt;set_to_clean();
1730     }
1731   }
1732   return true;
1733 }
1734 
1735 //
1736 // Resets a call-site in compiled code so it will get resolved again.
1737 // This routines handles both virtual call sites, optimized virtual call
1738 // sites, and static call sites. Typically used to change a call sites
1739 // destination from compiled to interpreted.
1740 //
1741 methodHandle SharedRuntime::reresolve_call_site(JavaThread *thread, TRAPS) {
1742   ResourceMark rm(thread);
1743   RegisterMap reg_map(thread, false);
1744   frame stub_frame = thread-&gt;last_frame();
1745   assert(stub_frame.is_runtime_frame(), &quot;must be a runtimeStub&quot;);
1746   frame caller = stub_frame.sender(&amp;reg_map);
1747 
1748   // Do nothing if the frame isn&#39;t a live compiled frame.
1749   // nmethod could be deoptimized by the time we get here
1750   // so no update to the caller is needed.
1751 
1752   if (caller.is_compiled_frame() &amp;&amp; !caller.is_deoptimized_frame()) {
1753 
1754     address pc = caller.pc();
1755 
1756     // Check for static or virtual call
1757     bool is_static_call = false;
1758     CompiledMethod* caller_nm = CodeCache::find_compiled(pc);
1759 
1760     // Default call_addr is the location of the &quot;basic&quot; call.
1761     // Determine the address of the call we a reresolving. With
1762     // Inline Caches we will always find a recognizable call.
1763     // With Inline Caches disabled we may or may not find a
1764     // recognizable call. We will always find a call for static
1765     // calls and for optimized virtual calls. For vanilla virtual
1766     // calls it depends on the state of the UseInlineCaches switch.
1767     //
1768     // With Inline Caches disabled we can get here for a virtual call
1769     // for two reasons:
1770     //   1 - calling an abstract method. The vtable for abstract methods
1771     //       will run us thru handle_wrong_method and we will eventually
1772     //       end up in the interpreter to throw the ame.
1773     //   2 - a racing deoptimization. We could be doing a vanilla vtable
1774     //       call and between the time we fetch the entry address and
1775     //       we jump to it the target gets deoptimized. Similar to 1
1776     //       we will wind up in the interprter (thru a c2i with c2).
1777     //
1778     address call_addr = NULL;
1779     {
1780       // Get call instruction under lock because another thread may be
1781       // busy patching it.
1782       CompiledICLocker ml(caller_nm);
1783       // Location of call instruction
1784       call_addr = caller_nm-&gt;call_instruction_address(pc);
1785     }
1786     // Make sure nmethod doesn&#39;t get deoptimized and removed until
1787     // this is done with it.
1788     // CLEANUP - with lazy deopt shouldn&#39;t need this lock
1789     nmethodLocker nmlock(caller_nm);
1790 
1791     if (call_addr != NULL) {
1792       RelocIterator iter(caller_nm, call_addr, call_addr+1);
1793       int ret = iter.next(); // Get item
1794       if (ret) {
1795         assert(iter.addr() == call_addr, &quot;must find call&quot;);
1796         if (iter.type() == relocInfo::static_call_type) {
1797           is_static_call = true;
1798         } else {
1799           assert(iter.type() == relocInfo::virtual_call_type ||
1800                  iter.type() == relocInfo::opt_virtual_call_type
1801                 , &quot;unexpected relocInfo. type&quot;);
1802         }
1803       } else {
1804         assert(!UseInlineCaches, &quot;relocation info. must exist for this address&quot;);
1805       }
1806 
1807       // Cleaning the inline cache will force a new resolve. This is more robust
1808       // than directly setting it to the new destination, since resolving of calls
1809       // is always done through the same code path. (experience shows that it
1810       // leads to very hard to track down bugs, if an inline cache gets updated
1811       // to a wrong method). It should not be performance critical, since the
1812       // resolve is only done once.
1813 
1814       for (;;) {
1815         ICRefillVerifier ic_refill_verifier;
1816         if (!clear_ic_at_addr(caller_nm, call_addr, is_static_call)) {
1817           InlineCacheBuffer::refill_ic_stubs();
1818         } else {
1819           break;
1820         }
1821       }
1822     }
1823   }
1824 
1825   methodHandle callee_method = find_callee_method(thread, CHECK_(methodHandle()));
1826 
1827 
1828 #ifndef PRODUCT
1829   Atomic::inc(&amp;_wrong_method_ctr);
1830 
1831   if (TraceCallFixup) {
1832     ResourceMark rm(thread);
1833     tty-&gt;print(&quot;handle_wrong_method reresolving call to&quot;);
1834     callee_method-&gt;print_short_name(tty);
1835     tty-&gt;print_cr(&quot; code: &quot; INTPTR_FORMAT, p2i(callee_method-&gt;code()));
1836   }
1837 #endif
1838 
1839   return callee_method;
1840 }
1841 
1842 address SharedRuntime::handle_unsafe_access(JavaThread* thread, address next_pc) {
1843   // The faulting unsafe accesses should be changed to throw the error
1844   // synchronously instead. Meanwhile the faulting instruction will be
1845   // skipped over (effectively turning it into a no-op) and an
1846   // asynchronous exception will be raised which the thread will
1847   // handle at a later point. If the instruction is a load it will
1848   // return garbage.
1849 
1850   // Request an async exception.
1851   thread-&gt;set_pending_unsafe_access_error();
1852 
1853   // Return address of next instruction to execute.
1854   return next_pc;
1855 }
1856 
1857 #ifdef ASSERT
1858 void SharedRuntime::check_member_name_argument_is_last_argument(const methodHandle&amp; method,
1859                                                                 const BasicType* sig_bt,
1860                                                                 const VMRegPair* regs) {
1861   ResourceMark rm;
1862   const int total_args_passed = method-&gt;size_of_parameters();
1863   const VMRegPair*    regs_with_member_name = regs;
1864         VMRegPair* regs_without_member_name = NEW_RESOURCE_ARRAY(VMRegPair, total_args_passed - 1);
1865 
1866   const int member_arg_pos = total_args_passed - 1;
1867   assert(member_arg_pos &gt;= 0 &amp;&amp; member_arg_pos &lt; total_args_passed, &quot;oob&quot;);
1868   assert(sig_bt[member_arg_pos] == T_OBJECT, &quot;dispatch argument must be an object&quot;);
1869 
1870   const bool is_outgoing = method-&gt;is_method_handle_intrinsic();
1871   int comp_args_on_stack = java_calling_convention(sig_bt, regs_without_member_name, total_args_passed - 1, is_outgoing);
1872 
1873   for (int i = 0; i &lt; member_arg_pos; i++) {
1874     VMReg a =    regs_with_member_name[i].first();
1875     VMReg b = regs_without_member_name[i].first();
1876     assert(a-&gt;value() == b-&gt;value(), &quot;register allocation mismatch: a=&quot; INTX_FORMAT &quot;, b=&quot; INTX_FORMAT, a-&gt;value(), b-&gt;value());
1877   }
1878   assert(regs_with_member_name[member_arg_pos].first()-&gt;is_valid(), &quot;bad member arg&quot;);
1879 }
1880 #endif
1881 
1882 bool SharedRuntime::should_fixup_call_destination(address destination, address entry_point, address caller_pc, Method* moop, CodeBlob* cb) {
1883   if (destination != entry_point) {
1884     CodeBlob* callee = CodeCache::find_blob(destination);
1885     // callee == cb seems weird. It means calling interpreter thru stub.
1886     if (callee != NULL &amp;&amp; (callee == cb || callee-&gt;is_adapter_blob())) {
1887       // static call or optimized virtual
1888       if (TraceCallFixup) {
1889         tty-&gt;print(&quot;fixup callsite           at &quot; INTPTR_FORMAT &quot; to compiled code for&quot;, p2i(caller_pc));
1890         moop-&gt;print_short_name(tty);
1891         tty-&gt;print_cr(&quot; to &quot; INTPTR_FORMAT, p2i(entry_point));
1892       }
1893       return true;
1894     } else {
1895       if (TraceCallFixup) {
1896         tty-&gt;print(&quot;failed to fixup callsite at &quot; INTPTR_FORMAT &quot; to compiled code for&quot;, p2i(caller_pc));
1897         moop-&gt;print_short_name(tty);
1898         tty-&gt;print_cr(&quot; to &quot; INTPTR_FORMAT, p2i(entry_point));
1899       }
1900       // assert is too strong could also be resolve destinations.
1901       // assert(InlineCacheBuffer::contains(destination) || VtableStubs::contains(destination), &quot;must be&quot;);
1902     }
1903   } else {
1904     if (TraceCallFixup) {
1905       tty-&gt;print(&quot;already patched callsite at &quot; INTPTR_FORMAT &quot; to compiled code for&quot;, p2i(caller_pc));
1906       moop-&gt;print_short_name(tty);
1907       tty-&gt;print_cr(&quot; to &quot; INTPTR_FORMAT, p2i(entry_point));
1908     }
1909   }
1910   return false;
1911 }
1912 
1913 // ---------------------------------------------------------------------------
1914 // We are calling the interpreter via a c2i. Normally this would mean that
1915 // we were called by a compiled method. However we could have lost a race
1916 // where we went int -&gt; i2c -&gt; c2i and so the caller could in fact be
1917 // interpreted. If the caller is compiled we attempt to patch the caller
1918 // so he no longer calls into the interpreter.
1919 JRT_LEAF(void, SharedRuntime::fixup_callers_callsite(Method* method, address caller_pc))
1920   Method* moop(method);
1921 
1922   address entry_point = moop-&gt;from_compiled_entry_no_trampoline();
1923 
1924   // It&#39;s possible that deoptimization can occur at a call site which hasn&#39;t
1925   // been resolved yet, in which case this function will be called from
1926   // an nmethod that has been patched for deopt and we can ignore the
1927   // request for a fixup.
1928   // Also it is possible that we lost a race in that from_compiled_entry
1929   // is now back to the i2c in that case we don&#39;t need to patch and if
1930   // we did we&#39;d leap into space because the callsite needs to use
1931   // &quot;to interpreter&quot; stub in order to load up the Method*. Don&#39;t
1932   // ask me how I know this...
1933 
1934   CodeBlob* cb = CodeCache::find_blob(caller_pc);
1935   if (cb == NULL || !cb-&gt;is_compiled() || entry_point == moop-&gt;get_c2i_entry()) {
1936     return;
1937   }
1938 
1939   // The check above makes sure this is a nmethod.
1940   CompiledMethod* nm = cb-&gt;as_compiled_method_or_null();
1941   assert(nm, &quot;must be&quot;);
1942 
1943   // Get the return PC for the passed caller PC.
1944   address return_pc = caller_pc + frame::pc_return_offset;
1945 
1946   // There is a benign race here. We could be attempting to patch to a compiled
1947   // entry point at the same time the callee is being deoptimized. If that is
1948   // the case then entry_point may in fact point to a c2i and we&#39;d patch the
1949   // call site with the same old data. clear_code will set code() to NULL
1950   // at the end of it. If we happen to see that NULL then we can skip trying
1951   // to patch. If we hit the window where the callee has a c2i in the
1952   // from_compiled_entry and the NULL isn&#39;t present yet then we lose the race
1953   // and patch the code with the same old data. Asi es la vida.
1954 
1955   if (moop-&gt;code() == NULL) return;
1956 
1957   if (nm-&gt;is_in_use()) {
1958     // Expect to find a native call there (unless it was no-inline cache vtable dispatch)
1959     CompiledICLocker ic_locker(nm);
1960     if (NativeCall::is_call_before(return_pc)) {
1961       ResourceMark mark;
1962       NativeCallWrapper* call = nm-&gt;call_wrapper_before(return_pc);
1963       //
1964       // bug 6281185. We might get here after resolving a call site to a vanilla
1965       // virtual call. Because the resolvee uses the verified entry it may then
1966       // see compiled code and attempt to patch the site by calling us. This would
1967       // then incorrectly convert the call site to optimized and its downhill from
1968       // there. If you&#39;re lucky you&#39;ll get the assert in the bugid, if not you&#39;ve
1969       // just made a call site that could be megamorphic into a monomorphic site
1970       // for the rest of its life! Just another racing bug in the life of
1971       // fixup_callers_callsite ...
1972       //
1973       RelocIterator iter(nm, call-&gt;instruction_address(), call-&gt;next_instruction_address());
1974       iter.next();
1975       assert(iter.has_current(), &quot;must have a reloc at java call site&quot;);
1976       relocInfo::relocType typ = iter.reloc()-&gt;type();
1977       if (typ != relocInfo::static_call_type &amp;&amp;
1978            typ != relocInfo::opt_virtual_call_type &amp;&amp;
1979            typ != relocInfo::static_stub_type) {
1980         return;
1981       }
1982       address destination = call-&gt;destination();
1983       if (should_fixup_call_destination(destination, entry_point, caller_pc, moop, cb)) {
1984         call-&gt;set_destination_mt_safe(entry_point);
1985       }
1986     }
1987   }
1988 JRT_END
1989 
1990 
1991 // same as JVM_Arraycopy, but called directly from compiled code
1992 JRT_ENTRY(void, SharedRuntime::slow_arraycopy_C(oopDesc* src,  jint src_pos,
1993                                                 oopDesc* dest, jint dest_pos,
1994                                                 jint length,
1995                                                 JavaThread* thread)) {
1996 #ifndef PRODUCT
1997   _slow_array_copy_ctr++;
1998 #endif
1999   // Check if we have null pointers
2000   if (src == NULL || dest == NULL) {
2001     THROW(vmSymbols::java_lang_NullPointerException());
2002   }
2003   // Do the copy.  The casts to arrayOop are necessary to the copy_array API,
2004   // even though the copy_array API also performs dynamic checks to ensure
2005   // that src and dest are truly arrays (and are conformable).
2006   // The copy_array mechanism is awkward and could be removed, but
2007   // the compilers don&#39;t call this function except as a last resort,
2008   // so it probably doesn&#39;t matter.
2009   src-&gt;klass()-&gt;copy_array((arrayOopDesc*)src, src_pos,
2010                                         (arrayOopDesc*)dest, dest_pos,
2011                                         length, thread);
2012 }
2013 JRT_END
2014 
2015 // The caller of generate_class_cast_message() (or one of its callers)
2016 // must use a ResourceMark in order to correctly free the result.
2017 char* SharedRuntime::generate_class_cast_message(
2018     JavaThread* thread, Klass* caster_klass) {
2019 
2020   // Get target class name from the checkcast instruction
2021   vframeStream vfst(thread, true);
2022   assert(!vfst.at_end(), &quot;Java frame must exist&quot;);
2023   Bytecode_checkcast cc(vfst.method(), vfst.method()-&gt;bcp_from(vfst.bci()));
2024   constantPoolHandle cpool(thread, vfst.method()-&gt;constants());
2025   Klass* target_klass = ConstantPool::klass_at_if_loaded(cpool, cc.index());
2026   Symbol* target_klass_name = NULL;
2027   if (target_klass == NULL) {
2028     // This klass should be resolved, but just in case, get the name in the klass slot.
2029     target_klass_name = cpool-&gt;klass_name_at(cc.index());
2030   }
2031   return generate_class_cast_message(caster_klass, target_klass, target_klass_name);
2032 }
2033 
2034 
2035 // The caller of generate_class_cast_message() (or one of its callers)
2036 // must use a ResourceMark in order to correctly free the result.
2037 char* SharedRuntime::generate_class_cast_message(
2038     Klass* caster_klass, Klass* target_klass, Symbol* target_klass_name) {
2039   const char* caster_name = caster_klass-&gt;external_name();
2040 
2041   assert(target_klass != NULL || target_klass_name != NULL, &quot;one must be provided&quot;);
2042   const char* target_name = target_klass == NULL ? target_klass_name-&gt;as_klass_external_name() :
2043                                                    target_klass-&gt;external_name();
2044 
2045   size_t msglen = strlen(caster_name) + strlen(&quot;class &quot;) + strlen(&quot; cannot be cast to class &quot;) + strlen(target_name) + 1;
2046 
2047   const char* caster_klass_description = &quot;&quot;;
2048   const char* target_klass_description = &quot;&quot;;
2049   const char* klass_separator = &quot;&quot;;
2050   if (target_klass != NULL &amp;&amp; caster_klass-&gt;module() == target_klass-&gt;module()) {
2051     caster_klass_description = caster_klass-&gt;joint_in_module_of_loader(target_klass);
2052   } else {
2053     caster_klass_description = caster_klass-&gt;class_in_module_of_loader();
2054     target_klass_description = (target_klass != NULL) ? target_klass-&gt;class_in_module_of_loader() : &quot;&quot;;
2055     klass_separator = (target_klass != NULL) ? &quot;; &quot; : &quot;&quot;;
2056   }
2057 
2058   // add 3 for parenthesis and preceeding space
2059   msglen += strlen(caster_klass_description) + strlen(target_klass_description) + strlen(klass_separator) + 3;
2060 
2061   char* message = NEW_RESOURCE_ARRAY_RETURN_NULL(char, msglen);
2062   if (message == NULL) {
2063     // Shouldn&#39;t happen, but don&#39;t cause even more problems if it does
2064     message = const_cast&lt;char*&gt;(caster_klass-&gt;external_name());
2065   } else {
2066     jio_snprintf(message,
2067                  msglen,
2068                  &quot;class %s cannot be cast to class %s (%s%s%s)&quot;,
2069                  caster_name,
2070                  target_name,
2071                  caster_klass_description,
2072                  klass_separator,
2073                  target_klass_description
2074                  );
2075   }
2076   return message;
2077 }
2078 
2079 JRT_LEAF(void, SharedRuntime::reguard_yellow_pages())
2080   (void) JavaThread::current()-&gt;reguard_stack();
2081 JRT_END
2082 
2083 void SharedRuntime::monitor_enter_helper(oopDesc* obj, BasicLock* lock, JavaThread* thread) {
2084   if (!SafepointSynchronize::is_synchronizing()) {
2085     // Only try quick_enter() if we&#39;re not trying to reach a safepoint
2086     // so that the calling thread reaches the safepoint more quickly.
2087     if (ObjectSynchronizer::quick_enter(obj, thread, lock)) return;
2088   }
2089   // NO_ASYNC required because an async exception on the state transition destructor
2090   // would leave you with the lock held and it would never be released.
2091   // The normal monitorenter NullPointerException is thrown without acquiring a lock
2092   // and the model is that an exception implies the method failed.
2093   JRT_BLOCK_NO_ASYNC
2094   if (PrintBiasedLockingStatistics) {
2095     Atomic::inc(BiasedLocking::slow_path_entry_count_addr());
2096   }
2097   Handle h_obj(THREAD, obj);
2098   ObjectSynchronizer::enter(h_obj, lock, CHECK);
2099   assert(!HAS_PENDING_EXCEPTION, &quot;Should have no exception here&quot;);
2100   JRT_BLOCK_END
2101 }
2102 
2103 // Handles the uncommon case in locking, i.e., contention or an inflated lock.
2104 JRT_BLOCK_ENTRY(void, SharedRuntime::complete_monitor_locking_C(oopDesc* obj, BasicLock* lock, JavaThread* thread))
2105   SharedRuntime::monitor_enter_helper(obj, lock, thread);
2106 JRT_END
2107 
2108 void SharedRuntime::monitor_exit_helper(oopDesc* obj, BasicLock* lock, JavaThread* thread) {
2109   assert(JavaThread::current() == thread, &quot;invariant&quot;);
2110   // Exit must be non-blocking, and therefore no exceptions can be thrown.
2111   EXCEPTION_MARK;
2112   ObjectSynchronizer::exit(obj, lock, THREAD);
2113 }
2114 
2115 // Handles the uncommon cases of monitor unlocking in compiled code
2116 JRT_LEAF(void, SharedRuntime::complete_monitor_unlocking_C(oopDesc* obj, BasicLock* lock, JavaThread* thread))
2117   SharedRuntime::monitor_exit_helper(obj, lock, thread);
2118 JRT_END
2119 
2120 #ifndef PRODUCT
2121 
2122 void SharedRuntime::print_statistics() {
2123   ttyLocker ttyl;
2124   if (xtty != NULL)  xtty-&gt;head(&quot;statistics type=&#39;SharedRuntime&#39;&quot;);
2125 
2126   if (_throw_null_ctr) tty-&gt;print_cr(&quot;%5d implicit null throw&quot;, _throw_null_ctr);
2127 
2128   SharedRuntime::print_ic_miss_histogram();
2129 
2130   if (CountRemovableExceptions) {
2131     if (_nof_removable_exceptions &gt; 0) {
2132       Unimplemented(); // this counter is not yet incremented
2133       tty-&gt;print_cr(&quot;Removable exceptions: %d&quot;, _nof_removable_exceptions);
2134     }
2135   }
2136 
2137   // Dump the JRT_ENTRY counters
2138   if (_new_instance_ctr) tty-&gt;print_cr(&quot;%5d new instance requires GC&quot;, _new_instance_ctr);
2139   if (_new_array_ctr) tty-&gt;print_cr(&quot;%5d new array requires GC&quot;, _new_array_ctr);
2140   if (_multi1_ctr) tty-&gt;print_cr(&quot;%5d multianewarray 1 dim&quot;, _multi1_ctr);
2141   if (_multi2_ctr) tty-&gt;print_cr(&quot;%5d multianewarray 2 dim&quot;, _multi2_ctr);
2142   if (_multi3_ctr) tty-&gt;print_cr(&quot;%5d multianewarray 3 dim&quot;, _multi3_ctr);
2143   if (_multi4_ctr) tty-&gt;print_cr(&quot;%5d multianewarray 4 dim&quot;, _multi4_ctr);
2144   if (_multi5_ctr) tty-&gt;print_cr(&quot;%5d multianewarray 5 dim&quot;, _multi5_ctr);
2145 
2146   tty-&gt;print_cr(&quot;%5d inline cache miss in compiled&quot;, _ic_miss_ctr);
2147   tty-&gt;print_cr(&quot;%5d wrong method&quot;, _wrong_method_ctr);
2148   tty-&gt;print_cr(&quot;%5d unresolved static call site&quot;, _resolve_static_ctr);
2149   tty-&gt;print_cr(&quot;%5d unresolved virtual call site&quot;, _resolve_virtual_ctr);
2150   tty-&gt;print_cr(&quot;%5d unresolved opt virtual call site&quot;, _resolve_opt_virtual_ctr);
2151 
2152   if (_mon_enter_stub_ctr) tty-&gt;print_cr(&quot;%5d monitor enter stub&quot;, _mon_enter_stub_ctr);
2153   if (_mon_exit_stub_ctr) tty-&gt;print_cr(&quot;%5d monitor exit stub&quot;, _mon_exit_stub_ctr);
2154   if (_mon_enter_ctr) tty-&gt;print_cr(&quot;%5d monitor enter slow&quot;, _mon_enter_ctr);
2155   if (_mon_exit_ctr) tty-&gt;print_cr(&quot;%5d monitor exit slow&quot;, _mon_exit_ctr);
2156   if (_partial_subtype_ctr) tty-&gt;print_cr(&quot;%5d slow partial subtype&quot;, _partial_subtype_ctr);
2157   if (_jbyte_array_copy_ctr) tty-&gt;print_cr(&quot;%5d byte array copies&quot;, _jbyte_array_copy_ctr);
2158   if (_jshort_array_copy_ctr) tty-&gt;print_cr(&quot;%5d short array copies&quot;, _jshort_array_copy_ctr);
2159   if (_jint_array_copy_ctr) tty-&gt;print_cr(&quot;%5d int array copies&quot;, _jint_array_copy_ctr);
2160   if (_jlong_array_copy_ctr) tty-&gt;print_cr(&quot;%5d long array copies&quot;, _jlong_array_copy_ctr);
2161   if (_oop_array_copy_ctr) tty-&gt;print_cr(&quot;%5d oop array copies&quot;, _oop_array_copy_ctr);
2162   if (_checkcast_array_copy_ctr) tty-&gt;print_cr(&quot;%5d checkcast array copies&quot;, _checkcast_array_copy_ctr);
2163   if (_unsafe_array_copy_ctr) tty-&gt;print_cr(&quot;%5d unsafe array copies&quot;, _unsafe_array_copy_ctr);
2164   if (_generic_array_copy_ctr) tty-&gt;print_cr(&quot;%5d generic array copies&quot;, _generic_array_copy_ctr);
2165   if (_slow_array_copy_ctr) tty-&gt;print_cr(&quot;%5d slow array copies&quot;, _slow_array_copy_ctr);
2166   if (_find_handler_ctr) tty-&gt;print_cr(&quot;%5d find exception handler&quot;, _find_handler_ctr);
2167   if (_rethrow_ctr) tty-&gt;print_cr(&quot;%5d rethrow handler&quot;, _rethrow_ctr);
2168 
2169   AdapterHandlerLibrary::print_statistics();
2170 
2171   if (xtty != NULL)  xtty-&gt;tail(&quot;statistics&quot;);
2172 }
2173 
2174 inline double percent(int x, int y) {
2175   return 100.0 * x / MAX2(y, 1);
2176 }
2177 
2178 class MethodArityHistogram {
2179  public:
2180   enum { MAX_ARITY = 256 };
2181  private:
2182   static int _arity_histogram[MAX_ARITY];     // histogram of #args
2183   static int _size_histogram[MAX_ARITY];      // histogram of arg size in words
2184   static int _max_arity;                      // max. arity seen
2185   static int _max_size;                       // max. arg size seen
2186 
2187   static void add_method_to_histogram(nmethod* nm) {
2188     if (CompiledMethod::nmethod_access_is_safe(nm)) {
2189       Method* method = nm-&gt;method();
2190       ArgumentCount args(method-&gt;signature());
2191       int arity   = args.size() + (method-&gt;is_static() ? 0 : 1);
2192       int argsize = method-&gt;size_of_parameters();
2193       arity   = MIN2(arity, MAX_ARITY-1);
2194       argsize = MIN2(argsize, MAX_ARITY-1);
2195       int count = method-&gt;compiled_invocation_count();
2196       _arity_histogram[arity]  += count;
2197       _size_histogram[argsize] += count;
2198       _max_arity = MAX2(_max_arity, arity);
2199       _max_size  = MAX2(_max_size, argsize);
2200     }
2201   }
2202 
2203   void print_histogram_helper(int n, int* histo, const char* name) {
2204     const int N = MIN2(5, n);
2205     tty-&gt;print_cr(&quot;\nHistogram of call arity (incl. rcvr, calls to compiled methods only):&quot;);
2206     double sum = 0;
2207     double weighted_sum = 0;
2208     int i;
2209     for (i = 0; i &lt;= n; i++) { sum += histo[i]; weighted_sum += i*histo[i]; }
2210     double rest = sum;
2211     double percent = sum / 100;
2212     for (i = 0; i &lt;= N; i++) {
2213       rest -= histo[i];
2214       tty-&gt;print_cr(&quot;%4d: %7d (%5.1f%%)&quot;, i, histo[i], histo[i] / percent);
2215     }
2216     tty-&gt;print_cr(&quot;rest: %7d (%5.1f%%))&quot;, (int)rest, rest / percent);
2217     tty-&gt;print_cr(&quot;(avg. %s = %3.1f, max = %d)&quot;, name, weighted_sum / sum, n);
2218   }
2219 
2220   void print_histogram() {
2221     tty-&gt;print_cr(&quot;\nHistogram of call arity (incl. rcvr, calls to compiled methods only):&quot;);
2222     print_histogram_helper(_max_arity, _arity_histogram, &quot;arity&quot;);
2223     tty-&gt;print_cr(&quot;\nSame for parameter size (in words):&quot;);
2224     print_histogram_helper(_max_size, _size_histogram, &quot;size&quot;);
2225     tty-&gt;cr();
2226   }
2227 
2228  public:
2229   MethodArityHistogram() {
2230     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
2231     _max_arity = _max_size = 0;
2232     for (int i = 0; i &lt; MAX_ARITY; i++) _arity_histogram[i] = _size_histogram[i] = 0;
2233     CodeCache::nmethods_do(add_method_to_histogram);
2234     print_histogram();
2235   }
2236 };
2237 
2238 int MethodArityHistogram::_arity_histogram[MethodArityHistogram::MAX_ARITY];
2239 int MethodArityHistogram::_size_histogram[MethodArityHistogram::MAX_ARITY];
2240 int MethodArityHistogram::_max_arity;
2241 int MethodArityHistogram::_max_size;
2242 
2243 void SharedRuntime::print_call_statistics(int comp_total) {
2244   tty-&gt;print_cr(&quot;Calls from compiled code:&quot;);
2245   int total  = _nof_normal_calls + _nof_interface_calls + _nof_static_calls;
2246   int mono_c = _nof_normal_calls - _nof_optimized_calls - _nof_megamorphic_calls;
2247   int mono_i = _nof_interface_calls - _nof_optimized_interface_calls - _nof_megamorphic_interface_calls;
2248   tty-&gt;print_cr(&quot;\t%9d   (%4.1f%%) total non-inlined   &quot;, total, percent(total, total));
2249   tty-&gt;print_cr(&quot;\t%9d   (%4.1f%%) virtual calls       &quot;, _nof_normal_calls, percent(_nof_normal_calls, total));
2250   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   inlined          &quot;, _nof_inlined_calls, percent(_nof_inlined_calls, _nof_normal_calls));
2251   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   optimized        &quot;, _nof_optimized_calls, percent(_nof_optimized_calls, _nof_normal_calls));
2252   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   monomorphic      &quot;, mono_c, percent(mono_c, _nof_normal_calls));
2253   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   megamorphic      &quot;, _nof_megamorphic_calls, percent(_nof_megamorphic_calls, _nof_normal_calls));
2254   tty-&gt;print_cr(&quot;\t%9d   (%4.1f%%) interface calls     &quot;, _nof_interface_calls, percent(_nof_interface_calls, total));
2255   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   inlined          &quot;, _nof_inlined_interface_calls, percent(_nof_inlined_interface_calls, _nof_interface_calls));
2256   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   optimized        &quot;, _nof_optimized_interface_calls, percent(_nof_optimized_interface_calls, _nof_interface_calls));
2257   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   monomorphic      &quot;, mono_i, percent(mono_i, _nof_interface_calls));
2258   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   megamorphic      &quot;, _nof_megamorphic_interface_calls, percent(_nof_megamorphic_interface_calls, _nof_interface_calls));
2259   tty-&gt;print_cr(&quot;\t%9d   (%4.1f%%) static/special calls&quot;, _nof_static_calls, percent(_nof_static_calls, total));
2260   tty-&gt;print_cr(&quot;\t  %9d  (%3.0f%%)   inlined          &quot;, _nof_inlined_static_calls, percent(_nof_inlined_static_calls, _nof_static_calls));
2261   tty-&gt;cr();
2262   tty-&gt;print_cr(&quot;Note 1: counter updates are not MT-safe.&quot;);
2263   tty-&gt;print_cr(&quot;Note 2: %% in major categories are relative to total non-inlined calls;&quot;);
2264   tty-&gt;print_cr(&quot;        %% in nested categories are relative to their category&quot;);
2265   tty-&gt;print_cr(&quot;        (and thus add up to more than 100%% with inlining)&quot;);
2266   tty-&gt;cr();
2267 
2268   MethodArityHistogram h;
2269 }
2270 #endif
2271 
2272 
2273 // A simple wrapper class around the calling convention information
2274 // that allows sharing of adapters for the same calling convention.
2275 class AdapterFingerPrint : public CHeapObj&lt;mtCode&gt; {
2276  private:
2277   enum {
2278     _basic_type_bits = 4,
2279     _basic_type_mask = right_n_bits(_basic_type_bits),
2280     _basic_types_per_int = BitsPerInt / _basic_type_bits,
2281     _compact_int_count = 3
2282   };
2283   // TO DO:  Consider integrating this with a more global scheme for compressing signatures.
2284   // For now, 4 bits per components (plus T_VOID gaps after double/long) is not excessive.
2285 
2286   union {
2287     int  _compact[_compact_int_count];
2288     int* _fingerprint;
2289   } _value;
2290   int _length; // A negative length indicates the fingerprint is in the compact form,
2291                // Otherwise _value._fingerprint is the array.
2292 
2293   // Remap BasicTypes that are handled equivalently by the adapters.
2294   // These are correct for the current system but someday it might be
2295   // necessary to make this mapping platform dependent.
2296   static int adapter_encoding(BasicType in) {
2297     switch (in) {
2298       case T_BOOLEAN:
2299       case T_BYTE:
2300       case T_SHORT:
2301       case T_CHAR:
2302         // There are all promoted to T_INT in the calling convention
2303         return T_INT;
2304 
2305       case T_OBJECT:
2306       case T_ARRAY:
2307         // In other words, we assume that any register good enough for
2308         // an int or long is good enough for a managed pointer.
2309 #ifdef _LP64
2310         return T_LONG;
2311 #else
2312         return T_INT;
2313 #endif
2314 
2315       case T_INT:
2316       case T_LONG:
2317       case T_FLOAT:
2318       case T_DOUBLE:
2319       case T_VOID:
2320         return in;
2321 
2322       default:
2323         ShouldNotReachHere();
2324         return T_CONFLICT;
2325     }
2326   }
2327 
2328  public:
2329   AdapterFingerPrint(int total_args_passed, BasicType* sig_bt) {
2330     // The fingerprint is based on the BasicType signature encoded
2331     // into an array of ints with eight entries per int.
2332     int* ptr;
2333     int len = (total_args_passed + (_basic_types_per_int-1)) / _basic_types_per_int;
2334     if (len &lt;= _compact_int_count) {
2335       assert(_compact_int_count == 3, &quot;else change next line&quot;);
2336       _value._compact[0] = _value._compact[1] = _value._compact[2] = 0;
2337       // Storing the signature encoded as signed chars hits about 98%
2338       // of the time.
2339       _length = -len;
2340       ptr = _value._compact;
2341     } else {
2342       _length = len;
2343       _value._fingerprint = NEW_C_HEAP_ARRAY(int, _length, mtCode);
2344       ptr = _value._fingerprint;
2345     }
2346 
2347     // Now pack the BasicTypes with 8 per int
2348     int sig_index = 0;
2349     for (int index = 0; index &lt; len; index++) {
2350       int value = 0;
2351       for (int byte = 0; byte &lt; _basic_types_per_int; byte++) {
2352         int bt = ((sig_index &lt; total_args_passed)
2353                   ? adapter_encoding(sig_bt[sig_index++])
2354                   : 0);
2355         assert((bt &amp; _basic_type_mask) == bt, &quot;must fit in 4 bits&quot;);
2356         value = (value &lt;&lt; _basic_type_bits) | bt;
2357       }
2358       ptr[index] = value;
2359     }
2360   }
2361 
2362   ~AdapterFingerPrint() {
2363     if (_length &gt; 0) {
2364       FREE_C_HEAP_ARRAY(int, _value._fingerprint);
2365     }
2366   }
2367 
2368   int value(int index) {
2369     if (_length &lt; 0) {
2370       return _value._compact[index];
2371     }
2372     return _value._fingerprint[index];
2373   }
2374   int length() {
2375     if (_length &lt; 0) return -_length;
2376     return _length;
2377   }
2378 
2379   bool is_compact() {
2380     return _length &lt;= 0;
2381   }
2382 
2383   unsigned int compute_hash() {
2384     int hash = 0;
2385     for (int i = 0; i &lt; length(); i++) {
2386       int v = value(i);
2387       hash = (hash &lt;&lt; 8) ^ v ^ (hash &gt;&gt; 5);
2388     }
2389     return (unsigned int)hash;
2390   }
2391 
2392   const char* as_string() {
2393     stringStream st;
2394     st.print(&quot;0x&quot;);
2395     for (int i = 0; i &lt; length(); i++) {
2396       st.print(&quot;%08x&quot;, value(i));
2397     }
2398     return st.as_string();
2399   }
2400 
2401   bool equals(AdapterFingerPrint* other) {
2402     if (other-&gt;_length != _length) {
2403       return false;
2404     }
2405     if (_length &lt; 0) {
2406       assert(_compact_int_count == 3, &quot;else change next line&quot;);
2407       return _value._compact[0] == other-&gt;_value._compact[0] &amp;&amp;
2408              _value._compact[1] == other-&gt;_value._compact[1] &amp;&amp;
2409              _value._compact[2] == other-&gt;_value._compact[2];
2410     } else {
2411       for (int i = 0; i &lt; _length; i++) {
2412         if (_value._fingerprint[i] != other-&gt;_value._fingerprint[i]) {
2413           return false;
2414         }
2415       }
2416     }
2417     return true;
2418   }
2419 };
2420 
2421 
2422 // A hashtable mapping from AdapterFingerPrints to AdapterHandlerEntries
2423 class AdapterHandlerTable : public BasicHashtable&lt;mtCode&gt; {
2424   friend class AdapterHandlerTableIterator;
2425 
2426  private:
2427 
2428 #ifndef PRODUCT
2429   static int _lookups; // number of calls to lookup
2430   static int _buckets; // number of buckets checked
2431   static int _equals;  // number of buckets checked with matching hash
2432   static int _hits;    // number of successful lookups
2433   static int _compact; // number of equals calls with compact signature
2434 #endif
2435 
2436   AdapterHandlerEntry* bucket(int i) {
2437     return (AdapterHandlerEntry*)BasicHashtable&lt;mtCode&gt;::bucket(i);
2438   }
2439 
2440  public:
2441   AdapterHandlerTable()
2442     : BasicHashtable&lt;mtCode&gt;(293, (DumpSharedSpaces ? sizeof(CDSAdapterHandlerEntry) : sizeof(AdapterHandlerEntry))) { }
2443 
2444   // Create a new entry suitable for insertion in the table
2445   AdapterHandlerEntry* new_entry(AdapterFingerPrint* fingerprint, address i2c_entry, address c2i_entry, address c2i_unverified_entry, address c2i_no_clinit_check_entry) {
2446     AdapterHandlerEntry* entry = (AdapterHandlerEntry*)BasicHashtable&lt;mtCode&gt;::new_entry(fingerprint-&gt;compute_hash());
2447     entry-&gt;init(fingerprint, i2c_entry, c2i_entry, c2i_unverified_entry, c2i_no_clinit_check_entry);
2448     if (DumpSharedSpaces) {
2449       ((CDSAdapterHandlerEntry*)entry)-&gt;init();
2450     }
2451     return entry;
2452   }
2453 
2454   // Insert an entry into the table
2455   void add(AdapterHandlerEntry* entry) {
2456     int index = hash_to_index(entry-&gt;hash());
2457     add_entry(index, entry);
2458   }
2459 
2460   void free_entry(AdapterHandlerEntry* entry) {
2461     entry-&gt;deallocate();
2462     BasicHashtable&lt;mtCode&gt;::free_entry(entry);
2463   }
2464 
2465   // Find a entry with the same fingerprint if it exists
2466   AdapterHandlerEntry* lookup(int total_args_passed, BasicType* sig_bt) {
2467     NOT_PRODUCT(_lookups++);
2468     AdapterFingerPrint fp(total_args_passed, sig_bt);
2469     unsigned int hash = fp.compute_hash();
2470     int index = hash_to_index(hash);
2471     for (AdapterHandlerEntry* e = bucket(index); e != NULL; e = e-&gt;next()) {
2472       NOT_PRODUCT(_buckets++);
2473       if (e-&gt;hash() == hash) {
2474         NOT_PRODUCT(_equals++);
2475         if (fp.equals(e-&gt;fingerprint())) {
2476 #ifndef PRODUCT
2477           if (fp.is_compact()) _compact++;
2478           _hits++;
2479 #endif
2480           return e;
2481         }
2482       }
2483     }
2484     return NULL;
2485   }
2486 
2487 #ifndef PRODUCT
2488   void print_statistics() {
2489     ResourceMark rm;
2490     int longest = 0;
2491     int empty = 0;
2492     int total = 0;
2493     int nonempty = 0;
2494     for (int index = 0; index &lt; table_size(); index++) {
2495       int count = 0;
2496       for (AdapterHandlerEntry* e = bucket(index); e != NULL; e = e-&gt;next()) {
2497         count++;
2498       }
2499       if (count != 0) nonempty++;
2500       if (count == 0) empty++;
2501       if (count &gt; longest) longest = count;
2502       total += count;
2503     }
2504     tty-&gt;print_cr(&quot;AdapterHandlerTable: empty %d longest %d total %d average %f&quot;,
2505                   empty, longest, total, total / (double)nonempty);
2506     tty-&gt;print_cr(&quot;AdapterHandlerTable: lookups %d buckets %d equals %d hits %d compact %d&quot;,
2507                   _lookups, _buckets, _equals, _hits, _compact);
2508   }
2509 #endif
2510 };
2511 
2512 
2513 #ifndef PRODUCT
2514 
2515 int AdapterHandlerTable::_lookups;
2516 int AdapterHandlerTable::_buckets;
2517 int AdapterHandlerTable::_equals;
2518 int AdapterHandlerTable::_hits;
2519 int AdapterHandlerTable::_compact;
2520 
2521 #endif
2522 
2523 class AdapterHandlerTableIterator : public StackObj {
2524  private:
2525   AdapterHandlerTable* _table;
2526   int _index;
2527   AdapterHandlerEntry* _current;
2528 
2529   void scan() {
2530     while (_index &lt; _table-&gt;table_size()) {
2531       AdapterHandlerEntry* a = _table-&gt;bucket(_index);
2532       _index++;
2533       if (a != NULL) {
2534         _current = a;
2535         return;
2536       }
2537     }
2538   }
2539 
2540  public:
2541   AdapterHandlerTableIterator(AdapterHandlerTable* table): _table(table), _index(0), _current(NULL) {
2542     scan();
2543   }
2544   bool has_next() {
2545     return _current != NULL;
2546   }
2547   AdapterHandlerEntry* next() {
2548     if (_current != NULL) {
2549       AdapterHandlerEntry* result = _current;
2550       _current = _current-&gt;next();
2551       if (_current == NULL) scan();
2552       return result;
2553     } else {
2554       return NULL;
2555     }
2556   }
2557 };
2558 
2559 
2560 // ---------------------------------------------------------------------------
2561 // Implementation of AdapterHandlerLibrary
2562 AdapterHandlerTable* AdapterHandlerLibrary::_adapters = NULL;
2563 AdapterHandlerEntry* AdapterHandlerLibrary::_abstract_method_handler = NULL;
2564 const int AdapterHandlerLibrary_size = 16*K;
2565 BufferBlob* AdapterHandlerLibrary::_buffer = NULL;
2566 
2567 BufferBlob* AdapterHandlerLibrary::buffer_blob() {
2568   // Should be called only when AdapterHandlerLibrary_lock is active.
2569   if (_buffer == NULL) // Initialize lazily
2570       _buffer = BufferBlob::create(&quot;adapters&quot;, AdapterHandlerLibrary_size);
2571   return _buffer;
2572 }
2573 
2574 extern &quot;C&quot; void unexpected_adapter_call() {
2575   ShouldNotCallThis();
2576 }
2577 
2578 void AdapterHandlerLibrary::initialize() {
2579   if (_adapters != NULL) return;
2580   _adapters = new AdapterHandlerTable();
2581 
2582   // Create a special handler for abstract methods.  Abstract methods
2583   // are never compiled so an i2c entry is somewhat meaningless, but
2584   // throw AbstractMethodError just in case.
2585   // Pass wrong_method_abstract for the c2i transitions to return
2586   // AbstractMethodError for invalid invocations.
2587   address wrong_method_abstract = SharedRuntime::get_handle_wrong_method_abstract_stub();
2588   _abstract_method_handler = AdapterHandlerLibrary::new_entry(new AdapterFingerPrint(0, NULL),
2589                                                               StubRoutines::throw_AbstractMethodError_entry(),
2590                                                               wrong_method_abstract, wrong_method_abstract);
2591 }
2592 
2593 AdapterHandlerEntry* AdapterHandlerLibrary::new_entry(AdapterFingerPrint* fingerprint,
2594                                                       address i2c_entry,
2595                                                       address c2i_entry,
2596                                                       address c2i_unverified_entry,
2597                                                       address c2i_no_clinit_check_entry) {
2598   return _adapters-&gt;new_entry(fingerprint, i2c_entry, c2i_entry, c2i_unverified_entry, c2i_no_clinit_check_entry);
2599 }
2600 
2601 AdapterHandlerEntry* AdapterHandlerLibrary::get_adapter(const methodHandle&amp; method) {
2602   AdapterHandlerEntry* entry = get_adapter0(method);
2603   if (entry != NULL &amp;&amp; method-&gt;is_shared()) {
2604     // See comments around Method::link_method()
2605     MutexLocker mu(AdapterHandlerLibrary_lock);
2606     if (method-&gt;adapter() == NULL) {
2607       method-&gt;update_adapter_trampoline(entry);
2608     }
2609     address trampoline = method-&gt;from_compiled_entry();
2610     if (*(int*)trampoline == 0) {
2611       CodeBuffer buffer(trampoline, (int)SharedRuntime::trampoline_size());
2612       MacroAssembler _masm(&amp;buffer);
2613       SharedRuntime::generate_trampoline(&amp;_masm, entry-&gt;get_c2i_entry());
2614       assert(*(int*)trampoline != 0, &quot;Instruction(s) for trampoline must not be encoded as zeros.&quot;);
2615       _masm.flush();
2616 
2617       if (PrintInterpreter) {
2618         Disassembler::decode(buffer.insts_begin(), buffer.insts_end());
2619       }
2620     }
2621   }
2622 
2623   return entry;
2624 }
2625 
2626 AdapterHandlerEntry* AdapterHandlerLibrary::get_adapter0(const methodHandle&amp; method) {
2627   // Use customized signature handler.  Need to lock around updates to
2628   // the AdapterHandlerTable (it is not safe for concurrent readers
2629   // and a single writer: this could be fixed if it becomes a
2630   // problem).
2631 
2632   ResourceMark rm;
2633 
2634   NOT_PRODUCT(int insts_size);
2635   AdapterBlob* new_adapter = NULL;
2636   AdapterHandlerEntry* entry = NULL;
2637   AdapterFingerPrint* fingerprint = NULL;
2638   {
2639     MutexLocker mu(AdapterHandlerLibrary_lock);
2640     // make sure data structure is initialized
2641     initialize();
2642 
2643     if (method-&gt;is_abstract()) {
2644       return _abstract_method_handler;
2645     }
2646 
2647     // Fill in the signature array, for the calling-convention call.
2648     int total_args_passed = method-&gt;size_of_parameters(); // All args on stack
2649 
2650     BasicType* sig_bt = NEW_RESOURCE_ARRAY(BasicType, total_args_passed);
2651     VMRegPair* regs   = NEW_RESOURCE_ARRAY(VMRegPair, total_args_passed);
2652     int i = 0;
2653     if (!method-&gt;is_static())  // Pass in receiver first
2654       sig_bt[i++] = T_OBJECT;
2655     for (SignatureStream ss(method-&gt;signature()); !ss.at_return_type(); ss.next()) {
2656       sig_bt[i++] = ss.type();  // Collect remaining bits of signature
2657       if (ss.type() == T_LONG || ss.type() == T_DOUBLE)
2658         sig_bt[i++] = T_VOID;   // Longs &amp; doubles take 2 Java slots
2659     }
2660     assert(i == total_args_passed, &quot;&quot;);
2661 
2662     // Lookup method signature&#39;s fingerprint
2663     entry = _adapters-&gt;lookup(total_args_passed, sig_bt);
2664 
2665 #ifdef ASSERT
2666     AdapterHandlerEntry* shared_entry = NULL;
2667     // Start adapter sharing verification only after the VM is booted.
2668     if (VerifyAdapterSharing &amp;&amp; (entry != NULL)) {
2669       shared_entry = entry;
2670       entry = NULL;
2671     }
2672 #endif
2673 
2674     if (entry != NULL) {
2675       return entry;
2676     }
2677 
2678     // Get a description of the compiled java calling convention and the largest used (VMReg) stack slot usage
2679     int comp_args_on_stack = SharedRuntime::java_calling_convention(sig_bt, regs, total_args_passed, false);
2680 
2681     // Make a C heap allocated version of the fingerprint to store in the adapter
2682     fingerprint = new AdapterFingerPrint(total_args_passed, sig_bt);
2683 
2684     // StubRoutines::code2() is initialized after this function can be called. As a result,
2685     // VerifyAdapterCalls and VerifyAdapterSharing can fail if we re-use code that generated
2686     // prior to StubRoutines::code2() being set. Checks refer to checks generated in an I2C
2687     // stub that ensure that an I2C stub is called from an interpreter frame.
2688     bool contains_all_checks = StubRoutines::code2() != NULL;
2689 
2690     // Create I2C &amp; C2I handlers
2691     BufferBlob* buf = buffer_blob(); // the temporary code buffer in CodeCache
2692     if (buf != NULL) {
2693       CodeBuffer buffer(buf);
2694       short buffer_locs[20];
2695       buffer.insts()-&gt;initialize_shared_locs((relocInfo*)buffer_locs,
2696                                              sizeof(buffer_locs)/sizeof(relocInfo));
2697 
2698       MacroAssembler _masm(&amp;buffer);
2699       entry = SharedRuntime::generate_i2c2i_adapters(&amp;_masm,
2700                                                      total_args_passed,
2701                                                      comp_args_on_stack,
2702                                                      sig_bt,
2703                                                      regs,
2704                                                      fingerprint);
2705 #ifdef ASSERT
2706       if (VerifyAdapterSharing) {
2707         if (shared_entry != NULL) {
2708           assert(shared_entry-&gt;compare_code(buf-&gt;code_begin(), buffer.insts_size()), &quot;code must match&quot;);
2709           // Release the one just created and return the original
2710           _adapters-&gt;free_entry(entry);
2711           return shared_entry;
2712         } else  {
2713           entry-&gt;save_code(buf-&gt;code_begin(), buffer.insts_size());
2714         }
2715       }
2716 #endif
2717 
2718       new_adapter = AdapterBlob::create(&amp;buffer);
2719       NOT_PRODUCT(insts_size = buffer.insts_size());
2720     }
2721     if (new_adapter == NULL) {
2722       // CodeCache is full, disable compilation
2723       // Ought to log this but compile log is only per compile thread
2724       // and we&#39;re some non descript Java thread.
2725       return NULL; // Out of CodeCache space
2726     }
2727     entry-&gt;relocate(new_adapter-&gt;content_begin());
2728 #ifndef PRODUCT
2729     // debugging suppport
2730     if (PrintAdapterHandlers || PrintStubCode) {
2731       ttyLocker ttyl;
2732       entry-&gt;print_adapter_on(tty);
2733       tty-&gt;print_cr(&quot;i2c argument handler #%d for: %s %s %s (%d bytes generated)&quot;,
2734                     _adapters-&gt;number_of_entries(), (method-&gt;is_static() ? &quot;static&quot; : &quot;receiver&quot;),
2735                     method-&gt;signature()-&gt;as_C_string(), fingerprint-&gt;as_string(), insts_size);
2736       tty-&gt;print_cr(&quot;c2i argument handler starts at &quot; INTPTR_FORMAT, p2i(entry-&gt;get_c2i_entry()));
2737       if (Verbose || PrintStubCode) {
2738         address first_pc = entry-&gt;base_address();
2739         if (first_pc != NULL) {
2740           Disassembler::decode(first_pc, first_pc + insts_size);
2741           tty-&gt;cr();
2742         }
2743       }
2744     }
2745 #endif
2746     // Add the entry only if the entry contains all required checks (see sharedRuntime_xxx.cpp)
2747     // The checks are inserted only if -XX:+VerifyAdapterCalls is specified.
2748     if (contains_all_checks || !VerifyAdapterCalls) {
2749       _adapters-&gt;add(entry);
2750     }
2751   }
2752   // Outside of the lock
2753   if (new_adapter != NULL) {
2754     char blob_id[256];
2755     jio_snprintf(blob_id,
2756                  sizeof(blob_id),
2757                  &quot;%s(%s)@&quot; PTR_FORMAT,
2758                  new_adapter-&gt;name(),
2759                  fingerprint-&gt;as_string(),
2760                  new_adapter-&gt;content_begin());
2761     Forte::register_stub(blob_id, new_adapter-&gt;content_begin(), new_adapter-&gt;content_end());
2762 
2763     if (JvmtiExport::should_post_dynamic_code_generated()) {
2764       JvmtiExport::post_dynamic_code_generated(blob_id, new_adapter-&gt;content_begin(), new_adapter-&gt;content_end());
2765     }
2766   }
2767   return entry;
2768 }
2769 
2770 address AdapterHandlerEntry::base_address() {
2771   address base = _i2c_entry;
2772   if (base == NULL)  base = _c2i_entry;
2773   assert(base &lt;= _c2i_entry || _c2i_entry == NULL, &quot;&quot;);
2774   assert(base &lt;= _c2i_unverified_entry || _c2i_unverified_entry == NULL, &quot;&quot;);
2775   assert(base &lt;= _c2i_no_clinit_check_entry || _c2i_no_clinit_check_entry == NULL, &quot;&quot;);
2776   return base;
2777 }
2778 
2779 void AdapterHandlerEntry::relocate(address new_base) {
2780   address old_base = base_address();
2781   assert(old_base != NULL, &quot;&quot;);
2782   ptrdiff_t delta = new_base - old_base;
2783   if (_i2c_entry != NULL)
2784     _i2c_entry += delta;
2785   if (_c2i_entry != NULL)
2786     _c2i_entry += delta;
2787   if (_c2i_unverified_entry != NULL)
2788     _c2i_unverified_entry += delta;
2789   if (_c2i_no_clinit_check_entry != NULL)
2790     _c2i_no_clinit_check_entry += delta;
2791   assert(base_address() == new_base, &quot;&quot;);
2792 }
2793 
2794 
2795 void AdapterHandlerEntry::deallocate() {
2796   delete _fingerprint;
2797 #ifdef ASSERT
2798   FREE_C_HEAP_ARRAY(unsigned char, _saved_code);
2799 #endif
2800 }
2801 
2802 
2803 #ifdef ASSERT
2804 // Capture the code before relocation so that it can be compared
2805 // against other versions.  If the code is captured after relocation
2806 // then relative instructions won&#39;t be equivalent.
2807 void AdapterHandlerEntry::save_code(unsigned char* buffer, int length) {
2808   _saved_code = NEW_C_HEAP_ARRAY(unsigned char, length, mtCode);
2809   _saved_code_length = length;
2810   memcpy(_saved_code, buffer, length);
2811 }
2812 
2813 
2814 bool AdapterHandlerEntry::compare_code(unsigned char* buffer, int length) {
2815   if (length != _saved_code_length) {
2816     return false;
2817   }
2818 
2819   return (memcmp(buffer, _saved_code, length) == 0) ? true : false;
2820 }
2821 #endif
2822 
2823 
2824 /**
2825  * Create a native wrapper for this native method.  The wrapper converts the
2826  * Java-compiled calling convention to the native convention, handles
2827  * arguments, and transitions to native.  On return from the native we transition
2828  * back to java blocking if a safepoint is in progress.
2829  */
2830 void AdapterHandlerLibrary::create_native_wrapper(const methodHandle&amp; method) {
2831   ResourceMark rm;
2832   nmethod* nm = NULL;
2833   address critical_entry = NULL;
2834 
2835   assert(method-&gt;is_native(), &quot;must be native&quot;);
2836   assert(method-&gt;is_special_native_intrinsic() ||
2837          method-&gt;has_native_function(), &quot;must have something valid to call!&quot;);
2838 
2839   if (CriticalJNINatives &amp;&amp; !method-&gt;is_special_native_intrinsic()) {
2840     // We perform the I/O with transition to native before acquiring AdapterHandlerLibrary_lock.
2841     critical_entry = NativeLookup::lookup_critical_entry(method);
2842   }
2843 
2844   {
2845     // Perform the work while holding the lock, but perform any printing outside the lock
2846     MutexLocker mu(AdapterHandlerLibrary_lock);
2847     // See if somebody beat us to it
2848     if (method-&gt;code() != NULL) {
2849       return;
2850     }
2851 
2852     const int compile_id = CompileBroker::assign_compile_id(method, CompileBroker::standard_entry_bci);
2853     assert(compile_id &gt; 0, &quot;Must generate native wrapper&quot;);
2854 
2855 
2856     ResourceMark rm;
2857     BufferBlob*  buf = buffer_blob(); // the temporary code buffer in CodeCache
2858     if (buf != NULL) {
2859       CodeBuffer buffer(buf);
2860 
2861       if (method-&gt;is_continuation_enter_intrinsic()) {
2862         buffer.initialize_stubs_size(64);
2863       }
2864 
2865       double locs_buf[20];
2866       double stubs_locs_buf[20];
2867       buffer.insts()-&gt;initialize_shared_locs((relocInfo*)locs_buf, sizeof(locs_buf) / sizeof(relocInfo));
2868 #if defined(AARCH64)
2869       // On AArch64 with ZGC and nmethod entry barriers, we need all oops to be
2870       // in the constant pool to ensure ordering between the barrier and oops
2871       // accesses. For native_wrappers we need a constant.
2872       buffer.initialize_consts_size(8);
2873 #endif
2874       buffer.stubs()-&gt;initialize_shared_locs((relocInfo*)stubs_locs_buf, sizeof(stubs_locs_buf) / sizeof(relocInfo));
2875       MacroAssembler _masm(&amp;buffer);
2876 
2877       // Fill in the signature array, for the calling-convention call.
2878       const int total_args_passed = method-&gt;size_of_parameters();
2879 
2880       BasicType* sig_bt = NEW_RESOURCE_ARRAY(BasicType, total_args_passed);
2881       VMRegPair*   regs = NEW_RESOURCE_ARRAY(VMRegPair, total_args_passed);
2882       int i=0;
2883       if (!method-&gt;is_static())  // Pass in receiver first
2884         sig_bt[i++] = T_OBJECT;
2885       SignatureStream ss(method-&gt;signature());
2886       for (; !ss.at_return_type(); ss.next()) {
2887         sig_bt[i++] = ss.type();  // Collect remaining bits of signature
2888         if (ss.type() == T_LONG || ss.type() == T_DOUBLE)
2889           sig_bt[i++] = T_VOID;   // Longs &amp; doubles take 2 Java slots
2890       }
2891       assert(i == total_args_passed, &quot;&quot;);
2892       BasicType ret_type = ss.type();
2893 
2894       // Now get the compiled-Java layout as input (or output) arguments.
2895       // NOTE: Stubs for compiled entry points of method handle intrinsics
2896       // are just trampolines so the argument registers must be outgoing ones.
2897       const bool is_outgoing = method-&gt;is_method_handle_intrinsic();
2898       int comp_args_on_stack = SharedRuntime::java_calling_convention(sig_bt, regs, total_args_passed, is_outgoing);
2899 
2900       // Generate the compiled-to-native wrapper code
2901       nm = SharedRuntime::generate_native_wrapper(&amp;_masm, method, compile_id, sig_bt, regs, ret_type, critical_entry);
2902 
2903       if (nm != NULL) {
2904         {
2905           MutexLocker pl(CompiledMethod_lock, Mutex::_no_safepoint_check_flag);
2906           if (nm-&gt;make_in_use()) {
2907             method-&gt;set_code(method, nm);
2908           }
2909         }
2910 
2911         DirectiveSet* directive = DirectivesStack::getDefaultDirective(CompileBroker::compiler(CompLevel_simple));
2912         if (directive-&gt;PrintAssemblyOption) {
2913           nm-&gt;print_code();
2914         }
2915         DirectivesStack::release(directive);
2916       }
2917     }
2918   } // Unlock AdapterHandlerLibrary_lock
2919 
2920 
2921   // Install the generated code.
2922   if (nm != NULL) {
2923     const char *msg = method-&gt;is_static() ? &quot;(static)&quot; : &quot;&quot;;
2924     CompileTask::print_ul(nm, msg);
2925     if (PrintCompilation) {
2926       ttyLocker ttyl;
2927       CompileTask::print(tty, nm, msg);
2928     }
2929     nm-&gt;post_compiled_method_load_event();
2930   }
2931 }
2932 
2933 JRT_ENTRY_NO_ASYNC(void, SharedRuntime::block_for_jni_critical(JavaThread* thread))
2934   assert(thread == JavaThread::current(), &quot;must be&quot;);
2935   // The code is about to enter a JNI lazy critical native method and
2936   // _needs_gc is true, so if this thread is already in a critical
2937   // section then just return, otherwise this thread should block
2938   // until needs_gc has been cleared.
2939   if (thread-&gt;in_critical()) {
2940     return;
2941   }
2942   // Lock and unlock a critical section to give the system a chance to block
2943   GCLocker::lock_critical(thread);
2944   GCLocker::unlock_critical(thread);
2945 JRT_END
2946 
2947 JRT_LEAF(oopDesc*, SharedRuntime::pin_object(JavaThread* thread, oopDesc* obj))
2948   assert(Universe::heap()-&gt;supports_object_pinning(), &quot;Why we are here?&quot;);
2949   assert(obj != NULL, &quot;Should not be null&quot;);
2950   oop o(obj);
2951   o = Universe::heap()-&gt;pin_object(thread, o);
2952   assert(o != NULL, &quot;Should not be null&quot;);
2953   return o;
2954 JRT_END
2955 
2956 JRT_LEAF(void, SharedRuntime::unpin_object(JavaThread* thread, oopDesc* obj))
2957   assert(Universe::heap()-&gt;supports_object_pinning(), &quot;Why we are here?&quot;);
2958   assert(obj != NULL, &quot;Should not be null&quot;);
2959   oop o(obj);
2960   Universe::heap()-&gt;unpin_object(thread, o);
2961 JRT_END
2962 
2963 // -------------------------------------------------------------------------
2964 // Java-Java calling convention
2965 // (what you use when Java calls Java)
2966 
2967 //------------------------------name_for_receiver----------------------------------
2968 // For a given signature, return the VMReg for parameter 0.
2969 VMReg SharedRuntime::name_for_receiver() {
2970   VMRegPair regs;
2971   BasicType sig_bt = T_OBJECT;
2972   (void) java_calling_convention(&amp;sig_bt, &amp;regs, 1, true);
2973   // Return argument 0 register.  In the LP64 build pointers
2974   // take 2 registers, but the VM wants only the &#39;main&#39; name.
2975   return regs.first();
2976 }
2977 
2978 VMRegPair *SharedRuntime::find_callee_arguments(Symbol* sig, bool has_receiver, bool has_appendix, int* arg_size) {
2979   // This method is returning a data structure allocating as a
2980   // ResourceObject, so do not put any ResourceMarks in here.
2981 
2982   BasicType *sig_bt = NEW_RESOURCE_ARRAY(BasicType, 256);
2983   VMRegPair *regs = NEW_RESOURCE_ARRAY(VMRegPair, 256);
2984   int cnt = 0;
2985   if (has_receiver) {
2986     sig_bt[cnt++] = T_OBJECT; // Receiver is argument 0; not in signature
2987   }
2988 
2989   for (SignatureStream ss(sig); !ss.at_return_type(); ss.next()) {
2990     BasicType type = ss.type();
2991     sig_bt[cnt++] = type;
2992     if (is_double_word_type(type))
2993       sig_bt[cnt++] = T_VOID;
2994   }
2995 
2996   if (has_appendix) {
2997     sig_bt[cnt++] = T_OBJECT;
2998   }
2999 
3000   assert(cnt &lt; 256, &quot;grow table size&quot;);
3001 
3002   int comp_args_on_stack;
3003   comp_args_on_stack = java_calling_convention(sig_bt, regs, cnt, true);
3004 
3005   // the calling convention doesn&#39;t count out_preserve_stack_slots so
3006   // we must add that in to get &quot;true&quot; stack offsets.
3007 
3008   if (comp_args_on_stack) {
3009     for (int i = 0; i &lt; cnt; i++) {
3010       VMReg reg1 = regs[i].first();
3011       if (reg1-&gt;is_stack()) {
3012         // Yuck
3013         reg1 = reg1-&gt;bias(out_preserve_stack_slots());
3014       }
3015       VMReg reg2 = regs[i].second();
3016       if (reg2-&gt;is_stack()) {
3017         // Yuck
3018         reg2 = reg2-&gt;bias(out_preserve_stack_slots());
3019       }
3020       regs[i].set_pair(reg2, reg1);
3021     }
3022   }
3023 
3024   // results
3025   *arg_size = cnt;
3026   return regs;
3027 }
3028 
3029 // OSR Migration Code
3030 //
3031 // This code is used convert interpreter frames into compiled frames.  It is
3032 // called from very start of a compiled OSR nmethod.  A temp array is
3033 // allocated to hold the interesting bits of the interpreter frame.  All
3034 // active locks are inflated to allow them to move.  The displaced headers and
3035 // active interpreter locals are copied into the temp buffer.  Then we return
3036 // back to the compiled code.  The compiled code then pops the current
3037 // interpreter frame off the stack and pushes a new compiled frame.  Then it
3038 // copies the interpreter locals and displaced headers where it wants.
3039 // Finally it calls back to free the temp buffer.
3040 //
3041 // All of this is done NOT at any Safepoint, nor is any safepoint or GC allowed.
3042 
3043 JRT_LEAF(intptr_t*, SharedRuntime::OSR_migration_begin( JavaThread *thread) )
3044 
3045   //
3046   // This code is dependent on the memory layout of the interpreter local
3047   // array and the monitors. On all of our platforms the layout is identical
3048   // so this code is shared. If some platform lays the their arrays out
3049   // differently then this code could move to platform specific code or
3050   // the code here could be modified to copy items one at a time using
3051   // frame accessor methods and be platform independent.
3052 
3053   frame fr = thread-&gt;last_frame();
3054   assert(fr.is_interpreted_frame(), &quot;&quot;);
3055   assert(fr.interpreter_frame_expression_stack_size()==0, &quot;only handle empty stacks&quot;);
3056 
3057   // Figure out how many monitors are active.
3058   int active_monitor_count = 0;
3059   for (BasicObjectLock *kptr = fr.interpreter_frame_monitor_end();
3060        kptr &lt; fr.interpreter_frame_monitor_begin();
3061        kptr = fr.next_monitor_in_interpreter_frame(kptr) ) {
3062     if (kptr-&gt;obj() != NULL) active_monitor_count++;
3063   }
3064 
3065   // QQQ we could place number of active monitors in the array so that compiled code
3066   // could double check it.
3067 
3068   Method* moop = fr.interpreter_frame_method();
3069   int max_locals = moop-&gt;max_locals();
3070   // Allocate temp buffer, 1 word per local &amp; 2 per active monitor
3071   int buf_size_words = max_locals + active_monitor_count * BasicObjectLock::size();
3072   intptr_t *buf = NEW_C_HEAP_ARRAY(intptr_t,buf_size_words, mtCode);
3073 
3074   // Copy the locals.  Order is preserved so that loading of longs works.
3075   // Since there&#39;s no GC I can copy the oops blindly.
3076   assert(sizeof(HeapWord)==sizeof(intptr_t), &quot;fix this code&quot;);
3077   Copy::disjoint_words((HeapWord*)fr.interpreter_frame_local_at(max_locals-1),
3078                        (HeapWord*)&amp;buf[0],
3079                        max_locals);
3080 
3081   // Inflate locks.  Copy the displaced headers.  Be careful, there can be holes.
3082   int i = max_locals;
3083   for (BasicObjectLock *kptr2 = fr.interpreter_frame_monitor_end();
3084        kptr2 &lt; fr.interpreter_frame_monitor_begin();
3085        kptr2 = fr.next_monitor_in_interpreter_frame(kptr2) ) {
3086     if (kptr2-&gt;obj() != NULL) {         // Avoid &#39;holes&#39; in the monitor array
3087       BasicLock *lock = kptr2-&gt;lock();
3088       // Inflate so the object&#39;s header no longer refers to the BasicLock.
3089       if (lock-&gt;displaced_header().is_unlocked()) {
3090         // The object is locked and the resulting ObjectMonitor* will also be
3091         // locked so it can&#39;t be async deflated until ownership is dropped.
3092         // See the big comment in basicLock.cpp: BasicLock::move_to().
3093         ObjectSynchronizer::inflate_helper(kptr2-&gt;obj());
3094       }
3095       // Now the displaced header is free to move because the
3096       // object&#39;s header no longer refers to it.
3097       buf[i++] = (intptr_t)lock-&gt;displaced_header().value();
3098       buf[i++] = cast_from_oop&lt;intptr_t&gt;(kptr2-&gt;obj());
3099     }
3100   }
3101   assert(i - max_locals == active_monitor_count*2, &quot;found the expected number of monitors&quot;);
3102 
3103   return buf;
3104 JRT_END
3105 
3106 JRT_LEAF(void, SharedRuntime::OSR_migration_end( intptr_t* buf) )
3107   FREE_C_HEAP_ARRAY(intptr_t, buf);
3108 JRT_END
3109 
3110 bool AdapterHandlerLibrary::contains(const CodeBlob* b) {
3111   AdapterHandlerTableIterator iter(_adapters);
3112   while (iter.has_next()) {
3113     AdapterHandlerEntry* a = iter.next();
3114     if (b == CodeCache::find_blob(a-&gt;get_i2c_entry())) return true;
3115   }
3116   return false;
3117 }
3118 
3119 void AdapterHandlerLibrary::print_handler_on(outputStream* st, const CodeBlob* b) {
3120   AdapterHandlerTableIterator iter(_adapters);
3121   while (iter.has_next()) {
3122     AdapterHandlerEntry* a = iter.next();
3123     if (b == CodeCache::find_blob(a-&gt;get_i2c_entry())) {
3124       st-&gt;print(&quot;Adapter for signature: &quot;);
3125       a-&gt;print_adapter_on(tty);
3126       return;
3127     }
3128   }
3129   assert(false, &quot;Should have found handler&quot;);
3130 }
3131 
3132 void AdapterHandlerEntry::print_adapter_on(outputStream* st) const {
3133   st-&gt;print(&quot;AHE@&quot; INTPTR_FORMAT &quot;: %s&quot;, p2i(this), fingerprint()-&gt;as_string());
3134   if (get_i2c_entry() != NULL) {
3135     st-&gt;print(&quot; i2c: &quot; INTPTR_FORMAT, p2i(get_i2c_entry()));
3136   }
3137   if (get_c2i_entry() != NULL) {
3138     st-&gt;print(&quot; c2i: &quot; INTPTR_FORMAT, p2i(get_c2i_entry()));
3139   }
3140   if (get_c2i_unverified_entry() != NULL) {
3141     st-&gt;print(&quot; c2iUV: &quot; INTPTR_FORMAT, p2i(get_c2i_unverified_entry()));
3142   }
3143   if (get_c2i_no_clinit_check_entry() != NULL) {
3144     st-&gt;print(&quot; c2iNCI: &quot; INTPTR_FORMAT, p2i(get_c2i_no_clinit_check_entry()));
3145   }
3146   st-&gt;cr();
3147 }
3148 
3149 #if INCLUDE_CDS
3150 
3151 void CDSAdapterHandlerEntry::init() {
3152   assert(DumpSharedSpaces, &quot;used during dump time only&quot;);
3153   _c2i_entry_trampoline = (address)MetaspaceShared::misc_code_space_alloc(SharedRuntime::trampoline_size());
3154   _adapter_trampoline = (AdapterHandlerEntry**)MetaspaceShared::misc_code_space_alloc(sizeof(AdapterHandlerEntry*));
3155 };
3156 
3157 #endif // INCLUDE_CDS
3158 
3159 
3160 #ifndef PRODUCT
3161 
3162 void AdapterHandlerLibrary::print_statistics() {
3163   _adapters-&gt;print_statistics();
3164 }
3165 
3166 #endif /* PRODUCT */
3167 
3168 JRT_LEAF(void, SharedRuntime::enable_stack_reserved_zone(JavaThread* thread))
3169   assert(thread-&gt;is_Java_thread(), &quot;Only Java threads have a stack reserved zone&quot;);
3170   if (thread-&gt;stack_reserved_zone_disabled()) {
3171   thread-&gt;enable_stack_reserved_zone();
3172   }
3173   thread-&gt;set_reserved_stack_activation(thread-&gt;stack_base());
3174 JRT_END
3175 
3176 frame SharedRuntime::look_for_reserved_stack_annotated_method(JavaThread* thread, frame fr) {
3177   ResourceMark rm(thread);
3178   frame activation;
3179   CompiledMethod* nm = NULL;
3180   int count = 1;
3181 
3182   assert(fr.is_java_frame(), &quot;Must start on Java frame&quot;);
3183 
3184   RegisterMap map(JavaThread::current(), false, true); // don&#39;t update; walk continuations
3185   for (; !fr.is_first_frame(); fr = fr.sender(&amp;map)) {
3186     if (!fr.is_java_frame())
3187       continue;
3188 
3189     Method* method = NULL;
3190     bool found = false;
3191     if (fr.is_interpreted_frame()) {
3192       method = fr.interpreter_frame_method();
3193       if (method != NULL &amp;&amp; method-&gt;has_reserved_stack_access()) {
3194         found = true;
3195       }
3196     } else {
3197       CodeBlob* cb = fr.cb();
3198       if (cb != NULL &amp;&amp; cb-&gt;is_compiled()) {
3199         nm = cb-&gt;as_compiled_method();
3200         method = nm-&gt;method();
3201         // scope_desc_near() must be used, instead of scope_desc_at() because on
3202         // SPARC, the pcDesc can be on the delay slot after the call instruction.
3203         for (ScopeDesc *sd = nm-&gt;scope_desc_near(fr.pc()); sd != NULL; sd = sd-&gt;sender()) {
3204           method = sd-&gt;method();
3205           if (method != NULL &amp;&amp; method-&gt;has_reserved_stack_access()) {
3206             found = true;
3207       }
3208     }
3209       }
3210     }
3211     if (found) {
3212       activation = fr;
3213       warning(&quot;Potentially dangerous stack overflow in &quot;
3214               &quot;ReservedStackAccess annotated method %s [%d]&quot;,
3215               method-&gt;name_and_sig_as_C_string(), count++);
3216       EventReservedStackActivation event;
3217       if (event.should_commit()) {
3218         event.set_method(method);
3219         event.commit();
3220       }
3221     }
3222   }
3223   return activation;
3224 }
3225 
3226 void SharedRuntime::on_slowpath_allocation_exit(JavaThread* thread) {
3227   // After any safepoint, just before going back to compiled code,
3228   // we inform the GC that we will be doing initializing writes to
3229   // this object in the future without emitting card-marks, so
3230   // GC may take any compensating steps.
3231 
3232   oop new_obj = thread-&gt;vm_result();
3233   if (new_obj == NULL) return;
3234 
3235   BarrierSet *bs = BarrierSet::barrier_set();
3236   bs-&gt;on_slowpath_allocation_exit(thread, new_obj);
3237 }
    </pre>
  </body>
</html>