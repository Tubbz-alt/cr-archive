<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/code/nmethod.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;asm/assembler.inline.hpp&quot;
  28 #include &quot;code/codeCache.hpp&quot;
  29 #include &quot;code/compiledIC.hpp&quot;
  30 #include &quot;code/compiledMethod.inline.hpp&quot;
  31 #include &quot;code/dependencies.hpp&quot;
  32 #include &quot;code/nativeInst.hpp&quot;
  33 #include &quot;code/nmethod.hpp&quot;
  34 #include &quot;code/scopeDesc.hpp&quot;
  35 #include &quot;compiler/abstractCompiler.hpp&quot;
  36 #include &quot;compiler/compileBroker.hpp&quot;
  37 #include &quot;compiler/compileLog.hpp&quot;
  38 #include &quot;compiler/compilerDirectives.hpp&quot;
  39 #include &quot;compiler/directivesParser.hpp&quot;
  40 #include &quot;compiler/disassembler.hpp&quot;
  41 #include &quot;compiler/oopMap.inline.hpp&quot;
  42 #include &quot;gc/shared/barrierSet.hpp&quot;
  43 #include &quot;gc/shared/barrierSetNMethod.hpp&quot;
  44 #include &quot;interpreter/bytecode.hpp&quot;
  45 #include &quot;logging/log.hpp&quot;
  46 #include &quot;logging/logStream.hpp&quot;
  47 #include &quot;memory/allocation.inline.hpp&quot;
  48 #include &quot;memory/resourceArea.hpp&quot;
  49 #include &quot;memory/universe.hpp&quot;
  50 #include &quot;oops/access.inline.hpp&quot;
  51 #include &quot;oops/method.inline.hpp&quot;
  52 #include &quot;oops/methodData.hpp&quot;
  53 #include &quot;oops/oop.inline.hpp&quot;
  54 #include &quot;oops/weakHandle.inline.hpp&quot;
  55 #include &quot;prims/jvmtiImpl.hpp&quot;
  56 #include &quot;prims/jvmtiThreadState.hpp&quot;
  57 #include &quot;runtime/atomic.hpp&quot;
  58 #include &quot;runtime/deoptimization.hpp&quot;
  59 #include &quot;runtime/flags/flagSetting.hpp&quot;
  60 #include &quot;runtime/frame.inline.hpp&quot;
  61 #include &quot;runtime/handles.inline.hpp&quot;
  62 #include &quot;runtime/jniHandles.inline.hpp&quot;
  63 #include &quot;runtime/orderAccess.hpp&quot;
  64 #include &quot;runtime/os.hpp&quot;
  65 #include &quot;runtime/safepointVerifiers.hpp&quot;
  66 #include &quot;runtime/serviceThread.hpp&quot;
  67 #include &quot;runtime/sharedRuntime.hpp&quot;
  68 #include &quot;runtime/sweeper.hpp&quot;
  69 #include &quot;runtime/vmThread.hpp&quot;
  70 #include &quot;utilities/align.hpp&quot;
  71 #include &quot;utilities/dtrace.hpp&quot;
  72 #include &quot;utilities/events.hpp&quot;
  73 #include &quot;utilities/resourceHash.hpp&quot;
  74 #include &quot;utilities/xmlstream.hpp&quot;
  75 #if INCLUDE_JVMCI
  76 #include &quot;jvmci/jvmciRuntime.hpp&quot;
  77 #endif
  78 
  79 #ifdef DTRACE_ENABLED
  80 
  81 // Only bother with this argument setup if dtrace is available
  82 
  83 #define DTRACE_METHOD_UNLOAD_PROBE(method)                                \
  84   {                                                                       \
  85     Method* m = (method);                                                 \
  86     if (m != NULL) {                                                      \
  87       Symbol* klass_name = m-&gt;klass_name();                               \
  88       Symbol* name = m-&gt;name();                                           \
  89       Symbol* signature = m-&gt;signature();                                 \
  90       HOTSPOT_COMPILED_METHOD_UNLOAD(                                     \
  91         (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),                   \
  92         (char *) name-&gt;bytes(), name-&gt;utf8_length(),                               \
  93         (char *) signature-&gt;bytes(), signature-&gt;utf8_length());                    \
  94     }                                                                     \
  95   }
  96 
  97 #else //  ndef DTRACE_ENABLED
  98 
  99 #define DTRACE_METHOD_UNLOAD_PROBE(method)
 100 
 101 #endif
 102 
 103 //---------------------------------------------------------------------------------
 104 // NMethod statistics
 105 // They are printed under various flags, including:
 106 //   PrintC1Statistics, PrintOptoStatistics, LogVMOutput, and LogCompilation.
 107 // (In the latter two cases, they like other stats are printed to the log only.)
 108 
 109 #ifndef PRODUCT
 110 // These variables are put into one block to reduce relocations
 111 // and make it simpler to print from the debugger.
 112 struct java_nmethod_stats_struct {
 113   int nmethod_count;
 114   int total_size;
 115   int relocation_size;
 116   int consts_size;
 117   int insts_size;
 118   int stub_size;
 119   int scopes_data_size;
 120   int scopes_pcs_size;
 121   int dependencies_size;
 122   int handler_table_size;
 123   int nul_chk_table_size;
 124 #if INCLUDE_JVMCI
 125   int speculations_size;
 126   int jvmci_data_size;
 127 #endif
 128   int oops_size;
 129   int metadata_size;
 130 
 131   void note_nmethod(nmethod* nm) {
 132     nmethod_count += 1;
 133     total_size          += nm-&gt;size();
 134     relocation_size     += nm-&gt;relocation_size();
 135     consts_size         += nm-&gt;consts_size();
 136     insts_size          += nm-&gt;insts_size();
 137     stub_size           += nm-&gt;stub_size();
 138     oops_size           += nm-&gt;oops_size();
 139     metadata_size       += nm-&gt;metadata_size();
 140     scopes_data_size    += nm-&gt;scopes_data_size();
 141     scopes_pcs_size     += nm-&gt;scopes_pcs_size();
 142     dependencies_size   += nm-&gt;dependencies_size();
 143     handler_table_size  += nm-&gt;handler_table_size();
 144     nul_chk_table_size  += nm-&gt;nul_chk_table_size();
 145 #if INCLUDE_JVMCI
 146     speculations_size   += nm-&gt;speculations_size();
 147     jvmci_data_size     += nm-&gt;jvmci_data_size();
 148 #endif
 149   }
 150   void print_nmethod_stats(const char* name) {
 151     if (nmethod_count == 0)  return;
 152     tty-&gt;print_cr(&quot;Statistics for %d bytecoded nmethods for %s:&quot;, nmethod_count, name);
 153     if (total_size != 0)          tty-&gt;print_cr(&quot; total in heap  = %d&quot;, total_size);
 154     if (nmethod_count != 0)       tty-&gt;print_cr(&quot; header         = &quot; SIZE_FORMAT, nmethod_count * sizeof(nmethod));
 155     if (relocation_size != 0)     tty-&gt;print_cr(&quot; relocation     = %d&quot;, relocation_size);
 156     if (consts_size != 0)         tty-&gt;print_cr(&quot; constants      = %d&quot;, consts_size);
 157     if (insts_size != 0)          tty-&gt;print_cr(&quot; main code      = %d&quot;, insts_size);
 158     if (stub_size != 0)           tty-&gt;print_cr(&quot; stub code      = %d&quot;, stub_size);
 159     if (oops_size != 0)           tty-&gt;print_cr(&quot; oops           = %d&quot;, oops_size);
 160     if (metadata_size != 0)       tty-&gt;print_cr(&quot; metadata       = %d&quot;, metadata_size);
 161     if (scopes_data_size != 0)    tty-&gt;print_cr(&quot; scopes data    = %d&quot;, scopes_data_size);
 162     if (scopes_pcs_size != 0)     tty-&gt;print_cr(&quot; scopes pcs     = %d&quot;, scopes_pcs_size);
 163     if (dependencies_size != 0)   tty-&gt;print_cr(&quot; dependencies   = %d&quot;, dependencies_size);
 164     if (handler_table_size != 0)  tty-&gt;print_cr(&quot; handler table  = %d&quot;, handler_table_size);
 165     if (nul_chk_table_size != 0)  tty-&gt;print_cr(&quot; nul chk table  = %d&quot;, nul_chk_table_size);
 166 #if INCLUDE_JVMCI
 167     if (speculations_size != 0)   tty-&gt;print_cr(&quot; speculations   = %d&quot;, speculations_size);
 168     if (jvmci_data_size != 0)     tty-&gt;print_cr(&quot; JVMCI data     = %d&quot;, jvmci_data_size);
 169 #endif
 170   }
 171 };
 172 
 173 struct native_nmethod_stats_struct {
 174   int native_nmethod_count;
 175   int native_total_size;
 176   int native_relocation_size;
 177   int native_insts_size;
 178   int native_oops_size;
 179   int native_metadata_size;
 180   void note_native_nmethod(nmethod* nm) {
 181     native_nmethod_count += 1;
 182     native_total_size       += nm-&gt;size();
 183     native_relocation_size  += nm-&gt;relocation_size();
 184     native_insts_size       += nm-&gt;insts_size();
 185     native_oops_size        += nm-&gt;oops_size();
 186     native_metadata_size    += nm-&gt;metadata_size();
 187   }
 188   void print_native_nmethod_stats() {
 189     if (native_nmethod_count == 0)  return;
 190     tty-&gt;print_cr(&quot;Statistics for %d native nmethods:&quot;, native_nmethod_count);
 191     if (native_total_size != 0)       tty-&gt;print_cr(&quot; N. total size  = %d&quot;, native_total_size);
 192     if (native_relocation_size != 0)  tty-&gt;print_cr(&quot; N. relocation  = %d&quot;, native_relocation_size);
 193     if (native_insts_size != 0)       tty-&gt;print_cr(&quot; N. main code   = %d&quot;, native_insts_size);
 194     if (native_oops_size != 0)        tty-&gt;print_cr(&quot; N. oops        = %d&quot;, native_oops_size);
 195     if (native_metadata_size != 0)    tty-&gt;print_cr(&quot; N. metadata    = %d&quot;, native_metadata_size);
 196   }
 197 };
 198 
 199 struct pc_nmethod_stats_struct {
 200   int pc_desc_resets;   // number of resets (= number of caches)
 201   int pc_desc_queries;  // queries to nmethod::find_pc_desc
 202   int pc_desc_approx;   // number of those which have approximate true
 203   int pc_desc_repeats;  // number of _pc_descs[0] hits
 204   int pc_desc_hits;     // number of LRU cache hits
 205   int pc_desc_tests;    // total number of PcDesc examinations
 206   int pc_desc_searches; // total number of quasi-binary search steps
 207   int pc_desc_adds;     // number of LUR cache insertions
 208 
 209   void print_pc_stats() {
 210     tty-&gt;print_cr(&quot;PcDesc Statistics:  %d queries, %.2f comparisons per query&quot;,
 211                   pc_desc_queries,
 212                   (double)(pc_desc_tests + pc_desc_searches)
 213                   / pc_desc_queries);
 214     tty-&gt;print_cr(&quot;  caches=%d queries=%d/%d, hits=%d+%d, tests=%d+%d, adds=%d&quot;,
 215                   pc_desc_resets,
 216                   pc_desc_queries, pc_desc_approx,
 217                   pc_desc_repeats, pc_desc_hits,
 218                   pc_desc_tests, pc_desc_searches, pc_desc_adds);
 219   }
 220 };
 221 
 222 #ifdef COMPILER1
 223 static java_nmethod_stats_struct c1_java_nmethod_stats;
 224 #endif
 225 #ifdef COMPILER2
 226 static java_nmethod_stats_struct c2_java_nmethod_stats;
 227 #endif
 228 #if INCLUDE_JVMCI
 229 static java_nmethod_stats_struct jvmci_java_nmethod_stats;
 230 #endif
 231 static java_nmethod_stats_struct unknown_java_nmethod_stats;
 232 
 233 static native_nmethod_stats_struct native_nmethod_stats;
 234 static pc_nmethod_stats_struct pc_nmethod_stats;
 235 
 236 static void note_java_nmethod(nmethod* nm) {
 237 #ifdef COMPILER1
 238   if (nm-&gt;is_compiled_by_c1()) {
 239     c1_java_nmethod_stats.note_nmethod(nm);
 240   } else
 241 #endif
 242 #ifdef COMPILER2
 243   if (nm-&gt;is_compiled_by_c2()) {
 244     c2_java_nmethod_stats.note_nmethod(nm);
 245   } else
 246 #endif
 247 #if INCLUDE_JVMCI
 248   if (nm-&gt;is_compiled_by_jvmci()) {
 249     jvmci_java_nmethod_stats.note_nmethod(nm);
 250   } else
 251 #endif
 252   {
 253     unknown_java_nmethod_stats.note_nmethod(nm);
 254   }
 255 }
 256 #endif // !PRODUCT
 257 
 258 //---------------------------------------------------------------------------------
 259 
 260 
 261 ExceptionCache::ExceptionCache(Handle exception, address pc, address handler) {
 262   assert(pc != NULL, &quot;Must be non null&quot;);
 263   assert(exception.not_null(), &quot;Must be non null&quot;);
 264   assert(handler != NULL, &quot;Must be non null&quot;);
 265 
 266   _count = 0;
 267   _exception_type = exception-&gt;klass();
 268   _next = NULL;
 269   _purge_list_next = NULL;
 270 
 271   add_address_and_handler(pc,handler);
 272 }
 273 
 274 
 275 address ExceptionCache::match(Handle exception, address pc) {
 276   assert(pc != NULL,&quot;Must be non null&quot;);
 277   assert(exception.not_null(),&quot;Must be non null&quot;);
 278   if (exception-&gt;klass() == exception_type()) {
 279     return (test_address(pc));
 280   }
 281 
 282   return NULL;
 283 }
 284 
 285 
 286 bool ExceptionCache::match_exception_with_space(Handle exception) {
 287   assert(exception.not_null(),&quot;Must be non null&quot;);
 288   if (exception-&gt;klass() == exception_type() &amp;&amp; count() &lt; cache_size) {
 289     return true;
 290   }
 291   return false;
 292 }
 293 
 294 
 295 address ExceptionCache::test_address(address addr) {
 296   int limit = count();
 297   for (int i = 0; i &lt; limit; i++) {
 298     if (pc_at(i) == addr) {
 299       return handler_at(i);
 300     }
 301   }
 302   return NULL;
 303 }
 304 
 305 
 306 bool ExceptionCache::add_address_and_handler(address addr, address handler) {
 307   if (test_address(addr) == handler) return true;
 308 
 309   int index = count();
 310   if (index &lt; cache_size) {
 311     set_pc_at(index, addr);
 312     set_handler_at(index, handler);
 313     increment_count();
 314     return true;
 315   }
 316   return false;
 317 }
 318 
 319 ExceptionCache* ExceptionCache::next() {
 320   return Atomic::load(&amp;_next);
 321 }
 322 
 323 void ExceptionCache::set_next(ExceptionCache *ec) {
 324   Atomic::store(&amp;_next, ec);
 325 }
 326 
 327 //-----------------------------------------------------------------------------
 328 
 329 
 330 // Helper used by both find_pc_desc methods.
 331 static inline bool match_desc(PcDesc* pc, int pc_offset, bool approximate) {
 332   NOT_PRODUCT(++pc_nmethod_stats.pc_desc_tests);
 333   if (!approximate)
 334     return pc-&gt;pc_offset() == pc_offset;
 335   else
 336     return (pc-1)-&gt;pc_offset() &lt; pc_offset &amp;&amp; pc_offset &lt;= pc-&gt;pc_offset();
 337 }
 338 
 339 void PcDescCache::reset_to(PcDesc* initial_pc_desc) {
 340   if (initial_pc_desc == NULL) {
 341     _pc_descs[0] = NULL; // native method; no PcDescs at all
 342     return;
 343   }
 344   NOT_PRODUCT(++pc_nmethod_stats.pc_desc_resets);
 345   // reset the cache by filling it with benign (non-null) values
 346   assert(initial_pc_desc-&gt;pc_offset() &lt; 0, &quot;must be sentinel&quot;);
 347   for (int i = 0; i &lt; cache_size; i++)
 348     _pc_descs[i] = initial_pc_desc;
 349 }
 350 
 351 PcDesc* PcDescCache::find_pc_desc(int pc_offset, bool approximate) {
 352   NOT_PRODUCT(++pc_nmethod_stats.pc_desc_queries);
 353   NOT_PRODUCT(if (approximate) ++pc_nmethod_stats.pc_desc_approx);
 354 
 355   // Note: one might think that caching the most recently
 356   // read value separately would be a win, but one would be
 357   // wrong.  When many threads are updating it, the cache
 358   // line it&#39;s in would bounce between caches, negating
 359   // any benefit.
 360 
 361   // In order to prevent race conditions do not load cache elements
 362   // repeatedly, but use a local copy:
 363   PcDesc* res;
 364 
 365   // Step one:  Check the most recently added value.
 366   res = _pc_descs[0];
 367   if (res == NULL) return NULL;  // native method; no PcDescs at all
 368   if (match_desc(res, pc_offset, approximate)) {
 369     NOT_PRODUCT(++pc_nmethod_stats.pc_desc_repeats);
 370     return res;
 371   }
 372 
 373   // Step two:  Check the rest of the LRU cache.
 374   for (int i = 1; i &lt; cache_size; ++i) {
 375     res = _pc_descs[i];
 376     if (res-&gt;pc_offset() &lt; 0) break;  // optimization: skip empty cache
 377     if (match_desc(res, pc_offset, approximate)) {
 378       NOT_PRODUCT(++pc_nmethod_stats.pc_desc_hits);
 379       return res;
 380     }
 381   }
 382 
 383   // Report failure.
 384   return NULL;
 385 }
 386 
 387 void PcDescCache::add_pc_desc(PcDesc* pc_desc) {
 388   NOT_PRODUCT(++pc_nmethod_stats.pc_desc_adds);
 389   // Update the LRU cache by shifting pc_desc forward.
 390   for (int i = 0; i &lt; cache_size; i++)  {
 391     PcDesc* next = _pc_descs[i];
 392     _pc_descs[i] = pc_desc;
 393     pc_desc = next;
 394   }
 395 }
 396 
 397 // adjust pcs_size so that it is a multiple of both oopSize and
 398 // sizeof(PcDesc) (assumes that if sizeof(PcDesc) is not a multiple
 399 // of oopSize, then 2*sizeof(PcDesc) is)
 400 static int adjust_pcs_size(int pcs_size) {
 401   int nsize = align_up(pcs_size,   oopSize);
 402   if ((nsize % sizeof(PcDesc)) != 0) {
 403     nsize = pcs_size + sizeof(PcDesc);
 404   }
 405   assert((nsize % oopSize) == 0, &quot;correct alignment&quot;);
 406   return nsize;
 407 }
 408 
 409 
 410 int nmethod::total_size() const {
 411   return
 412     consts_size()        +
 413     insts_size()         +
 414     stub_size()          +
 415     scopes_data_size()   +
 416     scopes_pcs_size()    +
 417     handler_table_size() +
 418     nul_chk_table_size();
 419 }
 420 
 421 const char* nmethod::compile_kind() const {
 422   if (is_osr_method())     return &quot;osr&quot;;
 423   if (method() != NULL &amp;&amp; is_native_method()) {
 424     if (method()-&gt;is_continuation_enter_intrinsic()) {
 425       return &quot;cnt&quot;;
 426     }
 427     return &quot;c2n&quot;;
 428   }
 429   return NULL;
 430 }
 431 
 432 // Fill in default values for various flag fields
 433 void nmethod::init_defaults() {
 434   _state                      = not_installed;
 435   _has_flushed_dependencies   = 0;
 436   _lock_count                 = 0;
 437   _stack_traversal_mark       = 0;
 438   _load_reported              = false; // jvmti state
 439   _unload_reported            = false;
 440   _is_far_code                = false; // nmethods are located in CodeCache
 441 
 442 #ifdef ASSERT
 443   _oops_are_stale             = false;
 444 #endif
 445 
 446   _oops_do_mark_link       = NULL;
 447   _osr_link                = NULL;
 448 #if INCLUDE_RTM_OPT
 449   _rtm_state               = NoRTM;
 450 #endif
 451 }
 452 
 453 nmethod* nmethod::new_native_nmethod(const methodHandle&amp; method,
 454   int compile_id,
 455   CodeBuffer *code_buffer,
 456   int vep_offset,
 457   int frame_complete,
 458   int frame_size,
 459   ByteSize basic_lock_owner_sp_offset,
 460   ByteSize basic_lock_sp_offset,
 461   OopMapSet* oop_maps,
 462   int exception_handler) {
 463   code_buffer-&gt;finalize_oop_references(method);
 464   // create nmethod
 465   nmethod* nm = NULL;
 466   {
 467     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
 468     int native_nmethod_size = CodeBlob::allocation_size(code_buffer, sizeof(nmethod));
 469 
 470     CodeOffsets offsets;
 471     offsets.set_value(CodeOffsets::Verified_Entry, vep_offset);
 472     offsets.set_value(CodeOffsets::Frame_Complete, frame_complete);
 473     if (exception_handler != -1) {
 474       offsets.set_value(CodeOffsets::Exceptions, exception_handler);
 475     }
 476     nm = new (native_nmethod_size, CompLevel_none)
 477     nmethod(method(), compiler_none, native_nmethod_size,
 478             compile_id, &amp;offsets,
 479             code_buffer, frame_size,
 480             basic_lock_owner_sp_offset,
 481             basic_lock_sp_offset,
 482             oop_maps);
 483     NOT_PRODUCT(if (nm != NULL)  native_nmethod_stats.note_native_nmethod(nm));
 484   }
 485 
 486   if (nm != NULL) {
 487     // verify nmethod
 488     debug_only(nm-&gt;verify();) // might block
 489 
 490     nm-&gt;log_new_nmethod();
 491   }
 492   return nm;
 493 }
 494 
 495 nmethod* nmethod::new_nmethod(const methodHandle&amp; method,
 496   int compile_id,
 497   int entry_bci,
 498   CodeOffsets* offsets,
 499   int orig_pc_offset,
 500   DebugInformationRecorder* debug_info,
 501   Dependencies* dependencies,
 502   CodeBuffer* code_buffer, int frame_size,
 503   OopMapSet* oop_maps,
 504   ExceptionHandlerTable* handler_table,
 505   ImplicitExceptionTable* nul_chk_table,
 506   AbstractCompiler* compiler,
 507   int comp_level
 508 #if INCLUDE_JVMCI
 509   , char* speculations,
 510   int speculations_len,
 511   int nmethod_mirror_index,
 512   const char* nmethod_mirror_name,
 513   FailedSpeculation** failed_speculations
 514 #endif
 515 )
 516 {
 517   assert(debug_info-&gt;oop_recorder() == code_buffer-&gt;oop_recorder(), &quot;shared OR&quot;);
 518   code_buffer-&gt;finalize_oop_references(method);
 519   // create nmethod
 520   nmethod* nm = NULL;
 521   { MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
 522 #if INCLUDE_JVMCI
 523     int jvmci_data_size = !compiler-&gt;is_jvmci() ? 0 : JVMCINMethodData::compute_size(nmethod_mirror_name);
 524 #endif
 525     int nmethod_size =
 526       CodeBlob::allocation_size(code_buffer, sizeof(nmethod))
 527       + adjust_pcs_size(debug_info-&gt;pcs_size())
 528       + align_up((int)dependencies-&gt;size_in_bytes(), oopSize)
 529       + align_up(handler_table-&gt;size_in_bytes()    , oopSize)
 530       + align_up(nul_chk_table-&gt;size_in_bytes()    , oopSize)
 531 #if INCLUDE_JVMCI
 532       + align_up(speculations_len                  , oopSize)
 533       + align_up(jvmci_data_size                   , oopSize)
 534 #endif
 535       + align_up(debug_info-&gt;data_size()           , oopSize);
 536 
 537     nm = new (nmethod_size, comp_level)
 538     nmethod(method(), compiler-&gt;type(), nmethod_size, compile_id, entry_bci, offsets,
 539             orig_pc_offset, debug_info, dependencies, code_buffer, frame_size,
 540             oop_maps,
 541             handler_table,
 542             nul_chk_table,
 543             compiler,
 544             comp_level
 545 #if INCLUDE_JVMCI
 546             , speculations,
 547             speculations_len,
 548             jvmci_data_size
 549 #endif
 550             );
 551 
 552     if (nm != NULL) {
 553 #if INCLUDE_JVMCI
 554       if (compiler-&gt;is_jvmci()) {
 555         // Initialize the JVMCINMethodData object inlined into nm
 556         nm-&gt;jvmci_nmethod_data()-&gt;initialize(nmethod_mirror_index, nmethod_mirror_name, failed_speculations);
 557       }
 558 #endif
 559       // To make dependency checking during class loading fast, record
 560       // the nmethod dependencies in the classes it is dependent on.
 561       // This allows the dependency checking code to simply walk the
 562       // class hierarchy above the loaded class, checking only nmethods
 563       // which are dependent on those classes.  The slow way is to
 564       // check every nmethod for dependencies which makes it linear in
 565       // the number of methods compiled.  For applications with a lot
 566       // classes the slow way is too slow.
 567       for (Dependencies::DepStream deps(nm); deps.next(); ) {
 568         if (deps.type() == Dependencies::call_site_target_value) {
 569           // CallSite dependencies are managed on per-CallSite instance basis.
 570           oop call_site = deps.argument_oop(0);
 571           MethodHandles::add_dependent_nmethod(call_site, nm);
 572         } else {
 573           Klass* klass = deps.context_type();
 574           if (klass == NULL) {
 575             continue;  // ignore things like evol_method
 576           }
 577           // record this nmethod as dependent on this klass
 578           InstanceKlass::cast(klass)-&gt;add_dependent_nmethod(nm);
 579         }
 580       }
 581       NOT_PRODUCT(if (nm != NULL)  note_java_nmethod(nm));
 582     }
 583   }
 584   // Do verification and logging outside CodeCache_lock.
 585   if (nm != NULL) {
 586     // Safepoints in nmethod::verify aren&#39;t allowed because nm hasn&#39;t been installed yet.
 587     DEBUG_ONLY(nm-&gt;verify();)
 588     nm-&gt;log_new_nmethod();
 589   }
 590   return nm;
 591 }
 592 
 593   class CountOops : public OopClosure {
 594   private:
 595     int _nr_oops;
 596   public:
 597     CountOops() : _nr_oops(0) {}
 598     int nr_oops() const { return _nr_oops; }
 599 
 600 
 601     virtual void do_oop(oop* o) { _nr_oops++; }
 602     virtual void do_oop(narrowOop* o) { _nr_oops++; }
 603   };
 604 
 605 // For native wrappers
 606 nmethod::nmethod(
 607   Method* method,
 608   CompilerType type,
 609   int nmethod_size,
 610   int compile_id,
 611   CodeOffsets* offsets,
 612   CodeBuffer* code_buffer,
 613   int frame_size,
 614   ByteSize basic_lock_owner_sp_offset,
 615   ByteSize basic_lock_sp_offset,
 616   OopMapSet* oop_maps )
 617   : CompiledMethod(method, &quot;native nmethod&quot;, type, nmethod_size, sizeof(nmethod), code_buffer, offsets-&gt;value(CodeOffsets::Frame_Complete), frame_size, oop_maps, false, true),
 618   _is_unloading_state(0),
 619   _native_receiver_sp_offset(basic_lock_owner_sp_offset),
 620   _native_basic_lock_sp_offset(basic_lock_sp_offset)
 621 {
 622   {
 623     int scopes_data_offset   = 0;
 624     int deoptimize_offset    = 0;
 625     int deoptimize_mh_offset = 0;
 626 
 627     debug_only(NoSafepointVerifier nsv;)
 628     assert_locked_or_safepoint(CodeCache_lock);
 629 
 630     init_defaults();
 631     _entry_bci               = InvocationEntryBci;
 632     // We have no exception handler or deopt handler make the
 633     // values something that will never match a pc like the nmethod vtable entry
 634     _exception_offset        = 0;
 635     _orig_pc_offset          = 0;
 636     _marking_cycle           = 0;
 637 
 638     _consts_offset           = data_offset();
 639     _stub_offset             = content_offset()      + code_buffer-&gt;total_offset_of(code_buffer-&gt;stubs());
 640     _oops_offset             = data_offset();
 641     _metadata_offset         = _oops_offset         + align_up(code_buffer-&gt;total_oop_size(), oopSize);
 642     scopes_data_offset       = _metadata_offset     + align_up(code_buffer-&gt;total_metadata_size(), wordSize);
 643     _scopes_pcs_offset       = scopes_data_offset;
 644     _dependencies_offset     = _scopes_pcs_offset;
 645     _handler_table_offset    = _dependencies_offset;
 646     _nul_chk_table_offset    = _handler_table_offset;
 647 #if INCLUDE_JVMCI
 648     _speculations_offset     = _nul_chk_table_offset;
 649     _jvmci_data_offset       = _speculations_offset;
 650     _nmethod_end_offset      = _jvmci_data_offset;
 651 #else
 652     _nmethod_end_offset      = _nul_chk_table_offset;
 653 #endif
 654     _compile_id              = compile_id;
 655     _comp_level              = CompLevel_none;
 656     _entry_point             = code_begin()          + offsets-&gt;value(CodeOffsets::Entry);
 657     _verified_entry_point    = code_begin()          + offsets-&gt;value(CodeOffsets::Verified_Entry);
 658     _osr_entry_point         = NULL;
 659     _exception_cache         = NULL;
 660     _pc_desc_container.reset_to(NULL);
 661     _hotness_counter         = NMethodSweeper::hotness_counter_reset_val();
 662 
 663     _exception_offset        = code_offset()          + offsets-&gt;value(CodeOffsets::Exceptions);
 664 
 665     _scopes_data_begin = (address) this + scopes_data_offset;
 666     _deopt_handler_begin = (address) this + deoptimize_offset;
 667     _deopt_mh_handler_begin = (address) this + deoptimize_mh_offset;
 668 
 669     code_buffer-&gt;copy_code_and_locs_to(this);
 670     code_buffer-&gt;copy_values_to(this);
 671 
 672     clear_unloading_state();
 673 
 674     Universe::heap()-&gt;register_nmethod(this);
 675     debug_only(Universe::heap()-&gt;verify_nmethod(this));
 676 
 677     CodeCache::commit(this);
 678   }
 679 
 680   if (PrintNativeNMethods || PrintDebugInfo || PrintRelocations || PrintDependencies) {
 681     ttyLocker ttyl;  // keep the following output all in one block
 682     // This output goes directly to the tty, not the compiler log.
 683     // To enable tools to match it up with the compilation activity,
 684     // be sure to tag this tty output with the compile ID.
 685     if (xtty != NULL) {
 686       xtty-&gt;begin_head(&quot;print_native_nmethod&quot;);
 687       xtty-&gt;method(_method);
 688       xtty-&gt;stamp();
 689       xtty-&gt;end_head(&quot; address=&#39;&quot; INTPTR_FORMAT &quot;&#39;&quot;, (intptr_t) this);
 690     }
 691     // Print the header part, then print the requested information.
 692     // This is both handled in decode2(), called via print_code() -&gt; decode()
 693     if (PrintNativeNMethods) {
 694       tty-&gt;print_cr(&quot;-------------------------- Assembly (native nmethod) ---------------------------&quot;);
 695       print_code();
 696       tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
 697 #if defined(SUPPORT_DATA_STRUCTS)
 698       if (AbstractDisassembler::show_structs()) {
 699         if (oop_maps != NULL) {
 700           tty-&gt;print(&quot;oop maps:&quot;); // oop_maps-&gt;print_on(tty) outputs a cr() at the beginning
 701           oop_maps-&gt;print_on(tty);
 702           tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
 703         }
 704       }
 705 #endif
 706     } else {
 707       print(); // print the header part only.
 708     }
 709 #if defined(SUPPORT_DATA_STRUCTS)
 710     if (AbstractDisassembler::show_structs()) {
 711       if (PrintRelocations) {
 712         print_relocations();
 713         tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
 714       }
 715     }
 716 #endif
 717     if (xtty != NULL) {
 718       xtty-&gt;tail(&quot;print_native_nmethod&quot;);
 719     }
 720   }
 721 }
 722 
 723 void* nmethod::operator new(size_t size, int nmethod_size, int comp_level) throw () {
 724   return CodeCache::allocate(nmethod_size, CodeCache::get_code_blob_type(comp_level));
 725 }
 726 
 727 nmethod::nmethod(
 728   Method* method,
 729   CompilerType type,
 730   int nmethod_size,
 731   int compile_id,
 732   int entry_bci,
 733   CodeOffsets* offsets,
 734   int orig_pc_offset,
 735   DebugInformationRecorder* debug_info,
 736   Dependencies* dependencies,
 737   CodeBuffer *code_buffer,
 738   int frame_size,
 739   OopMapSet* oop_maps,
 740   ExceptionHandlerTable* handler_table,
 741   ImplicitExceptionTable* nul_chk_table,
 742   AbstractCompiler* compiler,
 743   int comp_level
 744 #if INCLUDE_JVMCI
 745   , char* speculations,
 746   int speculations_len,
 747   int jvmci_data_size
 748 #endif
 749   )
 750   : CompiledMethod(method, &quot;nmethod&quot;, type, nmethod_size, sizeof(nmethod), code_buffer, offsets-&gt;value(CodeOffsets::Frame_Complete), frame_size, oop_maps, false, true),
 751   _is_unloading_state(0),
 752   _native_receiver_sp_offset(in_ByteSize(-1)),
 753   _native_basic_lock_sp_offset(in_ByteSize(-1))
 754 {
 755   assert(debug_info-&gt;oop_recorder() == code_buffer-&gt;oop_recorder(), &quot;shared OR&quot;);
 756   {
 757     debug_only(NoSafepointVerifier nsv;)
 758     assert_locked_or_safepoint(CodeCache_lock);
 759 
 760     _deopt_handler_begin = (address) this;
 761     _deopt_mh_handler_begin = (address) this;
 762 
 763     init_defaults();
 764     _entry_bci               = entry_bci;
 765     _compile_id              = compile_id;
 766     _comp_level              = comp_level;
 767     _orig_pc_offset          = orig_pc_offset;
 768     _hotness_counter         = NMethodSweeper::hotness_counter_reset_val();
 769 
 770     // Section offsets
 771     _consts_offset           = content_offset()      + code_buffer-&gt;total_offset_of(code_buffer-&gt;consts());
 772     _stub_offset             = content_offset()      + code_buffer-&gt;total_offset_of(code_buffer-&gt;stubs());
 773     set_ctable_begin(header_begin() + _consts_offset);
 774 
 775 #if INCLUDE_JVMCI
 776     if (compiler-&gt;is_jvmci()) {
 777       // JVMCI might not produce any stub sections
 778       if (offsets-&gt;value(CodeOffsets::Exceptions) != -1) {
 779         _exception_offset        = code_offset()          + offsets-&gt;value(CodeOffsets::Exceptions);
 780       } else {
 781         _exception_offset = -1;
 782       }
 783       if (offsets-&gt;value(CodeOffsets::Deopt) != -1) {
 784         _deopt_handler_begin       = (address) this + code_offset()          + offsets-&gt;value(CodeOffsets::Deopt);
 785       } else {
 786         _deopt_handler_begin = NULL;
 787       }
 788       if (offsets-&gt;value(CodeOffsets::DeoptMH) != -1) {
 789         _deopt_mh_handler_begin  = (address) this + code_offset()          + offsets-&gt;value(CodeOffsets::DeoptMH);
 790       } else {
 791         _deopt_mh_handler_begin = NULL;
 792       }
 793     } else
 794 #endif
 795     {
 796       // Exception handler and deopt handler are in the stub section
 797       assert(offsets-&gt;value(CodeOffsets::Exceptions) != -1, &quot;must be set&quot;);
 798       assert(offsets-&gt;value(CodeOffsets::Deopt     ) != -1, &quot;must be set&quot;);
 799 
 800       _exception_offset       = _stub_offset          + offsets-&gt;value(CodeOffsets::Exceptions);
 801       _deopt_handler_begin    = (address) this + _stub_offset          + offsets-&gt;value(CodeOffsets::Deopt);
 802       if (offsets-&gt;value(CodeOffsets::DeoptMH) != -1) {
 803         _deopt_mh_handler_begin  = (address) this + _stub_offset          + offsets-&gt;value(CodeOffsets::DeoptMH);
 804       } else {
 805         _deopt_mh_handler_begin  = NULL;
 806       }
 807     }
 808     if (offsets-&gt;value(CodeOffsets::UnwindHandler) != -1) {
 809       _unwind_handler_offset = code_offset()         + offsets-&gt;value(CodeOffsets::UnwindHandler);
 810     } else {
 811       _unwind_handler_offset = -1;
 812     }
 813 
 814     _oops_offset             = data_offset();
 815     _metadata_offset         = _oops_offset          + align_up(code_buffer-&gt;total_oop_size(), oopSize);
 816     int scopes_data_offset   = _metadata_offset      + align_up(code_buffer-&gt;total_metadata_size(), wordSize);
 817 
 818     _scopes_pcs_offset       = scopes_data_offset    + align_up(debug_info-&gt;data_size       (), oopSize);
 819     _dependencies_offset     = _scopes_pcs_offset    + adjust_pcs_size(debug_info-&gt;pcs_size());
 820     _handler_table_offset    = _dependencies_offset  + align_up((int)dependencies-&gt;size_in_bytes (), oopSize);
 821     _nul_chk_table_offset    = _handler_table_offset + align_up(handler_table-&gt;size_in_bytes(), oopSize);
 822 #if INCLUDE_JVMCI
 823     _speculations_offset     = _nul_chk_table_offset + align_up(nul_chk_table-&gt;size_in_bytes(), oopSize);
 824     _jvmci_data_offset       = _speculations_offset  + align_up(speculations_len, oopSize);
 825     _nmethod_end_offset      = _jvmci_data_offset    + align_up(jvmci_data_size, oopSize);
 826 #else
 827     _nmethod_end_offset      = _nul_chk_table_offset + align_up(nul_chk_table-&gt;size_in_bytes(), oopSize);
 828 #endif
 829     _entry_point             = code_begin()          + offsets-&gt;value(CodeOffsets::Entry);
 830     _verified_entry_point    = code_begin()          + offsets-&gt;value(CodeOffsets::Verified_Entry);
 831     _osr_entry_point         = code_begin()          + offsets-&gt;value(CodeOffsets::OSR_Entry);
 832     _exception_cache         = NULL;
 833     _scopes_data_begin       = (address) this + scopes_data_offset;
 834 
 835     _pc_desc_container.reset_to(scopes_pcs_begin());
 836 
 837     code_buffer-&gt;copy_code_and_locs_to(this);
 838     // Copy contents of ScopeDescRecorder to nmethod
 839     code_buffer-&gt;copy_values_to(this);
 840     debug_info-&gt;copy_to(this);
 841     dependencies-&gt;copy_to(this);
 842     clear_unloading_state();
 843 
 844     Universe::heap()-&gt;register_nmethod(this);
 845     debug_only(Universe::heap()-&gt;verify_nmethod(this));
 846 
 847     CodeCache::commit(this);
 848 
 849     // Copy contents of ExceptionHandlerTable to nmethod
 850     handler_table-&gt;copy_to(this);
 851     nul_chk_table-&gt;copy_to(this);
 852 
 853 #if INCLUDE_JVMCI
 854     // Copy speculations to nmethod
 855     if (speculations_size() != 0) {
 856       memcpy(speculations_begin(), speculations, speculations_len);
 857     }
 858 #endif
 859 
 860     // we use the information of entry points to find out if a method is
 861     // static or non static
 862     assert(compiler-&gt;is_c2() || compiler-&gt;is_jvmci() ||
 863            _method-&gt;is_static() == (entry_point() == _verified_entry_point),
 864            &quot; entry points must be same for static methods and vice versa&quot;);
 865 
 866     {
 867       CountOops count;
 868       this-&gt;oops_do(&amp;count, false, true);
 869       _nr_oops = count.nr_oops();
 870     }
 871   }
 872 }
 873 
 874 int nmethod::count_oops() {
 875   CountOops count;
 876   this-&gt;oops_do(&amp;count, false, true);
 877   return count.nr_oops();
 878 }
 879 
 880 // Print a short set of xml attributes to identify this nmethod.  The
 881 // output should be embedded in some other element.
 882 void nmethod::log_identity(xmlStream* log) const {
 883   log-&gt;print(&quot; compile_id=&#39;%d&#39;&quot;, compile_id());
 884   const char* nm_kind = compile_kind();
 885   if (nm_kind != NULL)  log-&gt;print(&quot; compile_kind=&#39;%s&#39;&quot;, nm_kind);
 886   log-&gt;print(&quot; compiler=&#39;%s&#39;&quot;, compiler_name());
 887   if (TieredCompilation) {
 888     log-&gt;print(&quot; level=&#39;%d&#39;&quot;, comp_level());
 889   }
 890 #if INCLUDE_JVMCI
 891   if (jvmci_nmethod_data() != NULL) {
 892     const char* jvmci_name = jvmci_nmethod_data()-&gt;name();
 893     if (jvmci_name != NULL) {
 894       log-&gt;print(&quot; jvmci_mirror_name=&#39;&quot;);
 895       log-&gt;text(&quot;%s&quot;, jvmci_name);
 896       log-&gt;print(&quot;&#39;&quot;);
 897     }
 898   }
 899 #endif
 900 }
 901 
 902 
 903 #define LOG_OFFSET(log, name)                    \
 904   if (p2i(name##_end()) - p2i(name##_begin())) \
 905     log-&gt;print(&quot; &quot; XSTR(name) &quot;_offset=&#39;&quot; INTX_FORMAT &quot;&#39;&quot;    , \
 906                p2i(name##_begin()) - p2i(this))
 907 
 908 
 909 void nmethod::log_new_nmethod() const {
 910   if (LogCompilation &amp;&amp; xtty != NULL) {
 911     ttyLocker ttyl;
 912     HandleMark hm;
 913     xtty-&gt;begin_elem(&quot;nmethod&quot;);
 914     log_identity(xtty);
 915     xtty-&gt;print(&quot; entry=&#39;&quot; INTPTR_FORMAT &quot;&#39; size=&#39;%d&#39;&quot;, p2i(code_begin()), size());
 916     xtty-&gt;print(&quot; address=&#39;&quot; INTPTR_FORMAT &quot;&#39;&quot;, p2i(this));
 917 
 918     LOG_OFFSET(xtty, relocation);
 919     LOG_OFFSET(xtty, consts);
 920     LOG_OFFSET(xtty, insts);
 921     LOG_OFFSET(xtty, stub);
 922     LOG_OFFSET(xtty, scopes_data);
 923     LOG_OFFSET(xtty, scopes_pcs);
 924     LOG_OFFSET(xtty, dependencies);
 925     LOG_OFFSET(xtty, handler_table);
 926     LOG_OFFSET(xtty, nul_chk_table);
 927     LOG_OFFSET(xtty, oops);
 928     LOG_OFFSET(xtty, metadata);
 929 
 930     xtty-&gt;method(method());
 931     xtty-&gt;stamp();
 932     xtty-&gt;end_elem();
 933   }
 934 }
 935 
 936 #undef LOG_OFFSET
 937 
 938 
 939 // Print out more verbose output usually for a newly created nmethod.
 940 void nmethod::print_on(outputStream* st, const char* msg) const {
 941   if (st != NULL) {
 942     ttyLocker ttyl;
 943     if (WizardMode) {
 944       CompileTask::print(st, this, msg, /*short_form:*/ true);
 945       st-&gt;print_cr(&quot; (&quot; INTPTR_FORMAT &quot;)&quot;, p2i(this));
 946     } else {
 947       CompileTask::print(st, this, msg, /*short_form:*/ false);
 948     }
 949   }
 950 }
 951 
 952 void nmethod::maybe_print_nmethod(DirectiveSet* directive) {
 953   bool printnmethods = directive-&gt;PrintAssemblyOption || directive-&gt;PrintNMethodsOption;
 954   if (printnmethods || PrintDebugInfo || PrintRelocations || PrintDependencies || PrintExceptionHandlers) {
 955     print_nmethod(printnmethods);
 956   }
 957 }
 958 
 959 void nmethod::print_nmethod(bool printmethod) {
 960   ttyLocker ttyl;  // keep the following output all in one block
 961   if (xtty != NULL) {
 962     xtty-&gt;begin_head(&quot;print_nmethod&quot;);
 963     log_identity(xtty);
 964     xtty-&gt;stamp();
 965     xtty-&gt;end_head();
 966   }
 967   // Print the header part, then print the requested information.
 968   // This is both handled in decode2().
 969   if (printmethod) {
 970     HandleMark hm;
 971     ResourceMark m;
 972     if (is_compiled_by_c1()) {
 973       tty-&gt;cr();
 974       tty-&gt;print_cr(&quot;============================= C1-compiled nmethod ==============================&quot;);
 975     }
 976     if (is_compiled_by_jvmci()) {
 977       tty-&gt;cr();
 978       tty-&gt;print_cr(&quot;=========================== JVMCI-compiled nmethod =============================&quot;);
 979     }
 980     tty-&gt;print_cr(&quot;----------------------------------- Assembly -----------------------------------&quot;);
 981     decode2(tty);
 982 #if defined(SUPPORT_DATA_STRUCTS)
 983     if (AbstractDisassembler::show_structs()) {
 984       // Print the oops from the underlying CodeBlob as well.
 985       tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
 986       print_oops(tty);
 987       tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
 988       print_metadata(tty);
 989       tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
 990       print_pcs();
 991       tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
 992       if (oop_maps() != NULL) {
 993         tty-&gt;print(&quot;oop maps:&quot;); // oop_maps()-&gt;print_on(tty) outputs a cr() at the beginning
 994         oop_maps()-&gt;print_on(tty);
 995         tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
 996       }
 997     }
 998 #endif
 999   } else {
1000     print(); // print the header part only.
1001   }
1002 
1003 #if defined(SUPPORT_DATA_STRUCTS)
1004   if (AbstractDisassembler::show_structs()) {
1005     methodHandle mh(Thread::current(), _method);
1006     if (printmethod || PrintDebugInfo || CompilerOracle::has_option_string(mh, &quot;PrintDebugInfo&quot;)) {
1007       print_scopes();
1008       tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
1009     }
1010     if (printmethod || PrintRelocations || CompilerOracle::has_option_string(mh, &quot;PrintRelocations&quot;)) {
1011       print_relocations();
1012       tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
1013     }
1014     if (printmethod || PrintDependencies || CompilerOracle::has_option_string(mh, &quot;PrintDependencies&quot;)) {
1015       print_dependencies();
1016       tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
1017     }
1018     if (printmethod || PrintExceptionHandlers) {
1019       print_handler_table();
1020       tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
1021       print_nul_chk_table();
1022       tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
1023     }
1024 
1025     if (printmethod) {
1026       print_recorded_oops();
1027       tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
1028       print_recorded_metadata();
1029       tty-&gt;print_cr(&quot;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &quot;);
1030     }
1031   }
1032 #endif
1033 
1034   if (xtty != NULL) {
1035     xtty-&gt;tail(&quot;print_nmethod&quot;);
1036   }
1037 }
1038 
1039 
1040 // Promote one word from an assembly-time handle to a live embedded oop.
1041 inline void nmethod::initialize_immediate_oop(oop* dest, jobject handle) {
1042   if (handle == NULL ||
1043       // As a special case, IC oops are initialized to 1 or -1.
1044       handle == (jobject) Universe::non_oop_word()) {
1045     (*dest) = (oop) handle;
1046   } else {
1047     (*dest) = JNIHandles::resolve_non_null(handle);
1048   }
1049 }
1050 
1051 
1052 // Have to have the same name because it&#39;s called by a template
1053 void nmethod::copy_values(GrowableArray&lt;jobject&gt;* array) {
1054   int length = array-&gt;length();
1055   assert((address)(oops_begin() + length) &lt;= (address)oops_end(), &quot;oops big enough&quot;);
1056   oop* dest = oops_begin();
1057   for (int index = 0 ; index &lt; length; index++) {
1058     initialize_immediate_oop(&amp;dest[index], array-&gt;at(index));
1059   }
1060 
1061   // Now we can fix up all the oops in the code.  We need to do this
1062   // in the code because the assembler uses jobjects as placeholders.
1063   // The code and relocations have already been initialized by the
1064   // CodeBlob constructor, so it is valid even at this early point to
1065   // iterate over relocations and patch the code.
1066   fix_oop_relocations(NULL, NULL, /*initialize_immediates=*/ true);
1067 }
1068 
1069 void nmethod::copy_values(GrowableArray&lt;Metadata*&gt;* array) {
1070   int length = array-&gt;length();
1071   assert((address)(metadata_begin() + length) &lt;= (address)metadata_end(), &quot;big enough&quot;);
1072   Metadata** dest = metadata_begin();
1073   for (int index = 0 ; index &lt; length; index++) {
1074     dest[index] = array-&gt;at(index);
1075   }
1076 }
1077 
1078 void nmethod::fix_oop_relocations(address begin, address end, bool initialize_immediates) {
1079   // re-patch all oop-bearing instructions, just in case some oops moved
1080   RelocIterator iter(this, begin, end);
1081   while (iter.next()) {
1082     if (iter.type() == relocInfo::oop_type) {
1083       oop_Relocation* reloc = iter.oop_reloc();
1084       if (initialize_immediates &amp;&amp; reloc-&gt;oop_is_immediate()) {
1085         oop* dest = reloc-&gt;oop_addr();
1086         initialize_immediate_oop(dest, cast_from_oop&lt;jobject&gt;(*dest));
1087       }
1088       // Refresh the oop-related bits of this instruction.
1089       reloc-&gt;fix_oop_relocation();
1090     } else if (iter.type() == relocInfo::metadata_type) {
1091       metadata_Relocation* reloc = iter.metadata_reloc();
1092       reloc-&gt;fix_metadata_relocation();
1093     }
1094   }
1095 }
1096 
1097 
1098 void nmethod::verify_clean_inline_caches() {
1099   assert(CompiledICLocker::is_safe(this), &quot;mt unsafe call&quot;);
1100 
1101   ResourceMark rm;
1102   RelocIterator iter(this, oops_reloc_begin());
1103   while(iter.next()) {
1104     switch(iter.type()) {
1105       case relocInfo::virtual_call_type:
1106       case relocInfo::opt_virtual_call_type: {
1107         CompiledIC *ic = CompiledIC_at(&amp;iter);
1108         // Ok, to lookup references to zombies here
1109         CodeBlob *cb = CodeCache::find_blob_unsafe(ic-&gt;ic_destination());
1110         assert(cb != NULL, &quot;destination not in CodeBlob?&quot;);
1111         nmethod* nm = cb-&gt;as_nmethod_or_null();
1112         if( nm != NULL ) {
1113           // Verify that inline caches pointing to both zombie and not_entrant methods are clean
1114           if (!nm-&gt;is_in_use() || (nm-&gt;method()-&gt;code() != nm)) {
1115             assert(ic-&gt;is_clean(), &quot;IC should be clean&quot;);
1116           }
1117         }
1118         break;
1119       }
1120       case relocInfo::static_call_type: {
1121         CompiledStaticCall *csc = compiledStaticCall_at(iter.reloc());
1122         CodeBlob *cb = CodeCache::find_blob_unsafe(csc-&gt;destination());
1123         assert(cb != NULL, &quot;destination not in CodeBlob?&quot;);
1124         nmethod* nm = cb-&gt;as_nmethod_or_null();
1125         if( nm != NULL ) {
1126           // Verify that inline caches pointing to both zombie and not_entrant methods are clean
1127           if (!nm-&gt;is_in_use() || (nm-&gt;method()-&gt;code() != nm)) {
1128             assert(csc-&gt;is_clean(), &quot;IC should be clean&quot;);
1129           }
1130         }
1131         break;
1132       }
1133       default:
1134         break;
1135     }
1136   }
1137 }
1138 
1139 // This is a private interface with the sweeper.
1140 void nmethod::mark_as_seen_on_stack() {
1141   assert(is_alive(), &quot;Must be an alive method&quot;);
1142   // Set the traversal mark to ensure that the sweeper does 2
1143   // cleaning passes before moving to zombie.
1144   set_stack_traversal_mark(NMethodSweeper::traversal_count());
1145 }
1146 
1147 void nmethod::mark_as_maybe_on_continuation() {
1148   assert(is_alive(), &quot;Must be an alive method&quot;);
1149   _marking_cycle = CodeCache::marking_cycle();
1150   BarrierSetNMethod* bs_nm = BarrierSet::barrier_set()-&gt;barrier_set_nmethod();
1151   if (bs_nm != NULL) {
1152     bs_nm-&gt;disarm(this);
1153   }
1154 }
1155 
1156 bool nmethod::is_not_on_continuation_stack() {
1157   // Odd marking cycles are found during concurrent marking. Even numbers are found
1158   // in nmethods that are marked when GC is inactive (e.g. nmethod entry barriers during
1159   // normal execution). Therefore we align up by 2 so that nmethods encountered during
1160   // concurrent marking are treated as if they were encountered in the inactive phase
1161   // after that concurrent GC. Each GC increments the marking cycle twice - once when
1162   // it starts and once when it ends. So we can only be sure there are no new continuations
1163   // when they have not been encountered from before a GC to after a GC.
1164   bool not_on_new_vthread_stack = CodeCache::marking_cycle() &gt;= align_up(_marking_cycle, 2) + 2;
1165 
1166   // As for old vthread stacks, they are kept alive by a WeakHandle.
1167   bool not_on_old_vthread_stack = false;
1168   if (_keepalive != NULL) {
1169     WeakHandle wh = WeakHandle::from_raw(_keepalive);
1170     not_on_old_vthread_stack = wh.resolve() == NULL;
1171   }
1172   return not_on_new_vthread_stack &amp;&amp; not_on_old_vthread_stack;
1173 }
1174 
1175 // Tell if a non-entrant method can be converted to a zombie (i.e.,
1176 // there are no activations on the stack, not in use by the VM,
1177 // and not in use by the ServiceThread)
1178 bool nmethod::can_convert_to_zombie() {
1179   // Note that this is called when the sweeper has observed the nmethod to be
1180   // not_entrant. However, with concurrent code cache unloading, the state
1181   // might have moved on to unloaded if it is_unloading(), due to racing
1182   // concurrent GC threads.
1183   assert(is_not_entrant() || is_unloading() ||
1184          !Thread::current()-&gt;is_Code_cache_sweeper_thread(),
1185          &quot;must be a non-entrant method if called from sweeper&quot;);
1186 
1187   // Since the nmethod sweeper only does partial sweep the sweeper&#39;s traversal
1188   // count can be greater than the stack traversal count before it hits the
1189   // nmethod for the second time.
1190   // If an is_unloading() nmethod is still not_entrant, then it is not safe to
1191   // convert it to zombie due to GC unloading interactions. However, if it
1192   // has become unloaded, then it is okay to convert such nmethods to zombie.
1193   return stack_traversal_mark()+1 &lt; NMethodSweeper::traversal_count() &amp;&amp; is_not_on_continuation_stack() &amp;&amp;
1194           !is_locked_by_vm() &amp;&amp; (!is_unloading() || is_unloaded());
1195 }
1196 
1197 void nmethod::inc_decompile_count() {
1198   if (!is_compiled_by_c2() &amp;&amp; !is_compiled_by_jvmci()) return;
1199   // Could be gated by ProfileTraps, but do not bother...
1200   Method* m = method();
1201   if (m == NULL)  return;
1202   MethodData* mdo = m-&gt;method_data();
1203   if (mdo == NULL)  return;
1204   // There is a benign race here.  See comments in methodData.hpp.
1205   mdo-&gt;inc_decompile_count();
1206 }
1207 
1208 bool nmethod::try_transition(int new_state_int) {
1209   signed char new_state = new_state_int;
1210 #ifdef DEBUG
1211   if (new_state != unloaded) {
1212     assert_lock_strong(CompiledMethod_lock);
1213   }
1214 #endif
1215   for (;;) {
1216     signed char old_state = Atomic::load(&amp;_state);
1217     if (old_state &gt;= new_state) {
1218       // Ensure monotonicity of transitions.
1219       return false;
1220     }
1221     if (Atomic::cmpxchg(&amp;_state, old_state, new_state) == old_state) {
1222       return true;
1223     }
1224   }
1225 }
1226 
1227 void nmethod::make_unloaded() {
1228   post_compiled_method_unload();
1229 
1230   // This nmethod is being unloaded, make sure that dependencies
1231   // recorded in instanceKlasses get flushed.
1232   // Since this work is being done during a GC, defer deleting dependencies from the
1233   // InstanceKlass.
1234   assert(Universe::heap()-&gt;is_gc_active() || Thread::current()-&gt;is_ConcurrentGC_thread(),
1235          &quot;should only be called during gc&quot;);
1236   flush_dependencies(/*delete_immediately*/false);
1237 
1238   // Break cycle between nmethod &amp; method
1239   LogTarget(Trace, class, unload, nmethod) lt;
1240   if (lt.is_enabled()) {
1241     LogStream ls(lt);
1242     ls.print(&quot;making nmethod &quot; INTPTR_FORMAT
1243              &quot; unloadable, Method*(&quot; INTPTR_FORMAT
1244              &quot;) &quot;,
1245              p2i(this), p2i(_method));
1246      ls.cr();
1247   }
1248   // Unlink the osr method, so we do not look this up again
1249   if (is_osr_method()) {
1250     // Invalidate the osr nmethod only once. Note that with concurrent
1251     // code cache unloading, OSR nmethods are invalidated before they
1252     // are made unloaded. Therefore, this becomes a no-op then.
1253     if (is_in_use()) {
1254       invalidate_osr_method();
1255     }
1256 #ifdef ASSERT
1257     if (method() != NULL) {
1258       // Make sure osr nmethod is invalidated, i.e. not on the list
1259       bool found = method()-&gt;method_holder()-&gt;remove_osr_nmethod(this);
1260       assert(!found, &quot;osr nmethod should have been invalidated&quot;);
1261     }
1262 #endif
1263   }
1264 
1265   // If _method is already NULL the Method* is about to be unloaded,
1266   // so we don&#39;t have to break the cycle. Note that it is possible to
1267   // have the Method* live here, in case we unload the nmethod because
1268   // it is pointing to some oop (other than the Method*) being unloaded.
1269   if (_method != NULL) {
1270     _method-&gt;unlink_code(this);
1271   }
1272 
1273   // Make the class unloaded - i.e., change state and notify sweeper
1274   assert(SafepointSynchronize::is_at_safepoint() || Thread::current()-&gt;is_ConcurrentGC_thread(),
1275          &quot;must be at safepoint&quot;);
1276 
1277   {
1278     // Clear ICStubs and release any CompiledICHolders.
1279     CompiledICLocker ml(this);
1280     clear_ic_callsites();
1281   }
1282 
1283   // Unregister must be done before the state change
1284   {
1285     MutexLocker ml(SafepointSynchronize::is_at_safepoint() ? NULL : CodeCache_lock,
1286                      Mutex::_no_safepoint_check_flag);
1287     Universe::heap()-&gt;unregister_nmethod(this);
1288   }
1289 
1290   // Clear the method of this dead nmethod
1291   set_method(NULL);
1292 
1293   // Log the unloading.
1294   log_state_change();
1295 
1296   // The Method* is gone at this point
1297   assert(_method == NULL, &quot;Tautology&quot;);
1298 
1299   set_osr_link(NULL);
1300   NMethodSweeper::report_state_change(this);
1301 
1302   bool transition_success = try_transition(unloaded);
1303 
1304   // It is an important invariant that there exists no race between
1305   // the sweeper and GC thread competing for making the same nmethod
1306   // zombie and unloaded respectively. This is ensured by
1307   // can_convert_to_zombie() returning false for any is_unloading()
1308   // nmethod, informing the sweeper not to step on any GC toes.
1309   assert(transition_success, &quot;Invalid nmethod transition to unloaded&quot;);
1310 
1311 #if INCLUDE_JVMCI
1312   // Clear the link between this nmethod and a HotSpotNmethod mirror
1313   JVMCINMethodData* nmethod_data = jvmci_nmethod_data();
1314   if (nmethod_data != NULL) {
1315     nmethod_data-&gt;invalidate_nmethod_mirror(this);
1316     nmethod_data-&gt;clear_nmethod_mirror(this);
1317   }
1318 #endif
1319 }
1320 
1321 void nmethod::invalidate_osr_method() {
1322   assert(_entry_bci != InvocationEntryBci, &quot;wrong kind of nmethod&quot;);
1323   // Remove from list of active nmethods
1324   if (method() != NULL) {
1325     method()-&gt;method_holder()-&gt;remove_osr_nmethod(this);
1326   }
1327 }
1328 
1329 void nmethod::log_state_change() const {
1330   if (LogCompilation) {
1331     if (xtty != NULL) {
1332       ttyLocker ttyl;  // keep the following output all in one block
1333       if (_state == unloaded) {
1334         xtty-&gt;begin_elem(&quot;make_unloaded thread=&#39;&quot; UINTX_FORMAT &quot;&#39;&quot;,
1335                          os::current_thread_id());
1336       } else {
1337         xtty-&gt;begin_elem(&quot;make_not_entrant thread=&#39;&quot; UINTX_FORMAT &quot;&#39;%s&quot;,
1338                          os::current_thread_id(),
1339                          (_state == zombie ? &quot; zombie=&#39;1&#39;&quot; : &quot;&quot;));
1340       }
1341       log_identity(xtty);
1342       xtty-&gt;stamp();
1343       xtty-&gt;end_elem();
1344     }
1345   }
1346 
1347   const char *state_msg = _state == zombie ? &quot;made zombie&quot; : &quot;made not entrant&quot;;
1348   CompileTask::print_ul(this, state_msg);
1349   if (PrintCompilation &amp;&amp; _state != unloaded) {
1350     print_on(tty, state_msg);
1351   }
1352 }
1353 
1354 void nmethod::unlink_from_method() {
1355   if (method() != NULL) {
1356     method()-&gt;unlink_code(this);
1357   }
1358 }
1359 
1360 /**
1361  * Common functionality for both make_not_entrant and make_zombie
1362  */
1363 bool nmethod::make_not_entrant_or_zombie(int state) {
1364   assert(state == zombie || state == not_entrant, &quot;must be zombie or not_entrant&quot;);
1365 
1366   if (Atomic::load(&amp;_state) &gt;= state) {
1367     // Avoid taking the lock if already in required state.
1368     // This is safe from races because the state is an end-state,
1369     // which the nmethod cannot back out of once entered.
1370     // No need for fencing either.
1371     return false;
1372   }
1373 
1374   // Make sure the nmethod is not flushed.
1375   nmethodLocker nml(this);
1376   // This can be called while the system is already at a safepoint which is ok
1377   NoSafepointVerifier nsv;
1378 
1379   // during patching, depending on the nmethod state we must notify the GC that
1380   // code has been unloaded, unregistering it. We cannot do this right while
1381   // holding the CompiledMethod_lock because we need to use the CodeCache_lock. This
1382   // would be prone to deadlocks.
1383   // This flag is used to remember whether we need to later lock and unregister.
1384   bool nmethod_needs_unregister = false;
1385 
1386   {
1387     // Enter critical section.  Does not block for safepoint.
1388     MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock, Mutex::_no_safepoint_check_flag);
1389 
1390     // This logic is equivalent to the logic below for patching the
1391     // verified entry point of regular methods. We check that the
1392     // nmethod is in use to ensure that it is invalidated only once.
1393     if (is_osr_method() &amp;&amp; is_in_use()) {
1394       // this effectively makes the osr nmethod not entrant
1395       invalidate_osr_method();
1396     }
1397 
1398     if (Atomic::load(&amp;_state) &gt;= state) {
1399       // another thread already performed this transition so nothing
1400       // to do, but return false to indicate this.
1401       return false;
1402     }
1403 
1404     // The caller can be calling the method statically or through an inline
1405     // cache call.
1406     if (!is_osr_method() &amp;&amp; !is_not_entrant()) {
1407       NativeJump::patch_verified_entry(entry_point(), verified_entry_point(),
1408                   SharedRuntime::get_handle_wrong_method_stub());
1409     }
1410 
1411     if (is_in_use() &amp;&amp; update_recompile_counts()) {
1412       // It&#39;s a true state change, so mark the method as decompiled.
1413       // Do it only for transition from alive.
1414       inc_decompile_count();
1415     }
1416 
1417     // If the state is becoming a zombie, signal to unregister the nmethod with
1418     // the heap.
1419     // This nmethod may have already been unloaded during a full GC.
1420     if ((state == zombie) &amp;&amp; !is_unloaded()) {
1421       nmethod_needs_unregister = true;
1422     }
1423 
1424     // Must happen before state change. Otherwise we have a race condition in
1425     // nmethod::can_convert_to_zombie(). I.e., a method can immediately
1426     // transition its state from &#39;not_entrant&#39; to &#39;zombie&#39; without having to wait
1427     // for stack scanning.
1428     if (state == not_entrant) {
1429       mark_as_seen_on_stack();
1430       OrderAccess::storestore(); // _stack_traversal_mark and _state
1431     }
1432 
1433     // Change state
1434     if (!try_transition(state)) {
1435       // If the transition fails, it is due to another thread making the nmethod more
1436       // dead. In particular, one thread might be making the nmethod unloaded concurrently.
1437       // If so, having patched in the jump in the verified entry unnecessarily is fine.
1438       // The nmethod is no longer possible to call by Java threads.
1439       // Incrementing the decompile count is also fine as the caller of make_not_entrant()
1440       // had a valid reason to deoptimize the nmethod.
1441       // Marking the nmethod as seen on stack also has no effect, as the nmethod is now
1442       // !is_alive(), and the seen on stack value is only used to convert not_entrant
1443       // nmethods to zombie in can_convert_to_zombie().
1444       return false;
1445     }
1446 
1447     // Log the transition once
1448     log_state_change();
1449 
1450     // Remove nmethod from method.
1451     unlink_from_method();
1452 
1453   } // leave critical region under CompiledMethod_lock
1454 
1455 #if INCLUDE_JVMCI
1456   // Invalidate can&#39;t occur while holding the Patching lock
1457   JVMCINMethodData* nmethod_data = jvmci_nmethod_data();
1458   if (nmethod_data != NULL) {
1459     nmethod_data-&gt;invalidate_nmethod_mirror(this);
1460   }
1461 #endif
1462 
1463 #ifdef ASSERT
1464   if (is_osr_method() &amp;&amp; method() != NULL) {
1465     // Make sure osr nmethod is invalidated, i.e. not on the list
1466     bool found = method()-&gt;method_holder()-&gt;remove_osr_nmethod(this);
1467     assert(!found, &quot;osr nmethod should have been invalidated&quot;);
1468   }
1469 #endif
1470 
1471   // When the nmethod becomes zombie it is no longer alive so the
1472   // dependencies must be flushed.  nmethods in the not_entrant
1473   // state will be flushed later when the transition to zombie
1474   // happens or they get unloaded.
1475   if (state == zombie) {
1476     {
1477       // Flushing dependencies must be done before any possible
1478       // safepoint can sneak in, otherwise the oops used by the
1479       // dependency logic could have become stale.
1480       MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1481       if (nmethod_needs_unregister) {
1482         Universe::heap()-&gt;unregister_nmethod(this);
1483       }
1484       flush_dependencies(/*delete_immediately*/true);
1485     }
1486 
1487 #if INCLUDE_JVMCI
1488     // Now that the nmethod has been unregistered, it&#39;s
1489     // safe to clear the HotSpotNmethod mirror oop.
1490     if (nmethod_data != NULL) {
1491       nmethod_data-&gt;clear_nmethod_mirror(this);
1492     }
1493 #endif
1494 
1495     // Clear ICStubs to prevent back patching stubs of zombie or flushed
1496     // nmethods during the next safepoint (see ICStub::finalize), as well
1497     // as to free up CompiledICHolder resources.
1498     {
1499       CompiledICLocker ml(this);
1500       clear_ic_callsites();
1501     }
1502 
1503     // zombie only - if a JVMTI agent has enabled the CompiledMethodUnload
1504     // event and it hasn&#39;t already been reported for this nmethod then
1505     // report it now. The event may have been reported earlier if the GC
1506     // marked it for unloading). JvmtiDeferredEventQueue support means
1507     // we no longer go to a safepoint here.
1508     post_compiled_method_unload();
1509 
1510 #ifdef ASSERT
1511     // It&#39;s no longer safe to access the oops section since zombie
1512     // nmethods aren&#39;t scanned for GC.
1513     _oops_are_stale = true;
1514 #endif
1515      // the Method may be reclaimed by class unloading now that the
1516      // nmethod is in zombie state
1517     set_method(NULL);
1518   } else {
1519     assert(state == not_entrant, &quot;other cases may need to be handled differently&quot;);
1520   }
1521 
1522   if (TraceCreateZombies &amp;&amp; state == zombie) {
1523     ResourceMark m;
1524     tty-&gt;print_cr(&quot;nmethod &lt;&quot; INTPTR_FORMAT &quot;&gt; %s code made %s&quot;, p2i(this), this-&gt;method() ? this-&gt;method()-&gt;name_and_sig_as_C_string() : &quot;null&quot;, (state == not_entrant) ? &quot;not entrant&quot; : &quot;zombie&quot;);
1525   }
1526 
1527   NMethodSweeper::report_state_change(this);
1528   return true;
1529 }
1530 
1531 void nmethod::flush() {
1532   MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1533   // Note that there are no valid oops in the nmethod anymore.
1534   assert(!is_osr_method() || is_unloaded() || is_zombie(),
1535          &quot;osr nmethod must be unloaded or zombie before flushing&quot;);
1536   assert(is_zombie() || is_osr_method(), &quot;must be a zombie method&quot;);
1537   assert (!is_locked_by_vm(), &quot;locked methods shouldn&#39;t be flushed&quot;);
1538   assert_locked_or_safepoint(CodeCache_lock);
1539 
1540   // completely deallocate this method
1541   Events::log(JavaThread::current(), &quot;flushing nmethod &quot; INTPTR_FORMAT, p2i(this));
1542   if (PrintMethodFlushing) {
1543     tty-&gt;print_cr(&quot;*flushing %s nmethod %3d/&quot; INTPTR_FORMAT &quot;. Live blobs:&quot; UINT32_FORMAT
1544                   &quot;/Free CodeCache:&quot; SIZE_FORMAT &quot;Kb&quot;,
1545                   is_osr_method() ? &quot;osr&quot; : &quot;&quot;,_compile_id, p2i(this), CodeCache::blob_count(),
1546                   CodeCache::unallocated_capacity(CodeCache::get_code_blob_type(this))/1024);
1547   }
1548 
1549   // We need to deallocate any ExceptionCache data.
1550   // Note that we do not need to grab the nmethod lock for this, it
1551   // better be thread safe if we&#39;re disposing of it!
1552   ExceptionCache* ec = exception_cache();
1553   set_exception_cache(NULL);
1554   while(ec != NULL) {
1555     ExceptionCache* next = ec-&gt;next();
1556     delete ec;
1557     ec = next;
1558   }
1559 
1560   Universe::heap()-&gt;flush_nmethod(this);
1561   CodeCache::unregister_old_nmethod(this);
1562 
1563   CodeBlob::flush();
1564   CodeCache::free(this);
1565 }
1566 
1567 oop nmethod::oop_at(int index) const {
1568   if (index == 0) {
1569     return NULL;
1570   }
1571   return NativeAccess&lt;AS_NO_KEEPALIVE&gt;::oop_load(oop_addr_at(index));
1572 }
1573 
1574 oop nmethod::oop_at_phantom(int index) const {
1575   if (index == 0) {
1576     return NULL;
1577   }
1578   return NativeAccess&lt;ON_PHANTOM_OOP_REF&gt;::oop_load(oop_addr_at(index));
1579 }
1580 
1581 //
1582 // Notify all classes this nmethod is dependent on that it is no
1583 // longer dependent. This should only be called in two situations.
1584 // First, when a nmethod transitions to a zombie all dependents need
1585 // to be clear.  Since zombification happens at a safepoint there&#39;s no
1586 // synchronization issues.  The second place is a little more tricky.
1587 // During phase 1 of mark sweep class unloading may happen and as a
1588 // result some nmethods may get unloaded.  In this case the flushing
1589 // of dependencies must happen during phase 1 since after GC any
1590 // dependencies in the unloaded nmethod won&#39;t be updated, so
1591 // traversing the dependency information in unsafe.  In that case this
1592 // function is called with a boolean argument and this function only
1593 // notifies instanceKlasses that are reachable
1594 
1595 void nmethod::flush_dependencies(bool delete_immediately) {
1596   DEBUG_ONLY(bool called_by_gc = Universe::heap()-&gt;is_gc_active() || Thread::current()-&gt;is_ConcurrentGC_thread();)
1597   assert(called_by_gc != delete_immediately,
1598   &quot;delete_immediately is false if and only if we are called during GC&quot;);
1599   if (!has_flushed_dependencies()) {
1600     set_has_flushed_dependencies();
1601     for (Dependencies::DepStream deps(this); deps.next(); ) {
1602       if (deps.type() == Dependencies::call_site_target_value) {
1603         // CallSite dependencies are managed on per-CallSite instance basis.
1604         oop call_site = deps.argument_oop(0);
1605         if (delete_immediately) {
1606           assert_locked_or_safepoint(CodeCache_lock);
1607           MethodHandles::remove_dependent_nmethod(call_site, this);
1608         } else {
1609           MethodHandles::clean_dependency_context(call_site);
1610         }
1611       } else {
1612         Klass* klass = deps.context_type();
1613         if (klass == NULL) {
1614           continue;  // ignore things like evol_method
1615         }
1616         // During GC delete_immediately is false, and liveness
1617         // of dependee determines class that needs to be updated.
1618         if (delete_immediately) {
1619           assert_locked_or_safepoint(CodeCache_lock);
1620           InstanceKlass::cast(klass)-&gt;remove_dependent_nmethod(this);
1621         } else if (klass-&gt;is_loader_alive()) {
1622           // The GC may clean dependency contexts concurrently and in parallel.
1623           InstanceKlass::cast(klass)-&gt;clean_dependency_context();
1624         }
1625       }
1626     }
1627   }
1628 }
1629 
1630 // ------------------------------------------------------------------
1631 // post_compiled_method_load_event
1632 // new method for install_code() path
1633 // Transfer information from compilation to jvmti
1634 void nmethod::post_compiled_method_load_event(JvmtiThreadState* state) {
1635 
1636   // Don&#39;t post this nmethod load event if it is already dying
1637   // because the sweeper might already be deleting this nmethod.
1638   if (is_not_entrant() &amp;&amp; can_convert_to_zombie()) {
1639     return;
1640   }
1641 
1642   // This is a bad time for a safepoint.  We don&#39;t want
1643   // this nmethod to get unloaded while we&#39;re queueing the event.
1644   NoSafepointVerifier nsv;
1645 
1646   Method* m = method();
1647   HOTSPOT_COMPILED_METHOD_LOAD(
1648       (char *) m-&gt;klass_name()-&gt;bytes(),
1649       m-&gt;klass_name()-&gt;utf8_length(),
1650       (char *) m-&gt;name()-&gt;bytes(),
1651       m-&gt;name()-&gt;utf8_length(),
1652       (char *) m-&gt;signature()-&gt;bytes(),
1653       m-&gt;signature()-&gt;utf8_length(),
1654       insts_begin(), insts_size());
1655 
1656 
1657   if (JvmtiExport::should_post_compiled_method_load()) {
1658     // Only post unload events if load events are found.
1659     set_load_reported();
1660     // If a JavaThread hasn&#39;t been passed in, let the Service thread
1661     // (which is a real Java thread) post the event
1662     JvmtiDeferredEvent event = JvmtiDeferredEvent::compiled_method_load_event(this);
1663     if (state == NULL) {
1664       // Execute any barrier code for this nmethod as if it&#39;s called, since
1665       // keeping it alive looks like stack walking.
1666       run_nmethod_entry_barrier();
1667       ServiceThread::enqueue_deferred_event(&amp;event);
1668     } else {
1669       // This enters the nmethod barrier outside in the caller.
1670       state-&gt;enqueue_event(&amp;event);
1671     }
1672   }
1673 }
1674 
1675 void nmethod::post_compiled_method_unload() {
1676   if (unload_reported()) {
1677     // During unloading we transition to unloaded and then to zombie
1678     // and the unloading is reported during the first transition.
1679     return;
1680   }
1681 
1682   assert(_method != NULL &amp;&amp; !is_unloaded(), &quot;just checking&quot;);
1683   DTRACE_METHOD_UNLOAD_PROBE(method());
1684 
1685   // If a JVMTI agent has enabled the CompiledMethodUnload event then
1686   // post the event. Sometime later this nmethod will be made a zombie
1687   // by the sweeper but the Method* will not be valid at that point.
1688   // The jmethodID is a weak reference to the Method* so if
1689   // it&#39;s being unloaded there&#39;s no way to look it up since the weak
1690   // ref will have been cleared.
1691 
1692   // Don&#39;t bother posting the unload if the load event wasn&#39;t posted.
1693   if (load_reported() &amp;&amp; JvmtiExport::should_post_compiled_method_unload()) {
1694     assert(!unload_reported(), &quot;already unloaded&quot;);
1695     JvmtiDeferredEvent event =
1696       JvmtiDeferredEvent::compiled_method_unload_event(
1697           method()-&gt;jmethod_id(), insts_begin());
1698     ServiceThread::enqueue_deferred_event(&amp;event);
1699   }
1700 
1701   // The JVMTI CompiledMethodUnload event can be enabled or disabled at
1702   // any time. As the nmethod is being unloaded now we mark it has
1703   // having the unload event reported - this will ensure that we don&#39;t
1704   // attempt to report the event in the unlikely scenario where the
1705   // event is enabled at the time the nmethod is made a zombie.
1706   set_unload_reported();
1707 }
1708 
1709 // Iterate over metadata calling this function.   Used by RedefineClasses
1710 void nmethod::metadata_do(MetadataClosure* f) {
1711   {
1712     // Visit all immediate references that are embedded in the instruction stream.
1713     RelocIterator iter(this, oops_reloc_begin());
1714     while (iter.next()) {
1715       if (iter.type() == relocInfo::metadata_type) {
1716         metadata_Relocation* r = iter.metadata_reloc();
1717         // In this metadata, we must only follow those metadatas directly embedded in
1718         // the code.  Other metadatas (oop_index&gt;0) are seen as part of
1719         // the metadata section below.
1720         assert(1 == (r-&gt;metadata_is_immediate()) +
1721                (r-&gt;metadata_addr() &gt;= metadata_begin() &amp;&amp; r-&gt;metadata_addr() &lt; metadata_end()),
1722                &quot;metadata must be found in exactly one place&quot;);
1723         if (r-&gt;metadata_is_immediate() &amp;&amp; r-&gt;metadata_value() != NULL) {
1724           Metadata* md = r-&gt;metadata_value();
1725           if (md != _method) f-&gt;do_metadata(md);
1726         }
1727       } else if (iter.type() == relocInfo::virtual_call_type) {
1728         // Check compiledIC holders associated with this nmethod
1729         ResourceMark rm;
1730         CompiledIC *ic = CompiledIC_at(&amp;iter);
1731         if (ic-&gt;is_icholder_call()) {
1732           CompiledICHolder* cichk = ic-&gt;cached_icholder();
1733           f-&gt;do_metadata(cichk-&gt;holder_metadata());
1734           f-&gt;do_metadata(cichk-&gt;holder_klass());
1735         } else {
1736           Metadata* ic_oop = ic-&gt;cached_metadata();
1737           if (ic_oop != NULL) {
1738             f-&gt;do_metadata(ic_oop);
1739           }
1740         }
1741       }
1742     }
1743   }
1744 
1745   // Visit the metadata section
1746   for (Metadata** p = metadata_begin(); p &lt; metadata_end(); p++) {
1747     if (*p == Universe::non_oop_word() || *p == NULL)  continue;  // skip non-oops
1748     Metadata* md = *p;
1749     f-&gt;do_metadata(md);
1750   }
1751 
1752   // Visit metadata not embedded in the other places.
1753   if (_method != NULL) f-&gt;do_metadata(_method);
1754 }
1755 
1756 // The _is_unloading_state encodes a tuple comprising the unloading cycle
1757 // and the result of IsUnloadingBehaviour::is_unloading() fpr that cycle.
1758 // This is the bit layout of the _is_unloading_state byte: 00000CCU
1759 // CC refers to the cycle, which has 2 bits, and U refers to the result of
1760 // IsUnloadingBehaviour::is_unloading() for that unloading cycle.
1761 
1762 class IsUnloadingState: public AllStatic {
1763   static const uint8_t _is_unloading_mask = 1;
1764   static const uint8_t _is_unloading_shift = 0;
1765   static const uint8_t _unloading_cycle_mask = 6;
1766   static const uint8_t _unloading_cycle_shift = 1;
1767 
1768   static uint8_t set_is_unloading(uint8_t state, bool value) {
1769     state &amp;= ~_is_unloading_mask;
1770     if (value) {
1771       state |= 1 &lt;&lt; _is_unloading_shift;
1772     }
1773     assert(is_unloading(state) == value, &quot;unexpected unloading cycle overflow&quot;);
1774     return state;
1775   }
1776 
1777   static uint8_t set_unloading_cycle(uint8_t state, uint8_t value) {
1778     state &amp;= ~_unloading_cycle_mask;
1779     state |= value &lt;&lt; _unloading_cycle_shift;
1780     assert(unloading_cycle(state) == value, &quot;unexpected unloading cycle overflow&quot;);
1781     return state;
1782   }
1783 
1784 public:
1785   static bool is_unloading(uint8_t state) { return (state &amp; _is_unloading_mask) &gt;&gt; _is_unloading_shift == 1; }
1786   static uint8_t unloading_cycle(uint8_t state) { return (state &amp; _unloading_cycle_mask) &gt;&gt; _unloading_cycle_shift; }
1787 
1788   static uint8_t create(bool is_unloading, uint8_t unloading_cycle) {
1789     uint8_t state = 0;
1790     state = set_is_unloading(state, is_unloading);
1791     state = set_unloading_cycle(state, unloading_cycle);
1792     return state;
1793   }
1794 };
1795 
1796 bool nmethod::is_unloading() {
1797   uint8_t state = RawAccess&lt;MO_RELAXED&gt;::load(&amp;_is_unloading_state);
1798   bool state_is_unloading = IsUnloadingState::is_unloading(state);
1799   uint8_t state_unloading_cycle = IsUnloadingState::unloading_cycle(state);
1800   if (state_is_unloading) {
1801     return true;
1802   }
1803   uint8_t current_cycle = CodeCache::unloading_cycle();
1804   if (state_unloading_cycle == current_cycle) {
1805     return false;
1806   }
1807 
1808   // The IsUnloadingBehaviour is responsible for checking if there are any dead
1809   // oops in the CompiledMethod, by calling oops_do on it.
1810   state_unloading_cycle = current_cycle;
1811 
1812   if (is_zombie()) {
1813     // Zombies without calculated unloading epoch are never unloading due to GC.
1814 
1815     // There are no races where a previously observed is_unloading() nmethod
1816     // suddenly becomes not is_unloading() due to here being observed as zombie.
1817 
1818     // With STW unloading, all is_alive() &amp;&amp; is_unloading() nmethods are unlinked
1819     // and unloaded in the safepoint. That makes races where an nmethod is first
1820     // observed as is_alive() &amp;&amp; is_unloading() and subsequently observed as
1821     // is_zombie() impossible.
1822 
1823     // With concurrent unloading, all references to is_unloading() nmethods are
1824     // first unlinked (e.g. IC caches and dependency contexts). Then a global
1825     // handshake operation is performed with all JavaThreads before finally
1826     // unloading the nmethods. The sweeper never converts is_alive() &amp;&amp; is_unloading()
1827     // nmethods to zombies; it waits for them to become is_unloaded(). So before
1828     // the global handshake, it is impossible for is_unloading() nmethods to
1829     // racingly become is_zombie(). And is_unloading() is calculated for all is_alive()
1830     // nmethods before taking that global handshake, meaning that it will never
1831     // be recalculated after the handshake.
1832 
1833     // After that global handshake, is_unloading() nmethods are only observable
1834     // to the iterators, and they will never trigger recomputation of the cached
1835     // is_unloading_state, and hence may not suffer from such races.
1836 
1837     state_is_unloading = false;
1838   } else {
1839     state_is_unloading = IsUnloadingBehaviour::current()-&gt;is_unloading(this);
1840   }
1841 
1842   state = IsUnloadingState::create(state_is_unloading, state_unloading_cycle);
1843 
1844   RawAccess&lt;MO_RELAXED&gt;::store(&amp;_is_unloading_state, state);
1845 
1846   return state_is_unloading;
1847 }
1848 
1849 void nmethod::clear_unloading_state() {
1850   uint8_t state = IsUnloadingState::create(false, CodeCache::unloading_cycle());
1851   RawAccess&lt;MO_RELAXED&gt;::store(&amp;_is_unloading_state, state);
1852 }
1853 
1854 
1855 // This is called at the end of the strong tracing/marking phase of a
1856 // GC to unload an nmethod if it contains otherwise unreachable
1857 // oops.
1858 
1859 void nmethod::do_unloading(bool unloading_occurred) {
1860   // Make sure the oop&#39;s ready to receive visitors
1861   assert(!is_zombie() &amp;&amp; !is_unloaded(),
1862          &quot;should not call follow on zombie or unloaded nmethod&quot;);
1863 
1864   if (is_unloading()) {
1865     make_unloaded();
1866   } else {
1867     guarantee(unload_nmethod_caches(unloading_occurred),
1868               &quot;Should not need transition stubs&quot;);
1869     BarrierSetNMethod* bs_nm = BarrierSet::barrier_set()-&gt;barrier_set_nmethod();
1870     if (bs_nm != NULL) {
1871       bs_nm-&gt;disarm(this);
1872     }
1873   }
1874 }
1875 
1876 void nmethod::oops_do(OopClosure* f, bool allow_dead, bool allow_null, bool keepalive_is_strong) {
1877   // make sure the oops ready to receive visitors
1878   assert(allow_dead || is_alive(), &quot;should not call follow on dead nmethod&quot;);
1879 
1880   if (keepalive_is_strong) {
1881     if (_keepalive != NULL) {
1882       WeakHandle wh = WeakHandle::from_raw(_keepalive);
1883       if (wh.resolve() != NULL) {
1884         f-&gt;do_oop(_keepalive);
1885       }
1886     }
1887   }
1888 
1889   // Prevent extra code cache walk for platforms that don&#39;t have immediate oops.
1890   if (relocInfo::mustIterateImmediateOopsInCode()) {
1891     RelocIterator iter(this, oops_reloc_begin());
1892 
1893     while (iter.next()) {
1894       if (iter.type() == relocInfo::oop_type ) {
1895         oop_Relocation* r = iter.oop_reloc();
1896         // In this loop, we must only follow those oops directly embedded in
1897         // the code.  Other oops (oop_index&gt;0) are seen as part of scopes_oops.
1898         assert(1 == (r-&gt;oop_is_immediate()) +
1899                (r-&gt;oop_addr() &gt;= oops_begin() &amp;&amp; r-&gt;oop_addr() &lt; oops_end()),
1900                &quot;oop must be found in exactly one place&quot;);
1901         if (r-&gt;oop_is_immediate() &amp;&amp; (r-&gt;oop_value() != NULL || allow_null)) {
1902           f-&gt;do_oop(r-&gt;oop_addr());
1903         }
1904       }
1905     }
1906   }
1907 
1908   // Scopes
1909   // This includes oop constants not inlined in the code stream.
1910   for (oop* p = oops_begin(); p &lt; oops_end(); p++) {
1911     if (*p == Universe::non_oop_word())  continue;  // skip non-oops
1912     f-&gt;do_oop(p);
1913   }
1914 }
1915 
1916 nmethod* volatile nmethod::_oops_do_mark_nmethods;
1917 
1918 void nmethod::oops_do_log_change(const char* state) {
1919   LogTarget(Trace, gc, nmethod) lt;
1920   if (lt.is_enabled()) {
1921     LogStream ls(lt);
1922     CompileTask::print(&amp;ls, this, state, true /* short_form */);
1923   }
1924 }
1925 
1926 bool nmethod::oops_do_try_claim() {
1927   if (oops_do_try_claim_weak_request()) {
1928     nmethod* result = oops_do_try_add_to_list_as_weak_done();
1929     assert(result == NULL, &quot;adding to global list as weak done must always succeed.&quot;);
1930     return true;
1931   }
1932   return false;
1933 }
1934 
1935 bool nmethod::oops_do_try_claim_weak_request() {
1936   assert(SafepointSynchronize::is_at_safepoint(), &quot;only at safepoint&quot;);
1937 
1938   if ((_oops_do_mark_link == NULL) &amp;&amp;
1939       (Atomic::replace_if_null(&amp;_oops_do_mark_link, mark_link(this, claim_weak_request_tag)))) {
1940     oops_do_log_change(&quot;oops_do, mark weak request&quot;);
1941     return true;
1942   }
1943   return false;
1944 }
1945 
1946 void nmethod::oops_do_set_strong_done(nmethod* old_head) {
1947   _oops_do_mark_link = mark_link(old_head, claim_strong_done_tag);
1948 }
1949 
1950 nmethod::oops_do_mark_link* nmethod::oops_do_try_claim_strong_done() {
1951   assert(SafepointSynchronize::is_at_safepoint(), &quot;only at safepoint&quot;);
1952 
1953   oops_do_mark_link* old_next = Atomic::cmpxchg(&amp;_oops_do_mark_link, mark_link(NULL, claim_weak_request_tag), mark_link(this, claim_strong_done_tag));
1954   if (old_next == NULL) {
1955     oops_do_log_change(&quot;oops_do, mark strong done&quot;);
1956   }
1957   return old_next;
1958 }
1959 
1960 nmethod::oops_do_mark_link* nmethod::oops_do_try_add_strong_request(nmethod::oops_do_mark_link* next) {
1961   assert(SafepointSynchronize::is_at_safepoint(), &quot;only at safepoint&quot;);
1962   assert(next == mark_link(this, claim_weak_request_tag), &quot;Should be claimed as weak&quot;);
1963 
1964   oops_do_mark_link* old_next = Atomic::cmpxchg(&amp;_oops_do_mark_link, next, mark_link(this, claim_strong_request_tag));
1965   if (old_next == next) {
1966     oops_do_log_change(&quot;oops_do, mark strong request&quot;);
1967   }
1968   return old_next;
1969 }
1970 
1971 bool nmethod::oops_do_try_claim_weak_done_as_strong_done(nmethod::oops_do_mark_link* next) {
1972   assert(SafepointSynchronize::is_at_safepoint(), &quot;only at safepoint&quot;);
1973   assert(extract_state(next) == claim_weak_done_tag, &quot;Should be claimed as weak done&quot;);
1974 
1975   oops_do_mark_link* old_next = Atomic::cmpxchg(&amp;_oops_do_mark_link, next, mark_link(extract_nmethod(next), claim_strong_done_tag));
1976   if (old_next == next) {
1977     oops_do_log_change(&quot;oops_do, mark weak done -&gt; mark strong done&quot;);
1978     return true;
1979   }
1980   return false;
1981 }
1982 
1983 nmethod* nmethod::oops_do_try_add_to_list_as_weak_done() {
1984   assert(SafepointSynchronize::is_at_safepoint(), &quot;only at safepoint&quot;);
1985 
1986   assert(extract_state(_oops_do_mark_link) == claim_weak_request_tag ||
1987          extract_state(_oops_do_mark_link) == claim_strong_request_tag,
1988          &quot;must be but is nmethod &quot; PTR_FORMAT &quot; %u&quot;, p2i(extract_nmethod(_oops_do_mark_link)), extract_state(_oops_do_mark_link));
1989 
1990   nmethod* old_head = Atomic::xchg(&amp;_oops_do_mark_nmethods, this);
1991   // Self-loop if needed.
1992   if (old_head == NULL) {
1993     old_head = this;
1994   }
1995   // Try to install end of list and weak done tag.
1996   if (Atomic::cmpxchg(&amp;_oops_do_mark_link, mark_link(this, claim_weak_request_tag), mark_link(old_head, claim_weak_done_tag)) == mark_link(this, claim_weak_request_tag)) {
1997     oops_do_log_change(&quot;oops_do, mark weak done&quot;);
1998     return NULL;
1999   } else {
2000     return old_head;
2001   }
2002 }
2003 
2004 void nmethod::oops_do_add_to_list_as_strong_done() {
2005   assert(SafepointSynchronize::is_at_safepoint(), &quot;only at safepoint&quot;);
2006 
2007   nmethod* old_head = Atomic::xchg(&amp;_oops_do_mark_nmethods, this);
2008   // Self-loop if needed.
2009   if (old_head == NULL) {
2010     old_head = this;
2011   }
2012   assert(_oops_do_mark_link == mark_link(this, claim_strong_done_tag), &quot;must be but is nmethod &quot; PTR_FORMAT &quot; state %u&quot;,
2013          p2i(extract_nmethod(_oops_do_mark_link)), extract_state(_oops_do_mark_link));
2014 
2015   oops_do_set_strong_done(old_head);
2016 }
2017 
2018 void nmethod::oops_do_process_weak(OopsDoProcessor* p) {
2019   if (!oops_do_try_claim_weak_request()) {
2020     // Failed to claim for weak processing.
2021     oops_do_log_change(&quot;oops_do, mark weak request fail&quot;);
2022     return;
2023   }
2024 
2025   p-&gt;do_regular_processing(this);
2026 
2027   nmethod* old_head = oops_do_try_add_to_list_as_weak_done();
2028   if (old_head == NULL) {
2029     return;
2030   }
2031   oops_do_log_change(&quot;oops_do, mark weak done fail&quot;);
2032   // Adding to global list failed, another thread added a strong request.
2033   assert(extract_state(_oops_do_mark_link) == claim_strong_request_tag,
2034          &quot;must be but is %u&quot;, extract_state(_oops_do_mark_link));
2035 
2036   oops_do_log_change(&quot;oops_do, mark weak request -&gt; mark strong done&quot;);
2037 
2038   oops_do_set_strong_done(old_head);
2039   // Do missing strong processing.
2040   p-&gt;do_remaining_strong_processing(this);
2041 }
2042 
2043 void nmethod::oops_do_process_strong(OopsDoProcessor* p) {
2044   oops_do_mark_link* next_raw = oops_do_try_claim_strong_done();
2045   if (next_raw == NULL) {
2046     p-&gt;do_regular_processing(this);
2047     oops_do_add_to_list_as_strong_done();
2048     return;
2049   }
2050   // Claim failed. Figure out why and handle it.
2051   if (oops_do_has_weak_request(next_raw)) {
2052     oops_do_mark_link* old = next_raw;
2053     // Claim failed because being weak processed (state == &quot;weak request&quot;).
2054     // Try to request deferred strong processing.
2055     next_raw = oops_do_try_add_strong_request(old);
2056     if (next_raw == old) {
2057       // Successfully requested deferred strong processing.
2058       return;
2059     }
2060     // Failed because of a concurrent transition. No longer in &quot;weak request&quot; state.
2061   }
2062   if (oops_do_has_any_strong_state(next_raw)) {
2063     // Already claimed for strong processing or requested for such.
2064     return;
2065   }
2066   if (oops_do_try_claim_weak_done_as_strong_done(next_raw)) {
2067     // Successfully claimed &quot;weak done&quot; as &quot;strong done&quot;. Do the missing marking.
2068     p-&gt;do_remaining_strong_processing(this);
2069     return;
2070   }
2071   // Claim failed, some other thread got it.
2072 }
2073 
2074 void nmethod::oops_do_marking_prologue() {
2075   assert_at_safepoint();
2076 
2077   log_trace(gc, nmethod)(&quot;oops_do_marking_prologue&quot;);
2078   assert(_oops_do_mark_nmethods == NULL, &quot;must be empty&quot;);
2079 }
2080 
2081 void nmethod::oops_do_marking_epilogue() {
2082   assert_at_safepoint();
2083 
2084   nmethod* next = _oops_do_mark_nmethods;
2085   _oops_do_mark_nmethods = NULL;
2086   if (next != NULL) {
2087     nmethod* cur;
2088     do {
2089       cur = next;
2090       next = extract_nmethod(cur-&gt;_oops_do_mark_link);
2091       cur-&gt;_oops_do_mark_link = NULL;
2092       DEBUG_ONLY(cur-&gt;verify_oop_relocations());
2093 
2094       LogTarget(Trace, gc, nmethod) lt;
2095       if (lt.is_enabled()) {
2096         LogStream ls(lt);
2097         CompileTask::print(&amp;ls, cur, &quot;oops_do, unmark&quot;, /*short_form:*/ true);
2098       }
2099       // End if self-loop has been detected.
2100     } while (cur != next);
2101   }
2102   log_trace(gc, nmethod)(&quot;oops_do_marking_epilogue&quot;);
2103 }
2104 
2105 inline bool includes(void* p, void* from, void* to) {
2106   return from &lt;= p &amp;&amp; p &lt; to;
2107 }
2108 
2109 
2110 void nmethod::copy_scopes_pcs(PcDesc* pcs, int count) {
2111   assert(count &gt;= 2, &quot;must be sentinel values, at least&quot;);
2112 
2113 #ifdef ASSERT
2114   // must be sorted and unique; we do a binary search in find_pc_desc()
2115   int prev_offset = pcs[0].pc_offset();
2116   assert(prev_offset == PcDesc::lower_offset_limit,
2117          &quot;must start with a sentinel&quot;);
2118   for (int i = 1; i &lt; count; i++) {
2119     int this_offset = pcs[i].pc_offset();
2120     assert(this_offset &gt; prev_offset, &quot;offsets must be sorted&quot;);
2121     prev_offset = this_offset;
2122   }
2123   assert(prev_offset == PcDesc::upper_offset_limit,
2124          &quot;must end with a sentinel&quot;);
2125 #endif //ASSERT
2126 
2127   // Search for MethodHandle invokes and tag the nmethod.
2128   for (int i = 0; i &lt; count; i++) {
2129     if (pcs[i].is_method_handle_invoke()) {
2130       set_has_method_handle_invokes(true);
2131       break;
2132     }
2133   }
2134   assert(has_method_handle_invokes() == (_deopt_mh_handler_begin != NULL), &quot;must have deopt mh handler&quot;);
2135 
2136   int size = count * sizeof(PcDesc);
2137   assert(scopes_pcs_size() &gt;= size, &quot;oob&quot;);
2138   memcpy(scopes_pcs_begin(), pcs, size);
2139 
2140   // Adjust the final sentinel downward.
2141   PcDesc* last_pc = &amp;scopes_pcs_begin()[count-1];
2142   assert(last_pc-&gt;pc_offset() == PcDesc::upper_offset_limit, &quot;sanity&quot;);
2143   last_pc-&gt;set_pc_offset(content_size() + 1);
2144   for (; last_pc + 1 &lt; scopes_pcs_end(); last_pc += 1) {
2145     // Fill any rounding gaps with copies of the last record.
2146     last_pc[1] = last_pc[0];
2147   }
2148   // The following assert could fail if sizeof(PcDesc) is not
2149   // an integral multiple of oopSize (the rounding term).
2150   // If it fails, change the logic to always allocate a multiple
2151   // of sizeof(PcDesc), and fill unused words with copies of *last_pc.
2152   assert(last_pc + 1 == scopes_pcs_end(), &quot;must match exactly&quot;);
2153 }
2154 
2155 void nmethod::copy_scopes_data(u_char* buffer, int size) {
2156   assert(scopes_data_size() &gt;= size, &quot;oob&quot;);
2157   memcpy(scopes_data_begin(), buffer, size);
2158 }
2159 
2160 #ifdef ASSERT
2161 static PcDesc* linear_search(const PcDescSearch&amp; search, int pc_offset, bool approximate) {
2162   PcDesc* lower = search.scopes_pcs_begin();
2163   PcDesc* upper = search.scopes_pcs_end();
2164   lower += 1; // exclude initial sentinel
2165   PcDesc* res = NULL;
2166   for (PcDesc* p = lower; p &lt; upper; p++) {
2167     NOT_PRODUCT(--pc_nmethod_stats.pc_desc_tests);  // don&#39;t count this call to match_desc
2168     if (match_desc(p, pc_offset, approximate)) {
2169       if (res == NULL)
2170         res = p;
2171       else
2172         res = (PcDesc*) badAddress;
2173     }
2174   }
2175   return res;
2176 }
2177 #endif
2178 
2179 
2180 // Finds a PcDesc with real-pc equal to &quot;pc&quot;
2181 PcDesc* PcDescContainer::find_pc_desc_internal(address pc, bool approximate, const PcDescSearch&amp; search) {
2182   address base_address = search.code_begin();
2183   if ((pc &lt; base_address) ||
2184       (pc - base_address) &gt;= (ptrdiff_t) PcDesc::upper_offset_limit) {
2185     return NULL;  // PC is wildly out of range
2186   }
2187   int pc_offset = (int) (pc - base_address);
2188 
2189   // Check the PcDesc cache if it contains the desired PcDesc
2190   // (This as an almost 100% hit rate.)
2191   PcDesc* res = _pc_desc_cache.find_pc_desc(pc_offset, approximate);
2192   if (res != NULL) {
2193     assert(res == linear_search(search, pc_offset, approximate), &quot;cache ok&quot;);
2194     return res;
2195   }
2196 
2197   // Fallback algorithm: quasi-linear search for the PcDesc
2198   // Find the last pc_offset less than the given offset.
2199   // The successor must be the required match, if there is a match at all.
2200   // (Use a fixed radix to avoid expensive affine pointer arithmetic.)
2201   PcDesc* lower = search.scopes_pcs_begin();
2202   PcDesc* upper = search.scopes_pcs_end();
2203   upper -= 1; // exclude final sentinel
2204   if (lower &gt;= upper)  return NULL;  // native method; no PcDescs at all
2205 
2206 #define assert_LU_OK \
2207   /* invariant on lower..upper during the following search: */ \
2208   assert(lower-&gt;pc_offset() &lt;  pc_offset, &quot;sanity&quot;); \
2209   assert(upper-&gt;pc_offset() &gt;= pc_offset, &quot;sanity&quot;)
2210   assert_LU_OK;
2211 
2212   // Use the last successful return as a split point.
2213   PcDesc* mid = _pc_desc_cache.last_pc_desc();
2214   NOT_PRODUCT(++pc_nmethod_stats.pc_desc_searches);
2215   if (mid-&gt;pc_offset() &lt; pc_offset) {
2216     lower = mid;
2217   } else {
2218     upper = mid;
2219   }
2220 
2221   // Take giant steps at first (4096, then 256, then 16, then 1)
2222   const int LOG2_RADIX = 4 /*smaller steps in debug mode:*/ debug_only(-1);
2223   const int RADIX = (1 &lt;&lt; LOG2_RADIX);
2224   for (int step = (1 &lt;&lt; (LOG2_RADIX*3)); step &gt; 1; step &gt;&gt;= LOG2_RADIX) {
2225     while ((mid = lower + step) &lt; upper) {
2226       assert_LU_OK;
2227       NOT_PRODUCT(++pc_nmethod_stats.pc_desc_searches);
2228       if (mid-&gt;pc_offset() &lt; pc_offset) {
2229         lower = mid;
2230       } else {
2231         upper = mid;
2232         break;
2233       }
2234     }
2235     assert_LU_OK;
2236   }
2237 
2238   // Sneak up on the value with a linear search of length ~16.
2239   while (true) {
2240     assert_LU_OK;
2241     mid = lower + 1;
2242     NOT_PRODUCT(++pc_nmethod_stats.pc_desc_searches);
2243     if (mid-&gt;pc_offset() &lt; pc_offset) {
2244       lower = mid;
2245     } else {
2246       upper = mid;
2247       break;
2248     }
2249   }
2250 #undef assert_LU_OK
2251 
2252   if (match_desc(upper, pc_offset, approximate)) {
2253     assert(upper == linear_search(search, pc_offset, approximate), &quot;search ok&quot;);
2254     _pc_desc_cache.add_pc_desc(upper);
2255     return upper;
2256   } else {
2257     assert(NULL == linear_search(search, pc_offset, approximate), &quot;search ok&quot;);
2258     return NULL;
2259   }
2260 }
2261 
2262 
2263 void nmethod::check_all_dependencies(DepChange&amp; changes) {
2264   // Checked dependencies are allocated into this ResourceMark
2265   ResourceMark rm;
2266 
2267   // Turn off dependency tracing while actually testing dependencies.
2268   NOT_PRODUCT( FlagSetting fs(TraceDependencies, false) );
2269 
2270   typedef ResourceHashtable&lt;DependencySignature, int, &amp;DependencySignature::hash,
2271                             &amp;DependencySignature::equals, 11027&gt; DepTable;
2272 
2273   DepTable* table = new DepTable();
2274 
2275   // Iterate over live nmethods and check dependencies of all nmethods that are not
2276   // marked for deoptimization. A particular dependency is only checked once.
2277   NMethodIterator iter(NMethodIterator::only_alive_and_not_unloading);
2278   while(iter.next()) {
2279     nmethod* nm = iter.method();
2280     // Only notify for live nmethods
2281     if (!nm-&gt;is_marked_for_deoptimization()) {
2282       for (Dependencies::DepStream deps(nm); deps.next(); ) {
2283         // Construct abstraction of a dependency.
2284         DependencySignature* current_sig = new DependencySignature(deps);
2285 
2286         // Determine if dependency is already checked. table-&gt;put(...) returns
2287         // &#39;true&#39; if the dependency is added (i.e., was not in the hashtable).
2288         if (table-&gt;put(*current_sig, 1)) {
2289           if (deps.check_dependency() != NULL) {
2290             // Dependency checking failed. Print out information about the failed
2291             // dependency and finally fail with an assert. We can fail here, since
2292             // dependency checking is never done in a product build.
2293             tty-&gt;print_cr(&quot;Failed dependency:&quot;);
2294             changes.print();
2295             nm-&gt;print();
2296             nm-&gt;print_dependencies();
2297             assert(false, &quot;Should have been marked for deoptimization&quot;);
2298           }
2299         }
2300       }
2301     }
2302   }
2303 }
2304 
2305 bool nmethod::check_dependency_on(DepChange&amp; changes) {
2306   // What has happened:
2307   // 1) a new class dependee has been added
2308   // 2) dependee and all its super classes have been marked
2309   bool found_check = false;  // set true if we are upset
2310   for (Dependencies::DepStream deps(this); deps.next(); ) {
2311     // Evaluate only relevant dependencies.
2312     if (deps.spot_check_dependency_at(changes) != NULL) {
2313       found_check = true;
2314       NOT_DEBUG(break);
2315     }
2316   }
2317   return found_check;
2318 }
2319 
2320 // Called from mark_for_deoptimization, when dependee is invalidated.
2321 bool nmethod::is_dependent_on_method(Method* dependee) {
2322   for (Dependencies::DepStream deps(this); deps.next(); ) {
2323     if (deps.type() != Dependencies::evol_method)
2324       continue;
2325     Method* method = deps.method_argument(0);
2326     if (method == dependee) return true;
2327   }
2328   return false;
2329 }
2330 
2331 
2332 bool nmethod::is_patchable_at(address instr_addr) {
2333   assert(insts_contains(instr_addr), &quot;wrong nmethod used&quot;);
2334   if (is_zombie()) {
2335     // a zombie may never be patched
2336     return false;
2337   }
2338   return true;
2339 }
2340 
2341 
2342 void nmethod_init() {
2343   // make sure you didn&#39;t forget to adjust the filler fields
2344   assert(sizeof(nmethod) % oopSize == 0, &quot;nmethod size must be multiple of a word&quot;);
2345 }
2346 
2347 
2348 //-------------------------------------------------------------------------------------------
2349 
2350 
2351 // QQQ might we make this work from a frame??
2352 nmethodLocker::nmethodLocker(address pc) {
2353   CodeBlob* cb = CodeCache::find_blob(pc);
2354   guarantee(cb != NULL &amp;&amp; cb-&gt;is_compiled(), &quot;bad pc for a nmethod found&quot;);
2355   _nm = cb-&gt;as_compiled_method();
2356   lock_nmethod(_nm);
2357 }
2358 
2359 // Only JvmtiDeferredEvent::compiled_method_unload_event()
2360 // should pass zombie_ok == true.
2361 void nmethodLocker::lock_nmethod(CompiledMethod* cm, bool zombie_ok) {
2362   if (cm == NULL)  return;
2363   if (cm-&gt;is_aot()) return;  // FIXME: Revisit once _lock_count is added to aot_method
2364   nmethod* nm = cm-&gt;as_nmethod();
2365   Atomic::inc(&amp;nm-&gt;_lock_count);
2366   assert(zombie_ok || !nm-&gt;is_zombie(), &quot;cannot lock a zombie method: %p&quot;, nm);
2367 }
2368 
2369 void nmethodLocker::unlock_nmethod(CompiledMethod* cm) {
2370   if (cm == NULL)  return;
2371   if (cm-&gt;is_aot()) return;  // FIXME: Revisit once _lock_count is added to aot_method
2372   nmethod* nm = cm-&gt;as_nmethod();
2373   Atomic::dec(&amp;nm-&gt;_lock_count);
2374   assert(nm-&gt;_lock_count &gt;= 0, &quot;unmatched nmethod lock/unlock&quot;);
2375 }
2376 
2377 
2378 // -----------------------------------------------------------------------------
2379 // Verification
2380 
2381 class VerifyOopsClosure: public OopClosure {
2382   nmethod* _nm;
2383   bool     _ok;
2384 public:
2385   VerifyOopsClosure(nmethod* nm) : _nm(nm), _ok(true) { }
2386   bool ok() { return _ok; }
2387   virtual void do_oop(oop* p) {
2388     if (oopDesc::is_oop_or_null(*p)) return;
2389     // Print diagnostic information before calling print_nmethod().
2390     // Assertions therein might prevent call from returning.
2391     tty-&gt;print_cr(&quot;*** non-oop &quot; PTR_FORMAT &quot; found at &quot; PTR_FORMAT &quot; (offset %d)&quot;,
2392                   p2i(*p), p2i(p), (int)((intptr_t)p - (intptr_t)_nm));
2393     if (_ok) {
2394       _nm-&gt;print_nmethod(true);
2395       _ok = false;
2396     }
2397   }
2398   virtual void do_oop(narrowOop* p) { ShouldNotReachHere(); }
2399 };
2400 
2401 class VerifyMetadataClosure: public MetadataClosure {
2402  public:
2403   void do_metadata(Metadata* md) {
2404     if (md-&gt;is_method()) {
2405       Method* method = (Method*)md;
2406       assert(!method-&gt;is_old(), &quot;Should not be installing old methods&quot;);
2407     }
2408   }
2409 };
2410 
2411 
2412 void nmethod::verify() {
2413 
2414   // Hmm. OSR methods can be deopted but not marked as zombie or not_entrant
2415   // seems odd.
2416 
2417   if (is_zombie() || is_not_entrant() || is_unloaded())
2418     return;
2419 
2420   // Make sure all the entry points are correctly aligned for patching.
2421   NativeJump::check_verified_entry_alignment(entry_point(), verified_entry_point());
2422 
2423   // assert(oopDesc::is_oop(method()), &quot;must be valid&quot;);
2424 
2425   ResourceMark rm;
2426 
2427   if (!CodeCache::contains(this)) {
2428     fatal(&quot;nmethod at &quot; INTPTR_FORMAT &quot; not in zone&quot;, p2i(this));
2429   }
2430 
2431   if(is_native_method() )
2432     return;
2433 
2434   nmethod* nm = CodeCache::find_nmethod(verified_entry_point());
2435   if (nm != this) {
2436     fatal(&quot;findNMethod did not find this nmethod (&quot; INTPTR_FORMAT &quot;)&quot;, p2i(this));
2437   }
2438 
2439   for (PcDesc* p = scopes_pcs_begin(); p &lt; scopes_pcs_end(); p++) {
2440     if (! p-&gt;verify(this)) {
2441       tty-&gt;print_cr(&quot;\t\tin nmethod at &quot; INTPTR_FORMAT &quot; (pcs)&quot;, p2i(this));
2442     }
2443   }
2444 
2445 #ifdef ASSERT
2446 #if INCLUDE_JVMCI
2447   {
2448     // Verify that implicit exceptions that deoptimize have a PcDesc and OopMap
2449     ImmutableOopMapSet* oms = oop_maps();
2450     ImplicitExceptionTable implicit_table(this);
2451     for (uint i = 0; i &lt; implicit_table.len(); i++) {
2452       int exec_offset = (int) implicit_table.get_exec_offset(i);
2453       if (implicit_table.get_exec_offset(i) == implicit_table.get_cont_offset(i)) {
2454         assert(pc_desc_at(code_begin() + exec_offset) != NULL, &quot;missing PcDesc&quot;);
2455         bool found = false;
2456         for (int i = 0, imax = oms-&gt;count(); i &lt; imax; i++) {
2457           if (oms-&gt;pair_at(i)-&gt;pc_offset() == exec_offset) {
2458             found = true;
2459             break;
2460           }
2461         }
2462         assert(found, &quot;missing oopmap&quot;);
2463       }
2464     }
2465   }
2466 #endif
2467 #endif
2468 
2469   VerifyOopsClosure voc(this);
2470   oops_do(&amp;voc);
2471   assert(voc.ok(), &quot;embedded oops must be OK&quot;);
2472   Universe::heap()-&gt;verify_nmethod(this);
2473 
2474   assert(_oops_do_mark_link == NULL, &quot;_oops_do_mark_link for %s should be NULL but is &quot; PTR_FORMAT,
2475          nm-&gt;method()-&gt;external_name(), p2i(_oops_do_mark_link));
2476   verify_scopes();
2477 
2478   CompiledICLocker nm_verify(this);
2479   VerifyMetadataClosure vmc;
2480   metadata_do(&amp;vmc);
2481 }
2482 
2483 
2484 void nmethod::verify_interrupt_point(address call_site) {
2485   // Verify IC only when nmethod installation is finished.
2486   if (!is_not_installed()) {
2487     if (CompiledICLocker::is_safe(this)) {
2488       CompiledIC_at(this, call_site);
2489     } else {
2490       CompiledICLocker ml_verify(this);
2491       CompiledIC_at(this, call_site);
2492     }
2493   }
2494 
2495   PcDesc* pd = pc_desc_at(nativeCall_at(call_site)-&gt;return_address());
2496   assert(pd != NULL, &quot;PcDesc must exist&quot;);
2497   for (ScopeDesc* sd = new ScopeDesc(this, pd-&gt;scope_decode_offset(),
2498                                      pd-&gt;obj_decode_offset(), pd-&gt;should_reexecute(), pd-&gt;rethrow_exception(),
2499                                      pd-&gt;return_oop());
2500        !sd-&gt;is_top(); sd = sd-&gt;sender()) {
2501     sd-&gt;verify();
2502   }
2503 }
2504 
2505 void nmethod::verify_scopes() {
2506   if( !method() ) return;       // Runtime stubs have no scope
2507   if (method()-&gt;is_native()) return; // Ignore stub methods.
2508   // iterate through all interrupt point
2509   // and verify the debug information is valid.
2510   RelocIterator iter((nmethod*)this);
2511   while (iter.next()) {
2512     address stub = NULL;
2513     switch (iter.type()) {
2514       case relocInfo::virtual_call_type:
2515         verify_interrupt_point(iter.addr());
2516         break;
2517       case relocInfo::opt_virtual_call_type:
2518         stub = iter.opt_virtual_call_reloc()-&gt;static_stub(false);
2519         verify_interrupt_point(iter.addr());
2520         break;
2521       case relocInfo::static_call_type:
2522         stub = iter.static_call_reloc()-&gt;static_stub(false);
2523         //verify_interrupt_point(iter.addr());
2524         break;
2525       case relocInfo::runtime_call_type:
2526       case relocInfo::runtime_call_w_cp_type: {
2527         address destination = iter.reloc()-&gt;value();
2528         // Right now there is no way to find out which entries support
2529         // an interrupt point.  It would be nice if we had this
2530         // information in a table.
2531         break;
2532       }
2533       default:
2534         break;
2535     }
2536     assert(stub == NULL || stub_contains(stub), &quot;static call stub outside stub section&quot;);
2537   }
2538 }
2539 
2540 
2541 // -----------------------------------------------------------------------------
2542 // Printing operations
2543 
2544 void nmethod::print() const {
2545   ttyLocker ttyl;   // keep the following output all in one block
2546   print(tty);
2547 }
2548 
2549 void nmethod::print(outputStream* st) const {
2550   ResourceMark rm;
2551 
2552   st-&gt;print(&quot;Compiled method &quot;);
2553 
2554   if (is_compiled_by_c1()) {
2555     st-&gt;print(&quot;(c1) &quot;);
2556   } else if (is_compiled_by_c2()) {
2557     st-&gt;print(&quot;(c2) &quot;);
2558   } else if (is_compiled_by_jvmci()) {
2559     st-&gt;print(&quot;(JVMCI) &quot;);
2560   } else {
2561     st-&gt;print(&quot;(n/a) &quot;);
2562   }
2563 
2564   print_on(tty, NULL);
2565 
2566   if (WizardMode) {
2567     st-&gt;print(&quot;((nmethod*) &quot; INTPTR_FORMAT &quot;) &quot;, p2i(this));
2568     st-&gt;print(&quot; for method &quot; INTPTR_FORMAT , p2i(method()));
2569     st-&gt;print(&quot; { &quot;);
2570     st-&gt;print_cr(&quot;%s &quot;, state());
2571     st-&gt;print_cr(&quot;}:&quot;);
2572   }
2573   if (size              () &gt; 0) st-&gt;print_cr(&quot; total in heap  [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2574                                              p2i(this),
2575                                              p2i(this) + size(),
2576                                              size());
2577   if (relocation_size   () &gt; 0) st-&gt;print_cr(&quot; relocation     [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2578                                              p2i(relocation_begin()),
2579                                              p2i(relocation_end()),
2580                                              relocation_size());
2581   if (consts_size       () &gt; 0) st-&gt;print_cr(&quot; constants      [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2582                                              p2i(consts_begin()),
2583                                              p2i(consts_end()),
2584                                              consts_size());
2585   if (insts_size        () &gt; 0) st-&gt;print_cr(&quot; main code      [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2586                                              p2i(insts_begin()),
2587                                              p2i(insts_end()),
2588                                              insts_size());
2589   if (stub_size         () &gt; 0) st-&gt;print_cr(&quot; stub code      [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2590                                              p2i(stub_begin()),
2591                                              p2i(stub_end()),
2592                                              stub_size());
2593   if (oops_size         () &gt; 0) st-&gt;print_cr(&quot; oops           [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2594                                              p2i(oops_begin()),
2595                                              p2i(oops_end()),
2596                                              oops_size());
2597   if (metadata_size     () &gt; 0) st-&gt;print_cr(&quot; metadata       [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2598                                              p2i(metadata_begin()),
2599                                              p2i(metadata_end()),
2600                                              metadata_size());
2601   if (scopes_data_size  () &gt; 0) st-&gt;print_cr(&quot; scopes data    [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2602                                              p2i(scopes_data_begin()),
2603                                              p2i(scopes_data_end()),
2604                                              scopes_data_size());
2605   if (scopes_pcs_size   () &gt; 0) st-&gt;print_cr(&quot; scopes pcs     [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2606                                              p2i(scopes_pcs_begin()),
2607                                              p2i(scopes_pcs_end()),
2608                                              scopes_pcs_size());
2609   if (dependencies_size () &gt; 0) st-&gt;print_cr(&quot; dependencies   [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2610                                              p2i(dependencies_begin()),
2611                                              p2i(dependencies_end()),
2612                                              dependencies_size());
2613   if (handler_table_size() &gt; 0) st-&gt;print_cr(&quot; handler table  [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2614                                              p2i(handler_table_begin()),
2615                                              p2i(handler_table_end()),
2616                                              handler_table_size());
2617   if (nul_chk_table_size() &gt; 0) st-&gt;print_cr(&quot; nul chk table  [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2618                                              p2i(nul_chk_table_begin()),
2619                                              p2i(nul_chk_table_end()),
2620                                              nul_chk_table_size());
2621 #if INCLUDE_JVMCI
2622   if (speculations_size () &gt; 0) st-&gt;print_cr(&quot; speculations   [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2623                                              p2i(speculations_begin()),
2624                                              p2i(speculations_end()),
2625                                              speculations_size());
2626   if (jvmci_data_size   () &gt; 0) st-&gt;print_cr(&quot; JVMCI data     [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] = %d&quot;,
2627                                              p2i(jvmci_data_begin()),
2628                                              p2i(jvmci_data_end()),
2629                                              jvmci_data_size());
2630 #endif
2631 }
2632 
2633 void nmethod::print_code() {
2634   HandleMark hm;
2635   ResourceMark m;
2636   ttyLocker ttyl;
2637   // Call the specialized decode method of this class.
2638   decode(tty);
2639 }
2640 
2641 #ifndef PRODUCT  // called InstanceKlass methods are available only then. Declared as PRODUCT_RETURN
2642 
2643 void nmethod::print_dependencies() {
2644   ResourceMark rm;
2645   ttyLocker ttyl;   // keep the following output all in one block
2646   tty-&gt;print_cr(&quot;Dependencies:&quot;);
2647   for (Dependencies::DepStream deps(this); deps.next(); ) {
2648     deps.print_dependency();
2649     Klass* ctxk = deps.context_type();
2650     if (ctxk != NULL) {
2651       if (ctxk-&gt;is_instance_klass() &amp;&amp; InstanceKlass::cast(ctxk)-&gt;is_dependent_nmethod(this)) {
2652         tty-&gt;print_cr(&quot;   [nmethod&lt;=klass]%s&quot;, ctxk-&gt;external_name());
2653       }
2654     }
2655     deps.log_dependency();  // put it into the xml log also
2656   }
2657 }
2658 #endif
2659 
2660 #if defined(SUPPORT_DATA_STRUCTS)
2661 
2662 // Print the oops from the underlying CodeBlob.
2663 void nmethod::print_oops(outputStream* st) {
2664   HandleMark hm;
2665   ResourceMark m;
2666   st-&gt;print(&quot;Oops:&quot;);
2667   if (oops_begin() &lt; oops_end()) {
2668     st-&gt;cr();
2669     for (oop* p = oops_begin(); p &lt; oops_end(); p++) {
2670       Disassembler::print_location((unsigned char*)p, (unsigned char*)oops_begin(), (unsigned char*)oops_end(), st, true, false);
2671       st-&gt;print(PTR_FORMAT &quot; &quot;, *((uintptr_t*)p));
2672       if (*p == Universe::non_oop_word()) {
2673         st-&gt;print_cr(&quot;NON_OOP&quot;);
2674         continue;  // skip non-oops
2675       }
2676       if (*p == NULL) {
2677         st-&gt;print_cr(&quot;NULL-oop&quot;);
2678         continue;  // skip non-oops
2679       }
2680       (*p)-&gt;print_value_on(st);
2681       st-&gt;cr();
2682     }
2683   } else {
2684     st-&gt;print_cr(&quot; &lt;list empty&gt;&quot;);
2685   }
2686 }
2687 
2688 // Print metadata pool.
2689 void nmethod::print_metadata(outputStream* st) {
2690   HandleMark hm;
2691   ResourceMark m;
2692   st-&gt;print(&quot;Metadata:&quot;);
2693   if (metadata_begin() &lt; metadata_end()) {
2694     st-&gt;cr();
2695     for (Metadata** p = metadata_begin(); p &lt; metadata_end(); p++) {
2696       Disassembler::print_location((unsigned char*)p, (unsigned char*)metadata_begin(), (unsigned char*)metadata_end(), st, true, false);
2697       st-&gt;print(PTR_FORMAT &quot; &quot;, *((uintptr_t*)p));
2698       if (*p &amp;&amp; *p != Universe::non_oop_word()) {
2699         (*p)-&gt;print_value_on(st);
2700       }
2701       st-&gt;cr();
2702     }
2703   } else {
2704     st-&gt;print_cr(&quot; &lt;list empty&gt;&quot;);
2705   }
2706 }
2707 
2708 #ifndef PRODUCT  // ScopeDesc::print_on() is available only then. Declared as PRODUCT_RETURN
2709 void nmethod::print_scopes_on(outputStream* st) {
2710   // Find the first pc desc for all scopes in the code and print it.
2711   ResourceMark rm;
2712   st-&gt;print(&quot;scopes:&quot;);
2713   if (scopes_pcs_begin() &lt; scopes_pcs_end()) {
2714     st-&gt;cr();
2715     for (PcDesc* p = scopes_pcs_begin(); p &lt; scopes_pcs_end(); p++) {
2716       if (p-&gt;scope_decode_offset() == DebugInformationRecorder::serialized_null)
2717         continue;
2718 
2719       ScopeDesc* sd = scope_desc_at(p-&gt;real_pc(this));
2720       while (sd != NULL) {
2721         sd-&gt;print_on(st, p);  // print output ends with a newline
2722         sd = sd-&gt;sender();
2723       }
2724     }
2725   } else {
2726     st-&gt;print_cr(&quot; &lt;list empty&gt;&quot;);
2727   }
2728 }
2729 #endif
2730 
2731 #ifndef PRODUCT  // RelocIterator does support printing only then.
2732 void nmethod::print_relocations() {
2733   ResourceMark m;       // in case methods get printed via the debugger
2734   tty-&gt;print_cr(&quot;relocations:&quot;);
2735   RelocIterator iter(this);
2736   iter.print();
2737 }
2738 #endif
2739 
2740 void nmethod::print_pcs_on(outputStream* st) {
2741   ResourceMark m;       // in case methods get printed via debugger
2742   st-&gt;print(&quot;pc-bytecode offsets:&quot;);
2743   if (scopes_pcs_begin() &lt; scopes_pcs_end()) {
2744     st-&gt;cr();
2745     for (PcDesc* p = scopes_pcs_begin(); p &lt; scopes_pcs_end(); p++) {
2746       p-&gt;print_on(st, this);  // print output ends with a newline
2747     }
2748   } else {
2749     st-&gt;print_cr(&quot; &lt;list empty&gt;&quot;);
2750   }
2751 }
2752 
2753 void nmethod::print_handler_table() {
2754   ExceptionHandlerTable(this).print();
2755 }
2756 
2757 void nmethod::print_nul_chk_table() {
2758   ImplicitExceptionTable(this).print(code_begin());
2759 }
2760 
2761 void nmethod::print_recorded_oops() {
2762   const int n = oops_count();
2763   const int log_n = (n&lt;10) ? 1 : (n&lt;100) ? 2 : (n&lt;1000) ? 3 : (n&lt;10000) ? 4 : 6;
2764   tty-&gt;print(&quot;Recorded oops:&quot;);
2765   if (n &gt; 0) {
2766     tty-&gt;cr();
2767     for (int i = 0; i &lt; n; i++) {
2768       oop o = oop_at(i);
2769       tty-&gt;print(&quot;#%*d: &quot; INTPTR_FORMAT &quot; &quot;, log_n, i, p2i(o));
2770       if (o == (oop)Universe::non_oop_word()) {
2771         tty-&gt;print(&quot;non-oop word&quot;);
2772       } else if (o == NULL) {
2773         tty-&gt;print(&quot;NULL-oop&quot;);
2774       } else {
2775         o-&gt;print_value_on(tty);
2776       }
2777       tty-&gt;cr();
2778     }
2779   } else {
2780     tty-&gt;print_cr(&quot; &lt;list empty&gt;&quot;);
2781   }
2782 }
2783 
2784 void nmethod::print_recorded_metadata() {
2785   const int n = metadata_count();
2786   const int log_n = (n&lt;10) ? 1 : (n&lt;100) ? 2 : (n&lt;1000) ? 3 : (n&lt;10000) ? 4 : 6;
2787   tty-&gt;print(&quot;Recorded metadata:&quot;);
2788   if (n &gt; 0) {
2789     tty-&gt;cr();
2790     for (int i = 0; i &lt; n; i++) {
2791       Metadata* m = metadata_at(i);
2792       tty-&gt;print(&quot;#%*d: &quot; INTPTR_FORMAT &quot; &quot;, log_n, i, p2i(m));
2793       if (m == (Metadata*)Universe::non_oop_word()) {
2794         tty-&gt;print(&quot;non-metadata word&quot;);
2795       } else if (m == NULL) {
2796         tty-&gt;print(&quot;NULL-oop&quot;);
2797       } else {
2798         Metadata::print_value_on_maybe_null(tty, m);
2799       }
2800       tty-&gt;cr();
2801     }
2802   } else {
2803     tty-&gt;print_cr(&quot; &lt;list empty&gt;&quot;);
2804   }
2805 }
2806 #endif
2807 
2808 #if defined(SUPPORT_ASSEMBLY) || defined(SUPPORT_ABSTRACT_ASSEMBLY)
2809 
2810 void nmethod::print_constant_pool(outputStream* st) {
2811   //-----------------------------------
2812   //---&lt;  Print the constant pool  &gt;---
2813   //-----------------------------------
2814   int consts_size = this-&gt;consts_size();
2815   if ( consts_size &gt; 0 ) {
2816     unsigned char* cstart = this-&gt;consts_begin();
2817     unsigned char* cp     = cstart;
2818     unsigned char* cend   = cp + consts_size;
2819     unsigned int   bytes_per_line = 4;
2820     unsigned int   CP_alignment   = 8;
2821     unsigned int   n;
2822 
2823     st-&gt;cr();
2824 
2825     //---&lt;  print CP header to make clear what&#39;s printed  &gt;---
2826     if( ((uintptr_t)cp&amp;(CP_alignment-1)) == 0 ) {
2827       n = bytes_per_line;
2828       st-&gt;print_cr(&quot;[Constant Pool]&quot;);
2829       Disassembler::print_location(cp, cstart, cend, st, true, true);
2830       Disassembler::print_hexdata(cp, n, st, true);
2831       st-&gt;cr();
2832     } else {
2833       n = (uintptr_t)cp&amp;(bytes_per_line-1);
2834       st-&gt;print_cr(&quot;[Constant Pool (unaligned)]&quot;);
2835     }
2836 
2837     //---&lt;  print CP contents, bytes_per_line at a time  &gt;---
2838     while (cp &lt; cend) {
2839       Disassembler::print_location(cp, cstart, cend, st, true, false);
2840       Disassembler::print_hexdata(cp, n, st, false);
2841       cp += n;
2842       n   = bytes_per_line;
2843       st-&gt;cr();
2844     }
2845 
2846     //---&lt;  Show potential alignment gap between constant pool and code  &gt;---
2847     cend = code_begin();
2848     if( cp &lt; cend ) {
2849       n = 4;
2850       st-&gt;print_cr(&quot;[Code entry alignment]&quot;);
2851       while (cp &lt; cend) {
2852         Disassembler::print_location(cp, cstart, cend, st, false, false);
2853         cp += n;
2854         st-&gt;cr();
2855       }
2856     }
2857   } else {
2858     st-&gt;print_cr(&quot;[Constant Pool (empty)]&quot;);
2859   }
2860   st-&gt;cr();
2861 }
2862 
2863 #endif
2864 
2865 // Disassemble this nmethod.
2866 // Print additional debug information, if requested. This could be code
2867 // comments, block comments, profiling counters, etc.
2868 // The undisassembled format is useful no disassembler library is available.
2869 // The resulting hex dump (with markers) can be disassembled later, or on
2870 // another system, when/where a disassembler library is available.
2871 void nmethod::decode2(outputStream* ost) const {
2872 
2873   // Called from frame::back_trace_with_decode without ResourceMark.
2874   ResourceMark rm;
2875 
2876   // Make sure we have a valid stream to print on.
2877   outputStream* st = ost ? ost : tty;
2878 
2879 #if defined(SUPPORT_ABSTRACT_ASSEMBLY) &amp;&amp; ! defined(SUPPORT_ASSEMBLY)
2880   const bool use_compressed_format    = true;
2881   const bool compressed_with_comments = use_compressed_format &amp;&amp; (AbstractDisassembler::show_comment() ||
2882                                                                   AbstractDisassembler::show_block_comment());
2883 #else
2884   const bool use_compressed_format    = Disassembler::is_abstract();
2885   const bool compressed_with_comments = use_compressed_format &amp;&amp; (AbstractDisassembler::show_comment() ||
2886                                                                   AbstractDisassembler::show_block_comment());
2887 #endif
2888 
2889   st-&gt;cr();
2890   this-&gt;print(st);
2891   st-&gt;cr();
2892 
2893 #if defined(SUPPORT_ASSEMBLY)
2894   //----------------------------------
2895   //---&lt;  Print real disassembly  &gt;---
2896   //----------------------------------
2897   if (! use_compressed_format) {
2898     Disassembler::decode(const_cast&lt;nmethod*&gt;(this), st);
2899     return;
2900   }
2901 #endif
2902 
2903 #if defined(SUPPORT_ABSTRACT_ASSEMBLY)
2904 
2905   // Compressed undisassembled disassembly format.
2906   // The following stati are defined/supported:
2907   //   = 0 - currently at bol() position, nothing printed yet on current line.
2908   //   = 1 - currently at position after print_location().
2909   //   &gt; 1 - in the midst of printing instruction stream bytes.
2910   int        compressed_format_idx    = 0;
2911   int        code_comment_column      = 0;
2912   const int  instr_maxlen             = Assembler::instr_maxlen();
2913   const uint tabspacing               = 8;
2914   unsigned char* start = this-&gt;code_begin();
2915   unsigned char* p     = this-&gt;code_begin();
2916   unsigned char* end   = this-&gt;code_end();
2917   unsigned char* pss   = p; // start of a code section (used for offsets)
2918 
2919   if ((start == NULL) || (end == NULL)) {
2920     st-&gt;print_cr(&quot;PrintAssembly not possible due to uninitialized section pointers&quot;);
2921     return;
2922   }
2923 #endif
2924 
2925 #if defined(SUPPORT_ABSTRACT_ASSEMBLY)
2926   //---&lt;  plain abstract disassembly, no comments or anything, just section headers  &gt;---
2927   if (use_compressed_format &amp;&amp; ! compressed_with_comments) {
2928     const_cast&lt;nmethod*&gt;(this)-&gt;print_constant_pool(st);
2929 
2930     //---&lt;  Open the output (Marker for post-mortem disassembler)  &gt;---
2931     st-&gt;print_cr(&quot;[MachCode]&quot;);
2932     const char* header = NULL;
2933     address p0 = p;
2934     while (p &lt; end) {
2935       address pp = p;
2936       while ((p &lt; end) &amp;&amp; (header == NULL)) {
2937         header = nmethod_section_label(p);
2938         pp  = p;
2939         p  += Assembler::instr_len(p);
2940       }
2941       if (pp &gt; p0) {
2942         AbstractDisassembler::decode_range_abstract(p0, pp, start, end, st, Assembler::instr_maxlen());
2943         p0 = pp;
2944         p  = pp;
2945         header = NULL;
2946       } else if (header != NULL) {
2947         st-&gt;bol();
2948         st-&gt;print_cr(&quot;%s&quot;, header);
2949         header = NULL;
2950       }
2951     }
2952     //---&lt;  Close the output (Marker for post-mortem disassembler)  &gt;---
2953     st-&gt;bol();
2954     st-&gt;print_cr(&quot;[/MachCode]&quot;);
2955     return;
2956   }
2957 #endif
2958 
2959 #if defined(SUPPORT_ABSTRACT_ASSEMBLY)
2960   //---&lt;  abstract disassembly with comments and section headers merged in  &gt;---
2961   if (compressed_with_comments) {
2962     const_cast&lt;nmethod*&gt;(this)-&gt;print_constant_pool(st);
2963 
2964     //---&lt;  Open the output (Marker for post-mortem disassembler)  &gt;---
2965     st-&gt;print_cr(&quot;[MachCode]&quot;);
2966     while ((p &lt; end) &amp;&amp; (p != NULL)) {
2967       const int instruction_size_in_bytes = Assembler::instr_len(p);
2968 
2969       //---&lt;  Block comments for nmethod. Interrupts instruction stream, if any.  &gt;---
2970       // Outputs a bol() before and a cr() after, but only if a comment is printed.
2971       // Prints nmethod_section_label as well.
2972       if (AbstractDisassembler::show_block_comment()) {
2973         print_block_comment(st, p);
2974         if (st-&gt;position() == 0) {
2975           compressed_format_idx = 0;
2976         }
2977       }
2978 
2979       //---&lt;  New location information after line break  &gt;---
2980       if (compressed_format_idx == 0) {
2981         code_comment_column   = Disassembler::print_location(p, pss, end, st, false, false);
2982         compressed_format_idx = 1;
2983       }
2984 
2985       //---&lt;  Code comment for current instruction. Address range [p..(p+len))  &gt;---
2986       unsigned char* p_end = p + (ssize_t)instruction_size_in_bytes;
2987       S390_ONLY(if (p_end &gt; end) p_end = end;) // avoid getting past the end
2988 
2989       if (AbstractDisassembler::show_comment() &amp;&amp; const_cast&lt;nmethod*&gt;(this)-&gt;has_code_comment(p, p_end)) {
2990         //---&lt;  interrupt instruction byte stream for code comment  &gt;---
2991         if (compressed_format_idx &gt; 1) {
2992           st-&gt;cr();  // interrupt byte stream
2993           st-&gt;cr();  // add an empty line
2994           code_comment_column = Disassembler::print_location(p, pss, end, st, false, false);
2995         }
2996         const_cast&lt;nmethod*&gt;(this)-&gt;print_code_comment_on(st, code_comment_column, p, p_end );
2997         st-&gt;bol();
2998         compressed_format_idx = 0;
2999       }
3000 
3001       //---&lt;  New location information after line break  &gt;---
3002       if (compressed_format_idx == 0) {
3003         code_comment_column   = Disassembler::print_location(p, pss, end, st, false, false);
3004         compressed_format_idx = 1;
3005       }
3006 
3007       //---&lt;  Nicely align instructions for readability  &gt;---
3008       if (compressed_format_idx &gt; 1) {
3009         Disassembler::print_delimiter(st);
3010       }
3011 
3012       //---&lt;  Now, finally, print the actual instruction bytes  &gt;---
3013       unsigned char* p0 = p;
3014       p = Disassembler::decode_instruction_abstract(p, st, instruction_size_in_bytes, instr_maxlen);
3015       compressed_format_idx += p - p0;
3016 
3017       if (Disassembler::start_newline(compressed_format_idx-1)) {
3018         st-&gt;cr();
3019         compressed_format_idx = 0;
3020       }
3021     }
3022     //---&lt;  Close the output (Marker for post-mortem disassembler)  &gt;---
3023     st-&gt;bol();
3024     st-&gt;print_cr(&quot;[/MachCode]&quot;);
3025     return;
3026   }
3027 #endif
3028 }
3029 
3030 #if defined(SUPPORT_ASSEMBLY) || defined(SUPPORT_ABSTRACT_ASSEMBLY)
3031 
3032 const char* nmethod::reloc_string_for(u_char* begin, u_char* end) {
3033   RelocIterator iter(this, begin, end);
3034   bool have_one = false;
3035   while (iter.next()) {
3036     have_one = true;
3037     switch (iter.type()) {
3038         case relocInfo::none:                  return &quot;no_reloc&quot;;
3039         case relocInfo::oop_type: {
3040           // Get a non-resizable resource-allocated stringStream.
3041           // Our callees make use of (nested) ResourceMarks.
3042           stringStream st(NEW_RESOURCE_ARRAY(char, 1024), 1024);
3043           oop_Relocation* r = iter.oop_reloc();
3044           oop obj = r-&gt;oop_value();
3045           st.print(&quot;oop(&quot;);
3046           if (obj == NULL) st.print(&quot;NULL&quot;);
3047           else obj-&gt;print_value_on(&amp;st);
3048           st.print(&quot;)&quot;);
3049           return st.as_string();
3050         }
3051         case relocInfo::metadata_type: {
3052           stringStream st;
3053           metadata_Relocation* r = iter.metadata_reloc();
3054           Metadata* obj = r-&gt;metadata_value();
3055           st.print(&quot;metadata(&quot;);
3056           if (obj == NULL) st.print(&quot;NULL&quot;);
3057           else obj-&gt;print_value_on(&amp;st);
3058           st.print(&quot;)&quot;);
3059           return st.as_string();
3060         }
3061         case relocInfo::runtime_call_type:
3062         case relocInfo::runtime_call_w_cp_type: {
3063           stringStream st;
3064           st.print(&quot;runtime_call&quot;);
3065           CallRelocation* r = (CallRelocation*)iter.reloc();
3066           address dest = r-&gt;destination();
3067           CodeBlob* cb = CodeCache::find_blob(dest);
3068           if (cb != NULL) {
3069             st.print(&quot; %s&quot;, cb-&gt;name());
3070           } else {
3071             ResourceMark rm;
3072             const int buflen = 1024;
3073             char* buf = NEW_RESOURCE_ARRAY(char, buflen);
3074             int offset;
3075             if (os::dll_address_to_function_name(dest, buf, buflen, &amp;offset)) {
3076               st.print(&quot; %s&quot;, buf);
3077               if (offset != 0) {
3078                 st.print(&quot;+%d&quot;, offset);
3079               }
3080             }
3081           }
3082           return st.as_string();
3083         }
3084         case relocInfo::virtual_call_type: {
3085           stringStream st;
3086           st.print_raw(&quot;virtual_call&quot;);
3087           virtual_call_Relocation* r = iter.virtual_call_reloc();
3088           Method* m = r-&gt;method_value();
3089           if (m != NULL) {
3090             assert(m-&gt;is_method(), &quot;&quot;);
3091             m-&gt;print_short_name(&amp;st);
3092           }
3093           return st.as_string();
3094         }
3095         case relocInfo::opt_virtual_call_type: {
3096           stringStream st;
3097           st.print_raw(&quot;optimized virtual_call&quot;);
3098           opt_virtual_call_Relocation* r = iter.opt_virtual_call_reloc();
3099           Method* m = r-&gt;method_value();
3100           if (m != NULL) {
3101             assert(m-&gt;is_method(), &quot;&quot;);
3102             m-&gt;print_short_name(&amp;st);
3103           }
3104           return st.as_string();
3105         }
3106         case relocInfo::static_call_type: {
3107           stringStream st;
3108           st.print_raw(&quot;static_call&quot;);
3109           static_call_Relocation* r = iter.static_call_reloc();
3110           Method* m = r-&gt;method_value();
3111           if (m != NULL) {
3112             assert(m-&gt;is_method(), &quot;&quot;);
3113             m-&gt;print_short_name(&amp;st);
3114           }
3115           return st.as_string();
3116         }
3117         case relocInfo::static_stub_type:      return &quot;static_stub&quot;;
3118         case relocInfo::external_word_type:    return &quot;external_word&quot;;
3119         case relocInfo::internal_word_type:    return &quot;internal_word&quot;;
3120         case relocInfo::section_word_type:     return &quot;section_word&quot;;
3121         case relocInfo::poll_type:             return &quot;poll&quot;;
3122         case relocInfo::poll_return_type:      return &quot;poll_return&quot;;
3123         case relocInfo::trampoline_stub_type:  return &quot;trampoline_stub&quot;;
3124         case relocInfo::type_mask:             return &quot;type_bit_mask&quot;;
3125 
3126         default:
3127           break;
3128     }
3129   }
3130   return have_one ? &quot;other&quot; : NULL;
3131 }
3132 
3133 // Return a the last scope in (begin..end]
3134 ScopeDesc* nmethod::scope_desc_in(address begin, address end) {
3135   PcDesc* p = pc_desc_near(begin+1);
3136   if (p != NULL &amp;&amp; p-&gt;real_pc(this) &lt;= end) {
3137     return new ScopeDesc(this, p-&gt;scope_decode_offset(),
3138                          p-&gt;obj_decode_offset(), p-&gt;should_reexecute(), p-&gt;rethrow_exception(),
3139                          p-&gt;return_oop());
3140   }
3141   return NULL;
3142 }
3143 
3144 const char* nmethod::nmethod_section_label(address pos) const {
3145   const char* label = NULL;
3146   if (pos == code_begin())                                              label = &quot;[Instructions begin]&quot;;
3147   if (pos == entry_point())                                             label = &quot;[Entry Point]&quot;;
3148   if (pos == verified_entry_point())                                    label = &quot;[Verified Entry Point]&quot;;
3149   if (has_method_handle_invokes() &amp;&amp; (pos == deopt_mh_handler_begin())) label = &quot;[Deopt MH Handler Code]&quot;;
3150   if (pos == consts_begin() &amp;&amp; pos != insts_begin())                    label = &quot;[Constants]&quot;;
3151   // Check stub_code before checking exception_handler or deopt_handler.
3152   if (pos == this-&gt;stub_begin())                                        label = &quot;[Stub Code]&quot;;
3153   if (JVMCI_ONLY(_exception_offset &gt;= 0 &amp;&amp;) pos == exception_begin())           label = &quot;[Exception Handler]&quot;;
3154   if (JVMCI_ONLY(_deopt_handler_begin != NULL &amp;&amp;) pos == deopt_handler_begin()) label = &quot;[Deopt Handler Code]&quot;;
3155   return label;
3156 }
3157 
3158 void nmethod::print_nmethod_labels(outputStream* stream, address block_begin, bool print_section_labels) const {
3159   if (print_section_labels) {
3160     const char* label = nmethod_section_label(block_begin);
3161     if (label != NULL) {
3162       stream-&gt;bol();
3163       stream-&gt;print_cr(&quot;%s&quot;, label);
3164     }
3165   }
3166 
3167   if (block_begin == entry_point()) {
3168     Method* m = method();
3169     if (m != NULL) {
3170       stream-&gt;print(&quot;  # &quot;);
3171       m-&gt;print_value_on(stream);
3172       stream-&gt;cr();
3173     }
3174     if (m != NULL &amp;&amp; !is_osr_method()) {
3175       ResourceMark rm;
3176       int sizeargs = m-&gt;size_of_parameters();
3177       BasicType* sig_bt = NEW_RESOURCE_ARRAY(BasicType, sizeargs);
3178       VMRegPair* regs   = NEW_RESOURCE_ARRAY(VMRegPair, sizeargs);
3179       {
3180         int sig_index = 0;
3181         if (!m-&gt;is_static())
3182           sig_bt[sig_index++] = T_OBJECT; // &#39;this&#39;
3183         for (SignatureStream ss(m-&gt;signature()); !ss.at_return_type(); ss.next()) {
3184           BasicType t = ss.type();
3185           sig_bt[sig_index++] = t;
3186           if (type2size[t] == 2) {
3187             sig_bt[sig_index++] = T_VOID;
3188           } else {
3189             assert(type2size[t] == 1, &quot;size is 1 or 2&quot;);
3190           }
3191         }
3192         assert(sig_index == sizeargs, &quot;&quot;);
3193       }
3194       const char* spname = &quot;sp&quot;; // make arch-specific?
3195       intptr_t out_preserve = SharedRuntime::java_calling_convention(sig_bt, regs, sizeargs, false);
3196       int stack_slot_offset = this-&gt;frame_size() * wordSize;
3197       int tab1 = 14, tab2 = 24;
3198       int sig_index = 0;
3199       int arg_index = (m-&gt;is_static() ? 0 : -1);
3200       bool did_old_sp = false;
3201       for (SignatureStream ss(m-&gt;signature()); !ss.at_return_type(); ) {
3202         bool at_this = (arg_index == -1);
3203         bool at_old_sp = false;
3204         BasicType t = (at_this ? T_OBJECT : ss.type());
3205         assert(t == sig_bt[sig_index], &quot;sigs in sync&quot;);
3206         if (at_this)
3207           stream-&gt;print(&quot;  # this: &quot;);
3208         else
3209           stream-&gt;print(&quot;  # parm%d: &quot;, arg_index);
3210         stream-&gt;move_to(tab1);
3211         VMReg fst = regs[sig_index].first();
3212         VMReg snd = regs[sig_index].second();
3213         if (fst-&gt;is_reg()) {
3214           stream-&gt;print(&quot;%s&quot;, fst-&gt;name());
3215           if (snd-&gt;is_valid())  {
3216             stream-&gt;print(&quot;:%s&quot;, snd-&gt;name());
3217           }
3218         } else if (fst-&gt;is_stack()) {
3219           int offset = fst-&gt;reg2stack() * VMRegImpl::stack_slot_size + stack_slot_offset;
3220           if (offset == stack_slot_offset)  at_old_sp = true;
3221           stream-&gt;print(&quot;[%s+0x%x]&quot;, spname, offset);
3222         } else {
3223           stream-&gt;print(&quot;reg%d:%d??&quot;, (int)(intptr_t)fst, (int)(intptr_t)snd);
3224         }
3225         stream-&gt;print(&quot; &quot;);
3226         stream-&gt;move_to(tab2);
3227         stream-&gt;print(&quot;= &quot;);
3228         if (at_this) {
3229           m-&gt;method_holder()-&gt;print_value_on(stream);
3230         } else {
3231           bool did_name = false;
3232           if (!at_this &amp;&amp; ss.is_reference()) {
3233             Symbol* name = ss.as_symbol();
3234             name-&gt;print_value_on(stream);
3235             did_name = true;
3236           }
3237           if (!did_name)
3238             stream-&gt;print(&quot;%s&quot;, type2name(t));
3239         }
3240         if (at_old_sp) {
3241           stream-&gt;print(&quot;  (%s of caller)&quot;, spname);
3242           did_old_sp = true;
3243         }
3244         stream-&gt;cr();
3245         sig_index += type2size[t];
3246         arg_index += 1;
3247         if (!at_this)  ss.next();
3248       }
3249       if (!did_old_sp) {
3250         stream-&gt;print(&quot;  # &quot;);
3251         stream-&gt;move_to(tab1);
3252         stream-&gt;print(&quot;[%s+0x%x]&quot;, spname, stack_slot_offset);
3253         stream-&gt;print(&quot;  (%s of caller)&quot;, spname);
3254         stream-&gt;cr();
3255       }
3256     }
3257   }
3258 }
3259 
3260 // Returns whether this nmethod has code comments.
3261 bool nmethod::has_code_comment(address begin, address end) {
3262   // scopes?
3263   ScopeDesc* sd  = scope_desc_in(begin, end);
3264   if (sd != NULL) return true;
3265 
3266   // relocations?
3267   const char* str = reloc_string_for(begin, end);
3268   if (str != NULL) return true;
3269 
3270   // implicit exceptions?
3271   int cont_offset = ImplicitExceptionTable(this).continuation_offset(begin - code_begin());
3272   if (cont_offset != 0) return true;
3273 
3274   return false;
3275 }
3276 
3277 void nmethod::print_code_comment_on(outputStream* st, int column, address begin, address end) {
3278   ImplicitExceptionTable implicit_table(this);
3279   int pc_offset = begin - code_begin();
3280   int cont_offset = implicit_table.continuation_offset(pc_offset);
3281   bool oop_map_required = false;
3282   if (cont_offset != 0) {
3283     st-&gt;move_to(column, 6, 0);
3284     if (pc_offset == cont_offset) {
3285       st-&gt;print(&quot;; implicit exception: deoptimizes&quot;);
3286       oop_map_required = true;
3287     } else {
3288       st-&gt;print(&quot;; implicit exception: dispatches to &quot; INTPTR_FORMAT, p2i(code_begin() + cont_offset));
3289     }
3290   }
3291 
3292   // Find an oopmap in (begin, end].  We use the odd half-closed
3293   // interval so that oop maps and scope descs which are tied to the
3294   // byte after a call are printed with the call itself.  OopMaps
3295   // associated with implicit exceptions are printed with the implicit
3296   // instruction.
3297   address base = code_begin();
3298   ImmutableOopMapSet* oms = oop_maps();
3299   if (oms != NULL) {
3300     for (int i = 0, imax = oms-&gt;count(); i &lt; imax; i++) {
3301       const ImmutableOopMapPair* pair = oms-&gt;pair_at(i);
3302       const ImmutableOopMap* om = pair-&gt;get_from(oms);
3303       address pc = base + pair-&gt;pc_offset();
3304       if (pc &gt;= begin) {
3305 #if INCLUDE_JVMCI
3306         bool is_implicit_deopt = implicit_table.continuation_offset(pair-&gt;pc_offset()) == (uint) pair-&gt;pc_offset();
3307 #else
3308         bool is_implicit_deopt = false;
3309 #endif
3310         if (is_implicit_deopt ? pc == begin : pc &gt; begin &amp;&amp; pc &lt;= end) {
3311           st-&gt;move_to(column, 6, 0);
3312           st-&gt;print(&quot;; &quot;);
3313           om-&gt;print_on(st);
3314           oop_map_required = false;
3315         }
3316       }
3317       if (pc &gt; end) {
3318         break;
3319       }
3320     }
3321   }
3322   assert(!oop_map_required, &quot;missed oopmap&quot;);
3323 
3324   Thread* thread = Thread::current();
3325 
3326   // Print any debug info present at this pc.
3327   ScopeDesc* sd  = scope_desc_in(begin, end);
3328   if (sd != NULL) {
3329     st-&gt;move_to(column, 6, 0);
3330     if (sd-&gt;bci() == SynchronizationEntryBCI) {
3331       st-&gt;print(&quot;;*synchronization entry&quot;);
3332     } else if (sd-&gt;bci() == AfterBci) {
3333       st-&gt;print(&quot;;* method exit (unlocked if synchronized)&quot;);
3334     } else if (sd-&gt;bci() == UnwindBci) {
3335       st-&gt;print(&quot;;* unwind (locked if synchronized)&quot;);
3336     } else if (sd-&gt;bci() == AfterExceptionBci) {
3337       st-&gt;print(&quot;;* unwind (unlocked if synchronized)&quot;);
3338     } else if (sd-&gt;bci() == UnknownBci) {
3339       st-&gt;print(&quot;;* unknown&quot;);
3340     } else if (sd-&gt;bci() == InvalidFrameStateBci) {
3341       st-&gt;print(&quot;;* invalid frame state&quot;);
3342     } else {
3343       if (sd-&gt;method() == NULL) {
3344         st-&gt;print(&quot;method is NULL&quot;);
3345       } else if (sd-&gt;method()-&gt;is_native()) {
3346         st-&gt;print(&quot;method is native&quot;);
3347       } else {
3348         Bytecodes::Code bc = sd-&gt;method()-&gt;java_code_at(sd-&gt;bci());
3349         st-&gt;print(&quot;;*%s&quot;, Bytecodes::name(bc));
3350         switch (bc) {
3351         case Bytecodes::_invokevirtual:
3352         case Bytecodes::_invokespecial:
3353         case Bytecodes::_invokestatic:
3354         case Bytecodes::_invokeinterface:
3355           {
3356             Bytecode_invoke invoke(methodHandle(thread, sd-&gt;method()), sd-&gt;bci());
3357             st-&gt;print(&quot; &quot;);
3358             if (invoke.name() != NULL)
3359               invoke.name()-&gt;print_symbol_on(st);
3360             else
3361               st-&gt;print(&quot;&lt;UNKNOWN&gt;&quot;);
3362             break;
3363           }
3364         case Bytecodes::_getfield:
3365         case Bytecodes::_putfield:
3366         case Bytecodes::_getstatic:
3367         case Bytecodes::_putstatic:
3368           {
3369             Bytecode_field field(methodHandle(thread, sd-&gt;method()), sd-&gt;bci());
3370             st-&gt;print(&quot; &quot;);
3371             if (field.name() != NULL)
3372               field.name()-&gt;print_symbol_on(st);
3373             else
3374               st-&gt;print(&quot;&lt;UNKNOWN&gt;&quot;);
3375           }
3376         default:
3377           break;
3378         }
3379       }
3380       st-&gt;print(&quot; {reexecute=%d rethrow=%d return_oop=%d}&quot;, sd-&gt;should_reexecute(), sd-&gt;rethrow_exception(), sd-&gt;return_oop());
3381     }
3382 
3383     // Print all scopes
3384     for (;sd != NULL; sd = sd-&gt;sender()) {
3385       st-&gt;move_to(column, 6, 0);
3386       st-&gt;print(&quot;; -&quot;);
3387       if (sd-&gt;should_reexecute()) {
3388         st-&gt;print(&quot; (reexecute)&quot;);
3389       }
3390       if (sd-&gt;method() == NULL) {
3391         st-&gt;print(&quot;method is NULL&quot;);
3392       } else {
3393         sd-&gt;method()-&gt;print_short_name(st);
3394       }
3395       int lineno = sd-&gt;method()-&gt;line_number_from_bci(sd-&gt;bci());
3396       if (lineno != -1) {
3397         st-&gt;print(&quot;@%d (line %d)&quot;, sd-&gt;bci(), lineno);
3398       } else {
3399         st-&gt;print(&quot;@%d&quot;, sd-&gt;bci());
3400       }
3401       st-&gt;cr();
3402     }
3403   }
3404 
3405   // Print relocation information
3406   // Prevent memory leak: allocating without ResourceMark.
3407   ResourceMark rm;
3408   const char* str = reloc_string_for(begin, end);
3409   if (str != NULL) {
3410     if (sd != NULL) st-&gt;cr();
3411     st-&gt;move_to(column, 6, 0);
3412     st-&gt;print(&quot;;   {%s}&quot;, str);
3413   }
3414 }
3415 
3416 #endif
3417 
3418 class DirectNativeCallWrapper: public NativeCallWrapper {
3419 private:
3420   NativeCall* _call;
3421 
3422 public:
3423   DirectNativeCallWrapper(NativeCall* call) : _call(call) {}
3424 
3425   virtual address destination() const { return _call-&gt;destination(); }
3426   virtual address instruction_address() const { return _call-&gt;instruction_address(); }
3427   virtual address next_instruction_address() const { return _call-&gt;next_instruction_address(); }
3428   virtual address return_address() const { return _call-&gt;return_address(); }
3429 
3430   virtual address get_resolve_call_stub(bool is_optimized) const {
3431     if (is_optimized) {
3432       return SharedRuntime::get_resolve_opt_virtual_call_stub();
3433     }
3434     return SharedRuntime::get_resolve_virtual_call_stub();
3435   }
3436 
3437   virtual void set_destination_mt_safe(address dest) {
3438 #if INCLUDE_AOT
3439     if (UseAOT) {
3440       CodeBlob* callee = CodeCache::find_blob(dest);
3441       CompiledMethod* cm = callee-&gt;as_compiled_method_or_null();
3442       if (cm != NULL &amp;&amp; cm-&gt;is_far_code()) {
3443         // Temporary fix, see JDK-8143106
3444         CompiledDirectStaticCall* csc = CompiledDirectStaticCall::at(instruction_address());
3445         csc-&gt;set_to_far(methodHandle(Thread::current(), cm-&gt;method()), dest);
3446         return;
3447       }
3448     }
3449 #endif
3450     _call-&gt;set_destination_mt_safe(dest);
3451   }
3452 
3453   virtual void set_to_interpreted(const methodHandle&amp; method, CompiledICInfo&amp; info) {
3454     CompiledDirectStaticCall* csc = CompiledDirectStaticCall::at(instruction_address());
3455 #if INCLUDE_AOT
3456     if (info.to_aot()) {
3457       csc-&gt;set_to_far(method, info.entry());
3458     } else
3459 #endif
3460     {
3461       csc-&gt;set_to_interpreted(method, info.entry());
3462     }
3463   }
3464 
3465   virtual void verify() const {
3466     // make sure code pattern is actually a call imm32 instruction
3467     _call-&gt;verify();
3468     _call-&gt;verify_alignment();
3469   }
3470 
3471   virtual void verify_resolve_call(address dest) const {
3472     CodeBlob* db = CodeCache::find_blob_unsafe(dest);
3473     assert(db != NULL &amp;&amp; !db-&gt;is_adapter_blob(), &quot;must use stub!&quot;);
3474   }
3475 
3476   virtual bool is_call_to_interpreted(address dest) const {
3477     CodeBlob* cb = CodeCache::find_blob(_call-&gt;instruction_address());
3478     return cb-&gt;contains(dest);
3479   }
3480 
3481   virtual bool is_safe_for_patching() const { return false; }
3482 
3483   virtual NativeInstruction* get_load_instruction(virtual_call_Relocation* r) const {
3484     return nativeMovConstReg_at(r-&gt;cached_value());
3485   }
3486 
3487   virtual void *get_data(NativeInstruction* instruction) const {
3488     return (void*)((NativeMovConstReg*) instruction)-&gt;data();
3489   }
3490 
3491   virtual void set_data(NativeInstruction* instruction, intptr_t data) {
3492     ((NativeMovConstReg*) instruction)-&gt;set_data(data);
3493   }
3494 };
3495 
3496 NativeCallWrapper* nmethod::call_wrapper_at(address call) const {
3497   return new DirectNativeCallWrapper((NativeCall*) call);
3498 }
3499 
3500 NativeCallWrapper* nmethod::call_wrapper_before(address return_pc) const {
3501   return new DirectNativeCallWrapper(nativeCall_before(return_pc));
3502 }
3503 
3504 address nmethod::call_instruction_address(address pc) const {
3505   if (NativeCall::is_call_before(pc)) {
3506     NativeCall *ncall = nativeCall_before(pc);
3507     return ncall-&gt;instruction_address();
3508   }
3509   return NULL;
3510 }
3511 
3512 CompiledStaticCall* nmethod::compiledStaticCall_at(Relocation* call_site) const {
3513   return CompiledDirectStaticCall::at(call_site);
3514 }
3515 
3516 CompiledStaticCall* nmethod::compiledStaticCall_at(address call_site) const {
3517   return CompiledDirectStaticCall::at(call_site);
3518 }
3519 
3520 CompiledStaticCall* nmethod::compiledStaticCall_before(address return_addr) const {
3521   return CompiledDirectStaticCall::before(return_addr);
3522 }
3523 
3524 #if defined(SUPPORT_DATA_STRUCTS)
3525 void nmethod::print_value_on(outputStream* st) const {
3526   st-&gt;print(&quot;nmethod&quot;);
3527   print_on(st, NULL);
3528 }
3529 #endif
3530 
3531 #ifndef PRODUCT
3532 
3533 void nmethod::print_calls(outputStream* st) {
3534   RelocIterator iter(this);
3535   while (iter.next()) {
3536     switch (iter.type()) {
3537     case relocInfo::virtual_call_type:
3538     case relocInfo::opt_virtual_call_type: {
3539       CompiledICLocker ml_verify(this);
3540       CompiledIC_at(&amp;iter)-&gt;print();
3541       break;
3542     }
3543     case relocInfo::static_call_type:
3544       st-&gt;print_cr(&quot;Static call at &quot; INTPTR_FORMAT, p2i(iter.reloc()-&gt;addr()));
3545       CompiledDirectStaticCall::at(iter.reloc())-&gt;print();
3546       break;
3547     default:
3548       break;
3549     }
3550   }
3551 }
3552 
3553 void nmethod::print_statistics() {
3554   ttyLocker ttyl;
3555   if (xtty != NULL)  xtty-&gt;head(&quot;statistics type=&#39;nmethod&#39;&quot;);
3556   native_nmethod_stats.print_native_nmethod_stats();
3557 #ifdef COMPILER1
3558   c1_java_nmethod_stats.print_nmethod_stats(&quot;C1&quot;);
3559 #endif
3560 #ifdef COMPILER2
3561   c2_java_nmethod_stats.print_nmethod_stats(&quot;C2&quot;);
3562 #endif
3563 #if INCLUDE_JVMCI
3564   jvmci_java_nmethod_stats.print_nmethod_stats(&quot;JVMCI&quot;);
3565 #endif
3566   unknown_java_nmethod_stats.print_nmethod_stats(&quot;Unknown&quot;);
3567   DebugInformationRecorder::print_statistics();
3568 #ifndef PRODUCT
3569   pc_nmethod_stats.print_pc_stats();
3570 #endif
3571   Dependencies::print_statistics();
3572   if (xtty != NULL)  xtty-&gt;tail(&quot;statistics&quot;);
3573 }
3574 
3575 #endif // !PRODUCT
3576 
3577 #if INCLUDE_JVMCI
3578 void nmethod::update_speculation(JavaThread* thread) {
3579   jlong speculation = thread-&gt;pending_failed_speculation();
3580   if (speculation != 0) {
3581     guarantee(jvmci_nmethod_data() != NULL, &quot;failed speculation in nmethod without failed speculation list&quot;);
3582     jvmci_nmethod_data()-&gt;add_failed_speculation(this, speculation);
3583     thread-&gt;set_pending_failed_speculation(0);
3584   }
3585 }
3586 
3587 const char* nmethod::jvmci_name() {
3588   if (jvmci_nmethod_data() != NULL) {
3589     return jvmci_nmethod_data()-&gt;name();
3590   }
3591   return NULL;
3592 }
3593 #endif
    </pre>
  </body>
</html>