<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/lib/jdk/test/lib/process/ProcessTools.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../make/conf/jib-profiles.js.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>test/lib/jdk/test/lib/process/ProcessTools.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,4 +1,6 @@</span>
<span class="udiff-line-added">+ </span>
  /*
   * Copyright (c) 2013, 2020, Oracle and/or its affiliates. All rights reserved.
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -27,10 +28,11 @@</span>
  import java.io.IOException;
  import java.io.InputStream;
  import java.io.OutputStream;
  import java.io.PrintStream;
  import java.nio.charset.Charset;
<span class="udiff-line-added">+ import java.lang.reflect.Method;</span>
  import java.nio.file.Paths;
  import java.util.ArrayList;
  import java.util.Arrays;
  import java.util.Collections;
  import java.util.concurrent.CountDownLatch;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -293,11 +295,73 @@</span>
  
          if (addTestVmAndJavaOptions) {
              Collections.addAll(args, Utils.getTestJavaOpts());
          }
  
<span class="udiff-line-modified-removed">-         Collections.addAll(args, command);</span>
<span class="udiff-line-modified-added">+         boolean noModule = true;</span>
<span class="udiff-line-added">+         for (String cmd: command) {</span>
<span class="udiff-line-added">+             if (cmd.equals(&quot;-m&quot;)) {</span>
<span class="udiff-line-added">+                 noModule = false;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         String[] doubleWordArgs = {&quot;-cp&quot;, &quot;-classpath&quot;, &quot;--add-opens&quot;, &quot;--class-path&quot;, &quot;--upgrade-module-path&quot;,</span>
<span class="udiff-line-added">+                                    &quot;--add-modules&quot;, &quot;-d&quot;, &quot;--add-exports&quot;, &quot;--patch-module&quot;, &quot;--module-path&quot;};</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (noModule &amp;&amp; System.getProperty(&quot;main.wrapper&quot;) != null) {</span>
<span class="udiff-line-added">+             boolean skipNext = false;</span>
<span class="udiff-line-added">+             boolean added = false;</span>
<span class="udiff-line-added">+             for (String cmd : command) {</span>
<span class="udiff-line-added">+                 if (added) {</span>
<span class="udiff-line-added">+                     args.add(cmd);</span>
<span class="udiff-line-added">+                     continue;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 if (skipNext) {</span>
<span class="udiff-line-added">+                     skipNext = false;</span>
<span class="udiff-line-added">+                     args.add(cmd);</span>
<span class="udiff-line-added">+                     continue;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 for (String dWArg : doubleWordArgs) {</span>
<span class="udiff-line-added">+                     if (cmd.equals(dWArg)) {</span>
<span class="udiff-line-added">+                         skipNext = true;</span>
<span class="udiff-line-added">+                         args.add(cmd);</span>
<span class="udiff-line-added">+                         continue;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (skipNext) {</span>
<span class="udiff-line-added">+                     continue;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (cmd.startsWith(&quot;-cp&quot;)) {</span>
<span class="udiff-line-added">+                     skipNext = true;</span>
<span class="udiff-line-added">+                     args.add(cmd);</span>
<span class="udiff-line-added">+                     continue;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (cmd.startsWith(&quot;--add-exports&quot;)) {</span>
<span class="udiff-line-added">+                     skipNext = true;</span>
<span class="udiff-line-added">+                     args.add(cmd);</span>
<span class="udiff-line-added">+                     continue;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (cmd.startsWith(&quot;--patch-module&quot;)) {</span>
<span class="udiff-line-added">+                     skipNext = true;</span>
<span class="udiff-line-added">+                     args.add(cmd);</span>
<span class="udiff-line-added">+                     continue;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (cmd.startsWith(&quot;-&quot;)) {</span>
<span class="udiff-line-added">+                     args.add(cmd);</span>
<span class="udiff-line-added">+                     continue;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 args.add(&quot;jdk.test.lib.process.ProcessTools&quot;);</span>
<span class="udiff-line-added">+                 args.add(System.getProperty(&quot;main.wrapper&quot;));</span>
<span class="udiff-line-added">+                 added = true;</span>
<span class="udiff-line-added">+                 // Should be main</span>
<span class="udiff-line-added">+                 // System.out.println(&quot;Wrapped TOFIND: &quot; + cmd);</span>
<span class="udiff-line-added">+                 args.add(cmd);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             Collections.addAll(args, command);</span>
<span class="udiff-line-added">+         }</span>
  
          // Reporting
          StringBuilder cmdLine = new StringBuilder();
          for (String cmd : args)
              cmdLine.append(cmd).append(&#39; &#39;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -622,6 +686,61 @@</span>
                  stderrTask.get();
              } catch (ExecutionException e) {
              }
          }
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // ProcessTools as a wrapper</span>
<span class="udiff-line-added">+     public static void main(String[] args) throws Throwable {</span>
<span class="udiff-line-added">+         String wrapper = args[0];</span>
<span class="udiff-line-added">+         String className = args[1];</span>
<span class="udiff-line-added">+         String[] classArgs = new String[args.length - 2];</span>
<span class="udiff-line-added">+         System.arraycopy(args, 2, classArgs, 0, args.length - 2);</span>
<span class="udiff-line-added">+         Class c = Class.forName(className);</span>
<span class="udiff-line-added">+         Method mainMethod = c.getMethod(&quot;main&quot;, new Class[] { String[].class });</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (wrapper.equals(&quot;Virtual&quot;)) {</span>
<span class="udiff-line-added">+             MainThreadGroup tg = new MainThreadGroup();</span>
<span class="udiff-line-added">+             // TODO fix to set virtual scheduler group when become available</span>
<span class="udiff-line-added">+             Thread vthread = Thread.builder().virtual().task(() -&gt; {</span>
<span class="udiff-line-added">+                     try {</span>
<span class="udiff-line-added">+                         mainMethod.invoke(null, new Object[] { classArgs });</span>
<span class="udiff-line-added">+                     } catch (Throwable error) {</span>
<span class="udiff-line-added">+                         tg.uncaughtThrowable = error;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }).build();</span>
<span class="udiff-line-added">+             vthread.start();</span>
<span class="udiff-line-added">+             vthread.join();</span>
<span class="udiff-line-added">+         } else if (wrapper.equals(&quot;Kernel&quot;)) {</span>
<span class="udiff-line-added">+             MainThreadGroup tg = new MainThreadGroup();</span>
<span class="udiff-line-added">+             Thread t = new Thread(tg, () -&gt; {</span>
<span class="udiff-line-added">+                     try {</span>
<span class="udiff-line-added">+                         mainMethod.invoke(null, new Object[] { classArgs });</span>
<span class="udiff-line-added">+                     } catch (Throwable error) {</span>
<span class="udiff-line-added">+                         tg.uncaughtThrowable = error;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 });</span>
<span class="udiff-line-added">+             t.start();</span>
<span class="udiff-line-added">+             t.join();</span>
<span class="udiff-line-added">+             if (tg.uncaughtThrowable != null) {</span>
<span class="udiff-line-added">+                 throw new RuntimeException(tg.uncaughtThrowable);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             mainMethod.invoke(null, new Object[] { classArgs });</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static class MainThreadGroup extends ThreadGroup {</span>
<span class="udiff-line-added">+         MainThreadGroup() {</span>
<span class="udiff-line-added">+             super(&quot;MainThreadGroup&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public void uncaughtException(Thread t, Throwable e) {</span>
<span class="udiff-line-added">+             if (e instanceof ThreadDeath) {</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             e.printStackTrace(System.err);</span>
<span class="udiff-line-added">+             uncaughtThrowable = e;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         Throwable uncaughtThrowable = null;</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="../../../../../../make/conf/jib-profiles.js.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>