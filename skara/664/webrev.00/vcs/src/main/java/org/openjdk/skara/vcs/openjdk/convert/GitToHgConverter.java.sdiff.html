<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/main/java/org/openjdk/skara/vcs/openjdk/convert/GitToHgConverter.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../hg/HgRepository.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HgToGitConverter.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>vcs/src/main/java/org/openjdk/skara/vcs/openjdk/convert/GitToHgConverter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
204                 var content = gitRepo.show(Path.of(&quot;.hgtags&quot;), commit.hash()).orElseThrow();
205                 var adjustedContent = updateTags(gitRepo, gitToHg, content);
206                 Files.write(hgRoot.resolve(&quot;.hgtags&quot;), adjustedContent, StandardOpenOption.CREATE, StandardOpenOption.WRITE, StandardOpenOption.TRUNCATE_EXISTING);
207             }
208 
209             var author = commit.author();
210             var committer = commit.committer();
211             if (committer.email() == null) {
212                 throw new IllegalStateException(&quot;Commit &quot; + commit.hash().hex() + &quot; contains committer without email&quot;);
213             }
214             var message = CommitMessageParsers.v1.parse(commit.message());
215             var hgMessage = convertMessage(message, author, committer);
216             log.finest(&quot;Message: &quot; + hgMessage);
217             var hgAuthor = username(committer);
218             log.finer(&quot;Author: &quot; + hgAuthor);
219 
220             Hash hgHash = null;
221             if (parents.size() == 1 &amp;&amp; patches0.isEmpty()) {
222                 var tmp = Files.createFile(hgRoot.resolve(&quot;THIS_IS_A_REALLY_UNIQUE_FILE_NAME_THAT_CANT_POSSIBLY_BE_USED&quot;));
223                 hgRepo.add(tmp);
<span class="line-modified">224                 hgRepo.commit(hgMessage, hgAuthor, null, commit.date());</span>
225                 hgRepo.remove(tmp);
226                 hgHash = hgRepo.amend(hgMessage, hgAuthor, null);
227             } else {
228                 hgHash = hgRepo.commit(hgMessage,
229                                        hgAuthor,
230                                        null,
<span class="line-modified">231                                        commit.date());</span>
232             }
233             log.fine(&quot;Converted hg hash: &quot; + hgHash.hex());
234             gitToHg.put(commit.hash(), hgHash);
235             hgToGit.put(hgHash, commit.hash());
236             hgHashes.add(hgHash);
237         }
238 
239         return hgHashes;
240     }
241 
242     private List&lt;Mark&gt; createMarks(List&lt;Hash&gt; hgHashes, Map&lt;Hash, Hash&gt; gitToHg, Map&lt;Hash, Hash&gt; hgToGit) {
243         return createMarks(List.of(), hgHashes, gitToHg, hgToGit);
244     }
245 
246     private List&lt;Mark&gt; createMarks(List&lt;Mark&gt; old, List&lt;Hash&gt; hgHashes, Map&lt;Hash, Hash&gt; gitToHg, Map&lt;Hash, Hash&gt; hgToGit) {
247         var marks = new ArrayList&lt;Mark&gt;(old);
248         for (var i = 0; i &lt; hgHashes.size(); i++) {
249             var hgHash = hgHashes.get(i);
250             var gitHash = hgToGit.get(hgHash);
251             if (gitHash == null) {
</pre>
</td>
<td>
<hr />
<pre>
204                 var content = gitRepo.show(Path.of(&quot;.hgtags&quot;), commit.hash()).orElseThrow();
205                 var adjustedContent = updateTags(gitRepo, gitToHg, content);
206                 Files.write(hgRoot.resolve(&quot;.hgtags&quot;), adjustedContent, StandardOpenOption.CREATE, StandardOpenOption.WRITE, StandardOpenOption.TRUNCATE_EXISTING);
207             }
208 
209             var author = commit.author();
210             var committer = commit.committer();
211             if (committer.email() == null) {
212                 throw new IllegalStateException(&quot;Commit &quot; + commit.hash().hex() + &quot; contains committer without email&quot;);
213             }
214             var message = CommitMessageParsers.v1.parse(commit.message());
215             var hgMessage = convertMessage(message, author, committer);
216             log.finest(&quot;Message: &quot; + hgMessage);
217             var hgAuthor = username(committer);
218             log.finer(&quot;Author: &quot; + hgAuthor);
219 
220             Hash hgHash = null;
221             if (parents.size() == 1 &amp;&amp; patches0.isEmpty()) {
222                 var tmp = Files.createFile(hgRoot.resolve(&quot;THIS_IS_A_REALLY_UNIQUE_FILE_NAME_THAT_CANT_POSSIBLY_BE_USED&quot;));
223                 hgRepo.add(tmp);
<span class="line-modified">224                 hgRepo.commit(hgMessage, hgAuthor, null, commit.authored());</span>
225                 hgRepo.remove(tmp);
226                 hgHash = hgRepo.amend(hgMessage, hgAuthor, null);
227             } else {
228                 hgHash = hgRepo.commit(hgMessage,
229                                        hgAuthor,
230                                        null,
<span class="line-modified">231                                        commit.authored());</span>
232             }
233             log.fine(&quot;Converted hg hash: &quot; + hgHash.hex());
234             gitToHg.put(commit.hash(), hgHash);
235             hgToGit.put(hgHash, commit.hash());
236             hgHashes.add(hgHash);
237         }
238 
239         return hgHashes;
240     }
241 
242     private List&lt;Mark&gt; createMarks(List&lt;Hash&gt; hgHashes, Map&lt;Hash, Hash&gt; gitToHg, Map&lt;Hash, Hash&gt; hgToGit) {
243         return createMarks(List.of(), hgHashes, gitToHg, hgToGit);
244     }
245 
246     private List&lt;Mark&gt; createMarks(List&lt;Mark&gt; old, List&lt;Hash&gt; hgHashes, Map&lt;Hash, Hash&gt; gitToHg, Map&lt;Hash, Hash&gt; hgToGit) {
247         var marks = new ArrayList&lt;Mark&gt;(old);
248         for (var i = 0; i &lt; hgHashes.size(); i++) {
249             var hgHash = hgHashes.get(i);
250             var gitHash = hgToGit.get(hgHash);
251             if (gitHash == null) {
</pre>
</td>
</tr>
</table>
<center><a href="../../hg/HgRepository.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HgToGitConverter.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>