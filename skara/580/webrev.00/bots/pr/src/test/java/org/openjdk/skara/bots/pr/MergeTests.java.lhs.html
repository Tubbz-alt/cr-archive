<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/pr/src/test/java/org/openjdk/skara/bots/pr/MergeTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.pr;
 24 
 25 import org.openjdk.skara.forge.Review;
 26 import org.openjdk.skara.issuetracker.Comment;
 27 import org.openjdk.skara.process.Process;
 28 import org.openjdk.skara.test.*;
 29 import org.openjdk.skara.vcs.*;
 30 
 31 import org.junit.jupiter.api.*;
 32 
 33 import java.io.IOException;
 34 import java.nio.charset.StandardCharsets;
 35 import java.nio.file.*;
 36 import java.util.Set;
 37 import java.util.stream.Collectors;
 38 
 39 import static org.junit.jupiter.api.Assertions.*;
 40 import static org.junit.jupiter.api.Assumptions.assumeTrue;
 41 
 42 class MergeTests {
 43     @Test
 44     void branchMerge(TestInfo testInfo) throws IOException {
 45         try (var credentials = new HostCredentials(testInfo);
 46              var tempFolder = new TemporaryDirectory()) {
 47 
 48             var author = credentials.getHostedRepository();
 49             var integrator = credentials.getHostedRepository();
 50             var censusBuilder = credentials.getCensusBuilder()
 51                                            .addCommitter(author.forge().currentUser().id())
 52                                            .addReviewer(integrator.forge().currentUser().id());
 53             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
 54 
 55             // Populate the projects repository
 56             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
 57             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
 58             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 59             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 60             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 61 
 62             // Make more changes in another branch
 63             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
 64                                                                 &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
 65             localRepo.push(otherHash1, author.url(), &quot;other&quot;, true);
 66             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
 67                                                                 &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
 68             localRepo.push(otherHash2, author.url(), &quot;other&quot;);
 69 
 70             // Go back to the original master
 71             localRepo.checkout(masterHash, true);
 72 
 73             // Make a change with a corresponding PR
 74             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
 75             localRepo.add(unrelated);
 76             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
 77             localRepo.merge(otherHash2);
 78             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);
 79 
 80             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
 81             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
 82             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
 83 
 84             // Approve it as another user
 85             var approvalPr = integrator.pullRequest(pr.id());
 86             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 87 
 88             // Let the bot check the status
 89             TestBotRunner.runPeriodicItems(mergeBot);
 90 
 91             // Push it
 92             pr.addComment(&quot;/integrate&quot;);
 93             TestBotRunner.runPeriodicItems(mergeBot);
 94 
 95             // The bot should reply with an ok message
 96             var pushed = pr.comments().stream()
 97                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
 98                            .count();
 99             assertEquals(1, pushed);
100 
101             // The change should now be present on the master branch
102             var pushedRepoFolder = tempFolder.path().resolve(&quot;pushedrepo&quot;);
103             var pushedRepo = Repository.materialize(pushedRepoFolder, author.url(), &quot;master&quot;);
104             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
105 
106             // The commits from the &quot;other&quot; branch should be preserved and not squashed (but not the merge commit)
107             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
108             Set&lt;Hash&gt; commits;
109             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
110                 commits = tempCommits.stream()
111                         .map(Commit::hash)
112                         .collect(Collectors.toSet());
113             }
114             assertTrue(commits.contains(otherHash1));
115             assertTrue(commits.contains(otherHash2));
116             assertFalse(commits.contains(mergeHash));
117 
118             // Author and committer should updated in the merge commit
119             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
120             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
121             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
122             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
123             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
124         }
125     }
126 
127     @Test
128     void branchMergeShortName(TestInfo testInfo) throws IOException {
129         try (var credentials = new HostCredentials(testInfo);
130              var tempFolder = new TemporaryDirectory()) {
131 
132             var author = credentials.getHostedRepository();
133             var integrator = credentials.getHostedRepository();
134             var censusBuilder = credentials.getCensusBuilder()
135                                            .addCommitter(author.forge().currentUser().id())
136                                            .addReviewer(integrator.forge().currentUser().id());
137             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
138 
139             // Populate the projects repository
140             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
141             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
142             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
143             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
144             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
145 
146             // Make more changes in another branch
147             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
148                                                                  &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
149             localRepo.push(otherHash1, author.url(), &quot;other&quot;, true);
150             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
151                                                                  &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
152             localRepo.push(otherHash2, author.url(), &quot;other&quot;);
153 
154             // Go back to the original master
155             localRepo.checkout(masterHash, true);
156 
157             // Make a change with a corresponding PR
158             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
159             localRepo.add(unrelated);
160             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
161             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);
162 
163             localRepo.merge(otherHash2);
164             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
165             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
166             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge other&quot;);
167 
168             // Approve it as another user
169             var approvalPr = integrator.pullRequest(pr.id());
170             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
171 
172             // Let the bot check the status
173             TestBotRunner.runPeriodicItems(mergeBot);
174 
175             // Push it
176             pr.addComment(&quot;/integrate&quot;);
177             TestBotRunner.runPeriodicItems(mergeBot);
178 
179             // The bot should reply with an ok message
180             var pushed = pr.comments().stream()
181                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
182                            .count();
183             assertEquals(1, pushed);
184 
185             // The change should now be present on the master branch
186             var pushedRepoFolder = tempFolder.path().resolve(&quot;pushedrepo&quot;);
187             var pushedRepo = Repository.materialize(pushedRepoFolder, author.url(), &quot;master&quot;);
188             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
189 
190             // The commits from the &quot;other&quot; branch should be preserved and not squashed (but not the merge commit)
191             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
192             Set&lt;Hash&gt; commits;
193             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
194                 commits = tempCommits.stream()
195                                      .map(Commit::hash)
196                                      .collect(Collectors.toSet());
197             }
198             assertTrue(commits.contains(otherHash1));
199             assertTrue(commits.contains(otherHash2));
200             assertFalse(commits.contains(mergeHash));
201 
202             // Author and committer should updated in the merge commit
203             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
204             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
205             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
206             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
207             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
208         }
209     }
210 
211     @Test
212     void branchMergeRebase(TestInfo testInfo) throws IOException {
213         try (var credentials = new HostCredentials(testInfo);
214              var tempFolder = new TemporaryDirectory()) {
215 
216             var author = credentials.getHostedRepository();
217             var integrator = credentials.getHostedRepository();
218             var censusBuilder = credentials.getCensusBuilder()
219                                            .addCommitter(author.forge().currentUser().id())
220                                            .addReviewer(integrator.forge().currentUser().id());
221             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
222 
223             // Populate the projects repository
224             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
225             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
226             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
227             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
228             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
229 
230             // Make more changes in another branch
231             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
232                                                                  &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
233             localRepo.push(otherHash1, author.url(), &quot;other&quot;, true);
234             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
235                                                                  &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
236             localRepo.push(otherHash2, author.url(), &quot;other&quot;);
237 
238             // Go back to the original master
239             localRepo.checkout(masterHash, true);
240 
241             // Make a change with a corresponding PR
242             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
243             localRepo.add(unrelated);
244             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
245             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);
246 
247             localRepo.merge(otherHash2);
248             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
249             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
250             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
251 
252             // Approve it as another user
253             var approvalPr = integrator.pullRequest(pr.id());
254             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
255 
256             // Let the bot check the status
257             TestBotRunner.runPeriodicItems(mergeBot);
258 
259             // Push something new to master
260             localRepo.checkout(updatedMaster, true);
261             var newMaster = Files.writeString(localRepo.root().resolve(&quot;newmaster.txt&quot;), &quot;New on master&quot;, StandardCharsets.UTF_8);
262             localRepo.add(newMaster);
263             var newMasterHash = localRepo.commit(&quot;New commit on master&quot;, &quot;some&quot;, &quot;some@one&quot;);
264             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
265 
266             // Let the bot notice
267             TestBotRunner.runPeriodicItems(mergeBot);
268 
269             // Push it
270             pr.addComment(&quot;/integrate&quot;);
271             TestBotRunner.runPeriodicItems(mergeBot);
272 
273             // The bot should reply with an ok message
274             var pushed = pr.comments().stream()
275                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
276                            .count();
277             assertEquals(1, pushed, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
278 
279             // The change should now be present on the master branch
280             var pushedRepoFolder = tempFolder.path().resolve(&quot;pushedrepo&quot;);
281             var pushedRepo = Repository.materialize(pushedRepoFolder, author.url(), &quot;master&quot;);
282             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
283 
284             // The commits from the &quot;other&quot; branch should be preserved and not squashed (but not the merge commit)
285             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
286             Set&lt;Hash&gt; commits;
287             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
288                 commits = tempCommits.stream()
289                         .map(Commit::hash)
290                         .collect(Collectors.toSet());
291             }
292             assertTrue(commits.contains(otherHash1));
293             assertTrue(commits.contains(otherHash2));
294             assertFalse(commits.contains(mergeHash));
295 
296             // Author and committer should updated in the merge commit
297             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
298             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
299             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
300             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
301             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
302         }
303     }
304 
305     @Test
306     void branchMergeAdditionalCommits(TestInfo testInfo) throws IOException {
307         try (var credentials = new HostCredentials(testInfo);
308              var tempFolder = new TemporaryDirectory()) {
309 
310             var author = credentials.getHostedRepository();
311             var integrator = credentials.getHostedRepository();
312             var censusBuilder = credentials.getCensusBuilder()
313                                            .addCommitter(author.forge().currentUser().id())
314                                            .addReviewer(integrator.forge().currentUser().id());
315             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
316 
317             // Populate the projects repository
318             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
319             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
320             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
321             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
322             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
323 
324             // Make more changes in another branch
325             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
326                                                                  &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
327             localRepo.push(otherHash1, author.url(), &quot;other&quot;, true);
328             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
329                                                                  &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
330             localRepo.push(otherHash2, author.url(), &quot;other&quot;);
331 
332             // Go back to the original master
333             localRepo.checkout(masterHash, true);
334 
335             // Make a change with a corresponding PR
336             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
337             localRepo.add(unrelated);
338             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
339             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);
340 
341             localRepo.merge(otherHash2);
342             var mergeHash = localRepo.commit(&quot;Our own merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
343             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
344             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
345 
346             // Approve it as another user
347             var approvalPr = integrator.pullRequest(pr.id());
348             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
349 
350             // Let the bot check the status
351             TestBotRunner.runPeriodicItems(mergeBot);
352 
353             // Push something new to master
354             localRepo.checkout(updatedMaster, true);
355             var newMaster = Files.writeString(localRepo.root().resolve(&quot;newmaster.txt&quot;), &quot;New on master&quot;, StandardCharsets.UTF_8);
356             localRepo.add(newMaster);
357             var newMasterHash = localRepo.commit(&quot;New commit on master&quot;, &quot;some&quot;, &quot;some@one&quot;);
358             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
359 
360             // Let the bot notice
361             TestBotRunner.runPeriodicItems(mergeBot);
362 
363             // Add another commit on top of the merge commit
364             localRepo.checkout(mergeHash, true);
365             var extraHash = CheckableRepository.appendAndCommit(localRepo, &quot;Fixing up stuff after merge&quot;);
366             localRepo.push(extraHash, author.url(), &quot;edit&quot;);
367 
368             // Let the bot notice again
369             TestBotRunner.runPeriodicItems(mergeBot);
370 
371             // Merge the latest from master
372             localRepo.merge(newMasterHash);
373             var latestMergeHash = localRepo.commit(&quot;Our to be squashed merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
374             localRepo.push(latestMergeHash, author.url(), &quot;edit&quot;);
375 
376             // Let the bot notice again
377             TestBotRunner.runPeriodicItems(mergeBot);
378 
379             // Push it
380             pr.addComment(&quot;/integrate&quot;);
381             TestBotRunner.runPeriodicItems(mergeBot);
382 
383             // The bot should reply with an ok message
384             var pushed = pr.comments().stream()
385                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
386                            .count();
387             assertEquals(1, pushed, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
388 
389             // The change should now be present on the master branch
390             var pushedRepoFolder = tempFolder.path().resolve(&quot;pushedrepo&quot;);
391             var pushedRepo = Repository.materialize(pushedRepoFolder, author.url(), &quot;master&quot;);
392             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
393 
394             // The commits from the &quot;other&quot; branch should be preserved and not squashed (but not the merge commit)
395             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
396             String commits;
397             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
398                 commits = tempCommits.stream()
399                                      .map(c -&gt; c.hash().hex() + &quot;:&quot; + c.message().get(0))
400                                      .collect(Collectors.joining(&quot;,&quot;));
401             }
402             assertTrue(commits.contains(otherHash1.hex() + &quot;:First other&quot;));
403             assertTrue(commits.contains(otherHash2.hex() + &quot;:Second other&quot;));
404             assertFalse(commits.contains(&quot;Our own merge commit&quot;));
405 
406             // Author and committer should updated in the merge commit
407             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
408             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
409             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
410             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
411             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
412         }
413     }
414 
415     @Test
416     void invalidMergeCommit(TestInfo testInfo) throws IOException {
417         try (var credentials = new HostCredentials(testInfo);
418              var tempFolder = new TemporaryDirectory()) {
419 
420             var author = credentials.getHostedRepository();
421             var integrator = credentials.getHostedRepository();
422             var censusBuilder = credentials.getCensusBuilder()
423                                            .addCommitter(author.forge().currentUser().id())
424                                            .addReviewer(integrator.forge().currentUser().id());
425             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
426 
427             // Populate the projects repository
428             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
429             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
430             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
431             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
432             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
433 
434             // Make a change in another branch
435             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
436                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
437             localRepo.push(otherHash, author.url(), &quot;other&quot;, true);
438 
439             // Go back to the original master
440             localRepo.checkout(masterHash, true);
441 
442             // Make a change with a corresponding PR
443             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
444             localRepo.add(unrelated);
445             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
446             localRepo.merge(otherHash);
447             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
448             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
449             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
450 
451             // Approve it as another user
452             var approvalPr = integrator.pullRequest(pr.id());
453             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
454 
455             // Let the bot check the status
456             TestBotRunner.runPeriodicItems(mergeBot);
457 
458             // Push it
459             pr.addComment(&quot;/integrate&quot;);
460             TestBotRunner.runPeriodicItems(mergeBot);
461 
462             // The bot should reply with a failure message
463             var error = pr.comments().stream()
464                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
465                           .count();
466             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
467 
468             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
469             assertEquals(&quot;- It was not possible to create a commit for the changes in this PR: No merge commit containing commits from another branch than the target was found&quot;, check.summary().orElseThrow());
470         }
471     }
472 
473     @Test
474     void invalidSourceRepo(TestInfo testInfo) throws IOException {
475         try (var credentials = new HostCredentials(testInfo);
476              var tempFolder = new TemporaryDirectory()) {
477 
478             var author = credentials.getHostedRepository();
479             var integrator = credentials.getHostedRepository();
480             var censusBuilder = credentials.getCensusBuilder()
481                                            .addCommitter(author.forge().currentUser().id())
482                                            .addReviewer(integrator.forge().currentUser().id());
483             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
484 
485             // Populate the projects repository
486             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
487             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
488             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
489             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
490             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
491 
492             // Make a change in another branch
493             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
494                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
495             localRepo.push(otherHash, author.url(), &quot;other&quot;, true);
496 
497             // Go back to the original master
498             localRepo.checkout(masterHash, true);
499 
500             // Make a change with a corresponding PR
501             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
502             localRepo.add(unrelated);
503             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
504             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);
505 
506             localRepo.merge(otherHash);
507             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
508             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
509             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;xyz&quot; + &quot;:other&quot;);
510 
511             // Approve it as another user
512             var approvalPr = integrator.pullRequest(pr.id());
513             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
514 
515             // Let the bot check the status
516             TestBotRunner.runPeriodicItems(mergeBot);
517 
518             // Push it
519             pr.addComment(&quot;/integrate&quot;);
520             TestBotRunner.runPeriodicItems(mergeBot);
521 
522             // The bot should reply with a failure message
523             var error = pr.comments().stream()
524                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
525                           .count();
526             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
527 
528             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
529             assertEquals(&quot;- Could not find project `&quot; + author.name() + &quot;xyz` - check that it is correct.&quot;, check.summary().orElseThrow());
530         }
531     }
532 
533     @Test
534     void invalidSourceBranch(TestInfo testInfo) throws IOException {
535         try (var credentials = new HostCredentials(testInfo);
536              var tempFolder = new TemporaryDirectory()) {
537 
538             var author = credentials.getHostedRepository();
539             var integrator = credentials.getHostedRepository();
540             var censusBuilder = credentials.getCensusBuilder()
541                                            .addCommitter(author.forge().currentUser().id())
542                                            .addReviewer(integrator.forge().currentUser().id());
543             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
544 
545             // Populate the projects repository
546             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
547             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
548             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
549             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
550             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
551 
552             // Make a change in another branch
553             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
554                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
555             localRepo.push(otherHash, author.url(), &quot;other&quot;, true);
556 
557             // Go back to the original master
558             localRepo.checkout(masterHash, true);
559 
560             // Make a change with a corresponding PR
561             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
562             localRepo.add(unrelated);
563             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
564             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);
565 
566             localRepo.merge(otherHash);
567             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
568             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
569             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:otherxyz&quot;);
570 
571             // Approve it as another user
572             var approvalPr = integrator.pullRequest(pr.id());
573             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
574 
575             // Let the bot check the status
576             TestBotRunner.runPeriodicItems(mergeBot);
577 
578             // Push it
579             pr.addComment(&quot;/integrate&quot;);
580             TestBotRunner.runPeriodicItems(mergeBot);
581 
582             // The bot should reply with a failure message
583             var error = pr.comments().stream()
584                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
585                           .count();
586             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
587 
588             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
589             assertEquals(&quot;- Could not fetch branch `otherxyz` from project `&quot; + author.name() + &quot;` - check that they are correct.&quot;, check.summary().orElseThrow());
590         }
591     }
592 
593     @Test
594     void inferredSourceProject(TestInfo testInfo) throws IOException {
595         try (var credentials = new HostCredentials(testInfo);
596              var tempFolder = new TemporaryDirectory()) {
597 
598             var author = credentials.getHostedRepository();
599             var integrator = credentials.getHostedRepository();
600             var censusBuilder = credentials.getCensusBuilder()
601                                            .addCommitter(author.forge().currentUser().id())
602                                            .addReviewer(integrator.forge().currentUser().id());
603             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
604 
605             // Populate the projects repository
606             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
607             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
608             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
609             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
610             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
611 
612             // Make a change in another branch
613             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
614                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
615             localRepo.push(otherHash, author.url(), &quot;other&quot;, true);
616 
617             // Go back to the original master
618             localRepo.checkout(masterHash, true);
619 
620             // Make a change with a corresponding PR
621             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
622             localRepo.add(unrelated);
623             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
624             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);
625 
626             localRepo.merge(otherHash);
627             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
628             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
629             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge otherxyz&quot;);
630 
631             // Approve it as another user
632             var approvalPr = integrator.pullRequest(pr.id());
633             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
634 
635             // Let the bot check the status
636             TestBotRunner.runPeriodicItems(mergeBot);
637 
638             // Push it
639             pr.addComment(&quot;/integrate&quot;);
640             TestBotRunner.runPeriodicItems(mergeBot);
641 
642             // The bot should reply with a failure message
643             var error = pr.comments().stream()
644                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
645                           .count();
646             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
647 
648             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
649             assertEquals(&quot;- Could not find project `otherxyz` - check that it is correct.&quot;, check.summary().orElseThrow());
650         }
651     }
652 
653     @Test
654     void wrongSourceBranch(TestInfo testInfo) throws IOException {
655         try (var credentials = new HostCredentials(testInfo);
656              var tempFolder = new TemporaryDirectory()) {
657 
658             var author = credentials.getHostedRepository();
659             var integrator = credentials.getHostedRepository();
660             var censusBuilder = credentials.getCensusBuilder()
661                                            .addCommitter(author.forge().currentUser().id())
662                                            .addReviewer(integrator.forge().currentUser().id());
663             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
664 
665             // Populate the projects repository
666             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
667             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
668             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
669             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
670             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
671 
672             // Make a change in another branch
673             var other1Hash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other1&quot;,
674                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
675             localRepo.push(other1Hash, author.url(), &quot;other1&quot;, true);
676 
677             // Go back to the original master
678             localRepo.checkout(masterHash, true);
679 
680             // Make yet another change in another branch
681             var other2Hash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other2&quot;,
682                                                                 &quot;Unrelated\n\nReviewed-by: integrationreviewer2&quot;);
683             localRepo.push(other2Hash, author.url(), &quot;other2&quot;, true);
684 
685             // Make a change with a corresponding PR
686             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
687             localRepo.add(unrelated);
688             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
689             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);
690 
691             localRepo.merge(other1Hash, &quot;ours&quot;);
692             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
693             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
694             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other2&quot;);
695 
696             // Approve it as another user
697             var approvalPr = integrator.pullRequest(pr.id());
698             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
699 
700             // Let the bot check the status
701             TestBotRunner.runPeriodicItems(mergeBot);
702 
703             // Push it
704             pr.addComment(&quot;/integrate&quot;);
705             TestBotRunner.runPeriodicItems(mergeBot);
706 
707             // The bot should reply with a failure message
708             var error = pr.comments().stream()
709                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
710                           .count();
711             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
712 
713             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
714             assertEquals(&quot;- The merge contains commits that are not ancestors of the source.&quot;, check.summary().orElseThrow());
715         }
716     }
717 
718     @Test
719     void invalidAuthor(TestInfo testInfo) throws IOException {
720         try (var credentials = new HostCredentials(testInfo);
721              var tempFolder = new TemporaryDirectory()) {
722 
723             var author = credentials.getHostedRepository();
724             var integrator = credentials.getHostedRepository();
725             var censusBuilder = credentials.getCensusBuilder()
726                                            .addAuthor(author.forge().currentUser().id())
727                                            .addReviewer(integrator.forge().currentUser().id());
728             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
729 
730             // Populate the projects repository
731             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
732             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
733             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
734             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
735             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
736 
737             // Make a change in another branch
738             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
739                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
740             localRepo.push(otherHash, author.url(), &quot;other&quot;, true);
741 
742             // Go back to the original master
743             localRepo.checkout(masterHash, true);
744 
745             // Make a change with a corresponding PR
746             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
747             localRepo.add(unrelated);
748             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
749             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);
750 
751             localRepo.merge(otherHash);
752             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
753             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
754             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
755 
756             // Approve it as another user
757             var approvalPr = integrator.pullRequest(pr.id());
758             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
759 
760             // Let the bot check the status
761             TestBotRunner.runPeriodicItems(mergeBot);
762 
763             // Push it
764             pr.addComment(&quot;/integrate&quot;);
765             TestBotRunner.runPeriodicItems(mergeBot);
766 
767             // The bot should reply with a need for sponsor
768             var error = pr.comments().stream()
769                           .filter(comment -&gt; comment.body().contains(&quot;Afterwards, your sponsor types `/sponsor`&quot;))
770                           .count();
771             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
772         }
773     }
774 
775     @Test
776     void unrelatedHistory(TestInfo testInfo) throws IOException {
777         try (var credentials = new HostCredentials(testInfo);
778              var tempFolder = new TemporaryDirectory()) {
779 
780             var author = credentials.getHostedRepository();
781             // Need to force merge unrelated histories
782             assumeTrue(author.repositoryType().equals(VCS.GIT));
783 
784             var integrator = credentials.getHostedRepository();
785             var censusBuilder = credentials.getCensusBuilder()
786                                            .addCommitter(author.forge().currentUser().id())
787                                            .addReviewer(integrator.forge().currentUser().id());
788             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
789 
790             // Populate the projects repository
791             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
792             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
793             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
794 
795             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
796             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
797 
798             // Make an unrelated change in another branch
799             var unrelatedRepoFolder = tempFolder.path().resolve(&quot;unrelated&quot;);
800             var unrelatedRepo = CheckableRepository.init(unrelatedRepoFolder, author.repositoryType(), Path.of(&quot;anotherfile.txt&quot;));
801             unrelatedRepo.amend(&quot;Unrelated initial commit\n\nReviewed-by: integrationreviewer2&quot;, &quot;some&quot;, &quot;one@mail&quot;);
802             var otherHash = CheckableRepository.appendAndCommit(unrelatedRepo, &quot;Change in other&quot;,
803                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
804             unrelatedRepo.push(otherHash, author.url(), &quot;other&quot;, true);
805             localRepo.fetch(author.url(), &quot;other&quot;);
806 
807             // Go back to the original master
808             localRepo.checkout(masterHash, true);
809 
810             // Make a change with a corresponding PR
811             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
812             localRepo.add(unrelated);
813             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
814             var mergeCmd = Process.command(&quot;git&quot;, &quot;merge&quot;, &quot;--no-commit&quot;, &quot;--allow-unrelated-histories&quot;, &quot;-s&quot;, &quot;ours&quot;, otherHash.hex())
815                                   .workdir(localRepo.root())
816                                   .environ(&quot;GIT_AUTHOR_NAME&quot;, &quot;some&quot;)
817                                   .environ(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;some@one&quot;)
818                                   .environ(&quot;GIT_COMMITTER_NAME&quot;, &quot;another&quot;)
819                                   .environ(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;another@one&quot;)
820                                   .execute();
821             mergeCmd.check();
822 
823             //localRepo.merge(otherHash);
824             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
825             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
826             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
827 
828             // Approve it as another user
829             var approvalPr = integrator.pullRequest(pr.id());
830             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
831 
832             // Let the bot check the status
833             TestBotRunner.runPeriodicItems(mergeBot);
834 
835             // Push it
836             pr.addComment(&quot;/integrate&quot;);
837             TestBotRunner.runPeriodicItems(mergeBot);
838 
839             // The bot should reply with an ok message as we currently allow this
840             var pushed = pr.comments().stream()
841                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
842                            .count();
843             assertEquals(1, pushed);
844         }
845     }
<a name="1" id="anc1"></a>
























































846 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>