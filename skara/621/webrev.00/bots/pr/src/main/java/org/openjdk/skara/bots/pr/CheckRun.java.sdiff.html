<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/CheckRun.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/pr/CheckTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/CheckRun.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 33 import java.nio.file.Path;
 34 import java.util.*;
 35 import java.util.logging.Logger;
 36 import java.util.regex.*;
 37 import java.util.stream.*;
 38 
 39 class CheckRun {
 40     private final CheckWorkItem workItem;
 41     private final PullRequest pr;
 42     private final Repository localRepo;
 43     private final List&lt;Comment&gt; comments;
 44     private final List&lt;Review&gt; allReviews;
 45     private final List&lt;Review&gt; activeReviews;
 46     private final Set&lt;String&gt; labels;
 47     private final CensusInstance censusInstance;
 48     private final boolean ignoreStaleReviews;
 49 
 50     private final Hash baseHash;
 51     private final CheckablePullRequest checkablePullRequest;
 52 
<span class="line-modified"> 53     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.pr&quot;);</span>
<span class="line-modified"> 54     private final String progressMarker = &quot;&lt;!-- Anything below this marker will be automatically updated, please do not edit manually! --&gt;&quot;;</span>
<span class="line-modified"> 55     private final String mergeReadyMarker = &quot;&lt;!-- PullRequestBot merge is ready comment --&gt;&quot;;</span>
<span class="line-modified"> 56     private final String outdatedHelpMarker = &quot;&lt;!-- PullRequestBot outdated help comment --&gt;&quot;;</span>
<span class="line-modified"> 57     private final String sourceBranchWarningMarker = &quot;&lt;!-- PullRequestBot source branch warning comment --&gt;&quot;;</span>


 58     private final Set&lt;String&gt; newLabels;
 59 
 60     private CheckRun(CheckWorkItem workItem, PullRequest pr, Repository localRepo, List&lt;Comment&gt; comments,
 61                      List&lt;Review&gt; allReviews, List&lt;Review&gt; activeReviews, Set&lt;String&gt; labels,
 62                      CensusInstance censusInstance, boolean ignoreStaleReviews) throws IOException {
 63         this.workItem = workItem;
 64         this.pr = pr;
 65         this.localRepo = localRepo;
 66         this.comments = comments;
 67         this.allReviews = allReviews;
 68         this.activeReviews = activeReviews;
 69         this.labels = new HashSet&lt;&gt;(labels);
 70         this.newLabels = new HashSet&lt;&gt;(labels);
 71         this.censusInstance = censusInstance;
 72         this.ignoreStaleReviews = ignoreStaleReviews;
 73 
 74         baseHash = PullRequestUtils.baseHash(pr, localRepo);
 75         checkablePullRequest = new CheckablePullRequest(pr, localRepo, ignoreStaleReviews);
 76     }
 77 
</pre>
<hr />
<pre>
341            &quot;`$ git fetch &quot; + repoUrl + &quot; &quot; + pr.fetchRef() + &quot;:pull/&quot; + pr.id() + &quot;`\n&quot; +
342            &quot;`$ git checkout pull/&quot; + pr.id() + &quot;`\n&quot;;
343     }
344 
345     private String bodyWithoutStatus() {
346         var description = pr.body();
347         var markerIndex = description.lastIndexOf(progressMarker);
348         return (markerIndex &lt; 0 ?
349                 description :
350                 description.substring(0, markerIndex)).trim();
351     }
352 
353     private String updateStatusMessage(String message) {
354         var description = pr.body();
355         var markerIndex = description.lastIndexOf(progressMarker);
356 
357         if (markerIndex &gt;= 0 &amp;&amp; description.substring(markerIndex).equals(message)) {
358             log.info(&quot;Progress already up to date&quot;);
359             return description;
360         }
<span class="line-modified">361         var newBody = bodyWithoutStatus() + &quot;\n&quot; + progressMarker + &quot;\n&quot; + message;</span>




362 
363         // TODO? Retrieve the body again here to lower the chance of concurrent updates
364         pr.setBody(newBody);
365         return newBody;
366     }
367 
368     private String verdictToString(Review.Verdict verdict) {
369         switch (verdict) {
370             case APPROVED:
371                 return &quot;changes are approved&quot;;
372             case DISAPPROVED:
373                 return &quot;more changes needed&quot;;
374             case NONE:
375                 return &quot;comment added&quot;;
376             default:
377                 throw new RuntimeException(&quot;Unknown verdict: &quot; + verdict);
378         }
379     }
380 
381     private void updateReviewedMessages(List&lt;Comment&gt; comments, List&lt;Review&gt; reviews) {
</pre>
</td>
<td>
<hr />
<pre>
 33 import java.nio.file.Path;
 34 import java.util.*;
 35 import java.util.logging.Logger;
 36 import java.util.regex.*;
 37 import java.util.stream.*;
 38 
 39 class CheckRun {
 40     private final CheckWorkItem workItem;
 41     private final PullRequest pr;
 42     private final Repository localRepo;
 43     private final List&lt;Comment&gt; comments;
 44     private final List&lt;Review&gt; allReviews;
 45     private final List&lt;Review&gt; activeReviews;
 46     private final Set&lt;String&gt; labels;
 47     private final CensusInstance censusInstance;
 48     private final boolean ignoreStaleReviews;
 49 
 50     private final Hash baseHash;
 51     private final CheckablePullRequest checkablePullRequest;
 52 
<span class="line-modified"> 53     private static final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.pr&quot;);</span>
<span class="line-modified"> 54     private static final String progressMarker = &quot;&lt;!-- Anything below this marker will be automatically updated, please do not edit manually! --&gt;&quot;;</span>
<span class="line-modified"> 55     private static final String mergeReadyMarker = &quot;&lt;!-- PullRequestBot merge is ready comment --&gt;&quot;;</span>
<span class="line-modified"> 56     private static final String outdatedHelpMarker = &quot;&lt;!-- PullRequestBot outdated help comment --&gt;&quot;;</span>
<span class="line-modified"> 57     private static final String sourceBranchWarningMarker = &quot;&lt;!-- PullRequestBot source branch warning comment --&gt;&quot;;</span>
<span class="line-added"> 58     private static final String emptyPrBodyMarker = &quot;&lt;!--\nReplace this text with a description of your pull request (also remove the surrounding HTML comment markers).\n&quot; +</span>
<span class="line-added"> 59             &quot;If in doubt, feel free to delete everything in this edit box first, the bot will restore the progress section as needed.\n--&gt;&quot;;</span>
 60     private final Set&lt;String&gt; newLabels;
 61 
 62     private CheckRun(CheckWorkItem workItem, PullRequest pr, Repository localRepo, List&lt;Comment&gt; comments,
 63                      List&lt;Review&gt; allReviews, List&lt;Review&gt; activeReviews, Set&lt;String&gt; labels,
 64                      CensusInstance censusInstance, boolean ignoreStaleReviews) throws IOException {
 65         this.workItem = workItem;
 66         this.pr = pr;
 67         this.localRepo = localRepo;
 68         this.comments = comments;
 69         this.allReviews = allReviews;
 70         this.activeReviews = activeReviews;
 71         this.labels = new HashSet&lt;&gt;(labels);
 72         this.newLabels = new HashSet&lt;&gt;(labels);
 73         this.censusInstance = censusInstance;
 74         this.ignoreStaleReviews = ignoreStaleReviews;
 75 
 76         baseHash = PullRequestUtils.baseHash(pr, localRepo);
 77         checkablePullRequest = new CheckablePullRequest(pr, localRepo, ignoreStaleReviews);
 78     }
 79 
</pre>
<hr />
<pre>
343            &quot;`$ git fetch &quot; + repoUrl + &quot; &quot; + pr.fetchRef() + &quot;:pull/&quot; + pr.id() + &quot;`\n&quot; +
344            &quot;`$ git checkout pull/&quot; + pr.id() + &quot;`\n&quot;;
345     }
346 
347     private String bodyWithoutStatus() {
348         var description = pr.body();
349         var markerIndex = description.lastIndexOf(progressMarker);
350         return (markerIndex &lt; 0 ?
351                 description :
352                 description.substring(0, markerIndex)).trim();
353     }
354 
355     private String updateStatusMessage(String message) {
356         var description = pr.body();
357         var markerIndex = description.lastIndexOf(progressMarker);
358 
359         if (markerIndex &gt;= 0 &amp;&amp; description.substring(markerIndex).equals(message)) {
360             log.info(&quot;Progress already up to date&quot;);
361             return description;
362         }
<span class="line-modified">363         var originalBody = bodyWithoutStatus();</span>
<span class="line-added">364         if (originalBody.isBlank()) {</span>
<span class="line-added">365             originalBody = emptyPrBodyMarker;</span>
<span class="line-added">366         }</span>
<span class="line-added">367         var newBody = originalBody + &quot;\n&quot; + progressMarker + &quot;\n&quot; + message;</span>
368 
369         // TODO? Retrieve the body again here to lower the chance of concurrent updates
370         pr.setBody(newBody);
371         return newBody;
372     }
373 
374     private String verdictToString(Review.Verdict verdict) {
375         switch (verdict) {
376             case APPROVED:
377                 return &quot;changes are approved&quot;;
378             case DISAPPROVED:
379                 return &quot;more changes needed&quot;;
380             case NONE:
381                 return &quot;comment added&quot;;
382             default:
383                 throw new RuntimeException(&quot;Unknown verdict: &quot; + verdict);
384         }
385     }
386 
387     private void updateReviewedMessages(List&lt;Comment&gt; comments, List&lt;Review&gt; reviews) {
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/pr/CheckTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>