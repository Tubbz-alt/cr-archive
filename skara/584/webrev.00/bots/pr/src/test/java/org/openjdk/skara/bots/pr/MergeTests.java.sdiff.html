<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/test/java/org/openjdk/skara/bots/pr/MergeTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/PullRequestInstance.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../vcs/src/main/java/org/openjdk/skara/vcs/git/GitRepository.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/test/java/org/openjdk/skara/bots/pr/MergeTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
192             Set&lt;Hash&gt; commits;
193             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
194                 commits = tempCommits.stream()
195                                      .map(Commit::hash)
196                                      .collect(Collectors.toSet());
197             }
198             assertTrue(commits.contains(otherHash1));
199             assertTrue(commits.contains(otherHash2));
200             assertFalse(commits.contains(mergeHash));
201 
202             // Author and committer should updated in the merge commit
203             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
204             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
205             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
206             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
207             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
208         }
209     }
210 
211     @Test

212     void branchMergeRebase(TestInfo testInfo) throws IOException {
213         try (var credentials = new HostCredentials(testInfo);
214              var tempFolder = new TemporaryDirectory()) {
215 
216             var author = credentials.getHostedRepository();
217             var integrator = credentials.getHostedRepository();
218             var censusBuilder = credentials.getCensusBuilder()
219                                            .addCommitter(author.forge().currentUser().id())
220                                            .addReviewer(integrator.forge().currentUser().id());
221             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
222 
223             // Populate the projects repository
224             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
225             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
226             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
227             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
228             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
229 
230             // Make more changes in another branch
231             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
</pre>
<hr />
<pre>
286             Set&lt;Hash&gt; commits;
287             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
288                 commits = tempCommits.stream()
289                         .map(Commit::hash)
290                         .collect(Collectors.toSet());
291             }
292             assertTrue(commits.contains(otherHash1));
293             assertTrue(commits.contains(otherHash2));
294             assertFalse(commits.contains(mergeHash));
295 
296             // Author and committer should updated in the merge commit
297             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
298             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
299             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
300             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
301             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
302         }
303     }
304 
305     @Test

306     void branchMergeAdditionalCommits(TestInfo testInfo) throws IOException {
307         try (var credentials = new HostCredentials(testInfo);
308              var tempFolder = new TemporaryDirectory()) {
309 
310             var author = credentials.getHostedRepository();
311             var integrator = credentials.getHostedRepository();
312             var censusBuilder = credentials.getCensusBuilder()
313                                            .addCommitter(author.forge().currentUser().id())
314                                            .addReviewer(integrator.forge().currentUser().id());
315             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
316 
317             // Populate the projects repository
318             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
319             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
320             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
321             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
322             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
323 
324             // Make more changes in another branch
325             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
</pre>
<hr />
<pre>
449             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
450 
451             // Approve it as another user
452             var approvalPr = integrator.pullRequest(pr.id());
453             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
454 
455             // Let the bot check the status
456             TestBotRunner.runPeriodicItems(mergeBot);
457 
458             // Push it
459             pr.addComment(&quot;/integrate&quot;);
460             TestBotRunner.runPeriodicItems(mergeBot);
461 
462             // The bot should reply with a failure message
463             var error = pr.comments().stream()
464                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
465                           .count();
466             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
467 
468             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
<span class="line-modified">469             assertEquals(&quot;- It was not possible to create a commit for the changes in this PR: No merge commit containing commits from another branch than the target was found&quot;, check.summary().orElseThrow());</span>
470         }
471     }
472 
473     @Test
474     void invalidSourceRepo(TestInfo testInfo) throws IOException {
475         try (var credentials = new HostCredentials(testInfo);
476              var tempFolder = new TemporaryDirectory()) {
477 
478             var author = credentials.getHostedRepository();
479             var integrator = credentials.getHostedRepository();
480             var censusBuilder = credentials.getCensusBuilder()
481                                            .addCommitter(author.forge().currentUser().id())
482                                            .addReviewer(integrator.forge().currentUser().id());
483             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
484 
485             // Populate the projects repository
486             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
487             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
488             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
489             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
</pre>
</td>
<td>
<hr />
<pre>
192             Set&lt;Hash&gt; commits;
193             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
194                 commits = tempCommits.stream()
195                                      .map(Commit::hash)
196                                      .collect(Collectors.toSet());
197             }
198             assertTrue(commits.contains(otherHash1));
199             assertTrue(commits.contains(otherHash2));
200             assertFalse(commits.contains(mergeHash));
201 
202             // Author and committer should updated in the merge commit
203             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
204             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
205             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
206             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
207             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
208         }
209     }
210 
211     @Test
<span class="line-added">212     @Disabled</span>
213     void branchMergeRebase(TestInfo testInfo) throws IOException {
214         try (var credentials = new HostCredentials(testInfo);
215              var tempFolder = new TemporaryDirectory()) {
216 
217             var author = credentials.getHostedRepository();
218             var integrator = credentials.getHostedRepository();
219             var censusBuilder = credentials.getCensusBuilder()
220                                            .addCommitter(author.forge().currentUser().id())
221                                            .addReviewer(integrator.forge().currentUser().id());
222             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
223 
224             // Populate the projects repository
225             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
226             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
227             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
228             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
229             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
230 
231             // Make more changes in another branch
232             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
</pre>
<hr />
<pre>
287             Set&lt;Hash&gt; commits;
288             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
289                 commits = tempCommits.stream()
290                         .map(Commit::hash)
291                         .collect(Collectors.toSet());
292             }
293             assertTrue(commits.contains(otherHash1));
294             assertTrue(commits.contains(otherHash2));
295             assertFalse(commits.contains(mergeHash));
296 
297             // Author and committer should updated in the merge commit
298             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
299             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
300             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
301             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
302             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
303         }
304     }
305 
306     @Test
<span class="line-added">307     @Disabled</span>
308     void branchMergeAdditionalCommits(TestInfo testInfo) throws IOException {
309         try (var credentials = new HostCredentials(testInfo);
310              var tempFolder = new TemporaryDirectory()) {
311 
312             var author = credentials.getHostedRepository();
313             var integrator = credentials.getHostedRepository();
314             var censusBuilder = credentials.getCensusBuilder()
315                                            .addCommitter(author.forge().currentUser().id())
316                                            .addReviewer(integrator.forge().currentUser().id());
317             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
318 
319             // Populate the projects repository
320             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
321             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
322             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
323             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
324             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
325 
326             // Make more changes in another branch
327             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
</pre>
<hr />
<pre>
451             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
452 
453             // Approve it as another user
454             var approvalPr = integrator.pullRequest(pr.id());
455             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
456 
457             // Let the bot check the status
458             TestBotRunner.runPeriodicItems(mergeBot);
459 
460             // Push it
461             pr.addComment(&quot;/integrate&quot;);
462             TestBotRunner.runPeriodicItems(mergeBot);
463 
464             // The bot should reply with a failure message
465             var error = pr.comments().stream()
466                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
467                           .count();
468             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
469 
470             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
<span class="line-modified">471             assertEquals(&quot;- It was not possible to create a commit for the changes in this PR: A merge PR is only allowed to contain a single merge commit. You will need to amend your commits.&quot;, check.summary().orElseThrow());</span>
472         }
473     }
474 
475     @Test
476     void invalidSourceRepo(TestInfo testInfo) throws IOException {
477         try (var credentials = new HostCredentials(testInfo);
478              var tempFolder = new TemporaryDirectory()) {
479 
480             var author = credentials.getHostedRepository();
481             var integrator = credentials.getHostedRepository();
482             var censusBuilder = credentials.getCensusBuilder()
483                                            .addCommitter(author.forge().currentUser().id())
484                                            .addReviewer(integrator.forge().currentUser().id());
485             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
486 
487             // Populate the projects repository
488             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
489             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
490             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
491             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/PullRequestInstance.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../vcs/src/main/java/org/openjdk/skara/vcs/git/GitRepository.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>