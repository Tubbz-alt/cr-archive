<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/test/java/org/openjdk/skara/bots/pr/MergeTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CheckTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../jcheck/src/test/java/org/openjdk/skara/jcheck/TestRepository.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/test/java/org/openjdk/skara/bots/pr/MergeTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
192             Set&lt;Hash&gt; commits;
193             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
194                 commits = tempCommits.stream()
195                                      .map(Commit::hash)
196                                      .collect(Collectors.toSet());
197             }
198             assertTrue(commits.contains(otherHash1));
199             assertTrue(commits.contains(otherHash2));
200             assertFalse(commits.contains(mergeHash));
201 
202             // Author and committer should updated in the merge commit
203             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
204             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
205             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
206             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
207             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
208         }
209     }
210 
211     @Test
<span class="line-removed">212     @Disabled</span>
213     void branchMergeRebase(TestInfo testInfo) throws IOException {
214         try (var credentials = new HostCredentials(testInfo);
215              var tempFolder = new TemporaryDirectory()) {
216 
217             var author = credentials.getHostedRepository();
218             var integrator = credentials.getHostedRepository();
219             var censusBuilder = credentials.getCensusBuilder()
220                                            .addCommitter(author.forge().currentUser().id())
221                                            .addReviewer(integrator.forge().currentUser().id());
222             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
223 
224             // Populate the projects repository
225             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
226             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
227             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
228             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
229             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
230 
231             // Make more changes in another branch
232             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
</pre>
<hr />
<pre>
287             Set&lt;Hash&gt; commits;
288             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
289                 commits = tempCommits.stream()
290                         .map(Commit::hash)
291                         .collect(Collectors.toSet());
292             }
293             assertTrue(commits.contains(otherHash1));
294             assertTrue(commits.contains(otherHash2));
295             assertFalse(commits.contains(mergeHash));
296 
297             // Author and committer should updated in the merge commit
298             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
299             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
300             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
301             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
302             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
303         }
304     }
305 
306     @Test
<span class="line-removed">307     @Disabled</span>
308     void branchMergeAdditionalCommits(TestInfo testInfo) throws IOException {
309         try (var credentials = new HostCredentials(testInfo);
310              var tempFolder = new TemporaryDirectory()) {
311 
312             var author = credentials.getHostedRepository();
313             var integrator = credentials.getHostedRepository();
314             var censusBuilder = credentials.getCensusBuilder()
315                                            .addCommitter(author.forge().currentUser().id())
316                                            .addReviewer(integrator.forge().currentUser().id());
317             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
318 
319             // Populate the projects repository
320             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
321             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
322             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
323             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
324             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
325 
326             // Make more changes in another branch
327             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
</pre>
<hr />
<pre>
394             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
395 
396             // The commits from the &quot;other&quot; branch should be preserved and not squashed (but not the merge commit)
397             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
398             String commits;
399             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
400                 commits = tempCommits.stream()
401                                      .map(c -&gt; c.hash().hex() + &quot;:&quot; + c.message().get(0))
402                                      .collect(Collectors.joining(&quot;,&quot;));
403             }
404             assertTrue(commits.contains(otherHash1.hex() + &quot;:First other&quot;));
405             assertTrue(commits.contains(otherHash2.hex() + &quot;:Second other&quot;));
406             assertFalse(commits.contains(&quot;Our own merge commit&quot;));
407 
408             // Author and committer should updated in the merge commit
409             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
410             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
411             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
412             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
413             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());




414         }
415     }
416 
417     @Test
418     void invalidMergeCommit(TestInfo testInfo) throws IOException {
419         try (var credentials = new HostCredentials(testInfo);
420              var tempFolder = new TemporaryDirectory()) {
421 
422             var author = credentials.getHostedRepository();
423             var integrator = credentials.getHostedRepository();
424             var censusBuilder = credentials.getCensusBuilder()
425                                            .addCommitter(author.forge().currentUser().id())
426                                            .addReviewer(integrator.forge().currentUser().id());
427             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
428 
429             // Populate the projects repository
430             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
431             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
432             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
433             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
</pre>
<hr />
<pre>
451             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
452 
453             // Approve it as another user
454             var approvalPr = integrator.pullRequest(pr.id());
455             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
456 
457             // Let the bot check the status
458             TestBotRunner.runPeriodicItems(mergeBot);
459 
460             // Push it
461             pr.addComment(&quot;/integrate&quot;);
462             TestBotRunner.runPeriodicItems(mergeBot);
463 
464             // The bot should reply with a failure message
465             var error = pr.comments().stream()
466                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
467                           .count();
468             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
469 
470             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
<span class="line-modified">471             assertEquals(&quot;- It was not possible to create a commit for the changes in this PR: A merge PR is only allowed to contain a single merge commit. You will need to amend your commits.&quot;, check.summary().orElseThrow());</span>
472         }
473     }
474 
475     @Test
476     void invalidSourceRepo(TestInfo testInfo) throws IOException {
477         try (var credentials = new HostCredentials(testInfo);
478              var tempFolder = new TemporaryDirectory()) {
479 
480             var author = credentials.getHostedRepository();
481             var integrator = credentials.getHostedRepository();
482             var censusBuilder = credentials.getCensusBuilder()
483                                            .addCommitter(author.forge().currentUser().id())
484                                            .addReviewer(integrator.forge().currentUser().id());
485             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
486 
487             // Populate the projects repository
488             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
489             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
490             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
491             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
</pre>
<hr />
<pre>
697             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other2&quot;);
698 
699             // Approve it as another user
700             var approvalPr = integrator.pullRequest(pr.id());
701             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
702 
703             // Let the bot check the status
704             TestBotRunner.runPeriodicItems(mergeBot);
705 
706             // Push it
707             pr.addComment(&quot;/integrate&quot;);
708             TestBotRunner.runPeriodicItems(mergeBot);
709 
710             // The bot should reply with a failure message
711             var error = pr.comments().stream()
712                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
713                           .count();
714             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
715 
716             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
<span class="line-modified">717             assertEquals(&quot;- The merge contains commits that are neither ancestors of the source nor the target.&quot;, check.summary().orElseThrow());</span>
718         }
719     }
720 
721     @Test
722     void invalidAuthor(TestInfo testInfo) throws IOException {
723         try (var credentials = new HostCredentials(testInfo);
724              var tempFolder = new TemporaryDirectory()) {
725 
726             var author = credentials.getHostedRepository();
727             var integrator = credentials.getHostedRepository();
728             var censusBuilder = credentials.getCensusBuilder()
729                                            .addAuthor(author.forge().currentUser().id())
730                                            .addReviewer(integrator.forge().currentUser().id());
731             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
732 
733             // Populate the projects repository
734             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
735             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
736             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
737             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
</pre>
<hr />
<pre>
829             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
830 
831             // Approve it as another user
832             var approvalPr = integrator.pullRequest(pr.id());
833             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
834 
835             // Let the bot check the status
836             TestBotRunner.runPeriodicItems(mergeBot);
837 
838             // Push it
839             pr.addComment(&quot;/integrate&quot;);
840             TestBotRunner.runPeriodicItems(mergeBot);
841 
842             // The bot should reply with a failure message
843             var error = pr.comments().stream()
844                     .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
845                     .count();
846             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
847 
848             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
<span class="line-modified">849             assertEquals(&quot;- The merge contains commits that are neither ancestors of the source nor the target.&quot;, check.summary().orElseThrow());</span>
850         }
851     }
852 
853     @Test
854     void invalidSyntax(TestInfo testInfo) throws IOException {
855         try (var credentials = new HostCredentials(testInfo);
856              var tempFolder = new TemporaryDirectory()) {
857 
858             var author = credentials.getHostedRepository();
859             var integrator = credentials.getHostedRepository();
860             var censusBuilder = credentials.getCensusBuilder()
861                                            .addCommitter(author.forge().currentUser().id())
862                                            .addReviewer(integrator.forge().currentUser().id());
863             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
864 
865             // Populate the projects repository
866             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
867             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(&quot;merge&quot;), &quot;1.0&quot;);
868             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
869             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
</pre>
<hr />
<pre>
885 
886             localRepo.merge(otherHash);
887             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
888             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
889             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge this or that&quot;);
890 
891             // Let the bot check the status
892             TestBotRunner.runPeriodicItems(mergeBot);
893 
894             // Push it
895             pr.addComment(&quot;/integrate&quot;);
896             TestBotRunner.runPeriodicItems(mergeBot);
897 
898             // The bot should reply with a failure message
899             var error = pr.comments().stream()
900                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
901                           .count();
902             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
903 
904             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
<span class="line-modified">905             assertEquals(&quot;- Could not determine the source for this merge. A Merge PR title must be specified on the format: Merge `project`:`branch` to allow verification of the merge contents.\n&quot; +</span>
<span class="line-removed">906                                  &quot;- Merge commit message is not Merge, but: Merge this or that&quot;, check.summary().orElseThrow());</span>
907         }
908     }
909 }
</pre>
</td>
<td>
<hr />
<pre>
192             Set&lt;Hash&gt; commits;
193             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
194                 commits = tempCommits.stream()
195                                      .map(Commit::hash)
196                                      .collect(Collectors.toSet());
197             }
198             assertTrue(commits.contains(otherHash1));
199             assertTrue(commits.contains(otherHash2));
200             assertFalse(commits.contains(mergeHash));
201 
202             // Author and committer should updated in the merge commit
203             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
204             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
205             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
206             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
207             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
208         }
209     }
210 
211     @Test

212     void branchMergeRebase(TestInfo testInfo) throws IOException {
213         try (var credentials = new HostCredentials(testInfo);
214              var tempFolder = new TemporaryDirectory()) {
215 
216             var author = credentials.getHostedRepository();
217             var integrator = credentials.getHostedRepository();
218             var censusBuilder = credentials.getCensusBuilder()
219                                            .addCommitter(author.forge().currentUser().id())
220                                            .addReviewer(integrator.forge().currentUser().id());
221             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
222 
223             // Populate the projects repository
224             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
225             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
226             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
227             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
228             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
229 
230             // Make more changes in another branch
231             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
</pre>
<hr />
<pre>
286             Set&lt;Hash&gt; commits;
287             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
288                 commits = tempCommits.stream()
289                         .map(Commit::hash)
290                         .collect(Collectors.toSet());
291             }
292             assertTrue(commits.contains(otherHash1));
293             assertTrue(commits.contains(otherHash2));
294             assertFalse(commits.contains(mergeHash));
295 
296             // Author and committer should updated in the merge commit
297             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
298             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
299             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
300             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
301             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
302         }
303     }
304 
305     @Test

306     void branchMergeAdditionalCommits(TestInfo testInfo) throws IOException {
307         try (var credentials = new HostCredentials(testInfo);
308              var tempFolder = new TemporaryDirectory()) {
309 
310             var author = credentials.getHostedRepository();
311             var integrator = credentials.getHostedRepository();
312             var censusBuilder = credentials.getCensusBuilder()
313                                            .addCommitter(author.forge().currentUser().id())
314                                            .addReviewer(integrator.forge().currentUser().id());
315             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
316 
317             // Populate the projects repository
318             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
319             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
320             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
321             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
322             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
323 
324             // Make more changes in another branch
325             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
</pre>
<hr />
<pre>
392             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
393 
394             // The commits from the &quot;other&quot; branch should be preserved and not squashed (but not the merge commit)
395             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
396             String commits;
397             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
398                 commits = tempCommits.stream()
399                                      .map(c -&gt; c.hash().hex() + &quot;:&quot; + c.message().get(0))
400                                      .collect(Collectors.joining(&quot;,&quot;));
401             }
402             assertTrue(commits.contains(otherHash1.hex() + &quot;:First other&quot;));
403             assertTrue(commits.contains(otherHash2.hex() + &quot;:Second other&quot;));
404             assertFalse(commits.contains(&quot;Our own merge commit&quot;));
405 
406             // Author and committer should updated in the merge commit
407             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
408             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
409             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
410             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
411             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
<span class="line-added">412 </span>
<span class="line-added">413             // The latest content from the source and the updated master should be present</span>
<span class="line-added">414             assertEquals(&quot;New on master&quot;, Files.readString(pushedRepoFolder.resolve(&quot;newmaster.txt&quot;)));</span>
<span class="line-added">415             assertEquals(&quot;Unrelated&quot;, Files.readString(pushedRepoFolder.resolve(&quot;unrelated.txt&quot;)));</span>
416         }
417     }
418 
419     @Test
420     void invalidMergeCommit(TestInfo testInfo) throws IOException {
421         try (var credentials = new HostCredentials(testInfo);
422              var tempFolder = new TemporaryDirectory()) {
423 
424             var author = credentials.getHostedRepository();
425             var integrator = credentials.getHostedRepository();
426             var censusBuilder = credentials.getCensusBuilder()
427                                            .addCommitter(author.forge().currentUser().id())
428                                            .addReviewer(integrator.forge().currentUser().id());
429             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
430 
431             // Populate the projects repository
432             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
433             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
434             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
435             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
</pre>
<hr />
<pre>
453             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
454 
455             // Approve it as another user
456             var approvalPr = integrator.pullRequest(pr.id());
457             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
458 
459             // Let the bot check the status
460             TestBotRunner.runPeriodicItems(mergeBot);
461 
462             // Push it
463             pr.addComment(&quot;/integrate&quot;);
464             TestBotRunner.runPeriodicItems(mergeBot);
465 
466             // The bot should reply with a failure message
467             var error = pr.comments().stream()
468                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
469                           .count();
470             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
471 
472             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
<span class="line-modified">473             assertEquals(&quot;- The merge commit must have a commit on the target branch as one of its parents.&quot;, check.summary().orElseThrow());</span>
474         }
475     }
476 
477     @Test
478     void invalidSourceRepo(TestInfo testInfo) throws IOException {
479         try (var credentials = new HostCredentials(testInfo);
480              var tempFolder = new TemporaryDirectory()) {
481 
482             var author = credentials.getHostedRepository();
483             var integrator = credentials.getHostedRepository();
484             var censusBuilder = credentials.getCensusBuilder()
485                                            .addCommitter(author.forge().currentUser().id())
486                                            .addReviewer(integrator.forge().currentUser().id());
487             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
488 
489             // Populate the projects repository
490             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
491             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
492             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
493             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
</pre>
<hr />
<pre>
699             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other2&quot;);
700 
701             // Approve it as another user
702             var approvalPr = integrator.pullRequest(pr.id());
703             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
704 
705             // Let the bot check the status
706             TestBotRunner.runPeriodicItems(mergeBot);
707 
708             // Push it
709             pr.addComment(&quot;/integrate&quot;);
710             TestBotRunner.runPeriodicItems(mergeBot);
711 
712             // The bot should reply with a failure message
713             var error = pr.comments().stream()
714                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
715                           .count();
716             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
717 
718             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
<span class="line-modified">719             assertEquals(&quot;- A merge PR must contain a merge commit as well as at least one other commit from the merge source.&quot;, check.summary().orElseThrow());</span>
720         }
721     }
722 
723     @Test
724     void invalidAuthor(TestInfo testInfo) throws IOException {
725         try (var credentials = new HostCredentials(testInfo);
726              var tempFolder = new TemporaryDirectory()) {
727 
728             var author = credentials.getHostedRepository();
729             var integrator = credentials.getHostedRepository();
730             var censusBuilder = credentials.getCensusBuilder()
731                                            .addAuthor(author.forge().currentUser().id())
732                                            .addReviewer(integrator.forge().currentUser().id());
733             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
734 
735             // Populate the projects repository
736             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
737             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
738             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
739             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
</pre>
<hr />
<pre>
831             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
832 
833             // Approve it as another user
834             var approvalPr = integrator.pullRequest(pr.id());
835             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
836 
837             // Let the bot check the status
838             TestBotRunner.runPeriodicItems(mergeBot);
839 
840             // Push it
841             pr.addComment(&quot;/integrate&quot;);
842             TestBotRunner.runPeriodicItems(mergeBot);
843 
844             // The bot should reply with a failure message
845             var error = pr.comments().stream()
846                     .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
847                     .count();
848             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
849 
850             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
<span class="line-modified">851             assertEquals(&quot;- The merge commit must have a commit on the target branch as one of its parents.&quot;, check.summary().orElseThrow());</span>
852         }
853     }
854 
855     @Test
856     void invalidSyntax(TestInfo testInfo) throws IOException {
857         try (var credentials = new HostCredentials(testInfo);
858              var tempFolder = new TemporaryDirectory()) {
859 
860             var author = credentials.getHostedRepository();
861             var integrator = credentials.getHostedRepository();
862             var censusBuilder = credentials.getCensusBuilder()
863                                            .addCommitter(author.forge().currentUser().id())
864                                            .addReviewer(integrator.forge().currentUser().id());
865             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
866 
867             // Populate the projects repository
868             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
869             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(&quot;merge&quot;), &quot;1.0&quot;);
870             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
871             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
</pre>
<hr />
<pre>
887 
888             localRepo.merge(otherHash);
889             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
890             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
891             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge this or that&quot;);
892 
893             // Let the bot check the status
894             TestBotRunner.runPeriodicItems(mergeBot);
895 
896             // Push it
897             pr.addComment(&quot;/integrate&quot;);
898             TestBotRunner.runPeriodicItems(mergeBot);
899 
900             // The bot should reply with a failure message
901             var error = pr.comments().stream()
902                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
903                           .count();
904             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
905 
906             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);
<span class="line-modified">907             assertEquals(&quot;- Could not determine the source for this merge. A Merge PR title must be specified on the format: Merge `project`:`branch` to allow verification of the merge contents.&quot;, check.summary().orElseThrow());</span>

908         }
909     }
910 }
</pre>
</td>
</tr>
</table>
<center><a href="CheckTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../jcheck/src/test/java/org/openjdk/skara/jcheck/TestRepository.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>