<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/main/java/org/openjdk/skara/vcs/git/GitRepository.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../Repository.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../hg/HgRepository.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>vcs/src/main/java/org/openjdk/skara/vcs/git/GitRepository.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 651         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--message=&quot; + message)
 652                          .workdir(dir)
 653                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 654                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 655                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 656                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
 657         if (authorDate != null) {
 658             cmd = cmd.environ(&quot;GIT_AUTHOR_DATE&quot;,
 659                               authorDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
 660         }
 661         if (committerDate != null) {
 662             cmd = cmd.environ(&quot;GIT_COMMITTER_DATE&quot;,
 663                               committerDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
 664         }
 665         try (var p = cmd.execute()) {
 666             await(p);
 667             return head();
 668         }
 669     }
 670 










































 671     @Override
 672     public Hash amend(String message, String authorName, String authorEmail) throws IOException {
 673         return amend(message, authorName, authorEmail, null, null);
 674     }
 675 
 676     @Override
 677     public Hash amend(String message, String authorName, String authorEmail, String committerName, String committerEmail) throws IOException {
 678         if (committerName == null) {
 679             committerName = authorName;
 680             committerEmail = authorEmail;
 681         }
 682         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--amend&quot;, &quot;--reset-author&quot;, &quot;--message=&quot; + message)
 683                          .workdir(dir)
 684                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 685                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 686                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 687                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
 688         try (var p = cmd.execute()) {
 689             await(p);
 690             return head();
</pre>
<hr />
<pre>
1296             for (var line : await(p).stdout()) {
1297                 var parts = line.substring(1).split(&quot; &quot;);
1298                 var hash = parts[0];
1299                 var path = parts[1];
1300                 hashes.put(path, hash);
1301             }
1302         }
1303 
1304         var modules = new ArrayList&lt;Submodule&gt;();
1305         for (var name : paths.keySet()) {
1306             var url = urls.get(name);
1307             var path = paths.get(name);
1308             var hash = hashes.get(path);
1309 
1310             modules.add(new Submodule(new Hash(hash), Path.of(path), url));
1311         }
1312 
1313         return modules;
1314     }
1315 






















1316     @Override
1317     public Optional&lt;Tag.Annotated&gt; annotate(Tag tag) throws IOException {
1318         var ref = &quot;refs/tags/&quot; + tag.name();
1319         var format = &quot;%(refname:short)%0a%(*objectname)%0a%(taggername) %(taggeremail)%0a%(taggerdate:iso-strict)%0a%(contents)&quot;;
1320         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format&quot;, format, ref)) {
1321             var lines = await(p).stdout();
1322             if (lines.size() &gt;= 4) {
1323                 var name = lines.get(0);
1324                 var target = new Hash(lines.get(1));
1325                 var author = Author.fromString(lines.get(2));
1326 
1327                 var formatter = DateTimeFormatter.ISO_OFFSET_DATE_TIME;
1328                 var date = ZonedDateTime.parse(lines.get(3), formatter);
1329                 var message = String.join(&quot;\n&quot;, lines.subList(4, lines.size()));
1330 
1331                 return Optional.of(new Tag.Annotated(name, target, author, date, message));
1332             }
1333             return Optional.empty();
1334         }
1335     }
</pre>
</td>
<td>
<hr />
<pre>
 651         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--message=&quot; + message)
 652                          .workdir(dir)
 653                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 654                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 655                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 656                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
 657         if (authorDate != null) {
 658             cmd = cmd.environ(&quot;GIT_AUTHOR_DATE&quot;,
 659                               authorDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
 660         }
 661         if (committerDate != null) {
 662             cmd = cmd.environ(&quot;GIT_COMMITTER_DATE&quot;,
 663                               committerDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
 664         }
 665         try (var p = cmd.execute()) {
 666             await(p);
 667             return head();
 668         }
 669     }
 670 
<span class="line-added"> 671     @Override</span>
<span class="line-added"> 672     public Hash commit(String message, String authorName, String authorEmail, ZonedDateTime authorDate, String committerName, String committerEmail, ZonedDateTime committerDate, List&lt;Hash&gt; parents, Tree tree) throws IOException {</span>
<span class="line-added"> 673         // Ensure we don&#39;t create identical commits</span>
<span class="line-added"> 674         if (parents.size() == 1) {</span>
<span class="line-added"> 675             var parentTree = tree(parents.get(0));</span>
<span class="line-added"> 676             if (parentTree.equals(tree)) {</span>
<span class="line-added"> 677                 return parents.get(0);</span>
<span class="line-added"> 678             }</span>
<span class="line-added"> 679         }</span>
<span class="line-added"> 680 </span>
<span class="line-added"> 681         var cmdLine = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;commit-tree&quot;, tree.hash().hex(), &quot;-m&quot;, message));</span>
<span class="line-added"> 682         for (var parent : parents) {</span>
<span class="line-added"> 683             cmdLine.add(&quot;-p&quot;);</span>
<span class="line-added"> 684             cmdLine.add(parent.hex());</span>
<span class="line-added"> 685         }</span>
<span class="line-added"> 686         var cmd = Process.capture(cmdLine.toArray(new String[0]))</span>
<span class="line-added"> 687                 .workdir(dir)</span>
<span class="line-added"> 688                 .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)</span>
<span class="line-added"> 689                 .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)</span>
<span class="line-added"> 690                 .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)</span>
<span class="line-added"> 691                 .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);</span>
<span class="line-added"> 692         if (authorDate != null) {</span>
<span class="line-added"> 693             cmd = cmd.environ(&quot;GIT_AUTHOR_DATE&quot;,</span>
<span class="line-added"> 694                     authorDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));</span>
<span class="line-added"> 695         }</span>
<span class="line-added"> 696         if (committerDate != null) {</span>
<span class="line-added"> 697             cmd = cmd.environ(&quot;GIT_COMMITTER_DATE&quot;,</span>
<span class="line-added"> 698                     committerDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));</span>
<span class="line-added"> 699         }</span>
<span class="line-added"> 700         try (var p = cmd.execute()) {</span>
<span class="line-added"> 701             var res = await(p);</span>
<span class="line-added"> 702             if (res.stdout().size() != 1) {</span>
<span class="line-added"> 703                 throw new IOException(&quot;Unexpected output: &quot; + res.stdout());</span>
<span class="line-added"> 704             }</span>
<span class="line-added"> 705             var commitHash = res.stdout().get(0).trim();</span>
<span class="line-added"> 706             if (commitHash.length() != 40) {</span>
<span class="line-added"> 707                 throw new IOException(&quot;Unexpected output: &quot; + commitHash);</span>
<span class="line-added"> 708             }</span>
<span class="line-added"> 709             return new Hash(commitHash);</span>
<span class="line-added"> 710         }</span>
<span class="line-added"> 711     }</span>
<span class="line-added"> 712 </span>
 713     @Override
 714     public Hash amend(String message, String authorName, String authorEmail) throws IOException {
 715         return amend(message, authorName, authorEmail, null, null);
 716     }
 717 
 718     @Override
 719     public Hash amend(String message, String authorName, String authorEmail, String committerName, String committerEmail) throws IOException {
 720         if (committerName == null) {
 721             committerName = authorName;
 722             committerEmail = authorEmail;
 723         }
 724         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--amend&quot;, &quot;--reset-author&quot;, &quot;--message=&quot; + message)
 725                          .workdir(dir)
 726                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 727                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 728                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 729                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
 730         try (var p = cmd.execute()) {
 731             await(p);
 732             return head();
</pre>
<hr />
<pre>
1338             for (var line : await(p).stdout()) {
1339                 var parts = line.substring(1).split(&quot; &quot;);
1340                 var hash = parts[0];
1341                 var path = parts[1];
1342                 hashes.put(path, hash);
1343             }
1344         }
1345 
1346         var modules = new ArrayList&lt;Submodule&gt;();
1347         for (var name : paths.keySet()) {
1348             var url = urls.get(name);
1349             var path = paths.get(name);
1350             var hash = hashes.get(path);
1351 
1352             modules.add(new Submodule(new Hash(hash), Path.of(path), url));
1353         }
1354 
1355         return modules;
1356     }
1357 
<span class="line-added">1358     @Override</span>
<span class="line-added">1359     public Tree tree(Hash h) throws IOException {</span>
<span class="line-added">1360         String treeHash;</span>
<span class="line-added">1361         try (var p = capture(&quot;git&quot;, &quot;cat-file&quot;, &quot;-p&quot;, h.hex())) {</span>
<span class="line-added">1362             var res = p.await();</span>
<span class="line-added">1363             if (res.stdout().size() &gt; 0) {</span>
<span class="line-added">1364                 var line = res.stdout().get(0);</span>
<span class="line-added">1365                 if (line.startsWith(&quot;tree &quot;)) {</span>
<span class="line-added">1366                     treeHash = line.substring(5).trim();</span>
<span class="line-added">1367                     if (treeHash.length() != 40) {</span>
<span class="line-added">1368                         throw new IOException(&quot;Unexpected output: &quot; + treeHash);</span>
<span class="line-added">1369                     }</span>
<span class="line-added">1370                 } else {</span>
<span class="line-added">1371                     throw new IOException(&quot;Unexpected output: &quot; + line);</span>
<span class="line-added">1372                 }</span>
<span class="line-added">1373             } else {</span>
<span class="line-added">1374                 throw new IOException(&quot;Unexpected output: &quot; + res.stderr());</span>
<span class="line-added">1375             }</span>
<span class="line-added">1376         }</span>
<span class="line-added">1377         return new Tree(new Hash(treeHash));</span>
<span class="line-added">1378     }</span>
<span class="line-added">1379 </span>
1380     @Override
1381     public Optional&lt;Tag.Annotated&gt; annotate(Tag tag) throws IOException {
1382         var ref = &quot;refs/tags/&quot; + tag.name();
1383         var format = &quot;%(refname:short)%0a%(*objectname)%0a%(taggername) %(taggeremail)%0a%(taggerdate:iso-strict)%0a%(contents)&quot;;
1384         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format&quot;, format, ref)) {
1385             var lines = await(p).stdout();
1386             if (lines.size() &gt;= 4) {
1387                 var name = lines.get(0);
1388                 var target = new Hash(lines.get(1));
1389                 var author = Author.fromString(lines.get(2));
1390 
1391                 var formatter = DateTimeFormatter.ISO_OFFSET_DATE_TIME;
1392                 var date = ZonedDateTime.parse(lines.get(3), formatter);
1393                 var message = String.join(&quot;\n&quot;, lines.subList(4, lines.size()));
1394 
1395                 return Optional.of(new Tag.Annotated(name, target, author, date, message));
1396             }
1397             return Optional.empty();
1398         }
1399     }
</pre>
</td>
</tr>
</table>
<center><a href="../Repository.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../hg/HgRepository.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>