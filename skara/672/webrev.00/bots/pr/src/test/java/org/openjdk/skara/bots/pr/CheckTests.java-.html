<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.pr;
  24 
  25 import org.junit.jupiter.api.*;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.json.JSON;
  28 import org.openjdk.skara.test.*;
  29 
  30 import java.io.IOException;
  31 import java.nio.charset.StandardCharsets;
  32 import java.nio.file.*;
  33 import java.nio.file.attribute.PosixFilePermission;
  34 import java.util.*;
  35 import java.util.regex.Pattern;
  36 
  37 import static org.junit.jupiter.api.Assertions.*;
  38 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  39 
  40 class CheckTests {
  41     @Test
  42     void simpleCommit(TestInfo testInfo) throws IOException {
  43         try (var credentials = new HostCredentials(testInfo);
  44              var tempFolder = new TemporaryDirectory()) {
  45             var author = credentials.getHostedRepository();
  46             var reviewer = credentials.getHostedRepository();
  47 
  48             var censusBuilder = credentials.getCensusBuilder()
  49                                            .addAuthor(author.forge().currentUser().id())
  50                                            .addReviewer(reviewer.forge().currentUser().id());
  51             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
  52 
  53             // Populate the projects repository
  54             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
  55             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
  56             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
  57 
  58             // Make a change with a corresponding PR
  59             var editHash = CheckableRepository.appendAndCommit(localRepo);
  60             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
  61             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
  62 
  63             // Check the status
  64             TestBotRunner.runPeriodicItems(checkBot);
  65 
  66             // Verify that the check succeeded
  67             var checks = pr.checks(editHash);
  68             assertEquals(1, checks.size());
  69             var check = checks.get(&quot;jcheck&quot;);
  70             assertEquals(CheckStatus.SUCCESS, check.status());
  71 
  72             // The PR should now be ready for review
  73             assertTrue(pr.labels().contains(&quot;rfr&quot;));
  74             assertFalse(pr.labels().contains(&quot;ready&quot;));
  75 
  76             // Approve it as another user
  77             var approvalPr = reviewer.pullRequest(pr.id());
  78             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
  79 
  80             // Check the status again
  81             TestBotRunner.runPeriodicItems(checkBot);
  82 
  83             // The check should now be successful
  84             checks = pr.checks(editHash);
  85             assertEquals(1, checks.size());
  86             check = checks.get(&quot;jcheck&quot;);
  87             assertEquals(CheckStatus.SUCCESS, check.status());
  88 
  89             // The PR should now be ready
  90             assertTrue(pr.labels().contains(&quot;ready&quot;));
  91         }
  92     }
  93 
  94     @Test
  95     void whitespaceIssue(TestInfo testInfo) throws IOException {
  96         try (var credentials = new HostCredentials(testInfo);
  97              var tempFolder = new TemporaryDirectory()) {
  98 
  99             var author = credentials.getHostedRepository();
 100             var reviewer = credentials.getHostedRepository();
 101 
 102             var censusBuilder = credentials.getCensusBuilder()
 103                                            .addAuthor(author.forge().currentUser().id())
 104                                            .addReviewer(reviewer.forge().currentUser().id());
 105             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 106 
 107             // Populate the projects repository
 108             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 109             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 110             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 111 
 112             // Make a change with a corresponding PR
 113             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line with a trailing whitespace   &quot;);
 114             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 115             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 116 
 117             // Check the status
 118             TestBotRunner.runPeriodicItems(checkBot);
 119 
 120             // The PR should not be flagged as ready for review
 121             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 122 
 123             // Approve it as another user
 124             var approvalPr = reviewer.pullRequest(pr.id());
 125             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 126 
 127             // Check the status
 128             TestBotRunner.runPeriodicItems(checkBot);
 129 
 130             // Verify that the check failed
 131             var checks = pr.checks(editHash);
 132             assertEquals(1, checks.size());
 133             var check = checks.get(&quot;jcheck&quot;);
 134             assertEquals(CheckStatus.FAILURE, check.status());
 135 
 136             // The PR should not still not be flagged as ready for review
 137             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 138 
 139             // Remove the trailing whitespace in a new commit
 140             editHash = CheckableRepository.replaceAndCommit(localRepo, &quot;A line without a trailing whitespace&quot;);
 141             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 142 
 143             // Make sure that the push registered
 144             var lastHeadHash = pr.headHash();
 145             var refreshCount = 0;
 146             do {
 147                 pr = author.pullRequest(pr.id());
 148                 if (refreshCount++ &gt; 100) {
 149                     fail(&quot;The PR did not update after the new push&quot;);
 150                 }
 151             } while (pr.headHash().equals(lastHeadHash));
 152 
 153             // Check the status again
 154             TestBotRunner.runPeriodicItems(checkBot);
 155 
 156             // The PR should now be ready
 157             assertTrue(pr.labels().contains(&quot;ready&quot;));
 158 
 159             // The check should now be successful
 160             checks = pr.checks(editHash);
 161             assertEquals(1, checks.size());
 162             check = checks.get(&quot;jcheck&quot;);
 163             assertEquals(CheckStatus.SUCCESS, check.status());
 164         }
 165     }
 166 
 167     @Test
 168     void multipleReviews(TestInfo testInfo) throws IOException {
 169         try (var credentials = new HostCredentials(testInfo);
 170              var tempFolder = new TemporaryDirectory()) {
 171 
 172             var author = credentials.getHostedRepository();
 173             var reviewer = credentials.getHostedRepository();
 174             var commenter = credentials.getHostedRepository();
 175 
 176             var censusBuilder = credentials.getCensusBuilder()
 177                                            .addAuthor(author.forge().currentUser().id())
 178                                            .addReviewer(reviewer.forge().currentUser().id())
 179                                            .addReviewer(commenter.forge().currentUser().id());
 180 
 181             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 182 
 183             // Populate the projects repository
 184             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 185             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 186             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 187 
 188             // Make a change with a corresponding PR
 189             var editHash = CheckableRepository.appendAndCommit(localRepo);
 190             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 191             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 192 
 193             // Let the status bot inspect the PR
 194             TestBotRunner.runPeriodicItems(checkBot);
 195             assertFalse(authorPr.body().contains(&quot;Reviewers&quot;));
 196 
 197             // Approve it
 198             var reviewerPr = reviewer.pullRequest(authorPr.id());
 199             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Reviewers&quot;);
 200             TestBotRunner.runPeriodicItems(checkBot);
 201 
 202             // Refresh the PR and check that it has been approved
 203             authorPr = author.pullRequest(authorPr.id());
 204             assertTrue(authorPr.body().contains(&quot;Reviewers&quot;));
 205 
 206             // Update the file after approval
 207             editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Now I&#39;ve gone and changed it&quot;);
 208             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 209 
 210             // Make sure that the push registered
 211             var lastHeadHash = authorPr.headHash();
 212             var refreshCount = 0;
 213             do {
 214                 authorPr = author.pullRequest(authorPr.id());
 215                 if (refreshCount++ &gt; 100) {
 216                     fail(&quot;The PR did not update after the new push&quot;);
 217                 }
 218             } while (authorPr.headHash().equals(lastHeadHash));
 219 
 220             // Check that the review is flagged as stale
 221             TestBotRunner.runPeriodicItems(checkBot);
 222             authorPr = author.pullRequest(authorPr.id());
 223             assertTrue(authorPr.body().contains(&quot;Review applies to&quot;));
 224 
 225             // Now we can approve it again
 226             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 227             TestBotRunner.runPeriodicItems(checkBot);
 228 
 229             // Refresh the PR and check that it has been approved (once) and is no longer stale
 230             authorPr = author.pullRequest(authorPr.id());
 231             assertTrue(authorPr.body().contains(&quot;Reviewers&quot;));
 232             assertEquals(1, authorPr.body().split(&quot;Generated Reviewer&quot;, -1).length - 1);
 233             assertTrue(authorPr.reviews().size() &gt;= 1);
 234             assertFalse(authorPr.body().contains(&quot;Note&quot;));
 235 
 236             // Add a review with disapproval
 237             var commenterPr = commenter.pullRequest(authorPr.id());
 238             commenterPr.addReview(Review.Verdict.DISAPPROVED, &quot;Disapproved&quot;);
 239             TestBotRunner.runPeriodicItems(checkBot);
 240 
 241             // Refresh the PR and check that it still only approved once (but two reviews) and is no longer stale
 242             authorPr = author.pullRequest(authorPr.id());
 243             assertTrue(authorPr.body().contains(&quot;Reviewers&quot;));
 244             assertEquals(1, authorPr.body().split(&quot;Generated Reviewer&quot;, -1).length - 1);
 245             assertTrue(authorPr.reviews().size() &gt;= 2);
 246             assertFalse(authorPr.body().contains(&quot;Note&quot;));
 247         }
 248     }
 249 
 250     @Test
 251     void selfReview(TestInfo testInfo) throws IOException {
 252         try (var credentials = new HostCredentials(testInfo);
 253              var tempFolder = new TemporaryDirectory()) {
 254 
 255             var author = credentials.getHostedRepository();
 256 
 257             var censusBuilder = credentials.getCensusBuilder()
 258                                            .addReviewer(author.forge().currentUser().id());
 259 
 260             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 261 
 262             // Populate the projects repository
 263             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 264             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 265             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 266 
 267             // Make a change with a corresponding PR
 268             var editHash = CheckableRepository.appendAndCommit(localRepo);
 269             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 270             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 271 
 272             // Let the status bot inspect the PR
 273             TestBotRunner.runPeriodicItems(checkBot);
 274             assertFalse(authorPr.body().contains(&quot;Reviewers&quot;));
 275 
 276             // Approve it
 277             authorPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 278             TestBotRunner.runPeriodicItems(checkBot);
 279 
 280             // Refresh the PR and check that it has been approved
 281             authorPr = author.pullRequest(authorPr.id());
 282             assertTrue(authorPr.body().contains(&quot;Reviewers&quot;));
 283 
 284             // Verify that the check failed
 285             var checks = authorPr.checks(editHash);
 286             assertEquals(1, checks.size());
 287             var check = checks.get(&quot;jcheck&quot;);
 288             assertEquals(CheckStatus.FAILURE, check.status());
 289         }
 290     }
 291 
 292     @Test
 293     void multipleCommitters(TestInfo testInfo) throws IOException {
 294         try (var credentials = new HostCredentials(testInfo);
 295              var tempFolder = new TemporaryDirectory()) {
 296             var author = credentials.getHostedRepository();
 297             var reviewer = credentials.getHostedRepository();
 298 
 299             var censusBuilder = credentials.getCensusBuilder()
 300                                            .addReviewer(reviewer.forge().currentUser().id());
 301             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 302 
 303             // Populate the projects repository
 304             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 305             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 306             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 307 
 308             // Make two changes with different authors
 309             CheckableRepository.appendAndCommit(localRepo, &quot;First edit&quot;, &quot;Edit by number 1&quot;,
 310                                                 &quot;number1&quot;, &quot;number1@none.none&quot;);
 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Second edit&quot;, &quot;Edit by number 2&quot;,
 312                                                                &quot;number2&quot;, &quot;number2@none.none&quot;);
 313             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 314             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 315 
 316             // Check the status
 317             TestBotRunner.runPeriodicItems(checkBot);
 318 
 319             // Verify that the check failed
 320             var checks = pr.checks(editHash);
 321             assertEquals(1, checks.size());
 322             var check = checks.get(&quot;jcheck&quot;);
 323             assertEquals(CheckStatus.FAILURE, check.status());
 324 
 325             // Approve it as another user
 326             var approvalPr = reviewer.pullRequest(pr.id());
 327             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 328 
 329             // Check the status again
 330             TestBotRunner.runPeriodicItems(checkBot);
 331 
 332             // The check should still be failing
 333             checks = pr.checks(editHash);
 334             assertEquals(1, checks.size());
 335             check = checks.get(&quot;jcheck&quot;);
 336             assertEquals(CheckStatus.FAILURE, check.status());
 337 
 338             // The PR should not be flagged as ready for review, as multiple committers is a problem
 339             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 340         }
 341     }
 342 
 343     @Test
 344     void updatedContentFailsCheck(TestInfo testInfo) throws IOException {
 345         try (var credentials = new HostCredentials(testInfo);
 346              var tempFolder = new TemporaryDirectory()) {
 347             var author = credentials.getHostedRepository();
 348             var reviewer = credentials.getHostedRepository();
 349 
 350             var censusBuilder = credentials.getCensusBuilder()
 351                                            .addAuthor(author.forge().currentUser().id())
 352                                            .addReviewer(reviewer.forge().currentUser().id());
 353             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 354 
 355             // Populate the projects repository
 356             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 357             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 358             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 359 
 360             // Make a change with a corresponding PR
 361             var editHash = CheckableRepository.appendAndCommit(localRepo);
 362             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 363             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 364 
 365             // Check the status
 366             TestBotRunner.runPeriodicItems(checkBot);
 367 
 368             // Verify that the check passed
 369             var checks = pr.checks(editHash);
 370             assertEquals(1, checks.size());
 371             var check = checks.get(&quot;jcheck&quot;);
 372             assertEquals(CheckStatus.SUCCESS, check.status());
 373 
 374             // The PR should now be ready for review
 375             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 376             assertFalse(pr.labels().contains(&quot;ready&quot;));
 377 
 378             // Approve it as another user
 379             var approvalPr = reviewer.pullRequest(pr.id());
 380             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 381 
 382             // Check the status again
 383             TestBotRunner.runPeriodicItems(checkBot);
 384 
 385             // The check should now be successful
 386             checks = pr.checks(editHash);
 387             assertEquals(1, checks.size());
 388             check = checks.get(&quot;jcheck&quot;);
 389             assertEquals(CheckStatus.SUCCESS, check.status());
 390 
 391             // The PR should now be ready
 392             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 393             assertTrue(pr.labels().contains(&quot;ready&quot;));
 394 
 395             var addedHash = CheckableRepository.appendAndCommit(localRepo, &quot;trailing whitespace   &quot;);
 396             localRepo.push(addedHash, author.url(), &quot;edit&quot;);
 397 
 398             // Make sure that the push registered
 399             var lastHeadHash = pr.headHash();
 400             var refreshCount = 0;
 401             do {
 402                 pr = author.pullRequest(pr.id());
 403                 if (refreshCount++ &gt; 100) {
 404                     fail(&quot;The PR did not update after the new push&quot;);
 405                 }
 406             } while (pr.headHash().equals(lastHeadHash));
 407 
 408             // Check the status
 409             TestBotRunner.runPeriodicItems(checkBot);
 410 
 411             // The PR is now neither ready for review nor integration
 412             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 413             assertFalse(pr.labels().contains(&quot;ready&quot;));
 414 
 415             // The check should now be failing
 416             checks = pr.checks(addedHash);
 417             assertEquals(1, checks.size());
 418             check = checks.get(&quot;jcheck&quot;);
 419             assertEquals(CheckStatus.FAILURE, check.status());
 420         }
 421     }
 422 
 423     @Test
 424     void individualReviewComments(TestInfo testInfo) throws IOException {
 425         try (var credentials = new HostCredentials(testInfo);
 426              var tempFolder = new TemporaryDirectory()) {
 427             var author = credentials.getHostedRepository();
 428             var reviewer = credentials.getHostedRepository();
 429 
 430             // This test is only relevant on hosts not supporting proper review comment bodies
 431             assumeTrue(!author.forge().supportsReviewBody());
 432 
 433             var censusBuilder = credentials.getCensusBuilder()
 434                                            .addAuthor(author.forge().currentUser().id())
 435                                            .addReviewer(reviewer.forge().currentUser().id());
 436             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 437 
 438             // Populate the projects repository
 439             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 440             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 441             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 442 
 443             // Make a change with a corresponding PR
 444             var editHash = CheckableRepository.appendAndCommit(localRepo);
 445             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 446             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 447 
 448             // Check the status
 449             TestBotRunner.runPeriodicItems(checkBot);
 450             var comments = pr.comments();
 451             var commentCount = comments.size();
 452 
 453             // Approve it as another user
 454             var approvalPr = reviewer.pullRequest(pr.id());
 455             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 456 
 457             // Check the status again
 458             TestBotRunner.runPeriodicItems(checkBot);
 459 
 460             // There should now be two additional comments
 461             comments = pr.comments();
 462             assertEquals(commentCount + 2, comments.size());
 463             var comment = comments.get(commentCount);
 464             assertTrue(comment.body().contains(reviewer.forge().currentUser().userName()));
 465             assertTrue(comment.body().contains(&quot;approved&quot;));
 466 
 467             // Drop the review
 468             approvalPr.addReview(Review.Verdict.NONE, &quot;Unreviewed&quot;);
 469 
 470             // Check the status again
 471             TestBotRunner.runPeriodicItems(checkBot);
 472 
 473             // There should now be yet another comment
 474             comments = pr.comments();
 475             assertEquals(commentCount + 3, comments.size());
 476             comment = comments.get(commentCount + 2);
 477             assertTrue(comment.body().contains(reviewer.forge().currentUser().userName()));
 478             assertTrue(comment.body().contains(&quot;comment&quot;));
 479 
 480             // No changes should not generate additional comments
 481             TestBotRunner.runPeriodicItems(checkBot);
 482             comments = pr.comments();
 483             assertEquals(commentCount + 3, comments.size());
 484         }
 485     }
 486 
 487     @Test
 488     void mergeMessage(TestInfo testInfo) throws IOException {
 489         try (var credentials = new HostCredentials(testInfo);
 490              var tempFolder = new TemporaryDirectory();
 491              var pushedFolder = new TemporaryDirectory()) {
 492 
 493             var author = credentials.getHostedRepository();
 494             var integrator = credentials.getHostedRepository();
 495             var censusBuilder = credentials.getCensusBuilder()
 496                                            .addCommitter(author.forge().currentUser().id())
 497                                            .addReviewer(integrator.forge().currentUser().id());
 498             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
 499 
 500             // Populate the projects repository
 501             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 502             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 503             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 504             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 505 
 506             // Make a change with a corresponding PR
 507             var editHash = CheckableRepository.appendAndCommit(localRepo);
 508             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 509             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 510 
 511             // Approve it as another user
 512             var approvalPr = integrator.pullRequest(pr.id());
 513             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 514 
 515             // Get all messages up to date
 516             TestBotRunner.runPeriodicItems(mergeBot);
 517 
 518             // Push something unrelated to master
 519             localRepo.checkout(masterHash, true);
 520             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
 521             Files.writeString(unrelated, &quot;Hello&quot;);
 522             localRepo.add(unrelated);
 523             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
 524             localRepo.push(unrelatedHash, author.url(), &quot;master&quot;);
 525 
 526             // Let the bot see the changes
 527             TestBotRunner.runPeriodicItems(mergeBot);
 528 
 529             // The bot should reply with an ok message
 530             var updated = pr.comments().stream()
 531                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
 532                             .filter(comment -&gt; comment.body().contains(&quot; * &quot; + unrelatedHash.abbreviate()))
 533                             .filter(comment -&gt; comment.body().contains(&quot;please merge&quot;))
 534                             .count();
 535             assertEquals(1, updated);
 536         }
 537     }
 538 
 539     @Test
 540     void cannotRebase(TestInfo testInfo) throws IOException {
 541         try (var credentials = new HostCredentials(testInfo);
 542              var tempFolder = new TemporaryDirectory();
 543              var pushedFolder = new TemporaryDirectory()) {
 544 
 545             var author = credentials.getHostedRepository();
 546             var integrator = credentials.getHostedRepository();
 547             var censusBuilder = credentials.getCensusBuilder()
 548                                            .addCommitter(author.forge().currentUser().id())
 549                                            .addReviewer(integrator.forge().currentUser().id());
 550             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
 551 
 552             // Populate the projects repository
 553             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 554             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 555             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 556             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 557 
 558             // Make a change with a corresponding PR
 559             var editHash = CheckableRepository.appendAndCommit(localRepo);
 560             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 561             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 562 
 563             // Approve it as another user
 564             var approvalPr = integrator.pullRequest(pr.id());
 565             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 566 
 567             // Get all messages up to date
 568             TestBotRunner.runPeriodicItems(mergeBot);
 569             assertTrue(pr.labels().contains(&quot;ready&quot;));
 570 
 571             // Push something conflicting to master
 572             localRepo.checkout(masterHash, true);
 573             var conflictingHash = CheckableRepository.appendAndCommit(localRepo, &quot;This looks like a conflict&quot;);
 574             localRepo.push(conflictingHash, author.url(), &quot;master&quot;);
 575 
 576             // Let the bot see the changes
 577             TestBotRunner.runPeriodicItems(mergeBot);
 578 
 579             // The bot should not yet post the ready for integration message
 580             var updated = pr.comments().stream()
 581                             .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
 582                             .count();
 583             assertEquals(0, updated);
 584 
 585             // The PR should be flagged as outdated
 586             assertTrue(pr.labels().contains(&quot;merge-conflict&quot;));
 587             assertFalse(pr.labels().contains(&quot;ready&quot;));
 588 
 589             // An instructional message should have been bosted
 590             var help = pr.comments().stream()
 591                          .filter(comment -&gt; comment.body().contains(&quot;To resolve these merge conflicts&quot;))
 592                          .count();
 593             assertEquals(1, help);
 594 
 595             // But it should still pass jcheck
 596             var checks = pr.checks(editHash);
 597             assertEquals(1, checks.size());
 598             var check = checks.get(&quot;jcheck&quot;);
 599             assertEquals(CheckStatus.SUCCESS, check.status());
 600 
 601             // Restore the master branch
 602             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 603 
 604             // Let the bot see the changes
 605             TestBotRunner.runPeriodicItems(mergeBot);
 606 
 607             // The bot should now post an integration message
 608             updated = pr.comments().stream()
 609                         .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
 610                         .count();
 611             assertEquals(1, updated);
 612 
 613             // The PR should not be flagged as outdated
 614             assertFalse(pr.labels().contains(&quot;merge-conflict&quot;));
 615             assertTrue(pr.labels().contains(&quot;ready&quot;));
 616         }
 617     }
 618 
 619     @Test
 620     void blockingLabel(TestInfo testInfo) throws IOException {
 621         try (var credentials = new HostCredentials(testInfo);
 622              var tempFolder = new TemporaryDirectory()) {
 623             var author = credentials.getHostedRepository();
 624             var reviewer = credentials.getHostedRepository();
 625 
 626             var censusBuilder = credentials.getCensusBuilder()
 627                                            .addAuthor(author.forge().currentUser().id())
 628                                            .addReviewer(reviewer.forge().currentUser().id());
 629             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).blockingCheckLabels(Map.of(&quot;block&quot;, &quot;Test Blocker&quot;)).build();
 630 
 631             // Populate the projects repository
 632             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 633             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 634             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 635 
 636             // Make a change with a corresponding PR
 637             var editHash = CheckableRepository.appendAndCommit(localRepo);
 638             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 639             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 640             pr.addLabel(&quot;block&quot;);
 641 
 642             // Check the status
 643             TestBotRunner.runPeriodicItems(checkBot);
 644 
 645             // Verify that the check failed
 646             var checks = pr.checks(editHash);
 647             assertEquals(1, checks.size());
 648             var check = checks.get(&quot;jcheck&quot;);
 649             assertEquals(CheckStatus.FAILURE, check.status());
 650             assertTrue(check.summary().orElseThrow().contains(&quot;Test Blocker&quot;));
 651 
 652             // The PR should not yet be ready for review
 653             assertTrue(pr.labels().contains(&quot;block&quot;));
 654             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 655             assertFalse(pr.labels().contains(&quot;ready&quot;));
 656 
 657             // Check the status again
 658             pr.removeLabel(&quot;block&quot;);
 659             TestBotRunner.runPeriodicItems(checkBot);
 660 
 661             // The PR should now be ready for review
 662             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 663             assertFalse(pr.labels().contains(&quot;ready&quot;));
 664         }
 665     }
 666 
 667     @Test
 668     void emptyPRBody(TestInfo testInfo) throws IOException {
 669         try (var credentials = new HostCredentials(testInfo);
 670              var tempFolder = new TemporaryDirectory()) {
 671             var author = credentials.getHostedRepository();
 672             var reviewer = credentials.getHostedRepository();
 673 
 674             var censusBuilder = credentials.getCensusBuilder()
 675                                            .addAuthor(author.forge().currentUser().id())
 676                                            .addReviewer(reviewer.forge().currentUser().id());
 677             var checkBot = PullRequestBot.newBuilder()
 678                                          .repo(author)
 679                                          .censusRepo(censusBuilder.build())
 680                                          .build();
 681 
 682             // Populate the projects repository
 683             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 684             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 685             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 686 
 687             // Make a change with a corresponding PR
 688             var editHash = CheckableRepository.appendAndCommit(localRepo);
 689             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 690             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Another PR&quot;);
 691             pr.setBody(&quot;    &quot;);
 692 
 693             // Check the status
 694             TestBotRunner.runPeriodicItems(checkBot);
 695 
 696             // Verify that the check failed
 697             var checks = pr.checks(editHash);
 698             assertEquals(1, checks.size());
 699             var check = checks.get(&quot;jcheck&quot;);
 700             assertEquals(CheckStatus.FAILURE, check.status());
 701             assertTrue(check.summary().orElseThrow().contains(&quot;The pull request body must not be empty.&quot;));
 702 
 703             // Additional errors should be displayed in the body
 704             var updatedPr = author.pullRequest(pr.id());
 705             assertTrue(updatedPr.body().contains(&quot;## Error&quot;));
 706             assertTrue(updatedPr.body().contains(&quot;The pull request body must not be empty.&quot;));
 707 
 708             // There should be an indicator of where the pr body should be entered
 709             assertTrue(updatedPr.body().contains(&quot;Replace this text with a description of your pull request&quot;));
 710 
 711             // The PR should not yet be ready for review
 712             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 713             assertFalse(pr.labels().contains(&quot;ready&quot;));
 714 
 715             // Check the status again
 716             pr.setBody(&quot;Here&#39;s that body&quot;);
 717             TestBotRunner.runPeriodicItems(checkBot);
 718 
 719             // The PR should now be ready for review
 720             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 721             assertFalse(pr.labels().contains(&quot;ready&quot;));
 722 
 723             // The additional errors should be gone
 724             updatedPr = author.pullRequest(pr.id());
 725             assertFalse(updatedPr.body().contains(&quot;## Error&quot;));
 726             assertFalse(updatedPr.body().contains(&quot;The pull request body must not be empty.&quot;));
 727 
 728             // And no new helper marker
 729             assertFalse(updatedPr.body().contains(&quot;Replace this text with a description of your pull request&quot;));
 730         }
 731     }
 732 
 733     @Test
 734     void executableFile(TestInfo testInfo) throws IOException {
 735         try (var credentials = new HostCredentials(testInfo);
 736              var tempFolder = new TemporaryDirectory()) {
 737             var author = credentials.getHostedRepository();
 738             var reviewer = credentials.getHostedRepository();
 739 
 740             var censusBuilder = credentials.getCensusBuilder()
 741                                            .addAuthor(author.forge().currentUser().id())
 742                                            .addReviewer(reviewer.forge().currentUser().id());
 743             var checkBot = PullRequestBot.newBuilder()
 744                                          .repo(author)
 745                                          .censusRepo(censusBuilder.build())
 746                                          .build();
 747 
 748             // Populate the projects repository
 749             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(),
 750                     Path.of(&quot;executable.exe&quot;), Set.of(&quot;reviewers&quot;, &quot;executable&quot;), &quot;0.1&quot;);
 751             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 752             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 753 
 754             // Make a change with a corresponding PR
 755             Files.writeString(tempFolder.path().resolve(&quot;executable.exe&quot;), &quot;Executable file contents&quot;, StandardCharsets.UTF_8);
 756             Files.setPosixFilePermissions(tempFolder.path().resolve(&quot;executable.exe&quot;), Set.of(PosixFilePermission.OWNER_EXECUTE, PosixFilePermission.OWNER_READ));
 757             localRepo.add(Path.of(&quot;executable.exe&quot;));
 758             var editHash = localRepo.commit(&quot;Make it executable&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 759             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 760             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Another PR&quot;);
 761             pr.setBody(&quot;This should now be ready&quot;);
 762 
 763             // Check the status
 764             TestBotRunner.runPeriodicItems(checkBot);
 765 
 766             // Verify that the check failed
 767             var checks = pr.checks(editHash);
 768             assertEquals(1, checks.size());
 769             var check = checks.get(&quot;jcheck&quot;);
 770             assertEquals(CheckStatus.FAILURE, check.status());
 771             assertTrue(check.summary().orElseThrow().contains(&quot;Executable files are not allowed (file: executable.exe)&quot;));
 772 
 773             // Additional errors should be displayed in the body
 774             var updatedPr = author.pullRequest(pr.id());
 775             assertTrue(updatedPr.body().contains(&quot;## Error&quot;));
 776             assertTrue(updatedPr.body().contains(&quot;Executable files are not allowed (file: executable.exe)&quot;));
 777 
 778             // The PR should not yet be ready for review
 779             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 780             assertFalse(pr.labels().contains(&quot;ready&quot;));
 781 
 782             // Drop that error
 783             Files.setPosixFilePermissions(tempFolder.path().resolve(&quot;executable.exe&quot;), Set.of(PosixFilePermission.OWNER_READ));
 784             localRepo.add(Path.of(&quot;executable.exe&quot;));
 785             var updatedHash = localRepo.commit(&quot;Make it unexecutable&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 786             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 787             TestBotRunner.runPeriodicItems(checkBot);
 788 
 789             // The PR should now be ready for review
 790             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 791             assertFalse(pr.labels().contains(&quot;ready&quot;));
 792 
 793             // The additional errors should be gone
 794             updatedPr = author.pullRequest(pr.id());
 795             assertFalse(updatedPr.body().contains(&quot;## Error&quot;));
 796             assertFalse(updatedPr.body().contains(&quot;Executable files are not allowed&quot;));
 797         }
 798     }
 799 
 800     @Test
 801     void missingReadyLabel(TestInfo testInfo) throws IOException {
 802         try (var credentials = new HostCredentials(testInfo);
 803              var tempFolder = new TemporaryDirectory()) {
 804             var author = credentials.getHostedRepository();
 805             var reviewer = credentials.getHostedRepository();
 806 
 807             var censusBuilder = credentials.getCensusBuilder()
 808                                            .addAuthor(author.forge().currentUser().id())
 809                                            .addReviewer(reviewer.forge().currentUser().id());
 810             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).readyLabels(Set.of(&quot;good-to-go&quot;)).build();
 811 
 812             // Populate the projects repository
 813             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 814             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 815             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 816 
 817             // Make a change with a corresponding PR
 818             var editHash = CheckableRepository.appendAndCommit(localRepo);
 819             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 820             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 821 
 822             // Check the status
 823             TestBotRunner.runPeriodicItems(checkBot);
 824 
 825             // Verify that no checks have been run
 826             var checks = pr.checks(editHash);
 827             assertEquals(0, checks.size());
 828 
 829             // The PR should not yet be ready for review
 830             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 831 
 832             // Check the status again
 833             pr.addLabel(&quot;good-to-go&quot;);
 834             TestBotRunner.runPeriodicItems(checkBot);
 835 
 836             // The PR should now be ready for review
 837             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 838         }
 839     }
 840 
 841     @Test
 842     void missingReadyComment(TestInfo testInfo) throws IOException {
 843         try (var credentials = new HostCredentials(testInfo);
 844              var tempFolder = new TemporaryDirectory()) {
 845             var author = credentials.getHostedRepository();
 846             var reviewer = credentials.getHostedRepository();
 847 
 848             var censusBuilder = credentials.getCensusBuilder()
 849                                            .addAuthor(author.forge().currentUser().id())
 850                                            .addReviewer(reviewer.forge().currentUser().id());
 851             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;proceed&quot;))).build();
 852 
 853             // Populate the projects repository
 854             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 855             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 856             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 857 
 858             // Make a change with a corresponding PR
 859             var editHash = CheckableRepository.appendAndCommit(localRepo);
 860             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 861             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 862 
 863             // Check the status
 864             TestBotRunner.runPeriodicItems(checkBot);
 865 
 866             // Verify that no checks have been run
 867             var checks = pr.checks(editHash);
 868             assertEquals(0, checks.size());
 869 
 870             // The PR should not yet be ready for review
 871             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 872 
 873             // Check the status again
 874             var reviewerPr = reviewer.pullRequest(pr.id());
 875             reviewerPr.addComment(&quot;proceed&quot;);
 876             TestBotRunner.runPeriodicItems(checkBot);
 877 
 878             // The PR should now be ready for review
 879             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 880         }
 881     }
 882 
 883     @Test
 884     void issueIssue(TestInfo testInfo) throws IOException {
 885         try (var credentials = new HostCredentials(testInfo);
 886              var tempFolder = new TemporaryDirectory()) {
 887             var author = credentials.getHostedRepository();
 888             var reviewer = credentials.getHostedRepository();
 889 
 890             var censusBuilder = credentials.getCensusBuilder()
 891                                            .addAuthor(author.forge().currentUser().id())
 892                                            .addReviewer(reviewer.forge().currentUser().id());
 893             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 894 
 895             // Populate the projects repository
 896             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 897                                                      Set.of(&quot;issues&quot;), null);
 898             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 899             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 900 
 901             // Make a change with a corresponding PR
 902             var editHash = CheckableRepository.appendAndCommit(localRepo);
 903             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 904             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 905 
 906             // Check the status
 907             TestBotRunner.runPeriodicItems(checkBot);
 908 
 909             // Verify that the check failed
 910             var checks = pr.checks(editHash);
 911             assertEquals(1, checks.size());
 912             var check = checks.get(&quot;jcheck&quot;);
 913             assertEquals(CheckStatus.FAILURE, check.status());
 914 
 915             // Add an issue to the title
 916             pr.setTitle(&quot;1234: This is a pull request&quot;);
 917 
 918             // Check the status again
 919             TestBotRunner.runPeriodicItems(checkBot);
 920 
 921             // The check should now be successful
 922             checks = pr.checks(editHash);
 923             assertEquals(1, checks.size());
 924             check = checks.get(&quot;jcheck&quot;);
 925             assertEquals(CheckStatus.SUCCESS, check.status());
 926         }
 927     }
 928 
 929     @Test
 930     void issueInSummary(TestInfo testInfo) throws IOException {
 931         try (var credentials = new HostCredentials(testInfo);
 932              var tempFolder = new TemporaryDirectory()) {
 933             var author = credentials.getHostedRepository();
 934             var reviewer = credentials.getHostedRepository();
 935             var issues = credentials.getIssueProject();
 936 
 937             var censusBuilder = credentials.getCensusBuilder()
 938                                            .addAuthor(author.forge().currentUser().id())
 939                                            .addReviewer(reviewer.forge().currentUser().id());
 940             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).issueProject(issues).build();
 941 
 942             // Populate the projects repository
 943             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 944                                                      Set.of(&quot;issues&quot;), null);
 945             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 946             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 947 
 948             var issue1 = issues.createIssue(&quot;My first issue&quot;, List.of(&quot;Hello&quot;), Map.of());
 949 
 950             // Make a change with a corresponding PR
 951             var editHash = CheckableRepository.appendAndCommit(localRepo);
 952             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 953             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, issue1.id() + &quot;: This is a pull request&quot;);
 954 
 955             // Check the status
 956             TestBotRunner.runPeriodicItems(checkBot);
 957 
 958             // The check should be successful
 959             var checks = pr.checks(editHash);
 960             assertEquals(1, checks.size());
 961             var check = checks.get(&quot;jcheck&quot;);
 962             assertEquals(CheckStatus.SUCCESS, check.status());
 963 
 964             // And the body should contain the issue title
 965             assertTrue(pr.body().contains(&quot;My first issue&quot;));
 966 
 967             // Change the issue
 968             var issue2 = issues.createIssue(&quot;My second issue&quot;, List.of(&quot;Body&quot;), Map.of());
 969             pr.setTitle(issue2.id() + &quot;: This is a pull request&quot;);
 970 
 971             // Check the status again
 972             TestBotRunner.runPeriodicItems(checkBot);
 973 
 974             // The body should contain the updated issue title
 975             assertFalse(pr.body().contains(&quot;My first issue&quot;));
 976             assertTrue(pr.body().contains(&quot;My second issue&quot;));
 977 
 978             // The PR title does not match the issue title
 979             assertTrue(pr.body().contains(&quot;Title mismatch&quot;));
 980 
 981             // Correct it
 982             pr.setTitle(issue2.id() + &quot; - &quot; + issue2.title());
 983 
 984             // Check the status again - it should now match
 985             TestBotRunner.runPeriodicItems(checkBot);
 986             assertFalse(pr.body().contains(&quot;Title mismatch&quot;));
 987 
 988             // Use an invalid issue key
 989             var issueKey = issue1.id().replace(&quot;TEST&quot;, &quot;BADPROJECT&quot;);
 990             pr.setTitle(issueKey + &quot;: This is a pull request&quot;);
 991 
 992             // Check the status again
 993             TestBotRunner.runPeriodicItems(checkBot);
 994             assertFalse(pr.body().contains(&quot;My first issue&quot;));
 995             assertFalse(pr.body().contains(&quot;My second issue&quot;));
 996             assertTrue(pr.body().contains(&quot;does not belong to the `TEST` project&quot;));
 997 
 998             // Now drop the issue key
 999             issueKey = issue1.id().replace(&quot;TEST-&quot;, &quot;&quot;);
1000             pr.setTitle(issueKey + &quot;: This is a pull request&quot;);
1001 
1002             // The body should now contain the updated issue title
1003             TestBotRunner.runPeriodicItems(checkBot);
1004             assertTrue(pr.body().contains(&quot;My first issue&quot;));
1005             assertFalse(pr.body().contains(&quot;My second issue&quot;));
1006 
1007             // Now enter an invalid issue id
1008             pr.setTitle(&quot;2384848: This is a pull request&quot;);
1009 
1010             // Check the status again
1011             TestBotRunner.runPeriodicItems(checkBot);
1012             assertFalse(pr.body().contains(&quot;My first issue&quot;));
1013             assertFalse(pr.body().contains(&quot;My second issue&quot;));
1014             assertTrue(pr.body().contains(&quot;Failed to retrieve&quot;));
1015 
1016             // The check should still be successful though
1017             checks = pr.checks(editHash);
1018             assertEquals(1, checks.size());
1019             check = checks.get(&quot;jcheck&quot;);
1020             assertEquals(CheckStatus.SUCCESS, check.status());
1021         }
1022     }
1023 
1024     @Test
1025     void cancelCheck(TestInfo testInfo) throws IOException {
1026         try (var credentials = new HostCredentials(testInfo);
1027              var tempFolder = new TemporaryDirectory()) {
1028             var author = credentials.getHostedRepository();
1029 
1030             // Populate the projects repository
1031             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1032             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1033             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1034 
1035             // Make a change with a corresponding PR
1036             var editHash = CheckableRepository.appendAndCommit(localRepo);
1037             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1038             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1039 
1040             // Verify no checks exists
1041             var checks = pr.checks(editHash);
1042             assertEquals(0, checks.size());
1043 
1044             // Create a check that is running
1045             var original = CheckBuilder.create(&quot;jcheck&quot;, editHash)
1046                                        .title(&quot;jcheck title&quot;)
1047                                        .summary(&quot;jcheck summary&quot;)
1048                                        .build();
1049             pr.createCheck(original);
1050 
1051             // Verify check is created
1052             checks = pr.checks(editHash);
1053             assertEquals(1, checks.size());
1054             var retrieved = checks.get(&quot;jcheck&quot;);
1055             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
1056             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
1057             assertEquals(CheckStatus.IN_PROGRESS, retrieved.status());
1058 
1059             // Cancel the check
1060             var cancelled = CheckBuilder.from(retrieved).cancel().build();
1061             pr.updateCheck(cancelled);
1062             checks = pr.checks(editHash);
1063             assertEquals(1, checks.size());
1064             retrieved = checks.get(&quot;jcheck&quot;);
1065             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
1066             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
1067             assertEquals(CheckStatus.CANCELLED, retrieved.status());
1068         }
1069     }
1070 
1071     @Test
1072     void rebaseBeforeCheck(TestInfo testInfo) throws IOException {
1073         try (var credentials = new HostCredentials(testInfo);
1074              var tempFolder = new TemporaryDirectory()) {
1075             var author = credentials.getHostedRepository();
1076             var reviewer = credentials.getHostedRepository();
1077 
1078             var censusBuilder = credentials.getCensusBuilder()
1079                                            .addAuthor(author.forge().currentUser().id())
1080                                            .addReviewer(reviewer.forge().currentUser().id());
1081             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1082 
1083             // Populate the projects repository
1084             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1085             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1086             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1087 
1088             // Make a change with a corresponding PR
1089             var editHash = CheckableRepository.appendAndCommit(localRepo);
1090             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1091             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1092 
1093             // Enable a new check in the target branch
1094             localRepo.checkout(masterHash, true);
1095             CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
1096                                      Set.of(&quot;author&quot;, &quot;reviewers&quot;, &quot;whitespace&quot;, &quot;issues&quot;), null);
1097             var headHash = localRepo.resolve(&quot;HEAD&quot;).orElseThrow();
1098             localRepo.push(headHash, author.url(), &quot;master&quot;, true);
1099 
1100             // Check the status
1101             TestBotRunner.runPeriodicItems(checkBot);
1102 
1103             // Verify that the check failed
1104             var checks = pr.checks(editHash);
1105             assertEquals(1, checks.size());
1106             var check = checks.get(&quot;jcheck&quot;);
1107             assertTrue(check.summary().orElseThrow().contains(&quot;commit message does not reference any issue&quot;));
1108             assertEquals(CheckStatus.FAILURE, check.status());
1109 
1110             // Adjust the title to conform and check the status again
1111             pr.setTitle(&quot;12345: This is a pull request&quot;);
1112             TestBotRunner.runPeriodicItems(checkBot);
1113 
1114             // Verify that the check passed
1115             checks = pr.checks(editHash);
1116             assertEquals(1, checks.size());
1117             check = checks.get(&quot;jcheck&quot;);
1118             assertEquals(CheckStatus.SUCCESS, check.status());
1119         }
1120     }
1121 
1122     @Test
1123     void draft(TestInfo testInfo) throws IOException {
1124         try (var credentials = new HostCredentials(testInfo);
1125              var tempFolder = new TemporaryDirectory()) {
1126             var author = credentials.getHostedRepository();
1127             var reviewer = credentials.getHostedRepository();
1128 
1129             var censusBuilder = credentials.getCensusBuilder()
1130                                            .addAuthor(author.forge().currentUser().id())
1131                                            .addReviewer(reviewer.forge().currentUser().id());
1132             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1133 
1134             // Populate the projects repository
1135             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1136             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1137             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1138 
1139             // Make a change with a corresponding PR
1140             var editHash = CheckableRepository.appendAndCommit(localRepo);
1141             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1142             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1143                                                    &quot;This is a pull request&quot;, true);
1144 
1145             // Check the status
1146             TestBotRunner.runPeriodicItems(checkBot);
1147 
1148             // Verify that the check succeeded
1149             var checks = pr.checks(editHash);
1150             assertEquals(1, checks.size());
1151             var check = checks.get(&quot;jcheck&quot;);
1152             assertEquals(CheckStatus.SUCCESS, check.status());
1153 
1154             // The PR should still not be ready for review as it is a draft
1155             assertFalse(pr.labels().contains(&quot;rfr&quot;));
1156             assertFalse(pr.labels().contains(&quot;ready&quot;));
1157         }
1158     }
1159 
1160     @Test
1161     void excessiveFailures(TestInfo testInfo) throws IOException {
1162         try (var credentials = new HostCredentials(testInfo);
1163              var tempFolder = new TemporaryDirectory()) {
1164             var author = credentials.getHostedRepository();
1165             var reviewer = credentials.getHostedRepository();
1166 
1167             var censusBuilder = credentials.getCensusBuilder()
1168                                            .addAuthor(author.forge().currentUser().id())
1169                                            .addReviewer(reviewer.forge().currentUser().id());
1170             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1171 
1172             // Populate the projects repository
1173             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1174             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1175             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1176 
1177             // Make a change with a corresponding PR containing more errors than at least GitHub can handle in a check
1178             var badContent = &quot;\tline   \n&quot;.repeat(200);
1179             var editHash = CheckableRepository.appendAndCommit(localRepo, badContent);
1180             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1181             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1182                                                    &quot;This is a pull request&quot;, true);
1183 
1184             // Check the status
1185             TestBotRunner.runPeriodicItems(checkBot);
1186 
1187             // Verify that the check failed
1188             var checks = pr.checks(editHash);
1189             assertEquals(1, checks.size());
1190             var check = checks.get(&quot;jcheck&quot;);
1191             assertEquals(CheckStatus.FAILURE, check.status());
1192         }
1193     }
1194 
1195     @Test
1196     void useJCheckConfFromTargetBranch(TestInfo testInfo) throws IOException {
1197         try (var credentials = new HostCredentials(testInfo);
1198              var tempFolder = new TemporaryDirectory()) {
1199             var author = credentials.getHostedRepository();
1200             var reviewer = credentials.getHostedRepository();
1201 
1202             var censusBuilder = credentials.getCensusBuilder()
1203                                            .addAuthor(author.forge().currentUser().id())
1204                                            .addReviewer(reviewer.forge().currentUser().id());
1205             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1206 
1207             // Populate the projects repository
1208             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1209             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1210             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1211 
1212             // Break the jcheck configuration on the &quot;edit&quot; branch
1213             var confPath = tempFolder.path().resolve(&quot;.jcheck/conf&quot;);
1214             var oldConf = Files.readString(confPath, StandardCharsets.UTF_8);
1215             Files.writeString(confPath, &quot;Hello there!&quot;, StandardCharsets.UTF_8);
1216             localRepo.add(confPath);
1217             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A change&quot;);
1218             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1219             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1220                                                    &quot;This is a pull request&quot;, true);
1221 
1222             // Check the status - should *not* throw because valid .jcheck/conf from
1223             // &quot;master&quot; branch should be used
1224             TestBotRunner.runPeriodicItems(checkBot);
1225             TestBotRunner.runPeriodicItems(checkBot);
1226             TestBotRunner.runPeriodicItems(checkBot);
1227 
1228             // Verify that the check succeeded
1229             var checks = pr.checks(editHash);
1230             assertEquals(1, checks.size());
1231             var check = checks.get(&quot;jcheck&quot;);
1232             assertEquals(CheckStatus.SUCCESS, check.status());
1233         }
1234     }
1235 
1236     @Test
1237     void noCommit(TestInfo testInfo) throws IOException {
1238         try (var credentials = new HostCredentials(testInfo);
1239              var tempFolder = new TemporaryDirectory()) {
1240             var author = credentials.getHostedRepository();
1241             var reviewer = credentials.getHostedRepository();
1242 
1243             var censusBuilder = credentials.getCensusBuilder()
1244                                            .addAuthor(author.forge().currentUser().id())
1245                                            .addReviewer(reviewer.forge().currentUser().id());
1246             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1247 
1248             // Populate the projects repository
1249             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1250             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1251             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1252 
1253             // Make a change with a corresponding PR
1254             var editHash = CheckableRepository.appendAndCommit(localRepo);
1255             localRepo.push(editHash, author.url(), &quot;master&quot;);
1256             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1257             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1258 
1259             // Check the status
1260             TestBotRunner.runPeriodicItems(checkBot);
1261 
1262             // Verify that the check failed
1263             var checks = pr.checks(editHash);
1264             assertEquals(1, checks.size());
1265             var check = checks.get(&quot;jcheck&quot;);
1266             assertEquals(CheckStatus.FAILURE, check.status());
1267             assertEquals(&quot;- This PR contains no changes&quot;, check.summary().orElseThrow());
1268         }
1269     }
1270 
1271     @Test
1272     void ignoreStale(TestInfo testInfo) throws IOException {
1273         try (var credentials = new HostCredentials(testInfo);
1274              var tempFolder = new TemporaryDirectory()) {
1275 
1276             var author = credentials.getHostedRepository();
1277             var reviewer = credentials.getHostedRepository();
1278 
1279             var censusBuilder = credentials.getCensusBuilder()
1280                                            .addAuthor(author.forge().currentUser().id())
1281                                            .addReviewer(reviewer.forge().currentUser().id());
1282             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).ignoreStaleReviews(true).build();
1283 
1284             // Populate the projects repository
1285             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1286             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1287             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1288 
1289             // Make a change with a corresponding PR
1290             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line with&quot;);
1291             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1292             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1293 
1294             // Check the status
1295             TestBotRunner.runPeriodicItems(checkBot);
1296 
1297             // Approve it as another user
1298             var approvalPr = reviewer.pullRequest(pr.id());
1299             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
1300 
1301             // Check the status
1302             TestBotRunner.runPeriodicItems(checkBot);
1303 
1304             // The PR should be flagged as ready
1305             assertTrue(pr.labels().contains(&quot;ready&quot;));
1306             assertFalse(pr.body().contains(&quot;Re-review required&quot;));
1307 
1308             // Add another commit
1309             editHash = CheckableRepository.replaceAndCommit(localRepo, &quot;Another line&quot;);
1310             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1311 
1312             // Make sure that the push registered
1313             var lastHeadHash = pr.headHash();
1314             var refreshCount = 0;
1315             do {
1316                 pr = author.pullRequest(pr.id());
1317                 if (refreshCount++ &gt; 100) {
1318                     fail(&quot;The PR did not update after the new push&quot;);
1319                 }
1320             } while (pr.headHash().equals(lastHeadHash));
1321 
1322             // Check the status again
1323             TestBotRunner.runPeriodicItems(checkBot);
1324 
1325             // The PR should no longer be ready, as the review is stale
1326             assertFalse(pr.labels().contains(&quot;ready&quot;));
1327             assertTrue(pr.labels().contains(&quot;rfr&quot;));
1328             assertTrue(pr.body().contains(&quot;Re-review required&quot;));
1329         }
1330     }
1331 
1332     @Test
1333     void targetBranchPattern(TestInfo testInfo) throws IOException {
1334         try (var credentials = new HostCredentials(testInfo);
1335              var tempFolder = new TemporaryDirectory()) {
1336             var author = credentials.getHostedRepository();
1337             var reviewer = credentials.getHostedRepository();
1338 
1339             var censusBuilder = credentials.getCensusBuilder()
1340                                            .addAuthor(author.forge().currentUser().id())
1341                                            .addReviewer(reviewer.forge().currentUser().id());
1342             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build())
1343                                          .allowedTargetBranches(&quot;^(?!master$).*&quot;)
1344                                          .build();
1345 
1346             // Populate the projects repository
1347             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1348             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1349             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1350             localRepo.push(masterHash, author.url(), &quot;notmaster&quot;, true);
1351 
1352             // Make a change with a corresponding PR
1353             var editHash = CheckableRepository.appendAndCommit(localRepo);
1354             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1355             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1356                                                    &quot;This is a pull request&quot;, true);
1357 
1358             // Check the status
1359             TestBotRunner.runPeriodicItems(checkBot);
1360 
1361             // Verify that the check failed
1362             var checks = pr.checks(editHash);
1363             assertEquals(1, checks.size());
1364             var check = checks.get(&quot;jcheck&quot;);
1365             assertEquals(CheckStatus.FAILURE, check.status());
1366             assertTrue(check.summary().orElseThrow().contains(&quot;The branch `master` is not allowed as target branch&quot;));
1367             assertTrue(check.summary().orElseThrow().contains(&quot;notmaster&quot;));
1368 
1369             var anotherPr = credentials.createPullRequest(author, &quot;notmaster&quot;, &quot;edit&quot;,
1370                                                    &quot;This is a pull request&quot;, true);
1371 
1372             // Check the status
1373             TestBotRunner.runPeriodicItems(checkBot);
1374 
1375             // Approve it as another user
1376             var approvalPr = reviewer.pullRequest(anotherPr.id());
1377             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
1378             TestBotRunner.runPeriodicItems(checkBot);
1379 
1380             // Verify that the check passed
1381             checks = anotherPr.checks(editHash);
1382             assertEquals(1, checks.size());
1383             check = checks.get(&quot;jcheck&quot;);
1384             assertEquals(CheckStatus.SUCCESS, check.status());
1385         }
1386     }
1387 
1388     @Test
1389     void allowedIssueTypes(TestInfo testInfo) throws IOException {
1390         try (var credentials = new HostCredentials(testInfo);
1391              var tempFolder = new TemporaryDirectory()) {
1392             var author = credentials.getHostedRepository();
1393             var reviewer = credentials.getHostedRepository();
1394             var issues = credentials.getIssueProject();
1395 
1396             var censusBuilder = credentials.getCensusBuilder()
1397                                            .addAuthor(author.forge().currentUser().id())
1398                                            .addReviewer(reviewer.forge().currentUser().id());
1399             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build())
1400                                          .allowedIssueTypes(Set.of(&quot;Bug&quot;))
1401                                          .issueProject(issues)
1402                                          .build();
1403 
1404             var bug = issues.createIssue(&quot;My first bug&quot;, List.of(&quot;A bug&quot;),
1405                                          Map.of(&quot;issuetype&quot;, JSON.of(&quot;Bug&quot;)));
1406             var feature = issues.createIssue(&quot;My first feature&quot;, List.of(&quot;A feature&quot;),
1407                                              Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1408 
1409             // Populate the projects repository
1410             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1411             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1412             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1413 
1414             // Make a change with a corresponding PR
1415             var bugHash = CheckableRepository.appendAndCommit(localRepo);
1416             localRepo.push(bugHash, author.url(), &quot;bug&quot;, true);
1417             var bugPR = credentials.createPullRequest(author, &quot;master&quot;, &quot;bug&quot;,
1418                                                       bug.id() + &quot;: My first bug&quot;, true);
1419 
1420             // Check the status
1421             TestBotRunner.runPeriodicItems(checkBot);
1422 
1423             // Verify that the check passed
1424             var bugChecks = bugPR.checks(bugHash);
1425             assertEquals(1, bugChecks.size());
1426             var bugCheck = bugChecks.get(&quot;jcheck&quot;);
1427             assertEquals(CheckStatus.SUCCESS, bugCheck.status());
1428 
1429             // Make a change with a corresponding PR
1430             var featureHash = CheckableRepository.appendAndCommit(localRepo);
1431             localRepo.push(featureHash, author.url(), &quot;feature&quot;, true);
1432             var featurePR = credentials.createPullRequest(author, &quot;master&quot;, &quot;feature&quot;,
1433                                                           feature.id() + &quot;: My first feature&quot;, true);
1434 
1435             // Check the status
1436             TestBotRunner.runPeriodicItems(checkBot);
1437 
1438             // Verify that the check failed for the feature PR
1439             var featureChecks = featurePR.checks(featureHash);
1440             assertEquals(1, featureChecks.size());
1441             var featureCheck = featureChecks.get(&quot;jcheck&quot;);
1442             assertEquals(CheckStatus.FAILURE, featureCheck.status());
1443             var link = &quot;[&quot; + feature.id() + &quot;](&quot; + feature.webUrl() + &quot;)&quot;;
1444             assertTrue(featureCheck.summary()
1445                                    .orElseThrow()
1446                                    .contains(&quot;The issue &quot; + link + &quot; is not of the expected type. &quot; +
1447                                              &quot;The allowed issue types are:\n&quot; +
1448                                              &quot;   - Bug\n&quot;));
1449         }
1450     }
1451 }
    </pre>
  </body>
</html>