<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff cli/src/main/java/org/openjdk/skara/cli/GitJCheck.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JCheckCLIVisitor.java.udiff.html" target="_top">next &gt;</a></center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitJCheck.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -32,17 +32,53 @@</span>
  import org.openjdk.skara.version.Version;
  
  import java.io.IOException;
  import java.net.*;
  import java.nio.file.*;
<span class="udiff-line-added">+ import java.nio.charset.StandardCharsets;</span>
  import java.util.*;
  import java.util.regex.Pattern;
  import java.util.stream.Collectors;
  import java.util.logging.Level;
  
  public class GitJCheck {
<span class="udiff-line-modified-removed">-     private static final Pattern urlPattern = Pattern.compile(&quot;^https?://.*&quot;, Pattern.CASE_INSENSITIVE);</span>
<span class="udiff-line-modified-added">+     static String gitConfig(String key) {</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             var pb = new ProcessBuilder(&quot;git&quot;, &quot;config&quot;, key);</span>
<span class="udiff-line-added">+             pb.redirectOutput(ProcessBuilder.Redirect.PIPE);</span>
<span class="udiff-line-added">+             pb.redirectError(ProcessBuilder.Redirect.DISCARD);</span>
<span class="udiff-line-added">+             var p = pb.start();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var output = new String(p.getInputStream().readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="udiff-line-added">+             var res = p.waitFor();</span>
<span class="udiff-line-added">+             if (res != 0) {</span>
<span class="udiff-line-added">+                 return null;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             return output == null ? null : output.replace(&quot;\n&quot;, &quot;&quot;);</span>
<span class="udiff-line-added">+         } catch (InterruptedException e) {</span>
<span class="udiff-line-added">+             return null;</span>
<span class="udiff-line-added">+         } catch (IOException e) {</span>
<span class="udiff-line-added">+             return null;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static String getOption(String name, Arguments arguments) {</span>
<span class="udiff-line-added">+         if (arguments.contains(name)) {</span>
<span class="udiff-line-added">+             return arguments.get(name).asString();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return gitConfig(&quot;jcheck.&quot; + name);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static boolean getSwitch(String name, Arguments arguments) {</span>
<span class="udiff-line-added">+         if (arguments.contains(name)) {</span>
<span class="udiff-line-added">+             return true;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         var value = gitConfig(&quot;jcheck.&quot; + name);</span>
<span class="udiff-line-added">+         return value != null &amp;&amp; value.toLowerCase().equals(&quot;true&quot;);</span>
<span class="udiff-line-added">+     }</span>
  
      public static int run(String[] args) throws IOException {
          var flags = List.of(
              Option.shortcut(&quot;r&quot;)
                    .fullname(&quot;rev&quot;)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -62,22 +98,19 @@</span>
              Option.shortcut(&quot;&quot;)
                    .fullname(&quot;census&quot;)
                    .describe(&quot;FILE&quot;)
                    .helptext(&quot;Use the specified census (default: https://openjdk.java.net/census.xml)&quot;)
                    .optional(),
<span class="udiff-line-added">+             Option.shortcut(&quot;&quot;)</span>
<span class="udiff-line-added">+                   .fullname(&quot;ignore&quot;)</span>
<span class="udiff-line-added">+                   .describe(&quot;CHECKS&quot;)</span>
<span class="udiff-line-added">+                   .helptext(&quot;Ignore errors from checks with the given name&quot;)</span>
<span class="udiff-line-added">+                   .optional(),</span>
              Switch.shortcut(&quot;m&quot;)
                    .fullname(&quot;mercurial&quot;)
                    .helptext(&quot;Deprecated: force use of mercurial&quot;)
                    .optional(),
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;local&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Run jcheck in \&quot;local\&quot; mode&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;pull-request&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Run jcheck in \&quot;pull request\&quot; mode&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
              Switch.shortcut(&quot;v&quot;)
                    .fullname(&quot;verbose&quot;)
                    .helptext(&quot;Turn on verbose output&quot;)
                    .optional(),
              Switch.shortcut(&quot;&quot;)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -119,11 +152,11 @@</span>
          var repo = repository.get();
          if (repo.isEmpty()) {
              return 1;
          }
  
<span class="udiff-line-modified-removed">-         var isMercurial = arguments.contains(&quot;mercurial&quot;);</span>
<span class="udiff-line-modified-added">+         var isMercurial = getSwitch(&quot;mercurial&quot;, arguments);</span>
          var defaultRange = isMercurial ? &quot;tip&quot; : &quot;HEAD^..HEAD&quot;;
          var range = arguments.get(&quot;rev&quot;).orString(defaultRange);
          if (!repo.isValidRevisionRange(range)) {
              System.err.println(String.format(&quot;error: %s is not a valid range of revisions,&quot;, range));
              if (isMercurial) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -132,60 +165,56 @@</span>
                  System.err.println(&quot;       see &#39;man 7 gitrevisions&#39; for how to specify revisions&quot;);
              }
              return 1;
          }
  
<span class="udiff-line-modified-removed">-         var whitelistFile = arguments.get(&quot;whitelist&quot;).or(&quot;.jcheck/whitelist.json&quot;).via(Path::of);</span>
<span class="udiff-line-modified-added">+         var whitelistOption = getOption(&quot;whitelist&quot;, arguments);</span>
<span class="udiff-line-added">+         if (whitelistOption == null) {</span>
<span class="udiff-line-added">+             whitelistOption = &quot;.jcheck/whitelist.json&quot;;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         var whitelistFile = Path.of(whitelistOption);</span>
          var whitelist = new HashMap&lt;String, Set&lt;Hash&gt;&gt;();
          if (Files.exists(whitelistFile)) {
              var json = JSON.parse(Files.readString(whitelistFile));
              for (var field : json.fields()) {
                  var check = field.name();
                  var hashes = field.value().stream().map(JSONValue::asString).map(Hash::new).collect(Collectors.toSet());
                  whitelist.put(check, hashes);
              }
          }
  
<span class="udiff-line-modified-removed">-         var blacklistFile = arguments.get(&quot;blacklist&quot;).or(&quot;.jcheck/blacklist.json&quot;).via(Path::of);</span>
<span class="udiff-line-modified-added">+         var blacklistOption = getOption(&quot;blacklist&quot;, arguments);</span>
<span class="udiff-line-added">+         if (blacklistOption == null) {</span>
<span class="udiff-line-added">+             blacklistOption = &quot;.jcheck/blacklist.json&quot;;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         var blacklistFile = Path.of(blacklistOption);</span>
          var blacklist = new HashSet&lt;Hash&gt;();
          if (Files.exists(blacklistFile)) {
              var json = JSON.parse(Files.readString(blacklistFile));
              json.get(&quot;commits&quot;).stream()
                                 .map(JSONValue::asString)
                                 .map(Hash::new)
                                 .forEach(blacklist::add);
          }
  
<span class="udiff-line-modified-removed">-         var endpoint = arguments.get(&quot;census&quot;).orString(() -&gt; {</span>
<span class="udiff-line-modified-removed">-             var fallback = &quot;https://openjdk.java.net/census.xml&quot;;</span>
<span class="udiff-line-modified-removed">-             try {</span>
<span class="udiff-line-removed">-                 var config = repo.config(&quot;jcheck.census&quot;);</span>
<span class="udiff-line-removed">-                 return config.isEmpty() ? fallback : config.get(0);</span>
<span class="udiff-line-removed">-             } catch (IOException e) {</span>
<span class="udiff-line-removed">-                 return fallback;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         });</span>
<span class="udiff-line-removed">-         var census = !isURL(endpoint)</span>
<span class="udiff-line-removed">-                 ? Census.parse(Path.of(endpoint))</span>
<span class="udiff-line-removed">-                 : Census.from(URI.create(endpoint));</span>
<span class="udiff-line-removed">-         var isLocal = arguments.contains(&quot;local&quot;);</span>
<span class="udiff-line-removed">-         if (!isLocal) {</span>
<span class="udiff-line-removed">-             var lines = repo.config(&quot;jcheck.local&quot;);</span>
<span class="udiff-line-removed">-             if (lines.size() == 1) {</span>
<span class="udiff-line-removed">-                 var value = lines.get(0).toUpperCase();</span>
<span class="udiff-line-removed">-                 isLocal = value.equals(&quot;TRUE&quot;) || value.equals(&quot;1&quot;) || value.equals(&quot;ON&quot;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+         var endpoint = getOption(&quot;census&quot;, arguments);</span>
<span class="udiff-line-modified-added">+         if (endpoint == null) {</span>
<span class="udiff-line-modified-added">+             endpoint = &quot;https://openjdk.java.net/census.xml&quot;;</span>
          }
<span class="udiff-line-modified-removed">-         var isPullRequest = arguments.contains(&quot;pull-request&quot;);</span>
<span class="udiff-line-modified-removed">-         if (!isPullRequest) {</span>
<span class="udiff-line-modified-removed">-             var lines = repo.config(&quot;jcheck.pull-request&quot;);</span>
<span class="udiff-line-modified-removed">-             if (lines.size() == 1) {</span>
<span class="udiff-line-modified-removed">-                 var value = lines.get(0).toUpperCase();</span>
<span class="udiff-line-modified-removed">-                 isLocal = value.equals(&quot;TRUE&quot;) || value.equals(&quot;1&quot;) || value.equals(&quot;ON&quot;);</span>
<span class="udiff-line-modified-added">+         var census = endpoint.startsWith(&quot;http://&quot;) || endpoint.startsWith(&quot;https://&quot;) ?</span>
<span class="udiff-line-modified-added">+             Census.from(URI.create(endpoint)) :</span>
<span class="udiff-line-modified-added">+             Census.parse(Path.of(endpoint));</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         var ignore = new HashSet&lt;String&gt;();</span>
<span class="udiff-line-modified-added">+         var ignoreOption = getOption(&quot;ignore&quot;, arguments);</span>
<span class="udiff-line-added">+         if (ignoreOption != null) {</span>
<span class="udiff-line-added">+             for (var check : ignoreOption.split(&quot;,&quot;)) {</span>
<span class="udiff-line-added">+                 ignore.add(check.trim());</span>
              }
          }
<span class="udiff-line-modified-removed">-         var visitor = new JCheckCLIVisitor(isLocal, isPullRequest);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+         var visitor = new JCheckCLIVisitor(ignore);</span>
          try (var errors = JCheck.check(repo, census, CommitMessageParsers.v1, range, whitelist, blacklist)) {
              for (var error : errors) {
                  error.accept(visitor);
              }
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -193,10 +222,6 @@</span>
      }
  
      public static void main(String[] args) throws IOException {
          System.exit(run(args));
      }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static boolean isURL(String s) {</span>
<span class="udiff-line-removed">-         return urlPattern.matcher(s).matches();</span>
<span class="udiff-line-removed">-     }</span>
  }
</pre>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JCheckCLIVisitor.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>