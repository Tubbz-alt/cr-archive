<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff cli/src/main/java/org/openjdk/skara/cli/JCheckCLIVisitor.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GitJCheck.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="pr/GitPrCreate.java.udiff.html" target="_top">next &gt;</a></center>    <h2>cli/src/main/java/org/openjdk/skara/cli/JCheckCLIVisitor.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -25,124 +25,130 @@</span>
  import org.openjdk.skara.jcheck.*;
  import org.openjdk.skara.vcs.Hash;
  
  import java.util.ArrayList;
  import java.util.List;
<span class="udiff-line-added">+ import java.util.Set;</span>
  import java.util.stream.Collectors;
  
  class JCheckCLIVisitor implements IssueVisitor {
<span class="udiff-line-modified-removed">-     private final boolean isLocal;</span>
<span class="udiff-line-removed">-     private final boolean isPullRequest;</span>
<span class="udiff-line-modified-added">+     private final Set&lt;String&gt; ignore;</span>
      private boolean hasDisplayedErrors;
  
      public JCheckCLIVisitor() {
<span class="udiff-line-modified-removed">-         this(false, false);</span>
<span class="udiff-line-modified-added">+         this(Set.of());</span>
      }
  
<span class="udiff-line-modified-removed">-     public JCheckCLIVisitor(boolean isLocal, boolean isPullRequest) {</span>
<span class="udiff-line-modified-removed">-         this.isLocal = isLocal;</span>
<span class="udiff-line-removed">-         this.isPullRequest = isPullRequest;</span>
<span class="udiff-line-modified-added">+     public JCheckCLIVisitor(Set&lt;String&gt; ignore) {</span>
<span class="udiff-line-modified-added">+         this.ignore = ignore;</span>
          this.hasDisplayedErrors = false;
      }
  
<span class="udiff-line-modified-removed">-     private void println(Issue i, String message) {</span>
<span class="udiff-line-modified-removed">-         System.out.print(&quot;[&quot;);</span>
<span class="udiff-line-modified-removed">-         System.out.print(i.check().name());</span>
<span class="udiff-line-removed">-         System.out.print(&quot;] &quot;);</span>
<span class="udiff-line-removed">-         System.out.print(i.severity());</span>
<span class="udiff-line-removed">-         System.out.print(&quot;: &quot;);</span>
<span class="udiff-line-modified-added">+     private String println(Issue i, String message) {</span>
<span class="udiff-line-modified-added">+         var prefix = &quot;[&quot; + i.check().name() + &quot;] &quot; + i.severity() + &quot;: &quot;;</span>
<span class="udiff-line-modified-added">+         System.out.print(prefix);</span>
          System.out.println(message);
<span class="udiff-line-added">+         return prefix;</span>
      }
  
<span class="udiff-line-modified-removed">-     private void println(CommitIssue i, String message) {</span>
<span class="udiff-line-modified-removed">-         System.out.print(&quot;[&quot;);</span>
<span class="udiff-line-modified-removed">-         System.out.print(i.check().name());</span>
<span class="udiff-line-modified-removed">-         System.out.print(&quot;] &quot;);</span>
<span class="udiff-line-removed">-         System.out.print(i.severity());</span>
<span class="udiff-line-removed">-         System.out.print(&quot;: &quot;);</span>
<span class="udiff-line-removed">-         System.out.print(i.commit().hash().abbreviate());</span>
<span class="udiff-line-removed">-         System.out.print(&quot;: &quot;);</span>
<span class="udiff-line-modified-added">+     private String println(CommitIssue i, String message) {</span>
<span class="udiff-line-modified-added">+         var prefix = &quot;[&quot; + i.check().name() + &quot;] &quot; + i.severity() + &quot;: &quot; +</span>
<span class="udiff-line-modified-added">+                      i.commit().hash().abbreviate() + &quot;: &quot;;</span>
<span class="udiff-line-modified-added">+         System.out.print(prefix);</span>
          System.out.println(message);
<span class="udiff-line-added">+         return prefix;</span>
      }
  
      public void visit(DuplicateIssuesIssue i) {
<span class="udiff-line-modified-removed">-         var id = i.issue().id();</span>
<span class="udiff-line-modified-removed">-         var hash = i.commit().hash().abbreviate();</span>
<span class="udiff-line-modified-removed">-         var other = i.hashes()</span>
<span class="udiff-line-modified-removed">-                      .stream()</span>
<span class="udiff-line-modified-removed">-                      .map(Hash::abbreviate)</span>
<span class="udiff-line-modified-removed">-                      .map(s -&gt; &quot;         - &quot; + s)</span>
<span class="udiff-line-modified-removed">-                      .collect(Collectors.toList());</span>
<span class="udiff-line-modified-removed">-         println(i, &quot;issue id &#39;&quot; + id + &quot;&#39; in commit &quot; + hash + &quot; is already used in commits:&quot;);</span>
<span class="udiff-line-modified-removed">-         other.forEach(System.out::println);</span>
<span class="udiff-line-modified-removed">-         hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
<span class="udiff-line-modified-added">+             var id = i.issue().id();</span>
<span class="udiff-line-modified-added">+             var hash = i.commit().hash().abbreviate();</span>
<span class="udiff-line-modified-added">+             var other = i.hashes()</span>
<span class="udiff-line-modified-added">+                          .stream()</span>
<span class="udiff-line-modified-added">+                          .map(Hash::abbreviate)</span>
<span class="udiff-line-modified-added">+                          .map(s -&gt; &quot;         - &quot; + s)</span>
<span class="udiff-line-modified-added">+                          .collect(Collectors.toList());</span>
<span class="udiff-line-modified-added">+             println(i, &quot;issue id &#39;&quot; + id + &quot;&#39; in commit &quot; + hash + &quot; is already used in commits:&quot;);</span>
<span class="udiff-line-modified-added">+             other.forEach(System.out::println);</span>
<span class="udiff-line-added">+             hasDisplayedErrors = true;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      public void visit(TagIssue i) {
<span class="udiff-line-modified-removed">-         println(i, &quot;illegal tag name: &quot; + i.tag().name());</span>
<span class="udiff-line-modified-removed">-         hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
<span class="udiff-line-modified-added">+             println(i, &quot;illegal tag name: &quot; + i.tag().name());</span>
<span class="udiff-line-added">+             hasDisplayedErrors = true;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      public void visit(BranchIssue i) {
<span class="udiff-line-modified-removed">-         if (!isLocal &amp;&amp; !isPullRequest) {</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
              println(i, &quot;illegal branch name: &quot; + i.branch().name());
              hasDisplayedErrors = true;
          }
      }
  
      public void visit(SelfReviewIssue i) {
<span class="udiff-line-modified-removed">-         println(i, &quot;self-reviews are not allowed&quot;);</span>
<span class="udiff-line-modified-removed">-         hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
<span class="udiff-line-modified-added">+             println(i, &quot;self-reviews are not allowed&quot;);</span>
<span class="udiff-line-added">+             hasDisplayedErrors = true;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      public void visit(TooFewReviewersIssue i) {
<span class="udiff-line-modified-removed">-         if (!isLocal &amp;&amp; !isPullRequest) {</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
              var required = i.numRequired();
              var actual = i.numActual();
              var reviewers = required == 1 ? &quot; reviewer&quot; : &quot; reviewers&quot;;
              println(i, required + reviewers + &quot; required, found &quot; + actual);
              hasDisplayedErrors = true;
          }
      }
  
      public void visit(InvalidReviewersIssue i) {
<span class="udiff-line-modified-removed">-         if (!isLocal &amp;&amp; !isPullRequest) {</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
              var invalid = String.join(&quot;, &quot;, i.invalid());
              var wording = i.invalid().size() == 1 ? &quot; is&quot; : &quot; are&quot;;
              println(i, invalid + wording + &quot; not part of OpenJDK&quot;);
              hasDisplayedErrors = true;
          }
      }
  
      public void visit(MergeMessageIssue i) {
<span class="udiff-line-modified-removed">-         println(i, &quot;merge commits should only use the commit message &#39;&quot; + i.expected() + &quot;&#39;&quot;);</span>
<span class="udiff-line-modified-removed">-         hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
<span class="udiff-line-modified-added">+             println(i, &quot;merge commits should only use the commit message &#39;&quot; + i.expected() + &quot;&#39;&quot;);</span>
<span class="udiff-line-added">+             hasDisplayedErrors = true;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      public void visit(HgTagCommitIssue i) {
<span class="udiff-line-modified-removed">-         hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-removed">-         switch (i.error()) {</span>
<span class="udiff-line-modified-removed">-             case TOO_MANY_LINES:</span>
<span class="udiff-line-modified-removed">-                 println(i, &quot;message should only be one line&quot;);</span>
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-modified-removed">-             case BAD_FORMAT:</span>
<span class="udiff-line-modified-removed">-                 println(i, &quot;message should be of format &#39;Added tag &lt;tag&gt; for changeset &lt;hash&gt;&#39;&quot;);</span>
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-modified-removed">-             case TOO_MANY_CHANGES:</span>
<span class="udiff-line-modified-removed">-                 println(i, &quot;should only add one line to .hgtags&quot;);</span>
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-modified-removed">-             case TAG_DIFFERS:</span>
<span class="udiff-line-modified-removed">-                 println(i, &quot;tag differs in commit message and .hgtags&quot;);</span>
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
<span class="udiff-line-modified-added">+             hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+             switch (i.error()) {</span>
<span class="udiff-line-modified-added">+                 case TOO_MANY_LINES:</span>
<span class="udiff-line-modified-added">+                     println(i, &quot;message should only be one line&quot;);</span>
<span class="udiff-line-modified-added">+                     return;</span>
<span class="udiff-line-modified-added">+                 case BAD_FORMAT:</span>
<span class="udiff-line-modified-added">+                     println(i, &quot;message should be of format &#39;Added tag &lt;tag&gt; for changeset &lt;hash&gt;&#39;&quot;);</span>
<span class="udiff-line-modified-added">+                     return;</span>
<span class="udiff-line-modified-added">+                 case TOO_MANY_CHANGES:</span>
<span class="udiff-line-modified-added">+                     println(i, &quot;should only add one line to .hgtags&quot;);</span>
<span class="udiff-line-modified-added">+                     return;</span>
<span class="udiff-line-modified-added">+                 case TAG_DIFFERS:</span>
<span class="udiff-line-modified-added">+                     println(i, &quot;tag differs in commit message and .hgtags&quot;);</span>
<span class="udiff-line-added">+                     return;</span>
<span class="udiff-line-added">+             }</span>
          }
      }
  
      public void visit(CommitterIssue i) {
<span class="udiff-line-modified-removed">-         var committer = i.commit().committer().name();</span>
<span class="udiff-line-modified-removed">-         var project = i.project().name();</span>
<span class="udiff-line-modified-removed">-         println(i, committer + &quot; is not committer in project &quot; + project);</span>
<span class="udiff-line-modified-removed">-         hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
<span class="udiff-line-modified-added">+             var committer = i.commit().committer().name();</span>
<span class="udiff-line-modified-added">+             var project = i.project().name();</span>
<span class="udiff-line-modified-added">+             println(i, committer + &quot; is not committer in project &quot; + project);</span>
<span class="udiff-line-added">+             hasDisplayedErrors = true;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      private static class WhitespaceRange {
          private final WhitespaceIssue.Whitespace kind;
          private final int start;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -189,77 +195,88 @@</span>
  
          return merged;
      }
  
      public void visit(WhitespaceIssue i) {
<span class="udiff-line-modified-removed">-         var hex = i.commit().hash().abbreviate();</span>
<span class="udiff-line-modified-removed">-         var prefix = i.severity() + &quot;: &quot; + hex + &quot;: &quot;;</span>
<span class="udiff-line-modified-removed">-         var indent = prefix.replaceAll(&quot;.&quot;, &quot; &quot;);</span>
<span class="udiff-line-modified-removed">-         var pos = i.path() + &quot;:&quot; + i.row();</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         System.out.println(prefix + i.describe() + &quot; in &quot; + pos);</span>
<span class="udiff-line-modified-removed">-         System.out.println(indent + i.escapeLine());</span>
<span class="udiff-line-modified-removed">-         System.out.println(indent + i.hints());</span>
<span class="udiff-line-removed">-         hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
<span class="udiff-line-modified-added">+             var pos = i.path() + &quot;:&quot; + i.row();</span>
<span class="udiff-line-modified-added">+             var prefix = println(i, i.describe() + &quot; in &quot; + pos);</span>
<span class="udiff-line-modified-added">+             var indent = prefix.replaceAll(&quot;.&quot;, &quot; &quot;);</span>
<span class="udiff-line-modified-added">+             System.out.println(indent + i.escapeLine());</span>
<span class="udiff-line-modified-added">+             System.out.println(indent + i.hints());</span>
<span class="udiff-line-modified-added">+             hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+         }</span>
      }
  
      public void visit(MessageIssue i) {
<span class="udiff-line-modified-removed">-         if (!isPullRequest) {</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
              println(i, &quot;contains additional lines in commit message&quot;);
              for (var line : i.message().additional()) {
                  System.out.println(&quot;&gt; &quot; + line);
              }
              hasDisplayedErrors = true;
          }
      }
  
      public void visit(IssuesIssue i) {
<span class="udiff-line-modified-removed">-         if (!isPullRequest) {</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
              println(i, &quot;missing reference to JBS issue in commit message&quot;);
              for (var line : i.commit().message()) {
                  System.out.println(&quot;&gt; &quot; + line);
              }
              hasDisplayedErrors = true;
          }
      }
  
      public void visit(ExecutableIssue i) {
<span class="udiff-line-modified-removed">-         println(i, &quot;file &quot; + i.path() + &quot; is executable&quot;);</span>
<span class="udiff-line-modified-removed">-         hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
<span class="udiff-line-modified-added">+             println(i, &quot;file &quot; + i.path() + &quot; is executable&quot;);</span>
<span class="udiff-line-added">+             hasDisplayedErrors = true;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      public void visit(AuthorNameIssue i) {
<span class="udiff-line-modified-removed">-         println(i, &quot;missing author name&quot;);</span>
<span class="udiff-line-modified-removed">-         hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
<span class="udiff-line-modified-added">+             println(i, &quot;missing author name&quot;);</span>
<span class="udiff-line-added">+             hasDisplayedErrors = true;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      public void visit(AuthorEmailIssue i) {
<span class="udiff-line-modified-removed">-         println(i, &quot;missing author email&quot;);</span>
<span class="udiff-line-modified-removed">-         hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
<span class="udiff-line-modified-added">+             println(i, &quot;missing author email&quot;);</span>
<span class="udiff-line-added">+             hasDisplayedErrors = true;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      public void visit(CommitterNameIssue i) {
<span class="udiff-line-modified-removed">-         println(i, &quot;missing committer name&quot;);</span>
<span class="udiff-line-modified-removed">-         hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
<span class="udiff-line-modified-added">+             println(i, &quot;missing committer name&quot;);</span>
<span class="udiff-line-added">+             hasDisplayedErrors = true;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      public void visit(CommitterEmailIssue i) {
<span class="udiff-line-modified-removed">-         if (!isLocal &amp;&amp; !isPullRequest) {</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
              var domain = i.expectedDomain();
              println(i, &quot;missing committer email from domain &quot; + domain);
              hasDisplayedErrors = true;
          }
      }
  
      public void visit(BlacklistIssue i) {
<span class="udiff-line-modified-removed">-         println(i, &quot;commit is blacklisted&quot;);</span>
<span class="udiff-line-modified-removed">-         hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
<span class="udiff-line-modified-added">+             println(i, &quot;commit is blacklisted&quot;);</span>
<span class="udiff-line-added">+             hasDisplayedErrors = true;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      public void visit(BinaryIssue i) {
<span class="udiff-line-modified-removed">-         println(i, &quot;adds binary file: &quot; + i.path().toString());</span>
<span class="udiff-line-modified-removed">-         hasDisplayedErrors = true;</span>
<span class="udiff-line-modified-added">+         if (!ignore.contains(i.check().name())) {</span>
<span class="udiff-line-modified-added">+             println(i, &quot;adds binary file: &quot; + i.path().toString());</span>
<span class="udiff-line-added">+             hasDisplayedErrors = true;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      public boolean hasDisplayedErrors() {
          return hasDisplayedErrors;
      }
</pre>
<center><a href="GitJCheck.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="pr/GitPrCreate.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>