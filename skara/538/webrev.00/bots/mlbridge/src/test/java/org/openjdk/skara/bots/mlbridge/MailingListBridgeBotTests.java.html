<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.network.URIBuilder;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Repository;
  32 
  33 import org.junit.jupiter.api.*;
  34 
  35 import java.io.IOException;
  36 import java.nio.charset.StandardCharsets;
  37 import java.nio.file.*;
  38 import java.time.*;
  39 import java.util.*;
  40 import java.util.logging.Logger;
  41 import java.util.regex.Pattern;
  42 import java.util.stream.Collectors;
  43 
  44 import static org.junit.jupiter.api.Assertions.*;
  45 
  46 class MailingListBridgeBotTests {
  47     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  48 
  49     private Optional&lt;String&gt; archiveContents(Path archive) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return Optional.empty();
  54             }
  55             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  56         } catch (IOException e) {
  57             return Optional.empty();
  58         }
  59 
  60     }
  61 
  62     private boolean archiveContains(Path archive, String text) {
  63         return archiveContainsCount(archive, text) &gt; 0;
  64     }
  65 
  66     private int archiveContainsCount(Path archive, String text) {
  67         var lines = archiveContents(archive);
  68         if (lines.isEmpty()) {
  69             return 0;
  70         }
  71         var pattern = Pattern.compile(text);
  72         int count = 0;
  73         for (var line : lines.get().split(&quot;\\R&quot;)) {
  74             var matcher = pattern.matcher(line);
  75             if (matcher.find()) {
  76                 count++;
  77             }
  78         }
  79         return count;
  80     }
  81 
  82     private boolean webrevContains(Path webrev, String text) {
  83         try {
  84             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  85             if (index.isEmpty()) {
  86                 return false;
  87             }
  88             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  89             return lines.contains(text);
  90         } catch (IOException e) {
  91             return false;
  92         }
  93     }
  94 
  95     private long countSubstrings(String string, String substring) {
  96         return Pattern.compile(substring).matcher(string).results().count();
  97     }
  98 
  99     private String noreplyAddress(HostedRepository repository) {
 100         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
 101                 repository.forge().currentUser().userName() +
 102                 &quot;@openjdk.java.net&quot;;
 103     }
 104 
 105     @Test
 106     void simpleArchive(TestInfo testInfo) throws IOException {
 107         try (var credentials = new HostCredentials(testInfo);
 108              var tempFolder = new TemporaryDirectory();
 109              var archiveFolder = new TemporaryDirectory();
 110              var webrevFolder = new TemporaryDirectory();
 111              var listServer = new TestMailmanServer();
 112              var webrevServer = new TestWebrevServer()) {
 113             var author = credentials.getHostedRepository();
 114             var archive = credentials.getHostedRepository();
 115             var ignored = credentials.getHostedRepository();
 116             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 117             var censusBuilder = credentials.getCensusBuilder()
 118                                            .addAuthor(author.forge().currentUser().id());
 119             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 120             var mlBot = MailingListBridgeBot.newBuilder()
 121                                             .from(from)
 122                                             .repo(author)
 123                                             .archive(archive)
 124                                             .censusRepo(censusBuilder.build())
 125                                             .list(listAddress)
 126                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 127                                             .ignoredComments(Set.of())
 128                                             .listArchive(listServer.getArchive())
 129                                             .smtpServer(listServer.getSMTP())
 130                                             .webrevStorageRepository(archive)
 131                                             .webrevStorageRef(&quot;webrev&quot;)
 132                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 133                                             .webrevStorageBaseUri(webrevServer.uri())
 134                                             .readyLabels(Set.of(&quot;rfr&quot;))
 135                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 137                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 138                                             .sendInterval(Duration.ZERO)
 139                                             .build();
 140 
 141             // Populate the projects repository
 142             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 143             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 144             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 145             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 146 
 147             // Make a change with a corresponding PR
 148             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 149                                                                &quot;Change msg\n\nWith several lines&quot;);
 150             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 151             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 152             pr.setBody(&quot;This should not be ready&quot;);
 153 
 154             // Run an archive pass
 155             TestBotRunner.runPeriodicItems(mlBot);
 156 
 157             // A PR that isn&#39;t ready for review should not be archived
 158             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 159             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 160 
 161             // Flag it as ready for review
 162             pr.setBody(&quot;This should now be ready&quot;);
 163             pr.addLabel(&quot;rfr&quot;);
 164 
 165             // Run another archive pass
 166             TestBotRunner.runPeriodicItems(mlBot);
 167 
 168             // But it should still not be archived
 169             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 170             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 171 
 172             // Now post a general comment - not a ready marker
 173             var ignoredPr = ignored.pullRequest(pr.id());
 174             ignoredPr.addComment(&quot;hello there&quot;);
 175 
 176             // Run another archive pass
 177             TestBotRunner.runPeriodicItems(mlBot);
 178 
 179             // It should still not be archived
 180             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 181             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 182 
 183             // Now post a ready comment
 184             ignoredPr.addComment(&quot;ready&quot;);
 185 
 186             // Run another archive pass
 187             TestBotRunner.runPeriodicItems(mlBot);
 188 
 189             // The archive should now contain an entry
 190             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 196             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 197             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 198             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 201             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));
 202             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 203 
 204             // The mailing list as well
 205             listServer.processIncoming();
 206             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 207             var mailmanList = mailmanServer.getList(listAddress.address());
 208             var conversations = mailmanList.conversations(Duration.ofDays(1));
 209             assertEquals(1, conversations.size());
 210             var mail = conversations.get(0).first();
 211             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 212             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 213             assertEquals(noreplyAddress(archive), mail.author().address());
 214             assertEquals(listAddress, mail.sender());
 215             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 216             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 217 
 218             // And there should be a webrev
 219             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 220             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 221             var comments = pr.comments();
 222             var webrevComments = comments.stream()
 223                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 224                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 225                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 226                                          .collect(Collectors.toList());
 227             assertEquals(1, webrevComments.size());
 228 
 229             // Add a comment
 230             pr.addComment(&quot;This is a comment :smile:&quot;);
 231 
 232             // Add a comment from an ignored user as well
 233             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 234 
 235             // Run another archive pass
 236             TestBotRunner.runPeriodicItems(mlBot);
 237 
 238             // The archive should now contain the comment, but not the ignored one
 239             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 240             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 241             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 242             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 243 
 244             listServer.processIncoming();
 245             conversations = mailmanList.conversations(Duration.ofDays(1));
 246             assertEquals(1, conversations.size());
 247             assertEquals(2, conversations.get(0).allMessages().size());
 248 
 249             // Remove the rfr flag and post another comment
 250             pr.addLabel(&quot;rfr&quot;);
 251             pr.addComment(&quot;This is another comment&quot;);
 252 
 253             // Run another archive pass
 254             TestBotRunner.runPeriodicItems(mlBot);
 255 
 256             // The archive should contain the additional comment
 257             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 258             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 259             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 260 
 261             listServer.processIncoming();
 262             conversations = mailmanList.conversations(Duration.ofDays(1));
 263             assertEquals(1, conversations.size());
 264             assertEquals(3, conversations.get(0).allMessages().size());
 265             for (var newMail : conversations.get(0).allMessages()) {
 266                 assertEquals(noreplyAddress(archive), newMail.author().address());
 267                 assertEquals(listAddress, newMail.sender());
 268             }
 269             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment 😄&quot;));
 270         }
 271     }
 272 
 273     @Test
 274     void archiveIntegrated(TestInfo testInfo) throws IOException {
 275         try (var credentials = new HostCredentials(testInfo);
 276              var tempFolder = new TemporaryDirectory();
 277              var archiveFolder = new TemporaryDirectory();
 278              var webrevFolder = new TemporaryDirectory();
 279              var listServer = new TestMailmanServer();
 280              var webrevServer = new TestWebrevServer()) {
 281             var author = credentials.getHostedRepository();
 282             var archive = credentials.getHostedRepository();
 283             var ignored = credentials.getHostedRepository();
 284             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 285             var censusBuilder = credentials.getCensusBuilder()
 286                                            .addAuthor(author.forge().currentUser().id());
 287             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 288             var mlBot = MailingListBridgeBot.newBuilder()
 289                                             .from(from)
 290                                             .repo(author)
 291                                             .archive(archive)
 292                                             .censusRepo(censusBuilder.build())
 293                                             .list(listAddress)
 294                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 295                                             .listArchive(listServer.getArchive())
 296                                             .smtpServer(listServer.getSMTP())
 297                                             .webrevStorageRepository(archive)
 298                                             .webrevStorageRef(&quot;webrev&quot;)
 299                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 300                                             .webrevStorageBaseUri(webrevServer.uri())
 301                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 302                                             .build();
 303 
 304             // Populate the projects repository
 305             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 306             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 307             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 308             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 309 
 310             // Make a change with a corresponding PR
 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 312                                                                &quot;Change msg\n\nWith several lines&quot;);
 313             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 314             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 315             pr.setBody(&quot;This should not be ready&quot;);
 316             pr.setState(Issue.State.CLOSED);
 317 
 318             // Run an archive pass
 319             TestBotRunner.runPeriodicItems(mlBot);
 320             TestBotRunner.runPeriodicItems(mlBot);
 321 
 322             // A PR that isn&#39;t ready for review should not be archived
 323             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 324             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 325 
 326             // Flag it as ready for review
 327             pr.setBody(&quot;This has already been integrated&quot;);
 328             pr.addLabel(&quot;integrated&quot;);
 329 
 330             // Run another archive pass
 331             TestBotRunner.runPeriodicItems(mlBot);
 332 
 333             // The archive should now contain an entry
 334             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 335             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: FYI: 1234: This is a pull request&quot;));
 336 
 337             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 338             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 339 
 340             // Run another archive pass
 341             TestBotRunner.runPeriodicItems(mlBot);
 342 
 343             // The archive should now contain another entry
 344             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 345             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] FYI: 1234: This is a pull request&quot;));
 346         }
 347     }
 348 
 349     @Test
 350     void archiveIntegratedRetainPrefix(TestInfo testInfo) throws IOException {
 351         try (var credentials = new HostCredentials(testInfo);
 352              var tempFolder = new TemporaryDirectory();
 353              var archiveFolder = new TemporaryDirectory();
 354              var webrevFolder = new TemporaryDirectory();
 355              var listServer = new TestMailmanServer();
 356              var webrevServer = new TestWebrevServer()) {
 357             var author = credentials.getHostedRepository();
 358             var archive = credentials.getHostedRepository();
 359             var ignored = credentials.getHostedRepository();
 360             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 361             var censusBuilder = credentials.getCensusBuilder()
 362                                            .addAuthor(author.forge().currentUser().id());
 363             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 364             var mlBot = MailingListBridgeBot.newBuilder()
 365                                             .from(from)
 366                                             .repo(author)
 367                                             .archive(archive)
 368                                             .censusRepo(censusBuilder.build())
 369                                             .list(listAddress)
 370                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 371                                             .listArchive(listServer.getArchive())
 372                                             .smtpServer(listServer.getSMTP())
 373                                             .webrevStorageRepository(archive)
 374                                             .webrevStorageRef(&quot;webrev&quot;)
 375                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 376                                             .webrevStorageBaseUri(webrevServer.uri())
 377                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 378                                             .build();
 379 
 380             // Populate the projects repository
 381             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 382             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 383             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 384             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 385 
 386             // Make a change with a corresponding PR
 387             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 388                                                                &quot;Change msg\n\nWith several lines&quot;);
 389             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 390             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 391             pr.setBody(&quot;This should be ready&quot;);
 392 
 393             // Run an archive pass
 394             TestBotRunner.runPeriodicItems(mlBot);
 395             TestBotRunner.runPeriodicItems(mlBot);
 396 
 397             // A PR that isn&#39;t ready for review should not be archived
 398             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 399             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 400 
 401             // Flag it as ready for review
 402             pr.addLabel(&quot;rfr&quot;);
 403 
 404             // Run another archive pass
 405             TestBotRunner.runPeriodicItems(mlBot);
 406 
 407             // The archive should now contain an entry
 408             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 409             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 410 
 411             // Close it and then push another change
 412             pr.setState(Issue.State.CLOSED);
 413             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 414             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 415 
 416             // Run another archive pass
 417             TestBotRunner.runPeriodicItems(mlBot);
 418 
 419             // The archive should now contain another entry - should retain the RFR thread prefix
 420             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 421             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] RFR: 1234: This is a pull request&quot;));
 422         }
 423     }
 424 
 425     @Test
 426     void reviewComment(TestInfo testInfo) throws IOException {
 427         try (var credentials = new HostCredentials(testInfo);
 428              var tempFolder = new TemporaryDirectory();
 429              var archiveFolder = new TemporaryDirectory();
 430              var listServer = new TestMailmanServer();
 431              var webrevServer = new TestWebrevServer()) {
 432             var author = credentials.getHostedRepository();
 433             var archive = credentials.getHostedRepository();
 434             var ignored = credentials.getHostedRepository();
 435             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 436             var censusBuilder = credentials.getCensusBuilder()
 437                                            .addAuthor(author.forge().currentUser().id());
 438             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 439             var mlBot = MailingListBridgeBot.newBuilder()
 440                                             .from(from)
 441                                             .repo(author)
 442                                             .archive(archive)
 443                                             .censusRepo(censusBuilder.build())
 444                                             .list(listAddress)
 445                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 446                                             .listArchive(listServer.getArchive())
 447                                             .smtpServer(listServer.getSMTP())
 448                                             .webrevStorageRepository(archive)
 449                                             .webrevStorageRef(&quot;webrev&quot;)
 450                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 451                                             .webrevStorageBaseUri(webrevServer.uri())
 452                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 453                                             .build();
 454 
 455             // Populate the projects repository
 456             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 457             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 458             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 459             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 460             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 461 
 462             // Make a change with a corresponding PR
 463             var editHash = CheckableRepository.appendAndCommit(localRepo);
 464             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 465             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 466             pr.setBody(&quot;This is now ready&quot;);
 467             TestBotRunner.runPeriodicItems(mlBot);
 468             listServer.processIncoming();
 469 
 470             // And make a file specific comment
 471             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 472             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 473 
 474             // Add one from an ignored user as well
 475             var ignoredPr = ignored.pullRequest(pr.id());
 476             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 477 
 478             // Process comments
 479             TestBotRunner.runPeriodicItems(mlBot);
 480             listServer.processIncoming();
 481 
 482             // The archive should now contain an entry
 483             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 484             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 485             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 486             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 487             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 488             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 489             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 490 
 491             // The mailing list as well
 492             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 493             var mailmanList = mailmanServer.getList(listAddress.address());
 494             var conversations = mailmanList.conversations(Duration.ofDays(1));
 495             assertEquals(1, conversations.size());
 496             var mail = conversations.get(0).first();
 497             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 498 
 499             // Comment on the comment
 500             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 501             TestBotRunner.runPeriodicItems(mlBot);
 502             listServer.processIncoming();
 503 
 504             // The archive should contain the additional comment (but no quoted footers)
 505             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 506             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 507             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 508             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 509 
 510             // As well as the mailing list
 511             conversations = mailmanList.conversations(Duration.ofDays(1));
 512             assertEquals(1, conversations.size());
 513             assertEquals(3, conversations.get(0).allMessages().size());
 514             for (var newMail : conversations.get(0).allMessages()) {
 515                 assertEquals(noreplyAddress(archive), newMail.author().address());
 516                 assertEquals(listAddress, newMail.sender());
 517             }
 518         }
 519     }
 520 
 521     @Test
 522     void combineComments(TestInfo testInfo) throws IOException {
 523         try (var credentials = new HostCredentials(testInfo);
 524              var tempFolder = new TemporaryDirectory();
 525              var archiveFolder = new TemporaryDirectory();
 526              var listServer = new TestMailmanServer();
 527              var webrevServer = new TestWebrevServer()) {
 528             var author = credentials.getHostedRepository();
 529             var archive = credentials.getHostedRepository();
 530             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 531             var censusBuilder = credentials.getCensusBuilder()
 532                                            .addAuthor(author.forge().currentUser().id());
 533             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 534             var mlBot = MailingListBridgeBot.newBuilder()
 535                                             .from(from)
 536                                             .repo(author)
 537                                             .archive(archive)
 538                                             .censusRepo(censusBuilder.build())
 539                                             .list(listAddress)
 540                                             .listArchive(listServer.getArchive())
 541                                             .smtpServer(listServer.getSMTP())
 542                                             .webrevStorageRepository(archive)
 543                                             .webrevStorageRef(&quot;webrev&quot;)
 544                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 545                                             .webrevStorageBaseUri(webrevServer.uri())
 546                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 547                                             .build();
 548 
 549             // Populate the projects repository
 550             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 551             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 552             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 553             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 554             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 555 
 556             // Make a change with a corresponding PR
 557             var editHash = CheckableRepository.appendAndCommit(localRepo);
 558             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 559             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 560             pr.setBody(&quot;This is now ready&quot;);
 561             pr.addComment(&quot;Avoid combining&quot;);
 562 
 563             TestBotRunner.runPeriodicItems(mlBot);
 564             listServer.processIncoming();
 565             listServer.processIncoming();
 566 
 567             // Make several file specific comments
 568             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 569             var second = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 570             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 571             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 572             TestBotRunner.runPeriodicItems(mlBot);
 573             listServer.processIncoming();
 574 
 575             // The archive should contain a combined entry
 576             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 577             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 578 
 579             // As well as the mailing list
 580             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 581             var mailmanList = mailmanServer.getList(listAddress.address());
 582             var conversations = mailmanList.conversations(Duration.ofDays(1));
 583             assertEquals(1, conversations.size());
 584             var mail = conversations.get(0).first();
 585             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 586             assertEquals(3, conversations.get(0).allMessages().size());
 587 
 588             var commentReply = conversations.get(0).replies(mail).get(0);
 589             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 590             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 591 
 592             var reviewReply = conversations.get(0).replies(mail).get(1);
 593             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 594             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 595             assertEquals(&quot;RFR: This is a pull request&quot;, reviewReply.subject());
 596             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 597             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 598 
 599             // Now reply to the first and second (collapsed) comment
 600             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 601             pr.addReviewCommentReply(second, &quot;Not with this one though&quot;);
 602             TestBotRunner.runPeriodicItems(mlBot);
 603             listServer.processIncoming();
 604 
 605             // The archive should contain a new entry
 606             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 607             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 608 
 609             // The combined review comments should only appear unquoted once
 610             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 611         }
 612     }
 613 
 614     @Test
 615     void commentThreading(TestInfo testInfo) throws IOException {
 616         try (var credentials = new HostCredentials(testInfo);
 617              var tempFolder = new TemporaryDirectory();
 618              var archiveFolder = new TemporaryDirectory();
 619              var listServer = new TestMailmanServer();
 620              var webrevServer = new TestWebrevServer()) {
 621             var author = credentials.getHostedRepository();
 622             var reviewer = credentials.getHostedRepository();
 623             var archive = credentials.getHostedRepository();
 624             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 625             var censusBuilder = credentials.getCensusBuilder()
 626                                            .addReviewer(reviewer.forge().currentUser().id())
 627                                            .addAuthor(author.forge().currentUser().id());
 628             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 629             var mlBot = MailingListBridgeBot.newBuilder()
 630                                             .from(from)
 631                                             .repo(author)
 632                                             .archive(archive)
 633                                             .censusRepo(censusBuilder.build())
 634                                             .list(listAddress)
 635                                             .listArchive(listServer.getArchive())
 636                                             .smtpServer(listServer.getSMTP())
 637                                             .webrevStorageRepository(archive)
 638                                             .webrevStorageRef(&quot;webrev&quot;)
 639                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 640                                             .webrevStorageBaseUri(webrevServer.uri())
 641                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 642                                             .build();
 643 
 644             // Populate the projects repository
 645             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 646             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 647             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 648             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 649             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 650 
 651             // Make a change with a corresponding PR
 652             var editHash = CheckableRepository.appendAndCommit(localRepo);
 653             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 654             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 655             pr.setBody(&quot;This is now ready&quot;);
 656             TestBotRunner.runPeriodicItems(mlBot);
 657             listServer.processIncoming();
 658 
 659             // Make a file specific comment
 660             var reviewPr = reviewer.pullRequest(pr.id());
 661             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 662             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 663             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 664             TestBotRunner.runPeriodicItems(mlBot);
 665             listServer.processIncoming();
 666             listServer.processIncoming();
 667             listServer.processIncoming();
 668 
 669             // And a second one by ourselves
 670             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 671             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 672             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 673             TestBotRunner.runPeriodicItems(mlBot);
 674             listServer.processIncoming();
 675             listServer.processIncoming();
 676             listServer.processIncoming();
 677 
 678             // Finally some approvals and another comment
 679             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 680             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 681             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 682             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 683             TestBotRunner.runPeriodicItems(mlBot);
 684             listServer.processIncoming();
 685             listServer.processIncoming();
 686             listServer.processIncoming();
 687 
 688             // Sanity check the archive
 689             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 690             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 691 
 692             // File specific comments should appear after the approval
 693             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 694             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 695 
 696             // Check the mailing list
 697             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 698             var mailmanList = mailmanServer.getList(listAddress.address());
 699             var conversations = mailmanList.conversations(Duration.ofDays(1));
 700             assertEquals(1, conversations.size());
 701             var mail = conversations.get(0).first();
 702             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 703             assertEquals(10, conversations.get(0).allMessages().size());
 704 
 705             // There should be four separate threads
 706             var thread1 = conversations.get(0).replies(mail).get(0);
 707             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 708             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 709             assertEquals(&quot;RFR: This is a pull request&quot;, thread1.subject());
 710             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 711             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 712             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 713             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 714             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 715             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
 716             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 717             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 718             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 719             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 720 
 721             var thread2 = conversations.get(0).replies(mail).get(1);
 722             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 723             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 724             assertEquals(&quot;RFR: This is a pull request&quot;, thread2.subject());
 725             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 726             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 727             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 728             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 729             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 730             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 731 
 732             var replies = conversations.get(0).replies(mail);
 733             var thread3 = replies.get(2);
 734             assertEquals(&quot;RFR: This is a pull request&quot;, thread3.subject());
 735             var thread4 = replies.get(3);
 736             assertEquals(&quot;RFR: This is a pull request&quot;, thread4.subject());
 737             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 738             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 739             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 740         }
 741     }
 742 
 743     @Test
 744     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 745         try (var credentials = new HostCredentials(testInfo);
 746              var tempFolder = new TemporaryDirectory();
 747              var archiveFolder = new TemporaryDirectory();
 748              var listServer = new TestMailmanServer();
 749              var webrevServer = new TestWebrevServer()) {
 750             var author = credentials.getHostedRepository();
 751             var reviewer = credentials.getHostedRepository();
 752             var archive = credentials.getHostedRepository();
 753             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 754             var censusBuilder = credentials.getCensusBuilder()
 755                                            .addReviewer(reviewer.forge().currentUser().id())
 756                                            .addAuthor(author.forge().currentUser().id());
 757             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 758             var mlBot = MailingListBridgeBot.newBuilder()
 759                                             .from(from)
 760                                             .repo(author)
 761                                             .archive(archive)
 762                                             .censusRepo(censusBuilder.build())
 763                                             .list(listAddress)
 764                                             .listArchive(listServer.getArchive())
 765                                             .smtpServer(listServer.getSMTP())
 766                                             .webrevStorageRepository(archive)
 767                                             .webrevStorageRef(&quot;webrev&quot;)
 768                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 769                                             .webrevStorageBaseUri(webrevServer.uri())
 770                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 771                                             .build();
 772 
 773             // Populate the projects repository
 774             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 775             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 776             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 777             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 778             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 779 
 780             // Make a change with a corresponding PR
 781             var editHash = CheckableRepository.appendAndCommit(localRepo);
 782             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 783             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 784             pr.setBody(&quot;This is now ready&quot;);
 785             TestBotRunner.runPeriodicItems(mlBot);
 786             listServer.processIncoming();
 787 
 788             // Make two file specific comments
 789             var reviewPr = reviewer.pullRequest(pr.id());
 790             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 791             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 792             TestBotRunner.runPeriodicItems(mlBot);
 793             listServer.processIncoming();
 794 
 795             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 796             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
 797             TestBotRunner.runPeriodicItems(mlBot);
 798             listServer.processIncoming();
 799 
 800             // Sanity check the archive
 801             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 802             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 803         }
 804     }
 805 
 806     @Test
 807     void commentWithMention(TestInfo testInfo) throws IOException {
 808         try (var credentials = new HostCredentials(testInfo);
 809              var tempFolder = new TemporaryDirectory();
 810              var archiveFolder = new TemporaryDirectory();
 811              var listServer = new TestMailmanServer();
 812              var webrevServer = new TestWebrevServer()) {
 813             var author = credentials.getHostedRepository();
 814             var reviewer = credentials.getHostedRepository();
 815             var archive = credentials.getHostedRepository();
 816             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 817             var censusBuilder = credentials.getCensusBuilder()
 818                                            .addReviewer(reviewer.forge().currentUser().id())
 819                                            .addAuthor(author.forge().currentUser().id());
 820             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 821             var mlBot = MailingListBridgeBot.newBuilder()
 822                                             .from(from)
 823                                             .repo(author)
 824                                             .archive(archive)
 825                                             .censusRepo(censusBuilder.build())
 826                                             .list(listAddress)
 827                                             .listArchive(listServer.getArchive())
 828                                             .smtpServer(listServer.getSMTP())
 829                                             .webrevStorageRepository(archive)
 830                                             .webrevStorageRef(&quot;webrev&quot;)
 831                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 832                                             .webrevStorageBaseUri(webrevServer.uri())
 833                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 834                                             .build();
 835 
 836             // Populate the projects repository
 837             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 838             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 839             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 840             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 841             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 842 
 843             // Make a change with a corresponding PR
 844             var editHash = CheckableRepository.appendAndCommit(localRepo);
 845             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 846             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 847             pr.setBody(&quot;This is now ready&quot;);
 848             TestBotRunner.runPeriodicItems(mlBot);
 849             listServer.processIncoming();
 850 
 851             // Make two comments from different authors
 852             var reviewPr = reviewer.pullRequest(pr.id());
 853             reviewPr.addComment(&quot;First comment&quot;);
 854             pr.addComment(&quot;Second comment&quot;);
 855 
 856             TestBotRunner.runPeriodicItems(mlBot);
 857             listServer.processIncoming();
 858 
 859             pr.addComment(&quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
 860             TestBotRunner.runPeriodicItems(mlBot);
 861             listServer.processIncoming();
 862 
 863             // The first comment should be quoted more often than the second
 864             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 865             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
 866             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
 867         }
 868     }
 869 
 870     @Test
 871     void reviewCommentWithMention(TestInfo testInfo) throws IOException {
 872         try (var credentials = new HostCredentials(testInfo);
 873              var tempFolder = new TemporaryDirectory();
 874              var archiveFolder = new TemporaryDirectory();
 875              var listServer = new TestMailmanServer();
 876              var webrevServer = new TestWebrevServer()) {
 877             var author = credentials.getHostedRepository();
 878             var reviewer = credentials.getHostedRepository();
 879             var archive = credentials.getHostedRepository();
 880             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 881             var censusBuilder = credentials.getCensusBuilder()
 882                                            .addReviewer(reviewer.forge().currentUser().id())
 883                                            .addAuthor(author.forge().currentUser().id());
 884             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 885             var mlBot = MailingListBridgeBot.newBuilder()
 886                                             .from(from)
 887                                             .repo(author)
 888                                             .archive(archive)
 889                                             .censusRepo(censusBuilder.build())
 890                                             .list(listAddress)
 891                                             .listArchive(listServer.getArchive())
 892                                             .smtpServer(listServer.getSMTP())
 893                                             .webrevStorageRepository(archive)
 894                                             .webrevStorageRef(&quot;webrev&quot;)
 895                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 896                                             .webrevStorageBaseUri(webrevServer.uri())
 897                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 898                                             .build();
 899 
 900             // Populate the projects repository
 901             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 902             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 903             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 904             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 905             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 906 
 907             // Make a change with a corresponding PR
 908             var editHash = CheckableRepository.appendAndCommit(localRepo);
 909             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 910             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 911             pr.setBody(&quot;This is now ready&quot;);
 912             TestBotRunner.runPeriodicItems(mlBot);
 913             listServer.processIncoming();
 914 
 915             // Make two review comments from different authors
 916             var reviewPr = reviewer.pullRequest(pr.id());
 917             var comment = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 918             reviewPr.addReviewCommentReply(comment, &quot;First review comment&quot;);
 919             pr.addReviewCommentReply(comment, &quot;Second review comment&quot;);
 920 
 921             TestBotRunner.runPeriodicItems(mlBot);
 922             listServer.processIncoming();
 923 
 924             pr.addReviewCommentReply(comment, &quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
 925             TestBotRunner.runPeriodicItems(mlBot);
 926             listServer.processIncoming();
 927 
 928             // The first comment should be quoted more often than the second
 929             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 930             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First review comment&quot;));
 931             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second review comment&quot;));
 932         }
 933     }
 934 
 935     @Test
 936     void commentWithQuote(TestInfo testInfo) throws IOException {
 937         try (var credentials = new HostCredentials(testInfo);
 938              var tempFolder = new TemporaryDirectory();
 939              var archiveFolder = new TemporaryDirectory();
 940              var listServer = new TestMailmanServer();
 941              var webrevServer = new TestWebrevServer()) {
 942             var author = credentials.getHostedRepository();
 943             var reviewer = credentials.getHostedRepository();
 944             var archive = credentials.getHostedRepository();
 945             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 946             var censusBuilder = credentials.getCensusBuilder()
 947                                            .addReviewer(reviewer.forge().currentUser().id())
 948                                            .addAuthor(author.forge().currentUser().id());
 949             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 950             var mlBot = MailingListBridgeBot.newBuilder()
 951                                             .from(from)
 952                                             .repo(author)
 953                                             .archive(archive)
 954                                             .censusRepo(censusBuilder.build())
 955                                             .list(listAddress)
 956                                             .listArchive(listServer.getArchive())
 957                                             .smtpServer(listServer.getSMTP())
 958                                             .webrevStorageRepository(archive)
 959                                             .webrevStorageRef(&quot;webrev&quot;)
 960                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 961                                             .webrevStorageBaseUri(webrevServer.uri())
 962                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 963                                             .build();
 964 
 965             // Populate the projects repository
 966             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 967             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 968             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 969             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 970             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 971 
 972             // Make a change with a corresponding PR
 973             var editHash = CheckableRepository.appendAndCommit(localRepo);
 974             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 975             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 976             pr.setBody(&quot;This is now ready&quot;);
 977             TestBotRunner.runPeriodicItems(mlBot);
 978             listServer.processIncoming();
 979 
 980             // Make two comments from different authors
 981             var reviewPr = reviewer.pullRequest(pr.id());
 982             reviewPr.addComment(&quot;First comment\nsecond line&quot;);
 983             pr.addComment(&quot;Second comment\nfourth line&quot;);
 984 
 985             TestBotRunner.runPeriodicItems(mlBot);
 986             listServer.processIncoming();
 987 
 988             pr.addComment(&quot;&gt;First comm\n\nreply to first&quot;);
 989             TestBotRunner.runPeriodicItems(mlBot);
 990             listServer.processIncoming();
 991 
 992             // The first comment should be quoted more often than the second
 993             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 994             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
 995             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comm&quot;));
 996             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
 997         }
 998     }
 999 
1000     @Test
1001     void reviewContext(TestInfo testInfo) throws IOException {
1002         try (var credentials = new HostCredentials(testInfo);
1003              var tempFolder = new TemporaryDirectory();
1004              var archiveFolder = new TemporaryDirectory();
1005              var listServer = new TestMailmanServer();
1006              var webrevServer = new TestWebrevServer()) {
1007             var author = credentials.getHostedRepository();
1008             var archive = credentials.getHostedRepository();
1009             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1010             var censusBuilder = credentials.getCensusBuilder()
1011                                            .addAuthor(author.forge().currentUser().id());
1012             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1013             var mlBot = MailingListBridgeBot.newBuilder()
1014                                             .from(from)
1015                                             .repo(author)
1016                                             .archive(archive)
1017                                             .censusRepo(censusBuilder.build())
1018                                             .list(listAddress)
1019                                             .listArchive(listServer.getArchive())
1020                                             .smtpServer(listServer.getSMTP())
1021                                             .webrevStorageRepository(archive)
1022                                             .webrevStorageRef(&quot;webrev&quot;)
1023                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1024                                             .webrevStorageBaseUri(webrevServer.uri())
1025                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1026                                             .build();
1027 
1028             // Populate the projects repository
1029             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1030             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1031             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1032             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1033             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1034 
1035             // Make a change with a corresponding PR
1036             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1037             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1038             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1039             pr.setBody(&quot;This is now ready&quot;);
1040             TestBotRunner.runPeriodicItems(mlBot);
1041             listServer.processIncoming();
1042 
1043             // Make a file specific comment
1044             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1045 
1046             TestBotRunner.runPeriodicItems(mlBot);
1047             listServer.processIncoming();
1048 
1049             // The archive should only contain context around line 2
1050             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1051             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
1052             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
1053             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
1054         }
1055     }
1056 
1057     @Test
1058     void multipleReviewContexts(TestInfo testInfo) throws IOException {
1059         try (var credentials = new HostCredentials(testInfo);
1060              var tempFolder = new TemporaryDirectory();
1061              var archiveFolder = new TemporaryDirectory();
1062              var listServer = new TestMailmanServer();
1063              var webrevServer = new TestWebrevServer()) {
1064             var author = credentials.getHostedRepository();
1065             var archive = credentials.getHostedRepository();
1066             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1067             var censusBuilder = credentials.getCensusBuilder()
1068                                            .addAuthor(author.forge().currentUser().id());
1069             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1070             var mlBot = MailingListBridgeBot.newBuilder()
1071                                             .from(from)
1072                                             .repo(author)
1073                                             .archive(archive)
1074                                             .censusRepo(censusBuilder.build())
1075                                             .list(listAddress)
1076                                             .listArchive(listServer.getArchive())
1077                                             .smtpServer(listServer.getSMTP())
1078                                             .webrevStorageRepository(archive)
1079                                             .webrevStorageRef(&quot;webrev&quot;)
1080                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1081                                             .webrevStorageBaseUri(webrevServer.uri())
1082                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1083                                             .build();
1084 
1085             // Populate the projects repository
1086             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1087             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1088             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1089             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1090             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1091             var initialHash = CheckableRepository.appendAndCommit(localRepo,
1092                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
1093                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
1094                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
1095                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
1096                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
1097                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
1098             localRepo.push(initialHash, author.url(), &quot;master&quot;);
1099 
1100             // Make a change with a corresponding PR
1101             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
1102             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
1103             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
1104             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
1105             var editHash = CheckableRepository.appendAndCommit(localRepo);
1106             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1107             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1108             pr.setBody(&quot;This is now ready&quot;);
1109             TestBotRunner.runPeriodicItems(mlBot);
1110             listServer.processIncoming();
1111 
1112             // Make file specific comments
1113             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
1114             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
1115 
1116             TestBotRunner.runPeriodicItems(mlBot);
1117             listServer.processIncoming();
1118 
1119             // The archive should only contain context around line 2 and 20
1120             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1121             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
1122             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
1123             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
1124             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
1125 
1126             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
1127             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
1128             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
1129             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
1130         }
1131     }
1132 
1133     @Test
1134     void filterComments(TestInfo testInfo) throws IOException {
1135         try (var credentials = new HostCredentials(testInfo);
1136              var tempFolder = new TemporaryDirectory();
1137              var archiveFolder = new TemporaryDirectory();
1138              var listServer = new TestMailmanServer();
1139              var webrevServer = new TestWebrevServer()) {
1140             var author = credentials.getHostedRepository();
1141             var archive = credentials.getHostedRepository();
1142             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1143             var censusBuilder = credentials.getCensusBuilder()
1144                                            .addAuthor(author.forge().currentUser().id());
1145             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1146             var mlBot = MailingListBridgeBot.newBuilder()
1147                                             .from(from)
1148                                             .repo(author)
1149                                             .archive(archive)
1150                                             .censusRepo(censusBuilder.build())
1151                                             .list(listAddress)
1152                                             .listArchive(listServer.getArchive())
1153                                             .smtpServer(listServer.getSMTP())
1154                                             .webrevStorageRepository(archive)
1155                                             .webrevStorageRef(&quot;webrev&quot;)
1156                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1157                                             .webrevStorageBaseUri(webrevServer.uri())
1158                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1159                                             .build();
1160 
1161             // Populate the projects repository
1162             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1163             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1164             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1165             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1166             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1167 
1168             // Make a change with a corresponding PR
1169             var editHash = CheckableRepository.appendAndCommit(localRepo);
1170             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1171             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1172             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
1173                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
1174 
1175             // Make a bunch of comments
1176             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
1177             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
1178             pr.addComment(&quot;/integrate stuff&quot;);
1179             TestBotRunner.runPeriodicItems(mlBot);
1180 
1181             // Run an archive pass
1182             TestBotRunner.runPeriodicItems(mlBot);
1183 
1184             // The archive should not contain the comment
1185             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1186             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1187             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
1188             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
1189             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
1190             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
1191             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
1192             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
1193             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
1194             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
1195         }
1196     }
1197 
1198     @Test
1199     void incrementalChanges(TestInfo testInfo) throws IOException {
1200         try (var credentials = new HostCredentials(testInfo);
1201              var tempFolder = new TemporaryDirectory();
1202              var archiveFolder = new TemporaryDirectory();
1203              var listServer = new TestMailmanServer();
1204              var webrevServer = new TestWebrevServer()) {
1205             var author = credentials.getHostedRepository();
1206             var archive = credentials.getHostedRepository();
1207             var commenter = credentials.getHostedRepository();
1208             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1209             var censusBuilder = credentials.getCensusBuilder()
1210                                            .addAuthor(author.forge().currentUser().id());
1211             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1212             var mlBot = MailingListBridgeBot.newBuilder()
1213                                             .from(from)
1214                                             .repo(author)
1215                                             .archive(archive)
1216                                             .censusRepo(censusBuilder.build())
1217                                             .list(listAddress)
1218                                             .listArchive(listServer.getArchive())
1219                                             .smtpServer(listServer.getSMTP())
1220                                             .webrevStorageRepository(archive)
1221                                             .webrevStorageRef(&quot;webrev&quot;)
1222                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1223                                             .webrevStorageBaseUri(webrevServer.uri())
1224                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1225                                             .build();
1226 
1227             // Populate the projects repository
1228             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1229             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1230             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1231             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1232             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1233 
1234             // Make a change with a corresponding PR
1235             var editHash = CheckableRepository.appendAndCommit(localRepo);
1236             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1237             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1238             pr.setBody(&quot;This is now ready&quot;);
1239 
1240             // Run an archive pass
1241             TestBotRunner.runPeriodicItems(mlBot);
1242             listServer.processIncoming();
1243 
1244             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
1245             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
1246 
1247             // Make sure that the push registered
1248             var lastHeadHash = pr.headHash();
1249             var refreshCount = 0;
1250             do {
1251                 pr = author.pullRequest(pr.id());
1252                 if (refreshCount++ &gt; 100) {
1253                     fail(&quot;The PR did not update after the new push&quot;);
1254                 }
1255             } while (pr.headHash().equals(lastHeadHash));
1256 
1257             // Run another archive pass
1258             TestBotRunner.runPeriodicItems(mlBot);
1259             TestBotRunner.runPeriodicItems(mlBot);
1260             TestBotRunner.runPeriodicItems(mlBot);
1261             listServer.processIncoming();
1262 
1263             // The archive should reference the updated push
1264             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1265             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request incrementally&quot;));
1266             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
1267             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
1268             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1269             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1270             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
1271 
1272             // The webrev comment should be updated
1273             var comments = pr.comments();
1274             var webrevComments = comments.stream()
1275                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1276                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1277                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
1278                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
1279                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
1280                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1281                                          .collect(Collectors.toList());
1282             assertEquals(1, webrevComments.size());
1283 
1284             // Check that sender address is set properly
1285             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1286             var mailmanList = mailmanServer.getList(listAddress.address());
1287             var conversations = mailmanList.conversations(Duration.ofDays(1));
1288             assertEquals(1, conversations.size());
1289             for (var newMail : conversations.get(0).allMessages()) {
1290                 assertEquals(noreplyAddress(archive), newMail.author().address());
1291                 assertEquals(listAddress, newMail.sender());
1292             }
1293 
1294             // Add a comment
1295             var commenterPr = commenter.pullRequest(pr.id());
1296             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1297             TestBotRunner.runPeriodicItems(mlBot);
1298             listServer.processIncoming();
1299 
1300             // Ensure that additional updates are only reported once
1301             for (int i = 0; i &lt; 3; ++i) {
1302                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
1303                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
1304 
1305                 // Make sure that the push registered
1306                 lastHeadHash = pr.headHash();
1307                 refreshCount = 0;
1308                 do {
1309                     pr = author.pullRequest(pr.id());
1310                     if (refreshCount++ &gt; 100) {
1311                         fail(&quot;The PR did not update after the new push&quot;);
1312                     }
1313                 } while (pr.headHash().equals(lastHeadHash));
1314 
1315                 TestBotRunner.runPeriodicItems(mlBot);
1316                 TestBotRunner.runPeriodicItems(mlBot);
1317                 listServer.processIncoming();
1318             }
1319             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
1320             assertEquals(1, updatedConversations.size());
1321             var conversation = updatedConversations.get(0);
1322             assertEquals(6, conversation.allMessages().size());
1323             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
1324             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
1325             assertEquals(&quot;[Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
1326         }
1327     }
1328 
1329     @Test
1330     void rebased(TestInfo testInfo) throws IOException {
1331         try (var credentials = new HostCredentials(testInfo);
1332              var tempFolder = new TemporaryDirectory();
1333              var archiveFolder = new TemporaryDirectory();
1334              var listServer = new TestMailmanServer();
1335              var webrevServer = new TestWebrevServer()) {
1336             var author = credentials.getHostedRepository();
1337             var archive = credentials.getHostedRepository();
1338             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1339             var censusBuilder = credentials.getCensusBuilder()
1340                                            .addAuthor(author.forge().currentUser().id());
1341             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1342             var mlBot = MailingListBridgeBot.newBuilder()
1343                                             .from(sender)
1344                                             .repo(author)
1345                                             .archive(archive)
1346                                             .censusRepo(censusBuilder.build())
1347                                             .list(listAddress)
1348                                             .listArchive(listServer.getArchive())
1349                                             .smtpServer(listServer.getSMTP())
1350                                             .webrevStorageRepository(archive)
1351                                             .webrevStorageRef(&quot;webrev&quot;)
1352                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1353                                             .webrevStorageBaseUri(webrevServer.uri())
1354                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1355                                             .build();
1356 
1357             // Populate the projects repository
1358             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1359             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1360             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1361             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1362             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1363 
1364             // Make a change with a corresponding PR
1365             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1366             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1367             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1368             pr.setBody(&quot;This is now ready&quot;);
1369 
1370             // Run an archive pass
1371             TestBotRunner.runPeriodicItems(mlBot);
1372             listServer.processIncoming();
1373 
1374             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1375             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1376             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1377 
1378             // Make sure that the push registered
1379             var lastHeadHash = pr.headHash();
1380             var refreshCount = 0;
1381             do {
1382                 pr = author.pullRequest(pr.id());
1383                 if (refreshCount++ &gt; 100) {
1384                     fail(&quot;The PR did not update after the new push&quot;);
1385                 }
1386             } while (pr.headHash().equals(lastHeadHash));
1387 
1388             // Run another archive pass
1389             TestBotRunner.runPeriodicItems(mlBot);
1390             listServer.processIncoming();
1391 
1392             // The archive should reference the rebased push
1393             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1394             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1395             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1396             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1397             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1398             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1399             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1400             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1401 
1402             // The webrev comment should be updated
1403             var comments = pr.comments();
1404             var webrevComments = comments.stream()
1405                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1406                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1407                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1408                                          .collect(Collectors.toList());
1409             assertEquals(1, webrevComments.size());
1410 
1411             // Check that sender address is set properly
1412             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1413             var mailmanList = mailmanServer.getList(listAddress.address());
1414             var conversations = mailmanList.conversations(Duration.ofDays(1));
1415             assertEquals(1, conversations.size());
1416             for (var newMail : conversations.get(0).allMessages()) {
1417                 assertEquals(noreplyAddress(archive), newMail.author().address());
1418                 assertEquals(listAddress, newMail.sender());
1419                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1420             }
1421             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1422         }
1423     }
1424 
1425     @Test
1426     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1427         try (var credentials = new HostCredentials(testInfo);
1428              var tempFolder = new TemporaryDirectory();
1429              var archiveFolder = new TemporaryDirectory();
1430              var listServer = new TestMailmanServer();
1431              var webrevServer = new TestWebrevServer()) {
1432             var author = credentials.getHostedRepository();
1433             var archive = credentials.getHostedRepository();
1434             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1435             var censusBuilder = credentials.getCensusBuilder()
1436                                            .addAuthor(author.forge().currentUser().id());
1437             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1438             var mlBot = MailingListBridgeBot.newBuilder()
1439                                             .from(sender)
1440                                             .repo(author)
1441                                             .archive(archive)
1442                                             .archiveRef(&quot;archive&quot;)
1443                                             .censusRepo(censusBuilder.build())
1444                                             .list(listAddress)
1445                                             .listArchive(listServer.getArchive())
1446                                             .smtpServer(listServer.getSMTP())
1447                                             .webrevStorageRepository(archive)
1448                                             .webrevStorageRef(&quot;webrev&quot;)
1449                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1450                                             .webrevStorageBaseUri(webrevServer.uri())
1451                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1452                                             .build();
1453 
1454             // Populate the projects repository
1455             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1456             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1457             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1458             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1459             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1460             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1461 
1462             // Make a change with a corresponding PR
1463             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1464             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1465             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1466             pr.setBody(&quot;This is now ready&quot;);
1467 
1468             // Run an archive pass
1469             TestBotRunner.runPeriodicItems(mlBot);
1470             listServer.processIncoming();
1471 
1472             // Push more stuff to master
1473             localRepo.checkout(masterHash, true);
1474             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1475             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1476             localRepo.add(unrelatedFile);
1477             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1478             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1479 
1480             // And more stuff to the pr branch
1481             localRepo.checkout(editHash, true);
1482             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1483 
1484             // Merge master
1485             localRepo.merge(newMasterHash);
1486             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1487             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1488 
1489             // Make sure that the push registered
1490             var lastHeadHash = pr.headHash();
1491             var refreshCount = 0;
1492             do {
1493                 pr = author.pullRequest(pr.id());
1494                 if (refreshCount++ &gt; 100) {
1495                     fail(&quot;The PR did not update after the new push&quot;);
1496                 }
1497             } while (pr.headHash().equals(lastHeadHash));
1498 
1499             // Run another archive pass
1500             TestBotRunner.runPeriodicItems(mlBot);
1501             listServer.processIncoming();
1502 
1503             // The archive should reference the rebased push
1504             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1505             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1506             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes&quot;));
1507             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1508             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1509             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1510             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1511         }
1512     }
1513 
1514     @Test
1515     void mergeWebrev(TestInfo testInfo) throws IOException {
1516         try (var credentials = new HostCredentials(testInfo);
1517              var tempFolder = new TemporaryDirectory();
1518              var archiveFolder = new TemporaryDirectory();
1519              var listServer = new TestMailmanServer();
1520              var webrevServer = new TestWebrevServer()) {
1521             var author = credentials.getHostedRepository();
1522             var archive = credentials.getHostedRepository();
1523             var commenter = credentials.getHostedRepository();
1524             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1525             var censusBuilder = credentials.getCensusBuilder()
1526                                            .addAuthor(author.forge().currentUser().id());
1527             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1528             var mlBot = MailingListBridgeBot.newBuilder()
1529                                             .from(from)
1530                                             .repo(author)
1531                                             .archive(archive)
1532                                             .archiveRef(&quot;archive&quot;)
1533                                             .censusRepo(censusBuilder.build())
1534                                             .list(listAddress)
1535                                             .listArchive(listServer.getArchive())
1536                                             .smtpServer(listServer.getSMTP())
1537                                             .webrevStorageRepository(archive)
1538                                             .webrevStorageRef(&quot;webrev&quot;)
1539                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1540                                             .webrevStorageBaseUri(webrevServer.uri())
1541                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1542                                             .build();
1543 
1544             // Populate the projects repository
1545             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1546             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1547             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1548             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1549             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1550             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1551 
1552             // Create a merge
1553             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1554             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1555             localRepo.add(editOnlyFile);
1556             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1557             localRepo.checkout(masterHash, true);
1558             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1559             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1560             localRepo.add(masterOnlyFile);
1561             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1562             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1563             localRepo.merge(editHash, &quot;ours&quot;);
1564             var mergeCommit = localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1565             var mergeOnlyFile = Path.of(&quot;mergeonly.txt&quot;);
1566             Files.writeString(localRepo.root().resolve(mergeOnlyFile), &quot;Only added in the merge&quot;);
1567             localRepo.add(mergeOnlyFile);
1568             Files.writeString(localRepo.root().resolve(reviewFile), &quot;Overwriting the conflict resolution&quot;);
1569             localRepo.add(reviewFile);
1570             var appendedCommit = localRepo.amend(&quot;Updated merge commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1571             localRepo.push(appendedCommit, author.url(), &quot;edit&quot;, true);
1572 
1573             // Make a merge PR
1574             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1575             pr.setBody(&quot;This is now ready&quot;);
1576 
1577             // Run an archive pass
1578             TestBotRunner.runPeriodicItems(mlBot);
1579             listServer.processIncoming();
1580 
1581             // The archive should contain a merge style webrev
1582             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1583             assertTrue(archiveContains(archiveFolder.path(), &quot;webrevs contain only the adjustments&quot;));
1584             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.0&quot;));
1585             assertTrue(archiveContains(archiveFolder.path(), &quot;3 lines in 2 files changed: 1 ins; 1 del; 1 mod&quot;));
1586 
1587             // The PR should contain a webrev comment
1588             assertEquals(1, pr.comments().size());
1589             var webrevComment = pr.comments().get(0);
1590             assertTrue(webrevComment.body().contains(&quot;Merge target&quot;));
1591             assertTrue(webrevComment.body().contains(&quot;Merge source&quot;));
1592         }
1593     }
1594 
1595     @Test
1596     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1597         try (var credentials = new HostCredentials(testInfo);
1598              var tempFolder = new TemporaryDirectory();
1599              var archiveFolder = new TemporaryDirectory();
1600              var webrevFolder = new TemporaryDirectory();
1601              var listServer = new TestMailmanServer();
1602              var webrevServer = new TestWebrevServer()) {
1603             var author = credentials.getHostedRepository();
1604             var archive = credentials.getHostedRepository();
1605             var ignored = credentials.getHostedRepository();
1606             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1607             var censusBuilder = credentials.getCensusBuilder()
1608                                            .addAuthor(author.forge().currentUser().id());
1609             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1610             var mlBot = MailingListBridgeBot.newBuilder()
1611                                             .from(from)
1612                                             .repo(author)
1613                                             .archive(archive)
1614                                             .censusRepo(censusBuilder.build())
1615                                             .list(listAddress)
1616                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1617                                             .listArchive(listServer.getArchive())
1618                                             .smtpServer(listServer.getSMTP())
1619                                             .webrevStorageRepository(archive)
1620                                             .webrevStorageRef(&quot;webrev&quot;)
1621                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1622                                             .webrevStorageBaseUri(webrevServer.uri())
1623                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1624                                             .build();
1625 
1626             // Populate the projects repository
1627             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1628             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1629             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1630             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1631 
1632             // Make a change with a corresponding PR
1633             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1634                                                                &quot;Change msg\n\nWith several lines&quot;);
1635             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1636             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1637 
1638             // Flag it as ready for review
1639             pr.setBody(&quot;This should now be ready&quot;);
1640 
1641             // Run an archive pass
1642             TestBotRunner.runPeriodicItems(mlBot);
1643 
1644             // The archive should now contain an entry
1645             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1646             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
1647 
1648             // And there should be a webrev comment
1649             var comments = pr.comments();
1650             var webrevComments = comments.stream()
1651                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1652                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1653                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1654                                          .collect(Collectors.toList());
1655             assertEquals(1, webrevComments.size());
1656             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1657 
1658             // Pretend the archive didn&#39;t work out
1659             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
1660 
1661             // Run another archive pass
1662             TestBotRunner.runPeriodicItems(mlBot);
1663 
1664             // The webrev comment should not contain duplicate entries
1665             comments = pr.comments();
1666             webrevComments = comments.stream()
1667                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1668                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1669                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
1670                                      .collect(Collectors.toList());
1671             assertEquals(1, webrevComments.size());
1672             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1673         }
1674     }
1675 
1676     @Test
1677     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1678         try (var credentials = new HostCredentials(testInfo);
1679              var tempFolder = new TemporaryDirectory();
1680              var archiveFolder = new TemporaryDirectory();
1681              var listServer = new TestMailmanServer();
1682              var webrevServer = new TestWebrevServer()) {
1683             var author = credentials.getHostedRepository();
1684             var archive = credentials.getHostedRepository();
1685             var reviewer = credentials.getHostedRepository();
1686             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1687             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1688             var censusBuilder = credentials.getCensusBuilder()
1689                                            .addReviewer(reviewer.forge().currentUser().id())
1690                                            .addAuthor(author.forge().currentUser().id());
1691             var mlBot = MailingListBridgeBot.newBuilder()
1692                                             .from(from)
1693                                             .repo(author)
1694                                             .archive(archive)
1695                                             .censusRepo(censusBuilder.build())
1696                                             .list(listAddress)
1697                                             .listArchive(listServer.getArchive())
1698                                             .smtpServer(listServer.getSMTP())
1699                                             .webrevStorageRepository(archive)
1700                                             .webrevStorageRef(&quot;webrev&quot;)
1701                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1702                                             .webrevStorageBaseUri(webrevServer.uri())
1703                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1704                                             .build();
1705 
1706             // Populate the projects repository
1707             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1708             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1709             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1710             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1711             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1712 
1713             // Make a change with a corresponding PR
1714             var editHash = CheckableRepository.appendAndCommit(localRepo);
1715             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1716             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1717             pr.setBody(&quot;This is now ready&quot;);
1718 
1719             // Run an archive pass
1720             TestBotRunner.runPeriodicItems(mlBot);
1721 
1722             // First unapprove it
1723             var reviewedPr = reviewer.pullRequest(pr.id());
1724             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1725             TestBotRunner.runPeriodicItems(mlBot);
1726             TestBotRunner.runPeriodicItems(mlBot);
1727             TestBotRunner.runPeriodicItems(mlBot);
1728 
1729             // The archive should contain a note
1730             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1731             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1732             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1733             if (author.forge().supportsReviewBody()) {
1734                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1735             }
1736 
1737             // Then approve it
1738             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1739             TestBotRunner.runPeriodicItems(mlBot);
1740             TestBotRunner.runPeriodicItems(mlBot);
1741             TestBotRunner.runPeriodicItems(mlBot);
1742 
1743             // The archive should contain another note
1744             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1745             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
1746             if (author.forge().supportsReviewBody()) {
1747                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1748             }
1749             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
1750 
1751             // Yet another change
1752             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1753             TestBotRunner.runPeriodicItems(mlBot);
1754             TestBotRunner.runPeriodicItems(mlBot);
1755             TestBotRunner.runPeriodicItems(mlBot);
1756 
1757             // The archive should contain another note
1758             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1759             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1760             if (author.forge().supportsReviewBody()) {
1761                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1762             }
1763         }
1764     }
1765 
1766     @Test
1767     void ignoreComments(TestInfo testInfo) throws IOException {
1768         try (var credentials = new HostCredentials(testInfo);
1769              var tempFolder = new TemporaryDirectory();
1770              var archiveFolder = new TemporaryDirectory();
1771              var listServer = new TestMailmanServer();
1772              var webrevServer = new TestWebrevServer()) {
1773             var author = credentials.getHostedRepository();
1774             var ignored = credentials.getHostedRepository();
1775             var archive = credentials.getHostedRepository();
1776             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1777             var censusBuilder = credentials.getCensusBuilder()
1778                                            .addAuthor(author.forge().currentUser().id());
1779             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1780             var mlBot = MailingListBridgeBot.newBuilder()
1781                                             .from(from)
1782                                             .repo(author)
1783                                             .archive(archive)
1784                                             .censusRepo(censusBuilder.build())
1785                                             .list(listAddress)
1786                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1787                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
1788                                             .listArchive(listServer.getArchive())
1789                                             .smtpServer(listServer.getSMTP())
1790                                             .webrevStorageRepository(archive)
1791                                             .webrevStorageRef(&quot;webrev&quot;)
1792                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1793                                             .webrevStorageBaseUri(webrevServer.uri())
1794                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1795                                             .build();
1796 
1797             // Populate the projects repository
1798             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1799             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1800             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1801             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1802             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1803 
1804             // Make a change with a corresponding PR
1805             var editHash = CheckableRepository.appendAndCommit(localRepo);
1806             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1807             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1808             pr.setBody(&quot;This is now ready&quot;);
1809 
1810             // Make a bunch of comments
1811             pr.addComment(&quot;Plain comment&quot;);
1812             pr.addComment(&quot;ignore this comment&quot;);
1813             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1814             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1815 
1816             var ignoredPR = ignored.pullRequest(pr.id());
1817             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1818 
1819             TestBotRunner.runPeriodicItems(mlBot);
1820             TestBotRunner.runPeriodicItems(mlBot);
1821 
1822             // The archive should not contain the ignored comments
1823             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1824             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1825             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1826             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1827             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1828             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1829         }
1830     }
1831 
1832     @Test
1833     void replyToEmptyReview(TestInfo testInfo) throws IOException {
1834         try (var credentials = new HostCredentials(testInfo);
1835              var tempFolder = new TemporaryDirectory();
1836              var archiveFolder = new TemporaryDirectory();
1837              var listServer = new TestMailmanServer();
1838              var webrevServer = new TestWebrevServer()) {
1839             var author = credentials.getHostedRepository();
1840             var reviewer = credentials.getHostedRepository();
1841             var archive = credentials.getHostedRepository();
1842             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1843             var censusBuilder = credentials.getCensusBuilder()
1844                                            .addReviewer(reviewer.forge().currentUser().id())
1845                                            .addAuthor(author.forge().currentUser().id());
1846             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1847             var mlBot = MailingListBridgeBot.newBuilder()
1848                                             .from(from)
1849                                             .repo(author)
1850                                             .archive(archive)
1851                                             .censusRepo(censusBuilder.build())
1852                                             .list(listAddress)
1853                                             .listArchive(listServer.getArchive())
1854                                             .smtpServer(listServer.getSMTP())
1855                                             .webrevStorageRepository(archive)
1856                                             .webrevStorageRef(&quot;webrev&quot;)
1857                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1858                                             .webrevStorageBaseUri(webrevServer.uri())
1859                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1860                                             .build();
1861 
1862             // Populate the projects repository
1863             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1864             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1865             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1866             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1867             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1868 
1869             // Make a change with a corresponding PR
1870             var editHash = CheckableRepository.appendAndCommit(localRepo);
1871             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1872             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1873             pr.setBody(&quot;This is now ready&quot;);
1874             TestBotRunner.runPeriodicItems(mlBot);
1875             listServer.processIncoming();
1876 
1877             // Make an empty approval
1878             var reviewPr = reviewer.pullRequest(pr.id());
1879             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
1880             TestBotRunner.runPeriodicItems(mlBot);
1881             listServer.processIncoming();
1882 
1883             pr.addComment(&quot;Thanks for the review!&quot;);
1884             TestBotRunner.runPeriodicItems(mlBot);
1885             listServer.processIncoming();
1886 
1887             // The approval text should be included in the quote
1888             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1889             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
1890         }
1891     }
1892 
1893     @Test
1894     void cooldown(TestInfo testInfo) throws IOException {
1895         try (var credentials = new HostCredentials(testInfo);
1896              var tempFolder = new TemporaryDirectory();
1897              var archiveFolder = new TemporaryDirectory();
1898              var listServer = new TestMailmanServer();
1899              var webrevServer = new TestWebrevServer()) {
1900             var bot = credentials.getHostedRepository();
1901             var author = credentials.getHostedRepository();
1902             var archive = credentials.getHostedRepository();
1903             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1904             var censusBuilder = credentials.getCensusBuilder()
1905                                            .addAuthor(author.forge().currentUser().id());
1906             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1907             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1908                                                    .from(from)
1909                                                    .repo(bot)
1910                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1911                                                    .archive(archive)
1912                                                    .censusRepo(censusBuilder.build())
1913                                                    .list(listAddress)
1914                                                    .listArchive(listServer.getArchive())
1915                                                    .smtpServer(listServer.getSMTP())
1916                                                    .webrevStorageRepository(archive)
1917                                                    .webrevStorageRef(&quot;webrev&quot;)
1918                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1919                                                    .webrevStorageBaseUri(webrevServer.uri())
1920                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1921 
1922             // Populate the projects repository
1923             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1924             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1925             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1926             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1927             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1928 
1929             // Make a change with a corresponding PR
1930             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1931             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1932             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1933             pr.setBody(&quot;This is now ready&quot;);
1934 
1935             var mlBot = mlBotBuilder.build();
1936             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
1937 
1938             TestBotRunner.runPeriodicItems(mlBot);
1939             listServer.processIncoming();
1940 
1941             // Make a comment
1942             pr.addComment(&quot;Looks good&quot;);
1943 
1944             // Bot with cooldown configured should not bridge the comment
1945             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
1946             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1947 
1948             // But without, it should
1949             TestBotRunner.runPeriodicItems(mlBot);
1950             listServer.processIncoming();
1951 
1952             // Check the archive
1953             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1954             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));
1955         }
1956     }
1957 
1958     @Test
1959     void cooldownNewRevision(TestInfo testInfo) throws IOException {
1960         try (var credentials = new HostCredentials(testInfo);
1961              var tempFolder = new TemporaryDirectory();
1962              var archiveFolder = new TemporaryDirectory();
1963              var listServer = new TestMailmanServer();
1964              var webrevServer = new TestWebrevServer()) {
1965             var bot = credentials.getHostedRepository();
1966             var author = credentials.getHostedRepository();
1967             var archive = credentials.getHostedRepository();
1968             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1969             var censusBuilder = credentials.getCensusBuilder()
1970                                            .addAuthor(author.forge().currentUser().id());
1971             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1972             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1973                                                    .from(from)
1974                                                    .repo(bot)
1975                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1976                                                    .archive(archive)
1977                                                    .censusRepo(censusBuilder.build())
1978                                                    .list(listAddress)
1979                                                    .listArchive(listServer.getArchive())
1980                                                    .smtpServer(listServer.getSMTP())
1981                                                    .webrevStorageRepository(archive)
1982                                                    .webrevStorageRef(&quot;webrev&quot;)
1983                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1984                                                    .webrevStorageBaseUri(webrevServer.uri())
1985                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1986 
1987             // Populate the projects repository
1988             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1989             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1990             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1991             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1992             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1993 
1994             // Make a change with a corresponding PR
1995             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1996             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1997             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1998             pr.setBody(&quot;This is now ready&quot;);
1999 
2000             var mlBot = mlBotBuilder.build();
2001             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2002 
2003             TestBotRunner.runPeriodicItems(mlBot);
2004             listServer.processIncoming();
2005 
2006             // Commit another revision
2007             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
2008             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
2009 
2010             // Bot with cooldown configured should not create a new webrev
2011             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2012             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2013 
2014             // But without, it should
2015             TestBotRunner.runPeriodicItems(mlBot);
2016             listServer.processIncoming();
2017 
2018             // Check the archive
2019             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2020             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.01&quot;));
2021         }
2022     }
2023 
2024     @Test
2025     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2026         try (var credentials = new HostCredentials(testInfo);
2027              var tempFolder = new TemporaryDirectory();
2028              var archiveFolder = new TemporaryDirectory();
2029              var listServer = new TestMailmanServer();
2030              var webrevServer = new TestWebrevServer()) {
2031             var bot = credentials.getHostedRepository();
2032             var author = credentials.getHostedRepository();
2033             var archive = credentials.getHostedRepository();
2034             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2035             var censusBuilder = credentials.getCensusBuilder()
2036                                            .addAuthor(author.forge().currentUser().id());
2037             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2038             var cooldown = Duration.ofMillis(500);
2039             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2040                                                    .from(from)
2041                                                    .repo(bot)
2042                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2043                                                    .archive(archive)
2044                                                    .censusRepo(censusBuilder.build())
2045                                                    .list(listAddress)
2046                                                    .listArchive(listServer.getArchive())
2047                                                    .smtpServer(listServer.getSMTP())
2048                                                    .webrevStorageRepository(archive)
2049                                                    .webrevStorageRef(&quot;webrev&quot;)
2050                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2051                                                    .webrevStorageBaseUri(webrevServer.uri())
2052                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2053 
2054             // Populate the projects repository
2055             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2056             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2057             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2058             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2059             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2060 
2061             // Make a change with a corresponding PR
2062             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2063             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2064             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2065             pr.setBody(&quot;This is now ready&quot;);
2066 
2067             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2068             Thread.sleep(cooldown.toMillis());
2069             TestBotRunner.runPeriodicItems(mlBot);
2070             listServer.processIncoming();
2071 
2072             // Make a comment and run the check within the cooldown period
2073             int counter;
2074             boolean noMailReceived = false;
2075             for (counter = 1; counter &lt; 10; ++counter) {
2076                 var start = Instant.now();
2077                 pr.addComment(&quot;Looks good - &quot; + counter + &quot; -&quot;);
2078 
2079                 // The bot should not bridge the comment due to cooldown
2080                 TestBotRunner.runPeriodicItems(mlBot);
2081                 try {
2082                     noMailReceived = false;
2083                     listServer.processIncoming(Duration.ofMillis(1));
2084                 } catch (RuntimeException e) {
2085                     noMailReceived = true;
2086                 }
2087                 var elapsed = Duration.between(start, Instant.now());
2088                 if (elapsed.compareTo(cooldown) &lt; 0) {
2089                     break;
2090                 } else {
2091                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2092                     // Ensure that the cooldown expires
2093                     Thread.sleep(cooldown.toMillis());
2094                     // If no mail was received, we have to flush it out
2095                     if (noMailReceived) {
2096                         TestBotRunner.runPeriodicItems(mlBot);
2097                         listServer.processIncoming();
2098                     }
2099                     cooldown = cooldown.multipliedBy(2);
2100                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2101                 }
2102             }
2103             assertTrue(noMailReceived);
2104 
2105             // But after the cooldown period has passed, it should
2106             Thread.sleep(cooldown.toMillis());
2107             TestBotRunner.runPeriodicItems(mlBot);
2108             listServer.processIncoming();
2109 
2110             // Check the archive
2111             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2112             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good - &quot; + counter + &quot; -&quot;));
2113         }
2114     }
2115 
2116     @Test
2117     void branchPrefix(TestInfo testInfo) throws IOException {
2118         try (var credentials = new HostCredentials(testInfo);
2119              var tempFolder = new TemporaryDirectory();
2120              var archiveFolder = new TemporaryDirectory();
2121              var listServer = new TestMailmanServer();
2122              var webrevServer = new TestWebrevServer()) {
2123             var author = credentials.getHostedRepository();
2124             var archive = credentials.getHostedRepository();
2125             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2126             var censusBuilder = credentials.getCensusBuilder()
2127                                            .addAuthor(author.forge().currentUser().id());
2128             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2129             var mlBot = MailingListBridgeBot.newBuilder()
2130                                             .from(from)
2131                                             .repo(author)
2132                                             .archive(archive)
2133                                             .censusRepo(censusBuilder.build())
2134                                             .list(listAddress)
2135                                             .listArchive(listServer.getArchive())
2136                                             .smtpServer(listServer.getSMTP())
2137                                             .webrevStorageRepository(archive)
2138                                             .webrevStorageRef(&quot;webrev&quot;)
2139                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2140                                             .webrevStorageBaseUri(webrevServer.uri())
2141                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2142                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2143                                             .build();
2144 
2145             // Populate the projects repository
2146             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2147             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2148             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2149             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2150 
2151             // Make a change with a corresponding PR
2152             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2153                                                                &quot;Change msg\n\nWith several lines&quot;);
2154             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2155             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2156             pr.setBody(&quot;This is a PR&quot;);
2157 
2158             // Run an archive pass
2159             TestBotRunner.runPeriodicItems(mlBot);
2160             listServer.processIncoming();
2161 
2162             pr.addComment(&quot;Looks good!&quot;);
2163             TestBotRunner.runPeriodicItems(mlBot);
2164             listServer.processIncoming();
2165 
2166             // Check the archive
2167             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2168             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[master\\] RFR: &quot;));
2169             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[master\\] RFR: &quot;));
2170         }
2171     }
2172 
2173     @Test
2174     void repoPrefix(TestInfo testInfo) throws IOException {
2175         try (var credentials = new HostCredentials(testInfo);
2176              var tempFolder = new TemporaryDirectory();
2177              var archiveFolder = new TemporaryDirectory();
2178              var listServer = new TestMailmanServer();
2179              var webrevServer = new TestWebrevServer()) {
2180             var author = credentials.getHostedRepository();
2181             var archive = credentials.getHostedRepository();
2182             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2183             var censusBuilder = credentials.getCensusBuilder()
2184                                            .addAuthor(author.forge().currentUser().id());
2185             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2186             var mlBot = MailingListBridgeBot.newBuilder()
2187                                             .from(from)
2188                                             .repo(author)
2189                                             .archive(archive)
2190                                             .censusRepo(censusBuilder.build())
2191                                             .list(listAddress)
2192                                             .listArchive(listServer.getArchive())
2193                                             .smtpServer(listServer.getSMTP())
2194                                             .webrevStorageRepository(archive)
2195                                             .webrevStorageRef(&quot;webrev&quot;)
2196                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2197                                             .webrevStorageBaseUri(webrevServer.uri())
2198                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2199                                             .repoInSubject(true)
2200                                             .build();
2201 
2202             // Populate the projects repository
2203             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2204             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2205             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2206             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2207 
2208             // Make a change with a corresponding PR
2209             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2210                                                                &quot;Change msg\n\nWith several lines&quot;);
2211             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2212             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2213             pr.setBody(&quot;This is a PR&quot;);
2214 
2215             // Run an archive pass
2216             TestBotRunner.runPeriodicItems(mlBot);
2217             listServer.processIncoming();
2218 
2219             pr.addComment(&quot;Looks good!&quot;);
2220             TestBotRunner.runPeriodicItems(mlBot);
2221             listServer.processIncoming();
2222 
2223             // Check the archive
2224             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2225             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2226             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2227         }
2228     }
2229 
2230     @Test
2231     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2232         try (var credentials = new HostCredentials(testInfo);
2233              var tempFolder = new TemporaryDirectory();
2234              var archiveFolder = new TemporaryDirectory();
2235              var listServer = new TestMailmanServer();
2236              var webrevServer = new TestWebrevServer()) {
2237             var author = credentials.getHostedRepository();
2238             var archive = credentials.getHostedRepository();
2239             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2240             var censusBuilder = credentials.getCensusBuilder()
2241                                            .addAuthor(author.forge().currentUser().id());
2242             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2243             var mlBot = MailingListBridgeBot.newBuilder()
2244                                             .from(from)
2245                                             .repo(author)
2246                                             .archive(archive)
2247                                             .censusRepo(censusBuilder.build())
2248                                             .list(listAddress)
2249                                             .listArchive(listServer.getArchive())
2250                                             .smtpServer(listServer.getSMTP())
2251                                             .webrevStorageRepository(archive)
2252                                             .webrevStorageRef(&quot;webrev&quot;)
2253                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2254                                             .webrevStorageBaseUri(webrevServer.uri())
2255                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2256                                             .repoInSubject(true)
2257                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2258                                             .build();
2259 
2260             // Populate the projects repository
2261             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2262             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2263             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2264             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2265 
2266             // Make a change with a corresponding PR
2267             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2268                                                                &quot;Change msg\n\nWith several lines&quot;);
2269             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2270             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2271             pr.setBody(&quot;This is a PR&quot;);
2272 
2273             // Run an archive pass
2274             TestBotRunner.runPeriodicItems(mlBot);
2275             listServer.processIncoming();
2276 
2277             pr.addComment(&quot;Looks good!&quot;);
2278             TestBotRunner.runPeriodicItems(mlBot);
2279             listServer.processIncoming();
2280 
2281             // Check the archive
2282             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2283             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2284             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2285         }
2286     }
2287 
2288     @Test
2289     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2290         try (var credentials = new HostCredentials(testInfo);
2291              var tempFolder = new TemporaryDirectory();
2292              var archiveFolder = new TemporaryDirectory();
2293              var listServer = new TestMailmanServer();
2294              var webrevServer = new TestWebrevServer()) {
2295             var bot = credentials.getHostedRepository();
2296             var author = credentials.getHostedRepository();
2297             var archive = credentials.getHostedRepository();
2298             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2299             var censusBuilder = credentials.getCensusBuilder()
2300                                            .addAuthor(author.forge().currentUser().id());
2301             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2302             var cooldown = Duration.ofMillis(500);
2303             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2304                                                    .from(from)
2305                                                    .repo(bot)
2306                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2307                                                    .archive(archive)
2308                                                    .censusRepo(censusBuilder.build())
2309                                                    .list(listAddress)
2310                                                    .listArchive(listServer.getArchive())
2311                                                    .smtpServer(listServer.getSMTP())
2312                                                    .webrevStorageRepository(archive)
2313                                                    .webrevStorageRef(&quot;webrev&quot;)
2314                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2315                                                    .webrevStorageBaseUri(webrevServer.uri())
2316                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2317 
2318             // Populate the projects repository
2319             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2320             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2321             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2322             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2323             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2324 
2325             // Make a change with a corresponding PR
2326             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2327             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2328             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2329             pr.setBody(&quot;This is now ready&quot;);
2330 
2331             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2332             Thread.sleep(cooldown.toMillis());
2333             TestBotRunner.runPeriodicItems(mlBot);
2334             listServer.processIncoming();
2335 
2336             // Make a new revision and run the check within the cooldown period
2337             int counter;
2338             boolean noMailReceived = false;
2339             for (counter = 1; counter &lt; 10; ++counter) {
2340                 var start = Instant.now();
2341                 var revHash = CheckableRepository.appendAndCommit(localRepo, &quot;more stuff&quot;, &quot;Update number - &quot; + counter + &quot; -&quot;);
2342                 localRepo.push(revHash, author.url(), &quot;edit&quot;);
2343 
2344                 // The bot should not bridge the new revision due to cooldown
2345                 TestBotRunner.runPeriodicItems(mlBot);
2346                 try {
2347                     noMailReceived = false;
2348                     listServer.processIncoming(Duration.ofMillis(1));
2349                 } catch (RuntimeException e) {
2350                     noMailReceived = true;
2351                 }
2352                 var elapsed = Duration.between(start, Instant.now());
2353                 if (elapsed.compareTo(cooldown) &lt; 0) {
2354                     break;
2355                 } else {
2356                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2357                     // Ensure that the cooldown expires
2358                     Thread.sleep(cooldown.toMillis());
2359                     // If no mail was received, we have to flush it out
2360                     if (noMailReceived) {
2361                         TestBotRunner.runPeriodicItems(mlBot);
2362                         listServer.processIncoming();
2363                     }
2364                     cooldown = cooldown.multipliedBy(2);
2365                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2366                 }
2367             }
2368             assertTrue(noMailReceived);
2369 
2370             // But after the cooldown period has passed, it should
2371             Thread.sleep(cooldown.toMillis());
2372             TestBotRunner.runPeriodicItems(mlBot);
2373             listServer.processIncoming();
2374 
2375             // Check the archive
2376             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2377             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
2378         }
2379     }
2380 }
    </pre>
  </body>
</html>