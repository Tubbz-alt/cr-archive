<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../test/src/main/java/org/openjdk/skara/test/TestHost.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;

  27 import org.openjdk.skara.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.*;
  38 import java.util.*;
  39 import java.util.logging.Logger;
  40 import java.util.regex.Pattern;
  41 import java.util.stream.Collectors;
  42 
  43 import static org.junit.jupiter.api.Assertions.*;
  44 
  45 class MailingListBridgeBotTests {
  46     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
</pre>
<hr />
<pre>
 252             // Run another archive pass
 253             TestBotRunner.runPeriodicItems(mlBot);
 254 
 255             // The archive should contain the additional comment
 256             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 257             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 258             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 259 
 260             listServer.processIncoming();
 261             conversations = mailmanList.conversations(Duration.ofDays(1));
 262             assertEquals(1, conversations.size());
 263             assertEquals(3, conversations.get(0).allMessages().size());
 264             for (var newMail : conversations.get(0).allMessages()) {
 265                 assertEquals(noreplyAddress(archive), newMail.author().address());
 266                 assertEquals(listAddress, newMail.sender());
 267             }
 268             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 269         }
 270     }
 271 

























































































































































 272     @Test
 273     void reviewComment(TestInfo testInfo) throws IOException {
 274         try (var credentials = new HostCredentials(testInfo);
 275              var tempFolder = new TemporaryDirectory();
 276              var archiveFolder = new TemporaryDirectory();
 277              var listServer = new TestMailmanServer();
 278              var webrevServer = new TestWebrevServer()) {
 279             var author = credentials.getHostedRepository();
 280             var archive = credentials.getHostedRepository();
 281             var ignored = credentials.getHostedRepository();
 282             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 283             var censusBuilder = credentials.getCensusBuilder()
 284                                            .addAuthor(author.forge().currentUser().id());
 285             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 286             var mlBot = MailingListBridgeBot.newBuilder()
 287                                             .from(from)
 288                                             .repo(author)
 289                                             .archive(archive)
 290                                             .censusRepo(censusBuilder.build())
 291                                             .list(listAddress)
</pre>
</td>
<td>
<hr />
<pre>
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
<span class="line-added">  27 import org.openjdk.skara.issuetracker.Issue;</span>
  28 import org.openjdk.skara.network.URIBuilder;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Repository;
  32 
  33 import org.junit.jupiter.api.*;
  34 
  35 import java.io.IOException;
  36 import java.nio.charset.StandardCharsets;
  37 import java.nio.file.*;
  38 import java.time.*;
  39 import java.util.*;
  40 import java.util.logging.Logger;
  41 import java.util.regex.Pattern;
  42 import java.util.stream.Collectors;
  43 
  44 import static org.junit.jupiter.api.Assertions.*;
  45 
  46 class MailingListBridgeBotTests {
  47     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
</pre>
<hr />
<pre>
 253             // Run another archive pass
 254             TestBotRunner.runPeriodicItems(mlBot);
 255 
 256             // The archive should contain the additional comment
 257             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 258             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 259             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 260 
 261             listServer.processIncoming();
 262             conversations = mailmanList.conversations(Duration.ofDays(1));
 263             assertEquals(1, conversations.size());
 264             assertEquals(3, conversations.get(0).allMessages().size());
 265             for (var newMail : conversations.get(0).allMessages()) {
 266                 assertEquals(noreplyAddress(archive), newMail.author().address());
 267                 assertEquals(listAddress, newMail.sender());
 268             }
 269             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 270         }
 271     }
 272 
<span class="line-added"> 273     @Test</span>
<span class="line-added"> 274     void archiveIntegrated(TestInfo testInfo) throws IOException {</span>
<span class="line-added"> 275         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added"> 276              var tempFolder = new TemporaryDirectory();</span>
<span class="line-added"> 277              var archiveFolder = new TemporaryDirectory();</span>
<span class="line-added"> 278              var webrevFolder = new TemporaryDirectory();</span>
<span class="line-added"> 279              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 280              var webrevServer = new TestWebrevServer()) {</span>
<span class="line-added"> 281             var author = credentials.getHostedRepository();</span>
<span class="line-added"> 282             var archive = credentials.getHostedRepository();</span>
<span class="line-added"> 283             var ignored = credentials.getHostedRepository();</span>
<span class="line-added"> 284             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-added"> 285             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added"> 286                                            .addAuthor(author.forge().currentUser().id());</span>
<span class="line-added"> 287             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);</span>
<span class="line-added"> 288             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-added"> 289                                             .from(from)</span>
<span class="line-added"> 290                                             .repo(author)</span>
<span class="line-added"> 291                                             .archive(archive)</span>
<span class="line-added"> 292                                             .censusRepo(censusBuilder.build())</span>
<span class="line-added"> 293                                             .list(listAddress)</span>
<span class="line-added"> 294                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))</span>
<span class="line-added"> 295                                             .listArchive(listServer.getArchive())</span>
<span class="line-added"> 296                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-added"> 297                                             .webrevStorageRepository(archive)</span>
<span class="line-added"> 298                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added"> 299                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added"> 300                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added"> 301                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added"> 302                                             .build();</span>
<span class="line-added"> 303 </span>
<span class="line-added"> 304             // Populate the projects repository</span>
<span class="line-added"> 305             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
<span class="line-added"> 306             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added"> 307             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-added"> 308             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
<span class="line-added"> 309 </span>
<span class="line-added"> 310             // Make a change with a corresponding PR</span>
<span class="line-added"> 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,</span>
<span class="line-added"> 312                                                                &quot;Change msg\n\nWith several lines&quot;);</span>
<span class="line-added"> 313             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-added"> 314             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);</span>
<span class="line-added"> 315             pr.setBody(&quot;This should not be ready&quot;);</span>
<span class="line-added"> 316             pr.setState(Issue.State.CLOSED);</span>
<span class="line-added"> 317 </span>
<span class="line-added"> 318             // Run an archive pass</span>
<span class="line-added"> 319             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 320             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 321 </span>
<span class="line-added"> 322             // A PR that isn&#39;t ready for review should not be archived</span>
<span class="line-added"> 323             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added"> 324             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));</span>
<span class="line-added"> 325 </span>
<span class="line-added"> 326             // Flag it as ready for review</span>
<span class="line-added"> 327             pr.setBody(&quot;This has already been integrated&quot;);</span>
<span class="line-added"> 328             pr.addLabel(&quot;integrated&quot;);</span>
<span class="line-added"> 329 </span>
<span class="line-added"> 330             // Run another archive pass</span>
<span class="line-added"> 331             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 332 </span>
<span class="line-added"> 333             // The archive should now contain an entry</span>
<span class="line-added"> 334             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added"> 335             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: FYI: 1234: This is a pull request&quot;));</span>
<span class="line-added"> 336 </span>
<span class="line-added"> 337             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);</span>
<span class="line-added"> 338             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);</span>
<span class="line-added"> 339 </span>
<span class="line-added"> 340             // Run another archive pass</span>
<span class="line-added"> 341             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 342 </span>
<span class="line-added"> 343             // The archive should now contain another entry</span>
<span class="line-added"> 344             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added"> 345             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] FYI: 1234: This is a pull request&quot;));</span>
<span class="line-added"> 346         }</span>
<span class="line-added"> 347     }</span>
<span class="line-added"> 348 </span>
<span class="line-added"> 349     @Test</span>
<span class="line-added"> 350     void archiveIntegratedRetainPrefix(TestInfo testInfo) throws IOException {</span>
<span class="line-added"> 351         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added"> 352              var tempFolder = new TemporaryDirectory();</span>
<span class="line-added"> 353              var archiveFolder = new TemporaryDirectory();</span>
<span class="line-added"> 354              var webrevFolder = new TemporaryDirectory();</span>
<span class="line-added"> 355              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 356              var webrevServer = new TestWebrevServer()) {</span>
<span class="line-added"> 357             var author = credentials.getHostedRepository();</span>
<span class="line-added"> 358             var archive = credentials.getHostedRepository();</span>
<span class="line-added"> 359             var ignored = credentials.getHostedRepository();</span>
<span class="line-added"> 360             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-added"> 361             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added"> 362                                            .addAuthor(author.forge().currentUser().id());</span>
<span class="line-added"> 363             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);</span>
<span class="line-added"> 364             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-added"> 365                                             .from(from)</span>
<span class="line-added"> 366                                             .repo(author)</span>
<span class="line-added"> 367                                             .archive(archive)</span>
<span class="line-added"> 368                                             .censusRepo(censusBuilder.build())</span>
<span class="line-added"> 369                                             .list(listAddress)</span>
<span class="line-added"> 370                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))</span>
<span class="line-added"> 371                                             .listArchive(listServer.getArchive())</span>
<span class="line-added"> 372                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-added"> 373                                             .webrevStorageRepository(archive)</span>
<span class="line-added"> 374                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added"> 375                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added"> 376                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added"> 377                                             .readyLabels(Set.of(&quot;rfr&quot;))</span>
<span class="line-added"> 378                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added"> 379                                             .build();</span>
<span class="line-added"> 380 </span>
<span class="line-added"> 381             // Populate the projects repository</span>
<span class="line-added"> 382             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
<span class="line-added"> 383             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added"> 384             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-added"> 385             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
<span class="line-added"> 386 </span>
<span class="line-added"> 387             // Make a change with a corresponding PR</span>
<span class="line-added"> 388             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,</span>
<span class="line-added"> 389                                                                &quot;Change msg\n\nWith several lines&quot;);</span>
<span class="line-added"> 390             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-added"> 391             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);</span>
<span class="line-added"> 392             pr.setBody(&quot;This should be ready&quot;);</span>
<span class="line-added"> 393 </span>
<span class="line-added"> 394             // Run an archive pass</span>
<span class="line-added"> 395             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 396             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 397 </span>
<span class="line-added"> 398             // A PR that isn&#39;t ready for review should not be archived</span>
<span class="line-added"> 399             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added"> 400             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));</span>
<span class="line-added"> 401 </span>
<span class="line-added"> 402             // Flag it as ready for review</span>
<span class="line-added"> 403             pr.addLabel(&quot;rfr&quot;);</span>
<span class="line-added"> 404 </span>
<span class="line-added"> 405             // Run another archive pass</span>
<span class="line-added"> 406             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 407 </span>
<span class="line-added"> 408             // The archive should now contain an entry</span>
<span class="line-added"> 409             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added"> 410             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));</span>
<span class="line-added"> 411 </span>
<span class="line-added"> 412             // Close it and then push another change</span>
<span class="line-added"> 413             pr.setState(Issue.State.CLOSED);</span>
<span class="line-added"> 414             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);</span>
<span class="line-added"> 415             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);</span>
<span class="line-added"> 416 </span>
<span class="line-added"> 417             // Run another archive pass</span>
<span class="line-added"> 418             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 419 </span>
<span class="line-added"> 420             // The archive should now contain another entry - should retain the RFR thread prefix</span>
<span class="line-added"> 421             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added"> 422             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] RFR: 1234: This is a pull request&quot;));</span>
<span class="line-added"> 423         }</span>
<span class="line-added"> 424     }</span>
<span class="line-added"> 425 </span>
 426     @Test
 427     void reviewComment(TestInfo testInfo) throws IOException {
 428         try (var credentials = new HostCredentials(testInfo);
 429              var tempFolder = new TemporaryDirectory();
 430              var archiveFolder = new TemporaryDirectory();
 431              var listServer = new TestMailmanServer();
 432              var webrevServer = new TestWebrevServer()) {
 433             var author = credentials.getHostedRepository();
 434             var archive = credentials.getHostedRepository();
 435             var ignored = credentials.getHostedRepository();
 436             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 437             var censusBuilder = credentials.getCensusBuilder()
 438                                            .addAuthor(author.forge().currentUser().id());
 439             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 440             var mlBot = MailingListBridgeBot.newBuilder()
 441                                             .from(from)
 442                                             .repo(author)
 443                                             .archive(archive)
 444                                             .censusRepo(censusBuilder.build())
 445                                             .list(listAddress)
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../test/src/main/java/org/openjdk/skara/test/TestHost.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>