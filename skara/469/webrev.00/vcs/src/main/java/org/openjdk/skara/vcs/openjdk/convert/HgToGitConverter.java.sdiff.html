<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/main/java/org/openjdk/skara/vcs/openjdk/convert/HgToGitConverter.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GitToHgConverter.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../test/java/org/openjdk/skara/vcs/RepositoryTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>vcs/src/main/java/org/openjdk/skara/vcs/openjdk/convert/HgToGitConverter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
335 
336         return new GitCommitMetadata(gitMark, gitParentMarks, gitAuthor, gitCommitter, gitBranch, gitDate, gitMessage);
337     }
338 
339     private List&lt;Hash&gt; convertCommits(Pipe pipe) throws IOException {
340         var tagCommits = new ArrayList&lt;Hash&gt;();
341         while (pipe.read() != -1) {
342             pipe.readln(); // skip delimiter
343             var hash = new Hash(pipe.readln());
344             log.fine(&quot;Converting: &quot; + hash.hex());
345             pipe.readln(); // skip revision number
346             var branch = new Branch(pipe.readln());
347             log.finer(&quot;Branch: &quot; + branch.name());
348 
349             var parents = pipe.readln();
350             log.finer(&quot;Parents: &quot; + parents);
351             var parentHashes = Arrays.asList(parents.split(&quot; &quot;))
352                                      .stream()
353                                      .map(Hash::new)
354                                      .collect(Collectors.toList());
<span class="line-modified">355             if (parentHashes.size() == 1 &amp;&amp; parentHashes.get(0).equals(new Hash(&quot;0&quot;.repeat(40)))) {</span>
356                 parentHashes = new ArrayList&lt;Hash&gt;();
357             }
358             pipe.readln(); // skip parent revisions
359 
360             var author = Author.fromString(pipe.readln());
361             log.finer(&quot;Author: &quot; + author.toString());
362 
363             var formatter = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd H:m:sZ&quot;);
364             var date = ZonedDateTime.parse(pipe.readln(), formatter);
365             log.finer(&quot;Date: &quot; + date.toString());
366 
367             var messageSize = parseInt(pipe.readln());
368             var messageBuffer = pipe.read(messageSize);
369             var hgMessage = new String(messageBuffer, 0, messageSize, StandardCharsets.UTF_8);
370             log.finest(&quot;Message: &quot; + hgMessage);
371 
372             var metadata = convertMetadata(hash,
373                                            branch,
374                                            author,
375                                            parentHashes,
</pre>
<hr />
<pre>
464         return tagCommits;
465     }
466 
467     private void convertTags(Pipe pipe, List&lt;Hash&gt; tagCommits, ReadOnlyRepository hgRepo) throws IOException {
468         var tags = new HashMap&lt;String, Commit&gt;();
469         for (var tagHash : tagCommits) {
470             log.fine(&quot;Inspecting tag commit &quot; + tagHash.toString());
471             var commit = hgRepo.lookup(tagHash).orElseThrow(() -&gt; new IOException(&quot;Could not find commit &quot; + tagHash));
472             var diff = commit.parentDiffs().get(0); // convert never returns merge commits
473             for (var patch : diff.patches()) {
474                 var target = patch.target().path();
475                 if (target.isPresent() &amp;&amp; target.get().equals(Path.of(&quot;.hgtags&quot;))) {
476                     for (var hunk : patch.asTextualPatch().hunks()) {
477                         for (var line : hunk.target().lines()) {
478                             if (line.isEmpty()) {
479                                 continue;
480                             }
481                             var parts = line.split(&quot; &quot;);
482                             var hash = parts[0];
483                             var tag = parts[1];
<span class="line-modified">484                             if (hash.equals(&quot;0&quot;.repeat(40))) {</span>
485                                 tags.remove(tag);
486                             } else {
487                                 tags.put(tag, commit);
488                             }
489                         }
490                     }
491                 }
492             }
493         }
494 
495         for (var tag : hgRepo.tags()) {
496             if (tags.containsKey(tag.name())) {
497                 var commit = tags.get(tag.name());
498 
499                 log.fine(&quot;Converting tag &quot; + tag.name());
500                 pipe.print(&quot;tag &quot;);
501                 pipe.println(tag.name());
502                 pipe.print(&quot;from :&quot;);
503                 pipe.println(hgHashesToMarks.get(hgRepo.lookup(tag).get().hash()));
504 
</pre>
</td>
<td>
<hr />
<pre>
335 
336         return new GitCommitMetadata(gitMark, gitParentMarks, gitAuthor, gitCommitter, gitBranch, gitDate, gitMessage);
337     }
338 
339     private List&lt;Hash&gt; convertCommits(Pipe pipe) throws IOException {
340         var tagCommits = new ArrayList&lt;Hash&gt;();
341         while (pipe.read() != -1) {
342             pipe.readln(); // skip delimiter
343             var hash = new Hash(pipe.readln());
344             log.fine(&quot;Converting: &quot; + hash.hex());
345             pipe.readln(); // skip revision number
346             var branch = new Branch(pipe.readln());
347             log.finer(&quot;Branch: &quot; + branch.name());
348 
349             var parents = pipe.readln();
350             log.finer(&quot;Parents: &quot; + parents);
351             var parentHashes = Arrays.asList(parents.split(&quot; &quot;))
352                                      .stream()
353                                      .map(Hash::new)
354                                      .collect(Collectors.toList());
<span class="line-modified">355             if (parentHashes.size() == 1 &amp;&amp; parentHashes.get(0).equals(Hash.zero())) {</span>
356                 parentHashes = new ArrayList&lt;Hash&gt;();
357             }
358             pipe.readln(); // skip parent revisions
359 
360             var author = Author.fromString(pipe.readln());
361             log.finer(&quot;Author: &quot; + author.toString());
362 
363             var formatter = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd H:m:sZ&quot;);
364             var date = ZonedDateTime.parse(pipe.readln(), formatter);
365             log.finer(&quot;Date: &quot; + date.toString());
366 
367             var messageSize = parseInt(pipe.readln());
368             var messageBuffer = pipe.read(messageSize);
369             var hgMessage = new String(messageBuffer, 0, messageSize, StandardCharsets.UTF_8);
370             log.finest(&quot;Message: &quot; + hgMessage);
371 
372             var metadata = convertMetadata(hash,
373                                            branch,
374                                            author,
375                                            parentHashes,
</pre>
<hr />
<pre>
464         return tagCommits;
465     }
466 
467     private void convertTags(Pipe pipe, List&lt;Hash&gt; tagCommits, ReadOnlyRepository hgRepo) throws IOException {
468         var tags = new HashMap&lt;String, Commit&gt;();
469         for (var tagHash : tagCommits) {
470             log.fine(&quot;Inspecting tag commit &quot; + tagHash.toString());
471             var commit = hgRepo.lookup(tagHash).orElseThrow(() -&gt; new IOException(&quot;Could not find commit &quot; + tagHash));
472             var diff = commit.parentDiffs().get(0); // convert never returns merge commits
473             for (var patch : diff.patches()) {
474                 var target = patch.target().path();
475                 if (target.isPresent() &amp;&amp; target.get().equals(Path.of(&quot;.hgtags&quot;))) {
476                     for (var hunk : patch.asTextualPatch().hunks()) {
477                         for (var line : hunk.target().lines()) {
478                             if (line.isEmpty()) {
479                                 continue;
480                             }
481                             var parts = line.split(&quot; &quot;);
482                             var hash = parts[0];
483                             var tag = parts[1];
<span class="line-modified">484                             if (hash.equals(Hash.zero().hex())) {</span>
485                                 tags.remove(tag);
486                             } else {
487                                 tags.put(tag, commit);
488                             }
489                         }
490                     }
491                 }
492             }
493         }
494 
495         for (var tag : hgRepo.tags()) {
496             if (tags.containsKey(tag.name())) {
497                 var commit = tags.get(tag.name());
498 
499                 log.fine(&quot;Converting tag &quot; + tag.name());
500                 pipe.print(&quot;tag &quot;);
501                 pipe.println(tag.name());
502                 pipe.print(&quot;from :&quot;);
503                 pipe.println(hgHashesToMarks.get(hgRepo.lookup(tag).get().hash()));
504 
</pre>
</td>
</tr>
</table>
<center><a href="GitToHgConverter.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../test/java/org/openjdk/skara/vcs/RepositoryTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>