<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/pr/src/test/java/org/openjdk/skara/bots/pr/LabelTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.pr;
 24 
 25 import org.junit.jupiter.api.*;
 26 import org.openjdk.skara.test.*;
 27 
 28 import java.io.IOException;
 29 import java.nio.file.*;
 30 import java.util.*;
 31 import java.util.regex.Pattern;
 32 
 33 import static org.junit.jupiter.api.Assertions.*;
 34 import static org.openjdk.skara.bots.pr.PullRequestAsserts.assertLastCommentContains;
 35 
 36 public class LabelTests {
 37     @Test
 38     void simple(TestInfo testInfo) throws IOException {
 39         try (var credentials = new HostCredentials(testInfo);
 40              var tempFolder = new TemporaryDirectory()) {
 41             var author = credentials.getHostedRepository();
 42             var integrator = credentials.getHostedRepository();
 43 
 44             var censusBuilder = credentials.getCensusBuilder()
 45                                            .addReviewer(integrator.forge().currentUser().id())
 46                                            .addCommitter(author.forge().currentUser().id());
 47             var labelConfiguration = LabelConfiguration.newBuilder()
 48                                                        .addMatchers(&quot;1&quot;, List.of(Pattern.compile(&quot;cpp$&quot;)))
 49                                                        .addMatchers(&quot;2&quot;, List.of(Pattern.compile(&quot;hpp$&quot;)))
 50                                                        .addGroup(&quot;group&quot;, List.of(&quot;1&quot;, &quot;2&quot;))
 51                                                        .addExtra(&quot;extra&quot;)
 52                                                        .build();
 53             var prBot = PullRequestBot.newBuilder()
 54                                       .repo(integrator)
 55                                       .censusRepo(censusBuilder.build())
 56                                       .labelConfiguration(labelConfiguration)
 57                                       .build();
 58 
 59             // Populate the projects repository
 60             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
 61             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
 62             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 63             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 64             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 65 
 66             // Make a change with a corresponding PR
 67             var editHash = CheckableRepository.appendAndCommit(localRepo);
 68             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 69             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;123: This is a pull request&quot;);
 70 
 71             // No arguments
 72             pr.addComment(&quot;/label&quot;);
 73             TestBotRunner.runPeriodicItems(prBot);
 74 
 75             // The bot should reply with a help message
 76             assertLastCommentContains(pr,&quot;Usage: `/label&quot;);
 77 
 78             // Check that the alias works as well
 79             pr.addComment(&quot;/cc&quot;);
 80             TestBotRunner.runPeriodicItems(prBot);
 81 
 82             // The bot should reply with a help message
 83             assertLastCommentContains(pr,&quot;Usage: `/cc&quot;);
 84 
 85             // Invalid label
 86             pr.addComment(&quot;/label add unknown&quot;);
 87             TestBotRunner.runPeriodicItems(prBot);
 88 
 89             // The bot should reply with a failure message
 90             assertLastCommentContains(pr,&quot;The label `unknown` is not a valid label&quot;);
 91             assertLastCommentContains(pr,&quot;* `1`&quot;);
 92             assertLastCommentContains(pr,&quot;* `group`&quot;);
 93             assertLastCommentContains(pr,&quot;* `extra`&quot;);
 94 
 95             // Add a label
 96             pr.addComment(&quot;/label add 1&quot;);
 97             TestBotRunner.runPeriodicItems(prBot);
 98 
 99             // The bot should reply with a success message
100             assertLastCommentContains(pr,&quot;The `1` label was successfully added.&quot;);
101 
102             // One more
103             pr.addComment(&quot;/cc group&quot;);
104             TestBotRunner.runPeriodicItems(prBot);
105 
106             // The bot should reply with a success message
107             assertLastCommentContains(pr,&quot;The `group` label was successfully added.&quot;);
108 
109             // Drop both
110             pr.addComment(&quot;/label remove 1   group&quot;);
111             TestBotRunner.runPeriodicItems(prBot);
112 
113             // The bot should reply with a success message
114             assertLastCommentContains(pr,&quot;The `1` label was successfully removed.&quot;);
115             assertLastCommentContains(pr,&quot;The `group` label was successfully removed.&quot;);
116 
117             // And once more
118             pr.addComment(&quot;/label add 2, extra&quot;);
119             TestBotRunner.runPeriodicItems(prBot);
120 
121             // The bot should reply with a success message
122             assertLastCommentContains(pr,&quot;The `2` label was successfully added.&quot;);
123             assertLastCommentContains(pr,&quot;The `extra` label was successfully added.&quot;);
124         }
125     }
126 
127     @Test
128     void removeAutoApplied(TestInfo testInfo) throws IOException {
129         try (var credentials = new HostCredentials(testInfo);
130              var tempFolder = new TemporaryDirectory()) {
131             var author = credentials.getHostedRepository();
132             var integrator = credentials.getHostedRepository();
133 
134             var censusBuilder = credentials.getCensusBuilder()
135                                            .addReviewer(integrator.forge().currentUser().id())
136                                            .addCommitter(author.forge().currentUser().id());
137             var labelConfiguration = LabelConfiguration.newBuilder()
138                                                        .addMatchers(&quot;1&quot;, List.of(Pattern.compile(&quot;cpp$&quot;)))
139                                                        .addMatchers(&quot;2&quot;, List.of(Pattern.compile(&quot;hpp$&quot;)))
140                                                        .addGroup(&quot;group&quot;, List.of(&quot;1&quot;, &quot;2&quot;))
141                                                        .addExtra(&quot;extra&quot;)
142                                                        .build();
143             var prBot = PullRequestBot.newBuilder()
144                                       .repo(integrator)
145                                       .censusRepo(censusBuilder.build())
146                                       .labelConfiguration(labelConfiguration)
147                                       .build();
148 
149             // Populate the projects repository
150             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
151             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType(), Path.of(&quot;test.hpp&quot;));
152             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
153             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
154             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
155 
156             // Make a change with a corresponding PR
157             var editHash = CheckableRepository.appendAndCommit(localRepo);
158             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
159             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;123: This is a pull request&quot;);
160 
161             // The bot should have applied one label automatically
162             TestBotRunner.runPeriodicItems(prBot);
163             assertEquals(Set.of(&quot;2&quot;, &quot;rfr&quot;), new HashSet&lt;&gt;(pr.labels()));
164 
165             // It will refuse to remove it
166             pr.addComment(&quot;/label remove 2&quot;);
167             TestBotRunner.runPeriodicItems(prBot);
168             assertLastCommentContains(pr, &quot;The `2` label was automatically added and cannot be removed.&quot;);
169 
170             // Add another file to trigger a group match
171             Files.writeString(localRepoFolder.resolve(&quot;test.cpp&quot;), &quot;Hello there&quot;);
172             localRepo.add(Path.of(&quot;test.cpp&quot;));
173             editHash = localRepo.commit(&quot;Another one&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
174             localRepo.push(editHash, author.url(), &quot;edit&quot;);
175 
176             // The bot should have applied more labels automatically
177             TestBotRunner.runPeriodicItems(prBot);
178             assertEquals(Set.of(&quot;1&quot;, &quot;2&quot;, &quot;group&quot;, &quot;rfr&quot;), new HashSet&lt;&gt;(pr.labels()));
179 
180             // It will refuse to remove these as well
181             pr.addComment(&quot;/label remove group, 1&quot;);
182             TestBotRunner.runPeriodicItems(prBot);
183             assertLastCommentContains(pr, &quot;The `1` label was automatically added and cannot be removed.&quot;);
184             assertLastCommentContains(pr, &quot;The `group` label was automatically added and cannot be removed.&quot;);
185         }
186     }
187 
188     @Test
189     void commandAuthor(TestInfo testInfo) throws IOException {
190         try (var credentials = new HostCredentials(testInfo);
191              var tempFolder = new TemporaryDirectory()) {
192             var author = credentials.getHostedRepository();
193             var integrator = credentials.getHostedRepository();
194             var other = credentials.getHostedRepository();
195             var committer = credentials.getHostedRepository();
196 
197             var censusBuilder = credentials.getCensusBuilder()
198                                            .addReviewer(integrator.forge().currentUser().id())
199                                            .addCommitter(committer.forge().currentUser().id())
200                                            .addAuthor(author.forge().currentUser().id())
201                                            .addAuthor(other.forge().currentUser().id());
202             var labelConfiguration = LabelConfiguration.newBuilder()
203                                                        .addMatchers(&quot;1&quot;, List.of(Pattern.compile(&quot;cpp$&quot;)))
204                                                        .addMatchers(&quot;2&quot;, List.of(Pattern.compile(&quot;hpp$&quot;)))
205                                                        .addGroup(&quot;group&quot;, List.of(&quot;1&quot;, &quot;2&quot;))
206                                                        .addExtra(&quot;extra&quot;)
207                                                        .build();
208             var prBot = PullRequestBot.newBuilder()
209                                       .repo(integrator)
210                                       .censusRepo(censusBuilder.build())
211                                       .labelConfiguration(labelConfiguration)
212                                       .build();
213 
214             // Populate the projects repository
215             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
216             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
217             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
218             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
219             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
220 
221             // Make a change with a corresponding PR
222             var editHash = CheckableRepository.appendAndCommit(localRepo);
223             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
224             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;123: This is a pull request&quot;);
225 
226             // Non committers cannot modify labels
227             var otherPr = other.pullRequest(pr.id());
228             otherPr.addComment(&quot;/label extra&quot;);
229             TestBotRunner.runPeriodicItems(prBot);
230             assertLastCommentContains(pr, &quot;Only the PR author and project [Committers]&quot;);
231 
232             // But PR authors can
233             pr.addComment(&quot;/label extra&quot;);
234             TestBotRunner.runPeriodicItems(prBot);
235             assertLastCommentContains(pr, &quot;The `extra` label was successfully added&quot;);
236 
237             // As well as other committers
238             var committerPr = committer.pullRequest(pr.id());
239             committerPr.addComment(&quot;/label 2&quot;);
240             TestBotRunner.runPeriodicItems(prBot);
241             assertLastCommentContains(pr, &quot;The `2` label was successfully added&quot;);
242         }
243     }
244 }
    </pre>
  </body>
</html>