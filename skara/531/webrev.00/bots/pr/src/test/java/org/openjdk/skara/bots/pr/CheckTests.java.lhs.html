<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.pr;
  24 
  25 import org.openjdk.skara.forge.*;
  26 import org.openjdk.skara.test.*;
  27 
  28 import org.junit.jupiter.api.*;
  29 
  30 import java.io.IOException;
  31 import java.nio.charset.StandardCharsets;
  32 import java.nio.file.*;
  33 import java.util.*;
  34 import java.util.regex.Pattern;
  35 
  36 import static org.junit.jupiter.api.Assertions.*;
  37 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  38 
  39 class CheckTests {
  40     @Test
  41     void simpleCommit(TestInfo testInfo) throws IOException {
  42         try (var credentials = new HostCredentials(testInfo);
  43              var tempFolder = new TemporaryDirectory()) {
  44             var author = credentials.getHostedRepository();
  45             var reviewer = credentials.getHostedRepository();
  46 
  47             var censusBuilder = credentials.getCensusBuilder()
  48                                            .addAuthor(author.forge().currentUser().id())
  49                                            .addReviewer(reviewer.forge().currentUser().id());
  50             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
  51 
  52             // Populate the projects repository
  53             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
  54             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
  55             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
  56 
  57             // Make a change with a corresponding PR
  58             var editHash = CheckableRepository.appendAndCommit(localRepo);
  59             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
  60             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
  61 
  62             // Check the status
  63             TestBotRunner.runPeriodicItems(checkBot);
  64 
  65             // Verify that the check succeeded
  66             var checks = pr.checks(editHash);
  67             assertEquals(1, checks.size());
  68             var check = checks.get(&quot;jcheck&quot;);
  69             assertEquals(CheckStatus.SUCCESS, check.status());
  70 
  71             // The PR should now be ready for review
  72             assertTrue(pr.labels().contains(&quot;rfr&quot;));
  73             assertFalse(pr.labels().contains(&quot;ready&quot;));
  74 
  75             // Approve it as another user
  76             var approvalPr = reviewer.pullRequest(pr.id());
  77             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
  78 
  79             // Check the status again
  80             TestBotRunner.runPeriodicItems(checkBot);
  81 
  82             // The check should now be successful
  83             checks = pr.checks(editHash);
  84             assertEquals(1, checks.size());
  85             check = checks.get(&quot;jcheck&quot;);
  86             assertEquals(CheckStatus.SUCCESS, check.status());
  87 
  88             // The PR should now be ready
  89             assertTrue(pr.labels().contains(&quot;ready&quot;));
  90         }
  91     }
  92 
  93     @Test
  94     void whitespaceIssue(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory()) {
  97 
  98             var author = credentials.getHostedRepository();
  99             var reviewer = credentials.getHostedRepository();
 100 
 101             var censusBuilder = credentials.getCensusBuilder()
 102                                            .addAuthor(author.forge().currentUser().id())
 103                                            .addReviewer(reviewer.forge().currentUser().id());
 104             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 105 
 106             // Populate the projects repository
 107             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 108             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 109             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 110 
 111             // Make a change with a corresponding PR
 112             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line with a trailing whitespace   &quot;);
 113             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 114             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 115 
 116             // Check the status
 117             TestBotRunner.runPeriodicItems(checkBot);
 118 
 119             // The PR should not be flagged as ready for review
 120             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 121 
 122             // Approve it as another user
 123             var approvalPr = reviewer.pullRequest(pr.id());
 124             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 125 
 126             // Check the status
 127             TestBotRunner.runPeriodicItems(checkBot);
 128 
 129             // Verify that the check failed
 130             var checks = pr.checks(editHash);
 131             assertEquals(1, checks.size());
 132             var check = checks.get(&quot;jcheck&quot;);
 133             assertEquals(CheckStatus.FAILURE, check.status());
 134 
 135             // The PR should not still not be flagged as ready for review
 136             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 137 
 138             // Remove the trailing whitespace in a new commit
 139             editHash = CheckableRepository.replaceAndCommit(localRepo, &quot;A line without a trailing whitespace&quot;);
 140             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 141 
 142             // Make sure that the push registered
 143             var lastHeadHash = pr.headHash();
 144             var refreshCount = 0;
 145             do {
 146                 pr = author.pullRequest(pr.id());
 147                 if (refreshCount++ &gt; 100) {
 148                     fail(&quot;The PR did not update after the new push&quot;);
 149                 }
 150             } while (pr.headHash().equals(lastHeadHash));
 151 
 152             // Check the status again
 153             TestBotRunner.runPeriodicItems(checkBot);
 154 
 155             // The PR should now be ready
 156             assertTrue(pr.labels().contains(&quot;ready&quot;));
 157 
 158             // The check should now be successful
 159             checks = pr.checks(editHash);
 160             assertEquals(1, checks.size());
 161             check = checks.get(&quot;jcheck&quot;);
 162             assertEquals(CheckStatus.SUCCESS, check.status());
 163         }
 164     }
 165 
 166     @Test
 167     void multipleReviews(TestInfo testInfo) throws IOException {
 168         try (var credentials = new HostCredentials(testInfo);
 169              var tempFolder = new TemporaryDirectory()) {
 170 
 171             var author = credentials.getHostedRepository();
 172             var reviewer = credentials.getHostedRepository();
 173             var commenter = credentials.getHostedRepository();
 174 
 175             var censusBuilder = credentials.getCensusBuilder()
 176                                            .addAuthor(author.forge().currentUser().id())
 177                                            .addReviewer(reviewer.forge().currentUser().id())
 178                                            .addReviewer(commenter.forge().currentUser().id());
 179 
 180             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 181 
 182             // Populate the projects repository
 183             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 184             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 185             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 186 
 187             // Make a change with a corresponding PR
 188             var editHash = CheckableRepository.appendAndCommit(localRepo);
 189             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 190             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 191 
 192             // Let the status bot inspect the PR
 193             TestBotRunner.runPeriodicItems(checkBot);
 194             assertFalse(authorPr.body().contains(&quot;Reviewers&quot;));
 195 
 196             // Approve it
 197             var reviewerPr = reviewer.pullRequest(authorPr.id());
 198             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Reviewers&quot;);
 199             TestBotRunner.runPeriodicItems(checkBot);
 200 
 201             // Refresh the PR and check that it has been approved
 202             authorPr = author.pullRequest(authorPr.id());
 203             assertTrue(authorPr.body().contains(&quot;Reviewers&quot;));
 204 
 205             // Update the file after approval
 206             editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Now I&#39;ve gone and changed it&quot;);
 207             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 208 
 209             // Make sure that the push registered
 210             var lastHeadHash = authorPr.headHash();
 211             var refreshCount = 0;
 212             do {
 213                 authorPr = author.pullRequest(authorPr.id());
 214                 if (refreshCount++ &gt; 100) {
 215                     fail(&quot;The PR did not update after the new push&quot;);
 216                 }
 217             } while (authorPr.headHash().equals(lastHeadHash));
 218 
 219             // Check that the review is flagged as stale
 220             TestBotRunner.runPeriodicItems(checkBot);
 221             authorPr = author.pullRequest(authorPr.id());
 222             assertTrue(authorPr.body().contains(&quot;Review applies to&quot;));
 223 
 224             // Now we can approve it again
 225             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 226             TestBotRunner.runPeriodicItems(checkBot);
 227 
 228             // Refresh the PR and check that it has been approved (once) and is no longer stale
 229             authorPr = author.pullRequest(authorPr.id());
 230             assertTrue(authorPr.body().contains(&quot;Reviewers&quot;));
 231             assertEquals(1, authorPr.body().split(&quot;Generated Reviewer&quot;, -1).length - 1);
 232             assertTrue(authorPr.reviews().size() &gt;= 1);
 233             assertFalse(authorPr.body().contains(&quot;Note&quot;));
 234 
 235             // Add a review with disapproval
 236             var commenterPr = commenter.pullRequest(authorPr.id());
 237             commenterPr.addReview(Review.Verdict.DISAPPROVED, &quot;Disapproved&quot;);
 238             TestBotRunner.runPeriodicItems(checkBot);
 239 
 240             // Refresh the PR and check that it still only approved once (but two reviews) and is no longer stale
 241             authorPr = author.pullRequest(authorPr.id());
 242             assertTrue(authorPr.body().contains(&quot;Reviewers&quot;));
 243             assertEquals(1, authorPr.body().split(&quot;Generated Reviewer&quot;, -1).length - 1);
 244             assertTrue(authorPr.reviews().size() &gt;= 2);
 245             assertFalse(authorPr.body().contains(&quot;Note&quot;));
 246         }
 247     }
 248 
 249     @Test
 250     void selfReview(TestInfo testInfo) throws IOException {
 251         try (var credentials = new HostCredentials(testInfo);
 252              var tempFolder = new TemporaryDirectory()) {
 253 
 254             var author = credentials.getHostedRepository();
 255 
 256             var censusBuilder = credentials.getCensusBuilder()
 257                                            .addReviewer(author.forge().currentUser().id());
 258 
 259             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 260 
 261             // Populate the projects repository
 262             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 263             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 264             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 265 
 266             // Make a change with a corresponding PR
 267             var editHash = CheckableRepository.appendAndCommit(localRepo);
 268             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 269             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 270 
 271             // Let the status bot inspect the PR
 272             TestBotRunner.runPeriodicItems(checkBot);
 273             assertFalse(authorPr.body().contains(&quot;Reviewers&quot;));
 274 
 275             // Approve it
 276             authorPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 277             TestBotRunner.runPeriodicItems(checkBot);
 278 
 279             // Refresh the PR and check that it has been approved
 280             authorPr = author.pullRequest(authorPr.id());
 281             assertTrue(authorPr.body().contains(&quot;Reviewers&quot;));
 282 
 283             // Verify that the check failed
 284             var checks = authorPr.checks(editHash);
 285             assertEquals(1, checks.size());
 286             var check = checks.get(&quot;jcheck&quot;);
 287             assertEquals(CheckStatus.FAILURE, check.status());
 288         }
 289     }
 290 
 291     @Test
 292     void multipleCommitters(TestInfo testInfo) throws IOException {
 293         try (var credentials = new HostCredentials(testInfo);
 294              var tempFolder = new TemporaryDirectory()) {
 295             var author = credentials.getHostedRepository();
 296             var reviewer = credentials.getHostedRepository();
 297 
 298             var censusBuilder = credentials.getCensusBuilder()
 299                                            .addReviewer(reviewer.forge().currentUser().id());
 300             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 301 
 302             // Populate the projects repository
 303             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 304             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 305             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 306 
 307             // Make two changes with different authors
 308             CheckableRepository.appendAndCommit(localRepo, &quot;First edit&quot;, &quot;Edit by number 1&quot;,
 309                                                 &quot;number1&quot;, &quot;number1@none.none&quot;);
 310             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Second edit&quot;, &quot;Edit by number 2&quot;,
 311                                                                &quot;number2&quot;, &quot;number2@none.none&quot;);
 312             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 313             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 314 
 315             // Check the status
 316             TestBotRunner.runPeriodicItems(checkBot);
 317 
 318             // Verify that the check failed
 319             var checks = pr.checks(editHash);
 320             assertEquals(1, checks.size());
 321             var check = checks.get(&quot;jcheck&quot;);
 322             assertEquals(CheckStatus.FAILURE, check.status());
 323 
 324             // Approve it as another user
 325             var approvalPr = reviewer.pullRequest(pr.id());
 326             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 327 
 328             // Check the status again
 329             TestBotRunner.runPeriodicItems(checkBot);
 330 
 331             // The check should still be failing
 332             checks = pr.checks(editHash);
 333             assertEquals(1, checks.size());
 334             check = checks.get(&quot;jcheck&quot;);
 335             assertEquals(CheckStatus.FAILURE, check.status());
 336 
 337             // The PR should not be flagged as ready for review, as multiple committers is a problem
 338             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 339         }
 340     }
 341 
 342     @Test
 343     void updatedContentFailsCheck(TestInfo testInfo) throws IOException {
 344         try (var credentials = new HostCredentials(testInfo);
 345              var tempFolder = new TemporaryDirectory()) {
 346             var author = credentials.getHostedRepository();
 347             var reviewer = credentials.getHostedRepository();
 348 
 349             var censusBuilder = credentials.getCensusBuilder()
 350                                            .addAuthor(author.forge().currentUser().id())
 351                                            .addReviewer(reviewer.forge().currentUser().id());
 352             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 353 
 354             // Populate the projects repository
 355             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 356             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 357             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 358 
 359             // Make a change with a corresponding PR
 360             var editHash = CheckableRepository.appendAndCommit(localRepo);
 361             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 362             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 363 
 364             // Check the status
 365             TestBotRunner.runPeriodicItems(checkBot);
 366 
 367             // Verify that the check passed
 368             var checks = pr.checks(editHash);
 369             assertEquals(1, checks.size());
 370             var check = checks.get(&quot;jcheck&quot;);
 371             assertEquals(CheckStatus.SUCCESS, check.status());
 372 
 373             // The PR should now be ready for review
 374             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 375             assertFalse(pr.labels().contains(&quot;ready&quot;));
 376 
 377             // Approve it as another user
 378             var approvalPr = reviewer.pullRequest(pr.id());
 379             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 380 
 381             // Check the status again
 382             TestBotRunner.runPeriodicItems(checkBot);
 383 
 384             // The check should now be successful
 385             checks = pr.checks(editHash);
 386             assertEquals(1, checks.size());
 387             check = checks.get(&quot;jcheck&quot;);
 388             assertEquals(CheckStatus.SUCCESS, check.status());
 389 
 390             // The PR should now be ready
 391             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 392             assertTrue(pr.labels().contains(&quot;ready&quot;));
 393 
 394             var addedHash = CheckableRepository.appendAndCommit(localRepo, &quot;trailing whitespace   &quot;);
 395             localRepo.push(addedHash, author.url(), &quot;edit&quot;);
 396 
 397             // Make sure that the push registered
 398             var lastHeadHash = pr.headHash();
 399             var refreshCount = 0;
 400             do {
 401                 pr = author.pullRequest(pr.id());
 402                 if (refreshCount++ &gt; 100) {
 403                     fail(&quot;The PR did not update after the new push&quot;);
 404                 }
 405             } while (pr.headHash().equals(lastHeadHash));
 406 
 407             // Check the status
 408             TestBotRunner.runPeriodicItems(checkBot);
 409 
 410             // The PR is now neither ready for review nor integration
 411             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 412             assertFalse(pr.labels().contains(&quot;ready&quot;));
 413 
 414             // The check should now be failing
 415             checks = pr.checks(addedHash);
 416             assertEquals(1, checks.size());
 417             check = checks.get(&quot;jcheck&quot;);
 418             assertEquals(CheckStatus.FAILURE, check.status());
 419         }
 420     }
 421 
 422     @Test
 423     void individualReviewComments(TestInfo testInfo) throws IOException {
 424         try (var credentials = new HostCredentials(testInfo);
 425              var tempFolder = new TemporaryDirectory()) {
 426             var author = credentials.getHostedRepository();
 427             var reviewer = credentials.getHostedRepository();
 428 
 429             // This test is only relevant on hosts not supporting proper review comment bodies
 430             assumeTrue(!author.forge().supportsReviewBody());
 431 
 432             var censusBuilder = credentials.getCensusBuilder()
 433                                            .addAuthor(author.forge().currentUser().id())
 434                                            .addReviewer(reviewer.forge().currentUser().id());
 435             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 436 
 437             // Populate the projects repository
 438             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 439             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 440             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 441 
 442             // Make a change with a corresponding PR
 443             var editHash = CheckableRepository.appendAndCommit(localRepo);
 444             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 445             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 446 
 447             // Check the status
 448             TestBotRunner.runPeriodicItems(checkBot);
 449             var comments = pr.comments();
 450             var commentCount = comments.size();
 451 
 452             // Approve it as another user
 453             var approvalPr = reviewer.pullRequest(pr.id());
 454             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 455 
 456             // Check the status again
 457             TestBotRunner.runPeriodicItems(checkBot);
 458 
 459             // There should now be two additional comments
 460             comments = pr.comments();
 461             assertEquals(commentCount + 2, comments.size());
 462             var comment = comments.get(commentCount);
 463             assertTrue(comment.body().contains(reviewer.forge().currentUser().userName()));
 464             assertTrue(comment.body().contains(&quot;approved&quot;));
 465 
 466             // Drop the review
 467             approvalPr.addReview(Review.Verdict.NONE, &quot;Unreviewed&quot;);
 468 
 469             // Check the status again
 470             TestBotRunner.runPeriodicItems(checkBot);
 471 
 472             // There should now be yet another comment
 473             comments = pr.comments();
 474             assertEquals(commentCount + 3, comments.size());
 475             comment = comments.get(commentCount + 2);
 476             assertTrue(comment.body().contains(reviewer.forge().currentUser().userName()));
 477             assertTrue(comment.body().contains(&quot;comment&quot;));
 478 
 479             // No changes should not generate additional comments
 480             TestBotRunner.runPeriodicItems(checkBot);
 481             comments = pr.comments();
 482             assertEquals(commentCount + 3, comments.size());
 483         }
 484     }
 485 
 486     @Test
 487     void mergeMessage(TestInfo testInfo) throws IOException {
 488         try (var credentials = new HostCredentials(testInfo);
 489              var tempFolder = new TemporaryDirectory();
 490              var pushedFolder = new TemporaryDirectory()) {
 491 
 492             var author = credentials.getHostedRepository();
 493             var integrator = credentials.getHostedRepository();
 494             var censusBuilder = credentials.getCensusBuilder()
 495                                            .addCommitter(author.forge().currentUser().id())
 496                                            .addReviewer(integrator.forge().currentUser().id());
 497             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
 498 
 499             // Populate the projects repository
 500             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 501             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 502             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 503             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 504 
 505             // Make a change with a corresponding PR
 506             var editHash = CheckableRepository.appendAndCommit(localRepo);
 507             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 508             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 509 
 510             // Approve it as another user
 511             var approvalPr = integrator.pullRequest(pr.id());
 512             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 513 
 514             // Get all messages up to date
 515             TestBotRunner.runPeriodicItems(mergeBot);
 516 
 517             // Push something unrelated to master
 518             localRepo.checkout(masterHash, true);
 519             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
 520             Files.writeString(unrelated, &quot;Hello&quot;);
 521             localRepo.add(unrelated);
 522             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
 523             localRepo.push(unrelatedHash, author.url(), &quot;master&quot;);
 524 
 525             // Let the bot see the changes
 526             TestBotRunner.runPeriodicItems(mergeBot);
 527 
 528             // The bot should reply with an ok message
 529             var updated = pr.comments().stream()
 530                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
 531                             .filter(comment -&gt; comment.body().contains(&quot;please merge&quot;))
 532                             .count();
 533             assertEquals(1, updated);
 534         }
 535     }
 536 
 537     @Test
 538     void cannotRebase(TestInfo testInfo) throws IOException {
 539         try (var credentials = new HostCredentials(testInfo);
 540              var tempFolder = new TemporaryDirectory();
 541              var pushedFolder = new TemporaryDirectory()) {
 542 
 543             var author = credentials.getHostedRepository();
 544             var integrator = credentials.getHostedRepository();
 545             var censusBuilder = credentials.getCensusBuilder()
 546                                            .addCommitter(author.forge().currentUser().id())
 547                                            .addReviewer(integrator.forge().currentUser().id());
 548             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
 549 
 550             // Populate the projects repository
 551             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 552             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 553             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 554             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 555 
 556             // Make a change with a corresponding PR
 557             var editHash = CheckableRepository.appendAndCommit(localRepo);
 558             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 559             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 560 
 561             // Approve it as another user
 562             var approvalPr = integrator.pullRequest(pr.id());
 563             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 564 
 565             // Get all messages up to date
 566             TestBotRunner.runPeriodicItems(mergeBot);
<a name="1" id="anc1"></a>
 567 
 568             // Push something conflicting to master
 569             localRepo.checkout(masterHash, true);
 570             var conflictingHash = CheckableRepository.appendAndCommit(localRepo, &quot;This looks like a conflict&quot;);
 571             localRepo.push(conflictingHash, author.url(), &quot;master&quot;);
 572 
 573             // Let the bot see the changes
 574             TestBotRunner.runPeriodicItems(mergeBot);
 575 
 576             // The bot should reply with that there is a conflict
 577             var updated = pr.comments().stream()
 578                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
 579                             .filter(comment -&gt; comment.body().contains(&quot;cannot be rebased automatically&quot;))
 580                             .count();
 581             assertEquals(1, updated);
 582 
 583             // The PR should be flagged as outdated
<a name="2" id="anc2"></a><span class="line-modified"> 584             assertTrue(pr.labels().contains(&quot;outdated&quot;));</span>

 585 
 586             // An instructional message should have been bosted
 587             var help = pr.comments().stream()
 588                          .filter(comment -&gt; comment.body().contains(&quot;To resolve these merge conflicts&quot;))
 589                          .count();
 590             assertEquals(1, help);
 591 
 592             // But it should still pass jcheck
 593             var checks = pr.checks(editHash);
 594             assertEquals(1, checks.size());
 595             var check = checks.get(&quot;jcheck&quot;);
 596             assertEquals(CheckStatus.SUCCESS, check.status());
 597 
 598             // Restore the master branch
 599             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 600 
 601             // Let the bot see the changes
 602             TestBotRunner.runPeriodicItems(mergeBot);
 603 
 604             // The bot should no longer detect a conflict
 605             updated = pr.comments().stream()
 606                         .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
 607                         .count();
 608             assertEquals(1, updated);
 609 
 610             // The PR should not be flagged as outdated
<a name="3" id="anc3"></a><span class="line-modified"> 611             assertFalse(pr.labels().contains(&quot;outdated&quot;));</span>

 612         }
 613     }
 614 
 615     @Test
 616     void blockingLabel(TestInfo testInfo) throws IOException {
 617         try (var credentials = new HostCredentials(testInfo);
 618              var tempFolder = new TemporaryDirectory()) {
 619             var author = credentials.getHostedRepository();
 620             var reviewer = credentials.getHostedRepository();
 621 
 622             var censusBuilder = credentials.getCensusBuilder()
 623                                            .addAuthor(author.forge().currentUser().id())
 624                                            .addReviewer(reviewer.forge().currentUser().id());
 625             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).blockingCheckLabels(Map.of(&quot;block&quot;, &quot;Test Blocker&quot;)).build();
 626 
 627             // Populate the projects repository
 628             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 629             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 630             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 631 
 632             // Make a change with a corresponding PR
 633             var editHash = CheckableRepository.appendAndCommit(localRepo);
 634             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 635             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 636             pr.addLabel(&quot;block&quot;);
 637 
 638             // Check the status
 639             TestBotRunner.runPeriodicItems(checkBot);
 640 
 641             // Verify that the check failed
 642             var checks = pr.checks(editHash);
 643             assertEquals(1, checks.size());
 644             var check = checks.get(&quot;jcheck&quot;);
 645             assertEquals(CheckStatus.FAILURE, check.status());
 646             assertTrue(check.summary().orElseThrow().contains(&quot;Test Blocker&quot;));
 647 
 648             // The PR should not yet be ready for review
 649             assertTrue(pr.labels().contains(&quot;block&quot;));
 650             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 651             assertFalse(pr.labels().contains(&quot;ready&quot;));
 652 
 653             // Check the status again
 654             pr.removeLabel(&quot;block&quot;);
 655             TestBotRunner.runPeriodicItems(checkBot);
 656 
 657             // The PR should now be ready for review
 658             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 659             assertFalse(pr.labels().contains(&quot;ready&quot;));
 660         }
 661     }
 662 
 663     @Test
 664     void emptyPRBody(TestInfo testInfo) throws IOException {
 665         try (var credentials = new HostCredentials(testInfo);
 666              var tempFolder = new TemporaryDirectory()) {
 667             var author = credentials.getHostedRepository();
 668             var reviewer = credentials.getHostedRepository();
 669 
 670             var censusBuilder = credentials.getCensusBuilder()
 671                                            .addAuthor(author.forge().currentUser().id())
 672                                            .addReviewer(reviewer.forge().currentUser().id());
 673             var checkBot = PullRequestBot.newBuilder()
 674                                          .repo(author)
 675                                          .censusRepo(censusBuilder.build())
 676                                          .build();
 677 
 678             // Populate the projects repository
 679             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 680             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 681             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 682 
 683             // Make a change with a corresponding PR
 684             var editHash = CheckableRepository.appendAndCommit(localRepo);
 685             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 686             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Another PR&quot;);
 687             pr.setBody(&quot;    &quot;);
 688 
 689             // Check the status
 690             TestBotRunner.runPeriodicItems(checkBot);
 691 
 692             // Verify that the check failed
 693             var checks = pr.checks(editHash);
 694             assertEquals(1, checks.size());
 695             var check = checks.get(&quot;jcheck&quot;);
 696             assertEquals(CheckStatus.FAILURE, check.status());
 697             assertTrue(check.summary().orElseThrow().contains(&quot;The pull request body must not be empty.&quot;));
 698 
 699             // The PR should not yet be ready for review
 700             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 701             assertFalse(pr.labels().contains(&quot;ready&quot;));
 702 
 703             // Check the status again
 704             pr.setBody(&quot;Here&#39;s that body&quot;);
 705             TestBotRunner.runPeriodicItems(checkBot);
 706 
 707             // The PR should now be ready for review
 708             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 709             assertFalse(pr.labels().contains(&quot;ready&quot;));
 710         }
 711     }
 712 
 713     @Test
 714     void missingReadyLabel(TestInfo testInfo) throws IOException {
 715         try (var credentials = new HostCredentials(testInfo);
 716              var tempFolder = new TemporaryDirectory()) {
 717             var author = credentials.getHostedRepository();
 718             var reviewer = credentials.getHostedRepository();
 719 
 720             var censusBuilder = credentials.getCensusBuilder()
 721                                            .addAuthor(author.forge().currentUser().id())
 722                                            .addReviewer(reviewer.forge().currentUser().id());
 723             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).readyLabels(Set.of(&quot;good-to-go&quot;)).build();
 724 
 725             // Populate the projects repository
 726             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 727             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 728             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 729 
 730             // Make a change with a corresponding PR
 731             var editHash = CheckableRepository.appendAndCommit(localRepo);
 732             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 733             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 734 
 735             // Check the status
 736             TestBotRunner.runPeriodicItems(checkBot);
 737 
 738             // Verify that no checks have been run
 739             var checks = pr.checks(editHash);
 740             assertEquals(0, checks.size());
 741 
 742             // The PR should not yet be ready for review
 743             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 744 
 745             // Check the status again
 746             pr.addLabel(&quot;good-to-go&quot;);
 747             TestBotRunner.runPeriodicItems(checkBot);
 748 
 749             // The PR should now be ready for review
 750             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 751         }
 752     }
 753 
 754     @Test
 755     void missingReadyComment(TestInfo testInfo) throws IOException {
 756         try (var credentials = new HostCredentials(testInfo);
 757              var tempFolder = new TemporaryDirectory()) {
 758             var author = credentials.getHostedRepository();
 759             var reviewer = credentials.getHostedRepository();
 760 
 761             var censusBuilder = credentials.getCensusBuilder()
 762                                            .addAuthor(author.forge().currentUser().id())
 763                                            .addReviewer(reviewer.forge().currentUser().id());
 764             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;proceed&quot;))).build();
 765 
 766             // Populate the projects repository
 767             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 768             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 769             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 770 
 771             // Make a change with a corresponding PR
 772             var editHash = CheckableRepository.appendAndCommit(localRepo);
 773             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 774             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 775 
 776             // Check the status
 777             TestBotRunner.runPeriodicItems(checkBot);
 778 
 779             // Verify that no checks have been run
 780             var checks = pr.checks(editHash);
 781             assertEquals(0, checks.size());
 782 
 783             // The PR should not yet be ready for review
 784             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 785 
 786             // Check the status again
 787             var reviewerPr = reviewer.pullRequest(pr.id());
 788             reviewerPr.addComment(&quot;proceed&quot;);
 789             TestBotRunner.runPeriodicItems(checkBot);
 790 
 791             // The PR should now be ready for review
 792             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 793         }
 794     }
 795 
 796     @Test
 797     void issueIssue(TestInfo testInfo) throws IOException {
 798         try (var credentials = new HostCredentials(testInfo);
 799              var tempFolder = new TemporaryDirectory()) {
 800             var author = credentials.getHostedRepository();
 801             var reviewer = credentials.getHostedRepository();
 802 
 803             var censusBuilder = credentials.getCensusBuilder()
 804                                            .addAuthor(author.forge().currentUser().id())
 805                                            .addReviewer(reviewer.forge().currentUser().id());
 806             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 807 
 808             // Populate the projects repository
 809             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 810                                                      Set.of(&quot;issues&quot;), null);
 811             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 812             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 813 
 814             // Make a change with a corresponding PR
 815             var editHash = CheckableRepository.appendAndCommit(localRepo);
 816             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 817             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 818 
 819             // Check the status
 820             TestBotRunner.runPeriodicItems(checkBot);
 821 
 822             // Verify that the check failed
 823             var checks = pr.checks(editHash);
 824             assertEquals(1, checks.size());
 825             var check = checks.get(&quot;jcheck&quot;);
 826             assertEquals(CheckStatus.FAILURE, check.status());
 827 
 828             // Add an issue to the title
 829             pr.setTitle(&quot;1234: This is a pull request&quot;);
 830 
 831             // Check the status again
 832             TestBotRunner.runPeriodicItems(checkBot);
 833 
 834             // The check should now be successful
 835             checks = pr.checks(editHash);
 836             assertEquals(1, checks.size());
 837             check = checks.get(&quot;jcheck&quot;);
 838             assertEquals(CheckStatus.SUCCESS, check.status());
 839         }
 840     }
 841 
 842     @Test
 843     void issueInSummary(TestInfo testInfo) throws IOException {
 844         try (var credentials = new HostCredentials(testInfo);
 845              var tempFolder = new TemporaryDirectory()) {
 846             var author = credentials.getHostedRepository();
 847             var reviewer = credentials.getHostedRepository();
 848             var issues = credentials.getIssueProject();
 849 
 850             var censusBuilder = credentials.getCensusBuilder()
 851                                            .addAuthor(author.forge().currentUser().id())
 852                                            .addReviewer(reviewer.forge().currentUser().id());
 853             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).issueProject(issues).build();
 854 
 855             // Populate the projects repository
 856             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 857                                                      Set.of(&quot;issues&quot;), null);
 858             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 859             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 860 
 861             var issue1 = issues.createIssue(&quot;My first issue&quot;, List.of(&quot;Hello&quot;), Map.of());
 862 
 863             // Make a change with a corresponding PR
 864             var editHash = CheckableRepository.appendAndCommit(localRepo);
 865             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 866             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, issue1.id() + &quot;: This is a pull request&quot;);
 867 
 868             // Check the status
 869             TestBotRunner.runPeriodicItems(checkBot);
 870 
 871             // The check should be successful
 872             var checks = pr.checks(editHash);
 873             assertEquals(1, checks.size());
 874             var check = checks.get(&quot;jcheck&quot;);
 875             assertEquals(CheckStatus.SUCCESS, check.status());
 876 
 877             // And the body should contain the issue title
 878             assertTrue(pr.body().contains(&quot;My first issue&quot;));
 879 
 880             // Change the issue
 881             var issue2 = issues.createIssue(&quot;My second issue&quot;, List.of(&quot;Body&quot;), Map.of());
 882             pr.setTitle(issue2.id() + &quot;: This is a pull request&quot;);
 883 
 884             // Check the status again
 885             TestBotRunner.runPeriodicItems(checkBot);
 886 
 887             // The body should contain the updated issue title
 888             assertFalse(pr.body().contains(&quot;My first issue&quot;));
 889             assertTrue(pr.body().contains(&quot;My second issue&quot;));
 890 
 891             // Use an invalid issue key
 892             var issueKey = issue1.id().replace(&quot;TEST&quot;, &quot;BADPROJECT&quot;);
 893             pr.setTitle(issueKey + &quot;: This is a pull request&quot;);
 894 
 895             // Check the status again
 896             TestBotRunner.runPeriodicItems(checkBot);
 897             assertFalse(pr.body().contains(&quot;My first issue&quot;));
 898             assertFalse(pr.body().contains(&quot;My second issue&quot;));
 899             assertTrue(pr.body().contains(&quot;Failed to retrieve&quot;));
 900 
 901             // Now drop the issue key
 902             issueKey = issue1.id().replace(&quot;TEST-&quot;, &quot;&quot;);
 903             pr.setTitle(issueKey + &quot;: This is a pull request&quot;);
 904 
 905             // The body should now contain the updated issue title
 906             TestBotRunner.runPeriodicItems(checkBot);
 907             assertTrue(pr.body().contains(&quot;My first issue&quot;));
 908             assertFalse(pr.body().contains(&quot;My second issue&quot;));
 909 
 910             // Now enter an invalid issue id
 911             pr.setTitle(&quot;2384848: This is a pull request&quot;);
 912 
 913             // Check the status again
 914             TestBotRunner.runPeriodicItems(checkBot);
 915             assertFalse(pr.body().contains(&quot;My first issue&quot;));
 916             assertFalse(pr.body().contains(&quot;My second issue&quot;));
 917             assertTrue(pr.body().contains(&quot;Failed to retrieve&quot;));
 918 
 919             // The check should still be successful though
 920             checks = pr.checks(editHash);
 921             assertEquals(1, checks.size());
 922             check = checks.get(&quot;jcheck&quot;);
 923             assertEquals(CheckStatus.SUCCESS, check.status());
 924         }
 925     }
 926 
 927     @Test
 928     void cancelCheck(TestInfo testInfo) throws IOException {
 929         try (var credentials = new HostCredentials(testInfo);
 930              var tempFolder = new TemporaryDirectory()) {
 931             var author = credentials.getHostedRepository();
 932 
 933             // Populate the projects repository
 934             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 935             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 936             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 937 
 938             // Make a change with a corresponding PR
 939             var editHash = CheckableRepository.appendAndCommit(localRepo);
 940             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 941             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 942 
 943             // Verify no checks exists
 944             var checks = pr.checks(editHash);
 945             assertEquals(0, checks.size());
 946 
 947             // Create a check that is running
 948             var original = CheckBuilder.create(&quot;jcheck&quot;, editHash)
 949                                        .title(&quot;jcheck title&quot;)
 950                                        .summary(&quot;jcheck summary&quot;)
 951                                        .build();
 952             pr.createCheck(original);
 953 
 954             // Verify check is created
 955             checks = pr.checks(editHash);
 956             assertEquals(1, checks.size());
 957             var retrieved = checks.get(&quot;jcheck&quot;);
 958             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
 959             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
 960             assertEquals(CheckStatus.IN_PROGRESS, retrieved.status());
 961 
 962             // Cancel the check
 963             var cancelled = CheckBuilder.from(retrieved).cancel().build();
 964             pr.updateCheck(cancelled);
 965             checks = pr.checks(editHash);
 966             assertEquals(1, checks.size());
 967             retrieved = checks.get(&quot;jcheck&quot;);
 968             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
 969             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
 970             assertEquals(CheckStatus.CANCELLED, retrieved.status());
 971         }
 972     }
 973 
 974     @Test
 975     void rebaseBeforeCheck(TestInfo testInfo) throws IOException {
 976         try (var credentials = new HostCredentials(testInfo);
 977              var tempFolder = new TemporaryDirectory()) {
 978             var author = credentials.getHostedRepository();
 979             var reviewer = credentials.getHostedRepository();
 980 
 981             var censusBuilder = credentials.getCensusBuilder()
 982                                            .addAuthor(author.forge().currentUser().id())
 983                                            .addReviewer(reviewer.forge().currentUser().id());
 984             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 985 
 986             // Populate the projects repository
 987             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 988             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 989             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 990 
 991             // Make a change with a corresponding PR
 992             var editHash = CheckableRepository.appendAndCommit(localRepo);
 993             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 994             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 995 
 996             // Enable a new check in the target branch
 997             localRepo.checkout(masterHash, true);
 998             CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 999                                      Set.of(&quot;author&quot;, &quot;reviewers&quot;, &quot;whitespace&quot;, &quot;issues&quot;), null);
1000             var headHash = localRepo.resolve(&quot;HEAD&quot;).orElseThrow();
1001             localRepo.push(headHash, author.url(), &quot;master&quot;, true);
1002 
1003             // Check the status
1004             TestBotRunner.runPeriodicItems(checkBot);
1005 
1006             // Verify that the check failed
1007             var checks = pr.checks(editHash);
1008             assertEquals(1, checks.size());
1009             var check = checks.get(&quot;jcheck&quot;);
1010             assertTrue(check.summary().orElseThrow().contains(&quot;commit message does not reference any issue&quot;));
1011             assertEquals(CheckStatus.FAILURE, check.status());
1012 
1013             // Adjust the title to conform and check the status again
1014             pr.setTitle(&quot;12345: This is a pull request&quot;);
1015             TestBotRunner.runPeriodicItems(checkBot);
1016 
1017             // Verify that the check passed
1018             checks = pr.checks(editHash);
1019             assertEquals(1, checks.size());
1020             check = checks.get(&quot;jcheck&quot;);
1021             assertEquals(CheckStatus.SUCCESS, check.status());
1022         }
1023     }
1024 
1025     @Test
1026     void draft(TestInfo testInfo) throws IOException {
1027         try (var credentials = new HostCredentials(testInfo);
1028              var tempFolder = new TemporaryDirectory()) {
1029             var author = credentials.getHostedRepository();
1030             var reviewer = credentials.getHostedRepository();
1031 
1032             var censusBuilder = credentials.getCensusBuilder()
1033                                            .addAuthor(author.forge().currentUser().id())
1034                                            .addReviewer(reviewer.forge().currentUser().id());
1035             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1036 
1037             // Populate the projects repository
1038             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1039             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1040             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1041 
1042             // Make a change with a corresponding PR
1043             var editHash = CheckableRepository.appendAndCommit(localRepo);
1044             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1045             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1046                                                    &quot;This is a pull request&quot;, true);
1047 
1048             // Check the status
1049             TestBotRunner.runPeriodicItems(checkBot);
1050 
1051             // Verify that the check succeeded
1052             var checks = pr.checks(editHash);
1053             assertEquals(1, checks.size());
1054             var check = checks.get(&quot;jcheck&quot;);
1055             assertEquals(CheckStatus.SUCCESS, check.status());
1056 
1057             // The PR should still not be ready for review as it is a draft
1058             assertFalse(pr.labels().contains(&quot;rfr&quot;));
1059             assertFalse(pr.labels().contains(&quot;ready&quot;));
1060         }
1061     }
1062 
1063     @Test
1064     void excessiveFailures(TestInfo testInfo) throws IOException {
1065         try (var credentials = new HostCredentials(testInfo);
1066              var tempFolder = new TemporaryDirectory()) {
1067             var author = credentials.getHostedRepository();
1068             var reviewer = credentials.getHostedRepository();
1069 
1070             var censusBuilder = credentials.getCensusBuilder()
1071                                            .addAuthor(author.forge().currentUser().id())
1072                                            .addReviewer(reviewer.forge().currentUser().id());
1073             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1074 
1075             // Populate the projects repository
1076             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1077             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1078             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1079 
1080             // Make a change with a corresponding PR containing more errors than at least GitHub can handle in a check
1081             var badContent = &quot;\tline   \n&quot;.repeat(200);
1082             var editHash = CheckableRepository.appendAndCommit(localRepo, badContent);
1083             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1084             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1085                                                    &quot;This is a pull request&quot;, true);
1086 
1087             // Check the status
1088             TestBotRunner.runPeriodicItems(checkBot);
1089 
1090             // Verify that the check failed
1091             var checks = pr.checks(editHash);
1092             assertEquals(1, checks.size());
1093             var check = checks.get(&quot;jcheck&quot;);
1094             assertEquals(CheckStatus.FAILURE, check.status());
1095         }
1096     }
1097 
1098     @Test
1099     void useJCheckConfFromTargetBranch(TestInfo testInfo) throws IOException {
1100         try (var credentials = new HostCredentials(testInfo);
1101              var tempFolder = new TemporaryDirectory()) {
1102             var author = credentials.getHostedRepository();
1103             var reviewer = credentials.getHostedRepository();
1104 
1105             var censusBuilder = credentials.getCensusBuilder()
1106                                            .addAuthor(author.forge().currentUser().id())
1107                                            .addReviewer(reviewer.forge().currentUser().id());
1108             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1109 
1110             // Populate the projects repository
1111             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1112             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1113             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1114 
1115             // Break the jcheck configuration on the &quot;edit&quot; branch
1116             var confPath = tempFolder.path().resolve(&quot;.jcheck/conf&quot;);
1117             var oldConf = Files.readString(confPath, StandardCharsets.UTF_8);
1118             Files.writeString(confPath, &quot;Hello there!&quot;, StandardCharsets.UTF_8);
1119             localRepo.add(confPath);
1120             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A change&quot;);
1121             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1122             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1123                                                    &quot;This is a pull request&quot;, true);
1124 
1125             // Check the status - should *not* throw because valid .jcheck/conf from
1126             // &quot;master&quot; branch should be used
1127             TestBotRunner.runPeriodicItems(checkBot);
1128             TestBotRunner.runPeriodicItems(checkBot);
1129             TestBotRunner.runPeriodicItems(checkBot);
1130 
1131             // Verify that the check succeeded
1132             var checks = pr.checks(editHash);
1133             assertEquals(1, checks.size());
1134             var check = checks.get(&quot;jcheck&quot;);
1135             assertEquals(CheckStatus.SUCCESS, check.status());
1136         }
1137     }
1138 
1139     @Test
1140     void noCommit(TestInfo testInfo) throws IOException {
1141         try (var credentials = new HostCredentials(testInfo);
1142              var tempFolder = new TemporaryDirectory()) {
1143             var author = credentials.getHostedRepository();
1144             var reviewer = credentials.getHostedRepository();
1145 
1146             var censusBuilder = credentials.getCensusBuilder()
1147                                            .addAuthor(author.forge().currentUser().id())
1148                                            .addReviewer(reviewer.forge().currentUser().id());
1149             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1150 
1151             // Populate the projects repository
1152             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1153             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1154             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1155 
1156             // Make a change with a corresponding PR
1157             var editHash = CheckableRepository.appendAndCommit(localRepo);
1158             localRepo.push(editHash, author.url(), &quot;master&quot;);
1159             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1160             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1161 
1162             // Check the status
1163             TestBotRunner.runPeriodicItems(checkBot);
1164 
1165             // Verify that the check failed
1166             var checks = pr.checks(editHash);
1167             assertEquals(1, checks.size());
1168             var check = checks.get(&quot;jcheck&quot;);
1169             assertEquals(CheckStatus.FAILURE, check.status());
1170         }
1171     }
1172 
1173     @Test
1174     void ignoreStale(TestInfo testInfo) throws IOException {
1175         try (var credentials = new HostCredentials(testInfo);
1176              var tempFolder = new TemporaryDirectory()) {
1177 
1178             var author = credentials.getHostedRepository();
1179             var reviewer = credentials.getHostedRepository();
1180 
1181             var censusBuilder = credentials.getCensusBuilder()
1182                                            .addAuthor(author.forge().currentUser().id())
1183                                            .addReviewer(reviewer.forge().currentUser().id());
1184             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).ignoreStaleReviews(true).build();
1185 
1186             // Populate the projects repository
1187             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1188             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1189             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1190 
1191             // Make a change with a corresponding PR
1192             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line with&quot;);
1193             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1194             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1195 
1196             // Check the status
1197             TestBotRunner.runPeriodicItems(checkBot);
1198 
1199             // Approve it as another user
1200             var approvalPr = reviewer.pullRequest(pr.id());
1201             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
1202 
1203             // Check the status
1204             TestBotRunner.runPeriodicItems(checkBot);
1205 
1206             // The PR should be flagged as ready
1207             assertTrue(pr.labels().contains(&quot;ready&quot;));
1208             assertFalse(pr.body().contains(&quot;Re-review required&quot;));
1209 
1210             // Add another commit
1211             editHash = CheckableRepository.replaceAndCommit(localRepo, &quot;Another line&quot;);
1212             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1213 
1214             // Make sure that the push registered
1215             var lastHeadHash = pr.headHash();
1216             var refreshCount = 0;
1217             do {
1218                 pr = author.pullRequest(pr.id());
1219                 if (refreshCount++ &gt; 100) {
1220                     fail(&quot;The PR did not update after the new push&quot;);
1221                 }
1222             } while (pr.headHash().equals(lastHeadHash));
1223 
1224             // Check the status again
1225             TestBotRunner.runPeriodicItems(checkBot);
1226 
1227             // The PR should no longer be ready, as the review is stale
1228             assertFalse(pr.labels().contains(&quot;ready&quot;));
1229             assertTrue(pr.labels().contains(&quot;rfr&quot;));
1230             assertTrue(pr.body().contains(&quot;Re-review required&quot;));
1231         }
1232     }
1233 
1234     @Test
1235     void targetBranchPattern(TestInfo testInfo) throws IOException {
1236         try (var credentials = new HostCredentials(testInfo);
1237              var tempFolder = new TemporaryDirectory()) {
1238             var author = credentials.getHostedRepository();
1239             var reviewer = credentials.getHostedRepository();
1240 
1241             var censusBuilder = credentials.getCensusBuilder()
1242                                            .addAuthor(author.forge().currentUser().id())
1243                                            .addReviewer(reviewer.forge().currentUser().id());
1244             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build())
1245                                          .allowedTargetBranches(&quot;^(?!master$).*&quot;)
1246                                          .build();
1247 
1248             // Populate the projects repository
1249             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1250             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1251             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1252             localRepo.push(masterHash, author.url(), &quot;notmaster&quot;, true);
1253 
1254             // Make a change with a corresponding PR
1255             var editHash = CheckableRepository.appendAndCommit(localRepo);
1256             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1257             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1258                                                    &quot;This is a pull request&quot;, true);
1259 
1260             // Check the status
1261             TestBotRunner.runPeriodicItems(checkBot);
1262 
1263             // Verify that the check failed
1264             var checks = pr.checks(editHash);
1265             assertEquals(1, checks.size());
1266             var check = checks.get(&quot;jcheck&quot;);
1267             assertEquals(CheckStatus.FAILURE, check.status());
1268             assertTrue(check.summary().orElseThrow().contains(&quot;The branch `master` is not allowed as target branch&quot;));
1269             assertTrue(check.summary().orElseThrow().contains(&quot;notmaster&quot;));
1270 
1271             var anotherPr = credentials.createPullRequest(author, &quot;notmaster&quot;, &quot;edit&quot;,
1272                                                    &quot;This is a pull request&quot;, true);
1273 
1274             // Check the status
1275             TestBotRunner.runPeriodicItems(checkBot);
1276 
1277             // Approve it as another user
1278             var approvalPr = reviewer.pullRequest(anotherPr.id());
1279             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
1280             TestBotRunner.runPeriodicItems(checkBot);
1281 
1282             // Verify that the check passed
1283             checks = anotherPr.checks(editHash);
1284             assertEquals(1, checks.size());
1285             check = checks.get(&quot;jcheck&quot;);
1286             assertEquals(CheckStatus.SUCCESS, check.status());
1287         }
1288     }
1289 
1290 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>