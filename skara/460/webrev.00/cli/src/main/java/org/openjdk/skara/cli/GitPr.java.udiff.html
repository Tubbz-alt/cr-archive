<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff cli/src/main/java/org/openjdk/skara/cli/GitPr.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GitJCheck.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Logging.java.udiff.html" target="_top">next &gt;</a></center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitPr.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -21,1622 +21,54 @@</span>
   * questions.
   */
  package org.openjdk.skara.cli;
  
  import org.openjdk.skara.args.*;
<span class="udiff-line-modified-removed">- import org.openjdk.skara.forge.*;</span>
<span class="udiff-line-removed">- import org.openjdk.skara.host.*;</span>
<span class="udiff-line-removed">- import org.openjdk.skara.issuetracker.IssueTracker;</span>
<span class="udiff-line-removed">- import org.openjdk.skara.issuetracker.Issue;</span>
<span class="udiff-line-removed">- import org.openjdk.skara.jcheck.JCheckConfiguration;</span>
<span class="udiff-line-modified-added">+ import org.openjdk.skara.cli.pr.*;</span>
  import org.openjdk.skara.proxy.HttpProxy;
<span class="udiff-line-removed">- import org.openjdk.skara.vcs.*;</span>
<span class="udiff-line-removed">- import org.openjdk.skara.vcs.openjdk.CommitMessageParsers;</span>
<span class="udiff-line-removed">- import org.openjdk.skara.version.Version;</span>
  
<span class="udiff-line-modified-removed">- import java.io.IOException;</span>
<span class="udiff-line-removed">- import java.net.URI;</span>
<span class="udiff-line-removed">- import java.nio.charset.StandardCharsets;</span>
<span class="udiff-line-removed">- import java.nio.file.*;</span>
<span class="udiff-line-removed">- import java.util.*;</span>
<span class="udiff-line-removed">- import java.util.regex.Pattern;</span>
<span class="udiff-line-removed">- import java.util.concurrent.TimeUnit;</span>
<span class="udiff-line-removed">- import java.util.logging.Level;</span>
<span class="udiff-line-removed">- import java.util.regex.Matcher;</span>
<span class="udiff-line-removed">- import java.util.stream.Collectors;</span>
<span class="udiff-line-modified-added">+ import java.util.List;</span>
  
  public class GitPr {
<span class="udiff-line-removed">-     private static final Pattern ISSUE_ID_PATTERN = Pattern.compile(&quot;([A-Za-z][A-Za-z0-9]+)?-([0-9]+)&quot;);</span>
<span class="udiff-line-removed">-     private static final Pattern ISSUE_MARKDOWN_PATTERN =</span>
<span class="udiff-line-removed">-         Pattern.compile(&quot;^(?: \\* )?\\[([A-Z]+-[0-9]+)\\]\\(https:\\/\\/bugs.openjdk.java.net\\/browse\\/[A-Z]+-[0-9]+\\): .*$&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void exit(String fmt, Object...args) {</span>
<span class="udiff-line-removed">-         System.err.println(String.format(fmt, args));</span>
<span class="udiff-line-removed">-         System.exit(1);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static String gitConfig(String key) {</span>
<span class="udiff-line-removed">-         try {</span>
<span class="udiff-line-removed">-             var pb = new ProcessBuilder(&quot;git&quot;, &quot;config&quot;, key);</span>
<span class="udiff-line-removed">-             pb.redirectOutput(ProcessBuilder.Redirect.PIPE);</span>
<span class="udiff-line-removed">-             pb.redirectError(ProcessBuilder.Redirect.DISCARD);</span>
<span class="udiff-line-removed">-             var p = pb.start();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var output = new String(p.getInputStream().readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="udiff-line-removed">-             var res = p.waitFor();</span>
<span class="udiff-line-removed">-             if (res != 0) {</span>
<span class="udiff-line-removed">-                 return null;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             return output == null ? null : output.replace(&quot;\n&quot;, &quot;&quot;);</span>
<span class="udiff-line-removed">-         } catch (InterruptedException e) {</span>
<span class="udiff-line-removed">-             return null;</span>
<span class="udiff-line-removed">-         } catch (IOException e) {</span>
<span class="udiff-line-removed">-             return null;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static String getOption(String name, Arguments arguments) {</span>
<span class="udiff-line-removed">-         return getOption(name, null, arguments);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static String getOption(String name, String subsection, Arguments arguments) {</span>
<span class="udiff-line-removed">-         if (arguments.contains(name)) {</span>
<span class="udiff-line-removed">-             return arguments.get(name).asString();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (subsection != null &amp;&amp; !subsection.isEmpty()) {</span>
<span class="udiff-line-removed">-             var subsectionSpecific = gitConfig(&quot;pr.&quot; + subsection + &quot;.&quot; + name);</span>
<span class="udiff-line-removed">-             if (subsectionSpecific != null) {</span>
<span class="udiff-line-removed">-                 return subsectionSpecific;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return gitConfig(&quot;fork.&quot; + name);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static boolean getSwitch(String name, Arguments arguments) {</span>
<span class="udiff-line-removed">-         return getSwitch(name, null, arguments);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static boolean getSwitch(String name, String subsection, Arguments arguments) {</span>
<span class="udiff-line-removed">-         if (arguments.contains(name)) {</span>
<span class="udiff-line-removed">-             return true;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (subsection != null &amp;&amp; !subsection.isEmpty()) {</span>
<span class="udiff-line-removed">-             var subsectionSpecific = gitConfig(&quot;pr.&quot; + subsection + &quot;.&quot; + name);</span>
<span class="udiff-line-removed">-             if (subsectionSpecific != null) {</span>
<span class="udiff-line-removed">-                 return subsectionSpecific.toLowerCase().equals(&quot;true&quot;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var sectionSpecific = gitConfig(&quot;fork.&quot; + name);</span>
<span class="udiff-line-removed">-         return sectionSpecific != null &amp;&amp; sectionSpecific.toLowerCase().equals(&quot;true&quot;);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static String rightPad(String s, int length) {</span>
<span class="udiff-line-removed">-         return String.format(&quot;%-&quot; + length + &quot;s&quot;, s);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void appendPaddedHTMLComment(Path file, String line) throws IOException {</span>
<span class="udiff-line-removed">-         var end = &quot; --&gt;&quot;;</span>
<span class="udiff-line-removed">-         var pad = 79 - end.length();</span>
<span class="udiff-line-removed">-         var newLine = &quot;\n&quot;;</span>
<span class="udiff-line-removed">-         Files.writeString(file, rightPad(&quot;&lt;!-- &quot; + line, pad) + end + newLine, StandardOpenOption.APPEND);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static String format(Issue issue) {</span>
<span class="udiff-line-removed">-         var parts = issue.id().split(&quot;-&quot;);</span>
<span class="udiff-line-removed">-         var id = parts.length == 2 ? parts[1] : issue.id();</span>
<span class="udiff-line-removed">-         return id + &quot;: &quot; + issue.title();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static String pullRequestIdArgument(ReadOnlyRepository repo, Arguments arguments) throws IOException {</span>
<span class="udiff-line-removed">-         if (arguments.at(0).isPresent()) {</span>
<span class="udiff-line-removed">-             return arguments.at(0).asString();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var currentBranch = repo.currentBranch();</span>
<span class="udiff-line-removed">-         if (currentBranch.isPresent()) {</span>
<span class="udiff-line-removed">-             var lines = repo.config(&quot;pr.&quot; + currentBranch.get().name() + &quot;.id&quot;);</span>
<span class="udiff-line-removed">-             if (lines.size() == 1) {</span>
<span class="udiff-line-removed">-                 return lines.get(0);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         exit(&quot;error: you must provide a pull request id&quot;);</span>
<span class="udiff-line-removed">-         return null;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static String statusForPullRequest(PullRequest pr) {</span>
<span class="udiff-line-removed">-         var labels = pr.labels();</span>
<span class="udiff-line-removed">-         if (pr.isDraft()) {</span>
<span class="udiff-line-removed">-             return &quot;DRAFT&quot;;</span>
<span class="udiff-line-removed">-         } else if (labels.contains(&quot;integrated&quot;)) {</span>
<span class="udiff-line-removed">-             return &quot;INTEGRATED&quot;;</span>
<span class="udiff-line-removed">-         } else if (labels.contains(&quot;ready&quot;)) {</span>
<span class="udiff-line-removed">-             return &quot;READY&quot;;</span>
<span class="udiff-line-removed">-         } else if (labels.contains(&quot;rfr&quot;)) {</span>
<span class="udiff-line-removed">-             return &quot;RFR&quot;;</span>
<span class="udiff-line-removed">-         } else if (labels.contains(&quot;outdated&quot;)) {</span>
<span class="udiff-line-removed">-             return &quot;OUTDATED&quot;;</span>
<span class="udiff-line-removed">-         } else if (labels.contains(&quot;oca&quot;)) {</span>
<span class="udiff-line-removed">-             return &quot;OCA&quot;;</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             var checks = pr.checks(pr.headHash());</span>
<span class="udiff-line-removed">-             var jcheck = Optional.ofNullable(checks.get(&quot;jcheck&quot;));</span>
<span class="udiff-line-removed">-             if (jcheck.isPresent()) {</span>
<span class="udiff-line-removed">-                 var checkStatus = jcheck.get().status();</span>
<span class="udiff-line-removed">-                 if (checkStatus == CheckStatus.IN_PROGRESS) {</span>
<span class="udiff-line-removed">-                     return &quot;CHECKING&quot;;</span>
<span class="udiff-line-removed">-                 } else if (checkStatus == CheckStatus.SUCCESS) {</span>
<span class="udiff-line-removed">-                     return &quot;RFR&quot;;</span>
<span class="udiff-line-removed">-                 } else if (checkStatus == CheckStatus.FAILURE) {</span>
<span class="udiff-line-removed">-                     return &quot;FAILURE&quot;;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 return &quot;CHECKING&quot;;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return &quot;UNKNOWN&quot;;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static String statusForCheck(Check check) {</span>
<span class="udiff-line-removed">-         var checkStatus = check.status();</span>
<span class="udiff-line-removed">-         if (checkStatus == CheckStatus.IN_PROGRESS) {</span>
<span class="udiff-line-removed">-             return &quot;RUNNING&quot;;</span>
<span class="udiff-line-removed">-         } else if (checkStatus == CheckStatus.SUCCESS) {</span>
<span class="udiff-line-removed">-             return &quot;OK&quot;;</span>
<span class="udiff-line-removed">-         } else if (checkStatus == CheckStatus.FAILURE) {</span>
<span class="udiff-line-removed">-             return &quot;FAILED&quot;;</span>
<span class="udiff-line-removed">-         } else if (checkStatus == CheckStatus.CANCELLED) {</span>
<span class="udiff-line-removed">-             return &quot;CANCELLED&quot;;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return &quot;UNKNOWN&quot;;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static List&lt;String&gt; issuesFromPullRequest(PullRequest pr) {</span>
<span class="udiff-line-removed">-         var issueTitleIndex = -1;</span>
<span class="udiff-line-removed">-         var lines = pr.body().split(&quot;\n&quot;);</span>
<span class="udiff-line-removed">-         for (var i = 0; i &lt; lines.length; i++) {</span>
<span class="udiff-line-removed">-             if (lines[i].startsWith(&quot;### Issue&quot;)) {</span>
<span class="udiff-line-removed">-                 issueTitleIndex = i;</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (issueTitleIndex == -1) {</span>
<span class="udiff-line-removed">-             return List.of();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var issues = new ArrayList&lt;String&gt;();</span>
<span class="udiff-line-removed">-         for (var i = issueTitleIndex + 1; i &lt; lines.length; i++) {</span>
<span class="udiff-line-removed">-             var m = ISSUE_MARKDOWN_PATTERN.matcher(lines[i]);</span>
<span class="udiff-line-removed">-             if (m.matches()) {</span>
<span class="udiff-line-removed">-                 issues.add(m.group(1));</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return issues;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static String jbsProjectFromJcheckConf(Repository repo, String targetBranch) throws IOException {</span>
<span class="udiff-line-removed">-         var conf = JCheckConfiguration.from(repo, repo.resolve(targetBranch).orElseThrow(() -&gt;</span>
<span class="udiff-line-removed">-             new IOException(&quot;Could not resolve &#39;&quot; + targetBranch + &quot;&#39; branch&quot;)</span>
<span class="udiff-line-removed">-         ));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return conf.general().jbs();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static Optional&lt;Issue&gt; getIssue(Commit commit, String project) throws IOException {</span>
<span class="udiff-line-removed">-         var message = CommitMessageParsers.v1.parse(commit.message());</span>
<span class="udiff-line-removed">-         var issues = message.issues();</span>
<span class="udiff-line-removed">-         if (issues.isEmpty()) {</span>
<span class="udiff-line-removed">-             return getIssue(message.title(), project);</span>
<span class="udiff-line-removed">-         } else if (issues.size() == 1) {</span>
<span class="udiff-line-removed">-             var issue = issues.get(0);</span>
<span class="udiff-line-removed">-             return getIssue(issue.id(), project);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return Optional.empty();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static Optional&lt;Issue&gt; getIssue(Branch b, String project) throws IOException {</span>
<span class="udiff-line-removed">-         return getIssue(b.name(), project);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static Optional&lt;Issue&gt; getIssue(String s, String project) throws IOException {</span>
<span class="udiff-line-removed">-         var m = ISSUE_ID_PATTERN.matcher(s);</span>
<span class="udiff-line-removed">-         if (m.matches()) {</span>
<span class="udiff-line-removed">-             var id = m.group(2);</span>
<span class="udiff-line-removed">-             if (project == null) {</span>
<span class="udiff-line-removed">-                 project = m.group(1);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             var issueTracker = IssueTracker.from(&quot;jira&quot;, URI.create(&quot;https://bugs.openjdk.java.net&quot;));</span>
<span class="udiff-line-removed">-             return issueTracker.project(project).issue(id);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return Optional.empty();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void await(Process p, Integer... allowedExitCodes) throws IOException {</span>
<span class="udiff-line-removed">-         var allowed = new HashSet&lt;&gt;(Arrays.asList(allowedExitCodes));</span>
<span class="udiff-line-removed">-         allowed.add(0);</span>
<span class="udiff-line-removed">-         try {</span>
<span class="udiff-line-removed">-             var res = p.waitFor();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             if (!allowed.contains(res)) {</span>
<span class="udiff-line-removed">-                 throw new IOException(&quot;Unexpected exit code &quot; + res);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         } catch (InterruptedException e) {</span>
<span class="udiff-line-removed">-             throw new IOException(e);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static boolean spawnEditor(ReadOnlyRepository repo, Path file) throws IOException {</span>
<span class="udiff-line-removed">-         String editor = null;</span>
<span class="udiff-line-removed">-         var lines = repo.config(&quot;core.editor&quot;);</span>
<span class="udiff-line-removed">-         if (lines.size() == 1) {</span>
<span class="udiff-line-removed">-             editor = lines.get(0);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (editor == null) {</span>
<span class="udiff-line-removed">-             editor = System.getenv(&quot;GIT_EDITOR&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (editor == null) {</span>
<span class="udiff-line-removed">-             editor = System.getenv(&quot;EDITOR&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (editor == null) {</span>
<span class="udiff-line-removed">-             editor = System.getenv(&quot;VISUAL&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (editor == null) {</span>
<span class="udiff-line-removed">-             editor = &quot;vi&quot;;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // As an editor command may have multiple arguments, we need to add each single one</span>
<span class="udiff-line-removed">-         // to the ProcessBuilder. Arguments are split by whitespace and can be quoted.</span>
<span class="udiff-line-removed">-         // e.g. I found core.editor =</span>
<span class="udiff-line-removed">-         // \&quot;C:\\\\Program Files\\\\Notepad++\\\\notepad++.exe\&quot; -multiInst -notabbar -nosession -noPlugin</span>
<span class="udiff-line-removed">-         List&lt;String&gt; editorParts = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-removed">-         Matcher em = Pattern.compile(&quot;\\s*([^\&quot;]\\S*|\&quot;.+?\&quot;)\\s*&quot;).matcher(editor);</span>
<span class="udiff-line-removed">-         while (em.find()) {</span>
<span class="udiff-line-removed">-             editorParts.add(em.group(1));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         editorParts.add(file.toString());</span>
<span class="udiff-line-removed">-         var pb = new ProcessBuilder(editorParts);</span>
<span class="udiff-line-removed">-         pb.inheritIO();</span>
<span class="udiff-line-removed">-         var p = pb.start();</span>
<span class="udiff-line-removed">-         try {</span>
<span class="udiff-line-removed">-             return p.waitFor() == 0;</span>
<span class="udiff-line-removed">-         } catch (InterruptedException e) {</span>
<span class="udiff-line-removed">-             throw new IOException(e);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static String projectName(URI uri) {</span>
<span class="udiff-line-removed">-         var name = uri.getPath().toString().substring(1);</span>
<span class="udiff-line-removed">-         if (name.endsWith(&quot;.git&quot;)) {</span>
<span class="udiff-line-removed">-             name = name.substring(0, name.length() - &quot;.git&quot;.length());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return name;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static HostedRepository getHostedRepositoryFor(URI uri, ReadOnlyRepository repo, Forge host) throws IOException {</span>
<span class="udiff-line-removed">-         HostedRepository targetRepo = null;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         try {</span>
<span class="udiff-line-removed">-             var upstream = Remote.toWebURI(repo.pullPath(&quot;upstream&quot;));</span>
<span class="udiff-line-removed">-             targetRepo = host.repository(projectName(upstream)).orElse(null);</span>
<span class="udiff-line-removed">-         } catch (IOException e) {</span>
<span class="udiff-line-removed">-             // do nothing</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (targetRepo == null) {</span>
<span class="udiff-line-removed">-             var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;</span>
<span class="udiff-line-removed">-                     new IOException(&quot;Could not find repository at: &quot; + uri.toString())</span>
<span class="udiff-line-removed">-             );</span>
<span class="udiff-line-removed">-             var parentRepo = remoteRepo.parent();</span>
<span class="udiff-line-removed">-             targetRepo = parentRepo.isPresent() ? parentRepo.get() : remoteRepo;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return targetRepo;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static PullRequest getPullRequest(URI uri, ReadOnlyRepository repo, Forge host, String prId) throws IOException {</span>
<span class="udiff-line-removed">-         var pr = getHostedRepositoryFor(uri, repo, host).pullRequest(prId);</span>
<span class="udiff-line-removed">-         if (pr == null) {</span>
<span class="udiff-line-removed">-             exit(&quot;error: could not fetch PR information&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return pr;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void show(String ref, Hash hash) throws IOException {</span>
<span class="udiff-line-removed">-         show(ref, hash, null);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     private static void show(String ref, Hash hash, Path dir) throws IOException {</span>
<span class="udiff-line-removed">-         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,</span>
<span class="udiff-line-removed">-                                                    &quot;--patch&quot;,</span>
<span class="udiff-line-removed">-                                                    &quot;--find-renames=50%&quot;,</span>
<span class="udiff-line-removed">-                                                    &quot;--find-copies=50%&quot;,</span>
<span class="udiff-line-removed">-                                                    &quot;--find-copies-harder&quot;,</span>
<span class="udiff-line-removed">-                                                    &quot;--abbrev&quot;,</span>
<span class="udiff-line-removed">-                                                    ref + &quot;...&quot; + hash.hex());</span>
<span class="udiff-line-removed">-         if (dir != null) {</span>
<span class="udiff-line-removed">-             pb.directory(dir.toFile());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         pb.inheritIO();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // git will return 141 (128 + 13) when it receive SIGPIPE (signal 13) from</span>
<span class="udiff-line-removed">-         // e.g. less when a user exits less when looking at a large diff. Therefore</span>
<span class="udiff-line-removed">-         // must allow 141 as a valid exit code.</span>
<span class="udiff-line-removed">-         await(pb.start(), 141);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static Path diff(String ref, Hash hash) throws IOException {</span>
<span class="udiff-line-removed">-         return diff(ref, hash, null);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static Path diff(String ref, Hash hash, Path dir) throws IOException {</span>
<span class="udiff-line-removed">-         var patch = Files.createTempFile(hash.hex(), &quot;.patch&quot;);</span>
<span class="udiff-line-removed">-         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,</span>
<span class="udiff-line-removed">-                                                    &quot;--patch&quot;,</span>
<span class="udiff-line-removed">-                                                    &quot;--find-renames=50%&quot;,</span>
<span class="udiff-line-removed">-                                                    &quot;--find-copies=50%&quot;,</span>
<span class="udiff-line-removed">-                                                    &quot;--find-copies-harder&quot;,</span>
<span class="udiff-line-removed">-                                                    &quot;--abbrev&quot;,</span>
<span class="udiff-line-removed">-                                                    ref + &quot;...&quot; + hash.hex());</span>
<span class="udiff-line-removed">-         if (dir != null) {</span>
<span class="udiff-line-removed">-             pb.directory(dir.toFile());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         pb.redirectOutput(patch.toFile());</span>
<span class="udiff-line-removed">-         pb.redirectError(ProcessBuilder.Redirect.INHERIT);</span>
<span class="udiff-line-removed">-         await(pb.start());</span>
<span class="udiff-line-removed">-         return patch;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void apply(Path patch) throws IOException {</span>
<span class="udiff-line-removed">-         var pb = new ProcessBuilder(&quot;git&quot;, &quot;apply&quot;, &quot;--no-commit&quot;, patch.toString());</span>
<span class="udiff-line-removed">-         pb.inheritIO();</span>
<span class="udiff-line-removed">-         await(pb.start());</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static int longest(List&lt;String&gt; strings) {</span>
<span class="udiff-line-removed">-         return strings.stream().mapToInt(String::length).max().orElse(0);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static String removeTrailing(String s, String trail) {</span>
<span class="udiff-line-removed">-         return s.endsWith(trail) ?</span>
<span class="udiff-line-removed">-             s.substring(0, s.length() - trail.length()) :</span>
<span class="udiff-line-removed">-             s;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static Repository getRepo() throws IOException {</span>
<span class="udiff-line-removed">-         var cwd = Path.of(&quot;&quot;).toAbsolutePath();</span>
<span class="udiff-line-removed">-         return Repository.get(cwd).orElseThrow(() -&gt; new IOException(&quot;no git repository found at &quot; + cwd.toString()));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static Arguments parse(ArgumentParser parser, String[] args) {</span>
<span class="udiff-line-removed">-         var arguments = parser.parse(args);</span>
<span class="udiff-line-removed">-         if (arguments.contains(&quot;version&quot;)) {</span>
<span class="udiff-line-removed">-             System.out.println(&quot;git-pr version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));</span>
<span class="udiff-line-removed">-             System.exit(0);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {</span>
<span class="udiff-line-removed">-             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;</span>
<span class="udiff-line-removed">-             Logging.setup(level);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return arguments;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static String getRemote(ReadOnlyRepository repo, Arguments arguments) throws IOException {</span>
<span class="udiff-line-removed">-         var remote = getOption(&quot;remote&quot;, arguments);</span>
<span class="udiff-line-removed">-         return remote == null ? &quot;origin&quot; : remote;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static URI getURI(ReadOnlyRepository repo, Arguments arguments) throws IOException {</span>
<span class="udiff-line-removed">-         var remotePullPath = repo.pullPath(getRemote(repo, arguments));</span>
<span class="udiff-line-removed">-         return Remote.toWebURI(remotePullPath);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static Forge getForge(URI uri, ReadOnlyRepository repo, Arguments arguments) throws IOException {</span>
<span class="udiff-line-removed">-         var username = getOption(&quot;username&quot;, arguments);</span>
<span class="udiff-line-removed">-         var token = System.getenv(&quot;GIT_TOKEN&quot;);</span>
<span class="udiff-line-removed">-         var shouldUseToken = !getSwitch(&quot;no-token&quot;, arguments);</span>
<span class="udiff-line-removed">-         var credentials = !shouldUseToken ?</span>
<span class="udiff-line-removed">-             null :</span>
<span class="udiff-line-removed">-             GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());</span>
<span class="udiff-line-removed">-         var forgeURI = URI.create(uri.getScheme() + &quot;://&quot; + uri.getHost());</span>
<span class="udiff-line-removed">-         var forge = credentials == null ?</span>
<span class="udiff-line-removed">-             Forge.from(forgeURI) :</span>
<span class="udiff-line-removed">-             Forge.from(forgeURI, new Credential(credentials.username(), credentials.password()));</span>
<span class="udiff-line-removed">-         if (forge.isEmpty()) {</span>
<span class="udiff-line-removed">-             if (!shouldUseToken) {</span>
<span class="udiff-line-removed">-                 if (arguments.contains(&quot;verbose&quot;)) {</span>
<span class="udiff-line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;warning: using git-pr with --no-token may result in rate limiting from &quot; + forgeURI);</span>
<span class="udiff-line-removed">-                 if (!arguments.contains(&quot;verbose&quot;)) {</span>
<span class="udiff-line-removed">-                     System.err.println(&quot;         Re-run git-pr with --verbose to see if you are being rate limited&quot;);</span>
<span class="udiff-line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             exit(&quot;error: failed to connect to host: &quot; + forgeURI);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return forge.get();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void create(String[] args) throws IOException, InterruptedException {</span>
<span class="udiff-line-removed">-         var flags = List.of(</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;u&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;username&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Username on host&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;r&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;remote&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;b&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;branch&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;ignore-workspace&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Ignore local changes in worktree and staging area when creating pull request&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;ignore-local-commits&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Ignore local commits not pushed when creating pull request&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;publish&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Publish the local branch before creating the pull request&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;jcheck&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Run jcheck before creating the pull request&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;verbose&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;debug&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;version&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="udiff-line-removed">-                   .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var inputs = List.of(</span>
<span class="udiff-line-removed">-             Input.position(0)</span>
<span class="udiff-line-removed">-                  .describe(&quot;ID&quot;)</span>
<span class="udiff-line-removed">-                  .singular()</span>
<span class="udiff-line-removed">-                  .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="udiff-line-removed">-         var arguments = parse(parser, args);</span>
<span class="udiff-line-removed">-         var repo = getRepo();</span>
<span class="udiff-line-removed">-         var uri = getURI(repo, arguments);</span>
<span class="udiff-line-removed">-         var host = getForge(uri, repo, arguments);</span>
<span class="udiff-line-removed">-         var remote = getRemote(repo, arguments);</span>
<span class="udiff-line-removed">-         var currentBranch = repo.currentBranch().orElseGet(() -&gt; {</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;error: the repository is in a detached HEAD state&quot;);</span>
<span class="udiff-line-removed">-                 System.exit(1);</span>
<span class="udiff-line-removed">-                 return null;</span>
<span class="udiff-line-removed">-         });</span>
<span class="udiff-line-removed">-         if (currentBranch.equals(repo.defaultBranch())) {</span>
<span class="udiff-line-removed">-             System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; branch&quot;);</span>
<span class="udiff-line-removed">-             System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-             System.err.println(&quot;To create a local branch for your changes and restore the &#39;master&#39; branch, run:&quot;);</span>
<span class="udiff-line-removed">-             System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-             System.err.println(&quot;    git checkout -b NAME-FOR-YOUR-LOCAL-BRANCH&quot;);</span>
<span class="udiff-line-removed">-             System.err.println(&quot;    git branch --force master origin/master&quot;);</span>
<span class="udiff-line-removed">-             System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-             System.exit(1);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var ignoreWorkspace = getSwitch(&quot;ignore-workspace&quot;, &quot;create&quot;, arguments);</span>
<span class="udiff-line-removed">-         if (!ignoreWorkspace) {</span>
<span class="udiff-line-removed">-             var diff = repo.diff(repo.head());</span>
<span class="udiff-line-removed">-             if (!diff.patches().isEmpty()) {</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 for (var patch : diff.patches()) {</span>
<span class="udiff-line-removed">-                     var path = patch.target().path().isPresent() ?</span>
<span class="udiff-line-removed">-                         patch.target().path().get() : patch.source().path().get();</span>
<span class="udiff-line-removed">-                     System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;    git stash&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);</span>
<span class="udiff-line-removed">-                 System.exit(1);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var upstream = repo.upstreamFor(currentBranch);</span>
<span class="udiff-line-removed">-         if (upstream.isEmpty()) {</span>
<span class="udiff-line-removed">-             var shouldPublish = getSwitch(&quot;publish&quot;, &quot;create&quot;, arguments);</span>
<span class="udiff-line-removed">-             if (shouldPublish) {</span>
<span class="udiff-line-removed">-                 GitPublish.main(new String[] { &quot;--quiet&quot;, remote });</span>
<span class="udiff-line-removed">-                 upstream = repo.upstreamFor(currentBranch);</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;error: there is no remote branch for the local branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;A remote branch must be present at &quot; + uri + &quot; to create a pull request&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;    git publish&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;If you created the remote branch from another client, you must update this repository.&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;To update remote information for this repository, run:&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;    git fetch &quot; + remote);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;    git branch --set-upstream &quot; + currentBranch + &quot; &quot; + remote + &quot;/&quot; + currentBranch);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.exit(1);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var upstreamRefName = upstream.get().substring(remote.length() + 1);</span>
<span class="udiff-line-removed">-         repo.fetch(uri, upstreamRefName);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var shouldIgnoreLocalCommits = getSwitch(&quot;ignore-local-commits&quot;, &quot;create&quot;, arguments);</span>
<span class="udiff-line-removed">-         if (!shouldIgnoreLocalCommits) {</span>
<span class="udiff-line-removed">-             var branchCommits = repo.commits(upstream.get() + &quot;..&quot; + currentBranch.name()).asList();</span>
<span class="udiff-line-removed">-             if (!branchCommits.isEmpty()) {</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;error: there are local commits on branch &#39;&quot; + currentBranch.name() + &quot;&#39; not present in the remote repository &quot; + uri);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;All commits must be present in the remote repository to be part of the pull request&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;The following commits are not present in the remote repository:&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 for (var commit : branchCommits) {</span>
<span class="udiff-line-removed">-                     System.err.println(&quot;- &quot; + commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0));</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;To push the above local commits to the remote repository, run:&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;    git push &quot; + remote + &quot; &quot; + currentBranch.name());</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="udiff-line-removed">-                 System.exit(1);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;</span>
<span class="udiff-line-removed">-                 new IOException(&quot;Could not find repository at &quot; + uri.toString())</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">-         var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;</span>
<span class="udiff-line-removed">-                 new IOException(&quot;error: remote repository &quot; + uri + &quot; is not a fork of any repository&quot;)</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var targetBranch = getOption(&quot;branch&quot;, &quot;create&quot;, arguments);</span>
<span class="udiff-line-removed">-         if (targetBranch == null) {</span>
<span class="udiff-line-removed">-             var upstreamBranchNames = repo.remoteBranches(parentRepo.webUrl().toString())</span>
<span class="udiff-line-removed">-                                           .stream()</span>
<span class="udiff-line-removed">-                                           .map(r -&gt; r.name())</span>
<span class="udiff-line-removed">-                                           .collect(Collectors.toSet());</span>
<span class="udiff-line-removed">-             var remoteBranches = repo.branches(remote);</span>
<span class="udiff-line-removed">-             var candidates = new ArrayList&lt;Branch&gt;();</span>
<span class="udiff-line-removed">-             for (var b : remoteBranches) {</span>
<span class="udiff-line-removed">-                 var withoutRemotePrefix = b.name().substring(remote.length() + 1);</span>
<span class="udiff-line-removed">-                 if (upstreamBranchNames.contains(withoutRemotePrefix)) {</span>
<span class="udiff-line-removed">-                     candidates.add(b);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var localBranches = repo.branches();</span>
<span class="udiff-line-removed">-             Branch closest = null;</span>
<span class="udiff-line-removed">-             var shortestDistance = Integer.MAX_VALUE;</span>
<span class="udiff-line-removed">-             for (var b : candidates) {</span>
<span class="udiff-line-removed">-                 var from = b.name();</span>
<span class="udiff-line-removed">-                 for (var localBranch : localBranches) {</span>
<span class="udiff-line-removed">-                     var trackingBranch = repo.upstreamFor(localBranch);</span>
<span class="udiff-line-removed">-                     if (trackingBranch.isPresent() &amp;&amp;</span>
<span class="udiff-line-removed">-                         trackingBranch.get().equals(b.name())) {</span>
<span class="udiff-line-removed">-                         from = localBranch.name();</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 var distance = repo.commitMetadata(from + &quot;...&quot; + currentBranch.name()).size();</span>
<span class="udiff-line-removed">-                 if (distance &lt; shortestDistance) {</span>
<span class="udiff-line-removed">-                     closest = b;</span>
<span class="udiff-line-removed">-                     shortestDistance = distance;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             if (closest != null) {</span>
<span class="udiff-line-removed">-                 targetBranch = closest.name().substring(remote.length() + 1);</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;error: cannot automatically infer target branch&quot;);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;       use --branch to specify target branch&quot;);</span>
<span class="udiff-line-removed">-                 System.exit(1);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         var commits = repo.commits(targetBranch + &quot;..&quot; + upstream.get()).asList();</span>
<span class="udiff-line-removed">-         if (commits.isEmpty()) {</span>
<span class="udiff-line-removed">-             System.err.println(&quot;error: no difference between branches &quot; + targetBranch + &quot; and &quot; + currentBranch.name());</span>
<span class="udiff-line-removed">-             System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);</span>
<span class="udiff-line-removed">-             System.exit(1);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var shouldRunJCheck = getSwitch(&quot;jcheck&quot;, &quot;create&quot;, arguments);</span>
<span class="udiff-line-removed">-         if (shouldRunJCheck) {</span>
<span class="udiff-line-removed">-             var jcheckArgs = new String[]{ &quot;--pull-request&quot;, &quot;--rev&quot;, targetBranch + &quot;..&quot; + upstream.get() };</span>
<span class="udiff-line-removed">-             var err = GitJCheck.run(jcheckArgs);</span>
<span class="udiff-line-removed">-             if (err != 0) {</span>
<span class="udiff-line-removed">-                 System.exit(err);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var project = jbsProjectFromJcheckConf(repo, targetBranch);</span>
<span class="udiff-line-removed">-         var issue = getIssue(currentBranch, project);</span>
<span class="udiff-line-removed">-         var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.md&quot;);</span>
<span class="udiff-line-removed">-         if (issue.isPresent()) {</span>
<span class="udiff-line-removed">-             Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);</span>
<span class="udiff-line-removed">-         } else if (commits.size() == 1) {</span>
<span class="udiff-line-removed">-             var commit = commits.get(0);</span>
<span class="udiff-line-removed">-             issue = getIssue(commit, project);</span>
<span class="udiff-line-removed">-             if (issue.isPresent()) {</span>
<span class="udiff-line-removed">-                 Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 var message = CommitMessageParsers.v1.parse(commit.message());</span>
<span class="udiff-line-removed">-                 Files.writeString(file, message.title() + &quot;\n&quot;);</span>
<span class="udiff-line-removed">-                 if (!message.summaries().isEmpty()) {</span>
<span class="udiff-line-removed">-                     Files.write(file, message.summaries(), StandardOpenOption.APPEND);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 if (!message.additional().isEmpty()) {</span>
<span class="udiff-line-removed">-                     Files.write(file, message.additional(), StandardOpenOption.APPEND);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             Files.write(file, List.of(&quot;&quot;));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         appendPaddedHTMLComment(file, &quot;Please enter the pull request message for your changes.&quot;);</span>
<span class="udiff-line-removed">-         appendPaddedHTMLComment(file, &quot;The first line will be considered the subject, use a blank line to&quot;);</span>
<span class="udiff-line-removed">-         appendPaddedHTMLComment(file, &quot;separate the subject from the body. These HTML comment lines will&quot;);</span>
<span class="udiff-line-removed">-         appendPaddedHTMLComment(file, &quot;be removed automatically. An empty message aborts the pull request.&quot;);</span>
<span class="udiff-line-removed">-         appendPaddedHTMLComment(file, &quot;&quot;);</span>
<span class="udiff-line-removed">-         appendPaddedHTMLComment(file, &quot;Commits to be included from branch &#39;&quot; + currentBranch.name() + &quot;&#39;:&quot;);</span>
<span class="udiff-line-removed">-         for (var commit : commits) {</span>
<span class="udiff-line-removed">-             var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);</span>
<span class="udiff-line-removed">-             appendPaddedHTMLComment(file, &quot;- &quot; + desc);</span>
<span class="udiff-line-removed">-             if (!commit.isMerge()) {</span>
<span class="udiff-line-removed">-                 var diff = commit.parentDiffs().get(0);</span>
<span class="udiff-line-removed">-                 for (var patch : diff.patches()) {</span>
<span class="udiff-line-removed">-                     var status = patch.status();</span>
<span class="udiff-line-removed">-                     if (status.isModified()) {</span>
<span class="udiff-line-removed">-                         appendPaddedHTMLComment(file, &quot;  M  &quot; + patch.target().path().get().toString());</span>
<span class="udiff-line-removed">-                     } else if (status.isAdded()) {</span>
<span class="udiff-line-removed">-                         appendPaddedHTMLComment(file, &quot;  A  &quot; + patch.target().path().get().toString());</span>
<span class="udiff-line-removed">-                     } else if (status.isDeleted()) {</span>
<span class="udiff-line-removed">-                         appendPaddedHTMLComment(file, &quot;  D  &quot; + patch.source().path().get().toString());</span>
<span class="udiff-line-removed">-                     } else if (status.isRenamed()) {</span>
<span class="udiff-line-removed">-                         appendPaddedHTMLComment(file, &quot;  R  &quot; + patch.target().path().get().toString());</span>
<span class="udiff-line-removed">-                         appendPaddedHTMLComment(file, &quot;      (&quot; + patch.source().path().get().toString() + &quot;)&quot;);</span>
<span class="udiff-line-removed">-                     } else if (status.isCopied()) {</span>
<span class="udiff-line-removed">-                         appendPaddedHTMLComment(file, &quot;  C  &quot; + patch.target().path().get().toString());</span>
<span class="udiff-line-removed">-                         appendPaddedHTMLComment(file, &quot;      (&quot; + patch.source().path().get().toString() + &quot;)&quot;);</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         appendPaddedHTMLComment(file, &quot;&quot;);</span>
<span class="udiff-line-removed">-         if (issue.isPresent()) {</span>
<span class="udiff-line-removed">-             appendPaddedHTMLComment(file, &quot;Issue:      &quot; + issue.get().webUrl());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         appendPaddedHTMLComment(file, &quot;Repository: &quot; + parentRepo.webUrl());</span>
<span class="udiff-line-removed">-         appendPaddedHTMLComment(file, &quot;Branch:     &quot; + targetBranch);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var success = spawnEditor(repo, file);</span>
<span class="udiff-line-removed">-         if (!success) {</span>
<span class="udiff-line-removed">-             System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);</span>
<span class="udiff-line-removed">-             System.exit(1);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         var lines = Files.readAllLines(file)</span>
<span class="udiff-line-removed">-                          .stream()</span>
<span class="udiff-line-removed">-                          .filter(l -&gt; !(l.startsWith(&quot;&lt;!--&quot;) &amp;&amp; l.endsWith(&quot;--&gt;&quot;)))</span>
<span class="udiff-line-removed">-                          .collect(Collectors.toList());</span>
<span class="udiff-line-removed">-         var isEmpty = lines.stream().allMatch(String::isEmpty);</span>
<span class="udiff-line-removed">-         if (isEmpty) {</span>
<span class="udiff-line-removed">-             System.err.println(&quot;error: no message present, aborting&quot;);</span>
<span class="udiff-line-removed">-             System.exit(1);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var title = lines.get(0);</span>
<span class="udiff-line-removed">-         List&lt;String&gt; body = null;</span>
<span class="udiff-line-removed">-         if (lines.size() &gt; 1) {</span>
<span class="udiff-line-removed">-             body = lines.subList(1, lines.size())</span>
<span class="udiff-line-removed">-                         .stream()</span>
<span class="udiff-line-removed">-                         .dropWhile(String::isEmpty)</span>
<span class="udiff-line-removed">-                         .collect(Collectors.toList());</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             body = Collections.emptyList();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);</span>
<span class="udiff-line-removed">-         var assigneesOption = getOption(&quot;assignees&quot;, &quot;create&quot;, arguments);</span>
<span class="udiff-line-removed">-         if (assigneesOption != null) {</span>
<span class="udiff-line-removed">-             var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="udiff-line-removed">-             var assignees = usernames.stream()</span>
<span class="udiff-line-removed">-                                      .map(u -&gt; host.user(u))</span>
<span class="udiff-line-removed">-                                      .filter(Optional::isPresent)</span>
<span class="udiff-line-removed">-                                      .map(Optional::get)</span>
<span class="udiff-line-removed">-                                      .collect(Collectors.toList());</span>
<span class="udiff-line-removed">-             pr.setAssignees(assignees);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         System.out.println(pr.webUrl().toString());</span>
<span class="udiff-line-removed">-         Files.deleteIfExists(file);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         repo.config(&quot;pr.&quot; + currentBranch.name(), &quot;id&quot;, pr.id().toString());</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void integrate(String[] args) throws IOException, InterruptedException {</span>
<span class="udiff-line-removed">-         var flags = List.of(</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;u&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;username&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Username on host&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;r&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;remote&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;atomic&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Integrate the pull request atomically&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;verbose&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;debug&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;version&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="udiff-line-removed">-                   .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var inputs = List.of(</span>
<span class="udiff-line-removed">-             Input.position(0)</span>
<span class="udiff-line-removed">-                  .describe(&quot;ID&quot;)</span>
<span class="udiff-line-removed">-                  .singular()</span>
<span class="udiff-line-removed">-                  .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="udiff-line-removed">-         var arguments = parse(parser, args);</span>
<span class="udiff-line-removed">-         var repo = getRepo();</span>
<span class="udiff-line-removed">-         var uri = getURI(repo, arguments);</span>
<span class="udiff-line-removed">-         var host = getForge(uri, repo, arguments);</span>
<span class="udiff-line-removed">-         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="udiff-line-removed">-         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="udiff-line-removed">-         var isAtomic = getSwitch(&quot;atomic&quot;, &quot;integrate&quot;, arguments);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var message = &quot;/integrate&quot;;</span>
<span class="udiff-line-removed">-         if (isAtomic) {</span>
<span class="udiff-line-removed">-             var targetHash = repo.resolve(pr.targetRef());</span>
<span class="udiff-line-removed">-             if (!targetHash.isPresent()) {</span>
<span class="udiff-line-removed">-                 exit(&quot;error: cannot resolve target branch &quot; + pr.targetRef());</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             var sourceHash = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="udiff-line-removed">-             var mergeBase = repo.mergeBase(sourceHash, targetHash.get());</span>
<span class="udiff-line-removed">-             message += &quot; &quot; + mergeBase.hex();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var integrateComment = pr.addComment(message);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var seenIntegrateComment = false;</span>
<span class="udiff-line-removed">-         var expected = &quot;&lt;!-- Jmerge command reply message (&quot; + integrateComment.id() + &quot;) --&gt;&quot;;</span>
<span class="udiff-line-removed">-         for (var i = 0; i &lt; 90; i++) {</span>
<span class="udiff-line-removed">-             var comments = pr.comments();</span>
<span class="udiff-line-removed">-             for (var comment : comments) {</span>
<span class="udiff-line-removed">-                 if (!seenIntegrateComment) {</span>
<span class="udiff-line-removed">-                     if (comment.id().equals(integrateComment.id())) {</span>
<span class="udiff-line-removed">-                         seenIntegrateComment = true;</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     continue;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 var lines = comment.body().split(&quot;\n&quot;);</span>
<span class="udiff-line-removed">-                 if (lines.length &gt; 0 &amp;&amp; lines[0].equals(expected)) {</span>
<span class="udiff-line-removed">-                     for (var line : lines) {</span>
<span class="udiff-line-removed">-                         if (line.startsWith(&quot;Pushed as commit&quot;)) {</span>
<span class="udiff-line-removed">-                             var output = removeTrailing(line, &quot;.&quot;);</span>
<span class="udiff-line-removed">-                             System.out.println(output);</span>
<span class="udiff-line-removed">-                             System.exit(0);</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             Thread.sleep(2000);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         System.err.println(&quot;error: timed out waiting for response to /integrate command&quot;);</span>
<span class="udiff-line-removed">-         System.exit(1);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void test(String[] args) throws IOException, InterruptedException {</span>
<span class="udiff-line-removed">-         var flags = List.of(</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;u&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;username&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Username on host&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;r&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;remote&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;verbose&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;debug&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;version&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="udiff-line-removed">-                   .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var inputs = List.of(</span>
<span class="udiff-line-removed">-             Input.position(0)</span>
<span class="udiff-line-removed">-                  .describe(&quot;ID&quot;)</span>
<span class="udiff-line-removed">-                  .singular()</span>
<span class="udiff-line-removed">-                  .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">-         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="udiff-line-removed">-         var arguments = parse(parser, args);</span>
<span class="udiff-line-removed">-         var repo = getRepo();</span>
<span class="udiff-line-removed">-         var uri = getURI(repo, arguments);</span>
<span class="udiff-line-removed">-         var host = getForge(uri, repo, arguments);</span>
<span class="udiff-line-removed">-         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="udiff-line-removed">-         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="udiff-line-removed">-         var head = pr.headHash();</span>
<span class="udiff-line-removed">-         var testComment = pr.addComment(&quot;/test&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var seenTestComment = false;</span>
<span class="udiff-line-removed">-         for (var i = 0; i &lt; 90; i++) {</span>
<span class="udiff-line-removed">-             var comments = pr.comments();</span>
<span class="udiff-line-removed">-             for (var comment : comments) {</span>
<span class="udiff-line-removed">-                 if (!seenTestComment) {</span>
<span class="udiff-line-removed">-                     if (comment.id().equals(testComment.id())) {</span>
<span class="udiff-line-removed">-                         seenTestComment = true;</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     continue;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 var lines = comment.body().split(&quot;\n&quot;);</span>
<span class="udiff-line-removed">-                 var n = lines.length;</span>
<span class="udiff-line-removed">-                 if (n &gt; 0) {</span>
<span class="udiff-line-removed">-                     if (n == 4 &amp;&amp;</span>
<span class="udiff-line-removed">-                         lines[0].equals(&quot;&lt;!-- TEST STARTED --&gt;&quot;) &amp;&amp;</span>
<span class="udiff-line-removed">-                         lines[1].startsWith(&quot;&lt;!-- github.com-&quot;) &amp;&amp;</span>
<span class="udiff-line-removed">-                         lines[2].equals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;)) {</span>
<span class="udiff-line-removed">-                         var output = removeTrailing(lines[3], &quot;.&quot;);</span>
<span class="udiff-line-removed">-                         System.out.println(output);</span>
<span class="udiff-line-removed">-                         System.exit(0);</span>
<span class="udiff-line-removed">-                     } else if (n == 2 &amp;&amp;</span>
<span class="udiff-line-removed">-                                lines[0].equals(&quot;&lt;!-- TEST ERROR --&gt;&quot;)) {</span>
<span class="udiff-line-removed">-                         var output = removeTrailing(lines[1], &quot;.&quot;);</span>
<span class="udiff-line-removed">-                         System.out.println(output);</span>
<span class="udiff-line-removed">-                         System.exit(1);</span>
<span class="udiff-line-removed">-                     } else if (n == 4 &amp;&amp;</span>
<span class="udiff-line-removed">-                                lines[0].equals(&quot;&lt;!-- TEST PENDING --&gt;&quot;) &amp;&amp;</span>
<span class="udiff-line-removed">-                                lines[1].equals(&quot;&lt;!--- &quot; + head.hex() + &quot; --&gt;&quot;)) {</span>
<span class="udiff-line-removed">-                         var output = removeTrailing(lines[3], &quot;.&quot;);</span>
<span class="udiff-line-removed">-                         System.out.println(output);</span>
<span class="udiff-line-removed">-                         System.exit(0);</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             Thread.sleep(2000);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void approve(String[] args) throws IOException, InterruptedException {</span>
<span class="udiff-line-removed">-         var flags = List.of(</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;u&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;username&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Username on host&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;r&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;remote&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;verbose&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;debug&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;version&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="udiff-line-removed">-                   .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var inputs = List.of(</span>
<span class="udiff-line-removed">-             Input.position(0)</span>
<span class="udiff-line-removed">-                  .describe(&quot;ID&quot;)</span>
<span class="udiff-line-removed">-                  .singular()</span>
<span class="udiff-line-removed">-                  .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">-         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="udiff-line-removed">-         var arguments = parse(parser, args);</span>
<span class="udiff-line-removed">-         var repo = getRepo();</span>
<span class="udiff-line-removed">-         var uri = getURI(repo, arguments);</span>
<span class="udiff-line-removed">-         var host = getForge(uri, repo, arguments);</span>
<span class="udiff-line-removed">-         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="udiff-line-removed">-         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="udiff-line-removed">-         pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void list(String[] args) throws IOException, InterruptedException {</span>
<span class="udiff-line-removed">-         var flags = List.of(</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;u&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;username&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Username on host&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;r&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;remote&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;authors&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;LIST&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Comma separated list of authors&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;assignees&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;LIST&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Comma separated list of assignees&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;labels&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;LIST&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Comma separated list of labels&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;issues&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;LIST&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Comma separated list of issues&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;columns&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;id,title,author,assignees,labels&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Comma separated list of columns to show&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;no-decoration&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Hide any decorations when listing PRs&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;no-draft&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Hide all pull requests in draft state&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;no-token&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;verbose&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;debug&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;version&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="udiff-line-removed">-                   .optional());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var inputs = List.of(</span>
<span class="udiff-line-removed">-             Input.position(0)</span>
<span class="udiff-line-removed">-                  .describe(&quot;ID&quot;)</span>
<span class="udiff-line-removed">-                  .singular()</span>
<span class="udiff-line-removed">-                  .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="udiff-line-removed">-         var arguments = parse(parser, args);</span>
<span class="udiff-line-removed">-         var repo = getRepo();</span>
<span class="udiff-line-removed">-         var uri = getURI(repo, arguments);</span>
<span class="udiff-line-removed">-         var host = getForge(uri, repo, arguments);</span>
<span class="udiff-line-removed">-         var remoteRepo = getHostedRepositoryFor(uri, repo, host);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var prs = remoteRepo.pullRequests();</span>
<span class="udiff-line-removed">-         var ids = new ArrayList&lt;String&gt;();</span>
<span class="udiff-line-removed">-         var titles = new ArrayList&lt;String&gt;();</span>
<span class="udiff-line-removed">-         var authors = new ArrayList&lt;String&gt;();</span>
<span class="udiff-line-removed">-         var assignees = new ArrayList&lt;String&gt;();</span>
<span class="udiff-line-removed">-         var labels = new ArrayList&lt;String&gt;();</span>
<span class="udiff-line-removed">-         var issues = new ArrayList&lt;String&gt;();</span>
<span class="udiff-line-removed">-         var branches = new ArrayList&lt;String&gt;();</span>
<span class="udiff-line-removed">-         var statuses = new ArrayList&lt;String&gt;();</span>
<span class="udiff-line-removed">-         var noDraft = getSwitch(&quot;no-draft&quot;, &quot;list&quot;, arguments);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var authorsOption = getOption(&quot;authors&quot;, &quot;list&quot;, arguments);</span>
<span class="udiff-line-removed">-         var filterAuthors = authorsOption == null ?</span>
<span class="udiff-line-removed">-             Set.of() :</span>
<span class="udiff-line-removed">-             new HashSet&lt;&gt;(Arrays.asList(authorsOption.split(&quot;,&quot;)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var assigneesOption = getOption(&quot;assignees&quot;, &quot;list&quot;, arguments);</span>
<span class="udiff-line-removed">-         var filterAssignees = assigneesOption == null ?</span>
<span class="udiff-line-removed">-             Set.of() :</span>
<span class="udiff-line-removed">-             Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var labelsOption = getOption(&quot;labels&quot;, &quot;list&quot;, arguments);</span>
<span class="udiff-line-removed">-         var filterLabels = labelsOption == null ?</span>
<span class="udiff-line-removed">-             Set.of() :</span>
<span class="udiff-line-removed">-             Arrays.asList(labelsOption.split(&quot;,&quot;));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var issuesOption = getOption(&quot;issues&quot;, &quot;list&quot;, arguments);</span>
<span class="udiff-line-removed">-         var filterIssues = issuesOption == null ?</span>
<span class="udiff-line-removed">-             Set.of() :</span>
<span class="udiff-line-removed">-             Arrays.asList(issuesOption.split(&quot;,&quot;));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var columnTitles = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;, &quot;issues&quot;, &quot;branch&quot;, &quot;status&quot;);</span>
<span class="udiff-line-removed">-         var columnValues = Map.of(columnTitles.get(0), ids,</span>
<span class="udiff-line-removed">-                                   columnTitles.get(1), titles,</span>
<span class="udiff-line-removed">-                                   columnTitles.get(2), authors,</span>
<span class="udiff-line-removed">-                                   columnTitles.get(3), assignees,</span>
<span class="udiff-line-removed">-                                   columnTitles.get(4), labels,</span>
<span class="udiff-line-removed">-                                   columnTitles.get(5), issues,</span>
<span class="udiff-line-removed">-                                   columnTitles.get(6), branches,</span>
<span class="udiff-line-removed">-                                   columnTitles.get(7), statuses);</span>
<span class="udiff-line-removed">-         var columnsOption = getOption(&quot;columns&quot;, &quot;list&quot;, arguments);</span>
<span class="udiff-line-removed">-         var columns = columnsOption == null ?</span>
<span class="udiff-line-removed">-             List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;status&quot;) :</span>
<span class="udiff-line-removed">-             Arrays.asList(columnsOption.split(&quot;,&quot;));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         for (var column : columns) {</span>
<span class="udiff-line-removed">-             if (!columnTitles.contains(column)) {</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;error: unknown column: &quot; + column);</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;       available columns are: &quot; + String.join(&quot;,&quot;, columnTitles));</span>
<span class="udiff-line-removed">-                 System.exit(1);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         for (var pr : prs) {</span>
<span class="udiff-line-removed">-             if (pr.isDraft() &amp;&amp; noDraft) {</span>
<span class="udiff-line-removed">-                 continue;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var prAuthor = pr.author().userName();</span>
<span class="udiff-line-removed">-             if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {</span>
<span class="udiff-line-removed">-                 continue;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var prAssignees = pr.assignees().stream()</span>
<span class="udiff-line-removed">-                                 .map(HostUser::userName)</span>
<span class="udiff-line-removed">-                                 .collect(Collectors.toSet());</span>
<span class="udiff-line-removed">-             if (!filterAssignees.isEmpty() &amp;&amp; !filterAssignees.stream().anyMatch(prAssignees::contains)) {</span>
<span class="udiff-line-removed">-                 continue;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var prLabels = new HashSet&lt;&gt;(pr.labels());</span>
<span class="udiff-line-removed">-             if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {</span>
<span class="udiff-line-removed">-                 continue;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var prIssues = new HashSet&lt;&gt;(issuesFromPullRequest(pr));</span>
<span class="udiff-line-removed">-             if (!filterIssues.isEmpty() &amp;&amp; !filterIssues.stream().anyMatch(prIssues::contains)) {</span>
<span class="udiff-line-removed">-                 continue;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             ids.add(pr.id());</span>
<span class="udiff-line-removed">-             titles.add(pr.title());</span>
<span class="udiff-line-removed">-             authors.add(prAuthor);</span>
<span class="udiff-line-removed">-             assignees.add(String.join(&quot;,&quot;, prAssignees));</span>
<span class="udiff-line-removed">-             labels.add(String.join(&quot;,&quot;, prLabels));</span>
<span class="udiff-line-removed">-             issues.add(String.join(&quot;,&quot;, prIssues));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             if (pr.sourceRepository().webUrl().equals(uri)) {</span>
<span class="udiff-line-removed">-                 branches.add(pr.sourceRef());</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 branches.add(&quot;&quot;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             if (columns.contains(&quot;status&quot;)) {</span>
<span class="udiff-line-removed">-                 statuses.add(statusForPullRequest(pr).toLowerCase());</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 statuses.add(&quot;&quot;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         String fmt = &quot;&quot;;</span>
<span class="udiff-line-removed">-         for (var column : columns.subList(0, columns.size() - 1)) {</span>
<span class="udiff-line-removed">-             var values = columnValues.get(column);</span>
<span class="udiff-line-removed">-             var n = Math.max(column.length(), longest(values));</span>
<span class="udiff-line-removed">-             fmt += &quot;%-&quot; + n + &quot;s    &quot;;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         fmt += &quot;%s\n&quot;;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;list&quot;, arguments);</span>
<span class="udiff-line-removed">-         if (!ids.isEmpty() &amp;&amp; !noDecoration) {</span>
<span class="udiff-line-removed">-             var upperCase = columns.stream()</span>
<span class="udiff-line-removed">-                                    .map(String::toUpperCase)</span>
<span class="udiff-line-removed">-                                    .collect(Collectors.toList());</span>
<span class="udiff-line-removed">-             System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         for (var i = 0; i &lt; ids.size(); i++) {</span>
<span class="udiff-line-removed">-             final int n = i;</span>
<span class="udiff-line-removed">-             var row = columns.stream()</span>
<span class="udiff-line-removed">-                              .map(columnValues::get)</span>
<span class="udiff-line-removed">-                              .map(values -&gt; values.get(n))</span>
<span class="udiff-line-removed">-                              .collect(Collectors.toList());</span>
<span class="udiff-line-removed">-             System.out.format(fmt, (Object[]) row.toArray(new String[0]));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void close(String[] args) throws IOException, InterruptedException {</span>
<span class="udiff-line-removed">-         var flags = List.of(</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;u&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;username&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Username on host&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;r&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;remote&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;verbose&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;debug&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;version&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="udiff-line-removed">-                   .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var inputs = List.of(</span>
<span class="udiff-line-removed">-             Input.position(0)</span>
<span class="udiff-line-removed">-                  .describe(&quot;ID&quot;)</span>
<span class="udiff-line-removed">-                  .singular()</span>
<span class="udiff-line-removed">-                  .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="udiff-line-removed">-         var arguments = parse(parser, args);</span>
<span class="udiff-line-removed">-         var repo = getRepo();</span>
<span class="udiff-line-removed">-         var uri = getURI(repo, arguments);</span>
<span class="udiff-line-removed">-         var host = getForge(uri, repo, arguments);</span>
<span class="udiff-line-removed">-         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="udiff-line-removed">-         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         pr.setState(PullRequest.State.CLOSED);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void set(String[] args) throws IOException, InterruptedException {</span>
<span class="udiff-line-removed">-         var flags = List.of(</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;u&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;username&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Username on host&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;r&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;remote&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;assignees&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;LIST&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Comma separated list of assignees&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;verbose&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;debug&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;version&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="udiff-line-removed">-                   .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var inputs = List.of(</span>
<span class="udiff-line-removed">-             Input.position(0)</span>
<span class="udiff-line-removed">-                  .describe(&quot;ID&quot;)</span>
<span class="udiff-line-removed">-                  .singular()</span>
<span class="udiff-line-removed">-                  .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="udiff-line-removed">-         var arguments = parse(parser, args);</span>
<span class="udiff-line-removed">-         var repo = getRepo();</span>
<span class="udiff-line-removed">-         var uri = getURI(repo, arguments);</span>
<span class="udiff-line-removed">-         var host = getForge(uri, repo, arguments);</span>
<span class="udiff-line-removed">-         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="udiff-line-removed">-         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var assigneesOption = getOption(&quot;assignees&quot;, &quot;set&quot;, arguments);</span>
<span class="udiff-line-removed">-         if (assigneesOption != null) {</span>
<span class="udiff-line-removed">-             var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="udiff-line-removed">-             var assignees = usernames.stream()</span>
<span class="udiff-line-removed">-                 .map(u -&gt; host.user(u))</span>
<span class="udiff-line-removed">-                 .filter(Optional::isPresent)</span>
<span class="udiff-line-removed">-                 .map(Optional::get)</span>
<span class="udiff-line-removed">-                 .collect(Collectors.toList());</span>
<span class="udiff-line-removed">-             pr.setAssignees(assignees);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void status(String[] args) throws IOException, InterruptedException {</span>
<span class="udiff-line-removed">-         var flags = List.of(</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;u&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;username&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Username on host&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;r&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;remote&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;no-decoration&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Hide any decorations when listing PRs&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;no-token&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;no-checks&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Do not show check status as part of the &#39;git pr status&#39; output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;verbose&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;debug&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;version&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="udiff-line-removed">-                   .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var inputs = List.of(</span>
<span class="udiff-line-removed">-             Input.position(0)</span>
<span class="udiff-line-removed">-                  .describe(&quot;ID&quot;)</span>
<span class="udiff-line-removed">-                  .singular()</span>
<span class="udiff-line-removed">-                  .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="udiff-line-removed">-         var arguments = parse(parser, args);</span>
<span class="udiff-line-removed">-         var repo = getRepo();</span>
<span class="udiff-line-removed">-         var uri = getURI(repo, arguments);</span>
<span class="udiff-line-removed">-         var host = getForge(uri, repo, arguments);</span>
<span class="udiff-line-removed">-         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="udiff-line-removed">-         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;status&quot;, arguments);</span>
<span class="udiff-line-removed">-         var decoration = noDecoration ? &quot;&quot; : &quot;Status: &quot;;</span>
<span class="udiff-line-removed">-         System.out.println(decoration + statusForPullRequest(pr));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var noChecks = getSwitch(&quot;no-checks&quot;, &quot;status&quot;, arguments);</span>
<span class="udiff-line-removed">-         if (!noChecks) {</span>
<span class="udiff-line-removed">-             var checks = pr.checks(pr.headHash());</span>
<span class="udiff-line-removed">-             var jcheck = Optional.ofNullable(checks.get(&quot;jcheck&quot;));</span>
<span class="udiff-line-removed">-             var submit = Optional.ofNullable(checks.get(&quot;submit&quot;));</span>
<span class="udiff-line-removed">-             var showChecks = jcheck.isPresent() || submit.isPresent();</span>
<span class="udiff-line-removed">-             if (showChecks) {</span>
<span class="udiff-line-removed">-                 System.out.println(&quot;Checks:&quot;);</span>
<span class="udiff-line-removed">-                 if (jcheck.isPresent()) {</span>
<span class="udiff-line-removed">-                     System.out.println(&quot;- jcheck: &quot; + statusForCheck(jcheck.get()));</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 if (submit.isPresent()) {</span>
<span class="udiff-line-removed">-                     System.out.println(&quot;- submit: &quot; + statusForCheck(submit.get()));</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void fetch(String[] args) throws IOException, InterruptedException {</span>
<span class="udiff-line-removed">-         var flags = List.of(</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;u&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;username&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Username on host&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;r&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;remote&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;b&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;branch&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;no-token&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;verbose&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;debug&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;version&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="udiff-line-removed">-                   .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var inputs = List.of(</span>
<span class="udiff-line-removed">-             Input.position(0)</span>
<span class="udiff-line-removed">-                  .describe(&quot;ID&quot;)</span>
<span class="udiff-line-removed">-                  .singular()</span>
<span class="udiff-line-removed">-                  .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="udiff-line-removed">-         var arguments = parse(parser, args);</span>
<span class="udiff-line-removed">-         var repo = getRepo();</span>
<span class="udiff-line-removed">-         var uri = getURI(repo, arguments);</span>
<span class="udiff-line-removed">-         var host = getForge(uri, repo, arguments);</span>
<span class="udiff-line-removed">-         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="udiff-line-removed">-         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var fetchHead = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="udiff-line-removed">-         var branchName = getOption(&quot;branch&quot;, &quot;fetch&quot;, arguments);</span>
<span class="udiff-line-removed">-         if (branchName != null) {</span>
<span class="udiff-line-removed">-             repo.branch(fetchHead, branchName);</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             System.out.println(fetchHead.hex());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void show(String[] args) throws IOException, InterruptedException {</span>
<span class="udiff-line-removed">-         var flags = List.of(</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;u&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;username&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Username on host&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;r&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;remote&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;no-token&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;verbose&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;debug&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;version&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="udiff-line-removed">-                   .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var inputs = List.of(</span>
<span class="udiff-line-removed">-             Input.position(0)</span>
<span class="udiff-line-removed">-                  .describe(&quot;ID&quot;)</span>
<span class="udiff-line-removed">-                  .singular()</span>
<span class="udiff-line-removed">-                  .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="udiff-line-removed">-         var arguments = parse(parser, args);</span>
<span class="udiff-line-removed">-         var repo = getRepo();</span>
<span class="udiff-line-removed">-         var uri = getURI(repo, arguments);</span>
<span class="udiff-line-removed">-         var host = getForge(uri, repo, arguments);</span>
<span class="udiff-line-removed">-         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="udiff-line-removed">-         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var fetchHead = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="udiff-line-removed">-         show(pr.targetRef(), fetchHead);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void checkout(String[] args) throws IOException, InterruptedException {</span>
<span class="udiff-line-removed">-         var flags = List.of(</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;u&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;username&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Username on host&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;r&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;remote&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;b&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;branch&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;no-token&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;verbose&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;debug&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;version&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="udiff-line-removed">-                   .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var inputs = List.of(</span>
<span class="udiff-line-removed">-             Input.position(0)</span>
<span class="udiff-line-removed">-                  .describe(&quot;ID&quot;)</span>
<span class="udiff-line-removed">-                  .singular()</span>
<span class="udiff-line-removed">-                  .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="udiff-line-removed">-         var arguments = parse(parser, args);</span>
<span class="udiff-line-removed">-         var repo = getRepo();</span>
<span class="udiff-line-removed">-         var uri = getURI(repo, arguments);</span>
<span class="udiff-line-removed">-         var host = getForge(uri, repo, arguments);</span>
<span class="udiff-line-removed">-         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="udiff-line-removed">-         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var fetchHead = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="udiff-line-removed">-         var branchName = getOption(&quot;branch&quot;, &quot;checkout&quot;, arguments);</span>
<span class="udiff-line-removed">-         if (branchName != null) {</span>
<span class="udiff-line-removed">-             var branch = repo.branch(fetchHead, branchName);</span>
<span class="udiff-line-removed">-             repo.checkout(branch, false);</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             repo.checkout(fetchHead, false);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void apply(String[] args) throws IOException, InterruptedException {</span>
<span class="udiff-line-removed">-         var flags = List.of(</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;u&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;username&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Username on host&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;r&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;remote&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;NAME&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;no-token&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;verbose&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;debug&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;version&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="udiff-line-removed">-                   .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var inputs = List.of(</span>
<span class="udiff-line-removed">-             Input.position(0)</span>
<span class="udiff-line-removed">-                  .describe(&quot;ID&quot;)</span>
<span class="udiff-line-removed">-                  .singular()</span>
<span class="udiff-line-removed">-                  .optional()</span>
<span class="udiff-line-removed">-         );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="udiff-line-removed">-         var arguments = parse(parser, args);</span>
<span class="udiff-line-removed">-         var repo = getRepo();</span>
<span class="udiff-line-removed">-         var uri = getURI(repo, arguments);</span>
<span class="udiff-line-removed">-         var host = getForge(uri, repo, arguments);</span>
<span class="udiff-line-removed">-         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="udiff-line-removed">-         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         var fetchHead = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="udiff-line-removed">-         var patch = diff(pr.targetRef(), fetchHead);</span>
<span class="udiff-line-removed">-         apply(patch);</span>
<span class="udiff-line-removed">-         Files.deleteIfExists(patch);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      public static void main(String[] args) throws Exception {
          var commands = List.of(
                      Default.name(&quot;list&quot;)
                             .helptext(&quot;list open pull requests&quot;)
<span class="udiff-line-modified-removed">-                            .main(GitPr::list),</span>
<span class="udiff-line-modified-added">+                            .main(GitPrList::main),</span>
                      Command.name(&quot;fetch&quot;)
                             .helptext(&quot;fetch a pull request&quot;)
<span class="udiff-line-modified-removed">-                            .main(GitPr::fetch),</span>
<span class="udiff-line-modified-added">+                            .main(GitPrFetch::main),</span>
                      Command.name(&quot;show&quot;)
                             .helptext(&quot;show a pull request&quot;)
<span class="udiff-line-modified-removed">-                            .main(GitPr::show),</span>
<span class="udiff-line-modified-added">+                            .main(GitPrShow::main),</span>
                      Command.name(&quot;checkout&quot;)
                             .helptext(&quot;checkout a pull request&quot;)
<span class="udiff-line-modified-removed">-                            .main(GitPr::checkout),</span>
<span class="udiff-line-modified-added">+                            .main(GitPrCheckout::main),</span>
                      Command.name(&quot;apply&quot;)
                             .helptext(&quot;apply a pull request&quot;)
<span class="udiff-line-modified-removed">-                            .main(GitPr::apply),</span>
<span class="udiff-line-modified-added">+                            .main(GitPrApply::main),</span>
                      Command.name(&quot;integrate&quot;)
                             .helptext(&quot;integrate a pull request&quot;)
<span class="udiff-line-modified-removed">-                            .main(GitPr::integrate),</span>
<span class="udiff-line-modified-added">+                            .main(GitPrIntegrate::main),</span>
                      Command.name(&quot;approve&quot;)
                             .helptext(&quot;approve a pull request&quot;)
<span class="udiff-line-modified-removed">-                            .main(GitPr::approve),</span>
<span class="udiff-line-modified-added">+                            .main(GitPrApprove::main),</span>
                      Command.name(&quot;create&quot;)
                             .helptext(&quot;create a pull request&quot;)
<span class="udiff-line-modified-removed">-                            .main(GitPr::create),</span>
<span class="udiff-line-modified-added">+                            .main(GitPrCreate::main),</span>
                      Command.name(&quot;close&quot;)
                             .helptext(&quot;close a pull request&quot;)
<span class="udiff-line-modified-removed">-                            .main(GitPr::close),</span>
<span class="udiff-line-modified-added">+                            .main(GitPrClose::main),</span>
                      Command.name(&quot;set&quot;)
                             .helptext(&quot;set properties of a pull request&quot;)
<span class="udiff-line-modified-removed">-                            .main(GitPr::set),</span>
<span class="udiff-line-modified-added">+                            .main(GitPrSet::main),</span>
                      Command.name(&quot;test&quot;)
                             .helptext(&quot;test a pull request&quot;)
<span class="udiff-line-modified-removed">-                            .main(GitPr::test),</span>
<span class="udiff-line-modified-added">+                            .main(GitPrTest::main),</span>
                      Command.name(&quot;status&quot;)
                             .helptext(&quot;show status of a pull request&quot;)
<span class="udiff-line-modified-removed">-                            .main(GitPr::status)</span>
<span class="udiff-line-modified-added">+                            .main(GitPrStatus::main)</span>
          );
  
          HttpProxy.setup();
  
          var parser = new MultiCommandParser(&quot;git pr&quot;, commands);
</pre>
<center><a href="GitJCheck.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Logging.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>