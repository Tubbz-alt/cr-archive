<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/json/JsonNotifierTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../issue/IssueNotifierTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../mailinglist/MailingListNotifierTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/json/JsonNotifierTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 45                     .collect(Collectors.toList());
 46     }
 47 
 48     @Test
 49     void testJsonNotifierBranch(TestInfo testInfo) throws IOException {
 50         try (var credentials = new HostCredentials(testInfo);
 51              var tempFolder = new TemporaryDirectory()) {
 52             var repo = credentials.getHostedRepository();
 53             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 54             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 55             credentials.commitLock(localRepo);
 56             localRepo.pushAll(repo.url());
 57 
 58             var tagStorage = createTagStorage(repo);
 59             var branchStorage = createBranchStorage(repo);
 60             var prStateStorage = createPullRequestStateStorage(repo);
 61             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 62             Files.createDirectory(jsonFolder);
 63             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 64 
<span class="line-removed"> 65             var updater = new JsonNotifier(jsonFolder, &quot;12&quot;, &quot;team&quot;);</span>
 66             var notifyBot = NotifyBot.newBuilder()
 67                                      .repository(repo)
 68                                      .storagePath(storageFolder)
 69                                      .branches(Pattern.compile(&quot;master&quot;))
 70                                      .tagStorageBuilder(tagStorage)
 71                                      .branchStorageBuilder(branchStorage)
 72                                      .prStateStorageBuilder(prStateStorage)
<span class="line-removed"> 73                                      .updaters(List.of(updater))</span>
 74                                      .build();
 75 



 76             TestBotRunner.runPeriodicItems(notifyBot);
 77             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 78 
 79             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 80             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 81             TestBotRunner.runPeriodicItems(notifyBot);
 82             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 83             assertEquals(1, jsonFiles.size());
 84             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 85             var json = JSON.parse(jsonData);
 86             assertEquals(1, json.asArray().size());
 87             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 88             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 89                                                   .map(JSONValue::asString)
 90                                                   .collect(Collectors.toList()));
 91         }
 92     }
 93 
 94     @Test
 95     void testJsonNotifierTag(TestInfo testInfo) throws IOException {
 96         try (var credentials = new HostCredentials(testInfo);
 97              var tempFolder = new TemporaryDirectory()) {
 98             var repo = credentials.getHostedRepository();
 99             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
100             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
101             credentials.commitLock(localRepo);
102             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
103             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
104             localRepo.pushAll(repo.url());
105 
106             var tagStorage = UpdaterTests.createTagStorage(repo);
107             var branchStorage = createBranchStorage(repo);
108             var prStateStorage = createPullRequestStateStorage(repo);
109             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
110             Files.createDirectory(jsonFolder);
111             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
112 
<span class="line-removed">113             var updater = new JsonNotifier(jsonFolder, &quot;12&quot;, &quot;team&quot;);</span>
114             var notifyBot = NotifyBot.newBuilder()
115                                      .repository(repo)
116                                      .storagePath(storageFolder)
117                                      .branches(Pattern.compile(&quot;master&quot;))
118                                      .tagStorageBuilder(tagStorage)
119                                      .branchStorageBuilder(branchStorage)
120                                      .prStateStorageBuilder(prStateStorage)
<span class="line-removed">121                                      .updaters(List.of(updater))</span>
122                                      .build();
123 



124             TestBotRunner.runPeriodicItems(notifyBot);
125             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
126 
127             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
128             localRepo.fetch(repo.url(), &quot;history:history&quot;);
129             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
130             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
131             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
132             localRepo.pushAll(repo.url());
133 
134             TestBotRunner.runPeriodicItems(notifyBot);
135             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
136             assertEquals(3, jsonFiles.size());
137 
138             for (var file : jsonFiles) {
139                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
140                 var json = JSON.parse(jsonData);
141 
142                 if (json.asArray().get(0).contains(&quot;date&quot;)) {
143                     assertEquals(2, json.asArray().size());
</pre>
</td>
<td>
<hr />
<pre>
 45                     .collect(Collectors.toList());
 46     }
 47 
 48     @Test
 49     void testJsonNotifierBranch(TestInfo testInfo) throws IOException {
 50         try (var credentials = new HostCredentials(testInfo);
 51              var tempFolder = new TemporaryDirectory()) {
 52             var repo = credentials.getHostedRepository();
 53             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 54             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 55             credentials.commitLock(localRepo);
 56             localRepo.pushAll(repo.url());
 57 
 58             var tagStorage = createTagStorage(repo);
 59             var branchStorage = createBranchStorage(repo);
 60             var prStateStorage = createPullRequestStateStorage(repo);
 61             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 62             Files.createDirectory(jsonFolder);
 63             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 64 

 65             var notifyBot = NotifyBot.newBuilder()
 66                                      .repository(repo)
 67                                      .storagePath(storageFolder)
 68                                      .branches(Pattern.compile(&quot;master&quot;))
 69                                      .tagStorageBuilder(tagStorage)
 70                                      .branchStorageBuilder(branchStorage)
 71                                      .prStateStorageBuilder(prStateStorage)

 72                                      .build();
 73 
<span class="line-added"> 74             var updater = new JsonNotifier(jsonFolder, &quot;12&quot;, &quot;team&quot;);</span>
<span class="line-added"> 75             updater.attachTo(notifyBot);</span>
<span class="line-added"> 76 </span>
 77             TestBotRunner.runPeriodicItems(notifyBot);
 78             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 79 
 80             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 81             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 82             TestBotRunner.runPeriodicItems(notifyBot);
 83             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 84             assertEquals(1, jsonFiles.size());
 85             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 86             var json = JSON.parse(jsonData);
 87             assertEquals(1, json.asArray().size());
 88             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 89             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 90                                                   .map(JSONValue::asString)
 91                                                   .collect(Collectors.toList()));
 92         }
 93     }
 94 
 95     @Test
 96     void testJsonNotifierTag(TestInfo testInfo) throws IOException {
 97         try (var credentials = new HostCredentials(testInfo);
 98              var tempFolder = new TemporaryDirectory()) {
 99             var repo = credentials.getHostedRepository();
100             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
101             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
102             credentials.commitLock(localRepo);
103             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
104             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
105             localRepo.pushAll(repo.url());
106 
107             var tagStorage = UpdaterTests.createTagStorage(repo);
108             var branchStorage = createBranchStorage(repo);
109             var prStateStorage = createPullRequestStateStorage(repo);
110             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
111             Files.createDirectory(jsonFolder);
112             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
113 

114             var notifyBot = NotifyBot.newBuilder()
115                                      .repository(repo)
116                                      .storagePath(storageFolder)
117                                      .branches(Pattern.compile(&quot;master&quot;))
118                                      .tagStorageBuilder(tagStorage)
119                                      .branchStorageBuilder(branchStorage)
120                                      .prStateStorageBuilder(prStateStorage)

121                                      .build();
122 
<span class="line-added">123             var updater = new JsonNotifier(jsonFolder, &quot;12&quot;, &quot;team&quot;);</span>
<span class="line-added">124             updater.attachTo(notifyBot);</span>
<span class="line-added">125 </span>
126             TestBotRunner.runPeriodicItems(notifyBot);
127             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
128 
129             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
130             localRepo.fetch(repo.url(), &quot;history:history&quot;);
131             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
132             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
133             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
134             localRepo.pushAll(repo.url());
135 
136             TestBotRunner.runPeriodicItems(notifyBot);
137             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
138             assertEquals(3, jsonFiles.size());
139 
140             for (var file : jsonFiles) {
141                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
142                 var json = JSON.parse(jsonData);
143 
144                 if (json.asArray().get(0).contains(&quot;date&quot;)) {
145                     assertEquals(2, json.asArray().size());
</pre>
</td>
</tr>
</table>
<center><a href="../issue/IssueNotifierTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../mailinglist/MailingListNotifierTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>