<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff issuetracker/src/main/java/org/openjdk/skara/issuetracker/jira/JiraIssue.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>issuetracker/src/main/java/org/openjdk/skara/issuetracker/jira/JiraIssue.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.issuetracker.jira;
 24 
 25 import org.openjdk.skara.host.HostUser;
 26 import org.openjdk.skara.issuetracker.*;
 27 import org.openjdk.skara.json.*;
 28 import org.openjdk.skara.network.*;
 29 
 30 import java.net.URI;
 31 import java.time.ZonedDateTime;
 32 import java.time.format.DateTimeFormatter;
 33 import java.util.*;
 34 import java.util.logging.Logger;

 35 import java.util.stream.*;
 36 
 37 public class JiraIssue implements Issue {
 38     private final JiraProject jiraProject;
 39     private final RestRequest request;
 40     private final JSONValue json;
<span class="line-modified"> 41 </span>
<span class="line-removed"> 42     // If true, the issue has the requested security level as set by the host. This means that fields that do</span>
<span class="line-removed"> 43     // not explicitly support a security level (such as labels and links) implicitly get the correct security</span>
<span class="line-removed"> 44     // level. If false, such items may not be added or updated.</span>
<span class="line-removed"> 45     // Comments are special in that they do explicitly support a visibility level, and can thus be posted and</span>
<span class="line-removed"> 46     // updated even if the issue has a different security level than the requested one.</span>
<span class="line-removed"> 47     private final boolean secure;</span>
 48 
 49     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.issuetracker.jira&quot;);
 50 
 51     private static final DateTimeFormatter dateFormat = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSZ&quot;);
 52 
 53     JiraIssue(JiraProject jiraProject, RestRequest request, JSONValue json) {
 54         this.jiraProject = jiraProject;
 55         this.request = request;
 56         this.json = json;
 57 
<span class="line-modified"> 58         if (json.get(&quot;fields&quot;).contains(&quot;security&quot;)) {</span>
<span class="line-removed"> 59             // Issue has the requested security level -&gt; fine to post fields without role</span>
<span class="line-removed"> 60             secure = jiraProject.jiraHost().securityLevel().orElse(&quot;&quot;).equals(json.get(&quot;fields&quot;).get(&quot;security&quot;).get(&quot;id&quot;).asString());</span>
<span class="line-removed"> 61         } else {</span>
<span class="line-removed"> 62             if (jiraProject.jiraHost().securityLevel().isEmpty()) {</span>
<span class="line-removed"> 63                 // No security level on issue, and none requested -&gt; fine to post fields without role</span>
<span class="line-removed"> 64                 secure = true;</span>
<span class="line-removed"> 65             } else {</span>
<span class="line-removed"> 66                 secure = false;</span>
<span class="line-removed"> 67             }</span>
<span class="line-removed"> 68         }</span>
 69     }
 70 
 71     @Override
 72     public IssueProject project() {
 73         return jiraProject;
 74     }
 75 
 76     @Override
 77     public String id() {
 78         return json.get(&quot;key&quot;).asString();
 79     }
 80 
 81     @Override
 82     public HostUser author() {
 83         return new HostUser(json.get(&quot;fields&quot;).get(&quot;creator&quot;).get(&quot;key&quot;).asString(),
 84                             json.get(&quot;fields&quot;).get(&quot;creator&quot;).get(&quot;name&quot;).asString(),
 85                             json.get(&quot;fields&quot;).get(&quot;creator&quot;).get(&quot;displayName&quot;).asString());
 86     }
 87 
 88     @Override
 89     public String title() {
 90         return json.get(&quot;fields&quot;).get(&quot;summary&quot;).asString();
 91     }
 92 
 93     @Override
 94     public void setTitle(String title) {
<span class="line-modified"> 95         if (!secure) {</span>
<span class="line-modified"> 96             log.warning(&quot;Ignoring attempt to set title on issue with wrong security level&quot;);</span>
 97             return;
 98         }
 99         var query = JSON.object()
100                         .put(&quot;fields&quot;, JSON.object()
101                                            .put(&quot;summary&quot;, title));
102         request.put(&quot;&quot;).body(query).execute();
103     }
104 
105     @Override
106     public String body() {
107         if (json.get(&quot;fields&quot;).get(&quot;description&quot;).isNull()) {
108             return &quot;&quot;;
109         } else {
110             return json.get(&quot;fields&quot;).get(&quot;description&quot;).asString();
111         }
112     }
113 
114     @Override
115     public void setBody(String body) {
<span class="line-modified">116         if (!secure) {</span>
<span class="line-modified">117             log.warning(&quot;Ignoring attempt to set body on issue with wrong security level&quot;);</span>
118             return;
119         }
120         var query = JSON.object()
121                         .put(&quot;fields&quot;, JSON.object()
122                                            .put(&quot;description&quot;, body));
123         request.put(&quot;&quot;).body(query).execute();
124     }
125 
126     private Comment parseComment(JSONValue json) {
127         return new Comment(json.get(&quot;id&quot;).asString(),
128                            json.get(&quot;body&quot;).asString(),
129                            new HostUser(json.get(&quot;author&quot;).get(&quot;name&quot;).asString(),
130                                         json.get(&quot;author&quot;).get(&quot;name&quot;).asString(),
131                                         json.get(&quot;author&quot;).get(&quot;displayName&quot;).asString()),
132                            ZonedDateTime.parse(json.get(&quot;created&quot;).asString(), dateFormat),
133                            ZonedDateTime.parse(json.get(&quot;updated&quot;).asString(), dateFormat));
134     }
135 
136     @Override
137     public List&lt;Comment&gt; comments() {
</pre>
<hr />
<pre>
232                     if (!availableTransitions.containsKey(&quot;Closed&quot;)) {
233                         throw new RuntimeException(&quot;Cannot transition to Closed after Resolved&quot;);
234                     }
235                 } else {
236                     throw new RuntimeException(&quot;Cannot transition to Closed&quot;);
237                 }
238                 performTransition(availableTransitions.get(&quot;Closed&quot;));
239             }
240         } else if (state == State.OPEN) {
241             if (!availableTransitions.containsKey(&quot;Open&quot;)) {
242                 throw new RuntimeException(&quot;Cannot transition to Open&quot;);
243             }
244             performTransition(availableTransitions.get(&quot;Open&quot;));
245         } else {
246             throw new IllegalStateException(&quot;Unknown state &quot; + state);
247         }
248     }
249 
250     @Override
251     public void addLabel(String label) {
<span class="line-modified">252         if (!secure) {</span>
<span class="line-modified">253             log.warning(&quot;Ignoring attempt to add label on issue with wrong security level&quot;);</span>
254             return;
255         }
256         var query = JSON.object()
257                         .put(&quot;update&quot;, JSON.object()
258                                            .put(&quot;labels&quot;, JSON.array().add(JSON.object()
259                                                                                .put(&quot;add&quot;, label))));
260         request.put(&quot;&quot;).body(query).execute();
261     }
262 
263     @Override
264     public void removeLabel(String label) {
265         var query = JSON.object()
266                         .put(&quot;update&quot;, JSON.object()
267                                            .put(&quot;labels&quot;, JSON.array().add(JSON.object()
268                                                                                .put(&quot;remove&quot;, label))));
269         request.put(&quot;&quot;).body(query).execute();
270     }
271 
272     @Override
273     public List&lt;String&gt; labels() {
</pre>
<hr />
<pre>
333         if (json.get(&quot;object&quot;).get(&quot;status&quot;).contains(&quot;icon&quot;)) {
334             if (json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;icon&quot;).contains(&quot;url16x16&quot;)) {
335                 link.statusIconUrl(URI.create(json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;icon&quot;).get(&quot;url16x16&quot;).asString()));
336             }
337             if (json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;icon&quot;).contains(&quot;title&quot;)) {
338                 link.statusIconTitle(json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;icon&quot;).get(&quot;title&quot;).asString());
339             }
340         }
341         link.resolved(json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;resolved&quot;).asBoolean());
342         return link.build();
343     }
344 
345     @Override
346     public List&lt;Link&gt; links() {
347         var result = request.get(&quot;/remotelink&quot;).execute();
348         var links = result.stream()
349                           .map(JSONValue::asObject)
350                           .filter(obj -&gt; obj.contains(&quot;globalId&quot;))
351                           .filter(obj -&gt; obj.get(&quot;globalId&quot;).asString().startsWith(&quot;skaralink=&quot;))
352                           .map(this::parseLink);







353         if (json.get(&quot;fields&quot;).contains(&quot;issuelinks&quot;)) {
354             var issueLinks = json.get(&quot;fields&quot;).get(&quot;issuelinks&quot;).stream()
355                                  .map(JSONValue::asObject)
356                                  .map(o -&gt; Link.create(o.contains(&quot;inwardIssue&quot;) ? jiraProject.issue(o.get(&quot;inwardIssue&quot;).get(&quot;key&quot;).asString()).orElseThrow() :
357                                                                jiraProject.issue(o.get(&quot;outwardIssue&quot;).get(&quot;key&quot;).asString()).orElseThrow(),
358                                                        o.contains(&quot;inwardIssue&quot;) ? o.get(&quot;type&quot;).get(&quot;inward&quot;).asString() :
359                                                                o.get(&quot;type&quot;).get(&quot;outward&quot;).asString())
360                                                .build());
361 
362             links = Stream.concat(issueLinks, links);
363         }

364         return links.collect(Collectors.toList());
365     }
366 








































367     private void addWebLink(Link link) {
<span class="line-modified">368         if (!secure) {</span>
<span class="line-modified">369             log.warning(&quot;Ignoring attempt to add link on issue with wrong security level&quot;);</span>
370             return;
371         }
372 
373         var query = JSON.object().put(&quot;globalId&quot;, &quot;skaralink=&quot; + link.uri().orElseThrow().toString());
374         var object = JSON.object().put(&quot;url&quot;, link.uri().orElseThrow().toString()).put(&quot;title&quot;, link.title().orElseThrow());
375         var status = JSON.object().put(&quot;resolved&quot;, link.resolved());
376         var icon = JSON.object();
377         var statusIcon = JSON.object();
378 
379         query.put(&quot;object&quot;, object);
380         object.put(&quot;icon&quot;, icon);
381         object.put(&quot;status&quot;, status);
382         status.put(&quot;icon&quot;, statusIcon);
383 
384         link.relationship().ifPresent(relationship -&gt; query.put(&quot;relationship&quot;, relationship));
385         link.summary().ifPresent(summary -&gt; object.put(&quot;summary&quot;, summary));
386         link.iconUrl().ifPresent(iconUrl -&gt; icon.put(&quot;url16x16&quot;, iconUrl.toString()));
387         link.iconTitle().ifPresent(iconTitle -&gt; icon.put(&quot;title&quot;, iconTitle));
388         link.statusIconUrl().ifPresent(statusIconUrl -&gt; statusIcon.put(&quot;url16x16&quot;, statusIconUrl.toString()));
389         link.statusIconTitle().ifPresent(statusIconTitle -&gt; statusIcon.put(&quot;title&quot;, statusIconTitle));
</pre>
<hr />
<pre>
421 
422         jiraProject.executeLinkQuery(query);
423     }
424 
425     @Override
426     public void addLink(Link link) {
427         if (link.uri().isPresent() &amp;&amp; link.title().isPresent()) {
428             addWebLink(link);
429         } else if (link.issue().isPresent() &amp;&amp; link.relationship().isPresent()) {
430             addIssueLink(link);
431         } else {
432             throw new IllegalArgumentException(&quot;Unknown type of link: &quot; + link);
433         }
434     }
435 
436     private void removeWebLink(Link link) {
437         request.delete(&quot;/remotelink&quot;)
438                .param(&quot;globalId&quot;, &quot;skaralink=&quot; + link.uri().orElseThrow().toString())
439                .onError(e -&gt; e.statusCode() == 404 ? Optional.of(JSON.object().put(&quot;already_deleted&quot;, true)) : Optional.empty())
440                .execute();











441     }
442 
443     private void removeIssueLink(Link link) {
444         throw new RuntimeException(&quot;not implemented yet&quot;);
445     }
446 
447     @Override
448     public void removeLink(Link link) {
449         if (link.uri().isPresent()) {
450             removeWebLink(link);
451         } else if (link.issue().isPresent() &amp;&amp; link.relationship().isPresent()) {
452             removeIssueLink(link);
453         } else {
454             throw new IllegalArgumentException(&quot;Unknown type of link: &quot; + link);
455         }
456     }
457 
458     @Override
459     public Map&lt;String, JSONValue&gt; properties() {
460         var ret = new HashMap&lt;String, JSONValue&gt;();
</pre>
</td>
<td>
<hr />
<pre>
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.issuetracker.jira;
 24 
 25 import org.openjdk.skara.host.HostUser;
 26 import org.openjdk.skara.issuetracker.*;
 27 import org.openjdk.skara.json.*;
 28 import org.openjdk.skara.network.*;
 29 
 30 import java.net.URI;
 31 import java.time.ZonedDateTime;
 32 import java.time.format.DateTimeFormatter;
 33 import java.util.*;
 34 import java.util.logging.Logger;
<span class="line-added"> 35 import java.util.regex.Pattern;</span>
 36 import java.util.stream.*;
 37 
 38 public class JiraIssue implements Issue {
 39     private final JiraProject jiraProject;
 40     private final RestRequest request;
 41     private final JSONValue json;
<span class="line-modified"> 42     private final boolean needSecurity;</span>






 43 
 44     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.issuetracker.jira&quot;);
 45 
 46     private static final DateTimeFormatter dateFormat = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSZ&quot;);
 47 
 48     JiraIssue(JiraProject jiraProject, RestRequest request, JSONValue json) {
 49         this.jiraProject = jiraProject;
 50         this.request = request;
 51         this.json = json;
 52 
<span class="line-modified"> 53         needSecurity = jiraProject.jiraHost().securityLevel().isPresent();</span>










 54     }
 55 
 56     @Override
 57     public IssueProject project() {
 58         return jiraProject;
 59     }
 60 
 61     @Override
 62     public String id() {
 63         return json.get(&quot;key&quot;).asString();
 64     }
 65 
 66     @Override
 67     public HostUser author() {
 68         return new HostUser(json.get(&quot;fields&quot;).get(&quot;creator&quot;).get(&quot;key&quot;).asString(),
 69                             json.get(&quot;fields&quot;).get(&quot;creator&quot;).get(&quot;name&quot;).asString(),
 70                             json.get(&quot;fields&quot;).get(&quot;creator&quot;).get(&quot;displayName&quot;).asString());
 71     }
 72 
 73     @Override
 74     public String title() {
 75         return json.get(&quot;fields&quot;).get(&quot;summary&quot;).asString();
 76     }
 77 
 78     @Override
 79     public void setTitle(String title) {
<span class="line-modified"> 80         if (needSecurity) {</span>
<span class="line-modified"> 81             log.warning(&quot;Issue title does not support setting a security level - ignoring&quot;);</span>
 82             return;
 83         }
 84         var query = JSON.object()
 85                         .put(&quot;fields&quot;, JSON.object()
 86                                            .put(&quot;summary&quot;, title));
 87         request.put(&quot;&quot;).body(query).execute();
 88     }
 89 
 90     @Override
 91     public String body() {
 92         if (json.get(&quot;fields&quot;).get(&quot;description&quot;).isNull()) {
 93             return &quot;&quot;;
 94         } else {
 95             return json.get(&quot;fields&quot;).get(&quot;description&quot;).asString();
 96         }
 97     }
 98 
 99     @Override
100     public void setBody(String body) {
<span class="line-modified">101         if (needSecurity) {</span>
<span class="line-modified">102             log.warning(&quot;Issue body does not support setting a security level - ignoring&quot;);</span>
103             return;
104         }
105         var query = JSON.object()
106                         .put(&quot;fields&quot;, JSON.object()
107                                            .put(&quot;description&quot;, body));
108         request.put(&quot;&quot;).body(query).execute();
109     }
110 
111     private Comment parseComment(JSONValue json) {
112         return new Comment(json.get(&quot;id&quot;).asString(),
113                            json.get(&quot;body&quot;).asString(),
114                            new HostUser(json.get(&quot;author&quot;).get(&quot;name&quot;).asString(),
115                                         json.get(&quot;author&quot;).get(&quot;name&quot;).asString(),
116                                         json.get(&quot;author&quot;).get(&quot;displayName&quot;).asString()),
117                            ZonedDateTime.parse(json.get(&quot;created&quot;).asString(), dateFormat),
118                            ZonedDateTime.parse(json.get(&quot;updated&quot;).asString(), dateFormat));
119     }
120 
121     @Override
122     public List&lt;Comment&gt; comments() {
</pre>
<hr />
<pre>
217                     if (!availableTransitions.containsKey(&quot;Closed&quot;)) {
218                         throw new RuntimeException(&quot;Cannot transition to Closed after Resolved&quot;);
219                     }
220                 } else {
221                     throw new RuntimeException(&quot;Cannot transition to Closed&quot;);
222                 }
223                 performTransition(availableTransitions.get(&quot;Closed&quot;));
224             }
225         } else if (state == State.OPEN) {
226             if (!availableTransitions.containsKey(&quot;Open&quot;)) {
227                 throw new RuntimeException(&quot;Cannot transition to Open&quot;);
228             }
229             performTransition(availableTransitions.get(&quot;Open&quot;));
230         } else {
231             throw new IllegalStateException(&quot;Unknown state &quot; + state);
232         }
233     }
234 
235     @Override
236     public void addLabel(String label) {
<span class="line-modified">237         if (needSecurity) {</span>
<span class="line-modified">238             log.warning(&quot;Issue label does not support setting a security level - ignoring&quot;);</span>
239             return;
240         }
241         var query = JSON.object()
242                         .put(&quot;update&quot;, JSON.object()
243                                            .put(&quot;labels&quot;, JSON.array().add(JSON.object()
244                                                                                .put(&quot;add&quot;, label))));
245         request.put(&quot;&quot;).body(query).execute();
246     }
247 
248     @Override
249     public void removeLabel(String label) {
250         var query = JSON.object()
251                         .put(&quot;update&quot;, JSON.object()
252                                            .put(&quot;labels&quot;, JSON.array().add(JSON.object()
253                                                                                .put(&quot;remove&quot;, label))));
254         request.put(&quot;&quot;).body(query).execute();
255     }
256 
257     @Override
258     public List&lt;String&gt; labels() {
</pre>
<hr />
<pre>
318         if (json.get(&quot;object&quot;).get(&quot;status&quot;).contains(&quot;icon&quot;)) {
319             if (json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;icon&quot;).contains(&quot;url16x16&quot;)) {
320                 link.statusIconUrl(URI.create(json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;icon&quot;).get(&quot;url16x16&quot;).asString()));
321             }
322             if (json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;icon&quot;).contains(&quot;title&quot;)) {
323                 link.statusIconTitle(json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;icon&quot;).get(&quot;title&quot;).asString());
324             }
325         }
326         link.resolved(json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;resolved&quot;).asBoolean());
327         return link.build();
328     }
329 
330     @Override
331     public List&lt;Link&gt; links() {
332         var result = request.get(&quot;/remotelink&quot;).execute();
333         var links = result.stream()
334                           .map(JSONValue::asObject)
335                           .filter(obj -&gt; obj.contains(&quot;globalId&quot;))
336                           .filter(obj -&gt; obj.get(&quot;globalId&quot;).asString().startsWith(&quot;skaralink=&quot;))
337                           .map(this::parseLink);
<span class="line-added">338 </span>
<span class="line-added">339         var commentLinks = comments().stream()</span>
<span class="line-added">340                                      .map(this::parseWebLinkComment)</span>
<span class="line-added">341                                      .filter(Optional::isPresent)</span>
<span class="line-added">342                                      .map(Optional::get);</span>
<span class="line-added">343         links = Stream.concat(commentLinks, links);</span>
<span class="line-added">344 </span>
345         if (json.get(&quot;fields&quot;).contains(&quot;issuelinks&quot;)) {
346             var issueLinks = json.get(&quot;fields&quot;).get(&quot;issuelinks&quot;).stream()
347                                  .map(JSONValue::asObject)
348                                  .map(o -&gt; Link.create(o.contains(&quot;inwardIssue&quot;) ? jiraProject.issue(o.get(&quot;inwardIssue&quot;).get(&quot;key&quot;).asString()).orElseThrow() :
349                                                                jiraProject.issue(o.get(&quot;outwardIssue&quot;).get(&quot;key&quot;).asString()).orElseThrow(),
350                                                        o.contains(&quot;inwardIssue&quot;) ? o.get(&quot;type&quot;).get(&quot;inward&quot;).asString() :
351                                                                o.get(&quot;type&quot;).get(&quot;outward&quot;).asString())
352                                                .build());
353 
354             links = Stream.concat(issueLinks, links);
355         }
<span class="line-added">356 </span>
357         return links.collect(Collectors.toList());
358     }
359 
<span class="line-added">360     private static final Pattern titlePattern = Pattern.compile(&quot;^Remote link: (.*)&quot;);</span>
<span class="line-added">361     private static final Pattern urlPattern = Pattern.compile(&quot;^URL: (.*)&quot;);</span>
<span class="line-added">362     private static final Pattern summaryPattern = Pattern.compile(&quot;^Summary: (.*)&quot;);</span>
<span class="line-added">363     private static final Pattern relationshipPattern = Pattern.compile(&quot;^Relationship: (.*)&quot;);</span>
<span class="line-added">364 </span>
<span class="line-added">365     private Optional&lt;Link&gt; parseWebLinkComment(Comment comment) {</span>
<span class="line-added">366         var lines = comment.body().lines().collect(Collectors.toList());</span>
<span class="line-added">367         if ((lines.size() &lt; 2 ) || (lines.size() &gt; 4)) {</span>
<span class="line-added">368             return Optional.empty();</span>
<span class="line-added">369         }</span>
<span class="line-added">370         var titleMatcher = titlePattern.matcher(lines.get(0));</span>
<span class="line-added">371         var urlMatcher = urlPattern.matcher(lines.get(1));</span>
<span class="line-added">372         if (!titleMatcher.matches() || !urlMatcher.matches()) {</span>
<span class="line-added">373             return Optional.empty();</span>
<span class="line-added">374         }</span>
<span class="line-added">375         var linkBuilder = Link.create(URI.create(urlMatcher.group(1)), titleMatcher.group(1));</span>
<span class="line-added">376         for (int i = 2; i &lt; lines.size(); ++i) {</span>
<span class="line-added">377             var line = lines.get(i);</span>
<span class="line-added">378             var summaryMatcher = summaryPattern.matcher(line);</span>
<span class="line-added">379             if (summaryMatcher.matches()) {</span>
<span class="line-added">380                 linkBuilder.summary(summaryMatcher.group(1));</span>
<span class="line-added">381             }</span>
<span class="line-added">382             var relationshipMatcher = relationshipPattern.matcher(line);</span>
<span class="line-added">383             if (relationshipMatcher.matches()) {</span>
<span class="line-added">384                 linkBuilder.relationship(relationshipMatcher.group(1));</span>
<span class="line-added">385             }</span>
<span class="line-added">386         }</span>
<span class="line-added">387         return Optional.of(linkBuilder.build());</span>
<span class="line-added">388     }</span>
<span class="line-added">389 </span>
<span class="line-added">390     private void addWebLinkAsComment(Link link) {</span>
<span class="line-added">391         var body = new StringBuilder();</span>
<span class="line-added">392         body.append(&quot;Remote link: &quot;).append(link.title().orElseThrow()).append(&quot;\n&quot;);</span>
<span class="line-added">393         body.append(&quot;URL: &quot;).append(link.uri().orElseThrow().toString()).append(&quot;\n&quot;);</span>
<span class="line-added">394         link.summary().ifPresent(summary -&gt; body.append(&quot;Summary: &quot;).append(summary).append(&quot;\n&quot;));</span>
<span class="line-added">395         link.relationship().ifPresent(relationship -&gt; body.append(&quot;Relationship: &quot;).append(relationship).append(&quot;\n&quot;));</span>
<span class="line-added">396 </span>
<span class="line-added">397         addComment(body.toString());</span>
<span class="line-added">398     }</span>
<span class="line-added">399 </span>
400     private void addWebLink(Link link) {
<span class="line-modified">401         if (needSecurity) {</span>
<span class="line-modified">402             addWebLinkAsComment(link);</span>
403             return;
404         }
405 
406         var query = JSON.object().put(&quot;globalId&quot;, &quot;skaralink=&quot; + link.uri().orElseThrow().toString());
407         var object = JSON.object().put(&quot;url&quot;, link.uri().orElseThrow().toString()).put(&quot;title&quot;, link.title().orElseThrow());
408         var status = JSON.object().put(&quot;resolved&quot;, link.resolved());
409         var icon = JSON.object();
410         var statusIcon = JSON.object();
411 
412         query.put(&quot;object&quot;, object);
413         object.put(&quot;icon&quot;, icon);
414         object.put(&quot;status&quot;, status);
415         status.put(&quot;icon&quot;, statusIcon);
416 
417         link.relationship().ifPresent(relationship -&gt; query.put(&quot;relationship&quot;, relationship));
418         link.summary().ifPresent(summary -&gt; object.put(&quot;summary&quot;, summary));
419         link.iconUrl().ifPresent(iconUrl -&gt; icon.put(&quot;url16x16&quot;, iconUrl.toString()));
420         link.iconTitle().ifPresent(iconTitle -&gt; icon.put(&quot;title&quot;, iconTitle));
421         link.statusIconUrl().ifPresent(statusIconUrl -&gt; statusIcon.put(&quot;url16x16&quot;, statusIconUrl.toString()));
422         link.statusIconTitle().ifPresent(statusIconTitle -&gt; statusIcon.put(&quot;title&quot;, statusIconTitle));
</pre>
<hr />
<pre>
454 
455         jiraProject.executeLinkQuery(query);
456     }
457 
458     @Override
459     public void addLink(Link link) {
460         if (link.uri().isPresent() &amp;&amp; link.title().isPresent()) {
461             addWebLink(link);
462         } else if (link.issue().isPresent() &amp;&amp; link.relationship().isPresent()) {
463             addIssueLink(link);
464         } else {
465             throw new IllegalArgumentException(&quot;Unknown type of link: &quot; + link);
466         }
467     }
468 
469     private void removeWebLink(Link link) {
470         request.delete(&quot;/remotelink&quot;)
471                .param(&quot;globalId&quot;, &quot;skaralink=&quot; + link.uri().orElseThrow().toString())
472                .onError(e -&gt; e.statusCode() == 404 ? Optional.of(JSON.object().put(&quot;already_deleted&quot;, true)) : Optional.empty())
473                .execute();
<span class="line-added">474 </span>
<span class="line-added">475         for (var comment : comments()) {</span>
<span class="line-added">476             var commentLink = parseWebLinkComment(comment);</span>
<span class="line-added">477             if (commentLink.isEmpty()) {</span>
<span class="line-added">478                 continue;</span>
<span class="line-added">479             }</span>
<span class="line-added">480             if (!commentLink.get().uri().equals(link.uri())) {</span>
<span class="line-added">481                 continue;</span>
<span class="line-added">482             }</span>
<span class="line-added">483             request.delete(&quot;/comment/&quot; + comment.id()).execute();</span>
<span class="line-added">484         }</span>
485     }
486 
487     private void removeIssueLink(Link link) {
488         throw new RuntimeException(&quot;not implemented yet&quot;);
489     }
490 
491     @Override
492     public void removeLink(Link link) {
493         if (link.uri().isPresent()) {
494             removeWebLink(link);
495         } else if (link.issue().isPresent() &amp;&amp; link.relationship().isPresent()) {
496             removeIssueLink(link);
497         } else {
498             throw new IllegalArgumentException(&quot;Unknown type of link: &quot; + link);
499         }
500     }
501 
502     @Override
503     public Map&lt;String, JSONValue&gt; properties() {
504         var ret = new HashMap&lt;String, JSONValue&gt;();
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>