<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.notify;
  24 
  25 import org.openjdk.skara.email.*;
  26 import org.openjdk.skara.forge.HostedRepository;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.json.*;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.storage.StorageBuilder;
  31 import org.openjdk.skara.test.*;
  32 import org.openjdk.skara.vcs.*;
  33 import org.openjdk.skara.vcs.Tag;
  34 import org.openjdk.skara.vcs.openjdk.OpenJDKTag;
  35 
  36 import org.junit.jupiter.api.*;
  37 
  38 import java.io.IOException;
  39 import java.net.URI;
  40 import java.nio.charset.StandardCharsets;
  41 import java.nio.file.*;
  42 import java.time.Duration;
  43 import java.util.*;
  44 import java.util.regex.Pattern;
  45 import java.util.stream.Collectors;
  46 
  47 import static org.junit.jupiter.api.Assertions.*;
  48 import static org.openjdk.skara.issuetracker.Issue.State.*;
  49 
  50 class UpdaterTests {
  51     private List&lt;Path&gt; findJsonFiles(Path folder, String partialName) throws IOException {
  52         return Files.walk(folder)
  53                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
  54                     .filter(path -&gt; path.toString().contains(partialName))
  55                     .collect(Collectors.toList());
  56     }
  57 
<a name="1" id="anc1"></a><span class="line-modified">  58     private StorageBuilder&lt;UpdatedTag&gt; createTagStorage(HostedRepository repository) {</span>
<span class="line-modified">  59         return new StorageBuilder&lt;UpdatedTag&gt;(&quot;tags.txt&quot;)</span>
  60                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);
  61     }
  62 
<a name="2" id="anc2"></a><span class="line-modified">  63     private StorageBuilder&lt;UpdatedBranch&gt; createBranchStorage(HostedRepository repository) {</span>
<span class="line-modified">  64         return new StorageBuilder&lt;UpdatedBranch&gt;(&quot;branches.txt&quot;)</span>
  65                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);
  66     }
  67 
  68     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {
  69         return new StorageBuilder&lt;PullRequestIssues&gt;(&quot;prissues.txt&quot;)
  70                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated prissues&quot;);
  71     }
  72 
  73     private Set&lt;String&gt; fixVersions(Issue issue) {
  74         if (!issue.properties().containsKey(&quot;fixVersions&quot;)) {
  75             return Set.of();
  76         }
  77         return issue.properties().get(&quot;fixVersions&quot;).stream()
  78                     .map(JSONValue::asString)
  79                     .collect(Collectors.toSet());
  80     }
  81 
  82     @Test
  83     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
  84         try (var credentials = new HostCredentials(testInfo);
  85              var tempFolder = new TemporaryDirectory()) {
  86             var repo = credentials.getHostedRepository();
  87             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
  88             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
  89             credentials.commitLock(localRepo);
  90             localRepo.pushAll(repo.url());
  91 
  92             var tagStorage = createTagStorage(repo);
  93             var branchStorage = createBranchStorage(repo);
  94             var prIssuesStorage = createPullRequestIssuesStorage(repo);
  95             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
  96             Files.createDirectory(jsonFolder);
  97             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  98 
  99             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
 100             var notifyBot = NotifyBot.newBuilder()
 101                                      .repository(repo)
 102                                      .storagePath(storageFolder)
 103                                      .branches(Pattern.compile(&quot;master&quot;))
 104                                      .tagStorageBuilder(tagStorage)
 105                                      .branchStorageBuilder(branchStorage)
 106                                      .prIssuesStorageBuilder(prIssuesStorage)
 107                                      .updaters(List.of(updater))
 108                                      .build();
 109 
 110             TestBotRunner.runPeriodicItems(notifyBot);
 111             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 112 
 113             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 114             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 115             TestBotRunner.runPeriodicItems(notifyBot);
 116             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 117             assertEquals(1, jsonFiles.size());
 118             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 119             var json = JSON.parse(jsonData);
 120             assertEquals(1, json.asArray().size());
 121             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 122             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 123                                                   .map(JSONValue::asString)
 124                                                   .collect(Collectors.toList()));
 125         }
 126     }
 127 
 128     @Test
 129     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
 130         try (var credentials = new HostCredentials(testInfo);
 131              var tempFolder = new TemporaryDirectory()) {
 132             var repo = credentials.getHostedRepository();
 133             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 134             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 135             credentials.commitLock(localRepo);
 136             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 137             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 138             localRepo.pushAll(repo.url());
 139 
 140             var tagStorage = createTagStorage(repo);
 141             var branchStorage = createBranchStorage(repo);
 142             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 143             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 144             Files.createDirectory(jsonFolder);
 145             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
 146 
 147             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
 148             var notifyBot = NotifyBot.newBuilder()
 149                                      .repository(repo)
 150                                      .storagePath(storageFolder)
 151                                      .branches(Pattern.compile(&quot;master&quot;))
 152                                      .tagStorageBuilder(tagStorage)
 153                                      .branchStorageBuilder(branchStorage)
 154                                      .prIssuesStorageBuilder(prIssuesStorage)
 155                                      .updaters(List.of(updater))
 156                                      .build();
 157 
 158             TestBotRunner.runPeriodicItems(notifyBot);
 159             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 160 
 161             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 162             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 163             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 164             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
 165             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 166             localRepo.pushAll(repo.url());
 167 
 168             TestBotRunner.runPeriodicItems(notifyBot);
 169             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 170             assertEquals(3, jsonFiles.size());
 171 
 172             for (var file : jsonFiles) {
 173                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
 174                 var json = JSON.parse(jsonData);
 175 
 176                 if (json.asArray().get(0).contains(&quot;date&quot;)) {
 177                     assertEquals(2, json.asArray().size());
 178                     assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 179                                                           .map(JSONValue::asString)
 180                                                           .collect(Collectors.toList()));
 181                     assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 182                     assertEquals(&quot;team&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 183                     assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(1).get(&quot;issue&quot;).asArray().stream()
 184                                                           .map(JSONValue::asString)
 185                                                           .collect(Collectors.toList()));
 186                     assertEquals(repo.webUrl(editHash2).toString(), json.asArray().get(1).get(&quot;url&quot;).asString());
 187                     assertEquals(&quot;team&quot;, json.asArray().get(1).get(&quot;build&quot;).asString());
 188                 } else {
 189                     assertEquals(1, json.asArray().size());
 190                     if (json.asArray().get(0).get(&quot;build&quot;).asString().equals(&quot;b02&quot;)) {
 191                         assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 192                                                               .map(JSONValue::asString)
 193                                                               .collect(Collectors.toList()));
 194                     } else {
 195                         assertEquals(&quot;b04&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 196                         assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 197                                                               .map(JSONValue::asString)
 198                                                               .collect(Collectors.toList()));
 199                     }
 200                 }
 201             }
 202         }
 203     }
 204 
 205     @Test
 206     void testMailingList(TestInfo testInfo) throws IOException {
 207         try (var listServer = new TestMailmanServer();
 208              var credentials = new HostCredentials(testInfo);
 209              var tempFolder = new TemporaryDirectory()) {
 210             var repo = credentials.getHostedRepository();
 211             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 212             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 213             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 214             credentials.commitLock(localRepo);
 215             localRepo.pushAll(repo.url());
 216 
 217             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 218             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 219             var mailmanList = mailmanServer.getList(listAddress.address());
 220             var tagStorage = createTagStorage(repo);
 221             var branchStorage = createBranchStorage(repo);
 222             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 223             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 224 
 225             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 226             var updater = MailingListUpdater.newBuilder()
 227                                             .list(mailmanList)
 228                                             .recipient(listAddress)
 229                                             .sender(sender)
 230                                             .reportNewTags(false)
 231                                             .reportNewBranches(false)
 232                                             .reportNewBuilds(false)
 233                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 234                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
 235                                             .build();
 236             var notifyBot = NotifyBot.newBuilder()
 237                                      .repository(repo)
 238                                      .storagePath(storageFolder)
 239                                      .branches(Pattern.compile(&quot;master&quot;))
 240                                      .tagStorageBuilder(tagStorage)
 241                                      .branchStorageBuilder(branchStorage)
 242                                      .prIssuesStorageBuilder(prIssuesStorage)
 243                                      .updaters(List.of(updater))
 244                                      .build();
 245 
 246             // No mail should be sent on the first run as there is no history
 247             TestBotRunner.runPeriodicItems(notifyBot);
 248             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 249 
 250             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 251             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 252             TestBotRunner.runPeriodicItems(notifyBot);
 253             listServer.processIncoming();
 254 
 255             var conversations = mailmanList.conversations(Duration.ofDays(1));
 256             var email = conversations.get(0).first();
 257             assertEquals(listAddress, email.sender());
 258             assertEquals(sender, email.author());
 259             assertEquals(email.recipients(), List.of(listAddress));
 260             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
 261             assertFalse(email.subject().contains(&quot;master&quot;));
 262             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 263             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 264             assertFalse(email.body().contains(&quot;Committer&quot;));
 265             assertFalse(email.body().contains(masterHash.abbreviate()));
 266             assertTrue(email.hasHeader(&quot;extra1&quot;));
 267             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 268             assertTrue(email.hasHeader(&quot;extra2&quot;));
 269             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 270         }
 271     }
 272 
 273     @Test
 274     void testMailingListMultiple(TestInfo testInfo) throws IOException {
 275         try (var listServer = new TestMailmanServer();
 276              var credentials = new HostCredentials(testInfo);
 277              var tempFolder = new TemporaryDirectory()) {
 278             var repo = credentials.getHostedRepository();
 279             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 280             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 281             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 282             credentials.commitLock(localRepo);
 283             localRepo.pushAll(repo.url());
 284 
 285             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 286             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 287             var mailmanList = mailmanServer.getList(listAddress.address());
 288             var tagStorage = createTagStorage(repo);
 289             var branchStorage = createBranchStorage(repo);
 290             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 291             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 292 
 293             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 294             var updater = MailingListUpdater.newBuilder()
 295                                             .list(mailmanList)
 296                                             .recipient(listAddress)
 297                                             .sender(sender)
 298                                             .reportNewTags(false)
 299                                             .reportNewBranches(false)
 300                                             .reportNewBuilds(false)
 301                                             .build();
 302             var notifyBot = NotifyBot.newBuilder()
 303                                      .repository(repo)
 304                                      .storagePath(storageFolder)
 305                                      .branches(Pattern.compile(&quot;master&quot;))
 306                                      .tagStorageBuilder(tagStorage)
 307                                      .branchStorageBuilder(branchStorage)
 308                                      .prIssuesStorageBuilder(prIssuesStorage)
 309                                      .updaters(List.of(updater))
 310                                      .build();
 311 
 312             // No mail should be sent on the first run as there is no history
 313             TestBotRunner.runPeriodicItems(notifyBot);
 314             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 315 
 316             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 317                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 318             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 319             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 320                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 321             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 322 
 323             TestBotRunner.runPeriodicItems(notifyBot);
 324             listServer.processIncoming();
 325 
 326             var conversations = mailmanList.conversations(Duration.ofDays(1));
 327             var email = conversations.get(0).first();
 328             assertEquals(listAddress, email.sender());
 329             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());
 330             assertEquals(email.recipients(), List.of(listAddress));
 331             assertTrue(email.subject().contains(&quot;: 2 new changesets&quot;));
 332             assertFalse(email.subject().contains(&quot;master&quot;));
 333             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 334             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 335             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 336             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 337             assertFalse(email.body().contains(masterHash.abbreviate()));
 338         }
 339     }
 340 
 341     @Test
 342     void testMailingListSponsored(TestInfo testInfo) throws IOException {
 343         try (var listServer = new TestMailmanServer();
 344              var credentials = new HostCredentials(testInfo);
 345              var tempFolder = new TemporaryDirectory()) {
 346             var repo = credentials.getHostedRepository();
 347             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 348             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 349             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 350             credentials.commitLock(localRepo);
 351             localRepo.pushAll(repo.url());
 352 
 353             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 354             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 355             var mailmanList = mailmanServer.getList(listAddress.address());
 356             var tagStorage = createTagStorage(repo);
 357             var branchStorage = createBranchStorage(repo);
 358             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 359             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 360 
 361             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 362             var updater = MailingListUpdater.newBuilder()
 363                                             .list(mailmanList)
 364                                             .recipient(listAddress)
 365                                             .sender(sender)
 366                                             .reportNewTags(false)
 367                                             .reportNewBranches(false)
 368                                             .reportNewBuilds(false)
 369                                             .build();
 370             var notifyBot = NotifyBot.newBuilder()
 371                                      .repository(repo)
 372                                      .storagePath(storageFolder)
 373                                      .branches(Pattern.compile(&quot;master&quot;))
 374                                      .tagStorageBuilder(tagStorage)
 375                                      .branchStorageBuilder(branchStorage)
 376                                      .prIssuesStorageBuilder(prIssuesStorage)
 377                                      .updaters(List.of(updater))
 378                                      .build();
 379 
 380             // No mail should be sent on the first run as there is no history
 381             TestBotRunner.runPeriodicItems(notifyBot);
 382             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 383 
 384             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 385                                                                &quot;author&quot;, &quot;author@test.test&quot;,
 386                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);
 387             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 388             TestBotRunner.runPeriodicItems(notifyBot);
 389             listServer.processIncoming();
 390 
 391             var conversations = mailmanList.conversations(Duration.ofDays(1));
 392             var email = conversations.get(0).first();
 393             assertEquals(listAddress, email.sender());
 394             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
 395             assertEquals(email.recipients(), List.of(listAddress));
 396             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 397             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 398             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
 399             assertTrue(email.body().contains(&quot;Committer: committer &lt;committer@test.test&gt;&quot;));
 400             assertFalse(email.body().contains(masterHash.abbreviate()));
 401         }
 402     }
 403 
 404     @Test
 405     void testMailingListMultipleBranches(TestInfo testInfo) throws IOException {
 406         try (var listServer = new TestMailmanServer();
 407              var credentials = new HostCredentials(testInfo);
 408              var tempFolder = new TemporaryDirectory()) {
 409             var repo = credentials.getHostedRepository();
 410             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 411             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 412             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 413             credentials.commitLock(localRepo);
 414             var branch = localRepo.branch(masterHash, &quot;another&quot;);
 415             localRepo.pushAll(repo.url());
 416 
 417             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 418             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 419             var mailmanList = mailmanServer.getList(listAddress.address());
 420             var tagStorage = createTagStorage(repo);
 421             var branchStorage = createBranchStorage(repo);
 422             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 423             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 424 
 425             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 426             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 427             var updater = MailingListUpdater.newBuilder()
 428                                             .list(mailmanList)
 429                                             .recipient(listAddress)
 430                                             .sender(sender)
 431                                             .author(author)
 432                                             .includeBranch(true)
 433                                             .reportNewTags(false)
 434                                             .reportNewBranches(false)
 435                                             .reportNewBuilds(false)
 436                                             .build();
 437             var notifyBot = NotifyBot.newBuilder()
 438                                      .repository(repo)
 439                                      .storagePath(storageFolder)
 440                                      .branches(Pattern.compile(&quot;master|another&quot;))
 441                                      .tagStorageBuilder(tagStorage)
 442                                      .branchStorageBuilder(branchStorage)
 443                                      .prIssuesStorageBuilder(prIssuesStorage)
 444                                      .updaters(List.of(updater))
 445                                      .build();
 446 
 447             // No mail should be sent on the first run as there is no history
 448             TestBotRunner.runPeriodicItems(notifyBot);
 449             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 450 
 451             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 452             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 453             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
 454             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 455 
 456             TestBotRunner.runPeriodicItems(notifyBot);
 457             listServer.processIncoming();
 458 
 459             var conversations = mailmanList.conversations(Duration.ofDays(1));
 460             var email = conversations.get(0).first();
 461             assertEquals(listAddress, email.sender());
 462             assertEquals(author, email.author());
 463             assertEquals(email.recipients(), List.of(listAddress));
 464             assertFalse(email.subject().contains(&quot;another&quot;));
 465             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
 466             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 467             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 468             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 469             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 470             assertFalse(email.body().contains(masterHash.abbreviate()));
 471             assertFalse(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 472 
 473             localRepo.checkout(branch, true);
 474             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);
 475             localRepo.push(editHash3, repo.url(), &quot;another&quot;);
 476 
 477             TestBotRunner.runPeriodicItems(notifyBot);
 478             listServer.processIncoming();
 479 
 480             conversations = mailmanList.conversations(Duration.ofDays(1));
 481             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 482             email = conversations.get(0).first();
 483             assertEquals(author, email.author());
 484             assertEquals(listAddress, email.sender());
 485             assertEquals(email.recipients(), List.of(listAddress));
 486             assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));
 487             assertFalse(email.subject().contains(&quot;master&quot;));
 488             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));
 489             assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 490             assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 491             assertFalse(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 492         }
 493     }
 494 
 495     @Test
 496     void testMailingListPROnly(TestInfo testInfo) throws IOException {
 497         try (var listServer = new TestMailmanServer();
 498              var credentials = new HostCredentials(testInfo);
 499              var tempFolder = new TemporaryDirectory()) {
 500             var repo = credentials.getHostedRepository();
 501             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 502             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 503             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 504             credentials.commitLock(localRepo);
 505             localRepo.pushAll(repo.url());
 506 
 507             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 508             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 509             var mailmanList = mailmanServer.getList(listAddress.address());
 510             var tagStorage = createTagStorage(repo);
 511             var branchStorage = createBranchStorage(repo);
 512             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 513             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 514 
 515             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 516             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 517             var updater = MailingListUpdater.newBuilder()
 518                                             .list(mailmanList)
 519                                             .recipient(listAddress)
 520                                             .sender(sender)
 521                                             .author(author)
 522                                             .reportNewTags(false)
 523                                             .reportNewBranches(false)
 524                                             .reportNewBuilds(false)
 525                                             .mode(MailingListUpdater.Mode.PR_ONLY)
 526                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;))
 527                                             .build();
 528             var notifyBot = NotifyBot.newBuilder()
 529                                      .repository(repo)
 530                                      .storagePath(storageFolder)
 531                                      .branches(Pattern.compile(&quot;master&quot;))
 532                                      .tagStorageBuilder(tagStorage)
 533                                      .branchStorageBuilder(branchStorage)
 534                                      .prIssuesStorageBuilder(prIssuesStorage)
 535                                      .updaters(List.of(updater))
 536                                      .build();
 537 
 538             // No mail should be sent on the first run as there is no history
 539             TestBotRunner.runPeriodicItems(notifyBot);
 540             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 541 
 542             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 543             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 544             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 545 
 546             // Create a potentially conflicting one
 547             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 548             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 549             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 550 
 551             // PR hasn&#39;t been integrated yet, so there should be no mail
 552             TestBotRunner.runPeriodicItems(notifyBot);
 553             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 554 
 555             // Simulate an RFR email
 556             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
 557                     .recipient(listAddress)
 558                     .build();
 559             mailmanList.post(rfr);
 560             listServer.processIncoming();
 561 
 562             // And an integration
 563             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 564             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 565             TestBotRunner.runPeriodicItems(notifyBot);
 566             listServer.processIncoming();
 567 
 568             var conversations = mailmanList.conversations(Duration.ofDays(1));
 569             assertEquals(1, conversations.size());
 570             var first = conversations.get(0).first();
 571             var email = conversations.get(0).replies(first).get(0);
 572             assertEquals(listAddress, email.sender());
 573             assertEquals(author, email.author());
 574             assertEquals(email.recipients(), List.of(listAddress));
 575             assertEquals(&quot;[Integrated] RFR: My PR&quot;, email.subject());
 576             assertFalse(email.subject().contains(&quot;master&quot;));
 577             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 578             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 579             assertFalse(email.body().contains(&quot;Committer&quot;));
 580             assertFalse(email.body().contains(masterHash.abbreviate()));
 581             assertTrue(email.hasHeader(&quot;extra1&quot;));
 582             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 583 
 584             // Now push the other one without a matching PR - PR_ONLY will not generate a mail
 585             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 586             TestBotRunner.runPeriodicItems(notifyBot);
 587             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofSeconds(1)));
 588         }
 589     }
 590 
 591     @Test
 592     void testMailingListPR(TestInfo testInfo) throws IOException {
 593         try (var listServer = new TestMailmanServer();
 594              var credentials = new HostCredentials(testInfo);
 595              var tempFolder = new TemporaryDirectory()) {
 596             var repo = credentials.getHostedRepository();
 597             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 598             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 599             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 600             credentials.commitLock(localRepo);
 601             localRepo.pushAll(repo.url());
 602 
 603             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 604             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 605             var mailmanList = mailmanServer.getList(listAddress.address());
 606             var tagStorage = createTagStorage(repo);
 607             var branchStorage = createBranchStorage(repo);
 608             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 609             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 610 
 611             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 612             var updater = MailingListUpdater.newBuilder()
 613                                             .list(mailmanList)
 614                                             .recipient(listAddress)
 615                                             .sender(sender)
 616                                             .reportNewTags(false)
 617                                             .reportNewBranches(false)
 618                                             .reportNewBuilds(false)
 619                                             .mode(MailingListUpdater.Mode.PR)
 620                                             .build();
 621             var notifyBot = NotifyBot.newBuilder()
 622                                      .repository(repo)
 623                                      .storagePath(storageFolder)
 624                                      .branches(Pattern.compile(&quot;master&quot;))
 625                                      .tagStorageBuilder(tagStorage)
 626                                      .branchStorageBuilder(branchStorage)
 627                                      .prIssuesStorageBuilder(prIssuesStorage)
 628                                      .updaters(List.of(updater))
 629                                      .build();
 630 
 631             // No mail should be sent on the first run as there is no history
 632             TestBotRunner.runPeriodicItems(notifyBot);
 633             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 634 
 635             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 636             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 637             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 638 
 639             // Create a potentially conflicting one
 640             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 641             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 642             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 643 
 644             // PR hasn&#39;t been integrated yet, so there should be no mail
 645             TestBotRunner.runPeriodicItems(notifyBot);
 646             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 647 
 648             // Simulate an RFR email
 649             var rfr = Email.create(&quot;[repo/branch] RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 650                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 651                            .recipient(listAddress)
 652                            .build();
 653             mailmanList.post(rfr);
 654             listServer.processIncoming();
 655 
 656             // And an integration
 657             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 658             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 659 
 660             // Push the other one without a matching PR
 661             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 662 
 663             TestBotRunner.runPeriodicItems(notifyBot);
 664             listServer.processIncoming();
 665             listServer.processIncoming();
 666 
 667             var conversations = mailmanList.conversations(Duration.ofDays(1));
 668             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 669             assertEquals(2, conversations.size());
 670 
 671             var prConversation = conversations.get(0);
 672             var pushConversation = conversations.get(1);
 673 
 674             var prEmail = prConversation.replies(prConversation.first()).get(0);
 675             assertEquals(listAddress, prEmail.sender());
 676             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
 677             assertEquals(prEmail.recipients(), List.of(listAddress));
 678             assertEquals(&quot;[Integrated] [repo/branch] RFR: My PR&quot;, prEmail.subject());
 679             assertFalse(prEmail.subject().contains(&quot;master&quot;));
 680             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 681             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
 682             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
 683             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
 684 
 685             var pushEmail = pushConversation.first();
 686             assertEquals(listAddress, pushEmail.sender());
 687             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 688             assertEquals(pushEmail.recipients(), List.of(listAddress));
 689             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 690         }
 691     }
 692 
 693     @Test
 694     void testMailingListPROnce(TestInfo testInfo) throws IOException {
 695         try (var listServer = new TestMailmanServer();
 696              var credentials = new HostCredentials(testInfo);
 697              var tempFolder = new TemporaryDirectory()) {
 698             var repo = credentials.getHostedRepository();
 699             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 700             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 701             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 702             localRepo.branch(masterHash, &quot;other&quot;);
 703             credentials.commitLock(localRepo);
 704             localRepo.pushAll(repo.url());
 705 
 706             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 707             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 708             var mailmanList = mailmanServer.getList(listAddress.address());
 709             var tagStorage = createTagStorage(repo);
 710             var branchStorage = createBranchStorage(repo);
 711             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 712             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 713 
 714             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 715             var updater = MailingListUpdater.newBuilder()
 716                                             .list(mailmanList)
 717                                             .recipient(listAddress)
 718                                             .sender(sender)
 719                                             .author(null)
 720                                             .reportNewTags(false)
 721                                             .reportNewBranches(false)
 722                                             .reportNewBuilds(false)
 723                                             .mode(MailingListUpdater.Mode.PR)
 724                                             .build();
 725             var notifyBot = NotifyBot.newBuilder()
 726                                      .repository(repo)
 727                                      .storagePath(storageFolder)
 728                                      .branches(Pattern.compile(&quot;master|other&quot;))
 729                                      .tagStorageBuilder(tagStorage)
 730                                      .branchStorageBuilder(branchStorage)
 731                                      .prIssuesStorageBuilder(prIssuesStorage)
 732                                      .updaters(List.of(updater))
 733                                      .build();
 734 
 735             // No mail should be sent on the first run as there is no history
 736             TestBotRunner.runPeriodicItems(notifyBot);
 737             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 738 
 739             localRepo.checkout(masterHash, true);
 740             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 741             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 742             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 743 
 744             // PR hasn&#39;t been integrated yet, so there should be no mail
 745             TestBotRunner.runPeriodicItems(notifyBot);
 746             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 747 
 748             // Simulate an RFR email
 749             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 750                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 751                            .recipient(listAddress)
 752                            .build();
 753             mailmanList.post(rfr);
 754             listServer.processIncoming();
 755 
 756             // And an integration
 757             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 758             localRepo.push(editHash, repo.url(), &quot;master&quot;, true);
 759 
 760             TestBotRunner.runPeriodicItems(notifyBot);
 761             listServer.processIncoming();
 762 
 763             var conversations = mailmanList.conversations(Duration.ofDays(1));
 764             assertEquals(1, conversations.size());
 765 
 766             var prConversation = conversations.get(0);
 767             var prEmail = prConversation.replies(prConversation.first()).get(0);
 768             assertEquals(listAddress, prEmail.sender());
 769             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
 770             assertEquals(prEmail.recipients(), List.of(listAddress));
 771             assertEquals(&quot;[Integrated] RFR: My PR&quot;, prEmail.subject());
 772             assertFalse(prEmail.subject().contains(&quot;master&quot;));
 773             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 774             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
 775             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
 776             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
 777 
 778             // Now push the change to another monitored branch
 779             localRepo.push(editHash, repo.url(), &quot;other&quot;, true);
 780             TestBotRunner.runPeriodicItems(notifyBot);
 781             listServer.processIncoming();
 782 
 783             // The change should now end up as a separate notification thread
 784             conversations = mailmanList.conversations(Duration.ofDays(1));
 785             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 786             assertEquals(2, conversations.size());
 787 
 788             var pushConversation = conversations.get(1);
 789             var pushEmail = pushConversation.first();
 790             assertEquals(listAddress, pushEmail.sender());
 791             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 792             assertEquals(pushEmail.recipients(), List.of(listAddress));
 793             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 794         }
 795     }
 796 
 797     @Test
 798     void testMailinglistTag(TestInfo testInfo) throws IOException {
 799         try (var credentials = new HostCredentials(testInfo);
 800              var tempFolder = new TemporaryDirectory();
 801              var listServer = new TestMailmanServer()) {
 802             var repo = credentials.getHostedRepository();
 803             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 804             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 805             credentials.commitLock(localRepo);
 806             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 807             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 808             localRepo.pushAll(repo.url());
 809 
 810             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 811             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 812             var mailmanList = mailmanServer.getList(listAddress.address());
 813             var tagStorage = createTagStorage(repo);
 814             var branchStorage = createBranchStorage(repo);
 815             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 816             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 817 
 818             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 819             var updater = MailingListUpdater.newBuilder()
 820                                             .list(mailmanList)
 821                                             .recipient(listAddress)
 822                                             .sender(sender)
 823                                             .reportNewBranches(false)
 824                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 825                                             .build();
 826             var prOnlyUpdater = MailingListUpdater.newBuilder()
 827                                                   .list(mailmanList)
 828                                                   .recipient(listAddress)
 829                                                   .sender(sender)
 830                                                   .reportNewTags(false)
 831                                                   .reportNewBranches(false)
 832                                                   .reportNewBuilds(false)
 833                                                   .mode(MailingListUpdater.Mode.PR_ONLY)
 834                                                   .build();
 835             var notifyBot = NotifyBot.newBuilder()
 836                                      .repository(repo)
 837                                      .storagePath(storageFolder)
 838                                      .branches(Pattern.compile(&quot;master&quot;))
 839                                      .tagStorageBuilder(tagStorage)
 840                                      .branchStorageBuilder(branchStorage)
 841                                      .prIssuesStorageBuilder(prIssuesStorage)
 842                                      .updaters(List.of(updater, prOnlyUpdater))
 843                                      .build();
 844 
 845             // No mail should be sent on the first run as there is no history
 846             TestBotRunner.runPeriodicItems(notifyBot);
 847             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 848 
 849             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 850             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 851             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 852             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 853             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 854             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 855             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 856             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 857             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 858             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 859             localRepo.pushAll(repo.url());
 860 
 861             TestBotRunner.runPeriodicItems(notifyBot);
 862             listServer.processIncoming();
 863             listServer.processIncoming();
 864             listServer.processIncoming();
 865             listServer.processIncoming();
 866 
 867             var conversations = mailmanList.conversations(Duration.ofDays(1));
 868             assertEquals(4, conversations.size());
 869 
 870             for (var conversation : conversations) {
 871                 var email = conversation.first();
 872                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 873                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 874                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 875                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 876                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 877                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 878                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 879                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 880                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 881                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 882                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 883                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 884                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 885                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 886                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 887                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 888                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 889                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 890                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 891                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 892                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 893                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 894                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 895                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 896                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 897                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 898                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 899                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 900                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 901                     assertTrue(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 902                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 903                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 904                 } else {
 905                     fail(&quot;Mismatched subject: &quot; + email.subject());
 906                 }
 907                 assertTrue(email.hasHeader(&quot;extra1&quot;));
 908                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 909                 assertTrue(email.hasHeader(&quot;extra2&quot;));
 910                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 911             }
 912         }
 913     }
 914 
 915     @Test
 916     void testMailinglistPlainTags(TestInfo testInfo) throws IOException {
 917         try (var credentials = new HostCredentials(testInfo);
 918              var tempFolder = new TemporaryDirectory();
 919              var listServer = new TestMailmanServer()) {
 920             var repo = credentials.getHostedRepository();
 921             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 922             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 923             credentials.commitLock(localRepo);
 924             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 925             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 926             localRepo.pushAll(repo.url());
 927 
 928             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 929             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 930             var mailmanList = mailmanServer.getList(listAddress.address());
 931             var tagStorage = createTagStorage(repo);
 932             var branchStorage = createBranchStorage(repo);
 933             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 934             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 935 
 936             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 937             var updater = MailingListUpdater.newBuilder()
 938                                             .list(mailmanList)
 939                                             .recipient(listAddress)
 940                                             .sender(sender)
 941                                             .reportNewBranches(false)
 942                                             .reportNewBuilds(false)
 943                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 944                                             .build();
 945             var prOnlyUpdater = MailingListUpdater.newBuilder()
 946                                                   .list(mailmanList)
 947                                                   .recipient(listAddress)
 948                                                   .sender(sender)
 949                                                   .reportNewTags(false)
 950                                                   .reportNewBranches(false)
 951                                                   .reportNewBuilds(false)
 952                                                   .mode(MailingListUpdater.Mode.PR_ONLY)
 953                                                   .build();
 954             var notifyBot = NotifyBot.newBuilder()
 955                                      .repository(repo)
 956                                      .storagePath(storageFolder)
 957                                      .branches(Pattern.compile(&quot;master&quot;))
 958                                      .tagStorageBuilder(tagStorage)
 959                                      .branchStorageBuilder(branchStorage)
 960                                      .prIssuesStorageBuilder(prIssuesStorage)
 961                                      .updaters(List.of(updater, prOnlyUpdater))
 962                                      .build();
 963 
 964             // No mail should be sent on the first run as there is no history
 965             TestBotRunner.runPeriodicItems(notifyBot);
 966             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 967 
 968             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 969             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 970             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 971             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 972             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 973             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 974             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 975             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 976             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 977             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 978             localRepo.pushAll(repo.url());
 979 
 980             TestBotRunner.runPeriodicItems(notifyBot);
 981             listServer.processIncoming();
 982             listServer.processIncoming();
 983             listServer.processIncoming();
 984             listServer.processIncoming();
 985 
 986             var conversations = mailmanList.conversations(Duration.ofDays(1));
 987             assertEquals(4, conversations.size());
 988 
 989             for (var conversation : conversations) {
 990                 var email = conversation.first();
 991                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 992                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 993                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 994                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 995                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 996                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 997                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 998                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 999                 } else {
1000                     fail(&quot;Mismatched subject: &quot; + email.subject());
1001                 }
1002                 assertTrue(email.hasHeader(&quot;extra1&quot;));
1003                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
1004                 assertTrue(email.hasHeader(&quot;extra2&quot;));
1005                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1006             }
1007         }
1008     }
1009 
1010     @Test
1011     void testMailingListBranch(TestInfo testInfo) throws IOException {
1012         try (var listServer = new TestMailmanServer();
1013              var credentials = new HostCredentials(testInfo);
1014              var tempFolder = new TemporaryDirectory()) {
1015             var repo = credentials.getHostedRepository();
1016             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1017             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1018             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1019             credentials.commitLock(localRepo);
1020             localRepo.pushAll(repo.url());
1021 
1022             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1023             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1024             var mailmanList = mailmanServer.getList(listAddress.address());
1025             var tagStorage = createTagStorage(repo);
1026             var branchStorage = createBranchStorage(repo);
1027             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1028             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1029 
1030             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1031             var updater = MailingListUpdater.newBuilder()
1032                                             .list(mailmanList)
1033                                             .recipient(listAddress)
1034                                             .sender(sender)
1035                                             .reportNewTags(false)
1036                                             .reportNewBuilds(false)
1037                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1038                                             .build();
1039             var notifyBot = NotifyBot.newBuilder()
1040                                      .repository(repo)
1041                                      .storagePath(storageFolder)
1042                                      .branches(Pattern.compile(&quot;master|newbranch.&quot;))
1043                                      .tagStorageBuilder(tagStorage)
1044                                      .branchStorageBuilder(branchStorage)
1045                                      .prIssuesStorageBuilder(prIssuesStorage)
1046                                      .updaters(List.of(updater))
1047                                      .build();
1048 
1049             // No mail should be sent on the first run as there is no history
1050             TestBotRunner.runPeriodicItems(notifyBot);
1051             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1052 
1053             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
1054             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1055             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
1056             TestBotRunner.runPeriodicItems(notifyBot);
1057             listServer.processIncoming();
1058 
1059             var conversations = mailmanList.conversations(Duration.ofDays(1));
1060             var email = conversations.get(0).first();
1061             assertEquals(listAddress, email.sender());
1062             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
1063             assertEquals(email.recipients(), List.of(listAddress));
1064             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());
1065             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));
1066             assertTrue(email.hasHeader(&quot;extra1&quot;));
1067             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
1068             assertTrue(email.hasHeader(&quot;extra2&quot;));
1069             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1070 
1071             TestBotRunner.runPeriodicItems(notifyBot);
1072             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1073 
1074             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);
1075             TestBotRunner.runPeriodicItems(notifyBot);
1076             listServer.processIncoming();
1077 
1078             var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()
1079                                              .filter(c -&gt; !c.equals(conversations.get(0)))
1080                                              .findFirst().orElseThrow();
1081             email = newConversation.first();
1082             assertEquals(listAddress, email.sender());
1083             assertEquals(sender, email.author());
1084             assertEquals(email.recipients(), List.of(listAddress));
1085             assertEquals(&quot;git: test: created branch newbranch2 based on the branch newbranch1 containing 0 unique commits&quot;, email.subject());
1086             assertEquals(&quot;The new branch newbranch2 is currently identical to the newbranch1 branch.&quot;, email.body());
1087         }
1088     }
1089 
1090     @Test
1091     void testMailingListBranchPrefix(TestInfo testInfo) throws IOException {
1092         try (var listServer = new TestMailmanServer();
1093              var credentials = new HostCredentials(testInfo);
1094              var tempFolder = new TemporaryDirectory()) {
1095             var repo = credentials.getHostedRepository();
1096             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1097             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1098             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1099             credentials.commitLock(localRepo);
1100             localRepo.pushAll(repo.url());
1101 
1102             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1103             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1104             var mailmanList = mailmanServer.getList(listAddress.address());
1105             var tagStorage = createTagStorage(repo);
1106             var branchStorage = createBranchStorage(repo);
1107             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1108             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1109 
1110             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1111             var updater = MailingListUpdater.newBuilder()
1112                                             .list(mailmanList)
1113                                             .recipient(listAddress)
1114                                             .sender(sender)
1115                                             .reportNewTags(false)
1116                                             .reportNewBranches(false)
1117                                             .reportNewBuilds(false)
1118                                             .mode(MailingListUpdater.Mode.PR)
1119                                             .repoInSubject(true)
1120                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
1121                                             .build();
1122             var notifyBot = NotifyBot.newBuilder()
1123                                      .repository(repo)
1124                                      .storagePath(storageFolder)
1125                                      .branches(Pattern.compile(&quot;master&quot;))
1126                                      .tagStorageBuilder(tagStorage)
1127                                      .branchStorageBuilder(branchStorage)
1128                                      .prIssuesStorageBuilder(prIssuesStorage)
1129                                      .updaters(List.of(updater))
1130                                      .build();
1131 
1132             // No mail should be sent on the first run as there is no history
1133             TestBotRunner.runPeriodicItems(notifyBot);
1134             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1135 
1136             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1137             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
1138             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
1139 
1140             // PR hasn&#39;t been integrated yet, so there should be no mail
1141             TestBotRunner.runPeriodicItems(notifyBot);
1142             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1143 
1144             // Simulate an RFR email
1145             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
1146                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
1147                            .recipient(listAddress)
1148                            .build();
1149             mailmanList.post(rfr);
1150             listServer.processIncoming();
1151 
1152             // And an integration
1153             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
1154             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1155 
1156             TestBotRunner.runPeriodicItems(notifyBot);
1157             listServer.processIncoming();
1158 
1159             var conversations = mailmanList.conversations(Duration.ofDays(1));
1160             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
1161             assertEquals(1, conversations.size());
1162 
1163             var prConversation = conversations.get(0);
1164 
1165             var prEmail = prConversation.replies(prConversation.first()).get(0);
1166             assertEquals(listAddress, prEmail.sender());
1167             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
1168             assertEquals(prEmail.recipients(), List.of(listAddress));
1169             assertEquals(&quot;[&quot; + repo.name() + &quot;:master] [Integrated] RFR: My PR&quot;, prEmail.subject());
1170             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
1171             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
1172             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
1173             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
1174         }
1175     }
1176 
1177     @Test
1178     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
1179         try (var listServer = new TestMailmanServer();
1180              var credentials = new HostCredentials(testInfo);
1181              var tempFolder = new TemporaryDirectory()) {
1182             var repo = credentials.getHostedRepository();
1183             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1184             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1185             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1186             credentials.commitLock(localRepo);
1187             localRepo.pushAll(repo.url());
1188 
1189             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1190             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1191             var mailmanList = mailmanServer.getList(listAddress.address());
1192             var tagStorage = createTagStorage(repo);
1193             var branchStorage = createBranchStorage(repo);
1194             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1195             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1196 
1197             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1198             var updater = MailingListUpdater.newBuilder()
1199                                             .list(mailmanList)
1200                                             .recipient(listAddress)
1201                                             .sender(sender)
1202                                             .reportNewTags(false)
1203                                             .reportNewBranches(false)
1204                                             .reportNewBuilds(false)
1205                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1206                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
1207                                             .build();
1208             var notifyBot = NotifyBot.newBuilder()
1209                                      .repository(repo)
1210                                      .storagePath(storageFolder)
1211                                      .branches(Pattern.compile(&quot;master&quot;))
1212                                      .tagStorageBuilder(tagStorage)
1213                                      .branchStorageBuilder(branchStorage)
1214                                      .prIssuesStorageBuilder(prIssuesStorage)
1215                                      .updaters(List.of(updater))
1216                                      .build();
1217 
1218             // No mail should be sent on the first run as there is no history
1219             TestBotRunner.runPeriodicItems(notifyBot);
1220             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1221 
1222             // Save history state
1223             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);
1224 
1225             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1226             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1227             TestBotRunner.runPeriodicItems(notifyBot);
1228             listServer.processIncoming();
1229 
1230             var conversations = mailmanList.conversations(Duration.ofDays(1));
1231             assertEquals(1, conversations.size());
1232 
1233             // Reset the history
1234             localRepo.push(historyHash, repo.url(), &quot;history&quot;, true);
1235             TestBotRunner.runPeriodicItems(notifyBot);
1236             listServer.processIncoming();
1237 
1238             // There should now be a duplicate mail
1239             conversations = mailmanList.conversations(Duration.ofDays(1));
1240             assertEquals(2, conversations.size());
1241         }
1242     }
1243 
1244     @Test
1245     void testIssue(TestInfo testInfo) throws IOException {
1246         try (var credentials = new HostCredentials(testInfo);
1247              var tempFolder = new TemporaryDirectory()) {
1248             var repo = credentials.getHostedRepository();
1249             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1250             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1251             credentials.commitLock(localRepo);
1252             localRepo.pushAll(repo.url());
1253 
1254             var tagStorage = createTagStorage(repo);
1255             var branchStorage = createBranchStorage(repo);
1256             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1257             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1258 
1259             var issueProject = credentials.getIssueProject();
1260             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1261             var updater = IssueUpdater.newBuilder()
1262                                       .issueProject(issueProject)
1263                                       .reviewLink(false)
1264                                       .commitIcon(commitIcon)
1265                                       .setFixVersion(true)
1266                                       .build();
1267             var notifyBot = NotifyBot.newBuilder()
1268                                      .repository(repo)
1269                                      .storagePath(storageFolder)
1270                                      .branches(Pattern.compile(&quot;master&quot;))
1271                                      .tagStorageBuilder(tagStorage)
1272                                      .branchStorageBuilder(branchStorage)
1273                                      .prIssuesStorageBuilder(prIssuesStorage)
1274                                      .updaters(List.of(updater))
1275                                      .build();
1276 
1277             // Initialize history
1278             TestBotRunner.runPeriodicItems(notifyBot);
1279 
1280             // Create an issue and commit a fix
1281             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1282             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1283             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1284             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1285             TestBotRunner.runPeriodicItems(notifyBot);
1286 
1287             // The changeset should be reflected in a comment
1288             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1289 
1290             var comments = updatedIssue.comments();
1291             assertEquals(1, comments.size());
1292             var comment = comments.get(0);
1293             assertTrue(comment.body().contains(editHash.abbreviate()));
1294 
1295             // And in a link
1296             var links = updatedIssue.links();
1297             assertEquals(1, links.size());
1298             var link = links.get(0);
1299             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1300             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1301             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1302 
1303             // As well as a fixVersion
1304             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1305 
1306             // The issue should be assigned and resolved
1307             assertEquals(RESOLVED, updatedIssue.state());
1308             assertEquals(List.of(issueProject.issueTracker().currentUser()), updatedIssue.assignees());
1309         }
1310     }
1311 
1312     @Test
1313     void testIssueNoVersion(TestInfo testInfo) throws IOException {
1314         try (var credentials = new HostCredentials(testInfo);
1315              var tempFolder = new TemporaryDirectory()) {
1316             var repo = credentials.getHostedRepository();
1317             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1318             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1319             credentials.commitLock(localRepo);
1320             localRepo.pushAll(repo.url());
1321 
1322             var tagStorage = createTagStorage(repo);
1323             var branchStorage = createBranchStorage(repo);
1324             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1325             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1326 
1327             var issueProject = credentials.getIssueProject();
1328             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1329             var updater = IssueUpdater.newBuilder()
1330                                       .issueProject(issueProject)
1331                                       .reviewLink(false)
1332                                       .commitIcon(commitIcon)
1333                                       .setFixVersion(true)
1334                                       .build();
1335             var notifyBot = NotifyBot.newBuilder()
1336                                      .repository(repo)
1337                                      .storagePath(storageFolder)
1338                                      .branches(Pattern.compile(&quot;master&quot;))
1339                                      .tagStorageBuilder(tagStorage)
1340                                      .branchStorageBuilder(branchStorage)
1341                                      .prIssuesStorageBuilder(prIssuesStorage)
1342                                      .updaters(List.of(updater))
1343                                      .build();
1344 
1345             // Initialize history
1346             TestBotRunner.runPeriodicItems(notifyBot);
1347 
1348             // Create an issue and commit a fix
1349             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1350             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1351             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1352             TestBotRunner.runPeriodicItems(notifyBot);
1353 
1354             // The changeset should be reflected in a comment
1355             var comments = issue.comments();
1356             assertEquals(1, comments.size());
1357             var comment = comments.get(0);
1358             assertTrue(comment.body().contains(editHash.abbreviate()));
1359 
1360             // But not in the fixVersion
1361             assertEquals(Set.of(), fixVersions(issue));
1362         }
1363     }
1364 
1365     @Test
1366     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
1367         try (var credentials = new HostCredentials(testInfo);
1368              var tempFolder = new TemporaryDirectory()) {
1369             var repo = credentials.getHostedRepository();
1370             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1371             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1372             credentials.commitLock(localRepo);
1373             localRepo.pushAll(repo.url());
1374 
1375             var tagStorage = createTagStorage(repo);
1376             var branchStorage = createBranchStorage(repo);
1377             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1378             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1379 
1380             var issueProject = credentials.getIssueProject();
1381             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1382             var updater = IssueUpdater.newBuilder()
1383                                       .issueProject(issueProject)
1384                                       .reviewLink(false)
1385                                       .commitLink(false)
1386                                       .commitIcon(commitIcon)
1387                                       .setFixVersion(true)
1388                                       .fixVersions(Map.of(&quot;master&quot;, &quot;2.0&quot;))
1389                                       .build();
1390             var notifyBot = NotifyBot.newBuilder()
1391                                      .repository(repo)
1392                                      .storagePath(storageFolder)
1393                                      .branches(Pattern.compile(&quot;master&quot;))
1394                                      .tagStorageBuilder(tagStorage)
1395                                      .branchStorageBuilder(branchStorage)
1396                                      .prIssuesStorageBuilder(prIssuesStorage)
1397                                      .updaters(List.of(updater))
1398                                      .build();
1399 
1400             // Initialize history
1401             TestBotRunner.runPeriodicItems(notifyBot);
1402 
1403             // Create an issue and commit a fix
1404             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1405             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1406             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1407             TestBotRunner.runPeriodicItems(notifyBot);
1408 
1409             // The changeset should not reflected in a comment
1410             var comments = issue.comments();
1411             assertEquals(1, comments.size());
1412             var comment = comments.get(0);
1413             assertTrue(comment.body().contains(editHash.abbreviate()));
1414 
1415             // As well as a fixVersion - but not the one from the repo
1416             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
1417 
1418             // And no commit link
1419             var links = issue.links();
1420             assertEquals(0, links.size());
1421         }
1422     }
1423 
1424     @Test
1425     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1426         try (var credentials = new HostCredentials(testInfo);
1427              var tempFolder = new TemporaryDirectory()) {
1428             var repo = credentials.getHostedRepository();
1429             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1430             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1431             credentials.commitLock(localRepo);
1432             localRepo.pushAll(repo.url());
1433 
1434             var tagStorage = createTagStorage(repo);
1435             var branchStorage = createBranchStorage(repo);
1436             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1437             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1438 
1439             var issueProject = credentials.getIssueProject();
1440             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1441             var updater = IssueUpdater.newBuilder()
1442                                       .issueProject(issueProject)
1443                                       .reviewLink(false)
1444                                       .commitIcon(commitIcon)
1445                                       .setFixVersion(true)
1446                                       .build();
1447             var notifyBot = NotifyBot.newBuilder()
1448                                      .repository(repo)
1449                                      .storagePath(storageFolder)
1450                                      .branches(Pattern.compile(&quot;master&quot;))
1451                                      .tagStorageBuilder(tagStorage)
1452                                      .branchStorageBuilder(branchStorage)
1453                                      .prIssuesStorageBuilder(prIssuesStorage)
1454                                      .updaters(List.of(updater))
1455                                      .build();
1456 
1457             // Initialize history
1458             TestBotRunner.runPeriodicItems(notifyBot);
1459 
1460             // Save the state
1461             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1462 
1463             // Create an issue and commit a fix
1464             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1465             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1466             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1467             TestBotRunner.runPeriodicItems(notifyBot);
1468 
1469             // The changeset should be reflected in a comment
1470             var comments = issue.comments();
1471             assertEquals(1, comments.size());
1472             var comment = comments.get(0);
1473             assertTrue(comment.body().contains(editHash.abbreviate()));
1474 
1475             // And in a link
1476             var links = issue.links();
1477             assertEquals(1, links.size());
1478             var link = links.get(0);
1479             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1480             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1481             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1482 
1483             // As well as a fixVersion
1484             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));
1485 
1486             // Wipe the history
1487             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
1488 
1489             // Run it again
1490             TestBotRunner.runPeriodicItems(notifyBot);
1491 
1492             // There should be no new comments, links or fixVersions
1493             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1494             assertEquals(1, updatedIssue.comments().size());
1495             assertEquals(1, updatedIssue.links().size());
1496             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1497         }
1498     }
1499 
1500     @Test
1501     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1502         try (var credentials = new HostCredentials(testInfo);
1503              var tempFolder = new TemporaryDirectory()) {
1504             var repo = credentials.getHostedRepository();
1505             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1506             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1507             credentials.commitLock(localRepo);
1508             localRepo.pushAll(repo.url());
1509 
1510             var tagStorage = createTagStorage(repo);
1511             var branchStorage = createBranchStorage(repo);
1512             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1513             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1514 
1515             var issueProject = credentials.getIssueProject();
1516             var updater = IssueUpdater.newBuilder()
1517                                       .issueProject(issueProject)
1518                                       .reviewLink(false)
1519                                       .commitLink(false)
1520                                       .setFixVersion(true)
1521                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))
1522                                       .build();
1523             var notifyBot = NotifyBot.newBuilder()
1524                                      .repository(repo)
1525                                      .storagePath(storageFolder)
1526                                      .branches(Pattern.compile(&quot;master&quot;))
1527                                      .tagStorageBuilder(tagStorage)
1528                                      .branchStorageBuilder(branchStorage)
1529                                      .prIssuesStorageBuilder(prIssuesStorage)
1530                                      .updaters(List.of(updater))
1531                                      .build();
1532 
1533             // Initialize history
1534             TestBotRunner.runPeriodicItems(notifyBot);
1535 
1536             // Create an issue and commit a fix
1537             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1538             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1539 
1540             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1541             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1542             TestBotRunner.runPeriodicItems(notifyBot);
1543 
1544             // The fixVersion should have been updated
1545             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1546         }
1547     }
1548 
1549     @Test
1550     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1551         try (var credentials = new HostCredentials(testInfo);
1552              var tempFolder = new TemporaryDirectory()) {
1553             var repo = credentials.getHostedRepository();
1554             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1555             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1556             credentials.commitLock(localRepo);
1557             localRepo.pushAll(repo.url());
1558 
1559             var tagStorage = createTagStorage(repo);
1560             var branchStorage = createBranchStorage(repo);
1561             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1562             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1563 
1564             var issueProject = credentials.getIssueProject();
1565             var updater = IssueUpdater.newBuilder()
1566                                       .issueProject(issueProject)
1567                                       .reviewLink(false)
1568                                       .commitLink(false)
1569                                       .setFixVersion(true)
1570                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))
1571                                       .build();
1572             var notifyBot = NotifyBot.newBuilder()
1573                                      .repository(repo)
1574                                      .storagePath(storageFolder)
1575                                      .branches(Pattern.compile(&quot;master&quot;))
1576                                      .tagStorageBuilder(tagStorage)
1577                                      .branchStorageBuilder(branchStorage)
1578                                      .prIssuesStorageBuilder(prIssuesStorage)
1579                                      .updaters(List.of(updater))
1580                                      .build();
1581 
1582             // Initialize history
1583             TestBotRunner.runPeriodicItems(notifyBot);
1584 
1585             // Create an issue and commit a fix
1586             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1587             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1588 
1589             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1590             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1591             TestBotRunner.runPeriodicItems(notifyBot);
1592 
1593             // The fixVersion should have been updated
1594             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1595         }
1596     }
1597 
1598     @Test
1599     void testIssueBackport(TestInfo testInfo) throws IOException {
1600         try (var credentials = new HostCredentials(testInfo);
1601              var tempFolder = new TemporaryDirectory()) {
1602             var repo = credentials.getHostedRepository();
1603             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1604             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1605             credentials.commitLock(localRepo);
1606             localRepo.pushAll(repo.url());
1607 
1608             var tagStorage = createTagStorage(repo);
1609             var branchStorage = createBranchStorage(repo);
1610             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1611             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1612 
1613             var issueProject = credentials.getIssueProject();
1614             var updater = IssueUpdater.newBuilder()
1615                                       .issueProject(issueProject)
1616                                       .reviewLink(false)
1617                                       .commitLink(false)
1618                                       .setFixVersion(true)
1619                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12.0.2&quot;))
1620                                       .build();
1621             var notifyBot = NotifyBot.newBuilder()
1622                                      .repository(repo)
1623                                      .storagePath(storageFolder)
1624                                      .branches(Pattern.compile(&quot;master&quot;))
1625                                      .tagStorageBuilder(tagStorage)
1626                                      .branchStorageBuilder(branchStorage)
1627                                      .prIssuesStorageBuilder(prIssuesStorage)
1628                                      .updaters(List.of(updater))
1629                                      .build();
1630 
1631             // Initialize history
1632             TestBotRunner.runPeriodicItems(notifyBot);
1633 
1634             // Create an issue and commit a fix
1635             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),
1636                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),
1637                                                         &quot;customfield_10008&quot;, JSON.object()
1638                                                                                  .put(&quot;id&quot;, 244)
1639                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),
1640                                                         &quot;customfield_10005&quot;, JSON.array()
1641                                                                                  .add(JSON.object()
1642                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)
1643                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))
1644                                                                                  .add(JSON.object()
1645                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)
1646                                                                                           .put(&quot;value&quot;, &quot;other&quot;))
1647                                                  ));
1648             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
1649             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
1650 
1651             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1652             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1653             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1654             TestBotRunner.runPeriodicItems(notifyBot);
1655 
1656             // The fixVersion should not have been updated
1657             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1658             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));
1659             assertEquals(OPEN, updatedIssue.state());
1660             assertEquals(List.of(), updatedIssue.assignees());
1661 
1662             // There should be a link
1663             var links = updatedIssue.links();
1664             assertEquals(1, links.size());
1665             var link = links.get(0);
1666             var backport = link.issue().orElseThrow();
1667 
1668             // The backport issue should have a correct fixVersion and assignee
1669             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));
1670             assertEquals(RESOLVED, backport.state());
1671             assertEquals(List.of(issueProject.issueTracker().currentUser()), backport.assignees());
1672 
1673             // Custom properties should also propagate
1674             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());
1675             assertEquals(244, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;id&quot;).asInt());
1676             assertEquals(&quot;java.io&quot;, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;name&quot;).asString());
1677             assertEquals(2, backport.properties().get(&quot;customfield_10005&quot;).asArray().size());
1678         }
1679     }
1680 
1681     @Test
1682     void testPullRequest(TestInfo testInfo) throws IOException {
1683         try (var credentials = new HostCredentials(testInfo);
1684              var tempFolder = new TemporaryDirectory()) {
1685             var repo = credentials.getHostedRepository();
1686             var reviewer = credentials.getHostedRepository();
1687             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1688             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1689             credentials.commitLock(localRepo);
1690             localRepo.pushAll(repo.url());
1691 
1692             var tagStorage = createTagStorage(repo);
1693             var branchStorage = createBranchStorage(repo);
1694             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1695             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1696 
1697             var issueProject = credentials.getIssueProject();
1698             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1699             var updater = IssueUpdater.newBuilder()
1700                                       .issueProject(issueProject)
1701                                       .reviewIcon(reviewIcon)
1702                                       .commitLink(false)
1703                                       .build();
1704             var notifyBot = NotifyBot.newBuilder()
1705                                      .repository(repo)
1706                                      .storagePath(storageFolder)
1707                                      .branches(Pattern.compile(&quot;master&quot;))
1708                                      .tagStorageBuilder(tagStorage)
1709                                      .branchStorageBuilder(branchStorage)
1710                                      .prIssuesStorageBuilder(prIssuesStorage)
1711                                      .prUpdaters(List.of(updater))
1712                                      .readyLabels(Set.of(&quot;rfr&quot;))
1713                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
1714                                      .build();
1715 
1716             // Initialize history
1717             TestBotRunner.runPeriodicItems(notifyBot);
1718 
1719             // Create an issue and a pull request to fix it
1720             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1721             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1722             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1723             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1724             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1725             TestBotRunner.runPeriodicItems(notifyBot);
1726 
1727             // The issue should not yet contain a link to the PR
1728             var links = issue.links();
1729             assertEquals(0, links.size());
1730 
1731             // Just a label isn&#39;t enough
1732             pr.addLabel(&quot;rfr&quot;);
1733             TestBotRunner.runPeriodicItems(notifyBot);
1734             links = issue.links();
1735             assertEquals(0, links.size());
1736 
1737             // Neither is just a comment
1738             pr.removeLabel(&quot;rfr&quot;);
1739             var reviewPr = reviewer.pullRequest(pr.id());
1740             reviewPr.addComment(&quot;This is now ready&quot;);
1741             TestBotRunner.runPeriodicItems(notifyBot);
1742             links = issue.links();
1743             assertEquals(0, links.size());
1744 
1745             // Both are needed
1746             pr.addLabel(&quot;rfr&quot;);
1747             TestBotRunner.runPeriodicItems(notifyBot);
1748 
1749             // The issue should now contain a link to the PR
1750             links = issue.links();
1751             assertEquals(1, links.size());
1752             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1753             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1754 
1755             // Add another issue
1756             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1757             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n * [&quot; + issue2.id() +
1758                                &quot;](http://www.test2.test/): The second issue&quot;);
1759             TestBotRunner.runPeriodicItems(notifyBot);
1760 
1761             // Both issues should contain a link to the PR
1762             var links1 = issue.links();
1763             assertEquals(1, links1.size());
1764             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());
1765             var links2 = issue2.links();
1766             assertEquals(1, links2.size());
1767             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1768 
1769             // Drop the first one
1770             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
1771             TestBotRunner.runPeriodicItems(notifyBot);
1772 
1773             // Only the second issue should now contain a link to the PR
1774             links1 = issue.links();
1775             assertEquals(0, links1.size());
1776             links2 = issue2.links();
1777             assertEquals(1, links2.size());
1778             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1779         }
1780     }
1781 
1782     @Test
1783     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
1784         try (var credentials = new HostCredentials(testInfo);
1785              var tempFolder = new TemporaryDirectory()) {
1786             var repo = credentials.getHostedRepository();
1787             var reviewer = credentials.getHostedRepository();
1788             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1789             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1790             credentials.commitLock(localRepo);
1791             localRepo.pushAll(repo.url());
1792 
1793             var tagStorage = createTagStorage(repo);
1794             var branchStorage = createBranchStorage(repo);
1795             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1796             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1797 
1798             var issueProject = credentials.getIssueProject();
1799             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1800             var updater = IssueUpdater.newBuilder()
1801                                       .issueProject(issueProject)
1802                                       .reviewLink(false)
1803                                       .reviewIcon(reviewIcon)
1804                                       .commitLink(false)
1805                                       .build();
1806             var notifyBot = NotifyBot.newBuilder()
1807                                      .repository(repo)
1808                                      .storagePath(storageFolder)
1809                                      .branches(Pattern.compile(&quot;master&quot;))
1810                                      .tagStorageBuilder(tagStorage)
1811                                      .branchStorageBuilder(branchStorage)
1812                                      .prIssuesStorageBuilder(prIssuesStorage)
1813                                      .prUpdaters(List.of(updater)).readyLabels(Set.of(&quot;rfr&quot;))
1814                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
1815                                      .build();
1816             // Initialize history
1817             TestBotRunner.runPeriodicItems(notifyBot);
1818 
1819             // Create an issue and a pull request to fix it
1820             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1821             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1822             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1823             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1824             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1825             TestBotRunner.runPeriodicItems(notifyBot);
1826 
1827             // Add required label
1828             pr.addLabel(&quot;rfr&quot;);
1829             TestBotRunner.runPeriodicItems(notifyBot);
1830 
1831             // And the required comment
1832             var reviewPr = reviewer.pullRequest(pr.id());
1833             reviewPr.addComment(&quot;This is now ready&quot;);
1834             TestBotRunner.runPeriodicItems(notifyBot);
1835 
1836             // The issue should still not contain a link to the PR
1837             var links = issue.links();
1838             assertEquals(0, links.size());
1839         }
1840     }
1841 
1842     @Test
1843     void testPullRequestPROnly(TestInfo testInfo) throws IOException {
1844         try (var credentials = new HostCredentials(testInfo);
1845              var tempFolder = new TemporaryDirectory()) {
1846             var repo = credentials.getHostedRepository();
1847             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1848             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1849             credentials.commitLock(localRepo);
1850             localRepo.pushAll(repo.url());
1851 
1852             var tagStorage = createTagStorage(repo);
1853             var branchStorage = createBranchStorage(repo);
1854             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1855             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1856 
1857             var issueProject = credentials.getIssueProject();
1858             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1859             var updater = IssueUpdater.newBuilder()
1860                                       .issueProject(issueProject)
1861                                       .reviewIcon(reviewIcon)
1862                                       .commitLink(false)
1863                                       .prOnly(true)
1864                                       .build();
1865             var notifyBot = NotifyBot.newBuilder()
1866                                      .repository(repo)
1867                                      .storagePath(storageFolder)
1868                                      .branches(Pattern.compile(&quot;.*&quot;))
1869                                      .tagStorageBuilder(tagStorage)
1870                                      .branchStorageBuilder(branchStorage)
1871                                      .prIssuesStorageBuilder(prIssuesStorage)
1872                                      .updaters(List.of(updater))
1873                                      .prUpdaters(List.of(updater))
1874                                      .build();
1875 
1876             // Initialize history
1877             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
1878             TestBotRunner.runPeriodicItems(notifyBot);
1879 
1880             // Create an issue and a pull request to fix it
1881             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1882             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1883             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1884             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
1885             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1886             TestBotRunner.runPeriodicItems(notifyBot);
1887 
1888             // The issue should now contain a link to the PR
1889             var links = issue.links();
1890             assertEquals(1, links.size());
1891             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1892             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1893 
1894             // Simulate integration
1895             localRepo.push(editHash, repo.url(), &quot;other&quot;);
1896             TestBotRunner.runPeriodicItems(notifyBot);
1897 
1898             // The changeset should be reflected in a comment
1899             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1900 
1901             var comments = updatedIssue.comments();
1902             assertEquals(1, comments.size());
1903             var comment = comments.get(0);
1904             assertTrue(comment.body().contains(editHash.abbreviate()));
1905 
1906             // Now simulate a merge to another branch
1907             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1908             TestBotRunner.runPeriodicItems(notifyBot);
1909 
1910             // No additional comment should have been made
1911             updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1912             comments = updatedIssue.comments();
1913             assertEquals(1, comments.size());
1914         }
1915     }
1916 
1917     private static class TestRepositoryUpdateConsumer implements RepositoryUpdateConsumer {
1918         private final String name;
1919         private final boolean idempotent;
1920         private int updateCount = 0;
1921         private boolean shouldFail = false;
1922 
1923         TestRepositoryUpdateConsumer(String name, boolean idempotent) {
1924             this.name = name;
1925             this.idempotent = idempotent;
1926         }
1927 
1928         @Override
1929         public void handleCommits(HostedRepository repository, Repository localRepository, List&lt;Commit&gt; commits,
<a name="3" id="anc3"></a><span class="line-modified">1930                                   Branch branch) throws NonRetriableException {</span>
1931             updateCount++;
1932             if (shouldFail) {
<a name="4" id="anc4"></a><span class="line-modified">1933                 if (idempotent) {</span>
<span class="line-added">1934                     throw new RuntimeException(&quot;induced failure&quot;);</span>
<span class="line-added">1935                 } else {</span>
<span class="line-added">1936                     throw new NonRetriableException(new RuntimeException(&quot;unretriable failure&quot;));</span>
<span class="line-added">1937                 }</span>
1938             }
1939         }
1940 
1941         @Override
1942         public void handleOpenJDKTagCommits(HostedRepository repository, Repository localRepository,
1943          List&lt;Commit&gt; commits, OpenJDKTag tag, Tag.Annotated annotated) {
1944             throw new RuntimeException(&quot;unexpected&quot;);
1945         }
1946 
1947         @Override
1948         public void handleTagCommit(HostedRepository repository, Repository localRepository, Commit commit, Tag tag,
1949          Tag.Annotated annotation) {
1950             throw new RuntimeException(&quot;unexpected&quot;);
1951         }
1952 
1953         @Override
1954         public void handleNewBranch(HostedRepository repository, Repository localRepository, List&lt;Commit&gt; commits,
1955          Branch parent, Branch branch) {
1956             throw new RuntimeException(&quot;unexpected&quot;);
1957         }
1958 
<a name="5" id="anc5"></a>




1959         @Override
1960         public String name() {
1961             return name;
1962         }
1963     }
1964 
1965     @Test
1966     void testIdempotenceMix(TestInfo testInfo) throws IOException {
1967         try (var credentials = new HostCredentials(testInfo);
1968              var tempFolder = new TemporaryDirectory()) {
1969             var repo = credentials.getHostedRepository();
1970             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1971             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1972             credentials.commitLock(localRepo);
1973             localRepo.pushAll(repo.url());
1974 
1975             var tagStorage = createTagStorage(repo);
1976             var branchStorage = createBranchStorage(repo);
1977             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1978             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1979 
1980             var idempotent = new TestRepositoryUpdateConsumer(&quot;i&quot;, true);
1981             var nonIdempotent = new TestRepositoryUpdateConsumer(&quot;ni&quot;, false);
1982             var notifyBot = NotifyBot.newBuilder()
1983                                      .repository(repo)
1984                                      .storagePath(storageFolder)
1985                                      .branches(Pattern.compile(&quot;master&quot;))
1986                                      .tagStorageBuilder(tagStorage)
1987                                      .branchStorageBuilder(branchStorage)
1988                                      .prIssuesStorageBuilder(prIssuesStorage)
1989                                      .updaters(List.of(idempotent, nonIdempotent))
1990                                      .build();
1991 
1992             // Initialize history
1993             TestBotRunner.runPeriodicItems(notifyBot);
1994 
1995             // Create an issue and commit a fix
1996             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix stuff&quot;);
1997             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1998             TestBotRunner.runPeriodicItems(notifyBot);
1999 
2000             // Both updaters should have run
2001             assertEquals(1, idempotent.updateCount);
2002             assertEquals(1, nonIdempotent.updateCount);
2003 
2004             var nextEditHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;Fix more stuff&quot;);
2005             localRepo.push(nextEditHash, repo.url(), &quot;master&quot;);
2006 
2007             idempotent.shouldFail = true;
2008             nonIdempotent.shouldFail = true;
2009             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(notifyBot));
2010 
2011             // Both updaters should have run again
2012             assertEquals(2, idempotent.updateCount);
2013             assertEquals(2, nonIdempotent.updateCount);
2014 
2015             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(notifyBot));
2016 
2017             // But now only the idempotent one should have been retried
2018             assertEquals(3, idempotent.updateCount);
2019             assertEquals(2, nonIdempotent.updateCount);
2020         }
2021     }
2022 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>