<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ArchiveWorkItem.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.udiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -12,17 +12,19 @@</span>
  import java.security.*;
  import java.time.*;
  import java.util.*;
  import java.util.function.Consumer;
  import java.util.logging.Logger;
<span class="udiff-line-added">+ import java.util.regex.*;</span>
  import java.util.stream.*;
  
  class ReviewArchive {
      private final PullRequest pr;
      private final EmailAddress sender;
  
      private final List&lt;Comment&gt; comments = new ArrayList&lt;&gt;();
<span class="udiff-line-added">+     private final List&lt;Comment&gt; ignoredComments = new ArrayList&lt;&gt;();</span>
      private final List&lt;Review&gt; reviews = new ArrayList&lt;&gt;();
      private final List&lt;ReviewComment&gt; reviewComments = new ArrayList&lt;&gt;();
  
      private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge&quot;);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -33,10 +35,14 @@</span>
  
      void addComment(Comment comment) {
          comments.add(comment);
      }
  
<span class="udiff-line-added">+     void addIgnored(Comment comment) {</span>
<span class="udiff-line-added">+         ignoredComments.add(comment);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      void addReview(Review review) {
          reviews.add(review);
      }
  
      void addReviewComment(ReviewComment reviewComment) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -50,10 +56,22 @@</span>
                          .filter(item -&gt; item.parent().isPresent())
                          .filter(item -&gt; item.parent().get().equals(parent))
                          .findAny();
      }
  
<span class="udiff-line-added">+     private final static Pattern pushedPattern = Pattern.compile(&quot;Pushed as commit ([a-f0-9]{40})\\.&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private Optional&lt;Hash&gt; findIntegratedHash() {</span>
<span class="udiff-line-added">+         return ignoredComments.stream()</span>
<span class="udiff-line-added">+                               .map(Comment::body)</span>
<span class="udiff-line-added">+                               .map(pushedPattern::matcher)</span>
<span class="udiff-line-added">+                               .filter(Matcher::find)</span>
<span class="udiff-line-added">+                               .map(m -&gt; m.group(1))</span>
<span class="udiff-line-added">+                               .map(Hash::new)</span>
<span class="udiff-line-added">+                               .findAny();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private List&lt;ArchiveItem&gt; generateArchiveItems(List&lt;Email&gt; sentEmails, Repository localRepo, URI issueTracker, String issuePrefix, HostUserToEmailAuthor hostUserToEmailAuthor, HostUserToUserName hostUserToUserName, HostUserToRole hostUserToRole, WebrevStorage.WebrevGenerator webrevGenerator, WebrevNotification webrevNotification, String subjectPrefix) throws IOException {
          var generated = new ArrayList&lt;ArchiveItem&gt;();
          Hash lastBase = null;
          Hash lastHead = null;
          int revisionIndex = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -120,14 +138,29 @@</span>
              var reply = ArchiveItem.from(pr, reviewComment, hostUserToEmailAuthor, parent);
              generated.add(reply);
          }
  
          // Post a closed notice for regular RFR threads that weren&#39;t integrated
<span class="udiff-line-modified-removed">-         if ((pr.state() != Issue.State.OPEN) &amp;&amp; threadPrefix.equals(&quot;RFR&quot;) &amp;&amp; !pr.labels().contains(&quot;integrated&quot;)) {</span>
<span class="udiff-line-modified-added">+         if (pr.state() != Issue.State.OPEN) {</span>
              var parent = generated.get(0);
<span class="udiff-line-modified-removed">-             var reply = ArchiveItem.closedNotice(pr, hostUserToEmailAuthor, parent, subjectPrefix, threadPrefix);</span>
<span class="udiff-line-modified-removed">-             generated.add(reply);</span>
<span class="udiff-line-modified-added">+             if (pr.labels().contains(&quot;integrated&quot;)) {</span>
<span class="udiff-line-modified-added">+                 var hash = findIntegratedHash();</span>
<span class="udiff-line-added">+                 if (hash.isPresent()) {</span>
<span class="udiff-line-added">+                     var commit = localRepo.lookup(hash.get());</span>
<span class="udiff-line-added">+                     var reply = ArchiveItem.integratedNotice(pr, localRepo, commit.orElseThrow(), hostUserToEmailAuthor, parent, subjectPrefix, threadPrefix);</span>
<span class="udiff-line-added">+                     generated.add(reply);</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     throw new RuntimeException(&quot;PR &quot; + pr.webUrl() + &quot; has integrated label but no integration comment&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else if (localRepo.isAncestor(pr.headHash(), pr.targetHash())) {</span>
<span class="udiff-line-added">+                 var commit = localRepo.lookup(pr.headHash());</span>
<span class="udiff-line-added">+                 var reply = ArchiveItem.integratedNotice(pr, localRepo, commit.orElseThrow(), hostUserToEmailAuthor, parent, subjectPrefix, threadPrefix);</span>
<span class="udiff-line-added">+                 generated.add(reply);</span>
<span class="udiff-line-added">+             } else if (threadPrefix.equals(&quot;RFR&quot;)) {</span>
<span class="udiff-line-added">+                 var reply = ArchiveItem.closedNotice(pr, hostUserToEmailAuthor, parent, subjectPrefix, threadPrefix);</span>
<span class="udiff-line-added">+                 generated.add(reply);</span>
<span class="udiff-line-added">+             }</span>
          }
  
          return generated;
      }
  
</pre>
<center><a href="ArchiveWorkItem.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>