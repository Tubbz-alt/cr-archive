<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/NotifyBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 491 
 492             conversations = mailmanList.conversations(Duration.ofDays(1));
 493             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 494             email = conversations.get(0).first();
 495             assertEquals(author, email.author());
 496             assertEquals(listAddress, email.sender());
 497             assertEquals(email.recipients(), List.of(listAddress));
 498             assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));
 499             assertFalse(email.subject().contains(&quot;master&quot;));
 500             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));
 501             assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 502             assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 503             assertFalse(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 504             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
 505             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
 506             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
 507             assertEquals(editHash3.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
 508         }
 509     }
 510 
<span class="line-removed"> 511     @Test</span>
<span class="line-removed"> 512     void testMailingListPROnly(TestInfo testInfo) throws IOException {</span>
<span class="line-removed"> 513         try (var listServer = new TestMailmanServer();</span>
<span class="line-removed"> 514              var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed"> 515              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed"> 516             var repo = credentials.getHostedRepository();</span>
<span class="line-removed"> 517             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed"> 518             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed"> 519             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed"> 520             credentials.commitLock(localRepo);</span>
<span class="line-removed"> 521             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 522 </span>
<span class="line-removed"> 523             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-removed"> 524             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-removed"> 525             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-removed"> 526             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed"> 527             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed"> 528             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed"> 529             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed"> 530 </span>
<span class="line-removed"> 531             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-removed"> 532             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);</span>
<span class="line-removed"> 533             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-removed"> 534                                             .list(mailmanList)</span>
<span class="line-removed"> 535                                             .recipient(listAddress)</span>
<span class="line-removed"> 536                                             .sender(sender)</span>
<span class="line-removed"> 537                                             .author(author)</span>
<span class="line-removed"> 538                                             .reportNewTags(false)</span>
<span class="line-removed"> 539                                             .reportNewBranches(false)</span>
<span class="line-removed"> 540                                             .reportNewBuilds(false)</span>
<span class="line-removed"> 541                                             .mode(MailingListUpdater.Mode.PR_ONLY)</span>
<span class="line-removed"> 542                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;))</span>
<span class="line-removed"> 543                                             .build();</span>
<span class="line-removed"> 544             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed"> 545                                      .repository(repo)</span>
<span class="line-removed"> 546                                      .storagePath(storageFolder)</span>
<span class="line-removed"> 547                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed"> 548                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed"> 549                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed"> 550                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed"> 551                                      .updaters(List.of(updater))</span>
<span class="line-removed"> 552                                      .build();</span>
<span class="line-removed"> 553 </span>
<span class="line-removed"> 554             // No mail should be sent on the first run as there is no history</span>
<span class="line-removed"> 555             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 556             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 557 </span>
<span class="line-removed"> 558             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed"> 559             localRepo.push(editHash, repo.url(), &quot;edit&quot;);</span>
<span class="line-removed"> 560             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);</span>
<span class="line-removed"> 561 </span>
<span class="line-removed"> 562             // Create a potentially conflicting one</span>
<span class="line-removed"> 563             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed"> 564             localRepo.push(otherHash, repo.url(), &quot;other&quot;);</span>
<span class="line-removed"> 565             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);</span>
<span class="line-removed"> 566 </span>
<span class="line-removed"> 567             // PR hasn&#39;t been integrated yet, so there should be no mail</span>
<span class="line-removed"> 568             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 569             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 570 </span>
<span class="line-removed"> 571             // Simulate an RFR email</span>
<span class="line-removed"> 572             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())</span>
<span class="line-removed"> 573                     .recipient(listAddress)</span>
<span class="line-removed"> 574                     .build();</span>
<span class="line-removed"> 575             mailmanList.post(rfr);</span>
<span class="line-removed"> 576             listServer.processIncoming();</span>
<span class="line-removed"> 577 </span>
<span class="line-removed"> 578             // And an integration</span>
<span class="line-removed"> 579             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);</span>
<span class="line-removed"> 580             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed"> 581             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 582             listServer.processIncoming();</span>
<span class="line-removed"> 583 </span>
<span class="line-removed"> 584             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed"> 585             assertEquals(1, conversations.size());</span>
<span class="line-removed"> 586             var first = conversations.get(0).first();</span>
<span class="line-removed"> 587             var email = conversations.get(0).replies(first).get(0);</span>
<span class="line-removed"> 588             assertEquals(listAddress, email.sender());</span>
<span class="line-removed"> 589             assertEquals(author, email.author());</span>
<span class="line-removed"> 590             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="line-removed"> 591             assertEquals(&quot;[Integrated] RFR: My PR&quot;, email.subject());</span>
<span class="line-removed"> 592             assertFalse(email.subject().contains(&quot;master&quot;));</span>
<span class="line-removed"> 593             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));</span>
<span class="line-removed"> 594             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed"> 595             assertFalse(email.body().contains(&quot;Committer&quot;));</span>
<span class="line-removed"> 596             assertFalse(email.body().contains(masterHash.abbreviate()));</span>
<span class="line-removed"> 597             assertTrue(email.hasHeader(&quot;extra1&quot;));</span>
<span class="line-removed"> 598             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));</span>
<span class="line-removed"> 599             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="line-removed"> 600             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="line-removed"> 601             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="line-removed"> 602             assertEquals(editHash.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
<span class="line-removed"> 603 </span>
<span class="line-removed"> 604             // Now push the other one without a matching PR - PR_ONLY will not generate a mail</span>
<span class="line-removed"> 605             localRepo.push(otherHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed"> 606             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 607             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofSeconds(1)));</span>
<span class="line-removed"> 608         }</span>
<span class="line-removed"> 609     }</span>
<span class="line-removed"> 610 </span>
 611     @Test
 612     void testMailingListPROnlyMultipleBranches(TestInfo testInfo) throws IOException {
 613         try (var listServer = new TestMailmanServer();
 614              var credentials = new HostCredentials(testInfo);
 615              var tempFolder = new TemporaryDirectory()) {
 616             var repo = credentials.getHostedRepository();
 617             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 618             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 619             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 620             credentials.commitLock(localRepo);
 621             localRepo.pushAll(repo.url());
 622 
 623             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 624             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 625             var mailmanList = mailmanServer.getList(listAddress.address());
 626             var tagStorage = createTagStorage(repo);
 627             var branchStorage = createBranchStorage(repo);
 628             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 629             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 630 
</pre>
<hr />
<pre>
 751             TestBotRunner.runPeriodicItems(notifyBot);
 752             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 753 
 754             // Simulate an RFR email
 755             var rfr = Email.create(&quot;[repo/branch] RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 756                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 757                            .recipient(listAddress)
 758                            .build();
 759             mailmanList.post(rfr);
 760             listServer.processIncoming();
 761 
 762             // And an integration
 763             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 764             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 765 
 766             // Push the other one without a matching PR
 767             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 768 
 769             TestBotRunner.runPeriodicItems(notifyBot);
 770             listServer.processIncoming();
<span class="line-removed"> 771             listServer.processIncoming();</span>
 772 
 773             var conversations = mailmanList.conversations(Duration.ofDays(1));
 774             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 775             assertEquals(2, conversations.size());
 776 
 777             var prConversation = conversations.get(0);
 778             var pushConversation = conversations.get(1);
<span class="line-modified"> 779 </span>
<span class="line-removed"> 780             var prEmail = prConversation.replies(prConversation.first()).get(0);</span>
<span class="line-removed"> 781             assertEquals(listAddress, prEmail.sender());</span>
<span class="line-removed"> 782             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());</span>
<span class="line-removed"> 783             assertEquals(prEmail.recipients(), List.of(listAddress));</span>
<span class="line-removed"> 784             assertEquals(&quot;[Integrated] [repo/branch] RFR: My PR&quot;, prEmail.subject());</span>
<span class="line-removed"> 785             assertFalse(prEmail.subject().contains(&quot;master&quot;));</span>
<span class="line-removed"> 786             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));</span>
<span class="line-removed"> 787             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed"> 788             assertFalse(prEmail.body().contains(&quot;Committer&quot;));</span>
<span class="line-removed"> 789             assertFalse(prEmail.body().contains(masterHash.abbreviate()));</span>
 790 
 791             var pushEmail = pushConversation.first();
 792             assertEquals(listAddress, pushEmail.sender());
 793             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 794             assertEquals(pushEmail.recipients(), List.of(listAddress));
 795             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 796         }
 797     }
 798 
 799     @Test
 800     void testMailingListPROnce(TestInfo testInfo) throws IOException {
 801         try (var listServer = new TestMailmanServer();
 802              var credentials = new HostCredentials(testInfo);
 803              var tempFolder = new TemporaryDirectory()) {
 804             var repo = credentials.getHostedRepository();
 805             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 806             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 807             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 808             localRepo.branch(masterHash, &quot;other&quot;);
 809             credentials.commitLock(localRepo);
</pre>
<hr />
<pre>
 847             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 848             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 849 
 850             // PR hasn&#39;t been integrated yet, so there should be no mail
 851             TestBotRunner.runPeriodicItems(notifyBot);
 852             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 853 
 854             // Simulate an RFR email
 855             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 856                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 857                            .recipient(listAddress)
 858                            .build();
 859             mailmanList.post(rfr);
 860             listServer.processIncoming();
 861 
 862             // And an integration
 863             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 864             localRepo.push(editHash, repo.url(), &quot;master&quot;, true);
 865 
 866             TestBotRunner.runPeriodicItems(notifyBot);
<span class="line-modified"> 867             listServer.processIncoming();</span>
 868 
 869             var conversations = mailmanList.conversations(Duration.ofDays(1));
 870             assertEquals(1, conversations.size());
 871 
 872             var prConversation = conversations.get(0);
<span class="line-modified"> 873             var prEmail = prConversation.replies(prConversation.first()).get(0);</span>
<span class="line-removed"> 874             assertEquals(listAddress, prEmail.sender());</span>
<span class="line-removed"> 875             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());</span>
<span class="line-removed"> 876             assertEquals(prEmail.recipients(), List.of(listAddress));</span>
<span class="line-removed"> 877             assertEquals(&quot;[Integrated] RFR: My PR&quot;, prEmail.subject());</span>
<span class="line-removed"> 878             assertFalse(prEmail.subject().contains(&quot;master&quot;));</span>
<span class="line-removed"> 879             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));</span>
<span class="line-removed"> 880             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed"> 881             assertFalse(prEmail.body().contains(&quot;Committer&quot;));</span>
<span class="line-removed"> 882             assertFalse(prEmail.body().contains(masterHash.abbreviate()));</span>
 883 
 884             // Now push the change to another monitored branch
 885             localRepo.push(editHash, repo.url(), &quot;other&quot;, true);
 886             TestBotRunner.runPeriodicItems(notifyBot);
 887             listServer.processIncoming();
 888 
 889             // The change should now end up as a separate notification thread
 890             conversations = mailmanList.conversations(Duration.ofDays(1));
 891             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 892             assertEquals(2, conversations.size());
 893 
 894             var pushConversation = conversations.get(1);
 895             var pushEmail = pushConversation.first();
 896             assertEquals(listAddress, pushEmail.sender());
 897             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 898             assertEquals(pushEmail.recipients(), List.of(listAddress));
 899             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 900         }
 901     }
 902 
</pre>
<hr />
<pre>
 912             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 913             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 914             localRepo.pushAll(repo.url());
 915 
 916             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 917             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 918             var mailmanList = mailmanServer.getList(listAddress.address());
 919             var tagStorage = createTagStorage(repo);
 920             var branchStorage = createBranchStorage(repo);
 921             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 922             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 923 
 924             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 925             var updater = MailingListUpdater.newBuilder()
 926                                             .list(mailmanList)
 927                                             .recipient(listAddress)
 928                                             .sender(sender)
 929                                             .reportNewBranches(false)
 930                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 931                                             .build();
<span class="line-modified"> 932             var prOnlyUpdater = MailingListUpdater.newBuilder()</span>
 933                                                   .list(mailmanList)
 934                                                   .recipient(listAddress)
 935                                                   .sender(sender)
 936                                                   .reportNewTags(false)
 937                                                   .reportNewBranches(false)
 938                                                   .reportNewBuilds(false)
<span class="line-removed"> 939                                                   .mode(MailingListUpdater.Mode.PR_ONLY)</span>
 940                                                   .build();
 941             var notifyBot = NotifyBot.newBuilder()
 942                                      .repository(repo)
 943                                      .storagePath(storageFolder)
 944                                      .branches(Pattern.compile(&quot;master&quot;))
 945                                      .tagStorageBuilder(tagStorage)
 946                                      .branchStorageBuilder(branchStorage)
 947                                      .prIssuesStorageBuilder(prIssuesStorage)
<span class="line-modified"> 948                                      .updaters(List.of(updater, prOnlyUpdater))</span>
 949                                      .build();
 950 
 951             // No mail should be sent on the first run as there is no history
 952             TestBotRunner.runPeriodicItems(notifyBot);
 953             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 954 
 955             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 956             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 957             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 958             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 959             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 960             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 961             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 962             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 963             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 964             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 965             localRepo.pushAll(repo.url());
 966 
 967             TestBotRunner.runPeriodicItems(notifyBot);
 968             listServer.processIncoming();
</pre>
<hr />
<pre>
1031             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
1032             localRepo.pushAll(repo.url());
1033 
1034             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1035             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1036             var mailmanList = mailmanServer.getList(listAddress.address());
1037             var tagStorage = createTagStorage(repo);
1038             var branchStorage = createBranchStorage(repo);
1039             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1040             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1041 
1042             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1043             var updater = MailingListUpdater.newBuilder()
1044                                             .list(mailmanList)
1045                                             .recipient(listAddress)
1046                                             .sender(sender)
1047                                             .reportNewBranches(false)
1048                                             .reportNewBuilds(false)
1049                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1050                                             .build();
<span class="line-modified">1051             var prOnlyUpdater = MailingListUpdater.newBuilder()</span>
1052                                                   .list(mailmanList)
1053                                                   .recipient(listAddress)
1054                                                   .sender(sender)
1055                                                   .reportNewTags(false)
1056                                                   .reportNewBranches(false)
1057                                                   .reportNewBuilds(false)
<span class="line-removed">1058                                                   .mode(MailingListUpdater.Mode.PR_ONLY)</span>
1059                                                   .build();
1060             var notifyBot = NotifyBot.newBuilder()
1061                                      .repository(repo)
1062                                      .storagePath(storageFolder)
1063                                      .branches(Pattern.compile(&quot;master&quot;))
1064                                      .tagStorageBuilder(tagStorage)
1065                                      .branchStorageBuilder(branchStorage)
1066                                      .prIssuesStorageBuilder(prIssuesStorage)
<span class="line-modified">1067                                      .updaters(List.of(updater, prOnlyUpdater))</span>
1068                                      .build();
1069 
1070             // No mail should be sent on the first run as there is no history
1071             TestBotRunner.runPeriodicItems(notifyBot);
1072             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1073 
1074             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1075             localRepo.fetch(repo.url(), &quot;history:history&quot;);
1076             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
1077             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
1078             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
1079             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
1080             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
1081             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
1082             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
1083             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
1084             localRepo.pushAll(repo.url());
1085 
1086             TestBotRunner.runPeriodicItems(notifyBot);
1087             listServer.processIncoming();
</pre>
<hr />
<pre>
1175             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1176 
1177             TestBotRunner.runPeriodicItems(notifyBot);
1178             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1179 
1180             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);
1181             TestBotRunner.runPeriodicItems(notifyBot);
1182             listServer.processIncoming();
1183 
1184             var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()
1185                                              .filter(c -&gt; !c.equals(conversations.get(0)))
1186                                              .findFirst().orElseThrow();
1187             email = newConversation.first();
1188             assertEquals(listAddress, email.sender());
1189             assertEquals(sender, email.author());
1190             assertEquals(email.recipients(), List.of(listAddress));
1191             assertEquals(&quot;git: test: created branch newbranch2 based on the branch newbranch1 containing 0 unique commits&quot;, email.subject());
1192             assertEquals(&quot;The new branch newbranch2 is currently identical to the newbranch1 branch.&quot;, email.body());
1193         }
1194     }
<span class="line-removed">1195 </span>
<span class="line-removed">1196     @Test</span>
<span class="line-removed">1197     void testMailingListBranchPrefix(TestInfo testInfo) throws IOException {</span>
<span class="line-removed">1198         try (var listServer = new TestMailmanServer();</span>
<span class="line-removed">1199              var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed">1200              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed">1201             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">1202             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">1203             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed">1204             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed">1205             credentials.commitLock(localRepo);</span>
<span class="line-removed">1206             localRepo.pushAll(repo.url());</span>
<span class="line-removed">1207 </span>
<span class="line-removed">1208             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-removed">1209             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-removed">1210             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-removed">1211             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">1212             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">1213             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">1214             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">1215 </span>
<span class="line-removed">1216             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-removed">1217             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-removed">1218                                             .list(mailmanList)</span>
<span class="line-removed">1219                                             .recipient(listAddress)</span>
<span class="line-removed">1220                                             .sender(sender)</span>
<span class="line-removed">1221                                             .reportNewTags(false)</span>
<span class="line-removed">1222                                             .reportNewBranches(false)</span>
<span class="line-removed">1223                                             .reportNewBuilds(false)</span>
<span class="line-removed">1224                                             .mode(MailingListUpdater.Mode.PR)</span>
<span class="line-removed">1225                                             .repoInSubject(true)</span>
<span class="line-removed">1226                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))</span>
<span class="line-removed">1227                                             .build();</span>
<span class="line-removed">1228             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed">1229                                      .repository(repo)</span>
<span class="line-removed">1230                                      .storagePath(storageFolder)</span>
<span class="line-removed">1231                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed">1232                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed">1233                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed">1234                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed">1235                                      .updaters(List.of(updater))</span>
<span class="line-removed">1236                                      .build();</span>
<span class="line-removed">1237 </span>
<span class="line-removed">1238             // No mail should be sent on the first run as there is no history</span>
<span class="line-removed">1239             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1240             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed">1241 </span>
<span class="line-removed">1242             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed">1243             localRepo.push(editHash, repo.url(), &quot;edit&quot;);</span>
<span class="line-removed">1244             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);</span>
<span class="line-removed">1245 </span>
<span class="line-removed">1246             // PR hasn&#39;t been integrated yet, so there should be no mail</span>
<span class="line-removed">1247             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1248             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed">1249 </span>
<span class="line-removed">1250             // Simulate an RFR email</span>
<span class="line-removed">1251             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())</span>
<span class="line-removed">1252                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))</span>
<span class="line-removed">1253                            .recipient(listAddress)</span>
<span class="line-removed">1254                            .build();</span>
<span class="line-removed">1255             mailmanList.post(rfr);</span>
<span class="line-removed">1256             listServer.processIncoming();</span>
<span class="line-removed">1257 </span>
<span class="line-removed">1258             // And an integration</span>
<span class="line-removed">1259             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);</span>
<span class="line-removed">1260             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed">1261 </span>
<span class="line-removed">1262             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1263             listServer.processIncoming();</span>
<span class="line-removed">1264 </span>
<span class="line-removed">1265             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed">1266             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));</span>
<span class="line-removed">1267             assertEquals(1, conversations.size());</span>
<span class="line-removed">1268 </span>
<span class="line-removed">1269             var prConversation = conversations.get(0);</span>
<span class="line-removed">1270 </span>
<span class="line-removed">1271             var prEmail = prConversation.replies(prConversation.first()).get(0);</span>
<span class="line-removed">1272             assertEquals(listAddress, prEmail.sender());</span>
<span class="line-removed">1273             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());</span>
<span class="line-removed">1274             assertEquals(prEmail.recipients(), List.of(listAddress));</span>
<span class="line-removed">1275             assertEquals(&quot;[&quot; + repo.name() + &quot;:master] [Integrated] RFR: My PR&quot;, prEmail.subject());</span>
<span class="line-removed">1276             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));</span>
<span class="line-removed">1277             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed">1278             assertFalse(prEmail.body().contains(&quot;Committer&quot;));</span>
<span class="line-removed">1279             assertFalse(prEmail.body().contains(masterHash.abbreviate()));</span>
<span class="line-removed">1280         }</span>
<span class="line-removed">1281     }</span>
1282 
1283     @Test
1284     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
1285         try (var listServer = new TestMailmanServer();
1286              var credentials = new HostCredentials(testInfo);
1287              var tempFolder = new TemporaryDirectory()) {
1288             var repo = credentials.getHostedRepository();
1289             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1290             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1291             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1292             credentials.commitLock(localRepo);
1293             localRepo.pushAll(repo.url());
1294 
1295             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1296             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1297             var mailmanList = mailmanServer.getList(listAddress.address());
1298             var tagStorage = createTagStorage(repo);
1299             var branchStorage = createBranchStorage(repo);
1300             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1301             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
</pre>
</td>
<td>
<hr />
<pre>
 491 
 492             conversations = mailmanList.conversations(Duration.ofDays(1));
 493             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 494             email = conversations.get(0).first();
 495             assertEquals(author, email.author());
 496             assertEquals(listAddress, email.sender());
 497             assertEquals(email.recipients(), List.of(listAddress));
 498             assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));
 499             assertFalse(email.subject().contains(&quot;master&quot;));
 500             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));
 501             assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 502             assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 503             assertFalse(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 504             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
 505             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
 506             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
 507             assertEquals(editHash3.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
 508         }
 509     }
 510 




































































































 511     @Test
 512     void testMailingListPROnlyMultipleBranches(TestInfo testInfo) throws IOException {
 513         try (var listServer = new TestMailmanServer();
 514              var credentials = new HostCredentials(testInfo);
 515              var tempFolder = new TemporaryDirectory()) {
 516             var repo = credentials.getHostedRepository();
 517             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 518             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 519             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 520             credentials.commitLock(localRepo);
 521             localRepo.pushAll(repo.url());
 522 
 523             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 524             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 525             var mailmanList = mailmanServer.getList(listAddress.address());
 526             var tagStorage = createTagStorage(repo);
 527             var branchStorage = createBranchStorage(repo);
 528             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 529             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 530 
</pre>
<hr />
<pre>
 651             TestBotRunner.runPeriodicItems(notifyBot);
 652             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 653 
 654             // Simulate an RFR email
 655             var rfr = Email.create(&quot;[repo/branch] RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 656                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 657                            .recipient(listAddress)
 658                            .build();
 659             mailmanList.post(rfr);
 660             listServer.processIncoming();
 661 
 662             // And an integration
 663             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 664             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 665 
 666             // Push the other one without a matching PR
 667             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 668 
 669             TestBotRunner.runPeriodicItems(notifyBot);
 670             listServer.processIncoming();

 671 
 672             var conversations = mailmanList.conversations(Duration.ofDays(1));
 673             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 674             assertEquals(2, conversations.size());
 675 
 676             var prConversation = conversations.get(0);
 677             var pushConversation = conversations.get(1);
<span class="line-modified"> 678             assertEquals(1, prConversation.allMessages().size());</span>










 679 
 680             var pushEmail = pushConversation.first();
 681             assertEquals(listAddress, pushEmail.sender());
 682             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 683             assertEquals(pushEmail.recipients(), List.of(listAddress));
 684             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 685         }
 686     }
 687 
 688     @Test
 689     void testMailingListPROnce(TestInfo testInfo) throws IOException {
 690         try (var listServer = new TestMailmanServer();
 691              var credentials = new HostCredentials(testInfo);
 692              var tempFolder = new TemporaryDirectory()) {
 693             var repo = credentials.getHostedRepository();
 694             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 695             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 696             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 697             localRepo.branch(masterHash, &quot;other&quot;);
 698             credentials.commitLock(localRepo);
</pre>
<hr />
<pre>
 736             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 737             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 738 
 739             // PR hasn&#39;t been integrated yet, so there should be no mail
 740             TestBotRunner.runPeriodicItems(notifyBot);
 741             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 742 
 743             // Simulate an RFR email
 744             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 745                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 746                            .recipient(listAddress)
 747                            .build();
 748             mailmanList.post(rfr);
 749             listServer.processIncoming();
 750 
 751             // And an integration
 752             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 753             localRepo.push(editHash, repo.url(), &quot;master&quot;, true);
 754 
 755             TestBotRunner.runPeriodicItems(notifyBot);
<span class="line-modified"> 756             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
 757 
 758             var conversations = mailmanList.conversations(Duration.ofDays(1));
 759             assertEquals(1, conversations.size());
 760 
 761             var prConversation = conversations.get(0);
<span class="line-modified"> 762             assertEquals(1, prConversation.allMessages().size());</span>









 763 
 764             // Now push the change to another monitored branch
 765             localRepo.push(editHash, repo.url(), &quot;other&quot;, true);
 766             TestBotRunner.runPeriodicItems(notifyBot);
 767             listServer.processIncoming();
 768 
 769             // The change should now end up as a separate notification thread
 770             conversations = mailmanList.conversations(Duration.ofDays(1));
 771             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 772             assertEquals(2, conversations.size());
 773 
 774             var pushConversation = conversations.get(1);
 775             var pushEmail = pushConversation.first();
 776             assertEquals(listAddress, pushEmail.sender());
 777             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 778             assertEquals(pushEmail.recipients(), List.of(listAddress));
 779             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 780         }
 781     }
 782 
</pre>
<hr />
<pre>
 792             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 793             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 794             localRepo.pushAll(repo.url());
 795 
 796             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 797             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 798             var mailmanList = mailmanServer.getList(listAddress.address());
 799             var tagStorage = createTagStorage(repo);
 800             var branchStorage = createBranchStorage(repo);
 801             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 802             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 803 
 804             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 805             var updater = MailingListUpdater.newBuilder()
 806                                             .list(mailmanList)
 807                                             .recipient(listAddress)
 808                                             .sender(sender)
 809                                             .reportNewBranches(false)
 810                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 811                                             .build();
<span class="line-modified"> 812             var noTagsUpdater = MailingListUpdater.newBuilder()</span>
 813                                                   .list(mailmanList)
 814                                                   .recipient(listAddress)
 815                                                   .sender(sender)
 816                                                   .reportNewTags(false)
 817                                                   .reportNewBranches(false)
 818                                                   .reportNewBuilds(false)

 819                                                   .build();
 820             var notifyBot = NotifyBot.newBuilder()
 821                                      .repository(repo)
 822                                      .storagePath(storageFolder)
 823                                      .branches(Pattern.compile(&quot;master&quot;))
 824                                      .tagStorageBuilder(tagStorage)
 825                                      .branchStorageBuilder(branchStorage)
 826                                      .prIssuesStorageBuilder(prIssuesStorage)
<span class="line-modified"> 827                                      .updaters(List.of(updater, noTagsUpdater))</span>
 828                                      .build();
 829 
 830             // No mail should be sent on the first run as there is no history
 831             TestBotRunner.runPeriodicItems(notifyBot);
 832             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 833 
 834             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 835             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 836             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 837             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 838             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 839             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 840             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 841             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 842             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 843             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 844             localRepo.pushAll(repo.url());
 845 
 846             TestBotRunner.runPeriodicItems(notifyBot);
 847             listServer.processIncoming();
</pre>
<hr />
<pre>
 910             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 911             localRepo.pushAll(repo.url());
 912 
 913             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 914             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 915             var mailmanList = mailmanServer.getList(listAddress.address());
 916             var tagStorage = createTagStorage(repo);
 917             var branchStorage = createBranchStorage(repo);
 918             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 919             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 920 
 921             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 922             var updater = MailingListUpdater.newBuilder()
 923                                             .list(mailmanList)
 924                                             .recipient(listAddress)
 925                                             .sender(sender)
 926                                             .reportNewBranches(false)
 927                                             .reportNewBuilds(false)
 928                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 929                                             .build();
<span class="line-modified"> 930             var noTagsUpdater = MailingListUpdater.newBuilder()</span>
 931                                                   .list(mailmanList)
 932                                                   .recipient(listAddress)
 933                                                   .sender(sender)
 934                                                   .reportNewTags(false)
 935                                                   .reportNewBranches(false)
 936                                                   .reportNewBuilds(false)

 937                                                   .build();
 938             var notifyBot = NotifyBot.newBuilder()
 939                                      .repository(repo)
 940                                      .storagePath(storageFolder)
 941                                      .branches(Pattern.compile(&quot;master&quot;))
 942                                      .tagStorageBuilder(tagStorage)
 943                                      .branchStorageBuilder(branchStorage)
 944                                      .prIssuesStorageBuilder(prIssuesStorage)
<span class="line-modified"> 945                                      .updaters(List.of(updater, noTagsUpdater))</span>
 946                                      .build();
 947 
 948             // No mail should be sent on the first run as there is no history
 949             TestBotRunner.runPeriodicItems(notifyBot);
 950             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 951 
 952             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 953             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 954             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 955             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 956             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 957             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 958             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 959             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 960             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 961             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 962             localRepo.pushAll(repo.url());
 963 
 964             TestBotRunner.runPeriodicItems(notifyBot);
 965             listServer.processIncoming();
</pre>
<hr />
<pre>
1053             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1054 
1055             TestBotRunner.runPeriodicItems(notifyBot);
1056             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1057 
1058             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);
1059             TestBotRunner.runPeriodicItems(notifyBot);
1060             listServer.processIncoming();
1061 
1062             var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()
1063                                              .filter(c -&gt; !c.equals(conversations.get(0)))
1064                                              .findFirst().orElseThrow();
1065             email = newConversation.first();
1066             assertEquals(listAddress, email.sender());
1067             assertEquals(sender, email.author());
1068             assertEquals(email.recipients(), List.of(listAddress));
1069             assertEquals(&quot;git: test: created branch newbranch2 based on the branch newbranch1 containing 0 unique commits&quot;, email.subject());
1070             assertEquals(&quot;The new branch newbranch2 is currently identical to the newbranch1 branch.&quot;, email.body());
1071         }
1072     }























































































1073 
1074     @Test
1075     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
1076         try (var listServer = new TestMailmanServer();
1077              var credentials = new HostCredentials(testInfo);
1078              var tempFolder = new TemporaryDirectory()) {
1079             var repo = credentials.getHostedRepository();
1080             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1081             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1082             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1083             credentials.commitLock(localRepo);
1084             localRepo.pushAll(repo.url());
1085 
1086             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1087             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1088             var mailmanList = mailmanServer.getList(listAddress.address());
1089             var tagStorage = createTagStorage(repo);
1090             var branchStorage = createBranchStorage(repo);
1091             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1092             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/NotifyBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>