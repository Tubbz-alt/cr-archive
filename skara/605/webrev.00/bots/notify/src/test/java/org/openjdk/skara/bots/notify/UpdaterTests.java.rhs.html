<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.notify;
  24 
  25 import org.openjdk.skara.email.*;
  26 import org.openjdk.skara.forge.HostedRepository;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.json.*;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.storage.StorageBuilder;
  31 import org.openjdk.skara.test.*;
  32 import org.openjdk.skara.vcs.*;
  33 import org.openjdk.skara.vcs.Tag;
  34 import org.openjdk.skara.vcs.openjdk.OpenJDKTag;
  35 
  36 import org.junit.jupiter.api.*;
  37 
  38 import java.io.IOException;
  39 import java.net.URI;
  40 import java.nio.charset.StandardCharsets;
  41 import java.nio.file.*;
  42 import java.time.Duration;
  43 import java.util.*;
  44 import java.util.regex.Pattern;
  45 import java.util.stream.Collectors;
  46 
  47 import static org.junit.jupiter.api.Assertions.*;
  48 import static org.openjdk.skara.issuetracker.Issue.State.*;
  49 
  50 class UpdaterTests {
  51     private List&lt;Path&gt; findJsonFiles(Path folder, String partialName) throws IOException {
  52         return Files.walk(folder)
  53                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
  54                     .filter(path -&gt; path.toString().contains(partialName))
  55                     .collect(Collectors.toList());
  56     }
  57 
  58     private StorageBuilder&lt;UpdatedTag&gt; createTagStorage(HostedRepository repository) {
  59         return new StorageBuilder&lt;UpdatedTag&gt;(&quot;tags.txt&quot;)
  60                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);
  61     }
  62 
  63     private StorageBuilder&lt;UpdatedBranch&gt; createBranchStorage(HostedRepository repository) {
  64         return new StorageBuilder&lt;UpdatedBranch&gt;(&quot;branches.txt&quot;)
  65                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);
  66     }
  67 
  68     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {
  69         return new StorageBuilder&lt;PullRequestIssues&gt;(&quot;prissues.txt&quot;)
  70                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated prissues&quot;);
  71     }
  72 
  73     private Set&lt;String&gt; fixVersions(Issue issue) {
  74         if (!issue.properties().containsKey(&quot;fixVersions&quot;)) {
  75             return Set.of();
  76         }
  77         return issue.properties().get(&quot;fixVersions&quot;).stream()
  78                     .map(JSONValue::asString)
  79                     .collect(Collectors.toSet());
  80     }
  81 
  82     @Test
  83     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
  84         try (var credentials = new HostCredentials(testInfo);
  85              var tempFolder = new TemporaryDirectory()) {
  86             var repo = credentials.getHostedRepository();
  87             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
  88             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
  89             credentials.commitLock(localRepo);
  90             localRepo.pushAll(repo.url());
  91 
  92             var tagStorage = createTagStorage(repo);
  93             var branchStorage = createBranchStorage(repo);
  94             var prIssuesStorage = createPullRequestIssuesStorage(repo);
  95             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
  96             Files.createDirectory(jsonFolder);
  97             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  98 
  99             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
 100             var notifyBot = NotifyBot.newBuilder()
 101                                      .repository(repo)
 102                                      .storagePath(storageFolder)
 103                                      .branches(Pattern.compile(&quot;master&quot;))
 104                                      .tagStorageBuilder(tagStorage)
 105                                      .branchStorageBuilder(branchStorage)
 106                                      .prIssuesStorageBuilder(prIssuesStorage)
 107                                      .updaters(List.of(updater))
 108                                      .build();
 109 
 110             TestBotRunner.runPeriodicItems(notifyBot);
 111             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 112 
 113             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 114             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 115             TestBotRunner.runPeriodicItems(notifyBot);
 116             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 117             assertEquals(1, jsonFiles.size());
 118             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 119             var json = JSON.parse(jsonData);
 120             assertEquals(1, json.asArray().size());
 121             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 122             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 123                                                   .map(JSONValue::asString)
 124                                                   .collect(Collectors.toList()));
 125         }
 126     }
 127 
 128     @Test
 129     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
 130         try (var credentials = new HostCredentials(testInfo);
 131              var tempFolder = new TemporaryDirectory()) {
 132             var repo = credentials.getHostedRepository();
 133             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 134             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 135             credentials.commitLock(localRepo);
 136             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 137             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 138             localRepo.pushAll(repo.url());
 139 
 140             var tagStorage = createTagStorage(repo);
 141             var branchStorage = createBranchStorage(repo);
 142             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 143             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 144             Files.createDirectory(jsonFolder);
 145             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
 146 
 147             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
 148             var notifyBot = NotifyBot.newBuilder()
 149                                      .repository(repo)
 150                                      .storagePath(storageFolder)
 151                                      .branches(Pattern.compile(&quot;master&quot;))
 152                                      .tagStorageBuilder(tagStorage)
 153                                      .branchStorageBuilder(branchStorage)
 154                                      .prIssuesStorageBuilder(prIssuesStorage)
 155                                      .updaters(List.of(updater))
 156                                      .build();
 157 
 158             TestBotRunner.runPeriodicItems(notifyBot);
 159             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 160 
 161             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 162             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 163             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 164             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
 165             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 166             localRepo.pushAll(repo.url());
 167 
 168             TestBotRunner.runPeriodicItems(notifyBot);
 169             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 170             assertEquals(3, jsonFiles.size());
 171 
 172             for (var file : jsonFiles) {
 173                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
 174                 var json = JSON.parse(jsonData);
 175 
 176                 if (json.asArray().get(0).contains(&quot;date&quot;)) {
 177                     assertEquals(2, json.asArray().size());
 178                     assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 179                                                           .map(JSONValue::asString)
 180                                                           .collect(Collectors.toList()));
 181                     assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 182                     assertEquals(&quot;team&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 183                     assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(1).get(&quot;issue&quot;).asArray().stream()
 184                                                           .map(JSONValue::asString)
 185                                                           .collect(Collectors.toList()));
 186                     assertEquals(repo.webUrl(editHash2).toString(), json.asArray().get(1).get(&quot;url&quot;).asString());
 187                     assertEquals(&quot;team&quot;, json.asArray().get(1).get(&quot;build&quot;).asString());
 188                 } else {
 189                     assertEquals(1, json.asArray().size());
 190                     if (json.asArray().get(0).get(&quot;build&quot;).asString().equals(&quot;b02&quot;)) {
 191                         assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 192                                                               .map(JSONValue::asString)
 193                                                               .collect(Collectors.toList()));
 194                     } else {
 195                         assertEquals(&quot;b04&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 196                         assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 197                                                               .map(JSONValue::asString)
 198                                                               .collect(Collectors.toList()));
 199                     }
 200                 }
 201             }
 202         }
 203     }
 204 
 205     @Test
 206     void testMailingList(TestInfo testInfo) throws IOException {
 207         try (var listServer = new TestMailmanServer();
 208              var credentials = new HostCredentials(testInfo);
 209              var tempFolder = new TemporaryDirectory()) {
 210             var repo = credentials.getHostedRepository();
 211             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 212             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 213             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 214             credentials.commitLock(localRepo);
 215             localRepo.pushAll(repo.url());
 216 
 217             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 218             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 219             var mailmanList = mailmanServer.getList(listAddress.address());
 220             var tagStorage = createTagStorage(repo);
 221             var branchStorage = createBranchStorage(repo);
 222             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 223             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 224 
 225             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 226             var updater = MailingListUpdater.newBuilder()
 227                                             .list(mailmanList)
 228                                             .recipient(listAddress)
 229                                             .sender(sender)
 230                                             .reportNewTags(false)
 231                                             .reportNewBranches(false)
 232                                             .reportNewBuilds(false)
 233                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 234                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
 235                                             .build();
 236             var notifyBot = NotifyBot.newBuilder()
 237                                      .repository(repo)
 238                                      .storagePath(storageFolder)
 239                                      .branches(Pattern.compile(&quot;master&quot;))
 240                                      .tagStorageBuilder(tagStorage)
 241                                      .branchStorageBuilder(branchStorage)
 242                                      .prIssuesStorageBuilder(prIssuesStorage)
 243                                      .updaters(List.of(updater))
 244                                      .build();
 245 
 246             // No mail should be sent on the first run as there is no history
 247             TestBotRunner.runPeriodicItems(notifyBot);
 248             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 249 
 250             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 251             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 252             TestBotRunner.runPeriodicItems(notifyBot);
 253             listServer.processIncoming();
 254 
 255             var conversations = mailmanList.conversations(Duration.ofDays(1));
 256             var email = conversations.get(0).first();
 257             assertEquals(listAddress, email.sender());
 258             assertEquals(sender, email.author());
 259             assertEquals(email.recipients(), List.of(listAddress));
 260             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
 261             assertFalse(email.subject().contains(&quot;master&quot;));
 262             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 263             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 264             assertFalse(email.body().contains(&quot;Committer&quot;));
 265             assertFalse(email.body().contains(masterHash.abbreviate()));
 266             assertTrue(email.hasHeader(&quot;extra1&quot;));
 267             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 268             assertTrue(email.hasHeader(&quot;extra2&quot;));
 269             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 270             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
 271             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
 272             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
 273             assertEquals(editHash.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
 274         }
 275     }
 276 
 277     @Test
 278     void testMailingListMultiple(TestInfo testInfo) throws IOException {
 279         try (var listServer = new TestMailmanServer();
 280              var credentials = new HostCredentials(testInfo);
 281              var tempFolder = new TemporaryDirectory()) {
 282             var repo = credentials.getHostedRepository();
 283             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 284             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 285             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 286             credentials.commitLock(localRepo);
 287             localRepo.pushAll(repo.url());
 288 
 289             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 290             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 291             var mailmanList = mailmanServer.getList(listAddress.address());
 292             var tagStorage = createTagStorage(repo);
 293             var branchStorage = createBranchStorage(repo);
 294             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 295             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 296 
 297             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 298             var updater = MailingListUpdater.newBuilder()
 299                                             .list(mailmanList)
 300                                             .recipient(listAddress)
 301                                             .sender(sender)
 302                                             .reportNewTags(false)
 303                                             .reportNewBranches(false)
 304                                             .reportNewBuilds(false)
 305                                             .build();
 306             var notifyBot = NotifyBot.newBuilder()
 307                                      .repository(repo)
 308                                      .storagePath(storageFolder)
 309                                      .branches(Pattern.compile(&quot;master&quot;))
 310                                      .tagStorageBuilder(tagStorage)
 311                                      .branchStorageBuilder(branchStorage)
 312                                      .prIssuesStorageBuilder(prIssuesStorage)
 313                                      .updaters(List.of(updater))
 314                                      .build();
 315 
 316             // No mail should be sent on the first run as there is no history
 317             TestBotRunner.runPeriodicItems(notifyBot);
 318             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 319 
 320             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 321                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 322             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 323             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 324                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 325             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 326 
 327             TestBotRunner.runPeriodicItems(notifyBot);
 328             listServer.processIncoming();
 329 
 330             var conversations = mailmanList.conversations(Duration.ofDays(1));
 331             var email = conversations.get(0).first();
 332             assertEquals(listAddress, email.sender());
 333             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());
 334             assertEquals(email.recipients(), List.of(listAddress));
 335             assertTrue(email.subject().contains(&quot;: 2 new changesets&quot;));
 336             assertFalse(email.subject().contains(&quot;master&quot;));
 337             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 338             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 339             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 340             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 341             assertFalse(email.body().contains(masterHash.abbreviate()));
 342             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
 343             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
 344             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
 345             assertEquals(editHash1.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
 346         }
 347     }
 348 
 349     @Test
 350     void testMailingListSponsored(TestInfo testInfo) throws IOException {
 351         try (var listServer = new TestMailmanServer();
 352              var credentials = new HostCredentials(testInfo);
 353              var tempFolder = new TemporaryDirectory()) {
 354             var repo = credentials.getHostedRepository();
 355             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 356             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 357             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 358             credentials.commitLock(localRepo);
 359             localRepo.pushAll(repo.url());
 360 
 361             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 362             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 363             var mailmanList = mailmanServer.getList(listAddress.address());
 364             var tagStorage = createTagStorage(repo);
 365             var branchStorage = createBranchStorage(repo);
 366             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 367             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 368 
 369             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 370             var updater = MailingListUpdater.newBuilder()
 371                                             .list(mailmanList)
 372                                             .recipient(listAddress)
 373                                             .sender(sender)
 374                                             .reportNewTags(false)
 375                                             .reportNewBranches(false)
 376                                             .reportNewBuilds(false)
 377                                             .build();
 378             var notifyBot = NotifyBot.newBuilder()
 379                                      .repository(repo)
 380                                      .storagePath(storageFolder)
 381                                      .branches(Pattern.compile(&quot;master&quot;))
 382                                      .tagStorageBuilder(tagStorage)
 383                                      .branchStorageBuilder(branchStorage)
 384                                      .prIssuesStorageBuilder(prIssuesStorage)
 385                                      .updaters(List.of(updater))
 386                                      .build();
 387 
 388             // No mail should be sent on the first run as there is no history
 389             TestBotRunner.runPeriodicItems(notifyBot);
 390             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 391 
 392             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 393                                                                &quot;author&quot;, &quot;author@test.test&quot;,
 394                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);
 395             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 396             TestBotRunner.runPeriodicItems(notifyBot);
 397             listServer.processIncoming();
 398 
 399             var conversations = mailmanList.conversations(Duration.ofDays(1));
 400             var email = conversations.get(0).first();
 401             assertEquals(listAddress, email.sender());
 402             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
 403             assertEquals(email.recipients(), List.of(listAddress));
 404             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 405             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 406             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
 407             assertTrue(email.body().contains(&quot;Committer: committer &lt;committer@test.test&gt;&quot;));
 408             assertFalse(email.body().contains(masterHash.abbreviate()));
 409         }
 410     }
 411 
 412     @Test
 413     void testMailingListMultipleBranches(TestInfo testInfo) throws IOException {
 414         try (var listServer = new TestMailmanServer();
 415              var credentials = new HostCredentials(testInfo);
 416              var tempFolder = new TemporaryDirectory()) {
 417             var repo = credentials.getHostedRepository();
 418             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 419             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 420             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 421             credentials.commitLock(localRepo);
 422             var branch = localRepo.branch(masterHash, &quot;another&quot;);
 423             localRepo.pushAll(repo.url());
 424 
 425             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 426             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 427             var mailmanList = mailmanServer.getList(listAddress.address());
 428             var tagStorage = createTagStorage(repo);
 429             var branchStorage = createBranchStorage(repo);
 430             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 431             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 432 
 433             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 434             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 435             var updater = MailingListUpdater.newBuilder()
 436                                             .list(mailmanList)
 437                                             .recipient(listAddress)
 438                                             .sender(sender)
 439                                             .author(author)
 440                                             .includeBranch(true)
 441                                             .reportNewTags(false)
 442                                             .reportNewBranches(false)
 443                                             .reportNewBuilds(false)
 444                                             .build();
 445             var notifyBot = NotifyBot.newBuilder()
 446                                      .repository(repo)
 447                                      .storagePath(storageFolder)
 448                                      .branches(Pattern.compile(&quot;master|another&quot;))
 449                                      .tagStorageBuilder(tagStorage)
 450                                      .branchStorageBuilder(branchStorage)
 451                                      .prIssuesStorageBuilder(prIssuesStorage)
 452                                      .updaters(List.of(updater))
 453                                      .build();
 454 
 455             // No mail should be sent on the first run as there is no history
 456             TestBotRunner.runPeriodicItems(notifyBot);
 457             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 458 
 459             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 460             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 461             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
 462             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 463 
 464             TestBotRunner.runPeriodicItems(notifyBot);
 465             listServer.processIncoming();
 466 
 467             var conversations = mailmanList.conversations(Duration.ofDays(1));
 468             var email = conversations.get(0).first();
 469             assertEquals(listAddress, email.sender());
 470             assertEquals(author, email.author());
 471             assertEquals(email.recipients(), List.of(listAddress));
 472             assertFalse(email.subject().contains(&quot;another&quot;));
 473             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
 474             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 475             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 476             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 477             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 478             assertFalse(email.body().contains(masterHash.abbreviate()));
 479             assertFalse(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 480             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
 481             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
 482             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
 483             assertEquals(editHash1.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
 484 
 485             localRepo.checkout(branch, true);
 486             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);
 487             localRepo.push(editHash3, repo.url(), &quot;another&quot;);
 488 
 489             TestBotRunner.runPeriodicItems(notifyBot);
 490             listServer.processIncoming();
 491 
 492             conversations = mailmanList.conversations(Duration.ofDays(1));
 493             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 494             email = conversations.get(0).first();
 495             assertEquals(author, email.author());
 496             assertEquals(listAddress, email.sender());
 497             assertEquals(email.recipients(), List.of(listAddress));
 498             assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));
 499             assertFalse(email.subject().contains(&quot;master&quot;));
 500             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));
 501             assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 502             assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 503             assertFalse(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 504             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
 505             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
 506             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
 507             assertEquals(editHash3.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
 508         }
 509     }
 510 
<a name="1" id="anc1"></a>



































































































 511     @Test
 512     void testMailingListPROnlyMultipleBranches(TestInfo testInfo) throws IOException {
 513         try (var listServer = new TestMailmanServer();
 514              var credentials = new HostCredentials(testInfo);
 515              var tempFolder = new TemporaryDirectory()) {
 516             var repo = credentials.getHostedRepository();
 517             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 518             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 519             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 520             credentials.commitLock(localRepo);
 521             localRepo.pushAll(repo.url());
 522 
 523             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 524             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 525             var mailmanList = mailmanServer.getList(listAddress.address());
 526             var tagStorage = createTagStorage(repo);
 527             var branchStorage = createBranchStorage(repo);
 528             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 529             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 530 
 531             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 532             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 533             var updater = MailingListUpdater.newBuilder()
 534                                             .list(mailmanList)
 535                                             .recipient(listAddress)
 536                                             .sender(sender)
 537                                             .author(author)
 538                                             .reportNewTags(false)
 539                                             .reportNewBranches(false)
 540                                             .reportNewBuilds(false)
 541                                             .includeBranch(true)
 542                                             .mode(MailingListUpdater.Mode.PR)
 543                                             .build();
 544             var notifyBot = NotifyBot.newBuilder()
 545                                      .repository(repo)
 546                                      .storagePath(storageFolder)
 547                                      .branches(Pattern.compile(&quot;master|other&quot;))
 548                                      .tagStorageBuilder(tagStorage)
 549                                      .branchStorageBuilder(branchStorage)
 550                                      .prIssuesStorageBuilder(prIssuesStorage)
 551                                      .updaters(List.of(updater))
 552                                      .build();
 553 
 554             // Populate our known branches
 555             localRepo.push(masterHash, repo.url(), &quot;master&quot;, true);
 556             localRepo.push(masterHash, repo.url(), &quot;other&quot;, true);
 557 
 558             // No mail should be sent on the first run as there is no history
 559             TestBotRunner.runPeriodicItems(notifyBot);
 560             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 561 
 562             localRepo.checkout(masterHash, true);
 563             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 564             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 565             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 566 
 567             // PR hasn&#39;t been integrated yet, so there should be no mail
 568             TestBotRunner.runPeriodicItems(notifyBot);
 569             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 570 
 571             // Simulate an RFR email
 572             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
 573                            .recipient(listAddress)
 574                            .build();
 575             mailmanList.post(rfr);
 576             listServer.processIncoming();
 577 
 578             // And an integration (but it hasn&#39;t reached master just yet)
 579             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 580 
 581             // Now push the same commit to another branch
 582             localRepo.push(editHash, repo.url(), &quot;other&quot;);
 583             TestBotRunner.runPeriodicItems(notifyBot);
 584             listServer.processIncoming();
 585 
 586             // This one should generate a plain integration mail
 587             var conversations = mailmanList.conversations(Duration.ofDays(1));
 588             assertEquals(2, conversations.size());
 589             var secondEmail = conversations.get(0).first();
 590             if (secondEmail.subject().contains(&quot;RFR&quot;)) {
 591                 secondEmail = conversations.get(1).first();
 592             }
 593             assertEquals(&quot;git: test: other: 23456789: More fixes&quot;, secondEmail.subject());
 594         }
 595     }
 596 
 597     @Test
 598     void testMailingListPR(TestInfo testInfo) throws IOException {
 599         try (var listServer = new TestMailmanServer();
 600              var credentials = new HostCredentials(testInfo);
 601              var tempFolder = new TemporaryDirectory()) {
 602             var repo = credentials.getHostedRepository();
 603             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 604             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 605             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 606             credentials.commitLock(localRepo);
 607             localRepo.pushAll(repo.url());
 608 
 609             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 610             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 611             var mailmanList = mailmanServer.getList(listAddress.address());
 612             var tagStorage = createTagStorage(repo);
 613             var branchStorage = createBranchStorage(repo);
 614             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 615             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 616 
 617             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 618             var updater = MailingListUpdater.newBuilder()
 619                                             .list(mailmanList)
 620                                             .recipient(listAddress)
 621                                             .sender(sender)
 622                                             .reportNewTags(false)
 623                                             .reportNewBranches(false)
 624                                             .reportNewBuilds(false)
 625                                             .mode(MailingListUpdater.Mode.PR)
 626                                             .build();
 627             var notifyBot = NotifyBot.newBuilder()
 628                                      .repository(repo)
 629                                      .storagePath(storageFolder)
 630                                      .branches(Pattern.compile(&quot;master&quot;))
 631                                      .tagStorageBuilder(tagStorage)
 632                                      .branchStorageBuilder(branchStorage)
 633                                      .prIssuesStorageBuilder(prIssuesStorage)
 634                                      .updaters(List.of(updater))
 635                                      .build();
 636 
 637             // No mail should be sent on the first run as there is no history
 638             TestBotRunner.runPeriodicItems(notifyBot);
 639             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 640 
 641             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 642             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 643             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 644 
 645             // Create a potentially conflicting one
 646             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 647             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 648             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 649 
 650             // PR hasn&#39;t been integrated yet, so there should be no mail
 651             TestBotRunner.runPeriodicItems(notifyBot);
 652             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 653 
 654             // Simulate an RFR email
 655             var rfr = Email.create(&quot;[repo/branch] RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 656                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 657                            .recipient(listAddress)
 658                            .build();
 659             mailmanList.post(rfr);
 660             listServer.processIncoming();
 661 
 662             // And an integration
 663             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 664             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 665 
 666             // Push the other one without a matching PR
 667             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 668 
 669             TestBotRunner.runPeriodicItems(notifyBot);
 670             listServer.processIncoming();
<a name="2" id="anc2"></a>
 671 
 672             var conversations = mailmanList.conversations(Duration.ofDays(1));
 673             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 674             assertEquals(2, conversations.size());
 675 
 676             var prConversation = conversations.get(0);
 677             var pushConversation = conversations.get(1);
<a name="3" id="anc3"></a><span class="line-modified"> 678             assertEquals(1, prConversation.allMessages().size());</span>










 679 
 680             var pushEmail = pushConversation.first();
 681             assertEquals(listAddress, pushEmail.sender());
 682             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 683             assertEquals(pushEmail.recipients(), List.of(listAddress));
 684             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 685         }
 686     }
 687 
 688     @Test
 689     void testMailingListPROnce(TestInfo testInfo) throws IOException {
 690         try (var listServer = new TestMailmanServer();
 691              var credentials = new HostCredentials(testInfo);
 692              var tempFolder = new TemporaryDirectory()) {
 693             var repo = credentials.getHostedRepository();
 694             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 695             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 696             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 697             localRepo.branch(masterHash, &quot;other&quot;);
 698             credentials.commitLock(localRepo);
 699             localRepo.pushAll(repo.url());
 700 
 701             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 702             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 703             var mailmanList = mailmanServer.getList(listAddress.address());
 704             var tagStorage = createTagStorage(repo);
 705             var branchStorage = createBranchStorage(repo);
 706             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 707             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 708 
 709             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 710             var updater = MailingListUpdater.newBuilder()
 711                                             .list(mailmanList)
 712                                             .recipient(listAddress)
 713                                             .sender(sender)
 714                                             .author(null)
 715                                             .reportNewTags(false)
 716                                             .reportNewBranches(false)
 717                                             .reportNewBuilds(false)
 718                                             .mode(MailingListUpdater.Mode.PR)
 719                                             .build();
 720             var notifyBot = NotifyBot.newBuilder()
 721                                      .repository(repo)
 722                                      .storagePath(storageFolder)
 723                                      .branches(Pattern.compile(&quot;master|other&quot;))
 724                                      .tagStorageBuilder(tagStorage)
 725                                      .branchStorageBuilder(branchStorage)
 726                                      .prIssuesStorageBuilder(prIssuesStorage)
 727                                      .updaters(List.of(updater))
 728                                      .build();
 729 
 730             // No mail should be sent on the first run as there is no history
 731             TestBotRunner.runPeriodicItems(notifyBot);
 732             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 733 
 734             localRepo.checkout(masterHash, true);
 735             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 736             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 737             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 738 
 739             // PR hasn&#39;t been integrated yet, so there should be no mail
 740             TestBotRunner.runPeriodicItems(notifyBot);
 741             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 742 
 743             // Simulate an RFR email
 744             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 745                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 746                            .recipient(listAddress)
 747                            .build();
 748             mailmanList.post(rfr);
 749             listServer.processIncoming();
 750 
 751             // And an integration
 752             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 753             localRepo.push(editHash, repo.url(), &quot;master&quot;, true);
 754 
 755             TestBotRunner.runPeriodicItems(notifyBot);
<a name="4" id="anc4"></a><span class="line-modified"> 756             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
 757 
 758             var conversations = mailmanList.conversations(Duration.ofDays(1));
 759             assertEquals(1, conversations.size());
 760 
 761             var prConversation = conversations.get(0);
<a name="5" id="anc5"></a><span class="line-modified"> 762             assertEquals(1, prConversation.allMessages().size());</span>









 763 
 764             // Now push the change to another monitored branch
 765             localRepo.push(editHash, repo.url(), &quot;other&quot;, true);
 766             TestBotRunner.runPeriodicItems(notifyBot);
 767             listServer.processIncoming();
 768 
 769             // The change should now end up as a separate notification thread
 770             conversations = mailmanList.conversations(Duration.ofDays(1));
 771             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 772             assertEquals(2, conversations.size());
 773 
 774             var pushConversation = conversations.get(1);
 775             var pushEmail = pushConversation.first();
 776             assertEquals(listAddress, pushEmail.sender());
 777             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 778             assertEquals(pushEmail.recipients(), List.of(listAddress));
 779             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 780         }
 781     }
 782 
 783     @Test
 784     void testMailinglistTag(TestInfo testInfo) throws IOException {
 785         try (var credentials = new HostCredentials(testInfo);
 786              var tempFolder = new TemporaryDirectory();
 787              var listServer = new TestMailmanServer()) {
 788             var repo = credentials.getHostedRepository();
 789             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 790             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 791             credentials.commitLock(localRepo);
 792             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 793             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 794             localRepo.pushAll(repo.url());
 795 
 796             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 797             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 798             var mailmanList = mailmanServer.getList(listAddress.address());
 799             var tagStorage = createTagStorage(repo);
 800             var branchStorage = createBranchStorage(repo);
 801             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 802             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 803 
 804             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 805             var updater = MailingListUpdater.newBuilder()
 806                                             .list(mailmanList)
 807                                             .recipient(listAddress)
 808                                             .sender(sender)
 809                                             .reportNewBranches(false)
 810                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 811                                             .build();
<a name="6" id="anc6"></a><span class="line-modified"> 812             var noTagsUpdater = MailingListUpdater.newBuilder()</span>
 813                                                   .list(mailmanList)
 814                                                   .recipient(listAddress)
 815                                                   .sender(sender)
 816                                                   .reportNewTags(false)
 817                                                   .reportNewBranches(false)
 818                                                   .reportNewBuilds(false)
<a name="7" id="anc7"></a>
 819                                                   .build();
 820             var notifyBot = NotifyBot.newBuilder()
 821                                      .repository(repo)
 822                                      .storagePath(storageFolder)
 823                                      .branches(Pattern.compile(&quot;master&quot;))
 824                                      .tagStorageBuilder(tagStorage)
 825                                      .branchStorageBuilder(branchStorage)
 826                                      .prIssuesStorageBuilder(prIssuesStorage)
<a name="8" id="anc8"></a><span class="line-modified"> 827                                      .updaters(List.of(updater, noTagsUpdater))</span>
 828                                      .build();
 829 
 830             // No mail should be sent on the first run as there is no history
 831             TestBotRunner.runPeriodicItems(notifyBot);
 832             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 833 
 834             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 835             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 836             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 837             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 838             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 839             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 840             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 841             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 842             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 843             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 844             localRepo.pushAll(repo.url());
 845 
 846             TestBotRunner.runPeriodicItems(notifyBot);
 847             listServer.processIncoming();
 848             listServer.processIncoming();
 849             listServer.processIncoming();
 850             listServer.processIncoming();
 851 
 852             var conversations = mailmanList.conversations(Duration.ofDays(1));
 853             assertEquals(4, conversations.size());
 854 
 855             for (var conversation : conversations) {
 856                 var email = conversation.first();
 857                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 858                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 859                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 860                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 861                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 862                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 863                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 864                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 865                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 866                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 867                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 868                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 869                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 870                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 871                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 872                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 873                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 874                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 875                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 876                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 877                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 878                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 879                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 880                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 881                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 882                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 883                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 884                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 885                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 886                     assertTrue(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 887                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 888                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 889                 } else {
 890                     fail(&quot;Mismatched subject: &quot; + email.subject());
 891                 }
 892                 assertTrue(email.hasHeader(&quot;extra1&quot;));
 893                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 894                 assertTrue(email.hasHeader(&quot;extra2&quot;));
 895                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 896             }
 897         }
 898     }
 899 
 900     @Test
 901     void testMailinglistPlainTags(TestInfo testInfo) throws IOException {
 902         try (var credentials = new HostCredentials(testInfo);
 903              var tempFolder = new TemporaryDirectory();
 904              var listServer = new TestMailmanServer()) {
 905             var repo = credentials.getHostedRepository();
 906             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 907             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 908             credentials.commitLock(localRepo);
 909             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 910             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 911             localRepo.pushAll(repo.url());
 912 
 913             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 914             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 915             var mailmanList = mailmanServer.getList(listAddress.address());
 916             var tagStorage = createTagStorage(repo);
 917             var branchStorage = createBranchStorage(repo);
 918             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 919             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 920 
 921             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 922             var updater = MailingListUpdater.newBuilder()
 923                                             .list(mailmanList)
 924                                             .recipient(listAddress)
 925                                             .sender(sender)
 926                                             .reportNewBranches(false)
 927                                             .reportNewBuilds(false)
 928                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 929                                             .build();
<a name="9" id="anc9"></a><span class="line-modified"> 930             var noTagsUpdater = MailingListUpdater.newBuilder()</span>
 931                                                   .list(mailmanList)
 932                                                   .recipient(listAddress)
 933                                                   .sender(sender)
 934                                                   .reportNewTags(false)
 935                                                   .reportNewBranches(false)
 936                                                   .reportNewBuilds(false)
<a name="10" id="anc10"></a>
 937                                                   .build();
 938             var notifyBot = NotifyBot.newBuilder()
 939                                      .repository(repo)
 940                                      .storagePath(storageFolder)
 941                                      .branches(Pattern.compile(&quot;master&quot;))
 942                                      .tagStorageBuilder(tagStorage)
 943                                      .branchStorageBuilder(branchStorage)
 944                                      .prIssuesStorageBuilder(prIssuesStorage)
<a name="11" id="anc11"></a><span class="line-modified"> 945                                      .updaters(List.of(updater, noTagsUpdater))</span>
 946                                      .build();
 947 
 948             // No mail should be sent on the first run as there is no history
 949             TestBotRunner.runPeriodicItems(notifyBot);
 950             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 951 
 952             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 953             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 954             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 955             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 956             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 957             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 958             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 959             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 960             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 961             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 962             localRepo.pushAll(repo.url());
 963 
 964             TestBotRunner.runPeriodicItems(notifyBot);
 965             listServer.processIncoming();
 966             listServer.processIncoming();
 967             listServer.processIncoming();
 968             listServer.processIncoming();
 969 
 970             var conversations = mailmanList.conversations(Duration.ofDays(1));
 971             assertEquals(4, conversations.size());
 972 
 973             for (var conversation : conversations) {
 974                 var email = conversation.first();
 975                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 976                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 977                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 978                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 979                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 980                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 981                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 982                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 983                 } else {
 984                     fail(&quot;Mismatched subject: &quot; + email.subject());
 985                 }
 986                 assertTrue(email.hasHeader(&quot;extra1&quot;));
 987                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 988                 assertTrue(email.hasHeader(&quot;extra2&quot;));
 989                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 990             }
 991         }
 992     }
 993 
 994     @Test
 995     void testMailingListBranch(TestInfo testInfo) throws IOException {
 996         try (var listServer = new TestMailmanServer();
 997              var credentials = new HostCredentials(testInfo);
 998              var tempFolder = new TemporaryDirectory()) {
 999             var repo = credentials.getHostedRepository();
1000             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1001             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1002             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1003             credentials.commitLock(localRepo);
1004             localRepo.pushAll(repo.url());
1005 
1006             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1007             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1008             var mailmanList = mailmanServer.getList(listAddress.address());
1009             var tagStorage = createTagStorage(repo);
1010             var branchStorage = createBranchStorage(repo);
1011             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1012             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1013 
1014             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1015             var updater = MailingListUpdater.newBuilder()
1016                                             .list(mailmanList)
1017                                             .recipient(listAddress)
1018                                             .sender(sender)
1019                                             .reportNewTags(false)
1020                                             .reportNewBuilds(false)
1021                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1022                                             .build();
1023             var notifyBot = NotifyBot.newBuilder()
1024                                      .repository(repo)
1025                                      .storagePath(storageFolder)
1026                                      .branches(Pattern.compile(&quot;master|newbranch.&quot;))
1027                                      .tagStorageBuilder(tagStorage)
1028                                      .branchStorageBuilder(branchStorage)
1029                                      .prIssuesStorageBuilder(prIssuesStorage)
1030                                      .updaters(List.of(updater))
1031                                      .build();
1032 
1033             // No mail should be sent on the first run as there is no history
1034             TestBotRunner.runPeriodicItems(notifyBot);
1035             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1036 
1037             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
1038             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1039             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
1040             TestBotRunner.runPeriodicItems(notifyBot);
1041             listServer.processIncoming();
1042 
1043             var conversations = mailmanList.conversations(Duration.ofDays(1));
1044             var email = conversations.get(0).first();
1045             assertEquals(listAddress, email.sender());
1046             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
1047             assertEquals(email.recipients(), List.of(listAddress));
1048             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());
1049             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));
1050             assertTrue(email.hasHeader(&quot;extra1&quot;));
1051             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
1052             assertTrue(email.hasHeader(&quot;extra2&quot;));
1053             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1054 
1055             TestBotRunner.runPeriodicItems(notifyBot);
1056             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1057 
1058             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);
1059             TestBotRunner.runPeriodicItems(notifyBot);
1060             listServer.processIncoming();
1061 
1062             var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()
1063                                              .filter(c -&gt; !c.equals(conversations.get(0)))
1064                                              .findFirst().orElseThrow();
1065             email = newConversation.first();
1066             assertEquals(listAddress, email.sender());
1067             assertEquals(sender, email.author());
1068             assertEquals(email.recipients(), List.of(listAddress));
1069             assertEquals(&quot;git: test: created branch newbranch2 based on the branch newbranch1 containing 0 unique commits&quot;, email.subject());
1070             assertEquals(&quot;The new branch newbranch2 is currently identical to the newbranch1 branch.&quot;, email.body());
1071         }
1072     }
<a name="12" id="anc12"></a>






















































































1073 
1074     @Test
1075     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
1076         try (var listServer = new TestMailmanServer();
1077              var credentials = new HostCredentials(testInfo);
1078              var tempFolder = new TemporaryDirectory()) {
1079             var repo = credentials.getHostedRepository();
1080             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1081             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1082             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1083             credentials.commitLock(localRepo);
1084             localRepo.pushAll(repo.url());
1085 
1086             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1087             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1088             var mailmanList = mailmanServer.getList(listAddress.address());
1089             var tagStorage = createTagStorage(repo);
1090             var branchStorage = createBranchStorage(repo);
1091             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1092             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1093 
1094             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1095             var updater = MailingListUpdater.newBuilder()
1096                                             .list(mailmanList)
1097                                             .recipient(listAddress)
1098                                             .sender(sender)
1099                                             .reportNewTags(false)
1100                                             .reportNewBranches(false)
1101                                             .reportNewBuilds(false)
1102                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1103                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
1104                                             .build();
1105             var notifyBot = NotifyBot.newBuilder()
1106                                      .repository(repo)
1107                                      .storagePath(storageFolder)
1108                                      .branches(Pattern.compile(&quot;master&quot;))
1109                                      .tagStorageBuilder(tagStorage)
1110                                      .branchStorageBuilder(branchStorage)
1111                                      .prIssuesStorageBuilder(prIssuesStorage)
1112                                      .updaters(List.of(updater))
1113                                      .build();
1114 
1115             // No mail should be sent on the first run as there is no history
1116             TestBotRunner.runPeriodicItems(notifyBot);
1117             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1118 
1119             // Save history state
1120             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);
1121 
1122             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1123             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1124             TestBotRunner.runPeriodicItems(notifyBot);
1125             listServer.processIncoming();
1126 
1127             var conversations = mailmanList.conversations(Duration.ofDays(1));
1128             assertEquals(1, conversations.size());
1129 
1130             // Reset the history
1131             localRepo.push(historyHash, repo.url(), &quot;history&quot;, true);
1132             TestBotRunner.runPeriodicItems(notifyBot);
1133             listServer.processIncoming();
1134 
1135             // There should now be a duplicate mail
1136             conversations = mailmanList.conversations(Duration.ofDays(1));
1137             assertEquals(2, conversations.size());
1138         }
1139     }
1140 
1141     @Test
1142     void testIssue(TestInfo testInfo) throws IOException {
1143         try (var credentials = new HostCredentials(testInfo);
1144              var tempFolder = new TemporaryDirectory()) {
1145             var repo = credentials.getHostedRepository();
1146             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1147             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1148             credentials.commitLock(localRepo);
1149             localRepo.pushAll(repo.url());
1150 
1151             var tagStorage = createTagStorage(repo);
1152             var branchStorage = createBranchStorage(repo);
1153             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1154             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1155 
1156             var issueProject = credentials.getIssueProject();
1157             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1158             var updater = IssueUpdater.newBuilder()
1159                                       .issueProject(issueProject)
1160                                       .reviewLink(false)
1161                                       .commitIcon(commitIcon)
1162                                       .setFixVersion(true)
1163                                       .build();
1164             var notifyBot = NotifyBot.newBuilder()
1165                                      .repository(repo)
1166                                      .storagePath(storageFolder)
1167                                      .branches(Pattern.compile(&quot;master&quot;))
1168                                      .tagStorageBuilder(tagStorage)
1169                                      .branchStorageBuilder(branchStorage)
1170                                      .prIssuesStorageBuilder(prIssuesStorage)
1171                                      .updaters(List.of(updater))
1172                                      .build();
1173 
1174             // Initialize history
1175             TestBotRunner.runPeriodicItems(notifyBot);
1176 
1177             // Create an issue and commit a fix
1178             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1179             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1180             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1181             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1182             TestBotRunner.runPeriodicItems(notifyBot);
1183 
1184             // The changeset should be reflected in a comment
1185             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1186 
1187             var comments = updatedIssue.comments();
1188             assertEquals(1, comments.size());
1189             var comment = comments.get(0);
1190             assertTrue(comment.body().contains(editHash.abbreviate()));
1191 
1192             // And in a link
1193             var links = updatedIssue.links();
1194             assertEquals(1, links.size());
1195             var link = links.get(0);
1196             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1197             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1198             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1199 
1200             // As well as a fixVersion
1201             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1202 
1203             // The issue should be assigned and resolved
1204             assertEquals(RESOLVED, updatedIssue.state());
1205             assertEquals(List.of(issueProject.issueTracker().currentUser()), updatedIssue.assignees());
1206         }
1207     }
1208 
1209     @Test
1210     void testIssueNoVersion(TestInfo testInfo) throws IOException {
1211         try (var credentials = new HostCredentials(testInfo);
1212              var tempFolder = new TemporaryDirectory()) {
1213             var repo = credentials.getHostedRepository();
1214             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1215             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1216             credentials.commitLock(localRepo);
1217             localRepo.pushAll(repo.url());
1218 
1219             var tagStorage = createTagStorage(repo);
1220             var branchStorage = createBranchStorage(repo);
1221             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1222             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1223 
1224             var issueProject = credentials.getIssueProject();
1225             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1226             var updater = IssueUpdater.newBuilder()
1227                                       .issueProject(issueProject)
1228                                       .reviewLink(false)
1229                                       .commitIcon(commitIcon)
1230                                       .setFixVersion(true)
1231                                       .build();
1232             var notifyBot = NotifyBot.newBuilder()
1233                                      .repository(repo)
1234                                      .storagePath(storageFolder)
1235                                      .branches(Pattern.compile(&quot;master&quot;))
1236                                      .tagStorageBuilder(tagStorage)
1237                                      .branchStorageBuilder(branchStorage)
1238                                      .prIssuesStorageBuilder(prIssuesStorage)
1239                                      .updaters(List.of(updater))
1240                                      .build();
1241 
1242             // Initialize history
1243             TestBotRunner.runPeriodicItems(notifyBot);
1244 
1245             // Create an issue and commit a fix
1246             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1247             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1248             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1249             TestBotRunner.runPeriodicItems(notifyBot);
1250 
1251             // The changeset should be reflected in a comment
1252             var comments = issue.comments();
1253             assertEquals(1, comments.size());
1254             var comment = comments.get(0);
1255             assertTrue(comment.body().contains(editHash.abbreviate()));
1256 
1257             // But not in the fixVersion
1258             assertEquals(Set.of(), fixVersions(issue));
1259         }
1260     }
1261 
1262     @Test
1263     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
1264         try (var credentials = new HostCredentials(testInfo);
1265              var tempFolder = new TemporaryDirectory()) {
1266             var repo = credentials.getHostedRepository();
1267             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1268             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1269             credentials.commitLock(localRepo);
1270             localRepo.pushAll(repo.url());
1271 
1272             var tagStorage = createTagStorage(repo);
1273             var branchStorage = createBranchStorage(repo);
1274             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1275             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1276 
1277             var issueProject = credentials.getIssueProject();
1278             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1279             var updater = IssueUpdater.newBuilder()
1280                                       .issueProject(issueProject)
1281                                       .reviewLink(false)
1282                                       .commitLink(false)
1283                                       .commitIcon(commitIcon)
1284                                       .setFixVersion(true)
1285                                       .fixVersions(Map.of(&quot;master&quot;, &quot;2.0&quot;))
1286                                       .build();
1287             var notifyBot = NotifyBot.newBuilder()
1288                                      .repository(repo)
1289                                      .storagePath(storageFolder)
1290                                      .branches(Pattern.compile(&quot;master&quot;))
1291                                      .tagStorageBuilder(tagStorage)
1292                                      .branchStorageBuilder(branchStorage)
1293                                      .prIssuesStorageBuilder(prIssuesStorage)
1294                                      .updaters(List.of(updater))
1295                                      .build();
1296 
1297             // Initialize history
1298             TestBotRunner.runPeriodicItems(notifyBot);
1299 
1300             // Create an issue and commit a fix
1301             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1302             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1303             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1304             TestBotRunner.runPeriodicItems(notifyBot);
1305 
1306             // The changeset should not reflected in a comment
1307             var comments = issue.comments();
1308             assertEquals(1, comments.size());
1309             var comment = comments.get(0);
1310             assertTrue(comment.body().contains(editHash.abbreviate()));
1311 
1312             // As well as a fixVersion - but not the one from the repo
1313             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
1314 
1315             // And no commit link
1316             var links = issue.links();
1317             assertEquals(0, links.size());
1318         }
1319     }
1320 
1321     @Test
1322     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1323         try (var credentials = new HostCredentials(testInfo);
1324              var tempFolder = new TemporaryDirectory()) {
1325             var repo = credentials.getHostedRepository();
1326             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1327             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1328             credentials.commitLock(localRepo);
1329             localRepo.pushAll(repo.url());
1330 
1331             var tagStorage = createTagStorage(repo);
1332             var branchStorage = createBranchStorage(repo);
1333             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1334             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1335 
1336             var issueProject = credentials.getIssueProject();
1337             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1338             var updater = IssueUpdater.newBuilder()
1339                                       .issueProject(issueProject)
1340                                       .reviewLink(false)
1341                                       .commitIcon(commitIcon)
1342                                       .setFixVersion(true)
1343                                       .build();
1344             var notifyBot = NotifyBot.newBuilder()
1345                                      .repository(repo)
1346                                      .storagePath(storageFolder)
1347                                      .branches(Pattern.compile(&quot;master&quot;))
1348                                      .tagStorageBuilder(tagStorage)
1349                                      .branchStorageBuilder(branchStorage)
1350                                      .prIssuesStorageBuilder(prIssuesStorage)
1351                                      .updaters(List.of(updater))
1352                                      .build();
1353 
1354             // Initialize history
1355             TestBotRunner.runPeriodicItems(notifyBot);
1356 
1357             // Save the state
1358             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1359 
1360             // Create an issue and commit a fix
1361             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1362             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1363             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1364             TestBotRunner.runPeriodicItems(notifyBot);
1365 
1366             // The changeset should be reflected in a comment
1367             var comments = issue.comments();
1368             assertEquals(1, comments.size());
1369             var comment = comments.get(0);
1370             assertTrue(comment.body().contains(editHash.abbreviate()));
1371 
1372             // And in a link
1373             var links = issue.links();
1374             assertEquals(1, links.size());
1375             var link = links.get(0);
1376             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1377             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1378             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1379 
1380             // As well as a fixVersion
1381             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));
1382 
1383             // Wipe the history
1384             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
1385 
1386             // Run it again
1387             TestBotRunner.runPeriodicItems(notifyBot);
1388 
1389             // There should be no new comments, links or fixVersions
1390             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1391             assertEquals(1, updatedIssue.comments().size());
1392             assertEquals(1, updatedIssue.links().size());
1393             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1394         }
1395     }
1396 
1397     @Test
1398     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1399         try (var credentials = new HostCredentials(testInfo);
1400              var tempFolder = new TemporaryDirectory()) {
1401             var repo = credentials.getHostedRepository();
1402             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1403             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1404             credentials.commitLock(localRepo);
1405             localRepo.pushAll(repo.url());
1406 
1407             var tagStorage = createTagStorage(repo);
1408             var branchStorage = createBranchStorage(repo);
1409             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1410             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1411 
1412             var issueProject = credentials.getIssueProject();
1413             var updater = IssueUpdater.newBuilder()
1414                                       .issueProject(issueProject)
1415                                       .reviewLink(false)
1416                                       .commitLink(false)
1417                                       .setFixVersion(true)
1418                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))
1419                                       .build();
1420             var notifyBot = NotifyBot.newBuilder()
1421                                      .repository(repo)
1422                                      .storagePath(storageFolder)
1423                                      .branches(Pattern.compile(&quot;master&quot;))
1424                                      .tagStorageBuilder(tagStorage)
1425                                      .branchStorageBuilder(branchStorage)
1426                                      .prIssuesStorageBuilder(prIssuesStorage)
1427                                      .updaters(List.of(updater))
1428                                      .build();
1429 
1430             // Initialize history
1431             TestBotRunner.runPeriodicItems(notifyBot);
1432 
1433             // Create an issue and commit a fix
1434             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1435             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1436 
1437             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1438             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1439             TestBotRunner.runPeriodicItems(notifyBot);
1440 
1441             // The fixVersion should have been updated
1442             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1443         }
1444     }
1445 
1446     @Test
1447     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1448         try (var credentials = new HostCredentials(testInfo);
1449              var tempFolder = new TemporaryDirectory()) {
1450             var repo = credentials.getHostedRepository();
1451             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1452             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1453             credentials.commitLock(localRepo);
1454             localRepo.pushAll(repo.url());
1455 
1456             var tagStorage = createTagStorage(repo);
1457             var branchStorage = createBranchStorage(repo);
1458             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1459             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1460 
1461             var issueProject = credentials.getIssueProject();
1462             var updater = IssueUpdater.newBuilder()
1463                                       .issueProject(issueProject)
1464                                       .reviewLink(false)
1465                                       .commitLink(false)
1466                                       .setFixVersion(true)
1467                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))
1468                                       .build();
1469             var notifyBot = NotifyBot.newBuilder()
1470                                      .repository(repo)
1471                                      .storagePath(storageFolder)
1472                                      .branches(Pattern.compile(&quot;master&quot;))
1473                                      .tagStorageBuilder(tagStorage)
1474                                      .branchStorageBuilder(branchStorage)
1475                                      .prIssuesStorageBuilder(prIssuesStorage)
1476                                      .updaters(List.of(updater))
1477                                      .build();
1478 
1479             // Initialize history
1480             TestBotRunner.runPeriodicItems(notifyBot);
1481 
1482             // Create an issue and commit a fix
1483             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1484             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1485 
1486             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1487             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1488             TestBotRunner.runPeriodicItems(notifyBot);
1489 
1490             // The fixVersion should have been updated
1491             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1492         }
1493     }
1494 
1495     @Test
1496     void testIssueBackport(TestInfo testInfo) throws IOException {
1497         try (var credentials = new HostCredentials(testInfo);
1498              var tempFolder = new TemporaryDirectory()) {
1499             var repo = credentials.getHostedRepository();
1500             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1501             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1502             credentials.commitLock(localRepo);
1503             localRepo.pushAll(repo.url());
1504 
1505             var tagStorage = createTagStorage(repo);
1506             var branchStorage = createBranchStorage(repo);
1507             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1508             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1509 
1510             var issueProject = credentials.getIssueProject();
1511             var updater = IssueUpdater.newBuilder()
1512                                       .issueProject(issueProject)
1513                                       .reviewLink(false)
1514                                       .commitLink(false)
1515                                       .setFixVersion(true)
1516                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12.0.2&quot;))
1517                                       .build();
1518             var notifyBot = NotifyBot.newBuilder()
1519                                      .repository(repo)
1520                                      .storagePath(storageFolder)
1521                                      .branches(Pattern.compile(&quot;master&quot;))
1522                                      .tagStorageBuilder(tagStorage)
1523                                      .branchStorageBuilder(branchStorage)
1524                                      .prIssuesStorageBuilder(prIssuesStorage)
1525                                      .updaters(List.of(updater))
1526                                      .build();
1527 
1528             // Initialize history
1529             TestBotRunner.runPeriodicItems(notifyBot);
1530 
1531             // Create an issue and commit a fix
1532             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),
1533                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),
1534                                                         &quot;customfield_10008&quot;, JSON.object()
1535                                                                                  .put(&quot;id&quot;, 244)
1536                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),
1537                                                         &quot;customfield_10005&quot;, JSON.array()
1538                                                                                  .add(JSON.object()
1539                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)
1540                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))
1541                                                                                  .add(JSON.object()
1542                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)
1543                                                                                           .put(&quot;value&quot;, &quot;other&quot;))
1544                                                  ));
1545             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
1546             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
1547 
1548             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1549             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1550             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1551             TestBotRunner.runPeriodicItems(notifyBot);
1552 
1553             // The fixVersion should not have been updated
1554             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1555             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));
1556             assertEquals(OPEN, updatedIssue.state());
1557             assertEquals(List.of(), updatedIssue.assignees());
1558 
1559             // There should be a link
1560             var links = updatedIssue.links();
1561             assertEquals(1, links.size());
1562             var link = links.get(0);
1563             var backport = link.issue().orElseThrow();
1564 
1565             // The backport issue should have a correct fixVersion and assignee
1566             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));
1567             assertEquals(RESOLVED, backport.state());
1568             assertEquals(List.of(issueProject.issueTracker().currentUser()), backport.assignees());
1569 
1570             // Custom properties should also propagate
1571             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());
1572             assertEquals(244, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;id&quot;).asInt());
1573             assertEquals(&quot;java.io&quot;, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;name&quot;).asString());
1574             assertEquals(2, backport.properties().get(&quot;customfield_10005&quot;).asArray().size());
1575         }
1576     }
1577 
1578     @Test
1579     void testPullRequest(TestInfo testInfo) throws IOException {
1580         try (var credentials = new HostCredentials(testInfo);
1581              var tempFolder = new TemporaryDirectory()) {
1582             var repo = credentials.getHostedRepository();
1583             var reviewer = credentials.getHostedRepository();
1584             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1585             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1586             credentials.commitLock(localRepo);
1587             localRepo.pushAll(repo.url());
1588 
1589             var tagStorage = createTagStorage(repo);
1590             var branchStorage = createBranchStorage(repo);
1591             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1592             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1593 
1594             var issueProject = credentials.getIssueProject();
1595             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1596             var updater = IssueUpdater.newBuilder()
1597                                       .issueProject(issueProject)
1598                                       .reviewIcon(reviewIcon)
1599                                       .commitLink(false)
1600                                       .build();
1601             var notifyBot = NotifyBot.newBuilder()
1602                                      .repository(repo)
1603                                      .storagePath(storageFolder)
1604                                      .branches(Pattern.compile(&quot;master&quot;))
1605                                      .tagStorageBuilder(tagStorage)
1606                                      .branchStorageBuilder(branchStorage)
1607                                      .prIssuesStorageBuilder(prIssuesStorage)
1608                                      .prUpdaters(List.of(updater))
1609                                      .readyLabels(Set.of(&quot;rfr&quot;))
1610                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
1611                                      .build();
1612 
1613             // Initialize history
1614             TestBotRunner.runPeriodicItems(notifyBot);
1615 
1616             // Create an issue and a pull request to fix it
1617             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1618             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1619             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1620             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1621             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1622             TestBotRunner.runPeriodicItems(notifyBot);
1623 
1624             // The issue should not yet contain a link to the PR
1625             var links = issue.links();
1626             assertEquals(0, links.size());
1627 
1628             // Just a label isn&#39;t enough
1629             pr.addLabel(&quot;rfr&quot;);
1630             TestBotRunner.runPeriodicItems(notifyBot);
1631             links = issue.links();
1632             assertEquals(0, links.size());
1633 
1634             // Neither is just a comment
1635             pr.removeLabel(&quot;rfr&quot;);
1636             var reviewPr = reviewer.pullRequest(pr.id());
1637             reviewPr.addComment(&quot;This is now ready&quot;);
1638             TestBotRunner.runPeriodicItems(notifyBot);
1639             links = issue.links();
1640             assertEquals(0, links.size());
1641 
1642             // Both are needed
1643             pr.addLabel(&quot;rfr&quot;);
1644             TestBotRunner.runPeriodicItems(notifyBot);
1645 
1646             // The issue should now contain a link to the PR
1647             links = issue.links();
1648             assertEquals(1, links.size());
1649             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1650             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1651 
1652             // Add another issue
1653             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1654             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n * [&quot; + issue2.id() +
1655                                &quot;](http://www.test2.test/): The second issue&quot;);
1656             TestBotRunner.runPeriodicItems(notifyBot);
1657 
1658             // Both issues should contain a link to the PR
1659             var links1 = issue.links();
1660             assertEquals(1, links1.size());
1661             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());
1662             var links2 = issue2.links();
1663             assertEquals(1, links2.size());
1664             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1665 
1666             // Drop the first one
1667             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
1668             TestBotRunner.runPeriodicItems(notifyBot);
1669 
1670             // Only the second issue should now contain a link to the PR
1671             links1 = issue.links();
1672             assertEquals(0, links1.size());
1673             links2 = issue2.links();
1674             assertEquals(1, links2.size());
1675             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1676         }
1677     }
1678 
1679     @Test
1680     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
1681         try (var credentials = new HostCredentials(testInfo);
1682              var tempFolder = new TemporaryDirectory()) {
1683             var repo = credentials.getHostedRepository();
1684             var reviewer = credentials.getHostedRepository();
1685             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1686             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1687             credentials.commitLock(localRepo);
1688             localRepo.pushAll(repo.url());
1689 
1690             var tagStorage = createTagStorage(repo);
1691             var branchStorage = createBranchStorage(repo);
1692             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1693             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1694 
1695             var issueProject = credentials.getIssueProject();
1696             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1697             var updater = IssueUpdater.newBuilder()
1698                                       .issueProject(issueProject)
1699                                       .reviewLink(false)
1700                                       .reviewIcon(reviewIcon)
1701                                       .commitLink(false)
1702                                       .build();
1703             var notifyBot = NotifyBot.newBuilder()
1704                                      .repository(repo)
1705                                      .storagePath(storageFolder)
1706                                      .branches(Pattern.compile(&quot;master&quot;))
1707                                      .tagStorageBuilder(tagStorage)
1708                                      .branchStorageBuilder(branchStorage)
1709                                      .prIssuesStorageBuilder(prIssuesStorage)
1710                                      .prUpdaters(List.of(updater)).readyLabels(Set.of(&quot;rfr&quot;))
1711                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
1712                                      .build();
1713             // Initialize history
1714             TestBotRunner.runPeriodicItems(notifyBot);
1715 
1716             // Create an issue and a pull request to fix it
1717             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1718             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1719             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1720             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1721             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1722             TestBotRunner.runPeriodicItems(notifyBot);
1723 
1724             // Add required label
1725             pr.addLabel(&quot;rfr&quot;);
1726             TestBotRunner.runPeriodicItems(notifyBot);
1727 
1728             // And the required comment
1729             var reviewPr = reviewer.pullRequest(pr.id());
1730             reviewPr.addComment(&quot;This is now ready&quot;);
1731             TestBotRunner.runPeriodicItems(notifyBot);
1732 
1733             // The issue should still not contain a link to the PR
1734             var links = issue.links();
1735             assertEquals(0, links.size());
1736         }
1737     }
1738 
1739     @Test
1740     void testPullRequestPROnly(TestInfo testInfo) throws IOException {
1741         try (var credentials = new HostCredentials(testInfo);
1742              var tempFolder = new TemporaryDirectory()) {
1743             var repo = credentials.getHostedRepository();
1744             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1745             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1746             credentials.commitLock(localRepo);
1747             localRepo.pushAll(repo.url());
1748 
1749             var tagStorage = createTagStorage(repo);
1750             var branchStorage = createBranchStorage(repo);
1751             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1752             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1753 
1754             var issueProject = credentials.getIssueProject();
1755             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1756             var updater = IssueUpdater.newBuilder()
1757                                       .issueProject(issueProject)
1758                                       .reviewIcon(reviewIcon)
1759                                       .commitLink(false)
1760                                       .prOnly(true)
1761                                       .build();
1762             var notifyBot = NotifyBot.newBuilder()
1763                                      .repository(repo)
1764                                      .storagePath(storageFolder)
1765                                      .branches(Pattern.compile(&quot;.*&quot;))
1766                                      .tagStorageBuilder(tagStorage)
1767                                      .branchStorageBuilder(branchStorage)
1768                                      .prIssuesStorageBuilder(prIssuesStorage)
1769                                      .updaters(List.of(updater))
1770                                      .prUpdaters(List.of(updater))
1771                                      .build();
1772 
1773             // Initialize history
1774             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
1775             TestBotRunner.runPeriodicItems(notifyBot);
1776 
1777             // Create an issue and a pull request to fix it
1778             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1779             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1780             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1781             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
1782             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1783             TestBotRunner.runPeriodicItems(notifyBot);
1784 
1785             // The issue should now contain a link to the PR
1786             var links = issue.links();
1787             assertEquals(1, links.size());
1788             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1789             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1790 
1791             // Simulate integration
1792             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
1793             localRepo.push(editHash, repo.url(), &quot;other&quot;);
1794             TestBotRunner.runPeriodicItems(notifyBot);
1795 
1796             // The changeset should be reflected in a comment
1797             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1798 
1799             var comments = updatedIssue.comments();
1800             assertEquals(1, comments.size());
1801             var comment = comments.get(0);
1802             assertTrue(comment.body().contains(editHash.abbreviate()));
1803 
1804             // Now simulate a merge to another branch
1805             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1806             TestBotRunner.runPeriodicItems(notifyBot);
1807 
1808             // No additional comment should have been made
1809             updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1810             comments = updatedIssue.comments();
1811             assertEquals(1, comments.size());
1812         }
1813     }
1814 
1815     private static class TestRepositoryUpdateConsumer implements RepositoryUpdateConsumer {
1816         private final String name;
1817         private final boolean idempotent;
1818         private int updateCount = 0;
1819         private boolean shouldFail = false;
1820 
1821         TestRepositoryUpdateConsumer(String name, boolean idempotent) {
1822             this.name = name;
1823             this.idempotent = idempotent;
1824         }
1825 
1826         @Override
1827         public void handleCommits(HostedRepository repository, Repository localRepository, List&lt;Commit&gt; commits,
1828                                   Branch branch) throws NonRetriableException {
1829             updateCount++;
1830             if (shouldFail) {
1831                 if (idempotent) {
1832                     throw new RuntimeException(&quot;induced failure&quot;);
1833                 } else {
1834                     throw new NonRetriableException(new RuntimeException(&quot;unretriable failure&quot;));
1835                 }
1836             }
1837         }
1838 
1839         @Override
1840         public void handleOpenJDKTagCommits(HostedRepository repository, Repository localRepository,
1841          List&lt;Commit&gt; commits, OpenJDKTag tag, Tag.Annotated annotated) {
1842             throw new RuntimeException(&quot;unexpected&quot;);
1843         }
1844 
1845         @Override
1846         public void handleTagCommit(HostedRepository repository, Repository localRepository, Commit commit, Tag tag,
1847          Tag.Annotated annotation) {
1848             throw new RuntimeException(&quot;unexpected&quot;);
1849         }
1850 
1851         @Override
1852         public void handleNewBranch(HostedRepository repository, Repository localRepository, List&lt;Commit&gt; commits,
1853          Branch parent, Branch branch) {
1854             throw new RuntimeException(&quot;unexpected&quot;);
1855         }
1856 
1857         @Override
1858         public String name() {
1859             return name;
1860         }
1861     }
1862 
1863     @Test
1864     void testIdempotenceMix(TestInfo testInfo) throws IOException {
1865         try (var credentials = new HostCredentials(testInfo);
1866              var tempFolder = new TemporaryDirectory()) {
1867             var repo = credentials.getHostedRepository();
1868             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1869             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1870             credentials.commitLock(localRepo);
1871             localRepo.pushAll(repo.url());
1872 
1873             var tagStorage = createTagStorage(repo);
1874             var branchStorage = createBranchStorage(repo);
1875             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1876             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1877 
1878             var idempotent = new TestRepositoryUpdateConsumer(&quot;i&quot;, true);
1879             var nonIdempotent = new TestRepositoryUpdateConsumer(&quot;ni&quot;, false);
1880             var notifyBot = NotifyBot.newBuilder()
1881                                      .repository(repo)
1882                                      .storagePath(storageFolder)
1883                                      .branches(Pattern.compile(&quot;master&quot;))
1884                                      .tagStorageBuilder(tagStorage)
1885                                      .branchStorageBuilder(branchStorage)
1886                                      .prIssuesStorageBuilder(prIssuesStorage)
1887                                      .updaters(List.of(idempotent, nonIdempotent))
1888                                      .build();
1889 
1890             // Initialize history
1891             TestBotRunner.runPeriodicItems(notifyBot);
1892 
1893             // Create an issue and commit a fix
1894             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix stuff&quot;);
1895             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1896             TestBotRunner.runPeriodicItems(notifyBot);
1897 
1898             // Both updaters should have run
1899             assertEquals(1, idempotent.updateCount);
1900             assertEquals(1, nonIdempotent.updateCount);
1901 
1902             var nextEditHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;Fix more stuff&quot;);
1903             localRepo.push(nextEditHash, repo.url(), &quot;master&quot;);
1904 
1905             idempotent.shouldFail = true;
1906             nonIdempotent.shouldFail = true;
1907             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(notifyBot));
1908 
1909             // Both updaters should have run again
1910             assertEquals(2, idempotent.updateCount);
1911             assertEquals(2, nonIdempotent.updateCount);
1912 
1913             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(notifyBot));
1914 
1915             // But now only the idempotent one should have been retried
1916             assertEquals(3, idempotent.updateCount);
1917             assertEquals(2, nonIdempotent.updateCount);
1918         }
1919     }
1920 }
<a name="13" id="anc13"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="13" type="hidden" />
</body>
</html>