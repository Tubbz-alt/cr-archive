<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff cli/src/main/java/org/openjdk/skara/cli/GitWebrev.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitWebrev.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.cli;
 24 
 25 import org.openjdk.skara.args.*;
 26 import org.openjdk.skara.proxy.HttpProxy;
 27 import org.openjdk.skara.vcs.*;
 28 import org.openjdk.skara.webrev.*;
 29 import org.openjdk.skara.version.Version;
 30 
 31 import java.io.*;
 32 import java.net.URI;
 33 import java.net.URISyntaxException;
 34 import java.net.http.HttpClient;
 35 import java.net.http.HttpRequest;
 36 import java.net.http.HttpResponse;
 37 import java.nio.file.*;
 38 import java.util.*;

 39 import java.util.regex.Pattern;
 40 import java.util.stream.Collectors;
 41 
 42 public class GitWebrev {
 43     private static final List&lt;String&gt; KNOWN_JBS_PROJECTS =
 44         List.of(&quot;JDK&quot;, &quot;CODETOOLS&quot;, &quot;SKARA&quot;, &quot;JMC&quot;);
 45     private static void clearDirectory(Path directory) {
 46         try {
 47             Files.walk(directory)
 48                     .map(Path::toFile)
 49                     .sorted(Comparator.reverseOrder())
 50                     .forEach(File::delete);
 51         } catch (IOException io) {
 52             throw new RuntimeException(io);
 53         }
 54     }
 55 
 56     private static String arg(String name, Arguments args, ReadOnlyRepository repo) throws IOException {
 57         if (args.contains(name)) {
 58             return args.get(name).asString();
</pre>
<hr />
<pre>
125                   .fullname(&quot;remote&quot;)
126                   .describe(&quot;NAME&quot;)
127                   .helptext(&quot;Use remote to calculate outgoing changes&quot;)
128                   .optional(),
129             Switch.shortcut(&quot;b&quot;)
130                   .fullname(&quot;&quot;)
131                   .helptext(&quot;Do not ignore changes in whitespace (always true)&quot;)
132                   .optional(),
133             Switch.shortcut(&quot;m&quot;)
134                   .fullname(&quot;mercurial&quot;)
135                   .helptext(&quot;Deprecated: force use of mercurial&quot;)
136                   .optional(),
137             Switch.shortcut(&quot;C&quot;)
138                   .fullname(&quot;no-comments&quot;)
139                   .helptext(&quot;Don&#39;t show comments&quot;)
140                   .optional(),
141             Switch.shortcut(&quot;N&quot;)
142                   .fullname(&quot;no-outgoing&quot;)
143                   .helptext(&quot;Do not compare against remote, use only &#39;status&#39;&quot;)
144                   .optional(),








145             Switch.shortcut(&quot;v&quot;)
146                   .fullname(&quot;version&quot;)
147                   .helptext(&quot;Print the version of this tool&quot;)
148                   .optional());
149 
150         var inputs = List.of(
151             Input.position(0)
152                  .describe(&quot;FILE&quot;)
153                  .singular()
154                  .optional());
155 
156         var parser = new ArgumentParser(&quot;git webrev&quot;, flags, inputs);
157         var arguments = parser.parse(args);
158 
159         var version = Version.fromManifest().orElse(&quot;unknown&quot;);
160         if (arguments.contains(&quot;version&quot;)) {
161             System.out.println(&quot;git-webrev version: &quot; + version);
162             System.exit(0);
163         }
164 





165         var cwd = Paths.get(&quot;&quot;).toAbsolutePath();
166         var repository = Repository.get(cwd);
167         if (!repository.isPresent()) {
168             System.err.println(String.format(&quot;error: %s is not a repository&quot;, cwd.toString()));
169             System.exit(1);
170         }
171         var repo = repository.get();
172         var isMercurial = arguments.contains(&quot;mercurial&quot;);
173 
174         var upstream = arg(&quot;upstream&quot;, arguments, repo);
175         if (upstream == null) {
176             var remotes = repo.remotes();
177             if (remotes.contains(&quot;upstream&quot;)) {
178                 var pullPath = Remote.toWebURI(repo.pullPath(&quot;upstream&quot;));
179                 var host = pullPath.getHost();
180                 if (host != null &amp;&amp; host.endsWith(&quot;openjdk.java.net&quot;)) {
181                     upstream = pullPath.toString();
182                 } else if (host != null &amp;&amp; host.equals(&quot;github.com&quot;)) {
183                     var path = pullPath.getPath();
184                     if (path != null &amp;&amp; path.startsWith(&quot;/openjdk/&quot;)) {
</pre>
<hr />
<pre>
234                             if (remotes.size() == 0) {
235                                 System.err.println(&quot;error: no remotes present, cannot figure out outgoing changes&quot;);
236                                 System.err.println(&quot;       Use --rev to specify revision to compare against&quot;);
237                                 System.exit(1);
238                             } else if (remotes.size() == 1) {
239                                 remote = remotes.get(0);
240                             } else {
241                                 if (remotes.contains(&quot;origin&quot;)) {
242                                     remote = &quot;origin&quot;;
243                                 } else {
244                                     System.err.println(&quot;error: multiple remotes without origin remote present, cannot figure out outgoing changes&quot;);
245                                     System.err.println(&quot;       Use --rev to specify revision to compare against&quot;);
246                                     System.exit(1);
247                                 }
248                             }
249                         }
250 
251                         var head = repo.head();
252                         var shortestDistance = -1;
253                         var pullPath = repo.pullPath(remote);
<span class="line-modified">254                         var remoteBranches = repo.remoteBranches(remote);</span>
<span class="line-modified">255                         for (var remoteBranch : remoteBranches) {</span>
<span class="line-modified">256                             var fetchHead = repo.fetch(URI.create(pullPath), remoteBranch.name());</span>
<span class="line-removed">257                             var mergeBase = repo.mergeBase(fetchHead, head);</span>
258                             var distance = repo.commitMetadata(mergeBase, head).size();
259                             if (shortestDistance == -1 || distance &lt; shortestDistance) {
260                                 rev = mergeBase;
261                                 shortestDistance = distance;
262                             }
263                         }
264                     }
265                 }
266             }
267         }
268 
269         var issue = arguments.contains(&quot;cr&quot;) ? arguments.get(&quot;cr&quot;).asString() : null;
270         if (issue != null) {
271             if (issue.startsWith(&quot;http&quot;)) {
272                 var uri = URI.create(issue);
273                 issue = Path.of(uri.getPath()).getFileName().toString();
274             } else if (isDigit(issue.charAt(0))) {
275                 issue = &quot;JDK-&quot; + issue;
276             }
277         }
</pre>
</td>
<td>
<hr />
<pre>
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.cli;
 24 
 25 import org.openjdk.skara.args.*;
 26 import org.openjdk.skara.proxy.HttpProxy;
 27 import org.openjdk.skara.vcs.*;
 28 import org.openjdk.skara.webrev.*;
 29 import org.openjdk.skara.version.Version;
 30 
 31 import java.io.*;
 32 import java.net.URI;
 33 import java.net.URISyntaxException;
 34 import java.net.http.HttpClient;
 35 import java.net.http.HttpRequest;
 36 import java.net.http.HttpResponse;
 37 import java.nio.file.*;
 38 import java.util.*;
<span class="line-added"> 39 import java.util.logging.Level;</span>
 40 import java.util.regex.Pattern;
 41 import java.util.stream.Collectors;
 42 
 43 public class GitWebrev {
 44     private static final List&lt;String&gt; KNOWN_JBS_PROJECTS =
 45         List.of(&quot;JDK&quot;, &quot;CODETOOLS&quot;, &quot;SKARA&quot;, &quot;JMC&quot;);
 46     private static void clearDirectory(Path directory) {
 47         try {
 48             Files.walk(directory)
 49                     .map(Path::toFile)
 50                     .sorted(Comparator.reverseOrder())
 51                     .forEach(File::delete);
 52         } catch (IOException io) {
 53             throw new RuntimeException(io);
 54         }
 55     }
 56 
 57     private static String arg(String name, Arguments args, ReadOnlyRepository repo) throws IOException {
 58         if (args.contains(name)) {
 59             return args.get(name).asString();
</pre>
<hr />
<pre>
126                   .fullname(&quot;remote&quot;)
127                   .describe(&quot;NAME&quot;)
128                   .helptext(&quot;Use remote to calculate outgoing changes&quot;)
129                   .optional(),
130             Switch.shortcut(&quot;b&quot;)
131                   .fullname(&quot;&quot;)
132                   .helptext(&quot;Do not ignore changes in whitespace (always true)&quot;)
133                   .optional(),
134             Switch.shortcut(&quot;m&quot;)
135                   .fullname(&quot;mercurial&quot;)
136                   .helptext(&quot;Deprecated: force use of mercurial&quot;)
137                   .optional(),
138             Switch.shortcut(&quot;C&quot;)
139                   .fullname(&quot;no-comments&quot;)
140                   .helptext(&quot;Don&#39;t show comments&quot;)
141                   .optional(),
142             Switch.shortcut(&quot;N&quot;)
143                   .fullname(&quot;no-outgoing&quot;)
144                   .helptext(&quot;Do not compare against remote, use only &#39;status&#39;&quot;)
145                   .optional(),
<span class="line-added">146             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">147                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">148                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">149                   .optional(),</span>
<span class="line-added">150             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">151                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">152                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">153                   .optional(),</span>
154             Switch.shortcut(&quot;v&quot;)
155                   .fullname(&quot;version&quot;)
156                   .helptext(&quot;Print the version of this tool&quot;)
157                   .optional());
158 
159         var inputs = List.of(
160             Input.position(0)
161                  .describe(&quot;FILE&quot;)
162                  .singular()
163                  .optional());
164 
165         var parser = new ArgumentParser(&quot;git webrev&quot;, flags, inputs);
166         var arguments = parser.parse(args);
167 
168         var version = Version.fromManifest().orElse(&quot;unknown&quot;);
169         if (arguments.contains(&quot;version&quot;)) {
170             System.out.println(&quot;git-webrev version: &quot; + version);
171             System.exit(0);
172         }
173 
<span class="line-added">174         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {</span>
<span class="line-added">175             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;</span>
<span class="line-added">176             Logging.setup(level);</span>
<span class="line-added">177         }</span>
<span class="line-added">178 </span>
179         var cwd = Paths.get(&quot;&quot;).toAbsolutePath();
180         var repository = Repository.get(cwd);
181         if (!repository.isPresent()) {
182             System.err.println(String.format(&quot;error: %s is not a repository&quot;, cwd.toString()));
183             System.exit(1);
184         }
185         var repo = repository.get();
186         var isMercurial = arguments.contains(&quot;mercurial&quot;);
187 
188         var upstream = arg(&quot;upstream&quot;, arguments, repo);
189         if (upstream == null) {
190             var remotes = repo.remotes();
191             if (remotes.contains(&quot;upstream&quot;)) {
192                 var pullPath = Remote.toWebURI(repo.pullPath(&quot;upstream&quot;));
193                 var host = pullPath.getHost();
194                 if (host != null &amp;&amp; host.endsWith(&quot;openjdk.java.net&quot;)) {
195                     upstream = pullPath.toString();
196                 } else if (host != null &amp;&amp; host.equals(&quot;github.com&quot;)) {
197                     var path = pullPath.getPath();
198                     if (path != null &amp;&amp; path.startsWith(&quot;/openjdk/&quot;)) {
</pre>
<hr />
<pre>
248                             if (remotes.size() == 0) {
249                                 System.err.println(&quot;error: no remotes present, cannot figure out outgoing changes&quot;);
250                                 System.err.println(&quot;       Use --rev to specify revision to compare against&quot;);
251                                 System.exit(1);
252                             } else if (remotes.size() == 1) {
253                                 remote = remotes.get(0);
254                             } else {
255                                 if (remotes.contains(&quot;origin&quot;)) {
256                                     remote = &quot;origin&quot;;
257                                 } else {
258                                     System.err.println(&quot;error: multiple remotes without origin remote present, cannot figure out outgoing changes&quot;);
259                                     System.err.println(&quot;       Use --rev to specify revision to compare against&quot;);
260                                     System.exit(1);
261                                 }
262                             }
263                         }
264 
265                         var head = repo.head();
266                         var shortestDistance = -1;
267                         var pullPath = repo.pullPath(remote);
<span class="line-modified">268                         for (var branch : repo.branches(remote)) {</span>
<span class="line-modified">269                             var branchHead = repo.resolve(branch).orElseThrow();</span>
<span class="line-modified">270                             var mergeBase = repo.mergeBase(branchHead, head);</span>

271                             var distance = repo.commitMetadata(mergeBase, head).size();
272                             if (shortestDistance == -1 || distance &lt; shortestDistance) {
273                                 rev = mergeBase;
274                                 shortestDistance = distance;
275                             }
276                         }
277                     }
278                 }
279             }
280         }
281 
282         var issue = arguments.contains(&quot;cr&quot;) ? arguments.get(&quot;cr&quot;).asString() : null;
283         if (issue != null) {
284             if (issue.startsWith(&quot;http&quot;)) {
285                 var uri = URI.create(issue);
286                 issue = Path.of(uri.getPath()).getFileName().toString();
287             } else if (isDigit(issue.charAt(0))) {
288                 issue = &quot;JDK-&quot; + issue;
289             }
290         }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>