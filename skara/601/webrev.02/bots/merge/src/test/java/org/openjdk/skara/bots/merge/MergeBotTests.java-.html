<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.merge;
 24 
 25 import org.openjdk.skara.host.*;
 26 import org.openjdk.skara.test.*;
 27 import org.openjdk.skara.vcs.*;
 28 
 29 import org.junit.jupiter.api.Test;
 30 import org.junit.jupiter.api.TestInfo;
 31 
 32 import java.io.IOException;
 33 import java.nio.file.Files;
 34 import java.nio.file.StandardOpenOption;
 35 import java.util.*;
 36 import java.util.stream.Collectors;
 37 import java.time.DayOfWeek;
 38 import java.time.Month;
 39 import java.time.ZonedDateTime;
 40 import java.time.ZoneId;
 41 
 42 import static org.junit.jupiter.api.Assertions.*;
 43 
 44 class MergeBotTests {
 45     @Test
 46     void mergeMasterBranch(TestInfo testInfo) throws IOException {
 47         try (var temp = new TemporaryDirectory()) {
 48             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 49 
 50             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 51             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 52             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 53 
 54             var toDir = temp.path().resolve(&quot;to.git&quot;);
 55             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 56             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 57             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 58                         StandardOpenOption.APPEND);
 59             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 60 
 61             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 62             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 63             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 64             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 65                         StandardOpenOption.APPEND);
 66             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 67 
 68             var now = ZonedDateTime.now();
 69             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 70             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 71             fromLocalRepo.add(fromFileA);
 72             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 73             var fromCommits = fromLocalRepo.commits().asList();
 74             assertEquals(1, fromCommits.size());
 75             assertEquals(fromHashA, fromCommits.get(0).hash());
 76 
 77             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 78             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 79             toLocalRepo.add(toFileA);
 80             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 81             var toCommits = toLocalRepo.commits().asList();
 82             assertEquals(1, toCommits.size());
 83             assertEquals(toHashA, toCommits.get(0).hash());
 84             assertEquals(fromHashA, toHashA);
 85 
 86             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 87             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 88             fromLocalRepo.add(fromFileB);
 89             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 90 
 91             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 92             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 93             toLocalRepo.add(toFileC);
 94             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 95 
 96             var storage = temp.path().resolve(&quot;storage&quot;);
 97             var master = new Branch(&quot;master&quot;);
 98             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 99             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
100             TestBotRunner.runPeriodicItems(bot);
101 
102             toCommits = toLocalRepo.commits().asList();
103             assertEquals(4, toCommits.size());
104             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
105             assertTrue(hashes.contains(toHashA));
106             assertTrue(hashes.contains(fromHashB));
107             assertTrue(hashes.contains(toHashC));
108 
109             var known = Set.of(toHashA, fromHashB, toHashC);
110             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
111             assertTrue(merge.isMerge());
112             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
113             assertEquals(&quot;duke&quot;, merge.author().name());
114             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
115 
116             assertEquals(0, toHostedRepo.pullRequests().size());
117         }
118     }
119 
120     @Test
121     void failingMergeTest(TestInfo testInfo) throws IOException {
122         try (var temp = new TemporaryDirectory()) {
123             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
124 
125             var fromDir = temp.path().resolve(&quot;from.git&quot;);
126             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
127             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
128 
129             var toDir = temp.path().resolve(&quot;to.git&quot;);
130             var toLocalRepo = Repository.init(toDir, VCS.GIT);
131             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
132             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
133                         StandardOpenOption.APPEND);
134             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
135 
136             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
137             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
138             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
139             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
140                         StandardOpenOption.APPEND);
141             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
142 
143             var now = ZonedDateTime.now();
144             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
145             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
146             fromLocalRepo.add(fromFileA);
147             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
148             var fromCommits = fromLocalRepo.commits().asList();
149             assertEquals(1, fromCommits.size());
150             assertEquals(fromHashA, fromCommits.get(0).hash());
151 
152             var toFileA = toDir.resolve(&quot;a.txt&quot;);
153             Files.writeString(toFileA, &quot;Hello A\n&quot;);
154             toLocalRepo.add(toFileA);
155             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
156             var toCommits = toLocalRepo.commits().asList();
157             assertEquals(1, toCommits.size());
158             assertEquals(toHashA, toCommits.get(0).hash());
159             assertEquals(fromHashA, toHashA);
160 
161             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
162             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
163             fromLocalRepo.add(fromFileB);
164             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
165 
166             var toFileB = toDir.resolve(&quot;b.txt&quot;);
167             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
168             toLocalRepo.add(toFileB);
169             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
170 
171             var storage = temp.path().resolve(&quot;storage&quot;);
172             var master = new Branch(&quot;master&quot;);
173             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
174             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
175             TestBotRunner.runPeriodicItems(bot);
176 
177             toCommits = toLocalRepo.commits().asList();
178             assertEquals(2, toCommits.size());
179             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
180             assertTrue(toHashes.contains(toHashA));
181             assertTrue(toHashes.contains(toHashB));
182 
183             var pullRequests = toHostedRepo.pullRequests();
184             assertEquals(1, pullRequests.size());
185             var pr = pullRequests.get(0);
186             assertEquals(&quot;Merge test:master&quot;, pr.title());
187             assertTrue(pr.labels().contains(&quot;failed-auto-merge&quot;));
188         }
189     }
190 
191     @Test
192     void failingMergeShouldResultInOnlyOnePR(TestInfo testInfo) throws IOException {
193         try (var temp = new TemporaryDirectory()) {
194             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
195 
196             var fromDir = temp.path().resolve(&quot;from.git&quot;);
197             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
198             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
199 
200             var toDir = temp.path().resolve(&quot;to.git&quot;);
201             var toLocalRepo = Repository.init(toDir, VCS.GIT);
202             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
203             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
204                         StandardOpenOption.APPEND);
205             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
206 
207             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
208             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
209             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
210             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
211                         StandardOpenOption.APPEND);
212             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
213 
214             var now = ZonedDateTime.now();
215             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
216             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
217             fromLocalRepo.add(fromFileA);
218             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
219             var fromCommits = fromLocalRepo.commits().asList();
220             assertEquals(1, fromCommits.size());
221             assertEquals(fromHashA, fromCommits.get(0).hash());
222 
223             var toFileA = toDir.resolve(&quot;a.txt&quot;);
224             Files.writeString(toFileA, &quot;Hello A\n&quot;);
225             toLocalRepo.add(toFileA);
226             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
227             var toCommits = toLocalRepo.commits().asList();
228             assertEquals(1, toCommits.size());
229             assertEquals(toHashA, toCommits.get(0).hash());
230             assertEquals(fromHashA, toHashA);
231 
232             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
233             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
234             fromLocalRepo.add(fromFileB);
235             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
236 
237             var toFileB = toDir.resolve(&quot;b.txt&quot;);
238             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
239             toLocalRepo.add(toFileB);
240             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
241 
242             var storage = temp.path().resolve(&quot;storage&quot;);
243             var master = new Branch(&quot;master&quot;);
244             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
245             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
246             TestBotRunner.runPeriodicItems(bot);
247             TestBotRunner.runPeriodicItems(bot);
248 
249             toCommits = toLocalRepo.commits().asList();
250             assertEquals(2, toCommits.size());
251             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
252             assertTrue(toHashes.contains(toHashA));
253             assertTrue(toHashes.contains(toHashB));
254 
255             var pullRequests = toHostedRepo.pullRequests();
256             assertEquals(1, pullRequests.size());
257             var pr = pullRequests.get(0);
258             assertEquals(&quot;Merge test:master&quot;, pr.title());
259         }
260     }
261 
262     @Test
263     void resolvedMergeConflictShouldResultInIntegrateCommand(TestInfo testInfo) throws IOException {
264         try (var temp = new TemporaryDirectory()) {
265             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
266 
267             var fromDir = temp.path().resolve(&quot;from.git&quot;);
268             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
269             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
270 
271             var toDir = temp.path().resolve(&quot;to.git&quot;);
272             var toLocalRepo = Repository.init(toDir, VCS.GIT);
273             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
274             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
275                         StandardOpenOption.APPEND);
276             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
277 
278             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
279             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
280             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
281             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
282                         StandardOpenOption.APPEND);
283             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
284 
285             var now = ZonedDateTime.now();
286             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
287             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
288             fromLocalRepo.add(fromFileA);
289             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
290             var fromCommits = fromLocalRepo.commits().asList();
291             assertEquals(1, fromCommits.size());
292             assertEquals(fromHashA, fromCommits.get(0).hash());
293 
294             var toFileA = toDir.resolve(&quot;a.txt&quot;);
295             Files.writeString(toFileA, &quot;Hello A\n&quot;);
296             toLocalRepo.add(toFileA);
297             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
298             var toCommits = toLocalRepo.commits().asList();
299             assertEquals(1, toCommits.size());
300             assertEquals(toHashA, toCommits.get(0).hash());
301             assertEquals(fromHashA, toHashA);
302 
303             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
304             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
305             fromLocalRepo.add(fromFileB);
306             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
307 
308             var toFileB = toDir.resolve(&quot;b.txt&quot;);
309             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
310             toLocalRepo.add(toFileB);
311             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
312 
313             var storage = temp.path().resolve(&quot;storage&quot;);
314             var master = new Branch(&quot;master&quot;);
315             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
316             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
317             TestBotRunner.runPeriodicItems(bot);
318             TestBotRunner.runPeriodicItems(bot);
319 
320             toCommits = toLocalRepo.commits().asList();
321             assertEquals(2, toCommits.size());
322             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
323             assertTrue(toHashes.contains(toHashA));
324             assertTrue(toHashes.contains(toHashB));
325 
326             var pullRequests = toHostedRepo.pullRequests();
327             assertEquals(1, pullRequests.size());
328             var pr = pullRequests.get(0);
329             assertEquals(&quot;Merge test:master&quot;, pr.title());
330             assertTrue(pr.labels().contains(&quot;failed-auto-merge&quot;));
331             assertTrue(forkLocalRepo.branches().contains(new Branch(&quot;master&quot;)));
332             assertTrue(forkLocalRepo.branches().contains(new Branch(&quot;1&quot;)));
333 
334             // Bot should do nothing as long as PR is presnt
335             TestBotRunner.runPeriodicItems(bot);
336             pullRequests = toHostedRepo.pullRequests();
337             assertEquals(1, pullRequests.size());
338             pr = pullRequests.get(0);
339 
340             // Simulate that the merge-conflict has been resolved by adding the &quot;ready&quot; label
341             pr.addLabel(&quot;ready&quot;);
342             TestBotRunner.runPeriodicItems(bot);
343             pullRequests = toHostedRepo.pullRequests();
344             assertEquals(1, pullRequests.size());
345 
346             pr = pullRequests.get(0);
347             var numComments = pr.comments().size();
348             var lastComment = pr.comments().get(pr.comments().size() - 1);
349             assertEquals(&quot;/integrate&quot;, lastComment.body());
350 
351             // Running the bot again should not result in another comment
352             TestBotRunner.runPeriodicItems(bot);
353             assertEquals(numComments, toHostedRepo.pullRequests().size());
354         }
355     }
356 
357     final static class TestClock implements Clock {
358         ZonedDateTime now;
359 
360         TestClock() {
361             this(null);
362         }
363 
364         TestClock(ZonedDateTime now) {
365             this.now = now;
366         }
367 
368         @Override
369         public ZonedDateTime now() {
370             return now;
371         }
372     }
373 
374     @Test
375     void testMergeHourly(TestInfo testInfo) throws IOException {
376         try (var temp = new TemporaryDirectory()) {
377             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
378 
379             var fromDir = temp.path().resolve(&quot;from.git&quot;);
380             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
381             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
382 
383             var toDir = temp.path().resolve(&quot;to.git&quot;);
384             var toLocalRepo = Repository.init(toDir, VCS.GIT);
385             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
386             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
387                         StandardOpenOption.APPEND);
388             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
389 
390             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
391             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
392             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
393             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
394                         StandardOpenOption.APPEND);
395             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
396 
397             var now = ZonedDateTime.now();
398             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
399             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
400             fromLocalRepo.add(fromFileA);
401             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
402             var fromCommits = fromLocalRepo.commits().asList();
403             assertEquals(1, fromCommits.size());
404             assertEquals(fromHashA, fromCommits.get(0).hash());
405 
406             var toFileA = toDir.resolve(&quot;a.txt&quot;);
407             Files.writeString(toFileA, &quot;Hello A\n&quot;);
408             toLocalRepo.add(toFileA);
409             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
410             var toCommits = toLocalRepo.commits().asList();
411             assertEquals(1, toCommits.size());
412             assertEquals(toHashA, toCommits.get(0).hash());
413             assertEquals(fromHashA, toHashA);
414 
415             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
416             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
417             fromLocalRepo.add(fromFileB);
418             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
419 
420             var toFileC = toDir.resolve(&quot;c.txt&quot;);
421             Files.writeString(toFileC, &quot;Hello C\n&quot;);
422             toLocalRepo.add(toFileC);
423             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
424 
425             var storage = temp.path().resolve(&quot;storage&quot;);
426             var master = new Branch(&quot;master&quot;);
427 
428             // Merge only at most once during the first minute every hour
429             var freq = MergeBot.Spec.Frequency.hourly(1);
430             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
431 
432             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 15, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
433             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
434 
435             TestBotRunner.runPeriodicItems(bot);
436 
437             // Ensure nothing has been merged
438             toCommits = toLocalRepo.commits().asList();
439             assertEquals(2, toCommits.size());
440             assertEquals(toHashC, toCommits.get(0).hash());
441             assertEquals(toHashA, toCommits.get(1).hash());
442 
443             // Set the clock to the first minute of the hour
444             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
445             TestBotRunner.runPeriodicItems(bot);
446 
447             // Should have merged
448             toCommits = toLocalRepo.commits().asList();
449             assertEquals(4, toCommits.size());
450             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
451             assertTrue(hashes.contains(toHashA));
452             assertTrue(hashes.contains(fromHashB));
453             assertTrue(hashes.contains(toHashC));
454 
455             var known = Set.of(toHashA, fromHashB, toHashC);
456             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
457             assertTrue(merge.isMerge());
458             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
459             assertEquals(&quot;duke&quot;, merge.author().name());
460             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
461 
462             assertEquals(0, toHostedRepo.pullRequests().size());
463 
464             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
465             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
466             fromLocalRepo.add(fromFileD);
467             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
468 
469             // Since the time hasn&#39;t changed it should not merge again
470             TestBotRunner.runPeriodicItems(bot);
471             toCommits = toLocalRepo.commits().asList();
472             assertEquals(4, toCommits.size());
473 
474             // Move the minutes forward, the bot should not merge
475             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
476             TestBotRunner.runPeriodicItems(bot);
477             toCommits = toLocalRepo.commits().asList();
478             assertEquals(4, toCommits.size());
479 
480             // Move the clock forward one hour, the bot should merge
481             clock.now = ZonedDateTime.of(2020, 1, 23, 16, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
482             TestBotRunner.runPeriodicItems(bot);
483 
484             toCommits = toLocalRepo.commits().asList();
485             assertEquals(6, toCommits.size());
486         }
487     }
488 
489     @Test
490     void testMergeDaily(TestInfo testInfo) throws IOException {
491         try (var temp = new TemporaryDirectory()) {
492             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
493 
494             var fromDir = temp.path().resolve(&quot;from.git&quot;);
495             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
496             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
497 
498             var toDir = temp.path().resolve(&quot;to.git&quot;);
499             var toLocalRepo = Repository.init(toDir, VCS.GIT);
500             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
501             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
502                         StandardOpenOption.APPEND);
503             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
504 
505             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
506             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
507             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
508             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
509                         StandardOpenOption.APPEND);
510             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
511 
512             var now = ZonedDateTime.now();
513             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
514             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
515             fromLocalRepo.add(fromFileA);
516             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
517             var fromCommits = fromLocalRepo.commits().asList();
518             assertEquals(1, fromCommits.size());
519             assertEquals(fromHashA, fromCommits.get(0).hash());
520 
521             var toFileA = toDir.resolve(&quot;a.txt&quot;);
522             Files.writeString(toFileA, &quot;Hello A\n&quot;);
523             toLocalRepo.add(toFileA);
524             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
525             var toCommits = toLocalRepo.commits().asList();
526             assertEquals(1, toCommits.size());
527             assertEquals(toHashA, toCommits.get(0).hash());
528             assertEquals(fromHashA, toHashA);
529 
530             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
531             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
532             fromLocalRepo.add(fromFileB);
533             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
534 
535             var toFileC = toDir.resolve(&quot;c.txt&quot;);
536             Files.writeString(toFileC, &quot;Hello C\n&quot;);
537             toLocalRepo.add(toFileC);
538             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
539 
540             var storage = temp.path().resolve(&quot;storage&quot;);
541             var master = new Branch(&quot;master&quot;);
542 
543             // Merge only at most once during the third hour every day
544             var freq = MergeBot.Spec.Frequency.daily(3);
545             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
546 
547             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 2, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
548             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
549 
550             TestBotRunner.runPeriodicItems(bot);
551 
552             // Ensure nothing has been merged
553             toCommits = toLocalRepo.commits().asList();
554             assertEquals(2, toCommits.size());
555             assertEquals(toHashC, toCommits.get(0).hash());
556             assertEquals(toHashA, toCommits.get(1).hash());
557 
558             // Set the clock to the third hour of the day (minutes should not matter)
559             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
560             TestBotRunner.runPeriodicItems(bot);
561 
562             // Should have merged
563             toCommits = toLocalRepo.commits().asList();
564             assertEquals(4, toCommits.size());
565             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
566             assertTrue(hashes.contains(toHashA));
567             assertTrue(hashes.contains(fromHashB));
568             assertTrue(hashes.contains(toHashC));
569 
570             var known = Set.of(toHashA, fromHashB, toHashC);
571             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
572             assertTrue(merge.isMerge());
573             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
574             assertEquals(&quot;duke&quot;, merge.author().name());
575             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
576 
577             assertEquals(0, toHostedRepo.pullRequests().size());
578 
579             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
580             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
581             fromLocalRepo.add(fromFileD);
582             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
583 
584             // Since the time hasn&#39;t changed it should not merge
585             TestBotRunner.runPeriodicItems(bot);
586             toCommits = toLocalRepo.commits().asList();
587             assertEquals(4, toCommits.size());
588 
589             // Move the minutes forward, the bot should not merge
590             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
591             TestBotRunner.runPeriodicItems(bot);
592             toCommits = toLocalRepo.commits().asList();
593             assertEquals(4, toCommits.size());
594 
595             // Move the hours forward, the bot should not merge
596             clock.now = ZonedDateTime.of(2020, 1, 23, 17, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
597             TestBotRunner.runPeriodicItems(bot);
598             toCommits = toLocalRepo.commits().asList();
599             assertEquals(4, toCommits.size());
600 
601             // Move the clock forward one day, the bot should merge
602             clock.now = ZonedDateTime.of(2020, 1, 24, 3, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
603             TestBotRunner.runPeriodicItems(bot);
604 
605             toCommits = toLocalRepo.commits().asList();
606             assertEquals(6, toCommits.size());
607         }
608     }
609 
610     @Test
611     void testMergeWeekly(TestInfo testInfo) throws IOException {
612         try (var temp = new TemporaryDirectory()) {
613             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
614 
615             var fromDir = temp.path().resolve(&quot;from.git&quot;);
616             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
617             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
618 
619             var toDir = temp.path().resolve(&quot;to.git&quot;);
620             var toLocalRepo = Repository.init(toDir, VCS.GIT);
621             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
622             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
623                         StandardOpenOption.APPEND);
624             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
625 
626             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
627             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
628             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
629             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
630                         StandardOpenOption.APPEND);
631             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
632 
633             var now = ZonedDateTime.now();
634             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
635             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
636             fromLocalRepo.add(fromFileA);
637             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
638             var fromCommits = fromLocalRepo.commits().asList();
639             assertEquals(1, fromCommits.size());
640             assertEquals(fromHashA, fromCommits.get(0).hash());
641 
642             var toFileA = toDir.resolve(&quot;a.txt&quot;);
643             Files.writeString(toFileA, &quot;Hello A\n&quot;);
644             toLocalRepo.add(toFileA);
645             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
646             var toCommits = toLocalRepo.commits().asList();
647             assertEquals(1, toCommits.size());
648             assertEquals(toHashA, toCommits.get(0).hash());
649             assertEquals(fromHashA, toHashA);
650 
651             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
652             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
653             fromLocalRepo.add(fromFileB);
654             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
655 
656             var toFileC = toDir.resolve(&quot;c.txt&quot;);
657             Files.writeString(toFileC, &quot;Hello C\n&quot;);
658             toLocalRepo.add(toFileC);
659             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
660 
661             var storage = temp.path().resolve(&quot;storage&quot;);
662             var master = new Branch(&quot;master&quot;);
663 
664             // Merge only at most once per week on Friday&#39;s at 12:00
665             var freq = MergeBot.Spec.Frequency.weekly(DayOfWeek.FRIDAY, 12);
666             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
667 
668             var clock = new TestClock(ZonedDateTime.of(2020, 1, 24, 11, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
669             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
670 
671             TestBotRunner.runPeriodicItems(bot);
672 
673             // Ensure nothing has been merged
674             toCommits = toLocalRepo.commits().asList();
675             assertEquals(2, toCommits.size());
676             assertEquals(toHashC, toCommits.get(0).hash());
677             assertEquals(toHashA, toCommits.get(1).hash());
678 
679             // Set the clock to the 12th hour of the day (minutes should not matter)
680             clock.now = ZonedDateTime.of(2020, 1, 24, 12, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
681             TestBotRunner.runPeriodicItems(bot);
682 
683             // Should have merged
684             toCommits = toLocalRepo.commits().asList();
685             assertEquals(4, toCommits.size());
686             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
687             assertTrue(hashes.contains(toHashA));
688             assertTrue(hashes.contains(fromHashB));
689             assertTrue(hashes.contains(toHashC));
690 
691             var known = Set.of(toHashA, fromHashB, toHashC);
692             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
693             assertTrue(merge.isMerge());
694             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
695             assertEquals(&quot;duke&quot;, merge.author().name());
696             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
697 
698             assertEquals(0, toHostedRepo.pullRequests().size());
699 
700             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
701             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
702             fromLocalRepo.add(fromFileD);
703             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
704 
705             // Since the time hasn&#39;t changed it should not merge
706             TestBotRunner.runPeriodicItems(bot);
707             toCommits = toLocalRepo.commits().asList();
708             assertEquals(4, toCommits.size());
709 
710             // Move the hours forward, the bot should not merge
711             clock.now = ZonedDateTime.of(2020, 1, 24, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
712             TestBotRunner.runPeriodicItems(bot);
713             toCommits = toLocalRepo.commits().asList();
714             assertEquals(4, toCommits.size());
715 
716             // Move the days forward, the bot should not merge
717             clock.now = ZonedDateTime.of(2020, 1, 25, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
718             TestBotRunner.runPeriodicItems(bot);
719             toCommits = toLocalRepo.commits().asList();
720             assertEquals(4, toCommits.size());
721 
722             // Move the clock forward one week, the bot should merge
723             clock.now = ZonedDateTime.of(2020, 1, 31, 12, 29, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
724             TestBotRunner.runPeriodicItems(bot);
725 
726             toCommits = toLocalRepo.commits().asList();
727             assertEquals(6, toCommits.size());
728         }
729     }
730 
731     @Test
732     void testMergeMonthly(TestInfo testInfo) throws IOException {
733         try (var temp = new TemporaryDirectory()) {
734             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
735 
736             var fromDir = temp.path().resolve(&quot;from.git&quot;);
737             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
738             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
739 
740             var toDir = temp.path().resolve(&quot;to.git&quot;);
741             var toLocalRepo = Repository.init(toDir, VCS.GIT);
742             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
743             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
744                         StandardOpenOption.APPEND);
745             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
746 
747             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
748             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
749             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
750             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
751                         StandardOpenOption.APPEND);
752             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
753 
754             var now = ZonedDateTime.now();
755             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
756             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
757             fromLocalRepo.add(fromFileA);
758             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
759             var fromCommits = fromLocalRepo.commits().asList();
760             assertEquals(1, fromCommits.size());
761             assertEquals(fromHashA, fromCommits.get(0).hash());
762 
763             var toFileA = toDir.resolve(&quot;a.txt&quot;);
764             Files.writeString(toFileA, &quot;Hello A\n&quot;);
765             toLocalRepo.add(toFileA);
766             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
767             var toCommits = toLocalRepo.commits().asList();
768             assertEquals(1, toCommits.size());
769             assertEquals(toHashA, toCommits.get(0).hash());
770             assertEquals(fromHashA, toHashA);
771 
772             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
773             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
774             fromLocalRepo.add(fromFileB);
775             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
776 
777             var toFileC = toDir.resolve(&quot;c.txt&quot;);
778             Files.writeString(toFileC, &quot;Hello C\n&quot;);
779             toLocalRepo.add(toFileC);
780             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
781 
782             var storage = temp.path().resolve(&quot;storage&quot;);
783             var master = new Branch(&quot;master&quot;);
784 
785             // Merge only at most once per month on the 17th day at at 11:00
786             var freq = MergeBot.Spec.Frequency.monthly(17, 11);
787             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
788 
789             var clock = new TestClock(ZonedDateTime.of(2020, 1, 16, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
790             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
791 
792             TestBotRunner.runPeriodicItems(bot);
793 
794             // Ensure nothing has been merged
795             toCommits = toLocalRepo.commits().asList();
796             assertEquals(2, toCommits.size());
797             assertEquals(toHashC, toCommits.get(0).hash());
798             assertEquals(toHashA, toCommits.get(1).hash());
799 
800             // Set the clock to the 17th day and at hour 11 (minutes should not matter)
801             clock.now = ZonedDateTime.of(2020, 1, 17, 11, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
802             TestBotRunner.runPeriodicItems(bot);
803 
804             // Should have merged
805             toCommits = toLocalRepo.commits().asList();
806             assertEquals(4, toCommits.size());
807             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
808             assertTrue(hashes.contains(toHashA));
809             assertTrue(hashes.contains(fromHashB));
810             assertTrue(hashes.contains(toHashC));
811 
812             var known = Set.of(toHashA, fromHashB, toHashC);
813             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
814             assertTrue(merge.isMerge());
815             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
816             assertEquals(&quot;duke&quot;, merge.author().name());
817             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
818 
819             assertEquals(0, toHostedRepo.pullRequests().size());
820 
821             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
822             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
823             fromLocalRepo.add(fromFileD);
824             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
825 
826             // Since the time hasn&#39;t changed it should not merge
827             TestBotRunner.runPeriodicItems(bot);
828             toCommits = toLocalRepo.commits().asList();
829             assertEquals(4, toCommits.size());
830 
831             // Move the hours forward, the bot should not merge
832             clock.now = ZonedDateTime.of(2020, 1, 17, 12, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
833             TestBotRunner.runPeriodicItems(bot);
834             toCommits = toLocalRepo.commits().asList();
835             assertEquals(4, toCommits.size());
836 
837             // Move the days forward, the bot should not merge
838             clock.now = ZonedDateTime.of(2020, 1, 18, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
839             TestBotRunner.runPeriodicItems(bot);
840             toCommits = toLocalRepo.commits().asList();
841             assertEquals(4, toCommits.size());
842 
843             // Move the clock forward one month, the bot should merge
844             clock.now = ZonedDateTime.of(2020, 2, 17, 11, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
845             TestBotRunner.runPeriodicItems(bot);
846 
847             toCommits = toLocalRepo.commits().asList();
848             assertEquals(6, toCommits.size());
849         }
850     }
851 
852     @Test
853     void testMergeYearly(TestInfo testInfo) throws IOException {
854         try (var temp = new TemporaryDirectory()) {
855             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
856 
857             var fromDir = temp.path().resolve(&quot;from.git&quot;);
858             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
859             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
860 
861             var toDir = temp.path().resolve(&quot;to.git&quot;);
862             var toLocalRepo = Repository.init(toDir, VCS.GIT);
863             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
864             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
865                         StandardOpenOption.APPEND);
866             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
867 
868             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
869             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
870             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
871             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
872                         StandardOpenOption.APPEND);
873             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
874 
875             var now = ZonedDateTime.now();
876             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
877             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
878             fromLocalRepo.add(fromFileA);
879             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
880             var fromCommits = fromLocalRepo.commits().asList();
881             assertEquals(1, fromCommits.size());
882             assertEquals(fromHashA, fromCommits.get(0).hash());
883 
884             var toFileA = toDir.resolve(&quot;a.txt&quot;);
885             Files.writeString(toFileA, &quot;Hello A\n&quot;);
886             toLocalRepo.add(toFileA);
887             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
888             var toCommits = toLocalRepo.commits().asList();
889             assertEquals(1, toCommits.size());
890             assertEquals(toHashA, toCommits.get(0).hash());
891             assertEquals(fromHashA, toHashA);
892 
893             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
894             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
895             fromLocalRepo.add(fromFileB);
896             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
897 
898             var toFileC = toDir.resolve(&quot;c.txt&quot;);
899             Files.writeString(toFileC, &quot;Hello C\n&quot;);
900             toLocalRepo.add(toFileC);
901             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
902 
903             var storage = temp.path().resolve(&quot;storage&quot;);
904             var master = new Branch(&quot;master&quot;);
905 
906             // Merge only at most once per year on the 29th day of May at at 07:00
907             var freq = MergeBot.Spec.Frequency.yearly(Month.MAY, 29, 07);
908             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
909 
910             var clock = new TestClock(ZonedDateTime.of(2020, 5, 27, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
911             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
912 
913             TestBotRunner.runPeriodicItems(bot);
914 
915             // Ensure nothing has been merged
916             toCommits = toLocalRepo.commits().asList();
917             assertEquals(2, toCommits.size());
918             assertEquals(toHashC, toCommits.get(0).hash());
919             assertEquals(toHashA, toCommits.get(1).hash());
920 
921             // Set the clock to the 29th of May and at hour 11 (minutes should not matter)
922             clock.now = ZonedDateTime.of(2020, 5, 29, 7, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
923             TestBotRunner.runPeriodicItems(bot);
924 
925             // Should have merged
926             toCommits = toLocalRepo.commits().asList();
927             assertEquals(4, toCommits.size());
928             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
929             assertTrue(hashes.contains(toHashA));
930             assertTrue(hashes.contains(fromHashB));
931             assertTrue(hashes.contains(toHashC));
932 
933             var known = Set.of(toHashA, fromHashB, toHashC);
934             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
935             assertTrue(merge.isMerge());
936             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
937             assertEquals(&quot;duke&quot;, merge.author().name());
938             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
939 
940             assertEquals(0, toHostedRepo.pullRequests().size());
941 
942             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
943             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
944             fromLocalRepo.add(fromFileD);
945             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
946 
947             // Since the time hasn&#39;t changed it should not merge again
948             TestBotRunner.runPeriodicItems(bot);
949             toCommits = toLocalRepo.commits().asList();
950             assertEquals(4, toCommits.size());
951 
952             // Move the hours forward, the bot should not merge
953             clock.now = ZonedDateTime.of(2020, 5, 29, 8, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
954             TestBotRunner.runPeriodicItems(bot);
955             toCommits = toLocalRepo.commits().asList();
956             assertEquals(4, toCommits.size());
957 
958             // Move the days forward, the bot should not merge
959             clock.now = ZonedDateTime.of(2020, 5, 30, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
960             TestBotRunner.runPeriodicItems(bot);
961             toCommits = toLocalRepo.commits().asList();
962             assertEquals(4, toCommits.size());
963 
964             // Move the months forward, the bot should not merge
965             clock.now = ZonedDateTime.of(2020, 7, 29, 7, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
966             TestBotRunner.runPeriodicItems(bot);
967             toCommits = toLocalRepo.commits().asList();
968             assertEquals(4, toCommits.size());
969 
970             // Move the clock forward one year, the bot should merge
971             clock.now = ZonedDateTime.of(2021, 5, 29, 7, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
972             TestBotRunner.runPeriodicItems(bot);
973 
974             toCommits = toLocalRepo.commits().asList();
975             assertEquals(6, toCommits.size());
976         }
977     }
978 }
    </pre>
  </body>
</html>