<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.network.URIBuilder;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Repository;
  32 
  33 import org.junit.jupiter.api.*;
  34 
  35 import java.io.IOException;
  36 import java.nio.charset.StandardCharsets;
  37 import java.nio.file.*;
  38 import java.time.*;
  39 import java.util.*;
  40 import java.util.logging.Logger;
  41 import java.util.regex.Pattern;
  42 import java.util.stream.Collectors;
  43 
  44 import static org.junit.jupiter.api.Assertions.*;
  45 
  46 class MailingListBridgeBotTests {
  47     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  48 
  49     private Optional&lt;String&gt; archiveContents(Path archive) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return Optional.empty();
  54             }
  55             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  56         } catch (IOException e) {
  57             return Optional.empty();
  58         }
  59 
  60     }
  61 
  62     private boolean archiveContains(Path archive, String text) {
  63         return archiveContainsCount(archive, text) &gt; 0;
  64     }
  65 
  66     private int archiveContainsCount(Path archive, String text) {
  67         var lines = archiveContents(archive);
  68         if (lines.isEmpty()) {
  69             return 0;
  70         }
  71         var pattern = Pattern.compile(text);
  72         int count = 0;
  73         for (var line : lines.get().split(&quot;\\R&quot;)) {
  74             var matcher = pattern.matcher(line);
  75             if (matcher.find()) {
  76                 count++;
  77             }
  78         }
  79         return count;
  80     }
  81 
  82     private boolean webrevContains(Path webrev, String text) {
  83         try {
  84             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  85             if (index.isEmpty()) {
  86                 return false;
  87             }
  88             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  89             return lines.contains(text);
  90         } catch (IOException e) {
  91             return false;
  92         }
  93     }
  94 
  95     private long countSubstrings(String string, String substring) {
  96         return Pattern.compile(substring).matcher(string).results().count();
  97     }
  98 
  99     private String noreplyAddress(HostedRepository repository) {
 100         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
 101                 repository.forge().currentUser().userName() +
 102                 &quot;@openjdk.java.net&quot;;
 103     }
 104 
 105     @Test
 106     void simpleArchive(TestInfo testInfo) throws IOException {
 107         try (var credentials = new HostCredentials(testInfo);
 108              var tempFolder = new TemporaryDirectory();
 109              var archiveFolder = new TemporaryDirectory();
 110              var webrevFolder = new TemporaryDirectory();
 111              var listServer = new TestMailmanServer();
 112              var webrevServer = new TestWebrevServer()) {
 113             var author = credentials.getHostedRepository();
 114             var archive = credentials.getHostedRepository();
 115             var ignored = credentials.getHostedRepository();
 116             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 117             var censusBuilder = credentials.getCensusBuilder()
 118                                            .addAuthor(author.forge().currentUser().id());
 119             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 120             var mlBot = MailingListBridgeBot.newBuilder()
 121                                             .from(from)
 122                                             .repo(author)
 123                                             .archive(archive)
 124                                             .censusRepo(censusBuilder.build())
 125                                             .list(listAddress)
 126                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 127                                             .ignoredComments(Set.of())
 128                                             .listArchive(listServer.getArchive())
 129                                             .smtpServer(listServer.getSMTP())
 130                                             .webrevStorageRepository(archive)
 131                                             .webrevStorageRef(&quot;webrev&quot;)
 132                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 133                                             .webrevStorageBaseUri(webrevServer.uri())
 134                                             .readyLabels(Set.of(&quot;rfr&quot;))
 135                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 137                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 138                                             .sendInterval(Duration.ZERO)
 139                                             .build();
 140 
 141             // Populate the projects repository
 142             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 143             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 144             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 145             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 146 
 147             // Make a change with a corresponding PR
 148             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 149                                                                &quot;Change msg\n\nWith several lines&quot;);
 150             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 151             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 152             pr.setBody(&quot;This should not be ready&quot;);
 153 
 154             // Run an archive pass
 155             TestBotRunner.runPeriodicItems(mlBot);
 156 
 157             // A PR that isn&#39;t ready for review should not be archived
 158             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 159             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 160 
 161             // Flag it as ready for review
 162             pr.setBody(&quot;This should now be ready&quot;);
 163             pr.addLabel(&quot;rfr&quot;);
 164 
 165             // Run another archive pass
 166             TestBotRunner.runPeriodicItems(mlBot);
 167 
 168             // But it should still not be archived
 169             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 170             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 171 
 172             // Now post a general comment - not a ready marker
 173             var ignoredPr = ignored.pullRequest(pr.id());
 174             ignoredPr.addComment(&quot;hello there&quot;);
 175 
 176             // Run another archive pass
 177             TestBotRunner.runPeriodicItems(mlBot);
 178 
 179             // It should still not be archived
 180             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 181             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 182 
 183             // Now post a ready comment
 184             ignoredPr.addComment(&quot;ready&quot;);
 185 
 186             // Run another archive pass
 187             TestBotRunner.runPeriodicItems(mlBot);
 188 
 189             // The archive should now contain an entry
 190             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 196             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 197             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 198             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 201             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));
 202             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 203 
 204             // The mailing list as well
 205             listServer.processIncoming();
 206             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 207             var mailmanList = mailmanServer.getList(listAddress.address());
 208             var conversations = mailmanList.conversations(Duration.ofDays(1));
 209             assertEquals(1, conversations.size());
 210             var mail = conversations.get(0).first();
 211             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 212             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 213             assertEquals(noreplyAddress(archive), mail.author().address());
 214             assertEquals(listAddress, mail.sender());
 215             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 216             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 217 
 218             // And there should be a webrev
 219             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 220             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 221             var comments = pr.comments();
 222             var webrevComments = comments.stream()
 223                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 224                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 225                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 226                                          .collect(Collectors.toList());
 227             assertEquals(1, webrevComments.size());
 228 
 229             // Add a comment
 230             pr.addComment(&quot;This is a comment :smile:&quot;);
 231 
 232             // Add a comment from an ignored user as well
 233             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 234 
 235             // Run another archive pass
 236             TestBotRunner.runPeriodicItems(mlBot);
 237 
 238             // The archive should now contain the comment, but not the ignored one
 239             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 240             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 241             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 242             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 243 
 244             listServer.processIncoming();
 245             conversations = mailmanList.conversations(Duration.ofDays(1));
 246             assertEquals(1, conversations.size());
 247             assertEquals(2, conversations.get(0).allMessages().size());
 248 
 249             // Remove the rfr flag and post another comment
 250             pr.addLabel(&quot;rfr&quot;);
 251             pr.addComment(&quot;This is another comment&quot;);
 252 
 253             // Run another archive pass
 254             TestBotRunner.runPeriodicItems(mlBot);
 255 
 256             // The archive should contain the additional comment
 257             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 258             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 259             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 260 
 261             listServer.processIncoming();
 262             conversations = mailmanList.conversations(Duration.ofDays(1));
 263             assertEquals(1, conversations.size());
 264             assertEquals(3, conversations.get(0).allMessages().size());
 265             for (var newMail : conversations.get(0).allMessages()) {
 266                 assertEquals(noreplyAddress(archive), newMail.author().address());
 267                 assertEquals(listAddress, newMail.sender());
 268             }
 269             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment 😄&quot;));
 270         }
 271     }
 272 
 273     @Test
 274     void archiveIntegrated(TestInfo testInfo) throws IOException {
 275         try (var credentials = new HostCredentials(testInfo);
 276              var tempFolder = new TemporaryDirectory();
 277              var archiveFolder = new TemporaryDirectory();
 278              var webrevFolder = new TemporaryDirectory();
 279              var listServer = new TestMailmanServer();
 280              var webrevServer = new TestWebrevServer()) {
 281             var author = credentials.getHostedRepository();
 282             var archive = credentials.getHostedRepository();
 283             var ignored = credentials.getHostedRepository();
 284             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 285             var censusBuilder = credentials.getCensusBuilder()
 286                                            .addAuthor(author.forge().currentUser().id());
 287             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 288             var mlBot = MailingListBridgeBot.newBuilder()
 289                                             .from(from)
 290                                             .repo(author)
 291                                             .archive(archive)
 292                                             .censusRepo(censusBuilder.build())
 293                                             .list(listAddress)
 294                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 295                                             .listArchive(listServer.getArchive())
 296                                             .smtpServer(listServer.getSMTP())
 297                                             .webrevStorageRepository(archive)
 298                                             .webrevStorageRef(&quot;webrev&quot;)
 299                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 300                                             .webrevStorageBaseUri(webrevServer.uri())
 301                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 302                                             .build();
 303 
 304             // Populate the projects repository
 305             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 306             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 307             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 308             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 309 
 310             // Make a change with a corresponding PR
 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 312                                                                &quot;Change msg\n\nWith several lines&quot;);
 313             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 314             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 315             pr.setBody(&quot;This should not be ready&quot;);
 316             pr.setState(Issue.State.CLOSED);
 317 
 318             // Run an archive pass
 319             TestBotRunner.runPeriodicItems(mlBot);
 320             TestBotRunner.runPeriodicItems(mlBot);
 321 
 322             // A PR that isn&#39;t ready for review should not be archived
 323             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 324             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 325 
 326             // Flag it as ready for review
 327             pr.setBody(&quot;This has already been integrated&quot;);
 328             pr.addLabel(&quot;integrated&quot;);
 329 
 330             // Run another archive pass
 331             TestBotRunner.runPeriodicItems(mlBot);
 332 
 333             // The archive should now contain an entry
 334             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 335             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: FYI: 1234: This is a pull request&quot;));
 336 
 337             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 338             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 339 
 340             // Run another archive pass
 341             TestBotRunner.runPeriodicItems(mlBot);
 342 
 343             // The archive should now contain another entry
 344             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 345             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] FYI: 1234: This is a pull request&quot;));
 346             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 347         }
 348     }
 349 
 350     @Test
 351     void archiveIntegratedRetainPrefix(TestInfo testInfo) throws IOException {
 352         try (var credentials = new HostCredentials(testInfo);
 353              var tempFolder = new TemporaryDirectory();
 354              var archiveFolder = new TemporaryDirectory();
 355              var webrevFolder = new TemporaryDirectory();
 356              var listServer = new TestMailmanServer();
 357              var webrevServer = new TestWebrevServer()) {
 358             var author = credentials.getHostedRepository();
 359             var archive = credentials.getHostedRepository();
 360             var ignored = credentials.getHostedRepository();
 361             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 362             var censusBuilder = credentials.getCensusBuilder()
 363                                            .addAuthor(author.forge().currentUser().id());
 364             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 365             var mlBot = MailingListBridgeBot.newBuilder()
 366                                             .from(from)
 367                                             .repo(author)
 368                                             .archive(archive)
 369                                             .censusRepo(censusBuilder.build())
 370                                             .list(listAddress)
 371                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 372                                             .listArchive(listServer.getArchive())
 373                                             .smtpServer(listServer.getSMTP())
 374                                             .webrevStorageRepository(archive)
 375                                             .webrevStorageRef(&quot;webrev&quot;)
 376                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 377                                             .webrevStorageBaseUri(webrevServer.uri())
 378                                             .readyLabels(Set.of(&quot;rfr&quot;))
 379                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 380                                             .build();
 381 
 382             // Populate the projects repository
 383             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 384             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 385             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 386             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 387 
 388             // Make a change with a corresponding PR
 389             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 390                                                                &quot;Change msg\n\nWith several lines&quot;);
 391             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 392             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 393             pr.setBody(&quot;This should be ready&quot;);
 394 
 395             // Run an archive pass
 396             TestBotRunner.runPeriodicItems(mlBot);
 397             TestBotRunner.runPeriodicItems(mlBot);
 398 
 399             // A PR that isn&#39;t ready for review should not be archived
 400             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 401             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 402 
 403             // Flag it as ready for review
 404             pr.addLabel(&quot;rfr&quot;);
 405 
 406             // Run another archive pass
 407             TestBotRunner.runPeriodicItems(mlBot);
 408 
 409             // The archive should now contain an entry
 410             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 411             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 412 
 413             // Close it and then push another change
 414             pr.setState(Issue.State.CLOSED);
 415             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 416             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 417 
 418             // Run another archive pass
 419             TestBotRunner.runPeriodicItems(mlBot);
 420 
 421             // The archive should now contain another entry - should retain the RFR thread prefix
 422             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 423             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] RFR: 1234: This is a pull request&quot;));
 424         }
 425     }
 426 
 427     @Test
 428     void archiveClosed(TestInfo testInfo) throws IOException {
 429         try (var credentials = new HostCredentials(testInfo);
 430              var tempFolder = new TemporaryDirectory();
 431              var archiveFolder = new TemporaryDirectory();
 432              var webrevFolder = new TemporaryDirectory();
 433              var listServer = new TestMailmanServer();
 434              var webrevServer = new TestWebrevServer()) {
 435             var author = credentials.getHostedRepository();
 436             var archive = credentials.getHostedRepository();
 437             var ignored = credentials.getHostedRepository();
 438             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 439             var censusBuilder = credentials.getCensusBuilder()
 440                                            .addAuthor(author.forge().currentUser().id());
 441             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 442             var mlBot = MailingListBridgeBot.newBuilder()
 443                                             .from(from)
 444                                             .repo(author)
 445                                             .archive(archive)
 446                                             .censusRepo(censusBuilder.build())
 447                                             .list(listAddress)
 448                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 449                                             .listArchive(listServer.getArchive())
 450                                             .smtpServer(listServer.getSMTP())
 451                                             .webrevStorageRepository(archive)
 452                                             .webrevStorageRef(&quot;webrev&quot;)
 453                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 454                                             .webrevStorageBaseUri(webrevServer.uri())
 455                                             .readyLabels(Set.of(&quot;rfr&quot;))
 456                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 457                                             .build();
 458 
 459             // Populate the projects repository
 460             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 461             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 462             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 463             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 464 
 465             // Make a change with a corresponding PR
 466             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 467                                                                &quot;Change msg\n\nWith several lines&quot;);
 468             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 469             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 470             pr.setBody(&quot;This should be ready&quot;);
 471 
 472             // Run an archive pass
 473             TestBotRunner.runPeriodicItems(mlBot);
 474             TestBotRunner.runPeriodicItems(mlBot);
 475 
 476             // A PR that isn&#39;t ready for review should not be archived
 477             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 478             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 479 
 480             // Flag it as ready for review
 481             pr.addLabel(&quot;rfr&quot;);
 482 
 483             // Run another archive pass
 484             TestBotRunner.runPeriodicItems(mlBot);
 485 
 486             // The archive should now contain an entry
 487             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 488             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 489 
 490             // Close it
 491             pr.setState(Issue.State.CLOSED);
 492 
 493             // Run another archive pass
 494             TestBotRunner.runPeriodicItems(mlBot);
 495 
 496             // The archive should now contain another entry - should say that it is closed
 497             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 498             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Re: \\[Closed\\] RFR: 1234: This is a pull request&quot;));
 499 
 500             pr.addComment(&quot;Fair enough&quot;);
 501 
 502             // Run another archive pass - only a single close notice should have been posted
 503             TestBotRunner.runPeriodicItems(mlBot);
 504             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 505             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Re: \\[Closed\\] RFR: 1234: This is a pull request&quot;));
 506         }
 507     }
 508 
 509     @Test
 510     void archiveFailedAutoMerge(TestInfo testInfo) throws IOException {
 511         try (var credentials = new HostCredentials(testInfo);
 512              var tempFolder = new TemporaryDirectory();
 513              var archiveFolder = new TemporaryDirectory();
 514              var webrevFolder = new TemporaryDirectory();
 515              var listServer = new TestMailmanServer();
 516              var webrevServer = new TestWebrevServer()) {
 517             var author = credentials.getHostedRepository();
 518             var archive = credentials.getHostedRepository();
 519             var ignored = credentials.getHostedRepository();
 520             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 521             var censusBuilder = credentials.getCensusBuilder()
 522                                            .addAuthor(author.forge().currentUser().id());
 523             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 524             var mlBot = MailingListBridgeBot.newBuilder()
 525                                             .from(from)
 526                                             .repo(author)
 527                                             .archive(archive)
 528                                             .censusRepo(censusBuilder.build())
 529                                             .list(listAddress)
 530                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 531                                             .listArchive(listServer.getArchive())
 532                                             .smtpServer(listServer.getSMTP())
 533                                             .webrevStorageRepository(archive)
 534                                             .webrevStorageRef(&quot;webrev&quot;)
 535                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 536                                             .webrevStorageBaseUri(webrevServer.uri())
 537                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 538                                             .build();
 539 
 540             // Populate the projects repository
 541             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 542             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 543             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 544             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 545 
 546             // Make a change with a corresponding PR
 547             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 548                                                                &quot;Change msg\n\nWith several lines&quot;);
 549             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 550             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Cannot automatically merge&quot;);
 551             pr.setBody(&quot;This is an automated merge PR&quot;);
 552             pr.addLabel(&quot;failed-auto-merge&quot;);
 553 
 554             // Run an archive pass
 555             TestBotRunner.runPeriodicItems(mlBot);
 556             TestBotRunner.runPeriodicItems(mlBot);
 557 
 558             // The archive should contain an entry
 559             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 560             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Cannot automatically merge&quot;));
 561         }
 562     }
 563 
 564     @Test
 565     void reviewComment(TestInfo testInfo) throws IOException {
 566         try (var credentials = new HostCredentials(testInfo);
 567              var tempFolder = new TemporaryDirectory();
 568              var archiveFolder = new TemporaryDirectory();
 569              var listServer = new TestMailmanServer();
 570              var webrevServer = new TestWebrevServer()) {
 571             var author = credentials.getHostedRepository();
 572             var archive = credentials.getHostedRepository();
 573             var ignored = credentials.getHostedRepository();
 574             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 575             var censusBuilder = credentials.getCensusBuilder()
 576                                            .addAuthor(author.forge().currentUser().id());
 577             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 578             var mlBot = MailingListBridgeBot.newBuilder()
 579                                             .from(from)
 580                                             .repo(author)
 581                                             .archive(archive)
 582                                             .censusRepo(censusBuilder.build())
 583                                             .list(listAddress)
 584                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 585                                             .listArchive(listServer.getArchive())
 586                                             .smtpServer(listServer.getSMTP())
 587                                             .webrevStorageRepository(archive)
 588                                             .webrevStorageRef(&quot;webrev&quot;)
 589                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 590                                             .webrevStorageBaseUri(webrevServer.uri())
 591                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 592                                             .build();
 593 
 594             // Populate the projects repository
 595             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 596             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 597             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 598             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 599             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 600 
 601             // Make a change with a corresponding PR
 602             var editHash = CheckableRepository.appendAndCommit(localRepo);
 603             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 604             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 605             pr.setBody(&quot;This is now ready&quot;);
 606             TestBotRunner.runPeriodicItems(mlBot);
 607             listServer.processIncoming();
 608 
 609             // And make a file specific comment
 610             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 611             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 612 
 613             // Add one from an ignored user as well
 614             var ignoredPr = ignored.pullRequest(pr.id());
 615             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 616 
 617             // Process comments
 618             TestBotRunner.runPeriodicItems(mlBot);
 619             listServer.processIncoming();
 620 
 621             // The archive should now contain an entry
 622             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 623             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 624             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 625             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 626             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 627             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 628             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 629 
 630             // The mailing list as well
 631             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 632             var mailmanList = mailmanServer.getList(listAddress.address());
 633             var conversations = mailmanList.conversations(Duration.ofDays(1));
 634             assertEquals(1, conversations.size());
 635             var mail = conversations.get(0).first();
 636             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 637 
 638             // Comment on the comment
 639             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 640             TestBotRunner.runPeriodicItems(mlBot);
 641             listServer.processIncoming();
 642 
 643             // The archive should contain the additional comment (but no quoted footers)
 644             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 645             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 646             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 647             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 648 
 649             // As well as the mailing list
 650             conversations = mailmanList.conversations(Duration.ofDays(1));
 651             assertEquals(1, conversations.size());
 652             assertEquals(3, conversations.get(0).allMessages().size());
 653             for (var newMail : conversations.get(0).allMessages()) {
 654                 assertEquals(noreplyAddress(archive), newMail.author().address());
 655                 assertEquals(listAddress, newMail.sender());
 656             }
 657         }
 658     }
 659 
 660     @Test
 661     void combineComments(TestInfo testInfo) throws IOException {
 662         try (var credentials = new HostCredentials(testInfo);
 663              var tempFolder = new TemporaryDirectory();
 664              var archiveFolder = new TemporaryDirectory();
 665              var listServer = new TestMailmanServer();
 666              var webrevServer = new TestWebrevServer()) {
 667             var author = credentials.getHostedRepository();
 668             var archive = credentials.getHostedRepository();
 669             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 670             var censusBuilder = credentials.getCensusBuilder()
 671                                            .addAuthor(author.forge().currentUser().id());
 672             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 673             var mlBot = MailingListBridgeBot.newBuilder()
 674                                             .from(from)
 675                                             .repo(author)
 676                                             .archive(archive)
 677                                             .censusRepo(censusBuilder.build())
 678                                             .list(listAddress)
 679                                             .listArchive(listServer.getArchive())
 680                                             .smtpServer(listServer.getSMTP())
 681                                             .webrevStorageRepository(archive)
 682                                             .webrevStorageRef(&quot;webrev&quot;)
 683                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 684                                             .webrevStorageBaseUri(webrevServer.uri())
 685                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 686                                             .build();
 687 
 688             // Populate the projects repository
 689             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 690             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 691             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 692             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 693             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 694 
 695             // Make a change with a corresponding PR
 696             var editHash = CheckableRepository.appendAndCommit(localRepo);
 697             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 698             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 699             pr.setBody(&quot;This is now ready&quot;);
 700             pr.addComment(&quot;Avoid combining&quot;);
 701 
 702             TestBotRunner.runPeriodicItems(mlBot);
 703             listServer.processIncoming();
 704             listServer.processIncoming();
 705 
 706             // Make several file specific comments
 707             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 708             var second = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 709             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 710             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 711             TestBotRunner.runPeriodicItems(mlBot);
 712             listServer.processIncoming();
 713 
 714             // The archive should contain a combined entry
 715             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 716             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 717 
 718             // As well as the mailing list
 719             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 720             var mailmanList = mailmanServer.getList(listAddress.address());
 721             var conversations = mailmanList.conversations(Duration.ofDays(1));
 722             assertEquals(1, conversations.size());
 723             var mail = conversations.get(0).first();
 724             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 725             assertEquals(3, conversations.get(0).allMessages().size());
 726 
 727             var commentReply = conversations.get(0).replies(mail).get(0);
 728             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 729             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 730 
 731             var reviewReply = conversations.get(0).replies(mail).get(1);
 732             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 733             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 734             assertEquals(&quot;RFR: This is a pull request&quot;, reviewReply.subject());
 735             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 736             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 737 
 738             // Now reply to the first and second (collapsed) comment
 739             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 740             pr.addReviewCommentReply(second, &quot;Not with this one though&quot;);
 741             TestBotRunner.runPeriodicItems(mlBot);
 742             listServer.processIncoming();
 743 
 744             // The archive should contain a new entry
 745             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 746             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 747 
 748             // The combined review comments should only appear unquoted once
 749             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 750         }
 751     }
 752 
 753     @Test
 754     void commentThreading(TestInfo testInfo) throws IOException {
 755         try (var credentials = new HostCredentials(testInfo);
 756              var tempFolder = new TemporaryDirectory();
 757              var archiveFolder = new TemporaryDirectory();
 758              var listServer = new TestMailmanServer();
 759              var webrevServer = new TestWebrevServer()) {
 760             var author = credentials.getHostedRepository();
 761             var reviewer = credentials.getHostedRepository();
 762             var archive = credentials.getHostedRepository();
 763             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 764             var censusBuilder = credentials.getCensusBuilder()
 765                                            .addReviewer(reviewer.forge().currentUser().id())
 766                                            .addAuthor(author.forge().currentUser().id());
 767             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 768             var mlBot = MailingListBridgeBot.newBuilder()
 769                                             .from(from)
 770                                             .repo(author)
 771                                             .archive(archive)
 772                                             .censusRepo(censusBuilder.build())
 773                                             .list(listAddress)
 774                                             .listArchive(listServer.getArchive())
 775                                             .smtpServer(listServer.getSMTP())
 776                                             .webrevStorageRepository(archive)
 777                                             .webrevStorageRef(&quot;webrev&quot;)
 778                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 779                                             .webrevStorageBaseUri(webrevServer.uri())
 780                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 781                                             .build();
 782 
 783             // Populate the projects repository
 784             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 785             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 786             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 787             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 788             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 789 
 790             // Make a change with a corresponding PR
 791             var editHash = CheckableRepository.appendAndCommit(localRepo);
 792             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 793             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 794             pr.setBody(&quot;This is now ready&quot;);
 795             TestBotRunner.runPeriodicItems(mlBot);
 796             listServer.processIncoming();
 797 
 798             // Make a file specific comment
 799             var reviewPr = reviewer.pullRequest(pr.id());
 800             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 801             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 802             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 803             TestBotRunner.runPeriodicItems(mlBot);
 804             listServer.processIncoming();
 805             listServer.processIncoming();
 806             listServer.processIncoming();
 807 
 808             // And a second one by ourselves
 809             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 810             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 811             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 812             TestBotRunner.runPeriodicItems(mlBot);
 813             listServer.processIncoming();
 814             listServer.processIncoming();
 815             listServer.processIncoming();
 816 
 817             // Finally some approvals and another comment
 818             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 819             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 820             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 821             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 822             TestBotRunner.runPeriodicItems(mlBot);
 823             listServer.processIncoming();
 824             listServer.processIncoming();
 825             listServer.processIncoming();
 826 
 827             // Sanity check the archive
 828             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 829             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 830 
 831             // File specific comments should appear after the approval
 832             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 833             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 834 
 835             // Check the mailing list
 836             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 837             var mailmanList = mailmanServer.getList(listAddress.address());
 838             var conversations = mailmanList.conversations(Duration.ofDays(1));
 839             assertEquals(1, conversations.size());
 840             var mail = conversations.get(0).first();
 841             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 842             assertEquals(10, conversations.get(0).allMessages().size());
 843 
 844             // There should be four separate threads
 845             var thread1 = conversations.get(0).replies(mail).get(0);
 846             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 847             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 848             assertEquals(&quot;RFR: This is a pull request&quot;, thread1.subject());
 849             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 850             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 851             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 852             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 853             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 854             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
 855             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 856             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 857             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 858             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 859 
 860             var thread2 = conversations.get(0).replies(mail).get(1);
 861             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 862             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 863             assertEquals(&quot;RFR: This is a pull request&quot;, thread2.subject());
 864             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 865             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 866             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 867             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 868             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 869             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 870 
 871             var replies = conversations.get(0).replies(mail);
 872             var thread3 = replies.get(2);
 873             assertEquals(&quot;RFR: This is a pull request&quot;, thread3.subject());
 874             var thread4 = replies.get(3);
 875             assertEquals(&quot;RFR: This is a pull request&quot;, thread4.subject());
 876             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 877             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 878             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 879         }
 880     }
 881 
 882     @Test
 883     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 884         try (var credentials = new HostCredentials(testInfo);
 885              var tempFolder = new TemporaryDirectory();
 886              var archiveFolder = new TemporaryDirectory();
 887              var listServer = new TestMailmanServer();
 888              var webrevServer = new TestWebrevServer()) {
 889             var author = credentials.getHostedRepository();
 890             var reviewer = credentials.getHostedRepository();
 891             var archive = credentials.getHostedRepository();
 892             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 893             var censusBuilder = credentials.getCensusBuilder()
 894                                            .addReviewer(reviewer.forge().currentUser().id())
 895                                            .addAuthor(author.forge().currentUser().id());
 896             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 897             var mlBot = MailingListBridgeBot.newBuilder()
 898                                             .from(from)
 899                                             .repo(author)
 900                                             .archive(archive)
 901                                             .censusRepo(censusBuilder.build())
 902                                             .list(listAddress)
 903                                             .listArchive(listServer.getArchive())
 904                                             .smtpServer(listServer.getSMTP())
 905                                             .webrevStorageRepository(archive)
 906                                             .webrevStorageRef(&quot;webrev&quot;)
 907                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 908                                             .webrevStorageBaseUri(webrevServer.uri())
 909                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 910                                             .build();
 911 
 912             // Populate the projects repository
 913             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 914             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 915             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 916             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 917             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 918 
 919             // Make a change with a corresponding PR
 920             var editHash = CheckableRepository.appendAndCommit(localRepo);
 921             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 922             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 923             pr.setBody(&quot;This is now ready&quot;);
 924             TestBotRunner.runPeriodicItems(mlBot);
 925             listServer.processIncoming();
 926 
 927             // Make two file specific comments
 928             var reviewPr = reviewer.pullRequest(pr.id());
 929             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 930             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 931             TestBotRunner.runPeriodicItems(mlBot);
 932             listServer.processIncoming();
 933 
 934             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 935             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
 936             TestBotRunner.runPeriodicItems(mlBot);
 937             listServer.processIncoming();
 938 
 939             // Sanity check the archive
 940             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 941             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 942         }
 943     }
 944 
 945     @Test
 946     void commentWithMention(TestInfo testInfo) throws IOException {
 947         try (var credentials = new HostCredentials(testInfo);
 948              var tempFolder = new TemporaryDirectory();
 949              var archiveFolder = new TemporaryDirectory();
 950              var listServer = new TestMailmanServer();
 951              var webrevServer = new TestWebrevServer()) {
 952             var author = credentials.getHostedRepository();
 953             var reviewer = credentials.getHostedRepository();
 954             var archive = credentials.getHostedRepository();
 955             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 956             var censusBuilder = credentials.getCensusBuilder()
 957                                            .addReviewer(reviewer.forge().currentUser().id())
 958                                            .addAuthor(author.forge().currentUser().id());
 959             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 960             var mlBot = MailingListBridgeBot.newBuilder()
 961                                             .from(from)
 962                                             .repo(author)
 963                                             .archive(archive)
 964                                             .censusRepo(censusBuilder.build())
 965                                             .list(listAddress)
 966                                             .listArchive(listServer.getArchive())
 967                                             .smtpServer(listServer.getSMTP())
 968                                             .webrevStorageRepository(archive)
 969                                             .webrevStorageRef(&quot;webrev&quot;)
 970                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 971                                             .webrevStorageBaseUri(webrevServer.uri())
 972                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 973                                             .build();
 974 
 975             // Populate the projects repository
 976             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 977             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 978             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 979             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 980             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 981 
 982             // Make a change with a corresponding PR
 983             var editHash = CheckableRepository.appendAndCommit(localRepo);
 984             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 985             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 986             pr.setBody(&quot;This is now ready&quot;);
 987             TestBotRunner.runPeriodicItems(mlBot);
 988             listServer.processIncoming();
 989 
 990             // Make two comments from different authors
 991             var reviewPr = reviewer.pullRequest(pr.id());
 992             reviewPr.addComment(&quot;First comment&quot;);
 993             pr.addComment(&quot;Second comment&quot;);
 994 
 995             TestBotRunner.runPeriodicItems(mlBot);
 996             listServer.processIncoming();
 997 
 998             pr.addComment(&quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
 999             TestBotRunner.runPeriodicItems(mlBot);
1000             listServer.processIncoming();
1001 
1002             // The first comment should be quoted more often than the second
1003             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1004             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
1005             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
1006         }
1007     }
1008 
1009     @Test
1010     void reviewCommentWithMention(TestInfo testInfo) throws IOException {
1011         try (var credentials = new HostCredentials(testInfo);
1012              var tempFolder = new TemporaryDirectory();
1013              var archiveFolder = new TemporaryDirectory();
1014              var listServer = new TestMailmanServer();
1015              var webrevServer = new TestWebrevServer()) {
1016             var author = credentials.getHostedRepository();
1017             var reviewer = credentials.getHostedRepository();
1018             var archive = credentials.getHostedRepository();
1019             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1020             var censusBuilder = credentials.getCensusBuilder()
1021                                            .addReviewer(reviewer.forge().currentUser().id())
1022                                            .addAuthor(author.forge().currentUser().id());
1023             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1024             var mlBot = MailingListBridgeBot.newBuilder()
1025                                             .from(from)
1026                                             .repo(author)
1027                                             .archive(archive)
1028                                             .censusRepo(censusBuilder.build())
1029                                             .list(listAddress)
1030                                             .listArchive(listServer.getArchive())
1031                                             .smtpServer(listServer.getSMTP())
1032                                             .webrevStorageRepository(archive)
1033                                             .webrevStorageRef(&quot;webrev&quot;)
1034                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1035                                             .webrevStorageBaseUri(webrevServer.uri())
1036                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1037                                             .build();
1038 
1039             // Populate the projects repository
1040             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1041             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1042             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1043             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1044             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1045 
1046             // Make a change with a corresponding PR
1047             var editHash = CheckableRepository.appendAndCommit(localRepo);
1048             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1049             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1050             pr.setBody(&quot;This is now ready&quot;);
1051             TestBotRunner.runPeriodicItems(mlBot);
1052             listServer.processIncoming();
1053 
1054             // Make two review comments from different authors
1055             var reviewPr = reviewer.pullRequest(pr.id());
1056             var comment = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1057             reviewPr.addReviewCommentReply(comment, &quot;First review comment&quot;);
1058             pr.addReviewCommentReply(comment, &quot;Second review comment&quot;);
1059 
1060             TestBotRunner.runPeriodicItems(mlBot);
1061             listServer.processIncoming();
1062 
1063             pr.addReviewCommentReply(comment, &quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
1064             TestBotRunner.runPeriodicItems(mlBot);
1065             listServer.processIncoming();
1066 
1067             // The first comment should be quoted more often than the second
1068             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1069             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First review comment&quot;));
1070             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second review comment&quot;));
1071         }
1072     }
1073 
1074     @Test
1075     void commentWithQuote(TestInfo testInfo) throws IOException {
1076         try (var credentials = new HostCredentials(testInfo);
1077              var tempFolder = new TemporaryDirectory();
1078              var archiveFolder = new TemporaryDirectory();
1079              var listServer = new TestMailmanServer();
1080              var webrevServer = new TestWebrevServer()) {
1081             var author = credentials.getHostedRepository();
1082             var reviewer = credentials.getHostedRepository();
1083             var archive = credentials.getHostedRepository();
1084             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1085             var censusBuilder = credentials.getCensusBuilder()
1086                                            .addReviewer(reviewer.forge().currentUser().id())
1087                                            .addAuthor(author.forge().currentUser().id());
1088             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1089             var mlBot = MailingListBridgeBot.newBuilder()
1090                                             .from(from)
1091                                             .repo(author)
1092                                             .archive(archive)
1093                                             .censusRepo(censusBuilder.build())
1094                                             .list(listAddress)
1095                                             .listArchive(listServer.getArchive())
1096                                             .smtpServer(listServer.getSMTP())
1097                                             .webrevStorageRepository(archive)
1098                                             .webrevStorageRef(&quot;webrev&quot;)
1099                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1100                                             .webrevStorageBaseUri(webrevServer.uri())
1101                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1102                                             .build();
1103 
1104             // Populate the projects repository
1105             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1106             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1107             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1108             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1109             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1110 
1111             // Make a change with a corresponding PR
1112             var editHash = CheckableRepository.appendAndCommit(localRepo);
1113             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1114             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1115             pr.setBody(&quot;This is now ready&quot;);
1116             TestBotRunner.runPeriodicItems(mlBot);
1117             listServer.processIncoming();
1118 
1119             // Make two comments from different authors
1120             var reviewPr = reviewer.pullRequest(pr.id());
1121             reviewPr.addComment(&quot;First comment\nsecond line&quot;);
1122             pr.addComment(&quot;Second comment\nfourth line&quot;);
1123 
1124             TestBotRunner.runPeriodicItems(mlBot);
1125             listServer.processIncoming();
1126 
1127             pr.addComment(&quot;&gt;First comm\n\nreply to first&quot;);
1128             TestBotRunner.runPeriodicItems(mlBot);
1129             listServer.processIncoming();
1130 
1131             // The first comment should be quoted more often than the second
1132             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1133             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
1134             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comm&quot;));
1135             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
1136         }
1137     }
1138 
1139     @Test
1140     void reviewContext(TestInfo testInfo) throws IOException {
1141         try (var credentials = new HostCredentials(testInfo);
1142              var tempFolder = new TemporaryDirectory();
1143              var archiveFolder = new TemporaryDirectory();
1144              var listServer = new TestMailmanServer();
1145              var webrevServer = new TestWebrevServer()) {
1146             var author = credentials.getHostedRepository();
1147             var archive = credentials.getHostedRepository();
1148             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1149             var censusBuilder = credentials.getCensusBuilder()
1150                                            .addAuthor(author.forge().currentUser().id());
1151             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1152             var mlBot = MailingListBridgeBot.newBuilder()
1153                                             .from(from)
1154                                             .repo(author)
1155                                             .archive(archive)
1156                                             .censusRepo(censusBuilder.build())
1157                                             .list(listAddress)
1158                                             .listArchive(listServer.getArchive())
1159                                             .smtpServer(listServer.getSMTP())
1160                                             .webrevStorageRepository(archive)
1161                                             .webrevStorageRef(&quot;webrev&quot;)
1162                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1163                                             .webrevStorageBaseUri(webrevServer.uri())
1164                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1165                                             .build();
1166 
1167             // Populate the projects repository
1168             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1169             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1170             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1171             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1172             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1173 
1174             // Make a change with a corresponding PR
1175             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1176             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1177             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1178             pr.setBody(&quot;This is now ready&quot;);
1179             TestBotRunner.runPeriodicItems(mlBot);
1180             listServer.processIncoming();
1181 
1182             // Make a file specific comment
1183             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1184 
1185             TestBotRunner.runPeriodicItems(mlBot);
1186             listServer.processIncoming();
1187 
1188             // The archive should only contain context around line 2
1189             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1190             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
1191             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
1192             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
1193         }
1194     }
1195 
1196     @Test
1197     void multipleReviewContexts(TestInfo testInfo) throws IOException {
1198         try (var credentials = new HostCredentials(testInfo);
1199              var tempFolder = new TemporaryDirectory();
1200              var archiveFolder = new TemporaryDirectory();
1201              var listServer = new TestMailmanServer();
1202              var webrevServer = new TestWebrevServer()) {
1203             var author = credentials.getHostedRepository();
1204             var archive = credentials.getHostedRepository();
1205             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1206             var censusBuilder = credentials.getCensusBuilder()
1207                                            .addAuthor(author.forge().currentUser().id());
1208             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1209             var mlBot = MailingListBridgeBot.newBuilder()
1210                                             .from(from)
1211                                             .repo(author)
1212                                             .archive(archive)
1213                                             .censusRepo(censusBuilder.build())
1214                                             .list(listAddress)
1215                                             .listArchive(listServer.getArchive())
1216                                             .smtpServer(listServer.getSMTP())
1217                                             .webrevStorageRepository(archive)
1218                                             .webrevStorageRef(&quot;webrev&quot;)
1219                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1220                                             .webrevStorageBaseUri(webrevServer.uri())
1221                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1222                                             .build();
1223 
1224             // Populate the projects repository
1225             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1226             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1227             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1228             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1229             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1230             var initialHash = CheckableRepository.appendAndCommit(localRepo,
1231                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
1232                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
1233                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
1234                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
1235                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
1236                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
1237             localRepo.push(initialHash, author.url(), &quot;master&quot;);
1238 
1239             // Make a change with a corresponding PR
1240             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
1241             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
1242             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
1243             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
1244             var editHash = CheckableRepository.appendAndCommit(localRepo);
1245             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1246             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1247             pr.setBody(&quot;This is now ready&quot;);
1248             TestBotRunner.runPeriodicItems(mlBot);
1249             listServer.processIncoming();
1250 
1251             // Make file specific comments
1252             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
1253             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
1254 
1255             TestBotRunner.runPeriodicItems(mlBot);
1256             listServer.processIncoming();
1257 
1258             // The archive should only contain context around line 2 and 20
1259             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1260             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
1261             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
1262             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
1263             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
1264 
1265             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
1266             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
1267             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
1268             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
1269         }
1270     }
1271 
1272     @Test
1273     void filterComments(TestInfo testInfo) throws IOException {
1274         try (var credentials = new HostCredentials(testInfo);
1275              var tempFolder = new TemporaryDirectory();
1276              var archiveFolder = new TemporaryDirectory();
1277              var listServer = new TestMailmanServer();
1278              var webrevServer = new TestWebrevServer()) {
1279             var author = credentials.getHostedRepository();
1280             var archive = credentials.getHostedRepository();
1281             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1282             var censusBuilder = credentials.getCensusBuilder()
1283                                            .addAuthor(author.forge().currentUser().id());
1284             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1285             var mlBot = MailingListBridgeBot.newBuilder()
1286                                             .from(from)
1287                                             .repo(author)
1288                                             .archive(archive)
1289                                             .censusRepo(censusBuilder.build())
1290                                             .list(listAddress)
1291                                             .listArchive(listServer.getArchive())
1292                                             .smtpServer(listServer.getSMTP())
1293                                             .webrevStorageRepository(archive)
1294                                             .webrevStorageRef(&quot;webrev&quot;)
1295                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1296                                             .webrevStorageBaseUri(webrevServer.uri())
1297                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1298                                             .build();
1299 
1300             // Populate the projects repository
1301             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1302             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1303             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1304             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1305             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1306 
1307             // Make a change with a corresponding PR
1308             var editHash = CheckableRepository.appendAndCommit(localRepo);
1309             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1310             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1311             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
1312                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
1313 
1314             // Make a bunch of comments
1315             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
1316             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
1317             pr.addComment(&quot;/integrate stuff&quot;);
1318             TestBotRunner.runPeriodicItems(mlBot);
1319 
1320             // Run an archive pass
1321             TestBotRunner.runPeriodicItems(mlBot);
1322 
1323             // The archive should not contain the comment
1324             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1325             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1326             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
1327             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
1328             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
1329             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
1330             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
1331             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
1332             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
1333             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
1334         }
1335     }
1336 
1337     @Test
1338     void incrementalChanges(TestInfo testInfo) throws IOException {
1339         try (var credentials = new HostCredentials(testInfo);
1340              var tempFolder = new TemporaryDirectory();
1341              var archiveFolder = new TemporaryDirectory();
1342              var listServer = new TestMailmanServer();
1343              var webrevServer = new TestWebrevServer()) {
1344             var author = credentials.getHostedRepository();
1345             var archive = credentials.getHostedRepository();
1346             var commenter = credentials.getHostedRepository();
1347             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1348             var censusBuilder = credentials.getCensusBuilder()
1349                                            .addAuthor(author.forge().currentUser().id());
1350             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1351             var mlBot = MailingListBridgeBot.newBuilder()
1352                                             .from(from)
1353                                             .repo(author)
1354                                             .archive(archive)
1355                                             .censusRepo(censusBuilder.build())
1356                                             .list(listAddress)
1357                                             .listArchive(listServer.getArchive())
1358                                             .smtpServer(listServer.getSMTP())
1359                                             .webrevStorageRepository(archive)
1360                                             .webrevStorageRef(&quot;webrev&quot;)
1361                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1362                                             .webrevStorageBaseUri(webrevServer.uri())
1363                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1364                                             .build();
1365 
1366             // Populate the projects repository
1367             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1368             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1369             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1370             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1371             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1372 
1373             // Make a change with a corresponding PR
1374             var editHash = CheckableRepository.appendAndCommit(localRepo);
1375             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1376             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1377             pr.setBody(&quot;This is now ready&quot;);
1378 
1379             // Run an archive pass
1380             TestBotRunner.runPeriodicItems(mlBot);
1381             listServer.processIncoming();
1382 
1383             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
1384             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
1385 
1386             // Make sure that the push registered
1387             var lastHeadHash = pr.headHash();
1388             var refreshCount = 0;
1389             do {
1390                 pr = author.pullRequest(pr.id());
1391                 if (refreshCount++ &gt; 100) {
1392                     fail(&quot;The PR did not update after the new push&quot;);
1393                 }
1394             } while (pr.headHash().equals(lastHeadHash));
1395 
1396             // Run another archive pass
1397             TestBotRunner.runPeriodicItems(mlBot);
1398             TestBotRunner.runPeriodicItems(mlBot);
1399             TestBotRunner.runPeriodicItems(mlBot);
1400             listServer.processIncoming();
1401 
1402             // The archive should reference the updated push
1403             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1404             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request incrementally&quot;));
1405             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
1406             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
1407             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1408             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1409             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
1410 
1411             // The webrev comment should be updated
1412             var comments = pr.comments();
1413             var webrevComments = comments.stream()
1414                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1415                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1416                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
1417                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
1418                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
1419                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1420                                          .collect(Collectors.toList());
1421             assertEquals(1, webrevComments.size());
1422 
1423             // Check that sender address is set properly
1424             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1425             var mailmanList = mailmanServer.getList(listAddress.address());
1426             var conversations = mailmanList.conversations(Duration.ofDays(1));
1427             assertEquals(1, conversations.size());
1428             for (var newMail : conversations.get(0).allMessages()) {
1429                 assertEquals(noreplyAddress(archive), newMail.author().address());
1430                 assertEquals(listAddress, newMail.sender());
1431             }
1432 
1433             // Add a comment
1434             var commenterPr = commenter.pullRequest(pr.id());
1435             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1436             TestBotRunner.runPeriodicItems(mlBot);
1437             listServer.processIncoming();
1438 
1439             // Ensure that additional updates are only reported once
1440             for (int i = 0; i &lt; 3; ++i) {
1441                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
1442                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
1443 
1444                 // Make sure that the push registered
1445                 lastHeadHash = pr.headHash();
1446                 refreshCount = 0;
1447                 do {
1448                     pr = author.pullRequest(pr.id());
1449                     if (refreshCount++ &gt; 100) {
1450                         fail(&quot;The PR did not update after the new push&quot;);
1451                     }
1452                 } while (pr.headHash().equals(lastHeadHash));
1453 
1454                 TestBotRunner.runPeriodicItems(mlBot);
1455                 TestBotRunner.runPeriodicItems(mlBot);
1456                 listServer.processIncoming();
1457             }
1458             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
1459             assertEquals(1, updatedConversations.size());
1460             var conversation = updatedConversations.get(0);
1461             assertEquals(6, conversation.allMessages().size());
1462             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
1463             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
1464             assertEquals(&quot;[Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
1465         }
1466     }
1467 
1468     @Test
1469     void rebased(TestInfo testInfo) throws IOException {
1470         try (var credentials = new HostCredentials(testInfo);
1471              var tempFolder = new TemporaryDirectory();
1472              var archiveFolder = new TemporaryDirectory();
1473              var listServer = new TestMailmanServer();
1474              var webrevServer = new TestWebrevServer()) {
1475             var author = credentials.getHostedRepository();
1476             var archive = credentials.getHostedRepository();
1477             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1478             var censusBuilder = credentials.getCensusBuilder()
1479                                            .addAuthor(author.forge().currentUser().id());
1480             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1481             var mlBot = MailingListBridgeBot.newBuilder()
1482                                             .from(sender)
1483                                             .repo(author)
1484                                             .archive(archive)
1485                                             .censusRepo(censusBuilder.build())
1486                                             .list(listAddress)
1487                                             .listArchive(listServer.getArchive())
1488                                             .smtpServer(listServer.getSMTP())
1489                                             .webrevStorageRepository(archive)
1490                                             .webrevStorageRef(&quot;webrev&quot;)
1491                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1492                                             .webrevStorageBaseUri(webrevServer.uri())
1493                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1494                                             .build();
1495 
1496             // Populate the projects repository
1497             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1498             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1499             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1500             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1501             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1502 
1503             // Make a change with a corresponding PR
1504             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1505             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1506             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1507             pr.setBody(&quot;This is now ready&quot;);
1508 
1509             // Run an archive pass
1510             TestBotRunner.runPeriodicItems(mlBot);
1511             listServer.processIncoming();
1512 
1513             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1514             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1515             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1516 
1517             // Make sure that the push registered
1518             var lastHeadHash = pr.headHash();
1519             var refreshCount = 0;
1520             do {
1521                 pr = author.pullRequest(pr.id());
1522                 if (refreshCount++ &gt; 100) {
1523                     fail(&quot;The PR did not update after the new push&quot;);
1524                 }
1525             } while (pr.headHash().equals(lastHeadHash));
1526 
1527             // Run another archive pass
1528             TestBotRunner.runPeriodicItems(mlBot);
1529             listServer.processIncoming();
1530 
1531             // The archive should reference the rebased push
1532             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1533             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1534             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1535             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1536             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1537             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1538             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1539             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1540 
1541             // The webrev comment should be updated
1542             var comments = pr.comments();
1543             var webrevComments = comments.stream()
1544                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1545                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1546                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1547                                          .collect(Collectors.toList());
1548             assertEquals(1, webrevComments.size());
1549 
1550             // Check that sender address is set properly
1551             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1552             var mailmanList = mailmanServer.getList(listAddress.address());
1553             var conversations = mailmanList.conversations(Duration.ofDays(1));
1554             assertEquals(1, conversations.size());
1555             for (var newMail : conversations.get(0).allMessages()) {
1556                 assertEquals(noreplyAddress(archive), newMail.author().address());
1557                 assertEquals(listAddress, newMail.sender());
1558                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1559             }
1560             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1561         }
1562     }
1563 
1564     @Test
1565     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1566         try (var credentials = new HostCredentials(testInfo);
1567              var tempFolder = new TemporaryDirectory();
1568              var archiveFolder = new TemporaryDirectory();
1569              var listServer = new TestMailmanServer();
1570              var webrevServer = new TestWebrevServer()) {
1571             var author = credentials.getHostedRepository();
1572             var archive = credentials.getHostedRepository();
1573             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1574             var censusBuilder = credentials.getCensusBuilder()
1575                                            .addAuthor(author.forge().currentUser().id());
1576             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1577             var mlBot = MailingListBridgeBot.newBuilder()
1578                                             .from(sender)
1579                                             .repo(author)
1580                                             .archive(archive)
1581                                             .archiveRef(&quot;archive&quot;)
1582                                             .censusRepo(censusBuilder.build())
1583                                             .list(listAddress)
1584                                             .listArchive(listServer.getArchive())
1585                                             .smtpServer(listServer.getSMTP())
1586                                             .webrevStorageRepository(archive)
1587                                             .webrevStorageRef(&quot;webrev&quot;)
1588                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1589                                             .webrevStorageBaseUri(webrevServer.uri())
1590                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1591                                             .build();
1592 
1593             // Populate the projects repository
1594             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1595             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1596             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1597             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1598             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1599             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1600 
1601             // Make a change with a corresponding PR
1602             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1603             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1604             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1605             pr.setBody(&quot;This is now ready&quot;);
1606 
1607             // Run an archive pass
1608             TestBotRunner.runPeriodicItems(mlBot);
1609             listServer.processIncoming();
1610 
1611             // Push more stuff to master
1612             localRepo.checkout(masterHash, true);
1613             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1614             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1615             localRepo.add(unrelatedFile);
1616             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1617             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1618 
1619             // And more stuff to the pr branch
1620             localRepo.checkout(editHash, true);
1621             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1622 
1623             // Merge master
1624             localRepo.merge(newMasterHash);
1625             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1626             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1627 
1628             // Make sure that the push registered
1629             var lastHeadHash = pr.headHash();
1630             var refreshCount = 0;
1631             do {
1632                 pr = author.pullRequest(pr.id());
1633                 if (refreshCount++ &gt; 100) {
1634                     fail(&quot;The PR did not update after the new push&quot;);
1635                 }
1636             } while (pr.headHash().equals(lastHeadHash));
1637 
1638             // Run another archive pass
1639             TestBotRunner.runPeriodicItems(mlBot);
1640             listServer.processIncoming();
1641 
1642             // The archive should reference the rebased push
1643             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1644             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1645             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes&quot;));
1646             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1647             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1648             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1649             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1650         }
1651     }
1652 
1653     @Test
1654     void mergeWebrev(TestInfo testInfo) throws IOException {
1655         try (var credentials = new HostCredentials(testInfo);
1656              var tempFolder = new TemporaryDirectory();
1657              var archiveFolder = new TemporaryDirectory();
1658              var listServer = new TestMailmanServer();
1659              var webrevServer = new TestWebrevServer()) {
1660             var author = credentials.getHostedRepository();
1661             var archive = credentials.getHostedRepository();
1662             var commenter = credentials.getHostedRepository();
1663             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1664             var censusBuilder = credentials.getCensusBuilder()
1665                                            .addAuthor(author.forge().currentUser().id());
1666             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1667             var mlBot = MailingListBridgeBot.newBuilder()
1668                                             .from(from)
1669                                             .repo(author)
1670                                             .archive(archive)
1671                                             .archiveRef(&quot;archive&quot;)
1672                                             .censusRepo(censusBuilder.build())
1673                                             .list(listAddress)
1674                                             .listArchive(listServer.getArchive())
1675                                             .smtpServer(listServer.getSMTP())
1676                                             .webrevStorageRepository(archive)
1677                                             .webrevStorageRef(&quot;webrev&quot;)
1678                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1679                                             .webrevStorageBaseUri(webrevServer.uri())
1680                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1681                                             .build();
1682 
1683             // Populate the projects repository
1684             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1685             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1686             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1687             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1688             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1689             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1690 
1691             // Create a merge
1692             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1693             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1694             localRepo.add(editOnlyFile);
1695             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1696             localRepo.checkout(masterHash, true);
1697             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1698             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1699             localRepo.add(masterOnlyFile);
1700             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1701             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1702             localRepo.merge(editHash, &quot;ours&quot;);
1703             var mergeCommit = localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1704             var mergeOnlyFile = Path.of(&quot;mergeonly.txt&quot;);
1705             Files.writeString(localRepo.root().resolve(mergeOnlyFile), &quot;Only added in the merge&quot;);
1706             localRepo.add(mergeOnlyFile);
1707             Files.writeString(localRepo.root().resolve(reviewFile), &quot;Overwriting the conflict resolution&quot;);
1708             localRepo.add(reviewFile);
1709             var appendedCommit = localRepo.amend(&quot;Updated merge commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1710             localRepo.push(appendedCommit, author.url(), &quot;edit&quot;, true);
1711 
1712             // Make a merge PR
1713             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1714             pr.setBody(&quot;This is now ready&quot;);
1715 
1716             // Run an archive pass
1717             TestBotRunner.runPeriodicItems(mlBot);
1718             listServer.processIncoming();
1719 
1720             // The archive should contain a merge style webrev
1721             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1722             assertTrue(archiveContains(archiveFolder.path(), &quot;webrevs contain only the adjustments&quot;));
1723             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.0&quot;));
1724             assertTrue(archiveContains(archiveFolder.path(), &quot;3 lines in 2 files changed: 1 ins; 1 del; 1 mod&quot;));
1725 
1726             // The PR should contain a webrev comment
1727             assertEquals(1, pr.comments().size());
1728             var webrevComment = pr.comments().get(0);
1729             assertTrue(webrevComment.body().contains(&quot;Merge target&quot;));
1730             assertTrue(webrevComment.body().contains(&quot;Merge source&quot;));
1731         }
1732     }
1733 
1734     @Test
1735     void mergeWebrevConflict(TestInfo testInfo) throws IOException {
1736         try (var credentials = new HostCredentials(testInfo);
1737              var tempFolder = new TemporaryDirectory();
1738              var archiveFolder = new TemporaryDirectory();
1739              var listServer = new TestMailmanServer();
1740              var webrevServer = new TestWebrevServer()) {
1741             var author = credentials.getHostedRepository();
1742             var archive = credentials.getHostedRepository();
1743             var commenter = credentials.getHostedRepository();
1744             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1745             var censusBuilder = credentials.getCensusBuilder()
1746                                            .addAuthor(author.forge().currentUser().id());
1747             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1748             var mlBot = MailingListBridgeBot.newBuilder()
1749                                             .from(from)
1750                                             .repo(author)
1751                                             .archive(archive)
1752                                             .archiveRef(&quot;archive&quot;)
1753                                             .censusRepo(censusBuilder.build())
1754                                             .list(listAddress)
1755                                             .listArchive(listServer.getArchive())
1756                                             .smtpServer(listServer.getSMTP())
1757                                             .webrevStorageRepository(archive)
1758                                             .webrevStorageRef(&quot;webrev&quot;)
1759                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1760                                             .webrevStorageBaseUri(webrevServer.uri())
1761                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1762                                             .build();
1763 
1764             // Populate the projects repository
1765             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1766             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1767             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1768             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1769             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1770             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1771 
1772             // Create a merge
1773             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1774             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1775             localRepo.add(editOnlyFile);
1776             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1777             localRepo.checkout(masterHash, true);
1778             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1779             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1780             localRepo.add(masterOnlyFile);
1781             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1782             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1783             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1784 
1785             // Make a merge PR
1786             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1787             pr.setBody(&quot;This is now ready&quot;);
1788 
1789             // Run an archive pass
1790             TestBotRunner.runPeriodicItems(mlBot);
1791             listServer.processIncoming();
1792 
1793             // The archive should contain a merge style webrev
1794             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1795             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrev contains the conflicts with master:&quot;));
1796             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.conflicts&quot;));
1797             assertTrue(archiveContains(archiveFolder.path(), &quot;2 lines in 2 files changed: 2 ins; 0 del; 0 mod&quot;));
1798 
1799             // The PR should contain a webrev comment
1800             assertEquals(1, pr.comments().size());
1801             var webrevComment = pr.comments().get(0);
1802             assertTrue(webrevComment.body().contains(&quot;Merge conflicts&quot;));
1803         }
1804     }
1805 
1806     @Test
1807     void mergeWebrevNoConflict(TestInfo testInfo) throws IOException {
1808         try (var credentials = new HostCredentials(testInfo);
1809              var tempFolder = new TemporaryDirectory();
1810              var archiveFolder = new TemporaryDirectory();
1811              var listServer = new TestMailmanServer();
1812              var webrevServer = new TestWebrevServer()) {
1813             var author = credentials.getHostedRepository();
1814             var archive = credentials.getHostedRepository();
1815             var commenter = credentials.getHostedRepository();
1816             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1817             var censusBuilder = credentials.getCensusBuilder()
1818                                            .addAuthor(author.forge().currentUser().id());
1819             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1820             var mlBot = MailingListBridgeBot.newBuilder()
1821                                             .from(from)
1822                                             .repo(author)
1823                                             .archive(archive)
1824                                             .archiveRef(&quot;archive&quot;)
1825                                             .censusRepo(censusBuilder.build())
1826                                             .list(listAddress)
1827                                             .listArchive(listServer.getArchive())
1828                                             .smtpServer(listServer.getSMTP())
1829                                             .webrevStorageRepository(archive)
1830                                             .webrevStorageRef(&quot;webrev&quot;)
1831                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1832                                             .webrevStorageBaseUri(webrevServer.uri())
1833                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1834                                             .build();
1835 
1836             // Populate the projects repository
1837             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1838             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1839             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1840             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1841             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1842             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1843 
1844             // Create a merge
1845             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1846             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1847             localRepo.add(editOnlyFile);
1848             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;, &quot;Commit in edit branch&quot;);
1849             localRepo.checkout(masterHash, true);
1850             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1851             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1852             localRepo.add(masterOnlyFile);
1853             var updatedMasterHash = localRepo.commit(&quot;Only added in master&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1854             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1855             localRepo.merge(editHash);
1856             var mergeCommit = localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1857             localRepo.push(mergeCommit, author.url(), &quot;edit&quot;, true);
1858 
1859             // Make a merge PR
1860             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1861             pr.setBody(&quot;This is now ready&quot;);
1862 
1863             // Run an archive pass
1864             TestBotRunner.runPeriodicItems(mlBot);
1865             listServer.processIncoming();
1866 
1867             // The archive should contain a merge style webrev
1868             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1869             assertTrue(archiveContains(archiveFolder.path(), &quot;so no merge-specific webrevs have been generated&quot;));
1870 
1871             // The PR should not contain a webrev comment
1872             assertEquals(0, pr.comments().size());
1873         }
1874     }
1875 
1876     @Test
1877     void mergeWebrevNoMerge(TestInfo testInfo) throws IOException {
1878         try (var credentials = new HostCredentials(testInfo);
1879              var tempFolder = new TemporaryDirectory();
1880              var archiveFolder = new TemporaryDirectory();
1881              var listServer = new TestMailmanServer();
1882              var webrevServer = new TestWebrevServer()) {
1883             var author = credentials.getHostedRepository();
1884             var archive = credentials.getHostedRepository();
1885             var commenter = credentials.getHostedRepository();
1886             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1887             var censusBuilder = credentials.getCensusBuilder()
1888                                            .addAuthor(author.forge().currentUser().id());
1889             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1890             var mlBot = MailingListBridgeBot.newBuilder()
1891                                             .from(from)
1892                                             .repo(author)
1893                                             .archive(archive)
1894                                             .archiveRef(&quot;archive&quot;)
1895                                             .censusRepo(censusBuilder.build())
1896                                             .list(listAddress)
1897                                             .listArchive(listServer.getArchive())
1898                                             .smtpServer(listServer.getSMTP())
1899                                             .webrevStorageRepository(archive)
1900                                             .webrevStorageRef(&quot;webrev&quot;)
1901                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1902                                             .webrevStorageBaseUri(webrevServer.uri())
1903                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1904                                             .build();
1905 
1906             // Populate the projects repository
1907             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1908             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1909             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1910             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1911             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1912             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1913 
1914             // Create a merge
1915             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1916             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1917             localRepo.add(editOnlyFile);
1918             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;, &quot;Commit in edit branch&quot;);
1919             localRepo.checkout(masterHash, true);
1920             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1921             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1922             localRepo.add(masterOnlyFile);
1923             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;, &quot;Commit in master branch&quot;);
1924             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1925             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1926 
1927             // Make a merge PR
1928             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1929             pr.setBody(&quot;This is now ready&quot;);
1930 
1931             // Run an archive pass
1932             TestBotRunner.runPeriodicItems(mlBot);
1933             listServer.processIncoming();
1934 
1935             // The archive should not include any merge-specific webrevs
1936             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1937             assertTrue(archiveContains(archiveFolder.path(), &quot;so no merge-specific webrevs have been generated&quot;));
1938 
1939             // The PR should not contain a webrev comment
1940             assertEquals(0, pr.comments().size());
1941         }
1942     }
1943 
1944     @Test
1945     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1946         try (var credentials = new HostCredentials(testInfo);
1947              var tempFolder = new TemporaryDirectory();
1948              var archiveFolder = new TemporaryDirectory();
1949              var webrevFolder = new TemporaryDirectory();
1950              var listServer = new TestMailmanServer();
1951              var webrevServer = new TestWebrevServer()) {
1952             var author = credentials.getHostedRepository();
1953             var archive = credentials.getHostedRepository();
1954             var ignored = credentials.getHostedRepository();
1955             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1956             var censusBuilder = credentials.getCensusBuilder()
1957                                            .addAuthor(author.forge().currentUser().id());
1958             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1959             var mlBot = MailingListBridgeBot.newBuilder()
1960                                             .from(from)
1961                                             .repo(author)
1962                                             .archive(archive)
1963                                             .censusRepo(censusBuilder.build())
1964                                             .list(listAddress)
1965                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1966                                             .listArchive(listServer.getArchive())
1967                                             .smtpServer(listServer.getSMTP())
1968                                             .webrevStorageRepository(archive)
1969                                             .webrevStorageRef(&quot;webrev&quot;)
1970                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1971                                             .webrevStorageBaseUri(webrevServer.uri())
1972                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1973                                             .build();
1974 
1975             // Populate the projects repository
1976             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1977             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1978             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1979             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1980 
1981             // Make a change with a corresponding PR
1982             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1983                                                                &quot;Change msg\n\nWith several lines&quot;);
1984             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1985             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1986 
1987             // Flag it as ready for review
1988             pr.setBody(&quot;This should now be ready&quot;);
1989 
1990             // Run an archive pass
1991             TestBotRunner.runPeriodicItems(mlBot);
1992 
1993             // The archive should now contain an entry
1994             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1995             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
1996 
1997             // And there should be a webrev comment
1998             var comments = pr.comments();
1999             var webrevComments = comments.stream()
2000                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2001                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2002                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
2003                                          .collect(Collectors.toList());
2004             assertEquals(1, webrevComments.size());
2005             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
2006 
2007             // Pretend the archive didn&#39;t work out
2008             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
2009 
2010             // Run another archive pass
2011             TestBotRunner.runPeriodicItems(mlBot);
2012 
2013             // The webrev comment should not contain duplicate entries
2014             comments = pr.comments();
2015             webrevComments = comments.stream()
2016                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2017                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2018                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
2019                                      .collect(Collectors.toList());
2020             assertEquals(1, webrevComments.size());
2021             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
2022         }
2023     }
2024 
2025     @Test
2026     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
2027         try (var credentials = new HostCredentials(testInfo);
2028              var tempFolder = new TemporaryDirectory();
2029              var archiveFolder = new TemporaryDirectory();
2030              var listServer = new TestMailmanServer();
2031              var webrevServer = new TestWebrevServer()) {
2032             var author = credentials.getHostedRepository();
2033             var archive = credentials.getHostedRepository();
2034             var reviewer = credentials.getHostedRepository();
2035             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2036             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2037             var censusBuilder = credentials.getCensusBuilder()
2038                                            .addReviewer(reviewer.forge().currentUser().id())
2039                                            .addAuthor(author.forge().currentUser().id());
2040             var mlBot = MailingListBridgeBot.newBuilder()
2041                                             .from(from)
2042                                             .repo(author)
2043                                             .archive(archive)
2044                                             .censusRepo(censusBuilder.build())
2045                                             .list(listAddress)
2046                                             .listArchive(listServer.getArchive())
2047                                             .smtpServer(listServer.getSMTP())
2048                                             .webrevStorageRepository(archive)
2049                                             .webrevStorageRef(&quot;webrev&quot;)
2050                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2051                                             .webrevStorageBaseUri(webrevServer.uri())
2052                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2053                                             .build();
2054 
2055             // Populate the projects repository
2056             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2057             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2058             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2059             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2060             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2061 
2062             // Make a change with a corresponding PR
2063             var editHash = CheckableRepository.appendAndCommit(localRepo);
2064             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2065             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2066             pr.setBody(&quot;This is now ready&quot;);
2067 
2068             // Run an archive pass
2069             TestBotRunner.runPeriodicItems(mlBot);
2070 
2071             // First unapprove it
2072             var reviewedPr = reviewer.pullRequest(pr.id());
2073             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
2074             TestBotRunner.runPeriodicItems(mlBot);
2075             TestBotRunner.runPeriodicItems(mlBot);
2076             TestBotRunner.runPeriodicItems(mlBot);
2077 
2078             // The archive should contain a note
2079             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2080             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
2081             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
2082             if (author.forge().supportsReviewBody()) {
2083                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
2084             }
2085 
2086             // Then approve it
2087             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
2088             TestBotRunner.runPeriodicItems(mlBot);
2089             TestBotRunner.runPeriodicItems(mlBot);
2090             TestBotRunner.runPeriodicItems(mlBot);
2091 
2092             // The archive should contain another note
2093             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2094             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
2095             if (author.forge().supportsReviewBody()) {
2096                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
2097             }
2098             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
2099 
2100             // Yet another change
2101             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
2102             TestBotRunner.runPeriodicItems(mlBot);
2103             TestBotRunner.runPeriodicItems(mlBot);
2104             TestBotRunner.runPeriodicItems(mlBot);
2105 
2106             // The archive should contain another note
2107             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2108             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
2109             if (author.forge().supportsReviewBody()) {
2110                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
2111             }
2112         }
2113     }
2114 
2115     @Test
2116     void ignoreComments(TestInfo testInfo) throws IOException {
2117         try (var credentials = new HostCredentials(testInfo);
2118              var tempFolder = new TemporaryDirectory();
2119              var archiveFolder = new TemporaryDirectory();
2120              var listServer = new TestMailmanServer();
2121              var webrevServer = new TestWebrevServer()) {
2122             var author = credentials.getHostedRepository();
2123             var ignored = credentials.getHostedRepository();
2124             var archive = credentials.getHostedRepository();
2125             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2126             var censusBuilder = credentials.getCensusBuilder()
2127                                            .addAuthor(author.forge().currentUser().id());
2128             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2129             var mlBot = MailingListBridgeBot.newBuilder()
2130                                             .from(from)
2131                                             .repo(author)
2132                                             .archive(archive)
2133                                             .censusRepo(censusBuilder.build())
2134                                             .list(listAddress)
2135                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2136                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
2137                                             .listArchive(listServer.getArchive())
2138                                             .smtpServer(listServer.getSMTP())
2139                                             .webrevStorageRepository(archive)
2140                                             .webrevStorageRef(&quot;webrev&quot;)
2141                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2142                                             .webrevStorageBaseUri(webrevServer.uri())
2143                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2144                                             .build();
2145 
2146             // Populate the projects repository
2147             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2148             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2149             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2150             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2151             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2152 
2153             // Make a change with a corresponding PR
2154             var editHash = CheckableRepository.appendAndCommit(localRepo);
2155             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2156             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2157             pr.setBody(&quot;This is now ready&quot;);
2158 
2159             // Make a bunch of comments
2160             pr.addComment(&quot;Plain comment&quot;);
2161             pr.addComment(&quot;ignore this comment&quot;);
2162             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
2163             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
2164 
2165             var ignoredPR = ignored.pullRequest(pr.id());
2166             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
2167 
2168             TestBotRunner.runPeriodicItems(mlBot);
2169             TestBotRunner.runPeriodicItems(mlBot);
2170 
2171             // The archive should not contain the ignored comments
2172             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2173             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
2174             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
2175             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
2176             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
2177             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
2178         }
2179     }
2180 
2181     @Test
2182     void replyToEmptyReview(TestInfo testInfo) throws IOException {
2183         try (var credentials = new HostCredentials(testInfo);
2184              var tempFolder = new TemporaryDirectory();
2185              var archiveFolder = new TemporaryDirectory();
2186              var listServer = new TestMailmanServer();
2187              var webrevServer = new TestWebrevServer()) {
2188             var author = credentials.getHostedRepository();
2189             var reviewer = credentials.getHostedRepository();
2190             var archive = credentials.getHostedRepository();
2191             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2192             var censusBuilder = credentials.getCensusBuilder()
2193                                            .addReviewer(reviewer.forge().currentUser().id())
2194                                            .addAuthor(author.forge().currentUser().id());
2195             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2196             var mlBot = MailingListBridgeBot.newBuilder()
2197                                             .from(from)
2198                                             .repo(author)
2199                                             .archive(archive)
2200                                             .censusRepo(censusBuilder.build())
2201                                             .list(listAddress)
2202                                             .listArchive(listServer.getArchive())
2203                                             .smtpServer(listServer.getSMTP())
2204                                             .webrevStorageRepository(archive)
2205                                             .webrevStorageRef(&quot;webrev&quot;)
2206                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2207                                             .webrevStorageBaseUri(webrevServer.uri())
2208                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2209                                             .build();
2210 
2211             // Populate the projects repository
2212             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2213             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2214             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2215             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2216             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2217 
2218             // Make a change with a corresponding PR
2219             var editHash = CheckableRepository.appendAndCommit(localRepo);
2220             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2221             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2222             pr.setBody(&quot;This is now ready&quot;);
2223             TestBotRunner.runPeriodicItems(mlBot);
2224             listServer.processIncoming();
2225 
2226             // Make an empty approval
2227             var reviewPr = reviewer.pullRequest(pr.id());
2228             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
2229             TestBotRunner.runPeriodicItems(mlBot);
2230             listServer.processIncoming();
2231 
2232             pr.addComment(&quot;Thanks for the review!&quot;);
2233             TestBotRunner.runPeriodicItems(mlBot);
2234             listServer.processIncoming();
2235 
2236             // The approval text should be included in the quote
2237             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2238             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
2239         }
2240     }
2241 
2242     @Test
2243     void cooldown(TestInfo testInfo) throws IOException {
2244         try (var credentials = new HostCredentials(testInfo);
2245              var tempFolder = new TemporaryDirectory();
2246              var archiveFolder = new TemporaryDirectory();
2247              var listServer = new TestMailmanServer();
2248              var webrevServer = new TestWebrevServer()) {
2249             var bot = credentials.getHostedRepository();
2250             var author = credentials.getHostedRepository();
2251             var archive = credentials.getHostedRepository();
2252             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2253             var censusBuilder = credentials.getCensusBuilder()
2254                                            .addAuthor(author.forge().currentUser().id());
2255             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2256             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2257                                                    .from(from)
2258                                                    .repo(bot)
2259                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2260                                                    .archive(archive)
2261                                                    .censusRepo(censusBuilder.build())
2262                                                    .list(listAddress)
2263                                                    .listArchive(listServer.getArchive())
2264                                                    .smtpServer(listServer.getSMTP())
2265                                                    .webrevStorageRepository(archive)
2266                                                    .webrevStorageRef(&quot;webrev&quot;)
2267                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2268                                                    .webrevStorageBaseUri(webrevServer.uri())
2269                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2270 
2271             // Populate the projects repository
2272             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2273             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2274             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2275             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2276             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2277 
2278             // Make a change with a corresponding PR
2279             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2280             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2281             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2282             pr.setBody(&quot;This is now ready&quot;);
2283 
2284             var mlBot = mlBotBuilder.build();
2285             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2286 
2287             TestBotRunner.runPeriodicItems(mlBot);
2288             listServer.processIncoming();
2289 
2290             // Make a comment
2291             pr.addComment(&quot;Looks good&quot;);
2292 
2293             // Bot with cooldown configured should not bridge the comment
2294             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2295             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2296 
2297             // But without, it should
2298             TestBotRunner.runPeriodicItems(mlBot);
2299             listServer.processIncoming();
2300 
2301             // Check the archive
2302             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2303             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));
2304         }
2305     }
2306 
2307     @Test
2308     void cooldownNewRevision(TestInfo testInfo) throws IOException {
2309         try (var credentials = new HostCredentials(testInfo);
2310              var tempFolder = new TemporaryDirectory();
2311              var archiveFolder = new TemporaryDirectory();
2312              var listServer = new TestMailmanServer();
2313              var webrevServer = new TestWebrevServer()) {
2314             var bot = credentials.getHostedRepository();
2315             var author = credentials.getHostedRepository();
2316             var archive = credentials.getHostedRepository();
2317             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2318             var censusBuilder = credentials.getCensusBuilder()
2319                                            .addAuthor(author.forge().currentUser().id());
2320             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2321             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2322                                                    .from(from)
2323                                                    .repo(bot)
2324                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2325                                                    .archive(archive)
2326                                                    .censusRepo(censusBuilder.build())
2327                                                    .list(listAddress)
2328                                                    .listArchive(listServer.getArchive())
2329                                                    .smtpServer(listServer.getSMTP())
2330                                                    .webrevStorageRepository(archive)
2331                                                    .webrevStorageRef(&quot;webrev&quot;)
2332                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2333                                                    .webrevStorageBaseUri(webrevServer.uri())
2334                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2335 
2336             // Populate the projects repository
2337             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2338             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2339             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2340             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2341             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2342 
2343             // Make a change with a corresponding PR
2344             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2345             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2346             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2347             pr.setBody(&quot;This is now ready&quot;);
2348 
2349             var mlBot = mlBotBuilder.build();
2350             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2351 
2352             TestBotRunner.runPeriodicItems(mlBot);
2353             listServer.processIncoming();
2354 
2355             // Commit another revision
2356             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
2357             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
2358 
2359             // Bot with cooldown configured should not create a new webrev
2360             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2361             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2362 
2363             // But without, it should
2364             TestBotRunner.runPeriodicItems(mlBot);
2365             listServer.processIncoming();
2366 
2367             // Check the archive
2368             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2369             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.01&quot;));
2370         }
2371     }
2372 
2373     @Test
2374     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2375         try (var credentials = new HostCredentials(testInfo);
2376              var tempFolder = new TemporaryDirectory();
2377              var archiveFolder = new TemporaryDirectory();
2378              var listServer = new TestMailmanServer();
2379              var webrevServer = new TestWebrevServer()) {
2380             var bot = credentials.getHostedRepository();
2381             var author = credentials.getHostedRepository();
2382             var archive = credentials.getHostedRepository();
2383             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2384             var censusBuilder = credentials.getCensusBuilder()
2385                                            .addAuthor(author.forge().currentUser().id());
2386             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2387             var cooldown = Duration.ofMillis(500);
2388             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2389                                                    .from(from)
2390                                                    .repo(bot)
2391                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2392                                                    .archive(archive)
2393                                                    .censusRepo(censusBuilder.build())
2394                                                    .list(listAddress)
2395                                                    .listArchive(listServer.getArchive())
2396                                                    .smtpServer(listServer.getSMTP())
2397                                                    .webrevStorageRepository(archive)
2398                                                    .webrevStorageRef(&quot;webrev&quot;)
2399                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2400                                                    .webrevStorageBaseUri(webrevServer.uri())
2401                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2402 
2403             // Populate the projects repository
2404             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2405             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2406             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2407             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2408             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2409 
2410             // Make a change with a corresponding PR
2411             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2412             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2413             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2414             pr.setBody(&quot;This is now ready&quot;);
2415 
2416             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2417             Thread.sleep(cooldown.toMillis());
2418             TestBotRunner.runPeriodicItems(mlBot);
2419             listServer.processIncoming();
2420 
2421             // Make a comment and run the check within the cooldown period
2422             int counter;
2423             boolean noMailReceived = false;
2424             for (counter = 1; counter &lt; 10; ++counter) {
2425                 var start = Instant.now();
2426                 pr.addComment(&quot;Looks good - &quot; + counter + &quot; -&quot;);
2427 
2428                 // The bot should not bridge the comment due to cooldown
2429                 TestBotRunner.runPeriodicItems(mlBot);
2430                 try {
2431                     noMailReceived = false;
2432                     listServer.processIncoming(Duration.ofMillis(1));
2433                 } catch (RuntimeException e) {
2434                     noMailReceived = true;
2435                 }
2436                 var elapsed = Duration.between(start, Instant.now());
2437                 if (elapsed.compareTo(cooldown) &lt; 0) {
2438                     break;
2439                 } else {
2440                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2441                     // Ensure that the cooldown expires
2442                     Thread.sleep(cooldown.toMillis());
2443                     // If no mail was received, we have to flush it out
2444                     if (noMailReceived) {
2445                         TestBotRunner.runPeriodicItems(mlBot);
2446                         listServer.processIncoming();
2447                     }
2448                     cooldown = cooldown.multipliedBy(2);
2449                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2450                 }
2451             }
2452             assertTrue(noMailReceived);
2453 
2454             // But after the cooldown period has passed, it should
2455             Thread.sleep(cooldown.toMillis());
2456             TestBotRunner.runPeriodicItems(mlBot);
2457             listServer.processIncoming();
2458 
2459             // Check the archive
2460             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2461             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good - &quot; + counter + &quot; -&quot;));
2462         }
2463     }
2464 
2465     @Test
2466     void branchPrefix(TestInfo testInfo) throws IOException {
2467         try (var credentials = new HostCredentials(testInfo);
2468              var tempFolder = new TemporaryDirectory();
2469              var archiveFolder = new TemporaryDirectory();
2470              var listServer = new TestMailmanServer();
2471              var webrevServer = new TestWebrevServer()) {
2472             var author = credentials.getHostedRepository();
2473             var archive = credentials.getHostedRepository();
2474             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2475             var censusBuilder = credentials.getCensusBuilder()
2476                                            .addAuthor(author.forge().currentUser().id());
2477             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2478             var mlBot = MailingListBridgeBot.newBuilder()
2479                                             .from(from)
2480                                             .repo(author)
2481                                             .archive(archive)
2482                                             .censusRepo(censusBuilder.build())
2483                                             .list(listAddress)
2484                                             .listArchive(listServer.getArchive())
2485                                             .smtpServer(listServer.getSMTP())
2486                                             .webrevStorageRepository(archive)
2487                                             .webrevStorageRef(&quot;webrev&quot;)
2488                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2489                                             .webrevStorageBaseUri(webrevServer.uri())
2490                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2491                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2492                                             .build();
2493 
2494             // Populate the projects repository
2495             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2496             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2497             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2498             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2499 
2500             // Make a change with a corresponding PR
2501             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2502                                                                &quot;Change msg\n\nWith several lines&quot;);
2503             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2504             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2505             pr.setBody(&quot;This is a PR&quot;);
2506 
2507             // Run an archive pass
2508             TestBotRunner.runPeriodicItems(mlBot);
2509             listServer.processIncoming();
2510 
2511             pr.addComment(&quot;Looks good!&quot;);
2512             TestBotRunner.runPeriodicItems(mlBot);
2513             listServer.processIncoming();
2514 
2515             // Check the archive
2516             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2517             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[master\\] RFR: &quot;));
2518             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[master\\] RFR: &quot;));
2519         }
2520     }
2521 
2522     @Test
2523     void repoPrefix(TestInfo testInfo) throws IOException {
2524         try (var credentials = new HostCredentials(testInfo);
2525              var tempFolder = new TemporaryDirectory();
2526              var archiveFolder = new TemporaryDirectory();
2527              var listServer = new TestMailmanServer();
2528              var webrevServer = new TestWebrevServer()) {
2529             var author = credentials.getHostedRepository();
2530             var archive = credentials.getHostedRepository();
2531             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2532             var censusBuilder = credentials.getCensusBuilder()
2533                                            .addAuthor(author.forge().currentUser().id());
2534             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2535             var mlBot = MailingListBridgeBot.newBuilder()
2536                                             .from(from)
2537                                             .repo(author)
2538                                             .archive(archive)
2539                                             .censusRepo(censusBuilder.build())
2540                                             .list(listAddress)
2541                                             .listArchive(listServer.getArchive())
2542                                             .smtpServer(listServer.getSMTP())
2543                                             .webrevStorageRepository(archive)
2544                                             .webrevStorageRef(&quot;webrev&quot;)
2545                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2546                                             .webrevStorageBaseUri(webrevServer.uri())
2547                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2548                                             .repoInSubject(true)
2549                                             .build();
2550 
2551             // Populate the projects repository
2552             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2553             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2554             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2555             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2556 
2557             // Make a change with a corresponding PR
2558             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2559                                                                &quot;Change msg\n\nWith several lines&quot;);
2560             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2561             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2562             pr.setBody(&quot;This is a PR&quot;);
2563 
2564             // Run an archive pass
2565             TestBotRunner.runPeriodicItems(mlBot);
2566             listServer.processIncoming();
2567 
2568             pr.addComment(&quot;Looks good!&quot;);
2569             TestBotRunner.runPeriodicItems(mlBot);
2570             listServer.processIncoming();
2571 
2572             // Check the archive
2573             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2574             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2575             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2576         }
2577     }
2578 
2579     @Test
2580     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2581         try (var credentials = new HostCredentials(testInfo);
2582              var tempFolder = new TemporaryDirectory();
2583              var archiveFolder = new TemporaryDirectory();
2584              var listServer = new TestMailmanServer();
2585              var webrevServer = new TestWebrevServer()) {
2586             var author = credentials.getHostedRepository();
2587             var archive = credentials.getHostedRepository();
2588             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2589             var censusBuilder = credentials.getCensusBuilder()
2590                                            .addAuthor(author.forge().currentUser().id());
2591             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2592             var mlBot = MailingListBridgeBot.newBuilder()
2593                                             .from(from)
2594                                             .repo(author)
2595                                             .archive(archive)
2596                                             .censusRepo(censusBuilder.build())
2597                                             .list(listAddress)
2598                                             .listArchive(listServer.getArchive())
2599                                             .smtpServer(listServer.getSMTP())
2600                                             .webrevStorageRepository(archive)
2601                                             .webrevStorageRef(&quot;webrev&quot;)
2602                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2603                                             .webrevStorageBaseUri(webrevServer.uri())
2604                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2605                                             .repoInSubject(true)
2606                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2607                                             .build();
2608 
2609             // Populate the projects repository
2610             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2611             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2612             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2613             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2614 
2615             // Make a change with a corresponding PR
2616             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2617                                                                &quot;Change msg\n\nWith several lines&quot;);
2618             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2619             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2620             pr.setBody(&quot;This is a PR&quot;);
2621 
2622             // Run an archive pass
2623             TestBotRunner.runPeriodicItems(mlBot);
2624             listServer.processIncoming();
2625 
2626             pr.addComment(&quot;Looks good!&quot;);
2627             TestBotRunner.runPeriodicItems(mlBot);
2628             listServer.processIncoming();
2629 
2630             // Check the archive
2631             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2632             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2633             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2634         }
2635     }
2636 
2637     @Test
2638     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2639         try (var credentials = new HostCredentials(testInfo);
2640              var tempFolder = new TemporaryDirectory();
2641              var archiveFolder = new TemporaryDirectory();
2642              var listServer = new TestMailmanServer();
2643              var webrevServer = new TestWebrevServer()) {
2644             var bot = credentials.getHostedRepository();
2645             var author = credentials.getHostedRepository();
2646             var archive = credentials.getHostedRepository();
2647             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2648             var censusBuilder = credentials.getCensusBuilder()
2649                                            .addAuthor(author.forge().currentUser().id());
2650             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2651             var cooldown = Duration.ofMillis(500);
2652             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2653                                                    .from(from)
2654                                                    .repo(bot)
2655                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2656                                                    .archive(archive)
2657                                                    .censusRepo(censusBuilder.build())
2658                                                    .list(listAddress)
2659                                                    .listArchive(listServer.getArchive())
2660                                                    .smtpServer(listServer.getSMTP())
2661                                                    .webrevStorageRepository(archive)
2662                                                    .webrevStorageRef(&quot;webrev&quot;)
2663                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2664                                                    .webrevStorageBaseUri(webrevServer.uri())
2665                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2666 
2667             // Populate the projects repository
2668             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2669             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2670             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2671             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2672             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2673 
2674             // Make a change with a corresponding PR
2675             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2676             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2677             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2678             pr.setBody(&quot;This is now ready&quot;);
2679 
2680             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2681             Thread.sleep(cooldown.toMillis());
2682             TestBotRunner.runPeriodicItems(mlBot);
2683             listServer.processIncoming();
2684 
2685             // Make a new revision and run the check within the cooldown period
2686             int counter;
2687             boolean noMailReceived = false;
2688             for (counter = 1; counter &lt; 10; ++counter) {
2689                 var start = Instant.now();
2690                 var revHash = CheckableRepository.appendAndCommit(localRepo, &quot;more stuff&quot;, &quot;Update number - &quot; + counter + &quot; -&quot;);
2691                 localRepo.push(revHash, author.url(), &quot;edit&quot;);
2692 
2693                 // The bot should not bridge the new revision due to cooldown
2694                 TestBotRunner.runPeriodicItems(mlBot);
2695                 try {
2696                     noMailReceived = false;
2697                     listServer.processIncoming(Duration.ofMillis(1));
2698                 } catch (RuntimeException e) {
2699                     noMailReceived = true;
2700                 }
2701                 var elapsed = Duration.between(start, Instant.now());
2702                 if (elapsed.compareTo(cooldown) &lt; 0) {
2703                     break;
2704                 } else {
2705                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2706                     // Ensure that the cooldown expires
2707                     Thread.sleep(cooldown.toMillis());
2708                     // If no mail was received, we have to flush it out
2709                     if (noMailReceived) {
2710                         TestBotRunner.runPeriodicItems(mlBot);
2711                         listServer.processIncoming();
2712                     }
2713                     cooldown = cooldown.multipliedBy(2);
2714                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2715                 }
2716             }
2717             assertTrue(noMailReceived);
2718 
2719             // But after the cooldown period has passed, it should
2720             Thread.sleep(cooldown.toMillis());
2721             TestBotRunner.runPeriodicItems(mlBot);
2722             listServer.processIncoming();
2723 
2724             // Check the archive
2725             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2726             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
2727         }
2728     }
2729 }
    </pre>
  </body>
</html>