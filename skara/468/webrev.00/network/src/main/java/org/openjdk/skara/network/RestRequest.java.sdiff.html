<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff network/src/main/java/org/openjdk/skara/network/RestRequest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../issuetracker/src/main/java/org/openjdk/skara/issuetracker/jira/JiraProject.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../test/java/org/openjdk/skara/network/RestRequestTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>network/src/main/java/org/openjdk/skara/network/RestRequest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 32 import java.util.logging.Logger;
 33 import java.util.regex.Pattern;
 34 import java.util.stream.Collectors;
 35 
 36 public class RestRequest {
 37     private enum RequestType {
 38         GET,
 39         POST,
 40         PUT,
 41         PATCH,
 42         DELETE
 43     }
 44 
 45     @FunctionalInterface
 46     public interface AuthenticationGenerator {
 47         List&lt;String&gt; getAuthHeaders();
 48     }
 49 
 50     @FunctionalInterface
 51     public interface ErrorTransform {
<span class="line-modified"> 52         JSONValue onError(HttpResponse&lt;String&gt; response);</span>
 53     }
 54 
 55     public class QueryBuilder {
 56         private class Param {
 57             String key;
 58             String value;
 59         }
 60 
 61         private final RequestType queryType;
 62         private final String endpoint;
 63 
 64         private final List&lt;Param&gt; params = new ArrayList&lt;&gt;();
 65         private final List&lt;Param&gt; bodyParams = new ArrayList&lt;&gt;();
 66         private final Map&lt;String, String&gt; headers = new HashMap&lt;&gt;();
 67         private JSONValue body;
 68         private int maxPages;
 69         private ErrorTransform onError;
 70 
 71         private QueryBuilder(RequestType queryType, String endpoint) {
 72             this.queryType = queryType;
</pre>
<hr />
<pre>
244                         throw new RuntimeException(ex);
245                     }
246                 }
247             }
248             retryCount++;
249         }
250 
251         logRateLimit(response.headers());
252         return response;
253     }
254 
255     private JSONValue parseResponse(HttpResponse&lt;String&gt; response) {
256         if (response.body().isEmpty()) {
257             return JSON.of();
258         }
259         return JSON.parse(response.body());
260     }
261 
262     private Optional&lt;JSONValue&gt; transformBadResponse(HttpResponse&lt;String&gt; response, QueryBuilder queryBuilder) {
263         if (response.statusCode() &gt;= 400) {
<span class="line-modified">264             if (queryBuilder.onError == null) {</span>
<span class="line-modified">265                 log.warning(queryBuilder.toString());</span>
<span class="line-modified">266                 log.warning(response.body());</span>
<span class="line-modified">267                 throw new RuntimeException(&quot;Request returned bad status: &quot; + response.statusCode());</span>
<span class="line-modified">268             } else {</span>
<span class="line-removed">269                 return Optional.of(queryBuilder.onError.onError(response));</span>
270             }



271         } else {
272             return Optional.empty();
273         }
274     }
275 
276     private HttpRequest createRequest(RequestType requestType, String endpoint, JSONValue body,
277                                       List&lt;QueryBuilder.Param&gt; params, Map&lt;String, String&gt; headers) {
278         var uriBuilder = URIBuilder.base(apiBase);
279         if (endpoint != null &amp;&amp; !endpoint.isEmpty()) {
280             uriBuilder = uriBuilder.appendPath(endpoint);
281         }
282         if (!params.isEmpty()) {
283             uriBuilder.setQuery(params.stream().collect(Collectors.toMap(param -&gt; param.key, param -&gt; param.value)));
284         }
285         var uri = uriBuilder.build();
286 
287         var requestBuilder = HttpRequest.newBuilder()
288                                         .uri(uri)
289                                         .timeout(Duration.ofSeconds(30))
290                                         .header(&quot;Content-type&quot;, &quot;application/json&quot;);
</pre>
</td>
<td>
<hr />
<pre>
 32 import java.util.logging.Logger;
 33 import java.util.regex.Pattern;
 34 import java.util.stream.Collectors;
 35 
 36 public class RestRequest {
 37     private enum RequestType {
 38         GET,
 39         POST,
 40         PUT,
 41         PATCH,
 42         DELETE
 43     }
 44 
 45     @FunctionalInterface
 46     public interface AuthenticationGenerator {
 47         List&lt;String&gt; getAuthHeaders();
 48     }
 49 
 50     @FunctionalInterface
 51     public interface ErrorTransform {
<span class="line-modified"> 52         Optional&lt;JSONValue&gt; onError(HttpResponse&lt;String&gt; response);</span>
 53     }
 54 
 55     public class QueryBuilder {
 56         private class Param {
 57             String key;
 58             String value;
 59         }
 60 
 61         private final RequestType queryType;
 62         private final String endpoint;
 63 
 64         private final List&lt;Param&gt; params = new ArrayList&lt;&gt;();
 65         private final List&lt;Param&gt; bodyParams = new ArrayList&lt;&gt;();
 66         private final Map&lt;String, String&gt; headers = new HashMap&lt;&gt;();
 67         private JSONValue body;
 68         private int maxPages;
 69         private ErrorTransform onError;
 70 
 71         private QueryBuilder(RequestType queryType, String endpoint) {
 72             this.queryType = queryType;
</pre>
<hr />
<pre>
244                         throw new RuntimeException(ex);
245                     }
246                 }
247             }
248             retryCount++;
249         }
250 
251         logRateLimit(response.headers());
252         return response;
253     }
254 
255     private JSONValue parseResponse(HttpResponse&lt;String&gt; response) {
256         if (response.body().isEmpty()) {
257             return JSON.of();
258         }
259         return JSON.parse(response.body());
260     }
261 
262     private Optional&lt;JSONValue&gt; transformBadResponse(HttpResponse&lt;String&gt; response, QueryBuilder queryBuilder) {
263         if (response.statusCode() &gt;= 400) {
<span class="line-modified">264             if (queryBuilder.onError != null) {</span>
<span class="line-modified">265                 var transformed = queryBuilder.onError.onError(response);</span>
<span class="line-modified">266                 if (transformed.isPresent()) {</span>
<span class="line-modified">267                     return transformed;</span>
<span class="line-modified">268                 }</span>

269             }
<span class="line-added">270             log.warning(queryBuilder.toString());</span>
<span class="line-added">271             log.warning(response.body());</span>
<span class="line-added">272             throw new RuntimeException(&quot;Request returned bad status: &quot; + response.statusCode());</span>
273         } else {
274             return Optional.empty();
275         }
276     }
277 
278     private HttpRequest createRequest(RequestType requestType, String endpoint, JSONValue body,
279                                       List&lt;QueryBuilder.Param&gt; params, Map&lt;String, String&gt; headers) {
280         var uriBuilder = URIBuilder.base(apiBase);
281         if (endpoint != null &amp;&amp; !endpoint.isEmpty()) {
282             uriBuilder = uriBuilder.appendPath(endpoint);
283         }
284         if (!params.isEmpty()) {
285             uriBuilder.setQuery(params.stream().collect(Collectors.toMap(param -&gt; param.key, param -&gt; param.value)));
286         }
287         var uri = uriBuilder.build();
288 
289         var requestBuilder = HttpRequest.newBuilder()
290                                         .uri(uri)
291                                         .timeout(Duration.ofSeconds(30))
292                                         .header(&quot;Content-type&quot;, &quot;application/json&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../issuetracker/src/main/java/org/openjdk/skara/issuetracker/jira/JiraProject.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../test/java/org/openjdk/skara/network/RestRequestTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>