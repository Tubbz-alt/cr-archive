<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff cli/src/main/java/org/openjdk/skara/cli/GitJCheck.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="GitSync.java.udiff.html" target="_top">next &gt;</a></center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitJCheck.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -106,29 +106,19 @@</span>
              Option.shortcut(&quot;&quot;)
                    .fullname(&quot;ignore&quot;)
                    .describe(&quot;CHECKS&quot;)
                    .helptext(&quot;Ignore errors from checks with the given name&quot;)
                    .optional(),
<span class="udiff-line-modified-removed">-             Option.shortcut(&quot;&quot;)</span>
<span class="udiff-line-modified-removed">-                   .fullname(&quot;push-url&quot;)</span>
<span class="udiff-line-modified-removed">-                   .describe(&quot;URL&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;URL that is being pushed to&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Option.shortcut(&quot;&quot;)</span>
<span class="udiff-line-removed">-                   .fullname(&quot;setup-pre-push-hooks&quot;)</span>
<span class="udiff-line-removed">-                   .describe(&quot;CHECKS&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Set up a pre-push hook for the given checks&quot;)</span>
<span class="udiff-line-modified-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="udiff-line-modified-added">+                   .fullname(&quot;setup-pre-push-hook&quot;)</span>
<span class="udiff-line-modified-added">+                   .helptext(&quot;Set up a pre-push hook that runs jcheck on commits to be pushed&quot;)</span>
                    .optional(),
              Switch.shortcut(&quot;m&quot;)
                    .fullname(&quot;mercurial&quot;)
                    .helptext(&quot;Deprecated: force use of mercurial&quot;)
                    .optional(),
              Switch.shortcut(&quot;&quot;)
<span class="udiff-line-removed">-                   .fullname(&quot;pre-push&quot;)</span>
<span class="udiff-line-removed">-                   .helptext(&quot;Execute as a pre-push hook&quot;)</span>
<span class="udiff-line-removed">-                   .optional(),</span>
<span class="udiff-line-removed">-             Switch.shortcut(&quot;v&quot;)</span>
                    .fullname(&quot;verbose&quot;)
                    .helptext(&quot;Turn on verbose output&quot;)
                    .optional(),
              Switch.shortcut(&quot;&quot;)
                    .fullname(&quot;debug&quot;)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -162,41 +152,27 @@</span>
          }
  
          HttpProxy.setup();
  
          var isMercurial = getSwitch(&quot;mercurial&quot;, arguments);
<span class="udiff-line-modified-removed">-         var setupPrePushHooksOption = getOption(&quot;setup-pre-push-hooks&quot;, arguments);</span>
<span class="udiff-line-modified-removed">-         if (!isMercurial &amp;&amp; setupPrePushHooksOption != null) {</span>
<span class="udiff-line-modified-added">+         var setupPrePushHook = getSwitch(&quot;setup-pre-push-hook&quot;, arguments);</span>
<span class="udiff-line-modified-added">+         if (!isMercurial &amp;&amp; setupPrePushHook) {</span>
              var hookFile = repo.root().resolve(&quot;.git&quot;).resolve(&quot;hooks&quot;).resolve(&quot;pre-push&quot;);
              Files.createDirectories(hookFile.getParent());
              var lines = List.of(
                  &quot;#!/usr/bin/sh&quot;,
<span class="udiff-line-modified-removed">-                 &quot;git jcheck --pre-push --push-url=\&quot;$2\&quot;&quot;</span>
<span class="udiff-line-modified-added">+                 &quot;JCHECK_IS_PRE_PUSH_HOOK=1 git jcheck&quot;</span>
              );
              Files.write(hookFile, lines);
              if (hookFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
                  var permissions = PosixFilePermissions.fromString(&quot;rwxr-xr-x&quot;);
                  Files.setPosixFilePermissions(hookFile, permissions);
              }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             for (var check : setupPrePushHooksOption.split(&quot;,&quot;)) {</span>
<span class="udiff-line-removed">-                 switch (check.trim()) {</span>
<span class="udiff-line-removed">-                     case &quot;branches&quot;:</span>
<span class="udiff-line-removed">-                         repo.config(&quot;jcheck.pre-push&quot;, &quot;branches&quot;, &quot;true&quot;, false);</span>
<span class="udiff-line-removed">-                         break;</span>
<span class="udiff-line-removed">-                     case &quot;commits&quot;:</span>
<span class="udiff-line-removed">-                         repo.config(&quot;jcheck.pre-push&quot;, &quot;commits&quot;, &quot;true&quot;, false);</span>
<span class="udiff-line-removed">-                         break;</span>
<span class="udiff-line-removed">-                     default:</span>
<span class="udiff-line-removed">-                         System.err.println(&quot;error: unexpected pre-push check: &quot; + check.trim());</span>
<span class="udiff-line-removed">-                         return 1;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
              return 0;
          }
  
<span class="udiff-line-modified-removed">-         var isPrePush = getSwitch(&quot;pre-push&quot;, arguments);</span>
<span class="udiff-line-modified-added">+         var isPrePush = System.getenv().containsKey(&quot;JCHECK_IS_PRE_PUSH_HOOK&quot;);</span>
          var ranges = new ArrayList&lt;String&gt;();
          var targetBranches = new HashSet&lt;String&gt;();
          if (!isMercurial &amp;&amp; isPrePush) {
              var reader = new BufferedReader(new InputStreamReader(System.in));
              var lines = reader.lines().collect(Collectors.toList());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -277,64 +253,17 @@</span>
              for (var check : ignoreOption.split(&quot;,&quot;)) {
                  ignore.add(check.trim());
              }
          }
  
<span class="udiff-line-removed">-         var lines = repo.config(&quot;jcheck.pre-push.branches&quot;);</span>
<span class="udiff-line-removed">-         var shouldCheckRemoteBranches = lines.size() == 1 &amp;&amp; lines.get(0).toLowerCase().equals(&quot;true&quot;);</span>
<span class="udiff-line-removed">-         if (!isMercurial &amp;&amp; isPrePush &amp;&amp; shouldCheckRemoteBranches &amp;&amp;</span>
<span class="udiff-line-removed">-             !Files.exists(repo.root().resolve(&quot;.git&quot;).resolve(&quot;GIT_SYNC_RUNNING&quot;))) {</span>
<span class="udiff-line-removed">-             var url = arguments.get(&quot;push-url&quot;).asString();</span>
<span class="udiff-line-removed">-             if (url == null) {</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;error: url for push not provided via --url option&quot;);</span>
<span class="udiff-line-removed">-                 return 1;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             var webUrl = Remote.toWebURI(url);</span>
<span class="udiff-line-removed">-             var forge = Forge.from(webUrl);</span>
<span class="udiff-line-removed">-             if (!forge.isPresent()) {</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;error: cannot find forge for &quot; + webUrl);</span>
<span class="udiff-line-removed">-                 return 1;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             var remoteRepo = forge.get().repository(webUrl.getPath().substring(1));</span>
<span class="udiff-line-removed">-             if (!remoteRepo.isPresent()) {</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;error: could not find remote repository at &quot; + webUrl);</span>
<span class="udiff-line-removed">-                 return 1;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             var parentRepo = remoteRepo.get().parent();</span>
<span class="udiff-line-removed">-             if (!parentRepo.isPresent()) {</span>
<span class="udiff-line-removed">-                 System.err.println(&quot;error: could not find upstream repository for &quot; + webUrl);</span>
<span class="udiff-line-removed">-                 return 1;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var upstreamBranchNames = repo.remoteBranches(parentRepo.get().webUrl().toString())</span>
<span class="udiff-line-removed">-                                           .stream()</span>
<span class="udiff-line-removed">-                                           .map(r -&gt; r.name())</span>
<span class="udiff-line-removed">-                                           .collect(Collectors.toSet());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var displayedError = false;</span>
<span class="udiff-line-removed">-             for (var branch : targetBranches) {</span>
<span class="udiff-line-removed">-                 if (upstreamBranchNames.contains(branch)) {</span>
<span class="udiff-line-removed">-                     System.err.println(&quot;error: should not push to branch in personal fork also present in upstream repository: &quot; + branch);</span>
<span class="udiff-line-removed">-                     displayedError = true;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             if (displayedError) {</span>
<span class="udiff-line-removed">-                 return 1;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
          var isLax = getSwitch(&quot;lax&quot;, arguments);
          var visitor = new JCheckCLIVisitor(ignore, isMercurial, isLax);
<span class="udiff-line-removed">-         lines = repo.config(&quot;jcheck.pre-push.commits&quot;);</span>
<span class="udiff-line-removed">-         var shouldCheckCommits = lines.size() == 1 &amp;&amp; lines.get(0).toLowerCase().equals(&quot;true&quot;);</span>
          var commitMessageParser = isMercurial ? CommitMessageParsers.v0 : CommitMessageParsers.v1;
<span class="udiff-line-modified-removed">-         if (!isPrePush || shouldCheckCommits) {</span>
<span class="udiff-line-modified-removed">-             for (var range : ranges) {</span>
<span class="udiff-line-modified-removed">-                 try (var errors = JCheck.check(repo, census, commitMessageParser, range, whitelist, blacklist)) {</span>
<span class="udiff-line-modified-removed">-                     for (var error : errors) {</span>
<span class="udiff-line-removed">-                         error.accept(visitor);</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-modified-added">+         for (var range : ranges) {</span>
<span class="udiff-line-modified-added">+             try (var errors = JCheck.check(repo, census, commitMessageParser, range, whitelist, blacklist)) {</span>
<span class="udiff-line-modified-added">+                 for (var error : errors) {</span>
<span class="udiff-line-modified-added">+                     error.accept(visitor);</span>
                  }
              }
          }
          return visitor.hasDisplayedErrors() ? 1 : 0;
      }
</pre>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="GitSync.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>