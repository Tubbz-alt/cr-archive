<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames cli/src/main/java/org/openjdk/skara/cli/GitJCheck.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.cli;
 24 
 25 import org.openjdk.skara.args.*;
 26 import org.openjdk.skara.census.Census;
 27 import org.openjdk.skara.forge.*;
 28 import org.openjdk.skara.jcheck.*;
 29 import org.openjdk.skara.json.JSON;
 30 import org.openjdk.skara.json.JSONValue;
 31 import org.openjdk.skara.vcs.*;
 32 import org.openjdk.skara.proxy.HttpProxy;
 33 import org.openjdk.skara.vcs.openjdk.CommitMessageParsers;
 34 import org.openjdk.skara.version.Version;
 35 
 36 import java.io.*;
 37 import java.net.*;
 38 import java.nio.file.*;
 39 import java.nio.file.attribute.PosixFilePermissions;
 40 import java.nio.charset.StandardCharsets;
 41 import java.util.*;
 42 import java.util.regex.Pattern;
 43 import java.util.stream.Collectors;
 44 import java.util.logging.Level;
 45 
 46 public class GitJCheck {
 47     static String gitConfig(String key) {
 48         try {
 49             var pb = new ProcessBuilder(&quot;git&quot;, &quot;config&quot;, key);
 50             pb.redirectOutput(ProcessBuilder.Redirect.PIPE);
 51             pb.redirectError(ProcessBuilder.Redirect.DISCARD);
 52             var p = pb.start();
 53 
 54             var output = new String(p.getInputStream().readAllBytes(), StandardCharsets.UTF_8);
 55             var res = p.waitFor();
 56             if (res != 0) {
 57                 return null;
 58             }
 59 
 60             return output == null ? null : output.replace(&quot;\n&quot;, &quot;&quot;);
 61         } catch (InterruptedException e) {
 62             return null;
 63         } catch (IOException e) {
 64             return null;
 65         }
 66     }
 67 
 68     static String getOption(String name, Arguments arguments) {
 69         if (arguments.contains(name)) {
 70             return arguments.get(name).asString();
 71         }
 72 
 73         return gitConfig(&quot;jcheck.&quot; + name);
 74     }
 75 
 76     static boolean getSwitch(String name, Arguments arguments) {
 77         if (arguments.contains(name)) {
 78             return true;
 79         }
 80         var value = gitConfig(&quot;jcheck.&quot; + name);
 81         return value != null &amp;&amp; value.toLowerCase().equals(&quot;true&quot;);
 82     }
 83 
 84     public static int run(Repository repo, String[] args) throws IOException {
 85         var flags = List.of(
 86             Option.shortcut(&quot;r&quot;)
 87                   .fullname(&quot;rev&quot;)
 88                   .describe(&quot;REV&quot;)
 89                   .helptext(&quot;Check the specified revision or range (default: HEAD)&quot;)
 90                   .optional(),
 91             Option.shortcut(&quot;&quot;)
 92                   .fullname(&quot;whitelist&quot;)
 93                   .describe(&quot;FILE&quot;)
 94                   .helptext(&quot;Use the specified whitelist (default: .jcheck/whitelist.json)&quot;)
 95                   .optional(),
 96             Option.shortcut(&quot;&quot;)
 97                   .fullname(&quot;blacklist&quot;)
 98                   .describe(&quot;FILE&quot;)
 99                   .helptext(&quot;Use the specified blacklist (default: .jcheck/blacklist.json)&quot;)
100                   .optional(),
101             Option.shortcut(&quot;&quot;)
102                   .fullname(&quot;census&quot;)
103                   .describe(&quot;FILE&quot;)
104                   .helptext(&quot;Use the specified census (default: https://openjdk.java.net/census.xml)&quot;)
105                   .optional(),
106             Option.shortcut(&quot;&quot;)
107                   .fullname(&quot;ignore&quot;)
108                   .describe(&quot;CHECKS&quot;)
109                   .helptext(&quot;Ignore errors from checks with the given name&quot;)
110                   .optional(),
<a name="1" id="anc1"></a><span class="line-modified">111             Switch.shortcut(&quot;&quot;)</span>
<span class="line-modified">112                   .fullname(&quot;setup-pre-push-hook&quot;)</span>
<span class="line-modified">113                   .helptext(&quot;Set up a pre-push hook that runs jcheck on commits to be pushed&quot;)</span>






114                   .optional(),
115             Switch.shortcut(&quot;m&quot;)
116                   .fullname(&quot;mercurial&quot;)
117                   .helptext(&quot;Deprecated: force use of mercurial&quot;)
118                   .optional(),
119             Switch.shortcut(&quot;&quot;)
<a name="2" id="anc2"></a>



120                   .fullname(&quot;verbose&quot;)
121                   .helptext(&quot;Turn on verbose output&quot;)
122                   .optional(),
123             Switch.shortcut(&quot;&quot;)
124                   .fullname(&quot;debug&quot;)
125                   .helptext(&quot;Turn on debugging output&quot;)
126                   .optional(),
127             Switch.shortcut(&quot;&quot;)
128                   .fullname(&quot;lax&quot;)
129                   .helptext(&quot;Check comments, tags and whitespace laxly&quot;)
130                   .optional(),
131             Switch.shortcut(&quot;s&quot;)
132                   .fullname(&quot;strict&quot;)
133                   .helptext(&quot;Check everything&quot;)
134                   .optional(),
135             Switch.shortcut(&quot;v&quot;)
136                   .fullname(&quot;version&quot;)
137                   .helptext(&quot;Print the version of this tool&quot;)
138                   .optional()
139         );
140 
141         var parser = new ArgumentParser(&quot;git jcheck&quot;, flags, List.of());
142         var arguments = parser.parse(args);
143 
144         if (arguments.contains(&quot;version&quot;)) {
145             System.out.println(&quot;git-jcheck version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));
146             return 0;
147         }
148 
149         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {
150             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;
151             Logging.setup(level, &quot;jcheck&quot;);
152         }
153 
154         HttpProxy.setup();
155 
156         var isMercurial = getSwitch(&quot;mercurial&quot;, arguments);
<a name="3" id="anc3"></a><span class="line-modified">157         var setupPrePushHook = getSwitch(&quot;setup-pre-push-hook&quot;, arguments);</span>
<span class="line-modified">158         if (!isMercurial &amp;&amp; setupPrePushHook) {</span>
159             var hookFile = repo.root().resolve(&quot;.git&quot;).resolve(&quot;hooks&quot;).resolve(&quot;pre-push&quot;);
160             Files.createDirectories(hookFile.getParent());
161             var lines = List.of(
162                 &quot;#!/usr/bin/sh&quot;,
<a name="4" id="anc4"></a><span class="line-modified">163                 &quot;JCHECK_IS_PRE_PUSH_HOOK=1 git jcheck&quot;</span>
164             );
165             Files.write(hookFile, lines);
166             if (hookFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
167                 var permissions = PosixFilePermissions.fromString(&quot;rwxr-xr-x&quot;);
168                 Files.setPosixFilePermissions(hookFile, permissions);
169             }
<a name="5" id="anc5"></a>













170             return 0;
171         }
172 
<a name="6" id="anc6"></a><span class="line-modified">173         var isPrePush = System.getenv().containsKey(&quot;JCHECK_IS_PRE_PUSH_HOOK&quot;);</span>
174         var ranges = new ArrayList&lt;String&gt;();
175         var targetBranches = new HashSet&lt;String&gt;();
176         if (!isMercurial &amp;&amp; isPrePush) {
177             var reader = new BufferedReader(new InputStreamReader(System.in));
178             var lines = reader.lines().collect(Collectors.toList());
179             for (var line : lines) {
180                 var parts = line.split(&quot; &quot;);
181                 var localHash = new Hash(parts[1]);
182                 var remoteRef = parts[2];
183                 var remoteHash = new Hash(parts[3]);
184 
185                 if (localHash.equals(Hash.zero())) {
186                     continue;
187                 }
188 
189                 if (remoteHash.equals(Hash.zero())) {
190                     ranges.add(&quot;origin..&quot; + localHash.hex());
191                 } else {
192                     targetBranches.add(Path.of(remoteRef).getFileName().toString());
193                     ranges.add(remoteHash.hex() + &quot;..&quot; + localHash.hex());
194                 }
195             }
196         } else {
197             var defaultRange = isMercurial ? &quot;tip&quot; : &quot;HEAD^..HEAD&quot;;
198             ranges.add(arguments.get(&quot;rev&quot;).orString(defaultRange));
199         }
200 
201         for (var range : ranges) {
202             if (!repo.isValidRevisionRange(range)) {
203                 System.err.println(String.format(&quot;error: %s is not a valid range of revisions,&quot;, range));
204                 if (isMercurial) {
205                     System.err.println(&quot;       see &#39;hg help revisions&#39; for how to specify revisions&quot;);
206                 } else {
207                     System.err.println(&quot;       see &#39;man 7 gitrevisions&#39; for how to specify revisions&quot;);
208                 }
209                 return 1;
210             }
211         }
212 
213         var whitelistOption = getOption(&quot;whitelist&quot;, arguments);
214         if (whitelistOption == null) {
215             whitelistOption = &quot;.jcheck/whitelist.json&quot;;
216         }
217         var whitelistFile = Path.of(whitelistOption);
218         var whitelist = new HashMap&lt;String, Set&lt;Hash&gt;&gt;();
219         if (Files.exists(whitelistFile)) {
220             var json = JSON.parse(Files.readString(whitelistFile));
221             for (var field : json.fields()) {
222                 var check = field.name();
223                 var hashes = field.value().stream().map(JSONValue::asString).map(Hash::new).collect(Collectors.toSet());
224                 whitelist.put(check, hashes);
225             }
226         }
227 
228         var blacklistOption = getOption(&quot;blacklist&quot;, arguments);
229         if (blacklistOption == null) {
230             blacklistOption = &quot;.jcheck/blacklist.json&quot;;
231         }
232         var blacklistFile = Path.of(blacklistOption);
233         var blacklist = new HashSet&lt;Hash&gt;();
234         if (Files.exists(blacklistFile)) {
235             var json = JSON.parse(Files.readString(blacklistFile));
236             json.get(&quot;commits&quot;).stream()
237                                .map(JSONValue::asString)
238                                .map(Hash::new)
239                                .forEach(blacklist::add);
240         }
241 
242         var endpoint = getOption(&quot;census&quot;, arguments);
243         if (endpoint == null) {
244             endpoint = &quot;https://openjdk.java.net/census.xml&quot;;
245         }
246         var census = endpoint.startsWith(&quot;http://&quot;) || endpoint.startsWith(&quot;https://&quot;) ?
247             Census.from(URI.create(endpoint)) :
248             Census.parse(Path.of(endpoint));
249 
250         var ignore = new HashSet&lt;String&gt;();
251         var ignoreOption = getOption(&quot;ignore&quot;, arguments);
252         if (ignoreOption != null) {
253             for (var check : ignoreOption.split(&quot;,&quot;)) {
254                 ignore.add(check.trim());
255             }
256         }
257 
<a name="7" id="anc7"></a>










































258         var isLax = getSwitch(&quot;lax&quot;, arguments);
259         var visitor = new JCheckCLIVisitor(ignore, isMercurial, isLax);
<a name="8" id="anc8"></a>

260         var commitMessageParser = isMercurial ? CommitMessageParsers.v0 : CommitMessageParsers.v1;
<a name="9" id="anc9"></a><span class="line-modified">261         for (var range : ranges) {</span>
<span class="line-modified">262             try (var errors = JCheck.check(repo, census, commitMessageParser, range, whitelist, blacklist)) {</span>
<span class="line-modified">263                 for (var error : errors) {</span>
<span class="line-modified">264                     error.accept(visitor);</span>


265                 }
266             }
267         }
268         return visitor.hasDisplayedErrors() ? 1 : 0;
269     }
270 
271     public static void main(String[] args) throws IOException {
272         var cwd = Paths.get(&quot;&quot;).toAbsolutePath();
273         var repository = Repository.get(cwd);
274         if (!repository.isPresent()) {
275             System.err.println(String.format(&quot;error: %s is not a repository&quot;, cwd.toString()));
276             System.exit(1);
277         }
278 
279         System.exit(run(repository.get(), args));
280     }
281 }
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>