<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/pr/src/test/java/org/openjdk/skara/bots/pr/IntegrateTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.pr;
 24 
 25 import org.openjdk.skara.forge.*;
 26 import org.openjdk.skara.issuetracker.Comment;
 27 import org.openjdk.skara.test.*;
 28 import org.openjdk.skara.vcs.Repository;
 29 
 30 import org.junit.jupiter.api.*;
 31 
 32 import java.io.IOException;
 33 import java.nio.charset.StandardCharsets;
 34 import java.nio.file.*;
 35 import java.util.Set;
 36 import java.util.stream.Collectors;
 37 
 38 import static org.junit.jupiter.api.Assertions.*;
 39 import static org.openjdk.skara.bots.pr.PullRequestAsserts.assertLastCommentContains;
 40 
 41 class IntegrateTests {
 42     @Test
 43     void simpleMerge(TestInfo testInfo) throws IOException {
 44         try (var credentials = new HostCredentials(testInfo);
 45              var tempFolder = new TemporaryDirectory();
 46              var pushedFolder = new TemporaryDirectory()) {
 47 
 48             var author = credentials.getHostedRepository();
 49             var integrator = credentials.getHostedRepository();
 50             var reviewer = credentials.getHostedRepository();
 51             var censusBuilder = credentials.getCensusBuilder()
 52                                            .addCommitter(author.forge().currentUser().id())
 53                                            .addReviewer(integrator.forge().currentUser().id())
 54                                            .addReviewer(reviewer.forge().currentUser().id());
 55             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
 56 
 57             // Populate the projects repository
 58             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 59             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 60             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 61             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 62 
 63             // Make a change with a corresponding PR
 64             var editHash = CheckableRepository.appendAndCommit(localRepo);
 65             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 66             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 67 
 68             // Approve it as another user
 69             var approvalPr = integrator.pullRequest(pr.id());
 70             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 71 
 72             // The bot should reply with integration message
 73             TestBotRunner.runPeriodicItems(mergeBot);
 74             var integrateComments = pr.comments()
 75                                       .stream()
 76                                       .filter(c -&gt; c.body().contains(&quot;To integrate this PR with the above commit message to the `master` branch&quot;))
 77                                       .filter(c -&gt; c.body().contains(&quot;If you would like to avoid potential automatic rebasing&quot;))
 78                                       .filter(c -&gt; c.body().contains(&quot;`/integrate &quot; + masterHash.hex() + &quot;`&quot;))
 79                                       .count();
 80             assertEquals(1, integrateComments);
 81 
 82             // Attempt a merge (the bot should only process the first one)
 83             pr.addComment(&quot;/integrate&quot;);
 84             pr.addComment(&quot;/integrate&quot;);
 85             pr.addComment(&quot;/integrate&quot;);
 86             TestBotRunner.runPeriodicItems(mergeBot);
 87 
 88             // The bot should reply with an ok message
 89             var pushed = pr.comments().stream()
 90                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
 91                            .count();
 92             assertEquals(1, pushed);
 93 
 94             // The change should now be present on the master branch
 95             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
 96             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
 97 
 98             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
 99             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
100 
101             // Author and committer should be the same
102             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
103             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
104             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
105             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
106             assertTrue(pr.labels().contains(&quot;integrated&quot;));
107 
108             // Ready label should have been removed
109             assertFalse(pr.labels().contains(&quot;ready&quot;));
110         }
111     }
112 
113     @Test
114     void reviewersRetained(TestInfo testInfo) throws IOException {
115         try (var credentials = new HostCredentials(testInfo);
116              var tempFolder = new TemporaryDirectory();
117              var pushedFolder = new TemporaryDirectory()) {
118             var author = credentials.getHostedRepository();
119             var integrator = credentials.getHostedRepository();
120             var committer = credentials.getHostedRepository();
121 
122             var censusBuilder = credentials.getCensusBuilder()
123                                            .addCommitter(author.forge().currentUser().id())
124                                            .addCommitter(committer.forge().currentUser().id())
125                                            .addReviewer(integrator.forge().currentUser().id());
126             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
127 
128             // Populate the projects repository
129             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
130             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
131             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
132             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
133 
134             // Make a change with a corresponding PR
135             var editHash = CheckableRepository.appendAndCommit(localRepo);
136             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
137             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
138 
139             // Review it twice
140             var integratorPr = integrator.pullRequest(pr.id());
141             var committerPr = committer.pullRequest(pr.id());
142             integratorPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
143             committerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
144 
145             // Attempt a merge
146             pr.addComment(&quot;/integrate&quot;);
147             TestBotRunner.runPeriodicItems(mergeBot);
148 
149             // The bot should reply with an ok message
150             var pushed = pr.comments().stream()
151                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
152                            .count();
153             assertEquals(1, pushed);
154 
155             // The change should now be present on the master branch
156             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
157             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
158             var headCommit = pushedRepo.commits(&quot;HEAD&quot;).asList().get(0);
159             assertTrue(String.join(&quot;&quot;, headCommit.message())
160                              .matches(&quot;.*Reviewed-by: integrationreviewer3, integrationcommitter2$&quot;),
161                        String.join(&quot;&quot;, headCommit.message()));
162         }
163     }
164 
165     @Test
166     void notChecked(TestInfo testInfo) throws IOException {
167         try (var credentials = new HostCredentials(testInfo);
168              var tempFolder = new TemporaryDirectory()) {
169             var author = credentials.getHostedRepository();
170             var integrator = credentials.getHostedRepository();
171             var censusBuilder = credentials.getCensusBuilder()
172                                            .addAuthor(author.forge().currentUser().id());
173             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
174 
175             // Populate the projects repository
176             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
177             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
178             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
179             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
180 
181             // Make a change with a corresponding PR
182             var editHash = CheckableRepository.appendAndCommit(localRepo);
183             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
184             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
185 
<a name="1" id="anc1"></a><span class="line-modified">186             // Attempt a merge, do not run the check from the bot</span>
187             pr.addComment(&quot;/integrate&quot;);
<a name="2" id="anc2"></a><span class="line-modified">188             TestBotRunner.runPeriodicItems(mergeBot, item -&gt; item instanceof CheckWorkItem);</span>





189 
190             // The bot should reply with an error message
191             var error = pr.comments().stream()
192                           .filter(comment -&gt; comment.body().contains(&quot;merge request cannot be fulfilled at this time&quot;))
193                           .filter(comment -&gt; comment.body().contains(&quot;status check&quot;))
194                           .filter(comment -&gt; comment.body().contains(&quot;has not been performed on commit&quot;))
195                           .count();
196             assertEquals(1, error);
197         }
198     }
199 
200     @Test
201     void notReviewed(TestInfo testInfo) throws IOException {
202         try (var credentials = new HostCredentials(testInfo);
203              var tempFolder = new TemporaryDirectory()) {
204             var author = credentials.getHostedRepository();
205             var integrator = credentials.getHostedRepository();
206             var censusBuilder = credentials.getCensusBuilder()
207                                            .addAuthor(author.forge().currentUser().id());
208             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
209 
210             // Populate the projects repository - but without any checks enabled
211             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
212                                                      Set.of(), null);
213             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
214             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
215             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
216 
217             // Make a change with a corresponding PR
218             var editHash = CheckableRepository.appendAndCommit(localRepo);
219             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
220             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
221 
222             // Now enable checks
223             localRepo.checkout(masterHash, true);
224             CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
225                                      Set.of(&quot;author&quot;, &quot;reviewers&quot;, &quot;whitespace&quot;), null);
226             var updatedHash = localRepo.resolve(&quot;HEAD&quot;).orElseThrow();
227             localRepo.push(updatedHash, author.url(), &quot;master&quot;, true);
228 
229             // Attempt a merge
230             pr.addComment(&quot;/integrate&quot;);
231             TestBotRunner.runPeriodicItems(mergeBot);
232 
233             // The bot should reply with an error message
234             var error = pr.comments().stream()
235                           .filter(comment -&gt; comment.body().contains(&quot;merge request cannot be fulfilled at this time&quot;))
236                           .filter(comment -&gt; comment.body().contains(&quot;failed the final jcheck&quot;))
237                           .count();
238             assertEquals(1, error, pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n---\n&quot;)));
239         }
240     }
241 
242     @Test
243     void failedCheck(TestInfo testInfo) throws IOException {
244         try (var credentials = new HostCredentials(testInfo);
245              var tempFolder = new TemporaryDirectory()) {
246             var author = credentials.getHostedRepository();
247             var integrator = credentials.getHostedRepository();
248             var censusBuilder = credentials.getCensusBuilder()
249                                            .addAuthor(author.forge().currentUser().id());
250             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
251 
252             // Populate the projects repository
253             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
254             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
255             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
256             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
257 
258             // Make a change with a corresponding PR
259             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;trailing whitespace   &quot;);
260             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
261             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
262 
263             // Attempt a merge
264             pr.addComment(&quot;/integrate&quot;);
265             TestBotRunner.runPeriodicItems(mergeBot);
266 
267             // The bot should reply with an error message
268             var error = pr.comments().stream()
269                           .filter(comment -&gt; comment.body().contains(&quot;merge request cannot be fulfilled at this time&quot;))
270                           .filter(comment -&gt; comment.body().contains(&quot;status check&quot;))
271                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
272                           .count();
273             assertEquals(1, error);
274         }
275     }
276 
277     @Test
278     void outdatedCheck(TestInfo testInfo) throws IOException {
279         try (var credentials = new HostCredentials(testInfo);
280              var tempFolder = new TemporaryDirectory()) {
281             var author = credentials.getHostedRepository();
282             var integrator = credentials.getHostedRepository();
283             var censusBuilder = credentials.getCensusBuilder()
284                                            .addAuthor(author.forge().currentUser().id());
285             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
286 
287             // Populate the projects repository
288             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
289             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
290             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
291             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
292 
293             // Make a change with a corresponding PR
294             var editHash = CheckableRepository.appendAndCommit(localRepo);
295             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
296             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
297 
298             // Flag it as checked
299             var check = CheckBuilder.create(&quot;testcheck&quot;, editHash);
300             pr.createCheck(check.build());
301             check.complete(true);
302             pr.updateCheck(check.build());
303 
304             // Now push another change
305             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;);
306             localRepo.push(updatedHash, author.url(), &quot;edit&quot;, true);
307 
<a name="3" id="anc3"></a><span class="line-modified">308             // Attempt a merge - avoid running checks from the bot</span>
309             pr.addComment(&quot;/integrate&quot;);
<a name="4" id="anc4"></a><span class="line-modified">310             TestBotRunner.runPeriodicItems(mergeBot, item -&gt; item instanceof CheckWorkItem);</span>





311 
312             // The bot should reply with an error message
313             var error = pr.comments().stream()
314                           .filter(comment -&gt; comment.body().contains(&quot;merge request cannot be fulfilled at this time&quot;))
315                           .filter(comment -&gt; comment.body().contains(&quot;status check&quot;))
316                           .filter(comment -&gt; comment.body().contains(&quot;has not been performed on commit&quot;))
317                           .count();
318             assertEquals(1, error);
319         }
320     }
321 
322     @Test
323     void mergeNotification(TestInfo testInfo) throws IOException {
324         try (var credentials = new HostCredentials(testInfo);
325              var tempFolder = new TemporaryDirectory()) {
326             var author = credentials.getHostedRepository();
327             var integrator = credentials.getHostedRepository();
328             var reviewer = credentials.getHostedRepository();
329             var censusBuilder = credentials.getCensusBuilder()
330                                            .addAuthor(author.forge().currentUser().id())
331                                            .addReviewer(reviewer.forge().currentUser().id())
332                                            .addReviewer(integrator.forge().currentUser().id());
333             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
334 
335             // Populate the projects repository
336             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
337             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
338             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
339             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
340 
341             // Make a change with a corresponding PR
342             var editHash = CheckableRepository.appendAndCommit(localRepo);
343             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
344             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
345 
346             // Approve it as another user
347             var approvalPr = integrator.pullRequest(pr.id());
348             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
349 
350             // Let the bot see it (a few times)
351             TestBotRunner.runPeriodicItems(mergeBot);
352             TestBotRunner.runPeriodicItems(mergeBot);
353             TestBotRunner.runPeriodicItems(mergeBot);
354 
355             // The bot should reply with an instructional message (and only one)
356             var pushed = pr.comments().stream()
357                            .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
358                            .filter(comment -&gt; comment.body().contains(&quot;Reviewed-by: integrationreviewer3&quot;))
359                            .count();
360             assertEquals(1, pushed);
361 
362             // Ensure that the bot doesn&#39;t pick up on commands in the instructional message
363             var error = pr.comments().stream()
364                           .filter(comment -&gt; comment.body().contains(&quot;Only the author&quot;))
365                           .count();
366             assertEquals(0, error);
367 
368             // Drop the approval
369             approvalPr.addReview(Review.Verdict.DISAPPROVED, &quot;Disapproved&quot;);
370             TestBotRunner.runPeriodicItems(mergeBot);
371 
372             // The instructional message should have been updated
373             pushed = pr.comments().stream()
374                        .filter(comment -&gt; comment.body().contains(&quot;no longer ready for integration&quot;))
375                        .count();
376             assertEquals(1, pushed);
377 
378             // Restore the approval
379             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
380             TestBotRunner.runPeriodicItems(mergeBot);
381 
382             // The instructional message should have been updated
383             pushed = pr.comments().stream()
384                        .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
385                        .filter(comment -&gt; comment.body().contains(&quot;Reviewed-by: integrationreviewer3&quot;))
386                        .count();
387             assertEquals(1, pushed);
388 
389             // Approve it as yet another user
390             var reviewerPr = reviewer.pullRequest(pr.id());
391             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
392             TestBotRunner.runPeriodicItems(mergeBot);
393 
394             // The instructional message should have been updated
395             pushed = pr.comments().stream()
396                        .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
397                        .filter(comment -&gt; comment.body().contains(&quot;Reviewed-by: integrationreviewer3, integrationreviewer2&quot;))
398                        .count();
399             assertEquals(1, pushed);
400         }
401     }
402 
403     @Test
404     void invalidCommandAuthor(TestInfo testInfo) throws IOException {
405         try (var credentials = new HostCredentials(testInfo);
406              var tempFolder = new TemporaryDirectory()) {
407             var author = credentials.getHostedRepository();
408             var integrator = credentials.getHostedRepository();
409             var external = credentials.getHostedRepository();
410 
411             var censusBuilder = credentials.getCensusBuilder()
412                                            .addAuthor(author.forge().currentUser().id());
413             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
414 
415             // Populate the projects repository
416             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
417             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
418             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
419             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
420 
421             // Make a change with a corresponding PR
422             var editHash = CheckableRepository.appendAndCommit(localRepo);
423             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
424             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
425 
426             // Issue a merge command not as the PR author
427             var externalPr = external.pullRequest(pr.id());
428             externalPr.addComment(&quot;/integrate&quot;);
429             TestBotRunner.runPeriodicItems(mergeBot);
430 
431             // The bot should reply with an error message
432             var error = pr.comments().stream()
433                           .filter(comment -&gt; comment.body().contains(&quot;Only the author&quot;))
434                           .count();
435             assertEquals(1, error);
436         }
437     }
438 
439     @Test
440     void invalidCommandSponsor(TestInfo testInfo) throws IOException {
441         try (var credentials = new HostCredentials(testInfo);
442              var tempFolder = new TemporaryDirectory()) {
443             var author = credentials.getHostedRepository();
444             var integrator = credentials.getHostedRepository();
445             var external = credentials.getHostedRepository();
446 
447             var censusBuilder = credentials.getCensusBuilder()
448                                            .addAuthor(author.forge().currentUser().id())
449                                            .addReviewer(integrator.forge().currentUser().id())
450                                            .addCommitter(external.forge().currentUser().id());
451             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
452 
453             // Populate the projects repository
454             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
455             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
456             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
457             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
458 
459             // Make a change with a corresponding PR
460             var editHash = CheckableRepository.appendAndCommit(localRepo);
461             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
462             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
463 
464             // Approve it as another user
465             var approvalPr = integrator.pullRequest(pr.id());
466             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
467             TestBotRunner.runPeriodicItems(mergeBot);
468 
469             // Mark it as ready for integration
470             pr.addComment(&quot;/integrate&quot;);
471             TestBotRunner.runPeriodicItems(mergeBot);
472 
473             // Issue a merge command not as the PR author
474             var externalPr = external.pullRequest(pr.id());
475             externalPr.addComment(&quot;/integrate&quot;);
476             TestBotRunner.runPeriodicItems(mergeBot);
477 
478             // The bot should reply with an error message
479             var error = pr.comments().stream()
480                           .filter(comment -&gt; comment.body().contains(&quot;Only the author&quot;))
481                           .filter(comment -&gt; comment.body().contains(&quot;did you mean to&quot;))
482                           .filter(comment -&gt; comment.body().contains(&quot;`/sponsor`&quot;))
483                           .count();
484             assertEquals(1, error);
485         }
486     }
487 
488     @Test
489     void autoRebase(TestInfo testInfo) throws IOException {
490         try (var credentials = new HostCredentials(testInfo);
491              var tempFolder = new TemporaryDirectory();
492              var pushedFolder = new TemporaryDirectory()) {
493 
494             var author = credentials.getHostedRepository();
495             var integrator = credentials.getHostedRepository();
496             var censusBuilder = credentials.getCensusBuilder()
497                                            .addCommitter(author.forge().currentUser().id())
498                                            .addReviewer(integrator.forge().currentUser().id());
499             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
500 
501             // Populate the projects repository
502             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
503             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
504             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
505             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
506 
507             // Make a change with a corresponding PR
508             var editHash = CheckableRepository.appendAndCommit(localRepo);
509             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
510             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
511 
512             // Approve it as another user
513             var approvalPr = integrator.pullRequest(pr.id());
514             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
515 
516             // Push something unrelated to master
517             localRepo.checkout(masterHash, true);
518             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
519             Files.writeString(unrelated, &quot;Hello&quot;);
520             localRepo.add(unrelated);
521             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
522             localRepo.push(unrelatedHash, author.url(), &quot;master&quot;);
523 
524             // Attempt a merge (the bot should only process the first one)
525             pr.addComment(&quot;/integrate&quot;);
526             pr.addComment(&quot;/integrate&quot;);
527             pr.addComment(&quot;/integrate&quot;);
528             TestBotRunner.runPeriodicItems(mergeBot);
529 
530             // The bot should reply with an ok message
531             var pushed = pr.comments().stream()
532                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
533                            .filter(comment -&gt; comment.body().contains(&quot;commit was automatically rebased without conflicts&quot;))
534                            .count();
535             assertEquals(1, pushed);
536 
537             // The change should now be present on the master branch
538             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
539             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
540         }
541     }
542 
543     @Test
544     void retryOnFailure(TestInfo testInfo) throws IOException {
545         try (var credentials = new HostCredentials(testInfo);
546              var tempFolder = new TemporaryDirectory();
547              var censusFolder = new TemporaryDirectory()) {
548 
549             var author = credentials.getHostedRepository();
550             var integrator = credentials.getHostedRepository();
551             var censusBuilder = credentials.getCensusBuilder()
552                                            .addCommitter(author.forge().currentUser().id())
553                                            .addReviewer(integrator.forge().currentUser().id());
554             var censusRepo = censusBuilder.build();
555             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusRepo).build();
556 
557             // Populate the projects repository
558             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
559             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
560             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
561             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
562 
563             // Make a change with a corresponding PR
564             var editHash = CheckableRepository.appendAndCommit(localRepo);
565             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
566             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
567 
568             // Approve it as another user
569             var approvalPr = integrator.pullRequest(pr.id());
570             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
571 
572             // Let the bot check it
573             TestBotRunner.runPeriodicItems(mergeBot);
574 
575             // Break the census to cause an exception
576             var localCensus = Repository.materialize(censusFolder.path(), censusRepo.url(), &quot;+master:current_census&quot;);
577             var currentCensusHash = localCensus.resolve(&quot;current_census&quot;).orElseThrow();
578             Files.writeString(censusFolder.path().resolve(&quot;contributors.xml&quot;), &quot;This is not xml&quot;, StandardCharsets.UTF_8);
579             localCensus.add(censusFolder.path().resolve(&quot;contributors.xml&quot;));
580             var badCensusHash = localCensus.commit(&quot;Bad census update&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
581             localCensus.push(badCensusHash, censusRepo.url(), &quot;master&quot;, true);
582 
<a name="5" id="anc5"></a><span class="line-modified">583             // Attempt a merge (without triggering another check)</span>
584             pr.addComment(&quot;/integrate&quot;);
<a name="6" id="anc6"></a><span class="line-modified">585             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(mergeBot, wi -&gt; wi instanceof CheckWorkItem));</span>
586 
587             // Restore the census
588             localCensus.push(currentCensusHash, censusRepo.url(), &quot;master&quot;, true);
589 
590             // The bot should now retry
<a name="7" id="anc7"></a><span class="line-modified">591             TestBotRunner.runPeriodicItems(mergeBot, wi -&gt; wi instanceof CheckWorkItem);</span>
592 
593             // The bot should reply with an ok message
594             var pushed = pr.comments().stream()
595                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
596                            .count();
597             assertEquals(1, pushed);
598         }
599     }
600 
601     @Test
602     void cannotRebase(TestInfo testInfo) throws IOException {
603         try (var credentials = new HostCredentials(testInfo);
604              var tempFolder = new TemporaryDirectory()) {
605 
606             var author = credentials.getHostedRepository();
607             var integrator = credentials.getHostedRepository();
608             var censusBuilder = credentials.getCensusBuilder()
609                                            .addCommitter(author.forge().currentUser().id())
610                                            .addReviewer(integrator.forge().currentUser().id());
611             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
612 
613             // Populate the projects repository
614             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
615             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
616             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
617             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
618 
619             // Make a change with a corresponding PR
620             var editHash = CheckableRepository.appendAndCommit(localRepo);
621             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
622             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
623 
624             // Approve it as another user
625             var approvalPr = integrator.pullRequest(pr.id());
626             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
627 
628             // Push something conflicting to master
629             localRepo.checkout(masterHash, true);
630             var conflictingHash = CheckableRepository.appendAndCommit(localRepo, &quot;This looks like a conflict&quot;);
631             localRepo.push(conflictingHash, author.url(), &quot;master&quot;);
632 
633             // Attempt an integration
634             pr.addComment(&quot;/integrate&quot;);
635             TestBotRunner.runPeriodicItems(mergeBot);
636 
637             // The bot should reply with an error message
638             var error = pr.comments().stream()
639                           .filter(comment -&gt; comment.body().contains(&quot;It was not possible to rebase your changes automatically.&quot;))
640                           .filter(comment -&gt; comment.body().contains(&quot;Please merge `master`&quot;))
641                           .count();
642             assertEquals(1, error);
643         }
644     }
645 
646     @Test
647     void noAutoRebase(TestInfo testInfo) throws IOException {
648         try (var credentials = new HostCredentials(testInfo);
649              var tempFolder = new TemporaryDirectory();
650              var pushedFolder = new TemporaryDirectory()) {
651 
652             var author = credentials.getHostedRepository();
653             var integrator = credentials.getHostedRepository();
654             var censusBuilder = credentials.getCensusBuilder()
655                                            .addCommitter(author.forge().currentUser().id())
656                                            .addReviewer(integrator.forge().currentUser().id());
657             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
658 
659             // Populate the projects repository
660             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
661             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
662             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
663             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
664 
665             // Make a change with a corresponding PR
666             var editHash = CheckableRepository.appendAndCommit(localRepo);
667             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
668             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
669 
670             // Approve it as another user
671             var approvalPr = integrator.pullRequest(pr.id());
672             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
673 
674             // Push something unrelated to master
675             localRepo.checkout(masterHash, true);
676             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
677             Files.writeString(unrelated, &quot;Hello&quot;);
678             localRepo.add(unrelated);
679             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
680             localRepo.push(unrelatedHash, author.url(), &quot;master&quot;);
681 
682             // Attempt a merge
683             pr.addComment(&quot;/integrate &quot; + masterHash);
684             TestBotRunner.runPeriodicItems(mergeBot);
685 
686             // The bot should reply with an error message
687             assertLastCommentContains(pr, &quot;the target branch is no longer at the requested hash&quot;);
688 
689             // Now use the correct target hash
690             pr.addComment(&quot;/integrate &quot; + unrelatedHash);
691             TestBotRunner.runPeriodicItems(mergeBot);
692 
693             // The bot should reply with an ok message
694             assertLastCommentContains(pr, &quot;Pushed as commit&quot;);
695 
696             // The change should now be present on the master branch
697             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
698             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
699         }
700     }
701 
702     @Test
703     void missingContributingFile(TestInfo testInfo) throws IOException {
704         try (var credentials = new HostCredentials(testInfo);
705              var tempFolder = new TemporaryDirectory();
706              var pushedFolder = new TemporaryDirectory()) {
707 
708             var author = credentials.getHostedRepository();
709             var integrator = credentials.getHostedRepository();
710             var censusBuilder = credentials.getCensusBuilder()
711                                            .addCommitter(author.forge().currentUser().id())
712                                            .addReviewer(integrator.forge().currentUser().id());
713             var prBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
714 
715             // Populate the projects repository
716             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
717             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
718             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
719             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
720 
721             // Make a change with a corresponding PR
722             var editHash = CheckableRepository.appendAndCommit(localRepo);
723             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
724             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
725 
726             // Approve it as another user
727             var approvalPr = integrator.pullRequest(pr.id());
728             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
729 
730             TestBotRunner.runPeriodicItems(prBot);
731 
732             // The bot should reply with an instructional message and no link to CONTRIBUTING.md
733             var lastComment = pr.comments().get(pr.comments().size() - 1);
734             assertFalse(lastComment.body().contains(&quot;CONTRIBUTING.md&quot;));
735         }
736     }
737 
738     @Test
739     void existingContributingFile(TestInfo testInfo) throws IOException {
740         try (var credentials = new HostCredentials(testInfo);
741              var tempFolder = new TemporaryDirectory();
742              var pushedFolder = new TemporaryDirectory()) {
743 
744             var author = credentials.getHostedRepository();
745             var integrator = credentials.getHostedRepository();
746             var censusBuilder = credentials.getCensusBuilder()
747                                            .addCommitter(author.forge().currentUser().id())
748                                            .addReviewer(integrator.forge().currentUser().id());
749             var prBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
750 
751             // Populate the projects repository
752             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
753             var contributingFile = localRepo.root().resolve(&quot;CONTRIBUTING.md&quot;);
754             Files.writeString(contributingFile, &quot;Patches welcome!\n&quot;);
755             localRepo.add(contributingFile);
756             localRepo.commit(&quot;Add CONTRIBUTING.md&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
757             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
758             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
759             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
760 
761             // Make a change with a corresponding PR
762             var editHash = CheckableRepository.appendAndCommit(localRepo);
763             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
764             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
765 
766             // Approve it as another user
767             var approvalPr = integrator.pullRequest(pr.id());
768             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
769 
770             TestBotRunner.runPeriodicItems(prBot);
771 
772             // The bot should reply with an instructional message and no link to CONTRIBUTING.md
773             var lastComment = pr.comments().get(pr.comments().size() - 1);
774             assertTrue(lastComment.body().contains(&quot;CONTRIBUTING.md&quot;));
775         }
776     }
777 }
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>