<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/pr/src/test/java/org/openjdk/skara/bots/pr/IntegrateTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.pr;
 24 
 25 import org.openjdk.skara.forge.*;
 26 import org.openjdk.skara.issuetracker.Comment;
 27 import org.openjdk.skara.test.*;
 28 import org.openjdk.skara.vcs.Repository;
 29 
 30 import org.junit.jupiter.api.*;
 31 
 32 import java.io.IOException;
 33 import java.nio.charset.StandardCharsets;
 34 import java.nio.file.*;
 35 import java.util.Set;
 36 import java.util.stream.Collectors;
 37 
 38 import static org.junit.jupiter.api.Assertions.*;
 39 import static org.openjdk.skara.bots.pr.PullRequestAsserts.assertLastCommentContains;
 40 
 41 class IntegrateTests {
 42     @Test
 43     void simpleMerge(TestInfo testInfo) throws IOException {
 44         try (var credentials = new HostCredentials(testInfo);
 45              var tempFolder = new TemporaryDirectory();
 46              var pushedFolder = new TemporaryDirectory()) {
 47 
 48             var author = credentials.getHostedRepository();
 49             var integrator = credentials.getHostedRepository();
 50             var reviewer = credentials.getHostedRepository();
 51             var censusBuilder = credentials.getCensusBuilder()
 52                                            .addCommitter(author.forge().currentUser().id())
 53                                            .addReviewer(integrator.forge().currentUser().id())
 54                                            .addReviewer(reviewer.forge().currentUser().id());
 55             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
 56 
 57             // Populate the projects repository
 58             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 59             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 60             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 61             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 62 
 63             // Make a change with a corresponding PR
 64             var editHash = CheckableRepository.appendAndCommit(localRepo);
 65             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 66             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 67 
 68             // Approve it as another user
 69             var approvalPr = integrator.pullRequest(pr.id());
 70             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 71 
 72             // The bot should reply with integration message
 73             TestBotRunner.runPeriodicItems(mergeBot);
 74             var integrateComments = pr.comments()
 75                                       .stream()
 76                                       .filter(c -&gt; c.body().contains(&quot;To integrate this PR with the above commit message to the `master` branch&quot;))
 77                                       .filter(c -&gt; c.body().contains(&quot;If you would like to avoid potential automatic rebasing&quot;))
 78                                       .filter(c -&gt; c.body().contains(&quot;`/integrate &quot; + masterHash.hex() + &quot;`&quot;))
 79                                       .count();
 80             assertEquals(1, integrateComments);
 81 
 82             // Attempt a merge (the bot should only process the first one)
 83             pr.addComment(&quot;/integrate&quot;);
 84             pr.addComment(&quot;/integrate&quot;);
 85             pr.addComment(&quot;/integrate&quot;);
 86             TestBotRunner.runPeriodicItems(mergeBot);
 87 
 88             // The bot should reply with an ok message
 89             var pushed = pr.comments().stream()
 90                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
 91                            .count();
 92             assertEquals(1, pushed);
 93 
 94             // The change should now be present on the master branch
 95             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
 96             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
 97 
 98             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
 99             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
100 
101             // Author and committer should be the same
102             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
103             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
104             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
105             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
106             assertTrue(pr.labels().contains(&quot;integrated&quot;));
107 
108             // Ready label should have been removed
109             assertFalse(pr.labels().contains(&quot;ready&quot;));
110         }
111     }
112 
113     @Test
114     void reviewersRetained(TestInfo testInfo) throws IOException {
115         try (var credentials = new HostCredentials(testInfo);
116              var tempFolder = new TemporaryDirectory();
117              var pushedFolder = new TemporaryDirectory()) {
118             var author = credentials.getHostedRepository();
119             var integrator = credentials.getHostedRepository();
120             var committer = credentials.getHostedRepository();
121 
122             var censusBuilder = credentials.getCensusBuilder()
123                                            .addCommitter(author.forge().currentUser().id())
124                                            .addCommitter(committer.forge().currentUser().id())
125                                            .addReviewer(integrator.forge().currentUser().id());
126             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
127 
128             // Populate the projects repository
129             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
130             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
131             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
132             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
133 
134             // Make a change with a corresponding PR
135             var editHash = CheckableRepository.appendAndCommit(localRepo);
136             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
137             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
138 
139             // Review it twice
140             var integratorPr = integrator.pullRequest(pr.id());
141             var committerPr = committer.pullRequest(pr.id());
142             integratorPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
143             committerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
144 
145             // Attempt a merge
146             pr.addComment(&quot;/integrate&quot;);
147             TestBotRunner.runPeriodicItems(mergeBot);
148 
149             // The bot should reply with an ok message
150             var pushed = pr.comments().stream()
151                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
152                            .count();
153             assertEquals(1, pushed);
154 
155             // The change should now be present on the master branch
156             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
157             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
158             var headCommit = pushedRepo.commits(&quot;HEAD&quot;).asList().get(0);
159             assertTrue(String.join(&quot;&quot;, headCommit.message())
160                              .matches(&quot;.*Reviewed-by: integrationreviewer3, integrationcommitter2$&quot;),
161                        String.join(&quot;&quot;, headCommit.message()));
162         }
163     }
164 
165     @Test
166     void notChecked(TestInfo testInfo) throws IOException {
167         try (var credentials = new HostCredentials(testInfo);
168              var tempFolder = new TemporaryDirectory()) {
169             var author = credentials.getHostedRepository();
170             var integrator = credentials.getHostedRepository();
171             var censusBuilder = credentials.getCensusBuilder()
172                                            .addAuthor(author.forge().currentUser().id());
173             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
174 
175             // Populate the projects repository
176             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
177             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
178             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
179             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
180 
181             // Make a change with a corresponding PR
182             var editHash = CheckableRepository.appendAndCommit(localRepo);
183             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
184             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
185 
186             // Attempt a merge, but point the check at some other commit
187             pr.addComment(&quot;/integrate&quot;);
188             TestBotRunner.runPeriodicItems(mergeBot, item -&gt; {
189                 if (item instanceof CheckWorkItem) {
190                     var newCheck = CheckBuilder.create(&quot;jcheck&quot;, masterHash).build();
191                     pr.updateCheck(newCheck);
192                 }
193             });
194 
195             // The bot should reply with an error message
196             var error = pr.comments().stream()
197                           .filter(comment -&gt; comment.body().contains(&quot;merge request cannot be fulfilled at this time&quot;))
198                           .filter(comment -&gt; comment.body().contains(&quot;status check&quot;))
199                           .filter(comment -&gt; comment.body().contains(&quot;has not been performed on commit&quot;))
200                           .count();
201             assertEquals(1, error);
202         }
203     }
204 
205     @Test
206     void notReviewed(TestInfo testInfo) throws IOException {
207         try (var credentials = new HostCredentials(testInfo);
208              var tempFolder = new TemporaryDirectory()) {
209             var author = credentials.getHostedRepository();
210             var integrator = credentials.getHostedRepository();
211             var censusBuilder = credentials.getCensusBuilder()
212                                            .addAuthor(author.forge().currentUser().id());
213             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
214 
215             // Populate the projects repository - but without any checks enabled
216             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
217                                                      Set.of(), null);
218             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
219             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
220             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
221 
222             // Make a change with a corresponding PR
223             var editHash = CheckableRepository.appendAndCommit(localRepo);
224             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
225             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
226 
227             // Now enable checks
228             localRepo.checkout(masterHash, true);
229             CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
230                                      Set.of(&quot;author&quot;, &quot;reviewers&quot;, &quot;whitespace&quot;), null);
231             var updatedHash = localRepo.resolve(&quot;HEAD&quot;).orElseThrow();
232             localRepo.push(updatedHash, author.url(), &quot;master&quot;, true);
233 
234             // Attempt a merge
235             pr.addComment(&quot;/integrate&quot;);
236             TestBotRunner.runPeriodicItems(mergeBot);
237 
238             // The bot should reply with an error message
239             var error = pr.comments().stream()
240                           .filter(comment -&gt; comment.body().contains(&quot;merge request cannot be fulfilled at this time&quot;))
241                           .filter(comment -&gt; comment.body().contains(&quot;failed the final jcheck&quot;))
242                           .count();
243             assertEquals(1, error, pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n---\n&quot;)));
244         }
245     }
246 
247     @Test
248     void failedCheck(TestInfo testInfo) throws IOException {
249         try (var credentials = new HostCredentials(testInfo);
250              var tempFolder = new TemporaryDirectory()) {
251             var author = credentials.getHostedRepository();
252             var integrator = credentials.getHostedRepository();
253             var censusBuilder = credentials.getCensusBuilder()
254                                            .addAuthor(author.forge().currentUser().id());
255             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
256 
257             // Populate the projects repository
258             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
259             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
260             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
261             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
262 
263             // Make a change with a corresponding PR
264             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;trailing whitespace   &quot;);
265             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
266             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
267 
268             // Attempt a merge
269             pr.addComment(&quot;/integrate&quot;);
270             TestBotRunner.runPeriodicItems(mergeBot);
271 
272             // The bot should reply with an error message
273             var error = pr.comments().stream()
274                           .filter(comment -&gt; comment.body().contains(&quot;merge request cannot be fulfilled at this time&quot;))
275                           .filter(comment -&gt; comment.body().contains(&quot;status check&quot;))
276                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
277                           .count();
278             assertEquals(1, error);
279         }
280     }
281 
282     @Test
283     void outdatedCheck(TestInfo testInfo) throws IOException {
284         try (var credentials = new HostCredentials(testInfo);
285              var tempFolder = new TemporaryDirectory()) {
286             var author = credentials.getHostedRepository();
287             var integrator = credentials.getHostedRepository();
288             var censusBuilder = credentials.getCensusBuilder()
289                                            .addAuthor(author.forge().currentUser().id());
290             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
291 
292             // Populate the projects repository
293             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
294             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
295             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
296             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
297 
298             // Make a change with a corresponding PR
299             var editHash = CheckableRepository.appendAndCommit(localRepo);
300             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
301             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
302 
303             // Flag it as checked
304             var check = CheckBuilder.create(&quot;testcheck&quot;, editHash);
305             pr.createCheck(check.build());
306             check.complete(true);
307             pr.updateCheck(check.build());
308 
309             // Now push another change
310             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;);
311             localRepo.push(updatedHash, author.url(), &quot;edit&quot;, true);
312 
313             // Attempt a merge, but point the check at some other commit
314             pr.addComment(&quot;/integrate&quot;);
315             TestBotRunner.runPeriodicItems(mergeBot, item -&gt; {
316                 if (item instanceof CheckWorkItem) {
317                     var newCheck = CheckBuilder.create(&quot;jcheck&quot;, masterHash).build();
318                     pr.updateCheck(newCheck);
319                 }
320             });
321 
322             // The bot should reply with an error message
323             var error = pr.comments().stream()
324                           .filter(comment -&gt; comment.body().contains(&quot;merge request cannot be fulfilled at this time&quot;))
325                           .filter(comment -&gt; comment.body().contains(&quot;status check&quot;))
326                           .filter(comment -&gt; comment.body().contains(&quot;has not been performed on commit&quot;))
327                           .count();
328             assertEquals(1, error);
329         }
330     }
331 
332     @Test
333     void mergeNotification(TestInfo testInfo) throws IOException {
334         try (var credentials = new HostCredentials(testInfo);
335              var tempFolder = new TemporaryDirectory()) {
336             var author = credentials.getHostedRepository();
337             var integrator = credentials.getHostedRepository();
338             var reviewer = credentials.getHostedRepository();
339             var censusBuilder = credentials.getCensusBuilder()
340                                            .addAuthor(author.forge().currentUser().id())
341                                            .addReviewer(reviewer.forge().currentUser().id())
342                                            .addReviewer(integrator.forge().currentUser().id());
343             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
344 
345             // Populate the projects repository
346             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
347             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
348             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
349             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
350 
351             // Make a change with a corresponding PR
352             var editHash = CheckableRepository.appendAndCommit(localRepo);
353             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
354             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
355 
356             // Approve it as another user
357             var approvalPr = integrator.pullRequest(pr.id());
358             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
359 
360             // Let the bot see it (a few times)
361             TestBotRunner.runPeriodicItems(mergeBot);
362             TestBotRunner.runPeriodicItems(mergeBot);
363             TestBotRunner.runPeriodicItems(mergeBot);
364 
365             // The bot should reply with an instructional message (and only one)
366             var pushed = pr.comments().stream()
367                            .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
368                            .filter(comment -&gt; comment.body().contains(&quot;Reviewed-by: integrationreviewer3&quot;))
369                            .count();
370             assertEquals(1, pushed);
371 
372             // Ensure that the bot doesn&#39;t pick up on commands in the instructional message
373             var error = pr.comments().stream()
374                           .filter(comment -&gt; comment.body().contains(&quot;Only the author&quot;))
375                           .count();
376             assertEquals(0, error);
377 
378             // Drop the approval
379             approvalPr.addReview(Review.Verdict.DISAPPROVED, &quot;Disapproved&quot;);
380             TestBotRunner.runPeriodicItems(mergeBot);
381 
382             // The instructional message should have been updated
383             pushed = pr.comments().stream()
384                        .filter(comment -&gt; comment.body().contains(&quot;no longer ready for integration&quot;))
385                        .count();
386             assertEquals(1, pushed);
387 
388             // Restore the approval
389             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
390             TestBotRunner.runPeriodicItems(mergeBot);
391 
392             // The instructional message should have been updated
393             pushed = pr.comments().stream()
394                        .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
395                        .filter(comment -&gt; comment.body().contains(&quot;Reviewed-by: integrationreviewer3&quot;))
396                        .count();
397             assertEquals(1, pushed);
398 
399             // Approve it as yet another user
400             var reviewerPr = reviewer.pullRequest(pr.id());
401             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
402             TestBotRunner.runPeriodicItems(mergeBot);
403 
404             // The instructional message should have been updated
405             pushed = pr.comments().stream()
406                        .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
407                        .filter(comment -&gt; comment.body().contains(&quot;Reviewed-by: integrationreviewer3, integrationreviewer2&quot;))
408                        .count();
409             assertEquals(1, pushed);
410         }
411     }
412 
413     @Test
414     void invalidCommandAuthor(TestInfo testInfo) throws IOException {
415         try (var credentials = new HostCredentials(testInfo);
416              var tempFolder = new TemporaryDirectory()) {
417             var author = credentials.getHostedRepository();
418             var integrator = credentials.getHostedRepository();
419             var external = credentials.getHostedRepository();
420 
421             var censusBuilder = credentials.getCensusBuilder()
422                                            .addAuthor(author.forge().currentUser().id());
423             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
424 
425             // Populate the projects repository
426             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
427             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
428             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
429             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
430 
431             // Make a change with a corresponding PR
432             var editHash = CheckableRepository.appendAndCommit(localRepo);
433             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
434             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
435 
436             // Issue a merge command not as the PR author
437             var externalPr = external.pullRequest(pr.id());
438             externalPr.addComment(&quot;/integrate&quot;);
439             TestBotRunner.runPeriodicItems(mergeBot);
440 
441             // The bot should reply with an error message
442             var error = pr.comments().stream()
443                           .filter(comment -&gt; comment.body().contains(&quot;Only the author&quot;))
444                           .count();
445             assertEquals(1, error);
446         }
447     }
448 
449     @Test
450     void invalidCommandSponsor(TestInfo testInfo) throws IOException {
451         try (var credentials = new HostCredentials(testInfo);
452              var tempFolder = new TemporaryDirectory()) {
453             var author = credentials.getHostedRepository();
454             var integrator = credentials.getHostedRepository();
455             var external = credentials.getHostedRepository();
456 
457             var censusBuilder = credentials.getCensusBuilder()
458                                            .addAuthor(author.forge().currentUser().id())
459                                            .addReviewer(integrator.forge().currentUser().id())
460                                            .addCommitter(external.forge().currentUser().id());
461             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
462 
463             // Populate the projects repository
464             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
465             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
466             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
467             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
468 
469             // Make a change with a corresponding PR
470             var editHash = CheckableRepository.appendAndCommit(localRepo);
471             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
472             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
473 
474             // Approve it as another user
475             var approvalPr = integrator.pullRequest(pr.id());
476             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
477             TestBotRunner.runPeriodicItems(mergeBot);
478 
479             // Mark it as ready for integration
480             pr.addComment(&quot;/integrate&quot;);
481             TestBotRunner.runPeriodicItems(mergeBot);
482 
483             // Issue a merge command not as the PR author
484             var externalPr = external.pullRequest(pr.id());
485             externalPr.addComment(&quot;/integrate&quot;);
486             TestBotRunner.runPeriodicItems(mergeBot);
487 
488             // The bot should reply with an error message
489             var error = pr.comments().stream()
490                           .filter(comment -&gt; comment.body().contains(&quot;Only the author&quot;))
491                           .filter(comment -&gt; comment.body().contains(&quot;did you mean to&quot;))
492                           .filter(comment -&gt; comment.body().contains(&quot;`/sponsor`&quot;))
493                           .count();
494             assertEquals(1, error);
495         }
496     }
497 
498     @Test
499     void autoRebase(TestInfo testInfo) throws IOException {
500         try (var credentials = new HostCredentials(testInfo);
501              var tempFolder = new TemporaryDirectory();
502              var pushedFolder = new TemporaryDirectory()) {
503 
504             var author = credentials.getHostedRepository();
505             var integrator = credentials.getHostedRepository();
506             var censusBuilder = credentials.getCensusBuilder()
507                                            .addCommitter(author.forge().currentUser().id())
508                                            .addReviewer(integrator.forge().currentUser().id());
509             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
510 
511             // Populate the projects repository
512             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
513             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
514             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
515             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
516 
517             // Make a change with a corresponding PR
518             var editHash = CheckableRepository.appendAndCommit(localRepo);
519             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
520             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
521 
522             // Approve it as another user
523             var approvalPr = integrator.pullRequest(pr.id());
524             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
525 
526             // Push something unrelated to master
527             localRepo.checkout(masterHash, true);
528             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
529             Files.writeString(unrelated, &quot;Hello&quot;);
530             localRepo.add(unrelated);
531             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
532             localRepo.push(unrelatedHash, author.url(), &quot;master&quot;);
533 
534             // Attempt a merge (the bot should only process the first one)
535             pr.addComment(&quot;/integrate&quot;);
536             pr.addComment(&quot;/integrate&quot;);
537             pr.addComment(&quot;/integrate&quot;);
538             TestBotRunner.runPeriodicItems(mergeBot);
539 
540             // The bot should reply with an ok message
541             var pushed = pr.comments().stream()
542                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
543                            .filter(comment -&gt; comment.body().contains(&quot;commit was automatically rebased without conflicts&quot;))
544                            .count();
545             assertEquals(1, pushed);
546 
547             // The change should now be present on the master branch
548             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
549             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
550         }
551     }
552 
553     @Test
554     void retryOnFailure(TestInfo testInfo) throws IOException {
555         try (var credentials = new HostCredentials(testInfo);
556              var tempFolder = new TemporaryDirectory();
557              var censusFolder = new TemporaryDirectory()) {
558 
559             var author = credentials.getHostedRepository();
560             var integrator = credentials.getHostedRepository();
561             var censusBuilder = credentials.getCensusBuilder()
562                                            .addCommitter(author.forge().currentUser().id())
563                                            .addReviewer(integrator.forge().currentUser().id());
564             var censusRepo = censusBuilder.build();
565             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusRepo).build();
566 
567             // Populate the projects repository
568             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
569             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
570             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
571             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
572 
573             // Make a change with a corresponding PR
574             var editHash = CheckableRepository.appendAndCommit(localRepo);
575             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
576             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
577 
578             // Approve it as another user
579             var approvalPr = integrator.pullRequest(pr.id());
580             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
581 
582             // Let the bot check it
583             TestBotRunner.runPeriodicItems(mergeBot);
584 
585             // Break the census to cause an exception
586             var localCensus = Repository.materialize(censusFolder.path(), censusRepo.url(), &quot;+master:current_census&quot;);
587             var currentCensusHash = localCensus.resolve(&quot;current_census&quot;).orElseThrow();
588             Files.writeString(censusFolder.path().resolve(&quot;contributors.xml&quot;), &quot;This is not xml&quot;, StandardCharsets.UTF_8);
589             localCensus.add(censusFolder.path().resolve(&quot;contributors.xml&quot;));
590             var badCensusHash = localCensus.commit(&quot;Bad census update&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
591             localCensus.push(badCensusHash, censusRepo.url(), &quot;master&quot;, true);
592 
593             // Attempt a merge
594             pr.addComment(&quot;/integrate&quot;);
595             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(mergeBot));
596 
597             // Restore the census
598             localCensus.push(currentCensusHash, censusRepo.url(), &quot;master&quot;, true);
599 
600             // The bot should now retry
601             TestBotRunner.runPeriodicItems(mergeBot);
602 
603             // The bot should reply with an ok message
604             var pushed = pr.comments().stream()
605                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
606                            .count();
607             assertEquals(1, pushed);
608         }
609     }
610 
611     @Test
612     void cannotRebase(TestInfo testInfo) throws IOException {
613         try (var credentials = new HostCredentials(testInfo);
614              var tempFolder = new TemporaryDirectory()) {
615 
616             var author = credentials.getHostedRepository();
617             var integrator = credentials.getHostedRepository();
618             var censusBuilder = credentials.getCensusBuilder()
619                                            .addCommitter(author.forge().currentUser().id())
620                                            .addReviewer(integrator.forge().currentUser().id());
621             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
622 
623             // Populate the projects repository
624             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
625             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
626             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
627             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
628 
629             // Make a change with a corresponding PR
630             var editHash = CheckableRepository.appendAndCommit(localRepo);
631             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
632             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
633 
634             // Approve it as another user
635             var approvalPr = integrator.pullRequest(pr.id());
636             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
637 
638             // Push something conflicting to master
639             localRepo.checkout(masterHash, true);
640             var conflictingHash = CheckableRepository.appendAndCommit(localRepo, &quot;This looks like a conflict&quot;);
641             localRepo.push(conflictingHash, author.url(), &quot;master&quot;);
642 
643             // Attempt an integration
644             pr.addComment(&quot;/integrate&quot;);
645             TestBotRunner.runPeriodicItems(mergeBot);
646 
647             // The bot should reply with an error message
648             var error = pr.comments().stream()
649                           .filter(comment -&gt; comment.body().contains(&quot;It was not possible to rebase your changes automatically.&quot;))
650                           .filter(comment -&gt; comment.body().contains(&quot;Please merge `master`&quot;))
651                           .count();
652             assertEquals(1, error);
653         }
654     }
655 
656     @Test
657     void noAutoRebase(TestInfo testInfo) throws IOException {
658         try (var credentials = new HostCredentials(testInfo);
659              var tempFolder = new TemporaryDirectory();
660              var pushedFolder = new TemporaryDirectory()) {
661 
662             var author = credentials.getHostedRepository();
663             var integrator = credentials.getHostedRepository();
664             var censusBuilder = credentials.getCensusBuilder()
665                                            .addCommitter(author.forge().currentUser().id())
666                                            .addReviewer(integrator.forge().currentUser().id());
667             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
668 
669             // Populate the projects repository
670             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
671             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
672             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
673             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
674 
675             // Make a change with a corresponding PR
676             var editHash = CheckableRepository.appendAndCommit(localRepo);
677             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
678             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
679 
680             // Approve it as another user
681             var approvalPr = integrator.pullRequest(pr.id());
682             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
683 
684             // Push something unrelated to master
685             localRepo.checkout(masterHash, true);
686             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
687             Files.writeString(unrelated, &quot;Hello&quot;);
688             localRepo.add(unrelated);
689             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
690             localRepo.push(unrelatedHash, author.url(), &quot;master&quot;);
691 
692             // Attempt a merge
693             pr.addComment(&quot;/integrate &quot; + masterHash);
694             TestBotRunner.runPeriodicItems(mergeBot);
695 
696             // The bot should reply with an error message
697             assertLastCommentContains(pr, &quot;the target branch is no longer at the requested hash&quot;);
698 
699             // Now use the correct target hash
700             pr.addComment(&quot;/integrate &quot; + unrelatedHash);
701             TestBotRunner.runPeriodicItems(mergeBot);
702 
703             // The bot should reply with an ok message
704             assertLastCommentContains(pr, &quot;Pushed as commit&quot;);
705 
706             // The change should now be present on the master branch
707             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
708             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
709         }
710     }
711 
712     @Test
713     void missingContributingFile(TestInfo testInfo) throws IOException {
714         try (var credentials = new HostCredentials(testInfo);
715              var tempFolder = new TemporaryDirectory();
716              var pushedFolder = new TemporaryDirectory()) {
717 
718             var author = credentials.getHostedRepository();
719             var integrator = credentials.getHostedRepository();
720             var censusBuilder = credentials.getCensusBuilder()
721                                            .addCommitter(author.forge().currentUser().id())
722                                            .addReviewer(integrator.forge().currentUser().id());
723             var prBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
724 
725             // Populate the projects repository
726             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
727             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
728             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
729             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
730 
731             // Make a change with a corresponding PR
732             var editHash = CheckableRepository.appendAndCommit(localRepo);
733             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
734             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
735 
736             // Approve it as another user
737             var approvalPr = integrator.pullRequest(pr.id());
738             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
739 
740             TestBotRunner.runPeriodicItems(prBot);
741 
742             // The bot should reply with an instructional message and no link to CONTRIBUTING.md
743             var lastComment = pr.comments().get(pr.comments().size() - 1);
744             assertFalse(lastComment.body().contains(&quot;CONTRIBUTING.md&quot;));
745         }
746     }
747 
748     @Test
749     void existingContributingFile(TestInfo testInfo) throws IOException {
750         try (var credentials = new HostCredentials(testInfo);
751              var tempFolder = new TemporaryDirectory();
752              var pushedFolder = new TemporaryDirectory()) {
753 
754             var author = credentials.getHostedRepository();
755             var integrator = credentials.getHostedRepository();
756             var censusBuilder = credentials.getCensusBuilder()
757                                            .addCommitter(author.forge().currentUser().id())
758                                            .addReviewer(integrator.forge().currentUser().id());
759             var prBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
760 
761             // Populate the projects repository
762             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
763             var contributingFile = localRepo.root().resolve(&quot;CONTRIBUTING.md&quot;);
764             Files.writeString(contributingFile, &quot;Patches welcome!\n&quot;);
765             localRepo.add(contributingFile);
766             localRepo.commit(&quot;Add CONTRIBUTING.md&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
767             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
768             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
769             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
770 
771             // Make a change with a corresponding PR
772             var editHash = CheckableRepository.appendAndCommit(localRepo);
773             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
774             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
775 
776             // Approve it as another user
777             var approvalPr = integrator.pullRequest(pr.id());
778             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
779 
780             TestBotRunner.runPeriodicItems(prBot);
781 
782             // The bot should reply with an instructional message and no link to CONTRIBUTING.md
783             var lastComment = pr.comments().get(pr.comments().size() - 1);
784             assertTrue(lastComment.body().contains(&quot;CONTRIBUTING.md&quot;));
785         }
786     }
787 }
    </pre>
  </body>
</html>