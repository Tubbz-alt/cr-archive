<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New vcs/src/main/java/org/openjdk/skara/vcs/git/GitVersion.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.vcs.git;
 24 
 25 import java.io.BufferedReader;
 26 import java.io.IOException;
 27 import java.io.InputStreamReader;
 28 import java.util.Objects;
 29 import java.util.regex.Pattern;
 30 import java.util.stream.Collectors;
 31 
 32 public class GitVersion {
 33 
 34     private static final Pattern versionPattern = Pattern.compile(
 35             &quot;git version (?&lt;versionString&gt;.*(?&lt;major&gt;\\d)\\.(?&lt;minor&gt;\\d{2})\\.(?&lt;security&gt;\\d).*)&quot;);
 36     private static final GitVersion UNKNOWN = new GitVersion(&quot;UNKNOWN&quot;, -1, -1, -1);
 37 
 38     private final String versionString;
 39     private final int major;
 40     private final int minor;
 41     private final int security;
 42 
 43     private GitVersion(String versionString, int major, int minor, int security) {
 44         this.versionString = versionString;
 45         this.major = major;
 46         this.minor = minor;
 47         this.security = security;
 48     }
 49 
 50     public static GitVersion parse(String version) {
 51         var matcher = versionPattern.matcher(version);
 52         if (!matcher.find()) {
 53             return UNKNOWN;
 54         }
 55 
 56         return new GitVersion(
 57             matcher.group(&quot;versionString&quot;),
 58             Integer.parseInt(matcher.group(&quot;major&quot;)),
 59             Integer.parseInt(matcher.group(&quot;minor&quot;)),
 60             Integer.parseInt(matcher.group(&quot;security&quot;))
 61         );
 62     }
 63 
 64     public static GitVersion get() throws IOException {
 65         var p = new ProcessBuilder().command(&quot;git&quot;, &quot;--version&quot;).start();
 66         try {
 67             var code = p.waitFor();
 68             if (code != 0) throw new IOException(&quot;git --version exited with code: &quot; + code);
 69             try (var lines = new BufferedReader(new InputStreamReader(p.getInputStream())).lines()) {
 70                 var linesList = lines.collect(Collectors.toList());
 71                 for (var line : linesList) {
 72                     var version = parse(line);
 73                     if (version != UNKNOWN) {
 74                         return version;
 75                     }
 76                 }
 77             }
 78             return UNKNOWN;
 79         } catch (InterruptedException e) {
 80             throw new IOException(e);
 81         }
 82     }
 83 
 84     public boolean isKnownSupported() {
 85         if (major &lt; 2) {
 86             return false;
 87         }
 88 
 89         switch (minor) {
 90 //            case 17:
 91 //            case 19:
 92 //                return security &gt;= 4;
 93 //
 94 //            case 18:
 95 //            case 20:
 96             case 22: // we require 2.22 since we use --combined-all-paths option of git log
 97             case 25:
 98                 return security &gt;= 3;
 99 
100             case 21:
101             case 23:
102             case 24:
103                 return security &gt;= 2;
104 
105             default: {
106                 if (minor &gt;= 26) {
107                     return true;
108                 }
109             }
110         }
111 
112         return false;
113     }
114 
115     public boolean isUnknown() {
116         return this == UNKNOWN;
117     }
118 
119     public int major() {
120         return major;
121     }
122 
123     public int minor() {
124         return minor;
125     }
126 
127     public int security() {
128         return security;
129     }
130 
131     @Override
132     public String toString() {
133         return versionString;
134     }
135 
136     @Override
137     public boolean equals(Object o) {
138         if (this == o) return true;
139         if (o == null || getClass() != o.getClass()) return false;
140         GitVersion that = (GitVersion) o;
141         return Objects.equals(versionString, that.versionString);
142     }
143 
144     @Override
145     public int hashCode() {
146         return Objects.hash(versionString);
147     }
148 }
    </pre>
  </body>
</html>