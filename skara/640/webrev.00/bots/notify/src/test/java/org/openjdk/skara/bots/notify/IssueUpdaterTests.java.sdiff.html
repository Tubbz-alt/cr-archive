<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/IssueUpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/PullRequestWorkItem.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JsonUpdaterTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/IssueUpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 31 import java.net.URI;
 32 import java.util.*;
 33 import java.util.regex.Pattern;
 34 
 35 import static org.junit.jupiter.api.Assertions.assertEquals;
 36 import static org.openjdk.skara.bots.notify.UpdaterTests.*;
 37 
 38 public class IssueUpdaterTests {
 39     @Test
 40     void testIssueIdempotence(TestInfo testInfo) throws IOException {
 41         try (var credentials = new HostCredentials(testInfo);
 42              var tempFolder = new TemporaryDirectory()) {
 43             var repo = credentials.getHostedRepository();
 44             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 45             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 46             credentials.commitLock(localRepo);
 47             localRepo.pushAll(repo.url());
 48 
 49             var tagStorage = createTagStorage(repo);
 50             var branchStorage = createBranchStorage(repo);
<span class="line-modified"> 51             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
 52             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 53 
 54             var issueProject = credentials.getIssueProject();
 55             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 56             var updater = IssueUpdater.newBuilder()
 57                                       .issueProject(issueProject)
 58                                       .reviewLink(false)
 59                                       .commitIcon(commitIcon)
 60                                       .build();
 61             var notifyBot = NotifyBot.newBuilder()
 62                                      .repository(repo)
 63                                      .storagePath(storageFolder)
 64                                      .branches(Pattern.compile(&quot;master&quot;))
 65                                      .tagStorageBuilder(tagStorage)
 66                                      .branchStorageBuilder(branchStorage)
<span class="line-modified"> 67                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
 68                                      .updaters(List.of(updater))
 69                                      .build();
 70 
 71             // Initialize history
 72             TestBotRunner.runPeriodicItems(notifyBot);
 73 
 74             // Save the state
 75             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
 76 
 77             // Create an issue and commit a fix
 78             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
 79             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
 80             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 81             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
 82             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
 83             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 84             TestBotRunner.runPeriodicItems(notifyBot);
 85 
 86             // The changeset should be reflected in a link
 87             var links = issue.links();
</pre>
<hr />
<pre>
 99 
100             // There should be no new links
101             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
102             assertEquals(1, updatedIssue.links().size());
103         }
104     }
105 
106     @Test
107     void testPullRequest(TestInfo testInfo) throws IOException {
108         try (var credentials = new HostCredentials(testInfo);
109              var tempFolder = new TemporaryDirectory()) {
110             var repo = credentials.getHostedRepository();
111             var reviewer = credentials.getHostedRepository();
112             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
113             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
114             credentials.commitLock(localRepo);
115             localRepo.pushAll(repo.url());
116 
117             var tagStorage = createTagStorage(repo);
118             var branchStorage = createBranchStorage(repo);
<span class="line-modified">119             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
120             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
121 
122             var issueProject = credentials.getIssueProject();
123             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
124             var updater = IssueUpdater.newBuilder()
125                                       .issueProject(issueProject)
126                                       .reviewIcon(reviewIcon)
127                                       .commitLink(false)
128                                       .build();
129             var notifyBot = NotifyBot.newBuilder()
130                                      .repository(repo)
131                                      .storagePath(storageFolder)
132                                      .branches(Pattern.compile(&quot;master&quot;))
133                                      .tagStorageBuilder(tagStorage)
134                                      .branchStorageBuilder(branchStorage)
<span class="line-modified">135                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
136                                      .prUpdaters(List.of(updater))
137                                      .readyLabels(Set.of(&quot;rfr&quot;))
138                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
139                                      .build();
140 
141             // Initialize history
142             TestBotRunner.runPeriodicItems(notifyBot);
143 
144             // Create an issue and a pull request to fix it
145             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
146             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
147             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
148             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
149             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
150             TestBotRunner.runPeriodicItems(notifyBot);
151 
152             // The issue should not yet contain a link to the PR
153             var links = issue.links();
154             assertEquals(0, links.size());
155 
</pre>
<hr />
<pre>
200             assertEquals(0, links1.size());
201             links2 = issue2.links();
202             assertEquals(1, links2.size());
203             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
204         }
205     }
206 
207     @Test
208     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
209         try (var credentials = new HostCredentials(testInfo);
210              var tempFolder = new TemporaryDirectory()) {
211             var repo = credentials.getHostedRepository();
212             var reviewer = credentials.getHostedRepository();
213             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
214             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
215             credentials.commitLock(localRepo);
216             localRepo.pushAll(repo.url());
217 
218             var tagStorage = createTagStorage(repo);
219             var branchStorage = createBranchStorage(repo);
<span class="line-modified">220             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
221             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
222 
223             var issueProject = credentials.getIssueProject();
224             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
225             var updater = IssueUpdater.newBuilder()
226                                       .issueProject(issueProject)
227                                       .reviewLink(false)
228                                       .reviewIcon(reviewIcon)
229                                       .commitLink(false)
230                                       .build();
231             var notifyBot = NotifyBot.newBuilder()
232                                      .repository(repo)
233                                      .storagePath(storageFolder)
234                                      .branches(Pattern.compile(&quot;master&quot;))
235                                      .tagStorageBuilder(tagStorage)
236                                      .branchStorageBuilder(branchStorage)
<span class="line-modified">237                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
238                                      .prUpdaters(List.of(updater)).readyLabels(Set.of(&quot;rfr&quot;))
239                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
240                                      .build();
241             // Initialize history
242             TestBotRunner.runPeriodicItems(notifyBot);
243 
244             // Create an issue and a pull request to fix it
245             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
246             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
247             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
248             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
249             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
250             TestBotRunner.runPeriodicItems(notifyBot);
251 
252             // Add required label
253             pr.addLabel(&quot;rfr&quot;);
254             TestBotRunner.runPeriodicItems(notifyBot);
255 
256             // And the required comment
257             var reviewPr = reviewer.pullRequest(pr.id());
</pre>
<hr />
<pre>
259             TestBotRunner.runPeriodicItems(notifyBot);
260 
261             // The issue should still not contain a link to the PR
262             var links = issue.links();
263             assertEquals(0, links.size());
264         }
265     }
266 
267     @Test
268     void testPullRequestPROnly(TestInfo testInfo) throws IOException {
269         try (var credentials = new HostCredentials(testInfo);
270              var tempFolder = new TemporaryDirectory()) {
271             var repo = credentials.getHostedRepository();
272             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
273             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
274             credentials.commitLock(localRepo);
275             localRepo.pushAll(repo.url());
276 
277             var tagStorage = createTagStorage(repo);
278             var branchStorage = createBranchStorage(repo);
<span class="line-modified">279             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
280             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
281 
282             var issueProject = credentials.getIssueProject();
283             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
284             var updater = IssueUpdater.newBuilder()
285                                       .issueProject(issueProject)
286                                       .reviewIcon(reviewIcon)
287                                       .commitLink(true)
288                                       .commitIcon(reviewIcon)
289                                       .build();
290             var notifyBot = NotifyBot.newBuilder()
291                                      .repository(repo)
292                                      .storagePath(storageFolder)
293                                      .branches(Pattern.compile(&quot;.*&quot;))
294                                      .tagStorageBuilder(tagStorage)
295                                      .branchStorageBuilder(branchStorage)
<span class="line-modified">296                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
297                                      .updaters(List.of(updater))
298                                      .prUpdaters(List.of(updater))
299                                      .build();
300 
301             // Initialize history
302             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
303             TestBotRunner.runPeriodicItems(notifyBot);
304 
305             // Create an issue and a pull request to fix it
306             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
307             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
308             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
309             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
310             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
311             TestBotRunner.runPeriodicItems(notifyBot);
312 
313             // The issue should now contain a link to the PR
314             var links = issue.links();
315             assertEquals(1, links.size());
316             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
</pre>
</td>
<td>
<hr />
<pre>
 31 import java.net.URI;
 32 import java.util.*;
 33 import java.util.regex.Pattern;
 34 
 35 import static org.junit.jupiter.api.Assertions.assertEquals;
 36 import static org.openjdk.skara.bots.notify.UpdaterTests.*;
 37 
 38 public class IssueUpdaterTests {
 39     @Test
 40     void testIssueIdempotence(TestInfo testInfo) throws IOException {
 41         try (var credentials = new HostCredentials(testInfo);
 42              var tempFolder = new TemporaryDirectory()) {
 43             var repo = credentials.getHostedRepository();
 44             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 45             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 46             credentials.commitLock(localRepo);
 47             localRepo.pushAll(repo.url());
 48 
 49             var tagStorage = createTagStorage(repo);
 50             var branchStorage = createBranchStorage(repo);
<span class="line-modified"> 51             var prStateStorage = createPullRequestStateStorage(repo);</span>
 52             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 53 
 54             var issueProject = credentials.getIssueProject();
 55             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 56             var updater = IssueUpdater.newBuilder()
 57                                       .issueProject(issueProject)
 58                                       .reviewLink(false)
 59                                       .commitIcon(commitIcon)
 60                                       .build();
 61             var notifyBot = NotifyBot.newBuilder()
 62                                      .repository(repo)
 63                                      .storagePath(storageFolder)
 64                                      .branches(Pattern.compile(&quot;master&quot;))
 65                                      .tagStorageBuilder(tagStorage)
 66                                      .branchStorageBuilder(branchStorage)
<span class="line-modified"> 67                                      .prStateStorageBuilder(prStateStorage)</span>
 68                                      .updaters(List.of(updater))
 69                                      .build();
 70 
 71             // Initialize history
 72             TestBotRunner.runPeriodicItems(notifyBot);
 73 
 74             // Save the state
 75             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
 76 
 77             // Create an issue and commit a fix
 78             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
 79             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
 80             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 81             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
 82             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
 83             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 84             TestBotRunner.runPeriodicItems(notifyBot);
 85 
 86             // The changeset should be reflected in a link
 87             var links = issue.links();
</pre>
<hr />
<pre>
 99 
100             // There should be no new links
101             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
102             assertEquals(1, updatedIssue.links().size());
103         }
104     }
105 
106     @Test
107     void testPullRequest(TestInfo testInfo) throws IOException {
108         try (var credentials = new HostCredentials(testInfo);
109              var tempFolder = new TemporaryDirectory()) {
110             var repo = credentials.getHostedRepository();
111             var reviewer = credentials.getHostedRepository();
112             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
113             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
114             credentials.commitLock(localRepo);
115             localRepo.pushAll(repo.url());
116 
117             var tagStorage = createTagStorage(repo);
118             var branchStorage = createBranchStorage(repo);
<span class="line-modified">119             var prStateStorage = createPullRequestStateStorage(repo);</span>
120             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
121 
122             var issueProject = credentials.getIssueProject();
123             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
124             var updater = IssueUpdater.newBuilder()
125                                       .issueProject(issueProject)
126                                       .reviewIcon(reviewIcon)
127                                       .commitLink(false)
128                                       .build();
129             var notifyBot = NotifyBot.newBuilder()
130                                      .repository(repo)
131                                      .storagePath(storageFolder)
132                                      .branches(Pattern.compile(&quot;master&quot;))
133                                      .tagStorageBuilder(tagStorage)
134                                      .branchStorageBuilder(branchStorage)
<span class="line-modified">135                                      .prStateStorageBuilder(prStateStorage)</span>
136                                      .prUpdaters(List.of(updater))
137                                      .readyLabels(Set.of(&quot;rfr&quot;))
138                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
139                                      .build();
140 
141             // Initialize history
142             TestBotRunner.runPeriodicItems(notifyBot);
143 
144             // Create an issue and a pull request to fix it
145             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
146             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
147             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
148             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
149             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
150             TestBotRunner.runPeriodicItems(notifyBot);
151 
152             // The issue should not yet contain a link to the PR
153             var links = issue.links();
154             assertEquals(0, links.size());
155 
</pre>
<hr />
<pre>
200             assertEquals(0, links1.size());
201             links2 = issue2.links();
202             assertEquals(1, links2.size());
203             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
204         }
205     }
206 
207     @Test
208     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
209         try (var credentials = new HostCredentials(testInfo);
210              var tempFolder = new TemporaryDirectory()) {
211             var repo = credentials.getHostedRepository();
212             var reviewer = credentials.getHostedRepository();
213             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
214             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
215             credentials.commitLock(localRepo);
216             localRepo.pushAll(repo.url());
217 
218             var tagStorage = createTagStorage(repo);
219             var branchStorage = createBranchStorage(repo);
<span class="line-modified">220             var prStateStorage = createPullRequestStateStorage(repo);</span>
221             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
222 
223             var issueProject = credentials.getIssueProject();
224             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
225             var updater = IssueUpdater.newBuilder()
226                                       .issueProject(issueProject)
227                                       .reviewLink(false)
228                                       .reviewIcon(reviewIcon)
229                                       .commitLink(false)
230                                       .build();
231             var notifyBot = NotifyBot.newBuilder()
232                                      .repository(repo)
233                                      .storagePath(storageFolder)
234                                      .branches(Pattern.compile(&quot;master&quot;))
235                                      .tagStorageBuilder(tagStorage)
236                                      .branchStorageBuilder(branchStorage)
<span class="line-modified">237                                      .prStateStorageBuilder(prStateStorage)</span>
238                                      .prUpdaters(List.of(updater)).readyLabels(Set.of(&quot;rfr&quot;))
239                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
240                                      .build();
241             // Initialize history
242             TestBotRunner.runPeriodicItems(notifyBot);
243 
244             // Create an issue and a pull request to fix it
245             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
246             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
247             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
248             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
249             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
250             TestBotRunner.runPeriodicItems(notifyBot);
251 
252             // Add required label
253             pr.addLabel(&quot;rfr&quot;);
254             TestBotRunner.runPeriodicItems(notifyBot);
255 
256             // And the required comment
257             var reviewPr = reviewer.pullRequest(pr.id());
</pre>
<hr />
<pre>
259             TestBotRunner.runPeriodicItems(notifyBot);
260 
261             // The issue should still not contain a link to the PR
262             var links = issue.links();
263             assertEquals(0, links.size());
264         }
265     }
266 
267     @Test
268     void testPullRequestPROnly(TestInfo testInfo) throws IOException {
269         try (var credentials = new HostCredentials(testInfo);
270              var tempFolder = new TemporaryDirectory()) {
271             var repo = credentials.getHostedRepository();
272             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
273             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
274             credentials.commitLock(localRepo);
275             localRepo.pushAll(repo.url());
276 
277             var tagStorage = createTagStorage(repo);
278             var branchStorage = createBranchStorage(repo);
<span class="line-modified">279             var prStateStorage = createPullRequestStateStorage(repo);</span>
280             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
281 
282             var issueProject = credentials.getIssueProject();
283             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
284             var updater = IssueUpdater.newBuilder()
285                                       .issueProject(issueProject)
286                                       .reviewIcon(reviewIcon)
287                                       .commitLink(true)
288                                       .commitIcon(reviewIcon)
289                                       .build();
290             var notifyBot = NotifyBot.newBuilder()
291                                      .repository(repo)
292                                      .storagePath(storageFolder)
293                                      .branches(Pattern.compile(&quot;.*&quot;))
294                                      .tagStorageBuilder(tagStorage)
295                                      .branchStorageBuilder(branchStorage)
<span class="line-modified">296                                      .prStateStorageBuilder(prStateStorage)</span>
297                                      .updaters(List.of(updater))
298                                      .prUpdaters(List.of(updater))
299                                      .build();
300 
301             // Initialize history
302             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
303             TestBotRunner.runPeriodicItems(notifyBot);
304 
305             // Create an issue and a pull request to fix it
306             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
307             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
308             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
309             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
310             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
311             TestBotRunner.runPeriodicItems(notifyBot);
312 
313             // The issue should now contain a link to the PR
314             var links = issue.links();
315             assertEquals(1, links.size());
316             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/PullRequestWorkItem.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JsonUpdaterTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>