<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/JsonUpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IssueUpdaterTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MailingListUpdaterTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/JsonUpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 40 public class JsonUpdaterTests {
 41     private List&lt;Path&gt; findJsonFiles(Path folder, String partialName) throws IOException {
 42         return Files.walk(folder)
 43                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
 44                     .filter(path -&gt; path.toString().contains(partialName))
 45                     .collect(Collectors.toList());
 46     }
 47 
 48     @Test
 49     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
 50         try (var credentials = new HostCredentials(testInfo);
 51              var tempFolder = new TemporaryDirectory()) {
 52             var repo = credentials.getHostedRepository();
 53             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 54             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 55             credentials.commitLock(localRepo);
 56             localRepo.pushAll(repo.url());
 57 
 58             var tagStorage = createTagStorage(repo);
 59             var branchStorage = createBranchStorage(repo);
<span class="line-modified"> 60             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
 61             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 62             Files.createDirectory(jsonFolder);
 63             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 64 
 65             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
 66             var notifyBot = NotifyBot.newBuilder()
 67                                      .repository(repo)
 68                                      .storagePath(storageFolder)
 69                                      .branches(Pattern.compile(&quot;master&quot;))
 70                                      .tagStorageBuilder(tagStorage)
 71                                      .branchStorageBuilder(branchStorage)
<span class="line-modified"> 72                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
 73                                      .updaters(List.of(updater))
 74                                      .build();
 75 
 76             TestBotRunner.runPeriodicItems(notifyBot);
 77             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 78 
 79             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 80             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 81             TestBotRunner.runPeriodicItems(notifyBot);
 82             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 83             assertEquals(1, jsonFiles.size());
 84             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 85             var json = JSON.parse(jsonData);
 86             assertEquals(1, json.asArray().size());
 87             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 88             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 89                                                   .map(JSONValue::asString)
 90                                                   .collect(Collectors.toList()));
 91         }
 92     }
 93 
 94     @Test
 95     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
 96         try (var credentials = new HostCredentials(testInfo);
 97              var tempFolder = new TemporaryDirectory()) {
 98             var repo = credentials.getHostedRepository();
 99             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
100             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
101             credentials.commitLock(localRepo);
102             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
103             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
104             localRepo.pushAll(repo.url());
105 
106             var tagStorage = UpdaterTests.createTagStorage(repo);
107             var branchStorage = createBranchStorage(repo);
<span class="line-modified">108             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
109             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
110             Files.createDirectory(jsonFolder);
111             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
112 
113             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
114             var notifyBot = NotifyBot.newBuilder()
115                                      .repository(repo)
116                                      .storagePath(storageFolder)
117                                      .branches(Pattern.compile(&quot;master&quot;))
118                                      .tagStorageBuilder(tagStorage)
119                                      .branchStorageBuilder(branchStorage)
<span class="line-modified">120                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
121                                      .updaters(List.of(updater))
122                                      .build();
123 
124             TestBotRunner.runPeriodicItems(notifyBot);
125             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
126 
127             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
128             localRepo.fetch(repo.url(), &quot;history:history&quot;);
129             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
130             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
131             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
132             localRepo.pushAll(repo.url());
133 
134             TestBotRunner.runPeriodicItems(notifyBot);
135             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
136             assertEquals(3, jsonFiles.size());
137 
138             for (var file : jsonFiles) {
139                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
140                 var json = JSON.parse(jsonData);
</pre>
</td>
<td>
<hr />
<pre>
 40 public class JsonUpdaterTests {
 41     private List&lt;Path&gt; findJsonFiles(Path folder, String partialName) throws IOException {
 42         return Files.walk(folder)
 43                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
 44                     .filter(path -&gt; path.toString().contains(partialName))
 45                     .collect(Collectors.toList());
 46     }
 47 
 48     @Test
 49     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
 50         try (var credentials = new HostCredentials(testInfo);
 51              var tempFolder = new TemporaryDirectory()) {
 52             var repo = credentials.getHostedRepository();
 53             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 54             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 55             credentials.commitLock(localRepo);
 56             localRepo.pushAll(repo.url());
 57 
 58             var tagStorage = createTagStorage(repo);
 59             var branchStorage = createBranchStorage(repo);
<span class="line-modified"> 60             var prStateStorage = createPullRequestStateStorage(repo);</span>
 61             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 62             Files.createDirectory(jsonFolder);
 63             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 64 
 65             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
 66             var notifyBot = NotifyBot.newBuilder()
 67                                      .repository(repo)
 68                                      .storagePath(storageFolder)
 69                                      .branches(Pattern.compile(&quot;master&quot;))
 70                                      .tagStorageBuilder(tagStorage)
 71                                      .branchStorageBuilder(branchStorage)
<span class="line-modified"> 72                                      .prStateStorageBuilder(prStateStorage)</span>
 73                                      .updaters(List.of(updater))
 74                                      .build();
 75 
 76             TestBotRunner.runPeriodicItems(notifyBot);
 77             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 78 
 79             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 80             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 81             TestBotRunner.runPeriodicItems(notifyBot);
 82             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 83             assertEquals(1, jsonFiles.size());
 84             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 85             var json = JSON.parse(jsonData);
 86             assertEquals(1, json.asArray().size());
 87             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 88             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 89                                                   .map(JSONValue::asString)
 90                                                   .collect(Collectors.toList()));
 91         }
 92     }
 93 
 94     @Test
 95     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
 96         try (var credentials = new HostCredentials(testInfo);
 97              var tempFolder = new TemporaryDirectory()) {
 98             var repo = credentials.getHostedRepository();
 99             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
100             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
101             credentials.commitLock(localRepo);
102             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
103             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
104             localRepo.pushAll(repo.url());
105 
106             var tagStorage = UpdaterTests.createTagStorage(repo);
107             var branchStorage = createBranchStorage(repo);
<span class="line-modified">108             var prStateStorage = createPullRequestStateStorage(repo);</span>
109             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
110             Files.createDirectory(jsonFolder);
111             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
112 
113             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
114             var notifyBot = NotifyBot.newBuilder()
115                                      .repository(repo)
116                                      .storagePath(storageFolder)
117                                      .branches(Pattern.compile(&quot;master&quot;))
118                                      .tagStorageBuilder(tagStorage)
119                                      .branchStorageBuilder(branchStorage)
<span class="line-modified">120                                      .prStateStorageBuilder(prStateStorage)</span>
121                                      .updaters(List.of(updater))
122                                      .build();
123 
124             TestBotRunner.runPeriodicItems(notifyBot);
125             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
126 
127             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
128             localRepo.fetch(repo.url(), &quot;history:history&quot;);
129             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
130             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
131             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
132             localRepo.pushAll(repo.url());
133 
134             TestBotRunner.runPeriodicItems(notifyBot);
135             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
136             assertEquals(3, jsonFiles.size());
137 
138             for (var file : jsonFiles) {
139                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
140                 var json = JSON.parse(jsonData);
</pre>
</td>
</tr>
</table>
<center><a href="IssueUpdaterTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MailingListUpdaterTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>