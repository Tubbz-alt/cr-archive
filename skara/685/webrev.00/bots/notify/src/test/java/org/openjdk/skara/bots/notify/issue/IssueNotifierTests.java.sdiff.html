<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/issue/IssueNotifierTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../main/java/org/openjdk/skara/bots/notify/issue/IssueNotifierFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/issue/IssueNotifierTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.notify.issue;
 24 
 25 import org.junit.jupiter.api.*;
 26 import org.openjdk.skara.bots.notify.NotifyBot;
<span class="line-modified"> 27 import org.openjdk.skara.issuetracker.Issue;</span>
<span class="line-modified"> 28 import org.openjdk.skara.json.JSON;</span>

 29 import org.openjdk.skara.test.*;
 30 
 31 import java.io.IOException;
 32 import java.net.URI;

 33 import java.util.*;
 34 import java.util.regex.Pattern;

 35 
<span class="line-modified"> 36 import static org.junit.jupiter.api.Assertions.assertEquals;</span>
 37 import static org.openjdk.skara.bots.notify.TestUtils.*;

 38 
 39 public class IssueNotifierTests {

































 40     @Test
<span class="line-modified"> 41     void testIssueIdempotence(TestInfo testInfo) throws IOException {</span>
 42         try (var credentials = new HostCredentials(testInfo);
 43              var tempFolder = new TemporaryDirectory()) {
 44             var repo = credentials.getHostedRepository();
 45             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 46             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 47             credentials.commitLock(localRepo);
 48             localRepo.pushAll(repo.url());
 49 
 50             var tagStorage = createTagStorage(repo);
 51             var branchStorage = createBranchStorage(repo);
 52             var prStateStorage = createPullRequestStateStorage(repo);
 53             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 54 
 55             var issueProject = credentials.getIssueProject();
 56             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 57             var notifyBot = NotifyBot.newBuilder()
 58                                      .repository(repo)
 59                                      .storagePath(storageFolder)
 60                                      .branches(Pattern.compile(&quot;master&quot;))
 61                                      .tagStorageBuilder(tagStorage)
</pre>
<hr />
<pre>
325             pr.addLabel(&quot;integrated&quot;);
326             pr.setState(Issue.State.CLOSED);
327             localRepo.push(editHash, repo.url(), &quot;other&quot;);
328             TestBotRunner.runPeriodicItems(notifyBot);
329 
330             // The changeset should be reflected in another link
331             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
332             links = updatedIssue.links();
333             assertEquals(2, links.size());
334 
335             // Now simulate a merge to another branch
336             localRepo.push(editHash, repo.url(), &quot;master&quot;);
337             TestBotRunner.runPeriodicItems(notifyBot);
338 
339             // No additional link should have been created
340             updatedIssue = issueProject.issue(issue.id()).orElseThrow();
341             links = updatedIssue.links();
342             assertEquals(2, links.size());
343         }
344     }





















































































































































































































































































































































345 }
</pre>
</td>
<td>
<hr />
<pre>
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.notify.issue;
 24 
 25 import org.junit.jupiter.api.*;
 26 import org.openjdk.skara.bots.notify.NotifyBot;
<span class="line-modified"> 27 import org.openjdk.skara.forge.HostedRepository;</span>
<span class="line-modified"> 28 import org.openjdk.skara.issuetracker.*;</span>
<span class="line-added"> 29 import org.openjdk.skara.json.*;</span>
 30 import org.openjdk.skara.test.*;
 31 
 32 import java.io.IOException;
 33 import java.net.URI;
<span class="line-added"> 34 import java.nio.file.Path;</span>
 35 import java.util.*;
 36 import java.util.regex.Pattern;
<span class="line-added"> 37 import java.util.stream.Collectors;</span>
 38 
<span class="line-modified"> 39 import static org.junit.jupiter.api.Assertions.*;</span>
 40 import static org.openjdk.skara.bots.notify.TestUtils.*;
<span class="line-added"> 41 import static org.openjdk.skara.issuetracker.Issue.State.*;</span>
 42 
 43 public class IssueNotifierTests {
<span class="line-added"> 44     private Set&lt;String&gt; fixVersions(Issue issue) {</span>
<span class="line-added"> 45         if (!issue.properties().containsKey(&quot;fixVersions&quot;)) {</span>
<span class="line-added"> 46             return Set.of();</span>
<span class="line-added"> 47         }</span>
<span class="line-added"> 48         return issue.properties().get(&quot;fixVersions&quot;).stream()</span>
<span class="line-added"> 49                     .map(JSONValue::asString)</span>
<span class="line-added"> 50                     .collect(Collectors.toSet());</span>
<span class="line-added"> 51     }</span>
<span class="line-added"> 52 </span>
<span class="line-added"> 53     private TestBotFactory testBotBuilder(HostedRepository hostedRepository, IssueProject issueProject, Path storagePath, JSONObject notifierConfig) throws IOException {</span>
<span class="line-added"> 54         if (!notifierConfig.contains(&quot;project&quot;)) {</span>
<span class="line-added"> 55             notifierConfig.put(&quot;project&quot;, &quot;issueproject&quot;);</span>
<span class="line-added"> 56         }</span>
<span class="line-added"> 57         return TestBotFactory.newBuilder()</span>
<span class="line-added"> 58                              .addHostedRepository(&quot;hostedrepo&quot;, hostedRepository)</span>
<span class="line-added"> 59                              .addIssueProject(&quot;issueproject&quot;, issueProject)</span>
<span class="line-added"> 60                              .storagePath(storagePath)</span>
<span class="line-added"> 61                              .addConfiguration(&quot;database&quot;, JSON.object()</span>
<span class="line-added"> 62                                                                .put(&quot;repository&quot;, &quot;hostedrepo:history&quot;)</span>
<span class="line-added"> 63                                                                .put(&quot;name&quot;, &quot;duke&quot;)</span>
<span class="line-added"> 64                                                                .put(&quot;email&quot;, &quot;duke@openjdk.org&quot;))</span>
<span class="line-added"> 65                              .addConfiguration(&quot;ready&quot;, JSON.object()</span>
<span class="line-added"> 66                                                             .put(&quot;labels&quot;, JSON.array())</span>
<span class="line-added"> 67                                                             .put(&quot;comments&quot;, JSON.array()))</span>
<span class="line-added"> 68                              .addConfiguration(&quot;integrator&quot;, JSON.of(hostedRepository.forge().currentUser().id()))</span>
<span class="line-added"> 69                              .addConfiguration(&quot;repositories&quot;, JSON.object()</span>
<span class="line-added"> 70                                                                    .put(&quot;hostedrepo&quot;, JSON.object()</span>
<span class="line-added"> 71                                                                                           .put(&quot;basename&quot;, &quot;test&quot;)</span>
<span class="line-added"> 72                                                                                           .put(&quot;branches&quot;, &quot;master&quot;)</span>
<span class="line-added"> 73                                                                                           .put(&quot;issue&quot;, notifierConfig)))</span>
<span class="line-added"> 74                              .build();</span>
<span class="line-added"> 75     }</span>
<span class="line-added"> 76 </span>
 77     @Test
<span class="line-modified"> 78     void testIssueLinkIdempotence(TestInfo testInfo) throws IOException {</span>
 79         try (var credentials = new HostCredentials(testInfo);
 80              var tempFolder = new TemporaryDirectory()) {
 81             var repo = credentials.getHostedRepository();
 82             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 83             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 84             credentials.commitLock(localRepo);
 85             localRepo.pushAll(repo.url());
 86 
 87             var tagStorage = createTagStorage(repo);
 88             var branchStorage = createBranchStorage(repo);
 89             var prStateStorage = createPullRequestStateStorage(repo);
 90             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 91 
 92             var issueProject = credentials.getIssueProject();
 93             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 94             var notifyBot = NotifyBot.newBuilder()
 95                                      .repository(repo)
 96                                      .storagePath(storageFolder)
 97                                      .branches(Pattern.compile(&quot;master&quot;))
 98                                      .tagStorageBuilder(tagStorage)
</pre>
<hr />
<pre>
362             pr.addLabel(&quot;integrated&quot;);
363             pr.setState(Issue.State.CLOSED);
364             localRepo.push(editHash, repo.url(), &quot;other&quot;);
365             TestBotRunner.runPeriodicItems(notifyBot);
366 
367             // The changeset should be reflected in another link
368             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
369             links = updatedIssue.links();
370             assertEquals(2, links.size());
371 
372             // Now simulate a merge to another branch
373             localRepo.push(editHash, repo.url(), &quot;master&quot;);
374             TestBotRunner.runPeriodicItems(notifyBot);
375 
376             // No additional link should have been created
377             updatedIssue = issueProject.issue(issue.id()).orElseThrow();
378             links = updatedIssue.links();
379             assertEquals(2, links.size());
380         }
381     }
<span class="line-added">382 </span>
<span class="line-added">383     @Test</span>
<span class="line-added">384     void testIssue(TestInfo testInfo) throws IOException {</span>
<span class="line-added">385         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">386              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">387 </span>
<span class="line-added">388             var repo = credentials.getHostedRepository();</span>
<span class="line-added">389             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">390             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-added">391             credentials.commitLock(localRepo);</span>
<span class="line-added">392             localRepo.pushAll(repo.url());</span>
<span class="line-added">393 </span>
<span class="line-added">394             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">395             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">396             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object());</span>
<span class="line-added">397             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">398 </span>
<span class="line-added">399             // Initialize history</span>
<span class="line-added">400             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">401 </span>
<span class="line-added">402             // Create an issue and commit a fix</span>
<span class="line-added">403             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;</span>
<span class="line-added">404             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-added">405             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);</span>
<span class="line-added">406             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">407             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">408 </span>
<span class="line-added">409             // The changeset should be reflected in a comment</span>
<span class="line-added">410             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-added">411 </span>
<span class="line-added">412             var comments = updatedIssue.comments();</span>
<span class="line-added">413             assertEquals(1, comments.size());</span>
<span class="line-added">414             var comment = comments.get(0);</span>
<span class="line-added">415             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-added">416 </span>
<span class="line-added">417             // As well as a fixVersion</span>
<span class="line-added">418             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));</span>
<span class="line-added">419 </span>
<span class="line-added">420             // The issue should be assigned and resolved</span>
<span class="line-added">421             assertEquals(RESOLVED, updatedIssue.state());</span>
<span class="line-added">422             assertEquals(List.of(issueProject.issueTracker().currentUser()), updatedIssue.assignees());</span>
<span class="line-added">423         }</span>
<span class="line-added">424     }</span>
<span class="line-added">425 </span>
<span class="line-added">426     @Test</span>
<span class="line-added">427     void testIssueNoVersion(TestInfo testInfo) throws IOException {</span>
<span class="line-added">428         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">429              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">430             var repo = credentials.getHostedRepository();</span>
<span class="line-added">431             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">432             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-added">433             credentials.commitLock(localRepo);</span>
<span class="line-added">434             localRepo.pushAll(repo.url());</span>
<span class="line-added">435 </span>
<span class="line-added">436             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">437             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">438             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object());</span>
<span class="line-added">439             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">440 </span>
<span class="line-added">441             // Initialize history</span>
<span class="line-added">442             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">443 </span>
<span class="line-added">444             // Create an issue and commit a fix</span>
<span class="line-added">445             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-added">446             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">447             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">448             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">449 </span>
<span class="line-added">450             // The changeset should be reflected in a comment</span>
<span class="line-added">451             var comments = issue.comments();</span>
<span class="line-added">452             assertEquals(1, comments.size());</span>
<span class="line-added">453             var comment = comments.get(0);</span>
<span class="line-added">454             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-added">455 </span>
<span class="line-added">456             // But not in the fixVersion</span>
<span class="line-added">457             assertEquals(Set.of(), fixVersions(issue));</span>
<span class="line-added">458         }</span>
<span class="line-added">459     }</span>
<span class="line-added">460 </span>
<span class="line-added">461     @Test</span>
<span class="line-added">462     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {</span>
<span class="line-added">463         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">464              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">465             var repo = credentials.getHostedRepository();</span>
<span class="line-added">466             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">467             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-added">468             credentials.commitLock(localRepo);</span>
<span class="line-added">469             localRepo.pushAll(repo.url());</span>
<span class="line-added">470 </span>
<span class="line-added">471             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">472             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">473             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;2.0&quot;));</span>
<span class="line-added">474             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">475 </span>
<span class="line-added">476             // Initialize history</span>
<span class="line-added">477             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">478 </span>
<span class="line-added">479             // Create an issue and commit a fix</span>
<span class="line-added">480             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-added">481             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">482             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">483             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">484 </span>
<span class="line-added">485             // The changeset should not reflected in a comment</span>
<span class="line-added">486             var comments = issue.comments();</span>
<span class="line-added">487             assertEquals(1, comments.size());</span>
<span class="line-added">488             var comment = comments.get(0);</span>
<span class="line-added">489             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-added">490 </span>
<span class="line-added">491             // As well as a fixVersion - but not the one from the repo</span>
<span class="line-added">492             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));</span>
<span class="line-added">493 </span>
<span class="line-added">494             // And no commit link</span>
<span class="line-added">495             var links = issue.links();</span>
<span class="line-added">496             assertEquals(0, links.size());</span>
<span class="line-added">497         }</span>
<span class="line-added">498     }</span>
<span class="line-added">499 </span>
<span class="line-added">500     @Test</span>
<span class="line-added">501     void testIssueIdempotence(TestInfo testInfo) throws IOException {</span>
<span class="line-added">502         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">503              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">504             var repo = credentials.getHostedRepository();</span>
<span class="line-added">505             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">506             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-added">507             credentials.commitLock(localRepo);</span>
<span class="line-added">508             localRepo.pushAll(repo.url());</span>
<span class="line-added">509 </span>
<span class="line-added">510             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">511             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">512             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object());</span>
<span class="line-added">513             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">514 </span>
<span class="line-added">515             // Initialize history</span>
<span class="line-added">516             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">517 </span>
<span class="line-added">518             // Save the state</span>
<span class="line-added">519             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);</span>
<span class="line-added">520 </span>
<span class="line-added">521             // Create an issue and commit a fix</span>
<span class="line-added">522             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-added">523             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">524             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">525             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">526 </span>
<span class="line-added">527             // The changeset should be reflected in a comment</span>
<span class="line-added">528             var comments = issue.comments();</span>
<span class="line-added">529             assertEquals(1, comments.size());</span>
<span class="line-added">530             var comment = comments.get(0);</span>
<span class="line-added">531             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-added">532 </span>
<span class="line-added">533             // As well as a fixVersion</span>
<span class="line-added">534             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));</span>
<span class="line-added">535 </span>
<span class="line-added">536             // Wipe the history</span>
<span class="line-added">537             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);</span>
<span class="line-added">538 </span>
<span class="line-added">539             // Run it again</span>
<span class="line-added">540             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">541 </span>
<span class="line-added">542             // There should be no new comments or fixVersions</span>
<span class="line-added">543             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-added">544             assertEquals(1, updatedIssue.comments().size());</span>
<span class="line-added">545             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));</span>
<span class="line-added">546         }</span>
<span class="line-added">547     }</span>
<span class="line-added">548 </span>
<span class="line-added">549     @Test</span>
<span class="line-added">550     void testIssuePoolVersion(TestInfo testInfo) throws IOException {</span>
<span class="line-added">551         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">552              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">553             var repo = credentials.getHostedRepository();</span>
<span class="line-added">554             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">555             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-added">556             credentials.commitLock(localRepo);</span>
<span class="line-added">557             localRepo.pushAll(repo.url());</span>
<span class="line-added">558 </span>
<span class="line-added">559             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">560             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">561             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;12u14&quot;));</span>
<span class="line-added">562             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">563 </span>
<span class="line-added">564             // Initialize history</span>
<span class="line-added">565             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">566 </span>
<span class="line-added">567             // Create an issue and commit a fix</span>
<span class="line-added">568             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-added">569             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));</span>
<span class="line-added">570 </span>
<span class="line-added">571             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">572             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">573             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">574 </span>
<span class="line-added">575             // The fixVersion should have been updated</span>
<span class="line-added">576             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));</span>
<span class="line-added">577         }</span>
<span class="line-added">578     }</span>
<span class="line-added">579 </span>
<span class="line-added">580     @Test</span>
<span class="line-added">581     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {</span>
<span class="line-added">582         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">583              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">584             var repo = credentials.getHostedRepository();</span>
<span class="line-added">585             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">586             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-added">587             credentials.commitLock(localRepo);</span>
<span class="line-added">588             localRepo.pushAll(repo.url());</span>
<span class="line-added">589 </span>
<span class="line-added">590             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">591             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">592             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;12u14&quot;));</span>
<span class="line-added">593             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">594 </span>
<span class="line-added">595             // Initialize history</span>
<span class="line-added">596             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">597 </span>
<span class="line-added">598             // Create an issue and commit a fix</span>
<span class="line-added">599             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-added">600             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));</span>
<span class="line-added">601 </span>
<span class="line-added">602             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">603             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">604             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">605 </span>
<span class="line-added">606             // The fixVersion should have been updated</span>
<span class="line-added">607             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));</span>
<span class="line-added">608         }</span>
<span class="line-added">609     }</span>
<span class="line-added">610 </span>
<span class="line-added">611     @Test</span>
<span class="line-added">612     void testIssueBackport(TestInfo testInfo) throws IOException {</span>
<span class="line-added">613         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">614              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">615             var repo = credentials.getHostedRepository();</span>
<span class="line-added">616             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">617             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-added">618             credentials.commitLock(localRepo);</span>
<span class="line-added">619             localRepo.pushAll(repo.url());</span>
<span class="line-added">620 </span>
<span class="line-added">621             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">622             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">623             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;12.0.2&quot;));</span>
<span class="line-added">624             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">625 </span>
<span class="line-added">626             // Initialize history</span>
<span class="line-added">627             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">628 </span>
<span class="line-added">629             // Create an issue and commit a fix</span>
<span class="line-added">630             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),</span>
<span class="line-added">631                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),</span>
<span class="line-added">632                                                         &quot;customfield_10008&quot;, JSON.object()</span>
<span class="line-added">633                                                                                  .put(&quot;id&quot;, 244)</span>
<span class="line-added">634                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),</span>
<span class="line-added">635                                                         &quot;customfield_10005&quot;, JSON.array()</span>
<span class="line-added">636                                                                                  .add(JSON.object()</span>
<span class="line-added">637                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)</span>
<span class="line-added">638                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))</span>
<span class="line-added">639                                                                                  .add(JSON.object()</span>
<span class="line-added">640                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)</span>
<span class="line-added">641                                                                                           .put(&quot;value&quot;, &quot;other&quot;))</span>
<span class="line-added">642                                                  ));</span>
<span class="line-added">643             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));</span>
<span class="line-added">644             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));</span>
<span class="line-added">645 </span>
<span class="line-added">646             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;</span>
<span class="line-added">647             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);</span>
<span class="line-added">648             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">649             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">650 </span>
<span class="line-added">651             // The fixVersion should not have been updated</span>
<span class="line-added">652             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-added">653             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));</span>
<span class="line-added">654             assertEquals(OPEN, updatedIssue.state());</span>
<span class="line-added">655             assertEquals(List.of(), updatedIssue.assignees());</span>
<span class="line-added">656 </span>
<span class="line-added">657             // There should be a link</span>
<span class="line-added">658             var links = updatedIssue.links();</span>
<span class="line-added">659             assertEquals(1, links.size());</span>
<span class="line-added">660             var link = links.get(0);</span>
<span class="line-added">661             var backport = link.issue().orElseThrow();</span>
<span class="line-added">662 </span>
<span class="line-added">663             // The backport issue should have a correct fixVersion and assignee</span>
<span class="line-added">664             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));</span>
<span class="line-added">665             assertEquals(RESOLVED, backport.state());</span>
<span class="line-added">666             assertEquals(List.of(issueProject.issueTracker().currentUser()), backport.assignees());</span>
<span class="line-added">667 </span>
<span class="line-added">668             // Custom properties should also propagate</span>
<span class="line-added">669             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());</span>
<span class="line-added">670             assertEquals(244, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;id&quot;).asInt());</span>
<span class="line-added">671             assertEquals(&quot;java.io&quot;, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;name&quot;).asString());</span>
<span class="line-added">672             assertEquals(2, backport.properties().get(&quot;customfield_10005&quot;).asArray().size());</span>
<span class="line-added">673         }</span>
<span class="line-added">674     }</span>
<span class="line-added">675 </span>
<span class="line-added">676     @Test</span>
<span class="line-added">677     void testSyncLabels(TestInfo testInfo) throws IOException {</span>
<span class="line-added">678         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">679              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">680             var repo = credentials.getHostedRepository();</span>
<span class="line-added">681             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">682             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-added">683             credentials.commitLock(localRepo);</span>
<span class="line-added">684             localRepo.pushAll(repo.url());</span>
<span class="line-added">685 </span>
<span class="line-added">686             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">687             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">688             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;8u192&quot;));</span>
<span class="line-added">689             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">690 </span>
<span class="line-added">691             // Initialize database</span>
<span class="line-added">692             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">693 </span>
<span class="line-added">694             var issue1 = credentials.createIssue(issueProject, &quot;Issue 1&quot;);</span>
<span class="line-added">695             issue1.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Bug&quot;));</span>
<span class="line-added">696 </span>
<span class="line-added">697             var issue2 = credentials.createIssue(issueProject, &quot;Issue 2&quot;);</span>
<span class="line-added">698             issue2.setProperty(&quot;fixVersions&quot;, JSON.array().add(JSON.of(&quot;8u162&quot;)));</span>
<span class="line-added">699             issue2.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Backport&quot;));</span>
<span class="line-added">700             issue1.addLink(Link.create(issue2, &quot;backported by&quot;).build());</span>
<span class="line-added">701 </span>
<span class="line-added">702             var issue3 = credentials.createIssue(issueProject, &quot;Issue 3&quot;);</span>
<span class="line-added">703             issue3.setProperty(&quot;fixVersions&quot;, JSON.array().add(JSON.of(&quot;10&quot;)));</span>
<span class="line-added">704             issue3.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Backport&quot;));</span>
<span class="line-added">705             issue1.addLink(Link.create(issue3, &quot;backported by&quot;).build());</span>
<span class="line-added">706 </span>
<span class="line-added">707             var issue4 = credentials.createIssue(issueProject, &quot;Issue 4&quot;);</span>
<span class="line-added">708             issue4.setProperty(&quot;fixVersions&quot;, JSON.array().add(JSON.of(&quot;11&quot;)));</span>
<span class="line-added">709             issue4.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Backport&quot;));</span>
<span class="line-added">710             issue1.addLink(Link.create(issue4, &quot;backported by&quot;).build());</span>
<span class="line-added">711 </span>
<span class="line-added">712             // Mention one of the issues</span>
<span class="line-added">713             var commit = CheckableRepository.appendAndCommit(localRepo, &quot;Hello there&quot;, issue1.id() + &quot;: A fix&quot;);</span>
<span class="line-added">714             localRepo.push(commit, repo.url(), &quot;master&quot;);</span>
<span class="line-added">715             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">716 </span>
<span class="line-added">717             assertEquals(List.of(&quot;hgupdater-sync&quot;), issue1.labels());</span>
<span class="line-added">718             assertEquals(List.of(), issue2.labels());</span>
<span class="line-added">719             assertEquals(List.of(), issue3.labels());</span>
<span class="line-added">720             assertEquals(List.of(&quot;hgupdater-sync&quot;), issue4.labels());</span>
<span class="line-added">721         }</span>
<span class="line-added">722     }</span>
723 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../main/java/org/openjdk/skara/bots/notify/issue/IssueNotifierFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>