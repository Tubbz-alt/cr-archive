<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/notify/src/test/java/org/openjdk/skara/bots/notify/issue/IssueNotifierTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.notify.issue;
 24 
 25 import org.junit.jupiter.api.*;
 26 import org.openjdk.skara.bots.notify.NotifyBot;
<a name="1" id="anc1"></a><span class="line-modified"> 27 import org.openjdk.skara.forge.HostedRepository;</span>
<span class="line-modified"> 28 import org.openjdk.skara.issuetracker.*;</span>
<span class="line-added"> 29 import org.openjdk.skara.json.*;</span>
 30 import org.openjdk.skara.test.*;
 31 
 32 import java.io.IOException;
 33 import java.net.URI;
<a name="2" id="anc2"></a><span class="line-added"> 34 import java.nio.file.Path;</span>
 35 import java.util.*;
 36 import java.util.regex.Pattern;
<a name="3" id="anc3"></a><span class="line-added"> 37 import java.util.stream.Collectors;</span>
 38 
<a name="4" id="anc4"></a><span class="line-modified"> 39 import static org.junit.jupiter.api.Assertions.*;</span>
 40 import static org.openjdk.skara.bots.notify.TestUtils.*;
<a name="5" id="anc5"></a><span class="line-added"> 41 import static org.openjdk.skara.issuetracker.Issue.State.*;</span>
 42 
 43 public class IssueNotifierTests {
<a name="6" id="anc6"></a><span class="line-added"> 44     private Set&lt;String&gt; fixVersions(Issue issue) {</span>
<span class="line-added"> 45         if (!issue.properties().containsKey(&quot;fixVersions&quot;)) {</span>
<span class="line-added"> 46             return Set.of();</span>
<span class="line-added"> 47         }</span>
<span class="line-added"> 48         return issue.properties().get(&quot;fixVersions&quot;).stream()</span>
<span class="line-added"> 49                     .map(JSONValue::asString)</span>
<span class="line-added"> 50                     .collect(Collectors.toSet());</span>
<span class="line-added"> 51     }</span>
<span class="line-added"> 52 </span>
<span class="line-added"> 53     private TestBotFactory testBotBuilder(HostedRepository hostedRepository, IssueProject issueProject, Path storagePath, JSONObject notifierConfig) throws IOException {</span>
<span class="line-added"> 54         if (!notifierConfig.contains(&quot;project&quot;)) {</span>
<span class="line-added"> 55             notifierConfig.put(&quot;project&quot;, &quot;issueproject&quot;);</span>
<span class="line-added"> 56         }</span>
<span class="line-added"> 57         return TestBotFactory.newBuilder()</span>
<span class="line-added"> 58                              .addHostedRepository(&quot;hostedrepo&quot;, hostedRepository)</span>
<span class="line-added"> 59                              .addIssueProject(&quot;issueproject&quot;, issueProject)</span>
<span class="line-added"> 60                              .storagePath(storagePath)</span>
<span class="line-added"> 61                              .addConfiguration(&quot;database&quot;, JSON.object()</span>
<span class="line-added"> 62                                                                .put(&quot;repository&quot;, &quot;hostedrepo:history&quot;)</span>
<span class="line-added"> 63                                                                .put(&quot;name&quot;, &quot;duke&quot;)</span>
<span class="line-added"> 64                                                                .put(&quot;email&quot;, &quot;duke@openjdk.org&quot;))</span>
<span class="line-added"> 65                              .addConfiguration(&quot;ready&quot;, JSON.object()</span>
<span class="line-added"> 66                                                             .put(&quot;labels&quot;, JSON.array())</span>
<span class="line-added"> 67                                                             .put(&quot;comments&quot;, JSON.array()))</span>
<span class="line-added"> 68                              .addConfiguration(&quot;integrator&quot;, JSON.of(hostedRepository.forge().currentUser().id()))</span>
<span class="line-added"> 69                              .addConfiguration(&quot;repositories&quot;, JSON.object()</span>
<span class="line-added"> 70                                                                    .put(&quot;hostedrepo&quot;, JSON.object()</span>
<span class="line-added"> 71                                                                                           .put(&quot;basename&quot;, &quot;test&quot;)</span>
<span class="line-added"> 72                                                                                           .put(&quot;branches&quot;, &quot;master&quot;)</span>
<span class="line-added"> 73                                                                                           .put(&quot;issue&quot;, notifierConfig)))</span>
<span class="line-added"> 74                              .build();</span>
<span class="line-added"> 75     }</span>
<span class="line-added"> 76 </span>
 77     @Test
<a name="7" id="anc7"></a><span class="line-modified"> 78     void testIssueLinkIdempotence(TestInfo testInfo) throws IOException {</span>
 79         try (var credentials = new HostCredentials(testInfo);
 80              var tempFolder = new TemporaryDirectory()) {
 81             var repo = credentials.getHostedRepository();
 82             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 83             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 84             credentials.commitLock(localRepo);
 85             localRepo.pushAll(repo.url());
 86 
 87             var tagStorage = createTagStorage(repo);
 88             var branchStorage = createBranchStorage(repo);
 89             var prStateStorage = createPullRequestStateStorage(repo);
 90             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 91 
 92             var issueProject = credentials.getIssueProject();
 93             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 94             var notifyBot = NotifyBot.newBuilder()
 95                                      .repository(repo)
 96                                      .storagePath(storageFolder)
 97                                      .branches(Pattern.compile(&quot;master&quot;))
 98                                      .tagStorageBuilder(tagStorage)
 99                                      .branchStorageBuilder(branchStorage)
100                                      .prStateStorageBuilder(prStateStorage)
101                                      .integratorId(repo.forge().currentUser().id())
102                                      .build();
103             var updater = IssueNotifier.newBuilder()
104                                       .issueProject(issueProject)
105                                       .reviewLink(false)
106                                       .commitIcon(commitIcon)
107                                       .build();
108             updater.attachTo(notifyBot);
109 
110             // Initialize history
111             TestBotRunner.runPeriodicItems(notifyBot);
112 
113             // Save the state
114             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
115 
116             // Create an issue and commit a fix
117             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
118             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
119             localRepo.push(editHash, repo.url(), &quot;master&quot;);
120             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
121             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
122             pr.addLabel(&quot;integrated&quot;);
123             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
124             TestBotRunner.runPeriodicItems(notifyBot);
125 
126             // The changeset should be reflected in a link
127             var links = issue.links();
128             assertEquals(1, links.size());
129             var link = links.get(0);
130             assertEquals(commitIcon, link.iconUrl().orElseThrow());
131             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
132             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
133 
134             // Wipe the history
135             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
136 
137             // Run it again
138             TestBotRunner.runPeriodicItems(notifyBot);
139 
140             // There should be no new links
141             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
142             assertEquals(1, updatedIssue.links().size());
143         }
144     }
145 
146     @Test
147     void testPullRequest(TestInfo testInfo) throws IOException {
148         try (var credentials = new HostCredentials(testInfo);
149              var tempFolder = new TemporaryDirectory()) {
150             var repo = credentials.getHostedRepository();
151             var reviewer = credentials.getHostedRepository();
152             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
153             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
154             credentials.commitLock(localRepo);
155             localRepo.pushAll(repo.url());
156 
157             var tagStorage = createTagStorage(repo);
158             var branchStorage = createBranchStorage(repo);
159             var prStateStorage = createPullRequestStateStorage(repo);
160             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
161 
162             var issueProject = credentials.getIssueProject();
163             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
164             var notifyBot = NotifyBot.newBuilder()
165                                      .repository(repo)
166                                      .storagePath(storageFolder)
167                                      .branches(Pattern.compile(&quot;master&quot;))
168                                      .tagStorageBuilder(tagStorage)
169                                      .branchStorageBuilder(branchStorage)
170                                      .prStateStorageBuilder(prStateStorage)
171                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
172                                      .build();
173             var updater = IssueNotifier.newBuilder()
174                                       .issueProject(issueProject)
175                                       .reviewIcon(reviewIcon)
176                                       .commitLink(false)
177                                       .build();
178             updater.attachTo(notifyBot);
179 
180             // Initialize history
181             TestBotRunner.runPeriodicItems(notifyBot);
182 
183             // Create an issue and a pull request to fix it
184             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
185             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
186             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
187             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
188             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
189             TestBotRunner.runPeriodicItems(notifyBot);
190 
191             // The issue should not yet contain a link to the PR
192             var links = issue.links();
193             assertEquals(0, links.size());
194 
195             // Just a label isn&#39;t enough
196             pr.addLabel(&quot;rfr&quot;);
197             TestBotRunner.runPeriodicItems(notifyBot);
198             links = issue.links();
199             assertEquals(0, links.size());
200 
201             // Neither is just a comment
202             pr.removeLabel(&quot;rfr&quot;);
203             var reviewPr = reviewer.pullRequest(pr.id());
204             reviewPr.addComment(&quot;This is now ready&quot;);
205             TestBotRunner.runPeriodicItems(notifyBot);
206             links = issue.links();
207             assertEquals(0, links.size());
208 
209             // Both are needed
210             pr.addLabel(&quot;rfr&quot;);
211             TestBotRunner.runPeriodicItems(notifyBot);
212 
213             // The issue should now contain a link to the PR
214             links = issue.links();
215             assertEquals(1, links.size());
216             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
217             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
218 
219             // Add another issue
220             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
221             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n * [&quot; + issue2.id() +
222                     &quot;](http://www.test2.test/): The second issue&quot;);
223             TestBotRunner.runPeriodicItems(notifyBot);
224 
225             // Both issues should contain a link to the PR
226             var links1 = issue.links();
227             assertEquals(1, links1.size());
228             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());
229             var links2 = issue2.links();
230             assertEquals(1, links2.size());
231             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
232 
233             // Drop the first one
234             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
235             TestBotRunner.runPeriodicItems(notifyBot);
236 
237             // Only the second issue should now contain a link to the PR
238             links1 = issue.links();
239             assertEquals(0, links1.size());
240             links2 = issue2.links();
241             assertEquals(1, links2.size());
242             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
243         }
244     }
245 
246     @Test
247     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
248         try (var credentials = new HostCredentials(testInfo);
249              var tempFolder = new TemporaryDirectory()) {
250             var repo = credentials.getHostedRepository();
251             var reviewer = credentials.getHostedRepository();
252             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
253             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
254             credentials.commitLock(localRepo);
255             localRepo.pushAll(repo.url());
256 
257             var tagStorage = createTagStorage(repo);
258             var branchStorage = createBranchStorage(repo);
259             var prStateStorage = createPullRequestStateStorage(repo);
260             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
261 
262             var issueProject = credentials.getIssueProject();
263             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
264             var notifyBot = NotifyBot.newBuilder()
265                                      .repository(repo)
266                                      .storagePath(storageFolder)
267                                      .branches(Pattern.compile(&quot;master&quot;))
268                                      .tagStorageBuilder(tagStorage)
269                                      .branchStorageBuilder(branchStorage)
270                                      .prStateStorageBuilder(prStateStorage)
271                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
272                                      .build();
273             var updater = IssueNotifier.newBuilder()
274                                       .issueProject(issueProject)
275                                       .reviewLink(false)
276                                       .reviewIcon(reviewIcon)
277                                       .commitLink(false)
278                                       .build();
279             updater.attachTo(notifyBot);
280 
281             // Initialize history
282             TestBotRunner.runPeriodicItems(notifyBot);
283 
284             // Create an issue and a pull request to fix it
285             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
286             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
287             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
288             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
289             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
290             TestBotRunner.runPeriodicItems(notifyBot);
291 
292             // Add required label
293             pr.addLabel(&quot;rfr&quot;);
294             TestBotRunner.runPeriodicItems(notifyBot);
295 
296             // And the required comment
297             var reviewPr = reviewer.pullRequest(pr.id());
298             reviewPr.addComment(&quot;This is now ready&quot;);
299             TestBotRunner.runPeriodicItems(notifyBot);
300 
301             // The issue should still not contain a link to the PR
302             var links = issue.links();
303             assertEquals(0, links.size());
304         }
305     }
306 
307     @Test
308     void testPullRequestPROnly(TestInfo testInfo) throws IOException {
309         try (var credentials = new HostCredentials(testInfo);
310              var tempFolder = new TemporaryDirectory()) {
311             var repo = credentials.getHostedRepository();
312             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
313             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
314             credentials.commitLock(localRepo);
315             localRepo.pushAll(repo.url());
316 
317             var tagStorage = createTagStorage(repo);
318             var branchStorage = createBranchStorage(repo);
319             var prStateStorage = createPullRequestStateStorage(repo);
320             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
321 
322             var issueProject = credentials.getIssueProject();
323             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
324             var notifyBot = NotifyBot.newBuilder()
325                                      .repository(repo)
326                                      .storagePath(storageFolder)
327                                      .branches(Pattern.compile(&quot;.*&quot;))
328                                      .tagStorageBuilder(tagStorage)
329                                      .branchStorageBuilder(branchStorage)
330                                      .prStateStorageBuilder(prStateStorage)
331                                      .integratorId(repo.forge().currentUser().id())
332                                      .build();
333             var updater = IssueNotifier.newBuilder()
334                                       .issueProject(issueProject)
335                                       .reviewIcon(reviewIcon)
336                                       .commitLink(true)
337                                       .commitIcon(reviewIcon)
338                                       .build();
339             updater.attachTo(notifyBot);
340 
341             // Initialize history
342             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
343             TestBotRunner.runPeriodicItems(notifyBot);
344 
345             // Create an issue and a pull request to fix it
346             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
347             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
348             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
349             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
350             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
351             pr.addLabel(&quot;rfr&quot;);
352             TestBotRunner.runPeriodicItems(notifyBot);
353 
354             // The issue should now contain a link to the PR
355             var links = issue.links();
356             assertEquals(1, links.size());
357             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
358             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
359 
360             // Simulate integration
361             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
362             pr.addLabel(&quot;integrated&quot;);
363             pr.setState(Issue.State.CLOSED);
364             localRepo.push(editHash, repo.url(), &quot;other&quot;);
365             TestBotRunner.runPeriodicItems(notifyBot);
366 
367             // The changeset should be reflected in another link
368             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
369             links = updatedIssue.links();
370             assertEquals(2, links.size());
371 
372             // Now simulate a merge to another branch
373             localRepo.push(editHash, repo.url(), &quot;master&quot;);
374             TestBotRunner.runPeriodicItems(notifyBot);
375 
376             // No additional link should have been created
377             updatedIssue = issueProject.issue(issue.id()).orElseThrow();
378             links = updatedIssue.links();
379             assertEquals(2, links.size());
380         }
381     }
<a name="8" id="anc8"></a><span class="line-added">382 </span>
<span class="line-added">383     @Test</span>
<span class="line-added">384     void testIssue(TestInfo testInfo) throws IOException {</span>
<span class="line-added">385         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">386              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">387 </span>
<span class="line-added">388             var repo = credentials.getHostedRepository();</span>
<span class="line-added">389             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">390             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-added">391             credentials.commitLock(localRepo);</span>
<span class="line-added">392             localRepo.pushAll(repo.url());</span>
<span class="line-added">393 </span>
<span class="line-added">394             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">395             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">396             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object());</span>
<span class="line-added">397             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">398 </span>
<span class="line-added">399             // Initialize history</span>
<span class="line-added">400             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">401 </span>
<span class="line-added">402             // Create an issue and commit a fix</span>
<span class="line-added">403             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;</span>
<span class="line-added">404             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-added">405             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);</span>
<span class="line-added">406             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">407             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">408 </span>
<span class="line-added">409             // The changeset should be reflected in a comment</span>
<span class="line-added">410             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-added">411 </span>
<span class="line-added">412             var comments = updatedIssue.comments();</span>
<span class="line-added">413             assertEquals(1, comments.size());</span>
<span class="line-added">414             var comment = comments.get(0);</span>
<span class="line-added">415             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-added">416 </span>
<span class="line-added">417             // As well as a fixVersion</span>
<span class="line-added">418             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));</span>
<span class="line-added">419 </span>
<span class="line-added">420             // The issue should be assigned and resolved</span>
<span class="line-added">421             assertEquals(RESOLVED, updatedIssue.state());</span>
<span class="line-added">422             assertEquals(List.of(issueProject.issueTracker().currentUser()), updatedIssue.assignees());</span>
<span class="line-added">423         }</span>
<span class="line-added">424     }</span>
<span class="line-added">425 </span>
<span class="line-added">426     @Test</span>
<span class="line-added">427     void testIssueNoVersion(TestInfo testInfo) throws IOException {</span>
<span class="line-added">428         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">429              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">430             var repo = credentials.getHostedRepository();</span>
<span class="line-added">431             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">432             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-added">433             credentials.commitLock(localRepo);</span>
<span class="line-added">434             localRepo.pushAll(repo.url());</span>
<span class="line-added">435 </span>
<span class="line-added">436             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">437             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">438             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object());</span>
<span class="line-added">439             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">440 </span>
<span class="line-added">441             // Initialize history</span>
<span class="line-added">442             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">443 </span>
<span class="line-added">444             // Create an issue and commit a fix</span>
<span class="line-added">445             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-added">446             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">447             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">448             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">449 </span>
<span class="line-added">450             // The changeset should be reflected in a comment</span>
<span class="line-added">451             var comments = issue.comments();</span>
<span class="line-added">452             assertEquals(1, comments.size());</span>
<span class="line-added">453             var comment = comments.get(0);</span>
<span class="line-added">454             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-added">455 </span>
<span class="line-added">456             // But not in the fixVersion</span>
<span class="line-added">457             assertEquals(Set.of(), fixVersions(issue));</span>
<span class="line-added">458         }</span>
<span class="line-added">459     }</span>
<span class="line-added">460 </span>
<span class="line-added">461     @Test</span>
<span class="line-added">462     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {</span>
<span class="line-added">463         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">464              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">465             var repo = credentials.getHostedRepository();</span>
<span class="line-added">466             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">467             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-added">468             credentials.commitLock(localRepo);</span>
<span class="line-added">469             localRepo.pushAll(repo.url());</span>
<span class="line-added">470 </span>
<span class="line-added">471             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">472             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">473             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;2.0&quot;));</span>
<span class="line-added">474             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">475 </span>
<span class="line-added">476             // Initialize history</span>
<span class="line-added">477             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">478 </span>
<span class="line-added">479             // Create an issue and commit a fix</span>
<span class="line-added">480             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-added">481             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">482             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">483             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">484 </span>
<span class="line-added">485             // The changeset should not reflected in a comment</span>
<span class="line-added">486             var comments = issue.comments();</span>
<span class="line-added">487             assertEquals(1, comments.size());</span>
<span class="line-added">488             var comment = comments.get(0);</span>
<span class="line-added">489             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-added">490 </span>
<span class="line-added">491             // As well as a fixVersion - but not the one from the repo</span>
<span class="line-added">492             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));</span>
<span class="line-added">493 </span>
<span class="line-added">494             // And no commit link</span>
<span class="line-added">495             var links = issue.links();</span>
<span class="line-added">496             assertEquals(0, links.size());</span>
<span class="line-added">497         }</span>
<span class="line-added">498     }</span>
<span class="line-added">499 </span>
<span class="line-added">500     @Test</span>
<span class="line-added">501     void testIssueIdempotence(TestInfo testInfo) throws IOException {</span>
<span class="line-added">502         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">503              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">504             var repo = credentials.getHostedRepository();</span>
<span class="line-added">505             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">506             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-added">507             credentials.commitLock(localRepo);</span>
<span class="line-added">508             localRepo.pushAll(repo.url());</span>
<span class="line-added">509 </span>
<span class="line-added">510             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">511             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">512             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object());</span>
<span class="line-added">513             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">514 </span>
<span class="line-added">515             // Initialize history</span>
<span class="line-added">516             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">517 </span>
<span class="line-added">518             // Save the state</span>
<span class="line-added">519             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);</span>
<span class="line-added">520 </span>
<span class="line-added">521             // Create an issue and commit a fix</span>
<span class="line-added">522             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-added">523             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">524             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">525             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">526 </span>
<span class="line-added">527             // The changeset should be reflected in a comment</span>
<span class="line-added">528             var comments = issue.comments();</span>
<span class="line-added">529             assertEquals(1, comments.size());</span>
<span class="line-added">530             var comment = comments.get(0);</span>
<span class="line-added">531             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-added">532 </span>
<span class="line-added">533             // As well as a fixVersion</span>
<span class="line-added">534             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));</span>
<span class="line-added">535 </span>
<span class="line-added">536             // Wipe the history</span>
<span class="line-added">537             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);</span>
<span class="line-added">538 </span>
<span class="line-added">539             // Run it again</span>
<span class="line-added">540             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">541 </span>
<span class="line-added">542             // There should be no new comments or fixVersions</span>
<span class="line-added">543             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-added">544             assertEquals(1, updatedIssue.comments().size());</span>
<span class="line-added">545             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));</span>
<span class="line-added">546         }</span>
<span class="line-added">547     }</span>
<span class="line-added">548 </span>
<span class="line-added">549     @Test</span>
<span class="line-added">550     void testIssuePoolVersion(TestInfo testInfo) throws IOException {</span>
<span class="line-added">551         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">552              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">553             var repo = credentials.getHostedRepository();</span>
<span class="line-added">554             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">555             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-added">556             credentials.commitLock(localRepo);</span>
<span class="line-added">557             localRepo.pushAll(repo.url());</span>
<span class="line-added">558 </span>
<span class="line-added">559             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">560             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">561             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;12u14&quot;));</span>
<span class="line-added">562             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">563 </span>
<span class="line-added">564             // Initialize history</span>
<span class="line-added">565             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">566 </span>
<span class="line-added">567             // Create an issue and commit a fix</span>
<span class="line-added">568             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-added">569             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));</span>
<span class="line-added">570 </span>
<span class="line-added">571             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">572             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">573             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">574 </span>
<span class="line-added">575             // The fixVersion should have been updated</span>
<span class="line-added">576             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));</span>
<span class="line-added">577         }</span>
<span class="line-added">578     }</span>
<span class="line-added">579 </span>
<span class="line-added">580     @Test</span>
<span class="line-added">581     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {</span>
<span class="line-added">582         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">583              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">584             var repo = credentials.getHostedRepository();</span>
<span class="line-added">585             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">586             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-added">587             credentials.commitLock(localRepo);</span>
<span class="line-added">588             localRepo.pushAll(repo.url());</span>
<span class="line-added">589 </span>
<span class="line-added">590             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">591             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">592             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;12u14&quot;));</span>
<span class="line-added">593             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">594 </span>
<span class="line-added">595             // Initialize history</span>
<span class="line-added">596             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">597 </span>
<span class="line-added">598             // Create an issue and commit a fix</span>
<span class="line-added">599             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-added">600             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));</span>
<span class="line-added">601 </span>
<span class="line-added">602             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">603             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">604             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">605 </span>
<span class="line-added">606             // The fixVersion should have been updated</span>
<span class="line-added">607             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));</span>
<span class="line-added">608         }</span>
<span class="line-added">609     }</span>
<span class="line-added">610 </span>
<span class="line-added">611     @Test</span>
<span class="line-added">612     void testIssueBackport(TestInfo testInfo) throws IOException {</span>
<span class="line-added">613         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">614              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">615             var repo = credentials.getHostedRepository();</span>
<span class="line-added">616             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">617             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-added">618             credentials.commitLock(localRepo);</span>
<span class="line-added">619             localRepo.pushAll(repo.url());</span>
<span class="line-added">620 </span>
<span class="line-added">621             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">622             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">623             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;12.0.2&quot;));</span>
<span class="line-added">624             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">625 </span>
<span class="line-added">626             // Initialize history</span>
<span class="line-added">627             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">628 </span>
<span class="line-added">629             // Create an issue and commit a fix</span>
<span class="line-added">630             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),</span>
<span class="line-added">631                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),</span>
<span class="line-added">632                                                         &quot;customfield_10008&quot;, JSON.object()</span>
<span class="line-added">633                                                                                  .put(&quot;id&quot;, 244)</span>
<span class="line-added">634                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),</span>
<span class="line-added">635                                                         &quot;customfield_10005&quot;, JSON.array()</span>
<span class="line-added">636                                                                                  .add(JSON.object()</span>
<span class="line-added">637                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)</span>
<span class="line-added">638                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))</span>
<span class="line-added">639                                                                                  .add(JSON.object()</span>
<span class="line-added">640                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)</span>
<span class="line-added">641                                                                                           .put(&quot;value&quot;, &quot;other&quot;))</span>
<span class="line-added">642                                                  ));</span>
<span class="line-added">643             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));</span>
<span class="line-added">644             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));</span>
<span class="line-added">645 </span>
<span class="line-added">646             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;</span>
<span class="line-added">647             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);</span>
<span class="line-added">648             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">649             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">650 </span>
<span class="line-added">651             // The fixVersion should not have been updated</span>
<span class="line-added">652             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-added">653             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));</span>
<span class="line-added">654             assertEquals(OPEN, updatedIssue.state());</span>
<span class="line-added">655             assertEquals(List.of(), updatedIssue.assignees());</span>
<span class="line-added">656 </span>
<span class="line-added">657             // There should be a link</span>
<span class="line-added">658             var links = updatedIssue.links();</span>
<span class="line-added">659             assertEquals(1, links.size());</span>
<span class="line-added">660             var link = links.get(0);</span>
<span class="line-added">661             var backport = link.issue().orElseThrow();</span>
<span class="line-added">662 </span>
<span class="line-added">663             // The backport issue should have a correct fixVersion and assignee</span>
<span class="line-added">664             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));</span>
<span class="line-added">665             assertEquals(RESOLVED, backport.state());</span>
<span class="line-added">666             assertEquals(List.of(issueProject.issueTracker().currentUser()), backport.assignees());</span>
<span class="line-added">667 </span>
<span class="line-added">668             // Custom properties should also propagate</span>
<span class="line-added">669             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());</span>
<span class="line-added">670             assertEquals(244, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;id&quot;).asInt());</span>
<span class="line-added">671             assertEquals(&quot;java.io&quot;, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;name&quot;).asString());</span>
<span class="line-added">672             assertEquals(2, backport.properties().get(&quot;customfield_10005&quot;).asArray().size());</span>
<span class="line-added">673         }</span>
<span class="line-added">674     }</span>
<span class="line-added">675 </span>
<span class="line-added">676     @Test</span>
<span class="line-added">677     void testSyncLabels(TestInfo testInfo) throws IOException {</span>
<span class="line-added">678         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">679              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">680             var repo = credentials.getHostedRepository();</span>
<span class="line-added">681             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">682             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-added">683             credentials.commitLock(localRepo);</span>
<span class="line-added">684             localRepo.pushAll(repo.url());</span>
<span class="line-added">685 </span>
<span class="line-added">686             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">687             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">688             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;8u192&quot;));</span>
<span class="line-added">689             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>
<span class="line-added">690 </span>
<span class="line-added">691             // Initialize database</span>
<span class="line-added">692             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">693 </span>
<span class="line-added">694             var issue1 = credentials.createIssue(issueProject, &quot;Issue 1&quot;);</span>
<span class="line-added">695             issue1.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Bug&quot;));</span>
<span class="line-added">696 </span>
<span class="line-added">697             var issue2 = credentials.createIssue(issueProject, &quot;Issue 2&quot;);</span>
<span class="line-added">698             issue2.setProperty(&quot;fixVersions&quot;, JSON.array().add(JSON.of(&quot;8u162&quot;)));</span>
<span class="line-added">699             issue2.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Backport&quot;));</span>
<span class="line-added">700             issue1.addLink(Link.create(issue2, &quot;backported by&quot;).build());</span>
<span class="line-added">701 </span>
<span class="line-added">702             var issue3 = credentials.createIssue(issueProject, &quot;Issue 3&quot;);</span>
<span class="line-added">703             issue3.setProperty(&quot;fixVersions&quot;, JSON.array().add(JSON.of(&quot;10&quot;)));</span>
<span class="line-added">704             issue3.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Backport&quot;));</span>
<span class="line-added">705             issue1.addLink(Link.create(issue3, &quot;backported by&quot;).build());</span>
<span class="line-added">706 </span>
<span class="line-added">707             var issue4 = credentials.createIssue(issueProject, &quot;Issue 4&quot;);</span>
<span class="line-added">708             issue4.setProperty(&quot;fixVersions&quot;, JSON.array().add(JSON.of(&quot;11&quot;)));</span>
<span class="line-added">709             issue4.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Backport&quot;));</span>
<span class="line-added">710             issue1.addLink(Link.create(issue4, &quot;backported by&quot;).build());</span>
<span class="line-added">711 </span>
<span class="line-added">712             // Mention one of the issues</span>
<span class="line-added">713             var commit = CheckableRepository.appendAndCommit(localRepo, &quot;Hello there&quot;, issue1.id() + &quot;: A fix&quot;);</span>
<span class="line-added">714             localRepo.push(commit, repo.url(), &quot;master&quot;);</span>
<span class="line-added">715             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">716 </span>
<span class="line-added">717             assertEquals(List.of(&quot;hgupdater-sync&quot;), issue1.labels());</span>
<span class="line-added">718             assertEquals(List.of(), issue2.labels());</span>
<span class="line-added">719             assertEquals(List.of(), issue3.labels());</span>
<span class="line-added">720             assertEquals(List.of(&quot;hgupdater-sync&quot;), issue4.labels());</span>
<span class="line-added">721         }</span>
<span class="line-added">722     }</span>
723 }
<a name="9" id="anc9"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="9" type="hidden" />
</body>
</html>