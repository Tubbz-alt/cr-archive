<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff cli/src/main/java/org/openjdk/skara/cli/Remote.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../module-info.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>cli/src/main/java/org/openjdk/skara/cli/Remote.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -20,58 +20,70 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package org.openjdk.skara.cli;
  
<span class="udiff-line-removed">- import org.openjdk.skara.ssh.SSHConfig;</span>
<span class="udiff-line-removed">- </span>
  import java.io.IOException;
  import java.net.URI;
  import java.nio.file.Path;
  import java.nio.file.Files;
<span class="udiff-line-added">+ import java.nio.charset.StandardCharsets;</span>
  
  public class Remote {
<span class="udiff-line-modified-removed">-     public static URI toWebURI(String remotePath) throws IOException {</span>
<span class="udiff-line-modified-removed">-         if (remotePath.startsWith(&quot;git+&quot;)) {</span>
<span class="udiff-line-modified-removed">-             remotePath = remotePath.substring(&quot;git+&quot;.length());</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         if (remotePath.endsWith(&quot;.git&quot;)) {</span>
<span class="udiff-line-modified-removed">-             remotePath = remotePath.substring(0, remotePath.length() - &quot;.git&quot;.length());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (remotePath.startsWith(&quot;http&quot;)) {</span>
<span class="udiff-line-removed">-             return URI.create(remotePath);</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             if (remotePath.startsWith(&quot;ssh://&quot;)) {</span>
<span class="udiff-line-removed">-                 remotePath = remotePath.substring(&quot;ssh://&quot;.length()).replaceFirst(&quot;/&quot;, &quot;:&quot;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             var indexOfColon = remotePath.indexOf(&#39;:&#39;);</span>
<span class="udiff-line-removed">-             var indexOfSlash = remotePath.indexOf(&#39;/&#39;);</span>
<span class="udiff-line-removed">-             if (indexOfColon != -1) {</span>
<span class="udiff-line-removed">-                 if (indexOfSlash == -1 || indexOfColon &lt; indexOfSlash) {</span>
<span class="udiff-line-removed">-                     var path = remotePath.contains(&quot;@&quot;) ? remotePath.split(&quot;@&quot;)[1] : remotePath;</span>
<span class="udiff-line-removed">-                     var name = path.split(&quot;:&quot;)[0];</span>
<span class="udiff-line-modified-added">+     private static URI sshCanonicalize(URI uri) throws IOException {</span>
<span class="udiff-line-modified-added">+         var arg = uri.getUserInfo() == null ? uri.getHost() : uri.getUserInfo() + &quot;@&quot; + uri.getHost();</span>
<span class="udiff-line-modified-added">+         var pb = new ProcessBuilder(&quot;ssh&quot;, &quot;-G&quot;, arg);</span>
<span class="udiff-line-modified-added">+         pb.redirectOutput(ProcessBuilder.Redirect.PIPE);</span>
<span class="udiff-line-modified-added">+         pb.redirectError(ProcessBuilder.Redirect.DISCARD);</span>
<span class="udiff-line-modified-added">+         var p = pb.start();</span>
  
<span class="udiff-line-modified-removed">-                     // Could be a Host in the ~/.ssh/config file</span>
<span class="udiff-line-modified-removed">-                     var sshConfig = Path.of(System.getProperty(&quot;user.home&quot;), &quot;.ssh&quot;, &quot;config&quot;);</span>
<span class="udiff-line-modified-removed">-                     if (Files.exists(sshConfig)) {</span>
<span class="udiff-line-modified-removed">-                         for (var host : SSHConfig.parse(sshConfig).hosts()) {</span>
<span class="udiff-line-modified-removed">-                             if (host.name().equals(name)) {</span>
<span class="udiff-line-modified-removed">-                                 var hostName = host.hostName();</span>
<span class="udiff-line-modified-removed">-                                 if (hostName != null) {</span>
<span class="udiff-line-modified-removed">-                                     return URI.create(&quot;https://&quot; + hostName + &quot;/&quot; + path.split(&quot;:&quot;)[1]);</span>
<span class="udiff-line-modified-removed">-                                 }</span>
<span class="udiff-line-removed">-                             }</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-modified-added">+         var output = new String(p.getInputStream().readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             var res = p.waitFor();</span>
<span class="udiff-line-modified-added">+             if (res != 0) {</span>
<span class="udiff-line-modified-added">+                 throw new IOException(&quot;ssh -G &quot; + arg + &quot; exited with non-zero exit code: &quot; + res);</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-modified-added">+         } catch (InterruptedException e) {</span>
<span class="udiff-line-modified-added">+             throw new IOException(e);</span>
<span class="udiff-line-modified-added">+         }</span>
  
<span class="udiff-line-modified-removed">-                     // Otherwise is must be a domain</span>
<span class="udiff-line-modified-removed">-                     return URI.create(&quot;https://&quot; + path.replace(&quot;:&quot;, &quot;/&quot;));</span>
<span class="udiff-line-modified-added">+         String hostname = null;</span>
<span class="udiff-line-modified-added">+         String username = null;</span>
<span class="udiff-line-added">+         for (var line : output.split(&quot;\n&quot;)) {</span>
<span class="udiff-line-added">+             var parts = line.trim().split(&quot; &quot;);</span>
<span class="udiff-line-added">+             if (parts.length == 2) {</span>
<span class="udiff-line-added">+                 var key = parts[0];</span>
<span class="udiff-line-added">+                 var value = parts[1];</span>
<span class="udiff-line-added">+                 if (key.equals(&quot;hostname&quot;)) {</span>
<span class="udiff-line-added">+                     hostname = value;</span>
<span class="udiff-line-added">+                 } else if (key.equals(&quot;user&quot;)) {</span>
<span class="udiff-line-added">+                     username = value;</span>
                  }
              }
          }
  
<span class="udiff-line-modified-removed">-         throw new IOException(&quot;error: cannot find remote repository for &quot; + remotePath);</span>
<span class="udiff-line-modified-added">+         if (hostname == null) {</span>
<span class="udiff-line-added">+             throw new IOException(&quot;ssh -G &quot; + arg + &quot; did not output a hostname&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return username == null ?</span>
<span class="udiff-line-added">+             URI.create(&quot;ssh://&quot; + hostname + uri.getPath()) :</span>
<span class="udiff-line-added">+             URI.create(&quot;ssh://&quot; + username + &quot;@&quot; + hostname + uri.getPath());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static URI toWebURI(String remotePath) throws IOException {</span>
<span class="udiff-line-added">+         var uri = toURI(remotePath);</span>
<span class="udiff-line-added">+         if (uri.getScheme().equals(&quot;file://&quot;)) {</span>
<span class="udiff-line-added">+             throw new IOException(&quot;Cannot create web URI for file path: &quot; + uri.toString());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Use https://, drop eventual .git from path and drop authority</span>
<span class="udiff-line-added">+         var path = uri.getPath();</span>
<span class="udiff-line-added">+         if (path.endsWith(&quot;.git&quot;)) {</span>
<span class="udiff-line-added">+             path = path.substring(0, path.length() - &quot;.git&quot;.length());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return URI.create(&quot;https://&quot; + uri.getHost() + path);</span>
      }
  
      public static URI toURI(String remotePath) throws IOException {
          if (remotePath.startsWith(&quot;git+&quot;)) {
              remotePath = remotePath.substring(&quot;git+&quot;.length());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -86,35 +98,13 @@</span>
  
          var indexOfColon = remotePath.indexOf(&#39;:&#39;);
          var indexOfSlash = remotePath.indexOf(&#39;/&#39;);
          if (indexOfColon != -1) {
              if (indexOfSlash == -1 || indexOfColon &lt; indexOfSlash) {
<span class="udiff-line-modified-removed">-                 var path = remotePath.contains(&quot;@&quot;) ? remotePath.split(&quot;@&quot;)[1] : remotePath;</span>
<span class="udiff-line-modified-removed">-                 var name = path.split(&quot;:&quot;)[0];</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 // Could be a Host in the ~/.ssh/config file</span>
<span class="udiff-line-removed">-                 var sshConfig = Path.of(System.getProperty(&quot;user.home&quot;), &quot;.ssh&quot;, &quot;config&quot;);</span>
<span class="udiff-line-removed">-                 if (Files.exists(sshConfig)) {</span>
<span class="udiff-line-removed">-                     for (var host : SSHConfig.parse(sshConfig).hosts()) {</span>
<span class="udiff-line-removed">-                         if (host.name().equals(name)) {</span>
<span class="udiff-line-removed">-                             var hostName = host.hostName();</span>
<span class="udiff-line-removed">-                             if (hostName != null) {</span>
<span class="udiff-line-removed">-                                 var username = host.user();</span>
<span class="udiff-line-removed">-                                 if (username == null) {</span>
<span class="udiff-line-removed">-                                     username = remotePath.contains(&quot;@&quot;) ? remotePath.split(&quot;@&quot;)[0] : null;</span>
<span class="udiff-line-removed">-                                 }</span>
<span class="udiff-line-removed">-                                 var userPrefix = username == null ? &quot;&quot; : username + &quot;@&quot;;</span>
<span class="udiff-line-removed">-                                 return URI.create(&quot;ssh://&quot; + userPrefix + hostName + &quot;/&quot; + path.split(&quot;:&quot;)[1]);</span>
<span class="udiff-line-removed">-                             }</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 // Otherwise is must be a domain</span>
<span class="udiff-line-removed">-                 var userPrefix = remotePath.contains(&quot;@&quot;) ? remotePath.split(&quot;@&quot;)[0] + &quot;@&quot; : &quot;&quot;;</span>
<span class="udiff-line-removed">-                 return URI.create(&quot;ssh://&quot; + userPrefix + path.replace(&quot;:&quot;, &quot;/&quot;));</span>
<span class="udiff-line-modified-added">+                 var uri = URI.create(&quot;ssh://&quot; + remotePath.replace(&quot;:&quot;, &quot;/&quot;));</span>
<span class="udiff-line-modified-added">+                 return sshCanonicalize(uri);</span>
              }
          }
  
<span class="udiff-line-modified-removed">-         throw new IOException(&quot;error: cannot construct proper URI for &quot; + remotePath);</span>
<span class="udiff-line-modified-added">+         throw new IOException(&quot;Cannot construct URI for &quot; + remotePath);</span>
      }
  }
</pre>
<center><a href="../../../../module-info.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>