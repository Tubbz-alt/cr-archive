<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveItem.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ArchiveMessages.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveItem.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 21     private final Map&lt;String, String&gt; extraHeaders;
 22     private final ArchiveItem parent;
 23     private final Supplier&lt;String&gt; subject;
 24     private final Supplier&lt;String&gt; header;
 25     private final Supplier&lt;String&gt; body;
 26     private final Supplier&lt;String&gt; footer;
 27 
 28     private ArchiveItem(ArchiveItem parent, String id, ZonedDateTime created, ZonedDateTime updated, HostUser author, Map&lt;String, String&gt; extraHeaders, Supplier&lt;String&gt; subject, Supplier&lt;String&gt; header, Supplier&lt;String&gt; body, Supplier&lt;String&gt; footer) {
 29         this.id = id;
 30         this.created = created;
 31         this.updated = updated;
 32         this.author = author;
 33         this.extraHeaders = extraHeaders;
 34         this.parent = parent;
 35         this.subject = subject;
 36         this.header = header;
 37         this.body = body;
 38         this.footer = footer;
 39     }
 40 






















 41     static ArchiveItem from(PullRequest pr, Repository localRepo, HostUserToEmailAuthor hostUserToEmailAuthor,
 42                             URI issueTracker, String issuePrefix, WebrevStorage.WebrevGenerator webrevGenerator,
 43                             WebrevNotification webrevNotification, ZonedDateTime created, ZonedDateTime updated,
 44                             Hash base, Hash head, String subjectPrefix) {
 45         return new ArchiveItem(null, &quot;fc&quot;, created, updated, pr.author(), Map.of(&quot;PR-Head-Hash&quot;, head.hex(), &quot;PR-Base-Hash&quot;, base.hex()),
 46                                () -&gt; subjectPrefix + &quot;RFR: &quot; + pr.title(),
 47                                () -&gt; &quot;&quot;,
 48                                () -&gt; ArchiveMessages.composeConversation(pr, localRepo, base, head),
 49                                () -&gt; {
<span class="line-modified"> 50                                     var fullWebrev = webrevGenerator.generate(base, head, &quot;00&quot;);</span>
<span class="line-modified"> 51                                     webrevNotification.notify(0, fullWebrev, null);</span>
<span class="line-modified"> 52                                     return ArchiveMessages.composeConversationFooter(pr, issueTracker, issuePrefix, localRepo, fullWebrev, base, head);</span>








 53                                });
 54     }
 55 
 56     private static Optional&lt;Hash&gt; rebasedLastHead(Repository localRepo, Hash newBase, Hash lastHead) {
 57         try {
 58             localRepo.checkout(lastHead, true);
 59             localRepo.rebase(newBase, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 60             var rebasedLastHead = localRepo.head();
 61             return Optional.of(rebasedLastHead);
 62         } catch (IOException e) {
 63             return Optional.empty();
 64         }
 65     }
 66 
 67     private static String hostUserToCommitterName(HostUserToEmailAuthor hostUserToEmailAuthor, HostUser hostUser) {
 68         var email = hostUserToEmailAuthor.author(hostUser);
 69         if (email.fullName().isPresent()) {
 70             return email.fullName().get();
 71         } else {
 72             return hostUser.fullName();
</pre>
</td>
<td>
<hr />
<pre>
 21     private final Map&lt;String, String&gt; extraHeaders;
 22     private final ArchiveItem parent;
 23     private final Supplier&lt;String&gt; subject;
 24     private final Supplier&lt;String&gt; header;
 25     private final Supplier&lt;String&gt; body;
 26     private final Supplier&lt;String&gt; footer;
 27 
 28     private ArchiveItem(ArchiveItem parent, String id, ZonedDateTime created, ZonedDateTime updated, HostUser author, Map&lt;String, String&gt; extraHeaders, Supplier&lt;String&gt; subject, Supplier&lt;String&gt; header, Supplier&lt;String&gt; body, Supplier&lt;String&gt; footer) {
 29         this.id = id;
 30         this.created = created;
 31         this.updated = updated;
 32         this.author = author;
 33         this.extraHeaders = extraHeaders;
 34         this.parent = parent;
 35         this.subject = subject;
 36         this.header = header;
 37         this.body = body;
 38         this.footer = footer;
 39     }
 40 
<span class="line-added"> 41     // If the head commit is a merge commit with base as one parent, return the other one (the new content)</span>
<span class="line-added"> 42     private static Optional&lt;Hash&gt; mergeParent(Repository localRepo, Hash base, Hash head) {</span>
<span class="line-added"> 43         try {</span>
<span class="line-added"> 44             var mergeCommit = localRepo.lookup(head);</span>
<span class="line-added"> 45             if (mergeCommit.isEmpty()) {</span>
<span class="line-added"> 46                 return Optional.empty();</span>
<span class="line-added"> 47             }</span>
<span class="line-added"> 48             if (!mergeCommit.get().isMerge()) {</span>
<span class="line-added"> 49                 return Optional.empty();</span>
<span class="line-added"> 50             }</span>
<span class="line-added"> 51             for (var parent : mergeCommit.get().parents()) {</span>
<span class="line-added"> 52                 if (parent.equals(base) || localRepo.isAncestor(parent, base)) {</span>
<span class="line-added"> 53                     continue;</span>
<span class="line-added"> 54                 }</span>
<span class="line-added"> 55                 return Optional.of(parent);</span>
<span class="line-added"> 56             }</span>
<span class="line-added"> 57             return Optional.empty();</span>
<span class="line-added"> 58         } catch (IOException e) {</span>
<span class="line-added"> 59             return Optional.empty();</span>
<span class="line-added"> 60         }</span>
<span class="line-added"> 61     }</span>
<span class="line-added"> 62 </span>
 63     static ArchiveItem from(PullRequest pr, Repository localRepo, HostUserToEmailAuthor hostUserToEmailAuthor,
 64                             URI issueTracker, String issuePrefix, WebrevStorage.WebrevGenerator webrevGenerator,
 65                             WebrevNotification webrevNotification, ZonedDateTime created, ZonedDateTime updated,
 66                             Hash base, Hash head, String subjectPrefix) {
 67         return new ArchiveItem(null, &quot;fc&quot;, created, updated, pr.author(), Map.of(&quot;PR-Head-Hash&quot;, head.hex(), &quot;PR-Base-Hash&quot;, base.hex()),
 68                                () -&gt; subjectPrefix + &quot;RFR: &quot; + pr.title(),
 69                                () -&gt; &quot;&quot;,
 70                                () -&gt; ArchiveMessages.composeConversation(pr, localRepo, base, head),
 71                                () -&gt; {
<span class="line-modified"> 72                                    if (pr.title().startsWith(&quot;Merge&quot;)) {</span>
<span class="line-modified"> 73                                        var mergeCommitParent = mergeParent(localRepo, base, head);</span>
<span class="line-modified"> 74                                         if (mergeCommitParent.isPresent()) {</span>
<span class="line-added"> 75                                             var mergeWebrev = webrevGenerator.generate(mergeCommitParent.get(), head, &quot;00&quot;);</span>
<span class="line-added"> 76                                             webrevNotification.notify(0, mergeWebrev, null);</span>
<span class="line-added"> 77                                             return ArchiveMessages.composeMergeConversationFooter(pr, localRepo, mergeWebrev, base, mergeCommitParent.get(), head);</span>
<span class="line-added"> 78                                         }</span>
<span class="line-added"> 79                                    }</span>
<span class="line-added"> 80                                    var fullWebrev = webrevGenerator.generate(base, head, &quot;00&quot;);</span>
<span class="line-added"> 81                                    webrevNotification.notify(0, fullWebrev, null);</span>
<span class="line-added"> 82                                    return ArchiveMessages.composeConversationFooter(pr, issueTracker, issuePrefix, localRepo, fullWebrev, base, head);</span>
 83                                });
 84     }
 85 
 86     private static Optional&lt;Hash&gt; rebasedLastHead(Repository localRepo, Hash newBase, Hash lastHead) {
 87         try {
 88             localRepo.checkout(lastHead, true);
 89             localRepo.rebase(newBase, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 90             var rebasedLastHead = localRepo.head();
 91             return Optional.of(rebasedLastHead);
 92         } catch (IOException e) {
 93             return Optional.empty();
 94         }
 95     }
 96 
 97     private static String hostUserToCommitterName(HostUserToEmailAuthor hostUserToEmailAuthor, HostUser hostUser) {
 98         var email = hostUserToEmailAuthor.author(hostUser);
 99         if (email.fullName().isPresent()) {
100             return email.fullName().get();
101         } else {
102             return hostUser.fullName();
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ArchiveMessages.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>