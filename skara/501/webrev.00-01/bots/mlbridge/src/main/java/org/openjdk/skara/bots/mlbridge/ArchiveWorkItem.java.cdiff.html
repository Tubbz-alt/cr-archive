<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveWorkItem.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ArchiveMessages.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebrevNotification.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveWorkItem.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 29,18 ***</span>
  import org.openjdk.skara.issuetracker.Comment;
  import org.openjdk.skara.mailinglist.*;
  import org.openjdk.skara.vcs.Repository;
  
  import java.io.*;
<span class="line-removed">- import java.net.URI;</span>
  import java.nio.file.Path;
  import java.time.*;
  import java.util.*;
  import java.util.function.*;
  import java.util.logging.Logger;
  import java.util.regex.Pattern;
<span class="line-modified">! import java.util.stream.*;</span>
  
  class ArchiveWorkItem implements WorkItem {
      private final PullRequest pr;
      private final MailingListBridgeBot bot;
      private final Consumer&lt;RuntimeException&gt; exceptionConsumer;
<span class="line-new-header">--- 29,17 ---</span>
  import org.openjdk.skara.issuetracker.Comment;
  import org.openjdk.skara.mailinglist.*;
  import org.openjdk.skara.vcs.Repository;
  
  import java.io.*;
  import java.nio.file.Path;
  import java.time.*;
  import java.util.*;
  import java.util.function.*;
  import java.util.logging.Logger;
  import java.util.regex.Pattern;
<span class="line-modified">! import java.util.stream.Collectors;</span>
  
  class ArchiveWorkItem implements WorkItem {
      private final PullRequest pr;
      private final MailingListBridgeBot bot;
      private final Consumer&lt;RuntimeException&gt; exceptionConsumer;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 129,28 ***</span>
  
      private static final String webrevCommentMarker = &quot;&lt;!-- mlbridge webrev comment --&gt;&quot;;
      private static final String webrevHeaderMarker = &quot;&lt;!-- mlbridge webrev header --&gt;&quot;;
      private static final String webrevListMarker = &quot;&lt;!-- mlbridge webrev list --&gt;&quot;;
  
<span class="line-modified">!     private void updateWebrevComment(List&lt;Comment&gt; comments, int index, URI fullWebrev, URI incWebrev) {</span>
          var existing = comments.stream()
                                 .filter(comment -&gt; comment.author().equals(pr.repository().forge().currentUser()))
                                 .filter(comment -&gt; comment.body().contains(webrevCommentMarker))
                                 .findAny();
          var comment = webrevCommentMarker + &quot;\n&quot;;
          comment += webrevHeaderMarker + &quot;\n&quot;;
          comment += &quot;### Webrevs&quot; + &quot;\n&quot;;
          comment += webrevListMarker + &quot;\n&quot;;
<span class="line-modified">!         comment += &quot; * &quot; + String.format(&quot;%02d&quot;, index) + &quot;: [Full](&quot; + fullWebrev.toString() + &quot;)&quot;;</span>
<span class="line-removed">-         if (incWebrev != null) {</span>
<span class="line-removed">-             comment += &quot; - [Incremental](&quot; + incWebrev.toString() + &quot;)&quot;;</span>
<span class="line-removed">-         }</span>
          comment += &quot; (&quot; + pr.headHash() + &quot;)\n&quot;;
  
          if (existing.isPresent()) {
<span class="line-modified">!             if (existing.get().body().contains(fullWebrev.toString())) {</span>
<span class="line-modified">!                 log.fine(&quot;Webrev link already posted - skipping update&quot;);</span>
                  return;
              }
              var previousListStart = existing.get().body().indexOf(webrevListMarker) + webrevListMarker.length() + 1;
              var previousList = existing.get().body().substring(previousListStart);
              comment += previousList;
<span class="line-new-header">--- 128,28 ---</span>
  
      private static final String webrevCommentMarker = &quot;&lt;!-- mlbridge webrev comment --&gt;&quot;;
      private static final String webrevHeaderMarker = &quot;&lt;!-- mlbridge webrev header --&gt;&quot;;
      private static final String webrevListMarker = &quot;&lt;!-- mlbridge webrev list --&gt;&quot;;
  
<span class="line-modified">!     private void updateWebrevComment(List&lt;Comment&gt; comments, int index, List&lt;WebrevDescription&gt; webrevs) {</span>
          var existing = comments.stream()
                                 .filter(comment -&gt; comment.author().equals(pr.repository().forge().currentUser()))
                                 .filter(comment -&gt; comment.body().contains(webrevCommentMarker))
                                 .findAny();
<span class="line-added">+         var webrevDescriptions = webrevs.stream()</span>
<span class="line-added">+                                         .map(d -&gt; String.format(&quot;[%s](%s)&quot;, d.label(), d.uri()))</span>
<span class="line-added">+                                         .collect(Collectors.joining(&quot; - &quot;));</span>
          var comment = webrevCommentMarker + &quot;\n&quot;;
          comment += webrevHeaderMarker + &quot;\n&quot;;
          comment += &quot;### Webrevs&quot; + &quot;\n&quot;;
          comment += webrevListMarker + &quot;\n&quot;;
<span class="line-modified">!         comment += &quot; * &quot; + String.format(&quot;%02d&quot;, index) + &quot;: &quot; + webrevDescriptions;</span>
          comment += &quot; (&quot; + pr.headHash() + &quot;)\n&quot;;
  
          if (existing.isPresent()) {
<span class="line-modified">!             if (existing.get().body().contains(webrevDescriptions)) {</span>
<span class="line-modified">!                 log.fine(&quot;Webrev links already posted - skipping update&quot;);</span>
                  return;
              }
              var previousListStart = existing.get().body().indexOf(webrevListMarker) + webrevListMarker.length() + 1;
              var previousList = existing.get().body().substring(previousListStart);
              comment += previousList;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 326,11 ***</span>
                  archiver.addReviewComment(reviewComment);
              }
  
              var webrevGenerator = bot.webrevStorage().generator(pr, localRepo, webrevPath);
              var newMails = archiver.generateNewEmails(sentMails, bot.cooldown(), localRepo, bot.issueTracker(), jbs.toUpperCase(), webrevGenerator,
<span class="line-modified">!                                                       (index, full, inc) -&gt; updateWebrevComment(comments, index, full, inc),</span>
                                                        user -&gt; getAuthorAddress(census, user),
                                                        user -&gt; getAuthorUserName(census, user),
                                                        user -&gt; getAuthorRole(census, user),
                                                        subjectPrefix(),
                                                        retryConsumer
<span class="line-new-header">--- 325,11 ---</span>
                  archiver.addReviewComment(reviewComment);
              }
  
              var webrevGenerator = bot.webrevStorage().generator(pr, localRepo, webrevPath);
              var newMails = archiver.generateNewEmails(sentMails, bot.cooldown(), localRepo, bot.issueTracker(), jbs.toUpperCase(), webrevGenerator,
<span class="line-modified">!                                                       (index, webrevs) -&gt; updateWebrevComment(comments, index, webrevs),</span>
                                                        user -&gt; getAuthorAddress(census, user),
                                                        user -&gt; getAuthorUserName(census, user),
                                                        user -&gt; getAuthorRole(census, user),
                                                        subjectPrefix(),
                                                        retryConsumer
</pre>
<center><a href="ArchiveMessages.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebrevNotification.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>