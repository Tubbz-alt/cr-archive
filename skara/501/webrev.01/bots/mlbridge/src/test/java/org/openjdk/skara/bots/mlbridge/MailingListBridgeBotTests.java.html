<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.*;
  38 import java.util.*;
  39 import java.util.logging.Logger;
  40 import java.util.regex.Pattern;
  41 import java.util.stream.Collectors;
  42 
  43 import static org.junit.jupiter.api.Assertions.*;
  44 
  45 class MailingListBridgeBotTests {
  46     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  47 
  48     private Optional&lt;String&gt; archiveContents(Path archive) {
  49         try {
  50             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  51             if (mbox.isEmpty()) {
  52                 return Optional.empty();
  53             }
  54             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  55         } catch (IOException e) {
  56             return Optional.empty();
  57         }
  58 
  59     }
  60 
  61     private boolean archiveContains(Path archive, String text) {
  62         return archiveContainsCount(archive, text) &gt; 0;
  63     }
  64 
  65     private int archiveContainsCount(Path archive, String text) {
  66         var lines = archiveContents(archive);
  67         if (lines.isEmpty()) {
  68             return 0;
  69         }
  70         var pattern = Pattern.compile(text);
  71         int count = 0;
  72         for (var line : lines.get().split(&quot;\\R&quot;)) {
  73             var matcher = pattern.matcher(line);
  74             if (matcher.find()) {
  75                 count++;
  76             }
  77         }
  78         return count;
  79     }
  80 
  81     private boolean webrevContains(Path webrev, String text) {
  82         try {
  83             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  84             if (index.isEmpty()) {
  85                 return false;
  86             }
  87             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  88             return lines.contains(text);
  89         } catch (IOException e) {
  90             return false;
  91         }
  92     }
  93 
  94     private long countSubstrings(String string, String substring) {
  95         return Pattern.compile(substring).matcher(string).results().count();
  96     }
  97 
  98     private String noreplyAddress(HostedRepository repository) {
  99         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
 100                 repository.forge().currentUser().userName() +
 101                 &quot;@openjdk.java.net&quot;;
 102     }
 103 
 104     @Test
 105     void simpleArchive(TestInfo testInfo) throws IOException {
 106         try (var credentials = new HostCredentials(testInfo);
 107              var tempFolder = new TemporaryDirectory();
 108              var archiveFolder = new TemporaryDirectory();
 109              var webrevFolder = new TemporaryDirectory();
 110              var listServer = new TestMailmanServer();
 111              var webrevServer = new TestWebrevServer()) {
 112             var author = credentials.getHostedRepository();
 113             var archive = credentials.getHostedRepository();
 114             var ignored = credentials.getHostedRepository();
 115             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 116             var censusBuilder = credentials.getCensusBuilder()
 117                                            .addAuthor(author.forge().currentUser().id());
 118             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 119             var mlBot = MailingListBridgeBot.newBuilder()
 120                                             .from(from)
 121                                             .repo(author)
 122                                             .archive(archive)
 123                                             .censusRepo(censusBuilder.build())
 124                                             .list(listAddress)
 125                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 126                                             .ignoredComments(Set.of())
 127                                             .listArchive(listServer.getArchive())
 128                                             .smtpServer(listServer.getSMTP())
 129                                             .webrevStorageRepository(archive)
 130                                             .webrevStorageRef(&quot;webrev&quot;)
 131                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 132                                             .webrevStorageBaseUri(webrevServer.uri())
 133                                             .readyLabels(Set.of(&quot;rfr&quot;))
 134                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 135                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 136                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 137                                             .sendInterval(Duration.ZERO)
 138                                             .build();
 139 
 140             // Populate the projects repository
 141             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 142             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 143             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 144             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 145 
 146             // Make a change with a corresponding PR
 147             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 148                                                                &quot;Change msg\n\nWith several lines&quot;);
 149             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 150             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 151             pr.setBody(&quot;This should not be ready&quot;);
 152 
 153             // Run an archive pass
 154             TestBotRunner.runPeriodicItems(mlBot);
 155 
 156             // A PR that isn&#39;t ready for review should not be archived
 157             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 158             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 159 
 160             // Flag it as ready for review
 161             pr.setBody(&quot;This should now be ready&quot;);
 162             pr.addLabel(&quot;rfr&quot;);
 163 
 164             // Run another archive pass
 165             TestBotRunner.runPeriodicItems(mlBot);
 166 
 167             // But it should still not be archived
 168             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 169             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 170 
 171             // Now post a general comment - not a ready marker
 172             var ignoredPr = ignored.pullRequest(pr.id());
 173             ignoredPr.addComment(&quot;hello there&quot;);
 174 
 175             // Run another archive pass
 176             TestBotRunner.runPeriodicItems(mlBot);
 177 
 178             // It should still not be archived
 179             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 180             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 181 
 182             // Now post a ready comment
 183             ignoredPr.addComment(&quot;ready&quot;);
 184 
 185             // Run another archive pass
 186             TestBotRunner.runPeriodicItems(mlBot);
 187 
 188             // The archive should now contain an entry
 189             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 190             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 196             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 197             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 198             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));
 201             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 202 
 203             // The mailing list as well
 204             listServer.processIncoming();
 205             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 206             var mailmanList = mailmanServer.getList(listAddress.address());
 207             var conversations = mailmanList.conversations(Duration.ofDays(1));
 208             assertEquals(1, conversations.size());
 209             var mail = conversations.get(0).first();
 210             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 211             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 212             assertEquals(noreplyAddress(archive), mail.author().address());
 213             assertEquals(listAddress, mail.sender());
 214             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 215             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 216 
 217             // And there should be a webrev
 218             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 219             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 220             var comments = pr.comments();
 221             var webrevComments = comments.stream()
 222                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 223                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 224                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 225                                          .collect(Collectors.toList());
 226             assertEquals(1, webrevComments.size());
 227 
 228             // Add a comment
 229             pr.addComment(&quot;This is a comment :smile:&quot;);
 230 
 231             // Add a comment from an ignored user as well
 232             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 233 
 234             // Run another archive pass
 235             TestBotRunner.runPeriodicItems(mlBot);
 236 
 237             // The archive should now contain the comment, but not the ignored one
 238             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 239             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 240             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 241             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 242 
 243             listServer.processIncoming();
 244             conversations = mailmanList.conversations(Duration.ofDays(1));
 245             assertEquals(1, conversations.size());
 246             assertEquals(2, conversations.get(0).allMessages().size());
 247 
 248             // Remove the rfr flag and post another comment
 249             pr.addLabel(&quot;rfr&quot;);
 250             pr.addComment(&quot;This is another comment&quot;);
 251 
 252             // Run another archive pass
 253             TestBotRunner.runPeriodicItems(mlBot);
 254 
 255             // The archive should contain the additional comment
 256             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 257             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 258             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 259 
 260             listServer.processIncoming();
 261             conversations = mailmanList.conversations(Duration.ofDays(1));
 262             assertEquals(1, conversations.size());
 263             assertEquals(3, conversations.get(0).allMessages().size());
 264             for (var newMail : conversations.get(0).allMessages()) {
 265                 assertEquals(noreplyAddress(archive), newMail.author().address());
 266                 assertEquals(listAddress, newMail.sender());
 267             }
 268             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment 😄&quot;));
 269         }
 270     }
 271 
 272     @Test
 273     void reviewComment(TestInfo testInfo) throws IOException {
 274         try (var credentials = new HostCredentials(testInfo);
 275              var tempFolder = new TemporaryDirectory();
 276              var archiveFolder = new TemporaryDirectory();
 277              var listServer = new TestMailmanServer();
 278              var webrevServer = new TestWebrevServer()) {
 279             var author = credentials.getHostedRepository();
 280             var archive = credentials.getHostedRepository();
 281             var ignored = credentials.getHostedRepository();
 282             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 283             var censusBuilder = credentials.getCensusBuilder()
 284                                            .addAuthor(author.forge().currentUser().id());
 285             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 286             var mlBot = MailingListBridgeBot.newBuilder()
 287                                             .from(from)
 288                                             .repo(author)
 289                                             .archive(archive)
 290                                             .censusRepo(censusBuilder.build())
 291                                             .list(listAddress)
 292                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 293                                             .listArchive(listServer.getArchive())
 294                                             .smtpServer(listServer.getSMTP())
 295                                             .webrevStorageRepository(archive)
 296                                             .webrevStorageRef(&quot;webrev&quot;)
 297                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 298                                             .webrevStorageBaseUri(webrevServer.uri())
 299                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 300                                             .build();
 301 
 302             // Populate the projects repository
 303             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 304             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 305             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 306             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 307             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 308 
 309             // Make a change with a corresponding PR
 310             var editHash = CheckableRepository.appendAndCommit(localRepo);
 311             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 312             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 313             pr.setBody(&quot;This is now ready&quot;);
 314             TestBotRunner.runPeriodicItems(mlBot);
 315             listServer.processIncoming();
 316 
 317             // And make a file specific comment
 318             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 319             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 320 
 321             // Add one from an ignored user as well
 322             var ignoredPr = ignored.pullRequest(pr.id());
 323             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 324 
 325             // Process comments
 326             TestBotRunner.runPeriodicItems(mlBot);
 327             listServer.processIncoming();
 328 
 329             // The archive should now contain an entry
 330             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 331             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 332             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 333             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 334             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 335             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 336             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 337 
 338             // The mailing list as well
 339             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 340             var mailmanList = mailmanServer.getList(listAddress.address());
 341             var conversations = mailmanList.conversations(Duration.ofDays(1));
 342             assertEquals(1, conversations.size());
 343             var mail = conversations.get(0).first();
 344             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 345 
 346             // Comment on the comment
 347             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 348             TestBotRunner.runPeriodicItems(mlBot);
 349             listServer.processIncoming();
 350 
 351             // The archive should contain the additional comment (but no quoted footers)
 352             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 353             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 354             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 355             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 356 
 357             // As well as the mailing list
 358             conversations = mailmanList.conversations(Duration.ofDays(1));
 359             assertEquals(1, conversations.size());
 360             assertEquals(3, conversations.get(0).allMessages().size());
 361             for (var newMail : conversations.get(0).allMessages()) {
 362                 assertEquals(noreplyAddress(archive), newMail.author().address());
 363                 assertEquals(listAddress, newMail.sender());
 364             }
 365         }
 366     }
 367 
 368     @Test
 369     void combineComments(TestInfo testInfo) throws IOException {
 370         try (var credentials = new HostCredentials(testInfo);
 371              var tempFolder = new TemporaryDirectory();
 372              var archiveFolder = new TemporaryDirectory();
 373              var listServer = new TestMailmanServer();
 374              var webrevServer = new TestWebrevServer()) {
 375             var author = credentials.getHostedRepository();
 376             var archive = credentials.getHostedRepository();
 377             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 378             var censusBuilder = credentials.getCensusBuilder()
 379                                            .addAuthor(author.forge().currentUser().id());
 380             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 381             var mlBot = MailingListBridgeBot.newBuilder()
 382                                             .from(from)
 383                                             .repo(author)
 384                                             .archive(archive)
 385                                             .censusRepo(censusBuilder.build())
 386                                             .list(listAddress)
 387                                             .listArchive(listServer.getArchive())
 388                                             .smtpServer(listServer.getSMTP())
 389                                             .webrevStorageRepository(archive)
 390                                             .webrevStorageRef(&quot;webrev&quot;)
 391                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 392                                             .webrevStorageBaseUri(webrevServer.uri())
 393                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 394                                             .build();
 395 
 396             // Populate the projects repository
 397             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 398             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 399             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 400             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 401             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 402 
 403             // Make a change with a corresponding PR
 404             var editHash = CheckableRepository.appendAndCommit(localRepo);
 405             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 406             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 407             pr.setBody(&quot;This is now ready&quot;);
 408             pr.addComment(&quot;Avoid combining&quot;);
 409 
 410             TestBotRunner.runPeriodicItems(mlBot);
 411             listServer.processIncoming();
 412             listServer.processIncoming();
 413 
 414             // Make several file specific comments
 415             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 416             var second = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 417             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 418             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 419             TestBotRunner.runPeriodicItems(mlBot);
 420             listServer.processIncoming();
 421 
 422             // The archive should contain a combined entry
 423             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 424             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 425 
 426             // As well as the mailing list
 427             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 428             var mailmanList = mailmanServer.getList(listAddress.address());
 429             var conversations = mailmanList.conversations(Duration.ofDays(1));
 430             assertEquals(1, conversations.size());
 431             var mail = conversations.get(0).first();
 432             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 433             assertEquals(3, conversations.get(0).allMessages().size());
 434 
 435             var commentReply = conversations.get(0).replies(mail).get(0);
 436             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 437             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 438 
 439             var reviewReply = conversations.get(0).replies(mail).get(1);
 440             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 441             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 442             assertEquals(&quot;RFR: This is a pull request&quot;, reviewReply.subject());
 443             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 444             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 445 
 446             // Now reply to the first and second (collapsed) comment
 447             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 448             pr.addReviewCommentReply(second, &quot;Not with this one though&quot;);
 449             TestBotRunner.runPeriodicItems(mlBot);
 450             listServer.processIncoming();
 451 
 452             // The archive should contain a new entry
 453             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 454             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 455 
 456             // The combined review comments should only appear unquoted once
 457             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 458         }
 459     }
 460 
 461     @Test
 462     void commentThreading(TestInfo testInfo) throws IOException {
 463         try (var credentials = new HostCredentials(testInfo);
 464              var tempFolder = new TemporaryDirectory();
 465              var archiveFolder = new TemporaryDirectory();
 466              var listServer = new TestMailmanServer();
 467              var webrevServer = new TestWebrevServer()) {
 468             var author = credentials.getHostedRepository();
 469             var reviewer = credentials.getHostedRepository();
 470             var archive = credentials.getHostedRepository();
 471             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 472             var censusBuilder = credentials.getCensusBuilder()
 473                                            .addReviewer(reviewer.forge().currentUser().id())
 474                                            .addAuthor(author.forge().currentUser().id());
 475             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 476             var mlBot = MailingListBridgeBot.newBuilder()
 477                                             .from(from)
 478                                             .repo(author)
 479                                             .archive(archive)
 480                                             .censusRepo(censusBuilder.build())
 481                                             .list(listAddress)
 482                                             .listArchive(listServer.getArchive())
 483                                             .smtpServer(listServer.getSMTP())
 484                                             .webrevStorageRepository(archive)
 485                                             .webrevStorageRef(&quot;webrev&quot;)
 486                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 487                                             .webrevStorageBaseUri(webrevServer.uri())
 488                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 489                                             .build();
 490 
 491             // Populate the projects repository
 492             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 493             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 494             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 495             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 496             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 497 
 498             // Make a change with a corresponding PR
 499             var editHash = CheckableRepository.appendAndCommit(localRepo);
 500             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 501             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 502             pr.setBody(&quot;This is now ready&quot;);
 503             TestBotRunner.runPeriodicItems(mlBot);
 504             listServer.processIncoming();
 505 
 506             // Make a file specific comment
 507             var reviewPr = reviewer.pullRequest(pr.id());
 508             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 509             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 510             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 511             TestBotRunner.runPeriodicItems(mlBot);
 512             listServer.processIncoming();
 513             listServer.processIncoming();
 514             listServer.processIncoming();
 515 
 516             // And a second one by ourselves
 517             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 518             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 519             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 520             TestBotRunner.runPeriodicItems(mlBot);
 521             listServer.processIncoming();
 522             listServer.processIncoming();
 523             listServer.processIncoming();
 524 
 525             // Finally some approvals and another comment
 526             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 527             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 528             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 529             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 530             TestBotRunner.runPeriodicItems(mlBot);
 531             listServer.processIncoming();
 532             listServer.processIncoming();
 533             listServer.processIncoming();
 534 
 535             // Sanity check the archive
 536             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 537             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 538 
 539             // File specific comments should appear after the approval
 540             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 541             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 542 
 543             // Check the mailing list
 544             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 545             var mailmanList = mailmanServer.getList(listAddress.address());
 546             var conversations = mailmanList.conversations(Duration.ofDays(1));
 547             assertEquals(1, conversations.size());
 548             var mail = conversations.get(0).first();
 549             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 550             assertEquals(10, conversations.get(0).allMessages().size());
 551 
 552             // There should be four separate threads
 553             var thread1 = conversations.get(0).replies(mail).get(0);
 554             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 555             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 556             assertEquals(&quot;RFR: This is a pull request&quot;, thread1.subject());
 557             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 558             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 559             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 560             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 561             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 562             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
 563             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 564             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 565             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 566             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 567 
 568             var thread2 = conversations.get(0).replies(mail).get(1);
 569             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 570             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 571             assertEquals(&quot;RFR: This is a pull request&quot;, thread2.subject());
 572             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 573             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 574             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 575             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 576             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 577             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 578 
 579             var replies = conversations.get(0).replies(mail);
 580             var thread3 = replies.get(2);
 581             assertEquals(&quot;RFR: This is a pull request&quot;, thread3.subject());
 582             var thread4 = replies.get(3);
 583             assertEquals(&quot;RFR: This is a pull request&quot;, thread4.subject());
 584             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 585             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 586             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 587         }
 588     }
 589 
 590     @Test
 591     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 592         try (var credentials = new HostCredentials(testInfo);
 593              var tempFolder = new TemporaryDirectory();
 594              var archiveFolder = new TemporaryDirectory();
 595              var listServer = new TestMailmanServer();
 596              var webrevServer = new TestWebrevServer()) {
 597             var author = credentials.getHostedRepository();
 598             var reviewer = credentials.getHostedRepository();
 599             var archive = credentials.getHostedRepository();
 600             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 601             var censusBuilder = credentials.getCensusBuilder()
 602                                            .addReviewer(reviewer.forge().currentUser().id())
 603                                            .addAuthor(author.forge().currentUser().id());
 604             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 605             var mlBot = MailingListBridgeBot.newBuilder()
 606                                             .from(from)
 607                                             .repo(author)
 608                                             .archive(archive)
 609                                             .censusRepo(censusBuilder.build())
 610                                             .list(listAddress)
 611                                             .listArchive(listServer.getArchive())
 612                                             .smtpServer(listServer.getSMTP())
 613                                             .webrevStorageRepository(archive)
 614                                             .webrevStorageRef(&quot;webrev&quot;)
 615                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 616                                             .webrevStorageBaseUri(webrevServer.uri())
 617                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 618                                             .build();
 619 
 620             // Populate the projects repository
 621             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 622             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 623             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 624             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 625             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 626 
 627             // Make a change with a corresponding PR
 628             var editHash = CheckableRepository.appendAndCommit(localRepo);
 629             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 630             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 631             pr.setBody(&quot;This is now ready&quot;);
 632             TestBotRunner.runPeriodicItems(mlBot);
 633             listServer.processIncoming();
 634 
 635             // Make two file specific comments
 636             var reviewPr = reviewer.pullRequest(pr.id());
 637             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 638             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 639             TestBotRunner.runPeriodicItems(mlBot);
 640             listServer.processIncoming();
 641 
 642             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 643             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
 644             TestBotRunner.runPeriodicItems(mlBot);
 645             listServer.processIncoming();
 646 
 647             // Sanity check the archive
 648             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 649             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 650         }
 651     }
 652 
 653     @Test
 654     void commentWithMention(TestInfo testInfo) throws IOException {
 655         try (var credentials = new HostCredentials(testInfo);
 656              var tempFolder = new TemporaryDirectory();
 657              var archiveFolder = new TemporaryDirectory();
 658              var listServer = new TestMailmanServer();
 659              var webrevServer = new TestWebrevServer()) {
 660             var author = credentials.getHostedRepository();
 661             var reviewer = credentials.getHostedRepository();
 662             var archive = credentials.getHostedRepository();
 663             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 664             var censusBuilder = credentials.getCensusBuilder()
 665                                            .addReviewer(reviewer.forge().currentUser().id())
 666                                            .addAuthor(author.forge().currentUser().id());
 667             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 668             var mlBot = MailingListBridgeBot.newBuilder()
 669                                             .from(from)
 670                                             .repo(author)
 671                                             .archive(archive)
 672                                             .censusRepo(censusBuilder.build())
 673                                             .list(listAddress)
 674                                             .listArchive(listServer.getArchive())
 675                                             .smtpServer(listServer.getSMTP())
 676                                             .webrevStorageRepository(archive)
 677                                             .webrevStorageRef(&quot;webrev&quot;)
 678                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 679                                             .webrevStorageBaseUri(webrevServer.uri())
 680                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 681                                             .build();
 682 
 683             // Populate the projects repository
 684             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 685             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 686             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 687             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 688             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 689 
 690             // Make a change with a corresponding PR
 691             var editHash = CheckableRepository.appendAndCommit(localRepo);
 692             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 693             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 694             pr.setBody(&quot;This is now ready&quot;);
 695             TestBotRunner.runPeriodicItems(mlBot);
 696             listServer.processIncoming();
 697 
 698             // Make two comments from different authors
 699             var reviewPr = reviewer.pullRequest(pr.id());
 700             reviewPr.addComment(&quot;First comment&quot;);
 701             pr.addComment(&quot;Second comment&quot;);
 702 
 703             TestBotRunner.runPeriodicItems(mlBot);
 704             listServer.processIncoming();
 705 
 706             pr.addComment(&quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
 707             TestBotRunner.runPeriodicItems(mlBot);
 708             listServer.processIncoming();
 709 
 710             // The first comment should be quoted more often than the second
 711             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 712             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
 713             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
 714         }
 715     }
 716 
 717     @Test
 718     void reviewCommentWithMention(TestInfo testInfo) throws IOException {
 719         try (var credentials = new HostCredentials(testInfo);
 720              var tempFolder = new TemporaryDirectory();
 721              var archiveFolder = new TemporaryDirectory();
 722              var listServer = new TestMailmanServer();
 723              var webrevServer = new TestWebrevServer()) {
 724             var author = credentials.getHostedRepository();
 725             var reviewer = credentials.getHostedRepository();
 726             var archive = credentials.getHostedRepository();
 727             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 728             var censusBuilder = credentials.getCensusBuilder()
 729                                            .addReviewer(reviewer.forge().currentUser().id())
 730                                            .addAuthor(author.forge().currentUser().id());
 731             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 732             var mlBot = MailingListBridgeBot.newBuilder()
 733                                             .from(from)
 734                                             .repo(author)
 735                                             .archive(archive)
 736                                             .censusRepo(censusBuilder.build())
 737                                             .list(listAddress)
 738                                             .listArchive(listServer.getArchive())
 739                                             .smtpServer(listServer.getSMTP())
 740                                             .webrevStorageRepository(archive)
 741                                             .webrevStorageRef(&quot;webrev&quot;)
 742                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 743                                             .webrevStorageBaseUri(webrevServer.uri())
 744                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 745                                             .build();
 746 
 747             // Populate the projects repository
 748             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 749             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 750             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 751             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 752             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 753 
 754             // Make a change with a corresponding PR
 755             var editHash = CheckableRepository.appendAndCommit(localRepo);
 756             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 757             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 758             pr.setBody(&quot;This is now ready&quot;);
 759             TestBotRunner.runPeriodicItems(mlBot);
 760             listServer.processIncoming();
 761 
 762             // Make two review comments from different authors
 763             var reviewPr = reviewer.pullRequest(pr.id());
 764             var comment = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 765             reviewPr.addReviewCommentReply(comment, &quot;First review comment&quot;);
 766             pr.addReviewCommentReply(comment, &quot;Second review comment&quot;);
 767 
 768             TestBotRunner.runPeriodicItems(mlBot);
 769             listServer.processIncoming();
 770 
 771             pr.addReviewCommentReply(comment, &quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
 772             TestBotRunner.runPeriodicItems(mlBot);
 773             listServer.processIncoming();
 774 
 775             // The first comment should be quoted more often than the second
 776             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 777             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First review comment&quot;));
 778             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second review comment&quot;));
 779         }
 780     }
 781 
 782     @Test
 783     void commentWithQuote(TestInfo testInfo) throws IOException {
 784         try (var credentials = new HostCredentials(testInfo);
 785              var tempFolder = new TemporaryDirectory();
 786              var archiveFolder = new TemporaryDirectory();
 787              var listServer = new TestMailmanServer();
 788              var webrevServer = new TestWebrevServer()) {
 789             var author = credentials.getHostedRepository();
 790             var reviewer = credentials.getHostedRepository();
 791             var archive = credentials.getHostedRepository();
 792             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 793             var censusBuilder = credentials.getCensusBuilder()
 794                                            .addReviewer(reviewer.forge().currentUser().id())
 795                                            .addAuthor(author.forge().currentUser().id());
 796             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 797             var mlBot = MailingListBridgeBot.newBuilder()
 798                                             .from(from)
 799                                             .repo(author)
 800                                             .archive(archive)
 801                                             .censusRepo(censusBuilder.build())
 802                                             .list(listAddress)
 803                                             .listArchive(listServer.getArchive())
 804                                             .smtpServer(listServer.getSMTP())
 805                                             .webrevStorageRepository(archive)
 806                                             .webrevStorageRef(&quot;webrev&quot;)
 807                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 808                                             .webrevStorageBaseUri(webrevServer.uri())
 809                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 810                                             .build();
 811 
 812             // Populate the projects repository
 813             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 814             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 815             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 816             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 817             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 818 
 819             // Make a change with a corresponding PR
 820             var editHash = CheckableRepository.appendAndCommit(localRepo);
 821             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 822             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 823             pr.setBody(&quot;This is now ready&quot;);
 824             TestBotRunner.runPeriodicItems(mlBot);
 825             listServer.processIncoming();
 826 
 827             // Make two comments from different authors
 828             var reviewPr = reviewer.pullRequest(pr.id());
 829             reviewPr.addComment(&quot;First comment\nsecond line&quot;);
 830             pr.addComment(&quot;Second comment\nfourth line&quot;);
 831 
 832             TestBotRunner.runPeriodicItems(mlBot);
 833             listServer.processIncoming();
 834 
 835             pr.addComment(&quot;&gt;First comm\n\nreply to first&quot;);
 836             TestBotRunner.runPeriodicItems(mlBot);
 837             listServer.processIncoming();
 838 
 839             // The first comment should be quoted more often than the second
 840             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 841             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
 842             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comm&quot;));
 843             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
 844         }
 845     }
 846 
 847     @Test
 848     void reviewContext(TestInfo testInfo) throws IOException {
 849         try (var credentials = new HostCredentials(testInfo);
 850              var tempFolder = new TemporaryDirectory();
 851              var archiveFolder = new TemporaryDirectory();
 852              var listServer = new TestMailmanServer();
 853              var webrevServer = new TestWebrevServer()) {
 854             var author = credentials.getHostedRepository();
 855             var archive = credentials.getHostedRepository();
 856             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 857             var censusBuilder = credentials.getCensusBuilder()
 858                                            .addAuthor(author.forge().currentUser().id());
 859             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 860             var mlBot = MailingListBridgeBot.newBuilder()
 861                                             .from(from)
 862                                             .repo(author)
 863                                             .archive(archive)
 864                                             .censusRepo(censusBuilder.build())
 865                                             .list(listAddress)
 866                                             .listArchive(listServer.getArchive())
 867                                             .smtpServer(listServer.getSMTP())
 868                                             .webrevStorageRepository(archive)
 869                                             .webrevStorageRef(&quot;webrev&quot;)
 870                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 871                                             .webrevStorageBaseUri(webrevServer.uri())
 872                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 873                                             .build();
 874 
 875             // Populate the projects repository
 876             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 877             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 878             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 879             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 880             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 881 
 882             // Make a change with a corresponding PR
 883             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 884             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 885             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 886             pr.setBody(&quot;This is now ready&quot;);
 887             TestBotRunner.runPeriodicItems(mlBot);
 888             listServer.processIncoming();
 889 
 890             // Make a file specific comment
 891             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 892 
 893             TestBotRunner.runPeriodicItems(mlBot);
 894             listServer.processIncoming();
 895 
 896             // The archive should only contain context around line 2
 897             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 898             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 899             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 900             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 901         }
 902     }
 903 
 904     @Test
 905     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 906         try (var credentials = new HostCredentials(testInfo);
 907              var tempFolder = new TemporaryDirectory();
 908              var archiveFolder = new TemporaryDirectory();
 909              var listServer = new TestMailmanServer();
 910              var webrevServer = new TestWebrevServer()) {
 911             var author = credentials.getHostedRepository();
 912             var archive = credentials.getHostedRepository();
 913             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 914             var censusBuilder = credentials.getCensusBuilder()
 915                                            .addAuthor(author.forge().currentUser().id());
 916             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 917             var mlBot = MailingListBridgeBot.newBuilder()
 918                                             .from(from)
 919                                             .repo(author)
 920                                             .archive(archive)
 921                                             .censusRepo(censusBuilder.build())
 922                                             .list(listAddress)
 923                                             .listArchive(listServer.getArchive())
 924                                             .smtpServer(listServer.getSMTP())
 925                                             .webrevStorageRepository(archive)
 926                                             .webrevStorageRef(&quot;webrev&quot;)
 927                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 928                                             .webrevStorageBaseUri(webrevServer.uri())
 929                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 930                                             .build();
 931 
 932             // Populate the projects repository
 933             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 934             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 935             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 936             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 937             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 938             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 939                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 940                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 941                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 942                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 943                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 944                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 945             localRepo.push(initialHash, author.url(), &quot;master&quot;);
 946 
 947             // Make a change with a corresponding PR
 948             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 949             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 950             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 951             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 952             var editHash = CheckableRepository.appendAndCommit(localRepo);
 953             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 954             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 955             pr.setBody(&quot;This is now ready&quot;);
 956             TestBotRunner.runPeriodicItems(mlBot);
 957             listServer.processIncoming();
 958 
 959             // Make file specific comments
 960             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 961             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 962 
 963             TestBotRunner.runPeriodicItems(mlBot);
 964             listServer.processIncoming();
 965 
 966             // The archive should only contain context around line 2 and 20
 967             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 968             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 969             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 970             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 971             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 972 
 973             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 974             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 975             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 976             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 977         }
 978     }
 979 
 980     @Test
 981     void filterComments(TestInfo testInfo) throws IOException {
 982         try (var credentials = new HostCredentials(testInfo);
 983              var tempFolder = new TemporaryDirectory();
 984              var archiveFolder = new TemporaryDirectory();
 985              var listServer = new TestMailmanServer();
 986              var webrevServer = new TestWebrevServer()) {
 987             var author = credentials.getHostedRepository();
 988             var archive = credentials.getHostedRepository();
 989             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 990             var censusBuilder = credentials.getCensusBuilder()
 991                                            .addAuthor(author.forge().currentUser().id());
 992             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 993             var mlBot = MailingListBridgeBot.newBuilder()
 994                                             .from(from)
 995                                             .repo(author)
 996                                             .archive(archive)
 997                                             .censusRepo(censusBuilder.build())
 998                                             .list(listAddress)
 999                                             .listArchive(listServer.getArchive())
1000                                             .smtpServer(listServer.getSMTP())
1001                                             .webrevStorageRepository(archive)
1002                                             .webrevStorageRef(&quot;webrev&quot;)
1003                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1004                                             .webrevStorageBaseUri(webrevServer.uri())
1005                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1006                                             .build();
1007 
1008             // Populate the projects repository
1009             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1010             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1011             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1012             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1013             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1014 
1015             // Make a change with a corresponding PR
1016             var editHash = CheckableRepository.appendAndCommit(localRepo);
1017             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1018             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1019             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
1020                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
1021 
1022             // Make a bunch of comments
1023             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
1024             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
1025             pr.addComment(&quot;/integrate stuff&quot;);
1026             TestBotRunner.runPeriodicItems(mlBot);
1027 
1028             // Run an archive pass
1029             TestBotRunner.runPeriodicItems(mlBot);
1030 
1031             // The archive should not contain the comment
1032             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1033             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1034             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
1035             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
1036             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
1037             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
1038             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
1039             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
1040             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
1041             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
1042         }
1043     }
1044 
1045     @Test
1046     void incrementalChanges(TestInfo testInfo) throws IOException {
1047         try (var credentials = new HostCredentials(testInfo);
1048              var tempFolder = new TemporaryDirectory();
1049              var archiveFolder = new TemporaryDirectory();
1050              var listServer = new TestMailmanServer();
1051              var webrevServer = new TestWebrevServer()) {
1052             var author = credentials.getHostedRepository();
1053             var archive = credentials.getHostedRepository();
1054             var commenter = credentials.getHostedRepository();
1055             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1056             var censusBuilder = credentials.getCensusBuilder()
1057                                            .addAuthor(author.forge().currentUser().id());
1058             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1059             var mlBot = MailingListBridgeBot.newBuilder()
1060                                             .from(from)
1061                                             .repo(author)
1062                                             .archive(archive)
1063                                             .censusRepo(censusBuilder.build())
1064                                             .list(listAddress)
1065                                             .listArchive(listServer.getArchive())
1066                                             .smtpServer(listServer.getSMTP())
1067                                             .webrevStorageRepository(archive)
1068                                             .webrevStorageRef(&quot;webrev&quot;)
1069                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1070                                             .webrevStorageBaseUri(webrevServer.uri())
1071                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1072                                             .build();
1073 
1074             // Populate the projects repository
1075             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1076             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1077             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1078             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1079             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1080 
1081             // Make a change with a corresponding PR
1082             var editHash = CheckableRepository.appendAndCommit(localRepo);
1083             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1084             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1085             pr.setBody(&quot;This is now ready&quot;);
1086 
1087             // Run an archive pass
1088             TestBotRunner.runPeriodicItems(mlBot);
1089             listServer.processIncoming();
1090 
1091             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
1092             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
1093 
1094             // Make sure that the push registered
1095             var lastHeadHash = pr.headHash();
1096             var refreshCount = 0;
1097             do {
1098                 pr = author.pullRequest(pr.id());
1099                 if (refreshCount++ &gt; 100) {
1100                     fail(&quot;The PR did not update after the new push&quot;);
1101                 }
1102             } while (pr.headHash().equals(lastHeadHash));
1103 
1104             // Run another archive pass
1105             TestBotRunner.runPeriodicItems(mlBot);
1106             TestBotRunner.runPeriodicItems(mlBot);
1107             TestBotRunner.runPeriodicItems(mlBot);
1108             listServer.processIncoming();
1109 
1110             // The archive should reference the updated push
1111             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1112             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request incrementally&quot;));
1113             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
1114             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
1115             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1116             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1117             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
1118 
1119             // The webrev comment should be updated
1120             var comments = pr.comments();
1121             var webrevComments = comments.stream()
1122                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1123                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1124                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
1125                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
1126                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
1127                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1128                                          .collect(Collectors.toList());
1129             assertEquals(1, webrevComments.size());
1130 
1131             // Check that sender address is set properly
1132             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1133             var mailmanList = mailmanServer.getList(listAddress.address());
1134             var conversations = mailmanList.conversations(Duration.ofDays(1));
1135             assertEquals(1, conversations.size());
1136             for (var newMail : conversations.get(0).allMessages()) {
1137                 assertEquals(noreplyAddress(archive), newMail.author().address());
1138                 assertEquals(listAddress, newMail.sender());
1139             }
1140 
1141             // Add a comment
1142             var commenterPr = commenter.pullRequest(pr.id());
1143             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1144             TestBotRunner.runPeriodicItems(mlBot);
1145             listServer.processIncoming();
1146 
1147             // Ensure that additional updates are only reported once
1148             for (int i = 0; i &lt; 3; ++i) {
1149                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
1150                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
1151 
1152                 // Make sure that the push registered
1153                 lastHeadHash = pr.headHash();
1154                 refreshCount = 0;
1155                 do {
1156                     pr = author.pullRequest(pr.id());
1157                     if (refreshCount++ &gt; 100) {
1158                         fail(&quot;The PR did not update after the new push&quot;);
1159                     }
1160                 } while (pr.headHash().equals(lastHeadHash));
1161 
1162                 TestBotRunner.runPeriodicItems(mlBot);
1163                 TestBotRunner.runPeriodicItems(mlBot);
1164                 listServer.processIncoming();
1165             }
1166             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
1167             assertEquals(1, updatedConversations.size());
1168             var conversation = updatedConversations.get(0);
1169             assertEquals(6, conversation.allMessages().size());
1170             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
1171             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
1172             assertEquals(&quot;[Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
1173         }
1174     }
1175 
1176     @Test
1177     void rebased(TestInfo testInfo) throws IOException {
1178         try (var credentials = new HostCredentials(testInfo);
1179              var tempFolder = new TemporaryDirectory();
1180              var archiveFolder = new TemporaryDirectory();
1181              var listServer = new TestMailmanServer();
1182              var webrevServer = new TestWebrevServer()) {
1183             var author = credentials.getHostedRepository();
1184             var archive = credentials.getHostedRepository();
1185             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1186             var censusBuilder = credentials.getCensusBuilder()
1187                                            .addAuthor(author.forge().currentUser().id());
1188             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1189             var mlBot = MailingListBridgeBot.newBuilder()
1190                                             .from(sender)
1191                                             .repo(author)
1192                                             .archive(archive)
1193                                             .censusRepo(censusBuilder.build())
1194                                             .list(listAddress)
1195                                             .listArchive(listServer.getArchive())
1196                                             .smtpServer(listServer.getSMTP())
1197                                             .webrevStorageRepository(archive)
1198                                             .webrevStorageRef(&quot;webrev&quot;)
1199                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1200                                             .webrevStorageBaseUri(webrevServer.uri())
1201                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1202                                             .build();
1203 
1204             // Populate the projects repository
1205             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1206             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1207             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1208             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1209             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1210 
1211             // Make a change with a corresponding PR
1212             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1213             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1214             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1215             pr.setBody(&quot;This is now ready&quot;);
1216 
1217             // Run an archive pass
1218             TestBotRunner.runPeriodicItems(mlBot);
1219             listServer.processIncoming();
1220 
1221             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1222             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1223             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1224 
1225             // Make sure that the push registered
1226             var lastHeadHash = pr.headHash();
1227             var refreshCount = 0;
1228             do {
1229                 pr = author.pullRequest(pr.id());
1230                 if (refreshCount++ &gt; 100) {
1231                     fail(&quot;The PR did not update after the new push&quot;);
1232                 }
1233             } while (pr.headHash().equals(lastHeadHash));
1234 
1235             // Run another archive pass
1236             TestBotRunner.runPeriodicItems(mlBot);
1237             listServer.processIncoming();
1238 
1239             // The archive should reference the rebased push
1240             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1241             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1242             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1243             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1244             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1245             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1246             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1247             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1248 
1249             // The webrev comment should be updated
1250             var comments = pr.comments();
1251             var webrevComments = comments.stream()
1252                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1253                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1254                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1255                                          .collect(Collectors.toList());
1256             assertEquals(1, webrevComments.size());
1257 
1258             // Check that sender address is set properly
1259             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1260             var mailmanList = mailmanServer.getList(listAddress.address());
1261             var conversations = mailmanList.conversations(Duration.ofDays(1));
1262             assertEquals(1, conversations.size());
1263             for (var newMail : conversations.get(0).allMessages()) {
1264                 assertEquals(noreplyAddress(archive), newMail.author().address());
1265                 assertEquals(listAddress, newMail.sender());
1266                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1267             }
1268             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1269         }
1270     }
1271 
1272     @Test
1273     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1274         try (var credentials = new HostCredentials(testInfo);
1275              var tempFolder = new TemporaryDirectory();
1276              var archiveFolder = new TemporaryDirectory();
1277              var listServer = new TestMailmanServer();
1278              var webrevServer = new TestWebrevServer()) {
1279             var author = credentials.getHostedRepository();
1280             var archive = credentials.getHostedRepository();
1281             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1282             var censusBuilder = credentials.getCensusBuilder()
1283                                            .addAuthor(author.forge().currentUser().id());
1284             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1285             var mlBot = MailingListBridgeBot.newBuilder()
1286                                             .from(sender)
1287                                             .repo(author)
1288                                             .archive(archive)
1289                                             .archiveRef(&quot;archive&quot;)
1290                                             .censusRepo(censusBuilder.build())
1291                                             .list(listAddress)
1292                                             .listArchive(listServer.getArchive())
1293                                             .smtpServer(listServer.getSMTP())
1294                                             .webrevStorageRepository(archive)
1295                                             .webrevStorageRef(&quot;webrev&quot;)
1296                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1297                                             .webrevStorageBaseUri(webrevServer.uri())
1298                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1299                                             .build();
1300 
1301             // Populate the projects repository
1302             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1303             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1304             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1305             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1306             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1307             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1308 
1309             // Make a change with a corresponding PR
1310             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1311             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1312             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1313             pr.setBody(&quot;This is now ready&quot;);
1314 
1315             // Run an archive pass
1316             TestBotRunner.runPeriodicItems(mlBot);
1317             listServer.processIncoming();
1318 
1319             // Push more stuff to master
1320             localRepo.checkout(masterHash, true);
1321             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1322             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1323             localRepo.add(unrelatedFile);
1324             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1325             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1326 
1327             // And more stuff to the pr branch
1328             localRepo.checkout(editHash, true);
1329             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1330 
1331             // Merge master
1332             localRepo.merge(newMasterHash);
1333             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1334             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1335 
1336             // Make sure that the push registered
1337             var lastHeadHash = pr.headHash();
1338             var refreshCount = 0;
1339             do {
1340                 pr = author.pullRequest(pr.id());
1341                 if (refreshCount++ &gt; 100) {
1342                     fail(&quot;The PR did not update after the new push&quot;);
1343                 }
1344             } while (pr.headHash().equals(lastHeadHash));
1345 
1346             // Run another archive pass
1347             TestBotRunner.runPeriodicItems(mlBot);
1348             listServer.processIncoming();
1349 
1350             // The archive should reference the rebased push
1351             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1352             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1353             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes&quot;));
1354             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1355             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1356             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1357             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1358         }
1359     }
1360 
1361     @Test
1362     void mergeWebrev(TestInfo testInfo) throws IOException {
1363         try (var credentials = new HostCredentials(testInfo);
1364              var tempFolder = new TemporaryDirectory();
1365              var archiveFolder = new TemporaryDirectory();
1366              var listServer = new TestMailmanServer();
1367              var webrevServer = new TestWebrevServer()) {
1368             var author = credentials.getHostedRepository();
1369             var archive = credentials.getHostedRepository();
1370             var commenter = credentials.getHostedRepository();
1371             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1372             var censusBuilder = credentials.getCensusBuilder()
1373                                            .addAuthor(author.forge().currentUser().id());
1374             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1375             var mlBot = MailingListBridgeBot.newBuilder()
1376                                             .from(from)
1377                                             .repo(author)
1378                                             .archive(archive)
1379                                             .archiveRef(&quot;archive&quot;)
1380                                             .censusRepo(censusBuilder.build())
1381                                             .list(listAddress)
1382                                             .listArchive(listServer.getArchive())
1383                                             .smtpServer(listServer.getSMTP())
1384                                             .webrevStorageRepository(archive)
1385                                             .webrevStorageRef(&quot;webrev&quot;)
1386                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1387                                             .webrevStorageBaseUri(webrevServer.uri())
1388                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1389                                             .build();
1390 
1391             // Populate the projects repository
1392             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1393             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1394             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1395             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1396             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1397             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1398 
1399             // Create a merge
1400             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1401             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1402             localRepo.add(editOnlyFile);
1403             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1404             localRepo.checkout(masterHash, true);
1405             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1406             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1407             localRepo.add(masterOnlyFile);
1408             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1409             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1410             localRepo.merge(editHash, &quot;ours&quot;);
1411             var mergeCommit = localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1412             var mergeOnlyFile = Path.of(&quot;mergeonly.txt&quot;);
1413             Files.writeString(localRepo.root().resolve(mergeOnlyFile), &quot;Only added in the merge&quot;);
1414             localRepo.add(mergeOnlyFile);
1415             Files.writeString(localRepo.root().resolve(reviewFile), &quot;Overwriting the conflict resolution&quot;);
1416             localRepo.add(reviewFile);
1417             var appendedCommit = localRepo.amend(&quot;Updated merge commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1418             localRepo.push(appendedCommit, author.url(), &quot;edit&quot;, true);
1419 
1420             // Make a merge PR
1421             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1422             pr.setBody(&quot;This is now ready&quot;);
1423 
1424             // Run an archive pass
1425             TestBotRunner.runPeriodicItems(mlBot);
1426             listServer.processIncoming();
1427 
1428             // The archive should contain a merge style webrev
1429             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1430             assertTrue(archiveContains(archiveFolder.path(), &quot;webrevs contain only the adjustments&quot;));
1431             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.0&quot;));
1432             assertTrue(archiveContains(archiveFolder.path(), &quot;3 lines in 2 files changed: 1 ins; 1 del; 1 mod&quot;));
1433 
1434             // The PR should contain a webrev comment
1435             assertEquals(1, pr.comments().size());
1436             var webrevComment = pr.comments().get(0);
1437             assertTrue(webrevComment.body().contains(&quot;Merge target&quot;));
1438             assertTrue(webrevComment.body().contains(&quot;Merge source&quot;));
1439         }
1440     }
1441 
1442     @Test
1443     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1444         try (var credentials = new HostCredentials(testInfo);
1445              var tempFolder = new TemporaryDirectory();
1446              var archiveFolder = new TemporaryDirectory();
1447              var webrevFolder = new TemporaryDirectory();
1448              var listServer = new TestMailmanServer();
1449              var webrevServer = new TestWebrevServer()) {
1450             var author = credentials.getHostedRepository();
1451             var archive = credentials.getHostedRepository();
1452             var ignored = credentials.getHostedRepository();
1453             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1454             var censusBuilder = credentials.getCensusBuilder()
1455                                            .addAuthor(author.forge().currentUser().id());
1456             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1457             var mlBot = MailingListBridgeBot.newBuilder()
1458                                             .from(from)
1459                                             .repo(author)
1460                                             .archive(archive)
1461                                             .censusRepo(censusBuilder.build())
1462                                             .list(listAddress)
1463                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1464                                             .listArchive(listServer.getArchive())
1465                                             .smtpServer(listServer.getSMTP())
1466                                             .webrevStorageRepository(archive)
1467                                             .webrevStorageRef(&quot;webrev&quot;)
1468                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1469                                             .webrevStorageBaseUri(webrevServer.uri())
1470                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1471                                             .build();
1472 
1473             // Populate the projects repository
1474             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1475             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1476             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1477             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1478 
1479             // Make a change with a corresponding PR
1480             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1481                                                                &quot;Change msg\n\nWith several lines&quot;);
1482             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1483             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1484 
1485             // Flag it as ready for review
1486             pr.setBody(&quot;This should now be ready&quot;);
1487 
1488             // Run an archive pass
1489             TestBotRunner.runPeriodicItems(mlBot);
1490 
1491             // The archive should now contain an entry
1492             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1493             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
1494 
1495             // And there should be a webrev comment
1496             var comments = pr.comments();
1497             var webrevComments = comments.stream()
1498                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1499                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1500                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1501                                          .collect(Collectors.toList());
1502             assertEquals(1, webrevComments.size());
1503             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1504 
1505             // Pretend the archive didn&#39;t work out
1506             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
1507 
1508             // Run another archive pass
1509             TestBotRunner.runPeriodicItems(mlBot);
1510 
1511             // The webrev comment should not contain duplicate entries
1512             comments = pr.comments();
1513             webrevComments = comments.stream()
1514                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1515                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1516                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
1517                                      .collect(Collectors.toList());
1518             assertEquals(1, webrevComments.size());
1519             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1520         }
1521     }
1522 
1523     @Test
1524     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1525         try (var credentials = new HostCredentials(testInfo);
1526              var tempFolder = new TemporaryDirectory();
1527              var archiveFolder = new TemporaryDirectory();
1528              var listServer = new TestMailmanServer();
1529              var webrevServer = new TestWebrevServer()) {
1530             var author = credentials.getHostedRepository();
1531             var archive = credentials.getHostedRepository();
1532             var reviewer = credentials.getHostedRepository();
1533             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1534             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1535             var censusBuilder = credentials.getCensusBuilder()
1536                                            .addReviewer(reviewer.forge().currentUser().id())
1537                                            .addAuthor(author.forge().currentUser().id());
1538             var mlBot = MailingListBridgeBot.newBuilder()
1539                                             .from(from)
1540                                             .repo(author)
1541                                             .archive(archive)
1542                                             .censusRepo(censusBuilder.build())
1543                                             .list(listAddress)
1544                                             .listArchive(listServer.getArchive())
1545                                             .smtpServer(listServer.getSMTP())
1546                                             .webrevStorageRepository(archive)
1547                                             .webrevStorageRef(&quot;webrev&quot;)
1548                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1549                                             .webrevStorageBaseUri(webrevServer.uri())
1550                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1551                                             .build();
1552 
1553             // Populate the projects repository
1554             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1555             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1556             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1557             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1558             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1559 
1560             // Make a change with a corresponding PR
1561             var editHash = CheckableRepository.appendAndCommit(localRepo);
1562             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1563             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1564             pr.setBody(&quot;This is now ready&quot;);
1565 
1566             // Run an archive pass
1567             TestBotRunner.runPeriodicItems(mlBot);
1568 
1569             // First unapprove it
1570             var reviewedPr = reviewer.pullRequest(pr.id());
1571             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1572             TestBotRunner.runPeriodicItems(mlBot);
1573             TestBotRunner.runPeriodicItems(mlBot);
1574             TestBotRunner.runPeriodicItems(mlBot);
1575 
1576             // The archive should contain a note
1577             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1578             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1579             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1580             if (author.forge().supportsReviewBody()) {
1581                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1582             }
1583 
1584             // Then approve it
1585             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1586             TestBotRunner.runPeriodicItems(mlBot);
1587             TestBotRunner.runPeriodicItems(mlBot);
1588             TestBotRunner.runPeriodicItems(mlBot);
1589 
1590             // The archive should contain another note
1591             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1592             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
1593             if (author.forge().supportsReviewBody()) {
1594                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1595             }
1596             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
1597 
1598             // Yet another change
1599             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1600             TestBotRunner.runPeriodicItems(mlBot);
1601             TestBotRunner.runPeriodicItems(mlBot);
1602             TestBotRunner.runPeriodicItems(mlBot);
1603 
1604             // The archive should contain another note
1605             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1606             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1607             if (author.forge().supportsReviewBody()) {
1608                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1609             }
1610         }
1611     }
1612 
1613     @Test
1614     void ignoreComments(TestInfo testInfo) throws IOException {
1615         try (var credentials = new HostCredentials(testInfo);
1616              var tempFolder = new TemporaryDirectory();
1617              var archiveFolder = new TemporaryDirectory();
1618              var listServer = new TestMailmanServer();
1619              var webrevServer = new TestWebrevServer()) {
1620             var author = credentials.getHostedRepository();
1621             var ignored = credentials.getHostedRepository();
1622             var archive = credentials.getHostedRepository();
1623             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1624             var censusBuilder = credentials.getCensusBuilder()
1625                                            .addAuthor(author.forge().currentUser().id());
1626             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1627             var mlBot = MailingListBridgeBot.newBuilder()
1628                                             .from(from)
1629                                             .repo(author)
1630                                             .archive(archive)
1631                                             .censusRepo(censusBuilder.build())
1632                                             .list(listAddress)
1633                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1634                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
1635                                             .listArchive(listServer.getArchive())
1636                                             .smtpServer(listServer.getSMTP())
1637                                             .webrevStorageRepository(archive)
1638                                             .webrevStorageRef(&quot;webrev&quot;)
1639                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1640                                             .webrevStorageBaseUri(webrevServer.uri())
1641                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1642                                             .build();
1643 
1644             // Populate the projects repository
1645             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1646             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1647             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1648             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1649             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1650 
1651             // Make a change with a corresponding PR
1652             var editHash = CheckableRepository.appendAndCommit(localRepo);
1653             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1654             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1655             pr.setBody(&quot;This is now ready&quot;);
1656 
1657             // Make a bunch of comments
1658             pr.addComment(&quot;Plain comment&quot;);
1659             pr.addComment(&quot;ignore this comment&quot;);
1660             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1661             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1662 
1663             var ignoredPR = ignored.pullRequest(pr.id());
1664             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1665 
1666             TestBotRunner.runPeriodicItems(mlBot);
1667             TestBotRunner.runPeriodicItems(mlBot);
1668 
1669             // The archive should not contain the ignored comments
1670             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1671             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1672             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1673             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1674             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1675             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1676         }
1677     }
1678 
1679     @Test
1680     void replyToEmptyReview(TestInfo testInfo) throws IOException {
1681         try (var credentials = new HostCredentials(testInfo);
1682              var tempFolder = new TemporaryDirectory();
1683              var archiveFolder = new TemporaryDirectory();
1684              var listServer = new TestMailmanServer();
1685              var webrevServer = new TestWebrevServer()) {
1686             var author = credentials.getHostedRepository();
1687             var reviewer = credentials.getHostedRepository();
1688             var archive = credentials.getHostedRepository();
1689             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1690             var censusBuilder = credentials.getCensusBuilder()
1691                                            .addReviewer(reviewer.forge().currentUser().id())
1692                                            .addAuthor(author.forge().currentUser().id());
1693             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1694             var mlBot = MailingListBridgeBot.newBuilder()
1695                                             .from(from)
1696                                             .repo(author)
1697                                             .archive(archive)
1698                                             .censusRepo(censusBuilder.build())
1699                                             .list(listAddress)
1700                                             .listArchive(listServer.getArchive())
1701                                             .smtpServer(listServer.getSMTP())
1702                                             .webrevStorageRepository(archive)
1703                                             .webrevStorageRef(&quot;webrev&quot;)
1704                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1705                                             .webrevStorageBaseUri(webrevServer.uri())
1706                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1707                                             .build();
1708 
1709             // Populate the projects repository
1710             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1711             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1712             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1713             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1714             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1715 
1716             // Make a change with a corresponding PR
1717             var editHash = CheckableRepository.appendAndCommit(localRepo);
1718             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1719             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1720             pr.setBody(&quot;This is now ready&quot;);
1721             TestBotRunner.runPeriodicItems(mlBot);
1722             listServer.processIncoming();
1723 
1724             // Make an empty approval
1725             var reviewPr = reviewer.pullRequest(pr.id());
1726             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
1727             TestBotRunner.runPeriodicItems(mlBot);
1728             listServer.processIncoming();
1729 
1730             pr.addComment(&quot;Thanks for the review!&quot;);
1731             TestBotRunner.runPeriodicItems(mlBot);
1732             listServer.processIncoming();
1733 
1734             // The approval text should be included in the quote
1735             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1736             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
1737         }
1738     }
1739 
1740     @Test
1741     void cooldown(TestInfo testInfo) throws IOException {
1742         try (var credentials = new HostCredentials(testInfo);
1743              var tempFolder = new TemporaryDirectory();
1744              var archiveFolder = new TemporaryDirectory();
1745              var listServer = new TestMailmanServer();
1746              var webrevServer = new TestWebrevServer()) {
1747             var bot = credentials.getHostedRepository();
1748             var author = credentials.getHostedRepository();
1749             var archive = credentials.getHostedRepository();
1750             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1751             var censusBuilder = credentials.getCensusBuilder()
1752                                            .addAuthor(author.forge().currentUser().id());
1753             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1754             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1755                                                    .from(from)
1756                                                    .repo(bot)
1757                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1758                                                    .archive(archive)
1759                                                    .censusRepo(censusBuilder.build())
1760                                                    .list(listAddress)
1761                                                    .listArchive(listServer.getArchive())
1762                                                    .smtpServer(listServer.getSMTP())
1763                                                    .webrevStorageRepository(archive)
1764                                                    .webrevStorageRef(&quot;webrev&quot;)
1765                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1766                                                    .webrevStorageBaseUri(webrevServer.uri())
1767                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1768 
1769             // Populate the projects repository
1770             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1771             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1772             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1773             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1774             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1775 
1776             // Make a change with a corresponding PR
1777             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1778             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1779             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1780             pr.setBody(&quot;This is now ready&quot;);
1781 
1782             var mlBot = mlBotBuilder.build();
1783             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
1784 
1785             TestBotRunner.runPeriodicItems(mlBot);
1786             listServer.processIncoming();
1787 
1788             // Make a comment
1789             pr.addComment(&quot;Looks good&quot;);
1790 
1791             // Bot with cooldown configured should not bridge the comment
1792             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
1793             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1794 
1795             // But without, it should
1796             TestBotRunner.runPeriodicItems(mlBot);
1797             listServer.processIncoming();
1798 
1799             // Check the archive
1800             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1801             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));
1802         }
1803     }
1804 
1805     @Test
1806     void cooldownNewRevision(TestInfo testInfo) throws IOException {
1807         try (var credentials = new HostCredentials(testInfo);
1808              var tempFolder = new TemporaryDirectory();
1809              var archiveFolder = new TemporaryDirectory();
1810              var listServer = new TestMailmanServer();
1811              var webrevServer = new TestWebrevServer()) {
1812             var bot = credentials.getHostedRepository();
1813             var author = credentials.getHostedRepository();
1814             var archive = credentials.getHostedRepository();
1815             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1816             var censusBuilder = credentials.getCensusBuilder()
1817                                            .addAuthor(author.forge().currentUser().id());
1818             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1819             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1820                                                    .from(from)
1821                                                    .repo(bot)
1822                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1823                                                    .archive(archive)
1824                                                    .censusRepo(censusBuilder.build())
1825                                                    .list(listAddress)
1826                                                    .listArchive(listServer.getArchive())
1827                                                    .smtpServer(listServer.getSMTP())
1828                                                    .webrevStorageRepository(archive)
1829                                                    .webrevStorageRef(&quot;webrev&quot;)
1830                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1831                                                    .webrevStorageBaseUri(webrevServer.uri())
1832                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1833 
1834             // Populate the projects repository
1835             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1836             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1837             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1838             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1839             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1840 
1841             // Make a change with a corresponding PR
1842             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1843             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1844             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1845             pr.setBody(&quot;This is now ready&quot;);
1846 
1847             var mlBot = mlBotBuilder.build();
1848             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
1849 
1850             TestBotRunner.runPeriodicItems(mlBot);
1851             listServer.processIncoming();
1852 
1853             // Commit another revision
1854             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
1855             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
1856 
1857             // Bot with cooldown configured should not create a new webrev
1858             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
1859             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1860 
1861             // But without, it should
1862             TestBotRunner.runPeriodicItems(mlBot);
1863             listServer.processIncoming();
1864 
1865             // Check the archive
1866             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1867             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.01&quot;));
1868         }
1869     }
1870 
1871     @Test
1872     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
1873         try (var credentials = new HostCredentials(testInfo);
1874              var tempFolder = new TemporaryDirectory();
1875              var archiveFolder = new TemporaryDirectory();
1876              var listServer = new TestMailmanServer();
1877              var webrevServer = new TestWebrevServer()) {
1878             var bot = credentials.getHostedRepository();
1879             var author = credentials.getHostedRepository();
1880             var archive = credentials.getHostedRepository();
1881             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1882             var censusBuilder = credentials.getCensusBuilder()
1883                                            .addAuthor(author.forge().currentUser().id());
1884             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1885             var cooldown = Duration.ofMillis(500);
1886             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1887                                                    .from(from)
1888                                                    .repo(bot)
1889                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1890                                                    .archive(archive)
1891                                                    .censusRepo(censusBuilder.build())
1892                                                    .list(listAddress)
1893                                                    .listArchive(listServer.getArchive())
1894                                                    .smtpServer(listServer.getSMTP())
1895                                                    .webrevStorageRepository(archive)
1896                                                    .webrevStorageRef(&quot;webrev&quot;)
1897                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1898                                                    .webrevStorageBaseUri(webrevServer.uri())
1899                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1900 
1901             // Populate the projects repository
1902             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1903             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1904             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1905             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1906             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1907 
1908             // Make a change with a corresponding PR
1909             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1910             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1911             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1912             pr.setBody(&quot;This is now ready&quot;);
1913 
1914             var mlBot = mlBotBuilder.cooldown(cooldown).build();
1915             Thread.sleep(cooldown.toMillis());
1916             TestBotRunner.runPeriodicItems(mlBot);
1917             listServer.processIncoming();
1918 
1919             // Make a comment and run the check within the cooldown period
1920             int counter;
1921             boolean noMailReceived = false;
1922             for (counter = 1; counter &lt; 10; ++counter) {
1923                 var start = Instant.now();
1924                 pr.addComment(&quot;Looks good - &quot; + counter + &quot; -&quot;);
1925 
1926                 // The bot should not bridge the comment due to cooldown
1927                 TestBotRunner.runPeriodicItems(mlBot);
1928                 try {
1929                     noMailReceived = false;
1930                     listServer.processIncoming(Duration.ofMillis(1));
1931                 } catch (RuntimeException e) {
1932                     noMailReceived = true;
1933                 }
1934                 var elapsed = Duration.between(start, Instant.now());
1935                 if (elapsed.compareTo(cooldown) &lt; 0) {
1936                     break;
1937                 } else {
1938                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
1939                     // Ensure that the cooldown expires
1940                     Thread.sleep(cooldown.toMillis());
1941                     // If no mail was received, we have to flush it out
1942                     if (noMailReceived) {
1943                         TestBotRunner.runPeriodicItems(mlBot);
1944                         listServer.processIncoming();
1945                     }
1946                     cooldown = cooldown.multipliedBy(2);
1947                     mlBot = mlBotBuilder.cooldown(cooldown).build();
1948                 }
1949             }
1950             assertTrue(noMailReceived);
1951 
1952             // But after the cooldown period has passed, it should
1953             Thread.sleep(cooldown.toMillis());
1954             TestBotRunner.runPeriodicItems(mlBot);
1955             listServer.processIncoming();
1956 
1957             // Check the archive
1958             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1959             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good - &quot; + counter + &quot; -&quot;));
1960         }
1961     }
1962 
1963     @Test
1964     void branchPrefix(TestInfo testInfo) throws IOException {
1965         try (var credentials = new HostCredentials(testInfo);
1966              var tempFolder = new TemporaryDirectory();
1967              var archiveFolder = new TemporaryDirectory();
1968              var listServer = new TestMailmanServer();
1969              var webrevServer = new TestWebrevServer()) {
1970             var author = credentials.getHostedRepository();
1971             var archive = credentials.getHostedRepository();
1972             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1973             var censusBuilder = credentials.getCensusBuilder()
1974                                            .addAuthor(author.forge().currentUser().id());
1975             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1976             var mlBot = MailingListBridgeBot.newBuilder()
1977                                             .from(from)
1978                                             .repo(author)
1979                                             .archive(archive)
1980                                             .censusRepo(censusBuilder.build())
1981                                             .list(listAddress)
1982                                             .listArchive(listServer.getArchive())
1983                                             .smtpServer(listServer.getSMTP())
1984                                             .webrevStorageRepository(archive)
1985                                             .webrevStorageRef(&quot;webrev&quot;)
1986                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1987                                             .webrevStorageBaseUri(webrevServer.uri())
1988                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1989                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
1990                                             .build();
1991 
1992             // Populate the projects repository
1993             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1994             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1995             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1996             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1997 
1998             // Make a change with a corresponding PR
1999             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2000                                                                &quot;Change msg\n\nWith several lines&quot;);
2001             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2002             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2003             pr.setBody(&quot;This is a PR&quot;);
2004 
2005             // Run an archive pass
2006             TestBotRunner.runPeriodicItems(mlBot);
2007             listServer.processIncoming();
2008 
2009             pr.addComment(&quot;Looks good!&quot;);
2010             TestBotRunner.runPeriodicItems(mlBot);
2011             listServer.processIncoming();
2012 
2013             // Check the archive
2014             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2015             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[master\\] RFR: &quot;));
2016             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[master\\] RFR: &quot;));
2017         }
2018     }
2019 
2020     @Test
2021     void repoPrefix(TestInfo testInfo) throws IOException {
2022         try (var credentials = new HostCredentials(testInfo);
2023              var tempFolder = new TemporaryDirectory();
2024              var archiveFolder = new TemporaryDirectory();
2025              var listServer = new TestMailmanServer();
2026              var webrevServer = new TestWebrevServer()) {
2027             var author = credentials.getHostedRepository();
2028             var archive = credentials.getHostedRepository();
2029             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2030             var censusBuilder = credentials.getCensusBuilder()
2031                                            .addAuthor(author.forge().currentUser().id());
2032             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2033             var mlBot = MailingListBridgeBot.newBuilder()
2034                                             .from(from)
2035                                             .repo(author)
2036                                             .archive(archive)
2037                                             .censusRepo(censusBuilder.build())
2038                                             .list(listAddress)
2039                                             .listArchive(listServer.getArchive())
2040                                             .smtpServer(listServer.getSMTP())
2041                                             .webrevStorageRepository(archive)
2042                                             .webrevStorageRef(&quot;webrev&quot;)
2043                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2044                                             .webrevStorageBaseUri(webrevServer.uri())
2045                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2046                                             .repoInSubject(true)
2047                                             .build();
2048 
2049             // Populate the projects repository
2050             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2051             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2052             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2053             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2054 
2055             // Make a change with a corresponding PR
2056             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2057                                                                &quot;Change msg\n\nWith several lines&quot;);
2058             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2059             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2060             pr.setBody(&quot;This is a PR&quot;);
2061 
2062             // Run an archive pass
2063             TestBotRunner.runPeriodicItems(mlBot);
2064             listServer.processIncoming();
2065 
2066             pr.addComment(&quot;Looks good!&quot;);
2067             TestBotRunner.runPeriodicItems(mlBot);
2068             listServer.processIncoming();
2069 
2070             // Check the archive
2071             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2072             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2073             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2074         }
2075     }
2076 
2077     @Test
2078     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2079         try (var credentials = new HostCredentials(testInfo);
2080              var tempFolder = new TemporaryDirectory();
2081              var archiveFolder = new TemporaryDirectory();
2082              var listServer = new TestMailmanServer();
2083              var webrevServer = new TestWebrevServer()) {
2084             var author = credentials.getHostedRepository();
2085             var archive = credentials.getHostedRepository();
2086             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2087             var censusBuilder = credentials.getCensusBuilder()
2088                                            .addAuthor(author.forge().currentUser().id());
2089             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2090             var mlBot = MailingListBridgeBot.newBuilder()
2091                                             .from(from)
2092                                             .repo(author)
2093                                             .archive(archive)
2094                                             .censusRepo(censusBuilder.build())
2095                                             .list(listAddress)
2096                                             .listArchive(listServer.getArchive())
2097                                             .smtpServer(listServer.getSMTP())
2098                                             .webrevStorageRepository(archive)
2099                                             .webrevStorageRef(&quot;webrev&quot;)
2100                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2101                                             .webrevStorageBaseUri(webrevServer.uri())
2102                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2103                                             .repoInSubject(true)
2104                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2105                                             .build();
2106 
2107             // Populate the projects repository
2108             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2109             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2110             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2111             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2112 
2113             // Make a change with a corresponding PR
2114             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2115                                                                &quot;Change msg\n\nWith several lines&quot;);
2116             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2117             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2118             pr.setBody(&quot;This is a PR&quot;);
2119 
2120             // Run an archive pass
2121             TestBotRunner.runPeriodicItems(mlBot);
2122             listServer.processIncoming();
2123 
2124             pr.addComment(&quot;Looks good!&quot;);
2125             TestBotRunner.runPeriodicItems(mlBot);
2126             listServer.processIncoming();
2127 
2128             // Check the archive
2129             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2130             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2131             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2132         }
2133     }
2134 
2135     @Test
2136     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2137         try (var credentials = new HostCredentials(testInfo);
2138              var tempFolder = new TemporaryDirectory();
2139              var archiveFolder = new TemporaryDirectory();
2140              var listServer = new TestMailmanServer();
2141              var webrevServer = new TestWebrevServer()) {
2142             var bot = credentials.getHostedRepository();
2143             var author = credentials.getHostedRepository();
2144             var archive = credentials.getHostedRepository();
2145             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2146             var censusBuilder = credentials.getCensusBuilder()
2147                                            .addAuthor(author.forge().currentUser().id());
2148             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2149             var cooldown = Duration.ofMillis(500);
2150             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2151                                                    .from(from)
2152                                                    .repo(bot)
2153                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2154                                                    .archive(archive)
2155                                                    .censusRepo(censusBuilder.build())
2156                                                    .list(listAddress)
2157                                                    .listArchive(listServer.getArchive())
2158                                                    .smtpServer(listServer.getSMTP())
2159                                                    .webrevStorageRepository(archive)
2160                                                    .webrevStorageRef(&quot;webrev&quot;)
2161                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2162                                                    .webrevStorageBaseUri(webrevServer.uri())
2163                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2164 
2165             // Populate the projects repository
2166             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2167             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2168             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2169             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2170             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2171 
2172             // Make a change with a corresponding PR
2173             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2174             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2175             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2176             pr.setBody(&quot;This is now ready&quot;);
2177 
2178             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2179             Thread.sleep(cooldown.toMillis());
2180             TestBotRunner.runPeriodicItems(mlBot);
2181             listServer.processIncoming();
2182 
2183             // Make a new revision and run the check within the cooldown period
2184             int counter;
2185             boolean noMailReceived = false;
2186             for (counter = 1; counter &lt; 10; ++counter) {
2187                 var start = Instant.now();
2188                 var revHash = CheckableRepository.appendAndCommit(localRepo, &quot;more stuff&quot;, &quot;Update number - &quot; + counter + &quot; -&quot;);
2189                 localRepo.push(revHash, author.url(), &quot;edit&quot;);
2190 
2191                 // The bot should not bridge the new revision due to cooldown
2192                 TestBotRunner.runPeriodicItems(mlBot);
2193                 try {
2194                     noMailReceived = false;
2195                     listServer.processIncoming(Duration.ofMillis(1));
2196                 } catch (RuntimeException e) {
2197                     noMailReceived = true;
2198                 }
2199                 var elapsed = Duration.between(start, Instant.now());
2200                 if (elapsed.compareTo(cooldown) &lt; 0) {
2201                     break;
2202                 } else {
2203                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2204                     // Ensure that the cooldown expires
2205                     Thread.sleep(cooldown.toMillis());
2206                     // If no mail was received, we have to flush it out
2207                     if (noMailReceived) {
2208                         TestBotRunner.runPeriodicItems(mlBot);
2209                         listServer.processIncoming();
2210                     }
2211                     cooldown = cooldown.multipliedBy(2);
2212                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2213                 }
2214             }
2215             assertTrue(noMailReceived);
2216 
2217             // But after the cooldown period has passed, it should
2218             Thread.sleep(cooldown.toMillis());
2219             TestBotRunner.runPeriodicItems(mlBot);
2220             listServer.processIncoming();
2221 
2222             // Check the archive
2223             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2224             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
2225         }
2226     }
2227 }
    </pre>
  </body>
</html>