<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/merge/src/main/java/org/openjdk/skara/bots/merge/MergeBot.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/merge/src/main/java/org/openjdk/skara/bots/merge/MergeBot.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
404                     }
405                     repo.push(toBranch, target.url().toString(), false);
406                 } else {
407                     log.info(&quot;Got error: &quot; + error.getMessage());
408                     log.info(&quot;Aborting unsuccesful merge&quot;);
409                     var status = repo.status();
410                     repo.abortMerge();
411 
412                     var fromRepoName = Path.of(fromRepo.webUrl().getPath()).getFileName();
413                     var branchDesc = fromRepoName + &quot;/&quot; + fromBranch.name() + &quot;-&gt;&quot; + toBranch.name();
414                     repo.push(fetchHead, fork.url(), branchDesc, true);
415 
416                     log.info(&quot;Creating pull request to alert&quot;);
417                     var mergeBase = repo.mergeBase(fetchHead, head);
418 
419                     var message = new ArrayList&lt;String&gt;();
420                     message.add(marker);
421                     message.add(&quot;&lt;!-- &quot; + fetchHead.hex() + &quot; --&gt;&quot;);
422 
423                     var commits = repo.commits(mergeBase.hex() + &quot;..&quot; + fetchHead.hex(), true).asList();
<span class="line-modified">424                     if (commits.size() &lt;= 10) {</span>
<span class="line-modified">425                         message.add(&quot;The following commits from &quot; + fromDesc + &quot; could *not* be &quot; +</span>
<span class="line-modified">426                                     &quot;automatically merged into &quot; + toBranch.name() + &quot;:&quot;);</span>
<span class="line-modified">427                         message.add(&quot;&quot;);</span>
<span class="line-modified">428                         for (var commit : commits) {</span>
<span class="line-modified">429                             message.add(&quot;- &quot; + commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0));</span>
<span class="line-modified">430                         }</span>
<span class="line-modified">431                         message.add(&quot;&quot;);</span>
<span class="line-modified">432                     } else {</span>
<span class="line-removed">433                         message.add(&quot;Could *not* automatically merge &quot; + commits.size() + &quot; commits from &quot; +</span>
<span class="line-removed">434                                     fromDesc + &quot; into &quot; + toBranch.name() + &quot;.&quot;);</span>
<span class="line-removed">435                     }</span>
436 
<span class="line-modified">437                     var unmerged = status.stream().filter(s -&gt; s.status().isUnmerged()).collect(Collectors.toList());</span>

438                     if (unmerged.size() &lt;= 10) {
<span class="line-modified">439                         message.add(&quot;The following files contains merge conflicts:&quot;);</span>

440                         message.add(&quot;&quot;);
441                         for (var fileStatus : unmerged) {
442                             message.add(&quot;- &quot; + fileStatus.source().path().orElseThrow());
443                         }
444                     } else {
445                         message.add(&quot;Over &quot; + unmerged.size() + &quot; files contains merge conflicts.&quot;);
446                     }
447                     message.add(&quot;&quot;);
448 
<span class="line-modified">449                     message.add(&quot;To manually resolve these merge conflicts, please create a personal fork of &quot; +</span>
<span class="line-modified">450                                 target.webUrl() + &quot; and execute the following commands:&quot;);</span>













451                     message.add(&quot;&quot;);
452                     message.add(&quot;```bash&quot;);
453                     message.add(&quot;$ git checkout &quot; + toBranch.name());
454                     message.add(&quot;$ git pull &quot; + target.webUrl() + &quot; &quot; + toBranch.name());
<span class="line-modified">455                     message.add(&quot;$ git checkout --branch merge-&quot; + fromBranch.name() + &quot;-into-&quot; + toBranch.name());</span>
456                     message.add(&quot;$ git pull &quot; + fromRepo.webUrl() + &quot; &quot; + fromBranch.name());
457                     message.add(&quot;```&quot;);
458                     message.add(&quot;&quot;);
<span class="line-modified">459                     message.add(&quot;When you have resolved the conflicts resulting from the above commands, run:&quot;);</span>

460                     message.add(&quot;&quot;);
461                     message.add(&quot;```bash&quot;);
462                     message.add(&quot;$ git add paths/to/files/with/conflicts&quot;);
463                     message.add(&quot;$ git commit -m &#39;Merge &quot; + fromDesc + &quot;&#39;&quot;);
464                     message.add(&quot;```&quot;);
465                     message.add(&quot;&quot;);
<span class="line-modified">466                     message.add(&quot;Push the merge commit to your personal fork:&quot;);</span>
<span class="line-modified">467                     message.add(&quot;&quot;);</span>
<span class="line-modified">468                     message.add(&quot;```bash&quot;);</span>
<span class="line-modified">469                     message.add(&quot;$ git push -u origin merge-&quot; + fromBranch.name() + &quot;-into-&quot; + toBranch.name());</span>
<span class="line-modified">470                     message.add(&quot;```&quot;);</span>
<span class="line-modified">471                     message.add(&quot;&quot;);</span>
<span class="line-modified">472                     message.add(&quot;Now proceed to create a pull request towards this repository.&quot;);</span>
<span class="line-removed">473                     message.add(&quot;If you are using the [Skara](https://wiki.openjdk.java.net/display/skara#Skara-Skara)&quot; +</span>
<span class="line-removed">474                                 &quot;CLI tooling then you can run the following command to create the pull request:&quot;);</span>
475                     message.add(&quot;&quot;);
<span class="line-modified">476                     message.add(&quot;```bash&quot;);</span>
<span class="line-modified">477                     message.add(&quot;$ git pr create&quot;);</span>
<span class="line-modified">478                     message.add(&quot;```&quot;);</span>



479                     message.add(&quot;&quot;);
<span class="line-modified">480                     message.add(&quot;This pull request will be closed automatically by a bot once &quot; +</span>
<span class="line-modified">481                                 &quot;the merge conflicts have been resolved.&quot;);</span>

482                     fork.createPullRequest(prTarget,
483                                            toBranch.name(),
484                                            branchDesc,
485                                            title,
486                                            message);
487                 }
488             }
489         } catch (IOException e) {
490             throw new UncheckedIOException(e);
491         }
492     }
493 
494     @Override
495     public String toString() {
496         return &quot;MergeBot@(&quot; + target.name() + &quot;)&quot;;
497     }
498 
499     @Override
500     public List&lt;WorkItem&gt; getPeriodicItems() {
501         return List.of(this);
</pre>
</td>
<td>
<hr />
<pre>
404                     }
405                     repo.push(toBranch, target.url().toString(), false);
406                 } else {
407                     log.info(&quot;Got error: &quot; + error.getMessage());
408                     log.info(&quot;Aborting unsuccesful merge&quot;);
409                     var status = repo.status();
410                     repo.abortMerge();
411 
412                     var fromRepoName = Path.of(fromRepo.webUrl().getPath()).getFileName();
413                     var branchDesc = fromRepoName + &quot;/&quot; + fromBranch.name() + &quot;-&gt;&quot; + toBranch.name();
414                     repo.push(fetchHead, fork.url(), branchDesc, true);
415 
416                     log.info(&quot;Creating pull request to alert&quot;);
417                     var mergeBase = repo.mergeBase(fetchHead, head);
418 
419                     var message = new ArrayList&lt;String&gt;();
420                     message.add(marker);
421                     message.add(&quot;&lt;!-- &quot; + fetchHead.hex() + &quot; --&gt;&quot;);
422 
423                     var commits = repo.commits(mergeBase.hex() + &quot;..&quot; + fetchHead.hex(), true).asList();
<span class="line-modified">424                     var numCommits = commits.size();</span>
<span class="line-modified">425                     var are = numCommits &gt; 1 ? &quot;are&quot; : &quot;is&quot;;</span>
<span class="line-modified">426                     var s = numCommits &gt; 1 ? &quot;s&quot; : &quot;&quot;;</span>
<span class="line-modified">427 </span>
<span class="line-modified">428                     message.add(&quot;Hi all,&quot;);</span>
<span class="line-modified">429                     message.add(&quot;&quot;);</span>
<span class="line-modified">430                     message.add(&quot;this is an _automatically_ generated merge request to notify you that there &quot; +</span>
<span class="line-modified">431                                 are + &quot; &quot; + numCommits + &quot; commit&quot; + s + &quot; from the branch `&quot; + fromDesc + &quot;`&quot; +</span>
<span class="line-modified">432                                 &quot;that can **not** be merged into the branch `&quot; + toBranch.name() + &quot;`:&quot;);</span>



433 
<span class="line-modified">434                     message.add(&quot;&quot;);</span>
<span class="line-added">435                     var unmerged = status.stream().filter(entry -&gt; entry.status().isUnmerged()).collect(Collectors.toList());</span>
436                     if (unmerged.size() &lt;= 10) {
<span class="line-modified">437                         var files = unmerged.size() &gt; 1 ? &quot;files&quot; : &quot;file&quot;;</span>
<span class="line-added">438                         message.add(&quot;The following &quot; + files + &quot; contains merge conflicts:&quot;);</span>
439                         message.add(&quot;&quot;);
440                         for (var fileStatus : unmerged) {
441                             message.add(&quot;- &quot; + fileStatus.source().path().orElseThrow());
442                         }
443                     } else {
444                         message.add(&quot;Over &quot; + unmerged.size() + &quot; files contains merge conflicts.&quot;);
445                     }
446                     message.add(&quot;&quot;);
447 
<span class="line-modified">448                     message.add(&quot;The following paragraphs will give an example on how to solve these &quot; +</span>
<span class="line-modified">449                                 &quot;merge conflicts and create a pull request to integrate them. If you are &quot; +</span>
<span class="line-added">450                                 &quot;using a workflow different from the one below, feel free to use that instead. &quot; +</span>
<span class="line-added">451                                 &quot;It is important that the title of the pull request you create is &quot; +</span>
<span class="line-added">452                                 &quot;`Merge &quot; + fromDesc + &quot;`, otherwise the bots will _not_ understand that the &quot; +</span>
<span class="line-added">453                                 &quot;pull request you create is a \&quot;merge style\&quot; pull request.&quot;);</span>
<span class="line-added">454                     message.add(&quot;&quot;);</span>
<span class="line-added">455                     var localBranchName = &quot;merge-&quot; + fromDesc + &quot;-into-&quot; + toBranch.name() + &quot;-&quot; + commits.get(0).hash().abbreviate();</span>
<span class="line-added">456                     message.add(&quot;The below commands should be run in a local clone of your &quot; +</span>
<span class="line-added">457                                 &quot;[personal fork](https://wiki.openjdk.java.net/display/skara#Skara-Personalforks) &quot; +</span>
<span class="line-added">458                                 &quot;of the [&quot; + target.name() + &quot;](&quot; + target.webUrl() + &quot;) repository. &quot; +</span>
<span class="line-added">459                                 &quot;These commands will allow you to view and resolve the merge conflicts. Note that &quot; +</span>
<span class="line-added">460                                 &quot;the name of the local branch in the commands, &quot; +</span>
<span class="line-added">461                                 &quot;`&quot; + localBranchName + &quot;`&quot; +</span>
<span class="line-added">462                                 &quot;, is just an example, feel free to give the local branch any name you prefer.&quot;);</span>
463                     message.add(&quot;&quot;);
464                     message.add(&quot;```bash&quot;);
465                     message.add(&quot;$ git checkout &quot; + toBranch.name());
466                     message.add(&quot;$ git pull &quot; + target.webUrl() + &quot; &quot; + toBranch.name());
<span class="line-modified">467                     message.add(&quot;$ git checkout -b &quot; + localBranchName);</span>
468                     message.add(&quot;$ git pull &quot; + fromRepo.webUrl() + &quot; &quot; + fromBranch.name());
469                     message.add(&quot;```&quot;);
470                     message.add(&quot;&quot;);
<span class="line-modified">471                     message.add(&quot;When you have resolved the conflicts resulting from the `git pull` command &quot; +</span>
<span class="line-added">472                                 &quot;above, run the following commands to create a merge commit:&quot;);</span>
473                     message.add(&quot;&quot;);
474                     message.add(&quot;```bash&quot;);
475                     message.add(&quot;$ git add paths/to/files/with/conflicts&quot;);
476                     message.add(&quot;$ git commit -m &#39;Merge &quot; + fromDesc + &quot;&#39;&quot;);
477                     message.add(&quot;```&quot;);
478                     message.add(&quot;&quot;);
<span class="line-modified">479                     message.add(&quot;The commit message does not have to be `Merge &quot; + fromDesc + &quot;`, &quot; +</span>
<span class="line-modified">480                                 &quot;but it is convenient for when you will create a pull request. Many tools &quot; +</span>
<span class="line-modified">481                                 &quot;will by default use the commit message of the most recent commit on a branch &quot; +</span>
<span class="line-modified">482                                 &quot;as the title for a pull request from that branch. This means that if you use &quot; +</span>
<span class="line-modified">483                                 &quot;the commit message `Merge &quot; + fromDesc + &quot;` as the commit message then the &quot; +</span>
<span class="line-modified">484                                 &quot;title of the pull request will (depending to tools used to create the &quot; +</span>
<span class="line-modified">485                                 &quot;pull request) be of a format that the bots expect.&quot;);</span>


486                     message.add(&quot;&quot;);
<span class="line-modified">487                     message.add(&quot;Proceed to [publish the local branch](https://wiki.openjdk.java.net/display/SKARA/FAQ#FAQ-HowdoIpushalocalbranchtoaremoterepository?) &quot; +</span>
<span class="line-modified">488                                 &quot;and [create a pull request](https://wiki.openjdk.java.net/display/SKARA/FAQ#FAQ-HowdoIcreateapullrequest?) &quot; +</span>
<span class="line-modified">489                                 &quot;towards the `&quot; + toBranch.name() + &quot;` branch in the &quot; +</span>
<span class="line-added">490                                 &quot;[&quot; + target.name() + &quot;](&quot; + target.webUrl() + &quot;) repository. The resulting pull &quot; +</span>
<span class="line-added">491                                 &quot;request can then integrated as usual once it has passed all required &quot; +</span>
<span class="line-added">492                                 &quot;pre-integration checks.&quot;);</span>
493                     message.add(&quot;&quot;);
<span class="line-modified">494                     message.add(&quot;Thanks,&quot;);</span>
<span class="line-modified">495                     message.add(&quot;J. Duke&quot;);</span>
<span class="line-added">496 </span>
497                     fork.createPullRequest(prTarget,
498                                            toBranch.name(),
499                                            branchDesc,
500                                            title,
501                                            message);
502                 }
503             }
504         } catch (IOException e) {
505             throw new UncheckedIOException(e);
506         }
507     }
508 
509     @Override
510     public String toString() {
511         return &quot;MergeBot@(&quot; + target.name() + &quot;)&quot;;
512     }
513 
514     @Override
515     public List&lt;WorkItem&gt; getPeriodicItems() {
516         return List.of(this);
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>