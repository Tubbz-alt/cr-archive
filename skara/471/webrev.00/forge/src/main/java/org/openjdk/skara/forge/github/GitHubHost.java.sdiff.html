<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff forge/src/main/java/org/openjdk/skara/forge/github/GitHubHost.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GitHubApplication.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="GitHubRepository.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>forge/src/main/java/org/openjdk/skara/forge/github/GitHubHost.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 40     private final String webUriReplacement;
 41     private final GitHubApplication application;
 42     private final Credential pat;
 43     private final RestRequest request;
 44     private final RestRequest graphQL;
 45     private HostUser currentUser;
 46     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.forge.github&quot;);
 47 
 48     public GitHubHost(URI uri, GitHubApplication application, Pattern webUriPattern, String webUriReplacement) {
 49         this.uri = uri;
 50         this.webUriPattern = webUriPattern;
 51         this.webUriReplacement = webUriReplacement;
 52         this.application = application;
 53         this.pat = null;
 54 
 55         var baseApi = URIBuilder.base(uri)
 56                 .appendSubDomain(&quot;api&quot;)
 57                 .setPath(&quot;/&quot;)
 58                 .build();
 59 
<span class="line-modified"> 60         request = new RestRequest(baseApi, () -&gt; Arrays.asList(</span>
 61                 &quot;Authorization&quot;, &quot;token &quot; + getInstallationToken().orElseThrow(),
 62                 &quot;Accept&quot;, &quot;application/vnd.github.machine-man-preview+json&quot;,
 63                 &quot;Accept&quot;, &quot;application/vnd.github.antiope-preview+json&quot;));
 64 
 65         var graphQLAPI = URIBuilder.base(uri)
 66                 .appendSubDomain(&quot;api&quot;)
 67                 .setPath(&quot;/graphql&quot;)
 68                 .build();
<span class="line-modified"> 69         graphQL = new RestRequest(graphQLAPI, () -&gt; Arrays.asList(</span>
 70                 &quot;Authorization&quot;, &quot;bearer &quot; + getInstallationToken().orElseThrow(),
 71                 &quot;Accept&quot;, &quot;application/vnd.github.machine-man-preview+json&quot;,
 72                 &quot;Accept&quot;, &quot;application/vnd.github.antiope-preview+json&quot;,
 73                 &quot;Accept&quot;, &quot;application/vnd.github.shadow-cat-preview+json&quot;,
 74                 &quot;Accept&quot;, &quot;application/vnd.github.comfort-fade-preview+json&quot;
 75         ));
 76     }
 77 
 78     RestRequest graphQL() {
 79         if (graphQL == null) {
 80             throw new IllegalStateException(&quot;Cannot use GraphQL API without authorization&quot;);
 81         }
 82         return graphQL;
 83     }
 84 
 85     public GitHubHost(URI uri, Credential pat, Pattern webUriPattern, String webUriReplacement) {
 86         this.uri = uri;
 87         this.webUriPattern = webUriPattern;
 88         this.webUriReplacement = webUriReplacement;
 89         this.pat = pat;
 90         this.application = null;
 91 
 92         var baseApi = URIBuilder.base(uri)
 93                                 .appendSubDomain(&quot;api&quot;)
 94                                 .setPath(&quot;/&quot;)
 95                                 .build();
 96 
<span class="line-modified"> 97         request = new RestRequest(baseApi, () -&gt; Arrays.asList(</span>
 98                 &quot;Authorization&quot;, &quot;token &quot; + getInstallationToken().orElseThrow()));
 99 
100         var graphQLAPI = URIBuilder.base(uri)
101                 .appendSubDomain(&quot;api&quot;)
102                 .setPath(&quot;/graphql&quot;)
103                 .build();
<span class="line-modified">104         graphQL = new RestRequest(graphQLAPI, () -&gt; Arrays.asList(</span>
105                 &quot;Authorization&quot;, &quot;bearer &quot; + getInstallationToken().orElseThrow(),
106                 &quot;Accept&quot;, &quot;application/vnd.github.machine-man-preview+json&quot;,
107                 &quot;Accept&quot;, &quot;application/vnd.github.antiope-preview+json&quot;,
108                 &quot;Accept&quot;, &quot;application/vnd.github.shadow-cat-preview+json&quot;,
109                 &quot;Accept&quot;, &quot;application/vnd.github.comfort-fade-preview+json&quot;
110         ));
111     }
112 
113     GitHubHost(URI uri, Pattern webUriPattern, String webUriReplacement) {
114         this.uri = uri;
115         this.webUriPattern = webUriPattern;
116         this.webUriReplacement = webUriReplacement;
117         this.pat = null;
118         this.application = null;
119 
120         var baseApi = URIBuilder.base(uri)
121                                 .appendSubDomain(&quot;api&quot;)
122                                 .setPath(&quot;/&quot;)
123                                 .build();
124 
</pre>
<hr />
<pre>
142         var matcher = webUriPattern.matcher(baseWebUri.toString());
143         if (!matcher.matches()) {
144             return baseWebUri;
145 
146         }
147         return URIBuilder.base(matcher.replaceAll(webUriReplacement)).build();
148     }
149 
150     Optional&lt;String&gt; getInstallationToken() {
151         if (application != null) {
152             return Optional.of(application.getInstallationToken());
153         }
154 
155         if (pat != null) {
156             return Optional.of(pat.password());
157         }
158 
159         return Optional.empty();
160     }
161 












162     private String getFullName(String userName) {
163         var details = user(userName);
164         return details.get().fullName();
165     }
166 
167     // Most GitHub API&#39;s return user information in this format
168     HostUser parseUserField(JSONValue json) {
169         return parseUserObject(json.get(&quot;user&quot;));
170     }
171 
172     HostUser parseUserObject(JSONValue json) {
173         return new HostUser(json.get(&quot;id&quot;).asInt(), json.get(&quot;login&quot;).asString(),
174                             () -&gt; getFullName(json.get(&quot;login&quot;).asString()));
175     }
176 
177     @Override
178     public boolean isValid() {
179         try {
180             var endpoints = request.get(&quot;&quot;)
181                                    .executeUnparsed();
</pre>
</td>
<td>
<hr />
<pre>
 40     private final String webUriReplacement;
 41     private final GitHubApplication application;
 42     private final Credential pat;
 43     private final RestRequest request;
 44     private final RestRequest graphQL;
 45     private HostUser currentUser;
 46     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.forge.github&quot;);
 47 
 48     public GitHubHost(URI uri, GitHubApplication application, Pattern webUriPattern, String webUriReplacement) {
 49         this.uri = uri;
 50         this.webUriPattern = webUriPattern;
 51         this.webUriReplacement = webUriReplacement;
 52         this.application = application;
 53         this.pat = null;
 54 
 55         var baseApi = URIBuilder.base(uri)
 56                 .appendSubDomain(&quot;api&quot;)
 57                 .setPath(&quot;/&quot;)
 58                 .build();
 59 
<span class="line-modified"> 60         request = new RestRequest(baseApi, application.authId(), () -&gt; Arrays.asList(</span>
 61                 &quot;Authorization&quot;, &quot;token &quot; + getInstallationToken().orElseThrow(),
 62                 &quot;Accept&quot;, &quot;application/vnd.github.machine-man-preview+json&quot;,
 63                 &quot;Accept&quot;, &quot;application/vnd.github.antiope-preview+json&quot;));
 64 
 65         var graphQLAPI = URIBuilder.base(uri)
 66                 .appendSubDomain(&quot;api&quot;)
 67                 .setPath(&quot;/graphql&quot;)
 68                 .build();
<span class="line-modified"> 69         graphQL = new RestRequest(graphQLAPI, application.authId(), () -&gt; Arrays.asList(</span>
 70                 &quot;Authorization&quot;, &quot;bearer &quot; + getInstallationToken().orElseThrow(),
 71                 &quot;Accept&quot;, &quot;application/vnd.github.machine-man-preview+json&quot;,
 72                 &quot;Accept&quot;, &quot;application/vnd.github.antiope-preview+json&quot;,
 73                 &quot;Accept&quot;, &quot;application/vnd.github.shadow-cat-preview+json&quot;,
 74                 &quot;Accept&quot;, &quot;application/vnd.github.comfort-fade-preview+json&quot;
 75         ));
 76     }
 77 
 78     RestRequest graphQL() {
 79         if (graphQL == null) {
 80             throw new IllegalStateException(&quot;Cannot use GraphQL API without authorization&quot;);
 81         }
 82         return graphQL;
 83     }
 84 
 85     public GitHubHost(URI uri, Credential pat, Pattern webUriPattern, String webUriReplacement) {
 86         this.uri = uri;
 87         this.webUriPattern = webUriPattern;
 88         this.webUriReplacement = webUriReplacement;
 89         this.pat = pat;
 90         this.application = null;
 91 
 92         var baseApi = URIBuilder.base(uri)
 93                                 .appendSubDomain(&quot;api&quot;)
 94                                 .setPath(&quot;/&quot;)
 95                                 .build();
 96 
<span class="line-modified"> 97         request = new RestRequest(baseApi, pat.username(), () -&gt; Arrays.asList(</span>
 98                 &quot;Authorization&quot;, &quot;token &quot; + getInstallationToken().orElseThrow()));
 99 
100         var graphQLAPI = URIBuilder.base(uri)
101                 .appendSubDomain(&quot;api&quot;)
102                 .setPath(&quot;/graphql&quot;)
103                 .build();
<span class="line-modified">104         graphQL = new RestRequest(graphQLAPI, pat.username(), () -&gt; Arrays.asList(</span>
105                 &quot;Authorization&quot;, &quot;bearer &quot; + getInstallationToken().orElseThrow(),
106                 &quot;Accept&quot;, &quot;application/vnd.github.machine-man-preview+json&quot;,
107                 &quot;Accept&quot;, &quot;application/vnd.github.antiope-preview+json&quot;,
108                 &quot;Accept&quot;, &quot;application/vnd.github.shadow-cat-preview+json&quot;,
109                 &quot;Accept&quot;, &quot;application/vnd.github.comfort-fade-preview+json&quot;
110         ));
111     }
112 
113     GitHubHost(URI uri, Pattern webUriPattern, String webUriReplacement) {
114         this.uri = uri;
115         this.webUriPattern = webUriPattern;
116         this.webUriReplacement = webUriReplacement;
117         this.pat = null;
118         this.application = null;
119 
120         var baseApi = URIBuilder.base(uri)
121                                 .appendSubDomain(&quot;api&quot;)
122                                 .setPath(&quot;/&quot;)
123                                 .build();
124 
</pre>
<hr />
<pre>
142         var matcher = webUriPattern.matcher(baseWebUri.toString());
143         if (!matcher.matches()) {
144             return baseWebUri;
145 
146         }
147         return URIBuilder.base(matcher.replaceAll(webUriReplacement)).build();
148     }
149 
150     Optional&lt;String&gt; getInstallationToken() {
151         if (application != null) {
152             return Optional.of(application.getInstallationToken());
153         }
154 
155         if (pat != null) {
156             return Optional.of(pat.password());
157         }
158 
159         return Optional.empty();
160     }
161 
<span class="line-added">162     Optional&lt;String&gt; authId() {</span>
<span class="line-added">163         if (application != null) {</span>
<span class="line-added">164             return Optional.of(application.authId());</span>
<span class="line-added">165         }</span>
<span class="line-added">166 </span>
<span class="line-added">167         if (pat != null) {</span>
<span class="line-added">168             return Optional.of(pat.username());</span>
<span class="line-added">169         }</span>
<span class="line-added">170 </span>
<span class="line-added">171         return Optional.empty();</span>
<span class="line-added">172     }</span>
<span class="line-added">173 </span>
174     private String getFullName(String userName) {
175         var details = user(userName);
176         return details.get().fullName();
177     }
178 
179     // Most GitHub API&#39;s return user information in this format
180     HostUser parseUserField(JSONValue json) {
181         return parseUserObject(json.get(&quot;user&quot;));
182     }
183 
184     HostUser parseUserObject(JSONValue json) {
185         return new HostUser(json.get(&quot;id&quot;).asInt(), json.get(&quot;login&quot;).asString(),
186                             () -&gt; getFullName(json.get(&quot;login&quot;).asString()));
187     }
188 
189     @Override
190     public boolean isValid() {
191         try {
192             var endpoints = request.get(&quot;&quot;)
193                                    .executeUnparsed();
</pre>
</td>
</tr>
</table>
<center><a href="GitHubApplication.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="GitHubRepository.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>