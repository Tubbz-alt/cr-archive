<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff network/src/main/java/org/openjdk/skara/network/RestRequest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../issuetracker/src/main/java/org/openjdk/skara/issuetracker/jira/JiraVault.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../test/java/org/openjdk/skara/network/RestRequestTests.java.udiff.html" target="_top">next &gt;</a></center>    <h2>network/src/main/java/org/openjdk/skara/network/RestRequest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -32,10 +32,12 @@</span>
  import java.util.logging.Logger;
  import java.util.regex.Pattern;
  import java.util.stream.Collectors;
  
  public class RestRequest {
<span class="udiff-line-added">+     private RestRequestCache cache = RestRequestCache.INSTANCE;</span>
<span class="udiff-line-added">+ </span>
      private enum RequestType {
          GET,
          POST,
          PUT,
          PATCH,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -161,30 +163,33 @@</span>
              return RestRequest.this.executeUnparsed(this);
          }
      }
  
      private final URI apiBase;
<span class="udiff-line-added">+     private final String authId;</span>
      private final AuthenticationGenerator authGen;
      private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.host.network&quot;);
  
<span class="udiff-line-modified-removed">-     public RestRequest(URI apiBase, AuthenticationGenerator authGen) {</span>
<span class="udiff-line-modified-added">+     public RestRequest(URI apiBase, String authId, AuthenticationGenerator authGen) {</span>
          this.apiBase = apiBase;
<span class="udiff-line-added">+         this.authId = authId;</span>
          this.authGen = authGen;
      }
  
      public RestRequest(URI apiBase) {
          this.apiBase = apiBase;
<span class="udiff-line-added">+         this.authId = null;</span>
          this.authGen = null;
      }
  
      /**
       * Creates a new request restricted to the given endpoint.
       * @param endpoint
       * @return
       */
      public RestRequest restrict(String endpoint) {
<span class="udiff-line-modified-removed">-         return new RestRequest(URIBuilder.base(apiBase).appendPath(endpoint).build(), authGen);</span>
<span class="udiff-line-modified-added">+         return new RestRequest(URIBuilder.base(apiBase).appendPath(endpoint).build(), authId, authGen);</span>
      }
  
      private URIBuilder getEndpointURI(String endpoint) {
          return URIBuilder.base(apiBase)
                           .appendPath(endpoint);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -218,20 +223,20 @@</span>
  
      void setRetryBackoffStep(Duration duration) {
          retryBackoffStep = duration;
      }
  
<span class="udiff-line-modified-removed">-     private HttpResponse&lt;String&gt; sendRequest(HttpRequest request) throws IOException {</span>
<span class="udiff-line-modified-added">+     private HttpResponse&lt;String&gt; sendRequest(HttpRequest.Builder request) throws IOException {</span>
          HttpResponse&lt;String&gt; response;
  
          var retryCount = 0;
          while (true) {
              try {
<span class="udiff-line-modified-removed">-                 var client = HttpClient.newBuilder()</span>
<span class="udiff-line-modified-removed">-                                        .connectTimeout(Duration.ofSeconds(10))</span>
<span class="udiff-line-modified-removed">-                                        .build();</span>
<span class="udiff-line-modified-removed">-                 response = client.send(request, HttpResponse.BodyHandlers.ofString());</span>
<span class="udiff-line-modified-added">+                 if (authGen != null) {</span>
<span class="udiff-line-modified-added">+                     request.headers(authGen.getAuthHeaders().toArray(new String[0]));</span>
<span class="udiff-line-modified-added">+                 }</span>
<span class="udiff-line-modified-added">+                 response = cache.send(authId, request);</span>
                  break;
              } catch (InterruptedException | IOException e) {
                  if (retryCount &lt; 5) {
                      try {
                          Thread.sleep(retryCount * retryBackoffStep.toMillis());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -273,11 +278,11 @@</span>
          } else {
              return Optional.empty();
          }
      }
  
<span class="udiff-line-modified-removed">-     private HttpRequest createRequest(RequestType requestType, String endpoint, JSONValue body,</span>
<span class="udiff-line-modified-added">+     private HttpRequest.Builder createRequest(RequestType requestType, String endpoint, JSONValue body,</span>
                                        List&lt;QueryBuilder.Param&gt; params, Map&lt;String, String&gt; headers) {
          var uriBuilder = URIBuilder.base(apiBase);
          if (endpoint != null &amp;&amp; !endpoint.isEmpty()) {
              uriBuilder = uriBuilder.appendPath(endpoint);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -288,18 +293,16 @@</span>
  
          var requestBuilder = HttpRequest.newBuilder()
                                          .uri(uri)
                                          .timeout(Duration.ofSeconds(30))
                                          .header(&quot;Content-type&quot;, &quot;application/json&quot;);
<span class="udiff-line-modified-removed">-         if (authGen != null) {</span>
<span class="udiff-line-removed">-             requestBuilder.headers(authGen.getAuthHeaders().toArray(new String[0]));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+ </span>
          if (body != null) {
              requestBuilder.method(requestType.name(), HttpRequest.BodyPublishers.ofString(body.toString()));
          }
          headers.forEach(requestBuilder::header);
<span class="udiff-line-modified-removed">-         return requestBuilder.build();</span>
<span class="udiff-line-modified-added">+         return requestBuilder;</span>
      }
  
      private final Pattern linkPattern = Pattern.compile(&quot;&lt;(.*?)&gt;; rel=\&quot;(.*?)\&quot;&quot;);
  
      private Map&lt;String, String&gt; parseLink(String link) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -327,11 +330,11 @@</span>
          ret.add(parsedResponse);
  
          var links = parseLink(link.get());
          while (links.containsKey(&quot;next&quot;) &amp;&amp; ret.size() &lt; queryBuilder.maxPages) {
              var uri = URI.create(links.get(&quot;next&quot;));
<span class="udiff-line-modified-removed">-             request = getHttpRequestBuilder(uri).GET().build();</span>
<span class="udiff-line-modified-added">+             request = getHttpRequestBuilder(uri).GET();</span>
              response = sendRequest(request);
  
              // If an error occurs during paginated parsing, we have to discard all previous data
              errorTransform = transformBadResponse(response, queryBuilder);
              if (errorTransform.isPresent()) {
</pre>
<center><a href="../../../../../../../../issuetracker/src/main/java/org/openjdk/skara/issuetracker/jira/JiraVault.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../test/java/org/openjdk/skara/network/RestRequestTests.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>