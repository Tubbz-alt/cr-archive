<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/pr/src/test/java/org/openjdk/skara/bots/pr/SponsorTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.pr;
 24 
 25 import org.openjdk.skara.forge.Review;
 26 import org.openjdk.skara.test.*;
 27 import org.openjdk.skara.vcs.Repository;
 28 import org.openjdk.skara.vcs.Branch;
 29 
 30 import org.junit.jupiter.api.*;
 31 
 32 import java.io.IOException;
 33 import java.nio.file.Files;
 34 
 35 import static org.junit.jupiter.api.Assertions.*;
 36 import static org.openjdk.skara.bots.pr.PullRequestAsserts.assertLastCommentContains;
 37 
 38 class SponsorTests {
 39     private void runSponsortest(TestInfo testInfo, boolean isAuthor) throws IOException {
 40         try (var credentials = new HostCredentials(testInfo);
 41              var tempFolder = new TemporaryDirectory();
 42              var pushedFolder = new TemporaryDirectory()) {
 43             var author = credentials.getHostedRepository();
 44             var integrator = credentials.getHostedRepository();
 45             var reviewer = credentials.getHostedRepository();
 46 
 47             var censusBuilder = credentials.getCensusBuilder()
 48                                            .addReviewer(reviewer.forge().currentUser().id());
 49             if (isAuthor) {
 50                 censusBuilder.addAuthor(author.forge().currentUser().id());
 51             }
 52             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
 53 
 54             // Populate the projects repository
 55             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 56             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 57             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 58             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 59 
 60             // Make a change with a corresponding PR
 61             var editHash = CheckableRepository.appendAndCommit(localRepo);
 62             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 63             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 64 
 65             // Approve it as another user
 66             var approvalPr = reviewer.pullRequest(pr.id());
 67             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 68 
 69             // Let the bot see it
 70             TestBotRunner.runPeriodicItems(mergeBot);
 71 
 72             // Issue a merge command without being a Committer
 73             pr.addComment(&quot;/integrate&quot;);
 74             TestBotRunner.runPeriodicItems(mergeBot);
 75 
 76             // The bot should reply that a sponsor is required
 77             var sponsor = pr.comments().stream()
 78                             .filter(comment -&gt; comment.body().contains(&quot;sponsor&quot;))
 79                             .filter(comment -&gt; comment.body().contains(&quot;your change&quot;))
 80                             .count();
 81             assertEquals(1, sponsor);
 82 
 83             // The bot should not have pushed the commit
 84             var notPushed = pr.comments().stream()
 85                               .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
 86                               .count();
 87             assertEquals(0, notPushed);
 88 
 89             // Reviewer now agrees to sponsor
 90             var reviewerPr = reviewer.pullRequest(pr.id());
 91             reviewerPr.addComment(&quot;/sponsor&quot;);
 92             TestBotRunner.runPeriodicItems(mergeBot);
 93 
 94             // The bot should have pushed the commit
 95             var pushed = pr.comments().stream()
 96                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
 97                            .count();
 98             assertEquals(1, pushed);
 99 
100             // The change should now be present on the master branch
101             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
102             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
103             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
104 
105             if (isAuthor) {
106                 assertEquals(&quot;Generated Author 2&quot;, headCommit.author().name());
107                 assertEquals(&quot;integrationauthor2@openjdk.java.net&quot;, headCommit.author().email());
108             } else {
109                 assertEquals(&quot;testauthor&quot;, headCommit.author().name());
110                 assertEquals(&quot;ta@none.none&quot;, headCommit.author().email());
111             }
112 
113             assertEquals(&quot;Generated Reviewer 1&quot;, headCommit.committer().name());
114             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, headCommit.committer().email());
115             assertTrue(pr.labels().contains(&quot;integrated&quot;));
116             assertFalse(pr.labels().contains(&quot;ready&quot;));
117             assertFalse(pr.labels().contains(&quot;sponsor&quot;));
118         }
119     }
120 
121     @Test
122     void sponsorNonAuthor(TestInfo testInfo) throws IOException {
123         runSponsortest(testInfo, false);
124     }
125 
126     @Test
127     void sponsorAuthor(TestInfo testInfo) throws IOException {
128         runSponsortest(testInfo, true);
129     }
130 
131     @Test
132     void sponsorNotNeeded(TestInfo testInfo) throws IOException {
133         try (var credentials = new HostCredentials(testInfo);
134              var tempFolder = new TemporaryDirectory()) {
135             var author = credentials.getHostedRepository();
136             var integrator = credentials.getHostedRepository();
137 
138             var censusBuilder = credentials.getCensusBuilder()
139                                            .addCommitter(author.forge().currentUser().id());
140             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
141 
142             // Populate the projects repository
143             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
144             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
145             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
146             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
147 
148             // Make a change with a corresponding PR
149             var editHash = CheckableRepository.appendAndCommit(localRepo);
150             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
151             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
152 
153             // Issue an invalid command
154             pr.addComment(&quot;/sponsor&quot;);
155             TestBotRunner.runPeriodicItems(mergeBot);
156 
157             // The bot should reply with an error message
158             var error = pr.comments().stream()
159                           .filter(comment -&gt; comment.body().contains(&quot;does not need sponsoring&quot;))
160                           .count();
161             assertEquals(1, error);
162         }
163     }
164 
165     @Test
166     void sponsorNotAllowed(TestInfo testInfo) throws IOException {
167         try (var credentials = new HostCredentials(testInfo);
168              var tempFolder = new TemporaryDirectory()) {
169             var author = credentials.getHostedRepository();
170             var integrator = credentials.getHostedRepository();
171 
172             var censusBuilder = credentials.getCensusBuilder()
173                                            .addAuthor(author.forge().currentUser().id());
174             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
175 
176             // Populate the projects repository
177             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
178             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
179             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
180             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
181 
182             // Make a change with a corresponding PR
183             var editHash = CheckableRepository.appendAndCommit(localRepo);
184             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
185             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
186 
187             // Issue an invalid command
188             pr.addComment(&quot;/sponsor&quot;);
189             TestBotRunner.runPeriodicItems(mergeBot);
190 
191             // The bot should reply with an error message
192             var error = pr.comments().stream()
193                           .filter(comment -&gt; comment.body().contains(&quot;Committers&quot;))
194                           .filter(comment -&gt; comment.body().contains(&quot;are allowed to sponsor&quot;))
195                           .count();
196             assertEquals(1, error);
197         }
198     }
199 
200     @Test
201     void sponsorNotReady(TestInfo testInfo) throws IOException {
202         try (var credentials = new HostCredentials(testInfo);
203              var tempFolder = new TemporaryDirectory()) {
204             var author = credentials.getHostedRepository();
205             var integrator = credentials.getHostedRepository();
206             var reviewer = credentials.getHostedRepository();
207 
208             var censusBuilder = credentials.getCensusBuilder()
209                                            .addReviewer(reviewer.forge().currentUser().id());
210             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
211 
212             // Populate the projects repository
213             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
214             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
215             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
216             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
217 
218             // Make a change with a corresponding PR
219             var editHash = CheckableRepository.appendAndCommit(localRepo);
220             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
221             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
222 
223             // Reviewer now tries to sponsor
224             var reviewerPr = reviewer.pullRequest(pr.id());
225             reviewerPr.addComment(&quot;/sponsor&quot;);
226             TestBotRunner.runPeriodicItems(mergeBot);
227 
228             // The bot should reply with an error message
229             var error = pr.comments().stream()
230                           .filter(comment -&gt; comment.body().contains(&quot;before the integration can be sponsored&quot;))
231                           .count();
232             assertEquals(1, error);
233         }
234     }
235 
236     @Test
237     void sponsorAfterChanges(TestInfo testInfo) throws IOException {
238         try (var credentials = new HostCredentials(testInfo);
239              var tempFolder = new TemporaryDirectory()) {
240             var author = credentials.getHostedRepository();
241             var integrator = credentials.getHostedRepository();
242             var reviewer = credentials.getHostedRepository();
243 
244             var censusBuilder = credentials.getCensusBuilder()
245                                            .addReviewer(reviewer.forge().currentUser().id());
246             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
247 
248             // Populate the projects repository
249             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
250             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
251             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
252             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
253 
254             // Make a change with a corresponding PR
255             var editHash = CheckableRepository.appendAndCommit(localRepo);
256             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
257             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
258 
259             // Approve it as another user
260             var approvalPr = reviewer.pullRequest(pr.id());
261             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
262 
263             // Let the bot see it
264             TestBotRunner.runPeriodicItems(mergeBot);
265 
266             // Flag it as ready for integration
267             pr.addComment(&quot;/integrate&quot;);
268             TestBotRunner.runPeriodicItems(mergeBot);
269 
270             // Bot should have replied
271             var ready = pr.comments().stream()
272                           .filter(comment -&gt; comment.body().contains(&quot;now ready to be sponsored&quot;))
273                           .filter(comment -&gt; comment.body().contains(&quot;at version &quot; + editHash.hex()))
274                           .count();
275             assertEquals(1, ready);
276             assertTrue(pr.labels().contains(&quot;sponsor&quot;));
277 
278             // Push another change
279             var updateHash = CheckableRepository.appendAndCommit(localRepo,&quot;Yet more stuff&quot;);
280             localRepo.push(updateHash, author.url(), &quot;edit&quot;);
281 
282             // Make sure that the push registered
283             var lastHeadHash = pr.headHash();
284             var refreshCount = 0;
285             do {
286                 pr = author.pullRequest(pr.id());
287                 if (refreshCount++ &gt; 100) {
288                     fail(&quot;The PR did not update after the new push&quot;);
289                 }
290             } while (pr.headHash().equals(lastHeadHash));
291 
292             // The label should have been dropped
293             TestBotRunner.runPeriodicItems(mergeBot);
294             assertFalse(pr.labels().contains(&quot;sponsor&quot;));
295 
296             // Reviewer now tries to sponsor
297             var reviewerPr = reviewer.pullRequest(pr.id());
298             reviewerPr.addComment(&quot;/sponsor&quot;);
299             TestBotRunner.runPeriodicItems(mergeBot);
300 
301             // The bot should reply with an error message
302             var error = pr.comments().stream()
303                           .filter(comment -&gt; comment.body().contains(&quot;The PR has been updated since the change&quot;))
304                           .count();
305             assertEquals(1, error);
306 
307             // Flag it as ready for integration again
308             pr.addComment(&quot;/integrate&quot;);
309             TestBotRunner.runPeriodicItems(mergeBot);
310             assertTrue(pr.labels().contains(&quot;sponsor&quot;));
311 
312             // It should now be possible to sponsor
313             reviewerPr.addComment(&quot;/sponsor&quot;);
314             TestBotRunner.runPeriodicItems(mergeBot);
315             assertFalse(pr.labels().contains(&quot;sponsor&quot;));
316 
317             // The bot should have pushed the commit
318             var pushed = pr.comments().stream()
319                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
320                            .count();
321             assertEquals(1, pushed);
322         }
323     }
324 
325     @Test
326     void autoRebase(TestInfo testInfo) throws IOException {
327         try (var credentials = new HostCredentials(testInfo);
328              var tempFolder = new TemporaryDirectory();
329              var pushedFolder = new TemporaryDirectory()) {
330 
331             var author = credentials.getHostedRepository();
332             var integrator = credentials.getHostedRepository();
333             var reviewer = credentials.getHostedRepository();
334             var censusBuilder = credentials.getCensusBuilder()
335                                            .addAuthor(author.forge().currentUser().id())
336                                            .addReviewer(integrator.forge().currentUser().id())
337                                            .addReviewer(reviewer.forge().currentUser().id());
338             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
339 
340             // Populate the projects repository
341             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
342             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
343             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
344             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
345 
346             // Make a change with a corresponding PR
347             var editHash = CheckableRepository.appendAndCommit(localRepo);
348             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
349             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
350 
351             // Approve it as another user
352             var approvalPr = integrator.pullRequest(pr.id());
353             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
354 
355             // Push something unrelated to master
356             localRepo.checkout(masterHash, true);
357             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
358             Files.writeString(unrelated, &quot;Hello&quot;);
359             localRepo.add(unrelated);
360             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
361             localRepo.push(unrelatedHash, author.url(), &quot;master&quot;);
362 
363             // Issue a merge command without being a Committer
364             pr.addComment(&quot;/integrate&quot;);
365             TestBotRunner.runPeriodicItems(mergeBot);
366 
367             // The bot should reply that a sponsor is required
368             var sponsor = pr.comments().stream()
369                             .filter(comment -&gt; comment.body().contains(&quot;sponsor&quot;))
370                             .filter(comment -&gt; comment.body().contains(&quot;your change&quot;))
371                             .count();
372             assertEquals(1, sponsor);
373 
374             // Reviewer now agrees to sponsor
375             var reviewerPr = reviewer.pullRequest(pr.id());
376             reviewerPr.addComment(&quot;/sponsor&quot;);
377             TestBotRunner.runPeriodicItems(mergeBot);
378 
379             // The bot should reply with an ok message
380             var pushed = pr.comments().stream()
381                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
382                            .filter(comment -&gt; comment.body().contains(&quot;commit was automatically rebased without conflicts&quot;))
383                            .count();
384             assertEquals(1, pushed);
385 
386             // The change should now be present on the master branch
387             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
388             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
389         }
390     }
391 
392     @Test
393     void noAutoRebase(TestInfo testInfo) throws IOException {
394         try (var credentials = new HostCredentials(testInfo);
395              var tempFolder = new TemporaryDirectory();
396              var pushedFolder = new TemporaryDirectory()) {
397 
398             var author = credentials.getHostedRepository();
399             var integrator = credentials.getHostedRepository();
400             var reviewer = credentials.getHostedRepository();
401             var censusBuilder = credentials.getCensusBuilder()
402                                            .addAuthor(author.forge().currentUser().id())
403                                            .addReviewer(integrator.forge().currentUser().id())
404                                            .addReviewer(reviewer.forge().currentUser().id());
405             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
406 
407             // Populate the projects repository
408             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
409             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
410             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
411             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
412 
413             // Make a change with a corresponding PR
414             var editHash = CheckableRepository.appendAndCommit(localRepo);
415             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
416             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
417 
418             // Approve it as another user
419             var approvalPr = integrator.pullRequest(pr.id());
420             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
421 
422             // Push something unrelated to master
423             localRepo.checkout(masterHash, true);
424             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
425             Files.writeString(unrelated, &quot;Hello&quot;);
426             localRepo.add(unrelated);
427             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
428             localRepo.push(unrelatedHash, author.url(), &quot;master&quot;);
429 
430             // Issue a merge command without being a Committer
431             pr.addComment(&quot;/integrate &quot; + masterHash);
432             TestBotRunner.runPeriodicItems(mergeBot);
433 
434             // The bot should reply with an error message
435             assertLastCommentContains(pr, &quot;the target branch is no longer at the requested hash&quot;);
436 
437             // Now choose the actual hash
438             pr.addComment(&quot;/integrate &quot; + unrelatedHash);
439             TestBotRunner.runPeriodicItems(mergeBot);
440 
441             // The bot should reply that a sponsor is required
442             assertLastCommentContains(pr, &quot;your sponsor will make the final decision onto which target hash to integrate&quot;);
443 
444             // Push more unrelated things
445             Files.writeString(unrelated, &quot;Hello again&quot;);
446             localRepo.add(unrelated);
447             var unrelatedHash2 = localRepo.commit(&quot;Unrelated 2&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
448             localRepo.push(unrelatedHash2, author.url(), &quot;master&quot;);
449 
450             // Reviewer now agrees to sponsor
451             var reviewerPr = reviewer.pullRequest(pr.id());
452             reviewerPr.addComment(&quot;/sponsor &quot; + unrelatedHash);
453             TestBotRunner.runPeriodicItems(mergeBot);
454 
455             // The bot should reply with an error message
456             assertLastCommentContains(pr, &quot;head of the target branch is no longer at the requested hash&quot;);
457 
458             // Use the current hash
459             reviewerPr.addComment(&quot;/sponsor &quot; + unrelatedHash2);
460             TestBotRunner.runPeriodicItems(mergeBot);
461 
462             // The bot should reply with an ok message
463             assertLastCommentContains(pr, &quot;Pushed as commit&quot;);
464 
465             // The change should now be present on the master branch
466             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
467             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
468         }
469     }
470 
471     @Test
472     void sponsorAfterFailingCheck(TestInfo testInfo) throws IOException {
473         try (var credentials = new HostCredentials(testInfo);
474              var tempFolder = new TemporaryDirectory()) {
475             var author = credentials.getHostedRepository();
476             var integrator = credentials.getHostedRepository();
477             var reviewer = credentials.getHostedRepository();
478 
479             var censusBuilder = credentials.getCensusBuilder()
480                                            .addReviewer(reviewer.forge().currentUser().id());
481             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
482 
483             // Populate the projects repository
484             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
485             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
486             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
487             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
488 
489             // Make a change with a corresponding PR
490             var editHash = CheckableRepository.appendAndCommit(localRepo);
491             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
492             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
493 
494             // Approve it as another user
495             var approvalPr = reviewer.pullRequest(pr.id());
496             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
497 
498             // Let the bot see it
499             TestBotRunner.runPeriodicItems(mergeBot);
500 
501             // Flag it as ready for integration
502             pr.addComment(&quot;/integrate&quot;);
503             TestBotRunner.runPeriodicItems(mergeBot);
504 
505             // Bot should have replied
506             var ready = pr.comments().stream()
507                           .filter(comment -&gt; comment.body().contains(&quot;now ready to be sponsored&quot;))
508                           .filter(comment -&gt; comment.body().contains(&quot;at version &quot; + editHash.hex()))
509                           .count();
510             assertEquals(1, ready);
511             assertTrue(pr.labels().contains(&quot;sponsor&quot;));
512 
513             // The reviewer now changes their mind
514             approvalPr.addReview(Review.Verdict.DISAPPROVED, &quot;No wait, disapproved&quot;);
515 
516             // The label should have been dropped
517             TestBotRunner.runPeriodicItems(mergeBot);
518             assertFalse(pr.labels().contains(&quot;sponsor&quot;));
519 
520             // Reviewer now tries to sponsor
521             var reviewerPr = reviewer.pullRequest(pr.id());
522             reviewerPr.addComment(&quot;/sponsor&quot;);
523             TestBotRunner.runPeriodicItems(mergeBot);
524 
525             // The bot should reply with an error message
526             var error = pr.comments().stream()
527                           .filter(comment -&gt; comment.body().contains(&quot;merge request cannot be fulfilled at this time&quot;))
528                           .filter(comment -&gt; comment.body().contains(&quot;failed the final jcheck&quot;))
529                           .count();
530             assertEquals(1, error);
531 
532             // Make it ready for integration again
533             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Sorry, wrong button&quot;);
534             TestBotRunner.runPeriodicItems(mergeBot);
535             assertTrue(pr.labels().contains(&quot;sponsor&quot;));
536 
537             // It should now be possible to sponsor
538             reviewerPr.addComment(&quot;/sponsor&quot;);
539             TestBotRunner.runPeriodicItems(mergeBot);
540             assertFalse(pr.labels().contains(&quot;sponsor&quot;));
541 
542             // The bot should have pushed the commit
543             var pushed = pr.comments().stream()
544                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
545                            .count();
546             assertEquals(1, pushed);
547         }
548     }
549 
550     @Test
551     void cannotRebase(TestInfo testInfo) throws IOException {
552         try (var credentials = new HostCredentials(testInfo);
553              var tempFolder = new TemporaryDirectory()) {
554             var author = credentials.getHostedRepository();
555             var integrator = credentials.getHostedRepository();
556             var reviewer = credentials.getHostedRepository();
557 
558             var censusBuilder = credentials.getCensusBuilder()
559                                            .addReviewer(reviewer.forge().currentUser().id())
560                                            .addAuthor(author.forge().currentUser().id());
561             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
562 
563             // Populate the projects repository
564             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
565             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
566             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
567             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
568 
569             // Make a change with a corresponding PR
570             var editHash = CheckableRepository.appendAndCommit(localRepo);
571             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
572             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
573 
574             // Approve it as another user
575             var approvalPr = reviewer.pullRequest(pr.id());
576             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
577 
578             // Let the bot see it
579             TestBotRunner.runPeriodicItems(mergeBot);
580 
581             // Issue a merge command without being a Committer
582             pr.addComment(&quot;/integrate&quot;);
583             TestBotRunner.runPeriodicItems(mergeBot);
584 
585             // The bot should reply that a sponsor is required
586             var sponsor = pr.comments().stream()
587                             .filter(comment -&gt; comment.body().contains(&quot;sponsor&quot;))
588                             .filter(comment -&gt; comment.body().contains(&quot;your change&quot;))
589                             .count();
590             assertEquals(1, sponsor);
591 
592             // The bot should not have pushed the commit
593             var notPushed = pr.comments().stream()
594                               .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
595                               .count();
596             assertEquals(0, notPushed);
597 
598             // Push something conflicting to master
599             localRepo.checkout(masterHash, true);
600             var conflictingHash = CheckableRepository.appendAndCommit(localRepo, &quot;This looks like a conflict&quot;);
601             localRepo.push(conflictingHash, author.url(), &quot;master&quot;);
602 
603             // Reviewer now agrees to sponsor
604             var reviewerPr = reviewer.pullRequest(pr.id());
605             reviewerPr.addComment(&quot;/sponsor&quot;);
606             TestBotRunner.runPeriodicItems(mergeBot);
607 
608             // The bot should reply with an error message
609             var error = pr.comments().stream()
610                           .filter(comment -&gt; comment.body().contains(&quot;It was not possible to rebase your changes automatically.&quot;))
611                           .filter(comment -&gt; comment.body().contains(&quot;Please merge `master`&quot;))
612                           .count();
613             assertEquals(1, error);
614         }
615     }
616 
617     @Test
618     void sponsorMergeCommit(TestInfo testInfo) throws IOException {
619         try (var credentials = new HostCredentials(testInfo);
620              var tempFolder = new TemporaryDirectory(false)) {
621             var author = credentials.getHostedRepository();
622             var integrator = credentials.getHostedRepository();
623             var reviewer = credentials.getHostedRepository();
624 
625             var reviewerId = reviewer.forge().currentUser().id();
626             var censusBuilder = credentials.getCensusBuilder()
627                                            .addReviewer(reviewerId)
628                                            .addAuthor(author.forge().currentUser().id());
629             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
630 
631             // Populate the projects repository
632             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;local.git&quot;), author.repositoryType());
633             var initialHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
634             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
635             var anotherFile = localRepo.root().resolve(&quot;ANOTHER_FILE.txt&quot;);
636             Files.writeString(anotherFile, &quot;A string\n&quot;);
637             localRepo.add(anotherFile);
638             var masterHash = localRepo.commit(&quot;Another commit\n\nReviewed-by: &quot; + reviewerId, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
639             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
640 
641             // Create a new branch, new commit and publish it
642             var editBranch = localRepo.branch(initialHash, &quot;edit&quot;);
643             localRepo.checkout(editBranch);
644             var editHash = CheckableRepository.appendAndCommit(localRepo);
645             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
646 
647             // Prepare to merge edit into master
648             localRepo.checkout(new Branch(&quot;master&quot;));
649             var editToMasterBranch = localRepo.branch(masterHash, &quot;edit-&gt;master&quot;);
650             localRepo.checkout(editToMasterBranch);
651             localRepo.merge(editHash);
652             var mergeHash = localRepo.commit(&quot;Merge edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
653             localRepo.push(mergeHash, author.url(), &quot;edit-&gt;master&quot;, true);
654 
655 
656             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit-&gt;master&quot;, &quot;Merge edit&quot;);
657 
658             // Approve it as another user
659             var approvalPr = reviewer.pullRequest(pr.id());
660             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
661 
662             // Let the bot see it
663             TestBotRunner.runPeriodicItems(mergeBot);
664 
665             // Issue a merge command without being a Committer
666             pr.addComment(&quot;/integrate&quot;);
667             TestBotRunner.runPeriodicItems(mergeBot);
668 
669             //System.out.println(pr.comments());
670             //for (var entry : pr.checks(pr.headHash()).entrySet()) {
671             //    System.out.println(entry.getValue().summary().orElseThrow());
672             //}
673 
674             // The bot should reply that a sponsor is required
675             var sponsor = pr.comments().stream()
676                             .filter(comment -&gt; comment.body().contains(&quot;sponsor&quot;))
677                             .filter(comment -&gt; comment.body().contains(&quot;your change&quot;))
678                             .count();
679             assertEquals(1, sponsor);
680 
681             // The bot should not have pushed the commit
682             var notPushed = pr.comments().stream()
683                               .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
684                               .count();
685             assertEquals(0, notPushed);
686 
687             // Reviewer now agrees to sponsor
688             var reviewerPr = reviewer.pullRequest(pr.id());
689             reviewerPr.addComment(&quot;/sponsor&quot;);
690             TestBotRunner.runPeriodicItems(mergeBot);
691 
692             // The bot should have pushed the commit
693             var pushed = pr.comments().stream()
694                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
695                            .count();
696             assertEquals(1, pushed);
697 
698             var targetRepo = Repository.clone(author.url(), tempFolder.path().resolve(&quot;target.git&quot;));
699             var masterHead = targetRepo.lookup(new Branch(&quot;origin/master&quot;)).orElseThrow();
700             assertEquals(&quot;Merge edit&quot;, masterHead.message().get(0));
701         }
702     }
703 }
    </pre>
  </body>
</html>