<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.merge;
  24 
  25 import org.openjdk.skara.host.*;
  26 import org.openjdk.skara.test.*;
  27 import org.openjdk.skara.vcs.*;
  28 
  29 import org.junit.jupiter.api.Test;
  30 import org.junit.jupiter.api.TestInfo;
  31 
  32 import java.io.IOException;
  33 import java.nio.file.Files;
  34 import java.nio.file.StandardOpenOption;
  35 import java.util.*;
  36 import java.util.stream.Collectors;
  37 import java.time.DayOfWeek;
  38 import java.time.Month;
  39 import java.time.ZonedDateTime;
  40 import java.time.ZoneId;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MergeBotTests {
  45     @Test
  46     void mergeMasterBranch(TestInfo testInfo) throws IOException {
  47         try (var temp = new TemporaryDirectory(false)) {
  48             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
  49 
  50             var fromDir = temp.path().resolve(&quot;from.git&quot;);
  51             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
  52             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
  53 
  54             var toDir = temp.path().resolve(&quot;to.git&quot;);
  55             var toLocalRepo = Repository.init(toDir, VCS.GIT);
  56             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  57             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  58                         StandardOpenOption.APPEND);
  59             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
  60 
  61             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
  62             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
  63             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  64             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  65                         StandardOpenOption.APPEND);
  66             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
  67 
  68             var now = ZonedDateTime.now();
  69             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
  70             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
  71             fromLocalRepo.add(fromFileA);
  72             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
  73             var fromCommits = fromLocalRepo.commits().asList();
  74             assertEquals(1, fromCommits.size());
  75             assertEquals(fromHashA, fromCommits.get(0).hash());
  76 
  77             var toFileA = toDir.resolve(&quot;a.txt&quot;);
  78             Files.writeString(toFileA, &quot;Hello A\n&quot;);
  79             toLocalRepo.add(toFileA);
  80             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
  81             var toCommits = toLocalRepo.commits().asList();
  82             assertEquals(1, toCommits.size());
  83             assertEquals(toHashA, toCommits.get(0).hash());
  84             assertEquals(fromHashA, toHashA);
  85 
  86             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
  87             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
  88             fromLocalRepo.add(fromFileB);
  89             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
  90 
  91             var toFileC = toDir.resolve(&quot;c.txt&quot;);
  92             Files.writeString(toFileC, &quot;Hello C\n&quot;);
  93             toLocalRepo.add(toFileC);
  94             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
  95 
  96             var storage = temp.path().resolve(&quot;storage&quot;);
  97             var master = new Branch(&quot;master&quot;);
  98             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
  99             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 100             TestBotRunner.runPeriodicItems(bot);
 101 
 102             toCommits = toLocalRepo.commits().asList();
 103             assertEquals(4, toCommits.size());
 104             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 105             assertTrue(hashes.contains(toHashA));
 106             assertTrue(hashes.contains(fromHashB));
 107             assertTrue(hashes.contains(toHashC));
 108 
 109             var known = Set.of(toHashA, fromHashB, toHashC);
 110             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 111             assertTrue(merge.isMerge());
 112             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
 113             assertEquals(&quot;duke&quot;, merge.author().name());
 114             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 115 
 116             assertEquals(0, toHostedRepo.pullRequests().size());
 117         }
 118     }
 119 
 120     @Test
 121     void failingMergeTest(TestInfo testInfo) throws IOException {
 122         try (var temp = new TemporaryDirectory(false)) {
 123             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 124 
 125             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 126             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 127             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 128 
 129             var toDir = temp.path().resolve(&quot;to.git&quot;);
 130             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 131             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 132             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 133                         StandardOpenOption.APPEND);
 134             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 135 
 136             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 137             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 138             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 139             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 140                         StandardOpenOption.APPEND);
 141             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 142 
 143             var now = ZonedDateTime.now();
 144             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 145             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 146             fromLocalRepo.add(fromFileA);
 147             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 148             var fromCommits = fromLocalRepo.commits().asList();
 149             assertEquals(1, fromCommits.size());
 150             assertEquals(fromHashA, fromCommits.get(0).hash());
 151 
 152             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 153             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 154             toLocalRepo.add(toFileA);
 155             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 156             var toCommits = toLocalRepo.commits().asList();
 157             assertEquals(1, toCommits.size());
 158             assertEquals(toHashA, toCommits.get(0).hash());
 159             assertEquals(fromHashA, toHashA);
 160 
 161             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 162             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 163             fromLocalRepo.add(fromFileB);
 164             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 165 
 166             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 167             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 168             toLocalRepo.add(toFileB);
 169             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 170 
 171             var storage = temp.path().resolve(&quot;storage&quot;);
 172             var master = new Branch(&quot;master&quot;);
 173             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 174             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 175             TestBotRunner.runPeriodicItems(bot);
 176 
 177             toCommits = toLocalRepo.commits().asList();
 178             assertEquals(2, toCommits.size());
 179             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 180             assertTrue(toHashes.contains(toHashA));
 181             assertTrue(toHashes.contains(toHashB));
 182 
 183             var pullRequests = toHostedRepo.pullRequests();
 184             assertEquals(1, pullRequests.size());
 185             var pr = pullRequests.get(0);
 186             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 187             assertTrue(pr.labels().contains(&quot;failed-auto-merge&quot;));
 188         }
 189     }
 190 
 191     @Test
 192     void failingMergeShouldResultInOnlyOnePR(TestInfo testInfo) throws IOException {
 193         try (var temp = new TemporaryDirectory(false)) {
 194             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 195 
 196             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 197             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 198             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 199 
 200             var toDir = temp.path().resolve(&quot;to.git&quot;);
 201             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 202             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 203             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 204                         StandardOpenOption.APPEND);
 205             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 206 
 207             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 208             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 209             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 210             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 211                         StandardOpenOption.APPEND);
 212             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 213 
 214             var now = ZonedDateTime.now();
 215             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 216             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 217             fromLocalRepo.add(fromFileA);
 218             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 219             var fromCommits = fromLocalRepo.commits().asList();
 220             assertEquals(1, fromCommits.size());
 221             assertEquals(fromHashA, fromCommits.get(0).hash());
 222 
 223             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 224             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 225             toLocalRepo.add(toFileA);
 226             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 227             var toCommits = toLocalRepo.commits().asList();
 228             assertEquals(1, toCommits.size());
 229             assertEquals(toHashA, toCommits.get(0).hash());
 230             assertEquals(fromHashA, toHashA);
 231 
 232             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 233             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 234             fromLocalRepo.add(fromFileB);
 235             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 236 
 237             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 238             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 239             toLocalRepo.add(toFileB);
 240             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 241 
 242             var storage = temp.path().resolve(&quot;storage&quot;);
 243             var master = new Branch(&quot;master&quot;);
 244             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 245             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 246             TestBotRunner.runPeriodicItems(bot);
 247             TestBotRunner.runPeriodicItems(bot);
 248 
 249             toCommits = toLocalRepo.commits().asList();
 250             assertEquals(2, toCommits.size());
 251             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 252             assertTrue(toHashes.contains(toHashA));
 253             assertTrue(toHashes.contains(toHashB));
 254 
 255             var pullRequests = toHostedRepo.pullRequests();
 256             assertEquals(1, pullRequests.size());
 257             var pr = pullRequests.get(0);
 258             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 259         }
 260     }
 261 
 262     @Test
 263     void resolvedMergeConflictShouldResultInClosedPR(TestInfo testInfo) throws IOException {
 264         try (var temp = new TemporaryDirectory(false)) {
 265             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 266 
 267             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 268             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 269             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 270 
 271             var toDir = temp.path().resolve(&quot;to.git&quot;);
 272             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 273             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 274             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 275                         StandardOpenOption.APPEND);
 276             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 277 
 278             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 279             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 280             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 281             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 282                         StandardOpenOption.APPEND);
 283             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 284 
 285             var now = ZonedDateTime.now();
 286             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 287             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 288             fromLocalRepo.add(fromFileA);
 289             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 290             var fromCommits = fromLocalRepo.commits().asList();
 291             assertEquals(1, fromCommits.size());
 292             assertEquals(fromHashA, fromCommits.get(0).hash());
 293 
 294             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 295             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 296             toLocalRepo.add(toFileA);
 297             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 298             var toCommits = toLocalRepo.commits().asList();
 299             assertEquals(1, toCommits.size());
 300             assertEquals(toHashA, toCommits.get(0).hash());
 301             assertEquals(fromHashA, toHashA);
 302 
 303             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 304             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 305             fromLocalRepo.add(fromFileB);
 306             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 307 
 308             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 309             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 310             toLocalRepo.add(toFileB);
 311             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 312 
 313             var storage = temp.path().resolve(&quot;storage&quot;);
 314             var master = new Branch(&quot;master&quot;);
 315             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 316             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 317             TestBotRunner.runPeriodicItems(bot);
 318             TestBotRunner.runPeriodicItems(bot);
 319 
 320             toCommits = toLocalRepo.commits().asList();
 321             assertEquals(2, toCommits.size());
 322             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 323             assertTrue(toHashes.contains(toHashA));
 324             assertTrue(toHashes.contains(toHashB));
 325 
 326             var pullRequests = toHostedRepo.pullRequests();
 327             assertEquals(1, pullRequests.size());
 328             var pr = pullRequests.get(0);
 329             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 330 
 331             var fetchHead = toLocalRepo.fetch(fromHostedRepo.webUrl(), &quot;master&quot;);
 332             toLocalRepo.merge(fetchHead, &quot;ours&quot;);
 333             toLocalRepo.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 334 
 335             toCommits = toLocalRepo.commits().asList();
 336             assertEquals(4, toCommits.size());
 337 
 338             TestBotRunner.runPeriodicItems(bot);
 339             pullRequests = toHostedRepo.pullRequests();
 340             assertEquals(0, pullRequests.size());
 341         }
 342     }
 343 
 344     @Test
 345     void resolvedMergeConflictAndThenNewConflict(TestInfo testInfo) throws IOException {
 346         try (var temp = new TemporaryDirectory(false)) {
 347             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 348 
 349             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 350             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 351             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 352 
 353             var toDir = temp.path().resolve(&quot;to.git&quot;);
 354             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 355             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 356             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 357                         StandardOpenOption.APPEND);
 358             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 359 
 360             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 361             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 362             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 363             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 364                         StandardOpenOption.APPEND);
 365             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 366 
 367             var now = ZonedDateTime.now();
 368             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 369             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 370             fromLocalRepo.add(fromFileA);
 371             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 372             var fromCommits = fromLocalRepo.commits().asList();
 373             assertEquals(1, fromCommits.size());
 374             assertEquals(fromHashA, fromCommits.get(0).hash());
 375 
 376             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 377             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 378             toLocalRepo.add(toFileA);
 379             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 380             var toCommits = toLocalRepo.commits().asList();
 381             assertEquals(1, toCommits.size());
 382             assertEquals(toHashA, toCommits.get(0).hash());
 383             assertEquals(fromHashA, toHashA);
 384 
 385             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 386             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 387             fromLocalRepo.add(fromFileB);
 388             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 389 
 390             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 391             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 392             toLocalRepo.add(toFileB);
 393             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 394 
 395             var storage = temp.path().resolve(&quot;storage&quot;);
 396             var master = new Branch(&quot;master&quot;);
 397             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 398             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 399             TestBotRunner.runPeriodicItems(bot);
 400             TestBotRunner.runPeriodicItems(bot);
 401 
 402             toCommits = toLocalRepo.commits().asList();
 403             assertEquals(2, toCommits.size());
 404             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 405             assertTrue(toHashes.contains(toHashA));
 406             assertTrue(toHashes.contains(toHashB));
 407 
 408             var pullRequests = toHostedRepo.pullRequests();
 409             assertEquals(1, pullRequests.size());
 410             var pr = pullRequests.get(0);
 411             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 412 
 413             var fetchHead = toLocalRepo.fetch(fromHostedRepo.webUrl(), &quot;master&quot;);
 414             toLocalRepo.merge(fetchHead, &quot;ours&quot;);
 415             toLocalRepo.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 416 
 417             toCommits = toLocalRepo.commits().asList();
 418             assertEquals(4, toCommits.size());
 419 
 420             TestBotRunner.runPeriodicItems(bot);
 421             pullRequests = toHostedRepo.pullRequests();
 422             assertEquals(0, pullRequests.size());
 423 
 424             var fromFileC = fromDir.resolve(&quot;c.txt&quot;);
 425             Files.writeString(fromFileC, &quot;Hello C1\n&quot;);
 426             fromLocalRepo.add(fromFileC);
 427             fromLocalRepo.commit(&quot;Adding c1&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 428 
 429             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 430             Files.writeString(toFileC, &quot;Hello C2\n&quot;);
 431             toLocalRepo.add(toFileC);
 432             toLocalRepo.commit(&quot;Adding c2&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 433 
 434             TestBotRunner.runPeriodicItems(bot);
 435             pullRequests = toHostedRepo.pullRequests();
 436             assertEquals(1, pullRequests.size());
 437             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 438         }
 439     }
 440 
 441     final static class TestClock implements Clock {
 442         ZonedDateTime now;
 443 
 444         TestClock() {
 445             this(null);
 446         }
 447 
 448         TestClock(ZonedDateTime now) {
 449             this.now = now;
 450         }
 451 
 452         @Override
 453         public ZonedDateTime now() {
 454             return now;
 455         }
 456     }
 457 
 458     @Test
 459     void testMergeHourly(TestInfo testInfo) throws IOException {
 460         try (var temp = new TemporaryDirectory(false)) {
 461             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 462 
 463             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 464             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 465             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 466 
 467             var toDir = temp.path().resolve(&quot;to.git&quot;);
 468             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 469             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 470             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 471                         StandardOpenOption.APPEND);
 472             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 473 
 474             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 475             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 476             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 477             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 478                         StandardOpenOption.APPEND);
 479             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 480 
 481             var now = ZonedDateTime.now();
 482             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 483             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 484             fromLocalRepo.add(fromFileA);
 485             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 486             var fromCommits = fromLocalRepo.commits().asList();
 487             assertEquals(1, fromCommits.size());
 488             assertEquals(fromHashA, fromCommits.get(0).hash());
 489 
 490             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 491             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 492             toLocalRepo.add(toFileA);
 493             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 494             var toCommits = toLocalRepo.commits().asList();
 495             assertEquals(1, toCommits.size());
 496             assertEquals(toHashA, toCommits.get(0).hash());
 497             assertEquals(fromHashA, toHashA);
 498 
 499             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 500             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 501             fromLocalRepo.add(fromFileB);
 502             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 503 
 504             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 505             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 506             toLocalRepo.add(toFileC);
 507             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 508 
 509             var storage = temp.path().resolve(&quot;storage&quot;);
 510             var master = new Branch(&quot;master&quot;);
 511 
 512             // Merge only at most once during the first minute every hour
 513             var freq = MergeBot.Spec.Frequency.hourly(1);
 514             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 515 
 516             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 15, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 517             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 518 
 519             TestBotRunner.runPeriodicItems(bot);
 520 
 521             // Ensure nothing has been merged
 522             toCommits = toLocalRepo.commits().asList();
 523             assertEquals(2, toCommits.size());
 524             assertEquals(toHashC, toCommits.get(0).hash());
 525             assertEquals(toHashA, toCommits.get(1).hash());
 526 
 527             // Set the clock to the first minute of the hour
 528             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 529             TestBotRunner.runPeriodicItems(bot);
 530 
 531             // Should have merged
 532             toCommits = toLocalRepo.commits().asList();
 533             assertEquals(4, toCommits.size());
 534             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 535             assertTrue(hashes.contains(toHashA));
 536             assertTrue(hashes.contains(fromHashB));
 537             assertTrue(hashes.contains(toHashC));
 538 
 539             var known = Set.of(toHashA, fromHashB, toHashC);
 540             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 541             assertTrue(merge.isMerge());
 542             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
 543             assertEquals(&quot;duke&quot;, merge.author().name());
 544             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 545 
 546             assertEquals(0, toHostedRepo.pullRequests().size());
 547 
 548             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 549             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 550             fromLocalRepo.add(fromFileD);
 551             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 552 
 553             // Since the time hasn&#39;t changed it should not merge again
 554             TestBotRunner.runPeriodicItems(bot);
 555             toCommits = toLocalRepo.commits().asList();
 556             assertEquals(4, toCommits.size());
 557 
 558             // Move the minutes forward, the bot should not merge
 559             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 560             TestBotRunner.runPeriodicItems(bot);
 561             toCommits = toLocalRepo.commits().asList();
 562             assertEquals(4, toCommits.size());
 563 
 564             // Move the clock forward one hour, the bot should merge
 565             clock.now = ZonedDateTime.of(2020, 1, 23, 16, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 566             TestBotRunner.runPeriodicItems(bot);
 567 
 568             toCommits = toLocalRepo.commits().asList();
 569             assertEquals(6, toCommits.size());
 570         }
 571     }
 572 
 573     @Test
 574     void testMergeDaily(TestInfo testInfo) throws IOException {
 575         try (var temp = new TemporaryDirectory(false)) {
 576             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 577 
 578             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 579             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 580             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 581 
 582             var toDir = temp.path().resolve(&quot;to.git&quot;);
 583             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 584             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 585             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 586                         StandardOpenOption.APPEND);
 587             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
 588 
 589             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 590             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 591             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 592             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 593                         StandardOpenOption.APPEND);
 594             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 595 
 596             var now = ZonedDateTime.now();
 597             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 598             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 599             fromLocalRepo.add(fromFileA);
 600             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 601             var fromCommits = fromLocalRepo.commits().asList();
 602             assertEquals(1, fromCommits.size());
 603             assertEquals(fromHashA, fromCommits.get(0).hash());
 604 
 605             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 606             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 607             toLocalRepo.add(toFileA);
 608             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 609             var toCommits = toLocalRepo.commits().asList();
 610             assertEquals(1, toCommits.size());
 611             assertEquals(toHashA, toCommits.get(0).hash());
 612             assertEquals(fromHashA, toHashA);
 613 
 614             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 615             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 616             fromLocalRepo.add(fromFileB);
 617             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 618 
 619             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 620             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 621             toLocalRepo.add(toFileC);
 622             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 623 
 624             var storage = temp.path().resolve(&quot;storage&quot;);
 625             var master = new Branch(&quot;master&quot;);
 626 
 627             // Merge only at most once during the third hour every day
 628             var freq = MergeBot.Spec.Frequency.daily(3);
 629             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 630 
 631             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 2, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 632             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 633 
 634             TestBotRunner.runPeriodicItems(bot);
 635 
 636             // Ensure nothing has been merged
 637             toCommits = toLocalRepo.commits().asList();
 638             assertEquals(2, toCommits.size());
 639             assertEquals(toHashC, toCommits.get(0).hash());
 640             assertEquals(toHashA, toCommits.get(1).hash());
 641 
 642             // Set the clock to the third hour of the day (minutes should not matter)
 643             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 644             TestBotRunner.runPeriodicItems(bot);
 645 
 646             // Should have merged
 647             toCommits = toLocalRepo.commits().asList();
 648             assertEquals(4, toCommits.size());
 649             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 650             assertTrue(hashes.contains(toHashA));
 651             assertTrue(hashes.contains(fromHashB));
 652             assertTrue(hashes.contains(toHashC));
 653 
 654             var known = Set.of(toHashA, fromHashB, toHashC);
 655             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 656             assertTrue(merge.isMerge());
 657             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
 658             assertEquals(&quot;duke&quot;, merge.author().name());
 659             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 660 
 661             assertEquals(0, toHostedRepo.pullRequests().size());
 662 
 663             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 664             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 665             fromLocalRepo.add(fromFileD);
 666             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 667 
 668             // Since the time hasn&#39;t changed it should not merge
 669             TestBotRunner.runPeriodicItems(bot);
 670             toCommits = toLocalRepo.commits().asList();
 671             assertEquals(4, toCommits.size());
 672 
 673             // Move the minutes forward, the bot should not merge
 674             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 675             TestBotRunner.runPeriodicItems(bot);
 676             toCommits = toLocalRepo.commits().asList();
 677             assertEquals(4, toCommits.size());
 678 
 679             // Move the hours forward, the bot should not merge
 680             clock.now = ZonedDateTime.of(2020, 1, 23, 17, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 681             TestBotRunner.runPeriodicItems(bot);
 682             toCommits = toLocalRepo.commits().asList();
 683             assertEquals(4, toCommits.size());
 684 
 685             // Move the clock forward one day, the bot should merge
 686             clock.now = ZonedDateTime.of(2020, 1, 24, 3, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 687             TestBotRunner.runPeriodicItems(bot);
 688 
 689             toCommits = toLocalRepo.commits().asList();
 690             assertEquals(6, toCommits.size());
 691         }
 692     }
 693 
 694     @Test
 695     void testMergeWeekly(TestInfo testInfo) throws IOException {
 696         try (var temp = new TemporaryDirectory(false)) {
 697             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 698 
 699             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 700             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 701             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 702 
 703             var toDir = temp.path().resolve(&quot;to.git&quot;);
 704             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 705             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 706             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 707                         StandardOpenOption.APPEND);
 708             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 709 
 710             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 711             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 712             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 713             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 714                         StandardOpenOption.APPEND);
 715             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 716 
 717             var now = ZonedDateTime.now();
 718             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 719             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 720             fromLocalRepo.add(fromFileA);
 721             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 722             var fromCommits = fromLocalRepo.commits().asList();
 723             assertEquals(1, fromCommits.size());
 724             assertEquals(fromHashA, fromCommits.get(0).hash());
 725 
 726             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 727             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 728             toLocalRepo.add(toFileA);
 729             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 730             var toCommits = toLocalRepo.commits().asList();
 731             assertEquals(1, toCommits.size());
 732             assertEquals(toHashA, toCommits.get(0).hash());
 733             assertEquals(fromHashA, toHashA);
 734 
 735             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 736             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 737             fromLocalRepo.add(fromFileB);
 738             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 739 
 740             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 741             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 742             toLocalRepo.add(toFileC);
 743             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 744 
 745             var storage = temp.path().resolve(&quot;storage&quot;);
 746             var master = new Branch(&quot;master&quot;);
 747 
 748             // Merge only at most once per week on Friday&#39;s at 12:00
 749             var freq = MergeBot.Spec.Frequency.weekly(DayOfWeek.FRIDAY, 12);
 750             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 751 
 752             var clock = new TestClock(ZonedDateTime.of(2020, 1, 24, 11, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 753             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 754 
 755             TestBotRunner.runPeriodicItems(bot);
 756 
 757             // Ensure nothing has been merged
 758             toCommits = toLocalRepo.commits().asList();
 759             assertEquals(2, toCommits.size());
 760             assertEquals(toHashC, toCommits.get(0).hash());
 761             assertEquals(toHashA, toCommits.get(1).hash());
 762 
 763             // Set the clock to the 12th hour of the day (minutes should not matter)
 764             clock.now = ZonedDateTime.of(2020, 1, 24, 12, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 765             TestBotRunner.runPeriodicItems(bot);
 766 
 767             // Should have merged
 768             toCommits = toLocalRepo.commits().asList();
 769             assertEquals(4, toCommits.size());
 770             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 771             assertTrue(hashes.contains(toHashA));
 772             assertTrue(hashes.contains(fromHashB));
 773             assertTrue(hashes.contains(toHashC));
 774 
 775             var known = Set.of(toHashA, fromHashB, toHashC);
 776             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 777             assertTrue(merge.isMerge());
 778             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
 779             assertEquals(&quot;duke&quot;, merge.author().name());
 780             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 781 
 782             assertEquals(0, toHostedRepo.pullRequests().size());
 783 
 784             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 785             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 786             fromLocalRepo.add(fromFileD);
 787             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 788 
 789             // Since the time hasn&#39;t changed it should not merge
 790             TestBotRunner.runPeriodicItems(bot);
 791             toCommits = toLocalRepo.commits().asList();
 792             assertEquals(4, toCommits.size());
 793 
 794             // Move the hours forward, the bot should not merge
 795             clock.now = ZonedDateTime.of(2020, 1, 24, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 796             TestBotRunner.runPeriodicItems(bot);
 797             toCommits = toLocalRepo.commits().asList();
 798             assertEquals(4, toCommits.size());
 799 
 800             // Move the days forward, the bot should not merge
 801             clock.now = ZonedDateTime.of(2020, 1, 25, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 802             TestBotRunner.runPeriodicItems(bot);
 803             toCommits = toLocalRepo.commits().asList();
 804             assertEquals(4, toCommits.size());
 805 
 806             // Move the clock forward one week, the bot should merge
 807             clock.now = ZonedDateTime.of(2020, 1, 31, 12, 29, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 808             TestBotRunner.runPeriodicItems(bot);
 809 
 810             toCommits = toLocalRepo.commits().asList();
 811             assertEquals(6, toCommits.size());
 812         }
 813     }
 814 
 815     @Test
 816     void testMergeMonthly(TestInfo testInfo) throws IOException {
 817         try (var temp = new TemporaryDirectory(false)) {
 818             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 819 
 820             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 821             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 822             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 823 
 824             var toDir = temp.path().resolve(&quot;to.git&quot;);
 825             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 826             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 827             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 828                         StandardOpenOption.APPEND);
 829             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
 830 
 831             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 832             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 833             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 834             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 835                         StandardOpenOption.APPEND);
 836             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 837 
 838             var now = ZonedDateTime.now();
 839             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 840             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 841             fromLocalRepo.add(fromFileA);
 842             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 843             var fromCommits = fromLocalRepo.commits().asList();
 844             assertEquals(1, fromCommits.size());
 845             assertEquals(fromHashA, fromCommits.get(0).hash());
 846 
 847             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 848             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 849             toLocalRepo.add(toFileA);
 850             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 851             var toCommits = toLocalRepo.commits().asList();
 852             assertEquals(1, toCommits.size());
 853             assertEquals(toHashA, toCommits.get(0).hash());
 854             assertEquals(fromHashA, toHashA);
 855 
 856             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 857             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 858             fromLocalRepo.add(fromFileB);
 859             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 860 
 861             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 862             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 863             toLocalRepo.add(toFileC);
 864             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 865 
 866             var storage = temp.path().resolve(&quot;storage&quot;);
 867             var master = new Branch(&quot;master&quot;);
 868 
 869             // Merge only at most once per month on the 17th day at at 11:00
 870             var freq = MergeBot.Spec.Frequency.monthly(17, 11);
 871             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 872 
 873             var clock = new TestClock(ZonedDateTime.of(2020, 1, 16, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 874             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 875 
 876             TestBotRunner.runPeriodicItems(bot);
 877 
 878             // Ensure nothing has been merged
 879             toCommits = toLocalRepo.commits().asList();
 880             assertEquals(2, toCommits.size());
 881             assertEquals(toHashC, toCommits.get(0).hash());
 882             assertEquals(toHashA, toCommits.get(1).hash());
 883 
 884             // Set the clock to the 17th day and at hour 11 (minutes should not matter)
 885             clock.now = ZonedDateTime.of(2020, 1, 17, 11, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 886             TestBotRunner.runPeriodicItems(bot);
 887 
 888             // Should have merged
 889             toCommits = toLocalRepo.commits().asList();
 890             assertEquals(4, toCommits.size());
 891             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 892             assertTrue(hashes.contains(toHashA));
 893             assertTrue(hashes.contains(fromHashB));
 894             assertTrue(hashes.contains(toHashC));
 895 
 896             var known = Set.of(toHashA, fromHashB, toHashC);
 897             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 898             assertTrue(merge.isMerge());
 899             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
 900             assertEquals(&quot;duke&quot;, merge.author().name());
 901             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 902 
 903             assertEquals(0, toHostedRepo.pullRequests().size());
 904 
 905             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 906             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 907             fromLocalRepo.add(fromFileD);
 908             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 909 
 910             // Since the time hasn&#39;t changed it should not merge
 911             TestBotRunner.runPeriodicItems(bot);
 912             toCommits = toLocalRepo.commits().asList();
 913             assertEquals(4, toCommits.size());
 914 
 915             // Move the hours forward, the bot should not merge
 916             clock.now = ZonedDateTime.of(2020, 1, 17, 12, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 917             TestBotRunner.runPeriodicItems(bot);
 918             toCommits = toLocalRepo.commits().asList();
 919             assertEquals(4, toCommits.size());
 920 
 921             // Move the days forward, the bot should not merge
 922             clock.now = ZonedDateTime.of(2020, 1, 18, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 923             TestBotRunner.runPeriodicItems(bot);
 924             toCommits = toLocalRepo.commits().asList();
 925             assertEquals(4, toCommits.size());
 926 
 927             // Move the clock forward one month, the bot should merge
 928             clock.now = ZonedDateTime.of(2020, 2, 17, 11, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 929             TestBotRunner.runPeriodicItems(bot);
 930 
 931             toCommits = toLocalRepo.commits().asList();
 932             assertEquals(6, toCommits.size());
 933         }
 934     }
 935 
 936     @Test
 937     void testMergeYearly(TestInfo testInfo) throws IOException {
 938         try (var temp = new TemporaryDirectory(false)) {
 939             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 940 
 941             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 942             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 943             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 944 
 945             var toDir = temp.path().resolve(&quot;to.git&quot;);
 946             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 947             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 948             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 949                         StandardOpenOption.APPEND);
 950             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
 951 
 952             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 953             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 954             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 955             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 956                         StandardOpenOption.APPEND);
 957             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 958 
 959             var now = ZonedDateTime.now();
 960             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 961             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 962             fromLocalRepo.add(fromFileA);
 963             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 964             var fromCommits = fromLocalRepo.commits().asList();
 965             assertEquals(1, fromCommits.size());
 966             assertEquals(fromHashA, fromCommits.get(0).hash());
 967 
 968             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 969             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 970             toLocalRepo.add(toFileA);
 971             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 972             var toCommits = toLocalRepo.commits().asList();
 973             assertEquals(1, toCommits.size());
 974             assertEquals(toHashA, toCommits.get(0).hash());
 975             assertEquals(fromHashA, toHashA);
 976 
 977             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 978             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 979             fromLocalRepo.add(fromFileB);
 980             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 981 
 982             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 983             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 984             toLocalRepo.add(toFileC);
 985             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 986 
 987             var storage = temp.path().resolve(&quot;storage&quot;);
 988             var master = new Branch(&quot;master&quot;);
 989 
 990             // Merge only at most once per year on the 29th day of May at at 07:00
 991             var freq = MergeBot.Spec.Frequency.yearly(Month.MAY, 29, 07);
 992             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 993 
 994             var clock = new TestClock(ZonedDateTime.of(2020, 5, 27, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 995             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 996 
 997             TestBotRunner.runPeriodicItems(bot);
 998 
 999             // Ensure nothing has been merged
1000             toCommits = toLocalRepo.commits().asList();
1001             assertEquals(2, toCommits.size());
1002             assertEquals(toHashC, toCommits.get(0).hash());
1003             assertEquals(toHashA, toCommits.get(1).hash());
1004 
1005             // Set the clock to the 29th of May and at hour 11 (minutes should not matter)
1006             clock.now = ZonedDateTime.of(2020, 5, 29, 7, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1007             TestBotRunner.runPeriodicItems(bot);
1008 
1009             // Should have merged
1010             toCommits = toLocalRepo.commits().asList();
1011             assertEquals(4, toCommits.size());
1012             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
1013             assertTrue(hashes.contains(toHashA));
1014             assertTrue(hashes.contains(fromHashB));
1015             assertTrue(hashes.contains(toHashC));
1016 
1017             var known = Set.of(toHashA, fromHashB, toHashC);
1018             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
1019             assertTrue(merge.isMerge());
1020             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
1021             assertEquals(&quot;duke&quot;, merge.author().name());
1022             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
1023 
1024             assertEquals(0, toHostedRepo.pullRequests().size());
1025 
1026             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
1027             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
1028             fromLocalRepo.add(fromFileD);
1029             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1030 
1031             // Since the time hasn&#39;t changed it should not merge again
1032             TestBotRunner.runPeriodicItems(bot);
1033             toCommits = toLocalRepo.commits().asList();
1034             assertEquals(4, toCommits.size());
1035 
1036             // Move the hours forward, the bot should not merge
1037             clock.now = ZonedDateTime.of(2020, 5, 29, 8, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1038             TestBotRunner.runPeriodicItems(bot);
1039             toCommits = toLocalRepo.commits().asList();
1040             assertEquals(4, toCommits.size());
1041 
1042             // Move the days forward, the bot should not merge
1043             clock.now = ZonedDateTime.of(2020, 5, 30, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1044             TestBotRunner.runPeriodicItems(bot);
1045             toCommits = toLocalRepo.commits().asList();
1046             assertEquals(4, toCommits.size());
1047 
1048             // Move the months forward, the bot should not merge
1049             clock.now = ZonedDateTime.of(2020, 7, 29, 7, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1050             TestBotRunner.runPeriodicItems(bot);
1051             toCommits = toLocalRepo.commits().asList();
1052             assertEquals(4, toCommits.size());
1053 
1054             // Move the clock forward one year, the bot should merge
1055             clock.now = ZonedDateTime.of(2021, 5, 29, 7, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1056             TestBotRunner.runPeriodicItems(bot);
1057 
1058             toCommits = toLocalRepo.commits().asList();
1059             assertEquals(6, toCommits.size());
1060         }
1061     }
1062 }
    </pre>
  </body>
</html>