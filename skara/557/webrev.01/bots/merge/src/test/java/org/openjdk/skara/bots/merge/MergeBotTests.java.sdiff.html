<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/merge/MergeBot.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  27 import org.openjdk.skara.vcs.*;
  28 
  29 import org.junit.jupiter.api.Test;
  30 import org.junit.jupiter.api.TestInfo;
  31 
  32 import java.io.IOException;
  33 import java.nio.file.Files;
  34 import java.nio.file.StandardOpenOption;
  35 import java.util.*;
  36 import java.util.stream.Collectors;
  37 import java.time.DayOfWeek;
  38 import java.time.Month;
  39 import java.time.ZonedDateTime;
  40 import java.time.ZoneId;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MergeBotTests {
  45     @Test
  46     void mergeMasterBranch(TestInfo testInfo) throws IOException {
<span class="line-modified">  47         try (var temp = new TemporaryDirectory(false)) {</span>
  48             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
  49 
  50             var fromDir = temp.path().resolve(&quot;from.git&quot;);
  51             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
  52             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
  53 
  54             var toDir = temp.path().resolve(&quot;to.git&quot;);
  55             var toLocalRepo = Repository.init(toDir, VCS.GIT);
  56             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  57             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  58                         StandardOpenOption.APPEND);
  59             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
  60 
  61             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
  62             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
  63             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  64             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  65                         StandardOpenOption.APPEND);
  66             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
  67 
</pre>
<hr />
<pre>
 102             toCommits = toLocalRepo.commits().asList();
 103             assertEquals(4, toCommits.size());
 104             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 105             assertTrue(hashes.contains(toHashA));
 106             assertTrue(hashes.contains(fromHashB));
 107             assertTrue(hashes.contains(toHashC));
 108 
 109             var known = Set.of(toHashA, fromHashB, toHashC);
 110             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 111             assertTrue(merge.isMerge());
 112             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
 113             assertEquals(&quot;duke&quot;, merge.author().name());
 114             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 115 
 116             assertEquals(0, toHostedRepo.pullRequests().size());
 117         }
 118     }
 119 
 120     @Test
 121     void failingMergeTest(TestInfo testInfo) throws IOException {
<span class="line-modified"> 122         try (var temp = new TemporaryDirectory(false)) {</span>
 123             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 124 
 125             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 126             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 127             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 128 
 129             var toDir = temp.path().resolve(&quot;to.git&quot;);
 130             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 131             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 132             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 133                         StandardOpenOption.APPEND);
 134             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 135 
 136             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 137             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 138             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 139             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 140                         StandardOpenOption.APPEND);
 141             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 142 
</pre>
<hr />
<pre>
 166             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 167             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 168             toLocalRepo.add(toFileB);
 169             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 170 
 171             var storage = temp.path().resolve(&quot;storage&quot;);
 172             var master = new Branch(&quot;master&quot;);
 173             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 174             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 175             TestBotRunner.runPeriodicItems(bot);
 176 
 177             toCommits = toLocalRepo.commits().asList();
 178             assertEquals(2, toCommits.size());
 179             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 180             assertTrue(toHashes.contains(toHashA));
 181             assertTrue(toHashes.contains(toHashB));
 182 
 183             var pullRequests = toHostedRepo.pullRequests();
 184             assertEquals(1, pullRequests.size());
 185             var pr = pullRequests.get(0);
<span class="line-modified"> 186             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());</span>
 187             assertTrue(pr.labels().contains(&quot;failed-auto-merge&quot;));
 188         }
 189     }
 190 
 191     @Test
 192     void failingMergeShouldResultInOnlyOnePR(TestInfo testInfo) throws IOException {
<span class="line-modified"> 193         try (var temp = new TemporaryDirectory(false)) {</span>
 194             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 195 
 196             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 197             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 198             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 199 
 200             var toDir = temp.path().resolve(&quot;to.git&quot;);
 201             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 202             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 203             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 204                         StandardOpenOption.APPEND);
 205             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 206 
 207             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 208             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 209             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 210             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 211                         StandardOpenOption.APPEND);
 212             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 213 
</pre>
<hr />
<pre>
 238             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 239             toLocalRepo.add(toFileB);
 240             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 241 
 242             var storage = temp.path().resolve(&quot;storage&quot;);
 243             var master = new Branch(&quot;master&quot;);
 244             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 245             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 246             TestBotRunner.runPeriodicItems(bot);
 247             TestBotRunner.runPeriodicItems(bot);
 248 
 249             toCommits = toLocalRepo.commits().asList();
 250             assertEquals(2, toCommits.size());
 251             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 252             assertTrue(toHashes.contains(toHashA));
 253             assertTrue(toHashes.contains(toHashB));
 254 
 255             var pullRequests = toHostedRepo.pullRequests();
 256             assertEquals(1, pullRequests.size());
 257             var pr = pullRequests.get(0);
<span class="line-modified"> 258             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());</span>
 259         }
 260     }
 261 
 262     @Test
<span class="line-modified"> 263     void resolvedMergeConflictShouldResultInClosedPR(TestInfo testInfo) throws IOException {</span>
<span class="line-modified"> 264         try (var temp = new TemporaryDirectory(false)) {</span>
 265             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 266 
 267             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 268             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 269             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 270 
 271             var toDir = temp.path().resolve(&quot;to.git&quot;);
 272             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 273             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 274             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 275                         StandardOpenOption.APPEND);
 276             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 277 
 278             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 279             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 280             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 281             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 282                         StandardOpenOption.APPEND);
 283             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 284 
</pre>
<hr />
<pre>
 309             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 310             toLocalRepo.add(toFileB);
 311             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 312 
 313             var storage = temp.path().resolve(&quot;storage&quot;);
 314             var master = new Branch(&quot;master&quot;);
 315             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 316             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 317             TestBotRunner.runPeriodicItems(bot);
 318             TestBotRunner.runPeriodicItems(bot);
 319 
 320             toCommits = toLocalRepo.commits().asList();
 321             assertEquals(2, toCommits.size());
 322             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 323             assertTrue(toHashes.contains(toHashA));
 324             assertTrue(toHashes.contains(toHashB));
 325 
 326             var pullRequests = toHostedRepo.pullRequests();
 327             assertEquals(1, pullRequests.size());
 328             var pr = pullRequests.get(0);
<span class="line-modified"> 329             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());</span>
<span class="line-modified"> 330 </span>
<span class="line-modified"> 331             var fetchHead = toLocalRepo.fetch(fromHostedRepo.webUrl(), &quot;master&quot;);</span>
<span class="line-modified"> 332             toLocalRepo.merge(fetchHead, &quot;ours&quot;);</span>
<span class="line-removed"> 333             toLocalRepo.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-removed"> 334 </span>
<span class="line-removed"> 335             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-removed"> 336             assertEquals(4, toCommits.size());</span>
 337 

 338             TestBotRunner.runPeriodicItems(bot);
 339             pullRequests = toHostedRepo.pullRequests();
<span class="line-removed"> 340             assertEquals(0, pullRequests.size());</span>
<span class="line-removed"> 341         }</span>
<span class="line-removed"> 342     }</span>
<span class="line-removed"> 343 </span>
<span class="line-removed"> 344     @Test</span>
<span class="line-removed"> 345     void resolvedMergeConflictAndThenNewConflict(TestInfo testInfo) throws IOException {</span>
<span class="line-removed"> 346         try (var temp = new TemporaryDirectory(false)) {</span>
<span class="line-removed"> 347             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="line-removed"> 348 </span>
<span class="line-removed"> 349             var fromDir = temp.path().resolve(&quot;from.git&quot;);</span>
<span class="line-removed"> 350             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);</span>
<span class="line-removed"> 351             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);</span>
<span class="line-removed"> 352 </span>
<span class="line-removed"> 353             var toDir = temp.path().resolve(&quot;to.git&quot;);</span>
<span class="line-removed"> 354             var toLocalRepo = Repository.init(toDir, VCS.GIT);</span>
<span class="line-removed"> 355             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-removed"> 356             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-removed"> 357                         StandardOpenOption.APPEND);</span>
<span class="line-removed"> 358             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);</span>
<span class="line-removed"> 359 </span>
<span class="line-removed"> 360             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="line-removed"> 361             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="line-removed"> 362             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-removed"> 363             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-removed"> 364                         StandardOpenOption.APPEND);</span>
<span class="line-removed"> 365             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="line-removed"> 366 </span>
<span class="line-removed"> 367             var now = ZonedDateTime.now();</span>
<span class="line-removed"> 368             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-removed"> 369             Files.writeString(fromFileA, &quot;Hello A\n&quot;);</span>
<span class="line-removed"> 370             fromLocalRepo.add(fromFileA);</span>
<span class="line-removed"> 371             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-removed"> 372             var fromCommits = fromLocalRepo.commits().asList();</span>
<span class="line-removed"> 373             assertEquals(1, fromCommits.size());</span>
<span class="line-removed"> 374             assertEquals(fromHashA, fromCommits.get(0).hash());</span>
<span class="line-removed"> 375 </span>
<span class="line-removed"> 376             var toFileA = toDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-removed"> 377             Files.writeString(toFileA, &quot;Hello A\n&quot;);</span>
<span class="line-removed"> 378             toLocalRepo.add(toFileA);</span>
<span class="line-removed"> 379             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-removed"> 380             var toCommits = toLocalRepo.commits().asList();</span>
<span class="line-removed"> 381             assertEquals(1, toCommits.size());</span>
<span class="line-removed"> 382             assertEquals(toHashA, toCommits.get(0).hash());</span>
<span class="line-removed"> 383             assertEquals(fromHashA, toHashA);</span>
<span class="line-removed"> 384 </span>
<span class="line-removed"> 385             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);</span>
<span class="line-removed"> 386             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);</span>
<span class="line-removed"> 387             fromLocalRepo.add(fromFileB);</span>
<span class="line-removed"> 388             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-removed"> 389 </span>
<span class="line-removed"> 390             var toFileB = toDir.resolve(&quot;b.txt&quot;);</span>
<span class="line-removed"> 391             Files.writeString(toFileB, &quot;Hello B2\n&quot;);</span>
<span class="line-removed"> 392             toLocalRepo.add(toFileB);</span>
<span class="line-removed"> 393             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-removed"> 394 </span>
<span class="line-removed"> 395             var storage = temp.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed"> 396             var master = new Branch(&quot;master&quot;);</span>
<span class="line-removed"> 397             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));</span>
<span class="line-removed"> 398             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);</span>
<span class="line-removed"> 399             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-removed"> 400             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-removed"> 401 </span>
<span class="line-removed"> 402             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-removed"> 403             assertEquals(2, toCommits.size());</span>
<span class="line-removed"> 404             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());</span>
<span class="line-removed"> 405             assertTrue(toHashes.contains(toHashA));</span>
<span class="line-removed"> 406             assertTrue(toHashes.contains(toHashB));</span>
<span class="line-removed"> 407 </span>
<span class="line-removed"> 408             var pullRequests = toHostedRepo.pullRequests();</span>
 409             assertEquals(1, pullRequests.size());
<span class="line-modified"> 410             var pr = pullRequests.get(0);</span>
<span class="line-removed"> 411             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());</span>
<span class="line-removed"> 412 </span>
<span class="line-removed"> 413             var fetchHead = toLocalRepo.fetch(fromHostedRepo.webUrl(), &quot;master&quot;);</span>
<span class="line-removed"> 414             toLocalRepo.merge(fetchHead, &quot;ours&quot;);</span>
<span class="line-removed"> 415             toLocalRepo.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-removed"> 416 </span>
<span class="line-removed"> 417             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-removed"> 418             assertEquals(4, toCommits.size());</span>
 419 


 420             TestBotRunner.runPeriodicItems(bot);
 421             pullRequests = toHostedRepo.pullRequests();
<span class="line-modified"> 422             assertEquals(0, pullRequests.size());</span>
<span class="line-removed"> 423 </span>
<span class="line-removed"> 424             var fromFileC = fromDir.resolve(&quot;c.txt&quot;);</span>
<span class="line-removed"> 425             Files.writeString(fromFileC, &quot;Hello C1\n&quot;);</span>
<span class="line-removed"> 426             fromLocalRepo.add(fromFileC);</span>
<span class="line-removed"> 427             fromLocalRepo.commit(&quot;Adding c1&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
 428 
<span class="line-modified"> 429             var toFileC = toDir.resolve(&quot;c.txt&quot;);</span>
<span class="line-modified"> 430             Files.writeString(toFileC, &quot;Hello C2\n&quot;);</span>
<span class="line-modified"> 431             toLocalRepo.add(toFileC);</span>
<span class="line-modified"> 432             toLocalRepo.commit(&quot;Adding c2&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
 433 

 434             TestBotRunner.runPeriodicItems(bot);
<span class="line-modified"> 435             pullRequests = toHostedRepo.pullRequests();</span>
<span class="line-removed"> 436             assertEquals(1, pullRequests.size());</span>
<span class="line-removed"> 437             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());</span>
 438         }
 439     }
 440 
 441     final static class TestClock implements Clock {
 442         ZonedDateTime now;
 443 
 444         TestClock() {
 445             this(null);
 446         }
 447 
 448         TestClock(ZonedDateTime now) {
 449             this.now = now;
 450         }
 451 
 452         @Override
 453         public ZonedDateTime now() {
 454             return now;
 455         }
 456     }
 457 
 458     @Test
 459     void testMergeHourly(TestInfo testInfo) throws IOException {
<span class="line-modified"> 460         try (var temp = new TemporaryDirectory(false)) {</span>
 461             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 462 
 463             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 464             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 465             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 466 
 467             var toDir = temp.path().resolve(&quot;to.git&quot;);
 468             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 469             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 470             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 471                         StandardOpenOption.APPEND);
 472             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 473 
 474             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 475             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 476             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 477             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 478                         StandardOpenOption.APPEND);
 479             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 480 
</pre>
<hr />
<pre>
 555             toCommits = toLocalRepo.commits().asList();
 556             assertEquals(4, toCommits.size());
 557 
 558             // Move the minutes forward, the bot should not merge
 559             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 560             TestBotRunner.runPeriodicItems(bot);
 561             toCommits = toLocalRepo.commits().asList();
 562             assertEquals(4, toCommits.size());
 563 
 564             // Move the clock forward one hour, the bot should merge
 565             clock.now = ZonedDateTime.of(2020, 1, 23, 16, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 566             TestBotRunner.runPeriodicItems(bot);
 567 
 568             toCommits = toLocalRepo.commits().asList();
 569             assertEquals(6, toCommits.size());
 570         }
 571     }
 572 
 573     @Test
 574     void testMergeDaily(TestInfo testInfo) throws IOException {
<span class="line-modified"> 575         try (var temp = new TemporaryDirectory(false)) {</span>
 576             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 577 
 578             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 579             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 580             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 581 
 582             var toDir = temp.path().resolve(&quot;to.git&quot;);
 583             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 584             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 585             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 586                         StandardOpenOption.APPEND);
 587             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
 588 
 589             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 590             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 591             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 592             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 593                         StandardOpenOption.APPEND);
 594             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 595 
</pre>
<hr />
<pre>
 676             toCommits = toLocalRepo.commits().asList();
 677             assertEquals(4, toCommits.size());
 678 
 679             // Move the hours forward, the bot should not merge
 680             clock.now = ZonedDateTime.of(2020, 1, 23, 17, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 681             TestBotRunner.runPeriodicItems(bot);
 682             toCommits = toLocalRepo.commits().asList();
 683             assertEquals(4, toCommits.size());
 684 
 685             // Move the clock forward one day, the bot should merge
 686             clock.now = ZonedDateTime.of(2020, 1, 24, 3, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 687             TestBotRunner.runPeriodicItems(bot);
 688 
 689             toCommits = toLocalRepo.commits().asList();
 690             assertEquals(6, toCommits.size());
 691         }
 692     }
 693 
 694     @Test
 695     void testMergeWeekly(TestInfo testInfo) throws IOException {
<span class="line-modified"> 696         try (var temp = new TemporaryDirectory(false)) {</span>
 697             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 698 
 699             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 700             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 701             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 702 
 703             var toDir = temp.path().resolve(&quot;to.git&quot;);
 704             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 705             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 706             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 707                         StandardOpenOption.APPEND);
 708             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 709 
 710             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 711             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 712             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 713             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 714                         StandardOpenOption.APPEND);
 715             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 716 
</pre>
<hr />
<pre>
 797             toCommits = toLocalRepo.commits().asList();
 798             assertEquals(4, toCommits.size());
 799 
 800             // Move the days forward, the bot should not merge
 801             clock.now = ZonedDateTime.of(2020, 1, 25, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 802             TestBotRunner.runPeriodicItems(bot);
 803             toCommits = toLocalRepo.commits().asList();
 804             assertEquals(4, toCommits.size());
 805 
 806             // Move the clock forward one week, the bot should merge
 807             clock.now = ZonedDateTime.of(2020, 1, 31, 12, 29, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 808             TestBotRunner.runPeriodicItems(bot);
 809 
 810             toCommits = toLocalRepo.commits().asList();
 811             assertEquals(6, toCommits.size());
 812         }
 813     }
 814 
 815     @Test
 816     void testMergeMonthly(TestInfo testInfo) throws IOException {
<span class="line-modified"> 817         try (var temp = new TemporaryDirectory(false)) {</span>
 818             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 819 
 820             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 821             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 822             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 823 
 824             var toDir = temp.path().resolve(&quot;to.git&quot;);
 825             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 826             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 827             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 828                         StandardOpenOption.APPEND);
 829             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
 830 
 831             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 832             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 833             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 834             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 835                         StandardOpenOption.APPEND);
 836             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 837 
</pre>
<hr />
<pre>
 918             toCommits = toLocalRepo.commits().asList();
 919             assertEquals(4, toCommits.size());
 920 
 921             // Move the days forward, the bot should not merge
 922             clock.now = ZonedDateTime.of(2020, 1, 18, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 923             TestBotRunner.runPeriodicItems(bot);
 924             toCommits = toLocalRepo.commits().asList();
 925             assertEquals(4, toCommits.size());
 926 
 927             // Move the clock forward one month, the bot should merge
 928             clock.now = ZonedDateTime.of(2020, 2, 17, 11, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 929             TestBotRunner.runPeriodicItems(bot);
 930 
 931             toCommits = toLocalRepo.commits().asList();
 932             assertEquals(6, toCommits.size());
 933         }
 934     }
 935 
 936     @Test
 937     void testMergeYearly(TestInfo testInfo) throws IOException {
<span class="line-modified"> 938         try (var temp = new TemporaryDirectory(false)) {</span>
 939             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 940 
 941             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 942             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 943             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 944 
 945             var toDir = temp.path().resolve(&quot;to.git&quot;);
 946             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 947             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 948             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 949                         StandardOpenOption.APPEND);
 950             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
 951 
 952             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 953             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 954             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 955             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 956                         StandardOpenOption.APPEND);
 957             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 958 
</pre>
</td>
<td>
<hr />
<pre>
  27 import org.openjdk.skara.vcs.*;
  28 
  29 import org.junit.jupiter.api.Test;
  30 import org.junit.jupiter.api.TestInfo;
  31 
  32 import java.io.IOException;
  33 import java.nio.file.Files;
  34 import java.nio.file.StandardOpenOption;
  35 import java.util.*;
  36 import java.util.stream.Collectors;
  37 import java.time.DayOfWeek;
  38 import java.time.Month;
  39 import java.time.ZonedDateTime;
  40 import java.time.ZoneId;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MergeBotTests {
  45     @Test
  46     void mergeMasterBranch(TestInfo testInfo) throws IOException {
<span class="line-modified">  47         try (var temp = new TemporaryDirectory()) {</span>
  48             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
  49 
  50             var fromDir = temp.path().resolve(&quot;from.git&quot;);
  51             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
  52             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
  53 
  54             var toDir = temp.path().resolve(&quot;to.git&quot;);
  55             var toLocalRepo = Repository.init(toDir, VCS.GIT);
  56             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  57             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  58                         StandardOpenOption.APPEND);
  59             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
  60 
  61             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
  62             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
  63             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  64             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  65                         StandardOpenOption.APPEND);
  66             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
  67 
</pre>
<hr />
<pre>
 102             toCommits = toLocalRepo.commits().asList();
 103             assertEquals(4, toCommits.size());
 104             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 105             assertTrue(hashes.contains(toHashA));
 106             assertTrue(hashes.contains(fromHashB));
 107             assertTrue(hashes.contains(toHashC));
 108 
 109             var known = Set.of(toHashA, fromHashB, toHashC);
 110             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 111             assertTrue(merge.isMerge());
 112             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
 113             assertEquals(&quot;duke&quot;, merge.author().name());
 114             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 115 
 116             assertEquals(0, toHostedRepo.pullRequests().size());
 117         }
 118     }
 119 
 120     @Test
 121     void failingMergeTest(TestInfo testInfo) throws IOException {
<span class="line-modified"> 122         try (var temp = new TemporaryDirectory()) {</span>
 123             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 124 
 125             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 126             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 127             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 128 
 129             var toDir = temp.path().resolve(&quot;to.git&quot;);
 130             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 131             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 132             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 133                         StandardOpenOption.APPEND);
 134             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 135 
 136             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 137             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 138             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 139             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 140                         StandardOpenOption.APPEND);
 141             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 142 
</pre>
<hr />
<pre>
 166             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 167             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 168             toLocalRepo.add(toFileB);
 169             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 170 
 171             var storage = temp.path().resolve(&quot;storage&quot;);
 172             var master = new Branch(&quot;master&quot;);
 173             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 174             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 175             TestBotRunner.runPeriodicItems(bot);
 176 
 177             toCommits = toLocalRepo.commits().asList();
 178             assertEquals(2, toCommits.size());
 179             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 180             assertTrue(toHashes.contains(toHashA));
 181             assertTrue(toHashes.contains(toHashB));
 182 
 183             var pullRequests = toHostedRepo.pullRequests();
 184             assertEquals(1, pullRequests.size());
 185             var pr = pullRequests.get(0);
<span class="line-modified"> 186             assertEquals(&quot;Merge test:master&quot;, pr.title());</span>
 187             assertTrue(pr.labels().contains(&quot;failed-auto-merge&quot;));
 188         }
 189     }
 190 
 191     @Test
 192     void failingMergeShouldResultInOnlyOnePR(TestInfo testInfo) throws IOException {
<span class="line-modified"> 193         try (var temp = new TemporaryDirectory()) {</span>
 194             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 195 
 196             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 197             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 198             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 199 
 200             var toDir = temp.path().resolve(&quot;to.git&quot;);
 201             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 202             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 203             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 204                         StandardOpenOption.APPEND);
 205             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 206 
 207             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 208             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 209             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 210             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 211                         StandardOpenOption.APPEND);
 212             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 213 
</pre>
<hr />
<pre>
 238             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 239             toLocalRepo.add(toFileB);
 240             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 241 
 242             var storage = temp.path().resolve(&quot;storage&quot;);
 243             var master = new Branch(&quot;master&quot;);
 244             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 245             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 246             TestBotRunner.runPeriodicItems(bot);
 247             TestBotRunner.runPeriodicItems(bot);
 248 
 249             toCommits = toLocalRepo.commits().asList();
 250             assertEquals(2, toCommits.size());
 251             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 252             assertTrue(toHashes.contains(toHashA));
 253             assertTrue(toHashes.contains(toHashB));
 254 
 255             var pullRequests = toHostedRepo.pullRequests();
 256             assertEquals(1, pullRequests.size());
 257             var pr = pullRequests.get(0);
<span class="line-modified"> 258             assertEquals(&quot;Merge test:master&quot;, pr.title());</span>
 259         }
 260     }
 261 
 262     @Test
<span class="line-modified"> 263     void resolvedMergeConflictShouldResultInIntegrateCommand(TestInfo testInfo) throws IOException {</span>
<span class="line-modified"> 264         try (var temp = new TemporaryDirectory()) {</span>
 265             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 266 
 267             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 268             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 269             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 270 
 271             var toDir = temp.path().resolve(&quot;to.git&quot;);
 272             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 273             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 274             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 275                         StandardOpenOption.APPEND);
 276             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 277 
 278             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 279             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 280             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 281             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 282                         StandardOpenOption.APPEND);
 283             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 284 
</pre>
<hr />
<pre>
 309             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 310             toLocalRepo.add(toFileB);
 311             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 312 
 313             var storage = temp.path().resolve(&quot;storage&quot;);
 314             var master = new Branch(&quot;master&quot;);
 315             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 316             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 317             TestBotRunner.runPeriodicItems(bot);
 318             TestBotRunner.runPeriodicItems(bot);
 319 
 320             toCommits = toLocalRepo.commits().asList();
 321             assertEquals(2, toCommits.size());
 322             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 323             assertTrue(toHashes.contains(toHashA));
 324             assertTrue(toHashes.contains(toHashB));
 325 
 326             var pullRequests = toHostedRepo.pullRequests();
 327             assertEquals(1, pullRequests.size());
 328             var pr = pullRequests.get(0);
<span class="line-modified"> 329             assertEquals(&quot;Merge test:master&quot;, pr.title());</span>
<span class="line-modified"> 330             assertTrue(pr.labels().contains(&quot;failed-auto-merge&quot;));</span>
<span class="line-modified"> 331             assertTrue(forkLocalRepo.branches().contains(new Branch(&quot;master&quot;)));</span>
<span class="line-modified"> 332             assertTrue(forkLocalRepo.branches().contains(new Branch(&quot;1&quot;)));</span>




 333 
<span class="line-added"> 334             // Bot should do nothing as long as PR is presnt</span>
 335             TestBotRunner.runPeriodicItems(bot);
 336             pullRequests = toHostedRepo.pullRequests();





































































 337             assertEquals(1, pullRequests.size());
<span class="line-modified"> 338             pr = pullRequests.get(0);</span>








 339 
<span class="line-added"> 340             // Simulate that the merge-conflict has been resolved by adding the &quot;ready&quot; label</span>
<span class="line-added"> 341             pr.addLabel(&quot;ready&quot;);</span>
 342             TestBotRunner.runPeriodicItems(bot);
 343             pullRequests = toHostedRepo.pullRequests();
<span class="line-modified"> 344             assertEquals(1, pullRequests.size());</span>





 345 
<span class="line-modified"> 346             pr = pullRequests.get(0);</span>
<span class="line-modified"> 347             var numComments = pr.comments().size();</span>
<span class="line-modified"> 348             var lastComment = pr.comments().get(pr.comments().size() - 1);</span>
<span class="line-modified"> 349             assertEquals(&quot;/integrate&quot;, lastComment.body());</span>
 350 
<span class="line-added"> 351             // Running the bot again should not result in another comment</span>
 352             TestBotRunner.runPeriodicItems(bot);
<span class="line-modified"> 353             assertEquals(numComments, toHostedRepo.pullRequests().size());</span>


 354         }
 355     }
 356 
 357     final static class TestClock implements Clock {
 358         ZonedDateTime now;
 359 
 360         TestClock() {
 361             this(null);
 362         }
 363 
 364         TestClock(ZonedDateTime now) {
 365             this.now = now;
 366         }
 367 
 368         @Override
 369         public ZonedDateTime now() {
 370             return now;
 371         }
 372     }
 373 
 374     @Test
 375     void testMergeHourly(TestInfo testInfo) throws IOException {
<span class="line-modified"> 376         try (var temp = new TemporaryDirectory()) {</span>
 377             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 378 
 379             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 380             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 381             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 382 
 383             var toDir = temp.path().resolve(&quot;to.git&quot;);
 384             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 385             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 386             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 387                         StandardOpenOption.APPEND);
 388             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 389 
 390             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 391             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 392             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 393             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 394                         StandardOpenOption.APPEND);
 395             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 396 
</pre>
<hr />
<pre>
 471             toCommits = toLocalRepo.commits().asList();
 472             assertEquals(4, toCommits.size());
 473 
 474             // Move the minutes forward, the bot should not merge
 475             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 476             TestBotRunner.runPeriodicItems(bot);
 477             toCommits = toLocalRepo.commits().asList();
 478             assertEquals(4, toCommits.size());
 479 
 480             // Move the clock forward one hour, the bot should merge
 481             clock.now = ZonedDateTime.of(2020, 1, 23, 16, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 482             TestBotRunner.runPeriodicItems(bot);
 483 
 484             toCommits = toLocalRepo.commits().asList();
 485             assertEquals(6, toCommits.size());
 486         }
 487     }
 488 
 489     @Test
 490     void testMergeDaily(TestInfo testInfo) throws IOException {
<span class="line-modified"> 491         try (var temp = new TemporaryDirectory()) {</span>
 492             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 493 
 494             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 495             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 496             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 497 
 498             var toDir = temp.path().resolve(&quot;to.git&quot;);
 499             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 500             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 501             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 502                         StandardOpenOption.APPEND);
 503             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
 504 
 505             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 506             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 507             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 508             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 509                         StandardOpenOption.APPEND);
 510             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 511 
</pre>
<hr />
<pre>
 592             toCommits = toLocalRepo.commits().asList();
 593             assertEquals(4, toCommits.size());
 594 
 595             // Move the hours forward, the bot should not merge
 596             clock.now = ZonedDateTime.of(2020, 1, 23, 17, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 597             TestBotRunner.runPeriodicItems(bot);
 598             toCommits = toLocalRepo.commits().asList();
 599             assertEquals(4, toCommits.size());
 600 
 601             // Move the clock forward one day, the bot should merge
 602             clock.now = ZonedDateTime.of(2020, 1, 24, 3, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 603             TestBotRunner.runPeriodicItems(bot);
 604 
 605             toCommits = toLocalRepo.commits().asList();
 606             assertEquals(6, toCommits.size());
 607         }
 608     }
 609 
 610     @Test
 611     void testMergeWeekly(TestInfo testInfo) throws IOException {
<span class="line-modified"> 612         try (var temp = new TemporaryDirectory()) {</span>
 613             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 614 
 615             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 616             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 617             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 618 
 619             var toDir = temp.path().resolve(&quot;to.git&quot;);
 620             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 621             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 622             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 623                         StandardOpenOption.APPEND);
 624             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 625 
 626             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 627             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 628             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 629             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 630                         StandardOpenOption.APPEND);
 631             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 632 
</pre>
<hr />
<pre>
 713             toCommits = toLocalRepo.commits().asList();
 714             assertEquals(4, toCommits.size());
 715 
 716             // Move the days forward, the bot should not merge
 717             clock.now = ZonedDateTime.of(2020, 1, 25, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 718             TestBotRunner.runPeriodicItems(bot);
 719             toCommits = toLocalRepo.commits().asList();
 720             assertEquals(4, toCommits.size());
 721 
 722             // Move the clock forward one week, the bot should merge
 723             clock.now = ZonedDateTime.of(2020, 1, 31, 12, 29, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 724             TestBotRunner.runPeriodicItems(bot);
 725 
 726             toCommits = toLocalRepo.commits().asList();
 727             assertEquals(6, toCommits.size());
 728         }
 729     }
 730 
 731     @Test
 732     void testMergeMonthly(TestInfo testInfo) throws IOException {
<span class="line-modified"> 733         try (var temp = new TemporaryDirectory()) {</span>
 734             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 735 
 736             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 737             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 738             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 739 
 740             var toDir = temp.path().resolve(&quot;to.git&quot;);
 741             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 742             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 743             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 744                         StandardOpenOption.APPEND);
 745             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
 746 
 747             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 748             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 749             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 750             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 751                         StandardOpenOption.APPEND);
 752             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 753 
</pre>
<hr />
<pre>
 834             toCommits = toLocalRepo.commits().asList();
 835             assertEquals(4, toCommits.size());
 836 
 837             // Move the days forward, the bot should not merge
 838             clock.now = ZonedDateTime.of(2020, 1, 18, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 839             TestBotRunner.runPeriodicItems(bot);
 840             toCommits = toLocalRepo.commits().asList();
 841             assertEquals(4, toCommits.size());
 842 
 843             // Move the clock forward one month, the bot should merge
 844             clock.now = ZonedDateTime.of(2020, 2, 17, 11, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 845             TestBotRunner.runPeriodicItems(bot);
 846 
 847             toCommits = toLocalRepo.commits().asList();
 848             assertEquals(6, toCommits.size());
 849         }
 850     }
 851 
 852     @Test
 853     void testMergeYearly(TestInfo testInfo) throws IOException {
<span class="line-modified"> 854         try (var temp = new TemporaryDirectory()) {</span>
 855             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 856 
 857             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 858             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 859             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 860 
 861             var toDir = temp.path().resolve(&quot;to.git&quot;);
 862             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 863             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 864             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 865                         StandardOpenOption.APPEND);
 866             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
 867 
 868             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 869             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 870             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 871             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 872                         StandardOpenOption.APPEND);
 873             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 874 
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/merge/MergeBot.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>