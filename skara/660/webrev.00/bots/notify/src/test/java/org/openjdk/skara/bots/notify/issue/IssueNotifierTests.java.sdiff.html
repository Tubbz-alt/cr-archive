<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/issue/IssueNotifierTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../main/java/org/openjdk/skara/bots/notify/NotifyBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/issue/IssueNotifierTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
114             var reviewer = credentials.getHostedRepository();
115             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
116             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
117             credentials.commitLock(localRepo);
118             localRepo.pushAll(repo.url());
119 
120             var tagStorage = createTagStorage(repo);
121             var branchStorage = createBranchStorage(repo);
122             var prStateStorage = createPullRequestStateStorage(repo);
123             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
124 
125             var issueProject = credentials.getIssueProject();
126             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
127             var notifyBot = NotifyBot.newBuilder()
128                                      .repository(repo)
129                                      .storagePath(storageFolder)
130                                      .branches(Pattern.compile(&quot;master&quot;))
131                                      .tagStorageBuilder(tagStorage)
132                                      .branchStorageBuilder(branchStorage)
133                                      .prStateStorageBuilder(prStateStorage)
<span class="line-removed">134                                      .readyLabels(Set.of(&quot;rfr&quot;))</span>
135                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
136                                      .build();
137             var updater = IssueNotifier.newBuilder()
138                                       .issueProject(issueProject)
139                                       .reviewIcon(reviewIcon)
140                                       .commitLink(false)
141                                       .build();
142             updater.attachTo(notifyBot);
143 
144             // Initialize history
145             TestBotRunner.runPeriodicItems(notifyBot);
146 
147             // Create an issue and a pull request to fix it
148             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
149             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
150             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
151             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
152             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
153             TestBotRunner.runPeriodicItems(notifyBot);
154 
</pre>
<hr />
<pre>
215             var reviewer = credentials.getHostedRepository();
216             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
217             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
218             credentials.commitLock(localRepo);
219             localRepo.pushAll(repo.url());
220 
221             var tagStorage = createTagStorage(repo);
222             var branchStorage = createBranchStorage(repo);
223             var prStateStorage = createPullRequestStateStorage(repo);
224             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
225 
226             var issueProject = credentials.getIssueProject();
227             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
228             var notifyBot = NotifyBot.newBuilder()
229                                      .repository(repo)
230                                      .storagePath(storageFolder)
231                                      .branches(Pattern.compile(&quot;master&quot;))
232                                      .tagStorageBuilder(tagStorage)
233                                      .branchStorageBuilder(branchStorage)
234                                      .prStateStorageBuilder(prStateStorage)
<span class="line-removed">235                                      .readyLabels(Set.of(&quot;rfr&quot;))</span>
236                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
237                                      .build();
238             var updater = IssueNotifier.newBuilder()
239                                       .issueProject(issueProject)
240                                       .reviewLink(false)
241                                       .reviewIcon(reviewIcon)
242                                       .commitLink(false)
243                                       .build();
244             updater.attachTo(notifyBot);
245 
246             // Initialize history
247             TestBotRunner.runPeriodicItems(notifyBot);
248 
249             // Create an issue and a pull request to fix it
250             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
251             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
252             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
253             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
254             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
255             TestBotRunner.runPeriodicItems(notifyBot);
</pre>
<hr />
<pre>
296                                      .integratorId(repo.forge().currentUser().id())
297                                      .build();
298             var updater = IssueNotifier.newBuilder()
299                                       .issueProject(issueProject)
300                                       .reviewIcon(reviewIcon)
301                                       .commitLink(true)
302                                       .commitIcon(reviewIcon)
303                                       .build();
304             updater.attachTo(notifyBot);
305 
306             // Initialize history
307             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
308             TestBotRunner.runPeriodicItems(notifyBot);
309 
310             // Create an issue and a pull request to fix it
311             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
312             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
313             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
314             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
315             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);

316             TestBotRunner.runPeriodicItems(notifyBot);
317 
318             // The issue should now contain a link to the PR
319             var links = issue.links();
320             assertEquals(1, links.size());
321             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
322             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
323 
324             // Simulate integration
325             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
326             pr.addLabel(&quot;integrated&quot;);
327             pr.setState(Issue.State.CLOSED);
328             localRepo.push(editHash, repo.url(), &quot;other&quot;);
329             TestBotRunner.runPeriodicItems(notifyBot);
330 
331             // The changeset should be reflected in another link
332             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
333             links = updatedIssue.links();
334             assertEquals(2, links.size());
335 
</pre>
</td>
<td>
<hr />
<pre>
114             var reviewer = credentials.getHostedRepository();
115             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
116             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
117             credentials.commitLock(localRepo);
118             localRepo.pushAll(repo.url());
119 
120             var tagStorage = createTagStorage(repo);
121             var branchStorage = createBranchStorage(repo);
122             var prStateStorage = createPullRequestStateStorage(repo);
123             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
124 
125             var issueProject = credentials.getIssueProject();
126             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
127             var notifyBot = NotifyBot.newBuilder()
128                                      .repository(repo)
129                                      .storagePath(storageFolder)
130                                      .branches(Pattern.compile(&quot;master&quot;))
131                                      .tagStorageBuilder(tagStorage)
132                                      .branchStorageBuilder(branchStorage)
133                                      .prStateStorageBuilder(prStateStorage)

134                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
135                                      .build();
136             var updater = IssueNotifier.newBuilder()
137                                       .issueProject(issueProject)
138                                       .reviewIcon(reviewIcon)
139                                       .commitLink(false)
140                                       .build();
141             updater.attachTo(notifyBot);
142 
143             // Initialize history
144             TestBotRunner.runPeriodicItems(notifyBot);
145 
146             // Create an issue and a pull request to fix it
147             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
148             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
149             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
150             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
151             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
152             TestBotRunner.runPeriodicItems(notifyBot);
153 
</pre>
<hr />
<pre>
214             var reviewer = credentials.getHostedRepository();
215             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
216             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
217             credentials.commitLock(localRepo);
218             localRepo.pushAll(repo.url());
219 
220             var tagStorage = createTagStorage(repo);
221             var branchStorage = createBranchStorage(repo);
222             var prStateStorage = createPullRequestStateStorage(repo);
223             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
224 
225             var issueProject = credentials.getIssueProject();
226             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
227             var notifyBot = NotifyBot.newBuilder()
228                                      .repository(repo)
229                                      .storagePath(storageFolder)
230                                      .branches(Pattern.compile(&quot;master&quot;))
231                                      .tagStorageBuilder(tagStorage)
232                                      .branchStorageBuilder(branchStorage)
233                                      .prStateStorageBuilder(prStateStorage)

234                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
235                                      .build();
236             var updater = IssueNotifier.newBuilder()
237                                       .issueProject(issueProject)
238                                       .reviewLink(false)
239                                       .reviewIcon(reviewIcon)
240                                       .commitLink(false)
241                                       .build();
242             updater.attachTo(notifyBot);
243 
244             // Initialize history
245             TestBotRunner.runPeriodicItems(notifyBot);
246 
247             // Create an issue and a pull request to fix it
248             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
249             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
250             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
251             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
252             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
253             TestBotRunner.runPeriodicItems(notifyBot);
</pre>
<hr />
<pre>
294                                      .integratorId(repo.forge().currentUser().id())
295                                      .build();
296             var updater = IssueNotifier.newBuilder()
297                                       .issueProject(issueProject)
298                                       .reviewIcon(reviewIcon)
299                                       .commitLink(true)
300                                       .commitIcon(reviewIcon)
301                                       .build();
302             updater.attachTo(notifyBot);
303 
304             // Initialize history
305             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
306             TestBotRunner.runPeriodicItems(notifyBot);
307 
308             // Create an issue and a pull request to fix it
309             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
310             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
311             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
312             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
313             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
<span class="line-added">314             pr.addLabel(&quot;rfr&quot;);</span>
315             TestBotRunner.runPeriodicItems(notifyBot);
316 
317             // The issue should now contain a link to the PR
318             var links = issue.links();
319             assertEquals(1, links.size());
320             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
321             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
322 
323             // Simulate integration
324             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
325             pr.addLabel(&quot;integrated&quot;);
326             pr.setState(Issue.State.CLOSED);
327             localRepo.push(editHash, repo.url(), &quot;other&quot;);
328             TestBotRunner.runPeriodicItems(notifyBot);
329 
330             // The changeset should be reflected in another link
331             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
332             links = updatedIssue.links();
333             assertEquals(2, links.size());
334 
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../main/java/org/openjdk/skara/bots/notify/NotifyBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>