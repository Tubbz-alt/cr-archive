<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/CommandWorkItem.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/pr/CommandTests.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/CommandWorkItem.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 57,20 ***</span>
              Map.entry(&quot;label&quot;, new LabelCommand()),
              Map.entry(&quot;cc&quot;, new LabelCommand(&quot;cc&quot;))
      );
  
      static class HelpCommand implements CommandHandler {
<span class="line-removed">-         static private Map&lt;String, String&gt; external = null;</span>
<span class="line-removed">- </span>
          @Override
          public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List&lt;Comment&gt; allComments, PrintWriter reply) {
              reply.println(&quot;Available commands:&quot;);
              Stream.concat(
                      commandHandlers.entrySet().stream()
                                     .map(entry -&gt; entry.getKey() + &quot; - &quot; + entry.getValue().description()),
<span class="line-modified">!                     external.entrySet().stream()</span>
<span class="line-modified">!                             .map(entry -&gt; entry.getKey() + &quot; - &quot; + entry.getValue())</span>
              ).sorted().forEachOrdered(c -&gt; reply.println(&quot; * &quot; + c));
          }
  
          @Override
          public String description() {
<span class="line-new-header">--- 57,18 ---</span>
              Map.entry(&quot;label&quot;, new LabelCommand()),
              Map.entry(&quot;cc&quot;, new LabelCommand(&quot;cc&quot;))
      );
  
      static class HelpCommand implements CommandHandler {
          @Override
          public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List&lt;Comment&gt; allComments, PrintWriter reply) {
              reply.println(&quot;Available commands:&quot;);
              Stream.concat(
                      commandHandlers.entrySet().stream()
                                     .map(entry -&gt; entry.getKey() + &quot; - &quot; + entry.getValue().description()),
<span class="line-modified">!                     bot.externalCommands().entrySet().stream()</span>
<span class="line-modified">!                                           .map(entry -&gt; entry.getKey() + &quot; - &quot; + entry.getValue())</span>
              ).sorted().forEachOrdered(c -&gt; reply.println(&quot; * &quot; + c));
          }
  
          @Override
          public String description() {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 175,10 ***</span>
<span class="line-new-header">--- 173,11 ---</span>
                                .map(matcher -&gt; matcher.group(1))
                                .collect(Collectors.toSet());
  
          return allCommands.stream()
                            .filter(ci -&gt; !handled.contains(ci.id()))
<span class="line-added">+                           .filter(ci -&gt; !bot.externalCommands().containsKey(ci.name()))</span>
                            .findFirst();
      }
  
      private void processCommand(PullRequest pr, CensusInstance censusInstance, Path scratchPath, CommandInvocation command, List&lt;Comment&gt; allComments) {
          var writer = new StringWriter();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 191,18 ***</span>
  
          var handler = command.handler();
          if (handler.isPresent()) {
              handler.get().handle(bot, pr, censusInstance, scratchPath, command, allComments, printer);
          } else {
<span class="line-modified">!             if (!bot.externalCommands().containsKey(command.name())) {</span>
<span class="line-modified">!                 printer.print(&quot;Unknown command `&quot;);</span>
<span class="line-modified">!                 printer.print(command.name());</span>
<span class="line-removed">-                 printer.println(&quot;` - for a list of valid commands use `/help`.&quot;);</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 // Do not reply to external commands</span>
<span class="line-removed">-                 return;</span>
<span class="line-removed">-             }</span>
          }
  
          pr.addComment(writer.toString());
      }
  
<span class="line-new-header">--- 190,13 ---</span>
  
          var handler = command.handler();
          if (handler.isPresent()) {
              handler.get().handle(bot, pr, censusInstance, scratchPath, command, allComments, printer);
          } else {
<span class="line-modified">!             printer.print(&quot;Unknown command `&quot;);</span>
<span class="line-modified">!             printer.print(command.name());</span>
<span class="line-modified">!             printer.println(&quot;` - for a list of valid commands use `/help`.&quot;);</span>
          }
  
          pr.addComment(writer.toString());
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 216,20 ***</span>
          }
  
          var comments = pr.comments();
          var nextCommand = nextCommand(pr, comments);
          if (nextCommand.isEmpty()) {
<span class="line-modified">!             log.fine(&quot;No new PR commands found, stopping further processing&quot;);</span>
              return List.of();
          }
  
<span class="line-removed">-         if (HelpCommand.external == null) {</span>
<span class="line-removed">-             HelpCommand.external = bot.externalCommands();</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
          var census = CensusInstance.create(bot.censusRepo(), bot.censusRef(), scratchPath.resolve(&quot;census&quot;), pr);
<span class="line-modified">!         processCommand(pr, census, scratchPath.resolve(&quot;pr&quot;).resolve(&quot;command&quot;), nextCommand.get(), comments);</span>
  
          // Run another check to reflect potential changes from commands
          return List.of(new CheckWorkItem(bot, pr, errorHandler));
      }
  
<span class="line-new-header">--- 210,18 ---</span>
          }
  
          var comments = pr.comments();
          var nextCommand = nextCommand(pr, comments);
          if (nextCommand.isEmpty()) {
<span class="line-modified">!             log.info(&quot;No new non-external PR commands found, stopping further processing&quot;);</span>
              return List.of();
          }
  
          var census = CensusInstance.create(bot.censusRepo(), bot.censusRef(), scratchPath.resolve(&quot;census&quot;), pr);
<span class="line-modified">!         var command = nextCommand.get();</span>
<span class="line-added">+         log.info(&quot;Processing command: &quot; + command.id() + &quot; - &quot; + command.name());</span>
<span class="line-added">+         processCommand(pr, census, scratchPath.resolve(&quot;pr&quot;).resolve(&quot;command&quot;), command, comments);</span>
  
          // Run another check to reflect potential changes from commands
          return List.of(new CheckWorkItem(bot, pr, errorHandler));
      }
  
</pre>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/pr/CommandTests.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>