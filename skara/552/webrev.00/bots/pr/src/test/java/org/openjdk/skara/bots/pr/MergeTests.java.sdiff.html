<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/test/java/org/openjdk/skara/bots/pr/MergeTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/PullRequestInstance.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/pr/src/test/java/org/openjdk/skara/bots/pr/MergeTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 56             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
 57             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
 58             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 59             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 60             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 61 
 62             // Make more changes in another branch
 63             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
 64                                                                 &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
 65             localRepo.push(otherHash1, author.url(), &quot;other&quot;, true);
 66             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
 67                                                                 &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
 68             localRepo.push(otherHash2, author.url(), &quot;other&quot;);
 69 
 70             // Go back to the original master
 71             localRepo.checkout(masterHash, true);
 72 
 73             // Make a change with a corresponding PR
 74             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
 75             localRepo.add(unrelated);
<span class="line-modified"> 76             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);</span>
 77             localRepo.merge(otherHash2);


 78             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
 79             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
 80             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
 81 
 82             // Approve it as another user
 83             var approvalPr = integrator.pullRequest(pr.id());
 84             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 85 
 86             // Let the bot check the status
 87             TestBotRunner.runPeriodicItems(mergeBot);
 88 
 89             // Push it
 90             pr.addComment(&quot;/integrate&quot;);
 91             TestBotRunner.runPeriodicItems(mergeBot);
 92 
 93             // The bot should reply with an ok message
 94             var pushed = pr.comments().stream()
 95                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
 96                            .count();
 97             assertEquals(1, pushed);
</pre>
<hr />
<pre>
138             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
139             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
140             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
141             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
142             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
143 
144             // Make more changes in another branch
145             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
146                                                                  &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
147             localRepo.push(otherHash1, author.url(), &quot;other&quot;, true);
148             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
149                                                                  &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
150             localRepo.push(otherHash2, author.url(), &quot;other&quot;);
151 
152             // Go back to the original master
153             localRepo.checkout(masterHash, true);
154 
155             // Make a change with a corresponding PR
156             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
157             localRepo.add(unrelated);
<span class="line-modified">158             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);</span>


159             localRepo.merge(otherHash2);
160             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
161             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
162             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge other&quot;);
163 
164             // Approve it as another user
165             var approvalPr = integrator.pullRequest(pr.id());
166             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
167 
168             // Let the bot check the status
169             TestBotRunner.runPeriodicItems(mergeBot);
170 
171             // Push it
172             pr.addComment(&quot;/integrate&quot;);
173             TestBotRunner.runPeriodicItems(mergeBot);
174 
175             // The bot should reply with an ok message
176             var pushed = pr.comments().stream()
177                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
178                            .count();
</pre>
<hr />
<pre>
221             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
222             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
223             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
224             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
225 
226             // Make more changes in another branch
227             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
228                                                                  &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
229             localRepo.push(otherHash1, author.url(), &quot;other&quot;, true);
230             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
231                                                                  &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
232             localRepo.push(otherHash2, author.url(), &quot;other&quot;);
233 
234             // Go back to the original master
235             localRepo.checkout(masterHash, true);
236 
237             // Make a change with a corresponding PR
238             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
239             localRepo.add(unrelated);
240             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);


241             localRepo.merge(otherHash2);
242             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
243             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
244             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
245 
246             // Approve it as another user
247             var approvalPr = integrator.pullRequest(pr.id());
248             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
249 
250             // Let the bot check the status
251             TestBotRunner.runPeriodicItems(mergeBot);
252 
253             // Push something new to master
254             localRepo.checkout(updatedMaster, true);
255             var newMaster = Files.writeString(localRepo.root().resolve(&quot;newmaster.txt&quot;), &quot;New on master&quot;, StandardCharsets.UTF_8);
256             localRepo.add(newMaster);
257             var newMasterHash = localRepo.commit(&quot;New commit on master&quot;, &quot;some&quot;, &quot;some@one&quot;);
258             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
259 
260             // Let the bot notice
</pre>
<hr />
<pre>
313             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
314             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
315             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
316             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
317 
318             // Make more changes in another branch
319             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
320                                                                  &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
321             localRepo.push(otherHash1, author.url(), &quot;other&quot;, true);
322             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
323                                                                  &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
324             localRepo.push(otherHash2, author.url(), &quot;other&quot;);
325 
326             // Go back to the original master
327             localRepo.checkout(masterHash, true);
328 
329             // Make a change with a corresponding PR
330             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
331             localRepo.add(unrelated);
332             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);


333             localRepo.merge(otherHash2);
334             var mergeHash = localRepo.commit(&quot;Our own merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
335             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
336             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
337 
338             // Approve it as another user
339             var approvalPr = integrator.pullRequest(pr.id());
340             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
341 
342             // Let the bot check the status
343             TestBotRunner.runPeriodicItems(mergeBot);
344 
345             // Push something new to master
346             localRepo.checkout(updatedMaster, true);
347             var newMaster = Files.writeString(localRepo.root().resolve(&quot;newmaster.txt&quot;), &quot;New on master&quot;, StandardCharsets.UTF_8);
348             localRepo.add(newMaster);
349             var newMasterHash = localRepo.commit(&quot;New commit on master&quot;, &quot;some&quot;, &quot;some@one&quot;);
350             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
351 
352             // Let the bot notice
353             TestBotRunner.runPeriodicItems(mergeBot);
354 
355             // Add another commit on top of the merge commit
356             localRepo.checkout(mergeHash, true);
357             var extraHash = CheckableRepository.appendAndCommit(localRepo, &quot;Fixing up stuff after merge&quot;);
358             localRepo.push(extraHash, author.url(), &quot;edit&quot;);
359 
360             // Let the bot notice again
361             TestBotRunner.runPeriodicItems(mergeBot);
362 








363             // Push it
364             pr.addComment(&quot;/integrate&quot;);
365             TestBotRunner.runPeriodicItems(mergeBot);
366 
367             // The bot should reply with an ok message
368             var pushed = pr.comments().stream()
369                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
370                            .count();
371             assertEquals(1, pushed, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
372 
373             // The change should now be present on the master branch
374             var pushedRepoFolder = tempFolder.path().resolve(&quot;pushedrepo&quot;);
375             var pushedRepo = Repository.materialize(pushedRepoFolder, author.url(), &quot;master&quot;);
376             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
377 
378             // The commits from the &quot;other&quot; branch should be preserved and not squashed (but not the merge commit)
379             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
380             String commits;
381             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
382                 commits = tempCommits.stream()
383                                      .map(c -&gt; c.hash().hex() + &quot;:&quot; + c.message().get(0))
384                                      .collect(Collectors.joining(&quot;,&quot;));
385             }
386             assertTrue(commits.contains(otherHash1.hex() + &quot;:First other&quot;));
387             assertTrue(commits.contains(otherHash2.hex() + &quot;:Second other&quot;));
388             assertFalse(commits.contains(&quot;Our own merge commit&quot;));
389 
390             // Author and committer should updated in the merge commit
391             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
392             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
393             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
394             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
395             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
396         }
397     }
398 
399     @Test
<span class="line-modified">400     void invalidSourceRepo(TestInfo testInfo) throws IOException {</span>
401         try (var credentials = new HostCredentials(testInfo);
402              var tempFolder = new TemporaryDirectory()) {
403 
404             var author = credentials.getHostedRepository();
405             var integrator = credentials.getHostedRepository();
406             var censusBuilder = credentials.getCensusBuilder()
407                                            .addCommitter(author.forge().currentUser().id())
408                                            .addReviewer(integrator.forge().currentUser().id());
409             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
410 
411             // Populate the projects repository
412             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
413             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
414             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
415             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
416             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
417 
418             // Make a change in another branch
419             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
420                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
421             localRepo.push(otherHash, author.url(), &quot;other&quot;, true);
422 
423             // Go back to the original master
424             localRepo.checkout(masterHash, true);
425 
426             // Make a change with a corresponding PR
427             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
428             localRepo.add(unrelated);
429             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);




























































430             localRepo.merge(otherHash);
431             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
432             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
433             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;xyz&quot; + &quot;:other&quot;);
434 
435             // Approve it as another user
436             var approvalPr = integrator.pullRequest(pr.id());
437             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
438 
439             // Let the bot check the status
440             TestBotRunner.runPeriodicItems(mergeBot);
441 
442             // Push it
443             pr.addComment(&quot;/integrate&quot;);
444             TestBotRunner.runPeriodicItems(mergeBot);
445 
446             // The bot should reply with a failure message
447             var error = pr.comments().stream()
448                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
449                           .count();
</pre>
<hr />
<pre>
467             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
468 
469             // Populate the projects repository
470             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
471             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
472             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
473             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
474             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
475 
476             // Make a change in another branch
477             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
478                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
479             localRepo.push(otherHash, author.url(), &quot;other&quot;, true);
480 
481             // Go back to the original master
482             localRepo.checkout(masterHash, true);
483 
484             // Make a change with a corresponding PR
485             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
486             localRepo.add(unrelated);
<span class="line-modified">487             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);</span>


488             localRepo.merge(otherHash);
489             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
490             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
491             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:otherxyz&quot;);
492 
493             // Approve it as another user
494             var approvalPr = integrator.pullRequest(pr.id());
495             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
496 
497             // Let the bot check the status
498             TestBotRunner.runPeriodicItems(mergeBot);
499 
500             // Push it
501             pr.addComment(&quot;/integrate&quot;);
502             TestBotRunner.runPeriodicItems(mergeBot);
503 
504             // The bot should reply with a failure message
505             var error = pr.comments().stream()
506                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
507                           .count();
</pre>
<hr />
<pre>
530             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
531             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
532             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
533 
534             // Make a change in another branch
535             var other1Hash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other1&quot;,
536                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
537             localRepo.push(other1Hash, author.url(), &quot;other1&quot;, true);
538 
539             // Go back to the original master
540             localRepo.checkout(masterHash, true);
541 
542             // Make yet another change in another branch
543             var other2Hash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other2&quot;,
544                                                                 &quot;Unrelated\n\nReviewed-by: integrationreviewer2&quot;);
545             localRepo.push(other2Hash, author.url(), &quot;other2&quot;, true);
546 
547             // Make a change with a corresponding PR
548             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
549             localRepo.add(unrelated);
<span class="line-modified">550             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);</span>


551             localRepo.merge(other1Hash, &quot;ours&quot;);
552             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
553             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
554             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other2&quot;);
555 
556             // Approve it as another user
557             var approvalPr = integrator.pullRequest(pr.id());
558             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
559 
560             // Let the bot check the status
561             TestBotRunner.runPeriodicItems(mergeBot);
562 
563             // Push it
564             pr.addComment(&quot;/integrate&quot;);
565             TestBotRunner.runPeriodicItems(mergeBot);
566 
567             // The bot should reply with a failure message
568             var error = pr.comments().stream()
569                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
570                           .count();
</pre>
<hr />
<pre>
588             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
589 
590             // Populate the projects repository
591             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
592             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
593             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
594             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
595             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
596 
597             // Make a change in another branch
598             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
599                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
600             localRepo.push(otherHash, author.url(), &quot;other&quot;, true);
601 
602             // Go back to the original master
603             localRepo.checkout(masterHash, true);
604 
605             // Make a change with a corresponding PR
606             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
607             localRepo.add(unrelated);
<span class="line-modified">608             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);</span>


609             localRepo.merge(otherHash);
610             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
611             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
612             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
613 
614             // Approve it as another user
615             var approvalPr = integrator.pullRequest(pr.id());
616             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
617 
618             // Let the bot check the status
619             TestBotRunner.runPeriodicItems(mergeBot);
620 
621             // Push it
622             pr.addComment(&quot;/integrate&quot;);
623             TestBotRunner.runPeriodicItems(mergeBot);
624 
625             // The bot should reply with a failure message
626             var error = pr.comments().stream()
627                           .filter(comment -&gt; comment.body().contains(&quot;Merges require Committer status&quot;))
628                           .count();
</pre>
</td>
<td>
<hr />
<pre>
 56             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
 57             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
 58             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 59             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 60             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 61 
 62             // Make more changes in another branch
 63             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
 64                                                                 &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
 65             localRepo.push(otherHash1, author.url(), &quot;other&quot;, true);
 66             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
 67                                                                 &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
 68             localRepo.push(otherHash2, author.url(), &quot;other&quot;);
 69 
 70             // Go back to the original master
 71             localRepo.checkout(masterHash, true);
 72 
 73             // Make a change with a corresponding PR
 74             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
 75             localRepo.add(unrelated);
<span class="line-modified"> 76             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);</span>
 77             localRepo.merge(otherHash2);
<span class="line-added"> 78             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);</span>
<span class="line-added"> 79 </span>
 80             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
 81             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
 82             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
 83 
 84             // Approve it as another user
 85             var approvalPr = integrator.pullRequest(pr.id());
 86             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 87 
 88             // Let the bot check the status
 89             TestBotRunner.runPeriodicItems(mergeBot);
 90 
 91             // Push it
 92             pr.addComment(&quot;/integrate&quot;);
 93             TestBotRunner.runPeriodicItems(mergeBot);
 94 
 95             // The bot should reply with an ok message
 96             var pushed = pr.comments().stream()
 97                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
 98                            .count();
 99             assertEquals(1, pushed);
</pre>
<hr />
<pre>
140             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
141             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
142             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
143             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
144             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
145 
146             // Make more changes in another branch
147             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
148                                                                  &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
149             localRepo.push(otherHash1, author.url(), &quot;other&quot;, true);
150             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
151                                                                  &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
152             localRepo.push(otherHash2, author.url(), &quot;other&quot;);
153 
154             // Go back to the original master
155             localRepo.checkout(masterHash, true);
156 
157             // Make a change with a corresponding PR
158             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
159             localRepo.add(unrelated);
<span class="line-modified">160             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);</span>
<span class="line-added">161             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);</span>
<span class="line-added">162 </span>
163             localRepo.merge(otherHash2);
164             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
165             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
166             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge other&quot;);
167 
168             // Approve it as another user
169             var approvalPr = integrator.pullRequest(pr.id());
170             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
171 
172             // Let the bot check the status
173             TestBotRunner.runPeriodicItems(mergeBot);
174 
175             // Push it
176             pr.addComment(&quot;/integrate&quot;);
177             TestBotRunner.runPeriodicItems(mergeBot);
178 
179             // The bot should reply with an ok message
180             var pushed = pr.comments().stream()
181                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
182                            .count();
</pre>
<hr />
<pre>
225             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
226             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
227             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
228             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
229 
230             // Make more changes in another branch
231             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
232                                                                  &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
233             localRepo.push(otherHash1, author.url(), &quot;other&quot;, true);
234             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
235                                                                  &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
236             localRepo.push(otherHash2, author.url(), &quot;other&quot;);
237 
238             // Go back to the original master
239             localRepo.checkout(masterHash, true);
240 
241             // Make a change with a corresponding PR
242             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
243             localRepo.add(unrelated);
244             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
<span class="line-added">245             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);</span>
<span class="line-added">246 </span>
247             localRepo.merge(otherHash2);
248             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
249             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
250             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
251 
252             // Approve it as another user
253             var approvalPr = integrator.pullRequest(pr.id());
254             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
255 
256             // Let the bot check the status
257             TestBotRunner.runPeriodicItems(mergeBot);
258 
259             // Push something new to master
260             localRepo.checkout(updatedMaster, true);
261             var newMaster = Files.writeString(localRepo.root().resolve(&quot;newmaster.txt&quot;), &quot;New on master&quot;, StandardCharsets.UTF_8);
262             localRepo.add(newMaster);
263             var newMasterHash = localRepo.commit(&quot;New commit on master&quot;, &quot;some&quot;, &quot;some@one&quot;);
264             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
265 
266             // Let the bot notice
</pre>
<hr />
<pre>
319             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
320             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
321             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
322             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
323 
324             // Make more changes in another branch
325             var otherHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;First change in other&quot;,
326                                                                  &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
327             localRepo.push(otherHash1, author.url(), &quot;other&quot;, true);
328             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
329                                                                  &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
330             localRepo.push(otherHash2, author.url(), &quot;other&quot;);
331 
332             // Go back to the original master
333             localRepo.checkout(masterHash, true);
334 
335             // Make a change with a corresponding PR
336             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
337             localRepo.add(unrelated);
338             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
<span class="line-added">339             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);</span>
<span class="line-added">340 </span>
341             localRepo.merge(otherHash2);
342             var mergeHash = localRepo.commit(&quot;Our own merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
343             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
344             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
345 
346             // Approve it as another user
347             var approvalPr = integrator.pullRequest(pr.id());
348             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
349 
350             // Let the bot check the status
351             TestBotRunner.runPeriodicItems(mergeBot);
352 
353             // Push something new to master
354             localRepo.checkout(updatedMaster, true);
355             var newMaster = Files.writeString(localRepo.root().resolve(&quot;newmaster.txt&quot;), &quot;New on master&quot;, StandardCharsets.UTF_8);
356             localRepo.add(newMaster);
357             var newMasterHash = localRepo.commit(&quot;New commit on master&quot;, &quot;some&quot;, &quot;some@one&quot;);
358             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
359 
360             // Let the bot notice
361             TestBotRunner.runPeriodicItems(mergeBot);
362 
363             // Add another commit on top of the merge commit
364             localRepo.checkout(mergeHash, true);
365             var extraHash = CheckableRepository.appendAndCommit(localRepo, &quot;Fixing up stuff after merge&quot;);
366             localRepo.push(extraHash, author.url(), &quot;edit&quot;);
367 
368             // Let the bot notice again
369             TestBotRunner.runPeriodicItems(mergeBot);
370 
<span class="line-added">371             // Merge the latest from master</span>
<span class="line-added">372             localRepo.merge(newMasterHash);</span>
<span class="line-added">373             var latestMergeHash = localRepo.commit(&quot;Our to be squashed merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);</span>
<span class="line-added">374             localRepo.push(latestMergeHash, author.url(), &quot;edit&quot;);</span>
<span class="line-added">375 </span>
<span class="line-added">376             // Let the bot notice again</span>
<span class="line-added">377             TestBotRunner.runPeriodicItems(mergeBot);</span>
<span class="line-added">378 </span>
379             // Push it
380             pr.addComment(&quot;/integrate&quot;);
381             TestBotRunner.runPeriodicItems(mergeBot);
382 
383             // The bot should reply with an ok message
384             var pushed = pr.comments().stream()
385                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
386                            .count();
387             assertEquals(1, pushed, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
388 
389             // The change should now be present on the master branch
390             var pushedRepoFolder = tempFolder.path().resolve(&quot;pushedrepo&quot;);
391             var pushedRepo = Repository.materialize(pushedRepoFolder, author.url(), &quot;master&quot;);
392             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
393 
394             // The commits from the &quot;other&quot; branch should be preserved and not squashed (but not the merge commit)
395             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
396             String commits;
397             try (var tempCommits = pushedRepo.commits(masterHash.hex() + &quot;..&quot; + headHash.hex())) {
398                 commits = tempCommits.stream()
399                                      .map(c -&gt; c.hash().hex() + &quot;:&quot; + c.message().get(0))
400                                      .collect(Collectors.joining(&quot;,&quot;));
401             }
402             assertTrue(commits.contains(otherHash1.hex() + &quot;:First other&quot;));
403             assertTrue(commits.contains(otherHash2.hex() + &quot;:Second other&quot;));
404             assertFalse(commits.contains(&quot;Our own merge commit&quot;));
405 
406             // Author and committer should updated in the merge commit
407             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
408             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
409             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
410             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
411             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
412         }
413     }
414 
415     @Test
<span class="line-modified">416     void invalidMergeCommit(TestInfo testInfo) throws IOException {</span>
417         try (var credentials = new HostCredentials(testInfo);
418              var tempFolder = new TemporaryDirectory()) {
419 
420             var author = credentials.getHostedRepository();
421             var integrator = credentials.getHostedRepository();
422             var censusBuilder = credentials.getCensusBuilder()
423                                            .addCommitter(author.forge().currentUser().id())
424                                            .addReviewer(integrator.forge().currentUser().id());
425             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
426 
427             // Populate the projects repository
428             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
429             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
430             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
431             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
432             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
433 
434             // Make a change in another branch
435             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
436                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
437             localRepo.push(otherHash, author.url(), &quot;other&quot;, true);
438 
439             // Go back to the original master
440             localRepo.checkout(masterHash, true);
441 
442             // Make a change with a corresponding PR
443             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
444             localRepo.add(unrelated);
445             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
<span class="line-added">446             localRepo.merge(otherHash);</span>
<span class="line-added">447             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);</span>
<span class="line-added">448             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-added">449             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);</span>
<span class="line-added">450 </span>
<span class="line-added">451             // Approve it as another user</span>
<span class="line-added">452             var approvalPr = integrator.pullRequest(pr.id());</span>
<span class="line-added">453             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);</span>
<span class="line-added">454 </span>
<span class="line-added">455             // Let the bot check the status</span>
<span class="line-added">456             TestBotRunner.runPeriodicItems(mergeBot);</span>
<span class="line-added">457 </span>
<span class="line-added">458             // Push it</span>
<span class="line-added">459             pr.addComment(&quot;/integrate&quot;);</span>
<span class="line-added">460             TestBotRunner.runPeriodicItems(mergeBot);</span>
<span class="line-added">461 </span>
<span class="line-added">462             // The bot should reply with a failure message</span>
<span class="line-added">463             var error = pr.comments().stream()</span>
<span class="line-added">464                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))</span>
<span class="line-added">465                           .count();</span>
<span class="line-added">466             assertEquals(1, error, () -&gt; pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));</span>
<span class="line-added">467 </span>
<span class="line-added">468             var check = pr.checks(mergeHash).get(&quot;jcheck&quot;);</span>
<span class="line-added">469             assertEquals(&quot;- It was not possible to create a commit for the changes in this PR: No merge commit containing commits from another branch than the target was found&quot;, check.summary().orElseThrow());</span>
<span class="line-added">470         }</span>
<span class="line-added">471     }</span>
<span class="line-added">472 </span>
<span class="line-added">473     @Test</span>
<span class="line-added">474     void invalidSourceRepo(TestInfo testInfo) throws IOException {</span>
<span class="line-added">475         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">476              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">477 </span>
<span class="line-added">478             var author = credentials.getHostedRepository();</span>
<span class="line-added">479             var integrator = credentials.getHostedRepository();</span>
<span class="line-added">480             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added">481                                            .addCommitter(author.forge().currentUser().id())</span>
<span class="line-added">482                                            .addReviewer(integrator.forge().currentUser().id());</span>
<span class="line-added">483             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();</span>
<span class="line-added">484 </span>
<span class="line-added">485             // Populate the projects repository</span>
<span class="line-added">486             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);</span>
<span class="line-added">487             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());</span>
<span class="line-added">488             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added">489             assertFalse(CheckableRepository.hasBeenEdited(localRepo));</span>
<span class="line-added">490             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-added">491 </span>
<span class="line-added">492             // Make a change in another branch</span>
<span class="line-added">493             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,</span>
<span class="line-added">494                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);</span>
<span class="line-added">495             localRepo.push(otherHash, author.url(), &quot;other&quot;, true);</span>
<span class="line-added">496 </span>
<span class="line-added">497             // Go back to the original master</span>
<span class="line-added">498             localRepo.checkout(masterHash, true);</span>
<span class="line-added">499 </span>
<span class="line-added">500             // Make a change with a corresponding PR</span>
<span class="line-added">501             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);</span>
<span class="line-added">502             localRepo.add(unrelated);</span>
<span class="line-added">503             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);</span>
<span class="line-added">504             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);</span>
<span class="line-added">505 </span>
506             localRepo.merge(otherHash);
507             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
508             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
509             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;xyz&quot; + &quot;:other&quot;);
510 
511             // Approve it as another user
512             var approvalPr = integrator.pullRequest(pr.id());
513             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
514 
515             // Let the bot check the status
516             TestBotRunner.runPeriodicItems(mergeBot);
517 
518             // Push it
519             pr.addComment(&quot;/integrate&quot;);
520             TestBotRunner.runPeriodicItems(mergeBot);
521 
522             // The bot should reply with a failure message
523             var error = pr.comments().stream()
524                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
525                           .count();
</pre>
<hr />
<pre>
543             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
544 
545             // Populate the projects repository
546             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
547             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
548             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
549             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
550             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
551 
552             // Make a change in another branch
553             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
554                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
555             localRepo.push(otherHash, author.url(), &quot;other&quot;, true);
556 
557             // Go back to the original master
558             localRepo.checkout(masterHash, true);
559 
560             // Make a change with a corresponding PR
561             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
562             localRepo.add(unrelated);
<span class="line-modified">563             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);</span>
<span class="line-added">564             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);</span>
<span class="line-added">565 </span>
566             localRepo.merge(otherHash);
567             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
568             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
569             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:otherxyz&quot;);
570 
571             // Approve it as another user
572             var approvalPr = integrator.pullRequest(pr.id());
573             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
574 
575             // Let the bot check the status
576             TestBotRunner.runPeriodicItems(mergeBot);
577 
578             // Push it
579             pr.addComment(&quot;/integrate&quot;);
580             TestBotRunner.runPeriodicItems(mergeBot);
581 
582             // The bot should reply with a failure message
583             var error = pr.comments().stream()
584                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
585                           .count();
</pre>
<hr />
<pre>
608             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
609             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
610             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
611 
612             // Make a change in another branch
613             var other1Hash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other1&quot;,
614                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
615             localRepo.push(other1Hash, author.url(), &quot;other1&quot;, true);
616 
617             // Go back to the original master
618             localRepo.checkout(masterHash, true);
619 
620             // Make yet another change in another branch
621             var other2Hash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other2&quot;,
622                                                                 &quot;Unrelated\n\nReviewed-by: integrationreviewer2&quot;);
623             localRepo.push(other2Hash, author.url(), &quot;other2&quot;, true);
624 
625             // Make a change with a corresponding PR
626             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
627             localRepo.add(unrelated);
<span class="line-modified">628             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);</span>
<span class="line-added">629             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);</span>
<span class="line-added">630 </span>
631             localRepo.merge(other1Hash, &quot;ours&quot;);
632             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
633             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
634             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other2&quot;);
635 
636             // Approve it as another user
637             var approvalPr = integrator.pullRequest(pr.id());
638             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
639 
640             // Let the bot check the status
641             TestBotRunner.runPeriodicItems(mergeBot);
642 
643             // Push it
644             pr.addComment(&quot;/integrate&quot;);
645             TestBotRunner.runPeriodicItems(mergeBot);
646 
647             // The bot should reply with a failure message
648             var error = pr.comments().stream()
649                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
650                           .count();
</pre>
<hr />
<pre>
668             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
669 
670             // Populate the projects repository
671             var localRepoFolder = tempFolder.path().resolve(&quot;localrepo&quot;);
672             var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());
673             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
674             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
675             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
676 
677             // Make a change in another branch
678             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
679                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
680             localRepo.push(otherHash, author.url(), &quot;other&quot;, true);
681 
682             // Go back to the original master
683             localRepo.checkout(masterHash, true);
684 
685             // Make a change with a corresponding PR
686             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
687             localRepo.add(unrelated);
<span class="line-modified">688             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);</span>
<span class="line-added">689             localRepo.push(updatedMaster, author.url(), &quot;master&quot;);</span>
<span class="line-added">690 </span>
691             localRepo.merge(otherHash);
692             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
693             localRepo.push(mergeHash, author.url(), &quot;edit&quot;, true);
694             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + author.name() + &quot;:other&quot;);
695 
696             // Approve it as another user
697             var approvalPr = integrator.pullRequest(pr.id());
698             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
699 
700             // Let the bot check the status
701             TestBotRunner.runPeriodicItems(mergeBot);
702 
703             // Push it
704             pr.addComment(&quot;/integrate&quot;);
705             TestBotRunner.runPeriodicItems(mergeBot);
706 
707             // The bot should reply with a failure message
708             var error = pr.comments().stream()
709                           .filter(comment -&gt; comment.body().contains(&quot;Merges require Committer status&quot;))
710                           .count();
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/PullRequestInstance.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>