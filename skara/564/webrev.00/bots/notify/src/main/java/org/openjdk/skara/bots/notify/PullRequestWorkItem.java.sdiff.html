<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/main/java/org/openjdk/skara/bots/notify/PullRequestWorkItem.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PullRequestUpdateConsumer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="RepositoryUpdateConsumer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/notify/src/main/java/org/openjdk/skara/bots/notify/PullRequestWorkItem.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
100             return true;
101         }
102         PullRequestWorkItem otherItem = (PullRequestWorkItem)other;
103         if (!pr.id().equals(otherItem.pr.id())) {
104             return true;
105         }
106         if (!pr.repository().name().equals(otherItem.pr.repository().name())) {
107             return true;
108         }
109         return false;
110     }
111 
112     private void notifyListenersAdded(String issueId) {
113         pullRequestUpdateConsumers.forEach(c -&gt; c.handleNewIssue(pr, new Issue(issueId, &quot;&quot;)));
114     }
115 
116     private void notifyListenersRemoved(String issueId) {
117         pullRequestUpdateConsumers.forEach(c -&gt; c.handleRemovedIssue(pr, new Issue(issueId, &quot;&quot;)));
118     }
119 




120     @Override
121     public void run(Path scratchPath) {
122         var historyPath = scratchPath.resolve(&quot;notify&quot;).resolve(&quot;history&quot;);
123         var storage = prIssuesStorageBuilder
124                 .serializer(this::serializePrIssues)
125                 .deserializer(this::loadPrIssues)
126                 .materialize(historyPath);
127 
128         var issues = parseIssues();
129         var prIssues = new PullRequestIssues(pr, issues);
130         var current = storage.current();
131         if (current.contains(prIssues)) {
132             // Already up to date
133             return;
134         }
135 
136         // Search for an existing
137         var oldPrIssues = current.stream()
138                 .filter(p -&gt; p.prId().equals(prIssues.prId()))
139                 .findAny();
140         if (oldPrIssues.isPresent()) {
141             var oldIssues = oldPrIssues.get().issueIds();
142             oldIssues.stream()
143                      .filter(issue -&gt; !issues.contains(issue))
144                      .forEach(this::notifyListenersRemoved);
145             issues.stream()
146                   .filter(issue -&gt; !oldIssues.contains(issue))
147                   .forEach(this::notifyListenersAdded);
148         } else {

149             issues.forEach(this::notifyListenersAdded);
150         }
151 
152         storage.put(prIssues);
153     }
154 
155     @Override
156     public String toString() {
157         return &quot;Notify.PR@&quot; + pr.repository().name() + &quot;#&quot; + pr.id();
158     }
159 
160     @Override
161     public void handleRuntimeException(RuntimeException e) {
162         errorHandler.accept(e);
163     }
164 }
</pre>
</td>
<td>
<hr />
<pre>
100             return true;
101         }
102         PullRequestWorkItem otherItem = (PullRequestWorkItem)other;
103         if (!pr.id().equals(otherItem.pr.id())) {
104             return true;
105         }
106         if (!pr.repository().name().equals(otherItem.pr.repository().name())) {
107             return true;
108         }
109         return false;
110     }
111 
112     private void notifyListenersAdded(String issueId) {
113         pullRequestUpdateConsumers.forEach(c -&gt; c.handleNewIssue(pr, new Issue(issueId, &quot;&quot;)));
114     }
115 
116     private void notifyListenersRemoved(String issueId) {
117         pullRequestUpdateConsumers.forEach(c -&gt; c.handleRemovedIssue(pr, new Issue(issueId, &quot;&quot;)));
118     }
119 
<span class="line-added">120     private void notifyNewPr(PullRequest pr) {</span>
<span class="line-added">121         pullRequestUpdateConsumers.forEach(c -&gt; c.handleNewPullRequest(pr));</span>
<span class="line-added">122     }</span>
<span class="line-added">123 </span>
124     @Override
125     public void run(Path scratchPath) {
126         var historyPath = scratchPath.resolve(&quot;notify&quot;).resolve(&quot;history&quot;);
127         var storage = prIssuesStorageBuilder
128                 .serializer(this::serializePrIssues)
129                 .deserializer(this::loadPrIssues)
130                 .materialize(historyPath);
131 
132         var issues = parseIssues();
133         var prIssues = new PullRequestIssues(pr, issues);
134         var current = storage.current();
135         if (current.contains(prIssues)) {
136             // Already up to date
137             return;
138         }
139 
140         // Search for an existing
141         var oldPrIssues = current.stream()
142                 .filter(p -&gt; p.prId().equals(prIssues.prId()))
143                 .findAny();
144         if (oldPrIssues.isPresent()) {
145             var oldIssues = oldPrIssues.get().issueIds();
146             oldIssues.stream()
147                      .filter(issue -&gt; !issues.contains(issue))
148                      .forEach(this::notifyListenersRemoved);
149             issues.stream()
150                   .filter(issue -&gt; !oldIssues.contains(issue))
151                   .forEach(this::notifyListenersAdded);
152         } else {
<span class="line-added">153             notifyNewPr(pr);</span>
154             issues.forEach(this::notifyListenersAdded);
155         }
156 
157         storage.put(prIssues);
158     }
159 
160     @Override
161     public String toString() {
162         return &quot;Notify.PR@&quot; + pr.repository().name() + &quot;#&quot; + pr.id();
163     }
164 
165     @Override
166     public void handleRuntimeException(RuntimeException e) {
167         errorHandler.accept(e);
168     }
169 }
</pre>
</td>
</tr>
</table>
<center><a href="PullRequestUpdateConsumer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="RepositoryUpdateConsumer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>