<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/main/java/org/openjdk/skara/bots/notify/PullRequestWorkItem.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/notify/src/main/java/org/openjdk/skara/bots/notify/PullRequestWorkItem.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
174     public Collection&lt;WorkItem&gt; run(Path scratchPath) {
175         var historyPath = scratchPath.resolve(&quot;notify&quot;).resolve(&quot;history&quot;);
176         var storage = prStateStorageBuilder
177                 .serializer(this::serializePrState)
178                 .deserializer(this::deserializePrState)
179                 .materialize(historyPath);
180 
181         var issues = parseIssues();
182         var commit = resultingCommitHashFor(pr);
183         var state = new PullRequestState(pr, issues, commit);
184         var stored = storage.current();
185         if (stored.contains(state)) {
186             // Already up to date
187             return List.of();
188         }
189 
190         // Search for an existing
191         var storedState = stored.stream()
192                 .filter(ss -&gt; ss.prId().equals(state.prId()))
193                 .findAny();
<span class="line-modified">194         if (storedState.isPresent()) {</span>
<span class="line-modified">195             // The stored entry could be old and be missing commit information - if so, upgrade it</span>
<span class="line-modified">196             if (storedState.get().commitId().isPresent() &amp;&amp; storedState.get().commitId().get().equals(Hash.zero())) {</span>
<span class="line-modified">197                 var hash = resultingCommitHashFor(pr);</span>
<span class="line-modified">198                 storedState = Optional.of(new PullRequestState(pr, issues, hash));</span>
<span class="line-modified">199             }</span>
200 

201             var storedIssues = storedState.get().issueIds();
202             storedIssues.stream()
203                         .filter(issue -&gt; !issues.contains(issue))
204                         .forEach(this::notifyRemovedIssue);
205             issues.stream()
206                   .filter(issue -&gt; !storedIssues.contains(issue))
207                   .forEach(this::notifyNewIssue);
208 
209             var storedCommit = storedState.get().commitId();
210             if (!storedCommit.isPresent() &amp;&amp; state.commitId().isPresent()) {
211                 notifyIntegratedPr(pr, state.commitId().get());
212             }
213         } else {
214             notifyNewPr(pr);
215             issues.forEach(this::notifyNewIssue);
216             if (state.commitId().isPresent()) {
217                 notifyIntegratedPr(pr, state.commitId().get());
218             }
219         }
220 
</pre>
</td>
<td>
<hr />
<pre>
174     public Collection&lt;WorkItem&gt; run(Path scratchPath) {
175         var historyPath = scratchPath.resolve(&quot;notify&quot;).resolve(&quot;history&quot;);
176         var storage = prStateStorageBuilder
177                 .serializer(this::serializePrState)
178                 .deserializer(this::deserializePrState)
179                 .materialize(historyPath);
180 
181         var issues = parseIssues();
182         var commit = resultingCommitHashFor(pr);
183         var state = new PullRequestState(pr, issues, commit);
184         var stored = storage.current();
185         if (stored.contains(state)) {
186             // Already up to date
187             return List.of();
188         }
189 
190         // Search for an existing
191         var storedState = stored.stream()
192                 .filter(ss -&gt; ss.prId().equals(state.prId()))
193                 .findAny();
<span class="line-modified">194         // The stored entry could be old and be missing commit information - if so, upgrade it</span>
<span class="line-modified">195         if (storedState.isPresent() &amp;&amp; storedState.get().commitId().equals(Optional.of(Hash.zero()))) {</span>
<span class="line-modified">196             var hash = resultingCommitHashFor(pr);</span>
<span class="line-modified">197             storedState = Optional.of(new PullRequestState(pr, storedState.get().issueIds(), hash));</span>
<span class="line-modified">198             storage.put(storedState.get());</span>
<span class="line-modified">199         }</span>
200 
<span class="line-added">201         if (storedState.isPresent()) {</span>
202             var storedIssues = storedState.get().issueIds();
203             storedIssues.stream()
204                         .filter(issue -&gt; !issues.contains(issue))
205                         .forEach(this::notifyRemovedIssue);
206             issues.stream()
207                   .filter(issue -&gt; !storedIssues.contains(issue))
208                   .forEach(this::notifyNewIssue);
209 
210             var storedCommit = storedState.get().commitId();
211             if (!storedCommit.isPresent() &amp;&amp; state.commitId().isPresent()) {
212                 notifyIntegratedPr(pr, state.commitId().get());
213             }
214         } else {
215             notifyNewPr(pr);
216             issues.forEach(this::notifyNewIssue);
217             if (state.commitId().isPresent()) {
218                 notifyIntegratedPr(pr, state.commitId().get());
219             }
220         }
221 
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>