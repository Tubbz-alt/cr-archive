<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/UpdatedBranch.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -20,1800 +20,40 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package org.openjdk.skara.bots.notify;
  
<span class="udiff-line-modified-removed">- import org.openjdk.skara.email.*;</span>
<span class="udiff-line-modified-added">+ import org.junit.jupiter.api.*;</span>
  import org.openjdk.skara.forge.HostedRepository;
<span class="udiff-line-removed">- import org.openjdk.skara.issuetracker.Issue;</span>
<span class="udiff-line-removed">- import org.openjdk.skara.json.*;</span>
<span class="udiff-line-removed">- import org.openjdk.skara.mailinglist.MailingListServerFactory;</span>
  import org.openjdk.skara.storage.StorageBuilder;
  import org.openjdk.skara.test.*;
<span class="udiff-line-removed">- import org.openjdk.skara.vcs.*;</span>
  import org.openjdk.skara.vcs.Tag;
<span class="udiff-line-added">+ import org.openjdk.skara.vcs.*;</span>
  import org.openjdk.skara.vcs.openjdk.OpenJDKTag;
  
<span class="udiff-line-removed">- import org.junit.jupiter.api.*;</span>
<span class="udiff-line-removed">- </span>
  import java.io.IOException;
<span class="udiff-line-modified-removed">- import java.net.URI;</span>
<span class="udiff-line-removed">- import java.nio.charset.StandardCharsets;</span>
<span class="udiff-line-removed">- import java.nio.file.*;</span>
<span class="udiff-line-removed">- import java.time.Duration;</span>
<span class="udiff-line-removed">- import java.util.*;</span>
<span class="udiff-line-modified-added">+ import java.util.List;</span>
  import java.util.regex.Pattern;
<span class="udiff-line-removed">- import java.util.stream.Collectors;</span>
  
  import static org.junit.jupiter.api.Assertions.*;
<span class="udiff-line-removed">- import static org.openjdk.skara.issuetracker.Issue.State.*;</span>
  
<span class="udiff-line-modified-removed">- class UpdaterTests {</span>
<span class="udiff-line-modified-removed">-     private List&lt;Path&gt; findJsonFiles(Path folder, String partialName) throws IOException {</span>
<span class="udiff-line-removed">-         return Files.walk(folder)</span>
<span class="udiff-line-removed">-                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))</span>
<span class="udiff-line-removed">-                     .filter(path -&gt; path.toString().contains(partialName))</span>
<span class="udiff-line-removed">-                     .collect(Collectors.toList());</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private StorageBuilder&lt;UpdatedTag&gt; createTagStorage(HostedRepository repository) {</span>
<span class="udiff-line-modified-added">+ public class UpdaterTests {</span>
<span class="udiff-line-modified-added">+     public static StorageBuilder&lt;UpdatedTag&gt; createTagStorage(HostedRepository repository) {</span>
          return new StorageBuilder&lt;UpdatedTag&gt;(&quot;tags.txt&quot;)
                  .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);
      }
  
<span class="udiff-line-modified-removed">-     private StorageBuilder&lt;UpdatedBranch&gt; createBranchStorage(HostedRepository repository) {</span>
<span class="udiff-line-modified-added">+     public static StorageBuilder&lt;UpdatedBranch&gt; createBranchStorage(HostedRepository repository) {</span>
          return new StorageBuilder&lt;UpdatedBranch&gt;(&quot;branches.txt&quot;)
                  .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);
      }
  
<span class="udiff-line-modified-removed">-     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {</span>
<span class="udiff-line-modified-added">+     public static StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {</span>
          return new StorageBuilder&lt;PullRequestIssues&gt;(&quot;prissues.txt&quot;)
                  .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated prissues&quot;);
      }
  
<span class="udiff-line-removed">-     private Set&lt;String&gt; fixVersions(Issue issue) {</span>
<span class="udiff-line-removed">-         if (!issue.properties().containsKey(&quot;fixVersions&quot;)) {</span>
<span class="udiff-line-removed">-             return Set.of();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return issue.properties().get(&quot;fixVersions&quot;).stream()</span>
<span class="udiff-line-removed">-                     .map(JSONValue::asString)</span>
<span class="udiff-line-removed">-                     .collect(Collectors.toSet());</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);</span>
<span class="udiff-line-removed">-             Files.createDirectory(jsonFolder);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);</span>
<span class="udiff-line-removed">-             assertEquals(1, jsonFiles.size());</span>
<span class="udiff-line-removed">-             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);</span>
<span class="udiff-line-removed">-             var json = JSON.parse(jsonData);</span>
<span class="udiff-line-removed">-             assertEquals(1, json.asArray().size());</span>
<span class="udiff-line-removed">-             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());</span>
<span class="udiff-line-removed">-             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()</span>
<span class="udiff-line-removed">-                                                   .map(JSONValue::asString)</span>
<span class="udiff-line-removed">-                                                   .collect(Collectors.toList()));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-removed">-             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);</span>
<span class="udiff-line-removed">-             Files.createDirectory(jsonFolder);</span>
<span class="udiff-line-removed">-             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.fetch(repo.url(), &quot;history:history&quot;);</span>
<span class="udiff-line-removed">-             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);</span>
<span class="udiff-line-removed">-             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);</span>
<span class="udiff-line-removed">-             assertEquals(3, jsonFiles.size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             for (var file : jsonFiles) {</span>
<span class="udiff-line-removed">-                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);</span>
<span class="udiff-line-removed">-                 var json = JSON.parse(jsonData);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 if (json.asArray().get(0).contains(&quot;date&quot;)) {</span>
<span class="udiff-line-removed">-                     assertEquals(2, json.asArray().size());</span>
<span class="udiff-line-removed">-                     assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()</span>
<span class="udiff-line-removed">-                                                           .map(JSONValue::asString)</span>
<span class="udiff-line-removed">-                                                           .collect(Collectors.toList()));</span>
<span class="udiff-line-removed">-                     assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());</span>
<span class="udiff-line-removed">-                     assertEquals(&quot;team&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());</span>
<span class="udiff-line-removed">-                     assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(1).get(&quot;issue&quot;).asArray().stream()</span>
<span class="udiff-line-removed">-                                                           .map(JSONValue::asString)</span>
<span class="udiff-line-removed">-                                                           .collect(Collectors.toList()));</span>
<span class="udiff-line-removed">-                     assertEquals(repo.webUrl(editHash2).toString(), json.asArray().get(1).get(&quot;url&quot;).asString());</span>
<span class="udiff-line-removed">-                     assertEquals(&quot;team&quot;, json.asArray().get(1).get(&quot;build&quot;).asString());</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                     assertEquals(1, json.asArray().size());</span>
<span class="udiff-line-removed">-                     if (json.asArray().get(0).get(&quot;build&quot;).asString().equals(&quot;b02&quot;)) {</span>
<span class="udiff-line-removed">-                         assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()</span>
<span class="udiff-line-removed">-                                                               .map(JSONValue::asString)</span>
<span class="udiff-line-removed">-                                                               .collect(Collectors.toList()));</span>
<span class="udiff-line-removed">-                     } else {</span>
<span class="udiff-line-removed">-                         assertEquals(&quot;b04&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());</span>
<span class="udiff-line-removed">-                         assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()</span>
<span class="udiff-line-removed">-                                                               .map(JSONValue::asString)</span>
<span class="udiff-line-removed">-                                                               .collect(Collectors.toList()));</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testMailingList(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var listServer = new TestMailmanServer();</span>
<span class="udiff-line-removed">-              var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-removed">-             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="udiff-line-removed">-             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-removed">-             var updater = MailingListUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                             .list(mailmanList)</span>
<span class="udiff-line-removed">-                                             .recipient(listAddress)</span>
<span class="udiff-line-removed">-                                             .sender(sender)</span>
<span class="udiff-line-removed">-                                             .reportNewTags(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBranches(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBuilds(false)</span>
<span class="udiff-line-removed">-                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="udiff-line-removed">-                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))</span>
<span class="udiff-line-removed">-                                             .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // No mail should be sent on the first run as there is no history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             var email = conversations.get(0).first();</span>
<span class="udiff-line-removed">-             assertEquals(listAddress, email.sender());</span>
<span class="udiff-line-removed">-             assertEquals(sender, email.author());</span>
<span class="udiff-line-removed">-             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="udiff-line-removed">-             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));</span>
<span class="udiff-line-removed">-             assertFalse(email.subject().contains(&quot;master&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="udiff-line-removed">-             assertFalse(email.body().contains(&quot;Committer&quot;));</span>
<span class="udiff-line-removed">-             assertFalse(email.body().contains(masterHash.abbreviate()));</span>
<span class="udiff-line-removed">-             assertTrue(email.hasHeader(&quot;extra1&quot;));</span>
<span class="udiff-line-removed">-             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.hasHeader(&quot;extra2&quot;));</span>
<span class="udiff-line-removed">-             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="udiff-line-removed">-             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="udiff-line-removed">-             assertEquals(editHash.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testMailingListMultiple(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var listServer = new TestMailmanServer();</span>
<span class="udiff-line-removed">-              var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-removed">-             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="udiff-line-removed">-             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-removed">-             var updater = MailingListUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                             .list(mailmanList)</span>
<span class="udiff-line-removed">-                                             .recipient(listAddress)</span>
<span class="udiff-line-removed">-                                             .sender(sender)</span>
<span class="udiff-line-removed">-                                             .reportNewTags(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBranches(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBuilds(false)</span>
<span class="udiff-line-removed">-                                             .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // No mail should be sent on the first run as there is no history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,</span>
<span class="udiff-line-removed">-                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash1, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,</span>
<span class="udiff-line-removed">-                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash2, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             var email = conversations.get(0).first();</span>
<span class="udiff-line-removed">-             assertEquals(listAddress, email.sender());</span>
<span class="udiff-line-removed">-             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());</span>
<span class="udiff-line-removed">-             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="udiff-line-removed">-             assertTrue(email.subject().contains(&quot;: 2 new changesets&quot;));</span>
<span class="udiff-line-removed">-             assertFalse(email.subject().contains(&quot;master&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));</span>
<span class="udiff-line-removed">-             assertFalse(email.body().contains(masterHash.abbreviate()));</span>
<span class="udiff-line-removed">-             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="udiff-line-removed">-             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="udiff-line-removed">-             assertEquals(editHash1.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testMailingListSponsored(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var listServer = new TestMailmanServer();</span>
<span class="udiff-line-removed">-              var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-removed">-             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="udiff-line-removed">-             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-removed">-             var updater = MailingListUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                             .list(mailmanList)</span>
<span class="udiff-line-removed">-                                             .recipient(listAddress)</span>
<span class="udiff-line-removed">-                                             .sender(sender)</span>
<span class="udiff-line-removed">-                                             .reportNewTags(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBranches(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBuilds(false)</span>
<span class="udiff-line-removed">-                                             .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // No mail should be sent on the first run as there is no history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,</span>
<span class="udiff-line-removed">-                                                                &quot;author&quot;, &quot;author@test.test&quot;,</span>
<span class="udiff-line-removed">-                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             var email = conversations.get(0).first();</span>
<span class="udiff-line-removed">-             assertEquals(listAddress, email.sender());</span>
<span class="udiff-line-removed">-             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());</span>
<span class="udiff-line-removed">-             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;Committer: committer &lt;committer@test.test&gt;&quot;));</span>
<span class="udiff-line-removed">-             assertFalse(email.body().contains(masterHash.abbreviate()));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testMailingListMultipleBranches(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var listServer = new TestMailmanServer();</span>
<span class="udiff-line-removed">-              var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             var branch = localRepo.branch(masterHash, &quot;another&quot;);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-removed">-             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="udiff-line-removed">-             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-removed">-             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);</span>
<span class="udiff-line-removed">-             var updater = MailingListUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                             .list(mailmanList)</span>
<span class="udiff-line-removed">-                                             .recipient(listAddress)</span>
<span class="udiff-line-removed">-                                             .sender(sender)</span>
<span class="udiff-line-removed">-                                             .author(author)</span>
<span class="udiff-line-removed">-                                             .includeBranch(true)</span>
<span class="udiff-line-removed">-                                             .reportNewTags(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBranches(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBuilds(false)</span>
<span class="udiff-line-removed">-                                             .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master|another&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // No mail should be sent on the first run as there is no history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash1, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash2, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             var email = conversations.get(0).first();</span>
<span class="udiff-line-removed">-             assertEquals(listAddress, email.sender());</span>
<span class="udiff-line-removed">-             assertEquals(author, email.author());</span>
<span class="udiff-line-removed">-             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="udiff-line-removed">-             assertFalse(email.subject().contains(&quot;another&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));</span>
<span class="udiff-line-removed">-             assertFalse(email.body().contains(masterHash.abbreviate()));</span>
<span class="udiff-line-removed">-             assertFalse(email.body().contains(&quot;456789AB: Yet more fixes&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="udiff-line-removed">-             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="udiff-line-removed">-             assertEquals(editHash1.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             localRepo.checkout(branch, true);</span>
<span class="udiff-line-removed">-             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash3, repo.url(), &quot;another&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));</span>
<span class="udiff-line-removed">-             email = conversations.get(0).first();</span>
<span class="udiff-line-removed">-             assertEquals(author, email.author());</span>
<span class="udiff-line-removed">-             assertEquals(listAddress, email.sender());</span>
<span class="udiff-line-removed">-             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="udiff-line-removed">-             assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));</span>
<span class="udiff-line-removed">-             assertFalse(email.subject().contains(&quot;master&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));</span>
<span class="udiff-line-removed">-             assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));</span>
<span class="udiff-line-removed">-             assertFalse(email.body().contains(&quot;3456789A: Even more fixes&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="udiff-line-removed">-             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="udiff-line-removed">-             assertEquals(editHash3.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testMailingListPROnlyMultipleBranches(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var listServer = new TestMailmanServer();</span>
<span class="udiff-line-removed">-              var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-removed">-             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="udiff-line-removed">-             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-removed">-             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);</span>
<span class="udiff-line-removed">-             var updater = MailingListUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                             .list(mailmanList)</span>
<span class="udiff-line-removed">-                                             .recipient(listAddress)</span>
<span class="udiff-line-removed">-                                             .sender(sender)</span>
<span class="udiff-line-removed">-                                             .author(author)</span>
<span class="udiff-line-removed">-                                             .reportNewTags(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBranches(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBuilds(false)</span>
<span class="udiff-line-removed">-                                             .includeBranch(true)</span>
<span class="udiff-line-removed">-                                             .mode(MailingListUpdater.Mode.PR)</span>
<span class="udiff-line-removed">-                                             .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master|other&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Populate our known branches</span>
<span class="udiff-line-removed">-             localRepo.push(masterHash, repo.url(), &quot;master&quot;, true);</span>
<span class="udiff-line-removed">-             localRepo.push(masterHash, repo.url(), &quot;other&quot;, true);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // No mail should be sent on the first run as there is no history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             localRepo.checkout(masterHash, true);</span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;edit&quot;);</span>
<span class="udiff-line-removed">-             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // PR hasn&#39;t been integrated yet, so there should be no mail</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Simulate an RFR email</span>
<span class="udiff-line-removed">-             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())</span>
<span class="udiff-line-removed">-                            .recipient(listAddress)</span>
<span class="udiff-line-removed">-                            .build();</span>
<span class="udiff-line-removed">-             mailmanList.post(rfr);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // And an integration (but it hasn&#39;t reached master just yet)</span>
<span class="udiff-line-removed">-             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Now push the same commit to another branch</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;other&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // This one should generate a plain integration mail</span>
<span class="udiff-line-removed">-             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             assertEquals(2, conversations.size());</span>
<span class="udiff-line-removed">-             var secondEmail = conversations.get(0).first();</span>
<span class="udiff-line-removed">-             if (secondEmail.subject().contains(&quot;RFR&quot;)) {</span>
<span class="udiff-line-removed">-                 secondEmail = conversations.get(1).first();</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             assertEquals(&quot;git: test: other: 23456789: More fixes&quot;, secondEmail.subject());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testMailingListPR(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var listServer = new TestMailmanServer();</span>
<span class="udiff-line-removed">-              var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-removed">-             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="udiff-line-removed">-             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-removed">-             var updater = MailingListUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                             .list(mailmanList)</span>
<span class="udiff-line-removed">-                                             .recipient(listAddress)</span>
<span class="udiff-line-removed">-                                             .sender(sender)</span>
<span class="udiff-line-removed">-                                             .reportNewTags(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBranches(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBuilds(false)</span>
<span class="udiff-line-removed">-                                             .mode(MailingListUpdater.Mode.PR)</span>
<span class="udiff-line-removed">-                                             .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // No mail should be sent on the first run as there is no history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;edit&quot;);</span>
<span class="udiff-line-removed">-             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Create a potentially conflicting one</span>
<span class="udiff-line-removed">-             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(otherHash, repo.url(), &quot;other&quot;);</span>
<span class="udiff-line-removed">-             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // PR hasn&#39;t been integrated yet, so there should be no mail</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Simulate an RFR email</span>
<span class="udiff-line-removed">-             var rfr = Email.create(&quot;[repo/branch] RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())</span>
<span class="udiff-line-removed">-                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))</span>
<span class="udiff-line-removed">-                            .recipient(listAddress)</span>
<span class="udiff-line-removed">-                            .build();</span>
<span class="udiff-line-removed">-             mailmanList.post(rfr);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // And an integration</span>
<span class="udiff-line-removed">-             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Push the other one without a matching PR</span>
<span class="udiff-line-removed">-             localRepo.push(otherHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));</span>
<span class="udiff-line-removed">-             assertEquals(2, conversations.size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var prConversation = conversations.get(0);</span>
<span class="udiff-line-removed">-             var pushConversation = conversations.get(1);</span>
<span class="udiff-line-removed">-             assertEquals(1, prConversation.allMessages().size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var pushEmail = pushConversation.first();</span>
<span class="udiff-line-removed">-             assertEquals(listAddress, pushEmail.sender());</span>
<span class="udiff-line-removed">-             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());</span>
<span class="udiff-line-removed">-             assertEquals(pushEmail.recipients(), List.of(listAddress));</span>
<span class="udiff-line-removed">-             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testMailingListPROnce(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var listServer = new TestMailmanServer();</span>
<span class="udiff-line-removed">-              var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-removed">-             localRepo.branch(masterHash, &quot;other&quot;);</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-removed">-             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="udiff-line-removed">-             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-removed">-             var updater = MailingListUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                             .list(mailmanList)</span>
<span class="udiff-line-removed">-                                             .recipient(listAddress)</span>
<span class="udiff-line-removed">-                                             .sender(sender)</span>
<span class="udiff-line-removed">-                                             .author(null)</span>
<span class="udiff-line-removed">-                                             .reportNewTags(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBranches(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBuilds(false)</span>
<span class="udiff-line-removed">-                                             .mode(MailingListUpdater.Mode.PR)</span>
<span class="udiff-line-removed">-                                             .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master|other&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // No mail should be sent on the first run as there is no history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             localRepo.checkout(masterHash, true);</span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;edit&quot;);</span>
<span class="udiff-line-removed">-             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // PR hasn&#39;t been integrated yet, so there should be no mail</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Simulate an RFR email</span>
<span class="udiff-line-removed">-             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())</span>
<span class="udiff-line-removed">-                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))</span>
<span class="udiff-line-removed">-                            .recipient(listAddress)</span>
<span class="udiff-line-removed">-                            .build();</span>
<span class="udiff-line-removed">-             mailmanList.post(rfr);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // And an integration</span>
<span class="udiff-line-removed">-             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;, true);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             assertEquals(1, conversations.size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var prConversation = conversations.get(0);</span>
<span class="udiff-line-removed">-             assertEquals(1, prConversation.allMessages().size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Now push the change to another monitored branch</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;other&quot;, true);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The change should now end up as a separate notification thread</span>
<span class="udiff-line-removed">-             conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));</span>
<span class="udiff-line-removed">-             assertEquals(2, conversations.size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var pushConversation = conversations.get(1);</span>
<span class="udiff-line-removed">-             var pushEmail = pushConversation.first();</span>
<span class="udiff-line-removed">-             assertEquals(listAddress, pushEmail.sender());</span>
<span class="udiff-line-removed">-             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());</span>
<span class="udiff-line-removed">-             assertEquals(pushEmail.recipients(), List.of(listAddress));</span>
<span class="udiff-line-removed">-             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testMailinglistTag(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory();</span>
<span class="udiff-line-removed">-              var listServer = new TestMailmanServer()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-removed">-             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-removed">-             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="udiff-line-removed">-             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-removed">-             var updater = MailingListUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                             .list(mailmanList)</span>
<span class="udiff-line-removed">-                                             .recipient(listAddress)</span>
<span class="udiff-line-removed">-                                             .sender(sender)</span>
<span class="udiff-line-removed">-                                             .reportNewBranches(false)</span>
<span class="udiff-line-removed">-                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="udiff-line-removed">-                                             .build();</span>
<span class="udiff-line-removed">-             var noTagsUpdater = MailingListUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                                   .list(mailmanList)</span>
<span class="udiff-line-removed">-                                                   .recipient(listAddress)</span>
<span class="udiff-line-removed">-                                                   .sender(sender)</span>
<span class="udiff-line-removed">-                                                   .reportNewTags(false)</span>
<span class="udiff-line-removed">-                                                   .reportNewBranches(false)</span>
<span class="udiff-line-removed">-                                                   .reportNewBuilds(false)</span>
<span class="udiff-line-removed">-                                                   .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater, noTagsUpdater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // No mail should be sent on the first run as there is no history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.fetch(repo.url(), &quot;history:history&quot;);</span>
<span class="udiff-line-removed">-             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="udiff-line-removed">-             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);</span>
<span class="udiff-line-removed">-             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);</span>
<span class="udiff-line-removed">-             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="udiff-line-removed">-             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);</span>
<span class="udiff-line-removed">-             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             assertEquals(4, conversations.size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             for (var conversation : conversations) {</span>
<span class="udiff-line-removed">-                 var email = conversation.first();</span>
<span class="udiff-line-removed">-                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {</span>
<span class="udiff-line-removed">-                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="udiff-line-removed">-                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {</span>
<span class="udiff-line-removed">-                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="udiff-line-removed">-                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {</span>
<span class="udiff-line-removed">-                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="udiff-line-removed">-                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {</span>
<span class="udiff-line-removed">-                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertTrue(email.body().contains(&quot;67890123: Brand new fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));</span>
<span class="udiff-line-removed">-                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                     fail(&quot;Mismatched subject: &quot; + email.subject());</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 assertTrue(email.hasHeader(&quot;extra1&quot;));</span>
<span class="udiff-line-removed">-                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));</span>
<span class="udiff-line-removed">-                 assertTrue(email.hasHeader(&quot;extra2&quot;));</span>
<span class="udiff-line-removed">-                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testMailinglistPlainTags(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory();</span>
<span class="udiff-line-removed">-              var listServer = new TestMailmanServer()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-removed">-             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-removed">-             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="udiff-line-removed">-             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-removed">-             var updater = MailingListUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                             .list(mailmanList)</span>
<span class="udiff-line-removed">-                                             .recipient(listAddress)</span>
<span class="udiff-line-removed">-                                             .sender(sender)</span>
<span class="udiff-line-removed">-                                             .reportNewBranches(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBuilds(false)</span>
<span class="udiff-line-removed">-                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="udiff-line-removed">-                                             .build();</span>
<span class="udiff-line-removed">-             var noTagsUpdater = MailingListUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                                   .list(mailmanList)</span>
<span class="udiff-line-removed">-                                                   .recipient(listAddress)</span>
<span class="udiff-line-removed">-                                                   .sender(sender)</span>
<span class="udiff-line-removed">-                                                   .reportNewTags(false)</span>
<span class="udiff-line-removed">-                                                   .reportNewBranches(false)</span>
<span class="udiff-line-removed">-                                                   .reportNewBuilds(false)</span>
<span class="udiff-line-removed">-                                                   .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater, noTagsUpdater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // No mail should be sent on the first run as there is no history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.fetch(repo.url(), &quot;history:history&quot;);</span>
<span class="udiff-line-removed">-             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="udiff-line-removed">-             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);</span>
<span class="udiff-line-removed">-             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);</span>
<span class="udiff-line-removed">-             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="udiff-line-removed">-             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);</span>
<span class="udiff-line-removed">-             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             assertEquals(4, conversations.size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             for (var conversation : conversations) {</span>
<span class="udiff-line-removed">-                 var email = conversation.first();</span>
<span class="udiff-line-removed">-                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {</span>
<span class="udiff-line-removed">-                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="udiff-line-removed">-                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {</span>
<span class="udiff-line-removed">-                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="udiff-line-removed">-                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {</span>
<span class="udiff-line-removed">-                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="udiff-line-removed">-                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {</span>
<span class="udiff-line-removed">-                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                     fail(&quot;Mismatched subject: &quot; + email.subject());</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 assertTrue(email.hasHeader(&quot;extra1&quot;));</span>
<span class="udiff-line-removed">-                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));</span>
<span class="udiff-line-removed">-                 assertTrue(email.hasHeader(&quot;extra2&quot;));</span>
<span class="udiff-line-removed">-                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testMailingListBranch(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var listServer = new TestMailmanServer();</span>
<span class="udiff-line-removed">-              var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-removed">-             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="udiff-line-removed">-             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-removed">-             var updater = MailingListUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                             .list(mailmanList)</span>
<span class="udiff-line-removed">-                                             .recipient(listAddress)</span>
<span class="udiff-line-removed">-                                             .sender(sender)</span>
<span class="udiff-line-removed">-                                             .reportNewTags(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBuilds(false)</span>
<span class="udiff-line-removed">-                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="udiff-line-removed">-                                             .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master|newbranch.&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // No mail should be sent on the first run as there is no history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);</span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             var email = conversations.get(0).first();</span>
<span class="udiff-line-removed">-             assertEquals(listAddress, email.sender());</span>
<span class="udiff-line-removed">-             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());</span>
<span class="udiff-line-removed">-             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="udiff-line-removed">-             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());</span>
<span class="udiff-line-removed">-             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.hasHeader(&quot;extra1&quot;));</span>
<span class="udiff-line-removed">-             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));</span>
<span class="udiff-line-removed">-             assertTrue(email.hasHeader(&quot;extra2&quot;));</span>
<span class="udiff-line-removed">-             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()</span>
<span class="udiff-line-removed">-                                              .filter(c -&gt; !c.equals(conversations.get(0)))</span>
<span class="udiff-line-removed">-                                              .findFirst().orElseThrow();</span>
<span class="udiff-line-removed">-             email = newConversation.first();</span>
<span class="udiff-line-removed">-             assertEquals(listAddress, email.sender());</span>
<span class="udiff-line-removed">-             assertEquals(sender, email.author());</span>
<span class="udiff-line-removed">-             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="udiff-line-removed">-             assertEquals(&quot;git: test: created branch newbranch2 based on the branch newbranch1 containing 0 unique commits&quot;, email.subject());</span>
<span class="udiff-line-removed">-             assertEquals(&quot;The new branch newbranch2 is currently identical to the newbranch1 branch.&quot;, email.body());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var listServer = new TestMailmanServer();</span>
<span class="udiff-line-removed">-              var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-removed">-             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="udiff-line-removed">-             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-removed">-             var updater = MailingListUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                             .list(mailmanList)</span>
<span class="udiff-line-removed">-                                             .recipient(listAddress)</span>
<span class="udiff-line-removed">-                                             .sender(sender)</span>
<span class="udiff-line-removed">-                                             .reportNewTags(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBranches(false)</span>
<span class="udiff-line-removed">-                                             .reportNewBuilds(false)</span>
<span class="udiff-line-removed">-                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="udiff-line-removed">-                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))</span>
<span class="udiff-line-removed">-                                             .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // No mail should be sent on the first run as there is no history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Save history state</span>
<span class="udiff-line-removed">-             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             assertEquals(1, conversations.size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Reset the history</span>
<span class="udiff-line-removed">-             localRepo.push(historyHash, repo.url(), &quot;history&quot;, true);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             listServer.processIncoming();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // There should now be a duplicate mail</span>
<span class="udiff-line-removed">-             conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-removed">-             assertEquals(2, conversations.size());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testIssue(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var issueProject = credentials.getIssueProject();</span>
<span class="udiff-line-removed">-             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);</span>
<span class="udiff-line-removed">-             var updater = IssueUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                       .issueProject(issueProject)</span>
<span class="udiff-line-removed">-                                       .reviewLink(false)</span>
<span class="udiff-line-removed">-                                       .commitIcon(commitIcon)</span>
<span class="udiff-line-removed">-                                       .setFixVersion(true)</span>
<span class="udiff-line-removed">-                                       .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Initialize history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Create an issue and commit a fix</span>
<span class="udiff-line-removed">-             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;</span>
<span class="udiff-line-removed">-             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The changeset should be reflected in a comment</span>
<span class="udiff-line-removed">-             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var comments = updatedIssue.comments();</span>
<span class="udiff-line-removed">-             assertEquals(1, comments.size());</span>
<span class="udiff-line-removed">-             var comment = comments.get(0);</span>
<span class="udiff-line-removed">-             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // And in a link</span>
<span class="udiff-line-removed">-             var links = updatedIssue.links();</span>
<span class="udiff-line-removed">-             assertEquals(1, links.size());</span>
<span class="udiff-line-removed">-             var link = links.get(0);</span>
<span class="udiff-line-removed">-             assertEquals(commitIcon, link.iconUrl().orElseThrow());</span>
<span class="udiff-line-removed">-             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());</span>
<span class="udiff-line-removed">-             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // As well as a fixVersion</span>
<span class="udiff-line-removed">-             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The issue should be assigned and resolved</span>
<span class="udiff-line-removed">-             assertEquals(RESOLVED, updatedIssue.state());</span>
<span class="udiff-line-removed">-             assertEquals(List.of(issueProject.issueTracker().currentUser()), updatedIssue.assignees());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testIssueNoVersion(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var issueProject = credentials.getIssueProject();</span>
<span class="udiff-line-removed">-             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);</span>
<span class="udiff-line-removed">-             var updater = IssueUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                       .issueProject(issueProject)</span>
<span class="udiff-line-removed">-                                       .reviewLink(false)</span>
<span class="udiff-line-removed">-                                       .commitIcon(commitIcon)</span>
<span class="udiff-line-removed">-                                       .setFixVersion(true)</span>
<span class="udiff-line-removed">-                                       .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Initialize history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Create an issue and commit a fix</span>
<span class="udiff-line-removed">-             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The changeset should be reflected in a comment</span>
<span class="udiff-line-removed">-             var comments = issue.comments();</span>
<span class="udiff-line-removed">-             assertEquals(1, comments.size());</span>
<span class="udiff-line-removed">-             var comment = comments.get(0);</span>
<span class="udiff-line-removed">-             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // But not in the fixVersion</span>
<span class="udiff-line-removed">-             assertEquals(Set.of(), fixVersions(issue));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var issueProject = credentials.getIssueProject();</span>
<span class="udiff-line-removed">-             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);</span>
<span class="udiff-line-removed">-             var updater = IssueUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                       .issueProject(issueProject)</span>
<span class="udiff-line-removed">-                                       .reviewLink(false)</span>
<span class="udiff-line-removed">-                                       .commitLink(false)</span>
<span class="udiff-line-removed">-                                       .commitIcon(commitIcon)</span>
<span class="udiff-line-removed">-                                       .setFixVersion(true)</span>
<span class="udiff-line-removed">-                                       .fixVersions(Map.of(&quot;master&quot;, &quot;2.0&quot;))</span>
<span class="udiff-line-removed">-                                       .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Initialize history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Create an issue and commit a fix</span>
<span class="udiff-line-removed">-             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The changeset should not reflected in a comment</span>
<span class="udiff-line-removed">-             var comments = issue.comments();</span>
<span class="udiff-line-removed">-             assertEquals(1, comments.size());</span>
<span class="udiff-line-removed">-             var comment = comments.get(0);</span>
<span class="udiff-line-removed">-             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // As well as a fixVersion - but not the one from the repo</span>
<span class="udiff-line-removed">-             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // And no commit link</span>
<span class="udiff-line-removed">-             var links = issue.links();</span>
<span class="udiff-line-removed">-             assertEquals(0, links.size());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testIssueIdempotence(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var issueProject = credentials.getIssueProject();</span>
<span class="udiff-line-removed">-             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);</span>
<span class="udiff-line-removed">-             var updater = IssueUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                       .issueProject(issueProject)</span>
<span class="udiff-line-removed">-                                       .reviewLink(false)</span>
<span class="udiff-line-removed">-                                       .commitIcon(commitIcon)</span>
<span class="udiff-line-removed">-                                       .setFixVersion(true)</span>
<span class="udiff-line-removed">-                                       .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Initialize history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Save the state</span>
<span class="udiff-line-removed">-             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Create an issue and commit a fix</span>
<span class="udiff-line-removed">-             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The changeset should be reflected in a comment</span>
<span class="udiff-line-removed">-             var comments = issue.comments();</span>
<span class="udiff-line-removed">-             assertEquals(1, comments.size());</span>
<span class="udiff-line-removed">-             var comment = comments.get(0);</span>
<span class="udiff-line-removed">-             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // And in a link</span>
<span class="udiff-line-removed">-             var links = issue.links();</span>
<span class="udiff-line-removed">-             assertEquals(1, links.size());</span>
<span class="udiff-line-removed">-             var link = links.get(0);</span>
<span class="udiff-line-removed">-             assertEquals(commitIcon, link.iconUrl().orElseThrow());</span>
<span class="udiff-line-removed">-             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());</span>
<span class="udiff-line-removed">-             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // As well as a fixVersion</span>
<span class="udiff-line-removed">-             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Wipe the history</span>
<span class="udiff-line-removed">-             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Run it again</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // There should be no new comments, links or fixVersions</span>
<span class="udiff-line-removed">-             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="udiff-line-removed">-             assertEquals(1, updatedIssue.comments().size());</span>
<span class="udiff-line-removed">-             assertEquals(1, updatedIssue.links().size());</span>
<span class="udiff-line-removed">-             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testIssuePoolVersion(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var issueProject = credentials.getIssueProject();</span>
<span class="udiff-line-removed">-             var updater = IssueUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                       .issueProject(issueProject)</span>
<span class="udiff-line-removed">-                                       .reviewLink(false)</span>
<span class="udiff-line-removed">-                                       .commitLink(false)</span>
<span class="udiff-line-removed">-                                       .setFixVersion(true)</span>
<span class="udiff-line-removed">-                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))</span>
<span class="udiff-line-removed">-                                       .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Initialize history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Create an issue and commit a fix</span>
<span class="udiff-line-removed">-             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="udiff-line-removed">-             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The fixVersion should have been updated</span>
<span class="udiff-line-removed">-             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var issueProject = credentials.getIssueProject();</span>
<span class="udiff-line-removed">-             var updater = IssueUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                       .issueProject(issueProject)</span>
<span class="udiff-line-removed">-                                       .reviewLink(false)</span>
<span class="udiff-line-removed">-                                       .commitLink(false)</span>
<span class="udiff-line-removed">-                                       .setFixVersion(true)</span>
<span class="udiff-line-removed">-                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))</span>
<span class="udiff-line-removed">-                                       .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Initialize history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Create an issue and commit a fix</span>
<span class="udiff-line-removed">-             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="udiff-line-removed">-             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The fixVersion should have been updated</span>
<span class="udiff-line-removed">-             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testIssueBackport(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var issueProject = credentials.getIssueProject();</span>
<span class="udiff-line-removed">-             var updater = IssueUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                       .issueProject(issueProject)</span>
<span class="udiff-line-removed">-                                       .reviewLink(false)</span>
<span class="udiff-line-removed">-                                       .commitLink(false)</span>
<span class="udiff-line-removed">-                                       .setFixVersion(true)</span>
<span class="udiff-line-removed">-                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12.0.2&quot;))</span>
<span class="udiff-line-removed">-                                       .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Initialize history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Create an issue and commit a fix</span>
<span class="udiff-line-removed">-             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),</span>
<span class="udiff-line-removed">-                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),</span>
<span class="udiff-line-removed">-                                                         &quot;customfield_10008&quot;, JSON.object()</span>
<span class="udiff-line-removed">-                                                                                  .put(&quot;id&quot;, 244)</span>
<span class="udiff-line-removed">-                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),</span>
<span class="udiff-line-removed">-                                                         &quot;customfield_10005&quot;, JSON.array()</span>
<span class="udiff-line-removed">-                                                                                  .add(JSON.object()</span>
<span class="udiff-line-removed">-                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)</span>
<span class="udiff-line-removed">-                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))</span>
<span class="udiff-line-removed">-                                                                                  .add(JSON.object()</span>
<span class="udiff-line-removed">-                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)</span>
<span class="udiff-line-removed">-                                                                                           .put(&quot;value&quot;, &quot;other&quot;))</span>
<span class="udiff-line-removed">-                                                  ));</span>
<span class="udiff-line-removed">-             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));</span>
<span class="udiff-line-removed">-             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;</span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The fixVersion should not have been updated</span>
<span class="udiff-line-removed">-             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="udiff-line-removed">-             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));</span>
<span class="udiff-line-removed">-             assertEquals(OPEN, updatedIssue.state());</span>
<span class="udiff-line-removed">-             assertEquals(List.of(), updatedIssue.assignees());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // There should be a link</span>
<span class="udiff-line-removed">-             var links = updatedIssue.links();</span>
<span class="udiff-line-removed">-             assertEquals(1, links.size());</span>
<span class="udiff-line-removed">-             var link = links.get(0);</span>
<span class="udiff-line-removed">-             var backport = link.issue().orElseThrow();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The backport issue should have a correct fixVersion and assignee</span>
<span class="udiff-line-removed">-             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));</span>
<span class="udiff-line-removed">-             assertEquals(RESOLVED, backport.state());</span>
<span class="udiff-line-removed">-             assertEquals(List.of(issueProject.issueTracker().currentUser()), backport.assignees());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Custom properties should also propagate</span>
<span class="udiff-line-removed">-             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());</span>
<span class="udiff-line-removed">-             assertEquals(244, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;id&quot;).asInt());</span>
<span class="udiff-line-removed">-             assertEquals(&quot;java.io&quot;, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;name&quot;).asString());</span>
<span class="udiff-line-removed">-             assertEquals(2, backport.properties().get(&quot;customfield_10005&quot;).asArray().size());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testPullRequest(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var reviewer = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var issueProject = credentials.getIssueProject();</span>
<span class="udiff-line-removed">-             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);</span>
<span class="udiff-line-removed">-             var updater = IssueUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                       .issueProject(issueProject)</span>
<span class="udiff-line-removed">-                                       .reviewIcon(reviewIcon)</span>
<span class="udiff-line-removed">-                                       .commitLink(false)</span>
<span class="udiff-line-removed">-                                       .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .prUpdaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .readyLabels(Set.of(&quot;rfr&quot;))</span>
<span class="udiff-line-removed">-                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Initialize history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Create an issue and a pull request to fix it</span>
<span class="udiff-line-removed">-             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);</span>
<span class="udiff-line-removed">-             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="udiff-line-removed">-             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The issue should not yet contain a link to the PR</span>
<span class="udiff-line-removed">-             var links = issue.links();</span>
<span class="udiff-line-removed">-             assertEquals(0, links.size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Just a label isn&#39;t enough</span>
<span class="udiff-line-removed">-             pr.addLabel(&quot;rfr&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             links = issue.links();</span>
<span class="udiff-line-removed">-             assertEquals(0, links.size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Neither is just a comment</span>
<span class="udiff-line-removed">-             pr.removeLabel(&quot;rfr&quot;);</span>
<span class="udiff-line-removed">-             var reviewPr = reviewer.pullRequest(pr.id());</span>
<span class="udiff-line-removed">-             reviewPr.addComment(&quot;This is now ready&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">-             links = issue.links();</span>
<span class="udiff-line-removed">-             assertEquals(0, links.size());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Both are needed</span>
<span class="udiff-line-removed">-             pr.addLabel(&quot;rfr&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The issue should now contain a link to the PR</span>
<span class="udiff-line-removed">-             links = issue.links();</span>
<span class="udiff-line-removed">-             assertEquals(1, links.size());</span>
<span class="udiff-line-removed">-             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());</span>
<span class="udiff-line-removed">-             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Add another issue</span>
<span class="udiff-line-removed">-             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="udiff-line-removed">-             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n * [&quot; + issue2.id() +</span>
<span class="udiff-line-removed">-                                &quot;](http://www.test2.test/): The second issue&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Both issues should contain a link to the PR</span>
<span class="udiff-line-removed">-             var links1 = issue.links();</span>
<span class="udiff-line-removed">-             assertEquals(1, links1.size());</span>
<span class="udiff-line-removed">-             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());</span>
<span class="udiff-line-removed">-             var links2 = issue2.links();</span>
<span class="udiff-line-removed">-             assertEquals(1, links2.size());</span>
<span class="udiff-line-removed">-             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Drop the first one</span>
<span class="udiff-line-removed">-             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Only the second issue should now contain a link to the PR</span>
<span class="udiff-line-removed">-             links1 = issue.links();</span>
<span class="udiff-line-removed">-             assertEquals(0, links1.size());</span>
<span class="udiff-line-removed">-             links2 = issue2.links();</span>
<span class="udiff-line-removed">-             assertEquals(1, links2.size());</span>
<span class="udiff-line-removed">-             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testPullRequestNoReview(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var reviewer = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var issueProject = credentials.getIssueProject();</span>
<span class="udiff-line-removed">-             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);</span>
<span class="udiff-line-removed">-             var updater = IssueUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                       .issueProject(issueProject)</span>
<span class="udiff-line-removed">-                                       .reviewLink(false)</span>
<span class="udiff-line-removed">-                                       .reviewIcon(reviewIcon)</span>
<span class="udiff-line-removed">-                                       .commitLink(false)</span>
<span class="udiff-line-removed">-                                       .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .prUpdaters(List.of(updater)).readyLabels(Set.of(&quot;rfr&quot;))</span>
<span class="udiff-line-removed">-                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">-             // Initialize history</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Create an issue and a pull request to fix it</span>
<span class="udiff-line-removed">-             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);</span>
<span class="udiff-line-removed">-             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="udiff-line-removed">-             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Add required label</span>
<span class="udiff-line-removed">-             pr.addLabel(&quot;rfr&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // And the required comment</span>
<span class="udiff-line-removed">-             var reviewPr = reviewer.pullRequest(pr.id());</span>
<span class="udiff-line-removed">-             reviewPr.addComment(&quot;This is now ready&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The issue should still not contain a link to the PR</span>
<span class="udiff-line-removed">-             var links = issue.links();</span>
<span class="udiff-line-removed">-             assertEquals(0, links.size());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     void testPullRequestPROnly(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-removed">-         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-removed">-              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-removed">-             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-removed">-             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-removed">-             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-removed">-             credentials.commitLock(localRepo);</span>
<span class="udiff-line-removed">-             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-removed">-             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-removed">-             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-removed">-             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var issueProject = credentials.getIssueProject();</span>
<span class="udiff-line-removed">-             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);</span>
<span class="udiff-line-removed">-             var updater = IssueUpdater.newBuilder()</span>
<span class="udiff-line-removed">-                                       .issueProject(issueProject)</span>
<span class="udiff-line-removed">-                                       .reviewIcon(reviewIcon)</span>
<span class="udiff-line-removed">-                                       .commitLink(false)</span>
<span class="udiff-line-removed">-                                       .prOnly(true)</span>
<span class="udiff-line-removed">-                                       .build();</span>
<span class="udiff-line-removed">-             var notifyBot = NotifyBot.newBuilder()</span>
<span class="udiff-line-removed">-                                      .repository(repo)</span>
<span class="udiff-line-removed">-                                      .storagePath(storageFolder)</span>
<span class="udiff-line-removed">-                                      .branches(Pattern.compile(&quot;.*&quot;))</span>
<span class="udiff-line-removed">-                                      .tagStorageBuilder(tagStorage)</span>
<span class="udiff-line-removed">-                                      .branchStorageBuilder(branchStorage)</span>
<span class="udiff-line-removed">-                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="udiff-line-removed">-                                      .updaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .prUpdaters(List.of(updater))</span>
<span class="udiff-line-removed">-                                      .build();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Initialize history</span>
<span class="udiff-line-removed">-             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Create an issue and a pull request to fix it</span>
<span class="udiff-line-removed">-             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="udiff-line-removed">-             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);</span>
<span class="udiff-line-removed">-             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="udiff-line-removed">-             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The issue should now contain a link to the PR</span>
<span class="udiff-line-removed">-             var links = issue.links();</span>
<span class="udiff-line-removed">-             assertEquals(1, links.size());</span>
<span class="udiff-line-removed">-             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());</span>
<span class="udiff-line-removed">-             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Simulate integration</span>
<span class="udiff-line-removed">-             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;other&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // The changeset should be reflected in a comment</span>
<span class="udiff-line-removed">-             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             var comments = updatedIssue.comments();</span>
<span class="udiff-line-removed">-             assertEquals(1, comments.size());</span>
<span class="udiff-line-removed">-             var comment = comments.get(0);</span>
<span class="udiff-line-removed">-             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // Now simulate a merge to another branch</span>
<span class="udiff-line-removed">-             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="udiff-line-removed">-             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // No additional comment should have been made</span>
<span class="udiff-line-removed">-             updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="udiff-line-removed">-             comments = updatedIssue.comments();</span>
<span class="udiff-line-removed">-             assertEquals(1, comments.size());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      private static class TestRepositoryUpdateConsumer implements RepositoryUpdateConsumer {
          private final String name;
          private final boolean idempotent;
          private int updateCount = 0;
          private boolean shouldFail = false;
</pre>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/UpdatedBranch.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>