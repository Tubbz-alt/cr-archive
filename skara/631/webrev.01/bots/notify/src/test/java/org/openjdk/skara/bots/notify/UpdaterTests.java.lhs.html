<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.notify;
  24 
<a name="1" id="anc1"></a><span class="line-modified">  25 import org.openjdk.skara.email.*;</span>
  26 import org.openjdk.skara.forge.HostedRepository;
<a name="2" id="anc2"></a><span class="line-removed">  27 import org.openjdk.skara.issuetracker.Issue;</span>
<span class="line-removed">  28 import org.openjdk.skara.json.*;</span>
<span class="line-removed">  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;</span>
  30 import org.openjdk.skara.storage.StorageBuilder;
  31 import org.openjdk.skara.test.*;
<a name="3" id="anc3"></a><span class="line-removed">  32 import org.openjdk.skara.vcs.*;</span>
  33 import org.openjdk.skara.vcs.Tag;
<a name="4" id="anc4"></a>
  34 import org.openjdk.skara.vcs.openjdk.OpenJDKTag;
  35 
<a name="5" id="anc5"></a><span class="line-removed">  36 import org.junit.jupiter.api.*;</span>
<span class="line-removed">  37 </span>
  38 import java.io.IOException;
<a name="6" id="anc6"></a><span class="line-modified">  39 import java.net.URI;</span>
<span class="line-removed">  40 import java.nio.charset.StandardCharsets;</span>
<span class="line-removed">  41 import java.nio.file.*;</span>
<span class="line-removed">  42 import java.time.Duration;</span>
<span class="line-removed">  43 import java.util.*;</span>
  44 import java.util.regex.Pattern;
<a name="7" id="anc7"></a><span class="line-removed">  45 import java.util.stream.Collectors;</span>
  46 
  47 import static org.junit.jupiter.api.Assertions.*;
<a name="8" id="anc8"></a><span class="line-removed">  48 import static org.openjdk.skara.issuetracker.Issue.State.*;</span>
  49 
<a name="9" id="anc9"></a><span class="line-modified">  50 class UpdaterTests {</span>
<span class="line-modified">  51     private List&lt;Path&gt; findJsonFiles(Path folder, String partialName) throws IOException {</span>
<span class="line-removed">  52         return Files.walk(folder)</span>
<span class="line-removed">  53                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))</span>
<span class="line-removed">  54                     .filter(path -&gt; path.toString().contains(partialName))</span>
<span class="line-removed">  55                     .collect(Collectors.toList());</span>
<span class="line-removed">  56     }</span>
<span class="line-removed">  57 </span>
<span class="line-removed">  58     private StorageBuilder&lt;UpdatedTag&gt; createTagStorage(HostedRepository repository) {</span>
  59         return new StorageBuilder&lt;UpdatedTag&gt;(&quot;tags.txt&quot;)
  60                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);
  61     }
  62 
<a name="10" id="anc10"></a><span class="line-modified">  63     private StorageBuilder&lt;UpdatedBranch&gt; createBranchStorage(HostedRepository repository) {</span>
  64         return new StorageBuilder&lt;UpdatedBranch&gt;(&quot;branches.txt&quot;)
  65                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);
  66     }
  67 
<a name="11" id="anc11"></a><span class="line-modified">  68     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {</span>
  69         return new StorageBuilder&lt;PullRequestIssues&gt;(&quot;prissues.txt&quot;)
  70                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated prissues&quot;);
  71     }
  72 
<a name="12" id="anc12"></a><span class="line-removed">  73     private Set&lt;String&gt; fixVersions(Issue issue) {</span>
<span class="line-removed">  74         if (!issue.properties().containsKey(&quot;fixVersions&quot;)) {</span>
<span class="line-removed">  75             return Set.of();</span>
<span class="line-removed">  76         }</span>
<span class="line-removed">  77         return issue.properties().get(&quot;fixVersions&quot;).stream()</span>
<span class="line-removed">  78                     .map(JSONValue::asString)</span>
<span class="line-removed">  79                     .collect(Collectors.toSet());</span>
<span class="line-removed">  80     }</span>
<span class="line-removed">  81 </span>
<span class="line-removed">  82     @Test</span>
<span class="line-removed">  83     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {</span>
<span class="line-removed">  84         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed">  85              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed">  86             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">  87             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">  88             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());</span>
<span class="line-removed">  89             credentials.commitLock(localRepo);</span>
<span class="line-removed">  90             localRepo.pushAll(repo.url());</span>
<span class="line-removed">  91 </span>
<span class="line-removed">  92             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">  93             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">  94             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">  95             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);</span>
<span class="line-removed">  96             Files.createDirectory(jsonFolder);</span>
<span class="line-removed">  97             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">  98 </span>
<span class="line-removed">  99             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);</span>
<span class="line-removed"> 100             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed"> 101                                      .repository(repo)</span>
<span class="line-removed"> 102                                      .storagePath(storageFolder)</span>
<span class="line-removed"> 103                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed"> 104                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed"> 105                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed"> 106                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed"> 107                                      .updaters(List.of(updater))</span>
<span class="line-removed"> 108                                      .build();</span>
<span class="line-removed"> 109 </span>
<span class="line-removed"> 110             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 111             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));</span>
<span class="line-removed"> 112 </span>
<span class="line-removed"> 113             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);</span>
<span class="line-removed"> 114             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed"> 115             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 116             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);</span>
<span class="line-removed"> 117             assertEquals(1, jsonFiles.size());</span>
<span class="line-removed"> 118             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);</span>
<span class="line-removed"> 119             var json = JSON.parse(jsonData);</span>
<span class="line-removed"> 120             assertEquals(1, json.asArray().size());</span>
<span class="line-removed"> 121             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());</span>
<span class="line-removed"> 122             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()</span>
<span class="line-removed"> 123                                                   .map(JSONValue::asString)</span>
<span class="line-removed"> 124                                                   .collect(Collectors.toList()));</span>
<span class="line-removed"> 125         }</span>
<span class="line-removed"> 126     }</span>
<span class="line-removed"> 127 </span>
<span class="line-removed"> 128     @Test</span>
<span class="line-removed"> 129     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {</span>
<span class="line-removed"> 130         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed"> 131              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed"> 132             var repo = credentials.getHostedRepository();</span>
<span class="line-removed"> 133             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed"> 134             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());</span>
<span class="line-removed"> 135             credentials.commitLock(localRepo);</span>
<span class="line-removed"> 136             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed"> 137             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);</span>
<span class="line-removed"> 138             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 139 </span>
<span class="line-removed"> 140             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed"> 141             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed"> 142             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed"> 143             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);</span>
<span class="line-removed"> 144             Files.createDirectory(jsonFolder);</span>
<span class="line-removed"> 145             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed"> 146 </span>
<span class="line-removed"> 147             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);</span>
<span class="line-removed"> 148             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed"> 149                                      .repository(repo)</span>
<span class="line-removed"> 150                                      .storagePath(storageFolder)</span>
<span class="line-removed"> 151                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed"> 152                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed"> 153                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed"> 154                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed"> 155                                      .updaters(List.of(updater))</span>
<span class="line-removed"> 156                                      .build();</span>
<span class="line-removed"> 157 </span>
<span class="line-removed"> 158             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 159             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));</span>
<span class="line-removed"> 160 </span>
<span class="line-removed"> 161             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed"> 162             localRepo.fetch(repo.url(), &quot;history:history&quot;);</span>
<span class="line-removed"> 163             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);</span>
<span class="line-removed"> 164             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);</span>
<span class="line-removed"> 165             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);</span>
<span class="line-removed"> 166             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 167 </span>
<span class="line-removed"> 168             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 169             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);</span>
<span class="line-removed"> 170             assertEquals(3, jsonFiles.size());</span>
<span class="line-removed"> 171 </span>
<span class="line-removed"> 172             for (var file : jsonFiles) {</span>
<span class="line-removed"> 173                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);</span>
<span class="line-removed"> 174                 var json = JSON.parse(jsonData);</span>
<span class="line-removed"> 175 </span>
<span class="line-removed"> 176                 if (json.asArray().get(0).contains(&quot;date&quot;)) {</span>
<span class="line-removed"> 177                     assertEquals(2, json.asArray().size());</span>
<span class="line-removed"> 178                     assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()</span>
<span class="line-removed"> 179                                                           .map(JSONValue::asString)</span>
<span class="line-removed"> 180                                                           .collect(Collectors.toList()));</span>
<span class="line-removed"> 181                     assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());</span>
<span class="line-removed"> 182                     assertEquals(&quot;team&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());</span>
<span class="line-removed"> 183                     assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(1).get(&quot;issue&quot;).asArray().stream()</span>
<span class="line-removed"> 184                                                           .map(JSONValue::asString)</span>
<span class="line-removed"> 185                                                           .collect(Collectors.toList()));</span>
<span class="line-removed"> 186                     assertEquals(repo.webUrl(editHash2).toString(), json.asArray().get(1).get(&quot;url&quot;).asString());</span>
<span class="line-removed"> 187                     assertEquals(&quot;team&quot;, json.asArray().get(1).get(&quot;build&quot;).asString());</span>
<span class="line-removed"> 188                 } else {</span>
<span class="line-removed"> 189                     assertEquals(1, json.asArray().size());</span>
<span class="line-removed"> 190                     if (json.asArray().get(0).get(&quot;build&quot;).asString().equals(&quot;b02&quot;)) {</span>
<span class="line-removed"> 191                         assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()</span>
<span class="line-removed"> 192                                                               .map(JSONValue::asString)</span>
<span class="line-removed"> 193                                                               .collect(Collectors.toList()));</span>
<span class="line-removed"> 194                     } else {</span>
<span class="line-removed"> 195                         assertEquals(&quot;b04&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());</span>
<span class="line-removed"> 196                         assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()</span>
<span class="line-removed"> 197                                                               .map(JSONValue::asString)</span>
<span class="line-removed"> 198                                                               .collect(Collectors.toList()));</span>
<span class="line-removed"> 199                     }</span>
<span class="line-removed"> 200                 }</span>
<span class="line-removed"> 201             }</span>
<span class="line-removed"> 202         }</span>
<span class="line-removed"> 203     }</span>
<span class="line-removed"> 204 </span>
<span class="line-removed"> 205     @Test</span>
<span class="line-removed"> 206     void testMailingList(TestInfo testInfo) throws IOException {</span>
<span class="line-removed"> 207         try (var listServer = new TestMailmanServer();</span>
<span class="line-removed"> 208              var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed"> 209              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed"> 210             var repo = credentials.getHostedRepository();</span>
<span class="line-removed"> 211             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed"> 212             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed"> 213             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed"> 214             credentials.commitLock(localRepo);</span>
<span class="line-removed"> 215             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 216 </span>
<span class="line-removed"> 217             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-removed"> 218             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-removed"> 219             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-removed"> 220             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed"> 221             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed"> 222             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed"> 223             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed"> 224 </span>
<span class="line-removed"> 225             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-removed"> 226             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-removed"> 227                                             .list(mailmanList)</span>
<span class="line-removed"> 228                                             .recipient(listAddress)</span>
<span class="line-removed"> 229                                             .sender(sender)</span>
<span class="line-removed"> 230                                             .reportNewTags(false)</span>
<span class="line-removed"> 231                                             .reportNewBranches(false)</span>
<span class="line-removed"> 232                                             .reportNewBuilds(false)</span>
<span class="line-removed"> 233                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="line-removed"> 234                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))</span>
<span class="line-removed"> 235                                             .build();</span>
<span class="line-removed"> 236             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed"> 237                                      .repository(repo)</span>
<span class="line-removed"> 238                                      .storagePath(storageFolder)</span>
<span class="line-removed"> 239                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed"> 240                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed"> 241                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed"> 242                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed"> 243                                      .updaters(List.of(updater))</span>
<span class="line-removed"> 244                                      .build();</span>
<span class="line-removed"> 245 </span>
<span class="line-removed"> 246             // No mail should be sent on the first run as there is no history</span>
<span class="line-removed"> 247             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 248             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 249 </span>
<span class="line-removed"> 250             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed"> 251             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed"> 252             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 253             listServer.processIncoming();</span>
<span class="line-removed"> 254 </span>
<span class="line-removed"> 255             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed"> 256             var email = conversations.get(0).first();</span>
<span class="line-removed"> 257             assertEquals(listAddress, email.sender());</span>
<span class="line-removed"> 258             assertEquals(sender, email.author());</span>
<span class="line-removed"> 259             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="line-removed"> 260             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));</span>
<span class="line-removed"> 261             assertFalse(email.subject().contains(&quot;master&quot;));</span>
<span class="line-removed"> 262             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));</span>
<span class="line-removed"> 263             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed"> 264             assertFalse(email.body().contains(&quot;Committer&quot;));</span>
<span class="line-removed"> 265             assertFalse(email.body().contains(masterHash.abbreviate()));</span>
<span class="line-removed"> 266             assertTrue(email.hasHeader(&quot;extra1&quot;));</span>
<span class="line-removed"> 267             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));</span>
<span class="line-removed"> 268             assertTrue(email.hasHeader(&quot;extra2&quot;));</span>
<span class="line-removed"> 269             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));</span>
<span class="line-removed"> 270             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="line-removed"> 271             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="line-removed"> 272             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="line-removed"> 273             assertEquals(editHash.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
<span class="line-removed"> 274         }</span>
<span class="line-removed"> 275     }</span>
<span class="line-removed"> 276 </span>
<span class="line-removed"> 277     @Test</span>
<span class="line-removed"> 278     void testMailingListMultiple(TestInfo testInfo) throws IOException {</span>
<span class="line-removed"> 279         try (var listServer = new TestMailmanServer();</span>
<span class="line-removed"> 280              var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed"> 281              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed"> 282             var repo = credentials.getHostedRepository();</span>
<span class="line-removed"> 283             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed"> 284             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed"> 285             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed"> 286             credentials.commitLock(localRepo);</span>
<span class="line-removed"> 287             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 288 </span>
<span class="line-removed"> 289             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-removed"> 290             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-removed"> 291             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-removed"> 292             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed"> 293             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed"> 294             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed"> 295             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed"> 296 </span>
<span class="line-removed"> 297             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-removed"> 298             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-removed"> 299                                             .list(mailmanList)</span>
<span class="line-removed"> 300                                             .recipient(listAddress)</span>
<span class="line-removed"> 301                                             .sender(sender)</span>
<span class="line-removed"> 302                                             .reportNewTags(false)</span>
<span class="line-removed"> 303                                             .reportNewBranches(false)</span>
<span class="line-removed"> 304                                             .reportNewBuilds(false)</span>
<span class="line-removed"> 305                                             .build();</span>
<span class="line-removed"> 306             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed"> 307                                      .repository(repo)</span>
<span class="line-removed"> 308                                      .storagePath(storageFolder)</span>
<span class="line-removed"> 309                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed"> 310                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed"> 311                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed"> 312                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed"> 313                                      .updaters(List.of(updater))</span>
<span class="line-removed"> 314                                      .build();</span>
<span class="line-removed"> 315 </span>
<span class="line-removed"> 316             // No mail should be sent on the first run as there is no history</span>
<span class="line-removed"> 317             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 318             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 319 </span>
<span class="line-removed"> 320             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,</span>
<span class="line-removed"> 321                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);</span>
<span class="line-removed"> 322             localRepo.push(editHash1, repo.url(), &quot;master&quot;);</span>
<span class="line-removed"> 323             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,</span>
<span class="line-removed"> 324                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);</span>
<span class="line-removed"> 325             localRepo.push(editHash2, repo.url(), &quot;master&quot;);</span>
<span class="line-removed"> 326 </span>
<span class="line-removed"> 327             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 328             listServer.processIncoming();</span>
<span class="line-removed"> 329 </span>
<span class="line-removed"> 330             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed"> 331             var email = conversations.get(0).first();</span>
<span class="line-removed"> 332             assertEquals(listAddress, email.sender());</span>
<span class="line-removed"> 333             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());</span>
<span class="line-removed"> 334             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="line-removed"> 335             assertTrue(email.subject().contains(&quot;: 2 new changesets&quot;));</span>
<span class="line-removed"> 336             assertFalse(email.subject().contains(&quot;master&quot;));</span>
<span class="line-removed"> 337             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));</span>
<span class="line-removed"> 338             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed"> 339             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));</span>
<span class="line-removed"> 340             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));</span>
<span class="line-removed"> 341             assertFalse(email.body().contains(masterHash.abbreviate()));</span>
<span class="line-removed"> 342             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="line-removed"> 343             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="line-removed"> 344             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="line-removed"> 345             assertEquals(editHash1.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
<span class="line-removed"> 346         }</span>
<span class="line-removed"> 347     }</span>
<span class="line-removed"> 348 </span>
<span class="line-removed"> 349     @Test</span>
<span class="line-removed"> 350     void testMailingListSponsored(TestInfo testInfo) throws IOException {</span>
<span class="line-removed"> 351         try (var listServer = new TestMailmanServer();</span>
<span class="line-removed"> 352              var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed"> 353              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed"> 354             var repo = credentials.getHostedRepository();</span>
<span class="line-removed"> 355             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed"> 356             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed"> 357             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed"> 358             credentials.commitLock(localRepo);</span>
<span class="line-removed"> 359             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 360 </span>
<span class="line-removed"> 361             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-removed"> 362             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-removed"> 363             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-removed"> 364             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed"> 365             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed"> 366             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed"> 367             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed"> 368 </span>
<span class="line-removed"> 369             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-removed"> 370             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-removed"> 371                                             .list(mailmanList)</span>
<span class="line-removed"> 372                                             .recipient(listAddress)</span>
<span class="line-removed"> 373                                             .sender(sender)</span>
<span class="line-removed"> 374                                             .reportNewTags(false)</span>
<span class="line-removed"> 375                                             .reportNewBranches(false)</span>
<span class="line-removed"> 376                                             .reportNewBuilds(false)</span>
<span class="line-removed"> 377                                             .build();</span>
<span class="line-removed"> 378             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed"> 379                                      .repository(repo)</span>
<span class="line-removed"> 380                                      .storagePath(storageFolder)</span>
<span class="line-removed"> 381                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed"> 382                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed"> 383                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed"> 384                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed"> 385                                      .updaters(List.of(updater))</span>
<span class="line-removed"> 386                                      .build();</span>
<span class="line-removed"> 387 </span>
<span class="line-removed"> 388             // No mail should be sent on the first run as there is no history</span>
<span class="line-removed"> 389             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 390             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 391 </span>
<span class="line-removed"> 392             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,</span>
<span class="line-removed"> 393                                                                &quot;author&quot;, &quot;author@test.test&quot;,</span>
<span class="line-removed"> 394                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);</span>
<span class="line-removed"> 395             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed"> 396             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 397             listServer.processIncoming();</span>
<span class="line-removed"> 398 </span>
<span class="line-removed"> 399             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed"> 400             var email = conversations.get(0).first();</span>
<span class="line-removed"> 401             assertEquals(listAddress, email.sender());</span>
<span class="line-removed"> 402             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());</span>
<span class="line-removed"> 403             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="line-removed"> 404             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));</span>
<span class="line-removed"> 405             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed"> 406             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));</span>
<span class="line-removed"> 407             assertTrue(email.body().contains(&quot;Committer: committer &lt;committer@test.test&gt;&quot;));</span>
<span class="line-removed"> 408             assertFalse(email.body().contains(masterHash.abbreviate()));</span>
<span class="line-removed"> 409         }</span>
<span class="line-removed"> 410     }</span>
<span class="line-removed"> 411 </span>
<span class="line-removed"> 412     @Test</span>
<span class="line-removed"> 413     void testMailingListMultipleBranches(TestInfo testInfo) throws IOException {</span>
<span class="line-removed"> 414         try (var listServer = new TestMailmanServer();</span>
<span class="line-removed"> 415              var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed"> 416              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed"> 417             var repo = credentials.getHostedRepository();</span>
<span class="line-removed"> 418             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed"> 419             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed"> 420             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed"> 421             credentials.commitLock(localRepo);</span>
<span class="line-removed"> 422             var branch = localRepo.branch(masterHash, &quot;another&quot;);</span>
<span class="line-removed"> 423             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 424 </span>
<span class="line-removed"> 425             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-removed"> 426             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-removed"> 427             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-removed"> 428             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed"> 429             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed"> 430             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed"> 431             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed"> 432 </span>
<span class="line-removed"> 433             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-removed"> 434             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);</span>
<span class="line-removed"> 435             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-removed"> 436                                             .list(mailmanList)</span>
<span class="line-removed"> 437                                             .recipient(listAddress)</span>
<span class="line-removed"> 438                                             .sender(sender)</span>
<span class="line-removed"> 439                                             .author(author)</span>
<span class="line-removed"> 440                                             .includeBranch(true)</span>
<span class="line-removed"> 441                                             .reportNewTags(false)</span>
<span class="line-removed"> 442                                             .reportNewBranches(false)</span>
<span class="line-removed"> 443                                             .reportNewBuilds(false)</span>
<span class="line-removed"> 444                                             .build();</span>
<span class="line-removed"> 445             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed"> 446                                      .repository(repo)</span>
<span class="line-removed"> 447                                      .storagePath(storageFolder)</span>
<span class="line-removed"> 448                                      .branches(Pattern.compile(&quot;master|another&quot;))</span>
<span class="line-removed"> 449                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed"> 450                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed"> 451                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed"> 452                                      .updaters(List.of(updater))</span>
<span class="line-removed"> 453                                      .build();</span>
<span class="line-removed"> 454 </span>
<span class="line-removed"> 455             // No mail should be sent on the first run as there is no history</span>
<span class="line-removed"> 456             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 457             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 458 </span>
<span class="line-removed"> 459             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed"> 460             localRepo.push(editHash1, repo.url(), &quot;master&quot;);</span>
<span class="line-removed"> 461             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);</span>
<span class="line-removed"> 462             localRepo.push(editHash2, repo.url(), &quot;master&quot;);</span>
<span class="line-removed"> 463 </span>
<span class="line-removed"> 464             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 465             listServer.processIncoming();</span>
<span class="line-removed"> 466 </span>
<span class="line-removed"> 467             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed"> 468             var email = conversations.get(0).first();</span>
<span class="line-removed"> 469             assertEquals(listAddress, email.sender());</span>
<span class="line-removed"> 470             assertEquals(author, email.author());</span>
<span class="line-removed"> 471             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="line-removed"> 472             assertFalse(email.subject().contains(&quot;another&quot;));</span>
<span class="line-removed"> 473             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));</span>
<span class="line-removed"> 474             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));</span>
<span class="line-removed"> 475             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed"> 476             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));</span>
<span class="line-removed"> 477             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));</span>
<span class="line-removed"> 478             assertFalse(email.body().contains(masterHash.abbreviate()));</span>
<span class="line-removed"> 479             assertFalse(email.body().contains(&quot;456789AB: Yet more fixes&quot;));</span>
<span class="line-removed"> 480             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="line-removed"> 481             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="line-removed"> 482             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="line-removed"> 483             assertEquals(editHash1.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
<span class="line-removed"> 484 </span>
<span class="line-removed"> 485             localRepo.checkout(branch, true);</span>
<span class="line-removed"> 486             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);</span>
<span class="line-removed"> 487             localRepo.push(editHash3, repo.url(), &quot;another&quot;);</span>
<span class="line-removed"> 488 </span>
<span class="line-removed"> 489             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 490             listServer.processIncoming();</span>
<span class="line-removed"> 491 </span>
<span class="line-removed"> 492             conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed"> 493             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));</span>
<span class="line-removed"> 494             email = conversations.get(0).first();</span>
<span class="line-removed"> 495             assertEquals(author, email.author());</span>
<span class="line-removed"> 496             assertEquals(listAddress, email.sender());</span>
<span class="line-removed"> 497             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="line-removed"> 498             assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));</span>
<span class="line-removed"> 499             assertFalse(email.subject().contains(&quot;master&quot;));</span>
<span class="line-removed"> 500             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));</span>
<span class="line-removed"> 501             assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));</span>
<span class="line-removed"> 502             assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));</span>
<span class="line-removed"> 503             assertFalse(email.body().contains(&quot;3456789A: Even more fixes&quot;));</span>
<span class="line-removed"> 504             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="line-removed"> 505             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="line-removed"> 506             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="line-removed"> 507             assertEquals(editHash3.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
<span class="line-removed"> 508         }</span>
<span class="line-removed"> 509     }</span>
<span class="line-removed"> 510 </span>
<span class="line-removed"> 511     @Test</span>
<span class="line-removed"> 512     void testMailingListPROnlyMultipleBranches(TestInfo testInfo) throws IOException {</span>
<span class="line-removed"> 513         try (var listServer = new TestMailmanServer();</span>
<span class="line-removed"> 514              var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed"> 515              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed"> 516             var repo = credentials.getHostedRepository();</span>
<span class="line-removed"> 517             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed"> 518             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed"> 519             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed"> 520             credentials.commitLock(localRepo);</span>
<span class="line-removed"> 521             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 522 </span>
<span class="line-removed"> 523             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-removed"> 524             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-removed"> 525             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-removed"> 526             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed"> 527             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed"> 528             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed"> 529             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed"> 530 </span>
<span class="line-removed"> 531             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-removed"> 532             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);</span>
<span class="line-removed"> 533             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-removed"> 534                                             .list(mailmanList)</span>
<span class="line-removed"> 535                                             .recipient(listAddress)</span>
<span class="line-removed"> 536                                             .sender(sender)</span>
<span class="line-removed"> 537                                             .author(author)</span>
<span class="line-removed"> 538                                             .reportNewTags(false)</span>
<span class="line-removed"> 539                                             .reportNewBranches(false)</span>
<span class="line-removed"> 540                                             .reportNewBuilds(false)</span>
<span class="line-removed"> 541                                             .includeBranch(true)</span>
<span class="line-removed"> 542                                             .mode(MailingListUpdater.Mode.PR)</span>
<span class="line-removed"> 543                                             .build();</span>
<span class="line-removed"> 544             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed"> 545                                      .repository(repo)</span>
<span class="line-removed"> 546                                      .storagePath(storageFolder)</span>
<span class="line-removed"> 547                                      .branches(Pattern.compile(&quot;master|other&quot;))</span>
<span class="line-removed"> 548                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed"> 549                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed"> 550                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed"> 551                                      .updaters(List.of(updater))</span>
<span class="line-removed"> 552                                      .build();</span>
<span class="line-removed"> 553 </span>
<span class="line-removed"> 554             // Populate our known branches</span>
<span class="line-removed"> 555             localRepo.push(masterHash, repo.url(), &quot;master&quot;, true);</span>
<span class="line-removed"> 556             localRepo.push(masterHash, repo.url(), &quot;other&quot;, true);</span>
<span class="line-removed"> 557 </span>
<span class="line-removed"> 558             // No mail should be sent on the first run as there is no history</span>
<span class="line-removed"> 559             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 560             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 561 </span>
<span class="line-removed"> 562             localRepo.checkout(masterHash, true);</span>
<span class="line-removed"> 563             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed"> 564             localRepo.push(editHash, repo.url(), &quot;edit&quot;);</span>
<span class="line-removed"> 565             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);</span>
<span class="line-removed"> 566 </span>
<span class="line-removed"> 567             // PR hasn&#39;t been integrated yet, so there should be no mail</span>
<span class="line-removed"> 568             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 569             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 570 </span>
<span class="line-removed"> 571             // Simulate an RFR email</span>
<span class="line-removed"> 572             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())</span>
<span class="line-removed"> 573                            .recipient(listAddress)</span>
<span class="line-removed"> 574                            .build();</span>
<span class="line-removed"> 575             mailmanList.post(rfr);</span>
<span class="line-removed"> 576             listServer.processIncoming();</span>
<span class="line-removed"> 577 </span>
<span class="line-removed"> 578             // And an integration (but it hasn&#39;t reached master just yet)</span>
<span class="line-removed"> 579             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);</span>
<span class="line-removed"> 580 </span>
<span class="line-removed"> 581             // Now push the same commit to another branch</span>
<span class="line-removed"> 582             localRepo.push(editHash, repo.url(), &quot;other&quot;);</span>
<span class="line-removed"> 583             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 584             listServer.processIncoming();</span>
<span class="line-removed"> 585 </span>
<span class="line-removed"> 586             // This one should generate a plain integration mail</span>
<span class="line-removed"> 587             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed"> 588             assertEquals(2, conversations.size());</span>
<span class="line-removed"> 589             var secondEmail = conversations.get(0).first();</span>
<span class="line-removed"> 590             if (secondEmail.subject().contains(&quot;RFR&quot;)) {</span>
<span class="line-removed"> 591                 secondEmail = conversations.get(1).first();</span>
<span class="line-removed"> 592             }</span>
<span class="line-removed"> 593             assertEquals(&quot;git: test: other: 23456789: More fixes&quot;, secondEmail.subject());</span>
<span class="line-removed"> 594         }</span>
<span class="line-removed"> 595     }</span>
<span class="line-removed"> 596 </span>
<span class="line-removed"> 597     @Test</span>
<span class="line-removed"> 598     void testMailingListPR(TestInfo testInfo) throws IOException {</span>
<span class="line-removed"> 599         try (var listServer = new TestMailmanServer();</span>
<span class="line-removed"> 600              var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed"> 601              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed"> 602             var repo = credentials.getHostedRepository();</span>
<span class="line-removed"> 603             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed"> 604             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed"> 605             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed"> 606             credentials.commitLock(localRepo);</span>
<span class="line-removed"> 607             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 608 </span>
<span class="line-removed"> 609             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-removed"> 610             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-removed"> 611             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-removed"> 612             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed"> 613             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed"> 614             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed"> 615             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed"> 616 </span>
<span class="line-removed"> 617             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-removed"> 618             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-removed"> 619                                             .list(mailmanList)</span>
<span class="line-removed"> 620                                             .recipient(listAddress)</span>
<span class="line-removed"> 621                                             .sender(sender)</span>
<span class="line-removed"> 622                                             .reportNewTags(false)</span>
<span class="line-removed"> 623                                             .reportNewBranches(false)</span>
<span class="line-removed"> 624                                             .reportNewBuilds(false)</span>
<span class="line-removed"> 625                                             .mode(MailingListUpdater.Mode.PR)</span>
<span class="line-removed"> 626                                             .build();</span>
<span class="line-removed"> 627             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed"> 628                                      .repository(repo)</span>
<span class="line-removed"> 629                                      .storagePath(storageFolder)</span>
<span class="line-removed"> 630                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed"> 631                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed"> 632                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed"> 633                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed"> 634                                      .updaters(List.of(updater))</span>
<span class="line-removed"> 635                                      .build();</span>
<span class="line-removed"> 636 </span>
<span class="line-removed"> 637             // No mail should be sent on the first run as there is no history</span>
<span class="line-removed"> 638             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 639             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 640 </span>
<span class="line-removed"> 641             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed"> 642             localRepo.push(editHash, repo.url(), &quot;edit&quot;);</span>
<span class="line-removed"> 643             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);</span>
<span class="line-removed"> 644 </span>
<span class="line-removed"> 645             // Create a potentially conflicting one</span>
<span class="line-removed"> 646             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed"> 647             localRepo.push(otherHash, repo.url(), &quot;other&quot;);</span>
<span class="line-removed"> 648             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);</span>
<span class="line-removed"> 649 </span>
<span class="line-removed"> 650             // PR hasn&#39;t been integrated yet, so there should be no mail</span>
<span class="line-removed"> 651             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 652             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 653 </span>
<span class="line-removed"> 654             // Simulate an RFR email</span>
<span class="line-removed"> 655             var rfr = Email.create(&quot;[repo/branch] RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())</span>
<span class="line-removed"> 656                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))</span>
<span class="line-removed"> 657                            .recipient(listAddress)</span>
<span class="line-removed"> 658                            .build();</span>
<span class="line-removed"> 659             mailmanList.post(rfr);</span>
<span class="line-removed"> 660             listServer.processIncoming();</span>
<span class="line-removed"> 661 </span>
<span class="line-removed"> 662             // And an integration</span>
<span class="line-removed"> 663             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);</span>
<span class="line-removed"> 664             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed"> 665 </span>
<span class="line-removed"> 666             // Push the other one without a matching PR</span>
<span class="line-removed"> 667             localRepo.push(otherHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed"> 668 </span>
<span class="line-removed"> 669             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 670             listServer.processIncoming();</span>
<span class="line-removed"> 671 </span>
<span class="line-removed"> 672             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed"> 673             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));</span>
<span class="line-removed"> 674             assertEquals(2, conversations.size());</span>
<span class="line-removed"> 675 </span>
<span class="line-removed"> 676             var prConversation = conversations.get(0);</span>
<span class="line-removed"> 677             var pushConversation = conversations.get(1);</span>
<span class="line-removed"> 678             assertEquals(1, prConversation.allMessages().size());</span>
<span class="line-removed"> 679 </span>
<span class="line-removed"> 680             var pushEmail = pushConversation.first();</span>
<span class="line-removed"> 681             assertEquals(listAddress, pushEmail.sender());</span>
<span class="line-removed"> 682             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());</span>
<span class="line-removed"> 683             assertEquals(pushEmail.recipients(), List.of(listAddress));</span>
<span class="line-removed"> 684             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed"> 685         }</span>
<span class="line-removed"> 686     }</span>
<span class="line-removed"> 687 </span>
<span class="line-removed"> 688     @Test</span>
<span class="line-removed"> 689     void testMailingListPROnce(TestInfo testInfo) throws IOException {</span>
<span class="line-removed"> 690         try (var listServer = new TestMailmanServer();</span>
<span class="line-removed"> 691              var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed"> 692              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed"> 693             var repo = credentials.getHostedRepository();</span>
<span class="line-removed"> 694             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed"> 695             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed"> 696             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed"> 697             localRepo.branch(masterHash, &quot;other&quot;);</span>
<span class="line-removed"> 698             credentials.commitLock(localRepo);</span>
<span class="line-removed"> 699             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 700 </span>
<span class="line-removed"> 701             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-removed"> 702             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-removed"> 703             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-removed"> 704             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed"> 705             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed"> 706             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed"> 707             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed"> 708 </span>
<span class="line-removed"> 709             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-removed"> 710             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-removed"> 711                                             .list(mailmanList)</span>
<span class="line-removed"> 712                                             .recipient(listAddress)</span>
<span class="line-removed"> 713                                             .sender(sender)</span>
<span class="line-removed"> 714                                             .author(null)</span>
<span class="line-removed"> 715                                             .reportNewTags(false)</span>
<span class="line-removed"> 716                                             .reportNewBranches(false)</span>
<span class="line-removed"> 717                                             .reportNewBuilds(false)</span>
<span class="line-removed"> 718                                             .mode(MailingListUpdater.Mode.PR)</span>
<span class="line-removed"> 719                                             .build();</span>
<span class="line-removed"> 720             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed"> 721                                      .repository(repo)</span>
<span class="line-removed"> 722                                      .storagePath(storageFolder)</span>
<span class="line-removed"> 723                                      .branches(Pattern.compile(&quot;master|other&quot;))</span>
<span class="line-removed"> 724                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed"> 725                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed"> 726                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed"> 727                                      .updaters(List.of(updater))</span>
<span class="line-removed"> 728                                      .build();</span>
<span class="line-removed"> 729 </span>
<span class="line-removed"> 730             // No mail should be sent on the first run as there is no history</span>
<span class="line-removed"> 731             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 732             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 733 </span>
<span class="line-removed"> 734             localRepo.checkout(masterHash, true);</span>
<span class="line-removed"> 735             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed"> 736             localRepo.push(editHash, repo.url(), &quot;edit&quot;);</span>
<span class="line-removed"> 737             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);</span>
<span class="line-removed"> 738 </span>
<span class="line-removed"> 739             // PR hasn&#39;t been integrated yet, so there should be no mail</span>
<span class="line-removed"> 740             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 741             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 742 </span>
<span class="line-removed"> 743             // Simulate an RFR email</span>
<span class="line-removed"> 744             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())</span>
<span class="line-removed"> 745                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))</span>
<span class="line-removed"> 746                            .recipient(listAddress)</span>
<span class="line-removed"> 747                            .build();</span>
<span class="line-removed"> 748             mailmanList.post(rfr);</span>
<span class="line-removed"> 749             listServer.processIncoming();</span>
<span class="line-removed"> 750 </span>
<span class="line-removed"> 751             // And an integration</span>
<span class="line-removed"> 752             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);</span>
<span class="line-removed"> 753             localRepo.push(editHash, repo.url(), &quot;master&quot;, true);</span>
<span class="line-removed"> 754 </span>
<span class="line-removed"> 755             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 756             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 757 </span>
<span class="line-removed"> 758             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed"> 759             assertEquals(1, conversations.size());</span>
<span class="line-removed"> 760 </span>
<span class="line-removed"> 761             var prConversation = conversations.get(0);</span>
<span class="line-removed"> 762             assertEquals(1, prConversation.allMessages().size());</span>
<span class="line-removed"> 763 </span>
<span class="line-removed"> 764             // Now push the change to another monitored branch</span>
<span class="line-removed"> 765             localRepo.push(editHash, repo.url(), &quot;other&quot;, true);</span>
<span class="line-removed"> 766             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 767             listServer.processIncoming();</span>
<span class="line-removed"> 768 </span>
<span class="line-removed"> 769             // The change should now end up as a separate notification thread</span>
<span class="line-removed"> 770             conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed"> 771             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));</span>
<span class="line-removed"> 772             assertEquals(2, conversations.size());</span>
<span class="line-removed"> 773 </span>
<span class="line-removed"> 774             var pushConversation = conversations.get(1);</span>
<span class="line-removed"> 775             var pushEmail = pushConversation.first();</span>
<span class="line-removed"> 776             assertEquals(listAddress, pushEmail.sender());</span>
<span class="line-removed"> 777             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());</span>
<span class="line-removed"> 778             assertEquals(pushEmail.recipients(), List.of(listAddress));</span>
<span class="line-removed"> 779             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed"> 780         }</span>
<span class="line-removed"> 781     }</span>
<span class="line-removed"> 782 </span>
<span class="line-removed"> 783     @Test</span>
<span class="line-removed"> 784     void testMailinglistTag(TestInfo testInfo) throws IOException {</span>
<span class="line-removed"> 785         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed"> 786              var tempFolder = new TemporaryDirectory();</span>
<span class="line-removed"> 787              var listServer = new TestMailmanServer()) {</span>
<span class="line-removed"> 788             var repo = credentials.getHostedRepository();</span>
<span class="line-removed"> 789             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed"> 790             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());</span>
<span class="line-removed"> 791             credentials.commitLock(localRepo);</span>
<span class="line-removed"> 792             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed"> 793             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="line-removed"> 794             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 795 </span>
<span class="line-removed"> 796             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-removed"> 797             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-removed"> 798             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-removed"> 799             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed"> 800             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed"> 801             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed"> 802             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed"> 803 </span>
<span class="line-removed"> 804             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-removed"> 805             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-removed"> 806                                             .list(mailmanList)</span>
<span class="line-removed"> 807                                             .recipient(listAddress)</span>
<span class="line-removed"> 808                                             .sender(sender)</span>
<span class="line-removed"> 809                                             .reportNewBranches(false)</span>
<span class="line-removed"> 810                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="line-removed"> 811                                             .build();</span>
<span class="line-removed"> 812             var noTagsUpdater = MailingListUpdater.newBuilder()</span>
<span class="line-removed"> 813                                                   .list(mailmanList)</span>
<span class="line-removed"> 814                                                   .recipient(listAddress)</span>
<span class="line-removed"> 815                                                   .sender(sender)</span>
<span class="line-removed"> 816                                                   .reportNewTags(false)</span>
<span class="line-removed"> 817                                                   .reportNewBranches(false)</span>
<span class="line-removed"> 818                                                   .reportNewBuilds(false)</span>
<span class="line-removed"> 819                                                   .build();</span>
<span class="line-removed"> 820             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed"> 821                                      .repository(repo)</span>
<span class="line-removed"> 822                                      .storagePath(storageFolder)</span>
<span class="line-removed"> 823                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed"> 824                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed"> 825                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed"> 826                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed"> 827                                      .updaters(List.of(updater, noTagsUpdater))</span>
<span class="line-removed"> 828                                      .build();</span>
<span class="line-removed"> 829 </span>
<span class="line-removed"> 830             // No mail should be sent on the first run as there is no history</span>
<span class="line-removed"> 831             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 832             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 833 </span>
<span class="line-removed"> 834             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed"> 835             localRepo.fetch(repo.url(), &quot;history:history&quot;);</span>
<span class="line-removed"> 836             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="line-removed"> 837             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);</span>
<span class="line-removed"> 838             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);</span>
<span class="line-removed"> 839             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);</span>
<span class="line-removed"> 840             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="line-removed"> 841             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);</span>
<span class="line-removed"> 842             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);</span>
<span class="line-removed"> 843             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="line-removed"> 844             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 845 </span>
<span class="line-removed"> 846             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 847             listServer.processIncoming();</span>
<span class="line-removed"> 848             listServer.processIncoming();</span>
<span class="line-removed"> 849             listServer.processIncoming();</span>
<span class="line-removed"> 850             listServer.processIncoming();</span>
<span class="line-removed"> 851 </span>
<span class="line-removed"> 852             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed"> 853             assertEquals(4, conversations.size());</span>
<span class="line-removed"> 854 </span>
<span class="line-removed"> 855             for (var conversation : conversations) {</span>
<span class="line-removed"> 856                 var email = conversation.first();</span>
<span class="line-removed"> 857                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {</span>
<span class="line-removed"> 858                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed"> 859                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));</span>
<span class="line-removed"> 860                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));</span>
<span class="line-removed"> 861                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));</span>
<span class="line-removed"> 862                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));</span>
<span class="line-removed"> 863                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));</span>
<span class="line-removed"> 864                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="line-removed"> 865                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {</span>
<span class="line-removed"> 866                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed"> 867                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));</span>
<span class="line-removed"> 868                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));</span>
<span class="line-removed"> 869                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));</span>
<span class="line-removed"> 870                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));</span>
<span class="line-removed"> 871                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));</span>
<span class="line-removed"> 872                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="line-removed"> 873                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {</span>
<span class="line-removed"> 874                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed"> 875                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));</span>
<span class="line-removed"> 876                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));</span>
<span class="line-removed"> 877                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));</span>
<span class="line-removed"> 878                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));</span>
<span class="line-removed"> 879                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));</span>
<span class="line-removed"> 880                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="line-removed"> 881                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {</span>
<span class="line-removed"> 882                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="line-removed"> 883                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));</span>
<span class="line-removed"> 884                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));</span>
<span class="line-removed"> 885                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));</span>
<span class="line-removed"> 886                     assertTrue(email.body().contains(&quot;67890123: Brand new fixes&quot;));</span>
<span class="line-removed"> 887                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));</span>
<span class="line-removed"> 888                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());</span>
<span class="line-removed"> 889                 } else {</span>
<span class="line-removed"> 890                     fail(&quot;Mismatched subject: &quot; + email.subject());</span>
<span class="line-removed"> 891                 }</span>
<span class="line-removed"> 892                 assertTrue(email.hasHeader(&quot;extra1&quot;));</span>
<span class="line-removed"> 893                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));</span>
<span class="line-removed"> 894                 assertTrue(email.hasHeader(&quot;extra2&quot;));</span>
<span class="line-removed"> 895                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));</span>
<span class="line-removed"> 896             }</span>
<span class="line-removed"> 897         }</span>
<span class="line-removed"> 898     }</span>
<span class="line-removed"> 899 </span>
<span class="line-removed"> 900     @Test</span>
<span class="line-removed"> 901     void testMailinglistPlainTags(TestInfo testInfo) throws IOException {</span>
<span class="line-removed"> 902         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed"> 903              var tempFolder = new TemporaryDirectory();</span>
<span class="line-removed"> 904              var listServer = new TestMailmanServer()) {</span>
<span class="line-removed"> 905             var repo = credentials.getHostedRepository();</span>
<span class="line-removed"> 906             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed"> 907             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());</span>
<span class="line-removed"> 908             credentials.commitLock(localRepo);</span>
<span class="line-removed"> 909             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed"> 910             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="line-removed"> 911             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 912 </span>
<span class="line-removed"> 913             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-removed"> 914             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-removed"> 915             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-removed"> 916             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed"> 917             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed"> 918             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed"> 919             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed"> 920 </span>
<span class="line-removed"> 921             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-removed"> 922             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-removed"> 923                                             .list(mailmanList)</span>
<span class="line-removed"> 924                                             .recipient(listAddress)</span>
<span class="line-removed"> 925                                             .sender(sender)</span>
<span class="line-removed"> 926                                             .reportNewBranches(false)</span>
<span class="line-removed"> 927                                             .reportNewBuilds(false)</span>
<span class="line-removed"> 928                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="line-removed"> 929                                             .build();</span>
<span class="line-removed"> 930             var noTagsUpdater = MailingListUpdater.newBuilder()</span>
<span class="line-removed"> 931                                                   .list(mailmanList)</span>
<span class="line-removed"> 932                                                   .recipient(listAddress)</span>
<span class="line-removed"> 933                                                   .sender(sender)</span>
<span class="line-removed"> 934                                                   .reportNewTags(false)</span>
<span class="line-removed"> 935                                                   .reportNewBranches(false)</span>
<span class="line-removed"> 936                                                   .reportNewBuilds(false)</span>
<span class="line-removed"> 937                                                   .build();</span>
<span class="line-removed"> 938             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed"> 939                                      .repository(repo)</span>
<span class="line-removed"> 940                                      .storagePath(storageFolder)</span>
<span class="line-removed"> 941                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed"> 942                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed"> 943                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed"> 944                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed"> 945                                      .updaters(List.of(updater, noTagsUpdater))</span>
<span class="line-removed"> 946                                      .build();</span>
<span class="line-removed"> 947 </span>
<span class="line-removed"> 948             // No mail should be sent on the first run as there is no history</span>
<span class="line-removed"> 949             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 950             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed"> 951 </span>
<span class="line-removed"> 952             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed"> 953             localRepo.fetch(repo.url(), &quot;history:history&quot;);</span>
<span class="line-removed"> 954             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="line-removed"> 955             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);</span>
<span class="line-removed"> 956             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);</span>
<span class="line-removed"> 957             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);</span>
<span class="line-removed"> 958             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="line-removed"> 959             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);</span>
<span class="line-removed"> 960             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);</span>
<span class="line-removed"> 961             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="line-removed"> 962             localRepo.pushAll(repo.url());</span>
<span class="line-removed"> 963 </span>
<span class="line-removed"> 964             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed"> 965             listServer.processIncoming();</span>
<span class="line-removed"> 966             listServer.processIncoming();</span>
<span class="line-removed"> 967             listServer.processIncoming();</span>
<span class="line-removed"> 968             listServer.processIncoming();</span>
<span class="line-removed"> 969 </span>
<span class="line-removed"> 970             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed"> 971             assertEquals(4, conversations.size());</span>
<span class="line-removed"> 972 </span>
<span class="line-removed"> 973             for (var conversation : conversations) {</span>
<span class="line-removed"> 974                 var email = conversation.first();</span>
<span class="line-removed"> 975                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {</span>
<span class="line-removed"> 976                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="line-removed"> 977                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {</span>
<span class="line-removed"> 978                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="line-removed"> 979                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {</span>
<span class="line-removed"> 980                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="line-removed"> 981                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {</span>
<span class="line-removed"> 982                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());</span>
<span class="line-removed"> 983                 } else {</span>
<span class="line-removed"> 984                     fail(&quot;Mismatched subject: &quot; + email.subject());</span>
<span class="line-removed"> 985                 }</span>
<span class="line-removed"> 986                 assertTrue(email.hasHeader(&quot;extra1&quot;));</span>
<span class="line-removed"> 987                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));</span>
<span class="line-removed"> 988                 assertTrue(email.hasHeader(&quot;extra2&quot;));</span>
<span class="line-removed"> 989                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));</span>
<span class="line-removed"> 990             }</span>
<span class="line-removed"> 991         }</span>
<span class="line-removed"> 992     }</span>
<span class="line-removed"> 993 </span>
<span class="line-removed"> 994     @Test</span>
<span class="line-removed"> 995     void testMailingListBranch(TestInfo testInfo) throws IOException {</span>
<span class="line-removed"> 996         try (var listServer = new TestMailmanServer();</span>
<span class="line-removed"> 997              var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed"> 998              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed"> 999             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">1000             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">1001             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed">1002             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed">1003             credentials.commitLock(localRepo);</span>
<span class="line-removed">1004             localRepo.pushAll(repo.url());</span>
<span class="line-removed">1005 </span>
<span class="line-removed">1006             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-removed">1007             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-removed">1008             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-removed">1009             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">1010             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">1011             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">1012             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">1013 </span>
<span class="line-removed">1014             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-removed">1015             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-removed">1016                                             .list(mailmanList)</span>
<span class="line-removed">1017                                             .recipient(listAddress)</span>
<span class="line-removed">1018                                             .sender(sender)</span>
<span class="line-removed">1019                                             .reportNewTags(false)</span>
<span class="line-removed">1020                                             .reportNewBuilds(false)</span>
<span class="line-removed">1021                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="line-removed">1022                                             .build();</span>
<span class="line-removed">1023             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed">1024                                      .repository(repo)</span>
<span class="line-removed">1025                                      .storagePath(storageFolder)</span>
<span class="line-removed">1026                                      .branches(Pattern.compile(&quot;master|newbranch.&quot;))</span>
<span class="line-removed">1027                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed">1028                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed">1029                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed">1030                                      .updaters(List.of(updater))</span>
<span class="line-removed">1031                                      .build();</span>
<span class="line-removed">1032 </span>
<span class="line-removed">1033             // No mail should be sent on the first run as there is no history</span>
<span class="line-removed">1034             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1035             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed">1036 </span>
<span class="line-removed">1037             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);</span>
<span class="line-removed">1038             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed">1039             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);</span>
<span class="line-removed">1040             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1041             listServer.processIncoming();</span>
<span class="line-removed">1042 </span>
<span class="line-removed">1043             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed">1044             var email = conversations.get(0).first();</span>
<span class="line-removed">1045             assertEquals(listAddress, email.sender());</span>
<span class="line-removed">1046             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());</span>
<span class="line-removed">1047             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="line-removed">1048             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());</span>
<span class="line-removed">1049             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));</span>
<span class="line-removed">1050             assertTrue(email.hasHeader(&quot;extra1&quot;));</span>
<span class="line-removed">1051             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));</span>
<span class="line-removed">1052             assertTrue(email.hasHeader(&quot;extra2&quot;));</span>
<span class="line-removed">1053             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));</span>
<span class="line-removed">1054 </span>
<span class="line-removed">1055             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1056             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed">1057 </span>
<span class="line-removed">1058             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);</span>
<span class="line-removed">1059             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1060             listServer.processIncoming();</span>
<span class="line-removed">1061 </span>
<span class="line-removed">1062             var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()</span>
<span class="line-removed">1063                                              .filter(c -&gt; !c.equals(conversations.get(0)))</span>
<span class="line-removed">1064                                              .findFirst().orElseThrow();</span>
<span class="line-removed">1065             email = newConversation.first();</span>
<span class="line-removed">1066             assertEquals(listAddress, email.sender());</span>
<span class="line-removed">1067             assertEquals(sender, email.author());</span>
<span class="line-removed">1068             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="line-removed">1069             assertEquals(&quot;git: test: created branch newbranch2 based on the branch newbranch1 containing 0 unique commits&quot;, email.subject());</span>
<span class="line-removed">1070             assertEquals(&quot;The new branch newbranch2 is currently identical to the newbranch1 branch.&quot;, email.body());</span>
<span class="line-removed">1071         }</span>
<span class="line-removed">1072     }</span>
<span class="line-removed">1073 </span>
<span class="line-removed">1074     @Test</span>
<span class="line-removed">1075     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {</span>
<span class="line-removed">1076         try (var listServer = new TestMailmanServer();</span>
<span class="line-removed">1077              var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed">1078              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed">1079             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">1080             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">1081             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed">1082             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-removed">1083             credentials.commitLock(localRepo);</span>
<span class="line-removed">1084             localRepo.pushAll(repo.url());</span>
<span class="line-removed">1085 </span>
<span class="line-removed">1086             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-removed">1087             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-removed">1088             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-removed">1089             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">1090             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">1091             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">1092             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">1093 </span>
<span class="line-removed">1094             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-removed">1095             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-removed">1096                                             .list(mailmanList)</span>
<span class="line-removed">1097                                             .recipient(listAddress)</span>
<span class="line-removed">1098                                             .sender(sender)</span>
<span class="line-removed">1099                                             .reportNewTags(false)</span>
<span class="line-removed">1100                                             .reportNewBranches(false)</span>
<span class="line-removed">1101                                             .reportNewBuilds(false)</span>
<span class="line-removed">1102                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="line-removed">1103                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))</span>
<span class="line-removed">1104                                             .build();</span>
<span class="line-removed">1105             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed">1106                                      .repository(repo)</span>
<span class="line-removed">1107                                      .storagePath(storageFolder)</span>
<span class="line-removed">1108                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed">1109                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed">1110                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed">1111                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed">1112                                      .updaters(List.of(updater))</span>
<span class="line-removed">1113                                      .build();</span>
<span class="line-removed">1114 </span>
<span class="line-removed">1115             // No mail should be sent on the first run as there is no history</span>
<span class="line-removed">1116             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1117             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-removed">1118 </span>
<span class="line-removed">1119             // Save history state</span>
<span class="line-removed">1120             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);</span>
<span class="line-removed">1121 </span>
<span class="line-removed">1122             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-removed">1123             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed">1124             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1125             listServer.processIncoming();</span>
<span class="line-removed">1126 </span>
<span class="line-removed">1127             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed">1128             assertEquals(1, conversations.size());</span>
<span class="line-removed">1129 </span>
<span class="line-removed">1130             // Reset the history</span>
<span class="line-removed">1131             localRepo.push(historyHash, repo.url(), &quot;history&quot;, true);</span>
<span class="line-removed">1132             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1133             listServer.processIncoming();</span>
<span class="line-removed">1134 </span>
<span class="line-removed">1135             // There should now be a duplicate mail</span>
<span class="line-removed">1136             conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-removed">1137             assertEquals(2, conversations.size());</span>
<span class="line-removed">1138         }</span>
<span class="line-removed">1139     }</span>
<span class="line-removed">1140 </span>
<span class="line-removed">1141     @Test</span>
<span class="line-removed">1142     void testIssue(TestInfo testInfo) throws IOException {</span>
<span class="line-removed">1143         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed">1144              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed">1145             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">1146             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">1147             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed">1148             credentials.commitLock(localRepo);</span>
<span class="line-removed">1149             localRepo.pushAll(repo.url());</span>
<span class="line-removed">1150 </span>
<span class="line-removed">1151             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">1152             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">1153             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">1154             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">1155 </span>
<span class="line-removed">1156             var issueProject = credentials.getIssueProject();</span>
<span class="line-removed">1157             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);</span>
<span class="line-removed">1158             var updater = IssueUpdater.newBuilder()</span>
<span class="line-removed">1159                                       .issueProject(issueProject)</span>
<span class="line-removed">1160                                       .reviewLink(false)</span>
<span class="line-removed">1161                                       .commitIcon(commitIcon)</span>
<span class="line-removed">1162                                       .setFixVersion(true)</span>
<span class="line-removed">1163                                       .build();</span>
<span class="line-removed">1164             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed">1165                                      .repository(repo)</span>
<span class="line-removed">1166                                      .storagePath(storageFolder)</span>
<span class="line-removed">1167                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed">1168                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed">1169                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed">1170                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed">1171                                      .updaters(List.of(updater))</span>
<span class="line-removed">1172                                      .build();</span>
<span class="line-removed">1173 </span>
<span class="line-removed">1174             // Initialize history</span>
<span class="line-removed">1175             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1176 </span>
<span class="line-removed">1177             // Create an issue and commit a fix</span>
<span class="line-removed">1178             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;</span>
<span class="line-removed">1179             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-removed">1180             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);</span>
<span class="line-removed">1181             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed">1182             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1183 </span>
<span class="line-removed">1184             // The changeset should be reflected in a comment</span>
<span class="line-removed">1185             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-removed">1186 </span>
<span class="line-removed">1187             var comments = updatedIssue.comments();</span>
<span class="line-removed">1188             assertEquals(1, comments.size());</span>
<span class="line-removed">1189             var comment = comments.get(0);</span>
<span class="line-removed">1190             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-removed">1191 </span>
<span class="line-removed">1192             // And in a link</span>
<span class="line-removed">1193             var links = updatedIssue.links();</span>
<span class="line-removed">1194             assertEquals(1, links.size());</span>
<span class="line-removed">1195             var link = links.get(0);</span>
<span class="line-removed">1196             assertEquals(commitIcon, link.iconUrl().orElseThrow());</span>
<span class="line-removed">1197             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());</span>
<span class="line-removed">1198             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());</span>
<span class="line-removed">1199 </span>
<span class="line-removed">1200             // As well as a fixVersion</span>
<span class="line-removed">1201             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));</span>
<span class="line-removed">1202 </span>
<span class="line-removed">1203             // The issue should be assigned and resolved</span>
<span class="line-removed">1204             assertEquals(RESOLVED, updatedIssue.state());</span>
<span class="line-removed">1205             assertEquals(List.of(issueProject.issueTracker().currentUser()), updatedIssue.assignees());</span>
<span class="line-removed">1206         }</span>
<span class="line-removed">1207     }</span>
<span class="line-removed">1208 </span>
<span class="line-removed">1209     @Test</span>
<span class="line-removed">1210     void testIssueNoVersion(TestInfo testInfo) throws IOException {</span>
<span class="line-removed">1211         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed">1212              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed">1213             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">1214             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">1215             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-removed">1216             credentials.commitLock(localRepo);</span>
<span class="line-removed">1217             localRepo.pushAll(repo.url());</span>
<span class="line-removed">1218 </span>
<span class="line-removed">1219             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">1220             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">1221             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">1222             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">1223 </span>
<span class="line-removed">1224             var issueProject = credentials.getIssueProject();</span>
<span class="line-removed">1225             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);</span>
<span class="line-removed">1226             var updater = IssueUpdater.newBuilder()</span>
<span class="line-removed">1227                                       .issueProject(issueProject)</span>
<span class="line-removed">1228                                       .reviewLink(false)</span>
<span class="line-removed">1229                                       .commitIcon(commitIcon)</span>
<span class="line-removed">1230                                       .setFixVersion(true)</span>
<span class="line-removed">1231                                       .build();</span>
<span class="line-removed">1232             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed">1233                                      .repository(repo)</span>
<span class="line-removed">1234                                      .storagePath(storageFolder)</span>
<span class="line-removed">1235                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed">1236                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed">1237                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed">1238                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed">1239                                      .updaters(List.of(updater))</span>
<span class="line-removed">1240                                      .build();</span>
<span class="line-removed">1241 </span>
<span class="line-removed">1242             // Initialize history</span>
<span class="line-removed">1243             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1244 </span>
<span class="line-removed">1245             // Create an issue and commit a fix</span>
<span class="line-removed">1246             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-removed">1247             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-removed">1248             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed">1249             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1250 </span>
<span class="line-removed">1251             // The changeset should be reflected in a comment</span>
<span class="line-removed">1252             var comments = issue.comments();</span>
<span class="line-removed">1253             assertEquals(1, comments.size());</span>
<span class="line-removed">1254             var comment = comments.get(0);</span>
<span class="line-removed">1255             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-removed">1256 </span>
<span class="line-removed">1257             // But not in the fixVersion</span>
<span class="line-removed">1258             assertEquals(Set.of(), fixVersions(issue));</span>
<span class="line-removed">1259         }</span>
<span class="line-removed">1260     }</span>
<span class="line-removed">1261 </span>
<span class="line-removed">1262     @Test</span>
<span class="line-removed">1263     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {</span>
<span class="line-removed">1264         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed">1265              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed">1266             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">1267             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">1268             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-removed">1269             credentials.commitLock(localRepo);</span>
<span class="line-removed">1270             localRepo.pushAll(repo.url());</span>
<span class="line-removed">1271 </span>
<span class="line-removed">1272             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">1273             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">1274             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">1275             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">1276 </span>
<span class="line-removed">1277             var issueProject = credentials.getIssueProject();</span>
<span class="line-removed">1278             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);</span>
<span class="line-removed">1279             var updater = IssueUpdater.newBuilder()</span>
<span class="line-removed">1280                                       .issueProject(issueProject)</span>
<span class="line-removed">1281                                       .reviewLink(false)</span>
<span class="line-removed">1282                                       .commitLink(false)</span>
<span class="line-removed">1283                                       .commitIcon(commitIcon)</span>
<span class="line-removed">1284                                       .setFixVersion(true)</span>
<span class="line-removed">1285                                       .fixVersions(Map.of(&quot;master&quot;, &quot;2.0&quot;))</span>
<span class="line-removed">1286                                       .build();</span>
<span class="line-removed">1287             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed">1288                                      .repository(repo)</span>
<span class="line-removed">1289                                      .storagePath(storageFolder)</span>
<span class="line-removed">1290                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed">1291                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed">1292                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed">1293                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed">1294                                      .updaters(List.of(updater))</span>
<span class="line-removed">1295                                      .build();</span>
<span class="line-removed">1296 </span>
<span class="line-removed">1297             // Initialize history</span>
<span class="line-removed">1298             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1299 </span>
<span class="line-removed">1300             // Create an issue and commit a fix</span>
<span class="line-removed">1301             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-removed">1302             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-removed">1303             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed">1304             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1305 </span>
<span class="line-removed">1306             // The changeset should not reflected in a comment</span>
<span class="line-removed">1307             var comments = issue.comments();</span>
<span class="line-removed">1308             assertEquals(1, comments.size());</span>
<span class="line-removed">1309             var comment = comments.get(0);</span>
<span class="line-removed">1310             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-removed">1311 </span>
<span class="line-removed">1312             // As well as a fixVersion - but not the one from the repo</span>
<span class="line-removed">1313             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));</span>
<span class="line-removed">1314 </span>
<span class="line-removed">1315             // And no commit link</span>
<span class="line-removed">1316             var links = issue.links();</span>
<span class="line-removed">1317             assertEquals(0, links.size());</span>
<span class="line-removed">1318         }</span>
<span class="line-removed">1319     }</span>
<span class="line-removed">1320 </span>
<span class="line-removed">1321     @Test</span>
<span class="line-removed">1322     void testIssueIdempotence(TestInfo testInfo) throws IOException {</span>
<span class="line-removed">1323         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed">1324              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed">1325             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">1326             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">1327             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed">1328             credentials.commitLock(localRepo);</span>
<span class="line-removed">1329             localRepo.pushAll(repo.url());</span>
<span class="line-removed">1330 </span>
<span class="line-removed">1331             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">1332             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">1333             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">1334             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">1335 </span>
<span class="line-removed">1336             var issueProject = credentials.getIssueProject();</span>
<span class="line-removed">1337             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);</span>
<span class="line-removed">1338             var updater = IssueUpdater.newBuilder()</span>
<span class="line-removed">1339                                       .issueProject(issueProject)</span>
<span class="line-removed">1340                                       .reviewLink(false)</span>
<span class="line-removed">1341                                       .commitIcon(commitIcon)</span>
<span class="line-removed">1342                                       .setFixVersion(true)</span>
<span class="line-removed">1343                                       .build();</span>
<span class="line-removed">1344             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed">1345                                      .repository(repo)</span>
<span class="line-removed">1346                                      .storagePath(storageFolder)</span>
<span class="line-removed">1347                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed">1348                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed">1349                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed">1350                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed">1351                                      .updaters(List.of(updater))</span>
<span class="line-removed">1352                                      .build();</span>
<span class="line-removed">1353 </span>
<span class="line-removed">1354             // Initialize history</span>
<span class="line-removed">1355             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1356 </span>
<span class="line-removed">1357             // Save the state</span>
<span class="line-removed">1358             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);</span>
<span class="line-removed">1359 </span>
<span class="line-removed">1360             // Create an issue and commit a fix</span>
<span class="line-removed">1361             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-removed">1362             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-removed">1363             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed">1364             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1365 </span>
<span class="line-removed">1366             // The changeset should be reflected in a comment</span>
<span class="line-removed">1367             var comments = issue.comments();</span>
<span class="line-removed">1368             assertEquals(1, comments.size());</span>
<span class="line-removed">1369             var comment = comments.get(0);</span>
<span class="line-removed">1370             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-removed">1371 </span>
<span class="line-removed">1372             // And in a link</span>
<span class="line-removed">1373             var links = issue.links();</span>
<span class="line-removed">1374             assertEquals(1, links.size());</span>
<span class="line-removed">1375             var link = links.get(0);</span>
<span class="line-removed">1376             assertEquals(commitIcon, link.iconUrl().orElseThrow());</span>
<span class="line-removed">1377             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());</span>
<span class="line-removed">1378             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());</span>
<span class="line-removed">1379 </span>
<span class="line-removed">1380             // As well as a fixVersion</span>
<span class="line-removed">1381             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));</span>
<span class="line-removed">1382 </span>
<span class="line-removed">1383             // Wipe the history</span>
<span class="line-removed">1384             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);</span>
<span class="line-removed">1385 </span>
<span class="line-removed">1386             // Run it again</span>
<span class="line-removed">1387             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1388 </span>
<span class="line-removed">1389             // There should be no new comments, links or fixVersions</span>
<span class="line-removed">1390             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-removed">1391             assertEquals(1, updatedIssue.comments().size());</span>
<span class="line-removed">1392             assertEquals(1, updatedIssue.links().size());</span>
<span class="line-removed">1393             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));</span>
<span class="line-removed">1394         }</span>
<span class="line-removed">1395     }</span>
<span class="line-removed">1396 </span>
<span class="line-removed">1397     @Test</span>
<span class="line-removed">1398     void testIssuePoolVersion(TestInfo testInfo) throws IOException {</span>
<span class="line-removed">1399         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed">1400              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed">1401             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">1402             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">1403             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-removed">1404             credentials.commitLock(localRepo);</span>
<span class="line-removed">1405             localRepo.pushAll(repo.url());</span>
<span class="line-removed">1406 </span>
<span class="line-removed">1407             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">1408             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">1409             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">1410             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">1411 </span>
<span class="line-removed">1412             var issueProject = credentials.getIssueProject();</span>
<span class="line-removed">1413             var updater = IssueUpdater.newBuilder()</span>
<span class="line-removed">1414                                       .issueProject(issueProject)</span>
<span class="line-removed">1415                                       .reviewLink(false)</span>
<span class="line-removed">1416                                       .commitLink(false)</span>
<span class="line-removed">1417                                       .setFixVersion(true)</span>
<span class="line-removed">1418                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))</span>
<span class="line-removed">1419                                       .build();</span>
<span class="line-removed">1420             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed">1421                                      .repository(repo)</span>
<span class="line-removed">1422                                      .storagePath(storageFolder)</span>
<span class="line-removed">1423                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed">1424                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed">1425                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed">1426                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed">1427                                      .updaters(List.of(updater))</span>
<span class="line-removed">1428                                      .build();</span>
<span class="line-removed">1429 </span>
<span class="line-removed">1430             // Initialize history</span>
<span class="line-removed">1431             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1432 </span>
<span class="line-removed">1433             // Create an issue and commit a fix</span>
<span class="line-removed">1434             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-removed">1435             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));</span>
<span class="line-removed">1436 </span>
<span class="line-removed">1437             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-removed">1438             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed">1439             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1440 </span>
<span class="line-removed">1441             // The fixVersion should have been updated</span>
<span class="line-removed">1442             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));</span>
<span class="line-removed">1443         }</span>
<span class="line-removed">1444     }</span>
<span class="line-removed">1445 </span>
<span class="line-removed">1446     @Test</span>
<span class="line-removed">1447     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {</span>
<span class="line-removed">1448         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed">1449              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed">1450             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">1451             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">1452             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-removed">1453             credentials.commitLock(localRepo);</span>
<span class="line-removed">1454             localRepo.pushAll(repo.url());</span>
<span class="line-removed">1455 </span>
<span class="line-removed">1456             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">1457             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">1458             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">1459             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">1460 </span>
<span class="line-removed">1461             var issueProject = credentials.getIssueProject();</span>
<span class="line-removed">1462             var updater = IssueUpdater.newBuilder()</span>
<span class="line-removed">1463                                       .issueProject(issueProject)</span>
<span class="line-removed">1464                                       .reviewLink(false)</span>
<span class="line-removed">1465                                       .commitLink(false)</span>
<span class="line-removed">1466                                       .setFixVersion(true)</span>
<span class="line-removed">1467                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))</span>
<span class="line-removed">1468                                       .build();</span>
<span class="line-removed">1469             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed">1470                                      .repository(repo)</span>
<span class="line-removed">1471                                      .storagePath(storageFolder)</span>
<span class="line-removed">1472                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed">1473                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed">1474                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed">1475                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed">1476                                      .updaters(List.of(updater))</span>
<span class="line-removed">1477                                      .build();</span>
<span class="line-removed">1478 </span>
<span class="line-removed">1479             // Initialize history</span>
<span class="line-removed">1480             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1481 </span>
<span class="line-removed">1482             // Create an issue and commit a fix</span>
<span class="line-removed">1483             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-removed">1484             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));</span>
<span class="line-removed">1485 </span>
<span class="line-removed">1486             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-removed">1487             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed">1488             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1489 </span>
<span class="line-removed">1490             // The fixVersion should have been updated</span>
<span class="line-removed">1491             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));</span>
<span class="line-removed">1492         }</span>
<span class="line-removed">1493     }</span>
<span class="line-removed">1494 </span>
<span class="line-removed">1495     @Test</span>
<span class="line-removed">1496     void testIssueBackport(TestInfo testInfo) throws IOException {</span>
<span class="line-removed">1497         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed">1498              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed">1499             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">1500             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">1501             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-removed">1502             credentials.commitLock(localRepo);</span>
<span class="line-removed">1503             localRepo.pushAll(repo.url());</span>
<span class="line-removed">1504 </span>
<span class="line-removed">1505             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">1506             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">1507             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">1508             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">1509 </span>
<span class="line-removed">1510             var issueProject = credentials.getIssueProject();</span>
<span class="line-removed">1511             var updater = IssueUpdater.newBuilder()</span>
<span class="line-removed">1512                                       .issueProject(issueProject)</span>
<span class="line-removed">1513                                       .reviewLink(false)</span>
<span class="line-removed">1514                                       .commitLink(false)</span>
<span class="line-removed">1515                                       .setFixVersion(true)</span>
<span class="line-removed">1516                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12.0.2&quot;))</span>
<span class="line-removed">1517                                       .build();</span>
<span class="line-removed">1518             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed">1519                                      .repository(repo)</span>
<span class="line-removed">1520                                      .storagePath(storageFolder)</span>
<span class="line-removed">1521                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed">1522                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed">1523                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed">1524                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed">1525                                      .updaters(List.of(updater))</span>
<span class="line-removed">1526                                      .build();</span>
<span class="line-removed">1527 </span>
<span class="line-removed">1528             // Initialize history</span>
<span class="line-removed">1529             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1530 </span>
<span class="line-removed">1531             // Create an issue and commit a fix</span>
<span class="line-removed">1532             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),</span>
<span class="line-removed">1533                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),</span>
<span class="line-removed">1534                                                         &quot;customfield_10008&quot;, JSON.object()</span>
<span class="line-removed">1535                                                                                  .put(&quot;id&quot;, 244)</span>
<span class="line-removed">1536                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),</span>
<span class="line-removed">1537                                                         &quot;customfield_10005&quot;, JSON.array()</span>
<span class="line-removed">1538                                                                                  .add(JSON.object()</span>
<span class="line-removed">1539                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)</span>
<span class="line-removed">1540                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))</span>
<span class="line-removed">1541                                                                                  .add(JSON.object()</span>
<span class="line-removed">1542                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)</span>
<span class="line-removed">1543                                                                                           .put(&quot;value&quot;, &quot;other&quot;))</span>
<span class="line-removed">1544                                                  ));</span>
<span class="line-removed">1545             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));</span>
<span class="line-removed">1546             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));</span>
<span class="line-removed">1547 </span>
<span class="line-removed">1548             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;</span>
<span class="line-removed">1549             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);</span>
<span class="line-removed">1550             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed">1551             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1552 </span>
<span class="line-removed">1553             // The fixVersion should not have been updated</span>
<span class="line-removed">1554             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-removed">1555             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));</span>
<span class="line-removed">1556             assertEquals(OPEN, updatedIssue.state());</span>
<span class="line-removed">1557             assertEquals(List.of(), updatedIssue.assignees());</span>
<span class="line-removed">1558 </span>
<span class="line-removed">1559             // There should be a link</span>
<span class="line-removed">1560             var links = updatedIssue.links();</span>
<span class="line-removed">1561             assertEquals(1, links.size());</span>
<span class="line-removed">1562             var link = links.get(0);</span>
<span class="line-removed">1563             var backport = link.issue().orElseThrow();</span>
<span class="line-removed">1564 </span>
<span class="line-removed">1565             // The backport issue should have a correct fixVersion and assignee</span>
<span class="line-removed">1566             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));</span>
<span class="line-removed">1567             assertEquals(RESOLVED, backport.state());</span>
<span class="line-removed">1568             assertEquals(List.of(issueProject.issueTracker().currentUser()), backport.assignees());</span>
<span class="line-removed">1569 </span>
<span class="line-removed">1570             // Custom properties should also propagate</span>
<span class="line-removed">1571             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());</span>
<span class="line-removed">1572             assertEquals(244, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;id&quot;).asInt());</span>
<span class="line-removed">1573             assertEquals(&quot;java.io&quot;, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;name&quot;).asString());</span>
<span class="line-removed">1574             assertEquals(2, backport.properties().get(&quot;customfield_10005&quot;).asArray().size());</span>
<span class="line-removed">1575         }</span>
<span class="line-removed">1576     }</span>
<span class="line-removed">1577 </span>
<span class="line-removed">1578     @Test</span>
<span class="line-removed">1579     void testPullRequest(TestInfo testInfo) throws IOException {</span>
<span class="line-removed">1580         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed">1581              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed">1582             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">1583             var reviewer = credentials.getHostedRepository();</span>
<span class="line-removed">1584             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">1585             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed">1586             credentials.commitLock(localRepo);</span>
<span class="line-removed">1587             localRepo.pushAll(repo.url());</span>
<span class="line-removed">1588 </span>
<span class="line-removed">1589             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">1590             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">1591             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">1592             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">1593 </span>
<span class="line-removed">1594             var issueProject = credentials.getIssueProject();</span>
<span class="line-removed">1595             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);</span>
<span class="line-removed">1596             var updater = IssueUpdater.newBuilder()</span>
<span class="line-removed">1597                                       .issueProject(issueProject)</span>
<span class="line-removed">1598                                       .reviewIcon(reviewIcon)</span>
<span class="line-removed">1599                                       .commitLink(false)</span>
<span class="line-removed">1600                                       .build();</span>
<span class="line-removed">1601             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed">1602                                      .repository(repo)</span>
<span class="line-removed">1603                                      .storagePath(storageFolder)</span>
<span class="line-removed">1604                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed">1605                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed">1606                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed">1607                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed">1608                                      .prUpdaters(List.of(updater))</span>
<span class="line-removed">1609                                      .readyLabels(Set.of(&quot;rfr&quot;))</span>
<span class="line-removed">1610                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))</span>
<span class="line-removed">1611                                      .build();</span>
<span class="line-removed">1612 </span>
<span class="line-removed">1613             // Initialize history</span>
<span class="line-removed">1614             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1615 </span>
<span class="line-removed">1616             // Create an issue and a pull request to fix it</span>
<span class="line-removed">1617             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-removed">1618             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);</span>
<span class="line-removed">1619             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);</span>
<span class="line-removed">1620             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-removed">1621             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);</span>
<span class="line-removed">1622             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1623 </span>
<span class="line-removed">1624             // The issue should not yet contain a link to the PR</span>
<span class="line-removed">1625             var links = issue.links();</span>
<span class="line-removed">1626             assertEquals(0, links.size());</span>
<span class="line-removed">1627 </span>
<span class="line-removed">1628             // Just a label isn&#39;t enough</span>
<span class="line-removed">1629             pr.addLabel(&quot;rfr&quot;);</span>
<span class="line-removed">1630             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1631             links = issue.links();</span>
<span class="line-removed">1632             assertEquals(0, links.size());</span>
<span class="line-removed">1633 </span>
<span class="line-removed">1634             // Neither is just a comment</span>
<span class="line-removed">1635             pr.removeLabel(&quot;rfr&quot;);</span>
<span class="line-removed">1636             var reviewPr = reviewer.pullRequest(pr.id());</span>
<span class="line-removed">1637             reviewPr.addComment(&quot;This is now ready&quot;);</span>
<span class="line-removed">1638             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1639             links = issue.links();</span>
<span class="line-removed">1640             assertEquals(0, links.size());</span>
<span class="line-removed">1641 </span>
<span class="line-removed">1642             // Both are needed</span>
<span class="line-removed">1643             pr.addLabel(&quot;rfr&quot;);</span>
<span class="line-removed">1644             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1645 </span>
<span class="line-removed">1646             // The issue should now contain a link to the PR</span>
<span class="line-removed">1647             links = issue.links();</span>
<span class="line-removed">1648             assertEquals(1, links.size());</span>
<span class="line-removed">1649             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());</span>
<span class="line-removed">1650             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());</span>
<span class="line-removed">1651 </span>
<span class="line-removed">1652             // Add another issue</span>
<span class="line-removed">1653             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-removed">1654             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n * [&quot; + issue2.id() +</span>
<span class="line-removed">1655                                &quot;](http://www.test2.test/): The second issue&quot;);</span>
<span class="line-removed">1656             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1657 </span>
<span class="line-removed">1658             // Both issues should contain a link to the PR</span>
<span class="line-removed">1659             var links1 = issue.links();</span>
<span class="line-removed">1660             assertEquals(1, links1.size());</span>
<span class="line-removed">1661             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());</span>
<span class="line-removed">1662             var links2 = issue2.links();</span>
<span class="line-removed">1663             assertEquals(1, links2.size());</span>
<span class="line-removed">1664             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());</span>
<span class="line-removed">1665 </span>
<span class="line-removed">1666             // Drop the first one</span>
<span class="line-removed">1667             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);</span>
<span class="line-removed">1668             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1669 </span>
<span class="line-removed">1670             // Only the second issue should now contain a link to the PR</span>
<span class="line-removed">1671             links1 = issue.links();</span>
<span class="line-removed">1672             assertEquals(0, links1.size());</span>
<span class="line-removed">1673             links2 = issue2.links();</span>
<span class="line-removed">1674             assertEquals(1, links2.size());</span>
<span class="line-removed">1675             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());</span>
<span class="line-removed">1676         }</span>
<span class="line-removed">1677     }</span>
<span class="line-removed">1678 </span>
<span class="line-removed">1679     @Test</span>
<span class="line-removed">1680     void testPullRequestNoReview(TestInfo testInfo) throws IOException {</span>
<span class="line-removed">1681         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed">1682              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed">1683             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">1684             var reviewer = credentials.getHostedRepository();</span>
<span class="line-removed">1685             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">1686             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed">1687             credentials.commitLock(localRepo);</span>
<span class="line-removed">1688             localRepo.pushAll(repo.url());</span>
<span class="line-removed">1689 </span>
<span class="line-removed">1690             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">1691             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">1692             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">1693             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">1694 </span>
<span class="line-removed">1695             var issueProject = credentials.getIssueProject();</span>
<span class="line-removed">1696             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);</span>
<span class="line-removed">1697             var updater = IssueUpdater.newBuilder()</span>
<span class="line-removed">1698                                       .issueProject(issueProject)</span>
<span class="line-removed">1699                                       .reviewLink(false)</span>
<span class="line-removed">1700                                       .reviewIcon(reviewIcon)</span>
<span class="line-removed">1701                                       .commitLink(false)</span>
<span class="line-removed">1702                                       .build();</span>
<span class="line-removed">1703             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed">1704                                      .repository(repo)</span>
<span class="line-removed">1705                                      .storagePath(storageFolder)</span>
<span class="line-removed">1706                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-removed">1707                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed">1708                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed">1709                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed">1710                                      .prUpdaters(List.of(updater)).readyLabels(Set.of(&quot;rfr&quot;))</span>
<span class="line-removed">1711                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))</span>
<span class="line-removed">1712                                      .build();</span>
<span class="line-removed">1713             // Initialize history</span>
<span class="line-removed">1714             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1715 </span>
<span class="line-removed">1716             // Create an issue and a pull request to fix it</span>
<span class="line-removed">1717             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-removed">1718             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);</span>
<span class="line-removed">1719             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);</span>
<span class="line-removed">1720             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-removed">1721             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);</span>
<span class="line-removed">1722             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1723 </span>
<span class="line-removed">1724             // Add required label</span>
<span class="line-removed">1725             pr.addLabel(&quot;rfr&quot;);</span>
<span class="line-removed">1726             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1727 </span>
<span class="line-removed">1728             // And the required comment</span>
<span class="line-removed">1729             var reviewPr = reviewer.pullRequest(pr.id());</span>
<span class="line-removed">1730             reviewPr.addComment(&quot;This is now ready&quot;);</span>
<span class="line-removed">1731             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1732 </span>
<span class="line-removed">1733             // The issue should still not contain a link to the PR</span>
<span class="line-removed">1734             var links = issue.links();</span>
<span class="line-removed">1735             assertEquals(0, links.size());</span>
<span class="line-removed">1736         }</span>
<span class="line-removed">1737     }</span>
<span class="line-removed">1738 </span>
<span class="line-removed">1739     @Test</span>
<span class="line-removed">1740     void testPullRequestPROnly(TestInfo testInfo) throws IOException {</span>
<span class="line-removed">1741         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-removed">1742              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-removed">1743             var repo = credentials.getHostedRepository();</span>
<span class="line-removed">1744             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-removed">1745             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-removed">1746             credentials.commitLock(localRepo);</span>
<span class="line-removed">1747             localRepo.pushAll(repo.url());</span>
<span class="line-removed">1748 </span>
<span class="line-removed">1749             var tagStorage = createTagStorage(repo);</span>
<span class="line-removed">1750             var branchStorage = createBranchStorage(repo);</span>
<span class="line-removed">1751             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-removed">1752             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-removed">1753 </span>
<span class="line-removed">1754             var issueProject = credentials.getIssueProject();</span>
<span class="line-removed">1755             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);</span>
<span class="line-removed">1756             var updater = IssueUpdater.newBuilder()</span>
<span class="line-removed">1757                                       .issueProject(issueProject)</span>
<span class="line-removed">1758                                       .reviewIcon(reviewIcon)</span>
<span class="line-removed">1759                                       .commitLink(false)</span>
<span class="line-removed">1760                                       .prOnly(true)</span>
<span class="line-removed">1761                                       .build();</span>
<span class="line-removed">1762             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-removed">1763                                      .repository(repo)</span>
<span class="line-removed">1764                                      .storagePath(storageFolder)</span>
<span class="line-removed">1765                                      .branches(Pattern.compile(&quot;.*&quot;))</span>
<span class="line-removed">1766                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-removed">1767                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-removed">1768                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-removed">1769                                      .updaters(List.of(updater))</span>
<span class="line-removed">1770                                      .prUpdaters(List.of(updater))</span>
<span class="line-removed">1771                                      .build();</span>
<span class="line-removed">1772 </span>
<span class="line-removed">1773             // Initialize history</span>
<span class="line-removed">1774             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);</span>
<span class="line-removed">1775             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1776 </span>
<span class="line-removed">1777             // Create an issue and a pull request to fix it</span>
<span class="line-removed">1778             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-removed">1779             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-removed">1780             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);</span>
<span class="line-removed">1781             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-removed">1782             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);</span>
<span class="line-removed">1783             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1784 </span>
<span class="line-removed">1785             // The issue should now contain a link to the PR</span>
<span class="line-removed">1786             var links = issue.links();</span>
<span class="line-removed">1787             assertEquals(1, links.size());</span>
<span class="line-removed">1788             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());</span>
<span class="line-removed">1789             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());</span>
<span class="line-removed">1790 </span>
<span class="line-removed">1791             // Simulate integration</span>
<span class="line-removed">1792             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);</span>
<span class="line-removed">1793             localRepo.push(editHash, repo.url(), &quot;other&quot;);</span>
<span class="line-removed">1794             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1795 </span>
<span class="line-removed">1796             // The changeset should be reflected in a comment</span>
<span class="line-removed">1797             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-removed">1798 </span>
<span class="line-removed">1799             var comments = updatedIssue.comments();</span>
<span class="line-removed">1800             assertEquals(1, comments.size());</span>
<span class="line-removed">1801             var comment = comments.get(0);</span>
<span class="line-removed">1802             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-removed">1803 </span>
<span class="line-removed">1804             // Now simulate a merge to another branch</span>
<span class="line-removed">1805             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-removed">1806             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-removed">1807 </span>
<span class="line-removed">1808             // No additional comment should have been made</span>
<span class="line-removed">1809             updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-removed">1810             comments = updatedIssue.comments();</span>
<span class="line-removed">1811             assertEquals(1, comments.size());</span>
<span class="line-removed">1812         }</span>
<span class="line-removed">1813     }</span>
<span class="line-removed">1814 </span>
1815     private static class TestRepositoryUpdateConsumer implements RepositoryUpdateConsumer {
1816         private final String name;
1817         private final boolean idempotent;
1818         private int updateCount = 0;
1819         private boolean shouldFail = false;
1820 
1821         TestRepositoryUpdateConsumer(String name, boolean idempotent) {
1822             this.name = name;
1823             this.idempotent = idempotent;
1824         }
1825 
1826         @Override
1827         public void handleCommits(HostedRepository repository, Repository localRepository, List&lt;Commit&gt; commits,
1828                                   Branch branch) throws NonRetriableException {
1829             updateCount++;
1830             if (shouldFail) {
1831                 if (idempotent) {
1832                     throw new RuntimeException(&quot;induced failure&quot;);
1833                 } else {
1834                     throw new NonRetriableException(new RuntimeException(&quot;unretriable failure&quot;));
1835                 }
1836             }
1837         }
1838 
1839         @Override
1840         public void handleOpenJDKTagCommits(HostedRepository repository, Repository localRepository,
1841          List&lt;Commit&gt; commits, OpenJDKTag tag, Tag.Annotated annotated) {
1842             throw new RuntimeException(&quot;unexpected&quot;);
1843         }
1844 
1845         @Override
1846         public void handleTagCommit(HostedRepository repository, Repository localRepository, Commit commit, Tag tag,
1847          Tag.Annotated annotation) {
1848             throw new RuntimeException(&quot;unexpected&quot;);
1849         }
1850 
1851         @Override
1852         public void handleNewBranch(HostedRepository repository, Repository localRepository, List&lt;Commit&gt; commits,
1853          Branch parent, Branch branch) {
1854             throw new RuntimeException(&quot;unexpected&quot;);
1855         }
1856 
1857         @Override
1858         public String name() {
1859             return name;
1860         }
1861     }
1862 
1863     @Test
1864     void testIdempotenceMix(TestInfo testInfo) throws IOException {
1865         try (var credentials = new HostCredentials(testInfo);
1866              var tempFolder = new TemporaryDirectory()) {
1867             var repo = credentials.getHostedRepository();
1868             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1869             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1870             credentials.commitLock(localRepo);
1871             localRepo.pushAll(repo.url());
1872 
1873             var tagStorage = createTagStorage(repo);
1874             var branchStorage = createBranchStorage(repo);
1875             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1876             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1877 
1878             var idempotent = new TestRepositoryUpdateConsumer(&quot;i&quot;, true);
1879             var nonIdempotent = new TestRepositoryUpdateConsumer(&quot;ni&quot;, false);
1880             var notifyBot = NotifyBot.newBuilder()
1881                                      .repository(repo)
1882                                      .storagePath(storageFolder)
1883                                      .branches(Pattern.compile(&quot;master&quot;))
1884                                      .tagStorageBuilder(tagStorage)
1885                                      .branchStorageBuilder(branchStorage)
1886                                      .prIssuesStorageBuilder(prIssuesStorage)
1887                                      .updaters(List.of(idempotent, nonIdempotent))
1888                                      .build();
1889 
1890             // Initialize history
1891             TestBotRunner.runPeriodicItems(notifyBot);
1892 
1893             // Create an issue and commit a fix
1894             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix stuff&quot;);
1895             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1896             TestBotRunner.runPeriodicItems(notifyBot);
1897 
1898             // Both updaters should have run
1899             assertEquals(1, idempotent.updateCount);
1900             assertEquals(1, nonIdempotent.updateCount);
1901 
1902             var nextEditHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;Fix more stuff&quot;);
1903             localRepo.push(nextEditHash, repo.url(), &quot;master&quot;);
1904 
1905             idempotent.shouldFail = true;
1906             nonIdempotent.shouldFail = true;
1907             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(notifyBot));
1908 
1909             // Both updaters should have run again
1910             assertEquals(2, idempotent.updateCount);
1911             assertEquals(2, nonIdempotent.updateCount);
1912 
1913             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(notifyBot));
1914 
1915             // But now only the idempotent one should have been retried
1916             assertEquals(3, idempotent.updateCount);
1917             assertEquals(2, nonIdempotent.updateCount);
1918         }
1919     }
1920 }
<a name="13" id="anc13"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="13" type="hidden" />
</body>
</html>