<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/notify/src/test/java/org/openjdk/skara/bots/notify/MailingListUpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre><a name="1" id="anc1"></a>





















  1 package org.openjdk.skara.bots.notify;
  2 
  3 import org.junit.jupiter.api.*;
  4 import org.openjdk.skara.bots.notify.mailinglist.MailingListUpdater;
  5 import org.openjdk.skara.email.*;
  6 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  7 import org.openjdk.skara.test.*;
  8 
  9 import java.io.IOException;
 10 import java.time.Duration;
 11 import java.util.*;
 12 import java.util.regex.Pattern;
 13 
 14 import static org.junit.jupiter.api.Assertions.*;
 15 import static org.openjdk.skara.bots.notify.UpdaterTests.*;
 16 
 17 public class MailingListUpdaterTests {
 18     @Test
 19     void testMailingList(TestInfo testInfo) throws IOException {
 20         try (var listServer = new TestMailmanServer();
 21              var credentials = new HostCredentials(testInfo);
 22              var tempFolder = new TemporaryDirectory()) {
 23             var repo = credentials.getHostedRepository();
 24             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 25             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 26             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 27             credentials.commitLock(localRepo);
 28             localRepo.pushAll(repo.url());
 29 
 30             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 31             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 32             var mailmanList = mailmanServer.getList(listAddress.address());
 33             var tagStorage = createTagStorage(repo);
 34             var branchStorage = createBranchStorage(repo);
 35             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 36             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 37 
 38             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 39             var updater = MailingListUpdater.newBuilder()
 40                                             .list(mailmanList)
 41                                             .recipient(listAddress)
 42                                             .sender(sender)
 43                                             .reportNewTags(false)
 44                                             .reportNewBranches(false)
 45                                             .reportNewBuilds(false)
 46                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 47                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
 48                                             .build();
 49             var notifyBot = NotifyBot.newBuilder()
 50                                      .repository(repo)
 51                                      .storagePath(storageFolder)
 52                                      .branches(Pattern.compile(&quot;master&quot;))
 53                                      .tagStorageBuilder(tagStorage)
 54                                      .branchStorageBuilder(branchStorage)
 55                                      .prIssuesStorageBuilder(prIssuesStorage)
 56                                      .updaters(List.of(updater))
 57                                      .build();
 58 
 59             // No mail should be sent on the first run as there is no history
 60             TestBotRunner.runPeriodicItems(notifyBot);
 61             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 62 
 63             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 64             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 65             TestBotRunner.runPeriodicItems(notifyBot);
 66             listServer.processIncoming();
 67 
 68             var conversations = mailmanList.conversations(Duration.ofDays(1));
 69             var email = conversations.get(0).first();
 70             assertEquals(listAddress, email.sender());
 71             assertEquals(sender, email.author());
 72             assertEquals(email.recipients(), List.of(listAddress));
 73             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
 74             assertFalse(email.subject().contains(&quot;master&quot;));
 75             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 76             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 77             assertFalse(email.body().contains(&quot;Committer&quot;));
 78             assertFalse(email.body().contains(masterHash.abbreviate()));
 79             assertTrue(email.hasHeader(&quot;extra1&quot;));
 80             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 81             assertTrue(email.hasHeader(&quot;extra2&quot;));
 82             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 83             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
 84             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
 85             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
 86             assertEquals(editHash.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
 87         }
 88     }
 89 
 90     @Test
 91     void testMailingListMultiple(TestInfo testInfo) throws IOException {
 92         try (var listServer = new TestMailmanServer();
 93              var credentials = new HostCredentials(testInfo);
 94              var tempFolder = new TemporaryDirectory()) {
 95             var repo = credentials.getHostedRepository();
 96             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 97             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 98             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 99             credentials.commitLock(localRepo);
100             localRepo.pushAll(repo.url());
101 
102             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
103             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
104             var mailmanList = mailmanServer.getList(listAddress.address());
105             var tagStorage = createTagStorage(repo);
106             var branchStorage = createBranchStorage(repo);
107             var prIssuesStorage = createPullRequestIssuesStorage(repo);
108             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
109 
110             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
111             var updater = MailingListUpdater.newBuilder()
112                                             .list(mailmanList)
113                                             .recipient(listAddress)
114                                             .sender(sender)
115                                             .reportNewTags(false)
116                                             .reportNewBranches(false)
117                                             .reportNewBuilds(false)
118                                             .build();
119             var notifyBot = NotifyBot.newBuilder()
120                                      .repository(repo)
121                                      .storagePath(storageFolder)
122                                      .branches(Pattern.compile(&quot;master&quot;))
123                                      .tagStorageBuilder(tagStorage)
124                                      .branchStorageBuilder(branchStorage)
125                                      .prIssuesStorageBuilder(prIssuesStorage)
126                                      .updaters(List.of(updater))
127                                      .build();
128 
129             // No mail should be sent on the first run as there is no history
130             TestBotRunner.runPeriodicItems(notifyBot);
131             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
132 
133             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
134                     &quot;first_author&quot;, &quot;first@author.example.com&quot;);
135             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
136             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
137                     &quot;another_author&quot;, &quot;another@author.example.com&quot;);
138             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
139 
140             TestBotRunner.runPeriodicItems(notifyBot);
141             listServer.processIncoming();
142 
143             var conversations = mailmanList.conversations(Duration.ofDays(1));
144             var email = conversations.get(0).first();
145             assertEquals(listAddress, email.sender());
146             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());
147             assertEquals(email.recipients(), List.of(listAddress));
148             assertTrue(email.subject().contains(&quot;: 2 new changesets&quot;));
149             assertFalse(email.subject().contains(&quot;master&quot;));
150             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
151             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
152             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
153             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
154             assertFalse(email.body().contains(masterHash.abbreviate()));
155             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
156             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
157             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
158             assertEquals(editHash1.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
159         }
160     }
161 
162     @Test
163     void testMailingListSponsored(TestInfo testInfo) throws IOException {
164         try (var listServer = new TestMailmanServer();
165              var credentials = new HostCredentials(testInfo);
166              var tempFolder = new TemporaryDirectory()) {
167             var repo = credentials.getHostedRepository();
168             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
169             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
170             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
171             credentials.commitLock(localRepo);
172             localRepo.pushAll(repo.url());
173 
174             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
175             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
176             var mailmanList = mailmanServer.getList(listAddress.address());
177             var tagStorage = createTagStorage(repo);
178             var branchStorage = createBranchStorage(repo);
179             var prIssuesStorage = createPullRequestIssuesStorage(repo);
180             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
181 
182             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
183             var updater = MailingListUpdater.newBuilder()
184                                             .list(mailmanList)
185                                             .recipient(listAddress)
186                                             .sender(sender)
187                                             .reportNewTags(false)
188                                             .reportNewBranches(false)
189                                             .reportNewBuilds(false)
190                                             .build();
191             var notifyBot = NotifyBot.newBuilder()
192                                      .repository(repo)
193                                      .storagePath(storageFolder)
194                                      .branches(Pattern.compile(&quot;master&quot;))
195                                      .tagStorageBuilder(tagStorage)
196                                      .branchStorageBuilder(branchStorage)
197                                      .prIssuesStorageBuilder(prIssuesStorage)
198                                      .updaters(List.of(updater))
199                                      .build();
200 
201             // No mail should be sent on the first run as there is no history
202             TestBotRunner.runPeriodicItems(notifyBot);
203             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
204 
205             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
206                     &quot;author&quot;, &quot;author@test.test&quot;,
207                     &quot;committer&quot;, &quot;committer@test.test&quot;);
208             localRepo.push(editHash, repo.url(), &quot;master&quot;);
209             TestBotRunner.runPeriodicItems(notifyBot);
210             listServer.processIncoming();
211 
212             var conversations = mailmanList.conversations(Duration.ofDays(1));
213             var email = conversations.get(0).first();
214             assertEquals(listAddress, email.sender());
215             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
216             assertEquals(email.recipients(), List.of(listAddress));
217             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
218             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
219             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
220             assertTrue(email.body().contains(&quot;Committer: committer &lt;committer@test.test&gt;&quot;));
221             assertFalse(email.body().contains(masterHash.abbreviate()));
222         }
223     }
224 
225     @Test
226     void testMailingListMultipleBranches(TestInfo testInfo) throws IOException {
227         try (var listServer = new TestMailmanServer();
228              var credentials = new HostCredentials(testInfo);
229              var tempFolder = new TemporaryDirectory()) {
230             var repo = credentials.getHostedRepository();
231             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
232             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
233             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
234             credentials.commitLock(localRepo);
235             var branch = localRepo.branch(masterHash, &quot;another&quot;);
236             localRepo.pushAll(repo.url());
237 
238             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
239             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
240             var mailmanList = mailmanServer.getList(listAddress.address());
241             var tagStorage = createTagStorage(repo);
242             var branchStorage = createBranchStorage(repo);
243             var prIssuesStorage = createPullRequestIssuesStorage(repo);
244             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
245 
246             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
247             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
248             var updater = MailingListUpdater.newBuilder()
249                                             .list(mailmanList)
250                                             .recipient(listAddress)
251                                             .sender(sender)
252                                             .author(author)
253                                             .includeBranch(true)
254                                             .reportNewTags(false)
255                                             .reportNewBranches(false)
256                                             .reportNewBuilds(false)
257                                             .build();
258             var notifyBot = NotifyBot.newBuilder()
259                                      .repository(repo)
260                                      .storagePath(storageFolder)
261                                      .branches(Pattern.compile(&quot;master|another&quot;))
262                                      .tagStorageBuilder(tagStorage)
263                                      .branchStorageBuilder(branchStorage)
264                                      .prIssuesStorageBuilder(prIssuesStorage)
265                                      .updaters(List.of(updater))
266                                      .build();
267 
268             // No mail should be sent on the first run as there is no history
269             TestBotRunner.runPeriodicItems(notifyBot);
270             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
271 
272             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
273             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
274             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
275             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
276 
277             TestBotRunner.runPeriodicItems(notifyBot);
278             listServer.processIncoming();
279 
280             var conversations = mailmanList.conversations(Duration.ofDays(1));
281             var email = conversations.get(0).first();
282             assertEquals(listAddress, email.sender());
283             assertEquals(author, email.author());
284             assertEquals(email.recipients(), List.of(listAddress));
285             assertFalse(email.subject().contains(&quot;another&quot;));
286             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
287             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
288             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
289             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
290             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
291             assertFalse(email.body().contains(masterHash.abbreviate()));
292             assertFalse(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
293             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
294             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
295             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
296             assertEquals(editHash1.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
297 
298             localRepo.checkout(branch, true);
299             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);
300             localRepo.push(editHash3, repo.url(), &quot;another&quot;);
301 
302             TestBotRunner.runPeriodicItems(notifyBot);
303             listServer.processIncoming();
304 
305             conversations = mailmanList.conversations(Duration.ofDays(1));
306             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
307             email = conversations.get(0).first();
308             assertEquals(author, email.author());
309             assertEquals(listAddress, email.sender());
310             assertEquals(email.recipients(), List.of(listAddress));
311             assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));
312             assertFalse(email.subject().contains(&quot;master&quot;));
313             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));
314             assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
315             assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
316             assertFalse(email.body().contains(&quot;3456789A: Even more fixes&quot;));
317             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
318             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
319             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
320             assertEquals(editHash3.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
321         }
322     }
323 
324     @Test
325     void testMailingListPROnlyMultipleBranches(TestInfo testInfo) throws IOException {
326         try (var listServer = new TestMailmanServer();
327              var credentials = new HostCredentials(testInfo);
328              var tempFolder = new TemporaryDirectory()) {
329             var repo = credentials.getHostedRepository();
330             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
331             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
332             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
333             credentials.commitLock(localRepo);
334             localRepo.pushAll(repo.url());
335 
336             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
337             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
338             var mailmanList = mailmanServer.getList(listAddress.address());
339             var tagStorage = createTagStorage(repo);
340             var branchStorage = createBranchStorage(repo);
341             var prIssuesStorage = createPullRequestIssuesStorage(repo);
342             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
343 
344             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
345             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
346             var updater = MailingListUpdater.newBuilder()
347                                             .list(mailmanList)
348                                             .recipient(listAddress)
349                                             .sender(sender)
350                                             .author(author)
351                                             .reportNewTags(false)
352                                             .reportNewBranches(false)
353                                             .reportNewBuilds(false)
354                                             .includeBranch(true)
355                                             .mode(MailingListUpdater.Mode.PR)
356                                             .build();
357             var notifyBot = NotifyBot.newBuilder()
358                                      .repository(repo)
359                                      .storagePath(storageFolder)
360                                      .branches(Pattern.compile(&quot;master|other&quot;))
361                                      .tagStorageBuilder(tagStorage)
362                                      .branchStorageBuilder(branchStorage)
363                                      .prIssuesStorageBuilder(prIssuesStorage)
364                                      .updaters(List.of(updater))
365                                      .build();
366 
367             // Populate our known branches
368             localRepo.push(masterHash, repo.url(), &quot;master&quot;, true);
369             localRepo.push(masterHash, repo.url(), &quot;other&quot;, true);
370 
371             // No mail should be sent on the first run as there is no history
372             TestBotRunner.runPeriodicItems(notifyBot);
373             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
374 
375             localRepo.checkout(masterHash, true);
376             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
377             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
378             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
379 
380             // PR hasn&#39;t been integrated yet, so there should be no mail
381             TestBotRunner.runPeriodicItems(notifyBot);
382             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
383 
384             // Simulate an RFR email
385             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
386                            .recipient(listAddress)
387                            .build();
388             mailmanList.post(rfr);
389             listServer.processIncoming();
390 
391             // And an integration (but it hasn&#39;t reached master just yet)
392             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
393 
394             // Now push the same commit to another branch
395             localRepo.push(editHash, repo.url(), &quot;other&quot;);
396             TestBotRunner.runPeriodicItems(notifyBot);
397             listServer.processIncoming();
398 
399             // This one should generate a plain integration mail
400             var conversations = mailmanList.conversations(Duration.ofDays(1));
401             assertEquals(2, conversations.size());
402             var secondEmail = conversations.get(0).first();
403             if (secondEmail.subject().contains(&quot;RFR&quot;)) {
404                 secondEmail = conversations.get(1).first();
405             }
406             assertEquals(&quot;git: test: other: 23456789: More fixes&quot;, secondEmail.subject());
407         }
408     }
409 
410     @Test
411     void testMailingListPR(TestInfo testInfo) throws IOException {
412         try (var listServer = new TestMailmanServer();
413              var credentials = new HostCredentials(testInfo);
414              var tempFolder = new TemporaryDirectory()) {
415             var repo = credentials.getHostedRepository();
416             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
417             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
418             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
419             credentials.commitLock(localRepo);
420             localRepo.pushAll(repo.url());
421 
422             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
423             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
424             var mailmanList = mailmanServer.getList(listAddress.address());
425             var tagStorage = createTagStorage(repo);
426             var branchStorage = createBranchStorage(repo);
427             var prIssuesStorage = createPullRequestIssuesStorage(repo);
428             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
429 
430             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
431             var updater = MailingListUpdater.newBuilder()
432                                             .list(mailmanList)
433                                             .recipient(listAddress)
434                                             .sender(sender)
435                                             .reportNewTags(false)
436                                             .reportNewBranches(false)
437                                             .reportNewBuilds(false)
438                                             .mode(MailingListUpdater.Mode.PR)
439                                             .build();
440             var notifyBot = NotifyBot.newBuilder()
441                                      .repository(repo)
442                                      .storagePath(storageFolder)
443                                      .branches(Pattern.compile(&quot;master&quot;))
444                                      .tagStorageBuilder(tagStorage)
445                                      .branchStorageBuilder(branchStorage)
446                                      .prIssuesStorageBuilder(prIssuesStorage)
447                                      .updaters(List.of(updater))
448                                      .build();
449 
450             // No mail should be sent on the first run as there is no history
451             TestBotRunner.runPeriodicItems(notifyBot);
452             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
453 
454             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
455             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
456             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
457 
458             // Create a potentially conflicting one
459             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
460             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
461             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
462 
463             // PR hasn&#39;t been integrated yet, so there should be no mail
464             TestBotRunner.runPeriodicItems(notifyBot);
465             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
466 
467             // Simulate an RFR email
468             var rfr = Email.create(&quot;[repo/branch] RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
469                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
470                            .recipient(listAddress)
471                            .build();
472             mailmanList.post(rfr);
473             listServer.processIncoming();
474 
475             // And an integration
476             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
477             localRepo.push(editHash, repo.url(), &quot;master&quot;);
478 
479             // Push the other one without a matching PR
480             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
481 
482             TestBotRunner.runPeriodicItems(notifyBot);
483             listServer.processIncoming();
484 
485             var conversations = mailmanList.conversations(Duration.ofDays(1));
486             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
487             assertEquals(2, conversations.size());
488 
489             var prConversation = conversations.get(0);
490             var pushConversation = conversations.get(1);
491             assertEquals(1, prConversation.allMessages().size());
492 
493             var pushEmail = pushConversation.first();
494             assertEquals(listAddress, pushEmail.sender());
495             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
496             assertEquals(pushEmail.recipients(), List.of(listAddress));
497             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
498         }
499     }
500 
501     @Test
502     void testMailingListPROnce(TestInfo testInfo) throws IOException {
503         try (var listServer = new TestMailmanServer();
504              var credentials = new HostCredentials(testInfo);
505              var tempFolder = new TemporaryDirectory()) {
506             var repo = credentials.getHostedRepository();
507             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
508             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
509             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
510             localRepo.branch(masterHash, &quot;other&quot;);
511             credentials.commitLock(localRepo);
512             localRepo.pushAll(repo.url());
513 
514             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
515             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
516             var mailmanList = mailmanServer.getList(listAddress.address());
517             var tagStorage = createTagStorage(repo);
518             var branchStorage = createBranchStorage(repo);
519             var prIssuesStorage = createPullRequestIssuesStorage(repo);
520             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
521 
522             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
523             var updater = MailingListUpdater.newBuilder()
524                                             .list(mailmanList)
525                                             .recipient(listAddress)
526                                             .sender(sender)
527                                             .author(null)
528                                             .reportNewTags(false)
529                                             .reportNewBranches(false)
530                                             .reportNewBuilds(false)
531                                             .mode(MailingListUpdater.Mode.PR)
532                                             .build();
533             var notifyBot = NotifyBot.newBuilder()
534                                      .repository(repo)
535                                      .storagePath(storageFolder)
536                                      .branches(Pattern.compile(&quot;master|other&quot;))
537                                      .tagStorageBuilder(tagStorage)
538                                      .branchStorageBuilder(branchStorage)
539                                      .prIssuesStorageBuilder(prIssuesStorage)
540                                      .updaters(List.of(updater))
541                                      .build();
542 
543             // No mail should be sent on the first run as there is no history
544             TestBotRunner.runPeriodicItems(notifyBot);
545             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
546 
547             localRepo.checkout(masterHash, true);
548             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
549             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
550             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
551 
552             // PR hasn&#39;t been integrated yet, so there should be no mail
553             TestBotRunner.runPeriodicItems(notifyBot);
554             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
555 
556             // Simulate an RFR email
557             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
558                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
559                            .recipient(listAddress)
560                            .build();
561             mailmanList.post(rfr);
562             listServer.processIncoming();
563 
564             // And an integration
565             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
566             localRepo.push(editHash, repo.url(), &quot;master&quot;, true);
567 
568             TestBotRunner.runPeriodicItems(notifyBot);
569             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
570 
571             var conversations = mailmanList.conversations(Duration.ofDays(1));
572             assertEquals(1, conversations.size());
573 
574             var prConversation = conversations.get(0);
575             assertEquals(1, prConversation.allMessages().size());
576 
577             // Now push the change to another monitored branch
578             localRepo.push(editHash, repo.url(), &quot;other&quot;, true);
579             TestBotRunner.runPeriodicItems(notifyBot);
580             listServer.processIncoming();
581 
582             // The change should now end up as a separate notification thread
583             conversations = mailmanList.conversations(Duration.ofDays(1));
584             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
585             assertEquals(2, conversations.size());
586 
587             var pushConversation = conversations.get(1);
588             var pushEmail = pushConversation.first();
589             assertEquals(listAddress, pushEmail.sender());
590             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
591             assertEquals(pushEmail.recipients(), List.of(listAddress));
592             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
593         }
594     }
595 
596     @Test
597     void testMailinglistTag(TestInfo testInfo) throws IOException {
598         try (var credentials = new HostCredentials(testInfo);
599              var tempFolder = new TemporaryDirectory();
600              var listServer = new TestMailmanServer()) {
601             var repo = credentials.getHostedRepository();
602             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
603             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
604             credentials.commitLock(localRepo);
605             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
606             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
607             localRepo.pushAll(repo.url());
608 
609             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
610             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
611             var mailmanList = mailmanServer.getList(listAddress.address());
612             var tagStorage = createTagStorage(repo);
613             var branchStorage = createBranchStorage(repo);
614             var prIssuesStorage = createPullRequestIssuesStorage(repo);
615             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
616 
617             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
618             var updater = MailingListUpdater.newBuilder()
619                                             .list(mailmanList)
620                                             .recipient(listAddress)
621                                             .sender(sender)
622                                             .reportNewBranches(false)
623                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
624                                             .build();
625             var noTagsUpdater = MailingListUpdater.newBuilder()
626                                                   .list(mailmanList)
627                                                   .recipient(listAddress)
628                                                   .sender(sender)
629                                                   .reportNewTags(false)
630                                                   .reportNewBranches(false)
631                                                   .reportNewBuilds(false)
632                                                   .build();
633             var notifyBot = NotifyBot.newBuilder()
634                                      .repository(repo)
635                                      .storagePath(storageFolder)
636                                      .branches(Pattern.compile(&quot;master&quot;))
637                                      .tagStorageBuilder(tagStorage)
638                                      .branchStorageBuilder(branchStorage)
639                                      .prIssuesStorageBuilder(prIssuesStorage)
640                                      .updaters(List.of(updater, noTagsUpdater))
641                                      .build();
642 
643             // No mail should be sent on the first run as there is no history
644             TestBotRunner.runPeriodicItems(notifyBot);
645             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
646 
647             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
648             localRepo.fetch(repo.url(), &quot;history:history&quot;);
649             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
650             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
651             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
652             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
653             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
654             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
655             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
656             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
657             localRepo.pushAll(repo.url());
658 
659             TestBotRunner.runPeriodicItems(notifyBot);
660             listServer.processIncoming();
661             listServer.processIncoming();
662             listServer.processIncoming();
663             listServer.processIncoming();
664 
665             var conversations = mailmanList.conversations(Duration.ofDays(1));
666             assertEquals(4, conversations.size());
667 
668             for (var conversation : conversations) {
669                 var email = conversation.first();
670                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
671                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
672                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
673                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
674                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
675                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
676                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
677                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
678                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
679                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
680                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
681                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
682                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
683                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
684                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
685                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
686                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
687                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
688                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
689                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
690                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
691                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
692                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
693                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
694                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
695                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
696                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
697                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
698                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
699                     assertTrue(email.body().contains(&quot;67890123: Brand new fixes&quot;));
700                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
701                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
702                 } else {
703                     fail(&quot;Mismatched subject: &quot; + email.subject());
704                 }
705                 assertTrue(email.hasHeader(&quot;extra1&quot;));
706                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
707                 assertTrue(email.hasHeader(&quot;extra2&quot;));
708                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
709             }
710         }
711     }
712 
713     @Test
714     void testMailinglistPlainTags(TestInfo testInfo) throws IOException {
715         try (var credentials = new HostCredentials(testInfo);
716              var tempFolder = new TemporaryDirectory();
717              var listServer = new TestMailmanServer()) {
718             var repo = credentials.getHostedRepository();
719             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
720             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
721             credentials.commitLock(localRepo);
722             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
723             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
724             localRepo.pushAll(repo.url());
725 
726             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
727             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
728             var mailmanList = mailmanServer.getList(listAddress.address());
729             var tagStorage = createTagStorage(repo);
730             var branchStorage = createBranchStorage(repo);
731             var prIssuesStorage = createPullRequestIssuesStorage(repo);
732             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
733 
734             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
735             var updater = MailingListUpdater.newBuilder()
736                                             .list(mailmanList)
737                                             .recipient(listAddress)
738                                             .sender(sender)
739                                             .reportNewBranches(false)
740                                             .reportNewBuilds(false)
741                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
742                                             .build();
743             var noTagsUpdater = MailingListUpdater.newBuilder()
744                                                   .list(mailmanList)
745                                                   .recipient(listAddress)
746                                                   .sender(sender)
747                                                   .reportNewTags(false)
748                                                   .reportNewBranches(false)
749                                                   .reportNewBuilds(false)
750                                                   .build();
751             var notifyBot = NotifyBot.newBuilder()
752                                      .repository(repo)
753                                      .storagePath(storageFolder)
754                                      .branches(Pattern.compile(&quot;master&quot;))
755                                      .tagStorageBuilder(tagStorage)
756                                      .branchStorageBuilder(branchStorage)
757                                      .prIssuesStorageBuilder(prIssuesStorage)
758                                      .updaters(List.of(updater, noTagsUpdater))
759                                      .build();
760 
761             // No mail should be sent on the first run as there is no history
762             TestBotRunner.runPeriodicItems(notifyBot);
763             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
764 
765             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
766             localRepo.fetch(repo.url(), &quot;history:history&quot;);
767             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
768             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
769             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
770             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
771             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
772             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
773             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
774             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
775             localRepo.pushAll(repo.url());
776 
777             TestBotRunner.runPeriodicItems(notifyBot);
778             listServer.processIncoming();
779             listServer.processIncoming();
780             listServer.processIncoming();
781             listServer.processIncoming();
782 
783             var conversations = mailmanList.conversations(Duration.ofDays(1));
784             assertEquals(4, conversations.size());
785 
786             for (var conversation : conversations) {
787                 var email = conversation.first();
788                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
789                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
790                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
791                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
792                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
793                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
794                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
795                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
796                 } else {
797                     fail(&quot;Mismatched subject: &quot; + email.subject());
798                 }
799                 assertTrue(email.hasHeader(&quot;extra1&quot;));
800                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
801                 assertTrue(email.hasHeader(&quot;extra2&quot;));
802                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
803             }
804         }
805     }
806 
807     @Test
808     void testMailingListBranch(TestInfo testInfo) throws IOException {
809         try (var listServer = new TestMailmanServer();
810              var credentials = new HostCredentials(testInfo);
811              var tempFolder = new TemporaryDirectory()) {
812             var repo = credentials.getHostedRepository();
813             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
814             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
815             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
816             credentials.commitLock(localRepo);
817             localRepo.pushAll(repo.url());
818 
819             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
820             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
821             var mailmanList = mailmanServer.getList(listAddress.address());
822             var tagStorage = createTagStorage(repo);
823             var branchStorage = createBranchStorage(repo);
824             var prIssuesStorage = createPullRequestIssuesStorage(repo);
825             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
826 
827             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
828             var updater = MailingListUpdater.newBuilder()
829                                             .list(mailmanList)
830                                             .recipient(listAddress)
831                                             .sender(sender)
832                                             .reportNewTags(false)
833                                             .reportNewBuilds(false)
834                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
835                                             .build();
836             var notifyBot = NotifyBot.newBuilder()
837                                      .repository(repo)
838                                      .storagePath(storageFolder)
839                                      .branches(Pattern.compile(&quot;master|newbranch.&quot;))
840                                      .tagStorageBuilder(tagStorage)
841                                      .branchStorageBuilder(branchStorage)
842                                      .prIssuesStorageBuilder(prIssuesStorage)
843                                      .updaters(List.of(updater))
844                                      .build();
845 
846             // No mail should be sent on the first run as there is no history
847             TestBotRunner.runPeriodicItems(notifyBot);
848             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
849 
850             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
851             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
852             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
853             TestBotRunner.runPeriodicItems(notifyBot);
854             listServer.processIncoming();
855 
856             var conversations = mailmanList.conversations(Duration.ofDays(1));
857             var email = conversations.get(0).first();
858             assertEquals(listAddress, email.sender());
859             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
860             assertEquals(email.recipients(), List.of(listAddress));
861             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());
862             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));
863             assertTrue(email.hasHeader(&quot;extra1&quot;));
864             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
865             assertTrue(email.hasHeader(&quot;extra2&quot;));
866             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
867 
868             TestBotRunner.runPeriodicItems(notifyBot);
869             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
870 
871             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);
872             TestBotRunner.runPeriodicItems(notifyBot);
873             listServer.processIncoming();
874 
875             var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()
876                                              .filter(c -&gt; !c.equals(conversations.get(0)))
877                                              .findFirst().orElseThrow();
878             email = newConversation.first();
879             assertEquals(listAddress, email.sender());
880             assertEquals(sender, email.author());
881             assertEquals(email.recipients(), List.of(listAddress));
882             assertEquals(&quot;git: test: created branch newbranch2 based on the branch newbranch1 containing 0 unique commits&quot;, email.subject());
883             assertEquals(&quot;The new branch newbranch2 is currently identical to the newbranch1 branch.&quot;, email.body());
884         }
885     }
886 
887     @Test
888     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
889         try (var listServer = new TestMailmanServer();
890              var credentials = new HostCredentials(testInfo);
891              var tempFolder = new TemporaryDirectory()) {
892             var repo = credentials.getHostedRepository();
893             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
894             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
895             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
896             credentials.commitLock(localRepo);
897             localRepo.pushAll(repo.url());
898 
899             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
900             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
901             var mailmanList = mailmanServer.getList(listAddress.address());
902             var tagStorage = createTagStorage(repo);
903             var branchStorage = createBranchStorage(repo);
904             var prIssuesStorage = createPullRequestIssuesStorage(repo);
905             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
906 
907             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
908             var updater = MailingListUpdater.newBuilder()
909                                             .list(mailmanList)
910                                             .recipient(listAddress)
911                                             .sender(sender)
912                                             .reportNewTags(false)
913                                             .reportNewBranches(false)
914                                             .reportNewBuilds(false)
915                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
916                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
917                                             .build();
918             var notifyBot = NotifyBot.newBuilder()
919                                      .repository(repo)
920                                      .storagePath(storageFolder)
921                                      .branches(Pattern.compile(&quot;master&quot;))
922                                      .tagStorageBuilder(tagStorage)
923                                      .branchStorageBuilder(branchStorage)
924                                      .prIssuesStorageBuilder(prIssuesStorage)
925                                      .updaters(List.of(updater))
926                                      .build();
927 
928             // No mail should be sent on the first run as there is no history
929             TestBotRunner.runPeriodicItems(notifyBot);
930             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
931 
932             // Save history state
933             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);
934 
935             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
936             localRepo.push(editHash, repo.url(), &quot;master&quot;);
937             TestBotRunner.runPeriodicItems(notifyBot);
938             listServer.processIncoming();
939 
940             var conversations = mailmanList.conversations(Duration.ofDays(1));
941             assertEquals(1, conversations.size());
942 
943             // Reset the history
944             localRepo.push(historyHash, repo.url(), &quot;history&quot;, true);
945             TestBotRunner.runPeriodicItems(notifyBot);
946             listServer.processIncoming();
947 
948             // There should now be a duplicate mail
949             conversations = mailmanList.conversations(Duration.ofDays(1));
950             assertEquals(2, conversations.size());
951         }
952     }
953 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>