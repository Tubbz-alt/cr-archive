<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/MailingListUpdater.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 627                                      .build();
 628 
 629             // No mail should be sent on the first run as there is no history
 630             TestBotRunner.runPeriodicItems(notifyBot);
 631             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 632 
 633             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 634             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 635             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 636 
 637             // Create a potentially conflicting one
 638             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 639             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 640             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 641 
 642             // PR hasn&#39;t been integrated yet, so there should be no mail
 643             TestBotRunner.runPeriodicItems(notifyBot);
 644             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 645 
 646             // Simulate an RFR email
<span class="line-modified"> 647             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())</span>
 648                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 649                            .recipient(listAddress)
 650                            .build();
 651             mailmanList.post(rfr);
 652             listServer.processIncoming();
 653 
 654             // And an integration
 655             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 656             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 657 
 658             // Push the other one without a matching PR
 659             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 660 
 661             TestBotRunner.runPeriodicItems(notifyBot);
 662             listServer.processIncoming();
 663             listServer.processIncoming();
 664 
 665             var conversations = mailmanList.conversations(Duration.ofDays(1));
 666             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 667             assertEquals(2, conversations.size());
 668 
 669             var prConversation = conversations.get(0);
 670             var pushConversation = conversations.get(1);
 671 
 672             var prEmail = prConversation.replies(prConversation.first()).get(0);
 673             assertEquals(listAddress, prEmail.sender());
 674             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
 675             assertEquals(prEmail.recipients(), List.of(listAddress));
<span class="line-modified"> 676             assertEquals(&quot;[Integrated] RFR: My PR&quot;, prEmail.subject());</span>
 677             assertFalse(prEmail.subject().contains(&quot;master&quot;));
 678             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 679             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
 680             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
 681             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
 682 
 683             var pushEmail = pushConversation.first();
 684             assertEquals(listAddress, pushEmail.sender());
 685             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 686             assertEquals(pushEmail.recipients(), List.of(listAddress));
 687             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 688         }
 689     }
 690 
 691     @Test
 692     void testMailingListPROnce(TestInfo testInfo) throws IOException {
 693         try (var listServer = new TestMailmanServer();
 694              var credentials = new HostCredentials(testInfo);
 695              var tempFolder = new TemporaryDirectory()) {
 696             var repo = credentials.getHostedRepository();
</pre>
</td>
<td>
<hr />
<pre>
 627                                      .build();
 628 
 629             // No mail should be sent on the first run as there is no history
 630             TestBotRunner.runPeriodicItems(notifyBot);
 631             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 632 
 633             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 634             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 635             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 636 
 637             // Create a potentially conflicting one
 638             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 639             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 640             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 641 
 642             // PR hasn&#39;t been integrated yet, so there should be no mail
 643             TestBotRunner.runPeriodicItems(notifyBot);
 644             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 645 
 646             // Simulate an RFR email
<span class="line-modified"> 647             var rfr = Email.create(&quot;[repo/branch] RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())</span>
 648                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 649                            .recipient(listAddress)
 650                            .build();
 651             mailmanList.post(rfr);
 652             listServer.processIncoming();
 653 
 654             // And an integration
 655             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 656             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 657 
 658             // Push the other one without a matching PR
 659             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 660 
 661             TestBotRunner.runPeriodicItems(notifyBot);
 662             listServer.processIncoming();
 663             listServer.processIncoming();
 664 
 665             var conversations = mailmanList.conversations(Duration.ofDays(1));
 666             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 667             assertEquals(2, conversations.size());
 668 
 669             var prConversation = conversations.get(0);
 670             var pushConversation = conversations.get(1);
 671 
 672             var prEmail = prConversation.replies(prConversation.first()).get(0);
 673             assertEquals(listAddress, prEmail.sender());
 674             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
 675             assertEquals(prEmail.recipients(), List.of(listAddress));
<span class="line-modified"> 676             assertEquals(&quot;[Integrated] [repo/branch] RFR: My PR&quot;, prEmail.subject());</span>
 677             assertFalse(prEmail.subject().contains(&quot;master&quot;));
 678             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 679             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
 680             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
 681             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
 682 
 683             var pushEmail = pushConversation.first();
 684             assertEquals(listAddress, pushEmail.sender());
 685             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 686             assertEquals(pushEmail.recipients(), List.of(listAddress));
 687             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 688         }
 689     }
 690 
 691     @Test
 692     void testMailingListPROnce(TestInfo testInfo) throws IOException {
 693         try (var listServer = new TestMailmanServer();
 694              var credentials = new HostCredentials(testInfo);
 695              var tempFolder = new TemporaryDirectory()) {
 696             var repo = credentials.getHostedRepository();
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/MailingListUpdater.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>