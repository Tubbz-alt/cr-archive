<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/CheckRun.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/pr/MergeTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/CheckRun.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 40 
 41 class CheckRun {
 42     private final CheckWorkItem workItem;
 43     private final PullRequest pr;
 44     private final Repository localRepo;
 45     private final List&lt;Comment&gt; comments;
 46     private final List&lt;Review&gt; allReviews;
 47     private final List&lt;Review&gt; activeReviews;
 48     private final Set&lt;String&gt; labels;
 49     private final CensusInstance censusInstance;
 50     private final boolean ignoreStaleReviews;
 51 
 52     private final Hash baseHash;
 53     private final CheckablePullRequest checkablePullRequest;
 54 
 55     private static final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.pr&quot;);
 56     private static final String progressMarker = &quot;&lt;!-- Anything below this marker will be automatically updated, please do not edit manually! --&gt;&quot;;
 57     private static final String mergeReadyMarker = &quot;&lt;!-- PullRequestBot merge is ready comment --&gt;&quot;;
 58     private static final String outdatedHelpMarker = &quot;&lt;!-- PullRequestBot outdated help comment --&gt;&quot;;
 59     private static final String sourceBranchWarningMarker = &quot;&lt;!-- PullRequestBot source branch warning comment --&gt;&quot;;

 60     private static final String emptyPrBodyMarker = &quot;&lt;!--\nReplace this text with a description of your pull request (also remove the surrounding HTML comment markers).\n&quot; +
 61             &quot;If in doubt, feel free to delete everything in this edit box first, the bot will restore the progress section as needed.\n--&gt;&quot;;
 62     private final Set&lt;String&gt; newLabels;
 63     static final Pattern ISSUE_ID_PATTERN = Pattern.compile(&quot;^(?:[A-Za-z][A-Za-z0-9]+-)?([0-9]+)$&quot;);
 64 
 65     private CheckRun(CheckWorkItem workItem, PullRequest pr, Repository localRepo, List&lt;Comment&gt; comments,
 66                      List&lt;Review&gt; allReviews, List&lt;Review&gt; activeReviews, Set&lt;String&gt; labels,
 67                      CensusInstance censusInstance, boolean ignoreStaleReviews) throws IOException {
 68         this.workItem = workItem;
 69         this.pr = pr;
 70         this.localRepo = localRepo;
 71         this.comments = comments;
 72         this.allReviews = allReviews;
 73         this.activeReviews = activeReviews;
 74         this.labels = new HashSet&lt;&gt;(labels);
 75         this.newLabels = new HashSet&lt;&gt;(labels);
 76         this.censusInstance = censusInstance;
 77         this.ignoreStaleReviews = ignoreStaleReviews;
 78 
 79         baseHash = PullRequestUtils.baseHash(pr, localRepo);
</pre>
<hr />
<pre>
677         var existing = findComment(comments, outdatedHelpMarker);
678         if (existing.isPresent()) {
679             // Only add the comment once per PR
680             return;
681         }
682         var message = &quot;@&quot; + pr.author().userName() + &quot; this pull request can not be integrated into &quot; +
683                 &quot;`&quot; + pr.targetRef() + &quot;` due to one or more merge conflicts. To resolve these merge conflicts &quot; +
684                 &quot;and update this pull request you can run the following commands in the local repository for your personal fork:\n&quot; +
685                 &quot;```bash\n&quot; +
686                 &quot;git checkout &quot; + pr.sourceRef() + &quot;\n&quot; +
687                 &quot;git fetch &quot; + pr.repository().webUrl() + &quot; &quot; + pr.targetRef() + &quot;\n&quot; +
688                 &quot;git merge FETCH_HEAD\n&quot; +
689                 &quot;# resolve conflicts and follow the instructions given by git merge\n&quot; +
690                 &quot;git commit -m \&quot;Merge &quot; + pr.targetRef() + &quot;\&quot;\n&quot; +
691                 &quot;git push\n&quot; +
692                 &quot;```\n&quot; +
693                 outdatedHelpMarker;
694         pr.addComment(message);
695     }
696 
















697     private void checkStatus() {
698         var checkBuilder = CheckBuilder.create(&quot;jcheck&quot;, pr.headHash());
699         var censusDomain = censusInstance.configuration().census().domain();
700         Exception checkException = null;
701 
702         try {
703             // Post check in-progress
704             log.info(&quot;Starting to run jcheck on PR head&quot;);
705             pr.createCheck(checkBuilder.build());
706 
707             var ignored = new PrintWriter(new StringWriter());
708             var rebasePossible = true;
709             var commitHash = pr.headHash();
710             var mergedHash = checkablePullRequest.mergeTarget(ignored);
711             if (mergedHash.isPresent()) {
712                 commitHash = mergedHash.get();
713             } else {
714                 rebasePossible = false;
715             }
716 
</pre>
<hr />
<pre>
752             updateMergeReadyComment(readyForIntegration, commitMessage, comments, activeReviews, rebasePossible);
753             if (readyForIntegration &amp;&amp; rebasePossible) {
754                 newLabels.add(&quot;ready&quot;);
755             } else {
756                 newLabels.remove(&quot;ready&quot;);
757             }
758             if (!rebasePossible) {
759                 if (!labels.contains(&quot;failed-auto-merge&quot;)) {
760                     addOutdatedComment(comments);
761                 }
762                 newLabels.add(&quot;merge-conflict&quot;);
763             } else {
764                 newLabels.remove(&quot;merge-conflict&quot;);
765             }
766 
767             var branchNames = pr.repository().branches().stream().map(HostedBranch::name).collect(Collectors.toSet());
768             if (!pr.repository().url().equals(pr.sourceRepository().url()) &amp;&amp; branchNames.contains(pr.sourceRef())) {
769                 addSourceBranchWarningComment(comments);
770             }
771 




772             // Ensure that the ready for sponsor label is up to date
773             newLabels.remove(&quot;sponsor&quot;);
774             var readyHash = ReadyForSponsorTracker.latestReadyForSponsor(pr.repository().forge().currentUser(), comments);
775             if (readyHash.isPresent() &amp;&amp; readyForIntegration) {
776                 var acceptedHash = readyHash.get();
777                 if (pr.headHash().equals(acceptedHash)) {
778                     newLabels.add(&quot;sponsor&quot;);
779                 }
780             }
781 
782             // Calculate current metadata to avoid unnecessary future checks
783             var metadata = workItem.getMetadata(title, updatedBody, pr.comments(), activeReviews, newLabels,
784                                                 censusInstance, pr.targetHash(), pr.isDraft());
785             checkBuilder.metadata(metadata);
786         } catch (Exception e) {
787             log.throwing(&quot;CommitChecker&quot;, &quot;checkStatus&quot;, e);
788             newLabels.remove(&quot;ready&quot;);
789             checkBuilder.metadata(&quot;invalid&quot;);
790             checkBuilder.title(&quot;Exception occurred during jcheck - the operation will be retried&quot;);
791             checkBuilder.summary(e.getMessage());
</pre>
</td>
<td>
<hr />
<pre>
 40 
 41 class CheckRun {
 42     private final CheckWorkItem workItem;
 43     private final PullRequest pr;
 44     private final Repository localRepo;
 45     private final List&lt;Comment&gt; comments;
 46     private final List&lt;Review&gt; allReviews;
 47     private final List&lt;Review&gt; activeReviews;
 48     private final Set&lt;String&gt; labels;
 49     private final CensusInstance censusInstance;
 50     private final boolean ignoreStaleReviews;
 51 
 52     private final Hash baseHash;
 53     private final CheckablePullRequest checkablePullRequest;
 54 
 55     private static final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.pr&quot;);
 56     private static final String progressMarker = &quot;&lt;!-- Anything below this marker will be automatically updated, please do not edit manually! --&gt;&quot;;
 57     private static final String mergeReadyMarker = &quot;&lt;!-- PullRequestBot merge is ready comment --&gt;&quot;;
 58     private static final String outdatedHelpMarker = &quot;&lt;!-- PullRequestBot outdated help comment --&gt;&quot;;
 59     private static final String sourceBranchWarningMarker = &quot;&lt;!-- PullRequestBot source branch warning comment --&gt;&quot;;
<span class="line-added"> 60     private static final String mergeCommitWarningMarker = &quot;&lt;!-- PullRequestBot merge commit warning comment --&gt;&quot;;</span>
 61     private static final String emptyPrBodyMarker = &quot;&lt;!--\nReplace this text with a description of your pull request (also remove the surrounding HTML comment markers).\n&quot; +
 62             &quot;If in doubt, feel free to delete everything in this edit box first, the bot will restore the progress section as needed.\n--&gt;&quot;;
 63     private final Set&lt;String&gt; newLabels;
 64     static final Pattern ISSUE_ID_PATTERN = Pattern.compile(&quot;^(?:[A-Za-z][A-Za-z0-9]+-)?([0-9]+)$&quot;);
 65 
 66     private CheckRun(CheckWorkItem workItem, PullRequest pr, Repository localRepo, List&lt;Comment&gt; comments,
 67                      List&lt;Review&gt; allReviews, List&lt;Review&gt; activeReviews, Set&lt;String&gt; labels,
 68                      CensusInstance censusInstance, boolean ignoreStaleReviews) throws IOException {
 69         this.workItem = workItem;
 70         this.pr = pr;
 71         this.localRepo = localRepo;
 72         this.comments = comments;
 73         this.allReviews = allReviews;
 74         this.activeReviews = activeReviews;
 75         this.labels = new HashSet&lt;&gt;(labels);
 76         this.newLabels = new HashSet&lt;&gt;(labels);
 77         this.censusInstance = censusInstance;
 78         this.ignoreStaleReviews = ignoreStaleReviews;
 79 
 80         baseHash = PullRequestUtils.baseHash(pr, localRepo);
</pre>
<hr />
<pre>
678         var existing = findComment(comments, outdatedHelpMarker);
679         if (existing.isPresent()) {
680             // Only add the comment once per PR
681             return;
682         }
683         var message = &quot;@&quot; + pr.author().userName() + &quot; this pull request can not be integrated into &quot; +
684                 &quot;`&quot; + pr.targetRef() + &quot;` due to one or more merge conflicts. To resolve these merge conflicts &quot; +
685                 &quot;and update this pull request you can run the following commands in the local repository for your personal fork:\n&quot; +
686                 &quot;```bash\n&quot; +
687                 &quot;git checkout &quot; + pr.sourceRef() + &quot;\n&quot; +
688                 &quot;git fetch &quot; + pr.repository().webUrl() + &quot; &quot; + pr.targetRef() + &quot;\n&quot; +
689                 &quot;git merge FETCH_HEAD\n&quot; +
690                 &quot;# resolve conflicts and follow the instructions given by git merge\n&quot; +
691                 &quot;git commit -m \&quot;Merge &quot; + pr.targetRef() + &quot;\&quot;\n&quot; +
692                 &quot;git push\n&quot; +
693                 &quot;```\n&quot; +
694                 outdatedHelpMarker;
695         pr.addComment(message);
696     }
697 
<span class="line-added">698     private void addMergeCommitWarningComment(List&lt;Comment&gt; comments) {</span>
<span class="line-added">699         var existing = findComment(comments, mergeCommitWarningMarker);</span>
<span class="line-added">700         if (existing.isPresent()) {</span>
<span class="line-added">701             // Only add the comment once per PR</span>
<span class="line-added">702             return;</span>
<span class="line-added">703         }</span>
<span class="line-added">704 </span>
<span class="line-added">705         var message = &quot;@&quot; + pr.author().userName() + &quot; This pull request looks like it contains a merge commit that &quot; +</span>
<span class="line-added">706                 &quot;brings in commits from outside of this repository. If you want these commits to be preserved &quot; +</span>
<span class="line-added">707                 &quot;when you integrate, you will need to make a &#39;merge-style&#39; pull request. To do this, change the &quot; +</span>
<span class="line-added">708                 &quot;title of this pull request to `Merge &lt;project&gt;:&lt;branch&gt;`, where `&lt;project&gt;` is the name of another &quot; +</span>
<span class="line-added">709                 &quot;project in the OpenJDK organization. For example: `Merge jdk:master`.&quot; +</span>
<span class="line-added">710                 &quot;\n&quot; + mergeCommitWarningMarker;</span>
<span class="line-added">711         pr.addComment(message);</span>
<span class="line-added">712     }</span>
<span class="line-added">713 </span>
714     private void checkStatus() {
715         var checkBuilder = CheckBuilder.create(&quot;jcheck&quot;, pr.headHash());
716         var censusDomain = censusInstance.configuration().census().domain();
717         Exception checkException = null;
718 
719         try {
720             // Post check in-progress
721             log.info(&quot;Starting to run jcheck on PR head&quot;);
722             pr.createCheck(checkBuilder.build());
723 
724             var ignored = new PrintWriter(new StringWriter());
725             var rebasePossible = true;
726             var commitHash = pr.headHash();
727             var mergedHash = checkablePullRequest.mergeTarget(ignored);
728             if (mergedHash.isPresent()) {
729                 commitHash = mergedHash.get();
730             } else {
731                 rebasePossible = false;
732             }
733 
</pre>
<hr />
<pre>
769             updateMergeReadyComment(readyForIntegration, commitMessage, comments, activeReviews, rebasePossible);
770             if (readyForIntegration &amp;&amp; rebasePossible) {
771                 newLabels.add(&quot;ready&quot;);
772             } else {
773                 newLabels.remove(&quot;ready&quot;);
774             }
775             if (!rebasePossible) {
776                 if (!labels.contains(&quot;failed-auto-merge&quot;)) {
777                     addOutdatedComment(comments);
778                 }
779                 newLabels.add(&quot;merge-conflict&quot;);
780             } else {
781                 newLabels.remove(&quot;merge-conflict&quot;);
782             }
783 
784             var branchNames = pr.repository().branches().stream().map(HostedBranch::name).collect(Collectors.toSet());
785             if (!pr.repository().url().equals(pr.sourceRepository().url()) &amp;&amp; branchNames.contains(pr.sourceRef())) {
786                 addSourceBranchWarningComment(comments);
787             }
788 
<span class="line-added">789             if (!PullRequestUtils.isMerge(pr) &amp;&amp; PullRequestUtils.containsForeignMerge(pr, localRepo)) {</span>
<span class="line-added">790                 addMergeCommitWarningComment(comments);</span>
<span class="line-added">791             }</span>
<span class="line-added">792 </span>
793             // Ensure that the ready for sponsor label is up to date
794             newLabels.remove(&quot;sponsor&quot;);
795             var readyHash = ReadyForSponsorTracker.latestReadyForSponsor(pr.repository().forge().currentUser(), comments);
796             if (readyHash.isPresent() &amp;&amp; readyForIntegration) {
797                 var acceptedHash = readyHash.get();
798                 if (pr.headHash().equals(acceptedHash)) {
799                     newLabels.add(&quot;sponsor&quot;);
800                 }
801             }
802 
803             // Calculate current metadata to avoid unnecessary future checks
804             var metadata = workItem.getMetadata(title, updatedBody, pr.comments(), activeReviews, newLabels,
805                                                 censusInstance, pr.targetHash(), pr.isDraft());
806             checkBuilder.metadata(metadata);
807         } catch (Exception e) {
808             log.throwing(&quot;CommitChecker&quot;, &quot;checkStatus&quot;, e);
809             newLabels.remove(&quot;ready&quot;);
810             checkBuilder.metadata(&quot;invalid&quot;);
811             checkBuilder.title(&quot;Exception occurred during jcheck - the operation will be retried&quot;);
812             checkBuilder.summary(e.getMessage());
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/pr/MergeTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>