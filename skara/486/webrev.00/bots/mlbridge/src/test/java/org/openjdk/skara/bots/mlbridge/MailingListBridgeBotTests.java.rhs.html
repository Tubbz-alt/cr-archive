<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.*;
  38 import java.util.*;
  39 import java.util.logging.Logger;
  40 import java.util.regex.Pattern;
  41 import java.util.stream.Collectors;
  42 
  43 import static org.junit.jupiter.api.Assertions.*;
  44 
  45 class MailingListBridgeBotTests {
  46     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  47 
  48     private Optional&lt;String&gt; archiveContents(Path archive) {
  49         try {
  50             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  51             if (mbox.isEmpty()) {
  52                 return Optional.empty();
  53             }
  54             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  55         } catch (IOException e) {
  56             return Optional.empty();
  57         }
  58 
  59     }
  60 
  61     private boolean archiveContains(Path archive, String text) {
  62         return archiveContainsCount(archive, text) &gt; 0;
  63     }
  64 
  65     private int archiveContainsCount(Path archive, String text) {
  66         var lines = archiveContents(archive);
  67         if (lines.isEmpty()) {
  68             return 0;
  69         }
  70         var pattern = Pattern.compile(text);
  71         int count = 0;
  72         for (var line : lines.get().split(&quot;\\R&quot;)) {
  73             var matcher = pattern.matcher(line);
  74             if (matcher.find()) {
  75                 count++;
  76             }
  77         }
  78         return count;
  79     }
  80 
  81     private boolean webrevContains(Path webrev, String text) {
  82         try {
  83             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  84             if (index.isEmpty()) {
  85                 return false;
  86             }
  87             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  88             return lines.contains(text);
  89         } catch (IOException e) {
  90             return false;
  91         }
  92     }
  93 
  94     private long countSubstrings(String string, String substring) {
  95         return Pattern.compile(substring).matcher(string).results().count();
  96     }
  97 
  98     private String noreplyAddress(HostedRepository repository) {
  99         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
 100                 repository.forge().currentUser().userName() +
 101                 &quot;@openjdk.java.net&quot;;
 102     }
 103 
 104     @Test
 105     void simpleArchive(TestInfo testInfo) throws IOException {
 106         try (var credentials = new HostCredentials(testInfo);
 107              var tempFolder = new TemporaryDirectory();
 108              var archiveFolder = new TemporaryDirectory();
 109              var webrevFolder = new TemporaryDirectory();
 110              var listServer = new TestMailmanServer();
 111              var webrevServer = new TestWebrevServer()) {
 112             var author = credentials.getHostedRepository();
 113             var archive = credentials.getHostedRepository();
 114             var ignored = credentials.getHostedRepository();
 115             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 116             var censusBuilder = credentials.getCensusBuilder()
 117                                            .addAuthor(author.forge().currentUser().id());
 118             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 119             var mlBot = MailingListBridgeBot.newBuilder()
 120                                             .from(from)
 121                                             .repo(author)
 122                                             .archive(archive)
 123                                             .censusRepo(censusBuilder.build())
 124                                             .list(listAddress)
 125                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 126                                             .ignoredComments(Set.of())
 127                                             .listArchive(listServer.getArchive())
 128                                             .smtpServer(listServer.getSMTP())
 129                                             .webrevStorageRepository(archive)
 130                                             .webrevStorageRef(&quot;webrev&quot;)
 131                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 132                                             .webrevStorageBaseUri(webrevServer.uri())
 133                                             .readyLabels(Set.of(&quot;rfr&quot;))
 134                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 135                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 136                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 137                                             .sendInterval(Duration.ZERO)
 138                                             .build();
 139 
 140             // Populate the projects repository
 141             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 142             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 143             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 144             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 145 
 146             // Make a change with a corresponding PR
 147             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 148                                                                &quot;Change msg\n\nWith several lines&quot;);
 149             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 150             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 151             pr.setBody(&quot;This should not be ready&quot;);
 152 
 153             // Run an archive pass
 154             TestBotRunner.runPeriodicItems(mlBot);
 155 
 156             // A PR that isn&#39;t ready for review should not be archived
 157             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 158             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 159 
 160             // Flag it as ready for review
 161             pr.setBody(&quot;This should now be ready&quot;);
 162             pr.addLabel(&quot;rfr&quot;);
 163 
 164             // Run another archive pass
 165             TestBotRunner.runPeriodicItems(mlBot);
 166 
 167             // But it should still not be archived
 168             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 169             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 170 
 171             // Now post a general comment - not a ready marker
 172             var ignoredPr = ignored.pullRequest(pr.id());
 173             ignoredPr.addComment(&quot;hello there&quot;);
 174 
 175             // Run another archive pass
 176             TestBotRunner.runPeriodicItems(mlBot);
 177 
 178             // It should still not be archived
 179             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 180             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 181 
 182             // Now post a ready comment
 183             ignoredPr.addComment(&quot;ready&quot;);
 184 
 185             // Run another archive pass
 186             TestBotRunner.runPeriodicItems(mlBot);
 187 
 188             // The archive should now contain an entry
 189             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 190             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 196             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 197             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 198             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 201             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 202 
 203             // The mailing list as well
 204             listServer.processIncoming();
 205             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 206             var mailmanList = mailmanServer.getList(listAddress.address());
 207             var conversations = mailmanList.conversations(Duration.ofDays(1));
 208             assertEquals(1, conversations.size());
 209             var mail = conversations.get(0).first();
 210             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 211             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 212             assertEquals(noreplyAddress(archive), mail.author().address());
 213             assertEquals(listAddress, mail.sender());
 214             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 215             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 216 
 217             // And there should be a webrev
 218             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 219             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 220             var comments = pr.comments();
 221             var webrevComments = comments.stream()
 222                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 223                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 224                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 225                                          .collect(Collectors.toList());
 226             assertEquals(1, webrevComments.size());
 227 
 228             // Add a comment
 229             pr.addComment(&quot;This is a comment :smile:&quot;);
 230 
 231             // Add a comment from an ignored user as well
 232             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 233 
 234             // Run another archive pass
 235             TestBotRunner.runPeriodicItems(mlBot);
 236 
 237             // The archive should now contain the comment, but not the ignored one
 238             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 239             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 240             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 241             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 242 
 243             listServer.processIncoming();
 244             conversations = mailmanList.conversations(Duration.ofDays(1));
 245             assertEquals(1, conversations.size());
 246             assertEquals(2, conversations.get(0).allMessages().size());
 247 
 248             // Remove the rfr flag and post another comment
 249             pr.addLabel(&quot;rfr&quot;);
 250             pr.addComment(&quot;This is another comment&quot;);
 251 
 252             // Run another archive pass
 253             TestBotRunner.runPeriodicItems(mlBot);
 254 
 255             // The archive should contain the additional comment
 256             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 257             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 258             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 259 
 260             listServer.processIncoming();
 261             conversations = mailmanList.conversations(Duration.ofDays(1));
 262             assertEquals(1, conversations.size());
 263             assertEquals(3, conversations.get(0).allMessages().size());
 264             for (var newMail : conversations.get(0).allMessages()) {
 265                 assertEquals(noreplyAddress(archive), newMail.author().address());
 266                 assertEquals(listAddress, newMail.sender());
 267             }
 268             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment 😄&quot;));
 269         }
 270     }
 271 
 272     @Test
 273     void reviewComment(TestInfo testInfo) throws IOException {
 274         try (var credentials = new HostCredentials(testInfo);
 275              var tempFolder = new TemporaryDirectory();
 276              var archiveFolder = new TemporaryDirectory();
 277              var listServer = new TestMailmanServer();
 278              var webrevServer = new TestWebrevServer()) {
 279             var author = credentials.getHostedRepository();
 280             var archive = credentials.getHostedRepository();
 281             var ignored = credentials.getHostedRepository();
 282             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 283             var censusBuilder = credentials.getCensusBuilder()
 284                                            .addAuthor(author.forge().currentUser().id());
 285             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 286             var mlBot = MailingListBridgeBot.newBuilder()
 287                                             .from(from)
 288                                             .repo(author)
 289                                             .archive(archive)
 290                                             .censusRepo(censusBuilder.build())
 291                                             .list(listAddress)
 292                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 293                                             .listArchive(listServer.getArchive())
 294                                             .smtpServer(listServer.getSMTP())
 295                                             .webrevStorageRepository(archive)
 296                                             .webrevStorageRef(&quot;webrev&quot;)
 297                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 298                                             .webrevStorageBaseUri(webrevServer.uri())
 299                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 300                                             .build();
 301 
 302             // Populate the projects repository
 303             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 304             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 305             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 306             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 307             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 308 
 309             // Make a change with a corresponding PR
 310             var editHash = CheckableRepository.appendAndCommit(localRepo);
 311             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 312             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 313             pr.setBody(&quot;This is now ready&quot;);
 314             TestBotRunner.runPeriodicItems(mlBot);
 315             listServer.processIncoming();
 316 
 317             // And make a file specific comment
 318             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 319             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 320 
 321             // Add one from an ignored user as well
 322             var ignoredPr = ignored.pullRequest(pr.id());
 323             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 324 
 325             // Process comments
 326             TestBotRunner.runPeriodicItems(mlBot);
 327             listServer.processIncoming();
 328 
 329             // The archive should now contain an entry
 330             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 331             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 332             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 333             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 334             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 335             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 336             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 337 
 338             // The mailing list as well
 339             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 340             var mailmanList = mailmanServer.getList(listAddress.address());
 341             var conversations = mailmanList.conversations(Duration.ofDays(1));
 342             assertEquals(1, conversations.size());
 343             var mail = conversations.get(0).first();
 344             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 345 
 346             // Comment on the comment
 347             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 348             TestBotRunner.runPeriodicItems(mlBot);
 349             listServer.processIncoming();
 350 
 351             // The archive should contain the additional comment (but no quoted footers)
 352             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 353             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 354             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 355             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 356 
 357             // As well as the mailing list
 358             conversations = mailmanList.conversations(Duration.ofDays(1));
 359             assertEquals(1, conversations.size());
 360             assertEquals(3, conversations.get(0).allMessages().size());
 361             for (var newMail : conversations.get(0).allMessages()) {
 362                 assertEquals(noreplyAddress(archive), newMail.author().address());
 363                 assertEquals(listAddress, newMail.sender());
 364             }
 365         }
 366     }
 367 
 368     @Test
 369     void combineComments(TestInfo testInfo) throws IOException {
 370         try (var credentials = new HostCredentials(testInfo);
 371              var tempFolder = new TemporaryDirectory();
 372              var archiveFolder = new TemporaryDirectory();
 373              var listServer = new TestMailmanServer();
 374              var webrevServer = new TestWebrevServer()) {
 375             var author = credentials.getHostedRepository();
 376             var archive = credentials.getHostedRepository();
 377             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 378             var censusBuilder = credentials.getCensusBuilder()
 379                                            .addAuthor(author.forge().currentUser().id());
 380             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 381             var mlBot = MailingListBridgeBot.newBuilder()
 382                                             .from(from)
 383                                             .repo(author)
 384                                             .archive(archive)
 385                                             .censusRepo(censusBuilder.build())
 386                                             .list(listAddress)
 387                                             .listArchive(listServer.getArchive())
 388                                             .smtpServer(listServer.getSMTP())
 389                                             .webrevStorageRepository(archive)
 390                                             .webrevStorageRef(&quot;webrev&quot;)
 391                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 392                                             .webrevStorageBaseUri(webrevServer.uri())
 393                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 394                                             .build();
 395 
 396             // Populate the projects repository
 397             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 398             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 399             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 400             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 401             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 402 
 403             // Make a change with a corresponding PR
 404             var editHash = CheckableRepository.appendAndCommit(localRepo);
 405             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 406             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 407             pr.setBody(&quot;This is now ready&quot;);
 408             pr.addComment(&quot;Avoid combining&quot;);
 409 
 410             TestBotRunner.runPeriodicItems(mlBot);
 411             listServer.processIncoming();
 412             listServer.processIncoming();
 413 
 414             // Make several file specific comments
 415             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 416             var second = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 417             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 418             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 419             TestBotRunner.runPeriodicItems(mlBot);
 420             listServer.processIncoming();
 421 
 422             // The archive should contain a combined entry
 423             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 424             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 425 
 426             // As well as the mailing list
 427             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 428             var mailmanList = mailmanServer.getList(listAddress.address());
 429             var conversations = mailmanList.conversations(Duration.ofDays(1));
 430             assertEquals(1, conversations.size());
 431             var mail = conversations.get(0).first();
 432             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 433             assertEquals(3, conversations.get(0).allMessages().size());
 434 
 435             var commentReply = conversations.get(0).replies(mail).get(0);
 436             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 437             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 438 
 439             var reviewReply = conversations.get(0).replies(mail).get(1);
 440             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 441             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 442             assertEquals(&quot;RFR: This is a pull request&quot;, reviewReply.subject());
 443             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 444             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 445 
 446             // Now reply to the first and second (collapsed) comment
 447             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 448             pr.addReviewCommentReply(second, &quot;Not with this one though&quot;);
 449             TestBotRunner.runPeriodicItems(mlBot);
 450             listServer.processIncoming();
 451 
 452             // The archive should contain a new entry
 453             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 454             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 455 
 456             // The combined review comments should only appear unquoted once
 457             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 458         }
 459     }
 460 
 461     @Test
 462     void commentThreading(TestInfo testInfo) throws IOException {
 463         try (var credentials = new HostCredentials(testInfo);
 464              var tempFolder = new TemporaryDirectory();
 465              var archiveFolder = new TemporaryDirectory();
 466              var listServer = new TestMailmanServer();
 467              var webrevServer = new TestWebrevServer()) {
 468             var author = credentials.getHostedRepository();
 469             var reviewer = credentials.getHostedRepository();
 470             var archive = credentials.getHostedRepository();
 471             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 472             var censusBuilder = credentials.getCensusBuilder()
 473                                            .addReviewer(reviewer.forge().currentUser().id())
 474                                            .addAuthor(author.forge().currentUser().id());
 475             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 476             var mlBot = MailingListBridgeBot.newBuilder()
 477                                             .from(from)
 478                                             .repo(author)
 479                                             .archive(archive)
 480                                             .censusRepo(censusBuilder.build())
 481                                             .list(listAddress)
 482                                             .listArchive(listServer.getArchive())
 483                                             .smtpServer(listServer.getSMTP())
 484                                             .webrevStorageRepository(archive)
 485                                             .webrevStorageRef(&quot;webrev&quot;)
 486                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 487                                             .webrevStorageBaseUri(webrevServer.uri())
 488                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 489                                             .build();
 490 
 491             // Populate the projects repository
 492             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 493             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 494             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 495             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 496             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 497 
 498             // Make a change with a corresponding PR
 499             var editHash = CheckableRepository.appendAndCommit(localRepo);
 500             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 501             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 502             pr.setBody(&quot;This is now ready&quot;);
 503             TestBotRunner.runPeriodicItems(mlBot);
 504             listServer.processIncoming();
 505 
 506             // Make a file specific comment
 507             var reviewPr = reviewer.pullRequest(pr.id());
 508             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 509             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 510             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 511             TestBotRunner.runPeriodicItems(mlBot);
 512             listServer.processIncoming();
 513             listServer.processIncoming();
 514             listServer.processIncoming();
 515 
 516             // And a second one by ourselves
 517             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 518             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 519             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 520             TestBotRunner.runPeriodicItems(mlBot);
 521             listServer.processIncoming();
 522             listServer.processIncoming();
 523             listServer.processIncoming();
 524 
 525             // Finally some approvals and another comment
 526             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 527             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 528             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 529             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 530             TestBotRunner.runPeriodicItems(mlBot);
 531             listServer.processIncoming();
 532             listServer.processIncoming();
 533             listServer.processIncoming();
 534 
 535             // Sanity check the archive
 536             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 537             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 538 
 539             // File specific comments should appear after the approval
 540             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 541             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 542 
 543             // Check the mailing list
 544             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 545             var mailmanList = mailmanServer.getList(listAddress.address());
 546             var conversations = mailmanList.conversations(Duration.ofDays(1));
 547             assertEquals(1, conversations.size());
 548             var mail = conversations.get(0).first();
 549             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 550             assertEquals(10, conversations.get(0).allMessages().size());
 551 
 552             // There should be four separate threads
 553             var thread1 = conversations.get(0).replies(mail).get(0);
 554             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 555             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 556             assertEquals(&quot;RFR: This is a pull request&quot;, thread1.subject());
 557             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 558             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 559             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 560             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 561             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 562             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
 563             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 564             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 565             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 566             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 567 
 568             var thread2 = conversations.get(0).replies(mail).get(1);
 569             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 570             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 571             assertEquals(&quot;RFR: This is a pull request&quot;, thread2.subject());
 572             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 573             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 574             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 575             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 576             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 577             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 578 
 579             var replies = conversations.get(0).replies(mail);
 580             var thread3 = replies.get(2);
 581             assertEquals(&quot;RFR: This is a pull request&quot;, thread3.subject());
 582             var thread4 = replies.get(3);
 583             assertEquals(&quot;RFR: This is a pull request&quot;, thread4.subject());
 584             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 585             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 586             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 587         }
 588     }
 589 
 590     @Test
 591     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 592         try (var credentials = new HostCredentials(testInfo);
 593              var tempFolder = new TemporaryDirectory();
 594              var archiveFolder = new TemporaryDirectory();
 595              var listServer = new TestMailmanServer();
 596              var webrevServer = new TestWebrevServer()) {
 597             var author = credentials.getHostedRepository();
 598             var reviewer = credentials.getHostedRepository();
 599             var archive = credentials.getHostedRepository();
 600             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 601             var censusBuilder = credentials.getCensusBuilder()
 602                                            .addReviewer(reviewer.forge().currentUser().id())
 603                                            .addAuthor(author.forge().currentUser().id());
 604             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 605             var mlBot = MailingListBridgeBot.newBuilder()
 606                                             .from(from)
 607                                             .repo(author)
 608                                             .archive(archive)
 609                                             .censusRepo(censusBuilder.build())
 610                                             .list(listAddress)
 611                                             .listArchive(listServer.getArchive())
 612                                             .smtpServer(listServer.getSMTP())
 613                                             .webrevStorageRepository(archive)
 614                                             .webrevStorageRef(&quot;webrev&quot;)
 615                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 616                                             .webrevStorageBaseUri(webrevServer.uri())
 617                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 618                                             .build();
 619 
 620             // Populate the projects repository
 621             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 622             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 623             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 624             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 625             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 626 
 627             // Make a change with a corresponding PR
 628             var editHash = CheckableRepository.appendAndCommit(localRepo);
 629             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 630             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 631             pr.setBody(&quot;This is now ready&quot;);
 632             TestBotRunner.runPeriodicItems(mlBot);
 633             listServer.processIncoming();
 634 
 635             // Make two file specific comments
 636             var reviewPr = reviewer.pullRequest(pr.id());
 637             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 638             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 639             TestBotRunner.runPeriodicItems(mlBot);
 640             listServer.processIncoming();
 641 
 642             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 643             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
 644             TestBotRunner.runPeriodicItems(mlBot);
 645             listServer.processIncoming();
 646 
 647             // Sanity check the archive
 648             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 649             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 650         }
 651     }
 652 
<a name="1" id="anc1"></a><span class="line-added"> 653     @Test</span>
<span class="line-added"> 654     void commentWithMention(TestInfo testInfo) throws IOException {</span>
<span class="line-added"> 655         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added"> 656              var tempFolder = new TemporaryDirectory();</span>
<span class="line-added"> 657              var archiveFolder = new TemporaryDirectory();</span>
<span class="line-added"> 658              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 659              var webrevServer = new TestWebrevServer()) {</span>
<span class="line-added"> 660             var author = credentials.getHostedRepository();</span>
<span class="line-added"> 661             var reviewer = credentials.getHostedRepository();</span>
<span class="line-added"> 662             var archive = credentials.getHostedRepository();</span>
<span class="line-added"> 663             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-added"> 664             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added"> 665                                            .addReviewer(reviewer.forge().currentUser().id())</span>
<span class="line-added"> 666                                            .addAuthor(author.forge().currentUser().id());</span>
<span class="line-added"> 667             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);</span>
<span class="line-added"> 668             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-added"> 669                                             .from(from)</span>
<span class="line-added"> 670                                             .repo(author)</span>
<span class="line-added"> 671                                             .archive(archive)</span>
<span class="line-added"> 672                                             .censusRepo(censusBuilder.build())</span>
<span class="line-added"> 673                                             .list(listAddress)</span>
<span class="line-added"> 674                                             .listArchive(listServer.getArchive())</span>
<span class="line-added"> 675                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-added"> 676                                             .webrevStorageRepository(archive)</span>
<span class="line-added"> 677                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added"> 678                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added"> 679                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added"> 680                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added"> 681                                             .build();</span>
<span class="line-added"> 682 </span>
<span class="line-added"> 683             // Populate the projects repository</span>
<span class="line-added"> 684             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);</span>
<span class="line-added"> 685             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);</span>
<span class="line-added"> 686             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added"> 687             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-added"> 688             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
<span class="line-added"> 689 </span>
<span class="line-added"> 690             // Make a change with a corresponding PR</span>
<span class="line-added"> 691             var editHash = CheckableRepository.appendAndCommit(localRepo);</span>
<span class="line-added"> 692             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-added"> 693             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);</span>
<span class="line-added"> 694             pr.setBody(&quot;This is now ready&quot;);</span>
<span class="line-added"> 695             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 696             listServer.processIncoming();</span>
<span class="line-added"> 697 </span>
<span class="line-added"> 698             // Make two comments from different authors</span>
<span class="line-added"> 699             var reviewPr = reviewer.pullRequest(pr.id());</span>
<span class="line-added"> 700             reviewPr.addComment(&quot;First comment&quot;);</span>
<span class="line-added"> 701             pr.addComment(&quot;Second comment&quot;);</span>
<span class="line-added"> 702 </span>
<span class="line-added"> 703             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 704             listServer.processIncoming();</span>
<span class="line-added"> 705 </span>
<span class="line-added"> 706             pr.addComment(&quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);</span>
<span class="line-added"> 707             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 708             listServer.processIncoming();</span>
<span class="line-added"> 709 </span>
<span class="line-added"> 710             // The first comment should be quoted more often than the second</span>
<span class="line-added"> 711             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added"> 712             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));</span>
<span class="line-added"> 713             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));</span>
<span class="line-added"> 714         }</span>
<span class="line-added"> 715     }</span>
<span class="line-added"> 716 </span>
<span class="line-added"> 717     @Test</span>
<span class="line-added"> 718     void reviewCommentWithMention(TestInfo testInfo) throws IOException {</span>
<span class="line-added"> 719         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added"> 720              var tempFolder = new TemporaryDirectory();</span>
<span class="line-added"> 721              var archiveFolder = new TemporaryDirectory();</span>
<span class="line-added"> 722              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 723              var webrevServer = new TestWebrevServer()) {</span>
<span class="line-added"> 724             var author = credentials.getHostedRepository();</span>
<span class="line-added"> 725             var reviewer = credentials.getHostedRepository();</span>
<span class="line-added"> 726             var archive = credentials.getHostedRepository();</span>
<span class="line-added"> 727             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-added"> 728             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added"> 729                                            .addReviewer(reviewer.forge().currentUser().id())</span>
<span class="line-added"> 730                                            .addAuthor(author.forge().currentUser().id());</span>
<span class="line-added"> 731             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);</span>
<span class="line-added"> 732             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-added"> 733                                             .from(from)</span>
<span class="line-added"> 734                                             .repo(author)</span>
<span class="line-added"> 735                                             .archive(archive)</span>
<span class="line-added"> 736                                             .censusRepo(censusBuilder.build())</span>
<span class="line-added"> 737                                             .list(listAddress)</span>
<span class="line-added"> 738                                             .listArchive(listServer.getArchive())</span>
<span class="line-added"> 739                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-added"> 740                                             .webrevStorageRepository(archive)</span>
<span class="line-added"> 741                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added"> 742                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added"> 743                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added"> 744                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added"> 745                                             .build();</span>
<span class="line-added"> 746 </span>
<span class="line-added"> 747             // Populate the projects repository</span>
<span class="line-added"> 748             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);</span>
<span class="line-added"> 749             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);</span>
<span class="line-added"> 750             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added"> 751             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-added"> 752             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
<span class="line-added"> 753 </span>
<span class="line-added"> 754             // Make a change with a corresponding PR</span>
<span class="line-added"> 755             var editHash = CheckableRepository.appendAndCommit(localRepo);</span>
<span class="line-added"> 756             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-added"> 757             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);</span>
<span class="line-added"> 758             pr.setBody(&quot;This is now ready&quot;);</span>
<span class="line-added"> 759             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 760             listServer.processIncoming();</span>
<span class="line-added"> 761 </span>
<span class="line-added"> 762             // Make two review comments from different authors</span>
<span class="line-added"> 763             var reviewPr = reviewer.pullRequest(pr.id());</span>
<span class="line-added"> 764             var comment = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);</span>
<span class="line-added"> 765             reviewPr.addReviewCommentReply(comment, &quot;First review comment&quot;);</span>
<span class="line-added"> 766             pr.addReviewCommentReply(comment, &quot;Second review comment&quot;);</span>
<span class="line-added"> 767 </span>
<span class="line-added"> 768             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 769             listServer.processIncoming();</span>
<span class="line-added"> 770 </span>
<span class="line-added"> 771             pr.addReviewCommentReply(comment, &quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);</span>
<span class="line-added"> 772             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 773             listServer.processIncoming();</span>
<span class="line-added"> 774 </span>
<span class="line-added"> 775             // The first comment should be quoted more often than the second</span>
<span class="line-added"> 776             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added"> 777             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First review comment&quot;));</span>
<span class="line-added"> 778             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second review comment&quot;));</span>
<span class="line-added"> 779         }</span>
<span class="line-added"> 780     }</span>
<span class="line-added"> 781 </span>
 782     @Test
 783     void reviewContext(TestInfo testInfo) throws IOException {
 784         try (var credentials = new HostCredentials(testInfo);
 785              var tempFolder = new TemporaryDirectory();
 786              var archiveFolder = new TemporaryDirectory();
 787              var listServer = new TestMailmanServer();
 788              var webrevServer = new TestWebrevServer()) {
 789             var author = credentials.getHostedRepository();
 790             var archive = credentials.getHostedRepository();
 791             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 792             var censusBuilder = credentials.getCensusBuilder()
 793                                            .addAuthor(author.forge().currentUser().id());
 794             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 795             var mlBot = MailingListBridgeBot.newBuilder()
 796                                             .from(from)
 797                                             .repo(author)
 798                                             .archive(archive)
 799                                             .censusRepo(censusBuilder.build())
 800                                             .list(listAddress)
 801                                             .listArchive(listServer.getArchive())
 802                                             .smtpServer(listServer.getSMTP())
 803                                             .webrevStorageRepository(archive)
 804                                             .webrevStorageRef(&quot;webrev&quot;)
 805                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 806                                             .webrevStorageBaseUri(webrevServer.uri())
 807                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 808                                             .build();
 809 
 810             // Populate the projects repository
 811             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 812             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 813             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 814             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 815             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 816 
 817             // Make a change with a corresponding PR
 818             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 819             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 820             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 821             pr.setBody(&quot;This is now ready&quot;);
 822             TestBotRunner.runPeriodicItems(mlBot);
 823             listServer.processIncoming();
 824 
 825             // Make a file specific comment
 826             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 827 
 828             TestBotRunner.runPeriodicItems(mlBot);
 829             listServer.processIncoming();
 830 
 831             // The archive should only contain context around line 2
 832             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 833             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 834             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 835             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 836         }
 837     }
 838 
 839     @Test
 840     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 841         try (var credentials = new HostCredentials(testInfo);
 842              var tempFolder = new TemporaryDirectory();
 843              var archiveFolder = new TemporaryDirectory();
 844              var listServer = new TestMailmanServer();
 845              var webrevServer = new TestWebrevServer()) {
 846             var author = credentials.getHostedRepository();
 847             var archive = credentials.getHostedRepository();
 848             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 849             var censusBuilder = credentials.getCensusBuilder()
 850                                            .addAuthor(author.forge().currentUser().id());
 851             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 852             var mlBot = MailingListBridgeBot.newBuilder()
 853                                             .from(from)
 854                                             .repo(author)
 855                                             .archive(archive)
 856                                             .censusRepo(censusBuilder.build())
 857                                             .list(listAddress)
 858                                             .listArchive(listServer.getArchive())
 859                                             .smtpServer(listServer.getSMTP())
 860                                             .webrevStorageRepository(archive)
 861                                             .webrevStorageRef(&quot;webrev&quot;)
 862                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 863                                             .webrevStorageBaseUri(webrevServer.uri())
 864                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 865                                             .build();
 866 
 867             // Populate the projects repository
 868             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 869             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 870             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 871             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 872             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 873             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 874                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 875                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 876                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 877                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 878                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 879                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 880             localRepo.push(initialHash, author.url(), &quot;master&quot;);
 881 
 882             // Make a change with a corresponding PR
 883             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 884             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 885             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 886             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 887             var editHash = CheckableRepository.appendAndCommit(localRepo);
 888             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 889             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 890             pr.setBody(&quot;This is now ready&quot;);
 891             TestBotRunner.runPeriodicItems(mlBot);
 892             listServer.processIncoming();
 893 
 894             // Make file specific comments
 895             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 896             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 897 
 898             TestBotRunner.runPeriodicItems(mlBot);
 899             listServer.processIncoming();
 900 
 901             // The archive should only contain context around line 2 and 20
 902             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 903             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 904             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 905             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 906             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 907 
 908             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 909             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 910             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 911             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 912         }
 913     }
 914 
 915     @Test
 916     void filterComments(TestInfo testInfo) throws IOException {
 917         try (var credentials = new HostCredentials(testInfo);
 918              var tempFolder = new TemporaryDirectory();
 919              var archiveFolder = new TemporaryDirectory();
 920              var listServer = new TestMailmanServer();
 921              var webrevServer = new TestWebrevServer()) {
 922             var author = credentials.getHostedRepository();
 923             var archive = credentials.getHostedRepository();
 924             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 925             var censusBuilder = credentials.getCensusBuilder()
 926                                            .addAuthor(author.forge().currentUser().id());
 927             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 928             var mlBot = MailingListBridgeBot.newBuilder()
 929                                             .from(from)
 930                                             .repo(author)
 931                                             .archive(archive)
 932                                             .censusRepo(censusBuilder.build())
 933                                             .list(listAddress)
 934                                             .listArchive(listServer.getArchive())
 935                                             .smtpServer(listServer.getSMTP())
 936                                             .webrevStorageRepository(archive)
 937                                             .webrevStorageRef(&quot;webrev&quot;)
 938                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 939                                             .webrevStorageBaseUri(webrevServer.uri())
 940                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 941                                             .build();
 942 
 943             // Populate the projects repository
 944             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 945             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 946             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 947             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 948             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 949 
 950             // Make a change with a corresponding PR
 951             var editHash = CheckableRepository.appendAndCommit(localRepo);
 952             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 953             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 954             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 955                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 956 
 957             // Make a bunch of comments
 958             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 959             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 960             pr.addComment(&quot;/integrate stuff&quot;);
 961             TestBotRunner.runPeriodicItems(mlBot);
 962 
 963             // Run an archive pass
 964             TestBotRunner.runPeriodicItems(mlBot);
 965 
 966             // The archive should not contain the comment
 967             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 968             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 969             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 970             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 971             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 972             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 973             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 974             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 975             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 976             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 977         }
 978     }
 979 
 980     @Test
 981     void incrementalChanges(TestInfo testInfo) throws IOException {
 982         try (var credentials = new HostCredentials(testInfo);
 983              var tempFolder = new TemporaryDirectory();
 984              var archiveFolder = new TemporaryDirectory();
 985              var listServer = new TestMailmanServer();
 986              var webrevServer = new TestWebrevServer()) {
 987             var author = credentials.getHostedRepository();
 988             var archive = credentials.getHostedRepository();
 989             var commenter = credentials.getHostedRepository();
 990             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 991             var censusBuilder = credentials.getCensusBuilder()
 992                                            .addAuthor(author.forge().currentUser().id());
 993             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 994             var mlBot = MailingListBridgeBot.newBuilder()
 995                                             .from(from)
 996                                             .repo(author)
 997                                             .archive(archive)
 998                                             .censusRepo(censusBuilder.build())
 999                                             .list(listAddress)
1000                                             .listArchive(listServer.getArchive())
1001                                             .smtpServer(listServer.getSMTP())
1002                                             .webrevStorageRepository(archive)
1003                                             .webrevStorageRef(&quot;webrev&quot;)
1004                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1005                                             .webrevStorageBaseUri(webrevServer.uri())
1006                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1007                                             .build();
1008 
1009             // Populate the projects repository
1010             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1011             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1012             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1013             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1014             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1015 
1016             // Make a change with a corresponding PR
1017             var editHash = CheckableRepository.appendAndCommit(localRepo);
1018             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1019             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1020             pr.setBody(&quot;This is now ready&quot;);
1021 
1022             // Run an archive pass
1023             TestBotRunner.runPeriodicItems(mlBot);
1024             listServer.processIncoming();
1025 
1026             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
1027             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
1028 
1029             // Make sure that the push registered
1030             var lastHeadHash = pr.headHash();
1031             var refreshCount = 0;
1032             do {
1033                 pr = author.pullRequest(pr.id());
1034                 if (refreshCount++ &gt; 100) {
1035                     fail(&quot;The PR did not update after the new push&quot;);
1036                 }
1037             } while (pr.headHash().equals(lastHeadHash));
1038 
1039             // Run another archive pass
1040             TestBotRunner.runPeriodicItems(mlBot);
1041             TestBotRunner.runPeriodicItems(mlBot);
1042             TestBotRunner.runPeriodicItems(mlBot);
1043             listServer.processIncoming();
1044 
1045             // The archive should reference the updated push
1046             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1047             assertTrue(archiveContains(archiveFolder.path(), &quot;1 additional commit&quot;));
1048             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
1049             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
1050             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1051             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1052             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
1053 
1054             // The webrev comment should be updated
1055             var comments = pr.comments();
1056             var webrevComments = comments.stream()
1057                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1058                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1059                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
1060                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
1061                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
1062                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1063                                          .collect(Collectors.toList());
1064             assertEquals(1, webrevComments.size());
1065 
1066             // Check that sender address is set properly
1067             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1068             var mailmanList = mailmanServer.getList(listAddress.address());
1069             var conversations = mailmanList.conversations(Duration.ofDays(1));
1070             assertEquals(1, conversations.size());
1071             for (var newMail : conversations.get(0).allMessages()) {
1072                 assertEquals(noreplyAddress(archive), newMail.author().address());
1073                 assertEquals(listAddress, newMail.sender());
1074             }
1075 
1076             // Add a comment
1077             var commenterPr = commenter.pullRequest(pr.id());
1078             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1079             TestBotRunner.runPeriodicItems(mlBot);
1080             listServer.processIncoming();
1081 
1082             // Ensure that additional updates are only reported once
1083             for (int i = 0; i &lt; 3; ++i) {
1084                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
1085                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
1086 
1087                 // Make sure that the push registered
1088                 lastHeadHash = pr.headHash();
1089                 refreshCount = 0;
1090                 do {
1091                     pr = author.pullRequest(pr.id());
1092                     if (refreshCount++ &gt; 100) {
1093                         fail(&quot;The PR did not update after the new push&quot;);
1094                     }
1095                 } while (pr.headHash().equals(lastHeadHash));
1096 
1097                 TestBotRunner.runPeriodicItems(mlBot);
1098                 TestBotRunner.runPeriodicItems(mlBot);
1099                 listServer.processIncoming();
1100             }
1101             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
1102             assertEquals(1, updatedConversations.size());
1103             var conversation = updatedConversations.get(0);
1104             assertEquals(6, conversation.allMessages().size());
1105             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
1106             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
1107             assertEquals(&quot;[Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
1108         }
1109     }
1110 
1111     @Test
1112     void rebased(TestInfo testInfo) throws IOException {
1113         try (var credentials = new HostCredentials(testInfo);
1114              var tempFolder = new TemporaryDirectory();
1115              var archiveFolder = new TemporaryDirectory();
1116              var listServer = new TestMailmanServer();
1117              var webrevServer = new TestWebrevServer()) {
1118             var author = credentials.getHostedRepository();
1119             var archive = credentials.getHostedRepository();
1120             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1121             var censusBuilder = credentials.getCensusBuilder()
1122                                            .addAuthor(author.forge().currentUser().id());
1123             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1124             var mlBot = MailingListBridgeBot.newBuilder()
1125                                             .from(sender)
1126                                             .repo(author)
1127                                             .archive(archive)
1128                                             .censusRepo(censusBuilder.build())
1129                                             .list(listAddress)
1130                                             .listArchive(listServer.getArchive())
1131                                             .smtpServer(listServer.getSMTP())
1132                                             .webrevStorageRepository(archive)
1133                                             .webrevStorageRef(&quot;webrev&quot;)
1134                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1135                                             .webrevStorageBaseUri(webrevServer.uri())
1136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1137                                             .build();
1138 
1139             // Populate the projects repository
1140             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1141             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1142             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1143             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1144             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1145 
1146             // Make a change with a corresponding PR
1147             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1148             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1149             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1150             pr.setBody(&quot;This is now ready&quot;);
1151 
1152             // Run an archive pass
1153             TestBotRunner.runPeriodicItems(mlBot);
1154             listServer.processIncoming();
1155 
1156             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1157             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1158             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1159 
1160             // Make sure that the push registered
1161             var lastHeadHash = pr.headHash();
1162             var refreshCount = 0;
1163             do {
1164                 pr = author.pullRequest(pr.id());
1165                 if (refreshCount++ &gt; 100) {
1166                     fail(&quot;The PR did not update after the new push&quot;);
1167                 }
1168             } while (pr.headHash().equals(lastHeadHash));
1169 
1170             // Run another archive pass
1171             TestBotRunner.runPeriodicItems(mlBot);
1172             listServer.processIncoming();
1173 
1174             // The archive should reference the rebased push
1175             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1176             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));
1177             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1178             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1179             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1180             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1181             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1182             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1183 
1184             // The webrev comment should be updated
1185             var comments = pr.comments();
1186             var webrevComments = comments.stream()
1187                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1188                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1189                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1190                                          .collect(Collectors.toList());
1191             assertEquals(1, webrevComments.size());
1192 
1193             // Check that sender address is set properly
1194             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1195             var mailmanList = mailmanServer.getList(listAddress.address());
1196             var conversations = mailmanList.conversations(Duration.ofDays(1));
1197             assertEquals(1, conversations.size());
1198             for (var newMail : conversations.get(0).allMessages()) {
1199                 assertEquals(noreplyAddress(archive), newMail.author().address());
1200                 assertEquals(listAddress, newMail.sender());
1201                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1202             }
1203             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1204         }
1205     }
1206 
1207     @Test
1208     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1209         try (var credentials = new HostCredentials(testInfo);
1210              var tempFolder = new TemporaryDirectory();
1211              var archiveFolder = new TemporaryDirectory();
1212              var listServer = new TestMailmanServer();
1213              var webrevServer = new TestWebrevServer()) {
1214             var author = credentials.getHostedRepository();
1215             var archive = credentials.getHostedRepository();
1216             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1217             var censusBuilder = credentials.getCensusBuilder()
1218                                            .addAuthor(author.forge().currentUser().id());
1219             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1220             var mlBot = MailingListBridgeBot.newBuilder()
1221                                             .from(sender)
1222                                             .repo(author)
1223                                             .archive(archive)
1224                                             .archiveRef(&quot;archive&quot;)
1225                                             .censusRepo(censusBuilder.build())
1226                                             .list(listAddress)
1227                                             .listArchive(listServer.getArchive())
1228                                             .smtpServer(listServer.getSMTP())
1229                                             .webrevStorageRepository(archive)
1230                                             .webrevStorageRef(&quot;webrev&quot;)
1231                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1232                                             .webrevStorageBaseUri(webrevServer.uri())
1233                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1234                                             .build();
1235 
1236             // Populate the projects repository
1237             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1238             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1239             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1240             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1241             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1242             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1243 
1244             // Make a change with a corresponding PR
1245             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1246             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1247             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1248             pr.setBody(&quot;This is now ready&quot;);
1249 
1250             // Run an archive pass
1251             TestBotRunner.runPeriodicItems(mlBot);
1252             listServer.processIncoming();
1253 
1254             // Push more stuff to master
1255             localRepo.checkout(masterHash, true);
1256             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1257             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1258             localRepo.add(unrelatedFile);
1259             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1260             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1261 
1262             // And more stuff to the pr branch
1263             localRepo.checkout(editHash, true);
1264             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1265 
1266             // Merge master
1267             localRepo.merge(newMasterHash);
1268             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1269             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1270 
1271             // Make sure that the push registered
1272             var lastHeadHash = pr.headHash();
1273             var refreshCount = 0;
1274             do {
1275                 pr = author.pullRequest(pr.id());
1276                 if (refreshCount++ &gt; 100) {
1277                     fail(&quot;The PR did not update after the new push&quot;);
1278                 }
1279             } while (pr.headHash().equals(lastHeadHash));
1280 
1281             // Run another archive pass
1282             TestBotRunner.runPeriodicItems(mlBot);
1283             listServer.processIncoming();
1284 
1285             // The archive should reference the rebased push
1286             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1287             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));
1288             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes the unrelated changes&quot;));
1289             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1290             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1291             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1292             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1293         }
1294     }
1295 
1296     @Test
1297     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1298         try (var credentials = new HostCredentials(testInfo);
1299              var tempFolder = new TemporaryDirectory();
1300              var archiveFolder = new TemporaryDirectory();
1301              var webrevFolder = new TemporaryDirectory();
1302              var listServer = new TestMailmanServer();
1303              var webrevServer = new TestWebrevServer()) {
1304             var author = credentials.getHostedRepository();
1305             var archive = credentials.getHostedRepository();
1306             var ignored = credentials.getHostedRepository();
1307             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1308             var censusBuilder = credentials.getCensusBuilder()
1309                                            .addAuthor(author.forge().currentUser().id());
1310             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1311             var mlBot = MailingListBridgeBot.newBuilder()
1312                                             .from(from)
1313                                             .repo(author)
1314                                             .archive(archive)
1315                                             .censusRepo(censusBuilder.build())
1316                                             .list(listAddress)
1317                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1318                                             .listArchive(listServer.getArchive())
1319                                             .smtpServer(listServer.getSMTP())
1320                                             .webrevStorageRepository(archive)
1321                                             .webrevStorageRef(&quot;webrev&quot;)
1322                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1323                                             .webrevStorageBaseUri(webrevServer.uri())
1324                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1325                                             .build();
1326 
1327             // Populate the projects repository
1328             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1329             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1330             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1331             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1332 
1333             // Make a change with a corresponding PR
1334             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1335                                                                &quot;Change msg\n\nWith several lines&quot;);
1336             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1337             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1338 
1339             // Flag it as ready for review
1340             pr.setBody(&quot;This should now be ready&quot;);
1341 
1342             // Run an archive pass
1343             TestBotRunner.runPeriodicItems(mlBot);
1344 
1345             // The archive should now contain an entry
1346             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1347             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
1348 
1349             // And there should be a webrev comment
1350             var comments = pr.comments();
1351             var webrevComments = comments.stream()
1352                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1353                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1354                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1355                                          .collect(Collectors.toList());
1356             assertEquals(1, webrevComments.size());
1357             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1358 
1359             // Pretend the archive didn&#39;t work out
1360             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
1361 
1362             // Run another archive pass
1363             TestBotRunner.runPeriodicItems(mlBot);
1364 
1365             // The webrev comment should not contain duplicate entries
1366             comments = pr.comments();
1367             webrevComments = comments.stream()
1368                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1369                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1370                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
1371                                      .collect(Collectors.toList());
1372             assertEquals(1, webrevComments.size());
1373             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1374         }
1375     }
1376 
1377     @Test
1378     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1379         try (var credentials = new HostCredentials(testInfo);
1380              var tempFolder = new TemporaryDirectory();
1381              var archiveFolder = new TemporaryDirectory();
1382              var listServer = new TestMailmanServer();
1383              var webrevServer = new TestWebrevServer()) {
1384             var author = credentials.getHostedRepository();
1385             var archive = credentials.getHostedRepository();
1386             var reviewer = credentials.getHostedRepository();
1387             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1388             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1389             var censusBuilder = credentials.getCensusBuilder()
1390                                            .addReviewer(reviewer.forge().currentUser().id())
1391                                            .addAuthor(author.forge().currentUser().id());
1392             var mlBot = MailingListBridgeBot.newBuilder()
1393                                             .from(from)
1394                                             .repo(author)
1395                                             .archive(archive)
1396                                             .censusRepo(censusBuilder.build())
1397                                             .list(listAddress)
1398                                             .listArchive(listServer.getArchive())
1399                                             .smtpServer(listServer.getSMTP())
1400                                             .webrevStorageRepository(archive)
1401                                             .webrevStorageRef(&quot;webrev&quot;)
1402                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1403                                             .webrevStorageBaseUri(webrevServer.uri())
1404                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1405                                             .build();
1406 
1407             // Populate the projects repository
1408             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1409             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1410             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1411             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1412             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1413 
1414             // Make a change with a corresponding PR
1415             var editHash = CheckableRepository.appendAndCommit(localRepo);
1416             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1417             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1418             pr.setBody(&quot;This is now ready&quot;);
1419 
1420             // Run an archive pass
1421             TestBotRunner.runPeriodicItems(mlBot);
1422 
1423             // First unapprove it
1424             var reviewedPr = reviewer.pullRequest(pr.id());
1425             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1426             TestBotRunner.runPeriodicItems(mlBot);
1427             TestBotRunner.runPeriodicItems(mlBot);
1428             TestBotRunner.runPeriodicItems(mlBot);
1429 
1430             // The archive should contain a note
1431             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1432             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1433             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1434             if (author.forge().supportsReviewBody()) {
1435                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1436             }
1437 
1438             // Then approve it
1439             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1440             TestBotRunner.runPeriodicItems(mlBot);
1441             TestBotRunner.runPeriodicItems(mlBot);
1442             TestBotRunner.runPeriodicItems(mlBot);
1443 
1444             // The archive should contain another note
1445             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1446             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
1447             if (author.forge().supportsReviewBody()) {
1448                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1449             }
1450             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
1451 
1452             // Yet another change
1453             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1454             TestBotRunner.runPeriodicItems(mlBot);
1455             TestBotRunner.runPeriodicItems(mlBot);
1456             TestBotRunner.runPeriodicItems(mlBot);
1457 
1458             // The archive should contain another note
1459             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1460             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1461             if (author.forge().supportsReviewBody()) {
1462                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1463             }
1464         }
1465     }
1466 
1467     @Test
1468     void ignoreComments(TestInfo testInfo) throws IOException {
1469         try (var credentials = new HostCredentials(testInfo);
1470              var tempFolder = new TemporaryDirectory();
1471              var archiveFolder = new TemporaryDirectory();
1472              var listServer = new TestMailmanServer();
1473              var webrevServer = new TestWebrevServer()) {
1474             var author = credentials.getHostedRepository();
1475             var ignored = credentials.getHostedRepository();
1476             var archive = credentials.getHostedRepository();
1477             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1478             var censusBuilder = credentials.getCensusBuilder()
1479                                            .addAuthor(author.forge().currentUser().id());
1480             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1481             var mlBot = MailingListBridgeBot.newBuilder()
1482                                             .from(from)
1483                                             .repo(author)
1484                                             .archive(archive)
1485                                             .censusRepo(censusBuilder.build())
1486                                             .list(listAddress)
1487                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1488                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
1489                                             .listArchive(listServer.getArchive())
1490                                             .smtpServer(listServer.getSMTP())
1491                                             .webrevStorageRepository(archive)
1492                                             .webrevStorageRef(&quot;webrev&quot;)
1493                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1494                                             .webrevStorageBaseUri(webrevServer.uri())
1495                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1496                                             .build();
1497 
1498             // Populate the projects repository
1499             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1500             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1501             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1502             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1503             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1504 
1505             // Make a change with a corresponding PR
1506             var editHash = CheckableRepository.appendAndCommit(localRepo);
1507             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1508             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1509             pr.setBody(&quot;This is now ready&quot;);
1510 
1511             // Make a bunch of comments
1512             pr.addComment(&quot;Plain comment&quot;);
1513             pr.addComment(&quot;ignore this comment&quot;);
1514             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1515             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1516 
1517             var ignoredPR = ignored.pullRequest(pr.id());
1518             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1519 
1520             TestBotRunner.runPeriodicItems(mlBot);
1521             TestBotRunner.runPeriodicItems(mlBot);
1522 
1523             // The archive should not contain the ignored comments
1524             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1525             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1526             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1527             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1528             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1529             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1530         }
1531     }
1532 
1533     @Test
1534     void replyToEmptyReview(TestInfo testInfo) throws IOException {
1535         try (var credentials = new HostCredentials(testInfo);
1536              var tempFolder = new TemporaryDirectory();
1537              var archiveFolder = new TemporaryDirectory();
1538              var listServer = new TestMailmanServer();
1539              var webrevServer = new TestWebrevServer()) {
1540             var author = credentials.getHostedRepository();
1541             var reviewer = credentials.getHostedRepository();
1542             var archive = credentials.getHostedRepository();
1543             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1544             var censusBuilder = credentials.getCensusBuilder()
1545                                            .addReviewer(reviewer.forge().currentUser().id())
1546                                            .addAuthor(author.forge().currentUser().id());
1547             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1548             var mlBot = MailingListBridgeBot.newBuilder()
1549                                             .from(from)
1550                                             .repo(author)
1551                                             .archive(archive)
1552                                             .censusRepo(censusBuilder.build())
1553                                             .list(listAddress)
1554                                             .listArchive(listServer.getArchive())
1555                                             .smtpServer(listServer.getSMTP())
1556                                             .webrevStorageRepository(archive)
1557                                             .webrevStorageRef(&quot;webrev&quot;)
1558                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1559                                             .webrevStorageBaseUri(webrevServer.uri())
1560                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1561                                             .build();
1562 
1563             // Populate the projects repository
1564             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1565             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1566             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1567             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1568             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1569 
1570             // Make a change with a corresponding PR
1571             var editHash = CheckableRepository.appendAndCommit(localRepo);
1572             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1573             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1574             pr.setBody(&quot;This is now ready&quot;);
1575             TestBotRunner.runPeriodicItems(mlBot);
1576             listServer.processIncoming();
1577 
1578             // Make an empty approval
1579             var reviewPr = reviewer.pullRequest(pr.id());
1580             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
1581             TestBotRunner.runPeriodicItems(mlBot);
1582             listServer.processIncoming();
1583 
1584             pr.addComment(&quot;Thanks for the review!&quot;);
1585             TestBotRunner.runPeriodicItems(mlBot);
1586             listServer.processIncoming();
1587 
1588             // The approval text should be included in the quote
1589             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1590             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
1591         }
1592     }
1593 
1594     @Test
1595     void cooldown(TestInfo testInfo) throws IOException {
1596         try (var credentials = new HostCredentials(testInfo);
1597              var tempFolder = new TemporaryDirectory();
1598              var archiveFolder = new TemporaryDirectory();
1599              var listServer = new TestMailmanServer();
1600              var webrevServer = new TestWebrevServer()) {
1601             var bot = credentials.getHostedRepository();
1602             var author = credentials.getHostedRepository();
1603             var archive = credentials.getHostedRepository();
1604             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1605             var censusBuilder = credentials.getCensusBuilder()
1606                                            .addAuthor(author.forge().currentUser().id());
1607             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1608             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1609                                                    .from(from)
1610                                                    .repo(bot)
1611                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1612                                                    .archive(archive)
1613                                                    .censusRepo(censusBuilder.build())
1614                                                    .list(listAddress)
1615                                                    .listArchive(listServer.getArchive())
1616                                                    .smtpServer(listServer.getSMTP())
1617                                                    .webrevStorageRepository(archive)
1618                                                    .webrevStorageRef(&quot;webrev&quot;)
1619                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1620                                                    .webrevStorageBaseUri(webrevServer.uri())
1621                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1622 
1623             // Populate the projects repository
1624             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1625             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1626             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1627             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1628             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1629 
1630             // Make a change with a corresponding PR
1631             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1632             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1633             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1634             pr.setBody(&quot;This is now ready&quot;);
1635 
1636             var mlBot = mlBotBuilder.build();
1637             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
1638 
1639             TestBotRunner.runPeriodicItems(mlBot);
1640             listServer.processIncoming();
1641 
1642             // Make a comment
1643             pr.addComment(&quot;Looks good&quot;);
1644 
1645             // Bot with cooldown configured should not bridge the comment
1646             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
1647             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1648 
1649             // But without, it should
1650             TestBotRunner.runPeriodicItems(mlBot);
1651             listServer.processIncoming();
1652 
1653             // Check the archive
1654             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1655             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));
1656         }
1657     }
1658 
1659     @Test
1660     void cooldownNewRevision(TestInfo testInfo) throws IOException {
1661         try (var credentials = new HostCredentials(testInfo);
1662              var tempFolder = new TemporaryDirectory();
1663              var archiveFolder = new TemporaryDirectory();
1664              var listServer = new TestMailmanServer();
1665              var webrevServer = new TestWebrevServer()) {
1666             var bot = credentials.getHostedRepository();
1667             var author = credentials.getHostedRepository();
1668             var archive = credentials.getHostedRepository();
1669             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1670             var censusBuilder = credentials.getCensusBuilder()
1671                                            .addAuthor(author.forge().currentUser().id());
1672             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1673             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1674                                                    .from(from)
1675                                                    .repo(bot)
1676                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1677                                                    .archive(archive)
1678                                                    .censusRepo(censusBuilder.build())
1679                                                    .list(listAddress)
1680                                                    .listArchive(listServer.getArchive())
1681                                                    .smtpServer(listServer.getSMTP())
1682                                                    .webrevStorageRepository(archive)
1683                                                    .webrevStorageRef(&quot;webrev&quot;)
1684                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1685                                                    .webrevStorageBaseUri(webrevServer.uri())
1686                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1687 
1688             // Populate the projects repository
1689             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1690             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1691             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1692             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1693             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1694 
1695             // Make a change with a corresponding PR
1696             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1697             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1698             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1699             pr.setBody(&quot;This is now ready&quot;);
1700 
1701             var mlBot = mlBotBuilder.build();
1702             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
1703 
1704             TestBotRunner.runPeriodicItems(mlBot);
1705             listServer.processIncoming();
1706 
1707             // Commit another revision
1708             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
1709             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
1710 
1711             // Bot with cooldown configured should not create a new webrev
1712             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
1713             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1714 
1715             // But without, it should
1716             TestBotRunner.runPeriodicItems(mlBot);
1717             listServer.processIncoming();
1718 
1719             // Check the archive
1720             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1721             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.01&quot;));
1722         }
1723     }
1724 
1725     @Test
1726     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
1727         try (var credentials = new HostCredentials(testInfo);
1728              var tempFolder = new TemporaryDirectory();
1729              var archiveFolder = new TemporaryDirectory();
1730              var listServer = new TestMailmanServer();
1731              var webrevServer = new TestWebrevServer()) {
1732             var bot = credentials.getHostedRepository();
1733             var author = credentials.getHostedRepository();
1734             var archive = credentials.getHostedRepository();
1735             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1736             var censusBuilder = credentials.getCensusBuilder()
1737                                            .addAuthor(author.forge().currentUser().id());
1738             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1739             var cooldown = Duration.ofMillis(500);
1740             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1741                                                    .from(from)
1742                                                    .repo(bot)
1743                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1744                                                    .archive(archive)
1745                                                    .censusRepo(censusBuilder.build())
1746                                                    .list(listAddress)
1747                                                    .listArchive(listServer.getArchive())
1748                                                    .smtpServer(listServer.getSMTP())
1749                                                    .webrevStorageRepository(archive)
1750                                                    .webrevStorageRef(&quot;webrev&quot;)
1751                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1752                                                    .webrevStorageBaseUri(webrevServer.uri())
1753                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1754 
1755             // Populate the projects repository
1756             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1757             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1758             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1759             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1760             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1761 
1762             // Make a change with a corresponding PR
1763             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1764             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1765             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1766             pr.setBody(&quot;This is now ready&quot;);
1767 
1768             var mlBot = mlBotBuilder.cooldown(cooldown).build();
1769             Thread.sleep(cooldown.toMillis());
1770             TestBotRunner.runPeriodicItems(mlBot);
1771             listServer.processIncoming();
1772 
1773             // Make a comment and run the check within the cooldown period
1774             int counter;
1775             boolean noMailReceived = false;
1776             for (counter = 1; counter &lt; 10; ++counter) {
1777                 var start = Instant.now();
1778                 pr.addComment(&quot;Looks good - &quot; + counter + &quot; -&quot;);
1779 
1780                 // The bot should not bridge the comment due to cooldown
1781                 TestBotRunner.runPeriodicItems(mlBot);
1782                 try {
1783                     noMailReceived = false;
1784                     listServer.processIncoming(Duration.ofMillis(1));
1785                 } catch (RuntimeException e) {
1786                     noMailReceived = true;
1787                 }
1788                 var elapsed = Duration.between(start, Instant.now());
1789                 if (elapsed.compareTo(cooldown) &lt; 0) {
1790                     break;
1791                 } else {
1792                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
1793                     // Ensure that the cooldown expires
1794                     Thread.sleep(cooldown.toMillis());
1795                     // If no mail was received, we have to flush it out
1796                     if (noMailReceived) {
1797                         TestBotRunner.runPeriodicItems(mlBot);
1798                         listServer.processIncoming();
1799                     }
1800                     cooldown = cooldown.multipliedBy(2);
1801                     mlBot = mlBotBuilder.cooldown(cooldown).build();
1802                 }
1803             }
1804             assertTrue(noMailReceived);
1805 
1806             // But after the cooldown period has passed, it should
1807             Thread.sleep(cooldown.toMillis());
1808             TestBotRunner.runPeriodicItems(mlBot);
1809             listServer.processIncoming();
1810 
1811             // Check the archive
1812             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1813             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good - &quot; + counter + &quot; -&quot;));
1814         }
1815     }
1816 
1817     @Test
1818     void branchPrefix(TestInfo testInfo) throws IOException {
1819         try (var credentials = new HostCredentials(testInfo);
1820              var tempFolder = new TemporaryDirectory();
1821              var archiveFolder = new TemporaryDirectory();
1822              var listServer = new TestMailmanServer();
1823              var webrevServer = new TestWebrevServer()) {
1824             var author = credentials.getHostedRepository();
1825             var archive = credentials.getHostedRepository();
1826             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1827             var censusBuilder = credentials.getCensusBuilder()
1828                                            .addAuthor(author.forge().currentUser().id());
1829             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1830             var mlBot = MailingListBridgeBot.newBuilder()
1831                                             .from(from)
1832                                             .repo(author)
1833                                             .archive(archive)
1834                                             .censusRepo(censusBuilder.build())
1835                                             .list(listAddress)
1836                                             .listArchive(listServer.getArchive())
1837                                             .smtpServer(listServer.getSMTP())
1838                                             .webrevStorageRepository(archive)
1839                                             .webrevStorageRef(&quot;webrev&quot;)
1840                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1841                                             .webrevStorageBaseUri(webrevServer.uri())
1842                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1843                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
1844                                             .build();
1845 
1846             // Populate the projects repository
1847             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1848             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1849             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1850             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1851 
1852             // Make a change with a corresponding PR
1853             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1854                                                                &quot;Change msg\n\nWith several lines&quot;);
1855             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1856             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
1857             pr.setBody(&quot;This is a PR&quot;);
1858 
1859             // Run an archive pass
1860             TestBotRunner.runPeriodicItems(mlBot);
1861             listServer.processIncoming();
1862 
1863             pr.addComment(&quot;Looks good!&quot;);
1864             TestBotRunner.runPeriodicItems(mlBot);
1865             listServer.processIncoming();
1866 
1867             // Check the archive
1868             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1869             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[master\\] RFR: &quot;));
1870             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[master\\] RFR: &quot;));
1871         }
1872     }
1873 
1874     @Test
1875     void repoPrefix(TestInfo testInfo) throws IOException {
1876         try (var credentials = new HostCredentials(testInfo);
1877              var tempFolder = new TemporaryDirectory();
1878              var archiveFolder = new TemporaryDirectory();
1879              var listServer = new TestMailmanServer();
1880              var webrevServer = new TestWebrevServer()) {
1881             var author = credentials.getHostedRepository();
1882             var archive = credentials.getHostedRepository();
1883             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1884             var censusBuilder = credentials.getCensusBuilder()
1885                                            .addAuthor(author.forge().currentUser().id());
1886             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1887             var mlBot = MailingListBridgeBot.newBuilder()
1888                                             .from(from)
1889                                             .repo(author)
1890                                             .archive(archive)
1891                                             .censusRepo(censusBuilder.build())
1892                                             .list(listAddress)
1893                                             .listArchive(listServer.getArchive())
1894                                             .smtpServer(listServer.getSMTP())
1895                                             .webrevStorageRepository(archive)
1896                                             .webrevStorageRef(&quot;webrev&quot;)
1897                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1898                                             .webrevStorageBaseUri(webrevServer.uri())
1899                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1900                                             .repoInSubject(true)
1901                                             .build();
1902 
1903             // Populate the projects repository
1904             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1905             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1906             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1907             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1908 
1909             // Make a change with a corresponding PR
1910             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1911                                                                &quot;Change msg\n\nWith several lines&quot;);
1912             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1913             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
1914             pr.setBody(&quot;This is a PR&quot;);
1915 
1916             // Run an archive pass
1917             TestBotRunner.runPeriodicItems(mlBot);
1918             listServer.processIncoming();
1919 
1920             pr.addComment(&quot;Looks good!&quot;);
1921             TestBotRunner.runPeriodicItems(mlBot);
1922             listServer.processIncoming();
1923 
1924             // Check the archive
1925             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1926             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
1927             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
1928         }
1929     }
1930 
1931     @Test
1932     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
1933         try (var credentials = new HostCredentials(testInfo);
1934              var tempFolder = new TemporaryDirectory();
1935              var archiveFolder = new TemporaryDirectory();
1936              var listServer = new TestMailmanServer();
1937              var webrevServer = new TestWebrevServer()) {
1938             var author = credentials.getHostedRepository();
1939             var archive = credentials.getHostedRepository();
1940             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1941             var censusBuilder = credentials.getCensusBuilder()
1942                                            .addAuthor(author.forge().currentUser().id());
1943             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1944             var mlBot = MailingListBridgeBot.newBuilder()
1945                                             .from(from)
1946                                             .repo(author)
1947                                             .archive(archive)
1948                                             .censusRepo(censusBuilder.build())
1949                                             .list(listAddress)
1950                                             .listArchive(listServer.getArchive())
1951                                             .smtpServer(listServer.getSMTP())
1952                                             .webrevStorageRepository(archive)
1953                                             .webrevStorageRef(&quot;webrev&quot;)
1954                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1955                                             .webrevStorageBaseUri(webrevServer.uri())
1956                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1957                                             .repoInSubject(true)
1958                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
1959                                             .build();
1960 
1961             // Populate the projects repository
1962             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1963             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1964             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1965             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1966 
1967             // Make a change with a corresponding PR
1968             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1969                                                                &quot;Change msg\n\nWith several lines&quot;);
1970             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1971             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
1972             pr.setBody(&quot;This is a PR&quot;);
1973 
1974             // Run an archive pass
1975             TestBotRunner.runPeriodicItems(mlBot);
1976             listServer.processIncoming();
1977 
1978             pr.addComment(&quot;Looks good!&quot;);
1979             TestBotRunner.runPeriodicItems(mlBot);
1980             listServer.processIncoming();
1981 
1982             // Check the archive
1983             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1984             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
1985             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
1986         }
1987     }
1988 
1989     @Test
1990     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
1991         try (var credentials = new HostCredentials(testInfo);
1992              var tempFolder = new TemporaryDirectory();
1993              var archiveFolder = new TemporaryDirectory();
1994              var listServer = new TestMailmanServer();
1995              var webrevServer = new TestWebrevServer()) {
1996             var bot = credentials.getHostedRepository();
1997             var author = credentials.getHostedRepository();
1998             var archive = credentials.getHostedRepository();
1999             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2000             var censusBuilder = credentials.getCensusBuilder()
2001                                            .addAuthor(author.forge().currentUser().id());
2002             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2003             var cooldown = Duration.ofMillis(500);
2004             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2005                                                    .from(from)
2006                                                    .repo(bot)
2007                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2008                                                    .archive(archive)
2009                                                    .censusRepo(censusBuilder.build())
2010                                                    .list(listAddress)
2011                                                    .listArchive(listServer.getArchive())
2012                                                    .smtpServer(listServer.getSMTP())
2013                                                    .webrevStorageRepository(archive)
2014                                                    .webrevStorageRef(&quot;webrev&quot;)
2015                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2016                                                    .webrevStorageBaseUri(webrevServer.uri())
2017                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2018 
2019             // Populate the projects repository
2020             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2021             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2022             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2023             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2024             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2025 
2026             // Make a change with a corresponding PR
2027             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2028             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2029             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2030             pr.setBody(&quot;This is now ready&quot;);
2031 
2032             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2033             Thread.sleep(cooldown.toMillis());
2034             TestBotRunner.runPeriodicItems(mlBot);
2035             listServer.processIncoming();
2036 
2037             // Make a new revision and run the check within the cooldown period
2038             int counter;
2039             boolean noMailReceived = false;
2040             for (counter = 1; counter &lt; 10; ++counter) {
2041                 var start = Instant.now();
2042                 var revHash = CheckableRepository.appendAndCommit(localRepo, &quot;more stuff&quot;, &quot;Update number - &quot; + counter + &quot; -&quot;);
2043                 localRepo.push(revHash, author.url(), &quot;edit&quot;);
2044 
2045                 // The bot should not bridge the new revision due to cooldown
2046                 TestBotRunner.runPeriodicItems(mlBot);
2047                 try {
2048                     noMailReceived = false;
2049                     listServer.processIncoming(Duration.ofMillis(1));
2050                 } catch (RuntimeException e) {
2051                     noMailReceived = true;
2052                 }
2053                 var elapsed = Duration.between(start, Instant.now());
2054                 if (elapsed.compareTo(cooldown) &lt; 0) {
2055                     break;
2056                 } else {
2057                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2058                     // Ensure that the cooldown expires
2059                     Thread.sleep(cooldown.toMillis());
2060                     // If no mail was received, we have to flush it out
2061                     if (noMailReceived) {
2062                         TestBotRunner.runPeriodicItems(mlBot);
2063                         listServer.processIncoming();
2064                     }
2065                     cooldown = cooldown.multipliedBy(2);
2066                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2067                 }
2068             }
2069             assertTrue(noMailReceived);
2070 
2071             // But after the cooldown period has passed, it should
2072             Thread.sleep(cooldown.toMillis());
2073             TestBotRunner.runPeriodicItems(mlBot);
2074             listServer.processIncoming();
2075 
2076             // Check the archive
2077             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2078             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
2079         }
2080     }
2081 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>