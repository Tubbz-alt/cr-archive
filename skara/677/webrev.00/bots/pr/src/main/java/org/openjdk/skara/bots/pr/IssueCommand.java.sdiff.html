<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/IssueCommand.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IntegrateCommand.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="LabelCommand.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/IssueCommand.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.pr;
 24 
<span class="line-modified"> 25 import org.openjdk.skara.forge.PullRequest;</span>

 26 import org.openjdk.skara.issuetracker.Comment;

 27 import org.openjdk.skara.vcs.openjdk.Issue;
 28 
 29 import java.io.PrintWriter;
 30 import java.nio.file.Path;
 31 import java.util.*;
 32 import java.util.regex.Pattern;
 33 import java.util.stream.Collectors;
 34 
 35 class InvalidIssue extends Exception {
 36     private String identifier;
 37     private String reason;
 38 
 39     InvalidIssue(String identifier, String reason) {
 40         this.identifier = identifier;
 41         this.reason = reason;
 42     }
 43 
 44     String identifier() {
 45         return identifier;
 46     }
 47 
 48     String reason() {
 49         return reason;
 50     }
 51 }
 52 
 53 public class IssueCommand implements CommandHandler {
 54     private final String name;
 55 
 56     private void showHelp(PrintWriter reply) {
<span class="line-modified"> 57         reply.println(&quot;Command syntax: `/&quot; + name + &quot; [add|remove] &lt;id&gt;[,&lt;id&gt;,...]` or `/issue [add] &lt;id&gt;: &lt;description&gt;`. For example:&quot;);</span>





 58         reply.println();
 59         reply.println(&quot; * `/&quot; + name + &quot; add JDK-1234567,4567890`&quot;);
 60         reply.println(&quot; * `/&quot; + name + &quot; remove JDK-4567890`&quot;);
 61         reply.println(&quot; * `/&quot; + name + &quot; 1234567: Use this exact title`&quot;);


 62         reply.println();
 63         reply.print(&quot;If issues are specified only by their ID, the title will be automatically retrieved from JBS. &quot;);
 64         reply.print(&quot;The project prefix (`JDK-` in the above examples) is optional. &quot;);
 65         reply.println(&quot;Separate multiple issue IDs using either spaces or commas.&quot;);
 66     }
 67 
 68     private static final Pattern shortIssuePattern = Pattern.compile(&quot;((?:[A-Za-z]+-)?[0-9]+)(?:,| |$)&quot;);
<span class="line-modified"> 69     private final static Pattern subCommandPattern = Pattern.compile(&quot;^(add|remove|delete|(?:[A-Za-z]+-)?[0-9]+:?)[ ,]?.*$&quot;);</span>
 70 
 71     private List&lt;Issue&gt; parseIssueList(String allowedPrefix, String issueList) throws InvalidIssue {
 72         List&lt;Issue&gt; ret;
 73         // Is this a single fully described issue?
 74         var singleIssue = Issue.fromString(issueList);
 75         if (singleIssue.isPresent()) {
 76             ret = List.of(singleIssue.get());
 77         } else {
 78             var shortIssueMatcher = shortIssuePattern.matcher(issueList);
 79             ret = shortIssueMatcher.results()
 80                                    .map(matchResult -&gt; matchResult.group(1))
 81                                    .map(identifier -&gt; new Issue(identifier, null))
 82                                    .collect(Collectors.toList());
 83         }
 84         for (var issue : ret) {
 85             if (issue.project().isPresent() &amp;&amp; !issue.project().get().equalsIgnoreCase(allowedPrefix)) {
 86                 throw new InvalidIssue(issue.id(), &quot;This PR can only solve issues in the &quot; + allowedPrefix + &quot; project&quot;);
 87             }
 88         }
 89 
 90         return ret;
 91     }
 92 
 93     IssueCommand(String name) {
 94         this.name = name;
 95     }
 96 
 97     IssueCommand() {
 98         this(&quot;issue&quot;);
 99     }
100 


























































































































































































101     @Override
102     public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, String args, Comment comment, List&lt;Comment&gt; allComments, PrintWriter reply) {
103         if (!comment.author().equals(pr.author())) {
104             reply.println(&quot;Only the author (@&quot; + pr.author().userName() + &quot;) is allowed to issue the `/&quot; + name + &quot;` command.&quot;);
105             return;
106         }
107         if (args.isBlank()) {
108             showHelp(reply);
109             return;
110         }
111         var subCommandMatcher = subCommandPattern.matcher(args);
112         if (!subCommandMatcher.matches()) {
113             showHelp(reply);
114             return;
115         }
116 
117         var currentSolved = SolvesTracker.currentSolved(pr.repository().forge().currentUser(), allComments)
118                                          .stream()
119                                          .map(Issue::shortId)
120                                          .collect(Collectors.toSet());
121         try {
122             if (args.startsWith(&quot;remove&quot;) || args.startsWith(&quot;delete&quot;)) {
<span class="line-modified">123                 var issueListStart = args.indexOf(&#39; &#39;);</span>
<span class="line-modified">124                 if (issueListStart == -1) {</span>
<span class="line-modified">125                     showHelp(reply);</span>
<span class="line-removed">126                     return;</span>
<span class="line-removed">127                 }</span>
<span class="line-removed">128                 if (currentSolved.isEmpty()) {</span>
<span class="line-removed">129                     reply.println(&quot;This PR does not contain any additional solved issues that can be removed. To remove the primary solved issue, simply edit the title of this PR.&quot;);</span>
<span class="line-removed">130                     return;</span>
<span class="line-removed">131                 }</span>
<span class="line-removed">132                 var issuesToRemove = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args.substring(issueListStart));</span>
<span class="line-removed">133                 for (var issue : issuesToRemove) {</span>
<span class="line-removed">134                     if (currentSolved.contains(issue.shortId())) {</span>
<span class="line-removed">135                         reply.println(SolvesTracker.removeSolvesMarker(issue));</span>
<span class="line-removed">136                         reply.println(&quot;Removing additional issue from &quot; + name + &quot; list: `&quot; + issue.shortId() + &quot;`.&quot;);</span>
<span class="line-removed">137                     } else {</span>
<span class="line-removed">138                         reply.print(&quot;The issue `&quot; + issue.shortId() + &quot;` was not found in the list of additional solved issues. The list currently contains these issues: &quot;);</span>
<span class="line-removed">139                         var currentList = currentSolved.stream()</span>
<span class="line-removed">140                                                        .map(id -&gt; &quot;`&quot; + id + &quot;`&quot;)</span>
<span class="line-removed">141                                                        .collect(Collectors.joining(&quot;, &quot;));</span>
<span class="line-removed">142                         reply.println(currentList);</span>
<span class="line-removed">143                     }</span>
<span class="line-removed">144                 }</span>
145             } else {
<span class="line-modified">146                 if (args.startsWith(&quot;add&quot;)) {</span>
<span class="line-removed">147                     var issueListStart = args.indexOf(&#39; &#39;);</span>
<span class="line-removed">148                     if (issueListStart == -1) {</span>
<span class="line-removed">149                         showHelp(reply);</span>
<span class="line-removed">150                         return;</span>
<span class="line-removed">151                     }</span>
<span class="line-removed">152                     args = args.substring(issueListStart);</span>
<span class="line-removed">153                 }</span>
<span class="line-removed">154                 var issues = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args);</span>
<span class="line-removed">155                 if (issues.size() == 0) {</span>
<span class="line-removed">156                     showHelp(reply);</span>
<span class="line-removed">157                     return;</span>
<span class="line-removed">158                 }</span>
<span class="line-removed">159                 var validatedIssues = new ArrayList&lt;Issue&gt;();</span>
<span class="line-removed">160                 for (var issue : issues) {</span>
<span class="line-removed">161                     try {</span>
<span class="line-removed">162                         if (bot.issueProject() == null) {</span>
<span class="line-removed">163                             if (issue.description() == null) {</span>
<span class="line-removed">164                                 reply.print(&quot;This repository does not have an issue project configured - you will need to input the issue title manually &quot;);</span>
<span class="line-removed">165                                 reply.println(&quot;using the syntax `/&quot; + name + &quot; &quot; + issue.shortId() + &quot;: title of the issue`.&quot;);</span>
<span class="line-removed">166                                 return;</span>
<span class="line-removed">167                             } else {</span>
<span class="line-removed">168                                 validatedIssues.add(issue);</span>
<span class="line-removed">169                                 continue;</span>
<span class="line-removed">170                             }</span>
<span class="line-removed">171                         }</span>
<span class="line-removed">172                         var validatedIssue = bot.issueProject().issue(issue.shortId());</span>
<span class="line-removed">173                         if (validatedIssue.isEmpty()) {</span>
<span class="line-removed">174                             reply.println(&quot;The issue `&quot; + issue.shortId() + &quot;` was not found in the `&quot; + bot.issueProject().name() + &quot;` project - make sure you have entered it correctly.&quot;);</span>
<span class="line-removed">175                             continue;</span>
<span class="line-removed">176                         }</span>
<span class="line-removed">177                         if (validatedIssue.get().state() != org.openjdk.skara.issuetracker.Issue.State.OPEN) {</span>
<span class="line-removed">178                             reply.println(&quot;The issue [&quot; + validatedIssue.get().id() + &quot;](&quot; + validatedIssue.get().webUrl() + &quot;) isn&#39;t open - make sure you have selected the correct issue.&quot;);</span>
<span class="line-removed">179                             continue;</span>
<span class="line-removed">180                         }</span>
<span class="line-removed">181                         if (issue.description() == null) {</span>
<span class="line-removed">182                             validatedIssues.add(new Issue(validatedIssue.get().id(), validatedIssue.get().title()));</span>
<span class="line-removed">183                         } else {</span>
<span class="line-removed">184                             validatedIssues.add(new Issue(validatedIssue.get().id(), issue.description()));</span>
<span class="line-removed">185                         }</span>
<span class="line-removed">186 </span>
<span class="line-removed">187                     } catch (RuntimeException e) {</span>
<span class="line-removed">188                         if (issue.description() == null) {</span>
<span class="line-removed">189                             reply.print(&quot;Temporary failure when trying to look up issue `&quot; + issue.shortId() + &quot;` - you will need to input the issue title manually &quot;);</span>
<span class="line-removed">190                             reply.println(&quot;using the syntax `/&quot; + name + &quot; &quot; + issue.shortId() + &quot;: title of the issue`.&quot;);</span>
<span class="line-removed">191                             return;</span>
<span class="line-removed">192                         } else {</span>
<span class="line-removed">193                             validatedIssues.add(issue);</span>
<span class="line-removed">194                         }</span>
<span class="line-removed">195                     }</span>
<span class="line-removed">196                 }</span>
<span class="line-removed">197                 if (validatedIssues.size() != issues.size()) {</span>
<span class="line-removed">198                     reply.println(&quot;As there were validation problems, no additional issues will be added to the list of solved issues.&quot;);</span>
<span class="line-removed">199                     return;</span>
<span class="line-removed">200                 }</span>
<span class="line-removed">201 </span>
<span class="line-removed">202                 var titleIssue = Issue.fromStringRelaxed(pr.title());</span>
<span class="line-removed">203                 for (var issue : validatedIssues) {</span>
<span class="line-removed">204                     if (titleIssue.isEmpty()) {</span>
<span class="line-removed">205                         reply.print(&quot;The primary solved issue for a PR is set through the PR title. Since the current title does &quot;);</span>
<span class="line-removed">206                         reply.println(&quot;not contain an issue reference, it will now be updated.&quot;);</span>
<span class="line-removed">207                         pr.setTitle(issue.toShortString());</span>
<span class="line-removed">208                         titleIssue = Optional.of(issue);</span>
<span class="line-removed">209                         continue;</span>
<span class="line-removed">210                     }</span>
<span class="line-removed">211                     if (titleIssue.get().shortId().equals(issue.shortId())) {</span>
<span class="line-removed">212                         reply.println(&quot;This issue is referenced in the PR title - it will now be updated.&quot;);</span>
<span class="line-removed">213                         pr.setTitle(issue.toShortString());</span>
<span class="line-removed">214                         continue;</span>
<span class="line-removed">215                     }</span>
<span class="line-removed">216                     reply.println(SolvesTracker.setSolvesMarker(issue));</span>
<span class="line-removed">217                     if (currentSolved.contains(issue.shortId())) {</span>
<span class="line-removed">218                         reply.println(&quot;Updating description of additional solved issue: `&quot; + issue.toShortString() + &quot;`.&quot;);</span>
<span class="line-removed">219                     } else {</span>
<span class="line-removed">220                         reply.println(&quot;Adding additional issue to &quot; + name + &quot; list: `&quot; + issue.toShortString() + &quot;`.&quot;);</span>
<span class="line-removed">221                     }</span>
<span class="line-removed">222                 }</span>
223             }
<span class="line-removed">224 </span>
225         } catch (InvalidIssue invalidIssue) {
226             reply.println(&quot;The issue identifier `&quot; + invalidIssue.identifier() + &quot;` is invalid: &quot; + invalidIssue.reason() + &quot;.&quot;);
227         }
228     }
229 
230     @Override
231     public String description() {
232         return &quot;edit the list of issues that this PR solves&quot;;
233     }
234 }
</pre>
</td>
<td>
<hr />
<pre>
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.pr;
 24 
<span class="line-modified"> 25 import org.openjdk.skara.forge.*;</span>
<span class="line-added"> 26 import org.openjdk.skara.host.HostUser;</span>
 27 import org.openjdk.skara.issuetracker.Comment;
<span class="line-added"> 28 import org.openjdk.skara.json.*;</span>
 29 import org.openjdk.skara.vcs.openjdk.Issue;
 30 
 31 import java.io.PrintWriter;
 32 import java.nio.file.Path;
 33 import java.util.*;
 34 import java.util.regex.Pattern;
 35 import java.util.stream.Collectors;
 36 
 37 class InvalidIssue extends Exception {
 38     private String identifier;
 39     private String reason;
 40 
 41     InvalidIssue(String identifier, String reason) {
 42         this.identifier = identifier;
 43         this.reason = reason;
 44     }
 45 
 46     String identifier() {
 47         return identifier;
 48     }
 49 
 50     String reason() {
 51         return reason;
 52     }
 53 }
 54 
 55 public class IssueCommand implements CommandHandler {
 56     private final String name;
 57 
 58     private void showHelp(PrintWriter reply) {
<span class="line-modified"> 59         reply.println(&quot;Command syntax:&quot;);</span>
<span class="line-added"> 60         reply.println(&quot; * `/&quot; + name + &quot; [add|remove] &lt;id&gt;[,&lt;id&gt;,...]`&quot;);</span>
<span class="line-added"> 61         reply.println(&quot; * `/&quot; + name + &quot; [add] &lt;id&gt;: &lt;description&gt;`&quot;);</span>
<span class="line-added"> 62         reply.println(&quot; * `/&quot; + name + &quot; create [pX] [type] &lt;component&gt; [subcomponent]&quot;);</span>
<span class="line-added"> 63         reply.println();</span>
<span class="line-added"> 64         reply.println(&quot;Some examples:&quot;);</span>
 65         reply.println();
 66         reply.println(&quot; * `/&quot; + name + &quot; add JDK-1234567,4567890`&quot;);
 67         reply.println(&quot; * `/&quot; + name + &quot; remove JDK-4567890`&quot;);
 68         reply.println(&quot; * `/&quot; + name + &quot; 1234567: Use this exact title`&quot;);
<span class="line-added"> 69         reply.println(&quot; * `/&quot; + name + &quot; create hotspot jfr&quot;);</span>
<span class="line-added"> 70         reply.println(&quot; * `/&quot; + name + &quot; create P4 enhancement core-libs java.nio&quot;);</span>
 71         reply.println();
 72         reply.print(&quot;If issues are specified only by their ID, the title will be automatically retrieved from JBS. &quot;);
 73         reply.print(&quot;The project prefix (`JDK-` in the above examples) is optional. &quot;);
 74         reply.println(&quot;Separate multiple issue IDs using either spaces or commas.&quot;);
 75     }
 76 
 77     private static final Pattern shortIssuePattern = Pattern.compile(&quot;((?:[A-Za-z]+-)?[0-9]+)(?:,| |$)&quot;);
<span class="line-modified"> 78     private final static Pattern subCommandPattern = Pattern.compile(&quot;^(add|remove|delete|create|(?:[A-Za-z]+-)?[0-9]+:?)[ ,]?.*$&quot;);</span>
 79 
 80     private List&lt;Issue&gt; parseIssueList(String allowedPrefix, String issueList) throws InvalidIssue {
 81         List&lt;Issue&gt; ret;
 82         // Is this a single fully described issue?
 83         var singleIssue = Issue.fromString(issueList);
 84         if (singleIssue.isPresent()) {
 85             ret = List.of(singleIssue.get());
 86         } else {
 87             var shortIssueMatcher = shortIssuePattern.matcher(issueList);
 88             ret = shortIssueMatcher.results()
 89                                    .map(matchResult -&gt; matchResult.group(1))
 90                                    .map(identifier -&gt; new Issue(identifier, null))
 91                                    .collect(Collectors.toList());
 92         }
 93         for (var issue : ret) {
 94             if (issue.project().isPresent() &amp;&amp; !issue.project().get().equalsIgnoreCase(allowedPrefix)) {
 95                 throw new InvalidIssue(issue.id(), &quot;This PR can only solve issues in the &quot; + allowedPrefix + &quot; project&quot;);
 96             }
 97         }
 98 
 99         return ret;
100     }
101 
102     IssueCommand(String name) {
103         this.name = name;
104     }
105 
106     IssueCommand() {
107         this(&quot;issue&quot;);
108     }
109 
<span class="line-added">110     private void addIssue(PullRequestBot bot, PullRequest pr, String args, Set&lt;String&gt; currentSolved, PrintWriter reply) throws InvalidIssue {</span>
<span class="line-added">111         if (args.startsWith(&quot;add&quot;)) {</span>
<span class="line-added">112             var issueListStart = args.indexOf(&#39; &#39;);</span>
<span class="line-added">113             if (issueListStart == -1) {</span>
<span class="line-added">114                 showHelp(reply);</span>
<span class="line-added">115                 return;</span>
<span class="line-added">116             }</span>
<span class="line-added">117             args = args.substring(issueListStart);</span>
<span class="line-added">118         }</span>
<span class="line-added">119         var issues = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args);</span>
<span class="line-added">120         if (issues.size() == 0) {</span>
<span class="line-added">121             showHelp(reply);</span>
<span class="line-added">122             return;</span>
<span class="line-added">123         }</span>
<span class="line-added">124         var validatedIssues = new ArrayList&lt;Issue&gt;();</span>
<span class="line-added">125         for (var issue : issues) {</span>
<span class="line-added">126             try {</span>
<span class="line-added">127                 if (bot.issueProject() == null) {</span>
<span class="line-added">128                     if (issue.description() == null) {</span>
<span class="line-added">129                         reply.print(&quot;This repository does not have an issue project configured - you will need to input the issue title manually &quot;);</span>
<span class="line-added">130                         reply.println(&quot;using the syntax `/&quot; + name + &quot; &quot; + issue.shortId() + &quot;: title of the issue`.&quot;);</span>
<span class="line-added">131                         return;</span>
<span class="line-added">132                     } else {</span>
<span class="line-added">133                         validatedIssues.add(issue);</span>
<span class="line-added">134                         continue;</span>
<span class="line-added">135                     }</span>
<span class="line-added">136                 }</span>
<span class="line-added">137                 var validatedIssue = bot.issueProject().issue(issue.shortId());</span>
<span class="line-added">138                 if (validatedIssue.isEmpty()) {</span>
<span class="line-added">139                     reply.println(&quot;The issue `&quot; + issue.shortId() + &quot;` was not found in the `&quot; + bot.issueProject().name() + &quot;` project - make sure you have entered it correctly.&quot;);</span>
<span class="line-added">140                     continue;</span>
<span class="line-added">141                 }</span>
<span class="line-added">142                 if (validatedIssue.get().state() != org.openjdk.skara.issuetracker.Issue.State.OPEN) {</span>
<span class="line-added">143                     reply.println(&quot;The issue [&quot; + validatedIssue.get().id() + &quot;](&quot; + validatedIssue.get().webUrl() + &quot;) isn&#39;t open - make sure you have selected the correct issue.&quot;);</span>
<span class="line-added">144                     continue;</span>
<span class="line-added">145                 }</span>
<span class="line-added">146                 if (issue.description() == null) {</span>
<span class="line-added">147                     validatedIssues.add(new Issue(validatedIssue.get().id(), validatedIssue.get().title()));</span>
<span class="line-added">148                 } else {</span>
<span class="line-added">149                     validatedIssues.add(new Issue(validatedIssue.get().id(), issue.description()));</span>
<span class="line-added">150                 }</span>
<span class="line-added">151 </span>
<span class="line-added">152             } catch (RuntimeException e) {</span>
<span class="line-added">153                 if (issue.description() == null) {</span>
<span class="line-added">154                     reply.print(&quot;Temporary failure when trying to look up issue `&quot; + issue.shortId() + &quot;` - you will need to input the issue title manually &quot;);</span>
<span class="line-added">155                     reply.println(&quot;using the syntax `/&quot; + name + &quot; &quot; + issue.shortId() + &quot;: title of the issue`.&quot;);</span>
<span class="line-added">156                     return;</span>
<span class="line-added">157                 } else {</span>
<span class="line-added">158                     validatedIssues.add(issue);</span>
<span class="line-added">159                 }</span>
<span class="line-added">160             }</span>
<span class="line-added">161         }</span>
<span class="line-added">162         if (validatedIssues.size() != issues.size()) {</span>
<span class="line-added">163             reply.println(&quot;As there were validation problems, no additional issues will be added to the list of solved issues.&quot;);</span>
<span class="line-added">164             return;</span>
<span class="line-added">165         }</span>
<span class="line-added">166 </span>
<span class="line-added">167         var titleIssue = Issue.fromStringRelaxed(pr.title());</span>
<span class="line-added">168         for (var issue : validatedIssues) {</span>
<span class="line-added">169             if (titleIssue.isEmpty()) {</span>
<span class="line-added">170                 reply.print(&quot;The primary solved issue for a PR is set through the PR title. Since the current title does &quot;);</span>
<span class="line-added">171                 reply.println(&quot;not contain an issue reference, it will now be updated.&quot;);</span>
<span class="line-added">172                 pr.setTitle(issue.toShortString());</span>
<span class="line-added">173                 titleIssue = Optional.of(issue);</span>
<span class="line-added">174                 continue;</span>
<span class="line-added">175             }</span>
<span class="line-added">176             if (titleIssue.get().shortId().equals(issue.shortId())) {</span>
<span class="line-added">177                 reply.println(&quot;This issue is referenced in the PR title - it will now be updated.&quot;);</span>
<span class="line-added">178                 pr.setTitle(issue.toShortString());</span>
<span class="line-added">179                 continue;</span>
<span class="line-added">180             }</span>
<span class="line-added">181             reply.println(SolvesTracker.setSolvesMarker(issue));</span>
<span class="line-added">182             if (currentSolved.contains(issue.shortId())) {</span>
<span class="line-added">183                 reply.println(&quot;Updating description of additional solved issue: `&quot; + issue.toShortString() + &quot;`.&quot;);</span>
<span class="line-added">184             } else {</span>
<span class="line-added">185                 reply.println(&quot;Adding additional issue to &quot; + name + &quot; list: `&quot; + issue.toShortString() + &quot;`.&quot;);</span>
<span class="line-added">186             }</span>
<span class="line-added">187         }</span>
<span class="line-added">188     }</span>
<span class="line-added">189 </span>
<span class="line-added">190     private void removeIssue(PullRequestBot bot, String args, Set&lt;String&gt; currentSolved, PrintWriter reply) throws InvalidIssue {</span>
<span class="line-added">191         var issueListStart = args.indexOf(&#39; &#39;);</span>
<span class="line-added">192         if (issueListStart == -1) {</span>
<span class="line-added">193             showHelp(reply);</span>
<span class="line-added">194             return;</span>
<span class="line-added">195         }</span>
<span class="line-added">196         if (currentSolved.isEmpty()) {</span>
<span class="line-added">197             reply.println(&quot;This PR does not contain any additional solved issues that can be removed. To remove the primary solved issue, simply edit the title of this PR.&quot;);</span>
<span class="line-added">198             return;</span>
<span class="line-added">199         }</span>
<span class="line-added">200         var issuesToRemove = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args.substring(issueListStart));</span>
<span class="line-added">201         for (var issue : issuesToRemove) {</span>
<span class="line-added">202             if (currentSolved.contains(issue.shortId())) {</span>
<span class="line-added">203                 reply.println(SolvesTracker.removeSolvesMarker(issue));</span>
<span class="line-added">204                 reply.println(&quot;Removing additional issue from &quot; + name + &quot; list: `&quot; + issue.shortId() + &quot;`.&quot;);</span>
<span class="line-added">205             } else {</span>
<span class="line-added">206                 reply.print(&quot;The issue `&quot; + issue.shortId() + &quot;` was not found in the list of additional solved issues. The list currently contains these issues: &quot;);</span>
<span class="line-added">207                 var currentList = currentSolved.stream()</span>
<span class="line-added">208                                                .map(id -&gt; &quot;`&quot; + id + &quot;`&quot;)</span>
<span class="line-added">209                                                .collect(Collectors.joining(&quot;, &quot;));</span>
<span class="line-added">210                 reply.println(currentList);</span>
<span class="line-added">211             }</span>
<span class="line-added">212         }</span>
<span class="line-added">213     }</span>
<span class="line-added">214 </span>
<span class="line-added">215     private static final Set&lt;String&gt; allowedTypes = Set.of(&quot;bug&quot;, &quot;new&quot;, &quot;enhancement&quot;);</span>
<span class="line-added">216 </span>
<span class="line-added">217     private void createIssue(PullRequestBot bot, PullRequest pr, String args, CensusInstance censusInstance, HostUser author, PrintWriter reply) {</span>
<span class="line-added">218         if (!censusInstance.isAuthor(author)) {</span>
<span class="line-added">219             reply.println(&quot;Only [Authors](https://openjdk.java.net/bylaws#author) are allowed to create issues.&quot;);</span>
<span class="line-added">220             return;</span>
<span class="line-added">221         }</span>
<span class="line-added">222 </span>
<span class="line-added">223         var currentTitleIssue = Issue.fromString(pr.title());</span>
<span class="line-added">224         if (currentTitleIssue.isPresent()) {</span>
<span class="line-added">225             reply.println(&quot;The PR title already references an issue (`&quot; + currentTitleIssue.get().shortId() + &quot;`) - will not create a new one.&quot;);</span>
<span class="line-added">226             return;</span>
<span class="line-added">227         }</span>
<span class="line-added">228 </span>
<span class="line-added">229         var argSplit = new LinkedList&lt;&gt;(Arrays.asList(args.split(&quot;\\s+&quot;)));</span>
<span class="line-added">230         argSplit.pollFirst();</span>
<span class="line-added">231 </span>
<span class="line-added">232         String priority = null;</span>
<span class="line-added">233         String type = null;</span>
<span class="line-added">234         String subComponent = null;</span>
<span class="line-added">235 </span>
<span class="line-added">236         // First argument can be a priority</span>
<span class="line-added">237         var next = argSplit.pollFirst();</span>
<span class="line-added">238         if (next != null &amp;&amp; next.matches(&quot;^[pP]\\d$&quot;)) {</span>
<span class="line-added">239             priority = next.substring(1);</span>
<span class="line-added">240             next = argSplit.pollFirst();</span>
<span class="line-added">241         }</span>
<span class="line-added">242 </span>
<span class="line-added">243         // Second (and third) can be a known issue type</span>
<span class="line-added">244         if (next != null &amp;&amp; allowedTypes.contains(next.toLowerCase())) {</span>
<span class="line-added">245             if (next.equals(&quot;new&quot;)) {</span>
<span class="line-added">246                 next = argSplit.pollFirst();</span>
<span class="line-added">247                 if (next != null &amp;&amp; next.toLowerCase().equals(&quot;feature&quot;)) {</span>
<span class="line-added">248                     type = &quot;new feature&quot;;</span>
<span class="line-added">249                 } else {</span>
<span class="line-added">250                     // Undo the halfway mismatch</span>
<span class="line-added">251                     argSplit.offerFirst(next);</span>
<span class="line-added">252                     argSplit.offerFirst(&quot;new&quot;);</span>
<span class="line-added">253                 }</span>
<span class="line-added">254             } else {</span>
<span class="line-added">255                 type = next.toLowerCase();</span>
<span class="line-added">256             }</span>
<span class="line-added">257             next = argSplit.pollFirst();</span>
<span class="line-added">258         }</span>
<span class="line-added">259 </span>
<span class="line-added">260         // Next argument is the mandatory component name</span>
<span class="line-added">261         if (next == null) {</span>
<span class="line-added">262             showHelp(reply);</span>
<span class="line-added">263             return;</span>
<span class="line-added">264         }</span>
<span class="line-added">265         var component = next;</span>
<span class="line-added">266         next = argSplit.pollFirst();</span>
<span class="line-added">267 </span>
<span class="line-added">268         // Finally there can be a subcomponent present</span>
<span class="line-added">269         if (next != null) {</span>
<span class="line-added">270             subComponent = next;</span>
<span class="line-added">271         }</span>
<span class="line-added">272 </span>
<span class="line-added">273         var properties = new HashMap&lt;String, JSONValue&gt;();</span>
<span class="line-added">274         properties.put(&quot;components&quot;, JSON.array().add(JSON.of(component)));</span>
<span class="line-added">275         if (subComponent != null) {</span>
<span class="line-added">276             properties.put(&quot;customfield_10008&quot;, JSON.of(subComponent));</span>
<span class="line-added">277         }</span>
<span class="line-added">278         if (priority != null) {</span>
<span class="line-added">279             properties.put(&quot;priority&quot;, JSON.of(priority));</span>
<span class="line-added">280         }</span>
<span class="line-added">281         if (type != null) {</span>
<span class="line-added">282             properties.put(&quot;issuetype&quot;, JSON.of(type));</span>
<span class="line-added">283         }</span>
<span class="line-added">284 </span>
<span class="line-added">285         var bodyText = PullRequestBody.parse(pr).bodyText();</span>
<span class="line-added">286         try {</span>
<span class="line-added">287             var issue = bot.issueProject().createIssue(pr.title(), bodyText.lines().collect(Collectors.toList()), properties);</span>
<span class="line-added">288             reply.println(&quot;The issue `&quot; + issue.id() + &quot;` was successfully created - the title of this PR will be updated to reference it. &quot;);</span>
<span class="line-added">289             var shortId = issue.id().contains(&quot;-&quot;) ? issue.id().split(&quot;-&quot;, 2)[1] : issue.id();</span>
<span class="line-added">290             pr.setTitle(shortId + &quot;: &quot; + issue.title());</span>
<span class="line-added">291         } catch (RuntimeException e) {</span>
<span class="line-added">292             reply.println(&quot;An error occurred when attempting to create an issue: &quot; + e.getMessage());</span>
<span class="line-added">293         }</span>
<span class="line-added">294     }</span>
<span class="line-added">295 </span>
296     @Override
297     public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, String args, Comment comment, List&lt;Comment&gt; allComments, PrintWriter reply) {
298         if (!comment.author().equals(pr.author())) {
299             reply.println(&quot;Only the author (@&quot; + pr.author().userName() + &quot;) is allowed to issue the `/&quot; + name + &quot;` command.&quot;);
300             return;
301         }
302         if (args.isBlank()) {
303             showHelp(reply);
304             return;
305         }
306         var subCommandMatcher = subCommandPattern.matcher(args);
307         if (!subCommandMatcher.matches()) {
308             showHelp(reply);
309             return;
310         }
311 
312         var currentSolved = SolvesTracker.currentSolved(pr.repository().forge().currentUser(), allComments)
313                                          .stream()
314                                          .map(Issue::shortId)
315                                          .collect(Collectors.toSet());
316         try {
317             if (args.startsWith(&quot;remove&quot;) || args.startsWith(&quot;delete&quot;)) {
<span class="line-modified">318                 removeIssue(bot, args, currentSolved, reply);</span>
<span class="line-modified">319             } else if (args.startsWith(&quot;create&quot;)) {</span>
<span class="line-modified">320                 createIssue(bot, pr, args, censusInstance, comment.author(), reply);</span>



















321             } else {
<span class="line-modified">322                 addIssue(bot, pr, args, currentSolved, reply);</span>












































































323             }

324         } catch (InvalidIssue invalidIssue) {
325             reply.println(&quot;The issue identifier `&quot; + invalidIssue.identifier() + &quot;` is invalid: &quot; + invalidIssue.reason() + &quot;.&quot;);
326         }
327     }
328 
329     @Override
330     public String description() {
331         return &quot;edit the list of issues that this PR solves&quot;;
332     }
333 }
</pre>
</td>
</tr>
</table>
<center><a href="IntegrateCommand.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="LabelCommand.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>