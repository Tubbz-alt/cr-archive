<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff issuetracker/src/main/java/org/openjdk/skara/issuetracker/jira/JiraProject.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../../forge/src/main/java/org/openjdk/skara/forge/PullRequestBody.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>issuetracker/src/main/java/org/openjdk/skara/issuetracker/jira/JiraProject.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -36,10 +36,11 @@</span>
      private final String projectName;
      private final RestRequest request;
  
      private JSONObject projectMetadataCache = null;
      private List&lt;JiraLinkType&gt; linkTypes = null;
<span class="udiff-line-added">+     private JSONObject createMetaCache = null;</span>
  
      private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.issuetracker.jira&quot;);
  
      JiraProject(JiraHost host, RestRequest request, String projectName) {
          this.jiraHost = host;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -52,26 +53,59 @@</span>
              projectMetadataCache = request.get(&quot;project/&quot; + projectName).execute().asObject();
          }
          return projectMetadataCache;
      }
  
<span class="udiff-line-added">+     private JSONObject createMeta() {</span>
<span class="udiff-line-added">+         if (createMetaCache == null) {</span>
<span class="udiff-line-added">+             createMetaCache = request.get(&quot;issue/createmeta&quot;)</span>
<span class="udiff-line-added">+                                      .param(&quot;projectKeys&quot;, projectName)</span>
<span class="udiff-line-added">+                                      .param(&quot;expand&quot;, &quot;projects.issuetypes.fields&quot;)</span>
<span class="udiff-line-added">+                                      .execute()</span>
<span class="udiff-line-added">+                                      .asObject();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return createMetaCache;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private Map&lt;String, String&gt; issueTypes() {
<span class="udiff-line-modified-removed">-         var ret = new HashMap&lt;String, String&gt;();</span>
<span class="udiff-line-modified-added">+         var ret = new TreeMap&lt;String, String&gt;(String.CASE_INSENSITIVE_ORDER);</span>
          for (var type : project().get(&quot;issueTypes&quot;).asArray()) {
              ret.put(type.get(&quot;name&quot;).asString(), type.get(&quot;id&quot;).asString());
          }
          return ret;
      }
  
<span class="udiff-line-added">+     private String issueTypeId(String name) {</span>
<span class="udiff-line-added">+         var ret = issueTypes().get(name);</span>
<span class="udiff-line-added">+         if (ret == null) {</span>
<span class="udiff-line-added">+             var allowedList = issueTypes().keySet().stream()</span>
<span class="udiff-line-added">+                                           .map(s -&gt; &quot;`&quot; + s + &quot;`&quot;)</span>
<span class="udiff-line-added">+                                           .collect(Collectors.joining(&quot;, &quot;));</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;Unknown issue type `&quot; + name + &quot;`` Known issue types are &quot; + allowedList + &quot;.&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return ret;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private Map&lt;String, String&gt; components() {
          var ret = new HashMap&lt;String, String&gt;();
          for (var type : project().get(&quot;components&quot;).asArray()) {
              ret.put(type.get(&quot;name&quot;).asString(), type.get(&quot;id&quot;).asString());
          }
          return ret;
      }
  
<span class="udiff-line-added">+     private String componentId(String name) {</span>
<span class="udiff-line-added">+         var ret = components().get(name);</span>
<span class="udiff-line-added">+         if (ret == null) {</span>
<span class="udiff-line-added">+             var allowedList = components().keySet().stream()</span>
<span class="udiff-line-added">+                                           .map(s -&gt; &quot;`&quot; + s + &quot;`&quot;)</span>
<span class="udiff-line-added">+                                           .collect(Collectors.joining(&quot;, &quot;));</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;Unknown component `&quot; + name + &quot;`. Known components are &quot; + allowedList + &quot;.&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return ret;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private Map&lt;String, String&gt; versions() {
          var ret = new HashMap&lt;String, String&gt;();
          for (var type : project().get(&quot;versions&quot;).asArray()) {
              ret.put(type.get(&quot;name&quot;).asString(), type.get(&quot;id&quot;).asString());
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -146,10 +180,11 @@</span>
              case &quot;versions&quot;: // fall-through
              case &quot;components&quot;:
                  return Optional.of(new JSONArray(value.stream()
                                                        .map(obj -&gt; obj.get(&quot;name&quot;))
                                                        .collect(Collectors.toList())));
<span class="udiff-line-added">+             case &quot;customfield_10008&quot;: // fall-through</span>
              case &quot;issuetype&quot;:
                  return Optional.of(JSON.of(value.get(&quot;name&quot;).asString()));
              case &quot;priority&quot;:
                  return Optional.of(JSON.of(value.get(&quot;id&quot;).asString()));
              default:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -170,52 +205,94 @@</span>
                                                        .map(s -&gt; JSON.object().put(&quot;id&quot;, versions().get(s)))
                                                        .collect(Collectors.toList())));
              case &quot;components&quot;:
                  return Optional.of(new JSONArray(value.stream()
                                                        .map(JSONValue::asString)
<span class="udiff-line-modified-removed">-                                                       .map(s -&gt; JSON.object().put(&quot;id&quot;, components().get(s)))</span>
<span class="udiff-line-modified-added">+                                                       .map(s -&gt; JSON.object().put(&quot;id&quot;, componentId(s)))</span>
                                                        .collect(Collectors.toList())));
              case &quot;issuetype&quot;:
<span class="udiff-line-modified-removed">-                 return Optional.of(JSON.object().put(&quot;id&quot;, issueTypes().get(value.asString())));</span>
<span class="udiff-line-modified-added">+                 return Optional.of(JSON.object().put(&quot;id&quot;, issueTypeId(value.asString())));</span>
              case &quot;priority&quot;:
                  return Optional.of(JSON.object().put(&quot;id&quot;, value.asString()));
              default:
                  return Optional.of(value);
          }
      }
  
<span class="udiff-line-added">+     JSONValue encodeCustomFields(String name, JSONValue value, Map&lt;String, JSONValue&gt; allProperties) {</span>
<span class="udiff-line-added">+         if (!name.startsWith(&quot;customfield_&quot;)) {</span>
<span class="udiff-line-added">+             return value;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (!name.equals(&quot;customfield_10008&quot;)) {</span>
<span class="udiff-line-added">+             if (value.isObject()) {</span>
<span class="udiff-line-added">+                 if (value.asObject().contains(&quot;id&quot;)) {</span>
<span class="udiff-line-added">+                     return value.get(&quot;id&quot;);</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     return value;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 return value;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         var createMeta = createMeta();</span>
<span class="udiff-line-added">+         var fields = createMeta.get(&quot;projects&quot;).stream()</span>
<span class="udiff-line-added">+                                .filter(p -&gt; p.contains(&quot;name&quot;))</span>
<span class="udiff-line-added">+                                .filter(p -&gt; p.get(&quot;name&quot;).asString().equalsIgnoreCase(projectName))</span>
<span class="udiff-line-added">+                                .findAny().orElseThrow()</span>
<span class="udiff-line-added">+                                .get(&quot;issuetypes&quot;).stream()</span>
<span class="udiff-line-added">+                                .filter(i -&gt; i.get(&quot;id&quot;).asString().equals(allProperties.get(&quot;issuetype&quot;).get(&quot;id&quot;).asString()))</span>
<span class="udiff-line-added">+                                .findAny().orElseThrow()</span>
<span class="udiff-line-added">+                                .get(&quot;fields&quot;)</span>
<span class="udiff-line-added">+                                .asObject();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         var field = fields.get(name);</span>
<span class="udiff-line-added">+         var componentIds = allProperties.get(&quot;components&quot;).stream()</span>
<span class="udiff-line-added">+                                         .map(c -&gt; c.get(&quot;id&quot;).asString())</span>
<span class="udiff-line-added">+                                         .map(Integer::parseInt)</span>
<span class="udiff-line-added">+                                         .collect(Collectors.toSet());</span>
<span class="udiff-line-added">+         var allowed = field.get(&quot;allowedValues&quot;).stream()</span>
<span class="udiff-line-added">+                            .filter(c -&gt; componentIds.contains(c.get(&quot;id&quot;).asInt()))</span>
<span class="udiff-line-added">+                            .flatMap(c -&gt; c.get(&quot;subComponents&quot;).stream())</span>
<span class="udiff-line-added">+                            .collect(Collectors.toMap(s -&gt; s.get(&quot;name&quot;).asString(),</span>
<span class="udiff-line-added">+                                                      s -&gt; s.get(&quot;id&quot;).asInt()));</span>
<span class="udiff-line-added">+         if (!allowed.containsKey(value.asString())) {</span>
<span class="udiff-line-added">+             var allowedList = allowed.keySet().stream()</span>
<span class="udiff-line-added">+                                      .map(s -&gt; &quot;`&quot; + s + &quot;`&quot;)</span>
<span class="udiff-line-added">+                                      .collect(Collectors.joining(&quot;, &quot;));</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;Unknown subcomponent `&quot; + value.asString() + &quot;`. Known subcomponents are &quot; +</span>
<span class="udiff-line-added">+                                                allowedList + &quot;.&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return JSON.of(allowed.get(value.asString()));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      @Override
      public IssueTracker issueTracker() {
          return jiraHost;
      }
  
      @Override
      public URI webUrl() {
          return URIBuilder.base(jiraHost.getUri()).setPath(&quot;/projects/&quot; + projectName).build();
      }
  
<span class="udiff-line-modified-removed">-     private boolean isInitialField(String name, JSONValue value) {</span>
<span class="udiff-line-modified-removed">-         if (name.equals(&quot;project&quot;) || name.equals(&quot;summary&quot;) || name.equals(&quot;description&quot;) || name.equals(&quot;components&quot;)) {</span>
<span class="udiff-line-modified-removed">-             return true;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         return false;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     // Custom fields are set a bit differently depending on their type</span>
<span class="udiff-line-modified-removed">-     private JSONValue filterCustomFieldValue(String name, JSONValue unfiltered) {</span>
<span class="udiff-line-modified-removed">-         if (!name.startsWith(&quot;customfield_&quot;)) {</span>
<span class="udiff-line-modified-removed">-             return unfiltered;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         if (unfiltered.isObject()) {</span>
<span class="udiff-line-modified-removed">-             if (unfiltered.asObject().contains(&quot;id&quot;)) {</span>
<span class="udiff-line-removed">-                 return unfiltered.get(&quot;id&quot;);</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 return unfiltered;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             return unfiltered;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+     private boolean isInitialField(String issueType, String name, JSONValue value) {</span>
<span class="udiff-line-modified-added">+         var createMeta = createMeta();</span>
<span class="udiff-line-modified-added">+         var fields = createMeta.get(&quot;projects&quot;).stream()</span>
<span class="udiff-line-modified-added">+                                .filter(p -&gt; p.contains(&quot;name&quot;))</span>
<span class="udiff-line-modified-added">+                                .filter(p -&gt; p.get(&quot;name&quot;).asString().equalsIgnoreCase(projectName))</span>
<span class="udiff-line-modified-added">+                                .findAny().orElseThrow()</span>
<span class="udiff-line-modified-added">+                                .get(&quot;issuetypes&quot;).stream()</span>
<span class="udiff-line-modified-added">+                                .filter(i -&gt; i.get(&quot;id&quot;).asString().equals(issueType))</span>
<span class="udiff-line-modified-added">+                                .findAny().orElseThrow()</span>
<span class="udiff-line-modified-added">+                                .get(&quot;fields&quot;).fields().stream()</span>
<span class="udiff-line-modified-added">+                                .map(JSONObject.Field::name)</span>
<span class="udiff-line-modified-added">+                                .collect(Collectors.toSet());</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         return fields.contains(name);</span>
      }
  
      @Override
      public Issue createIssue(String title, List&lt;String&gt; body, Map&lt;String, JSONValue&gt; properties) {
          var query = JSON.object();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -235,33 +312,34 @@</span>
          finalProperties.put(&quot;summary&quot;, JSON.of(title));
          finalProperties.put(&quot;description&quot;, JSON.of(String.join(&quot;\n&quot;, body)));
  
          // Provide default values for required fields if not present
          finalProperties.putIfAbsent(&quot;components&quot;, JSON.array().add(JSON.object().put(&quot;id&quot;, defaultComponent())));
<span class="udiff-line-added">+         finalProperties.putIfAbsent(&quot;issuetype&quot;, JSON.object().put(&quot;id&quot;, defaultIssueType()));</span>
  
          // Filter out the fields that can be set at creation time
<span class="udiff-line-added">+         var issueType = finalProperties.get(&quot;issuetype&quot;).get(&quot;id&quot;).asString();</span>
          var fields = JSON.object();
          finalProperties.entrySet().stream()
<span class="udiff-line-modified-removed">-                        .filter(entry -&gt; isInitialField(entry.getKey(), entry.getValue()))</span>
<span class="udiff-line-modified-removed">-                        .forEach(entry -&gt; fields.put(entry.getKey(), entry.getValue()));</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         // Certain types can only be set after creation, so always start with the default value</span>
<span class="udiff-line-removed">-         fields.put(&quot;issuetype&quot;, JSON.object().put(&quot;id&quot;, defaultIssueType()));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+                        .filter(entry -&gt; isInitialField(issueType, entry.getKey(), entry.getValue()))</span>
<span class="udiff-line-modified-added">+                        .forEach(entry -&gt; fields.put(entry.getKey(), encodeCustomFields(entry.getKey(),</span>
<span class="udiff-line-modified-added">+                                                                                        entry.getValue(),</span>
<span class="udiff-line-modified-added">+                                                                                        finalProperties)));</span>
          query.put(&quot;fields&quot;, fields);
          jiraHost.securityLevel().ifPresent(securityLevel -&gt; fields.put(&quot;security&quot;, JSON.object()
                                                                                         .put(&quot;id&quot;, securityLevel)));
          var data = request.post(&quot;issue&quot;)
                            .body(query)
                            .execute();
  
          // Apply fields that have to be set later (if any)
          var editFields = JSON.object();
          finalProperties.entrySet().stream()
<span class="udiff-line-modified-removed">-                        .filter(entry -&gt; !isInitialField(entry.getKey(), entry.getValue()))</span>
<span class="udiff-line-modified-removed">-                        .forEach(entry -&gt; editFields.put(entry.getKey(), filterCustomFieldValue(entry.getKey(),</span>
<span class="udiff-line-modified-removed">-                                                                                                entry.getValue())));</span>
<span class="udiff-line-modified-added">+                        .filter(entry -&gt; !isInitialField(issueType, entry.getKey(), entry.getValue()))</span>
<span class="udiff-line-modified-added">+                        .forEach(entry -&gt; editFields.put(entry.getKey(), encodeCustomFields(entry.getKey(),</span>
<span class="udiff-line-modified-added">+                                                                                            entry.getValue(),</span>
<span class="udiff-line-added">+                                                                                            finalProperties)));</span>
  
          if (editFields.fields().size() &gt; 0) {
              var id = data.get(&quot;key&quot;).asString();
              if (id.indexOf(&#39;-&#39;) &lt; 0) {
                  id = projectName.toUpperCase() + &quot;-&quot; + id;
</pre>
<center><a href="../../../../../../../../../forge/src/main/java/org/openjdk/skara/forge/PullRequestBody.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>