<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/IssueCommand.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/pr/IssueTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/IssueCommand.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 42         this.identifier = identifier;
 43         this.reason = reason;
 44     }
 45 
 46     String identifier() {
 47         return identifier;
 48     }
 49 
 50     String reason() {
 51         return reason;
 52     }
 53 }
 54 
 55 public class IssueCommand implements CommandHandler {
 56     private final String name;
 57 
 58     private void showHelp(PrintWriter reply) {
 59         reply.println(&quot;Command syntax:&quot;);
 60         reply.println(&quot; * `/&quot; + name + &quot; [add|remove] &lt;id&gt;[,&lt;id&gt;,...]`&quot;);
 61         reply.println(&quot; * `/&quot; + name + &quot; [add] &lt;id&gt;: &lt;description&gt;`&quot;);
<span class="line-modified"> 62         reply.println(&quot; * `/&quot; + name + &quot; create [pX] [type] &lt;component&gt; [subcomponent]&quot;);</span>
 63         reply.println();
 64         reply.println(&quot;Some examples:&quot;);
 65         reply.println();
 66         reply.println(&quot; * `/&quot; + name + &quot; add JDK-1234567,4567890`&quot;);
 67         reply.println(&quot; * `/&quot; + name + &quot; remove JDK-4567890`&quot;);
 68         reply.println(&quot; * `/&quot; + name + &quot; 1234567: Use this exact title`&quot;);
 69         reply.println(&quot; * `/&quot; + name + &quot; create hotspot jfr&quot;);
<span class="line-modified"> 70         reply.println(&quot; * `/&quot; + name + &quot; create P4 enhancement core-libs java.nio&quot;);</span>
 71         reply.println();
 72         reply.print(&quot;If issues are specified only by their ID, the title will be automatically retrieved from JBS. &quot;);
 73         reply.print(&quot;The project prefix (`JDK-` in the above examples) is optional. &quot;);
 74         reply.println(&quot;Separate multiple issue IDs using either spaces or commas.&quot;);
 75     }
 76 
 77     private static final Pattern shortIssuePattern = Pattern.compile(&quot;((?:[A-Za-z]+-)?[0-9]+)(?:,| |$)&quot;);
 78     private final static Pattern subCommandPattern = Pattern.compile(&quot;^(add|remove|delete|create|(?:[A-Za-z]+-)?[0-9]+:?)[ ,]?.*$&quot;);
 79 
 80     private List&lt;Issue&gt; parseIssueList(String allowedPrefix, String issueList) throws InvalidIssue {
 81         List&lt;Issue&gt; ret;
 82         // Is this a single fully described issue?
 83         var singleIssue = Issue.fromString(issueList);
 84         if (singleIssue.isPresent()) {
 85             ret = List.of(singleIssue.get());
 86         } else {
 87             var shortIssueMatcher = shortIssuePattern.matcher(issueList);
 88             ret = shortIssueMatcher.results()
 89                                    .map(matchResult -&gt; matchResult.group(1))
 90                                    .map(identifier -&gt; new Issue(identifier, null))
</pre>
<hr />
<pre>
195         }
196         if (currentSolved.isEmpty()) {
197             reply.println(&quot;This PR does not contain any additional solved issues that can be removed. To remove the primary solved issue, simply edit the title of this PR.&quot;);
198             return;
199         }
200         var issuesToRemove = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args.substring(issueListStart));
201         for (var issue : issuesToRemove) {
202             if (currentSolved.contains(issue.shortId())) {
203                 reply.println(SolvesTracker.removeSolvesMarker(issue));
204                 reply.println(&quot;Removing additional issue from &quot; + name + &quot; list: `&quot; + issue.shortId() + &quot;`.&quot;);
205             } else {
206                 reply.print(&quot;The issue `&quot; + issue.shortId() + &quot;` was not found in the list of additional solved issues. The list currently contains these issues: &quot;);
207                 var currentList = currentSolved.stream()
208                                                .map(id -&gt; &quot;`&quot; + id + &quot;`&quot;)
209                                                .collect(Collectors.joining(&quot;, &quot;));
210                 reply.println(currentList);
211             }
212         }
213     }
214 
<span class="line-removed">215     private static final Set&lt;String&gt; allowedTypes = Set.of(&quot;bug&quot;, &quot;new&quot;, &quot;enhancement&quot;);</span>
<span class="line-removed">216 </span>
217     private void createIssue(PullRequestBot bot, PullRequest pr, String args, CensusInstance censusInstance, HostUser author, PrintWriter reply) {
218         if (!censusInstance.isAuthor(author)) {
219             reply.println(&quot;Only [Authors](https://openjdk.java.net/bylaws#author) are allowed to create issues.&quot;);
220             return;
221         }
222 
223         var currentTitleIssue = Issue.fromString(pr.title());
224         if (currentTitleIssue.isPresent()) {
225             reply.println(&quot;The PR title already references an issue (`&quot; + currentTitleIssue.get().shortId() + &quot;`) - will not create a new one.&quot;);
226             return;
227         }
228 
<span class="line-modified">229         var argSplit = new LinkedList&lt;&gt;(Arrays.asList(args.split(&quot;\\s+&quot;)));</span>
230         argSplit.pollFirst();
231 
232         String priority = null;
<span class="line-removed">233         String type = null;</span>
234         String subComponent = null;
235 
236         // First argument can be a priority
237         var next = argSplit.pollFirst();
238         if (next != null &amp;&amp; next.matches(&quot;^[pP]\\d$&quot;)) {
239             priority = next.substring(1);
240             next = argSplit.pollFirst();
241         }
242 
<span class="line-removed">243         // Second (and third) can be a known issue type</span>
<span class="line-removed">244         if (next != null &amp;&amp; allowedTypes.contains(next.toLowerCase())) {</span>
<span class="line-removed">245             if (next.equals(&quot;new&quot;)) {</span>
<span class="line-removed">246                 next = argSplit.pollFirst();</span>
<span class="line-removed">247                 if (next != null &amp;&amp; next.toLowerCase().equals(&quot;feature&quot;)) {</span>
<span class="line-removed">248                     type = &quot;new feature&quot;;</span>
<span class="line-removed">249                 } else {</span>
<span class="line-removed">250                     // Undo the halfway mismatch</span>
<span class="line-removed">251                     argSplit.offerFirst(next);</span>
<span class="line-removed">252                     argSplit.offerFirst(&quot;new&quot;);</span>
<span class="line-removed">253                 }</span>
<span class="line-removed">254             } else {</span>
<span class="line-removed">255                 type = next.toLowerCase();</span>
<span class="line-removed">256             }</span>
<span class="line-removed">257             next = argSplit.pollFirst();</span>
<span class="line-removed">258         }</span>
<span class="line-removed">259 </span>
260         // Next argument is the mandatory component name
261         if (next == null) {
262             showHelp(reply);
263             return;
264         }
265         var component = next;
266         next = argSplit.pollFirst();
267 
268         // Finally there can be a subcomponent present
269         if (next != null) {
270             subComponent = next;
271         }
272 
273         var properties = new HashMap&lt;String, JSONValue&gt;();
274         properties.put(&quot;components&quot;, JSON.array().add(JSON.of(component)));
275         if (subComponent != null) {
276             properties.put(&quot;customfield_10008&quot;, JSON.of(subComponent));
277         }
278         if (priority != null) {
279             properties.put(&quot;priority&quot;, JSON.of(priority));
280         }
<span class="line-modified">281         if (type != null) {</span>
<span class="line-removed">282             properties.put(&quot;issuetype&quot;, JSON.of(type));</span>
<span class="line-removed">283         }</span>
284 
285         var bodyText = PullRequestBody.parse(pr).bodyText();
286         try {
287             var issue = bot.issueProject().createIssue(pr.title(), bodyText.lines().collect(Collectors.toList()), properties);
288             reply.println(&quot;The issue `&quot; + issue.id() + &quot;` was successfully created - the title of this PR will be updated to reference it. &quot;);
289             var shortId = issue.id().contains(&quot;-&quot;) ? issue.id().split(&quot;-&quot;, 2)[1] : issue.id();
290             pr.setTitle(shortId + &quot;: &quot; + issue.title());
291         } catch (RuntimeException e) {
292             reply.println(&quot;An error occurred when attempting to create an issue: &quot; + e.getMessage());
293         }
294     }
295 
296     @Override
297     public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, String args, Comment comment, List&lt;Comment&gt; allComments, PrintWriter reply) {
298         if (!comment.author().equals(pr.author())) {
299             reply.println(&quot;Only the author (@&quot; + pr.author().userName() + &quot;) is allowed to issue the `/&quot; + name + &quot;` command.&quot;);
300             return;
301         }
302         if (args.isBlank()) {
303             showHelp(reply);
</pre>
</td>
<td>
<hr />
<pre>
 42         this.identifier = identifier;
 43         this.reason = reason;
 44     }
 45 
 46     String identifier() {
 47         return identifier;
 48     }
 49 
 50     String reason() {
 51         return reason;
 52     }
 53 }
 54 
 55 public class IssueCommand implements CommandHandler {
 56     private final String name;
 57 
 58     private void showHelp(PrintWriter reply) {
 59         reply.println(&quot;Command syntax:&quot;);
 60         reply.println(&quot; * `/&quot; + name + &quot; [add|remove] &lt;id&gt;[,&lt;id&gt;,...]`&quot;);
 61         reply.println(&quot; * `/&quot; + name + &quot; [add] &lt;id&gt;: &lt;description&gt;`&quot;);
<span class="line-modified"> 62         reply.println(&quot; * `/&quot; + name + &quot; create [pX] &lt;component&gt; [subcomponent]&quot;);</span>
 63         reply.println();
 64         reply.println(&quot;Some examples:&quot;);
 65         reply.println();
 66         reply.println(&quot; * `/&quot; + name + &quot; add JDK-1234567,4567890`&quot;);
 67         reply.println(&quot; * `/&quot; + name + &quot; remove JDK-4567890`&quot;);
 68         reply.println(&quot; * `/&quot; + name + &quot; 1234567: Use this exact title`&quot;);
 69         reply.println(&quot; * `/&quot; + name + &quot; create hotspot jfr&quot;);
<span class="line-modified"> 70         reply.println(&quot; * `/&quot; + name + &quot; create P4 core-libs java.nio&quot;);</span>
 71         reply.println();
 72         reply.print(&quot;If issues are specified only by their ID, the title will be automatically retrieved from JBS. &quot;);
 73         reply.print(&quot;The project prefix (`JDK-` in the above examples) is optional. &quot;);
 74         reply.println(&quot;Separate multiple issue IDs using either spaces or commas.&quot;);
 75     }
 76 
 77     private static final Pattern shortIssuePattern = Pattern.compile(&quot;((?:[A-Za-z]+-)?[0-9]+)(?:,| |$)&quot;);
 78     private final static Pattern subCommandPattern = Pattern.compile(&quot;^(add|remove|delete|create|(?:[A-Za-z]+-)?[0-9]+:?)[ ,]?.*$&quot;);
 79 
 80     private List&lt;Issue&gt; parseIssueList(String allowedPrefix, String issueList) throws InvalidIssue {
 81         List&lt;Issue&gt; ret;
 82         // Is this a single fully described issue?
 83         var singleIssue = Issue.fromString(issueList);
 84         if (singleIssue.isPresent()) {
 85             ret = List.of(singleIssue.get());
 86         } else {
 87             var shortIssueMatcher = shortIssuePattern.matcher(issueList);
 88             ret = shortIssueMatcher.results()
 89                                    .map(matchResult -&gt; matchResult.group(1))
 90                                    .map(identifier -&gt; new Issue(identifier, null))
</pre>
<hr />
<pre>
195         }
196         if (currentSolved.isEmpty()) {
197             reply.println(&quot;This PR does not contain any additional solved issues that can be removed. To remove the primary solved issue, simply edit the title of this PR.&quot;);
198             return;
199         }
200         var issuesToRemove = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args.substring(issueListStart));
201         for (var issue : issuesToRemove) {
202             if (currentSolved.contains(issue.shortId())) {
203                 reply.println(SolvesTracker.removeSolvesMarker(issue));
204                 reply.println(&quot;Removing additional issue from &quot; + name + &quot; list: `&quot; + issue.shortId() + &quot;`.&quot;);
205             } else {
206                 reply.print(&quot;The issue `&quot; + issue.shortId() + &quot;` was not found in the list of additional solved issues. The list currently contains these issues: &quot;);
207                 var currentList = currentSolved.stream()
208                                                .map(id -&gt; &quot;`&quot; + id + &quot;`&quot;)
209                                                .collect(Collectors.joining(&quot;, &quot;));
210                 reply.println(currentList);
211             }
212         }
213     }
214 


215     private void createIssue(PullRequestBot bot, PullRequest pr, String args, CensusInstance censusInstance, HostUser author, PrintWriter reply) {
216         if (!censusInstance.isAuthor(author)) {
217             reply.println(&quot;Only [Authors](https://openjdk.java.net/bylaws#author) are allowed to create issues.&quot;);
218             return;
219         }
220 
221         var currentTitleIssue = Issue.fromString(pr.title());
222         if (currentTitleIssue.isPresent()) {
223             reply.println(&quot;The PR title already references an issue (`&quot; + currentTitleIssue.get().shortId() + &quot;`) - will not create a new one.&quot;);
224             return;
225         }
226 
<span class="line-modified">227         var argSplit = new LinkedList&lt;&gt;(Arrays.asList(args.split(&quot;(?:\\s+|/)&quot;)));</span>
228         argSplit.pollFirst();
229 
230         String priority = null;

231         String subComponent = null;
232 
233         // First argument can be a priority
234         var next = argSplit.pollFirst();
235         if (next != null &amp;&amp; next.matches(&quot;^[pP]\\d$&quot;)) {
236             priority = next.substring(1);
237             next = argSplit.pollFirst();
238         }
239 

















240         // Next argument is the mandatory component name
241         if (next == null) {
242             showHelp(reply);
243             return;
244         }
245         var component = next;
246         next = argSplit.pollFirst();
247 
248         // Finally there can be a subcomponent present
249         if (next != null) {
250             subComponent = next;
251         }
252 
253         var properties = new HashMap&lt;String, JSONValue&gt;();
254         properties.put(&quot;components&quot;, JSON.array().add(JSON.of(component)));
255         if (subComponent != null) {
256             properties.put(&quot;customfield_10008&quot;, JSON.of(subComponent));
257         }
258         if (priority != null) {
259             properties.put(&quot;priority&quot;, JSON.of(priority));
260         }
<span class="line-modified">261         properties.put(&quot;issuetype&quot;, JSON.of(&quot;enhancement&quot;));</span>


262 
263         var bodyText = PullRequestBody.parse(pr).bodyText();
264         try {
265             var issue = bot.issueProject().createIssue(pr.title(), bodyText.lines().collect(Collectors.toList()), properties);
266             reply.println(&quot;The issue `&quot; + issue.id() + &quot;` was successfully created - the title of this PR will be updated to reference it. &quot;);
267             var shortId = issue.id().contains(&quot;-&quot;) ? issue.id().split(&quot;-&quot;, 2)[1] : issue.id();
268             pr.setTitle(shortId + &quot;: &quot; + issue.title());
269         } catch (RuntimeException e) {
270             reply.println(&quot;An error occurred when attempting to create an issue: &quot; + e.getMessage());
271         }
272     }
273 
274     @Override
275     public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, String args, Comment comment, List&lt;Comment&gt; allComments, PrintWriter reply) {
276         if (!comment.author().equals(pr.author())) {
277             reply.println(&quot;Only the author (@&quot; + pr.author().userName() + &quot;) is allowed to issue the `/&quot; + name + &quot;` command.&quot;);
278             return;
279         }
280         if (args.isBlank()) {
281             showHelp(reply);
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/pr/IssueTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>