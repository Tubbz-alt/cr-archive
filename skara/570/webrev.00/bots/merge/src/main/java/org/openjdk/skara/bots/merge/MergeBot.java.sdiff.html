<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/merge/src/main/java/org/openjdk/skara/bots/merge/MergeBot.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/merge/src/main/java/org/openjdk/skara/bots/merge/MergeBot.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.merge;
 24 
 25 import org.openjdk.skara.bot.*;
 26 import org.openjdk.skara.forge.*;
 27 import org.openjdk.skara.vcs.*;
 28 import org.openjdk.skara.jcheck.JCheckConfiguration;
 29 
 30 import java.io.IOException;

 31 import java.io.UncheckedIOException;
 32 import java.nio.charset.StandardCharsets;
 33 import java.nio.file.Path;
 34 import java.nio.file.Files;
 35 import java.net.URLEncoder;
 36 import java.time.DayOfWeek;
 37 import java.time.Month;
 38 import java.time.temporal.WeekFields;
 39 import java.time.ZonedDateTime;
 40 import java.util.*;
 41 import java.util.stream.Collectors;
 42 import java.util.logging.Logger;
 43 
 44 class MergeBot implements Bot, WorkItem {
 45     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots&quot;);;
 46     private final Path storage;
 47 

 48     private final HostedRepository target;
 49     private final HostedRepository fork;
 50     private final List&lt;Spec&gt; specs;
 51 
 52     private final Clock clock;
 53 
 54     private final Map&lt;String, Set&lt;Integer&gt;&gt; hourly = new HashMap&lt;&gt;();
 55     private final Map&lt;String, Set&lt;Integer&gt;&gt; daily = new HashMap&lt;&gt;();
 56     private final Map&lt;String, Set&lt;Integer&gt;&gt; weekly = new HashMap&lt;&gt;();
 57     private final Map&lt;String, Set&lt;Month&gt;&gt; monthly = new HashMap&lt;&gt;();
 58     private final Map&lt;String, Set&lt;Integer&gt;&gt; yearly = new HashMap&lt;&gt;();
 59 
 60     MergeBot(Path storage, HostedRepository target, HostedRepository fork,
 61              List&lt;Spec&gt; specs) {
 62         this(storage, target, fork, specs, new Clock() {
 63             public ZonedDateTime now() {
 64                 return ZonedDateTime.now();
 65             }
 66         });
 67     }
 68 
 69     MergeBot(Path storage, HostedRepository target, HostedRepository fork,
 70              List&lt;Spec&gt; specs, Clock clock) {
 71         this.storage = storage;

 72         this.target = target;
 73         this.fork = fork;
 74         this.specs = specs;
 75         this.clock = clock;
 76     }
 77 
 78     final static class Spec {
 79         final static class Frequency {
 80             static enum Interval {
 81                 HOURLY,
 82                 DAILY,
 83                 WEEKLY,
 84                 MONTHLY,
 85                 YEARLY;
 86 
 87                 boolean isHourly() {
 88                     return this.equals(HOURLY);
 89                 }
 90 
 91                 boolean isDaily() {
</pre>
<hr />
<pre>
198             this.frequency = frequency;
199         }
200 
201         HostedRepository fromRepo() {
202             return fromRepo;
203         }
204 
205         Branch fromBranch() {
206             return fromBranch;
207         }
208 
209         Branch toBranch() {
210             return toBranch;
211         }
212 
213         Optional&lt;Frequency&gt; frequency() {
214             return Optional.ofNullable(frequency);
215         }
216     }
217 























218     @Override
219     public boolean concurrentWith(WorkItem other) {
220         if (!(other instanceof MergeBot)) {
221             return true;
222         }
223         var otherBot = (MergeBot) other;
224         return !target.name().equals(otherBot.target.name());
225     }
226 
227     @Override
228     public void run(Path scratchPath) {
229         try {
230             var sanitizedUrl =
231                 URLEncoder.encode(fork.webUrl().toString(), StandardCharsets.UTF_8);
232             var dir = storage.resolve(sanitizedUrl);
233 
<span class="line-modified">234             Repository repo = null;</span>
<span class="line-removed">235             if (!Files.exists(dir)) {</span>
<span class="line-removed">236                 log.info(&quot;Cloning &quot; + fork.name());</span>
<span class="line-removed">237                 Files.createDirectories(dir);</span>
<span class="line-removed">238                 repo = Repository.clone(fork.url(), dir);</span>
<span class="line-removed">239             } else {</span>
<span class="line-removed">240                 log.info(&quot;Found existing scratch directory for &quot; + fork.name());</span>
<span class="line-removed">241                 repo = Repository.get(dir).orElseThrow(() -&gt; {</span>
<span class="line-removed">242                         return new RuntimeException(&quot;Repository in &quot; + dir + &quot; has vanished&quot;);</span>
<span class="line-removed">243                 });</span>
<span class="line-removed">244             }</span>
<span class="line-removed">245 </span>
<span class="line-removed">246             // Sync personal fork</span>
<span class="line-removed">247             var remoteBranches = repo.remoteBranches(target.url().toString());</span>
<span class="line-removed">248             for (var branch : remoteBranches) {</span>
<span class="line-removed">249                 var fetchHead = repo.fetch(target.url(), branch.hash().hex());</span>
<span class="line-removed">250                 repo.push(fetchHead, fork.url(), branch.name());</span>
<span class="line-removed">251             }</span>
<span class="line-removed">252 </span>
<span class="line-removed">253             // Must fetch once to update refs/heads</span>
<span class="line-removed">254             repo.fetchAll();</span>
255 
256             var prTarget = fork.forge().repository(target.name()).orElseThrow(() -&gt;
257                     new IllegalStateException(&quot;Can&#39;t get well-known repository &quot; + target.name())
258             );
259             var prs = prTarget.pullRequests();
260             var currentUser = prTarget.forge().currentUser();
261 
262             for (var spec : specs) {
263                 var toBranch = spec.toBranch();
264                 var fromRepo = spec.fromRepo();
265                 var fromBranch = spec.fromBranch();
266 
267                 var targetName = Path.of(target.name()).getFileName();
268                 var fromName = Path.of(fromRepo.name()).getFileName();
269                 var fromDesc = targetName.equals(fromName) ? fromBranch.name() : fromName + &quot;:&quot; + fromBranch.name();
270 
271                 // Check if merge conflict pull request is present
272                 var shouldMerge = true;
273                 var title = &quot;Merge &quot; + fromDesc;
274                 var marker = &quot;&lt;!-- AUTOMATIC MERGE PR --&gt;&quot;;
</pre>
<hr />
<pre>
413                     log.info(&quot;Nothing to merge&quot;);
414                     continue;
415                 }
416 
417                 var isAncestor = repo.isAncestor(head, fetchHead);
418 
419                 log.info(&quot;Merging into &quot; + toBranch.name());
420                 IOException error = null;
421                 try {
422                     repo.merge(fetchHead);
423                 } catch (IOException e) {
424                     error = e;
425                 }
426 
427                 if (error == null) {
428                     log.info(&quot;Pushing successful merge&quot;);
429                     if (!isAncestor) {
430                         repo.commit(&quot;Automatic merge of &quot; + fromDesc + &quot; into &quot; + toBranch,
431                                 &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
432                     }
<span class="line-modified">433                     repo.push(toBranch, target.url().toString(), false);</span>









434                 } else {
435                     log.info(&quot;Got error: &quot; + error.getMessage());
436                     log.info(&quot;Aborting unsuccesful merge&quot;);
437                     var status = repo.status();
438                     repo.abortMerge();
439 
440                     var fromRepoName = Path.of(fromRepo.webUrl().getPath()).getFileName();
441                     var branchDesc = Integer.toString(prs.size() + 1);
442                     repo.push(fetchHead, fork.url(), branchDesc, true);
443 
444                     log.info(&quot;Creating pull request to alert&quot;);
445                     var mergeBase = repo.mergeBase(fetchHead, head);
446 
447                     var message = new ArrayList&lt;String&gt;();
448                     message.add(marker);
449                     message.add(&quot;&lt;!-- &quot; + fetchHead.hex() + &quot; --&gt;&quot;);
450 
451                     var commits = repo.commits(mergeBase.hex() + &quot;..&quot; + fetchHead.hex(), true).asList();
452                     var numCommits = commits.size();
453                     var are = numCommits &gt; 1 ? &quot;are&quot; : &quot;is&quot;;
</pre>
</td>
<td>
<hr />
<pre>
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.merge;
 24 
 25 import org.openjdk.skara.bot.*;
 26 import org.openjdk.skara.forge.*;
 27 import org.openjdk.skara.vcs.*;
 28 import org.openjdk.skara.jcheck.JCheckConfiguration;
 29 
 30 import java.io.IOException;
<span class="line-added"> 31 import java.io.File;</span>
 32 import java.io.UncheckedIOException;
 33 import java.nio.charset.StandardCharsets;
 34 import java.nio.file.Path;
 35 import java.nio.file.Files;
 36 import java.net.URLEncoder;
 37 import java.time.DayOfWeek;
 38 import java.time.Month;
 39 import java.time.temporal.WeekFields;
 40 import java.time.ZonedDateTime;
 41 import java.util.*;
 42 import java.util.stream.Collectors;
 43 import java.util.logging.Logger;
 44 
 45 class MergeBot implements Bot, WorkItem {
 46     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots&quot;);;
 47     private final Path storage;
 48 
<span class="line-added"> 49     private final HostedRepositoryPool pool;</span>
 50     private final HostedRepository target;
 51     private final HostedRepository fork;
 52     private final List&lt;Spec&gt; specs;
 53 
 54     private final Clock clock;
 55 
 56     private final Map&lt;String, Set&lt;Integer&gt;&gt; hourly = new HashMap&lt;&gt;();
 57     private final Map&lt;String, Set&lt;Integer&gt;&gt; daily = new HashMap&lt;&gt;();
 58     private final Map&lt;String, Set&lt;Integer&gt;&gt; weekly = new HashMap&lt;&gt;();
 59     private final Map&lt;String, Set&lt;Month&gt;&gt; monthly = new HashMap&lt;&gt;();
 60     private final Map&lt;String, Set&lt;Integer&gt;&gt; yearly = new HashMap&lt;&gt;();
 61 
 62     MergeBot(Path storage, HostedRepository target, HostedRepository fork,
 63              List&lt;Spec&gt; specs) {
 64         this(storage, target, fork, specs, new Clock() {
 65             public ZonedDateTime now() {
 66                 return ZonedDateTime.now();
 67             }
 68         });
 69     }
 70 
 71     MergeBot(Path storage, HostedRepository target, HostedRepository fork,
 72              List&lt;Spec&gt; specs, Clock clock) {
 73         this.storage = storage;
<span class="line-added"> 74         this.pool = new HostedRepositoryPool(storage.resolve(&quot;seeds&quot;));</span>
 75         this.target = target;
 76         this.fork = fork;
 77         this.specs = specs;
 78         this.clock = clock;
 79     }
 80 
 81     final static class Spec {
 82         final static class Frequency {
 83             static enum Interval {
 84                 HOURLY,
 85                 DAILY,
 86                 WEEKLY,
 87                 MONTHLY,
 88                 YEARLY;
 89 
 90                 boolean isHourly() {
 91                     return this.equals(HOURLY);
 92                 }
 93 
 94                 boolean isDaily() {
</pre>
<hr />
<pre>
201             this.frequency = frequency;
202         }
203 
204         HostedRepository fromRepo() {
205             return fromRepo;
206         }
207 
208         Branch fromBranch() {
209             return fromBranch;
210         }
211 
212         Branch toBranch() {
213             return toBranch;
214         }
215 
216         Optional&lt;Frequency&gt; frequency() {
217             return Optional.ofNullable(frequency);
218         }
219     }
220 
<span class="line-added">221     private static void deleteDirectory(Path dir) throws IOException {</span>
<span class="line-added">222         Files.walk(dir)</span>
<span class="line-added">223              .map(Path::toFile)</span>
<span class="line-added">224              .sorted(Comparator.reverseOrder())</span>
<span class="line-added">225              .forEach(File::delete);</span>
<span class="line-added">226     }</span>
<span class="line-added">227 </span>
<span class="line-added">228     private Repository cloneAndSyncFork(Path to) throws IOException {</span>
<span class="line-added">229         var repo = pool.materialize(fork, to);</span>
<span class="line-added">230 </span>
<span class="line-added">231         // Sync personal fork</span>
<span class="line-added">232         var remoteBranches = repo.remoteBranches(target.url().toString());</span>
<span class="line-added">233         for (var branch : remoteBranches) {</span>
<span class="line-added">234             var fetchHead = repo.fetch(target.url(), branch.hash().hex());</span>
<span class="line-added">235             repo.push(fetchHead, fork.url(), branch.name());</span>
<span class="line-added">236         }</span>
<span class="line-added">237 </span>
<span class="line-added">238         // Must fetch once to update refs/heads</span>
<span class="line-added">239         repo.fetchAll();</span>
<span class="line-added">240 </span>
<span class="line-added">241         return repo;</span>
<span class="line-added">242     }</span>
<span class="line-added">243 </span>
244     @Override
245     public boolean concurrentWith(WorkItem other) {
246         if (!(other instanceof MergeBot)) {
247             return true;
248         }
249         var otherBot = (MergeBot) other;
250         return !target.name().equals(otherBot.target.name());
251     }
252 
253     @Override
254     public void run(Path scratchPath) {
255         try {
256             var sanitizedUrl =
257                 URLEncoder.encode(fork.webUrl().toString(), StandardCharsets.UTF_8);
258             var dir = storage.resolve(sanitizedUrl);
259 
<span class="line-modified">260             var repo = cloneAndSyncFork(dir);</span>




















261 
262             var prTarget = fork.forge().repository(target.name()).orElseThrow(() -&gt;
263                     new IllegalStateException(&quot;Can&#39;t get well-known repository &quot; + target.name())
264             );
265             var prs = prTarget.pullRequests();
266             var currentUser = prTarget.forge().currentUser();
267 
268             for (var spec : specs) {
269                 var toBranch = spec.toBranch();
270                 var fromRepo = spec.fromRepo();
271                 var fromBranch = spec.fromBranch();
272 
273                 var targetName = Path.of(target.name()).getFileName();
274                 var fromName = Path.of(fromRepo.name()).getFileName();
275                 var fromDesc = targetName.equals(fromName) ? fromBranch.name() : fromName + &quot;:&quot; + fromBranch.name();
276 
277                 // Check if merge conflict pull request is present
278                 var shouldMerge = true;
279                 var title = &quot;Merge &quot; + fromDesc;
280                 var marker = &quot;&lt;!-- AUTOMATIC MERGE PR --&gt;&quot;;
</pre>
<hr />
<pre>
419                     log.info(&quot;Nothing to merge&quot;);
420                     continue;
421                 }
422 
423                 var isAncestor = repo.isAncestor(head, fetchHead);
424 
425                 log.info(&quot;Merging into &quot; + toBranch.name());
426                 IOException error = null;
427                 try {
428                     repo.merge(fetchHead);
429                 } catch (IOException e) {
430                     error = e;
431                 }
432 
433                 if (error == null) {
434                     log.info(&quot;Pushing successful merge&quot;);
435                     if (!isAncestor) {
436                         repo.commit(&quot;Automatic merge of &quot; + fromDesc + &quot; into &quot; + toBranch,
437                                 &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
438                     }
<span class="line-modified">439                     try {</span>
<span class="line-added">440                         repo.push(toBranch, target.url().toString(), false);</span>
<span class="line-added">441                     } catch (IOException e) {</span>
<span class="line-added">442                         // A failed push can result in the local and remote branch diverging,</span>
<span class="line-added">443                         // re-create the repository from the remote.</span>
<span class="line-added">444                         // No need to create a pull request, just retry the merge and the push</span>
<span class="line-added">445                         // the next run.</span>
<span class="line-added">446                         deleteDirectory(dir);</span>
<span class="line-added">447                         repo = cloneAndSyncFork(dir);</span>
<span class="line-added">448                     }</span>
449                 } else {
450                     log.info(&quot;Got error: &quot; + error.getMessage());
451                     log.info(&quot;Aborting unsuccesful merge&quot;);
452                     var status = repo.status();
453                     repo.abortMerge();
454 
455                     var fromRepoName = Path.of(fromRepo.webUrl().getPath()).getFileName();
456                     var branchDesc = Integer.toString(prs.size() + 1);
457                     repo.push(fetchHead, fork.url(), branchDesc, true);
458 
459                     log.info(&quot;Creating pull request to alert&quot;);
460                     var mergeBase = repo.mergeBase(fetchHead, head);
461 
462                     var message = new ArrayList&lt;String&gt;();
463                     message.add(marker);
464                     message.add(&quot;&lt;!-- &quot; + fetchHead.hex() + &quot; --&gt;&quot;);
465 
466                     var commits = repo.commits(mergeBase.hex() + &quot;..&quot; + fetchHead.hex(), true).asList();
467                     var numCommits = commits.size();
468                     var are = numCommits &gt; 1 ? &quot;are&quot; : &quot;is&quot;;
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>