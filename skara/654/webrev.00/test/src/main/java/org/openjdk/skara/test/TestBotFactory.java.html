<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/src/main/java/org/openjdk/skara/test/TestBotFactory.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.test;
 24 
 25 import org.openjdk.skara.bot.*;
 26 import org.openjdk.skara.ci.ContinuousIntegration;
 27 import org.openjdk.skara.forge.HostedRepository;
 28 import org.openjdk.skara.issuetracker.IssueProject;
 29 import org.openjdk.skara.json.*;
 30 
 31 import java.nio.file.Path;
 32 import java.util.*;
 33 
 34 public class TestBotFactory {
 35     private final Map&lt;String, HostedRepository&gt; hostedRepositories;
 36     private final Map&lt;String, IssueProject&gt; issueProjects;
 37     private final Path storagePath;
 38     private final JSONObject defaultConfiguration;
 39 
 40     private TestBotFactory(Map&lt;String, HostedRepository&gt; hostedRepositories, Map&lt;String, IssueProject&gt; issueProjects,
 41             Path storagePath, JSONObject defaultConfiguration) {
 42         this.hostedRepositories = Collections.unmodifiableMap(hostedRepositories);
 43         this.issueProjects = Collections.unmodifiableMap(issueProjects);
 44         this.storagePath = storagePath;
 45         this.defaultConfiguration = defaultConfiguration;
 46     }
 47 
 48     public static TestBotFactoryBuilder newBuilder() {
 49         return new TestBotFactoryBuilder();
 50     }
 51 
 52     public static class TestBotFactoryBuilder {
 53         private final Map&lt;String, HostedRepository&gt; hostedRepositories = new HashMap&lt;&gt;();
 54         private final Map&lt;String, IssueProject&gt; issueProjects = new HashMap&lt;&gt;();
 55         private final JSONObject defaultConfiguration = JSON.object();
 56         private Path storagePath;
 57 
 58         private TestBotFactoryBuilder() {
 59         }
 60 
 61         public TestBotFactoryBuilder addHostedRepository(String name, HostedRepository hostedRepository) {
 62             hostedRepositories.put(name, hostedRepository);
 63             return this;
 64         }
 65 
 66         public TestBotFactoryBuilder addIssueProject(String name, IssueProject issueProject) {
 67             issueProjects.put(name, issueProject);
 68             return this;
 69         }
 70 
 71         public TestBotFactoryBuilder addConfiguration(String field, JSONValue value) {
 72             defaultConfiguration.put(field, value);
 73             return this;
 74         }
 75 
 76         public TestBotFactoryBuilder storagePath(Path storagePath) {
 77             this.storagePath = storagePath;
 78             return this;
 79         }
 80 
 81         public TestBotFactory build() {
 82             return new TestBotFactory(hostedRepositories, issueProjects, storagePath, defaultConfiguration);
 83         }
 84     }
 85 
 86     public Bot create(String name, JSONObject configuration) {
 87         var finalConfiguration = JSON.object();
 88         for (var defaultField : defaultConfiguration.fields()) {
 89             finalConfiguration.put(defaultField.name(), defaultField.value());
 90         }
 91         for (var field : configuration.fields()) {
 92             finalConfiguration.put(field.name(), field.value());
 93         }
 94 
 95         var botConfiguration = new BotConfiguration() {
 96             @Override
 97             public Path storageFolder() {
 98                 return storagePath;
 99             }
100 
101             @Override
102             public HostedRepository repository(String name) {
103                 var repoName = name.split(&quot;:&quot;)[0];
104                 if (!hostedRepositories.containsKey(repoName)) {
105                     throw new RuntimeException(&quot;Unknown repository: &quot; + repoName);
106                 }
107                 return hostedRepositories.get(repoName);
108             }
109 
110             @Override
111             public IssueProject issueProject(String name) {
112                 if (!issueProjects.containsKey(name)) {
113                     throw new RuntimeException(&quot;Unknown issue project: &quot; + name);
114                 }
115                 return issueProjects.get(name);
116             }
117 
118             @Override
119             public ContinuousIntegration continuousIntegration(String name) {
120                 throw new RuntimeException(&quot;not implemented yet&quot;);
121             }
122 
123             @Override
124             public String repositoryRef(String name) {
125                 return name.split(&quot;:&quot;)[1];
126             }
127 
128             @Override
129             public String repositoryName(String name) {
130                 var refIndex = name.indexOf(&#39;:&#39;);
131                 if (refIndex &gt;= 0) {
132                     name = name.substring(0, refIndex);
133                 }
134                 var orgIndex = name.lastIndexOf(&#39;/&#39;);
135                 if (orgIndex &gt;= 0) {
136                     name = name.substring(orgIndex + 1);
137                 }
138                 return name;
139             }
140 
141             @Override
142             public JSONObject specific() {
143                 return finalConfiguration;
144             }
145         };
146 
147         var factories = BotFactory.getBotFactories();
148         for (var factory : factories) {
149             if (factory.name().equals(name)) {
150                 var bots = factory.create(botConfiguration);
151                 if (bots.size() != 1) {
152                     throw new RuntimeException(&quot;Factory did not create a bot instance&quot;);
153                 }
154                 return bots.get(0);
155             }
156         }
157         throw new RuntimeException(&quot;Failed to find bot factory with name: &quot; + name);
158     }
159 }
    </pre>
  </body>
</html>