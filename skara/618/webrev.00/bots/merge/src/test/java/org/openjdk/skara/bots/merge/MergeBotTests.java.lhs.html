<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.merge;
  24 
  25 import org.openjdk.skara.host.*;
  26 import org.openjdk.skara.test.*;
  27 import org.openjdk.skara.vcs.*;
  28 import org.openjdk.skara.issuetracker.Issue;
  29 
  30 import org.junit.jupiter.api.Test;
  31 import org.junit.jupiter.api.TestInfo;
  32 
  33 import java.io.IOException;
  34 import java.nio.file.Files;
  35 import java.nio.file.StandardOpenOption;
  36 import java.util.*;
  37 import java.util.stream.Collectors;
  38 import java.time.DayOfWeek;
  39 import java.time.Month;
  40 import java.time.ZonedDateTime;
  41 import java.time.ZoneId;
  42 
  43 import static org.junit.jupiter.api.Assertions.*;
  44 
  45 class MergeBotTests {
  46     @Test
  47     void mergeMasterBranch(TestInfo testInfo) throws IOException {
  48         try (var temp = new TemporaryDirectory()) {
  49             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
  50 
  51             var fromDir = temp.path().resolve(&quot;from.git&quot;);
  52             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
  53             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
  54 
  55             var toDir = temp.path().resolve(&quot;to.git&quot;);
  56             var toLocalRepo = Repository.init(toDir, VCS.GIT);
  57             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  58             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  59                         StandardOpenOption.APPEND);
  60             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
  61 
  62             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
  63             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
  64             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  65             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  66                         StandardOpenOption.APPEND);
  67             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
  68 
  69             var now = ZonedDateTime.now();
  70             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
  71             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
  72             fromLocalRepo.add(fromFileA);
  73             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
  74             var fromCommits = fromLocalRepo.commits().asList();
  75             assertEquals(1, fromCommits.size());
  76             assertEquals(fromHashA, fromCommits.get(0).hash());
  77 
  78             var toFileA = toDir.resolve(&quot;a.txt&quot;);
  79             Files.writeString(toFileA, &quot;Hello A\n&quot;);
  80             toLocalRepo.add(toFileA);
  81             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
  82             var toCommits = toLocalRepo.commits().asList();
  83             assertEquals(1, toCommits.size());
  84             assertEquals(toHashA, toCommits.get(0).hash());
  85             assertEquals(fromHashA, toHashA);
  86 
  87             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
  88             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
  89             fromLocalRepo.add(fromFileB);
  90             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
  91 
  92             var toFileC = toDir.resolve(&quot;c.txt&quot;);
  93             Files.writeString(toFileC, &quot;Hello C\n&quot;);
  94             toLocalRepo.add(toFileC);
  95             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
  96 
  97             var storage = temp.path().resolve(&quot;storage&quot;);
  98             var master = new Branch(&quot;master&quot;);
  99             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 100             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 101             TestBotRunner.runPeriodicItems(bot);
 102 
 103             toCommits = toLocalRepo.commits().asList();
 104             assertEquals(4, toCommits.size());
 105             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 106             assertTrue(hashes.contains(toHashA));
 107             assertTrue(hashes.contains(fromHashB));
 108             assertTrue(hashes.contains(toHashC));
 109 
 110             var known = Set.of(toHashA, fromHashB, toHashC);
 111             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 112             assertTrue(merge.isMerge());
 113             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
 114             assertEquals(&quot;duke&quot;, merge.author().name());
 115             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 116 
 117             assertEquals(0, toHostedRepo.pullRequests().size());
 118         }
 119     }
 120 
 121     @Test
 122     void successfulDependency(TestInfo testInfo) throws IOException {
 123         try (var temp = new TemporaryDirectory(false)) {
 124             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 125 
 126             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 127             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 128             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 129 
 130             var toDir = temp.path().resolve(&quot;to.git&quot;);
 131             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 132             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 133             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 134                         StandardOpenOption.APPEND);
 135             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 136 
 137             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 138             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 139             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 140             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 141                         StandardOpenOption.APPEND);
 142             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 143 
 144             var now = ZonedDateTime.now();
 145             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 146             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 147             fromLocalRepo.add(fromFileA);
 148             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 149             var fromCommits = fromLocalRepo.commits().asList();
 150             assertEquals(1, fromCommits.size());
 151             assertEquals(fromHashA, fromCommits.get(0).hash());
 152 
 153             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 154             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 155             toLocalRepo.add(toFileA);
 156             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 157             var toCommits = toLocalRepo.commits().asList();
 158             assertEquals(1, toCommits.size());
 159             assertEquals(toHashA, toCommits.get(0).hash());
 160             assertEquals(fromHashA, toHashA);
 161             toLocalRepo.branch(toHashA, &quot;feature&quot;);
 162             assertEquals(2, toLocalRepo.branches().size());
 163 
 164             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 165             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 166             fromLocalRepo.add(fromFileB);
 167             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 168 
 169             var featureBranch = fromLocalRepo.branch(fromHashB, &quot;feature&quot;);
 170             fromLocalRepo.checkout(featureBranch);
 171             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 172             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 173             fromLocalRepo.add(fromFileD);
 174             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 175 
 176             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 177             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 178             toLocalRepo.add(toFileC);
 179             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 180 
 181             toLocalRepo.checkout(featureBranch);
 182             var toFileE = toDir.resolve(&quot;e.txt&quot;);
 183             Files.writeString(toFileE, &quot;Hello E\n&quot;);
 184             toLocalRepo.add(toFileE);
 185             var toHashE = toLocalRepo.commit(&quot;Adding e.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 186 
 187             var storage = temp.path().resolve(&quot;storage&quot;);
 188             var master = new Branch(&quot;master&quot;);
 189             var feature = new Branch(&quot;feature&quot;);
 190             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, null, &quot;master&quot;, List.of(), List.of()),
 191                                 new MergeBot.Spec(fromHostedRepo, feature, feature, null, &quot;feature&quot;, List.of(&quot;master&quot;), List.of()));
 192             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 193             TestBotRunner.runPeriodicItems(bot);
 194 
 195             toCommits = toLocalRepo.commits().asList();
 196             assertEquals(7, toCommits.size());
 197             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 198             assertTrue(hashes.contains(toHashA));
 199             assertTrue(hashes.contains(fromHashB));
 200             assertTrue(hashes.contains(toHashC));
 201 
 202             var merges = toCommits.stream().filter(c -&gt; c.isMerge()).collect(Collectors.toList());
 203             assertEquals(2, merges.size());
 204 
 205             assertTrue(merges.stream().anyMatch(c -&gt; c.message().get(0).equals(&quot;Automatic merge of test:master into master&quot;)));
 206             assertTrue(merges.stream().anyMatch(c -&gt; c.message().get(0).equals(&quot;Automatic merge of test:feature into feature&quot;)));
 207         }
 208     }
 209 
 210     @Test
 211     void failedDependency(TestInfo testInfo) throws IOException {
 212         try (var temp = new TemporaryDirectory(false)) {
 213             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 214 
 215             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 216             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 217             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 218 
 219             var toDir = temp.path().resolve(&quot;to.git&quot;);
 220             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 221             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 222             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 223                         StandardOpenOption.APPEND);
 224             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 225 
 226             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 227             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 228             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 229             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 230                         StandardOpenOption.APPEND);
 231             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 232 
 233             var now = ZonedDateTime.now();
 234             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 235             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 236             fromLocalRepo.add(fromFileA);
 237             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 238             var fromCommits = fromLocalRepo.commits().asList();
 239             assertEquals(1, fromCommits.size());
 240             assertEquals(fromHashA, fromCommits.get(0).hash());
 241 
 242             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 243             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 244             toLocalRepo.add(toFileA);
 245             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 246             var toCommits = toLocalRepo.commits().asList();
 247             assertEquals(1, toCommits.size());
 248             assertEquals(toHashA, toCommits.get(0).hash());
 249             assertEquals(fromHashA, toHashA);
 250             toLocalRepo.branch(toHashA, &quot;feature&quot;);
 251             assertEquals(2, toLocalRepo.branches().size());
 252 
 253             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 254             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 255             fromLocalRepo.add(fromFileB);
 256             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 257 
 258             var featureBranch = fromLocalRepo.branch(fromHashB, &quot;feature&quot;);
 259             fromLocalRepo.checkout(featureBranch);
 260             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 261             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 262             fromLocalRepo.add(fromFileD);
 263             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 264 
 265             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 266             Files.writeString(toFileB, &quot;Hello conflict\n&quot;);
 267             toLocalRepo.add(toFileB);
 268             var toHashB = toLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 269 
 270             toLocalRepo.checkout(featureBranch);
 271             var toFileE = toDir.resolve(&quot;e.txt&quot;);
 272             Files.writeString(toFileE, &quot;Hello E\n&quot;);
 273             toLocalRepo.add(toFileE);
 274             var toHashE = toLocalRepo.commit(&quot;Adding e.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 275 
 276             var toCommitsBeforeMerge = toLocalRepo.commits().asList();
 277             assertEquals(3, toCommitsBeforeMerge.size());
 278             assertEquals(toHashE, toCommitsBeforeMerge.get(0).hash());
 279             assertEquals(toHashB, toCommitsBeforeMerge.get(1).hash());
 280             assertEquals(toHashA, toCommitsBeforeMerge.get(2).hash());
 281             assertEquals(toHashB, toLocalRepo.resolve(&quot;master&quot;).get());
 282             assertEquals(toHashE, toLocalRepo.resolve(&quot;feature&quot;).get());
 283 
 284             var storage = temp.path().resolve(&quot;storage&quot;);
 285             var master = new Branch(&quot;master&quot;);
 286             var feature = new Branch(&quot;feature&quot;);
 287             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, null, &quot;master&quot;, List.of(), List.of()),
 288                                 new MergeBot.Spec(fromHostedRepo, feature, feature, null, &quot;feature&quot;, List.of(&quot;master&quot;), List.of()));
 289             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 290             TestBotRunner.runPeriodicItems(bot);
 291 
 292             toCommits = toLocalRepo.commits().asList();
 293             assertEquals(toCommitsBeforeMerge.size(), toCommits.size());
 294             assertEquals(toCommitsBeforeMerge.get(0).hash(), toCommits.get(0).hash());
 295             assertEquals(toCommitsBeforeMerge.get(1).hash(), toCommits.get(1).hash());
 296             assertEquals(toCommitsBeforeMerge.get(2).hash(), toCommits.get(2).hash());
 297             assertEquals(toHashB, toLocalRepo.resolve(&quot;master&quot;).get());
 298             assertEquals(toHashE, toLocalRepo.resolve(&quot;feature&quot;).get());
 299         }
 300     }
 301 
 302     @Test
 303     void failingMergeTest(TestInfo testInfo) throws IOException {
 304         try (var temp = new TemporaryDirectory()) {
 305             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 306 
 307             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 308             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 309             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 310 
 311             var toDir = temp.path().resolve(&quot;to.git&quot;);
 312             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 313             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 314             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 315                         StandardOpenOption.APPEND);
 316             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 317 
 318             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 319             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 320             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 321             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 322                         StandardOpenOption.APPEND);
 323             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 324 
 325             var now = ZonedDateTime.now();
 326             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 327             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 328             fromLocalRepo.add(fromFileA);
 329             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 330             var fromCommits = fromLocalRepo.commits().asList();
 331             assertEquals(1, fromCommits.size());
 332             assertEquals(fromHashA, fromCommits.get(0).hash());
 333 
 334             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 335             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 336             toLocalRepo.add(toFileA);
 337             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 338             var toCommits = toLocalRepo.commits().asList();
 339             assertEquals(1, toCommits.size());
 340             assertEquals(toHashA, toCommits.get(0).hash());
 341             assertEquals(fromHashA, toHashA);
 342 
 343             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 344             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 345             fromLocalRepo.add(fromFileB);
 346             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 347 
 348             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 349             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 350             toLocalRepo.add(toFileB);
 351             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 352 
 353             var storage = temp.path().resolve(&quot;storage&quot;);
 354             var master = new Branch(&quot;master&quot;);
 355             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 356             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 357             TestBotRunner.runPeriodicItems(bot);
 358 
 359             toCommits = toLocalRepo.commits().asList();
 360             assertEquals(2, toCommits.size());
 361             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 362             assertTrue(toHashes.contains(toHashA));
 363             assertTrue(toHashes.contains(toHashB));
 364 
 365             var pullRequests = toHostedRepo.pullRequests();
 366             assertEquals(1, pullRequests.size());
 367             var pr = pullRequests.get(0);
 368             assertEquals(&quot;Merge test:master&quot;, pr.title());
 369             assertTrue(pr.labels().contains(&quot;failed-auto-merge&quot;));
 370         }
 371     }
 372 
 373     @Test
 374     void failingPrerequisite(TestInfo testInfo) throws IOException {
 375         try (var temp = new TemporaryDirectory()) {
 376             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 377 
 378             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 379             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 380             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 381 
 382             var toDir = temp.path().resolve(&quot;to.git&quot;);
 383             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 384             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 385             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 386                         StandardOpenOption.APPEND);
 387             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 388 
 389             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 390             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 391             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 392             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 393                         StandardOpenOption.APPEND);
 394             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 395 
 396             var now = ZonedDateTime.now();
 397             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 398             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 399             fromLocalRepo.add(fromFileA);
 400             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 401             var fromCommits = fromLocalRepo.commits().asList();
 402             assertEquals(1, fromCommits.size());
 403             assertEquals(fromHashA, fromCommits.get(0).hash());
 404 
 405             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 406             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 407             toLocalRepo.add(toFileA);
 408             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 409             var toCommits = toLocalRepo.commits().asList();
 410             assertEquals(1, toCommits.size());
 411             assertEquals(toHashA, toCommits.get(0).hash());
 412             assertEquals(fromHashA, toHashA);
 413 
 414             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 415             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 416             fromLocalRepo.add(fromFileB);
 417             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 418 
 419             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 420             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 421             toLocalRepo.add(toFileB);
 422             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 423 
 424             var storage = temp.path().resolve(&quot;storage&quot;);
 425             var master = new Branch(&quot;master&quot;);
 426             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 427             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 428             TestBotRunner.runPeriodicItems(bot);
 429 
 430             toCommits = toLocalRepo.commits().asList();
 431             assertEquals(2, toCommits.size());
 432             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 433             assertTrue(toHashes.contains(toHashA));
 434             assertTrue(toHashes.contains(toHashB));
 435 
 436             var pullRequests = toHostedRepo.pullRequests();
 437             assertEquals(1, pullRequests.size());
 438             var pr = pullRequests.get(0);
 439             assertEquals(&quot;Merge test:master&quot;, pr.title());
 440 
 441             var fromDir2 = temp.path().resolve(&quot;from2.git&quot;);
 442             var fromLocalRepo2 = Repository.init(fromDir2, VCS.GIT);
 443             var fromHostedRepo2 = new TestHostedRepository(host, &quot;test-2&quot;, fromLocalRepo2);
 444 
 445             var host2 = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 446             var toDir2 = temp.path().resolve(&quot;to2.git&quot;);
 447             var toLocalRepo2 = Repository.init(toDir2, VCS.GIT);
 448             var toGitConfig2 = toDir2.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 449             Files.write(toGitConfig2, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 450                         StandardOpenOption.APPEND);
 451             var toHostedRepo2 = new TestHostedRepository(host2, &quot;test-mirror-2&quot;, toLocalRepo2);
 452 
 453             var forkDir2 = temp.path().resolve(&quot;fork2.git&quot;);
 454             var forkLocalRepo2 = Repository.init(forkDir2, VCS.GIT);
 455             var forkGitConfig2 = forkDir2.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 456             Files.write(forkGitConfig2, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 457                         StandardOpenOption.APPEND);
 458             var toFork2 = new TestHostedRepository(host2, &quot;test-mirror-fork-2&quot;, forkLocalRepo2);
 459 
 460             var now2 = ZonedDateTime.now();
 461             var fromFileA2 = fromDir2.resolve(&quot;a2.txt&quot;);
 462             Files.writeString(fromFileA2, &quot;Hello A2\n&quot;);
 463             fromLocalRepo2.add(fromFileA2);
 464             var fromHashA2 = fromLocalRepo2.commit(&quot;Adding a2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now2);
 465 
 466             var toFileA2 = toDir2.resolve(&quot;a2.txt&quot;);
 467             Files.writeString(toFileA2, &quot;Hello A2\n&quot;);
 468             toLocalRepo2.add(toFileA2);
 469             var toHashA2 = toLocalRepo2.commit(&quot;Adding a2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now2);
 470             var toCommits2 = toLocalRepo2.commits().asList();
 471             assertEquals(1, toCommits2.size());
 472             assertEquals(toHashA2, toCommits2.get(0).hash());
 473             assertEquals(fromHashA2, toHashA2);
 474 
 475             var fromFileB2 = fromDir2.resolve(&quot;b2.txt&quot;);
 476             Files.writeString(fromFileB2, &quot;Hello B2\n&quot;);
 477             fromLocalRepo2.add(fromFileB2);
 478             var fromHashB2 = fromLocalRepo2.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 479             var fromCommits2 = fromLocalRepo2.commits().asList();
 480             assertEquals(2, fromCommits2.size());
 481             assertEquals(fromHashB2, fromCommits2.get(0).hash());
 482             assertEquals(fromHashA2, fromCommits2.get(1).hash());
 483 
 484             var storage2 = temp.path().resolve(&quot;storage-2&quot;);
 485             var master2 = new Branch(&quot;master&quot;);
 486             var specs2 = List.of(new MergeBot.Spec(fromHostedRepo2, master2, master2, null, &quot;master&quot;, List.of(), List.of(toHostedRepo)));
 487             var bot2 = new MergeBot(storage2, toHostedRepo2, toFork2, specs2);
 488             TestBotRunner.runPeriodicItems(bot2);
 489 
 490             var toCommitsAfterMerge2 = toLocalRepo2.commits().asList();
 491             assertEquals(1, toCommitsAfterMerge2.size());
 492             assertEquals(toHashA2, toCommitsAfterMerge2.get(0).hash());
 493             assertEquals(toHashA2, toLocalRepo2.resolve(&quot;master&quot;).get());
 494 
 495             pr.setState(Issue.State.CLOSED);
 496             TestBotRunner.runPeriodicItems(bot2);
 497             toCommitsAfterMerge2 = toLocalRepo2.commits().asList();
 498             assertEquals(2, toCommitsAfterMerge2.size());
 499             assertEquals(fromHashB2, toCommitsAfterMerge2.get(0).hash());
 500             assertEquals(toHashA2, toCommitsAfterMerge2.get(1).hash());
 501             assertEquals(fromHashB2, toLocalRepo2.resolve(&quot;master&quot;).get());
 502         }
 503     }
 504 
 505     @Test
 506     void failingMergeShouldResultInOnlyOnePR(TestInfo testInfo) throws IOException {
 507         try (var temp = new TemporaryDirectory()) {
 508             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 509 
 510             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 511             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 512             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 513 
 514             var toDir = temp.path().resolve(&quot;to.git&quot;);
 515             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 516             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 517             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 518                         StandardOpenOption.APPEND);
 519             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 520 
 521             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 522             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 523             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 524             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 525                         StandardOpenOption.APPEND);
 526             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 527 
 528             var now = ZonedDateTime.now();
 529             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 530             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 531             fromLocalRepo.add(fromFileA);
 532             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 533             var fromCommits = fromLocalRepo.commits().asList();
 534             assertEquals(1, fromCommits.size());
 535             assertEquals(fromHashA, fromCommits.get(0).hash());
 536 
 537             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 538             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 539             toLocalRepo.add(toFileA);
 540             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 541             var toCommits = toLocalRepo.commits().asList();
 542             assertEquals(1, toCommits.size());
 543             assertEquals(toHashA, toCommits.get(0).hash());
 544             assertEquals(fromHashA, toHashA);
 545 
 546             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 547             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 548             fromLocalRepo.add(fromFileB);
 549             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 550 
 551             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 552             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 553             toLocalRepo.add(toFileB);
 554             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 555 
 556             var storage = temp.path().resolve(&quot;storage&quot;);
 557             var master = new Branch(&quot;master&quot;);
 558             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 559             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 560             TestBotRunner.runPeriodicItems(bot);
 561             TestBotRunner.runPeriodicItems(bot);
 562 
 563             toCommits = toLocalRepo.commits().asList();
 564             assertEquals(2, toCommits.size());
 565             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 566             assertTrue(toHashes.contains(toHashA));
 567             assertTrue(toHashes.contains(toHashB));
 568 
 569             var pullRequests = toHostedRepo.pullRequests();
 570             assertEquals(1, pullRequests.size());
 571             var pr = pullRequests.get(0);
 572             assertEquals(&quot;Merge test:master&quot;, pr.title());
 573         }
 574     }
 575 
 576     @Test
 577     void resolvedMergeConflictShouldResultInIntegrateCommand(TestInfo testInfo) throws IOException {
 578         try (var temp = new TemporaryDirectory()) {
 579             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 580 
 581             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 582             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 583             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 584 
 585             var toDir = temp.path().resolve(&quot;to.git&quot;);
 586             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 587             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 588             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 589                         StandardOpenOption.APPEND);
 590             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 591 
 592             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 593             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 594             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 595             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 596                         StandardOpenOption.APPEND);
 597             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 598 
 599             var now = ZonedDateTime.now();
 600             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 601             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 602             fromLocalRepo.add(fromFileA);
 603             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 604             var fromCommits = fromLocalRepo.commits().asList();
 605             assertEquals(1, fromCommits.size());
 606             assertEquals(fromHashA, fromCommits.get(0).hash());
 607 
 608             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 609             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 610             toLocalRepo.add(toFileA);
 611             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 612             var toCommits = toLocalRepo.commits().asList();
 613             assertEquals(1, toCommits.size());
 614             assertEquals(toHashA, toCommits.get(0).hash());
 615             assertEquals(fromHashA, toHashA);
 616 
 617             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 618             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 619             fromLocalRepo.add(fromFileB);
 620             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 621 
 622             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 623             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 624             toLocalRepo.add(toFileB);
 625             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 626 
 627             var storage = temp.path().resolve(&quot;storage&quot;);
 628             var master = new Branch(&quot;master&quot;);
 629             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 630             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 631             TestBotRunner.runPeriodicItems(bot);
 632             TestBotRunner.runPeriodicItems(bot);
 633 
 634             toCommits = toLocalRepo.commits().asList();
 635             assertEquals(2, toCommits.size());
 636             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 637             assertTrue(toHashes.contains(toHashA));
 638             assertTrue(toHashes.contains(toHashB));
 639 
 640             var pullRequests = toHostedRepo.pullRequests();
 641             assertEquals(1, pullRequests.size());
 642             var pr = pullRequests.get(0);
 643             assertEquals(&quot;Merge test:master&quot;, pr.title());
 644             assertTrue(pr.labels().contains(&quot;failed-auto-merge&quot;));
 645             assertTrue(forkLocalRepo.branches().contains(new Branch(&quot;master&quot;)));
 646             assertTrue(forkLocalRepo.branches().contains(new Branch(&quot;2&quot;)));
 647 
 648             // Bot should do nothing as long as PR is presnt
 649             TestBotRunner.runPeriodicItems(bot);
 650             pullRequests = toHostedRepo.pullRequests();
 651             assertEquals(1, pullRequests.size());
 652             pr = pullRequests.get(0);
 653 
 654             // Simulate that the merge-conflict has been resolved by adding the &quot;ready&quot; label
 655             pr.addLabel(&quot;ready&quot;);
 656             TestBotRunner.runPeriodicItems(bot);
 657             pullRequests = toHostedRepo.pullRequests();
 658             assertEquals(1, pullRequests.size());
 659 
 660             pr = pullRequests.get(0);
 661             var numComments = pr.comments().size();
 662             var lastComment = pr.comments().get(pr.comments().size() - 1);
<a name="1" id="anc1"></a><span class="line-modified"> 663             assertEquals(&quot;/integrate&quot;, lastComment.body());</span>
 664 
 665             // Running the bot again should not result in another comment
 666             TestBotRunner.runPeriodicItems(bot);
 667             assertEquals(numComments, toHostedRepo.pullRequests().size());
 668         }
 669     }
 670 
 671     final static class TestClock implements Clock {
 672         ZonedDateTime now;
 673 
 674         TestClock() {
 675             this(null);
 676         }
 677 
 678         TestClock(ZonedDateTime now) {
 679             this.now = now;
 680         }
 681 
 682         @Override
 683         public ZonedDateTime now() {
 684             return now;
 685         }
 686     }
 687 
 688     @Test
 689     void testMergeHourly(TestInfo testInfo) throws IOException {
 690         try (var temp = new TemporaryDirectory()) {
 691             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 692 
 693             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 694             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 695             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 696 
 697             var toDir = temp.path().resolve(&quot;to.git&quot;);
 698             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 699             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 700             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 701                         StandardOpenOption.APPEND);
 702             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 703 
 704             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 705             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 706             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 707             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 708                         StandardOpenOption.APPEND);
 709             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 710 
 711             var now = ZonedDateTime.now();
 712             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 713             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 714             fromLocalRepo.add(fromFileA);
 715             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 716             var fromCommits = fromLocalRepo.commits().asList();
 717             assertEquals(1, fromCommits.size());
 718             assertEquals(fromHashA, fromCommits.get(0).hash());
 719 
 720             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 721             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 722             toLocalRepo.add(toFileA);
 723             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 724             var toCommits = toLocalRepo.commits().asList();
 725             assertEquals(1, toCommits.size());
 726             assertEquals(toHashA, toCommits.get(0).hash());
 727             assertEquals(fromHashA, toHashA);
 728 
 729             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 730             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 731             fromLocalRepo.add(fromFileB);
 732             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 733 
 734             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 735             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 736             toLocalRepo.add(toFileC);
 737             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 738 
 739             var storage = temp.path().resolve(&quot;storage&quot;);
 740             var master = new Branch(&quot;master&quot;);
 741 
 742             // Merge only at most once during the first minute every hour
 743             var freq = MergeBot.Spec.Frequency.hourly(1);
 744             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 745 
 746             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 15, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 747             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 748 
 749             TestBotRunner.runPeriodicItems(bot);
 750 
 751             // Ensure nothing has been merged
 752             toCommits = toLocalRepo.commits().asList();
 753             assertEquals(2, toCommits.size());
 754             assertEquals(toHashC, toCommits.get(0).hash());
 755             assertEquals(toHashA, toCommits.get(1).hash());
 756 
 757             // Set the clock to the first minute of the hour
 758             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 759             TestBotRunner.runPeriodicItems(bot);
 760 
 761             // Should have merged
 762             toCommits = toLocalRepo.commits().asList();
 763             assertEquals(4, toCommits.size());
 764             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 765             assertTrue(hashes.contains(toHashA));
 766             assertTrue(hashes.contains(fromHashB));
 767             assertTrue(hashes.contains(toHashC));
 768 
 769             var known = Set.of(toHashA, fromHashB, toHashC);
 770             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 771             assertTrue(merge.isMerge());
 772             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
 773             assertEquals(&quot;duke&quot;, merge.author().name());
 774             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 775 
 776             assertEquals(0, toHostedRepo.pullRequests().size());
 777 
 778             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 779             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 780             fromLocalRepo.add(fromFileD);
 781             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 782 
 783             // Since the time hasn&#39;t changed it should not merge again
 784             TestBotRunner.runPeriodicItems(bot);
 785             toCommits = toLocalRepo.commits().asList();
 786             assertEquals(4, toCommits.size());
 787 
 788             // Move the minutes forward, the bot should not merge
 789             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 790             TestBotRunner.runPeriodicItems(bot);
 791             toCommits = toLocalRepo.commits().asList();
 792             assertEquals(4, toCommits.size());
 793 
 794             // Move the clock forward one hour, the bot should merge
 795             clock.now = ZonedDateTime.of(2020, 1, 23, 16, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 796             TestBotRunner.runPeriodicItems(bot);
 797 
 798             toCommits = toLocalRepo.commits().asList();
 799             assertEquals(6, toCommits.size());
 800         }
 801     }
 802 
 803     @Test
 804     void testMergeDaily(TestInfo testInfo) throws IOException {
 805         try (var temp = new TemporaryDirectory()) {
 806             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 807 
 808             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 809             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 810             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 811 
 812             var toDir = temp.path().resolve(&quot;to.git&quot;);
 813             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 814             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 815             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 816                         StandardOpenOption.APPEND);
 817             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
 818 
 819             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 820             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 821             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 822             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 823                         StandardOpenOption.APPEND);
 824             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 825 
 826             var now = ZonedDateTime.now();
 827             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 828             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 829             fromLocalRepo.add(fromFileA);
 830             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 831             var fromCommits = fromLocalRepo.commits().asList();
 832             assertEquals(1, fromCommits.size());
 833             assertEquals(fromHashA, fromCommits.get(0).hash());
 834 
 835             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 836             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 837             toLocalRepo.add(toFileA);
 838             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 839             var toCommits = toLocalRepo.commits().asList();
 840             assertEquals(1, toCommits.size());
 841             assertEquals(toHashA, toCommits.get(0).hash());
 842             assertEquals(fromHashA, toHashA);
 843 
 844             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 845             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 846             fromLocalRepo.add(fromFileB);
 847             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 848 
 849             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 850             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 851             toLocalRepo.add(toFileC);
 852             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 853 
 854             var storage = temp.path().resolve(&quot;storage&quot;);
 855             var master = new Branch(&quot;master&quot;);
 856 
 857             // Merge only at most once during the third hour every day
 858             var freq = MergeBot.Spec.Frequency.daily(3);
 859             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 860 
 861             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 2, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 862             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 863 
 864             TestBotRunner.runPeriodicItems(bot);
 865 
 866             // Ensure nothing has been merged
 867             toCommits = toLocalRepo.commits().asList();
 868             assertEquals(2, toCommits.size());
 869             assertEquals(toHashC, toCommits.get(0).hash());
 870             assertEquals(toHashA, toCommits.get(1).hash());
 871 
 872             // Set the clock to the third hour of the day (minutes should not matter)
 873             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 874             TestBotRunner.runPeriodicItems(bot);
 875 
 876             // Should have merged
 877             toCommits = toLocalRepo.commits().asList();
 878             assertEquals(4, toCommits.size());
 879             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 880             assertTrue(hashes.contains(toHashA));
 881             assertTrue(hashes.contains(fromHashB));
 882             assertTrue(hashes.contains(toHashC));
 883 
 884             var known = Set.of(toHashA, fromHashB, toHashC);
 885             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 886             assertTrue(merge.isMerge());
 887             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
 888             assertEquals(&quot;duke&quot;, merge.author().name());
 889             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 890 
 891             assertEquals(0, toHostedRepo.pullRequests().size());
 892 
 893             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 894             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 895             fromLocalRepo.add(fromFileD);
 896             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 897 
 898             // Since the time hasn&#39;t changed it should not merge
 899             TestBotRunner.runPeriodicItems(bot);
 900             toCommits = toLocalRepo.commits().asList();
 901             assertEquals(4, toCommits.size());
 902 
 903             // Move the minutes forward, the bot should not merge
 904             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 905             TestBotRunner.runPeriodicItems(bot);
 906             toCommits = toLocalRepo.commits().asList();
 907             assertEquals(4, toCommits.size());
 908 
 909             // Move the hours forward, the bot should not merge
 910             clock.now = ZonedDateTime.of(2020, 1, 23, 17, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 911             TestBotRunner.runPeriodicItems(bot);
 912             toCommits = toLocalRepo.commits().asList();
 913             assertEquals(4, toCommits.size());
 914 
 915             // Move the clock forward one day, the bot should merge
 916             clock.now = ZonedDateTime.of(2020, 1, 24, 3, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 917             TestBotRunner.runPeriodicItems(bot);
 918 
 919             toCommits = toLocalRepo.commits().asList();
 920             assertEquals(6, toCommits.size());
 921         }
 922     }
 923 
 924     @Test
 925     void testMergeWeekly(TestInfo testInfo) throws IOException {
 926         try (var temp = new TemporaryDirectory()) {
 927             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 928 
 929             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 930             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 931             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 932 
 933             var toDir = temp.path().resolve(&quot;to.git&quot;);
 934             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 935             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 936             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 937                         StandardOpenOption.APPEND);
 938             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 939 
 940             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 941             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 942             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 943             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 944                         StandardOpenOption.APPEND);
 945             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 946 
 947             var now = ZonedDateTime.now();
 948             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 949             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 950             fromLocalRepo.add(fromFileA);
 951             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 952             var fromCommits = fromLocalRepo.commits().asList();
 953             assertEquals(1, fromCommits.size());
 954             assertEquals(fromHashA, fromCommits.get(0).hash());
 955 
 956             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 957             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 958             toLocalRepo.add(toFileA);
 959             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 960             var toCommits = toLocalRepo.commits().asList();
 961             assertEquals(1, toCommits.size());
 962             assertEquals(toHashA, toCommits.get(0).hash());
 963             assertEquals(fromHashA, toHashA);
 964 
 965             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 966             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 967             fromLocalRepo.add(fromFileB);
 968             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 969 
 970             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 971             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 972             toLocalRepo.add(toFileC);
 973             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 974 
 975             var storage = temp.path().resolve(&quot;storage&quot;);
 976             var master = new Branch(&quot;master&quot;);
 977 
 978             // Merge only at most once per week on Friday&#39;s at 12:00
 979             var freq = MergeBot.Spec.Frequency.weekly(DayOfWeek.FRIDAY, 12);
 980             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 981 
 982             var clock = new TestClock(ZonedDateTime.of(2020, 1, 24, 11, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 983             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 984 
 985             TestBotRunner.runPeriodicItems(bot);
 986 
 987             // Ensure nothing has been merged
 988             toCommits = toLocalRepo.commits().asList();
 989             assertEquals(2, toCommits.size());
 990             assertEquals(toHashC, toCommits.get(0).hash());
 991             assertEquals(toHashA, toCommits.get(1).hash());
 992 
 993             // Set the clock to the 12th hour of the day (minutes should not matter)
 994             clock.now = ZonedDateTime.of(2020, 1, 24, 12, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 995             TestBotRunner.runPeriodicItems(bot);
 996 
 997             // Should have merged
 998             toCommits = toLocalRepo.commits().asList();
 999             assertEquals(4, toCommits.size());
1000             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
1001             assertTrue(hashes.contains(toHashA));
1002             assertTrue(hashes.contains(fromHashB));
1003             assertTrue(hashes.contains(toHashC));
1004 
1005             var known = Set.of(toHashA, fromHashB, toHashC);
1006             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
1007             assertTrue(merge.isMerge());
1008             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
1009             assertEquals(&quot;duke&quot;, merge.author().name());
1010             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
1011 
1012             assertEquals(0, toHostedRepo.pullRequests().size());
1013 
1014             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
1015             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
1016             fromLocalRepo.add(fromFileD);
1017             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1018 
1019             // Since the time hasn&#39;t changed it should not merge
1020             TestBotRunner.runPeriodicItems(bot);
1021             toCommits = toLocalRepo.commits().asList();
1022             assertEquals(4, toCommits.size());
1023 
1024             // Move the hours forward, the bot should not merge
1025             clock.now = ZonedDateTime.of(2020, 1, 24, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1026             TestBotRunner.runPeriodicItems(bot);
1027             toCommits = toLocalRepo.commits().asList();
1028             assertEquals(4, toCommits.size());
1029 
1030             // Move the days forward, the bot should not merge
1031             clock.now = ZonedDateTime.of(2020, 1, 25, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1032             TestBotRunner.runPeriodicItems(bot);
1033             toCommits = toLocalRepo.commits().asList();
1034             assertEquals(4, toCommits.size());
1035 
1036             // Move the clock forward one week, the bot should merge
1037             clock.now = ZonedDateTime.of(2020, 1, 31, 12, 29, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1038             TestBotRunner.runPeriodicItems(bot);
1039 
1040             toCommits = toLocalRepo.commits().asList();
1041             assertEquals(6, toCommits.size());
1042         }
1043     }
1044 
1045     @Test
1046     void testMergeMonthly(TestInfo testInfo) throws IOException {
1047         try (var temp = new TemporaryDirectory()) {
1048             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
1049 
1050             var fromDir = temp.path().resolve(&quot;from.git&quot;);
1051             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
1052             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
1053 
1054             var toDir = temp.path().resolve(&quot;to.git&quot;);
1055             var toLocalRepo = Repository.init(toDir, VCS.GIT);
1056             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
1057             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
1058                         StandardOpenOption.APPEND);
1059             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
1060 
1061             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
1062             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
1063             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
1064             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
1065                         StandardOpenOption.APPEND);
1066             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
1067 
1068             var now = ZonedDateTime.now();
1069             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
1070             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
1071             fromLocalRepo.add(fromFileA);
1072             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
1073             var fromCommits = fromLocalRepo.commits().asList();
1074             assertEquals(1, fromCommits.size());
1075             assertEquals(fromHashA, fromCommits.get(0).hash());
1076 
1077             var toFileA = toDir.resolve(&quot;a.txt&quot;);
1078             Files.writeString(toFileA, &quot;Hello A\n&quot;);
1079             toLocalRepo.add(toFileA);
1080             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
1081             var toCommits = toLocalRepo.commits().asList();
1082             assertEquals(1, toCommits.size());
1083             assertEquals(toHashA, toCommits.get(0).hash());
1084             assertEquals(fromHashA, toHashA);
1085 
1086             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
1087             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
1088             fromLocalRepo.add(fromFileB);
1089             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1090 
1091             var toFileC = toDir.resolve(&quot;c.txt&quot;);
1092             Files.writeString(toFileC, &quot;Hello C\n&quot;);
1093             toLocalRepo.add(toFileC);
1094             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1095 
1096             var storage = temp.path().resolve(&quot;storage&quot;);
1097             var master = new Branch(&quot;master&quot;);
1098 
1099             // Merge only at most once per month on the 17th day at at 11:00
1100             var freq = MergeBot.Spec.Frequency.monthly(17, 11);
1101             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
1102 
1103             var clock = new TestClock(ZonedDateTime.of(2020, 1, 16, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
1104             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
1105 
1106             TestBotRunner.runPeriodicItems(bot);
1107 
1108             // Ensure nothing has been merged
1109             toCommits = toLocalRepo.commits().asList();
1110             assertEquals(2, toCommits.size());
1111             assertEquals(toHashC, toCommits.get(0).hash());
1112             assertEquals(toHashA, toCommits.get(1).hash());
1113 
1114             // Set the clock to the 17th day and at hour 11 (minutes should not matter)
1115             clock.now = ZonedDateTime.of(2020, 1, 17, 11, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1116             TestBotRunner.runPeriodicItems(bot);
1117 
1118             // Should have merged
1119             toCommits = toLocalRepo.commits().asList();
1120             assertEquals(4, toCommits.size());
1121             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
1122             assertTrue(hashes.contains(toHashA));
1123             assertTrue(hashes.contains(fromHashB));
1124             assertTrue(hashes.contains(toHashC));
1125 
1126             var known = Set.of(toHashA, fromHashB, toHashC);
1127             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
1128             assertTrue(merge.isMerge());
1129             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
1130             assertEquals(&quot;duke&quot;, merge.author().name());
1131             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
1132 
1133             assertEquals(0, toHostedRepo.pullRequests().size());
1134 
1135             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
1136             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
1137             fromLocalRepo.add(fromFileD);
1138             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1139 
1140             // Since the time hasn&#39;t changed it should not merge
1141             TestBotRunner.runPeriodicItems(bot);
1142             toCommits = toLocalRepo.commits().asList();
1143             assertEquals(4, toCommits.size());
1144 
1145             // Move the hours forward, the bot should not merge
1146             clock.now = ZonedDateTime.of(2020, 1, 17, 12, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1147             TestBotRunner.runPeriodicItems(bot);
1148             toCommits = toLocalRepo.commits().asList();
1149             assertEquals(4, toCommits.size());
1150 
1151             // Move the days forward, the bot should not merge
1152             clock.now = ZonedDateTime.of(2020, 1, 18, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1153             TestBotRunner.runPeriodicItems(bot);
1154             toCommits = toLocalRepo.commits().asList();
1155             assertEquals(4, toCommits.size());
1156 
1157             // Move the clock forward one month, the bot should merge
1158             clock.now = ZonedDateTime.of(2020, 2, 17, 11, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1159             TestBotRunner.runPeriodicItems(bot);
1160 
1161             toCommits = toLocalRepo.commits().asList();
1162             assertEquals(6, toCommits.size());
1163         }
1164     }
1165 
1166     @Test
1167     void testMergeYearly(TestInfo testInfo) throws IOException {
1168         try (var temp = new TemporaryDirectory()) {
1169             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
1170 
1171             var fromDir = temp.path().resolve(&quot;from.git&quot;);
1172             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
1173             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
1174 
1175             var toDir = temp.path().resolve(&quot;to.git&quot;);
1176             var toLocalRepo = Repository.init(toDir, VCS.GIT);
1177             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
1178             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
1179                         StandardOpenOption.APPEND);
1180             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
1181 
1182             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
1183             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
1184             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
1185             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
1186                         StandardOpenOption.APPEND);
1187             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
1188 
1189             var now = ZonedDateTime.now();
1190             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
1191             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
1192             fromLocalRepo.add(fromFileA);
1193             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
1194             var fromCommits = fromLocalRepo.commits().asList();
1195             assertEquals(1, fromCommits.size());
1196             assertEquals(fromHashA, fromCommits.get(0).hash());
1197 
1198             var toFileA = toDir.resolve(&quot;a.txt&quot;);
1199             Files.writeString(toFileA, &quot;Hello A\n&quot;);
1200             toLocalRepo.add(toFileA);
1201             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
1202             var toCommits = toLocalRepo.commits().asList();
1203             assertEquals(1, toCommits.size());
1204             assertEquals(toHashA, toCommits.get(0).hash());
1205             assertEquals(fromHashA, toHashA);
1206 
1207             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
1208             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
1209             fromLocalRepo.add(fromFileB);
1210             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1211 
1212             var toFileC = toDir.resolve(&quot;c.txt&quot;);
1213             Files.writeString(toFileC, &quot;Hello C\n&quot;);
1214             toLocalRepo.add(toFileC);
1215             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1216 
1217             var storage = temp.path().resolve(&quot;storage&quot;);
1218             var master = new Branch(&quot;master&quot;);
1219 
1220             // Merge only at most once per year on the 29th day of May at at 07:00
1221             var freq = MergeBot.Spec.Frequency.yearly(Month.MAY, 29, 07);
1222             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
1223 
1224             var clock = new TestClock(ZonedDateTime.of(2020, 5, 27, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
1225             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
1226 
1227             TestBotRunner.runPeriodicItems(bot);
1228 
1229             // Ensure nothing has been merged
1230             toCommits = toLocalRepo.commits().asList();
1231             assertEquals(2, toCommits.size());
1232             assertEquals(toHashC, toCommits.get(0).hash());
1233             assertEquals(toHashA, toCommits.get(1).hash());
1234 
1235             // Set the clock to the 29th of May and at hour 11 (minutes should not matter)
1236             clock.now = ZonedDateTime.of(2020, 5, 29, 7, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1237             TestBotRunner.runPeriodicItems(bot);
1238 
1239             // Should have merged
1240             toCommits = toLocalRepo.commits().asList();
1241             assertEquals(4, toCommits.size());
1242             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
1243             assertTrue(hashes.contains(toHashA));
1244             assertTrue(hashes.contains(fromHashB));
1245             assertTrue(hashes.contains(toHashC));
1246 
1247             var known = Set.of(toHashA, fromHashB, toHashC);
1248             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
1249             assertTrue(merge.isMerge());
1250             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
1251             assertEquals(&quot;duke&quot;, merge.author().name());
1252             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
1253 
1254             assertEquals(0, toHostedRepo.pullRequests().size());
1255 
1256             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
1257             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
1258             fromLocalRepo.add(fromFileD);
1259             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1260 
1261             // Since the time hasn&#39;t changed it should not merge again
1262             TestBotRunner.runPeriodicItems(bot);
1263             toCommits = toLocalRepo.commits().asList();
1264             assertEquals(4, toCommits.size());
1265 
1266             // Move the hours forward, the bot should not merge
1267             clock.now = ZonedDateTime.of(2020, 5, 29, 8, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1268             TestBotRunner.runPeriodicItems(bot);
1269             toCommits = toLocalRepo.commits().asList();
1270             assertEquals(4, toCommits.size());
1271 
1272             // Move the days forward, the bot should not merge
1273             clock.now = ZonedDateTime.of(2020, 5, 30, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1274             TestBotRunner.runPeriodicItems(bot);
1275             toCommits = toLocalRepo.commits().asList();
1276             assertEquals(4, toCommits.size());
1277 
1278             // Move the months forward, the bot should not merge
1279             clock.now = ZonedDateTime.of(2020, 7, 29, 7, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1280             TestBotRunner.runPeriodicItems(bot);
1281             toCommits = toLocalRepo.commits().asList();
1282             assertEquals(4, toCommits.size());
1283 
1284             // Move the clock forward one year, the bot should merge
1285             clock.now = ZonedDateTime.of(2021, 5, 29, 7, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1286             TestBotRunner.runPeriodicItems(bot);
1287 
1288             toCommits = toLocalRepo.commits().asList();
1289             assertEquals(6, toCommits.size());
1290         }
1291     }
1292 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>