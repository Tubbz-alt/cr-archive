<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff cli/src/main/java/org/openjdk/skara/cli/GitPublish.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="GitSync.java.udiff.html" target="_top">next &gt;</a></center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitPublish.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,10 +26,11 @@</span>
  import org.openjdk.skara.vcs.*;
  import org.openjdk.skara.version.Version;
  
  import java.io.*;
  import java.nio.file.*;
<span class="udiff-line-added">+ import java.net.URI;</span>
  import java.util.*;
  import java.util.function.Supplier;
  import java.util.logging.Level;
  
  public class GitPublish {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -63,10 +64,20 @@</span>
              System.out.flush();
          }
          return err;
      }
  
<span class="udiff-line-added">+     private static String getOption(String name, Arguments arguments, ReadOnlyRepository repo) throws IOException {</span>
<span class="udiff-line-added">+         if (arguments.contains(name)) {</span>
<span class="udiff-line-added">+             return arguments.get(name).asString();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         var lines = repo.config(&quot;sync.&quot; + name);</span>
<span class="udiff-line-added">+         return lines.size() == 1 ? lines.get(0) : null;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
      public static void main(String[] args) throws IOException, InterruptedException {
          var flags = List.of(
              Switch.shortcut(&quot;q&quot;)
                    .fullname(&quot;quiet&quot;)
                    .helptext(&quot;Silence all output&quot;)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -106,10 +117,31 @@</span>
  
          var cwd = Path.of(&quot;&quot;).toAbsolutePath();
          var repo = Repository.get(cwd).or(die(&quot;error: no repository found at &quot; + cwd.toString())).get();
          var remote = arguments.at(0).orString(&quot;origin&quot;);
  
<span class="udiff-line-added">+         var pushPath = repo.pushPath(remote);</span>
<span class="udiff-line-added">+         if (pushPath.startsWith(&quot;http://&quot;) || pushPath.startsWith(&quot;https://&quot;)) {</span>
<span class="udiff-line-added">+             var uri = URI.create(pushPath);</span>
<span class="udiff-line-added">+             var token = System.getenv(&quot;GIT_TOKEN&quot;);</span>
<span class="udiff-line-added">+             var username = getOption(&quot;username&quot;, arguments, repo);</span>
<span class="udiff-line-added">+             var credentials = GitCredentials.fill(uri.getHost(),</span>
<span class="udiff-line-added">+                                                   uri.getPath(),</span>
<span class="udiff-line-added">+                                                   username,</span>
<span class="udiff-line-added">+                                                   token,</span>
<span class="udiff-line-added">+                                                   uri.getScheme());</span>
<span class="udiff-line-added">+             if (credentials.password() == null) {</span>
<span class="udiff-line-added">+                 die(&quot;error: no personal access token found, use git-credentials or the environment variable GIT_TOKEN&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (credentials.username() == null) {</span>
<span class="udiff-line-added">+                 die(&quot;error: no username for &quot; + uri.getHost() + &quot; found, use git-credentials or the flag --username&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (token != null) {</span>
<span class="udiff-line-added">+                 GitCredentials.approve(credentials);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          var currentBranch = repo.currentBranch();
          if (currentBranch.isEmpty()) {
              System.err.println(&quot;error: the repository is in a detached HEAD state&quot;);
              System.exit(1);
          }
</pre>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="GitSync.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>