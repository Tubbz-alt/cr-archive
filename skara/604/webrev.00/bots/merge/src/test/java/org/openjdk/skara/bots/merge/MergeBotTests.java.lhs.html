<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.merge;
  24 
  25 import org.openjdk.skara.host.*;
  26 import org.openjdk.skara.test.*;
  27 import org.openjdk.skara.vcs.*;
<a name="1" id="anc1"></a>
  28 
  29 import org.junit.jupiter.api.Test;
  30 import org.junit.jupiter.api.TestInfo;
  31 
  32 import java.io.IOException;
  33 import java.nio.file.Files;
  34 import java.nio.file.StandardOpenOption;
  35 import java.util.*;
  36 import java.util.stream.Collectors;
  37 import java.time.DayOfWeek;
  38 import java.time.Month;
  39 import java.time.ZonedDateTime;
  40 import java.time.ZoneId;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MergeBotTests {
  45     @Test
  46     void mergeMasterBranch(TestInfo testInfo) throws IOException {
  47         try (var temp = new TemporaryDirectory()) {
  48             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
  49 
  50             var fromDir = temp.path().resolve(&quot;from.git&quot;);
  51             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
  52             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
  53 
  54             var toDir = temp.path().resolve(&quot;to.git&quot;);
  55             var toLocalRepo = Repository.init(toDir, VCS.GIT);
  56             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  57             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  58                         StandardOpenOption.APPEND);
  59             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
  60 
  61             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
  62             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
  63             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  64             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  65                         StandardOpenOption.APPEND);
  66             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
  67 
  68             var now = ZonedDateTime.now();
  69             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
  70             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
  71             fromLocalRepo.add(fromFileA);
  72             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
  73             var fromCommits = fromLocalRepo.commits().asList();
  74             assertEquals(1, fromCommits.size());
  75             assertEquals(fromHashA, fromCommits.get(0).hash());
  76 
  77             var toFileA = toDir.resolve(&quot;a.txt&quot;);
  78             Files.writeString(toFileA, &quot;Hello A\n&quot;);
  79             toLocalRepo.add(toFileA);
  80             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
  81             var toCommits = toLocalRepo.commits().asList();
  82             assertEquals(1, toCommits.size());
  83             assertEquals(toHashA, toCommits.get(0).hash());
  84             assertEquals(fromHashA, toHashA);
  85 
  86             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
  87             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
  88             fromLocalRepo.add(fromFileB);
  89             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
  90 
  91             var toFileC = toDir.resolve(&quot;c.txt&quot;);
  92             Files.writeString(toFileC, &quot;Hello C\n&quot;);
  93             toLocalRepo.add(toFileC);
  94             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
  95 
  96             var storage = temp.path().resolve(&quot;storage&quot;);
  97             var master = new Branch(&quot;master&quot;);
  98             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
  99             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 100             TestBotRunner.runPeriodicItems(bot);
 101 
 102             toCommits = toLocalRepo.commits().asList();
 103             assertEquals(4, toCommits.size());
 104             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 105             assertTrue(hashes.contains(toHashA));
 106             assertTrue(hashes.contains(fromHashB));
 107             assertTrue(hashes.contains(toHashC));
 108 
 109             var known = Set.of(toHashA, fromHashB, toHashC);
 110             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 111             assertTrue(merge.isMerge());
 112             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
 113             assertEquals(&quot;duke&quot;, merge.author().name());
 114             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 115 
 116             assertEquals(0, toHostedRepo.pullRequests().size());
 117         }
 118     }
 119 
 120     @Test
 121     void successfulDependency(TestInfo testInfo) throws IOException {
 122         try (var temp = new TemporaryDirectory(false)) {
 123             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 124 
 125             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 126             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 127             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 128 
 129             var toDir = temp.path().resolve(&quot;to.git&quot;);
 130             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 131             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 132             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 133                         StandardOpenOption.APPEND);
 134             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 135 
 136             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 137             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 138             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 139             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 140                         StandardOpenOption.APPEND);
 141             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 142 
 143             var now = ZonedDateTime.now();
 144             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 145             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 146             fromLocalRepo.add(fromFileA);
 147             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 148             var fromCommits = fromLocalRepo.commits().asList();
 149             assertEquals(1, fromCommits.size());
 150             assertEquals(fromHashA, fromCommits.get(0).hash());
 151 
 152             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 153             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 154             toLocalRepo.add(toFileA);
 155             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 156             var toCommits = toLocalRepo.commits().asList();
 157             assertEquals(1, toCommits.size());
 158             assertEquals(toHashA, toCommits.get(0).hash());
 159             assertEquals(fromHashA, toHashA);
 160             toLocalRepo.branch(toHashA, &quot;feature&quot;);
 161             assertEquals(2, toLocalRepo.branches().size());
 162 
 163             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 164             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 165             fromLocalRepo.add(fromFileB);
 166             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 167 
 168             var featureBranch = fromLocalRepo.branch(fromHashB, &quot;feature&quot;);
 169             fromLocalRepo.checkout(featureBranch);
 170             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 171             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 172             fromLocalRepo.add(fromFileD);
 173             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 174 
 175             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 176             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 177             toLocalRepo.add(toFileC);
 178             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 179 
 180             toLocalRepo.checkout(featureBranch);
 181             var toFileE = toDir.resolve(&quot;e.txt&quot;);
 182             Files.writeString(toFileE, &quot;Hello E\n&quot;);
 183             toLocalRepo.add(toFileE);
 184             var toHashE = toLocalRepo.commit(&quot;Adding e.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 185 
 186             var storage = temp.path().resolve(&quot;storage&quot;);
 187             var master = new Branch(&quot;master&quot;);
 188             var feature = new Branch(&quot;feature&quot;);
<a name="2" id="anc2"></a><span class="line-modified"> 189             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, &quot;master&quot;),</span>
<span class="line-modified"> 190                                 new MergeBot.Spec(fromHostedRepo, feature, feature, &quot;feature&quot;, List.of(&quot;master&quot;)));</span>
 191             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 192             TestBotRunner.runPeriodicItems(bot);
 193 
 194             toCommits = toLocalRepo.commits().asList();
 195             assertEquals(7, toCommits.size());
 196             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 197             assertTrue(hashes.contains(toHashA));
 198             assertTrue(hashes.contains(fromHashB));
 199             assertTrue(hashes.contains(toHashC));
 200 
 201             var merges = toCommits.stream().filter(c -&gt; c.isMerge()).collect(Collectors.toList());
 202             assertEquals(2, merges.size());
 203 
 204             assertTrue(merges.stream().anyMatch(c -&gt; c.message().get(0).equals(&quot;Automatic merge of test:master into master&quot;)));
 205             assertTrue(merges.stream().anyMatch(c -&gt; c.message().get(0).equals(&quot;Automatic merge of test:feature into feature&quot;)));
 206         }
 207     }
 208 
 209     @Test
 210     void failedDependency(TestInfo testInfo) throws IOException {
 211         try (var temp = new TemporaryDirectory(false)) {
 212             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 213 
 214             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 215             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 216             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 217 
 218             var toDir = temp.path().resolve(&quot;to.git&quot;);
 219             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 220             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 221             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 222                         StandardOpenOption.APPEND);
 223             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 224 
 225             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 226             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 227             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 228             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 229                         StandardOpenOption.APPEND);
 230             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 231 
 232             var now = ZonedDateTime.now();
 233             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 234             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 235             fromLocalRepo.add(fromFileA);
 236             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 237             var fromCommits = fromLocalRepo.commits().asList();
 238             assertEquals(1, fromCommits.size());
 239             assertEquals(fromHashA, fromCommits.get(0).hash());
 240 
 241             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 242             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 243             toLocalRepo.add(toFileA);
 244             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 245             var toCommits = toLocalRepo.commits().asList();
 246             assertEquals(1, toCommits.size());
 247             assertEquals(toHashA, toCommits.get(0).hash());
 248             assertEquals(fromHashA, toHashA);
 249             toLocalRepo.branch(toHashA, &quot;feature&quot;);
 250             assertEquals(2, toLocalRepo.branches().size());
 251 
 252             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 253             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 254             fromLocalRepo.add(fromFileB);
 255             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 256 
 257             var featureBranch = fromLocalRepo.branch(fromHashB, &quot;feature&quot;);
 258             fromLocalRepo.checkout(featureBranch);
 259             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 260             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 261             fromLocalRepo.add(fromFileD);
 262             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 263 
 264             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 265             Files.writeString(toFileB, &quot;Hello conflict\n&quot;);
 266             toLocalRepo.add(toFileB);
 267             var toHashB = toLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 268 
 269             toLocalRepo.checkout(featureBranch);
 270             var toFileE = toDir.resolve(&quot;e.txt&quot;);
 271             Files.writeString(toFileE, &quot;Hello E\n&quot;);
 272             toLocalRepo.add(toFileE);
 273             var toHashE = toLocalRepo.commit(&quot;Adding e.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 274 
 275             var toCommitsBeforeMerge = toLocalRepo.commits().asList();
 276             assertEquals(3, toCommitsBeforeMerge.size());
 277             assertEquals(toHashE, toCommitsBeforeMerge.get(0).hash());
 278             assertEquals(toHashB, toCommitsBeforeMerge.get(1).hash());
 279             assertEquals(toHashA, toCommitsBeforeMerge.get(2).hash());
 280             assertEquals(toHashB, toLocalRepo.resolve(&quot;master&quot;).get());
 281             assertEquals(toHashE, toLocalRepo.resolve(&quot;feature&quot;).get());
 282 
 283             var storage = temp.path().resolve(&quot;storage&quot;);
 284             var master = new Branch(&quot;master&quot;);
 285             var feature = new Branch(&quot;feature&quot;);
<a name="3" id="anc3"></a><span class="line-modified"> 286             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, &quot;master&quot;),</span>
<span class="line-modified"> 287                                 new MergeBot.Spec(fromHostedRepo, feature, feature, &quot;feature&quot;, List.of(&quot;master&quot;)));</span>
 288             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 289             TestBotRunner.runPeriodicItems(bot);
 290 
 291             toCommits = toLocalRepo.commits().asList();
 292             assertEquals(toCommitsBeforeMerge.size(), toCommits.size());
 293             assertEquals(toCommitsBeforeMerge.get(0).hash(), toCommits.get(0).hash());
 294             assertEquals(toCommitsBeforeMerge.get(1).hash(), toCommits.get(1).hash());
 295             assertEquals(toCommitsBeforeMerge.get(2).hash(), toCommits.get(2).hash());
 296             assertEquals(toHashB, toLocalRepo.resolve(&quot;master&quot;).get());
 297             assertEquals(toHashE, toLocalRepo.resolve(&quot;feature&quot;).get());
 298         }
 299     }
 300 
 301     @Test
 302     void failingMergeTest(TestInfo testInfo) throws IOException {
 303         try (var temp = new TemporaryDirectory()) {
 304             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 305 
 306             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 307             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 308             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 309 
 310             var toDir = temp.path().resolve(&quot;to.git&quot;);
 311             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 312             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 313             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 314                         StandardOpenOption.APPEND);
 315             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 316 
 317             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 318             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 319             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 320             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 321                         StandardOpenOption.APPEND);
 322             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 323 
 324             var now = ZonedDateTime.now();
 325             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 326             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 327             fromLocalRepo.add(fromFileA);
 328             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 329             var fromCommits = fromLocalRepo.commits().asList();
 330             assertEquals(1, fromCommits.size());
 331             assertEquals(fromHashA, fromCommits.get(0).hash());
 332 
 333             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 334             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 335             toLocalRepo.add(toFileA);
 336             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 337             var toCommits = toLocalRepo.commits().asList();
 338             assertEquals(1, toCommits.size());
 339             assertEquals(toHashA, toCommits.get(0).hash());
 340             assertEquals(fromHashA, toHashA);
 341 
 342             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 343             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 344             fromLocalRepo.add(fromFileB);
 345             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 346 
 347             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 348             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 349             toLocalRepo.add(toFileB);
 350             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 351 
 352             var storage = temp.path().resolve(&quot;storage&quot;);
 353             var master = new Branch(&quot;master&quot;);
 354             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 355             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 356             TestBotRunner.runPeriodicItems(bot);
 357 
 358             toCommits = toLocalRepo.commits().asList();
 359             assertEquals(2, toCommits.size());
 360             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 361             assertTrue(toHashes.contains(toHashA));
 362             assertTrue(toHashes.contains(toHashB));
 363 
 364             var pullRequests = toHostedRepo.pullRequests();
 365             assertEquals(1, pullRequests.size());
 366             var pr = pullRequests.get(0);
 367             assertEquals(&quot;Merge test:master&quot;, pr.title());
 368             assertTrue(pr.labels().contains(&quot;failed-auto-merge&quot;));
 369         }
 370     }
 371 
<a name="4" id="anc4"></a>



































































































































 372     @Test
 373     void failingMergeShouldResultInOnlyOnePR(TestInfo testInfo) throws IOException {
 374         try (var temp = new TemporaryDirectory()) {
 375             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 376 
 377             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 378             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 379             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 380 
 381             var toDir = temp.path().resolve(&quot;to.git&quot;);
 382             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 383             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 384             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 385                         StandardOpenOption.APPEND);
 386             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 387 
 388             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 389             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 390             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 391             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 392                         StandardOpenOption.APPEND);
 393             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 394 
 395             var now = ZonedDateTime.now();
 396             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 397             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 398             fromLocalRepo.add(fromFileA);
 399             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 400             var fromCommits = fromLocalRepo.commits().asList();
 401             assertEquals(1, fromCommits.size());
 402             assertEquals(fromHashA, fromCommits.get(0).hash());
 403 
 404             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 405             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 406             toLocalRepo.add(toFileA);
 407             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 408             var toCommits = toLocalRepo.commits().asList();
 409             assertEquals(1, toCommits.size());
 410             assertEquals(toHashA, toCommits.get(0).hash());
 411             assertEquals(fromHashA, toHashA);
 412 
 413             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 414             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 415             fromLocalRepo.add(fromFileB);
 416             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 417 
 418             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 419             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 420             toLocalRepo.add(toFileB);
 421             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 422 
 423             var storage = temp.path().resolve(&quot;storage&quot;);
 424             var master = new Branch(&quot;master&quot;);
 425             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 426             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 427             TestBotRunner.runPeriodicItems(bot);
 428             TestBotRunner.runPeriodicItems(bot);
 429 
 430             toCommits = toLocalRepo.commits().asList();
 431             assertEquals(2, toCommits.size());
 432             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 433             assertTrue(toHashes.contains(toHashA));
 434             assertTrue(toHashes.contains(toHashB));
 435 
 436             var pullRequests = toHostedRepo.pullRequests();
 437             assertEquals(1, pullRequests.size());
 438             var pr = pullRequests.get(0);
 439             assertEquals(&quot;Merge test:master&quot;, pr.title());
 440         }
 441     }
 442 
 443     @Test
 444     void resolvedMergeConflictShouldResultInIntegrateCommand(TestInfo testInfo) throws IOException {
 445         try (var temp = new TemporaryDirectory()) {
 446             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 447 
 448             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 449             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 450             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 451 
 452             var toDir = temp.path().resolve(&quot;to.git&quot;);
 453             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 454             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 455             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 456                         StandardOpenOption.APPEND);
 457             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 458 
 459             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 460             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 461             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 462             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 463                         StandardOpenOption.APPEND);
 464             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 465 
 466             var now = ZonedDateTime.now();
 467             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 468             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 469             fromLocalRepo.add(fromFileA);
 470             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 471             var fromCommits = fromLocalRepo.commits().asList();
 472             assertEquals(1, fromCommits.size());
 473             assertEquals(fromHashA, fromCommits.get(0).hash());
 474 
 475             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 476             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 477             toLocalRepo.add(toFileA);
 478             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 479             var toCommits = toLocalRepo.commits().asList();
 480             assertEquals(1, toCommits.size());
 481             assertEquals(toHashA, toCommits.get(0).hash());
 482             assertEquals(fromHashA, toHashA);
 483 
 484             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 485             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 486             fromLocalRepo.add(fromFileB);
 487             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 488 
 489             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 490             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 491             toLocalRepo.add(toFileB);
 492             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 493 
 494             var storage = temp.path().resolve(&quot;storage&quot;);
 495             var master = new Branch(&quot;master&quot;);
 496             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 497             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 498             TestBotRunner.runPeriodicItems(bot);
 499             TestBotRunner.runPeriodicItems(bot);
 500 
 501             toCommits = toLocalRepo.commits().asList();
 502             assertEquals(2, toCommits.size());
 503             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 504             assertTrue(toHashes.contains(toHashA));
 505             assertTrue(toHashes.contains(toHashB));
 506 
 507             var pullRequests = toHostedRepo.pullRequests();
 508             assertEquals(1, pullRequests.size());
 509             var pr = pullRequests.get(0);
 510             assertEquals(&quot;Merge test:master&quot;, pr.title());
 511             assertTrue(pr.labels().contains(&quot;failed-auto-merge&quot;));
 512             assertTrue(forkLocalRepo.branches().contains(new Branch(&quot;master&quot;)));
 513             assertTrue(forkLocalRepo.branches().contains(new Branch(&quot;2&quot;)));
 514 
 515             // Bot should do nothing as long as PR is presnt
 516             TestBotRunner.runPeriodicItems(bot);
 517             pullRequests = toHostedRepo.pullRequests();
 518             assertEquals(1, pullRequests.size());
 519             pr = pullRequests.get(0);
 520 
 521             // Simulate that the merge-conflict has been resolved by adding the &quot;ready&quot; label
 522             pr.addLabel(&quot;ready&quot;);
 523             TestBotRunner.runPeriodicItems(bot);
 524             pullRequests = toHostedRepo.pullRequests();
 525             assertEquals(1, pullRequests.size());
 526 
 527             pr = pullRequests.get(0);
 528             var numComments = pr.comments().size();
 529             var lastComment = pr.comments().get(pr.comments().size() - 1);
 530             assertEquals(&quot;/integrate&quot;, lastComment.body());
 531 
 532             // Running the bot again should not result in another comment
 533             TestBotRunner.runPeriodicItems(bot);
 534             assertEquals(numComments, toHostedRepo.pullRequests().size());
 535         }
 536     }
 537 
 538     final static class TestClock implements Clock {
 539         ZonedDateTime now;
 540 
 541         TestClock() {
 542             this(null);
 543         }
 544 
 545         TestClock(ZonedDateTime now) {
 546             this.now = now;
 547         }
 548 
 549         @Override
 550         public ZonedDateTime now() {
 551             return now;
 552         }
 553     }
 554 
 555     @Test
 556     void testMergeHourly(TestInfo testInfo) throws IOException {
 557         try (var temp = new TemporaryDirectory()) {
 558             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 559 
 560             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 561             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 562             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 563 
 564             var toDir = temp.path().resolve(&quot;to.git&quot;);
 565             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 566             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 567             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 568                         StandardOpenOption.APPEND);
 569             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 570 
 571             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 572             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 573             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 574             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 575                         StandardOpenOption.APPEND);
 576             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 577 
 578             var now = ZonedDateTime.now();
 579             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 580             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 581             fromLocalRepo.add(fromFileA);
 582             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 583             var fromCommits = fromLocalRepo.commits().asList();
 584             assertEquals(1, fromCommits.size());
 585             assertEquals(fromHashA, fromCommits.get(0).hash());
 586 
 587             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 588             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 589             toLocalRepo.add(toFileA);
 590             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 591             var toCommits = toLocalRepo.commits().asList();
 592             assertEquals(1, toCommits.size());
 593             assertEquals(toHashA, toCommits.get(0).hash());
 594             assertEquals(fromHashA, toHashA);
 595 
 596             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 597             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 598             fromLocalRepo.add(fromFileB);
 599             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 600 
 601             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 602             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 603             toLocalRepo.add(toFileC);
 604             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 605 
 606             var storage = temp.path().resolve(&quot;storage&quot;);
 607             var master = new Branch(&quot;master&quot;);
 608 
 609             // Merge only at most once during the first minute every hour
 610             var freq = MergeBot.Spec.Frequency.hourly(1);
 611             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 612 
 613             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 15, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 614             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 615 
 616             TestBotRunner.runPeriodicItems(bot);
 617 
 618             // Ensure nothing has been merged
 619             toCommits = toLocalRepo.commits().asList();
 620             assertEquals(2, toCommits.size());
 621             assertEquals(toHashC, toCommits.get(0).hash());
 622             assertEquals(toHashA, toCommits.get(1).hash());
 623 
 624             // Set the clock to the first minute of the hour
 625             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 626             TestBotRunner.runPeriodicItems(bot);
 627 
 628             // Should have merged
 629             toCommits = toLocalRepo.commits().asList();
 630             assertEquals(4, toCommits.size());
 631             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 632             assertTrue(hashes.contains(toHashA));
 633             assertTrue(hashes.contains(fromHashB));
 634             assertTrue(hashes.contains(toHashC));
 635 
 636             var known = Set.of(toHashA, fromHashB, toHashC);
 637             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 638             assertTrue(merge.isMerge());
 639             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
 640             assertEquals(&quot;duke&quot;, merge.author().name());
 641             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 642 
 643             assertEquals(0, toHostedRepo.pullRequests().size());
 644 
 645             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 646             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 647             fromLocalRepo.add(fromFileD);
 648             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 649 
 650             // Since the time hasn&#39;t changed it should not merge again
 651             TestBotRunner.runPeriodicItems(bot);
 652             toCommits = toLocalRepo.commits().asList();
 653             assertEquals(4, toCommits.size());
 654 
 655             // Move the minutes forward, the bot should not merge
 656             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 657             TestBotRunner.runPeriodicItems(bot);
 658             toCommits = toLocalRepo.commits().asList();
 659             assertEquals(4, toCommits.size());
 660 
 661             // Move the clock forward one hour, the bot should merge
 662             clock.now = ZonedDateTime.of(2020, 1, 23, 16, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 663             TestBotRunner.runPeriodicItems(bot);
 664 
 665             toCommits = toLocalRepo.commits().asList();
 666             assertEquals(6, toCommits.size());
 667         }
 668     }
 669 
 670     @Test
 671     void testMergeDaily(TestInfo testInfo) throws IOException {
 672         try (var temp = new TemporaryDirectory()) {
 673             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 674 
 675             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 676             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 677             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 678 
 679             var toDir = temp.path().resolve(&quot;to.git&quot;);
 680             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 681             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 682             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 683                         StandardOpenOption.APPEND);
 684             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
 685 
 686             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 687             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 688             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 689             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 690                         StandardOpenOption.APPEND);
 691             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 692 
 693             var now = ZonedDateTime.now();
 694             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 695             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 696             fromLocalRepo.add(fromFileA);
 697             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 698             var fromCommits = fromLocalRepo.commits().asList();
 699             assertEquals(1, fromCommits.size());
 700             assertEquals(fromHashA, fromCommits.get(0).hash());
 701 
 702             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 703             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 704             toLocalRepo.add(toFileA);
 705             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 706             var toCommits = toLocalRepo.commits().asList();
 707             assertEquals(1, toCommits.size());
 708             assertEquals(toHashA, toCommits.get(0).hash());
 709             assertEquals(fromHashA, toHashA);
 710 
 711             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 712             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 713             fromLocalRepo.add(fromFileB);
 714             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 715 
 716             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 717             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 718             toLocalRepo.add(toFileC);
 719             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 720 
 721             var storage = temp.path().resolve(&quot;storage&quot;);
 722             var master = new Branch(&quot;master&quot;);
 723 
 724             // Merge only at most once during the third hour every day
 725             var freq = MergeBot.Spec.Frequency.daily(3);
 726             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 727 
 728             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 2, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 729             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 730 
 731             TestBotRunner.runPeriodicItems(bot);
 732 
 733             // Ensure nothing has been merged
 734             toCommits = toLocalRepo.commits().asList();
 735             assertEquals(2, toCommits.size());
 736             assertEquals(toHashC, toCommits.get(0).hash());
 737             assertEquals(toHashA, toCommits.get(1).hash());
 738 
 739             // Set the clock to the third hour of the day (minutes should not matter)
 740             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 741             TestBotRunner.runPeriodicItems(bot);
 742 
 743             // Should have merged
 744             toCommits = toLocalRepo.commits().asList();
 745             assertEquals(4, toCommits.size());
 746             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 747             assertTrue(hashes.contains(toHashA));
 748             assertTrue(hashes.contains(fromHashB));
 749             assertTrue(hashes.contains(toHashC));
 750 
 751             var known = Set.of(toHashA, fromHashB, toHashC);
 752             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 753             assertTrue(merge.isMerge());
 754             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
 755             assertEquals(&quot;duke&quot;, merge.author().name());
 756             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 757 
 758             assertEquals(0, toHostedRepo.pullRequests().size());
 759 
 760             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 761             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 762             fromLocalRepo.add(fromFileD);
 763             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 764 
 765             // Since the time hasn&#39;t changed it should not merge
 766             TestBotRunner.runPeriodicItems(bot);
 767             toCommits = toLocalRepo.commits().asList();
 768             assertEquals(4, toCommits.size());
 769 
 770             // Move the minutes forward, the bot should not merge
 771             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 772             TestBotRunner.runPeriodicItems(bot);
 773             toCommits = toLocalRepo.commits().asList();
 774             assertEquals(4, toCommits.size());
 775 
 776             // Move the hours forward, the bot should not merge
 777             clock.now = ZonedDateTime.of(2020, 1, 23, 17, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 778             TestBotRunner.runPeriodicItems(bot);
 779             toCommits = toLocalRepo.commits().asList();
 780             assertEquals(4, toCommits.size());
 781 
 782             // Move the clock forward one day, the bot should merge
 783             clock.now = ZonedDateTime.of(2020, 1, 24, 3, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 784             TestBotRunner.runPeriodicItems(bot);
 785 
 786             toCommits = toLocalRepo.commits().asList();
 787             assertEquals(6, toCommits.size());
 788         }
 789     }
 790 
 791     @Test
 792     void testMergeWeekly(TestInfo testInfo) throws IOException {
 793         try (var temp = new TemporaryDirectory()) {
 794             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 795 
 796             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 797             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 798             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 799 
 800             var toDir = temp.path().resolve(&quot;to.git&quot;);
 801             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 802             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 803             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 804                         StandardOpenOption.APPEND);
 805             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 806 
 807             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 808             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 809             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 810             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 811                         StandardOpenOption.APPEND);
 812             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 813 
 814             var now = ZonedDateTime.now();
 815             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 816             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 817             fromLocalRepo.add(fromFileA);
 818             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 819             var fromCommits = fromLocalRepo.commits().asList();
 820             assertEquals(1, fromCommits.size());
 821             assertEquals(fromHashA, fromCommits.get(0).hash());
 822 
 823             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 824             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 825             toLocalRepo.add(toFileA);
 826             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 827             var toCommits = toLocalRepo.commits().asList();
 828             assertEquals(1, toCommits.size());
 829             assertEquals(toHashA, toCommits.get(0).hash());
 830             assertEquals(fromHashA, toHashA);
 831 
 832             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 833             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 834             fromLocalRepo.add(fromFileB);
 835             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 836 
 837             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 838             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 839             toLocalRepo.add(toFileC);
 840             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 841 
 842             var storage = temp.path().resolve(&quot;storage&quot;);
 843             var master = new Branch(&quot;master&quot;);
 844 
 845             // Merge only at most once per week on Friday&#39;s at 12:00
 846             var freq = MergeBot.Spec.Frequency.weekly(DayOfWeek.FRIDAY, 12);
 847             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 848 
 849             var clock = new TestClock(ZonedDateTime.of(2020, 1, 24, 11, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 850             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 851 
 852             TestBotRunner.runPeriodicItems(bot);
 853 
 854             // Ensure nothing has been merged
 855             toCommits = toLocalRepo.commits().asList();
 856             assertEquals(2, toCommits.size());
 857             assertEquals(toHashC, toCommits.get(0).hash());
 858             assertEquals(toHashA, toCommits.get(1).hash());
 859 
 860             // Set the clock to the 12th hour of the day (minutes should not matter)
 861             clock.now = ZonedDateTime.of(2020, 1, 24, 12, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 862             TestBotRunner.runPeriodicItems(bot);
 863 
 864             // Should have merged
 865             toCommits = toLocalRepo.commits().asList();
 866             assertEquals(4, toCommits.size());
 867             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 868             assertTrue(hashes.contains(toHashA));
 869             assertTrue(hashes.contains(fromHashB));
 870             assertTrue(hashes.contains(toHashC));
 871 
 872             var known = Set.of(toHashA, fromHashB, toHashC);
 873             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 874             assertTrue(merge.isMerge());
 875             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
 876             assertEquals(&quot;duke&quot;, merge.author().name());
 877             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 878 
 879             assertEquals(0, toHostedRepo.pullRequests().size());
 880 
 881             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 882             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 883             fromLocalRepo.add(fromFileD);
 884             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 885 
 886             // Since the time hasn&#39;t changed it should not merge
 887             TestBotRunner.runPeriodicItems(bot);
 888             toCommits = toLocalRepo.commits().asList();
 889             assertEquals(4, toCommits.size());
 890 
 891             // Move the hours forward, the bot should not merge
 892             clock.now = ZonedDateTime.of(2020, 1, 24, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 893             TestBotRunner.runPeriodicItems(bot);
 894             toCommits = toLocalRepo.commits().asList();
 895             assertEquals(4, toCommits.size());
 896 
 897             // Move the days forward, the bot should not merge
 898             clock.now = ZonedDateTime.of(2020, 1, 25, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 899             TestBotRunner.runPeriodicItems(bot);
 900             toCommits = toLocalRepo.commits().asList();
 901             assertEquals(4, toCommits.size());
 902 
 903             // Move the clock forward one week, the bot should merge
 904             clock.now = ZonedDateTime.of(2020, 1, 31, 12, 29, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 905             TestBotRunner.runPeriodicItems(bot);
 906 
 907             toCommits = toLocalRepo.commits().asList();
 908             assertEquals(6, toCommits.size());
 909         }
 910     }
 911 
 912     @Test
 913     void testMergeMonthly(TestInfo testInfo) throws IOException {
 914         try (var temp = new TemporaryDirectory()) {
 915             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 916 
 917             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 918             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 919             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 920 
 921             var toDir = temp.path().resolve(&quot;to.git&quot;);
 922             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 923             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 924             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 925                         StandardOpenOption.APPEND);
 926             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
 927 
 928             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 929             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 930             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 931             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 932                         StandardOpenOption.APPEND);
 933             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 934 
 935             var now = ZonedDateTime.now();
 936             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 937             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 938             fromLocalRepo.add(fromFileA);
 939             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 940             var fromCommits = fromLocalRepo.commits().asList();
 941             assertEquals(1, fromCommits.size());
 942             assertEquals(fromHashA, fromCommits.get(0).hash());
 943 
 944             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 945             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 946             toLocalRepo.add(toFileA);
 947             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 948             var toCommits = toLocalRepo.commits().asList();
 949             assertEquals(1, toCommits.size());
 950             assertEquals(toHashA, toCommits.get(0).hash());
 951             assertEquals(fromHashA, toHashA);
 952 
 953             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 954             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 955             fromLocalRepo.add(fromFileB);
 956             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 957 
 958             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 959             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 960             toLocalRepo.add(toFileC);
 961             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 962 
 963             var storage = temp.path().resolve(&quot;storage&quot;);
 964             var master = new Branch(&quot;master&quot;);
 965 
 966             // Merge only at most once per month on the 17th day at at 11:00
 967             var freq = MergeBot.Spec.Frequency.monthly(17, 11);
 968             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 969 
 970             var clock = new TestClock(ZonedDateTime.of(2020, 1, 16, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 971             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 972 
 973             TestBotRunner.runPeriodicItems(bot);
 974 
 975             // Ensure nothing has been merged
 976             toCommits = toLocalRepo.commits().asList();
 977             assertEquals(2, toCommits.size());
 978             assertEquals(toHashC, toCommits.get(0).hash());
 979             assertEquals(toHashA, toCommits.get(1).hash());
 980 
 981             // Set the clock to the 17th day and at hour 11 (minutes should not matter)
 982             clock.now = ZonedDateTime.of(2020, 1, 17, 11, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 983             TestBotRunner.runPeriodicItems(bot);
 984 
 985             // Should have merged
 986             toCommits = toLocalRepo.commits().asList();
 987             assertEquals(4, toCommits.size());
 988             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 989             assertTrue(hashes.contains(toHashA));
 990             assertTrue(hashes.contains(fromHashB));
 991             assertTrue(hashes.contains(toHashC));
 992 
 993             var known = Set.of(toHashA, fromHashB, toHashC);
 994             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 995             assertTrue(merge.isMerge());
 996             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
 997             assertEquals(&quot;duke&quot;, merge.author().name());
 998             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 999 
1000             assertEquals(0, toHostedRepo.pullRequests().size());
1001 
1002             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
1003             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
1004             fromLocalRepo.add(fromFileD);
1005             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1006 
1007             // Since the time hasn&#39;t changed it should not merge
1008             TestBotRunner.runPeriodicItems(bot);
1009             toCommits = toLocalRepo.commits().asList();
1010             assertEquals(4, toCommits.size());
1011 
1012             // Move the hours forward, the bot should not merge
1013             clock.now = ZonedDateTime.of(2020, 1, 17, 12, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1014             TestBotRunner.runPeriodicItems(bot);
1015             toCommits = toLocalRepo.commits().asList();
1016             assertEquals(4, toCommits.size());
1017 
1018             // Move the days forward, the bot should not merge
1019             clock.now = ZonedDateTime.of(2020, 1, 18, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1020             TestBotRunner.runPeriodicItems(bot);
1021             toCommits = toLocalRepo.commits().asList();
1022             assertEquals(4, toCommits.size());
1023 
1024             // Move the clock forward one month, the bot should merge
1025             clock.now = ZonedDateTime.of(2020, 2, 17, 11, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1026             TestBotRunner.runPeriodicItems(bot);
1027 
1028             toCommits = toLocalRepo.commits().asList();
1029             assertEquals(6, toCommits.size());
1030         }
1031     }
1032 
1033     @Test
1034     void testMergeYearly(TestInfo testInfo) throws IOException {
1035         try (var temp = new TemporaryDirectory()) {
1036             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
1037 
1038             var fromDir = temp.path().resolve(&quot;from.git&quot;);
1039             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
1040             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
1041 
1042             var toDir = temp.path().resolve(&quot;to.git&quot;);
1043             var toLocalRepo = Repository.init(toDir, VCS.GIT);
1044             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
1045             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
1046                         StandardOpenOption.APPEND);
1047             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
1048 
1049             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
1050             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
1051             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
1052             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
1053                         StandardOpenOption.APPEND);
1054             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
1055 
1056             var now = ZonedDateTime.now();
1057             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
1058             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
1059             fromLocalRepo.add(fromFileA);
1060             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
1061             var fromCommits = fromLocalRepo.commits().asList();
1062             assertEquals(1, fromCommits.size());
1063             assertEquals(fromHashA, fromCommits.get(0).hash());
1064 
1065             var toFileA = toDir.resolve(&quot;a.txt&quot;);
1066             Files.writeString(toFileA, &quot;Hello A\n&quot;);
1067             toLocalRepo.add(toFileA);
1068             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
1069             var toCommits = toLocalRepo.commits().asList();
1070             assertEquals(1, toCommits.size());
1071             assertEquals(toHashA, toCommits.get(0).hash());
1072             assertEquals(fromHashA, toHashA);
1073 
1074             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
1075             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
1076             fromLocalRepo.add(fromFileB);
1077             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1078 
1079             var toFileC = toDir.resolve(&quot;c.txt&quot;);
1080             Files.writeString(toFileC, &quot;Hello C\n&quot;);
1081             toLocalRepo.add(toFileC);
1082             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1083 
1084             var storage = temp.path().resolve(&quot;storage&quot;);
1085             var master = new Branch(&quot;master&quot;);
1086 
1087             // Merge only at most once per year on the 29th day of May at at 07:00
1088             var freq = MergeBot.Spec.Frequency.yearly(Month.MAY, 29, 07);
1089             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
1090 
1091             var clock = new TestClock(ZonedDateTime.of(2020, 5, 27, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
1092             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
1093 
1094             TestBotRunner.runPeriodicItems(bot);
1095 
1096             // Ensure nothing has been merged
1097             toCommits = toLocalRepo.commits().asList();
1098             assertEquals(2, toCommits.size());
1099             assertEquals(toHashC, toCommits.get(0).hash());
1100             assertEquals(toHashA, toCommits.get(1).hash());
1101 
1102             // Set the clock to the 29th of May and at hour 11 (minutes should not matter)
1103             clock.now = ZonedDateTime.of(2020, 5, 29, 7, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1104             TestBotRunner.runPeriodicItems(bot);
1105 
1106             // Should have merged
1107             toCommits = toLocalRepo.commits().asList();
1108             assertEquals(4, toCommits.size());
1109             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
1110             assertTrue(hashes.contains(toHashA));
1111             assertTrue(hashes.contains(fromHashB));
1112             assertTrue(hashes.contains(toHashC));
1113 
1114             var known = Set.of(toHashA, fromHashB, toHashC);
1115             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
1116             assertTrue(merge.isMerge());
1117             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
1118             assertEquals(&quot;duke&quot;, merge.author().name());
1119             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
1120 
1121             assertEquals(0, toHostedRepo.pullRequests().size());
1122 
1123             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
1124             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
1125             fromLocalRepo.add(fromFileD);
1126             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1127 
1128             // Since the time hasn&#39;t changed it should not merge again
1129             TestBotRunner.runPeriodicItems(bot);
1130             toCommits = toLocalRepo.commits().asList();
1131             assertEquals(4, toCommits.size());
1132 
1133             // Move the hours forward, the bot should not merge
1134             clock.now = ZonedDateTime.of(2020, 5, 29, 8, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1135             TestBotRunner.runPeriodicItems(bot);
1136             toCommits = toLocalRepo.commits().asList();
1137             assertEquals(4, toCommits.size());
1138 
1139             // Move the days forward, the bot should not merge
1140             clock.now = ZonedDateTime.of(2020, 5, 30, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1141             TestBotRunner.runPeriodicItems(bot);
1142             toCommits = toLocalRepo.commits().asList();
1143             assertEquals(4, toCommits.size());
1144 
1145             // Move the months forward, the bot should not merge
1146             clock.now = ZonedDateTime.of(2020, 7, 29, 7, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1147             TestBotRunner.runPeriodicItems(bot);
1148             toCommits = toLocalRepo.commits().asList();
1149             assertEquals(4, toCommits.size());
1150 
1151             // Move the clock forward one year, the bot should merge
1152             clock.now = ZonedDateTime.of(2021, 5, 29, 7, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1153             TestBotRunner.runPeriodicItems(bot);
1154 
1155             toCommits = toLocalRepo.commits().asList();
1156             assertEquals(6, toCommits.size());
1157         }
1158     }
1159 }
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>