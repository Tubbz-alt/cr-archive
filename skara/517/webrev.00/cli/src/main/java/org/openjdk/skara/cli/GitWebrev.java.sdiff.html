<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff cli/src/main/java/org/openjdk/skara/cli/GitWebrev.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitWebrev.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
104             Option.shortcut(&quot;u&quot;)
105                   .fullname(&quot;username&quot;)
106                   .describe(&quot;NAME&quot;)
107                   .helptext(&quot;Use that username instead of &#39;guessing&#39; one&quot;)
108                   .optional(),
109             Option.shortcut(&quot;&quot;)
110                   .fullname(&quot;upstream&quot;)
111                   .describe(&quot;URL&quot;)
112                   .helptext(&quot;The URL to the upstream repository&quot;)
113                   .optional(),
114             Option.shortcut(&quot;t&quot;)
115                   .fullname(&quot;title&quot;)
116                   .describe(&quot;TITLE&quot;)
117                   .helptext(&quot;The title of the webrev&quot;)
118                   .optional(),
119             Option.shortcut(&quot;c&quot;)
120                   .fullname(&quot;cr&quot;)
121                   .describe(&quot;CR#&quot;)
122                   .helptext(&quot;Include link to CR (aka bugid) in the main page&quot;)
123                   .optional(),





124             Switch.shortcut(&quot;b&quot;)
125                   .fullname(&quot;&quot;)
126                   .helptext(&quot;Do not ignore changes in whitespace (always true)&quot;)
127                   .optional(),
128             Switch.shortcut(&quot;m&quot;)
129                   .fullname(&quot;mercurial&quot;)
130                   .helptext(&quot;Deprecated: force use of mercurial&quot;)
131                   .optional(),
132             Switch.shortcut(&quot;C&quot;)
133                   .fullname(&quot;no-comments&quot;)
134                   .helptext(&quot;Don&#39;t show comments&quot;)
135                   .optional(),
136             Switch.shortcut(&quot;N&quot;)
137                   .fullname(&quot;no-outgoing&quot;)
138                   .helptext(&quot;Do not compare against remote, use only &#39;status&#39;&quot;)
139                   .optional(),
140             Switch.shortcut(&quot;v&quot;)
141                   .fullname(&quot;version&quot;)
142                   .helptext(&quot;Print the version of this tool&quot;)
143                   .optional());
144 
145         var inputs = List.of(
146             Input.position(0)
147                  .describe(&quot;FILE&quot;)
148                  .singular()
149                  .optional());
150 
151         var parser = new ArgumentParser(&quot;git webrev&quot;, flags, inputs);
152         var arguments = parser.parse(args);
153 
154         var version = Version.fromManifest().orElse(&quot;unknown&quot;);
155         if (arguments.contains(&quot;version&quot;)) {
156             System.out.println(&quot;git-webrev version: &quot; + version);
157             System.exit(0);
158         }
159 
160         var cwd = Paths.get(&quot;&quot;).toAbsolutePath();
<span class="line-modified">161         var repository = ReadOnlyRepository.get(cwd);</span>
162         if (!repository.isPresent()) {
163             System.err.println(String.format(&quot;error: %s is not a repository&quot;, cwd.toString()));
164             System.exit(1);
165         }
166         var repo = repository.get();
167         var isMercurial = arguments.contains(&quot;mercurial&quot;);
168 
169         var upstream = arg(&quot;upstream&quot;, arguments, repo);
170         if (upstream == null) {
171             var remotes = repo.remotes();
172             if (remotes.contains(&quot;upstream&quot;)) {
173                 var pullPath = Remote.toWebURI(repo.pullPath(&quot;upstream&quot;));
174                 var host = pullPath.getHost();
175                 if (host != null &amp;&amp; host.endsWith(&quot;openjdk.java.net&quot;)) {
176                     upstream = pullPath.toString();
177                 } else if (host != null &amp;&amp; host.equals(&quot;github.com&quot;)) {
178                     var path = pullPath.getPath();
179                     if (path != null &amp;&amp; path.startsWith(&quot;/openjdk/&quot;)) {
180                         upstream = pullPath.toString();
181                     }
</pre>
<hr />
<pre>
196         }
197         var upstreamURL = upstream;
198 
199         var noOutgoing = arguments.contains(&quot;no-outgoing&quot;);
200         if (!noOutgoing) {
201             var config = repo.config(&quot;webrev.no-outgoing&quot;);
202             if (config.size() == 1) {
203                 var enabled = Set.of(&quot;TRUE&quot;, &quot;ON&quot;, &quot;1&quot;, &quot;ENABLED&quot;);
204                 noOutgoing = enabled.contains(config.get(0).toUpperCase());
205             }
206         }
207 
208         var rev = arguments.contains(&quot;rev&quot;) ? resolve(repo, arguments.get(&quot;rev&quot;).asString()) : null;
209         if (rev == null) {
210             if (isMercurial) {
211                 resolve(repo, noOutgoing ? &quot;tip&quot; : &quot;min(outgoing())^&quot;);
212             } else {
213                 if (noOutgoing) {
214                     rev = resolve(repo, &quot;HEAD&quot;);
215                 } else {
<span class="line-modified">216                     var commits = repo.commitMetadata(&quot;origin..HEAD&quot;, true);</span>
<span class="line-modified">217                     if (commits.isEmpty()) {</span>
<span class="line-modified">218                         rev = resolve(repo, &quot;HEAD&quot;);</span>






219                     } else {
<span class="line-modified">220                         rev = resolve(repo, commits.get(0).hash().hex() + &quot;^&quot;);</span>
































221                     }
222                 }
223             }
224         }
225 
226         var issue = arguments.contains(&quot;cr&quot;) ? arguments.get(&quot;cr&quot;).asString() : null;
227         if (issue != null) {
228             if (issue.startsWith(&quot;http&quot;)) {
229                 var uri = URI.create(issue);
230                 issue = Path.of(uri.getPath()).getFileName().toString();
231             } else if (isDigit(issue.charAt(0))) {
232                 issue = &quot;JDK-&quot; + issue;
233             }
234         }
235         if (issue == null) {
236             var pattern = Pattern.compile(&quot;(?:(&quot; + String.join(&quot;|&quot;, KNOWN_JBS_PROJECTS) + &quot;)-)?([0-9]+).*&quot;);
237             var currentBranch = repo.currentBranch();
238             if (currentBranch.isPresent()) {
239                 var branchName = currentBranch.get().name().toUpperCase();
240                 var m = pattern.matcher(branchName);
</pre>
</td>
<td>
<hr />
<pre>
104             Option.shortcut(&quot;u&quot;)
105                   .fullname(&quot;username&quot;)
106                   .describe(&quot;NAME&quot;)
107                   .helptext(&quot;Use that username instead of &#39;guessing&#39; one&quot;)
108                   .optional(),
109             Option.shortcut(&quot;&quot;)
110                   .fullname(&quot;upstream&quot;)
111                   .describe(&quot;URL&quot;)
112                   .helptext(&quot;The URL to the upstream repository&quot;)
113                   .optional(),
114             Option.shortcut(&quot;t&quot;)
115                   .fullname(&quot;title&quot;)
116                   .describe(&quot;TITLE&quot;)
117                   .helptext(&quot;The title of the webrev&quot;)
118                   .optional(),
119             Option.shortcut(&quot;c&quot;)
120                   .fullname(&quot;cr&quot;)
121                   .describe(&quot;CR#&quot;)
122                   .helptext(&quot;Include link to CR (aka bugid) in the main page&quot;)
123                   .optional(),
<span class="line-added">124             Option.shortcut(&quot;&quot;)</span>
<span class="line-added">125                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">126                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">127                   .helptext(&quot;Use remote to calculate outgoing changes&quot;)</span>
<span class="line-added">128                   .optional(),</span>
129             Switch.shortcut(&quot;b&quot;)
130                   .fullname(&quot;&quot;)
131                   .helptext(&quot;Do not ignore changes in whitespace (always true)&quot;)
132                   .optional(),
133             Switch.shortcut(&quot;m&quot;)
134                   .fullname(&quot;mercurial&quot;)
135                   .helptext(&quot;Deprecated: force use of mercurial&quot;)
136                   .optional(),
137             Switch.shortcut(&quot;C&quot;)
138                   .fullname(&quot;no-comments&quot;)
139                   .helptext(&quot;Don&#39;t show comments&quot;)
140                   .optional(),
141             Switch.shortcut(&quot;N&quot;)
142                   .fullname(&quot;no-outgoing&quot;)
143                   .helptext(&quot;Do not compare against remote, use only &#39;status&#39;&quot;)
144                   .optional(),
145             Switch.shortcut(&quot;v&quot;)
146                   .fullname(&quot;version&quot;)
147                   .helptext(&quot;Print the version of this tool&quot;)
148                   .optional());
149 
150         var inputs = List.of(
151             Input.position(0)
152                  .describe(&quot;FILE&quot;)
153                  .singular()
154                  .optional());
155 
156         var parser = new ArgumentParser(&quot;git webrev&quot;, flags, inputs);
157         var arguments = parser.parse(args);
158 
159         var version = Version.fromManifest().orElse(&quot;unknown&quot;);
160         if (arguments.contains(&quot;version&quot;)) {
161             System.out.println(&quot;git-webrev version: &quot; + version);
162             System.exit(0);
163         }
164 
165         var cwd = Paths.get(&quot;&quot;).toAbsolutePath();
<span class="line-modified">166         var repository = Repository.get(cwd);</span>
167         if (!repository.isPresent()) {
168             System.err.println(String.format(&quot;error: %s is not a repository&quot;, cwd.toString()));
169             System.exit(1);
170         }
171         var repo = repository.get();
172         var isMercurial = arguments.contains(&quot;mercurial&quot;);
173 
174         var upstream = arg(&quot;upstream&quot;, arguments, repo);
175         if (upstream == null) {
176             var remotes = repo.remotes();
177             if (remotes.contains(&quot;upstream&quot;)) {
178                 var pullPath = Remote.toWebURI(repo.pullPath(&quot;upstream&quot;));
179                 var host = pullPath.getHost();
180                 if (host != null &amp;&amp; host.endsWith(&quot;openjdk.java.net&quot;)) {
181                     upstream = pullPath.toString();
182                 } else if (host != null &amp;&amp; host.equals(&quot;github.com&quot;)) {
183                     var path = pullPath.getPath();
184                     if (path != null &amp;&amp; path.startsWith(&quot;/openjdk/&quot;)) {
185                         upstream = pullPath.toString();
186                     }
</pre>
<hr />
<pre>
201         }
202         var upstreamURL = upstream;
203 
204         var noOutgoing = arguments.contains(&quot;no-outgoing&quot;);
205         if (!noOutgoing) {
206             var config = repo.config(&quot;webrev.no-outgoing&quot;);
207             if (config.size() == 1) {
208                 var enabled = Set.of(&quot;TRUE&quot;, &quot;ON&quot;, &quot;1&quot;, &quot;ENABLED&quot;);
209                 noOutgoing = enabled.contains(config.get(0).toUpperCase());
210             }
211         }
212 
213         var rev = arguments.contains(&quot;rev&quot;) ? resolve(repo, arguments.get(&quot;rev&quot;).asString()) : null;
214         if (rev == null) {
215             if (isMercurial) {
216                 resolve(repo, noOutgoing ? &quot;tip&quot; : &quot;min(outgoing())^&quot;);
217             } else {
218                 if (noOutgoing) {
219                     rev = resolve(repo, &quot;HEAD&quot;);
220                 } else {
<span class="line-modified">221                     var currentUpstreamBranch = repo.currentBranch().flatMap(b -&gt; {</span>
<span class="line-modified">222                         try {</span>
<span class="line-modified">223                             return repo.upstreamFor(b);</span>
<span class="line-added">224                         } catch (IOException e) {</span>
<span class="line-added">225                             throw new UncheckedIOException(e);</span>
<span class="line-added">226                         }</span>
<span class="line-added">227                     });</span>
<span class="line-added">228                     if (currentUpstreamBranch.isPresent()) {</span>
<span class="line-added">229                         rev = resolve(repo, currentUpstreamBranch.get());</span>
230                     } else {
<span class="line-modified">231                         String remote = arg(&quot;remote&quot;, arguments, repo);</span>
<span class="line-added">232                         if (remote == null) {</span>
<span class="line-added">233                             var remotes = repo.remotes();</span>
<span class="line-added">234                             if (remotes.size() == 0) {</span>
<span class="line-added">235                                 System.err.println(&quot;error: no remotes present, cannot figure out outgoing changes&quot;);</span>
<span class="line-added">236                                 System.err.println(&quot;       Use --rev to specify revision to compare against&quot;);</span>
<span class="line-added">237                                 System.exit(1);</span>
<span class="line-added">238                             } else if (remotes.size() == 1) {</span>
<span class="line-added">239                                 remote = remotes.get(0);</span>
<span class="line-added">240                             } else {</span>
<span class="line-added">241                                 if (remotes.contains(&quot;origin&quot;)) {</span>
<span class="line-added">242                                     remote = &quot;origin&quot;;</span>
<span class="line-added">243                                 } else {</span>
<span class="line-added">244                                     System.err.println(&quot;error: multiple remotes without origin remote present, cannot figure out outgoing changes&quot;);</span>
<span class="line-added">245                                     System.err.println(&quot;       Use --rev to specify revision to compare against&quot;);</span>
<span class="line-added">246                                     System.exit(1);</span>
<span class="line-added">247                                 }</span>
<span class="line-added">248                             }</span>
<span class="line-added">249                         }</span>
<span class="line-added">250 </span>
<span class="line-added">251                         var head = repo.head();</span>
<span class="line-added">252                         var shortestDistance = -1;</span>
<span class="line-added">253                         var pullPath = repo.pullPath(remote);</span>
<span class="line-added">254                         var remoteBranches = repo.remoteBranches(remote);</span>
<span class="line-added">255                         for (var remoteBranch : remoteBranches) {</span>
<span class="line-added">256                             var fetchHead = repo.fetch(URI.create(pullPath), remoteBranch.name());</span>
<span class="line-added">257                             var mergeBase = repo.mergeBase(fetchHead, head);</span>
<span class="line-added">258                             var distance = repo.commitMetadata(mergeBase, head).size();</span>
<span class="line-added">259                             if (shortestDistance == -1 || distance &lt; shortestDistance) {</span>
<span class="line-added">260                                 rev = mergeBase;</span>
<span class="line-added">261                                 shortestDistance = distance;</span>
<span class="line-added">262                             }</span>
<span class="line-added">263                         }</span>
264                     }
265                 }
266             }
267         }
268 
269         var issue = arguments.contains(&quot;cr&quot;) ? arguments.get(&quot;cr&quot;).asString() : null;
270         if (issue != null) {
271             if (issue.startsWith(&quot;http&quot;)) {
272                 var uri = URI.create(issue);
273                 issue = Path.of(uri.getPath()).getFileName().toString();
274             } else if (isDigit(issue.charAt(0))) {
275                 issue = &quot;JDK-&quot; + issue;
276             }
277         }
278         if (issue == null) {
279             var pattern = Pattern.compile(&quot;(?:(&quot; + String.join(&quot;|&quot;, KNOWN_JBS_PROJECTS) + &quot;)-)?([0-9]+).*&quot;);
280             var currentBranch = repo.currentBranch();
281             if (currentBranch.isPresent()) {
282                 var branchName = currentBranch.get().name().toUpperCase();
283                 var m = pattern.matcher(branchName);
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>