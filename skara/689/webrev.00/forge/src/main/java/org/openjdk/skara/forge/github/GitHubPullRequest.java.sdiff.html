<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff forge/src/main/java/org/openjdk/skara/forge/github/GitHubPullRequest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="GitHubRepository.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>forge/src/main/java/org/openjdk/skara/forge/github/GitHubPullRequest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.forge.github;
 24 
 25 import org.openjdk.skara.forge.*;
 26 import org.openjdk.skara.host.HostUser;
 27 import org.openjdk.skara.issuetracker.*;
 28 import org.openjdk.skara.json.*;
 29 import org.openjdk.skara.network.*;
 30 import org.openjdk.skara.vcs.Hash;
 31 
 32 import java.net.URI;
 33 import java.time.*;
 34 import java.time.format.DateTimeFormatter;
 35 import java.util.*;

 36 import java.util.logging.Logger;
 37 import java.util.stream.Collectors;
 38 
 39 public class GitHubPullRequest implements PullRequest {
 40     private final JSONValue json;
 41     private final RestRequest request;
 42     private final GitHubHost host;
 43     private final GitHubRepository repository;
 44     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.host&quot;);
 45 
 46     private List&lt;String&gt; labels = null;
 47 
 48     GitHubPullRequest(GitHubRepository repository, JSONValue jsonValue, RestRequest request) {
 49         this.host = (GitHubHost)repository.forge();
 50         this.repository = repository;
 51         this.request = request;
 52         this.json = jsonValue;
 53 
 54         labels = json.get(&quot;labels&quot;)
 55                      .stream()
</pre>
<hr />
<pre>
 61     @Override
 62     public HostedRepository repository() {
 63         return repository;
 64     }
 65 
 66     @Override
 67     public IssueProject project() {
 68         return null;
 69     }
 70 
 71     @Override
 72     public String id() {
 73         return json.get(&quot;number&quot;).toString();
 74     }
 75 
 76     @Override
 77     public HostUser author() {
 78         return host.parseUserField(json);
 79     }
 80 









 81     @Override
 82     public List&lt;Review&gt; reviews() {
 83         var reviews = request.get(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/reviews&quot;).execute().stream()
 84                              .map(JSONValue::asObject)
 85                              .filter(obj -&gt; !(obj.get(&quot;state&quot;).asString().equals(&quot;COMMENTED&quot;) &amp;&amp; obj.get(&quot;body&quot;).asString().isEmpty()))
 86                              .map(obj -&gt; {
 87                                  var reviewer = host.parseUserField(obj);
 88                                  var hash = new Hash(obj.get(&quot;commit_id&quot;).asString());
 89                                  Review.Verdict verdict;
 90                                  switch (obj.get(&quot;state&quot;).asString()) {
 91                                      case &quot;APPROVED&quot;:
 92                                          verdict = Review.Verdict.APPROVED;
 93                                          break;
 94                                      case &quot;CHANGES_REQUESTED&quot;:
 95                                          verdict = Review.Verdict.DISAPPROVED;
 96                                          break;
 97                                      default:
 98                                          verdict = Review.Verdict.NONE;
 99                                          break;
100                                  }
101                                  var id = obj.get(&quot;id&quot;).asInt();
102                                  var body = obj.get(&quot;body&quot;).asString();
103                                  var createdAt = ZonedDateTime.parse(obj.get(&quot;submitted_at&quot;).asString());
104                                  return new Review(createdAt, reviewer, verdict, hash, id, body);
105                              })
106                              .collect(Collectors.toList());









107         return reviews;
108     }
109 
110     @Override
111     public void addReview(Review.Verdict verdict, String body) {
112         var query = JSON.object();
113         switch (verdict) {
114             case APPROVED:
115                 query.put(&quot;event&quot;, &quot;APPROVE&quot;);
116                 break;
117             case DISAPPROVED:
118                 query.put(&quot;event&quot;, &quot;REQUEST_CHANGES&quot;);
119                 break;
120             case NONE:
121                 query.put(&quot;event&quot;, &quot;COMMENT&quot;);
122                 break;
123         }
124         query.put(&quot;body&quot;, body);
125         query.put(&quot;commit_id&quot;, headHash().hex());
126         query.put(&quot;comments&quot;, JSON.array());
</pre>
</td>
<td>
<hr />
<pre>
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.forge.github;
 24 
 25 import org.openjdk.skara.forge.*;
 26 import org.openjdk.skara.host.HostUser;
 27 import org.openjdk.skara.issuetracker.*;
 28 import org.openjdk.skara.json.*;
 29 import org.openjdk.skara.network.*;
 30 import org.openjdk.skara.vcs.Hash;
 31 
 32 import java.net.URI;
 33 import java.time.*;
 34 import java.time.format.DateTimeFormatter;
 35 import java.util.*;
<span class="line-added"> 36 import java.util.function.Function;</span>
 37 import java.util.logging.Logger;
 38 import java.util.stream.Collectors;
 39 
 40 public class GitHubPullRequest implements PullRequest {
 41     private final JSONValue json;
 42     private final RestRequest request;
 43     private final GitHubHost host;
 44     private final GitHubRepository repository;
 45     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.host&quot;);
 46 
 47     private List&lt;String&gt; labels = null;
 48 
 49     GitHubPullRequest(GitHubRepository repository, JSONValue jsonValue, RestRequest request) {
 50         this.host = (GitHubHost)repository.forge();
 51         this.repository = repository;
 52         this.request = request;
 53         this.json = jsonValue;
 54 
 55         labels = json.get(&quot;labels&quot;)
 56                      .stream()
</pre>
<hr />
<pre>
 62     @Override
 63     public HostedRepository repository() {
 64         return repository;
 65     }
 66 
 67     @Override
 68     public IssueProject project() {
 69         return null;
 70     }
 71 
 72     @Override
 73     public String id() {
 74         return json.get(&quot;number&quot;).toString();
 75     }
 76 
 77     @Override
 78     public HostUser author() {
 79         return host.parseUserField(json);
 80     }
 81 
<span class="line-added"> 82     private Optional&lt;ZonedDateTime&gt; lastBaseRefChange() {</span>
<span class="line-added"> 83         return request.get(&quot;issues/&quot; + json.get(&quot;number&quot;).toString() + &quot;/timeline&quot;).execute().stream()</span>
<span class="line-added"> 84                       .map(JSONValue::asObject)</span>
<span class="line-added"> 85                       .filter(obj -&gt; obj.contains(&quot;event&quot;))</span>
<span class="line-added"> 86                       .filter(obj -&gt; obj.get(&quot;event&quot;).asString().equals(&quot;base_ref_changed&quot;))</span>
<span class="line-added"> 87                       .map(o -&gt; ZonedDateTime.parse(o.get(&quot;created_at&quot;).asString()))</span>
<span class="line-added"> 88                       .max(Comparator.comparing(Function.identity()));</span>
<span class="line-added"> 89     }</span>
<span class="line-added"> 90 </span>
 91     @Override
 92     public List&lt;Review&gt; reviews() {
 93         var reviews = request.get(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/reviews&quot;).execute().stream()
 94                              .map(JSONValue::asObject)
 95                              .filter(obj -&gt; !(obj.get(&quot;state&quot;).asString().equals(&quot;COMMENTED&quot;) &amp;&amp; obj.get(&quot;body&quot;).asString().isEmpty()))
 96                              .map(obj -&gt; {
 97                                  var reviewer = host.parseUserField(obj);
 98                                  var hash = new Hash(obj.get(&quot;commit_id&quot;).asString());
 99                                  Review.Verdict verdict;
100                                  switch (obj.get(&quot;state&quot;).asString()) {
101                                      case &quot;APPROVED&quot;:
102                                          verdict = Review.Verdict.APPROVED;
103                                          break;
104                                      case &quot;CHANGES_REQUESTED&quot;:
105                                          verdict = Review.Verdict.DISAPPROVED;
106                                          break;
107                                      default:
108                                          verdict = Review.Verdict.NONE;
109                                          break;
110                                  }
111                                  var id = obj.get(&quot;id&quot;).asInt();
112                                  var body = obj.get(&quot;body&quot;).asString();
113                                  var createdAt = ZonedDateTime.parse(obj.get(&quot;submitted_at&quot;).asString());
114                                  return new Review(createdAt, reviewer, verdict, hash, id, body);
115                              })
116                              .collect(Collectors.toList());
<span class="line-added">117 </span>
<span class="line-added">118         // In the unlikely event that the base ref has changed after a review, we treat those as invalid</span>
<span class="line-added">119         var lastBaseRefChange = lastBaseRefChange();</span>
<span class="line-added">120         if (lastBaseRefChange.isPresent()) {</span>
<span class="line-added">121             reviews = reviews.stream()</span>
<span class="line-added">122                              .filter(r -&gt; r.createdAt().isAfter(lastBaseRefChange.get()))</span>
<span class="line-added">123                              .collect(Collectors.toList());;</span>
<span class="line-added">124         }</span>
<span class="line-added">125 </span>
126         return reviews;
127     }
128 
129     @Override
130     public void addReview(Review.Verdict verdict, String body) {
131         var query = JSON.object();
132         switch (verdict) {
133             case APPROVED:
134                 query.put(&quot;event&quot;, &quot;APPROVE&quot;);
135                 break;
136             case DISAPPROVED:
137                 query.put(&quot;event&quot;, &quot;REQUEST_CHANGES&quot;);
138                 break;
139             case NONE:
140                 query.put(&quot;event&quot;, &quot;COMMENT&quot;);
141                 break;
142         }
143         query.put(&quot;body&quot;, body);
144         query.put(&quot;commit_id&quot;, headHash().hex());
145         query.put(&quot;comments&quot;, JSON.array());
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="GitHubRepository.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>