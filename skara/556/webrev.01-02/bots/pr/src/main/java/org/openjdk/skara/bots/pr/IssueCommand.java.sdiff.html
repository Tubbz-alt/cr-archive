<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/IssueCommand.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/IssueCommand.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 88 
 89         // Drop the validated project prefixes
 90         return ret.stream()
 91                   .map(issue -&gt; issue.id().contains(&quot;-&quot;) ? new Issue(issue.id().split(&quot;-&quot;, 2)[1], issue.description()) : issue)
 92                   .collect(Collectors.toList());
 93     }
 94 
 95     private final static Pattern subCommandPattern = Pattern.compile(&quot;^(add|remove|delete|(?:[A-Za-z]+-)?[0-9]+:?)[ ,]+.*$&quot;);
 96 
 97     IssueCommand(String name) {
 98         this.name = name;
 99     }
100 
101     IssueCommand() {
102         this(&quot;issue&quot;);
103     }
104 
105     @Override
106     public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, String args, Comment comment, List&lt;Comment&gt; allComments, PrintWriter reply) {
107         if (!comment.author().equals(pr.author())) {
<span class="line-modified">108             reply.println(&quot;Only the author (@&quot; + pr.author().userName() + &quot;) is allowed to issue the `solves` command.&quot;);</span>
109             return;
110         }
111         if (args.isBlank()) {
112             showHelp(reply);
113             return;
114         }
115         var subCommandMatcher = subCommandPattern.matcher(args);
116         if (!subCommandMatcher.matches()) {
117             showHelp(reply);
118             return;
119         }
120 
121         var currentSolved = SolvesTracker.currentSolved(pr.repository().forge().currentUser(), allComments)
122                                          .stream()
123                                          .map(Issue::id)
124                                          .collect(Collectors.toSet());
125         try {
126             if (args.startsWith(&quot;remove&quot;) || args.startsWith(&quot;delete&quot;)) {
127                 var issueListStart = args.indexOf(&#39; &#39;);
128                 if (issueListStart == -1) {
129                     showHelp(reply);
130                     return;
131                 }
132                 if (currentSolved.isEmpty()) {
133                     reply.println(&quot;This PR does not contain any additional solved issues that can be removed. To remove the primary solved issue, simply edit the title of this PR.&quot;);
134                     return;
135                 }
136                 var issuesToRemove = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args.substring(issueListStart));
137                 for (var issue : issuesToRemove) {
138                     if (currentSolved.contains(issue.id())) {
139                         reply.println(SolvesTracker.removeSolvesMarker(issue));
<span class="line-modified">140                         reply.println(&quot;Removing additional issue from solves list: `&quot; + issue.id() + &quot;`.&quot;);</span>
141                     } else {
142                         reply.print(&quot;The issue `&quot; + issue.id() + &quot;` was not found in the list of additional solved issues. The list currently contains these issues: &quot;);
143                         var currentList = currentSolved.stream()
144                                                        .map(id -&gt; &quot;`&quot; + id + &quot;`&quot;)
145                                                        .collect(Collectors.joining(&quot;, &quot;));
146                         reply.println(currentList);
147                     }
148                 }
149             } else {
150                 if (args.startsWith(&quot;add&quot;)) {
151                     var issueListStart = args.indexOf(&#39; &#39;);
152                     if (issueListStart == -1) {
153                         showHelp(reply);
154                         return;
155                     }
156                     args = args.substring(issueListStart);
157                 }
158                 var issues = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args);
159                 if (issues.size() == 0) {
160                     showHelp(reply);
161                     return;
162                 }
163                 var validatedIssues = new ArrayList&lt;Issue&gt;();
164                 for (var issue : issues) {
165                     try {
166                         if (bot.issueProject() == null) {
167                             if (issue.description() == null) {
168                                 reply.print(&quot;This repository does not have an issue project configured - you will need to input the issue title manually &quot;);
<span class="line-modified">169                                 reply.println(&quot;using the syntax `/solves &quot; + issue.id() + &quot;: title of the issue`.&quot;);</span>
170                                 return;
171                             } else {
172                                 validatedIssues.add(issue);
173                                 continue;
174                             }
175                         }
176                         var validatedIssue = bot.issueProject().issue(issue.id());
177                         if (validatedIssue.isEmpty()) {
178                             reply.println(&quot;The issue `&quot; + issue.id() + &quot;` was not found in the `&quot; + bot.issueProject().name() + &quot;` project - make sure you have entered it correctly.&quot;);
179                             continue;
180                         }
181                         if (validatedIssue.get().state() != org.openjdk.skara.issuetracker.Issue.State.OPEN) {
182                             reply.println(&quot;The issue [&quot; + validatedIssue.get().id() + &quot;](&quot; + validatedIssue.get().webUrl() + &quot;) isn&#39;t open - make sure you have selected the correct issue.&quot;);
183                             continue;
184                         }
185                         if (issue.description() == null) {
186                             validatedIssues.add(new Issue(validatedIssue.get().id(), validatedIssue.get().title()));
187                         } else {
188                             validatedIssues.add(new Issue(validatedIssue.get().id(), issue.description()));
189                         }
190 
191                     } catch (RuntimeException e) {
192                         if (issue.description() == null) {
193                             reply.print(&quot;Temporary failure when trying to look up issue `&quot; + issue.id() + &quot;` - you will need to input the issue title manually &quot;);
<span class="line-modified">194                             reply.println(&quot;using the syntax `/solves &quot; + issue.id() + &quot;: title of the issue`.&quot;);</span>
195                             return;
196                         } else {
197                             validatedIssues.add(issue);
198                         }
199                     }
200                 }
201                 if (validatedIssues.size() != issues.size()) {
202                     reply.println(&quot;As there were validation problems, no additional issues will be added to the list of solved issues.&quot;);
203                     return;
204                 }
205 
206                 // Drop the validated project prefixes
207                 var strippedValidatedIssues = validatedIssues.stream()
208                                                              .map(issue -&gt; issue.id().contains(&quot;-&quot;) ? new Issue(issue.id().split(&quot;-&quot;, 2)[1], issue.description()) : issue)
209                                                              .collect(Collectors.toList());
210                 var titleIssue = Issue.fromString(pr.title());
211                 for (var issue : strippedValidatedIssues) {
212                     if (titleIssue.isEmpty()) {
213                         reply.print(&quot;The primary solved issue for a PR is set through the PR title. Since the current title does &quot;);
214                         reply.println(&quot;not contain an issue reference, it will now be updated.&quot;);
215                         pr.setTitle(issue.toString());
216                         titleIssue = Optional.of(issue);
217                         continue;
218                     }
219                     if (titleIssue.get().id().equals(issue.id())) {
220                         reply.println(&quot;This issue is referenced in the PR title - it will now be updated.&quot;);
221                         pr.setTitle(issue.toString());
222                         continue;
223                     }
224                     reply.println(SolvesTracker.setSolvesMarker(issue));
225                     if (currentSolved.contains(issue.id())) {
226                         reply.println(&quot;Updating description of additional solved issue: `&quot; + issue.toString() + &quot;`.&quot;);
227                     } else {
<span class="line-modified">228                         reply.println(&quot;Adding additional issue to solves list: `&quot; + issue.toString() + &quot;`.&quot;);</span>
229                     }
230                 }
231             }
232 
233         } catch (InvalidIssue invalidIssue) {
234             reply.println(&quot;The issue identifier `&quot; + invalidIssue.identifier() + &quot;` is invalid: &quot; + invalidIssue.reason() + &quot;.&quot;);
235         }
236     }
237 
238     @Override
239     public String description() {
240         return &quot;edit the list of issues that this PR solves&quot;;
241     }
242 }
</pre>
</td>
<td>
<hr />
<pre>
 88 
 89         // Drop the validated project prefixes
 90         return ret.stream()
 91                   .map(issue -&gt; issue.id().contains(&quot;-&quot;) ? new Issue(issue.id().split(&quot;-&quot;, 2)[1], issue.description()) : issue)
 92                   .collect(Collectors.toList());
 93     }
 94 
 95     private final static Pattern subCommandPattern = Pattern.compile(&quot;^(add|remove|delete|(?:[A-Za-z]+-)?[0-9]+:?)[ ,]+.*$&quot;);
 96 
 97     IssueCommand(String name) {
 98         this.name = name;
 99     }
100 
101     IssueCommand() {
102         this(&quot;issue&quot;);
103     }
104 
105     @Override
106     public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, String args, Comment comment, List&lt;Comment&gt; allComments, PrintWriter reply) {
107         if (!comment.author().equals(pr.author())) {
<span class="line-modified">108             reply.println(&quot;Only the author (@&quot; + pr.author().userName() + &quot;) is allowed to issue the `/&quot; + name + &quot;` command.&quot;);</span>
109             return;
110         }
111         if (args.isBlank()) {
112             showHelp(reply);
113             return;
114         }
115         var subCommandMatcher = subCommandPattern.matcher(args);
116         if (!subCommandMatcher.matches()) {
117             showHelp(reply);
118             return;
119         }
120 
121         var currentSolved = SolvesTracker.currentSolved(pr.repository().forge().currentUser(), allComments)
122                                          .stream()
123                                          .map(Issue::id)
124                                          .collect(Collectors.toSet());
125         try {
126             if (args.startsWith(&quot;remove&quot;) || args.startsWith(&quot;delete&quot;)) {
127                 var issueListStart = args.indexOf(&#39; &#39;);
128                 if (issueListStart == -1) {
129                     showHelp(reply);
130                     return;
131                 }
132                 if (currentSolved.isEmpty()) {
133                     reply.println(&quot;This PR does not contain any additional solved issues that can be removed. To remove the primary solved issue, simply edit the title of this PR.&quot;);
134                     return;
135                 }
136                 var issuesToRemove = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args.substring(issueListStart));
137                 for (var issue : issuesToRemove) {
138                     if (currentSolved.contains(issue.id())) {
139                         reply.println(SolvesTracker.removeSolvesMarker(issue));
<span class="line-modified">140                         reply.println(&quot;Removing additional issue from &quot; + name + &quot; list: `&quot; + issue.id() + &quot;`.&quot;);</span>
141                     } else {
142                         reply.print(&quot;The issue `&quot; + issue.id() + &quot;` was not found in the list of additional solved issues. The list currently contains these issues: &quot;);
143                         var currentList = currentSolved.stream()
144                                                        .map(id -&gt; &quot;`&quot; + id + &quot;`&quot;)
145                                                        .collect(Collectors.joining(&quot;, &quot;));
146                         reply.println(currentList);
147                     }
148                 }
149             } else {
150                 if (args.startsWith(&quot;add&quot;)) {
151                     var issueListStart = args.indexOf(&#39; &#39;);
152                     if (issueListStart == -1) {
153                         showHelp(reply);
154                         return;
155                     }
156                     args = args.substring(issueListStart);
157                 }
158                 var issues = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args);
159                 if (issues.size() == 0) {
160                     showHelp(reply);
161                     return;
162                 }
163                 var validatedIssues = new ArrayList&lt;Issue&gt;();
164                 for (var issue : issues) {
165                     try {
166                         if (bot.issueProject() == null) {
167                             if (issue.description() == null) {
168                                 reply.print(&quot;This repository does not have an issue project configured - you will need to input the issue title manually &quot;);
<span class="line-modified">169                                 reply.println(&quot;using the syntax `/&quot; + name + &quot; &quot; + issue.id() + &quot;: title of the issue`.&quot;);</span>
170                                 return;
171                             } else {
172                                 validatedIssues.add(issue);
173                                 continue;
174                             }
175                         }
176                         var validatedIssue = bot.issueProject().issue(issue.id());
177                         if (validatedIssue.isEmpty()) {
178                             reply.println(&quot;The issue `&quot; + issue.id() + &quot;` was not found in the `&quot; + bot.issueProject().name() + &quot;` project - make sure you have entered it correctly.&quot;);
179                             continue;
180                         }
181                         if (validatedIssue.get().state() != org.openjdk.skara.issuetracker.Issue.State.OPEN) {
182                             reply.println(&quot;The issue [&quot; + validatedIssue.get().id() + &quot;](&quot; + validatedIssue.get().webUrl() + &quot;) isn&#39;t open - make sure you have selected the correct issue.&quot;);
183                             continue;
184                         }
185                         if (issue.description() == null) {
186                             validatedIssues.add(new Issue(validatedIssue.get().id(), validatedIssue.get().title()));
187                         } else {
188                             validatedIssues.add(new Issue(validatedIssue.get().id(), issue.description()));
189                         }
190 
191                     } catch (RuntimeException e) {
192                         if (issue.description() == null) {
193                             reply.print(&quot;Temporary failure when trying to look up issue `&quot; + issue.id() + &quot;` - you will need to input the issue title manually &quot;);
<span class="line-modified">194                             reply.println(&quot;using the syntax `/&quot; + name + &quot; &quot; + issue.id() + &quot;: title of the issue`.&quot;);</span>
195                             return;
196                         } else {
197                             validatedIssues.add(issue);
198                         }
199                     }
200                 }
201                 if (validatedIssues.size() != issues.size()) {
202                     reply.println(&quot;As there were validation problems, no additional issues will be added to the list of solved issues.&quot;);
203                     return;
204                 }
205 
206                 // Drop the validated project prefixes
207                 var strippedValidatedIssues = validatedIssues.stream()
208                                                              .map(issue -&gt; issue.id().contains(&quot;-&quot;) ? new Issue(issue.id().split(&quot;-&quot;, 2)[1], issue.description()) : issue)
209                                                              .collect(Collectors.toList());
210                 var titleIssue = Issue.fromString(pr.title());
211                 for (var issue : strippedValidatedIssues) {
212                     if (titleIssue.isEmpty()) {
213                         reply.print(&quot;The primary solved issue for a PR is set through the PR title. Since the current title does &quot;);
214                         reply.println(&quot;not contain an issue reference, it will now be updated.&quot;);
215                         pr.setTitle(issue.toString());
216                         titleIssue = Optional.of(issue);
217                         continue;
218                     }
219                     if (titleIssue.get().id().equals(issue.id())) {
220                         reply.println(&quot;This issue is referenced in the PR title - it will now be updated.&quot;);
221                         pr.setTitle(issue.toString());
222                         continue;
223                     }
224                     reply.println(SolvesTracker.setSolvesMarker(issue));
225                     if (currentSolved.contains(issue.id())) {
226                         reply.println(&quot;Updating description of additional solved issue: `&quot; + issue.toString() + &quot;`.&quot;);
227                     } else {
<span class="line-modified">228                         reply.println(&quot;Adding additional issue to &quot; + name + &quot; list: `&quot; + issue.toString() + &quot;`.&quot;);</span>
229                     }
230                 }
231             }
232 
233         } catch (InvalidIssue invalidIssue) {
234             reply.println(&quot;The issue identifier `&quot; + invalidIssue.identifier() + &quot;` is invalid: &quot; + invalidIssue.reason() + &quot;.&quot;);
235         }
236     }
237 
238     @Override
239     public String description() {
240         return &quot;edit the list of issues that this PR solves&quot;;
241     }
242 }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>