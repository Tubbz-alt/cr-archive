<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/pr/src/main/java/org/openjdk/skara/bots/pr/SolvesCommand.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.pr;
 24 
 25 import org.openjdk.skara.forge.PullRequest;
 26 import org.openjdk.skara.issuetracker.Comment;
 27 import org.openjdk.skara.vcs.openjdk.Issue;
 28 
 29 import java.io.PrintWriter;
 30 import java.nio.file.Path;
<a name="1" id="anc1"></a><span class="line-modified"> 31 import java.util.*;</span>
<span class="line-added"> 32 import java.util.regex.Pattern;</span>
 33 import java.util.stream.Collectors;
 34 
<a name="2" id="anc2"></a><span class="line-added"> 35 class InvalidIssue extends Exception {</span>
<span class="line-added"> 36     private String identifier;</span>
<span class="line-added"> 37     private String reason;</span>
<span class="line-added"> 38 </span>
<span class="line-added"> 39     InvalidIssue(String identifier, String reason) {</span>
<span class="line-added"> 40         this.identifier = identifier;</span>
<span class="line-added"> 41         this.reason = reason;</span>
<span class="line-added"> 42     }</span>
<span class="line-added"> 43 </span>
<span class="line-added"> 44     String identifier() {</span>
<span class="line-added"> 45         return identifier;</span>
<span class="line-added"> 46     }</span>
<span class="line-added"> 47 </span>
<span class="line-added"> 48     String reason() {</span>
<span class="line-added"> 49         return reason;</span>
<span class="line-added"> 50     }</span>
<span class="line-added"> 51 }</span>
<span class="line-added"> 52 </span>
 53 public class SolvesCommand implements CommandHandler {
 54     private void showHelp(PrintWriter reply) {
<a name="3" id="anc3"></a><span class="line-modified"> 55         reply.println(&quot;Command syntax: `/solves [remove] &lt;id&gt;[,&lt;id&gt;,...]` or `/solves &lt;id&gt;: &lt;description&gt;`. For example:&quot;);</span>
<span class="line-modified"> 56         reply.println();</span>
<span class="line-added"> 57         reply.println(&quot; * `/solves JDK-1234567,4567890`&quot;);</span>
<span class="line-added"> 58         reply.println(&quot; * `/solves remove JDK-4567890`&quot;);</span>
<span class="line-added"> 59         reply.println(&quot; * `/solves 1234567: Use this exact title`&quot;);</span>
<span class="line-added"> 60         reply.println();</span>
<span class="line-added"> 61         reply.print(&quot;If issues are specified only by their ID, the title will be automatically retrieved from JBS. &quot;);</span>
<span class="line-added"> 62         reply.print(&quot;The project prefix (`JDK-` in the above examples) is optional. &quot;);</span>
<span class="line-added"> 63         reply.println(&quot;Separate multiple issue IDs using either spaces or commas.&quot;);</span>
<span class="line-added"> 64     }</span>
<span class="line-added"> 65 </span>
<span class="line-added"> 66     private static final Pattern shortIssuePattern = Pattern.compile(&quot;((?:[A-Za-z]+-)?[0-9]+)(?:,| |$)&quot;);</span>
<span class="line-added"> 67 </span>
<span class="line-added"> 68     private List&lt;Issue&gt; parseIssueList(String allowedPrefix, String issueList) throws InvalidIssue {</span>
<span class="line-added"> 69         List&lt;Issue&gt; ret;</span>
<span class="line-added"> 70         // Is this a single fully described issue?</span>
<span class="line-added"> 71         var singleIssue = Issue.fromString(issueList);</span>
<span class="line-added"> 72         if (singleIssue.isPresent()) {</span>
<span class="line-added"> 73             ret = List.of(singleIssue.get());</span>
<span class="line-added"> 74         } else {</span>
<span class="line-added"> 75             var shortIssueMatcher = shortIssuePattern.matcher(issueList);</span>
<span class="line-added"> 76             ret = shortIssueMatcher.results()</span>
<span class="line-added"> 77                                    .map(matchResult -&gt; matchResult.group(1))</span>
<span class="line-added"> 78                                    .map(identifier -&gt; new Issue(identifier, null))</span>
<span class="line-added"> 79                                    .collect(Collectors.toList());</span>
<span class="line-added"> 80         }</span>
<span class="line-added"> 81         for (var issue : ret) {</span>
<span class="line-added"> 82             if (issue.id().contains(&quot;-&quot;) &amp;&amp; !issue.id().startsWith(allowedPrefix)) {</span>
<span class="line-added"> 83                 throw new InvalidIssue(issue.id(), &quot;This PR can only solve issues in the &quot; + allowedPrefix + &quot; project&quot;);</span>
<span class="line-added"> 84             }</span>
<span class="line-added"> 85         }</span>
<span class="line-added"> 86 </span>
<span class="line-added"> 87         // Drop the validated project prefixes</span>
<span class="line-added"> 88         return ret.stream()</span>
<span class="line-added"> 89                   .map(issue -&gt; issue.id().contains(&quot;-&quot;) ? new Issue(issue.id().split(&quot;-&quot;, 2)[1], issue.description()) : issue)</span>
<span class="line-added"> 90                   .collect(Collectors.toList());</span>
 91     }
 92 
 93     @Override
 94     public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, String args, Comment comment, List&lt;Comment&gt; allComments, PrintWriter reply) {
 95         if (!comment.author().equals(pr.author())) {
 96             reply.println(&quot;Only the author (@&quot; + pr.author().userName() + &quot;) is allowed to issue the `solves` command.&quot;);
 97             return;
 98         }
<a name="4" id="anc4"></a>
 99         if (args.isBlank()) {
100             showHelp(reply);
101             return;
102         }
103 
104         var currentSolved = SolvesTracker.currentSolved(pr.repository().forge().currentUser(), allComments)
105                                          .stream()
106                                          .map(Issue::id)
107                                          .collect(Collectors.toSet());
<a name="5" id="anc5"></a><span class="line-added">108         try {</span>
<span class="line-added">109             if (args.startsWith(&quot;remove&quot;) || args.startsWith(&quot;delete&quot;)) {</span>
<span class="line-added">110                 var issueListStart = args.indexOf(&#39; &#39;);</span>
<span class="line-added">111                 if (issueListStart == -1) {</span>
<span class="line-added">112                     showHelp(reply);</span>
<span class="line-added">113                     return;</span>
<span class="line-added">114                 }</span>
<span class="line-added">115                 if (currentSolved.isEmpty()) {</span>
<span class="line-added">116                     reply.println(&quot;This PR does not contain any additional solved issues that can be removed. To remove the primary solved issue, simply edit the title of this PR.&quot;);</span>
<span class="line-added">117                     return;</span>
<span class="line-added">118                 }</span>
<span class="line-added">119                 var issuesToRemove = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args.substring(issueListStart));</span>
<span class="line-added">120                 for (var issue : issuesToRemove) {</span>
<span class="line-added">121                     if (currentSolved.contains(issue.id())) {</span>
<span class="line-added">122                         reply.println(SolvesTracker.removeSolvesMarker(issue));</span>
<span class="line-added">123                         reply.println(&quot;Removing additional issue from solves list: `&quot; + issue.id() + &quot;`.&quot;);</span>
<span class="line-added">124                     } else {</span>
<span class="line-added">125                         reply.print(&quot;The issue `&quot; + issue.id() + &quot;` was not found in the list of additional solved issues. The list currently contains these issues: &quot;);</span>
<span class="line-added">126                         var currentList = currentSolved.stream()</span>
<span class="line-added">127                                                        .map(id -&gt; &quot;`&quot; + id + &quot;`&quot;)</span>
<span class="line-added">128                                                        .collect(Collectors.joining(&quot;, &quot;));</span>
<span class="line-added">129                         reply.println(currentList);</span>
<span class="line-added">130                     }</span>
<span class="line-added">131                 }</span>
<span class="line-added">132             } else {</span>
<span class="line-added">133                 var issues = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args);</span>
<span class="line-added">134                 if (issues.size() == 0) {</span>
<span class="line-added">135                     showHelp(reply);</span>
<span class="line-added">136                     return;</span>
<span class="line-added">137                 }</span>
<span class="line-added">138                 var validatedIssues = new ArrayList&lt;Issue&gt;();</span>
<span class="line-added">139                 for (var issue : issues) {</span>
<span class="line-added">140                     try {</span>
<span class="line-added">141                         if (bot.issueProject() == null) {</span>
<span class="line-added">142                             if (issue.description() == null) {</span>
<span class="line-added">143                                 reply.print(&quot;This repository does not have an issue project configured - you will need to input the issue title manually &quot;);</span>
<span class="line-added">144                                 reply.println(&quot;using the syntax `/solves &quot; + issue.id() + &quot;: title of the issue`.&quot;);</span>
<span class="line-added">145                                 return;</span>
<span class="line-added">146                             } else {</span>
<span class="line-added">147                                 validatedIssues.add(issue);</span>
<span class="line-added">148                                 continue;</span>
<span class="line-added">149                             }</span>
<span class="line-added">150                         }</span>
<span class="line-added">151                         var validatedIssue = bot.issueProject().issue(issue.id());</span>
<span class="line-added">152                         if (validatedIssue.isEmpty()) {</span>
<span class="line-added">153                             reply.println(&quot;The issue `&quot; + issue.id() + &quot;` was not found in the `&quot; + bot.issueProject().name() + &quot;` project - make sure you have entered it correctly.&quot;);</span>
<span class="line-added">154                             continue;</span>
<span class="line-added">155                         }</span>
<span class="line-added">156                         if (validatedIssue.get().state() != org.openjdk.skara.issuetracker.Issue.State.OPEN) {</span>
<span class="line-added">157                             reply.println(&quot;The issue [&quot; + validatedIssue.get().id() + &quot;](&quot; + validatedIssue.get().webUrl() + &quot;) isn&#39;t open - make sure you have selected the correct issue.&quot;);</span>
<span class="line-added">158                             continue;</span>
<span class="line-added">159                         }</span>
<span class="line-added">160                         if (issue.description() == null) {</span>
<span class="line-added">161                             validatedIssues.add(new Issue(validatedIssue.get().id(), validatedIssue.get().title()));</span>
<span class="line-added">162                         } else {</span>
<span class="line-added">163                             validatedIssues.add(new Issue(validatedIssue.get().id(), issue.description()));</span>
<span class="line-added">164                         }</span>
165 
<a name="6" id="anc6"></a><span class="line-modified">166                     } catch (RuntimeException e) {</span>
<span class="line-modified">167                         if (issue.description() == null) {</span>
<span class="line-modified">168                             reply.print(&quot;Temporary failure when trying to look up issue `&quot; + issue.id() + &quot;` - you will need to input the issue title manually &quot;);</span>
<span class="line-modified">169                             reply.println(&quot;using the syntax `/solves &quot; + issue.id() + &quot;: title of the issue`.&quot;);</span>
<span class="line-modified">170                             return;</span>
<span class="line-modified">171                         } else {</span>
<span class="line-modified">172                             validatedIssues.add(issue);</span>
<span class="line-modified">173                         }</span>
<span class="line-added">174                     }</span>
<span class="line-added">175                 }</span>
<span class="line-added">176                 if (validatedIssues.size() != issues.size()) {</span>
<span class="line-added">177                     reply.println(&quot;As there were validation problems, no additional issues will be added to the list of solved issues.&quot;);</span>
<span class="line-added">178                     return;</span>
<span class="line-added">179                 }</span>
180 
<a name="7" id="anc7"></a><span class="line-modified">181                 // Drop the validated project prefixes</span>
<span class="line-modified">182                 var strippedValidatedIssues = validatedIssues.stream()</span>
<span class="line-modified">183                                                              .map(issue -&gt; issue.id().contains(&quot;-&quot;) ? new Issue(issue.id().split(&quot;-&quot;, 2)[1], issue.description()) : issue)</span>
<span class="line-modified">184                                                              .collect(Collectors.toList());</span>
<span class="line-modified">185                 var titleIssue = Issue.fromString(pr.title());</span>
<span class="line-added">186                 for (var issue : strippedValidatedIssues) {</span>
<span class="line-added">187                     if (titleIssue.isEmpty()) {</span>
<span class="line-added">188                         reply.print(&quot;The primary solved issue for a PR is set through the PR title. Since the current title does &quot;);</span>
<span class="line-added">189                         reply.println(&quot;not contain an issue reference, it will now be updated.&quot;);</span>
<span class="line-added">190                         pr.setTitle(issue.toString());</span>
<span class="line-added">191                         titleIssue = Optional.of(issue);</span>
<span class="line-added">192                         continue;</span>
<span class="line-added">193                     }</span>
<span class="line-added">194                     if (titleIssue.get().id().equals(issue.id())) {</span>
<span class="line-added">195                         reply.println(&quot;This issue is referenced in the PR title - it will now be updated.&quot;);</span>
<span class="line-added">196                         pr.setTitle(issue.toString());</span>
<span class="line-added">197                         continue;</span>
<span class="line-added">198                     }</span>
<span class="line-added">199                     reply.println(SolvesTracker.setSolvesMarker(issue));</span>
<span class="line-added">200                     if (currentSolved.contains(issue.id())) {</span>
<span class="line-added">201                         reply.println(&quot;Updating description of additional solved issue: `&quot; + issue.toString() + &quot;`.&quot;);</span>
<span class="line-added">202                     } else {</span>
<span class="line-added">203                         reply.println(&quot;Adding additional issue to solves list: `&quot; + issue.toString() + &quot;`.&quot;);</span>
<span class="line-added">204                     }</span>
<span class="line-added">205                 }</span>
206             }
<a name="8" id="anc8"></a>

207 
<a name="9" id="anc9"></a><span class="line-modified">208         } catch (InvalidIssue invalidIssue) {</span>
<span class="line-modified">209             reply.println(&quot;The issue identifier `&quot; + invalidIssue.identifier() + &quot;` is invalid: &quot; + invalidIssue.reason() + &quot;.&quot;);</span>















210         }
211     }
212 
213     @Override
214     public String description() {
215         return &quot;add an additional issue that this PR solves&quot;;
216     }
217 }
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>