<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/SolvesCommand.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SolvesTracker.java.udiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/SolvesCommand.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,71 +26,189 @@</span>
  import org.openjdk.skara.issuetracker.Comment;
  import org.openjdk.skara.vcs.openjdk.Issue;
  
  import java.io.PrintWriter;
  import java.nio.file.Path;
<span class="udiff-line-modified-removed">- import java.util.List;</span>
<span class="udiff-line-modified-added">+ import java.util.*;</span>
<span class="udiff-line-added">+ import java.util.regex.Pattern;</span>
  import java.util.stream.Collectors;
  
<span class="udiff-line-added">+ class InvalidIssue extends Exception {</span>
<span class="udiff-line-added">+     private String identifier;</span>
<span class="udiff-line-added">+     private String reason;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     InvalidIssue(String identifier, String reason) {</span>
<span class="udiff-line-added">+         this.identifier = identifier;</span>
<span class="udiff-line-added">+         this.reason = reason;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     String identifier() {</span>
<span class="udiff-line-added">+         return identifier;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     String reason() {</span>
<span class="udiff-line-added">+         return reason;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  public class SolvesCommand implements CommandHandler {
      private void showHelp(PrintWriter reply) {
<span class="udiff-line-modified-removed">-         reply.println(&quot;To add an additional issue to the list of issues that this PR solves: `/solves &lt;id&gt;: &lt;description&gt;`.&quot; +</span>
<span class="udiff-line-modified-removed">-                               &quot;To remove a previously added additional issue: `/solves &lt;id&gt;`.&quot;);</span>
<span class="udiff-line-modified-added">+         reply.println(&quot;Command syntax: `/solves [remove] &lt;id&gt;[,&lt;id&gt;,...]` or `/solves &lt;id&gt;: &lt;description&gt;`. For example:&quot;);</span>
<span class="udiff-line-modified-added">+         reply.println();</span>
<span class="udiff-line-added">+         reply.println(&quot; * `/solves JDK-1234567,4567890`&quot;);</span>
<span class="udiff-line-added">+         reply.println(&quot; * `/solves remove JDK-4567890`&quot;);</span>
<span class="udiff-line-added">+         reply.println(&quot; * `/solves 1234567: Use this exact title`&quot;);</span>
<span class="udiff-line-added">+         reply.println();</span>
<span class="udiff-line-added">+         reply.print(&quot;If issues are specified only by their ID, the title will be automatically retrieved from JBS. &quot;);</span>
<span class="udiff-line-added">+         reply.print(&quot;The project prefix (`JDK-` in the above examples) is optional. &quot;);</span>
<span class="udiff-line-added">+         reply.println(&quot;Separate multiple issue IDs using either spaces or commas.&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static final Pattern shortIssuePattern = Pattern.compile(&quot;((?:[A-Za-z]+-)?[0-9]+)(?:,| |$)&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private List&lt;Issue&gt; parseIssueList(String allowedPrefix, String issueList) throws InvalidIssue {</span>
<span class="udiff-line-added">+         List&lt;Issue&gt; ret;</span>
<span class="udiff-line-added">+         // Is this a single fully described issue?</span>
<span class="udiff-line-added">+         var singleIssue = Issue.fromString(issueList);</span>
<span class="udiff-line-added">+         if (singleIssue.isPresent()) {</span>
<span class="udiff-line-added">+             ret = List.of(singleIssue.get());</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             var shortIssueMatcher = shortIssuePattern.matcher(issueList);</span>
<span class="udiff-line-added">+             ret = shortIssueMatcher.results()</span>
<span class="udiff-line-added">+                                    .map(matchResult -&gt; matchResult.group(1))</span>
<span class="udiff-line-added">+                                    .map(identifier -&gt; new Issue(identifier, null))</span>
<span class="udiff-line-added">+                                    .collect(Collectors.toList());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         for (var issue : ret) {</span>
<span class="udiff-line-added">+             if (issue.id().contains(&quot;-&quot;) &amp;&amp; !issue.id().startsWith(allowedPrefix)) {</span>
<span class="udiff-line-added">+                 throw new InvalidIssue(issue.id(), &quot;This PR can only solve issues in the &quot; + allowedPrefix + &quot; project&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Drop the validated project prefixes</span>
<span class="udiff-line-added">+         return ret.stream()</span>
<span class="udiff-line-added">+                   .map(issue -&gt; issue.id().contains(&quot;-&quot;) ? new Issue(issue.id().split(&quot;-&quot;, 2)[1], issue.description()) : issue)</span>
<span class="udiff-line-added">+                   .collect(Collectors.toList());</span>
      }
  
      @Override
      public void handle(PullRequestBot bot, PullRequest pr, CensusInstance censusInstance, Path scratchPath, String args, Comment comment, List&lt;Comment&gt; allComments, PrintWriter reply) {
          if (!comment.author().equals(pr.author())) {
              reply.println(&quot;Only the author (@&quot; + pr.author().userName() + &quot;) is allowed to issue the `solves` command.&quot;);
              return;
          }
<span class="udiff-line-removed">- </span>
          if (args.isBlank()) {
              showHelp(reply);
              return;
          }
  
          var currentSolved = SolvesTracker.currentSolved(pr.repository().forge().currentUser(), allComments)
                                           .stream()
                                           .map(Issue::id)
                                           .collect(Collectors.toSet());
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             if (args.startsWith(&quot;remove&quot;) || args.startsWith(&quot;delete&quot;)) {</span>
<span class="udiff-line-added">+                 var issueListStart = args.indexOf(&#39; &#39;);</span>
<span class="udiff-line-added">+                 if (issueListStart == -1) {</span>
<span class="udiff-line-added">+                     showHelp(reply);</span>
<span class="udiff-line-added">+                     return;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (currentSolved.isEmpty()) {</span>
<span class="udiff-line-added">+                     reply.println(&quot;This PR does not contain any additional solved issues that can be removed. To remove the primary solved issue, simply edit the title of this PR.&quot;);</span>
<span class="udiff-line-added">+                     return;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 var issuesToRemove = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args.substring(issueListStart));</span>
<span class="udiff-line-added">+                 for (var issue : issuesToRemove) {</span>
<span class="udiff-line-added">+                     if (currentSolved.contains(issue.id())) {</span>
<span class="udiff-line-added">+                         reply.println(SolvesTracker.removeSolvesMarker(issue));</span>
<span class="udiff-line-added">+                         reply.println(&quot;Removing additional issue from solves list: `&quot; + issue.id() + &quot;`.&quot;);</span>
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         reply.print(&quot;The issue `&quot; + issue.id() + &quot;` was not found in the list of additional solved issues. The list currently contains these issues: &quot;);</span>
<span class="udiff-line-added">+                         var currentList = currentSolved.stream()</span>
<span class="udiff-line-added">+                                                        .map(id -&gt; &quot;`&quot; + id + &quot;`&quot;)</span>
<span class="udiff-line-added">+                                                        .collect(Collectors.joining(&quot;, &quot;));</span>
<span class="udiff-line-added">+                         reply.println(currentList);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 var issues = parseIssueList(bot.issueProject() == null ? &quot;&quot; : bot.issueProject().name(), args);</span>
<span class="udiff-line-added">+                 if (issues.size() == 0) {</span>
<span class="udiff-line-added">+                     showHelp(reply);</span>
<span class="udiff-line-added">+                     return;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 var validatedIssues = new ArrayList&lt;Issue&gt;();</span>
<span class="udiff-line-added">+                 for (var issue : issues) {</span>
<span class="udiff-line-added">+                     try {</span>
<span class="udiff-line-added">+                         if (bot.issueProject() == null) {</span>
<span class="udiff-line-added">+                             if (issue.description() == null) {</span>
<span class="udiff-line-added">+                                 reply.print(&quot;This repository does not have an issue project configured - you will need to input the issue title manually &quot;);</span>
<span class="udiff-line-added">+                                 reply.println(&quot;using the syntax `/solves &quot; + issue.id() + &quot;: title of the issue`.&quot;);</span>
<span class="udiff-line-added">+                                 return;</span>
<span class="udiff-line-added">+                             } else {</span>
<span class="udiff-line-added">+                                 validatedIssues.add(issue);</span>
<span class="udiff-line-added">+                                 continue;</span>
<span class="udiff-line-added">+                             }</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         var validatedIssue = bot.issueProject().issue(issue.id());</span>
<span class="udiff-line-added">+                         if (validatedIssue.isEmpty()) {</span>
<span class="udiff-line-added">+                             reply.println(&quot;The issue `&quot; + issue.id() + &quot;` was not found in the `&quot; + bot.issueProject().name() + &quot;` project - make sure you have entered it correctly.&quot;);</span>
<span class="udiff-line-added">+                             continue;</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         if (validatedIssue.get().state() != org.openjdk.skara.issuetracker.Issue.State.OPEN) {</span>
<span class="udiff-line-added">+                             reply.println(&quot;The issue [&quot; + validatedIssue.get().id() + &quot;](&quot; + validatedIssue.get().webUrl() + &quot;) isn&#39;t open - make sure you have selected the correct issue.&quot;);</span>
<span class="udiff-line-added">+                             continue;</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         if (issue.description() == null) {</span>
<span class="udiff-line-added">+                             validatedIssues.add(new Issue(validatedIssue.get().id(), validatedIssue.get().title()));</span>
<span class="udiff-line-added">+                         } else {</span>
<span class="udiff-line-added">+                             validatedIssues.add(new Issue(validatedIssue.get().id(), issue.description()));</span>
<span class="udiff-line-added">+                         }</span>
  
<span class="udiff-line-modified-removed">-         var issue = Issue.fromString(args);</span>
<span class="udiff-line-modified-removed">-         if (issue.isEmpty()) {</span>
<span class="udiff-line-modified-removed">-             issue = Issue.fromString(args + &quot;: deleteme&quot;);</span>
<span class="udiff-line-modified-removed">-             if (issue.isEmpty()) {</span>
<span class="udiff-line-modified-removed">-                 reply.println(&quot;Invalid command syntax.&quot;);</span>
<span class="udiff-line-modified-removed">-                 showHelp(reply);</span>
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-added">+                     } catch (RuntimeException e) {</span>
<span class="udiff-line-modified-added">+                         if (issue.description() == null) {</span>
<span class="udiff-line-modified-added">+                             reply.print(&quot;Temporary failure when trying to look up issue `&quot; + issue.id() + &quot;` - you will need to input the issue title manually &quot;);</span>
<span class="udiff-line-modified-added">+                             reply.println(&quot;using the syntax `/solves &quot; + issue.id() + &quot;: title of the issue`.&quot;);</span>
<span class="udiff-line-modified-added">+                             return;</span>
<span class="udiff-line-modified-added">+                         } else {</span>
<span class="udiff-line-modified-added">+                             validatedIssues.add(issue);</span>
<span class="udiff-line-modified-added">+                         }</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (validatedIssues.size() != issues.size()) {</span>
<span class="udiff-line-added">+                     reply.println(&quot;As there were validation problems, no additional issues will be added to the list of solved issues.&quot;);</span>
<span class="udiff-line-added">+                     return;</span>
<span class="udiff-line-added">+                 }</span>
  
<span class="udiff-line-modified-removed">-             if (currentSolved.contains(issue.get().id())) {</span>
<span class="udiff-line-modified-removed">-                 reply.println(SolvesTracker.removeSolvesMarker(issue.get()));;</span>
<span class="udiff-line-modified-removed">-                 reply.println(&quot;Removing additional issue from solves list: `&quot; + issue.get().id() + &quot;`.&quot;);</span>
<span class="udiff-line-modified-removed">-             } else {</span>
<span class="udiff-line-modified-removed">-                 reply.println(&quot;Could not find issue `&quot; + issue.get().id() + &quot;` in the list of additional solved issues.&quot;);</span>
<span class="udiff-line-modified-added">+                 // Drop the validated project prefixes</span>
<span class="udiff-line-modified-added">+                 var strippedValidatedIssues = validatedIssues.stream()</span>
<span class="udiff-line-modified-added">+                                                              .map(issue -&gt; issue.id().contains(&quot;-&quot;) ? new Issue(issue.id().split(&quot;-&quot;, 2)[1], issue.description()) : issue)</span>
<span class="udiff-line-modified-added">+                                                              .collect(Collectors.toList());</span>
<span class="udiff-line-modified-added">+                 var titleIssue = Issue.fromString(pr.title());</span>
<span class="udiff-line-added">+                 for (var issue : strippedValidatedIssues) {</span>
<span class="udiff-line-added">+                     if (titleIssue.isEmpty()) {</span>
<span class="udiff-line-added">+                         reply.print(&quot;The primary solved issue for a PR is set through the PR title. Since the current title does &quot;);</span>
<span class="udiff-line-added">+                         reply.println(&quot;not contain an issue reference, it will now be updated.&quot;);</span>
<span class="udiff-line-added">+                         pr.setTitle(issue.toString());</span>
<span class="udiff-line-added">+                         titleIssue = Optional.of(issue);</span>
<span class="udiff-line-added">+                         continue;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     if (titleIssue.get().id().equals(issue.id())) {</span>
<span class="udiff-line-added">+                         reply.println(&quot;This issue is referenced in the PR title - it will now be updated.&quot;);</span>
<span class="udiff-line-added">+                         pr.setTitle(issue.toString());</span>
<span class="udiff-line-added">+                         continue;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     reply.println(SolvesTracker.setSolvesMarker(issue));</span>
<span class="udiff-line-added">+                     if (currentSolved.contains(issue.id())) {</span>
<span class="udiff-line-added">+                         reply.println(&quot;Updating description of additional solved issue: `&quot; + issue.toString() + &quot;`.&quot;);</span>
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         reply.println(&quot;Adding additional issue to solves list: `&quot; + issue.toString() + &quot;`.&quot;);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
              }
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
  
<span class="udiff-line-modified-removed">-         var titleIssue = Issue.fromString(pr.title());</span>
<span class="udiff-line-modified-removed">-         if (titleIssue.isEmpty()) {</span>
<span class="udiff-line-removed">-             reply.print(&quot;The primary solved issue for a PR is set through the PR title. Since the current title does &quot;);</span>
<span class="udiff-line-removed">-             reply.println(&quot;not contain an issue reference, it will now be updated.&quot;);</span>
<span class="udiff-line-removed">-             pr.setTitle(issue.get().toString());</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (titleIssue.get().id().equals(issue.get().id())) {</span>
<span class="udiff-line-removed">-             reply.println(&quot;This issue is referenced in the PR title - it will now be updated.&quot;);</span>
<span class="udiff-line-removed">-             pr.setTitle(issue.get().toString());</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         reply.println(SolvesTracker.setSolvesMarker(issue.get()));</span>
<span class="udiff-line-removed">-         if (currentSolved.contains(issue.get().id())) {</span>
<span class="udiff-line-removed">-             reply.println(&quot;Updating description of additional solved issue: `&quot; + issue.get().toString() + &quot;`.&quot;);</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             reply.println(&quot;Adding additional issue to solves list: `&quot; + issue.get().toString() + &quot;`.&quot;);</span>
<span class="udiff-line-modified-added">+         } catch (InvalidIssue invalidIssue) {</span>
<span class="udiff-line-modified-added">+             reply.println(&quot;The issue identifier `&quot; + invalidIssue.identifier() + &quot;` is invalid: &quot; + invalidIssue.reason() + &quot;.&quot;);</span>
          }
      }
  
      @Override
      public String description() {
</pre>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SolvesTracker.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>