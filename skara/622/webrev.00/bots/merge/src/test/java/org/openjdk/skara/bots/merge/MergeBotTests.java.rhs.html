<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.merge;
  24 
<a name="1" id="anc1"></a><span class="line-modified">  25 import org.junit.jupiter.api.*;</span>
<span class="line-added">  26 import org.openjdk.skara.host.HostUser;</span>
<span class="line-added">  27 import org.openjdk.skara.issuetracker.Issue;</span>
  28 import org.openjdk.skara.test.*;
  29 import org.openjdk.skara.vcs.*;
<a name="2" id="anc2"></a>



  30 
  31 import java.io.IOException;
<a name="3" id="anc3"></a><span class="line-modified">  32 import java.net.URLEncoder;</span>
<span class="line-modified">  33 import java.nio.charset.StandardCharsets;</span>
<span class="line-added">  34 import java.nio.file.*;</span>
<span class="line-added">  35 import java.time.*;</span>
  36 import java.util.*;
  37 import java.util.stream.Collectors;
<a name="4" id="anc4"></a>



  38 
  39 import static org.junit.jupiter.api.Assertions.*;
  40 
  41 class MergeBotTests {
  42     @Test
  43     void mergeMasterBranch(TestInfo testInfo) throws IOException {
  44         try (var temp = new TemporaryDirectory()) {
  45             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
  46 
  47             var fromDir = temp.path().resolve(&quot;from.git&quot;);
  48             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
  49             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
  50 
  51             var toDir = temp.path().resolve(&quot;to.git&quot;);
  52             var toLocalRepo = Repository.init(toDir, VCS.GIT);
  53             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  54             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  55                         StandardOpenOption.APPEND);
  56             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
  57 
  58             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
  59             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
  60             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  61             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  62                         StandardOpenOption.APPEND);
  63             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
  64 
  65             var now = ZonedDateTime.now();
  66             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
  67             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
  68             fromLocalRepo.add(fromFileA);
  69             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
  70             var fromCommits = fromLocalRepo.commits().asList();
  71             assertEquals(1, fromCommits.size());
  72             assertEquals(fromHashA, fromCommits.get(0).hash());
  73 
  74             var toFileA = toDir.resolve(&quot;a.txt&quot;);
  75             Files.writeString(toFileA, &quot;Hello A\n&quot;);
  76             toLocalRepo.add(toFileA);
  77             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
  78             var toCommits = toLocalRepo.commits().asList();
  79             assertEquals(1, toCommits.size());
  80             assertEquals(toHashA, toCommits.get(0).hash());
  81             assertEquals(fromHashA, toHashA);
  82 
  83             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
  84             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
  85             fromLocalRepo.add(fromFileB);
  86             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
  87 
  88             var toFileC = toDir.resolve(&quot;c.txt&quot;);
  89             Files.writeString(toFileC, &quot;Hello C\n&quot;);
  90             toLocalRepo.add(toFileC);
  91             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
  92 
  93             var storage = temp.path().resolve(&quot;storage&quot;);
  94             var master = new Branch(&quot;master&quot;);
  95             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
  96             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
  97             TestBotRunner.runPeriodicItems(bot);
  98 
  99             toCommits = toLocalRepo.commits().asList();
 100             assertEquals(4, toCommits.size());
 101             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 102             assertTrue(hashes.contains(toHashA));
 103             assertTrue(hashes.contains(fromHashB));
 104             assertTrue(hashes.contains(toHashC));
 105 
 106             var known = Set.of(toHashA, fromHashB, toHashC);
 107             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 108             assertTrue(merge.isMerge());
 109             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
 110             assertEquals(&quot;duke&quot;, merge.author().name());
 111             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 112 
 113             assertEquals(0, toHostedRepo.pullRequests().size());
 114         }
 115     }
 116 
 117     @Test
 118     void successfulDependency(TestInfo testInfo) throws IOException {
 119         try (var temp = new TemporaryDirectory(false)) {
 120             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 121 
 122             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 123             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 124             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 125 
 126             var toDir = temp.path().resolve(&quot;to.git&quot;);
 127             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 128             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 129             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 130                         StandardOpenOption.APPEND);
 131             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 132 
 133             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 134             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 135             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 136             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 137                         StandardOpenOption.APPEND);
 138             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 139 
 140             var now = ZonedDateTime.now();
 141             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 142             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 143             fromLocalRepo.add(fromFileA);
 144             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 145             var fromCommits = fromLocalRepo.commits().asList();
 146             assertEquals(1, fromCommits.size());
 147             assertEquals(fromHashA, fromCommits.get(0).hash());
 148 
 149             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 150             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 151             toLocalRepo.add(toFileA);
 152             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 153             var toCommits = toLocalRepo.commits().asList();
 154             assertEquals(1, toCommits.size());
 155             assertEquals(toHashA, toCommits.get(0).hash());
 156             assertEquals(fromHashA, toHashA);
 157             toLocalRepo.branch(toHashA, &quot;feature&quot;);
 158             assertEquals(2, toLocalRepo.branches().size());
 159 
 160             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 161             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 162             fromLocalRepo.add(fromFileB);
 163             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 164 
 165             var featureBranch = fromLocalRepo.branch(fromHashB, &quot;feature&quot;);
 166             fromLocalRepo.checkout(featureBranch);
 167             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 168             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 169             fromLocalRepo.add(fromFileD);
 170             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 171 
 172             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 173             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 174             toLocalRepo.add(toFileC);
 175             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 176 
 177             toLocalRepo.checkout(featureBranch);
 178             var toFileE = toDir.resolve(&quot;e.txt&quot;);
 179             Files.writeString(toFileE, &quot;Hello E\n&quot;);
 180             toLocalRepo.add(toFileE);
 181             var toHashE = toLocalRepo.commit(&quot;Adding e.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 182 
 183             var storage = temp.path().resolve(&quot;storage&quot;);
 184             var master = new Branch(&quot;master&quot;);
 185             var feature = new Branch(&quot;feature&quot;);
 186             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, null, &quot;master&quot;, List.of(), List.of()),
 187                                 new MergeBot.Spec(fromHostedRepo, feature, feature, null, &quot;feature&quot;, List.of(&quot;master&quot;), List.of()));
 188             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 189             TestBotRunner.runPeriodicItems(bot);
 190 
 191             toCommits = toLocalRepo.commits().asList();
 192             assertEquals(7, toCommits.size());
 193             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 194             assertTrue(hashes.contains(toHashA));
 195             assertTrue(hashes.contains(fromHashB));
 196             assertTrue(hashes.contains(toHashC));
 197 
 198             var merges = toCommits.stream().filter(c -&gt; c.isMerge()).collect(Collectors.toList());
 199             assertEquals(2, merges.size());
 200 
 201             assertTrue(merges.stream().anyMatch(c -&gt; c.message().get(0).equals(&quot;Automatic merge of test:master into master&quot;)));
 202             assertTrue(merges.stream().anyMatch(c -&gt; c.message().get(0).equals(&quot;Automatic merge of test:feature into feature&quot;)));
 203         }
 204     }
 205 
 206     @Test
 207     void failedDependency(TestInfo testInfo) throws IOException {
 208         try (var temp = new TemporaryDirectory(false)) {
 209             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 210 
 211             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 212             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 213             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 214 
 215             var toDir = temp.path().resolve(&quot;to.git&quot;);
 216             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 217             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 218             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 219                         StandardOpenOption.APPEND);
 220             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 221 
 222             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 223             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 224             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 225             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 226                         StandardOpenOption.APPEND);
 227             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 228 
 229             var now = ZonedDateTime.now();
 230             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 231             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 232             fromLocalRepo.add(fromFileA);
 233             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 234             var fromCommits = fromLocalRepo.commits().asList();
 235             assertEquals(1, fromCommits.size());
 236             assertEquals(fromHashA, fromCommits.get(0).hash());
 237 
 238             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 239             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 240             toLocalRepo.add(toFileA);
 241             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 242             var toCommits = toLocalRepo.commits().asList();
 243             assertEquals(1, toCommits.size());
 244             assertEquals(toHashA, toCommits.get(0).hash());
 245             assertEquals(fromHashA, toHashA);
 246             toLocalRepo.branch(toHashA, &quot;feature&quot;);
 247             assertEquals(2, toLocalRepo.branches().size());
 248 
 249             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 250             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 251             fromLocalRepo.add(fromFileB);
 252             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 253 
 254             var featureBranch = fromLocalRepo.branch(fromHashB, &quot;feature&quot;);
 255             fromLocalRepo.checkout(featureBranch);
 256             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 257             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 258             fromLocalRepo.add(fromFileD);
 259             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 260 
 261             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 262             Files.writeString(toFileB, &quot;Hello conflict\n&quot;);
 263             toLocalRepo.add(toFileB);
 264             var toHashB = toLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 265 
 266             toLocalRepo.checkout(featureBranch);
 267             var toFileE = toDir.resolve(&quot;e.txt&quot;);
 268             Files.writeString(toFileE, &quot;Hello E\n&quot;);
 269             toLocalRepo.add(toFileE);
 270             var toHashE = toLocalRepo.commit(&quot;Adding e.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 271 
 272             var toCommitsBeforeMerge = toLocalRepo.commits().asList();
 273             assertEquals(3, toCommitsBeforeMerge.size());
 274             assertEquals(toHashE, toCommitsBeforeMerge.get(0).hash());
 275             assertEquals(toHashB, toCommitsBeforeMerge.get(1).hash());
 276             assertEquals(toHashA, toCommitsBeforeMerge.get(2).hash());
 277             assertEquals(toHashB, toLocalRepo.resolve(&quot;master&quot;).get());
 278             assertEquals(toHashE, toLocalRepo.resolve(&quot;feature&quot;).get());
 279 
 280             var storage = temp.path().resolve(&quot;storage&quot;);
 281             var master = new Branch(&quot;master&quot;);
 282             var feature = new Branch(&quot;feature&quot;);
 283             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, null, &quot;master&quot;, List.of(), List.of()),
 284                                 new MergeBot.Spec(fromHostedRepo, feature, feature, null, &quot;feature&quot;, List.of(&quot;master&quot;), List.of()));
 285             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 286             TestBotRunner.runPeriodicItems(bot);
 287 
 288             toCommits = toLocalRepo.commits().asList();
 289             assertEquals(toCommitsBeforeMerge.size(), toCommits.size());
 290             assertEquals(toCommitsBeforeMerge.get(0).hash(), toCommits.get(0).hash());
 291             assertEquals(toCommitsBeforeMerge.get(1).hash(), toCommits.get(1).hash());
 292             assertEquals(toCommitsBeforeMerge.get(2).hash(), toCommits.get(2).hash());
 293             assertEquals(toHashB, toLocalRepo.resolve(&quot;master&quot;).get());
 294             assertEquals(toHashE, toLocalRepo.resolve(&quot;feature&quot;).get());
 295         }
 296     }
 297 
 298     @Test
 299     void failingMergeTest(TestInfo testInfo) throws IOException {
 300         try (var temp = new TemporaryDirectory()) {
 301             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 302 
 303             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 304             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 305             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 306 
 307             var toDir = temp.path().resolve(&quot;to.git&quot;);
 308             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 309             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 310             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 311                         StandardOpenOption.APPEND);
 312             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 313 
 314             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 315             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 316             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 317             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 318                         StandardOpenOption.APPEND);
 319             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 320 
 321             var now = ZonedDateTime.now();
 322             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 323             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 324             fromLocalRepo.add(fromFileA);
 325             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 326             var fromCommits = fromLocalRepo.commits().asList();
 327             assertEquals(1, fromCommits.size());
 328             assertEquals(fromHashA, fromCommits.get(0).hash());
 329 
 330             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 331             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 332             toLocalRepo.add(toFileA);
 333             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 334             var toCommits = toLocalRepo.commits().asList();
 335             assertEquals(1, toCommits.size());
 336             assertEquals(toHashA, toCommits.get(0).hash());
 337             assertEquals(fromHashA, toHashA);
 338 
 339             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 340             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 341             fromLocalRepo.add(fromFileB);
 342             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 343 
 344             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 345             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 346             toLocalRepo.add(toFileB);
 347             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 348 
 349             var storage = temp.path().resolve(&quot;storage&quot;);
 350             var master = new Branch(&quot;master&quot;);
 351             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 352             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 353             TestBotRunner.runPeriodicItems(bot);
 354 
 355             toCommits = toLocalRepo.commits().asList();
 356             assertEquals(2, toCommits.size());
 357             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 358             assertTrue(toHashes.contains(toHashA));
 359             assertTrue(toHashes.contains(toHashB));
 360 
 361             var pullRequests = toHostedRepo.pullRequests();
 362             assertEquals(1, pullRequests.size());
 363             var pr = pullRequests.get(0);
 364             assertEquals(&quot;Merge test:master&quot;, pr.title());
 365             assertTrue(pr.labels().contains(&quot;failed-auto-merge&quot;));
 366         }
 367     }
 368 
 369     @Test
 370     void failingPrerequisite(TestInfo testInfo) throws IOException {
 371         try (var temp = new TemporaryDirectory()) {
 372             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 373 
 374             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 375             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 376             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 377 
 378             var toDir = temp.path().resolve(&quot;to.git&quot;);
 379             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 380             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 381             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 382                         StandardOpenOption.APPEND);
 383             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 384 
 385             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 386             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 387             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 388             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 389                         StandardOpenOption.APPEND);
 390             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 391 
 392             var now = ZonedDateTime.now();
 393             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 394             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 395             fromLocalRepo.add(fromFileA);
 396             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 397             var fromCommits = fromLocalRepo.commits().asList();
 398             assertEquals(1, fromCommits.size());
 399             assertEquals(fromHashA, fromCommits.get(0).hash());
 400 
 401             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 402             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 403             toLocalRepo.add(toFileA);
 404             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 405             var toCommits = toLocalRepo.commits().asList();
 406             assertEquals(1, toCommits.size());
 407             assertEquals(toHashA, toCommits.get(0).hash());
 408             assertEquals(fromHashA, toHashA);
 409 
 410             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 411             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 412             fromLocalRepo.add(fromFileB);
 413             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 414 
 415             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 416             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 417             toLocalRepo.add(toFileB);
 418             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 419 
 420             var storage = temp.path().resolve(&quot;storage&quot;);
 421             var master = new Branch(&quot;master&quot;);
 422             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 423             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 424             TestBotRunner.runPeriodicItems(bot);
 425 
 426             toCommits = toLocalRepo.commits().asList();
 427             assertEquals(2, toCommits.size());
 428             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 429             assertTrue(toHashes.contains(toHashA));
 430             assertTrue(toHashes.contains(toHashB));
 431 
 432             var pullRequests = toHostedRepo.pullRequests();
 433             assertEquals(1, pullRequests.size());
 434             var pr = pullRequests.get(0);
 435             assertEquals(&quot;Merge test:master&quot;, pr.title());
 436 
 437             var fromDir2 = temp.path().resolve(&quot;from2.git&quot;);
 438             var fromLocalRepo2 = Repository.init(fromDir2, VCS.GIT);
 439             var fromHostedRepo2 = new TestHostedRepository(host, &quot;test-2&quot;, fromLocalRepo2);
 440 
 441             var host2 = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 442             var toDir2 = temp.path().resolve(&quot;to2.git&quot;);
 443             var toLocalRepo2 = Repository.init(toDir2, VCS.GIT);
 444             var toGitConfig2 = toDir2.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 445             Files.write(toGitConfig2, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 446                         StandardOpenOption.APPEND);
 447             var toHostedRepo2 = new TestHostedRepository(host2, &quot;test-mirror-2&quot;, toLocalRepo2);
 448 
 449             var forkDir2 = temp.path().resolve(&quot;fork2.git&quot;);
 450             var forkLocalRepo2 = Repository.init(forkDir2, VCS.GIT);
 451             var forkGitConfig2 = forkDir2.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 452             Files.write(forkGitConfig2, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 453                         StandardOpenOption.APPEND);
 454             var toFork2 = new TestHostedRepository(host2, &quot;test-mirror-fork-2&quot;, forkLocalRepo2);
 455 
 456             var now2 = ZonedDateTime.now();
 457             var fromFileA2 = fromDir2.resolve(&quot;a2.txt&quot;);
 458             Files.writeString(fromFileA2, &quot;Hello A2\n&quot;);
 459             fromLocalRepo2.add(fromFileA2);
 460             var fromHashA2 = fromLocalRepo2.commit(&quot;Adding a2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now2);
 461 
 462             var toFileA2 = toDir2.resolve(&quot;a2.txt&quot;);
 463             Files.writeString(toFileA2, &quot;Hello A2\n&quot;);
 464             toLocalRepo2.add(toFileA2);
 465             var toHashA2 = toLocalRepo2.commit(&quot;Adding a2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now2);
 466             var toCommits2 = toLocalRepo2.commits().asList();
 467             assertEquals(1, toCommits2.size());
 468             assertEquals(toHashA2, toCommits2.get(0).hash());
 469             assertEquals(fromHashA2, toHashA2);
 470 
 471             var fromFileB2 = fromDir2.resolve(&quot;b2.txt&quot;);
 472             Files.writeString(fromFileB2, &quot;Hello B2\n&quot;);
 473             fromLocalRepo2.add(fromFileB2);
 474             var fromHashB2 = fromLocalRepo2.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 475             var fromCommits2 = fromLocalRepo2.commits().asList();
 476             assertEquals(2, fromCommits2.size());
 477             assertEquals(fromHashB2, fromCommits2.get(0).hash());
 478             assertEquals(fromHashA2, fromCommits2.get(1).hash());
 479 
 480             var storage2 = temp.path().resolve(&quot;storage-2&quot;);
 481             var master2 = new Branch(&quot;master&quot;);
 482             var specs2 = List.of(new MergeBot.Spec(fromHostedRepo2, master2, master2, null, &quot;master&quot;, List.of(), List.of(toHostedRepo)));
 483             var bot2 = new MergeBot(storage2, toHostedRepo2, toFork2, specs2);
 484             TestBotRunner.runPeriodicItems(bot2);
 485 
 486             var toCommitsAfterMerge2 = toLocalRepo2.commits().asList();
 487             assertEquals(1, toCommitsAfterMerge2.size());
 488             assertEquals(toHashA2, toCommitsAfterMerge2.get(0).hash());
 489             assertEquals(toHashA2, toLocalRepo2.resolve(&quot;master&quot;).get());
 490 
 491             pr.setState(Issue.State.CLOSED);
 492             TestBotRunner.runPeriodicItems(bot2);
 493             toCommitsAfterMerge2 = toLocalRepo2.commits().asList();
 494             assertEquals(2, toCommitsAfterMerge2.size());
 495             assertEquals(fromHashB2, toCommitsAfterMerge2.get(0).hash());
 496             assertEquals(toHashA2, toCommitsAfterMerge2.get(1).hash());
 497             assertEquals(fromHashB2, toLocalRepo2.resolve(&quot;master&quot;).get());
 498         }
 499     }
 500 
 501     @Test
 502     void failingMergeShouldResultInOnlyOnePR(TestInfo testInfo) throws IOException {
 503         try (var temp = new TemporaryDirectory()) {
 504             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 505 
 506             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 507             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 508             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 509 
 510             var toDir = temp.path().resolve(&quot;to.git&quot;);
 511             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 512             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 513             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 514                         StandardOpenOption.APPEND);
 515             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 516 
 517             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 518             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 519             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 520             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 521                         StandardOpenOption.APPEND);
 522             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 523 
 524             var now = ZonedDateTime.now();
 525             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 526             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 527             fromLocalRepo.add(fromFileA);
 528             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 529             var fromCommits = fromLocalRepo.commits().asList();
 530             assertEquals(1, fromCommits.size());
 531             assertEquals(fromHashA, fromCommits.get(0).hash());
 532 
 533             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 534             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 535             toLocalRepo.add(toFileA);
 536             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 537             var toCommits = toLocalRepo.commits().asList();
 538             assertEquals(1, toCommits.size());
 539             assertEquals(toHashA, toCommits.get(0).hash());
 540             assertEquals(fromHashA, toHashA);
 541 
 542             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 543             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 544             fromLocalRepo.add(fromFileB);
 545             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 546 
 547             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 548             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 549             toLocalRepo.add(toFileB);
 550             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 551 
 552             var storage = temp.path().resolve(&quot;storage&quot;);
 553             var master = new Branch(&quot;master&quot;);
 554             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 555             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 556             TestBotRunner.runPeriodicItems(bot);
 557             TestBotRunner.runPeriodicItems(bot);
 558 
 559             toCommits = toLocalRepo.commits().asList();
 560             assertEquals(2, toCommits.size());
 561             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 562             assertTrue(toHashes.contains(toHashA));
 563             assertTrue(toHashes.contains(toHashB));
 564 
 565             var pullRequests = toHostedRepo.pullRequests();
 566             assertEquals(1, pullRequests.size());
 567             var pr = pullRequests.get(0);
 568             assertEquals(&quot;Merge test:master&quot;, pr.title());
 569         }
 570     }
 571 
 572     @Test
 573     void resolvedMergeConflictShouldResultInIntegrateCommand(TestInfo testInfo) throws IOException {
 574         try (var temp = new TemporaryDirectory()) {
 575             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 576 
 577             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 578             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 579             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 580 
 581             var toDir = temp.path().resolve(&quot;to.git&quot;);
 582             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 583             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 584             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 585                         StandardOpenOption.APPEND);
 586             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 587 
 588             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 589             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 590             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 591             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 592                         StandardOpenOption.APPEND);
 593             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 594 
 595             var now = ZonedDateTime.now();
 596             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 597             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 598             fromLocalRepo.add(fromFileA);
 599             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 600             var fromCommits = fromLocalRepo.commits().asList();
 601             assertEquals(1, fromCommits.size());
 602             assertEquals(fromHashA, fromCommits.get(0).hash());
 603 
 604             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 605             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 606             toLocalRepo.add(toFileA);
 607             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 608             var toCommits = toLocalRepo.commits().asList();
 609             assertEquals(1, toCommits.size());
 610             assertEquals(toHashA, toCommits.get(0).hash());
 611             assertEquals(fromHashA, toHashA);
 612 
 613             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 614             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 615             fromLocalRepo.add(fromFileB);
 616             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 617 
 618             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 619             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 620             toLocalRepo.add(toFileB);
 621             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 622 
 623             var storage = temp.path().resolve(&quot;storage&quot;);
 624             var master = new Branch(&quot;master&quot;);
 625             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 626             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 627             TestBotRunner.runPeriodicItems(bot);
 628             TestBotRunner.runPeriodicItems(bot);
 629 
 630             toCommits = toLocalRepo.commits().asList();
 631             assertEquals(2, toCommits.size());
 632             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 633             assertTrue(toHashes.contains(toHashA));
 634             assertTrue(toHashes.contains(toHashB));
 635 
 636             var pullRequests = toHostedRepo.pullRequests();
 637             assertEquals(1, pullRequests.size());
 638             var pr = pullRequests.get(0);
 639             assertEquals(&quot;Merge test:master&quot;, pr.title());
 640             assertTrue(pr.labels().contains(&quot;failed-auto-merge&quot;));
 641             assertTrue(forkLocalRepo.branches().contains(new Branch(&quot;master&quot;)));
 642             assertTrue(forkLocalRepo.branches().contains(new Branch(&quot;2&quot;)));
 643 
 644             // Bot should do nothing as long as PR is presnt
 645             TestBotRunner.runPeriodicItems(bot);
 646             pullRequests = toHostedRepo.pullRequests();
 647             assertEquals(1, pullRequests.size());
 648             pr = pullRequests.get(0);
 649 
 650             // Simulate that the merge-conflict has been resolved by adding the &quot;ready&quot; label
 651             pr.addLabel(&quot;ready&quot;);
 652             TestBotRunner.runPeriodicItems(bot);
 653             pullRequests = toHostedRepo.pullRequests();
 654             assertEquals(1, pullRequests.size());
 655 
 656             pr = pullRequests.get(0);
 657             var numComments = pr.comments().size();
 658             var lastComment = pr.comments().get(pr.comments().size() - 1);
 659             assertEquals(&quot;/integrate\n&lt;!-- Valid self-command --&gt;&quot;, lastComment.body());
 660 
 661             // Running the bot again should not result in another comment
 662             TestBotRunner.runPeriodicItems(bot);
 663             assertEquals(numComments, toHostedRepo.pullRequests().size());
 664         }
 665     }
 666 
 667     final static class TestClock implements Clock {
 668         ZonedDateTime now;
 669 
 670         TestClock() {
 671             this(null);
 672         }
 673 
 674         TestClock(ZonedDateTime now) {
 675             this.now = now;
 676         }
 677 
 678         @Override
 679         public ZonedDateTime now() {
 680             return now;
 681         }
 682     }
 683 
 684     @Test
 685     void testMergeHourly(TestInfo testInfo) throws IOException {
 686         try (var temp = new TemporaryDirectory()) {
 687             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 688 
 689             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 690             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 691             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 692 
 693             var toDir = temp.path().resolve(&quot;to.git&quot;);
 694             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 695             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 696             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 697                         StandardOpenOption.APPEND);
 698             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 699 
 700             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 701             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 702             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 703             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 704                         StandardOpenOption.APPEND);
 705             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 706 
 707             var now = ZonedDateTime.now();
 708             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 709             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 710             fromLocalRepo.add(fromFileA);
 711             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 712             var fromCommits = fromLocalRepo.commits().asList();
 713             assertEquals(1, fromCommits.size());
 714             assertEquals(fromHashA, fromCommits.get(0).hash());
 715 
 716             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 717             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 718             toLocalRepo.add(toFileA);
 719             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 720             var toCommits = toLocalRepo.commits().asList();
 721             assertEquals(1, toCommits.size());
 722             assertEquals(toHashA, toCommits.get(0).hash());
 723             assertEquals(fromHashA, toHashA);
 724 
 725             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 726             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 727             fromLocalRepo.add(fromFileB);
 728             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 729 
 730             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 731             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 732             toLocalRepo.add(toFileC);
 733             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 734 
 735             var storage = temp.path().resolve(&quot;storage&quot;);
 736             var master = new Branch(&quot;master&quot;);
 737 
 738             // Merge only at most once during the first minute every hour
 739             var freq = MergeBot.Spec.Frequency.hourly(1);
 740             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 741 
 742             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 15, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 743             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 744 
 745             TestBotRunner.runPeriodicItems(bot);
 746 
 747             // Ensure nothing has been merged
 748             toCommits = toLocalRepo.commits().asList();
 749             assertEquals(2, toCommits.size());
 750             assertEquals(toHashC, toCommits.get(0).hash());
 751             assertEquals(toHashA, toCommits.get(1).hash());
 752 
 753             // Set the clock to the first minute of the hour
 754             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 755             TestBotRunner.runPeriodicItems(bot);
 756 
 757             // Should have merged
 758             toCommits = toLocalRepo.commits().asList();
 759             assertEquals(4, toCommits.size());
 760             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 761             assertTrue(hashes.contains(toHashA));
 762             assertTrue(hashes.contains(fromHashB));
 763             assertTrue(hashes.contains(toHashC));
 764 
 765             var known = Set.of(toHashA, fromHashB, toHashC);
 766             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 767             assertTrue(merge.isMerge());
 768             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
 769             assertEquals(&quot;duke&quot;, merge.author().name());
 770             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 771 
 772             assertEquals(0, toHostedRepo.pullRequests().size());
 773 
 774             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 775             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 776             fromLocalRepo.add(fromFileD);
 777             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 778 
 779             // Since the time hasn&#39;t changed it should not merge again
 780             TestBotRunner.runPeriodicItems(bot);
 781             toCommits = toLocalRepo.commits().asList();
 782             assertEquals(4, toCommits.size());
 783 
 784             // Move the minutes forward, the bot should not merge
 785             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 786             TestBotRunner.runPeriodicItems(bot);
 787             toCommits = toLocalRepo.commits().asList();
 788             assertEquals(4, toCommits.size());
 789 
 790             // Move the clock forward one hour, the bot should merge
 791             clock.now = ZonedDateTime.of(2020, 1, 23, 16, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 792             TestBotRunner.runPeriodicItems(bot);
 793 
 794             toCommits = toLocalRepo.commits().asList();
 795             assertEquals(6, toCommits.size());
 796         }
 797     }
 798 
 799     @Test
 800     void testMergeDaily(TestInfo testInfo) throws IOException {
 801         try (var temp = new TemporaryDirectory()) {
 802             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 803 
 804             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 805             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 806             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 807 
 808             var toDir = temp.path().resolve(&quot;to.git&quot;);
 809             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 810             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 811             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 812                         StandardOpenOption.APPEND);
 813             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
 814 
 815             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 816             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 817             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 818             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 819                         StandardOpenOption.APPEND);
 820             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 821 
 822             var now = ZonedDateTime.now();
 823             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 824             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 825             fromLocalRepo.add(fromFileA);
 826             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 827             var fromCommits = fromLocalRepo.commits().asList();
 828             assertEquals(1, fromCommits.size());
 829             assertEquals(fromHashA, fromCommits.get(0).hash());
 830 
 831             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 832             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 833             toLocalRepo.add(toFileA);
 834             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 835             var toCommits = toLocalRepo.commits().asList();
 836             assertEquals(1, toCommits.size());
 837             assertEquals(toHashA, toCommits.get(0).hash());
 838             assertEquals(fromHashA, toHashA);
 839 
 840             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 841             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 842             fromLocalRepo.add(fromFileB);
 843             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 844 
 845             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 846             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 847             toLocalRepo.add(toFileC);
 848             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 849 
 850             var storage = temp.path().resolve(&quot;storage&quot;);
 851             var master = new Branch(&quot;master&quot;);
 852 
 853             // Merge only at most once during the third hour every day
 854             var freq = MergeBot.Spec.Frequency.daily(3);
 855             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 856 
 857             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 2, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 858             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 859 
 860             TestBotRunner.runPeriodicItems(bot);
 861 
 862             // Ensure nothing has been merged
 863             toCommits = toLocalRepo.commits().asList();
 864             assertEquals(2, toCommits.size());
 865             assertEquals(toHashC, toCommits.get(0).hash());
 866             assertEquals(toHashA, toCommits.get(1).hash());
 867 
 868             // Set the clock to the third hour of the day (minutes should not matter)
 869             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 870             TestBotRunner.runPeriodicItems(bot);
 871 
 872             // Should have merged
 873             toCommits = toLocalRepo.commits().asList();
 874             assertEquals(4, toCommits.size());
 875             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 876             assertTrue(hashes.contains(toHashA));
 877             assertTrue(hashes.contains(fromHashB));
 878             assertTrue(hashes.contains(toHashC));
 879 
 880             var known = Set.of(toHashA, fromHashB, toHashC);
 881             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 882             assertTrue(merge.isMerge());
 883             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
 884             assertEquals(&quot;duke&quot;, merge.author().name());
 885             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 886 
 887             assertEquals(0, toHostedRepo.pullRequests().size());
 888 
 889             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 890             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 891             fromLocalRepo.add(fromFileD);
 892             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 893 
 894             // Since the time hasn&#39;t changed it should not merge
 895             TestBotRunner.runPeriodicItems(bot);
 896             toCommits = toLocalRepo.commits().asList();
 897             assertEquals(4, toCommits.size());
 898 
 899             // Move the minutes forward, the bot should not merge
 900             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 901             TestBotRunner.runPeriodicItems(bot);
 902             toCommits = toLocalRepo.commits().asList();
 903             assertEquals(4, toCommits.size());
 904 
 905             // Move the hours forward, the bot should not merge
 906             clock.now = ZonedDateTime.of(2020, 1, 23, 17, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 907             TestBotRunner.runPeriodicItems(bot);
 908             toCommits = toLocalRepo.commits().asList();
 909             assertEquals(4, toCommits.size());
 910 
 911             // Move the clock forward one day, the bot should merge
 912             clock.now = ZonedDateTime.of(2020, 1, 24, 3, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 913             TestBotRunner.runPeriodicItems(bot);
 914 
 915             toCommits = toLocalRepo.commits().asList();
 916             assertEquals(6, toCommits.size());
 917         }
 918     }
 919 
 920     @Test
 921     void testMergeWeekly(TestInfo testInfo) throws IOException {
 922         try (var temp = new TemporaryDirectory()) {
 923             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 924 
 925             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 926             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 927             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 928 
 929             var toDir = temp.path().resolve(&quot;to.git&quot;);
 930             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 931             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 932             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 933                         StandardOpenOption.APPEND);
 934             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 935 
 936             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 937             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 938             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 939             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 940                         StandardOpenOption.APPEND);
 941             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 942 
 943             var now = ZonedDateTime.now();
 944             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 945             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 946             fromLocalRepo.add(fromFileA);
 947             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 948             var fromCommits = fromLocalRepo.commits().asList();
 949             assertEquals(1, fromCommits.size());
 950             assertEquals(fromHashA, fromCommits.get(0).hash());
 951 
 952             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 953             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 954             toLocalRepo.add(toFileA);
 955             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 956             var toCommits = toLocalRepo.commits().asList();
 957             assertEquals(1, toCommits.size());
 958             assertEquals(toHashA, toCommits.get(0).hash());
 959             assertEquals(fromHashA, toHashA);
 960 
 961             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 962             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 963             fromLocalRepo.add(fromFileB);
 964             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 965 
 966             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 967             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 968             toLocalRepo.add(toFileC);
 969             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 970 
 971             var storage = temp.path().resolve(&quot;storage&quot;);
 972             var master = new Branch(&quot;master&quot;);
 973 
 974             // Merge only at most once per week on Friday&#39;s at 12:00
 975             var freq = MergeBot.Spec.Frequency.weekly(DayOfWeek.FRIDAY, 12);
 976             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 977 
 978             var clock = new TestClock(ZonedDateTime.of(2020, 1, 24, 11, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 979             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 980 
 981             TestBotRunner.runPeriodicItems(bot);
 982 
 983             // Ensure nothing has been merged
 984             toCommits = toLocalRepo.commits().asList();
 985             assertEquals(2, toCommits.size());
 986             assertEquals(toHashC, toCommits.get(0).hash());
 987             assertEquals(toHashA, toCommits.get(1).hash());
 988 
 989             // Set the clock to the 12th hour of the day (minutes should not matter)
 990             clock.now = ZonedDateTime.of(2020, 1, 24, 12, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 991             TestBotRunner.runPeriodicItems(bot);
 992 
 993             // Should have merged
 994             toCommits = toLocalRepo.commits().asList();
 995             assertEquals(4, toCommits.size());
 996             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 997             assertTrue(hashes.contains(toHashA));
 998             assertTrue(hashes.contains(fromHashB));
 999             assertTrue(hashes.contains(toHashC));
1000 
1001             var known = Set.of(toHashA, fromHashB, toHashC);
1002             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
1003             assertTrue(merge.isMerge());
1004             assertEquals(List.of(&quot;Automatic merge of test:master into master&quot;), merge.message());
1005             assertEquals(&quot;duke&quot;, merge.author().name());
1006             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
1007 
1008             assertEquals(0, toHostedRepo.pullRequests().size());
1009 
1010             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
1011             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
1012             fromLocalRepo.add(fromFileD);
1013             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1014 
1015             // Since the time hasn&#39;t changed it should not merge
1016             TestBotRunner.runPeriodicItems(bot);
1017             toCommits = toLocalRepo.commits().asList();
1018             assertEquals(4, toCommits.size());
1019 
1020             // Move the hours forward, the bot should not merge
1021             clock.now = ZonedDateTime.of(2020, 1, 24, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1022             TestBotRunner.runPeriodicItems(bot);
1023             toCommits = toLocalRepo.commits().asList();
1024             assertEquals(4, toCommits.size());
1025 
1026             // Move the days forward, the bot should not merge
1027             clock.now = ZonedDateTime.of(2020, 1, 25, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1028             TestBotRunner.runPeriodicItems(bot);
1029             toCommits = toLocalRepo.commits().asList();
1030             assertEquals(4, toCommits.size());
1031 
1032             // Move the clock forward one week, the bot should merge
1033             clock.now = ZonedDateTime.of(2020, 1, 31, 12, 29, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1034             TestBotRunner.runPeriodicItems(bot);
1035 
1036             toCommits = toLocalRepo.commits().asList();
1037             assertEquals(6, toCommits.size());
1038         }
1039     }
1040 
1041     @Test
1042     void testMergeMonthly(TestInfo testInfo) throws IOException {
1043         try (var temp = new TemporaryDirectory()) {
1044             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
1045 
1046             var fromDir = temp.path().resolve(&quot;from.git&quot;);
1047             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
1048             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
1049 
1050             var toDir = temp.path().resolve(&quot;to.git&quot;);
1051             var toLocalRepo = Repository.init(toDir, VCS.GIT);
1052             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
1053             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
1054                         StandardOpenOption.APPEND);
1055             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
1056 
1057             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
1058             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
1059             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
1060             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
1061                         StandardOpenOption.APPEND);
1062             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
1063 
1064             var now = ZonedDateTime.now();
1065             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
1066             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
1067             fromLocalRepo.add(fromFileA);
1068             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
1069             var fromCommits = fromLocalRepo.commits().asList();
1070             assertEquals(1, fromCommits.size());
1071             assertEquals(fromHashA, fromCommits.get(0).hash());
1072 
1073             var toFileA = toDir.resolve(&quot;a.txt&quot;);
1074             Files.writeString(toFileA, &quot;Hello A\n&quot;);
1075             toLocalRepo.add(toFileA);
1076             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
1077             var toCommits = toLocalRepo.commits().asList();
1078             assertEquals(1, toCommits.size());
1079             assertEquals(toHashA, toCommits.get(0).hash());
1080             assertEquals(fromHashA, toHashA);
1081 
1082             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
1083             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
1084             fromLocalRepo.add(fromFileB);
1085             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1086 
1087             var toFileC = toDir.resolve(&quot;c.txt&quot;);
1088             Files.writeString(toFileC, &quot;Hello C\n&quot;);
1089             toLocalRepo.add(toFileC);
1090             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1091 
1092             var storage = temp.path().resolve(&quot;storage&quot;);
1093             var master = new Branch(&quot;master&quot;);
1094 
1095             // Merge only at most once per month on the 17th day at at 11:00
1096             var freq = MergeBot.Spec.Frequency.monthly(17, 11);
1097             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
1098 
1099             var clock = new TestClock(ZonedDateTime.of(2020, 1, 16, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
1100             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
1101 
1102             TestBotRunner.runPeriodicItems(bot);
1103 
1104             // Ensure nothing has been merged
1105             toCommits = toLocalRepo.commits().asList();
1106             assertEquals(2, toCommits.size());
1107             assertEquals(toHashC, toCommits.get(0).hash());
1108             assertEquals(toHashA, toCommits.get(1).hash());
1109 
1110             // Set the clock to the 17th day and at hour 11 (minutes should not matter)
1111             clock.now = ZonedDateTime.of(2020, 1, 17, 11, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1112             TestBotRunner.runPeriodicItems(bot);
1113 
1114             // Should have merged
1115             toCommits = toLocalRepo.commits().asList();
1116             assertEquals(4, toCommits.size());
1117             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
1118             assertTrue(hashes.contains(toHashA));
1119             assertTrue(hashes.contains(fromHashB));
1120             assertTrue(hashes.contains(toHashC));
1121 
1122             var known = Set.of(toHashA, fromHashB, toHashC);
1123             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
1124             assertTrue(merge.isMerge());
1125             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
1126             assertEquals(&quot;duke&quot;, merge.author().name());
1127             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
1128 
1129             assertEquals(0, toHostedRepo.pullRequests().size());
1130 
1131             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
1132             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
1133             fromLocalRepo.add(fromFileD);
1134             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1135 
1136             // Since the time hasn&#39;t changed it should not merge
1137             TestBotRunner.runPeriodicItems(bot);
1138             toCommits = toLocalRepo.commits().asList();
1139             assertEquals(4, toCommits.size());
1140 
1141             // Move the hours forward, the bot should not merge
1142             clock.now = ZonedDateTime.of(2020, 1, 17, 12, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1143             TestBotRunner.runPeriodicItems(bot);
1144             toCommits = toLocalRepo.commits().asList();
1145             assertEquals(4, toCommits.size());
1146 
1147             // Move the days forward, the bot should not merge
1148             clock.now = ZonedDateTime.of(2020, 1, 18, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1149             TestBotRunner.runPeriodicItems(bot);
1150             toCommits = toLocalRepo.commits().asList();
1151             assertEquals(4, toCommits.size());
1152 
1153             // Move the clock forward one month, the bot should merge
1154             clock.now = ZonedDateTime.of(2020, 2, 17, 11, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1155             TestBotRunner.runPeriodicItems(bot);
1156 
1157             toCommits = toLocalRepo.commits().asList();
1158             assertEquals(6, toCommits.size());
1159         }
1160     }
1161 
1162     @Test
1163     void testMergeYearly(TestInfo testInfo) throws IOException {
1164         try (var temp = new TemporaryDirectory()) {
1165             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
1166 
1167             var fromDir = temp.path().resolve(&quot;from.git&quot;);
1168             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
1169             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
1170 
1171             var toDir = temp.path().resolve(&quot;to.git&quot;);
1172             var toLocalRepo = Repository.init(toDir, VCS.GIT);
1173             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
1174             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
1175                         StandardOpenOption.APPEND);
1176             var toHostedRepo = new TestHostedRepository(host, &quot;test&quot;, toLocalRepo);
1177 
1178             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
1179             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
1180             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
1181             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
1182                         StandardOpenOption.APPEND);
1183             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
1184 
1185             var now = ZonedDateTime.now();
1186             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
1187             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
1188             fromLocalRepo.add(fromFileA);
1189             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
1190             var fromCommits = fromLocalRepo.commits().asList();
1191             assertEquals(1, fromCommits.size());
1192             assertEquals(fromHashA, fromCommits.get(0).hash());
1193 
1194             var toFileA = toDir.resolve(&quot;a.txt&quot;);
1195             Files.writeString(toFileA, &quot;Hello A\n&quot;);
1196             toLocalRepo.add(toFileA);
1197             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
1198             var toCommits = toLocalRepo.commits().asList();
1199             assertEquals(1, toCommits.size());
1200             assertEquals(toHashA, toCommits.get(0).hash());
1201             assertEquals(fromHashA, toHashA);
1202 
1203             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
1204             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
1205             fromLocalRepo.add(fromFileB);
1206             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1207 
1208             var toFileC = toDir.resolve(&quot;c.txt&quot;);
1209             Files.writeString(toFileC, &quot;Hello C\n&quot;);
1210             toLocalRepo.add(toFileC);
1211             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1212 
1213             var storage = temp.path().resolve(&quot;storage&quot;);
1214             var master = new Branch(&quot;master&quot;);
1215 
1216             // Merge only at most once per year on the 29th day of May at at 07:00
1217             var freq = MergeBot.Spec.Frequency.yearly(Month.MAY, 29, 07);
1218             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
1219 
1220             var clock = new TestClock(ZonedDateTime.of(2020, 5, 27, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
1221             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
1222 
1223             TestBotRunner.runPeriodicItems(bot);
1224 
1225             // Ensure nothing has been merged
1226             toCommits = toLocalRepo.commits().asList();
1227             assertEquals(2, toCommits.size());
1228             assertEquals(toHashC, toCommits.get(0).hash());
1229             assertEquals(toHashA, toCommits.get(1).hash());
1230 
1231             // Set the clock to the 29th of May and at hour 11 (minutes should not matter)
1232             clock.now = ZonedDateTime.of(2020, 5, 29, 7, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1233             TestBotRunner.runPeriodicItems(bot);
1234 
1235             // Should have merged
1236             toCommits = toLocalRepo.commits().asList();
1237             assertEquals(4, toCommits.size());
1238             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
1239             assertTrue(hashes.contains(toHashA));
1240             assertTrue(hashes.contains(fromHashB));
1241             assertTrue(hashes.contains(toHashC));
1242 
1243             var known = Set.of(toHashA, fromHashB, toHashC);
1244             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
1245             assertTrue(merge.isMerge());
1246             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
1247             assertEquals(&quot;duke&quot;, merge.author().name());
1248             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
1249 
1250             assertEquals(0, toHostedRepo.pullRequests().size());
1251 
1252             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
1253             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
1254             fromLocalRepo.add(fromFileD);
1255             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1256 
1257             // Since the time hasn&#39;t changed it should not merge again
1258             TestBotRunner.runPeriodicItems(bot);
1259             toCommits = toLocalRepo.commits().asList();
1260             assertEquals(4, toCommits.size());
1261 
1262             // Move the hours forward, the bot should not merge
1263             clock.now = ZonedDateTime.of(2020, 5, 29, 8, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1264             TestBotRunner.runPeriodicItems(bot);
1265             toCommits = toLocalRepo.commits().asList();
1266             assertEquals(4, toCommits.size());
1267 
1268             // Move the days forward, the bot should not merge
1269             clock.now = ZonedDateTime.of(2020, 5, 30, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1270             TestBotRunner.runPeriodicItems(bot);
1271             toCommits = toLocalRepo.commits().asList();
1272             assertEquals(4, toCommits.size());
1273 
1274             // Move the months forward, the bot should not merge
1275             clock.now = ZonedDateTime.of(2020, 7, 29, 7, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1276             TestBotRunner.runPeriodicItems(bot);
1277             toCommits = toLocalRepo.commits().asList();
1278             assertEquals(4, toCommits.size());
1279 
1280             // Move the clock forward one year, the bot should merge
1281             clock.now = ZonedDateTime.of(2021, 5, 29, 7, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1282             TestBotRunner.runPeriodicItems(bot);
1283 
1284             toCommits = toLocalRepo.commits().asList();
1285             assertEquals(6, toCommits.size());
1286         }
1287     }
<a name="5" id="anc5"></a><span class="line-added">1288 </span>
<span class="line-added">1289     @Test</span>
<span class="line-added">1290     void mergeAfterDivergedStorage(TestInfo testInfo) throws IOException {</span>
<span class="line-added">1291         try (var temp = new TemporaryDirectory()) {</span>
<span class="line-added">1292             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="line-added">1293 </span>
<span class="line-added">1294             var fromDir = temp.path().resolve(&quot;from.git&quot;);</span>
<span class="line-added">1295             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);</span>
<span class="line-added">1296             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);</span>
<span class="line-added">1297 </span>
<span class="line-added">1298             var toDir = temp.path().resolve(&quot;to.git&quot;);</span>
<span class="line-added">1299             var toLocalRepo = Repository.init(toDir, VCS.GIT);</span>
<span class="line-added">1300             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added">1301             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added">1302                     StandardOpenOption.APPEND);</span>
<span class="line-added">1303             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);</span>
<span class="line-added">1304 </span>
<span class="line-added">1305             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="line-added">1306             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="line-added">1307             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added">1308             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added">1309                     StandardOpenOption.APPEND);</span>
<span class="line-added">1310             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="line-added">1311 </span>
<span class="line-added">1312             var now = ZonedDateTime.now();</span>
<span class="line-added">1313             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added">1314             Files.writeString(fromFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added">1315             fromLocalRepo.add(fromFileA);</span>
<span class="line-added">1316             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added">1317             var fromCommits = fromLocalRepo.commits().asList();</span>
<span class="line-added">1318             assertEquals(1, fromCommits.size());</span>
<span class="line-added">1319             assertEquals(fromHashA, fromCommits.get(0).hash());</span>
<span class="line-added">1320 </span>
<span class="line-added">1321             var toFileA = toDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added">1322             Files.writeString(toFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added">1323             toLocalRepo.add(toFileA);</span>
<span class="line-added">1324             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added">1325             var toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added">1326             assertEquals(1, toCommits.size());</span>
<span class="line-added">1327             assertEquals(toHashA, toCommits.get(0).hash());</span>
<span class="line-added">1328             assertEquals(fromHashA, toHashA);</span>
<span class="line-added">1329 </span>
<span class="line-added">1330             var storage = temp.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">1331             var master = new Branch(&quot;master&quot;);</span>
<span class="line-added">1332             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));</span>
<span class="line-added">1333             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);</span>
<span class="line-added">1334             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added">1335 </span>
<span class="line-added">1336             // Add something new to the source</span>
<span class="line-added">1337             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);</span>
<span class="line-added">1338             Files.writeString(fromFileB, &quot;Hello B\n&quot;);</span>
<span class="line-added">1339             fromLocalRepo.add(fromFileB);</span>
<span class="line-added">1340             var fromHashB = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added">1341             fromLocalRepo.push(fromHashB, fromHostedRepo.url(), &quot;master&quot;);</span>
<span class="line-added">1342 </span>
<span class="line-added">1343             // Diverge the target with something non-conflicting</span>
<span class="line-added">1344             var toFileC = toDir.resolve(&quot;c.txt&quot;);</span>
<span class="line-added">1345             Files.writeString(toFileC, &quot;Hello C\n&quot;);</span>
<span class="line-added">1346             toLocalRepo.add(toFileC);</span>
<span class="line-added">1347             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added">1348             toLocalRepo.push(toHashC, toHostedRepo.url(), &quot;master&quot;);</span>
<span class="line-added">1349 </span>
<span class="line-added">1350             // But push something out of place to the local storage as well</span>
<span class="line-added">1351             var sanitizedForkUrl = URLEncoder.encode(toFork.webUrl().toString(), StandardCharsets.UTF_8);</span>
<span class="line-added">1352             var storageRepo = Repository.init(storage.resolve(sanitizedForkUrl), VCS.GIT);</span>
<span class="line-added">1353             var divergedForkFile = storageRepo.root().resolve(&quot;d.txt&quot;);</span>
<span class="line-added">1354             Files.writeString(divergedForkFile, &quot;Hello D\n&quot;);</span>
<span class="line-added">1355             storageRepo.add(divergedForkFile);</span>
<span class="line-added">1356             var divergedForkHash = storageRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added">1357 </span>
<span class="line-added">1358             // This will need manual intervention</span>
<span class="line-added">1359             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(bot));</span>
<span class="line-added">1360         }</span>
<span class="line-added">1361     }</span>
1362 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>