<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/merge/MergeBot.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.merge;
  24 
<span class="line-modified">  25 import org.openjdk.skara.host.*;</span>


  26 import org.openjdk.skara.test.*;
  27 import org.openjdk.skara.vcs.*;
<span class="line-removed">  28 import org.openjdk.skara.issuetracker.Issue;</span>
<span class="line-removed">  29 </span>
<span class="line-removed">  30 import org.junit.jupiter.api.Test;</span>
<span class="line-removed">  31 import org.junit.jupiter.api.TestInfo;</span>
  32 
  33 import java.io.IOException;
<span class="line-modified">  34 import java.nio.file.Files;</span>
<span class="line-modified">  35 import java.nio.file.StandardOpenOption;</span>


  36 import java.util.*;
  37 import java.util.stream.Collectors;
<span class="line-removed">  38 import java.time.DayOfWeek;</span>
<span class="line-removed">  39 import java.time.Month;</span>
<span class="line-removed">  40 import java.time.ZonedDateTime;</span>
<span class="line-removed">  41 import java.time.ZoneId;</span>
  42 
  43 import static org.junit.jupiter.api.Assertions.*;
  44 
  45 class MergeBotTests {
  46     @Test
  47     void mergeMasterBranch(TestInfo testInfo) throws IOException {
  48         try (var temp = new TemporaryDirectory()) {
  49             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
  50 
  51             var fromDir = temp.path().resolve(&quot;from.git&quot;);
  52             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
  53             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
  54 
  55             var toDir = temp.path().resolve(&quot;to.git&quot;);
  56             var toLocalRepo = Repository.init(toDir, VCS.GIT);
  57             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  58             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  59                         StandardOpenOption.APPEND);
  60             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
  61 
</pre>
<hr />
<pre>
1272             // Move the days forward, the bot should not merge
1273             clock.now = ZonedDateTime.of(2020, 5, 30, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1274             TestBotRunner.runPeriodicItems(bot);
1275             toCommits = toLocalRepo.commits().asList();
1276             assertEquals(4, toCommits.size());
1277 
1278             // Move the months forward, the bot should not merge
1279             clock.now = ZonedDateTime.of(2020, 7, 29, 7, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1280             TestBotRunner.runPeriodicItems(bot);
1281             toCommits = toLocalRepo.commits().asList();
1282             assertEquals(4, toCommits.size());
1283 
1284             // Move the clock forward one year, the bot should merge
1285             clock.now = ZonedDateTime.of(2021, 5, 29, 7, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1286             TestBotRunner.runPeriodicItems(bot);
1287 
1288             toCommits = toLocalRepo.commits().asList();
1289             assertEquals(6, toCommits.size());
1290         }
1291     }










































































1292 }
</pre>
</td>
<td>
<hr />
<pre>
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.merge;
  24 
<span class="line-modified">  25 import org.junit.jupiter.api.*;</span>
<span class="line-added">  26 import org.openjdk.skara.host.HostUser;</span>
<span class="line-added">  27 import org.openjdk.skara.issuetracker.Issue;</span>
  28 import org.openjdk.skara.test.*;
  29 import org.openjdk.skara.vcs.*;




  30 
  31 import java.io.IOException;
<span class="line-modified">  32 import java.net.URLEncoder;</span>
<span class="line-modified">  33 import java.nio.charset.StandardCharsets;</span>
<span class="line-added">  34 import java.nio.file.*;</span>
<span class="line-added">  35 import java.time.*;</span>
  36 import java.util.*;
  37 import java.util.stream.Collectors;




  38 
  39 import static org.junit.jupiter.api.Assertions.*;
  40 
  41 class MergeBotTests {
  42     @Test
  43     void mergeMasterBranch(TestInfo testInfo) throws IOException {
  44         try (var temp = new TemporaryDirectory()) {
  45             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
  46 
  47             var fromDir = temp.path().resolve(&quot;from.git&quot;);
  48             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
  49             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
  50 
  51             var toDir = temp.path().resolve(&quot;to.git&quot;);
  52             var toLocalRepo = Repository.init(toDir, VCS.GIT);
  53             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  54             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  55                         StandardOpenOption.APPEND);
  56             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
  57 
</pre>
<hr />
<pre>
1268             // Move the days forward, the bot should not merge
1269             clock.now = ZonedDateTime.of(2020, 5, 30, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1270             TestBotRunner.runPeriodicItems(bot);
1271             toCommits = toLocalRepo.commits().asList();
1272             assertEquals(4, toCommits.size());
1273 
1274             // Move the months forward, the bot should not merge
1275             clock.now = ZonedDateTime.of(2020, 7, 29, 7, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1276             TestBotRunner.runPeriodicItems(bot);
1277             toCommits = toLocalRepo.commits().asList();
1278             assertEquals(4, toCommits.size());
1279 
1280             // Move the clock forward one year, the bot should merge
1281             clock.now = ZonedDateTime.of(2021, 5, 29, 7, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1282             TestBotRunner.runPeriodicItems(bot);
1283 
1284             toCommits = toLocalRepo.commits().asList();
1285             assertEquals(6, toCommits.size());
1286         }
1287     }
<span class="line-added">1288 </span>
<span class="line-added">1289     @Test</span>
<span class="line-added">1290     void mergeAfterDivergedStorage(TestInfo testInfo) throws IOException {</span>
<span class="line-added">1291         try (var temp = new TemporaryDirectory()) {</span>
<span class="line-added">1292             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="line-added">1293 </span>
<span class="line-added">1294             var fromDir = temp.path().resolve(&quot;from.git&quot;);</span>
<span class="line-added">1295             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);</span>
<span class="line-added">1296             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);</span>
<span class="line-added">1297 </span>
<span class="line-added">1298             var toDir = temp.path().resolve(&quot;to.git&quot;);</span>
<span class="line-added">1299             var toLocalRepo = Repository.init(toDir, VCS.GIT);</span>
<span class="line-added">1300             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added">1301             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added">1302                     StandardOpenOption.APPEND);</span>
<span class="line-added">1303             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);</span>
<span class="line-added">1304 </span>
<span class="line-added">1305             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="line-added">1306             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="line-added">1307             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added">1308             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added">1309                     StandardOpenOption.APPEND);</span>
<span class="line-added">1310             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="line-added">1311 </span>
<span class="line-added">1312             var now = ZonedDateTime.now();</span>
<span class="line-added">1313             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added">1314             Files.writeString(fromFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added">1315             fromLocalRepo.add(fromFileA);</span>
<span class="line-added">1316             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added">1317             var fromCommits = fromLocalRepo.commits().asList();</span>
<span class="line-added">1318             assertEquals(1, fromCommits.size());</span>
<span class="line-added">1319             assertEquals(fromHashA, fromCommits.get(0).hash());</span>
<span class="line-added">1320 </span>
<span class="line-added">1321             var toFileA = toDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added">1322             Files.writeString(toFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added">1323             toLocalRepo.add(toFileA);</span>
<span class="line-added">1324             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added">1325             var toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added">1326             assertEquals(1, toCommits.size());</span>
<span class="line-added">1327             assertEquals(toHashA, toCommits.get(0).hash());</span>
<span class="line-added">1328             assertEquals(fromHashA, toHashA);</span>
<span class="line-added">1329 </span>
<span class="line-added">1330             var storage = temp.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">1331             var master = new Branch(&quot;master&quot;);</span>
<span class="line-added">1332             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));</span>
<span class="line-added">1333             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);</span>
<span class="line-added">1334             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added">1335 </span>
<span class="line-added">1336             // Add something new to the source</span>
<span class="line-added">1337             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);</span>
<span class="line-added">1338             Files.writeString(fromFileB, &quot;Hello B\n&quot;);</span>
<span class="line-added">1339             fromLocalRepo.add(fromFileB);</span>
<span class="line-added">1340             var fromHashB = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added">1341             fromLocalRepo.push(fromHashB, fromHostedRepo.url(), &quot;master&quot;);</span>
<span class="line-added">1342 </span>
<span class="line-added">1343             // Diverge the target with something non-conflicting</span>
<span class="line-added">1344             var toFileC = toDir.resolve(&quot;c.txt&quot;);</span>
<span class="line-added">1345             Files.writeString(toFileC, &quot;Hello C\n&quot;);</span>
<span class="line-added">1346             toLocalRepo.add(toFileC);</span>
<span class="line-added">1347             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added">1348             toLocalRepo.push(toHashC, toHostedRepo.url(), &quot;master&quot;);</span>
<span class="line-added">1349 </span>
<span class="line-added">1350             // But push something out of place to the local storage as well</span>
<span class="line-added">1351             var sanitizedForkUrl = URLEncoder.encode(toFork.webUrl().toString(), StandardCharsets.UTF_8);</span>
<span class="line-added">1352             var storageRepo = Repository.init(storage.resolve(sanitizedForkUrl), VCS.GIT);</span>
<span class="line-added">1353             var divergedForkFile = storageRepo.root().resolve(&quot;d.txt&quot;);</span>
<span class="line-added">1354             Files.writeString(divergedForkFile, &quot;Hello D\n&quot;);</span>
<span class="line-added">1355             storageRepo.add(divergedForkFile);</span>
<span class="line-added">1356             var divergedForkHash = storageRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added">1357 </span>
<span class="line-added">1358             // This will need manual intervention</span>
<span class="line-added">1359             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(bot));</span>
<span class="line-added">1360         }</span>
<span class="line-added">1361     }</span>
1362 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/merge/MergeBot.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>