<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/notify/src/test/java/org/openjdk/skara/bots/notify/issue/IssueNotifierTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.notify.issue;
 24 
 25 import org.junit.jupiter.api.*;
 26 import org.openjdk.skara.bots.notify.NotifyBot;
 27 import org.openjdk.skara.forge.HostedRepository;
 28 import org.openjdk.skara.issuetracker.*;
 29 import org.openjdk.skara.json.*;
 30 import org.openjdk.skara.test.*;
 31 
 32 import java.io.IOException;
 33 import java.net.URI;
 34 import java.nio.file.Path;
 35 import java.util.*;
 36 import java.util.regex.Pattern;
 37 import java.util.stream.Collectors;
 38 
 39 import static org.junit.jupiter.api.Assertions.*;
 40 import static org.openjdk.skara.bots.notify.TestUtils.*;
 41 import static org.openjdk.skara.issuetracker.Issue.State.*;
 42 
 43 public class IssueNotifierTests {
 44     private Set&lt;String&gt; fixVersions(Issue issue) {
 45         if (!issue.properties().containsKey(&quot;fixVersions&quot;)) {
 46             return Set.of();
 47         }
 48         return issue.properties().get(&quot;fixVersions&quot;).stream()
 49                     .map(JSONValue::asString)
 50                     .collect(Collectors.toSet());
 51     }
 52 
 53     private TestBotFactory testBotBuilder(HostedRepository hostedRepository, IssueProject issueProject, Path storagePath, JSONObject notifierConfig) throws IOException {
 54         if (!notifierConfig.contains(&quot;project&quot;)) {
 55             notifierConfig.put(&quot;project&quot;, &quot;issueproject&quot;);
 56         }
 57         return TestBotFactory.newBuilder()
 58                              .addHostedRepository(&quot;hostedrepo&quot;, hostedRepository)
 59                              .addIssueProject(&quot;issueproject&quot;, issueProject)
 60                              .storagePath(storagePath)
 61                              .addConfiguration(&quot;database&quot;, JSON.object()
 62                                                                .put(&quot;repository&quot;, &quot;hostedrepo:history&quot;)
 63                                                                .put(&quot;name&quot;, &quot;duke&quot;)
 64                                                                .put(&quot;email&quot;, &quot;duke@openjdk.org&quot;))
 65                              .addConfiguration(&quot;ready&quot;, JSON.object()
 66                                                             .put(&quot;labels&quot;, JSON.array())
 67                                                             .put(&quot;comments&quot;, JSON.array()))
 68                              .addConfiguration(&quot;integrator&quot;, JSON.of(hostedRepository.forge().currentUser().id()))
 69                              .addConfiguration(&quot;repositories&quot;, JSON.object()
 70                                                                    .put(&quot;hostedrepo&quot;, JSON.object()
 71                                                                                           .put(&quot;basename&quot;, &quot;test&quot;)
 72                                                                                           .put(&quot;branches&quot;, &quot;master&quot;)
 73                                                                                           .put(&quot;issue&quot;, notifierConfig)))
 74                              .build();
 75     }
 76 
 77     @Test
 78     void testIssueLinkIdempotence(TestInfo testInfo) throws IOException {
 79         try (var credentials = new HostCredentials(testInfo);
 80              var tempFolder = new TemporaryDirectory()) {
 81             var repo = credentials.getHostedRepository();
 82             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 83             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 84             credentials.commitLock(localRepo);
 85             localRepo.pushAll(repo.url());
 86 
 87             var tagStorage = createTagStorage(repo);
 88             var branchStorage = createBranchStorage(repo);
 89             var prStateStorage = createPullRequestStateStorage(repo);
 90             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 91 
 92             var issueProject = credentials.getIssueProject();
 93             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 94             var notifyBot = NotifyBot.newBuilder()
 95                                      .repository(repo)
 96                                      .storagePath(storageFolder)
 97                                      .branches(Pattern.compile(&quot;master&quot;))
 98                                      .tagStorageBuilder(tagStorage)
 99                                      .branchStorageBuilder(branchStorage)
100                                      .prStateStorageBuilder(prStateStorage)
101                                      .integratorId(repo.forge().currentUser().id())
102                                      .build();
103             var updater = IssueNotifier.newBuilder()
104                                       .issueProject(issueProject)
105                                       .reviewLink(false)
106                                       .commitIcon(commitIcon)
107                                       .build();
108             updater.attachTo(notifyBot);
109 
110             // Initialize history
111             TestBotRunner.runPeriodicItems(notifyBot);
112 
113             // Save the state
114             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
115 
116             // Create an issue and commit a fix
117             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
118             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
119             localRepo.push(editHash, repo.url(), &quot;master&quot;);
120             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
121             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
122             pr.addLabel(&quot;integrated&quot;);
123             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
124             TestBotRunner.runPeriodicItems(notifyBot);
125 
126             // The changeset should be reflected in a link
127             var links = issue.links();
128             assertEquals(1, links.size());
129             var link = links.get(0);
130             assertEquals(commitIcon, link.iconUrl().orElseThrow());
131             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
132             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
133 
134             // Wipe the history
135             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
136 
137             // Run it again
138             TestBotRunner.runPeriodicItems(notifyBot);
139 
140             // There should be no new links
141             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
142             assertEquals(1, updatedIssue.links().size());
143         }
144     }
145 
146     @Test
147     void testPullRequest(TestInfo testInfo) throws IOException {
148         try (var credentials = new HostCredentials(testInfo);
149              var tempFolder = new TemporaryDirectory()) {
150             var repo = credentials.getHostedRepository();
151             var reviewer = credentials.getHostedRepository();
152             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
153             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
154             credentials.commitLock(localRepo);
155             localRepo.pushAll(repo.url());
156 
157             var tagStorage = createTagStorage(repo);
158             var branchStorage = createBranchStorage(repo);
159             var prStateStorage = createPullRequestStateStorage(repo);
160             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
161 
162             var issueProject = credentials.getIssueProject();
163             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
164             var notifyBot = NotifyBot.newBuilder()
165                                      .repository(repo)
166                                      .storagePath(storageFolder)
167                                      .branches(Pattern.compile(&quot;master&quot;))
168                                      .tagStorageBuilder(tagStorage)
169                                      .branchStorageBuilder(branchStorage)
170                                      .prStateStorageBuilder(prStateStorage)
171                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
172                                      .build();
173             var updater = IssueNotifier.newBuilder()
174                                       .issueProject(issueProject)
175                                       .reviewIcon(reviewIcon)
176                                       .commitLink(false)
177                                       .build();
178             updater.attachTo(notifyBot);
179 
180             // Initialize history
181             TestBotRunner.runPeriodicItems(notifyBot);
182 
183             // Create an issue and a pull request to fix it
184             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
185             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
186             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
187             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
188             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
189             TestBotRunner.runPeriodicItems(notifyBot);
190 
191             // The issue should not yet contain a link to the PR
192             var links = issue.links();
193             assertEquals(0, links.size());
194 
195             // Just a label isn&#39;t enough
196             pr.addLabel(&quot;rfr&quot;);
197             TestBotRunner.runPeriodicItems(notifyBot);
198             links = issue.links();
199             assertEquals(0, links.size());
200 
201             // Neither is just a comment
202             pr.removeLabel(&quot;rfr&quot;);
203             var reviewPr = reviewer.pullRequest(pr.id());
204             reviewPr.addComment(&quot;This is now ready&quot;);
205             TestBotRunner.runPeriodicItems(notifyBot);
206             links = issue.links();
207             assertEquals(0, links.size());
208 
209             // Both are needed
210             pr.addLabel(&quot;rfr&quot;);
211             TestBotRunner.runPeriodicItems(notifyBot);
212 
213             // The issue should now contain a link to the PR
214             links = issue.links();
215             assertEquals(1, links.size());
216             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
217             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
218 
219             // Add another issue
220             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
221             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n * [&quot; + issue2.id() +
222                     &quot;](http://www.test2.test/): The second issue&quot;);
223             TestBotRunner.runPeriodicItems(notifyBot);
224 
225             // Both issues should contain a link to the PR
226             var links1 = issue.links();
227             assertEquals(1, links1.size());
228             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());
229             var links2 = issue2.links();
230             assertEquals(1, links2.size());
231             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
232 
233             // Drop the first one
234             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
235             TestBotRunner.runPeriodicItems(notifyBot);
236 
237             // Only the second issue should now contain a link to the PR
238             links1 = issue.links();
239             assertEquals(0, links1.size());
240             links2 = issue2.links();
241             assertEquals(1, links2.size());
242             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
243         }
244     }
245 
246     @Test
247     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
248         try (var credentials = new HostCredentials(testInfo);
249              var tempFolder = new TemporaryDirectory()) {
250             var repo = credentials.getHostedRepository();
251             var reviewer = credentials.getHostedRepository();
252             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
253             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
254             credentials.commitLock(localRepo);
255             localRepo.pushAll(repo.url());
256 
257             var tagStorage = createTagStorage(repo);
258             var branchStorage = createBranchStorage(repo);
259             var prStateStorage = createPullRequestStateStorage(repo);
260             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
261 
262             var issueProject = credentials.getIssueProject();
263             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
264             var notifyBot = NotifyBot.newBuilder()
265                                      .repository(repo)
266                                      .storagePath(storageFolder)
267                                      .branches(Pattern.compile(&quot;master&quot;))
268                                      .tagStorageBuilder(tagStorage)
269                                      .branchStorageBuilder(branchStorage)
270                                      .prStateStorageBuilder(prStateStorage)
271                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
272                                      .build();
273             var updater = IssueNotifier.newBuilder()
274                                       .issueProject(issueProject)
275                                       .reviewLink(false)
276                                       .reviewIcon(reviewIcon)
277                                       .commitLink(false)
278                                       .build();
279             updater.attachTo(notifyBot);
280 
281             // Initialize history
282             TestBotRunner.runPeriodicItems(notifyBot);
283 
284             // Create an issue and a pull request to fix it
285             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
286             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
287             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
288             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
289             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
290             TestBotRunner.runPeriodicItems(notifyBot);
291 
292             // Add required label
293             pr.addLabel(&quot;rfr&quot;);
294             TestBotRunner.runPeriodicItems(notifyBot);
295 
296             // And the required comment
297             var reviewPr = reviewer.pullRequest(pr.id());
298             reviewPr.addComment(&quot;This is now ready&quot;);
299             TestBotRunner.runPeriodicItems(notifyBot);
300 
301             // The issue should still not contain a link to the PR
302             var links = issue.links();
303             assertEquals(0, links.size());
304         }
305     }
306 
307     @Test
308     void testPullRequestPROnly(TestInfo testInfo) throws IOException {
309         try (var credentials = new HostCredentials(testInfo);
310              var tempFolder = new TemporaryDirectory()) {
311             var repo = credentials.getHostedRepository();
312             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
313             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
314             credentials.commitLock(localRepo);
315             localRepo.pushAll(repo.url());
316 
317             var tagStorage = createTagStorage(repo);
318             var branchStorage = createBranchStorage(repo);
319             var prStateStorage = createPullRequestStateStorage(repo);
320             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
321 
322             var issueProject = credentials.getIssueProject();
323             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
324             var notifyBot = NotifyBot.newBuilder()
325                                      .repository(repo)
326                                      .storagePath(storageFolder)
327                                      .branches(Pattern.compile(&quot;.*&quot;))
328                                      .tagStorageBuilder(tagStorage)
329                                      .branchStorageBuilder(branchStorage)
330                                      .prStateStorageBuilder(prStateStorage)
331                                      .integratorId(repo.forge().currentUser().id())
332                                      .build();
333             var updater = IssueNotifier.newBuilder()
334                                       .issueProject(issueProject)
335                                       .reviewIcon(reviewIcon)
336                                       .commitLink(true)
337                                       .commitIcon(reviewIcon)
338                                       .build();
339             updater.attachTo(notifyBot);
340 
341             // Initialize history
342             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
343             TestBotRunner.runPeriodicItems(notifyBot);
344 
345             // Create an issue and a pull request to fix it
346             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
347             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
348             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
349             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
350             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
351             pr.addLabel(&quot;rfr&quot;);
352             TestBotRunner.runPeriodicItems(notifyBot);
353 
354             // The issue should now contain a link to the PR
355             var links = issue.links();
356             assertEquals(1, links.size());
357             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
358             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
359 
360             // Simulate integration
361             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
362             pr.addLabel(&quot;integrated&quot;);
363             pr.setState(Issue.State.CLOSED);
364             localRepo.push(editHash, repo.url(), &quot;other&quot;);
365             TestBotRunner.runPeriodicItems(notifyBot);
366 
367             // The changeset should be reflected in another link
368             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
369             links = updatedIssue.links();
370             assertEquals(2, links.size());
371 
372             // Now simulate a merge to another branch
373             localRepo.push(editHash, repo.url(), &quot;master&quot;);
374             TestBotRunner.runPeriodicItems(notifyBot);
375 
376             // No additional link should have been created
377             updatedIssue = issueProject.issue(issue.id()).orElseThrow();
378             links = updatedIssue.links();
379             assertEquals(2, links.size());
380         }
381     }
382 
383     @Test
384     void testIssue(TestInfo testInfo) throws IOException {
385         try (var credentials = new HostCredentials(testInfo);
386              var tempFolder = new TemporaryDirectory()) {
387 
388             var repo = credentials.getHostedRepository();
389             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
390             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
391             credentials.commitLock(localRepo);
392             localRepo.pushAll(repo.url());
393 
394             var issueProject = credentials.getIssueProject();
395             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
396             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object());
397             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
398 
399             // Initialize history
400             TestBotRunner.runPeriodicItems(notifyBot);
401 
402             // Create an issue and commit a fix
403             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
404             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
405             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
406             localRepo.push(editHash, repo.url(), &quot;master&quot;);
407             TestBotRunner.runPeriodicItems(notifyBot);
408 
409             // The changeset should be reflected in a comment
410             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
411 
412             var comments = updatedIssue.comments();
413             assertEquals(1, comments.size());
414             var comment = comments.get(0);
415             assertTrue(comment.body().contains(editHash.abbreviate()));
416 
417             // As well as a fixVersion
418             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
419 
420             // The issue should be assigned and resolved
421             assertEquals(RESOLVED, updatedIssue.state());
422             assertEquals(List.of(issueProject.issueTracker().currentUser()), updatedIssue.assignees());
423         }
424     }
425 
426     @Test
427     void testIssueNoVersion(TestInfo testInfo) throws IOException {
428         try (var credentials = new HostCredentials(testInfo);
429              var tempFolder = new TemporaryDirectory()) {
430             var repo = credentials.getHostedRepository();
431             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
432             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
433             credentials.commitLock(localRepo);
434             localRepo.pushAll(repo.url());
435 
436             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
437             var issueProject = credentials.getIssueProject();
438             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object());
439             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
440 
441             // Initialize history
442             TestBotRunner.runPeriodicItems(notifyBot);
443 
444             // Create an issue and commit a fix
445             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
446             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
447             localRepo.push(editHash, repo.url(), &quot;master&quot;);
448             TestBotRunner.runPeriodicItems(notifyBot);
449 
450             // The changeset should be reflected in a comment
451             var comments = issue.comments();
452             assertEquals(1, comments.size());
453             var comment = comments.get(0);
454             assertTrue(comment.body().contains(editHash.abbreviate()));
455 
456             // But not in the fixVersion
457             assertEquals(Set.of(), fixVersions(issue));
458         }
459     }
460 
461     @Test
462     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
463         try (var credentials = new HostCredentials(testInfo);
464              var tempFolder = new TemporaryDirectory()) {
465             var repo = credentials.getHostedRepository();
466             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
467             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
468             credentials.commitLock(localRepo);
469             localRepo.pushAll(repo.url());
470 
471             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
472             var issueProject = credentials.getIssueProject();
473             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;2.0&quot;));
474             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
475 
476             // Initialize history
477             TestBotRunner.runPeriodicItems(notifyBot);
478 
479             // Create an issue and commit a fix
480             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
481             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
482             localRepo.push(editHash, repo.url(), &quot;master&quot;);
483             TestBotRunner.runPeriodicItems(notifyBot);
484 
485             // The changeset should not reflected in a comment
486             var comments = issue.comments();
487             assertEquals(1, comments.size());
488             var comment = comments.get(0);
489             assertTrue(comment.body().contains(editHash.abbreviate()));
490 
491             // As well as a fixVersion - but not the one from the repo
492             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
493 
494             // And no commit link
495             var links = issue.links();
496             assertEquals(0, links.size());
497         }
498     }
499 
500     @Test
501     void testIssueIdempotence(TestInfo testInfo) throws IOException {
502         try (var credentials = new HostCredentials(testInfo);
503              var tempFolder = new TemporaryDirectory()) {
504             var repo = credentials.getHostedRepository();
505             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
506             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
507             credentials.commitLock(localRepo);
508             localRepo.pushAll(repo.url());
509 
510             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
511             var issueProject = credentials.getIssueProject();
512             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object());
513             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
514 
515             // Initialize history
516             TestBotRunner.runPeriodicItems(notifyBot);
517 
518             // Save the state
519             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
520 
521             // Create an issue and commit a fix
522             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
523             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
524             localRepo.push(editHash, repo.url(), &quot;master&quot;);
525             TestBotRunner.runPeriodicItems(notifyBot);
526 
527             // The changeset should be reflected in a comment
528             var comments = issue.comments();
529             assertEquals(1, comments.size());
530             var comment = comments.get(0);
531             assertTrue(comment.body().contains(editHash.abbreviate()));
532 
533             // As well as a fixVersion
534             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));
535 
536             // Wipe the history
537             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
538 
539             // Run it again
540             TestBotRunner.runPeriodicItems(notifyBot);
541 
542             // There should be no new comments or fixVersions
543             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
544             assertEquals(1, updatedIssue.comments().size());
545             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
546         }
547     }
548 
549     @Test
550     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
551         try (var credentials = new HostCredentials(testInfo);
552              var tempFolder = new TemporaryDirectory()) {
553             var repo = credentials.getHostedRepository();
554             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
555             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
556             credentials.commitLock(localRepo);
557             localRepo.pushAll(repo.url());
558 
559             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
560             var issueProject = credentials.getIssueProject();
561             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;12u14&quot;));
562             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
563 
564             // Initialize history
565             TestBotRunner.runPeriodicItems(notifyBot);
566 
567             // Create an issue and commit a fix
568             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
569             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
570 
571             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
572             localRepo.push(editHash, repo.url(), &quot;master&quot;);
573             TestBotRunner.runPeriodicItems(notifyBot);
574 
575             // The fixVersion should have been updated
576             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
577         }
578     }
579 
580     @Test
581     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
582         try (var credentials = new HostCredentials(testInfo);
583              var tempFolder = new TemporaryDirectory()) {
584             var repo = credentials.getHostedRepository();
585             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
586             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
587             credentials.commitLock(localRepo);
588             localRepo.pushAll(repo.url());
589 
590             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
591             var issueProject = credentials.getIssueProject();
592             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;12u14&quot;));
593             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
594 
595             // Initialize history
596             TestBotRunner.runPeriodicItems(notifyBot);
597 
598             // Create an issue and commit a fix
599             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
600             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
601 
602             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
603             localRepo.push(editHash, repo.url(), &quot;master&quot;);
604             TestBotRunner.runPeriodicItems(notifyBot);
605 
606             // The fixVersion should have been updated
607             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
608         }
609     }
610 
611     @Test
612     void testIssueBackport(TestInfo testInfo) throws IOException {
613         try (var credentials = new HostCredentials(testInfo);
614              var tempFolder = new TemporaryDirectory()) {
615             var repo = credentials.getHostedRepository();
616             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
617             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
618             credentials.commitLock(localRepo);
619             localRepo.pushAll(repo.url());
620 
621             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
622             var issueProject = credentials.getIssueProject();
623             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;12.0.2&quot;));
624             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
625 
626             // Initialize history
627             TestBotRunner.runPeriodicItems(notifyBot);
628 
629             // Create an issue and commit a fix
630             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),
631                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),
632                                                         &quot;customfield_10008&quot;, JSON.object()
633                                                                                  .put(&quot;id&quot;, 244)
634                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),
635                                                         &quot;customfield_10005&quot;, JSON.array()
636                                                                                  .add(JSON.object()
637                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)
638                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))
639                                                                                  .add(JSON.object()
640                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)
641                                                                                           .put(&quot;value&quot;, &quot;other&quot;))
642                                                  ));
643             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
644             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
645 
646             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
647             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
648             localRepo.push(editHash, repo.url(), &quot;master&quot;);
649             TestBotRunner.runPeriodicItems(notifyBot);
650 
651             // The fixVersion should not have been updated
652             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
653             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));
654             assertEquals(OPEN, updatedIssue.state());
655             assertEquals(List.of(), updatedIssue.assignees());
656 
657             // There should be a link
658             var links = updatedIssue.links();
659             assertEquals(1, links.size());
660             var link = links.get(0);
661             var backport = link.issue().orElseThrow();
662 
663             // The backport issue should have a correct fixVersion and assignee
664             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));
665             assertEquals(RESOLVED, backport.state());
666             assertEquals(List.of(issueProject.issueTracker().currentUser()), backport.assignees());
667 
668             // Custom properties should also propagate
669             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());
670             assertEquals(244, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;id&quot;).asInt());
671             assertEquals(&quot;java.io&quot;, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;name&quot;).asString());
672             assertEquals(2, backport.properties().get(&quot;customfield_10005&quot;).asArray().size());
673         }
674     }
675 
676     @Test
677     void testSyncLabels(TestInfo testInfo) throws IOException {
678         try (var credentials = new HostCredentials(testInfo);
679              var tempFolder = new TemporaryDirectory()) {
680             var repo = credentials.getHostedRepository();
681             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
682             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
683             credentials.commitLock(localRepo);
684             localRepo.pushAll(repo.url());
685 
686             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
687             var issueProject = credentials.getIssueProject();
688             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;8u192&quot;));
689             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
690 
691             // Initialize database
692             TestBotRunner.runPeriodicItems(notifyBot);
693 
694             var issue1 = credentials.createIssue(issueProject, &quot;Issue 1&quot;);
695             issue1.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Bug&quot;));
696 
697             var issue2 = credentials.createIssue(issueProject, &quot;Issue 2&quot;);
698             issue2.setProperty(&quot;fixVersions&quot;, JSON.array().add(JSON.of(&quot;8u162&quot;)));
699             issue2.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Backport&quot;));
700             issue1.addLink(Link.create(issue2, &quot;backported by&quot;).build());
701 
702             var issue3 = credentials.createIssue(issueProject, &quot;Issue 3&quot;);
703             issue3.setProperty(&quot;fixVersions&quot;, JSON.array().add(JSON.of(&quot;10&quot;)));
704             issue3.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Backport&quot;));
705             issue1.addLink(Link.create(issue3, &quot;backported by&quot;).build());
706 
707             var issue4 = credentials.createIssue(issueProject, &quot;Issue 4&quot;);
708             issue4.setProperty(&quot;fixVersions&quot;, JSON.array().add(JSON.of(&quot;11&quot;)));
709             issue4.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Backport&quot;));
710             issue1.addLink(Link.create(issue4, &quot;backported by&quot;).build());
711 
712             // Mention one of the issues
713             var commit = CheckableRepository.appendAndCommit(localRepo, &quot;Hello there&quot;, issue1.id() + &quot;: A fix&quot;);
714             localRepo.push(commit, repo.url(), &quot;master&quot;);
715             TestBotRunner.runPeriodicItems(notifyBot);
716 
717             assertEquals(List.of(&quot;hgupdater-sync&quot;), issue1.labels());
718             assertEquals(List.of(), issue2.labels());
719             assertEquals(List.of(), issue3.labels());
720             assertEquals(List.of(&quot;hgupdater-sync&quot;), issue4.labels());
721         }
722     }
723 }
    </pre>
  </body>
</html>