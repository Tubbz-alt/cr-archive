<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/notify/src/test/java/org/openjdk/skara/bots/notify/issue/IssueNotifierTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.notify.issue;
 24 
 25 import org.junit.jupiter.api.*;
 26 import org.openjdk.skara.bots.notify.NotifyBot;
 27 import org.openjdk.skara.forge.HostedRepository;
 28 import org.openjdk.skara.issuetracker.*;
 29 import org.openjdk.skara.json.*;
 30 import org.openjdk.skara.test.*;
 31 
 32 import java.io.IOException;
 33 import java.net.URI;
 34 import java.nio.file.Path;
 35 import java.util.*;
 36 import java.util.regex.Pattern;
 37 import java.util.stream.Collectors;
 38 
 39 import static org.junit.jupiter.api.Assertions.*;
 40 import static org.openjdk.skara.bots.notify.TestUtils.*;
 41 import static org.openjdk.skara.issuetracker.Issue.State.*;
 42 
 43 public class IssueNotifierTests {
 44     private Set&lt;String&gt; fixVersions(Issue issue) {
 45         if (!issue.properties().containsKey(&quot;fixVersions&quot;)) {
 46             return Set.of();
 47         }
 48         return issue.properties().get(&quot;fixVersions&quot;).stream()
 49                     .map(JSONValue::asString)
 50                     .collect(Collectors.toSet());
 51     }
 52 
 53     private TestBotFactory testBotBuilder(HostedRepository hostedRepository, IssueProject issueProject, Path storagePath, JSONObject notifierConfig) throws IOException {
 54         if (!notifierConfig.contains(&quot;project&quot;)) {
 55             notifierConfig.put(&quot;project&quot;, &quot;issueproject&quot;);
 56         }
 57         return TestBotFactory.newBuilder()
 58                              .addHostedRepository(&quot;hostedrepo&quot;, hostedRepository)
 59                              .addIssueProject(&quot;issueproject&quot;, issueProject)
 60                              .storagePath(storagePath)
 61                              .addConfiguration(&quot;database&quot;, JSON.object()
 62                                                                .put(&quot;repository&quot;, &quot;hostedrepo:history&quot;)
 63                                                                .put(&quot;name&quot;, &quot;duke&quot;)
 64                                                                .put(&quot;email&quot;, &quot;duke@openjdk.org&quot;))
 65                              .addConfiguration(&quot;ready&quot;, JSON.object()
 66                                                             .put(&quot;labels&quot;, JSON.array())
 67                                                             .put(&quot;comments&quot;, JSON.array()))
 68                              .addConfiguration(&quot;integrator&quot;, JSON.of(hostedRepository.forge().currentUser().id()))
 69                              .addConfiguration(&quot;repositories&quot;, JSON.object()
 70                                                                    .put(&quot;hostedrepo&quot;, JSON.object()
 71                                                                                           .put(&quot;basename&quot;, &quot;test&quot;)
 72                                                                                           .put(&quot;branches&quot;, &quot;master&quot;)
 73                                                                                           .put(&quot;issue&quot;, notifierConfig)))
 74                              .build();
 75     }
 76 
 77     @Test
 78     void testIssueLinkIdempotence(TestInfo testInfo) throws IOException {
 79         try (var credentials = new HostCredentials(testInfo);
 80              var tempFolder = new TemporaryDirectory()) {
 81             var repo = credentials.getHostedRepository();
 82             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 83             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 84             credentials.commitLock(localRepo);
 85             localRepo.pushAll(repo.url());
 86 
 87             var tagStorage = createTagStorage(repo);
 88             var branchStorage = createBranchStorage(repo);
 89             var prStateStorage = createPullRequestStateStorage(repo);
 90             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 91 
 92             var issueProject = credentials.getIssueProject();
 93             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 94             var notifyBot = NotifyBot.newBuilder()
 95                                      .repository(repo)
 96                                      .storagePath(storageFolder)
 97                                      .branches(Pattern.compile(&quot;master&quot;))
 98                                      .tagStorageBuilder(tagStorage)
 99                                      .branchStorageBuilder(branchStorage)
100                                      .prStateStorageBuilder(prStateStorage)
101                                      .integratorId(repo.forge().currentUser().id())
102                                      .build();
103             var updater = IssueNotifier.newBuilder()
104                                       .issueProject(issueProject)
105                                       .reviewLink(false)
106                                       .commitIcon(commitIcon)
107                                       .build();
108             updater.attachTo(notifyBot);
109 
110             // Initialize history
111             TestBotRunner.runPeriodicItems(notifyBot);
112 
113             // Save the state
114             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
115 
116             // Create an issue and commit a fix
117             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
118             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
119             localRepo.push(editHash, repo.url(), &quot;master&quot;);
120             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
121             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
122             pr.addLabel(&quot;integrated&quot;);
123             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
124             TestBotRunner.runPeriodicItems(notifyBot);
125 
126             // The changeset should be reflected in a link
127             var links = issue.links();
128             assertEquals(1, links.size());
129             var link = links.get(0);
130             assertEquals(commitIcon, link.iconUrl().orElseThrow());
131             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
132             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
133 
134             // Wipe the history
135             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
136 
137             // Run it again
138             TestBotRunner.runPeriodicItems(notifyBot);
139 
140             // There should be no new links
141             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
142             assertEquals(1, updatedIssue.links().size());
143         }
144     }
145 
146     @Test
147     void testPullRequest(TestInfo testInfo) throws IOException {
148         try (var credentials = new HostCredentials(testInfo);
149              var tempFolder = new TemporaryDirectory()) {
150             var repo = credentials.getHostedRepository();
151             var reviewer = credentials.getHostedRepository();
152             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
153             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
154             credentials.commitLock(localRepo);
155             localRepo.pushAll(repo.url());
156 
157             var tagStorage = createTagStorage(repo);
158             var branchStorage = createBranchStorage(repo);
159             var prStateStorage = createPullRequestStateStorage(repo);
160             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
161 
162             var issueProject = credentials.getIssueProject();
163             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
164             var notifyBot = NotifyBot.newBuilder()
165                                      .repository(repo)
166                                      .storagePath(storageFolder)
167                                      .branches(Pattern.compile(&quot;master&quot;))
168                                      .tagStorageBuilder(tagStorage)
169                                      .branchStorageBuilder(branchStorage)
170                                      .prStateStorageBuilder(prStateStorage)
171                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
172                                      .build();
173             var updater = IssueNotifier.newBuilder()
174                                       .issueProject(issueProject)
175                                       .reviewIcon(reviewIcon)
176                                       .commitLink(false)
177                                       .build();
178             updater.attachTo(notifyBot);
179 
180             // Initialize history
181             TestBotRunner.runPeriodicItems(notifyBot);
182 
183             // Create an issue and a pull request to fix it
184             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
185             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
186             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
187             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
188             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
189             TestBotRunner.runPeriodicItems(notifyBot);
190 
191             // The issue should not yet contain a link to the PR
192             var links = issue.links();
193             assertEquals(0, links.size());
194 
195             // Just a label isn&#39;t enough
196             pr.addLabel(&quot;rfr&quot;);
197             TestBotRunner.runPeriodicItems(notifyBot);
198             links = issue.links();
199             assertEquals(0, links.size());
200 
201             // Neither is just a comment
202             pr.removeLabel(&quot;rfr&quot;);
203             var reviewPr = reviewer.pullRequest(pr.id());
204             reviewPr.addComment(&quot;This is now ready&quot;);
205             TestBotRunner.runPeriodicItems(notifyBot);
206             links = issue.links();
207             assertEquals(0, links.size());
208 
209             // Both are needed
210             pr.addLabel(&quot;rfr&quot;);
211             TestBotRunner.runPeriodicItems(notifyBot);
212 
213             // The issue should now contain a link to the PR
214             links = issue.links();
215             assertEquals(1, links.size());
216             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
217             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
218 
219             // Add another issue
220             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
221             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n * [&quot; + issue2.id() +
222                     &quot;](http://www.test2.test/): The second issue&quot;);
223             TestBotRunner.runPeriodicItems(notifyBot);
224 
225             // Both issues should contain a link to the PR
226             var links1 = issue.links();
227             assertEquals(1, links1.size());
228             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());
229             var links2 = issue2.links();
230             assertEquals(1, links2.size());
231             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
232 
233             // Drop the first one
234             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
235             TestBotRunner.runPeriodicItems(notifyBot);
236 
237             // Only the second issue should now contain a link to the PR
238             links1 = issue.links();
239             assertEquals(0, links1.size());
240             links2 = issue2.links();
241             assertEquals(1, links2.size());
242             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
243         }
244     }
245 
246     @Test
247     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
248         try (var credentials = new HostCredentials(testInfo);
249              var tempFolder = new TemporaryDirectory()) {
250             var repo = credentials.getHostedRepository();
251             var reviewer = credentials.getHostedRepository();
252             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
253             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
254             credentials.commitLock(localRepo);
255             localRepo.pushAll(repo.url());
256 
257             var tagStorage = createTagStorage(repo);
258             var branchStorage = createBranchStorage(repo);
259             var prStateStorage = createPullRequestStateStorage(repo);
260             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
261 
262             var issueProject = credentials.getIssueProject();
263             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
264             var notifyBot = NotifyBot.newBuilder()
265                                      .repository(repo)
266                                      .storagePath(storageFolder)
267                                      .branches(Pattern.compile(&quot;master&quot;))
268                                      .tagStorageBuilder(tagStorage)
269                                      .branchStorageBuilder(branchStorage)
270                                      .prStateStorageBuilder(prStateStorage)
271                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
272                                      .build();
273             var updater = IssueNotifier.newBuilder()
274                                       .issueProject(issueProject)
275                                       .reviewLink(false)
276                                       .reviewIcon(reviewIcon)
277                                       .commitLink(false)
278                                       .build();
279             updater.attachTo(notifyBot);
280 
281             // Initialize history
282             TestBotRunner.runPeriodicItems(notifyBot);
283 
284             // Create an issue and a pull request to fix it
285             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
286             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
287             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
288             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
289             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
290             TestBotRunner.runPeriodicItems(notifyBot);
291 
292             // Add required label
293             pr.addLabel(&quot;rfr&quot;);
294             TestBotRunner.runPeriodicItems(notifyBot);
295 
296             // And the required comment
297             var reviewPr = reviewer.pullRequest(pr.id());
298             reviewPr.addComment(&quot;This is now ready&quot;);
299             TestBotRunner.runPeriodicItems(notifyBot);
300 
301             // The issue should still not contain a link to the PR
302             var links = issue.links();
303             assertEquals(0, links.size());
304         }
305     }
306 
307     @Test
308     void testPullRequestPROnly(TestInfo testInfo) throws IOException {
309         try (var credentials = new HostCredentials(testInfo);
310              var tempFolder = new TemporaryDirectory()) {
311             var repo = credentials.getHostedRepository();
312             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
313             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
314             credentials.commitLock(localRepo);
315             localRepo.pushAll(repo.url());
316 
<a name="1" id="anc1"></a>




317             var issueProject = credentials.getIssueProject();
<a name="2" id="anc2"></a><span class="line-added">318             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
319             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
<a name="3" id="anc3"></a><span class="line-modified">320             var jbsNotifierConfig = JSON.object().put(&quot;reviews&quot;, JSON.object().put(&quot;icon&quot;, reviewIcon.toString()));</span>
<span class="line-modified">321             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());</span>














322 
323             // Initialize history
324             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
325             TestBotRunner.runPeriodicItems(notifyBot);
326 
327             // Create an issue and a pull request to fix it
328             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
329             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
330             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
331             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
332             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
333             pr.addLabel(&quot;rfr&quot;);
334             TestBotRunner.runPeriodicItems(notifyBot);
335 
336             // The issue should now contain a link to the PR
337             var links = issue.links();
338             assertEquals(1, links.size());
339             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
340             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
341 
342             // Simulate integration
343             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
344             pr.addLabel(&quot;integrated&quot;);
345             pr.setState(Issue.State.CLOSED);
346             localRepo.push(editHash, repo.url(), &quot;other&quot;);
347             TestBotRunner.runPeriodicItems(notifyBot);
348 
349             // The changeset should be reflected in another link
350             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
351             links = updatedIssue.links();
352             assertEquals(2, links.size());
353 
354             // Now simulate a merge to another branch
355             localRepo.push(editHash, repo.url(), &quot;master&quot;);
356             TestBotRunner.runPeriodicItems(notifyBot);
357 
358             // No additional link should have been created
359             updatedIssue = issueProject.issue(issue.id()).orElseThrow();
360             links = updatedIssue.links();
361             assertEquals(2, links.size());
<a name="4" id="anc4"></a><span class="line-added">362 </span>
<span class="line-added">363             // And no comments should have been made</span>
<span class="line-added">364             assertEquals(0, issue.comments().size());</span>
365         }
366     }
367 
368     @Test
369     void testIssue(TestInfo testInfo) throws IOException {
370         try (var credentials = new HostCredentials(testInfo);
371              var tempFolder = new TemporaryDirectory()) {
372 
373             var repo = credentials.getHostedRepository();
374             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
375             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
376             credentials.commitLock(localRepo);
377             localRepo.pushAll(repo.url());
378 
379             var issueProject = credentials.getIssueProject();
380             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
381             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object());
382             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
383 
384             // Initialize history
385             TestBotRunner.runPeriodicItems(notifyBot);
386 
387             // Create an issue and commit a fix
388             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
389             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
390             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
391             localRepo.push(editHash, repo.url(), &quot;master&quot;);
392             TestBotRunner.runPeriodicItems(notifyBot);
393 
394             // The changeset should be reflected in a comment
395             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
396 
397             var comments = updatedIssue.comments();
398             assertEquals(1, comments.size());
399             var comment = comments.get(0);
400             assertTrue(comment.body().contains(editHash.abbreviate()));
401 
402             // As well as a fixVersion
403             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
404 
405             // The issue should be assigned and resolved
406             assertEquals(RESOLVED, updatedIssue.state());
407             assertEquals(List.of(issueProject.issueTracker().currentUser()), updatedIssue.assignees());
408         }
409     }
410 
411     @Test
412     void testIssueNoVersion(TestInfo testInfo) throws IOException {
413         try (var credentials = new HostCredentials(testInfo);
414              var tempFolder = new TemporaryDirectory()) {
415             var repo = credentials.getHostedRepository();
416             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
417             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
418             credentials.commitLock(localRepo);
419             localRepo.pushAll(repo.url());
420 
421             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
422             var issueProject = credentials.getIssueProject();
423             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object());
424             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
425 
426             // Initialize history
427             TestBotRunner.runPeriodicItems(notifyBot);
428 
429             // Create an issue and commit a fix
430             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
431             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
432             localRepo.push(editHash, repo.url(), &quot;master&quot;);
433             TestBotRunner.runPeriodicItems(notifyBot);
434 
435             // The changeset should be reflected in a comment
436             var comments = issue.comments();
437             assertEquals(1, comments.size());
438             var comment = comments.get(0);
439             assertTrue(comment.body().contains(editHash.abbreviate()));
440 
441             // But not in the fixVersion
442             assertEquals(Set.of(), fixVersions(issue));
443         }
444     }
445 
446     @Test
447     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
448         try (var credentials = new HostCredentials(testInfo);
449              var tempFolder = new TemporaryDirectory()) {
450             var repo = credentials.getHostedRepository();
451             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
452             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
453             credentials.commitLock(localRepo);
454             localRepo.pushAll(repo.url());
455 
456             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
457             var issueProject = credentials.getIssueProject();
458             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;2.0&quot;));
459             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
460 
461             // Initialize history
462             TestBotRunner.runPeriodicItems(notifyBot);
463 
464             // Create an issue and commit a fix
465             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
466             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
467             localRepo.push(editHash, repo.url(), &quot;master&quot;);
468             TestBotRunner.runPeriodicItems(notifyBot);
469 
470             // The changeset should not reflected in a comment
471             var comments = issue.comments();
472             assertEquals(1, comments.size());
473             var comment = comments.get(0);
474             assertTrue(comment.body().contains(editHash.abbreviate()));
475 
476             // As well as a fixVersion - but not the one from the repo
477             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
478 
479             // And no commit link
480             var links = issue.links();
481             assertEquals(0, links.size());
482         }
483     }
484 
485     @Test
486     void testIssueIdempotence(TestInfo testInfo) throws IOException {
487         try (var credentials = new HostCredentials(testInfo);
488              var tempFolder = new TemporaryDirectory()) {
489             var repo = credentials.getHostedRepository();
490             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
491             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
492             credentials.commitLock(localRepo);
493             localRepo.pushAll(repo.url());
494 
495             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
496             var issueProject = credentials.getIssueProject();
497             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object());
498             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
499 
500             // Initialize history
501             TestBotRunner.runPeriodicItems(notifyBot);
502 
503             // Save the state
504             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
505 
506             // Create an issue and commit a fix
507             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
508             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
509             localRepo.push(editHash, repo.url(), &quot;master&quot;);
510             TestBotRunner.runPeriodicItems(notifyBot);
511 
512             // The changeset should be reflected in a comment
513             var comments = issue.comments();
514             assertEquals(1, comments.size());
515             var comment = comments.get(0);
516             assertTrue(comment.body().contains(editHash.abbreviate()));
517 
518             // As well as a fixVersion
519             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));
520 
521             // Wipe the history
522             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
523 
524             // Run it again
525             TestBotRunner.runPeriodicItems(notifyBot);
526 
527             // There should be no new comments or fixVersions
528             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
529             assertEquals(1, updatedIssue.comments().size());
530             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
531         }
532     }
533 
534     @Test
535     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
536         try (var credentials = new HostCredentials(testInfo);
537              var tempFolder = new TemporaryDirectory()) {
538             var repo = credentials.getHostedRepository();
539             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
540             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
541             credentials.commitLock(localRepo);
542             localRepo.pushAll(repo.url());
543 
544             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
545             var issueProject = credentials.getIssueProject();
546             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;12u14&quot;));
547             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
548 
549             // Initialize history
550             TestBotRunner.runPeriodicItems(notifyBot);
551 
552             // Create an issue and commit a fix
553             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
554             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
555 
556             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
557             localRepo.push(editHash, repo.url(), &quot;master&quot;);
558             TestBotRunner.runPeriodicItems(notifyBot);
559 
560             // The fixVersion should have been updated
561             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
562         }
563     }
564 
565     @Test
566     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
567         try (var credentials = new HostCredentials(testInfo);
568              var tempFolder = new TemporaryDirectory()) {
569             var repo = credentials.getHostedRepository();
570             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
571             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
572             credentials.commitLock(localRepo);
573             localRepo.pushAll(repo.url());
574 
575             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
576             var issueProject = credentials.getIssueProject();
577             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;12u14&quot;));
578             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
579 
580             // Initialize history
581             TestBotRunner.runPeriodicItems(notifyBot);
582 
583             // Create an issue and commit a fix
584             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
585             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
586 
587             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
588             localRepo.push(editHash, repo.url(), &quot;master&quot;);
589             TestBotRunner.runPeriodicItems(notifyBot);
590 
591             // The fixVersion should have been updated
592             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
593         }
594     }
595 
596     @Test
597     void testIssueBackport(TestInfo testInfo) throws IOException {
598         try (var credentials = new HostCredentials(testInfo);
599              var tempFolder = new TemporaryDirectory()) {
600             var repo = credentials.getHostedRepository();
601             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
602             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
603             credentials.commitLock(localRepo);
604             localRepo.pushAll(repo.url());
605 
606             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
607             var issueProject = credentials.getIssueProject();
608             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;12.0.2&quot;));
609             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
610 
611             // Initialize history
612             TestBotRunner.runPeriodicItems(notifyBot);
613 
614             // Create an issue and commit a fix
615             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),
616                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),
617                                                         &quot;customfield_10008&quot;, JSON.object()
618                                                                                  .put(&quot;id&quot;, 244)
619                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),
620                                                         &quot;customfield_10005&quot;, JSON.array()
621                                                                                  .add(JSON.object()
622                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)
623                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))
624                                                                                  .add(JSON.object()
625                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)
626                                                                                           .put(&quot;value&quot;, &quot;other&quot;))
627                                                  ));
628             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
629             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
630 
631             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
632             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
633             localRepo.push(editHash, repo.url(), &quot;master&quot;);
634             TestBotRunner.runPeriodicItems(notifyBot);
635 
636             // The fixVersion should not have been updated
637             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
638             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));
639             assertEquals(OPEN, updatedIssue.state());
640             assertEquals(List.of(), updatedIssue.assignees());
641 
642             // There should be a link
643             var links = updatedIssue.links();
644             assertEquals(1, links.size());
645             var link = links.get(0);
646             var backport = link.issue().orElseThrow();
647 
648             // The backport issue should have a correct fixVersion and assignee
649             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));
650             assertEquals(RESOLVED, backport.state());
651             assertEquals(List.of(issueProject.issueTracker().currentUser()), backport.assignees());
652 
653             // Custom properties should also propagate
654             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());
655             assertEquals(244, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;id&quot;).asInt());
656             assertEquals(&quot;java.io&quot;, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;name&quot;).asString());
657             assertEquals(2, backport.properties().get(&quot;customfield_10005&quot;).asArray().size());
658         }
659     }
660 
661     @Test
662     void testSyncLabels(TestInfo testInfo) throws IOException {
663         try (var credentials = new HostCredentials(testInfo);
664              var tempFolder = new TemporaryDirectory()) {
665             var repo = credentials.getHostedRepository();
666             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
667             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
668             credentials.commitLock(localRepo);
669             localRepo.pushAll(repo.url());
670 
671             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
672             var issueProject = credentials.getIssueProject();
673             var jbsNotifierConfig = JSON.object().put(&quot;fixversions&quot;, JSON.object().put(&quot;master&quot;, &quot;8u192&quot;));
674             var notifyBot = testBotBuilder(repo, issueProject, storageFolder, jbsNotifierConfig).create(&quot;notify&quot;, JSON.object());
675 
676             // Initialize database
677             TestBotRunner.runPeriodicItems(notifyBot);
678 
679             var issue1 = credentials.createIssue(issueProject, &quot;Issue 1&quot;);
680             issue1.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Bug&quot;));
681 
682             var issue2 = credentials.createIssue(issueProject, &quot;Issue 2&quot;);
683             issue2.setProperty(&quot;fixVersions&quot;, JSON.array().add(JSON.of(&quot;8u162&quot;)));
684             issue2.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Backport&quot;));
685             issue1.addLink(Link.create(issue2, &quot;backported by&quot;).build());
686 
687             var issue3 = credentials.createIssue(issueProject, &quot;Issue 3&quot;);
688             issue3.setProperty(&quot;fixVersions&quot;, JSON.array().add(JSON.of(&quot;10&quot;)));
689             issue3.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Backport&quot;));
690             issue1.addLink(Link.create(issue3, &quot;backported by&quot;).build());
691 
692             var issue4 = credentials.createIssue(issueProject, &quot;Issue 4&quot;);
693             issue4.setProperty(&quot;fixVersions&quot;, JSON.array().add(JSON.of(&quot;11&quot;)));
694             issue4.setProperty(&quot;issuetype&quot;, JSON.of(&quot;Backport&quot;));
695             issue1.addLink(Link.create(issue4, &quot;backported by&quot;).build());
696 
697             // Mention one of the issues
698             var commit = CheckableRepository.appendAndCommit(localRepo, &quot;Hello there&quot;, issue1.id() + &quot;: A fix&quot;);
699             localRepo.push(commit, repo.url(), &quot;master&quot;);
700             TestBotRunner.runPeriodicItems(notifyBot);
701 
702             assertEquals(List.of(&quot;hgupdater-sync&quot;), issue1.labels());
703             assertEquals(List.of(), issue2.labels());
704             assertEquals(List.of(), issue3.labels());
705             assertEquals(List.of(&quot;hgupdater-sync&quot;), issue4.labels());
706         }
707     }
708 }
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>