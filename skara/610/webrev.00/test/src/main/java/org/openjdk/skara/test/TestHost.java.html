<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/src/main/java/org/openjdk/skara/test/TestHost.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.test;
 24 
 25 import org.openjdk.skara.forge.*;
 26 import org.openjdk.skara.host.*;
 27 import org.openjdk.skara.issuetracker.*;
 28 import org.openjdk.skara.json.JSONValue;
 29 import org.openjdk.skara.vcs.*;
 30 
 31 import java.io.*;
 32 import java.nio.charset.StandardCharsets;
 33 import java.nio.file.*;
 34 import java.util.*;
 35 import java.util.logging.Logger;
 36 import java.util.stream.Collectors;
 37 
 38 public class TestHost implements Forge, IssueTracker {
 39     private final int currentUser;
 40     private HostData data;
 41     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.test&quot;);
 42 
 43     private static class HostData {
 44         final List&lt;HostUser&gt; users = new ArrayList&lt;&gt;();
 45         final Map&lt;String, Repository&gt; repositories = new HashMap&lt;&gt;();
 46         final Map&lt;String, IssueProject&gt; issueProjects = new HashMap&lt;&gt;();
 47         final Set&lt;TemporaryDirectory&gt; folders = new HashSet&lt;&gt;();
 48         private final Map&lt;String, TestPullRequest&gt; pullRequests = new HashMap&lt;&gt;();
 49         private final Map&lt;String, TestIssue&gt; issues = new HashMap&lt;&gt;();
 50     }
 51 
 52     private Repository createLocalRepository() {
 53         var folder = new TemporaryDirectory();
 54         data.folders.add(folder);
 55         try {
 56             var repo = Repository.init(folder.path().resolve(&quot;hosted.git&quot;), VCS.GIT);
 57             Files.writeString(repo.root().resolve(&quot;content.txt&quot;), &quot;Initial content&quot;, StandardCharsets.UTF_8);
 58             repo.add(repo.root().resolve(&quot;content.txt&quot;));
 59             var hash = repo.commit(&quot;Initial content&quot;, &quot;author&quot;, &quot;author@none&quot;);
 60             repo.push(hash, repo.root().toUri(), &quot;testhostcontent&quot;);
 61             repo.checkout(hash, true);
 62             return repo;
 63         } catch (IOException e) {
 64             throw new UncheckedIOException(e);
 65         }
 66     }
 67 
 68     public static TestHost createNew(List&lt;HostUser&gt; users) {
 69         var data = new HostData();
 70         data.users.addAll(users);
 71         var host = new TestHost(data, 0);
 72         return host;
 73     }
 74 
 75     static TestHost createFromExisting(TestHost existing, int userIndex) {
 76         var host = new TestHost(existing.data, userIndex);
 77         return host;
 78     }
 79 
 80     private TestHost(HostData data, int currentUser) {
 81         this.data = data;
 82         this.currentUser = currentUser;
 83     }
 84 
 85     @Override
 86     public boolean isValid() {
 87         return true;
 88     }
 89 
 90     @Override
 91     public String name() {
 92         return &quot;Test&quot;;
 93     }
 94 
 95     @Override
 96     public Optional&lt;HostedRepository&gt; repository(String name) {
 97         Repository localRepository;
 98         if (data.repositories.containsKey(name)) {
 99             localRepository = data.repositories.get(name);
100         } else {
101             if (data.repositories.size() &gt; 0) {
102                 log.warning(&quot;A test host can only manage a single repository - reporting &quot; + name + &quot; as not found&quot;);
103                 return Optional.empty();
104             }
105             localRepository = createLocalRepository();
106             data.repositories.put(name, localRepository);
107         }
108         return Optional.of(new TestHostedRepository(this, name, localRepository));
109     }
110 
111     @Override
112     public IssueProject project(String name) {
113         if (data.issueProjects.containsKey(name)) {
114             return data.issueProjects.get(name);
115         } else {
116             if (data.issueProjects.size() &gt; 0) {
117                 throw new RuntimeException(&quot;A test host can only manage a single issue project&quot;);
118             }
119             var issueProject = new TestIssueProject(this, name);
120             data.issueProjects.put(name, issueProject);
121             return issueProject;
122         }
123     }
124 
125     @Override
126     public Optional&lt;HostUser&gt; user(String username) {
127         return data.users.stream()
128                          .filter(user -&gt; user.userName().equals(username))
129                          .findAny();
130     }
131 
132     @Override
133     public HostUser currentUser() {
134         return data.users.get(currentUser);
135     }
136 
137     @Override
138     public boolean supportsReviewBody() {
139         return true;
140     }
141 
142     @Override
143     public boolean isMemberOf(String groupId, HostUser user) {
144         return false;
145     }
146 
147     void close() {
148         if (currentUser == 0) {
149             data.folders.forEach(TemporaryDirectory::close);
150         }
151     }
152 
153     TestPullRequest createPullRequest(TestHostedRepository targetRepository, TestHostedRepository sourceRepository, String targetRef, String sourceRef, String title, List&lt;String&gt; body, boolean draft) {
154         var id = String.valueOf(data.pullRequests.size() + 1);
155         var pr = TestPullRequest.createNew(targetRepository, sourceRepository, id, targetRef, sourceRef, title, body, draft);
156         data.pullRequests.put(id, pr);
157         return pr;
158     }
159 
160     TestPullRequest getPullRequest(TestHostedRepository repository, String id) {
161         var original = data.pullRequests.get(id);
162         return TestPullRequest.createFrom(repository, original);
163     }
164 
165     List&lt;TestPullRequest&gt; getPullRequests(TestHostedRepository repository) {
166         return data.pullRequests.entrySet().stream()
167                                 .sorted(Comparator.comparing(Map.Entry::getKey))
168                                 .map(pr -&gt; getPullRequest(repository, pr.getKey()))
169                                 .collect(Collectors.toList());
170     }
171 
172     TestIssue createIssue(TestIssueProject issueProject, String title, List&lt;String&gt; body, Map&lt;String, JSONValue&gt; properties) {
173         var id = issueProject.projectName().toUpperCase() + &quot;-&quot; + (data.issues.size() + 1);
174         var issue = TestIssue.createNew(issueProject, id, title, body, properties);
175         data.issues.put(id ,issue);
176         return issue;
177     }
178 
179     TestIssue getIssue(TestIssueProject issueProject, String id) {
180         var original = data.issues.get(id);
181         if (original == null) {
182             return null;
183         }
184         return TestIssue.createFrom(issueProject, original);
185     }
186 
187     List&lt;TestIssue&gt; getIssues(TestIssueProject issueProject) {
188         return data.issues.entrySet().stream()
189                           .sorted(Comparator.comparing(Map.Entry::getKey))
190                           .map(issue -&gt; getIssue(issueProject, issue.getKey()))
191                           .filter(i -&gt; i.state().equals(Issue.State.OPEN))
192                           .collect(Collectors.toList());
193     }
194 }
    </pre>
  </body>
</html>