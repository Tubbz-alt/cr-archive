<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../email/src/main/java/org/openjdk/skara/email/Email.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 105     @Test
 106     void simpleArchive(TestInfo testInfo) throws IOException {
 107         try (var credentials = new HostCredentials(testInfo);
 108              var tempFolder = new TemporaryDirectory();
 109              var archiveFolder = new TemporaryDirectory();
 110              var webrevFolder = new TemporaryDirectory();
 111              var listServer = new TestMailmanServer();
 112              var webrevServer = new TestWebrevServer()) {
 113             var author = credentials.getHostedRepository();
 114             var archive = credentials.getHostedRepository();
 115             var ignored = credentials.getHostedRepository();
 116             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 117             var censusBuilder = credentials.getCensusBuilder()
 118                                            .addAuthor(author.forge().currentUser().id());
 119             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 120             var mlBot = MailingListBridgeBot.newBuilder()
 121                                             .from(from)
 122                                             .repo(author)
 123                                             .archive(archive)
 124                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 125                                             .list(listAddress)</span>
 126                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 127                                             .ignoredComments(Set.of())
 128                                             .listArchive(listServer.getArchive())
 129                                             .smtpServer(listServer.getSMTP())
 130                                             .webrevStorageRepository(archive)
 131                                             .webrevStorageRef(&quot;webrev&quot;)
 132                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 133                                             .webrevStorageBaseUri(webrevServer.uri())
 134                                             .readyLabels(Set.of(&quot;rfr&quot;))
 135                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 137                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 138                                             .sendInterval(Duration.ZERO)
 139                                             .build();
 140 
 141             // Populate the projects repository
 142             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 143             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 144             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 145             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
</pre>
<hr />
<pre>
 273     @Test
 274     void archiveIntegrated(TestInfo testInfo) throws IOException {
 275         try (var credentials = new HostCredentials(testInfo);
 276              var tempFolder = new TemporaryDirectory();
 277              var archiveFolder = new TemporaryDirectory();
 278              var webrevFolder = new TemporaryDirectory();
 279              var listServer = new TestMailmanServer();
 280              var webrevServer = new TestWebrevServer()) {
 281             var author = credentials.getHostedRepository();
 282             var archive = credentials.getHostedRepository();
 283             var ignored = credentials.getHostedRepository();
 284             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 285             var censusBuilder = credentials.getCensusBuilder()
 286                                            .addAuthor(author.forge().currentUser().id());
 287             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 288             var mlBot = MailingListBridgeBot.newBuilder()
 289                                             .from(from)
 290                                             .repo(author)
 291                                             .archive(archive)
 292                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 293                                             .list(listAddress)</span>
 294                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 295                                             .listArchive(listServer.getArchive())
 296                                             .smtpServer(listServer.getSMTP())
 297                                             .webrevStorageRepository(archive)
 298                                             .webrevStorageRef(&quot;webrev&quot;)
 299                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 300                                             .webrevStorageBaseUri(webrevServer.uri())
 301                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 302                                             .build();
 303 
 304             // Populate the projects repository
 305             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 306             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 307             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 308             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 309 
 310             // Make a change with a corresponding PR
 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 312                                                                &quot;Change msg\n\nWith several lines&quot;);
 313             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
 339             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 340         }
 341     }
 342 
 343     @Test
 344     void archiveLegacyIntegrated(TestInfo testInfo) throws IOException {
 345         try (var credentials = new HostCredentials(testInfo);
 346              var tempFolder = new TemporaryDirectory();
 347              var archiveFolder = new TemporaryDirectory();
 348              var webrevFolder = new TemporaryDirectory();
 349              var listServer = new TestMailmanServer();
 350              var webrevServer = new TestWebrevServer()) {
 351             var author = credentials.getHostedRepository();
 352             var archive = credentials.getHostedRepository();
 353             var ignored = credentials.getHostedRepository();
 354             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 355             var censusBuilder = credentials.getCensusBuilder()
 356                     .addAuthor(author.forge().currentUser().id());
 357             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 358             var mlBot = MailingListBridgeBot.newBuilder()
<span class="line-modified"> 359                     .from(from)</span>
<span class="line-modified"> 360                     .repo(author)</span>
<span class="line-modified"> 361                     .archive(archive)</span>
<span class="line-modified"> 362                     .censusRepo(censusBuilder.build())</span>
<span class="line-modified"> 363                     .list(listAddress)</span>
<span class="line-modified"> 364                     .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))</span>
<span class="line-modified"> 365                     .listArchive(listServer.getArchive())</span>
<span class="line-modified"> 366                     .smtpServer(listServer.getSMTP())</span>
<span class="line-modified"> 367                     .webrevStorageRepository(archive)</span>
<span class="line-modified"> 368                     .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-modified"> 369                     .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-modified"> 370                     .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-modified"> 371                     .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-modified"> 372                     .build();</span>
 373 
 374             // Populate the projects repository
 375             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 376             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 377             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 378             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 379 
 380             // Make a change with a corresponding PR with a date in the past
 381             var editFile = tempFolder.path().resolve(&quot;change.txt&quot;);
 382             Files.writeString(editFile, &quot;A simple change&quot;);
 383             localRepo.add(editFile);
 384             var commitDate = ZonedDateTime.of(2020, 3, 12, 0, 0, 0, 0, ZoneId.of(&quot;UTC&quot;));
 385             var editHash = localRepo.commit(&quot;An old change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate,
 386                              &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate);
 387             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 388             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 389             pr.setBody(&quot;This is now ready&quot;);
 390             pr.addLabel(&quot;rfr&quot;);
 391 
 392             // Run an archive pass
</pre>
<hr />
<pre>
 417     @Test
 418     void archiveDirectToIntegrated(TestInfo testInfo) throws IOException {
 419         try (var credentials = new HostCredentials(testInfo);
 420              var tempFolder = new TemporaryDirectory();
 421              var archiveFolder = new TemporaryDirectory();
 422              var webrevFolder = new TemporaryDirectory();
 423              var listServer = new TestMailmanServer();
 424              var webrevServer = new TestWebrevServer()) {
 425             var author = credentials.getHostedRepository();
 426             var archive = credentials.getHostedRepository();
 427             var ignored = credentials.getHostedRepository();
 428             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 429             var censusBuilder = credentials.getCensusBuilder()
 430                                            .addAuthor(author.forge().currentUser().id());
 431             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 432             var mlBot = MailingListBridgeBot.newBuilder()
 433                                             .from(from)
 434                                             .repo(author)
 435                                             .archive(archive)
 436                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 437                                             .list(listAddress)</span>
 438                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 439                                             .listArchive(listServer.getArchive())
 440                                             .smtpServer(listServer.getSMTP())
 441                                             .webrevStorageRepository(archive)
 442                                             .webrevStorageRef(&quot;webrev&quot;)
 443                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 444                                             .webrevStorageBaseUri(webrevServer.uri())
 445                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 446                                             .build();
 447 
 448             // Populate the projects repository
 449             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 450             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 451             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 452             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 453 
 454             // Make a change with a corresponding PR
 455             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 456                                                                &quot;Change msg\n\nWith several lines&quot;);
 457             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
 496     @Test
 497     void archiveIntegratedRetainPrefix(TestInfo testInfo) throws IOException {
 498         try (var credentials = new HostCredentials(testInfo);
 499              var tempFolder = new TemporaryDirectory();
 500              var archiveFolder = new TemporaryDirectory();
 501              var webrevFolder = new TemporaryDirectory();
 502              var listServer = new TestMailmanServer();
 503              var webrevServer = new TestWebrevServer()) {
 504             var author = credentials.getHostedRepository();
 505             var archive = credentials.getHostedRepository();
 506             var ignored = credentials.getHostedRepository();
 507             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 508             var censusBuilder = credentials.getCensusBuilder()
 509                                            .addAuthor(author.forge().currentUser().id());
 510             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 511             var mlBot = MailingListBridgeBot.newBuilder()
 512                                             .from(from)
 513                                             .repo(author)
 514                                             .archive(archive)
 515                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 516                                             .list(listAddress)</span>
 517                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 518                                             .listArchive(listServer.getArchive())
 519                                             .smtpServer(listServer.getSMTP())
 520                                             .webrevStorageRepository(archive)
 521                                             .webrevStorageRef(&quot;webrev&quot;)
 522                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 523                                             .webrevStorageBaseUri(webrevServer.uri())
 524                                             .readyLabels(Set.of(&quot;rfr&quot;))
 525                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 526                                             .build();
 527 
 528             // Populate the projects repository
 529             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 530             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 531             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 532             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 533 
 534             // Make a change with a corresponding PR
 535             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 536                                                                &quot;Change msg\n\nWith several lines&quot;);
</pre>
<hr />
<pre>
 573     @Test
 574     void archiveClosed(TestInfo testInfo) throws IOException {
 575         try (var credentials = new HostCredentials(testInfo);
 576              var tempFolder = new TemporaryDirectory();
 577              var archiveFolder = new TemporaryDirectory();
 578              var webrevFolder = new TemporaryDirectory();
 579              var listServer = new TestMailmanServer();
 580              var webrevServer = new TestWebrevServer()) {
 581             var author = credentials.getHostedRepository();
 582             var archive = credentials.getHostedRepository();
 583             var ignored = credentials.getHostedRepository();
 584             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 585             var censusBuilder = credentials.getCensusBuilder()
 586                                            .addAuthor(author.forge().currentUser().id());
 587             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 588             var mlBot = MailingListBridgeBot.newBuilder()
 589                                             .from(from)
 590                                             .repo(author)
 591                                             .archive(archive)
 592                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 593                                             .list(listAddress)</span>
 594                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 595                                             .listArchive(listServer.getArchive())
 596                                             .smtpServer(listServer.getSMTP())
 597                                             .webrevStorageRepository(archive)
 598                                             .webrevStorageRef(&quot;webrev&quot;)
 599                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 600                                             .webrevStorageBaseUri(webrevServer.uri())
 601                                             .readyLabels(Set.of(&quot;rfr&quot;))
 602                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 603                                             .build();
 604 
 605             // Populate the projects repository
 606             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 607             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 608             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 609             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 610 
 611             // Make a change with a corresponding PR
 612             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 613                                                                &quot;Change msg\n\nWith several lines&quot;);
</pre>
<hr />
<pre>
 656     @Test
 657     void archiveFailedAutoMerge(TestInfo testInfo) throws IOException {
 658         try (var credentials = new HostCredentials(testInfo);
 659              var tempFolder = new TemporaryDirectory();
 660              var archiveFolder = new TemporaryDirectory();
 661              var webrevFolder = new TemporaryDirectory();
 662              var listServer = new TestMailmanServer();
 663              var webrevServer = new TestWebrevServer()) {
 664             var author = credentials.getHostedRepository();
 665             var archive = credentials.getHostedRepository();
 666             var ignored = credentials.getHostedRepository();
 667             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 668             var censusBuilder = credentials.getCensusBuilder()
 669                                            .addAuthor(author.forge().currentUser().id());
 670             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 671             var mlBot = MailingListBridgeBot.newBuilder()
 672                                             .from(from)
 673                                             .repo(author)
 674                                             .archive(archive)
 675                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 676                                             .list(listAddress)</span>
 677                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 678                                             .listArchive(listServer.getArchive())
 679                                             .smtpServer(listServer.getSMTP())
 680                                             .webrevStorageRepository(archive)
 681                                             .webrevStorageRef(&quot;webrev&quot;)
 682                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 683                                             .webrevStorageBaseUri(webrevServer.uri())
 684                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 685                                             .build();
 686 
 687             // Populate the projects repository
 688             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 689             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 690             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 691             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 692 
 693             // Make a change with a corresponding PR
 694             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 695                                                                &quot;Change msg\n\nWith several lines&quot;);
 696             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
 710 
 711     @Test
 712     void reviewComment(TestInfo testInfo) throws IOException {
 713         try (var credentials = new HostCredentials(testInfo);
 714              var tempFolder = new TemporaryDirectory();
 715              var archiveFolder = new TemporaryDirectory();
 716              var listServer = new TestMailmanServer();
 717              var webrevServer = new TestWebrevServer()) {
 718             var author = credentials.getHostedRepository();
 719             var archive = credentials.getHostedRepository();
 720             var ignored = credentials.getHostedRepository();
 721             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 722             var censusBuilder = credentials.getCensusBuilder()
 723                                            .addAuthor(author.forge().currentUser().id());
 724             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 725             var mlBot = MailingListBridgeBot.newBuilder()
 726                                             .from(from)
 727                                             .repo(author)
 728                                             .archive(archive)
 729                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 730                                             .list(listAddress)</span>
 731                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 732                                             .listArchive(listServer.getArchive())
 733                                             .smtpServer(listServer.getSMTP())
 734                                             .webrevStorageRepository(archive)
 735                                             .webrevStorageRef(&quot;webrev&quot;)
 736                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 737                                             .webrevStorageBaseUri(webrevServer.uri())
 738                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 739                                             .build();
 740 
 741             // Populate the projects repository
 742             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 743             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 744             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 745             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 746             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 747 
 748             // Make a change with a corresponding PR
 749             var editHash = CheckableRepository.appendAndCommit(localRepo);
 750             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
 805     }
 806 
 807     @Test
 808     void combineComments(TestInfo testInfo) throws IOException {
 809         try (var credentials = new HostCredentials(testInfo);
 810              var tempFolder = new TemporaryDirectory();
 811              var archiveFolder = new TemporaryDirectory();
 812              var listServer = new TestMailmanServer();
 813              var webrevServer = new TestWebrevServer()) {
 814             var author = credentials.getHostedRepository();
 815             var archive = credentials.getHostedRepository();
 816             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 817             var censusBuilder = credentials.getCensusBuilder()
 818                                            .addAuthor(author.forge().currentUser().id());
 819             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 820             var mlBot = MailingListBridgeBot.newBuilder()
 821                                             .from(from)
 822                                             .repo(author)
 823                                             .archive(archive)
 824                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 825                                             .list(listAddress)</span>
 826                                             .listArchive(listServer.getArchive())
 827                                             .smtpServer(listServer.getSMTP())
 828                                             .webrevStorageRepository(archive)
 829                                             .webrevStorageRef(&quot;webrev&quot;)
 830                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 831                                             .webrevStorageBaseUri(webrevServer.uri())
 832                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 833                                             .build();
 834 
 835             // Populate the projects repository
 836             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 837             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 838             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 839             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 840             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 841 
 842             // Make a change with a corresponding PR
 843             var editHash = CheckableRepository.appendAndCommit(localRepo);
 844             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 845             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
 900     @Test
 901     void commentThreading(TestInfo testInfo) throws IOException {
 902         try (var credentials = new HostCredentials(testInfo);
 903              var tempFolder = new TemporaryDirectory();
 904              var archiveFolder = new TemporaryDirectory();
 905              var listServer = new TestMailmanServer();
 906              var webrevServer = new TestWebrevServer()) {
 907             var author = credentials.getHostedRepository();
 908             var reviewer = credentials.getHostedRepository();
 909             var archive = credentials.getHostedRepository();
 910             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 911             var censusBuilder = credentials.getCensusBuilder()
 912                                            .addReviewer(reviewer.forge().currentUser().id())
 913                                            .addAuthor(author.forge().currentUser().id());
 914             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 915             var mlBot = MailingListBridgeBot.newBuilder()
 916                                             .from(from)
 917                                             .repo(author)
 918                                             .archive(archive)
 919                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 920                                             .list(listAddress)</span>
 921                                             .listArchive(listServer.getArchive())
 922                                             .smtpServer(listServer.getSMTP())
 923                                             .webrevStorageRepository(archive)
 924                                             .webrevStorageRef(&quot;webrev&quot;)
 925                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 926                                             .webrevStorageBaseUri(webrevServer.uri())
 927                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 928                                             .build();
 929 
 930             // Populate the projects repository
 931             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 932             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 933             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 934             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 935             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 936 
 937             // Make a change with a corresponding PR
 938             var editHash = CheckableRepository.appendAndCommit(localRepo);
 939             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 940             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1029     @Test
1030     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
1031         try (var credentials = new HostCredentials(testInfo);
1032              var tempFolder = new TemporaryDirectory();
1033              var archiveFolder = new TemporaryDirectory();
1034              var listServer = new TestMailmanServer();
1035              var webrevServer = new TestWebrevServer()) {
1036             var author = credentials.getHostedRepository();
1037             var reviewer = credentials.getHostedRepository();
1038             var archive = credentials.getHostedRepository();
1039             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1040             var censusBuilder = credentials.getCensusBuilder()
1041                                            .addReviewer(reviewer.forge().currentUser().id())
1042                                            .addAuthor(author.forge().currentUser().id());
1043             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1044             var mlBot = MailingListBridgeBot.newBuilder()
1045                                             .from(from)
1046                                             .repo(author)
1047                                             .archive(archive)
1048                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1049                                             .list(listAddress)</span>
1050                                             .listArchive(listServer.getArchive())
1051                                             .smtpServer(listServer.getSMTP())
1052                                             .webrevStorageRepository(archive)
1053                                             .webrevStorageRef(&quot;webrev&quot;)
1054                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1055                                             .webrevStorageBaseUri(webrevServer.uri())
1056                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1057                                             .build();
1058 
1059             // Populate the projects repository
1060             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1061             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1062             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1063             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1064             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1065 
1066             // Make a change with a corresponding PR
1067             var editHash = CheckableRepository.appendAndCommit(localRepo);
1068             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1069             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1092     @Test
1093     void commentWithMention(TestInfo testInfo) throws IOException {
1094         try (var credentials = new HostCredentials(testInfo);
1095              var tempFolder = new TemporaryDirectory();
1096              var archiveFolder = new TemporaryDirectory();
1097              var listServer = new TestMailmanServer();
1098              var webrevServer = new TestWebrevServer()) {
1099             var author = credentials.getHostedRepository();
1100             var reviewer = credentials.getHostedRepository();
1101             var archive = credentials.getHostedRepository();
1102             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1103             var censusBuilder = credentials.getCensusBuilder()
1104                                            .addReviewer(reviewer.forge().currentUser().id())
1105                                            .addAuthor(author.forge().currentUser().id());
1106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1107             var mlBot = MailingListBridgeBot.newBuilder()
1108                                             .from(from)
1109                                             .repo(author)
1110                                             .archive(archive)
1111                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1112                                             .list(listAddress)</span>
1113                                             .listArchive(listServer.getArchive())
1114                                             .smtpServer(listServer.getSMTP())
1115                                             .webrevStorageRepository(archive)
1116                                             .webrevStorageRef(&quot;webrev&quot;)
1117                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1118                                             .webrevStorageBaseUri(webrevServer.uri())
1119                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1120                                             .build();
1121 
1122             // Populate the projects repository
1123             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1124             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1125             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1126             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1127             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1128 
1129             // Make a change with a corresponding PR
1130             var editHash = CheckableRepository.appendAndCommit(localRepo);
1131             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1132             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1156     @Test
1157     void reviewCommentWithMention(TestInfo testInfo) throws IOException {
1158         try (var credentials = new HostCredentials(testInfo);
1159              var tempFolder = new TemporaryDirectory();
1160              var archiveFolder = new TemporaryDirectory();
1161              var listServer = new TestMailmanServer();
1162              var webrevServer = new TestWebrevServer()) {
1163             var author = credentials.getHostedRepository();
1164             var reviewer = credentials.getHostedRepository();
1165             var archive = credentials.getHostedRepository();
1166             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1167             var censusBuilder = credentials.getCensusBuilder()
1168                                            .addReviewer(reviewer.forge().currentUser().id())
1169                                            .addAuthor(author.forge().currentUser().id());
1170             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1171             var mlBot = MailingListBridgeBot.newBuilder()
1172                                             .from(from)
1173                                             .repo(author)
1174                                             .archive(archive)
1175                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1176                                             .list(listAddress)</span>
1177                                             .listArchive(listServer.getArchive())
1178                                             .smtpServer(listServer.getSMTP())
1179                                             .webrevStorageRepository(archive)
1180                                             .webrevStorageRef(&quot;webrev&quot;)
1181                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1182                                             .webrevStorageBaseUri(webrevServer.uri())
1183                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1184                                             .build();
1185 
1186             // Populate the projects repository
1187             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1188             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1189             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1190             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1191             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1192 
1193             // Make a change with a corresponding PR
1194             var editHash = CheckableRepository.appendAndCommit(localRepo);
1195             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1196             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1221     @Test
1222     void commentWithQuote(TestInfo testInfo) throws IOException {
1223         try (var credentials = new HostCredentials(testInfo);
1224              var tempFolder = new TemporaryDirectory();
1225              var archiveFolder = new TemporaryDirectory();
1226              var listServer = new TestMailmanServer();
1227              var webrevServer = new TestWebrevServer()) {
1228             var author = credentials.getHostedRepository();
1229             var reviewer = credentials.getHostedRepository();
1230             var archive = credentials.getHostedRepository();
1231             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1232             var censusBuilder = credentials.getCensusBuilder()
1233                                            .addReviewer(reviewer.forge().currentUser().id())
1234                                            .addAuthor(author.forge().currentUser().id());
1235             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1236             var mlBot = MailingListBridgeBot.newBuilder()
1237                                             .from(from)
1238                                             .repo(author)
1239                                             .archive(archive)
1240                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1241                                             .list(listAddress)</span>
1242                                             .listArchive(listServer.getArchive())
1243                                             .smtpServer(listServer.getSMTP())
1244                                             .webrevStorageRepository(archive)
1245                                             .webrevStorageRef(&quot;webrev&quot;)
1246                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1247                                             .webrevStorageBaseUri(webrevServer.uri())
1248                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1249                                             .build();
1250 
1251             // Populate the projects repository
1252             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1253             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1254             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1255             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1256             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1257 
1258             // Make a change with a corresponding PR
1259             var editHash = CheckableRepository.appendAndCommit(localRepo);
1260             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1261             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1284     }
1285 
1286     @Test
1287     void reviewContext(TestInfo testInfo) throws IOException {
1288         try (var credentials = new HostCredentials(testInfo);
1289              var tempFolder = new TemporaryDirectory();
1290              var archiveFolder = new TemporaryDirectory();
1291              var listServer = new TestMailmanServer();
1292              var webrevServer = new TestWebrevServer()) {
1293             var author = credentials.getHostedRepository();
1294             var archive = credentials.getHostedRepository();
1295             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1296             var censusBuilder = credentials.getCensusBuilder()
1297                                            .addAuthor(author.forge().currentUser().id());
1298             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1299             var mlBot = MailingListBridgeBot.newBuilder()
1300                                             .from(from)
1301                                             .repo(author)
1302                                             .archive(archive)
1303                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1304                                             .list(listAddress)</span>
1305                                             .listArchive(listServer.getArchive())
1306                                             .smtpServer(listServer.getSMTP())
1307                                             .webrevStorageRepository(archive)
1308                                             .webrevStorageRef(&quot;webrev&quot;)
1309                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1310                                             .webrevStorageBaseUri(webrevServer.uri())
1311                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1312                                             .build();
1313 
1314             // Populate the projects repository
1315             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1316             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1317             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1318             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1319             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1320 
1321             // Make a change with a corresponding PR
1322             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1323             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1324             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1341     }
1342 
1343     @Test
1344     void multipleReviewContexts(TestInfo testInfo) throws IOException {
1345         try (var credentials = new HostCredentials(testInfo);
1346              var tempFolder = new TemporaryDirectory();
1347              var archiveFolder = new TemporaryDirectory();
1348              var listServer = new TestMailmanServer();
1349              var webrevServer = new TestWebrevServer()) {
1350             var author = credentials.getHostedRepository();
1351             var archive = credentials.getHostedRepository();
1352             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1353             var censusBuilder = credentials.getCensusBuilder()
1354                                            .addAuthor(author.forge().currentUser().id());
1355             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1356             var mlBot = MailingListBridgeBot.newBuilder()
1357                                             .from(from)
1358                                             .repo(author)
1359                                             .archive(archive)
1360                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1361                                             .list(listAddress)</span>
1362                                             .listArchive(listServer.getArchive())
1363                                             .smtpServer(listServer.getSMTP())
1364                                             .webrevStorageRepository(archive)
1365                                             .webrevStorageRef(&quot;webrev&quot;)
1366                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1367                                             .webrevStorageBaseUri(webrevServer.uri())
1368                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1369                                             .build();
1370 
1371             // Populate the projects repository
1372             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1373             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1374             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1375             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1376             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1377             var initialHash = CheckableRepository.appendAndCommit(localRepo,
1378                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
1379                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
1380                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
1381                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
</pre>
<hr />
<pre>
1417     }
1418 
1419     @Test
1420     void filterComments(TestInfo testInfo) throws IOException {
1421         try (var credentials = new HostCredentials(testInfo);
1422              var tempFolder = new TemporaryDirectory();
1423              var archiveFolder = new TemporaryDirectory();
1424              var listServer = new TestMailmanServer();
1425              var webrevServer = new TestWebrevServer()) {
1426             var author = credentials.getHostedRepository();
1427             var archive = credentials.getHostedRepository();
1428             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1429             var censusBuilder = credentials.getCensusBuilder()
1430                                            .addAuthor(author.forge().currentUser().id());
1431             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1432             var mlBot = MailingListBridgeBot.newBuilder()
1433                                             .from(from)
1434                                             .repo(author)
1435                                             .archive(archive)
1436                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1437                                             .list(listAddress)</span>
1438                                             .listArchive(listServer.getArchive())
1439                                             .smtpServer(listServer.getSMTP())
1440                                             .webrevStorageRepository(archive)
1441                                             .webrevStorageRef(&quot;webrev&quot;)
1442                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1443                                             .webrevStorageBaseUri(webrevServer.uri())
1444                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1445                                             .build();
1446 
1447             // Populate the projects repository
1448             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1449             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1450             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1451             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1452             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1453 
1454             // Make a change with a corresponding PR
1455             var editHash = CheckableRepository.appendAndCommit(localRepo);
1456             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1457             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1483 
1484     @Test
1485     void incrementalChanges(TestInfo testInfo) throws IOException {
1486         try (var credentials = new HostCredentials(testInfo);
1487              var tempFolder = new TemporaryDirectory();
1488              var archiveFolder = new TemporaryDirectory();
1489              var listServer = new TestMailmanServer();
1490              var webrevServer = new TestWebrevServer()) {
1491             var author = credentials.getHostedRepository();
1492             var archive = credentials.getHostedRepository();
1493             var commenter = credentials.getHostedRepository();
1494             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1495             var censusBuilder = credentials.getCensusBuilder()
1496                                            .addAuthor(author.forge().currentUser().id());
1497             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1498             var mlBot = MailingListBridgeBot.newBuilder()
1499                                             .from(from)
1500                                             .repo(author)
1501                                             .archive(archive)
1502                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1503                                             .list(listAddress)</span>
1504                                             .listArchive(listServer.getArchive())
1505                                             .smtpServer(listServer.getSMTP())
1506                                             .webrevStorageRepository(archive)
1507                                             .webrevStorageRef(&quot;webrev&quot;)
1508                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1509                                             .webrevStorageBaseUri(webrevServer.uri())
1510                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1511                                             .build();
1512 
1513             // Populate the projects repository
1514             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1515             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1516             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1517             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1518             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1519 
1520             // Make a change with a corresponding PR
1521             var editHash = CheckableRepository.appendAndCommit(localRepo);
1522             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1523             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1613     }
1614 
1615     @Test
1616     void rebased(TestInfo testInfo) throws IOException {
1617         try (var credentials = new HostCredentials(testInfo);
1618              var tempFolder = new TemporaryDirectory();
1619              var archiveFolder = new TemporaryDirectory();
1620              var listServer = new TestMailmanServer();
1621              var webrevServer = new TestWebrevServer()) {
1622             var author = credentials.getHostedRepository();
1623             var archive = credentials.getHostedRepository();
1624             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1625             var censusBuilder = credentials.getCensusBuilder()
1626                                            .addAuthor(author.forge().currentUser().id());
1627             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1628             var mlBot = MailingListBridgeBot.newBuilder()
1629                                             .from(sender)
1630                                             .repo(author)
1631                                             .archive(archive)
1632                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1633                                             .list(listAddress)</span>
1634                                             .listArchive(listServer.getArchive())
1635                                             .smtpServer(listServer.getSMTP())
1636                                             .webrevStorageRepository(archive)
1637                                             .webrevStorageRef(&quot;webrev&quot;)
1638                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1639                                             .webrevStorageBaseUri(webrevServer.uri())
1640                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1641                                             .build();
1642 
1643             // Populate the projects repository
1644             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1645             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1646             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1647             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1648             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1649 
1650             // Make a change with a corresponding PR
1651             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1652             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1653             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1710 
1711     @Test
1712     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1713         try (var credentials = new HostCredentials(testInfo);
1714              var tempFolder = new TemporaryDirectory();
1715              var archiveFolder = new TemporaryDirectory();
1716              var listServer = new TestMailmanServer();
1717              var webrevServer = new TestWebrevServer()) {
1718             var author = credentials.getHostedRepository();
1719             var archive = credentials.getHostedRepository();
1720             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1721             var censusBuilder = credentials.getCensusBuilder()
1722                                            .addAuthor(author.forge().currentUser().id());
1723             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1724             var mlBot = MailingListBridgeBot.newBuilder()
1725                                             .from(sender)
1726                                             .repo(author)
1727                                             .archive(archive)
1728                                             .archiveRef(&quot;archive&quot;)
1729                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1730                                             .list(listAddress)</span>
1731                                             .listArchive(listServer.getArchive())
1732                                             .smtpServer(listServer.getSMTP())
1733                                             .webrevStorageRepository(archive)
1734                                             .webrevStorageRef(&quot;webrev&quot;)
1735                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1736                                             .webrevStorageBaseUri(webrevServer.uri())
1737                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1738                                             .build();
1739 
1740             // Populate the projects repository
1741             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1742             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1743             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1744             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1745             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1746             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1747 
1748             // Make a change with a corresponding PR
1749             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1750             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
1800     @Test
1801     void mergeWebrev(TestInfo testInfo) throws IOException {
1802         try (var credentials = new HostCredentials(testInfo);
1803              var tempFolder = new TemporaryDirectory();
1804              var archiveFolder = new TemporaryDirectory();
1805              var listServer = new TestMailmanServer();
1806              var webrevServer = new TestWebrevServer()) {
1807             var author = credentials.getHostedRepository();
1808             var archive = credentials.getHostedRepository();
1809             var commenter = credentials.getHostedRepository();
1810             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1811             var censusBuilder = credentials.getCensusBuilder()
1812                                            .addAuthor(author.forge().currentUser().id());
1813             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1814             var mlBot = MailingListBridgeBot.newBuilder()
1815                                             .from(from)
1816                                             .repo(author)
1817                                             .archive(archive)
1818                                             .archiveRef(&quot;archive&quot;)
1819                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1820                                             .list(listAddress)</span>
1821                                             .listArchive(listServer.getArchive())
1822                                             .smtpServer(listServer.getSMTP())
1823                                             .webrevStorageRepository(archive)
1824                                             .webrevStorageRef(&quot;webrev&quot;)
1825                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1826                                             .webrevStorageBaseUri(webrevServer.uri())
1827                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1828                                             .build();
1829 
1830             // Populate the projects repository
1831             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1832             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1833             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1834             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1835             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1836             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1837 
1838             // Create a diverging branch
1839             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1840             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
</pre>
<hr />
<pre>
1886     @Test
1887     void mergeWebrevConflict(TestInfo testInfo) throws IOException {
1888         try (var credentials = new HostCredentials(testInfo);
1889              var tempFolder = new TemporaryDirectory();
1890              var archiveFolder = new TemporaryDirectory();
1891              var listServer = new TestMailmanServer();
1892              var webrevServer = new TestWebrevServer()) {
1893             var author = credentials.getHostedRepository();
1894             var archive = credentials.getHostedRepository();
1895             var commenter = credentials.getHostedRepository();
1896             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1897             var censusBuilder = credentials.getCensusBuilder()
1898                                            .addAuthor(author.forge().currentUser().id());
1899             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1900             var mlBot = MailingListBridgeBot.newBuilder()
1901                                             .from(from)
1902                                             .repo(author)
1903                                             .archive(archive)
1904                                             .archiveRef(&quot;archive&quot;)
1905                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1906                                             .list(listAddress)</span>
1907                                             .listArchive(listServer.getArchive())
1908                                             .smtpServer(listServer.getSMTP())
1909                                             .webrevStorageRepository(archive)
1910                                             .webrevStorageRef(&quot;webrev&quot;)
1911                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1912                                             .webrevStorageBaseUri(webrevServer.uri())
1913                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1914                                             .build();
1915 
1916             // Populate the projects repository
1917             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1918             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1919             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1920             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1921             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1922             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1923 
1924             // Create a merge
1925             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1926             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
</pre>
<hr />
<pre>
1958     @Test
1959     void mergeWebrevNoConflict(TestInfo testInfo) throws IOException {
1960         try (var credentials = new HostCredentials(testInfo);
1961              var tempFolder = new TemporaryDirectory();
1962              var archiveFolder = new TemporaryDirectory();
1963              var listServer = new TestMailmanServer();
1964              var webrevServer = new TestWebrevServer()) {
1965             var author = credentials.getHostedRepository();
1966             var archive = credentials.getHostedRepository();
1967             var commenter = credentials.getHostedRepository();
1968             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1969             var censusBuilder = credentials.getCensusBuilder()
1970                                            .addAuthor(author.forge().currentUser().id());
1971             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1972             var mlBot = MailingListBridgeBot.newBuilder()
1973                                             .from(from)
1974                                             .repo(author)
1975                                             .archive(archive)
1976                                             .archiveRef(&quot;archive&quot;)
1977                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1978                                             .list(listAddress)</span>
1979                                             .listArchive(listServer.getArchive())
1980                                             .smtpServer(listServer.getSMTP())
1981                                             .webrevStorageRepository(archive)
1982                                             .webrevStorageRef(&quot;webrev&quot;)
1983                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1984                                             .webrevStorageBaseUri(webrevServer.uri())
1985                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1986                                             .build();
1987 
1988             // Populate the projects repository
1989             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1990             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1991             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1992             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1993             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1994             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1995 
1996             // Create a merge
1997             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1998             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
</pre>
<hr />
<pre>
2028     @Test
2029     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
2030         try (var credentials = new HostCredentials(testInfo);
2031              var tempFolder = new TemporaryDirectory();
2032              var archiveFolder = new TemporaryDirectory();
2033              var webrevFolder = new TemporaryDirectory();
2034              var listServer = new TestMailmanServer();
2035              var webrevServer = new TestWebrevServer()) {
2036             var author = credentials.getHostedRepository();
2037             var archive = credentials.getHostedRepository();
2038             var ignored = credentials.getHostedRepository();
2039             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2040             var censusBuilder = credentials.getCensusBuilder()
2041                                            .addAuthor(author.forge().currentUser().id());
2042             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2043             var mlBot = MailingListBridgeBot.newBuilder()
2044                                             .from(from)
2045                                             .repo(author)
2046                                             .archive(archive)
2047                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2048                                             .list(listAddress)</span>
2049                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2050                                             .listArchive(listServer.getArchive())
2051                                             .smtpServer(listServer.getSMTP())
2052                                             .webrevStorageRepository(archive)
2053                                             .webrevStorageRef(&quot;webrev&quot;)
2054                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2055                                             .webrevStorageBaseUri(webrevServer.uri())
2056                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2057                                             .build();
2058 
2059             // Populate the projects repository
2060             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2061             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2062             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2063             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2064 
2065             // Make a change with a corresponding PR
2066             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2067                                                                &quot;Change msg\n\nWith several lines&quot;);
2068             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
2109     @Test
2110     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
2111         try (var credentials = new HostCredentials(testInfo);
2112              var tempFolder = new TemporaryDirectory();
2113              var archiveFolder = new TemporaryDirectory();
2114              var listServer = new TestMailmanServer();
2115              var webrevServer = new TestWebrevServer()) {
2116             var author = credentials.getHostedRepository();
2117             var archive = credentials.getHostedRepository();
2118             var reviewer = credentials.getHostedRepository();
2119             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2120             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2121             var censusBuilder = credentials.getCensusBuilder()
2122                                            .addReviewer(reviewer.forge().currentUser().id())
2123                                            .addAuthor(author.forge().currentUser().id());
2124             var mlBot = MailingListBridgeBot.newBuilder()
2125                                             .from(from)
2126                                             .repo(author)
2127                                             .archive(archive)
2128                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2129                                             .list(listAddress)</span>
2130                                             .listArchive(listServer.getArchive())
2131                                             .smtpServer(listServer.getSMTP())
2132                                             .webrevStorageRepository(archive)
2133                                             .webrevStorageRef(&quot;webrev&quot;)
2134                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2135                                             .webrevStorageBaseUri(webrevServer.uri())
2136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2137                                             .build();
2138 
2139             // Populate the projects repository
2140             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2141             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2142             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2143             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2144             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2145 
2146             // Make a change with a corresponding PR
2147             var editHash = CheckableRepository.appendAndCommit(localRepo);
2148             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2149             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
2198 
2199     @Test
2200     void ignoreComments(TestInfo testInfo) throws IOException {
2201         try (var credentials = new HostCredentials(testInfo);
2202              var tempFolder = new TemporaryDirectory();
2203              var archiveFolder = new TemporaryDirectory();
2204              var listServer = new TestMailmanServer();
2205              var webrevServer = new TestWebrevServer()) {
2206             var author = credentials.getHostedRepository();
2207             var ignored = credentials.getHostedRepository();
2208             var archive = credentials.getHostedRepository();
2209             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2210             var censusBuilder = credentials.getCensusBuilder()
2211                                            .addAuthor(author.forge().currentUser().id());
2212             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2213             var mlBot = MailingListBridgeBot.newBuilder()
2214                                             .from(from)
2215                                             .repo(author)
2216                                             .archive(archive)
2217                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2218                                             .list(listAddress)</span>
2219                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2220                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
2221                                             .listArchive(listServer.getArchive())
2222                                             .smtpServer(listServer.getSMTP())
2223                                             .webrevStorageRepository(archive)
2224                                             .webrevStorageRef(&quot;webrev&quot;)
2225                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2226                                             .webrevStorageBaseUri(webrevServer.uri())
2227                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2228                                             .build();
2229 
2230             // Populate the projects repository
2231             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2232             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2233             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2234             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2235             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2236 
2237             // Make a change with a corresponding PR
2238             var editHash = CheckableRepository.appendAndCommit(localRepo);
</pre>
<hr />
<pre>
2265     @Test
2266     void replyToEmptyReview(TestInfo testInfo) throws IOException {
2267         try (var credentials = new HostCredentials(testInfo);
2268              var tempFolder = new TemporaryDirectory();
2269              var archiveFolder = new TemporaryDirectory();
2270              var listServer = new TestMailmanServer();
2271              var webrevServer = new TestWebrevServer()) {
2272             var author = credentials.getHostedRepository();
2273             var reviewer = credentials.getHostedRepository();
2274             var archive = credentials.getHostedRepository();
2275             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2276             var censusBuilder = credentials.getCensusBuilder()
2277                                            .addReviewer(reviewer.forge().currentUser().id())
2278                                            .addAuthor(author.forge().currentUser().id());
2279             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2280             var mlBot = MailingListBridgeBot.newBuilder()
2281                                             .from(from)
2282                                             .repo(author)
2283                                             .archive(archive)
2284                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2285                                             .list(listAddress)</span>
2286                                             .listArchive(listServer.getArchive())
2287                                             .smtpServer(listServer.getSMTP())
2288                                             .webrevStorageRepository(archive)
2289                                             .webrevStorageRef(&quot;webrev&quot;)
2290                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2291                                             .webrevStorageBaseUri(webrevServer.uri())
2292                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2293                                             .build();
2294 
2295             // Populate the projects repository
2296             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2297             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2298             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2299             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2300             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2301 
2302             // Make a change with a corresponding PR
2303             var editHash = CheckableRepository.appendAndCommit(localRepo);
2304             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2305             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
2326     @Test
2327     void cooldown(TestInfo testInfo) throws IOException {
2328         try (var credentials = new HostCredentials(testInfo);
2329              var tempFolder = new TemporaryDirectory();
2330              var archiveFolder = new TemporaryDirectory();
2331              var listServer = new TestMailmanServer();
2332              var webrevServer = new TestWebrevServer()) {
2333             var bot = credentials.getHostedRepository();
2334             var author = credentials.getHostedRepository();
2335             var archive = credentials.getHostedRepository();
2336             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2337             var censusBuilder = credentials.getCensusBuilder()
2338                                            .addAuthor(author.forge().currentUser().id());
2339             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2340             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2341                                                    .from(from)
2342                                                    .repo(bot)
2343                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2344                                                    .archive(archive)
2345                                                    .censusRepo(censusBuilder.build())
<span class="line-modified">2346                                                    .list(listAddress)</span>
2347                                                    .listArchive(listServer.getArchive())
2348                                                    .smtpServer(listServer.getSMTP())
2349                                                    .webrevStorageRepository(archive)
2350                                                    .webrevStorageRef(&quot;webrev&quot;)
2351                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2352                                                    .webrevStorageBaseUri(webrevServer.uri())
2353                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2354 
2355             // Populate the projects repository
2356             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2357             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2358             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2359             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2360             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2361 
2362             // Make a change with a corresponding PR
2363             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2364             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2365             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2366             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
2391     @Test
2392     void cooldownNewRevision(TestInfo testInfo) throws IOException {
2393         try (var credentials = new HostCredentials(testInfo);
2394              var tempFolder = new TemporaryDirectory();
2395              var archiveFolder = new TemporaryDirectory();
2396              var listServer = new TestMailmanServer();
2397              var webrevServer = new TestWebrevServer()) {
2398             var bot = credentials.getHostedRepository();
2399             var author = credentials.getHostedRepository();
2400             var archive = credentials.getHostedRepository();
2401             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2402             var censusBuilder = credentials.getCensusBuilder()
2403                                            .addAuthor(author.forge().currentUser().id());
2404             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2405             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2406                                                    .from(from)
2407                                                    .repo(bot)
2408                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2409                                                    .archive(archive)
2410                                                    .censusRepo(censusBuilder.build())
<span class="line-modified">2411                                                    .list(listAddress)</span>
2412                                                    .listArchive(listServer.getArchive())
2413                                                    .smtpServer(listServer.getSMTP())
2414                                                    .webrevStorageRepository(archive)
2415                                                    .webrevStorageRef(&quot;webrev&quot;)
2416                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2417                                                    .webrevStorageBaseUri(webrevServer.uri())
2418                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2419 
2420             // Populate the projects repository
2421             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2422             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2423             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2424             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2425             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2426 
2427             // Make a change with a corresponding PR
2428             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2429             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2430             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2431             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
2458     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2459         try (var credentials = new HostCredentials(testInfo);
2460              var tempFolder = new TemporaryDirectory();
2461              var archiveFolder = new TemporaryDirectory();
2462              var listServer = new TestMailmanServer();
2463              var webrevServer = new TestWebrevServer()) {
2464             var bot = credentials.getHostedRepository();
2465             var author = credentials.getHostedRepository();
2466             var archive = credentials.getHostedRepository();
2467             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2468             var censusBuilder = credentials.getCensusBuilder()
2469                                            .addAuthor(author.forge().currentUser().id());
2470             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2471             var cooldown = Duration.ofMillis(500);
2472             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2473                                                    .from(from)
2474                                                    .repo(bot)
2475                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2476                                                    .archive(archive)
2477                                                    .censusRepo(censusBuilder.build())
<span class="line-modified">2478                                                    .list(listAddress)</span>
2479                                                    .listArchive(listServer.getArchive())
2480                                                    .smtpServer(listServer.getSMTP())
2481                                                    .webrevStorageRepository(archive)
2482                                                    .webrevStorageRef(&quot;webrev&quot;)
2483                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2484                                                    .webrevStorageBaseUri(webrevServer.uri())
2485                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2486 
2487             // Populate the projects repository
2488             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2489             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2490             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2491             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2492             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2493 
2494             // Make a change with a corresponding PR
2495             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2496             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2497             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2498             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
2547     }
2548 
2549     @Test
2550     void branchPrefix(TestInfo testInfo) throws IOException {
2551         try (var credentials = new HostCredentials(testInfo);
2552              var tempFolder = new TemporaryDirectory();
2553              var archiveFolder = new TemporaryDirectory();
2554              var listServer = new TestMailmanServer();
2555              var webrevServer = new TestWebrevServer()) {
2556             var author = credentials.getHostedRepository();
2557             var archive = credentials.getHostedRepository();
2558             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2559             var censusBuilder = credentials.getCensusBuilder()
2560                                            .addAuthor(author.forge().currentUser().id());
2561             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2562             var mlBot = MailingListBridgeBot.newBuilder()
2563                                             .from(from)
2564                                             .repo(author)
2565                                             .archive(archive)
2566                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2567                                             .list(listAddress)</span>
2568                                             .listArchive(listServer.getArchive())
2569                                             .smtpServer(listServer.getSMTP())
2570                                             .webrevStorageRepository(archive)
2571                                             .webrevStorageRef(&quot;webrev&quot;)
2572                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2573                                             .webrevStorageBaseUri(webrevServer.uri())
2574                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2575                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2576                                             .build();
2577 
2578             // Populate the projects repository
2579             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2580             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2581             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2582             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2583 
2584             // Make a change with a corresponding PR
2585             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2586                                                                &quot;Change msg\n\nWith several lines&quot;);
2587             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
2604     }
2605 
2606     @Test
2607     void repoPrefix(TestInfo testInfo) throws IOException {
2608         try (var credentials = new HostCredentials(testInfo);
2609              var tempFolder = new TemporaryDirectory();
2610              var archiveFolder = new TemporaryDirectory();
2611              var listServer = new TestMailmanServer();
2612              var webrevServer = new TestWebrevServer()) {
2613             var author = credentials.getHostedRepository();
2614             var archive = credentials.getHostedRepository();
2615             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2616             var censusBuilder = credentials.getCensusBuilder()
2617                                            .addAuthor(author.forge().currentUser().id());
2618             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2619             var mlBot = MailingListBridgeBot.newBuilder()
2620                                             .from(from)
2621                                             .repo(author)
2622                                             .archive(archive)
2623                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2624                                             .list(listAddress)</span>
2625                                             .listArchive(listServer.getArchive())
2626                                             .smtpServer(listServer.getSMTP())
2627                                             .webrevStorageRepository(archive)
2628                                             .webrevStorageRef(&quot;webrev&quot;)
2629                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2630                                             .webrevStorageBaseUri(webrevServer.uri())
2631                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2632                                             .repoInSubject(true)
2633                                             .build();
2634 
2635             // Populate the projects repository
2636             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2637             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2638             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2639             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2640 
2641             // Make a change with a corresponding PR
2642             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2643                                                                &quot;Change msg\n\nWith several lines&quot;);
2644             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
2661     }
2662 
2663     @Test
2664     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2665         try (var credentials = new HostCredentials(testInfo);
2666              var tempFolder = new TemporaryDirectory();
2667              var archiveFolder = new TemporaryDirectory();
2668              var listServer = new TestMailmanServer();
2669              var webrevServer = new TestWebrevServer()) {
2670             var author = credentials.getHostedRepository();
2671             var archive = credentials.getHostedRepository();
2672             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2673             var censusBuilder = credentials.getCensusBuilder()
2674                                            .addAuthor(author.forge().currentUser().id());
2675             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2676             var mlBot = MailingListBridgeBot.newBuilder()
2677                                             .from(from)
2678                                             .repo(author)
2679                                             .archive(archive)
2680                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2681                                             .list(listAddress)</span>
2682                                             .listArchive(listServer.getArchive())
2683                                             .smtpServer(listServer.getSMTP())
2684                                             .webrevStorageRepository(archive)
2685                                             .webrevStorageRef(&quot;webrev&quot;)
2686                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2687                                             .webrevStorageBaseUri(webrevServer.uri())
2688                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2689                                             .repoInSubject(true)
2690                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2691                                             .build();
2692 
2693             // Populate the projects repository
2694             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2695             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2696             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2697             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2698 
2699             // Make a change with a corresponding PR
2700             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2701                                                                &quot;Change msg\n\nWith several lines&quot;);
</pre>
<hr />
<pre>
2722     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2723         try (var credentials = new HostCredentials(testInfo);
2724              var tempFolder = new TemporaryDirectory();
2725              var archiveFolder = new TemporaryDirectory();
2726              var listServer = new TestMailmanServer();
2727              var webrevServer = new TestWebrevServer()) {
2728             var bot = credentials.getHostedRepository();
2729             var author = credentials.getHostedRepository();
2730             var archive = credentials.getHostedRepository();
2731             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2732             var censusBuilder = credentials.getCensusBuilder()
2733                                            .addAuthor(author.forge().currentUser().id());
2734             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2735             var cooldown = Duration.ofMillis(500);
2736             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2737                                                    .from(from)
2738                                                    .repo(bot)
2739                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2740                                                    .archive(archive)
2741                                                    .censusRepo(censusBuilder.build())
<span class="line-modified">2742                                                    .list(listAddress)</span>
2743                                                    .listArchive(listServer.getArchive())
2744                                                    .smtpServer(listServer.getSMTP())
2745                                                    .webrevStorageRepository(archive)
2746                                                    .webrevStorageRef(&quot;webrev&quot;)
2747                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2748                                                    .webrevStorageBaseUri(webrevServer.uri())
2749                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2750 
2751             // Populate the projects repository
2752             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2753             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2754             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2755             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2756             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2757 
2758             // Make a change with a corresponding PR
2759             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2760             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2761             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2762             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
2793                     if (noMailReceived) {
2794                         TestBotRunner.runPeriodicItems(mlBot);
2795                         listServer.processIncoming();
2796                     }
2797                     cooldown = cooldown.multipliedBy(2);
2798                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2799                 }
2800             }
2801             assertTrue(noMailReceived);
2802 
2803             // But after the cooldown period has passed, it should
2804             Thread.sleep(cooldown.toMillis());
2805             TestBotRunner.runPeriodicItems(mlBot);
2806             listServer.processIncoming();
2807 
2808             // Check the archive
2809             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2810             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
2811         }
2812     }














































































2813 }
</pre>
</td>
<td>
<hr />
<pre>
 105     @Test
 106     void simpleArchive(TestInfo testInfo) throws IOException {
 107         try (var credentials = new HostCredentials(testInfo);
 108              var tempFolder = new TemporaryDirectory();
 109              var archiveFolder = new TemporaryDirectory();
 110              var webrevFolder = new TemporaryDirectory();
 111              var listServer = new TestMailmanServer();
 112              var webrevServer = new TestWebrevServer()) {
 113             var author = credentials.getHostedRepository();
 114             var archive = credentials.getHostedRepository();
 115             var ignored = credentials.getHostedRepository();
 116             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 117             var censusBuilder = credentials.getCensusBuilder()
 118                                            .addAuthor(author.forge().currentUser().id());
 119             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 120             var mlBot = MailingListBridgeBot.newBuilder()
 121                                             .from(from)
 122                                             .repo(author)
 123                                             .archive(archive)
 124                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 125                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
 126                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 127                                             .ignoredComments(Set.of())
 128                                             .listArchive(listServer.getArchive())
 129                                             .smtpServer(listServer.getSMTP())
 130                                             .webrevStorageRepository(archive)
 131                                             .webrevStorageRef(&quot;webrev&quot;)
 132                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 133                                             .webrevStorageBaseUri(webrevServer.uri())
 134                                             .readyLabels(Set.of(&quot;rfr&quot;))
 135                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 137                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 138                                             .sendInterval(Duration.ZERO)
 139                                             .build();
 140 
 141             // Populate the projects repository
 142             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 143             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 144             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 145             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
</pre>
<hr />
<pre>
 273     @Test
 274     void archiveIntegrated(TestInfo testInfo) throws IOException {
 275         try (var credentials = new HostCredentials(testInfo);
 276              var tempFolder = new TemporaryDirectory();
 277              var archiveFolder = new TemporaryDirectory();
 278              var webrevFolder = new TemporaryDirectory();
 279              var listServer = new TestMailmanServer();
 280              var webrevServer = new TestWebrevServer()) {
 281             var author = credentials.getHostedRepository();
 282             var archive = credentials.getHostedRepository();
 283             var ignored = credentials.getHostedRepository();
 284             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 285             var censusBuilder = credentials.getCensusBuilder()
 286                                            .addAuthor(author.forge().currentUser().id());
 287             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 288             var mlBot = MailingListBridgeBot.newBuilder()
 289                                             .from(from)
 290                                             .repo(author)
 291                                             .archive(archive)
 292                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 293                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
 294                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 295                                             .listArchive(listServer.getArchive())
 296                                             .smtpServer(listServer.getSMTP())
 297                                             .webrevStorageRepository(archive)
 298                                             .webrevStorageRef(&quot;webrev&quot;)
 299                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 300                                             .webrevStorageBaseUri(webrevServer.uri())
 301                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 302                                             .build();
 303 
 304             // Populate the projects repository
 305             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 306             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 307             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 308             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 309 
 310             // Make a change with a corresponding PR
 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 312                                                                &quot;Change msg\n\nWith several lines&quot;);
 313             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
 339             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 340         }
 341     }
 342 
 343     @Test
 344     void archiveLegacyIntegrated(TestInfo testInfo) throws IOException {
 345         try (var credentials = new HostCredentials(testInfo);
 346              var tempFolder = new TemporaryDirectory();
 347              var archiveFolder = new TemporaryDirectory();
 348              var webrevFolder = new TemporaryDirectory();
 349              var listServer = new TestMailmanServer();
 350              var webrevServer = new TestWebrevServer()) {
 351             var author = credentials.getHostedRepository();
 352             var archive = credentials.getHostedRepository();
 353             var ignored = credentials.getHostedRepository();
 354             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 355             var censusBuilder = credentials.getCensusBuilder()
 356                     .addAuthor(author.forge().currentUser().id());
 357             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 358             var mlBot = MailingListBridgeBot.newBuilder()
<span class="line-modified"> 359                                             .from(from)</span>
<span class="line-modified"> 360                                             .repo(author)</span>
<span class="line-modified"> 361                                             .archive(archive)</span>
<span class="line-modified"> 362                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified"> 363                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
<span class="line-modified"> 364                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))</span>
<span class="line-modified"> 365                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified"> 366                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified"> 367                                             .webrevStorageRepository(archive)</span>
<span class="line-modified"> 368                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-modified"> 369                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-modified"> 370                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-modified"> 371                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-modified"> 372                                             .build();</span>
 373 
 374             // Populate the projects repository
 375             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 376             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 377             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 378             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 379 
 380             // Make a change with a corresponding PR with a date in the past
 381             var editFile = tempFolder.path().resolve(&quot;change.txt&quot;);
 382             Files.writeString(editFile, &quot;A simple change&quot;);
 383             localRepo.add(editFile);
 384             var commitDate = ZonedDateTime.of(2020, 3, 12, 0, 0, 0, 0, ZoneId.of(&quot;UTC&quot;));
 385             var editHash = localRepo.commit(&quot;An old change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate,
 386                              &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate);
 387             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 388             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 389             pr.setBody(&quot;This is now ready&quot;);
 390             pr.addLabel(&quot;rfr&quot;);
 391 
 392             // Run an archive pass
</pre>
<hr />
<pre>
 417     @Test
 418     void archiveDirectToIntegrated(TestInfo testInfo) throws IOException {
 419         try (var credentials = new HostCredentials(testInfo);
 420              var tempFolder = new TemporaryDirectory();
 421              var archiveFolder = new TemporaryDirectory();
 422              var webrevFolder = new TemporaryDirectory();
 423              var listServer = new TestMailmanServer();
 424              var webrevServer = new TestWebrevServer()) {
 425             var author = credentials.getHostedRepository();
 426             var archive = credentials.getHostedRepository();
 427             var ignored = credentials.getHostedRepository();
 428             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 429             var censusBuilder = credentials.getCensusBuilder()
 430                                            .addAuthor(author.forge().currentUser().id());
 431             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 432             var mlBot = MailingListBridgeBot.newBuilder()
 433                                             .from(from)
 434                                             .repo(author)
 435                                             .archive(archive)
 436                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 437                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
 438                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 439                                             .listArchive(listServer.getArchive())
 440                                             .smtpServer(listServer.getSMTP())
 441                                             .webrevStorageRepository(archive)
 442                                             .webrevStorageRef(&quot;webrev&quot;)
 443                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 444                                             .webrevStorageBaseUri(webrevServer.uri())
 445                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 446                                             .build();
 447 
 448             // Populate the projects repository
 449             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 450             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 451             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 452             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 453 
 454             // Make a change with a corresponding PR
 455             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 456                                                                &quot;Change msg\n\nWith several lines&quot;);
 457             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
 496     @Test
 497     void archiveIntegratedRetainPrefix(TestInfo testInfo) throws IOException {
 498         try (var credentials = new HostCredentials(testInfo);
 499              var tempFolder = new TemporaryDirectory();
 500              var archiveFolder = new TemporaryDirectory();
 501              var webrevFolder = new TemporaryDirectory();
 502              var listServer = new TestMailmanServer();
 503              var webrevServer = new TestWebrevServer()) {
 504             var author = credentials.getHostedRepository();
 505             var archive = credentials.getHostedRepository();
 506             var ignored = credentials.getHostedRepository();
 507             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 508             var censusBuilder = credentials.getCensusBuilder()
 509                                            .addAuthor(author.forge().currentUser().id());
 510             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 511             var mlBot = MailingListBridgeBot.newBuilder()
 512                                             .from(from)
 513                                             .repo(author)
 514                                             .archive(archive)
 515                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 516                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
 517                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 518                                             .listArchive(listServer.getArchive())
 519                                             .smtpServer(listServer.getSMTP())
 520                                             .webrevStorageRepository(archive)
 521                                             .webrevStorageRef(&quot;webrev&quot;)
 522                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 523                                             .webrevStorageBaseUri(webrevServer.uri())
 524                                             .readyLabels(Set.of(&quot;rfr&quot;))
 525                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 526                                             .build();
 527 
 528             // Populate the projects repository
 529             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 530             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 531             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 532             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 533 
 534             // Make a change with a corresponding PR
 535             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 536                                                                &quot;Change msg\n\nWith several lines&quot;);
</pre>
<hr />
<pre>
 573     @Test
 574     void archiveClosed(TestInfo testInfo) throws IOException {
 575         try (var credentials = new HostCredentials(testInfo);
 576              var tempFolder = new TemporaryDirectory();
 577              var archiveFolder = new TemporaryDirectory();
 578              var webrevFolder = new TemporaryDirectory();
 579              var listServer = new TestMailmanServer();
 580              var webrevServer = new TestWebrevServer()) {
 581             var author = credentials.getHostedRepository();
 582             var archive = credentials.getHostedRepository();
 583             var ignored = credentials.getHostedRepository();
 584             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 585             var censusBuilder = credentials.getCensusBuilder()
 586                                            .addAuthor(author.forge().currentUser().id());
 587             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 588             var mlBot = MailingListBridgeBot.newBuilder()
 589                                             .from(from)
 590                                             .repo(author)
 591                                             .archive(archive)
 592                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 593                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
 594                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 595                                             .listArchive(listServer.getArchive())
 596                                             .smtpServer(listServer.getSMTP())
 597                                             .webrevStorageRepository(archive)
 598                                             .webrevStorageRef(&quot;webrev&quot;)
 599                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 600                                             .webrevStorageBaseUri(webrevServer.uri())
 601                                             .readyLabels(Set.of(&quot;rfr&quot;))
 602                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 603                                             .build();
 604 
 605             // Populate the projects repository
 606             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 607             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 608             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 609             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 610 
 611             // Make a change with a corresponding PR
 612             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 613                                                                &quot;Change msg\n\nWith several lines&quot;);
</pre>
<hr />
<pre>
 656     @Test
 657     void archiveFailedAutoMerge(TestInfo testInfo) throws IOException {
 658         try (var credentials = new HostCredentials(testInfo);
 659              var tempFolder = new TemporaryDirectory();
 660              var archiveFolder = new TemporaryDirectory();
 661              var webrevFolder = new TemporaryDirectory();
 662              var listServer = new TestMailmanServer();
 663              var webrevServer = new TestWebrevServer()) {
 664             var author = credentials.getHostedRepository();
 665             var archive = credentials.getHostedRepository();
 666             var ignored = credentials.getHostedRepository();
 667             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 668             var censusBuilder = credentials.getCensusBuilder()
 669                                            .addAuthor(author.forge().currentUser().id());
 670             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 671             var mlBot = MailingListBridgeBot.newBuilder()
 672                                             .from(from)
 673                                             .repo(author)
 674                                             .archive(archive)
 675                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 676                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
 677                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 678                                             .listArchive(listServer.getArchive())
 679                                             .smtpServer(listServer.getSMTP())
 680                                             .webrevStorageRepository(archive)
 681                                             .webrevStorageRef(&quot;webrev&quot;)
 682                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 683                                             .webrevStorageBaseUri(webrevServer.uri())
 684                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 685                                             .build();
 686 
 687             // Populate the projects repository
 688             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 689             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 690             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 691             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 692 
 693             // Make a change with a corresponding PR
 694             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 695                                                                &quot;Change msg\n\nWith several lines&quot;);
 696             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
 710 
 711     @Test
 712     void reviewComment(TestInfo testInfo) throws IOException {
 713         try (var credentials = new HostCredentials(testInfo);
 714              var tempFolder = new TemporaryDirectory();
 715              var archiveFolder = new TemporaryDirectory();
 716              var listServer = new TestMailmanServer();
 717              var webrevServer = new TestWebrevServer()) {
 718             var author = credentials.getHostedRepository();
 719             var archive = credentials.getHostedRepository();
 720             var ignored = credentials.getHostedRepository();
 721             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 722             var censusBuilder = credentials.getCensusBuilder()
 723                                            .addAuthor(author.forge().currentUser().id());
 724             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 725             var mlBot = MailingListBridgeBot.newBuilder()
 726                                             .from(from)
 727                                             .repo(author)
 728                                             .archive(archive)
 729                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 730                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
 731                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 732                                             .listArchive(listServer.getArchive())
 733                                             .smtpServer(listServer.getSMTP())
 734                                             .webrevStorageRepository(archive)
 735                                             .webrevStorageRef(&quot;webrev&quot;)
 736                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 737                                             .webrevStorageBaseUri(webrevServer.uri())
 738                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 739                                             .build();
 740 
 741             // Populate the projects repository
 742             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 743             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 744             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 745             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 746             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 747 
 748             // Make a change with a corresponding PR
 749             var editHash = CheckableRepository.appendAndCommit(localRepo);
 750             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
 805     }
 806 
 807     @Test
 808     void combineComments(TestInfo testInfo) throws IOException {
 809         try (var credentials = new HostCredentials(testInfo);
 810              var tempFolder = new TemporaryDirectory();
 811              var archiveFolder = new TemporaryDirectory();
 812              var listServer = new TestMailmanServer();
 813              var webrevServer = new TestWebrevServer()) {
 814             var author = credentials.getHostedRepository();
 815             var archive = credentials.getHostedRepository();
 816             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 817             var censusBuilder = credentials.getCensusBuilder()
 818                                            .addAuthor(author.forge().currentUser().id());
 819             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 820             var mlBot = MailingListBridgeBot.newBuilder()
 821                                             .from(from)
 822                                             .repo(author)
 823                                             .archive(archive)
 824                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 825                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
 826                                             .listArchive(listServer.getArchive())
 827                                             .smtpServer(listServer.getSMTP())
 828                                             .webrevStorageRepository(archive)
 829                                             .webrevStorageRef(&quot;webrev&quot;)
 830                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 831                                             .webrevStorageBaseUri(webrevServer.uri())
 832                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 833                                             .build();
 834 
 835             // Populate the projects repository
 836             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 837             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 838             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 839             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 840             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 841 
 842             // Make a change with a corresponding PR
 843             var editHash = CheckableRepository.appendAndCommit(localRepo);
 844             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 845             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
 900     @Test
 901     void commentThreading(TestInfo testInfo) throws IOException {
 902         try (var credentials = new HostCredentials(testInfo);
 903              var tempFolder = new TemporaryDirectory();
 904              var archiveFolder = new TemporaryDirectory();
 905              var listServer = new TestMailmanServer();
 906              var webrevServer = new TestWebrevServer()) {
 907             var author = credentials.getHostedRepository();
 908             var reviewer = credentials.getHostedRepository();
 909             var archive = credentials.getHostedRepository();
 910             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 911             var censusBuilder = credentials.getCensusBuilder()
 912                                            .addReviewer(reviewer.forge().currentUser().id())
 913                                            .addAuthor(author.forge().currentUser().id());
 914             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 915             var mlBot = MailingListBridgeBot.newBuilder()
 916                                             .from(from)
 917                                             .repo(author)
 918                                             .archive(archive)
 919                                             .censusRepo(censusBuilder.build())
<span class="line-modified"> 920                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
 921                                             .listArchive(listServer.getArchive())
 922                                             .smtpServer(listServer.getSMTP())
 923                                             .webrevStorageRepository(archive)
 924                                             .webrevStorageRef(&quot;webrev&quot;)
 925                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 926                                             .webrevStorageBaseUri(webrevServer.uri())
 927                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 928                                             .build();
 929 
 930             // Populate the projects repository
 931             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 932             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 933             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 934             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 935             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 936 
 937             // Make a change with a corresponding PR
 938             var editHash = CheckableRepository.appendAndCommit(localRepo);
 939             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 940             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1029     @Test
1030     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
1031         try (var credentials = new HostCredentials(testInfo);
1032              var tempFolder = new TemporaryDirectory();
1033              var archiveFolder = new TemporaryDirectory();
1034              var listServer = new TestMailmanServer();
1035              var webrevServer = new TestWebrevServer()) {
1036             var author = credentials.getHostedRepository();
1037             var reviewer = credentials.getHostedRepository();
1038             var archive = credentials.getHostedRepository();
1039             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1040             var censusBuilder = credentials.getCensusBuilder()
1041                                            .addReviewer(reviewer.forge().currentUser().id())
1042                                            .addAuthor(author.forge().currentUser().id());
1043             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1044             var mlBot = MailingListBridgeBot.newBuilder()
1045                                             .from(from)
1046                                             .repo(author)
1047                                             .archive(archive)
1048                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1049                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
1050                                             .listArchive(listServer.getArchive())
1051                                             .smtpServer(listServer.getSMTP())
1052                                             .webrevStorageRepository(archive)
1053                                             .webrevStorageRef(&quot;webrev&quot;)
1054                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1055                                             .webrevStorageBaseUri(webrevServer.uri())
1056                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1057                                             .build();
1058 
1059             // Populate the projects repository
1060             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1061             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1062             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1063             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1064             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1065 
1066             // Make a change with a corresponding PR
1067             var editHash = CheckableRepository.appendAndCommit(localRepo);
1068             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1069             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1092     @Test
1093     void commentWithMention(TestInfo testInfo) throws IOException {
1094         try (var credentials = new HostCredentials(testInfo);
1095              var tempFolder = new TemporaryDirectory();
1096              var archiveFolder = new TemporaryDirectory();
1097              var listServer = new TestMailmanServer();
1098              var webrevServer = new TestWebrevServer()) {
1099             var author = credentials.getHostedRepository();
1100             var reviewer = credentials.getHostedRepository();
1101             var archive = credentials.getHostedRepository();
1102             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1103             var censusBuilder = credentials.getCensusBuilder()
1104                                            .addReviewer(reviewer.forge().currentUser().id())
1105                                            .addAuthor(author.forge().currentUser().id());
1106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1107             var mlBot = MailingListBridgeBot.newBuilder()
1108                                             .from(from)
1109                                             .repo(author)
1110                                             .archive(archive)
1111                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1112                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
1113                                             .listArchive(listServer.getArchive())
1114                                             .smtpServer(listServer.getSMTP())
1115                                             .webrevStorageRepository(archive)
1116                                             .webrevStorageRef(&quot;webrev&quot;)
1117                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1118                                             .webrevStorageBaseUri(webrevServer.uri())
1119                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1120                                             .build();
1121 
1122             // Populate the projects repository
1123             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1124             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1125             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1126             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1127             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1128 
1129             // Make a change with a corresponding PR
1130             var editHash = CheckableRepository.appendAndCommit(localRepo);
1131             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1132             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1156     @Test
1157     void reviewCommentWithMention(TestInfo testInfo) throws IOException {
1158         try (var credentials = new HostCredentials(testInfo);
1159              var tempFolder = new TemporaryDirectory();
1160              var archiveFolder = new TemporaryDirectory();
1161              var listServer = new TestMailmanServer();
1162              var webrevServer = new TestWebrevServer()) {
1163             var author = credentials.getHostedRepository();
1164             var reviewer = credentials.getHostedRepository();
1165             var archive = credentials.getHostedRepository();
1166             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1167             var censusBuilder = credentials.getCensusBuilder()
1168                                            .addReviewer(reviewer.forge().currentUser().id())
1169                                            .addAuthor(author.forge().currentUser().id());
1170             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1171             var mlBot = MailingListBridgeBot.newBuilder()
1172                                             .from(from)
1173                                             .repo(author)
1174                                             .archive(archive)
1175                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1176                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
1177                                             .listArchive(listServer.getArchive())
1178                                             .smtpServer(listServer.getSMTP())
1179                                             .webrevStorageRepository(archive)
1180                                             .webrevStorageRef(&quot;webrev&quot;)
1181                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1182                                             .webrevStorageBaseUri(webrevServer.uri())
1183                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1184                                             .build();
1185 
1186             // Populate the projects repository
1187             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1188             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1189             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1190             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1191             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1192 
1193             // Make a change with a corresponding PR
1194             var editHash = CheckableRepository.appendAndCommit(localRepo);
1195             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1196             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1221     @Test
1222     void commentWithQuote(TestInfo testInfo) throws IOException {
1223         try (var credentials = new HostCredentials(testInfo);
1224              var tempFolder = new TemporaryDirectory();
1225              var archiveFolder = new TemporaryDirectory();
1226              var listServer = new TestMailmanServer();
1227              var webrevServer = new TestWebrevServer()) {
1228             var author = credentials.getHostedRepository();
1229             var reviewer = credentials.getHostedRepository();
1230             var archive = credentials.getHostedRepository();
1231             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1232             var censusBuilder = credentials.getCensusBuilder()
1233                                            .addReviewer(reviewer.forge().currentUser().id())
1234                                            .addAuthor(author.forge().currentUser().id());
1235             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1236             var mlBot = MailingListBridgeBot.newBuilder()
1237                                             .from(from)
1238                                             .repo(author)
1239                                             .archive(archive)
1240                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1241                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
1242                                             .listArchive(listServer.getArchive())
1243                                             .smtpServer(listServer.getSMTP())
1244                                             .webrevStorageRepository(archive)
1245                                             .webrevStorageRef(&quot;webrev&quot;)
1246                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1247                                             .webrevStorageBaseUri(webrevServer.uri())
1248                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1249                                             .build();
1250 
1251             // Populate the projects repository
1252             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1253             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1254             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1255             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1256             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1257 
1258             // Make a change with a corresponding PR
1259             var editHash = CheckableRepository.appendAndCommit(localRepo);
1260             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1261             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1284     }
1285 
1286     @Test
1287     void reviewContext(TestInfo testInfo) throws IOException {
1288         try (var credentials = new HostCredentials(testInfo);
1289              var tempFolder = new TemporaryDirectory();
1290              var archiveFolder = new TemporaryDirectory();
1291              var listServer = new TestMailmanServer();
1292              var webrevServer = new TestWebrevServer()) {
1293             var author = credentials.getHostedRepository();
1294             var archive = credentials.getHostedRepository();
1295             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1296             var censusBuilder = credentials.getCensusBuilder()
1297                                            .addAuthor(author.forge().currentUser().id());
1298             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1299             var mlBot = MailingListBridgeBot.newBuilder()
1300                                             .from(from)
1301                                             .repo(author)
1302                                             .archive(archive)
1303                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1304                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
1305                                             .listArchive(listServer.getArchive())
1306                                             .smtpServer(listServer.getSMTP())
1307                                             .webrevStorageRepository(archive)
1308                                             .webrevStorageRef(&quot;webrev&quot;)
1309                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1310                                             .webrevStorageBaseUri(webrevServer.uri())
1311                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1312                                             .build();
1313 
1314             // Populate the projects repository
1315             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1316             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1317             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1318             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1319             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1320 
1321             // Make a change with a corresponding PR
1322             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1323             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1324             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1341     }
1342 
1343     @Test
1344     void multipleReviewContexts(TestInfo testInfo) throws IOException {
1345         try (var credentials = new HostCredentials(testInfo);
1346              var tempFolder = new TemporaryDirectory();
1347              var archiveFolder = new TemporaryDirectory();
1348              var listServer = new TestMailmanServer();
1349              var webrevServer = new TestWebrevServer()) {
1350             var author = credentials.getHostedRepository();
1351             var archive = credentials.getHostedRepository();
1352             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1353             var censusBuilder = credentials.getCensusBuilder()
1354                                            .addAuthor(author.forge().currentUser().id());
1355             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1356             var mlBot = MailingListBridgeBot.newBuilder()
1357                                             .from(from)
1358                                             .repo(author)
1359                                             .archive(archive)
1360                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1361                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
1362                                             .listArchive(listServer.getArchive())
1363                                             .smtpServer(listServer.getSMTP())
1364                                             .webrevStorageRepository(archive)
1365                                             .webrevStorageRef(&quot;webrev&quot;)
1366                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1367                                             .webrevStorageBaseUri(webrevServer.uri())
1368                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1369                                             .build();
1370 
1371             // Populate the projects repository
1372             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1373             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1374             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1375             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1376             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1377             var initialHash = CheckableRepository.appendAndCommit(localRepo,
1378                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
1379                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
1380                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
1381                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
</pre>
<hr />
<pre>
1417     }
1418 
1419     @Test
1420     void filterComments(TestInfo testInfo) throws IOException {
1421         try (var credentials = new HostCredentials(testInfo);
1422              var tempFolder = new TemporaryDirectory();
1423              var archiveFolder = new TemporaryDirectory();
1424              var listServer = new TestMailmanServer();
1425              var webrevServer = new TestWebrevServer()) {
1426             var author = credentials.getHostedRepository();
1427             var archive = credentials.getHostedRepository();
1428             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1429             var censusBuilder = credentials.getCensusBuilder()
1430                                            .addAuthor(author.forge().currentUser().id());
1431             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1432             var mlBot = MailingListBridgeBot.newBuilder()
1433                                             .from(from)
1434                                             .repo(author)
1435                                             .archive(archive)
1436                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1437                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
1438                                             .listArchive(listServer.getArchive())
1439                                             .smtpServer(listServer.getSMTP())
1440                                             .webrevStorageRepository(archive)
1441                                             .webrevStorageRef(&quot;webrev&quot;)
1442                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1443                                             .webrevStorageBaseUri(webrevServer.uri())
1444                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1445                                             .build();
1446 
1447             // Populate the projects repository
1448             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1449             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1450             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1451             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1452             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1453 
1454             // Make a change with a corresponding PR
1455             var editHash = CheckableRepository.appendAndCommit(localRepo);
1456             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1457             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1483 
1484     @Test
1485     void incrementalChanges(TestInfo testInfo) throws IOException {
1486         try (var credentials = new HostCredentials(testInfo);
1487              var tempFolder = new TemporaryDirectory();
1488              var archiveFolder = new TemporaryDirectory();
1489              var listServer = new TestMailmanServer();
1490              var webrevServer = new TestWebrevServer()) {
1491             var author = credentials.getHostedRepository();
1492             var archive = credentials.getHostedRepository();
1493             var commenter = credentials.getHostedRepository();
1494             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1495             var censusBuilder = credentials.getCensusBuilder()
1496                                            .addAuthor(author.forge().currentUser().id());
1497             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1498             var mlBot = MailingListBridgeBot.newBuilder()
1499                                             .from(from)
1500                                             .repo(author)
1501                                             .archive(archive)
1502                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1503                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
1504                                             .listArchive(listServer.getArchive())
1505                                             .smtpServer(listServer.getSMTP())
1506                                             .webrevStorageRepository(archive)
1507                                             .webrevStorageRef(&quot;webrev&quot;)
1508                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1509                                             .webrevStorageBaseUri(webrevServer.uri())
1510                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1511                                             .build();
1512 
1513             // Populate the projects repository
1514             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1515             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1516             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1517             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1518             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1519 
1520             // Make a change with a corresponding PR
1521             var editHash = CheckableRepository.appendAndCommit(localRepo);
1522             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1523             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1613     }
1614 
1615     @Test
1616     void rebased(TestInfo testInfo) throws IOException {
1617         try (var credentials = new HostCredentials(testInfo);
1618              var tempFolder = new TemporaryDirectory();
1619              var archiveFolder = new TemporaryDirectory();
1620              var listServer = new TestMailmanServer();
1621              var webrevServer = new TestWebrevServer()) {
1622             var author = credentials.getHostedRepository();
1623             var archive = credentials.getHostedRepository();
1624             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1625             var censusBuilder = credentials.getCensusBuilder()
1626                                            .addAuthor(author.forge().currentUser().id());
1627             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1628             var mlBot = MailingListBridgeBot.newBuilder()
1629                                             .from(sender)
1630                                             .repo(author)
1631                                             .archive(archive)
1632                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1633                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
1634                                             .listArchive(listServer.getArchive())
1635                                             .smtpServer(listServer.getSMTP())
1636                                             .webrevStorageRepository(archive)
1637                                             .webrevStorageRef(&quot;webrev&quot;)
1638                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1639                                             .webrevStorageBaseUri(webrevServer.uri())
1640                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1641                                             .build();
1642 
1643             // Populate the projects repository
1644             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1645             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1646             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1647             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1648             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1649 
1650             // Make a change with a corresponding PR
1651             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1652             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1653             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
1710 
1711     @Test
1712     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1713         try (var credentials = new HostCredentials(testInfo);
1714              var tempFolder = new TemporaryDirectory();
1715              var archiveFolder = new TemporaryDirectory();
1716              var listServer = new TestMailmanServer();
1717              var webrevServer = new TestWebrevServer()) {
1718             var author = credentials.getHostedRepository();
1719             var archive = credentials.getHostedRepository();
1720             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1721             var censusBuilder = credentials.getCensusBuilder()
1722                                            .addAuthor(author.forge().currentUser().id());
1723             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1724             var mlBot = MailingListBridgeBot.newBuilder()
1725                                             .from(sender)
1726                                             .repo(author)
1727                                             .archive(archive)
1728                                             .archiveRef(&quot;archive&quot;)
1729                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1730                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
1731                                             .listArchive(listServer.getArchive())
1732                                             .smtpServer(listServer.getSMTP())
1733                                             .webrevStorageRepository(archive)
1734                                             .webrevStorageRef(&quot;webrev&quot;)
1735                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1736                                             .webrevStorageBaseUri(webrevServer.uri())
1737                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1738                                             .build();
1739 
1740             // Populate the projects repository
1741             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1742             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1743             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1744             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1745             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1746             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1747 
1748             // Make a change with a corresponding PR
1749             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1750             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
1800     @Test
1801     void mergeWebrev(TestInfo testInfo) throws IOException {
1802         try (var credentials = new HostCredentials(testInfo);
1803              var tempFolder = new TemporaryDirectory();
1804              var archiveFolder = new TemporaryDirectory();
1805              var listServer = new TestMailmanServer();
1806              var webrevServer = new TestWebrevServer()) {
1807             var author = credentials.getHostedRepository();
1808             var archive = credentials.getHostedRepository();
1809             var commenter = credentials.getHostedRepository();
1810             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1811             var censusBuilder = credentials.getCensusBuilder()
1812                                            .addAuthor(author.forge().currentUser().id());
1813             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1814             var mlBot = MailingListBridgeBot.newBuilder()
1815                                             .from(from)
1816                                             .repo(author)
1817                                             .archive(archive)
1818                                             .archiveRef(&quot;archive&quot;)
1819                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1820                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
1821                                             .listArchive(listServer.getArchive())
1822                                             .smtpServer(listServer.getSMTP())
1823                                             .webrevStorageRepository(archive)
1824                                             .webrevStorageRef(&quot;webrev&quot;)
1825                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1826                                             .webrevStorageBaseUri(webrevServer.uri())
1827                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1828                                             .build();
1829 
1830             // Populate the projects repository
1831             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1832             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1833             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1834             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1835             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1836             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1837 
1838             // Create a diverging branch
1839             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1840             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
</pre>
<hr />
<pre>
1886     @Test
1887     void mergeWebrevConflict(TestInfo testInfo) throws IOException {
1888         try (var credentials = new HostCredentials(testInfo);
1889              var tempFolder = new TemporaryDirectory();
1890              var archiveFolder = new TemporaryDirectory();
1891              var listServer = new TestMailmanServer();
1892              var webrevServer = new TestWebrevServer()) {
1893             var author = credentials.getHostedRepository();
1894             var archive = credentials.getHostedRepository();
1895             var commenter = credentials.getHostedRepository();
1896             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1897             var censusBuilder = credentials.getCensusBuilder()
1898                                            .addAuthor(author.forge().currentUser().id());
1899             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1900             var mlBot = MailingListBridgeBot.newBuilder()
1901                                             .from(from)
1902                                             .repo(author)
1903                                             .archive(archive)
1904                                             .archiveRef(&quot;archive&quot;)
1905                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1906                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
1907                                             .listArchive(listServer.getArchive())
1908                                             .smtpServer(listServer.getSMTP())
1909                                             .webrevStorageRepository(archive)
1910                                             .webrevStorageRef(&quot;webrev&quot;)
1911                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1912                                             .webrevStorageBaseUri(webrevServer.uri())
1913                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1914                                             .build();
1915 
1916             // Populate the projects repository
1917             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1918             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1919             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1920             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1921             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1922             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1923 
1924             // Create a merge
1925             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1926             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
</pre>
<hr />
<pre>
1958     @Test
1959     void mergeWebrevNoConflict(TestInfo testInfo) throws IOException {
1960         try (var credentials = new HostCredentials(testInfo);
1961              var tempFolder = new TemporaryDirectory();
1962              var archiveFolder = new TemporaryDirectory();
1963              var listServer = new TestMailmanServer();
1964              var webrevServer = new TestWebrevServer()) {
1965             var author = credentials.getHostedRepository();
1966             var archive = credentials.getHostedRepository();
1967             var commenter = credentials.getHostedRepository();
1968             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1969             var censusBuilder = credentials.getCensusBuilder()
1970                                            .addAuthor(author.forge().currentUser().id());
1971             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1972             var mlBot = MailingListBridgeBot.newBuilder()
1973                                             .from(from)
1974                                             .repo(author)
1975                                             .archive(archive)
1976                                             .archiveRef(&quot;archive&quot;)
1977                                             .censusRepo(censusBuilder.build())
<span class="line-modified">1978                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
1979                                             .listArchive(listServer.getArchive())
1980                                             .smtpServer(listServer.getSMTP())
1981                                             .webrevStorageRepository(archive)
1982                                             .webrevStorageRef(&quot;webrev&quot;)
1983                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1984                                             .webrevStorageBaseUri(webrevServer.uri())
1985                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1986                                             .build();
1987 
1988             // Populate the projects repository
1989             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1990             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1991             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1992             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1993             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1994             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1995 
1996             // Create a merge
1997             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1998             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
</pre>
<hr />
<pre>
2028     @Test
2029     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
2030         try (var credentials = new HostCredentials(testInfo);
2031              var tempFolder = new TemporaryDirectory();
2032              var archiveFolder = new TemporaryDirectory();
2033              var webrevFolder = new TemporaryDirectory();
2034              var listServer = new TestMailmanServer();
2035              var webrevServer = new TestWebrevServer()) {
2036             var author = credentials.getHostedRepository();
2037             var archive = credentials.getHostedRepository();
2038             var ignored = credentials.getHostedRepository();
2039             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2040             var censusBuilder = credentials.getCensusBuilder()
2041                                            .addAuthor(author.forge().currentUser().id());
2042             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2043             var mlBot = MailingListBridgeBot.newBuilder()
2044                                             .from(from)
2045                                             .repo(author)
2046                                             .archive(archive)
2047                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2048                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
2049                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2050                                             .listArchive(listServer.getArchive())
2051                                             .smtpServer(listServer.getSMTP())
2052                                             .webrevStorageRepository(archive)
2053                                             .webrevStorageRef(&quot;webrev&quot;)
2054                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2055                                             .webrevStorageBaseUri(webrevServer.uri())
2056                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2057                                             .build();
2058 
2059             // Populate the projects repository
2060             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2061             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2062             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2063             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2064 
2065             // Make a change with a corresponding PR
2066             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2067                                                                &quot;Change msg\n\nWith several lines&quot;);
2068             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
2109     @Test
2110     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
2111         try (var credentials = new HostCredentials(testInfo);
2112              var tempFolder = new TemporaryDirectory();
2113              var archiveFolder = new TemporaryDirectory();
2114              var listServer = new TestMailmanServer();
2115              var webrevServer = new TestWebrevServer()) {
2116             var author = credentials.getHostedRepository();
2117             var archive = credentials.getHostedRepository();
2118             var reviewer = credentials.getHostedRepository();
2119             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2120             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2121             var censusBuilder = credentials.getCensusBuilder()
2122                                            .addReviewer(reviewer.forge().currentUser().id())
2123                                            .addAuthor(author.forge().currentUser().id());
2124             var mlBot = MailingListBridgeBot.newBuilder()
2125                                             .from(from)
2126                                             .repo(author)
2127                                             .archive(archive)
2128                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2129                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
2130                                             .listArchive(listServer.getArchive())
2131                                             .smtpServer(listServer.getSMTP())
2132                                             .webrevStorageRepository(archive)
2133                                             .webrevStorageRef(&quot;webrev&quot;)
2134                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2135                                             .webrevStorageBaseUri(webrevServer.uri())
2136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2137                                             .build();
2138 
2139             // Populate the projects repository
2140             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2141             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2142             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2143             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2144             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2145 
2146             // Make a change with a corresponding PR
2147             var editHash = CheckableRepository.appendAndCommit(localRepo);
2148             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2149             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
2198 
2199     @Test
2200     void ignoreComments(TestInfo testInfo) throws IOException {
2201         try (var credentials = new HostCredentials(testInfo);
2202              var tempFolder = new TemporaryDirectory();
2203              var archiveFolder = new TemporaryDirectory();
2204              var listServer = new TestMailmanServer();
2205              var webrevServer = new TestWebrevServer()) {
2206             var author = credentials.getHostedRepository();
2207             var ignored = credentials.getHostedRepository();
2208             var archive = credentials.getHostedRepository();
2209             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2210             var censusBuilder = credentials.getCensusBuilder()
2211                                            .addAuthor(author.forge().currentUser().id());
2212             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2213             var mlBot = MailingListBridgeBot.newBuilder()
2214                                             .from(from)
2215                                             .repo(author)
2216                                             .archive(archive)
2217                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2218                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
2219                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2220                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
2221                                             .listArchive(listServer.getArchive())
2222                                             .smtpServer(listServer.getSMTP())
2223                                             .webrevStorageRepository(archive)
2224                                             .webrevStorageRef(&quot;webrev&quot;)
2225                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2226                                             .webrevStorageBaseUri(webrevServer.uri())
2227                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2228                                             .build();
2229 
2230             // Populate the projects repository
2231             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2232             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2233             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2234             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2235             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2236 
2237             // Make a change with a corresponding PR
2238             var editHash = CheckableRepository.appendAndCommit(localRepo);
</pre>
<hr />
<pre>
2265     @Test
2266     void replyToEmptyReview(TestInfo testInfo) throws IOException {
2267         try (var credentials = new HostCredentials(testInfo);
2268              var tempFolder = new TemporaryDirectory();
2269              var archiveFolder = new TemporaryDirectory();
2270              var listServer = new TestMailmanServer();
2271              var webrevServer = new TestWebrevServer()) {
2272             var author = credentials.getHostedRepository();
2273             var reviewer = credentials.getHostedRepository();
2274             var archive = credentials.getHostedRepository();
2275             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2276             var censusBuilder = credentials.getCensusBuilder()
2277                                            .addReviewer(reviewer.forge().currentUser().id())
2278                                            .addAuthor(author.forge().currentUser().id());
2279             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2280             var mlBot = MailingListBridgeBot.newBuilder()
2281                                             .from(from)
2282                                             .repo(author)
2283                                             .archive(archive)
2284                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2285                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
2286                                             .listArchive(listServer.getArchive())
2287                                             .smtpServer(listServer.getSMTP())
2288                                             .webrevStorageRepository(archive)
2289                                             .webrevStorageRef(&quot;webrev&quot;)
2290                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2291                                             .webrevStorageBaseUri(webrevServer.uri())
2292                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2293                                             .build();
2294 
2295             // Populate the projects repository
2296             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2297             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2298             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2299             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2300             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2301 
2302             // Make a change with a corresponding PR
2303             var editHash = CheckableRepository.appendAndCommit(localRepo);
2304             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2305             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
2326     @Test
2327     void cooldown(TestInfo testInfo) throws IOException {
2328         try (var credentials = new HostCredentials(testInfo);
2329              var tempFolder = new TemporaryDirectory();
2330              var archiveFolder = new TemporaryDirectory();
2331              var listServer = new TestMailmanServer();
2332              var webrevServer = new TestWebrevServer()) {
2333             var bot = credentials.getHostedRepository();
2334             var author = credentials.getHostedRepository();
2335             var archive = credentials.getHostedRepository();
2336             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2337             var censusBuilder = credentials.getCensusBuilder()
2338                                            .addAuthor(author.forge().currentUser().id());
2339             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2340             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2341                                                    .from(from)
2342                                                    .repo(bot)
2343                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2344                                                    .archive(archive)
2345                                                    .censusRepo(censusBuilder.build())
<span class="line-modified">2346                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
2347                                                    .listArchive(listServer.getArchive())
2348                                                    .smtpServer(listServer.getSMTP())
2349                                                    .webrevStorageRepository(archive)
2350                                                    .webrevStorageRef(&quot;webrev&quot;)
2351                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2352                                                    .webrevStorageBaseUri(webrevServer.uri())
2353                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2354 
2355             // Populate the projects repository
2356             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2357             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2358             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2359             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2360             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2361 
2362             // Make a change with a corresponding PR
2363             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2364             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2365             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2366             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
2391     @Test
2392     void cooldownNewRevision(TestInfo testInfo) throws IOException {
2393         try (var credentials = new HostCredentials(testInfo);
2394              var tempFolder = new TemporaryDirectory();
2395              var archiveFolder = new TemporaryDirectory();
2396              var listServer = new TestMailmanServer();
2397              var webrevServer = new TestWebrevServer()) {
2398             var bot = credentials.getHostedRepository();
2399             var author = credentials.getHostedRepository();
2400             var archive = credentials.getHostedRepository();
2401             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2402             var censusBuilder = credentials.getCensusBuilder()
2403                                            .addAuthor(author.forge().currentUser().id());
2404             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2405             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2406                                                    .from(from)
2407                                                    .repo(bot)
2408                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2409                                                    .archive(archive)
2410                                                    .censusRepo(censusBuilder.build())
<span class="line-modified">2411                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
2412                                                    .listArchive(listServer.getArchive())
2413                                                    .smtpServer(listServer.getSMTP())
2414                                                    .webrevStorageRepository(archive)
2415                                                    .webrevStorageRef(&quot;webrev&quot;)
2416                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2417                                                    .webrevStorageBaseUri(webrevServer.uri())
2418                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2419 
2420             // Populate the projects repository
2421             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2422             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2423             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2424             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2425             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2426 
2427             // Make a change with a corresponding PR
2428             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2429             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2430             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2431             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
2458     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2459         try (var credentials = new HostCredentials(testInfo);
2460              var tempFolder = new TemporaryDirectory();
2461              var archiveFolder = new TemporaryDirectory();
2462              var listServer = new TestMailmanServer();
2463              var webrevServer = new TestWebrevServer()) {
2464             var bot = credentials.getHostedRepository();
2465             var author = credentials.getHostedRepository();
2466             var archive = credentials.getHostedRepository();
2467             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2468             var censusBuilder = credentials.getCensusBuilder()
2469                                            .addAuthor(author.forge().currentUser().id());
2470             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2471             var cooldown = Duration.ofMillis(500);
2472             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2473                                                    .from(from)
2474                                                    .repo(bot)
2475                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2476                                                    .archive(archive)
2477                                                    .censusRepo(censusBuilder.build())
<span class="line-modified">2478                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
2479                                                    .listArchive(listServer.getArchive())
2480                                                    .smtpServer(listServer.getSMTP())
2481                                                    .webrevStorageRepository(archive)
2482                                                    .webrevStorageRef(&quot;webrev&quot;)
2483                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2484                                                    .webrevStorageBaseUri(webrevServer.uri())
2485                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2486 
2487             // Populate the projects repository
2488             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2489             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2490             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2491             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2492             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2493 
2494             // Make a change with a corresponding PR
2495             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2496             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2497             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2498             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
2547     }
2548 
2549     @Test
2550     void branchPrefix(TestInfo testInfo) throws IOException {
2551         try (var credentials = new HostCredentials(testInfo);
2552              var tempFolder = new TemporaryDirectory();
2553              var archiveFolder = new TemporaryDirectory();
2554              var listServer = new TestMailmanServer();
2555              var webrevServer = new TestWebrevServer()) {
2556             var author = credentials.getHostedRepository();
2557             var archive = credentials.getHostedRepository();
2558             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2559             var censusBuilder = credentials.getCensusBuilder()
2560                                            .addAuthor(author.forge().currentUser().id());
2561             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2562             var mlBot = MailingListBridgeBot.newBuilder()
2563                                             .from(from)
2564                                             .repo(author)
2565                                             .archive(archive)
2566                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2567                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
2568                                             .listArchive(listServer.getArchive())
2569                                             .smtpServer(listServer.getSMTP())
2570                                             .webrevStorageRepository(archive)
2571                                             .webrevStorageRef(&quot;webrev&quot;)
2572                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2573                                             .webrevStorageBaseUri(webrevServer.uri())
2574                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2575                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2576                                             .build();
2577 
2578             // Populate the projects repository
2579             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2580             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2581             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2582             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2583 
2584             // Make a change with a corresponding PR
2585             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2586                                                                &quot;Change msg\n\nWith several lines&quot;);
2587             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
2604     }
2605 
2606     @Test
2607     void repoPrefix(TestInfo testInfo) throws IOException {
2608         try (var credentials = new HostCredentials(testInfo);
2609              var tempFolder = new TemporaryDirectory();
2610              var archiveFolder = new TemporaryDirectory();
2611              var listServer = new TestMailmanServer();
2612              var webrevServer = new TestWebrevServer()) {
2613             var author = credentials.getHostedRepository();
2614             var archive = credentials.getHostedRepository();
2615             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2616             var censusBuilder = credentials.getCensusBuilder()
2617                                            .addAuthor(author.forge().currentUser().id());
2618             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2619             var mlBot = MailingListBridgeBot.newBuilder()
2620                                             .from(from)
2621                                             .repo(author)
2622                                             .archive(archive)
2623                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2624                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
2625                                             .listArchive(listServer.getArchive())
2626                                             .smtpServer(listServer.getSMTP())
2627                                             .webrevStorageRepository(archive)
2628                                             .webrevStorageRef(&quot;webrev&quot;)
2629                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2630                                             .webrevStorageBaseUri(webrevServer.uri())
2631                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2632                                             .repoInSubject(true)
2633                                             .build();
2634 
2635             // Populate the projects repository
2636             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2637             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2638             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2639             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2640 
2641             // Make a change with a corresponding PR
2642             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2643                                                                &quot;Change msg\n\nWith several lines&quot;);
2644             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
2661     }
2662 
2663     @Test
2664     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2665         try (var credentials = new HostCredentials(testInfo);
2666              var tempFolder = new TemporaryDirectory();
2667              var archiveFolder = new TemporaryDirectory();
2668              var listServer = new TestMailmanServer();
2669              var webrevServer = new TestWebrevServer()) {
2670             var author = credentials.getHostedRepository();
2671             var archive = credentials.getHostedRepository();
2672             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2673             var censusBuilder = credentials.getCensusBuilder()
2674                                            .addAuthor(author.forge().currentUser().id());
2675             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2676             var mlBot = MailingListBridgeBot.newBuilder()
2677                                             .from(from)
2678                                             .repo(author)
2679                                             .archive(archive)
2680                                             .censusRepo(censusBuilder.build())
<span class="line-modified">2681                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
2682                                             .listArchive(listServer.getArchive())
2683                                             .smtpServer(listServer.getSMTP())
2684                                             .webrevStorageRepository(archive)
2685                                             .webrevStorageRef(&quot;webrev&quot;)
2686                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2687                                             .webrevStorageBaseUri(webrevServer.uri())
2688                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2689                                             .repoInSubject(true)
2690                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2691                                             .build();
2692 
2693             // Populate the projects repository
2694             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2695             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2696             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2697             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2698 
2699             // Make a change with a corresponding PR
2700             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2701                                                                &quot;Change msg\n\nWith several lines&quot;);
</pre>
<hr />
<pre>
2722     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2723         try (var credentials = new HostCredentials(testInfo);
2724              var tempFolder = new TemporaryDirectory();
2725              var archiveFolder = new TemporaryDirectory();
2726              var listServer = new TestMailmanServer();
2727              var webrevServer = new TestWebrevServer()) {
2728             var bot = credentials.getHostedRepository();
2729             var author = credentials.getHostedRepository();
2730             var archive = credentials.getHostedRepository();
2731             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2732             var censusBuilder = credentials.getCensusBuilder()
2733                                            .addAuthor(author.forge().currentUser().id());
2734             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2735             var cooldown = Duration.ofMillis(500);
2736             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2737                                                    .from(from)
2738                                                    .repo(bot)
2739                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2740                                                    .archive(archive)
2741                                                    .censusRepo(censusBuilder.build())
<span class="line-modified">2742                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
2743                                                    .listArchive(listServer.getArchive())
2744                                                    .smtpServer(listServer.getSMTP())
2745                                                    .webrevStorageRepository(archive)
2746                                                    .webrevStorageRef(&quot;webrev&quot;)
2747                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2748                                                    .webrevStorageBaseUri(webrevServer.uri())
2749                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2750 
2751             // Populate the projects repository
2752             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2753             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2754             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2755             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2756             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2757 
2758             // Make a change with a corresponding PR
2759             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2760             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2761             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2762             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
2793                     if (noMailReceived) {
2794                         TestBotRunner.runPeriodicItems(mlBot);
2795                         listServer.processIncoming();
2796                     }
2797                     cooldown = cooldown.multipliedBy(2);
2798                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2799                 }
2800             }
2801             assertTrue(noMailReceived);
2802 
2803             // But after the cooldown period has passed, it should
2804             Thread.sleep(cooldown.toMillis());
2805             TestBotRunner.runPeriodicItems(mlBot);
2806             listServer.processIncoming();
2807 
2808             // Check the archive
2809             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2810             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
2811         }
2812     }
<span class="line-added">2813 </span>
<span class="line-added">2814     @Test</span>
<span class="line-added">2815     void multipleRecipients(TestInfo testInfo) throws IOException {</span>
<span class="line-added">2816         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">2817              var tempFolder = new TemporaryDirectory();</span>
<span class="line-added">2818              var archiveFolder = new TemporaryDirectory();</span>
<span class="line-added">2819              var listServer = new TestMailmanServer();</span>
<span class="line-added">2820              var webrevServer = new TestWebrevServer()) {</span>
<span class="line-added">2821             var author = credentials.getHostedRepository();</span>
<span class="line-added">2822             var archive = credentials.getHostedRepository();</span>
<span class="line-added">2823             var listAddress1 = EmailAddress.parse(listServer.createList(&quot;test1&quot;));</span>
<span class="line-added">2824             var listAddress2 = EmailAddress.parse(listServer.createList(&quot;test2&quot;));</span>
<span class="line-added">2825             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added">2826                                            .addAuthor(author.forge().currentUser().id());</span>
<span class="line-added">2827             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);</span>
<span class="line-added">2828             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-added">2829                                             .from(from)</span>
<span class="line-added">2830                                             .repo(author)</span>
<span class="line-added">2831                                             .archive(archive)</span>
<span class="line-added">2832                                             .censusRepo(censusBuilder.build())</span>
<span class="line-added">2833                                             .lists(List.of(new MailingListConfiguration(listAddress1, Set.of(&quot;list1&quot;)),</span>
<span class="line-added">2834                                                            new MailingListConfiguration(listAddress2, Set.of(&quot;list2&quot;))))</span>
<span class="line-added">2835                                             .listArchive(listServer.getArchive())</span>
<span class="line-added">2836                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-added">2837                                             .webrevStorageRepository(archive)</span>
<span class="line-added">2838                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added">2839                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added">2840                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added">2841                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added">2842                                             .build();</span>
<span class="line-added">2843 </span>
<span class="line-added">2844             // Populate the projects repository</span>
<span class="line-added">2845             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
<span class="line-added">2846             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added">2847             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-added">2848             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
<span class="line-added">2849 </span>
<span class="line-added">2850             // Make a change with a corresponding PR</span>
<span class="line-added">2851             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,</span>
<span class="line-added">2852                                                                &quot;Change msg\n\nWith several lines&quot;);</span>
<span class="line-added">2853             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-added">2854             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);</span>
<span class="line-added">2855             pr.setBody(&quot;This is a PR&quot;);</span>
<span class="line-added">2856             pr.addLabel(&quot;list1&quot;);</span>
<span class="line-added">2857 </span>
<span class="line-added">2858             // Run an archive pass</span>
<span class="line-added">2859             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">2860             listServer.processIncoming();</span>
<span class="line-added">2861 </span>
<span class="line-added">2862             // The mail should have been sent to list1</span>
<span class="line-added">2863             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-added">2864             var mailmanList = mailmanServer.getList(listAddress1.address());</span>
<span class="line-added">2865             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-added">2866             assertEquals(1, conversations.size());</span>
<span class="line-added">2867             var mail = conversations.get(0).first();</span>
<span class="line-added">2868             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());</span>
<span class="line-added">2869             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());</span>
<span class="line-added">2870             assertEquals(noreplyAddress(archive), mail.author().address());</span>
<span class="line-added">2871             assertEquals(listAddress1, mail.sender());</span>
<span class="line-added">2872             assertEquals(List.of(listAddress1), mail.recipients());</span>
<span class="line-added">2873 </span>
<span class="line-added">2874             // Add another label and comment</span>
<span class="line-added">2875             pr.addLabel(&quot;list2&quot;);</span>
<span class="line-added">2876             pr.addComment(&quot;Looks good!&quot;);</span>
<span class="line-added">2877             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">2878             listServer.processIncoming();</span>
<span class="line-added">2879 </span>
<span class="line-added">2880             // This one should have been sent to list1 and list2</span>
<span class="line-added">2881             conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-added">2882             assertEquals(1, conversations.size());</span>
<span class="line-added">2883             var reply = conversations.get(0).replies(conversations.get(0).first()).get(0);</span>
<span class="line-added">2884             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, reply.subject());</span>
<span class="line-added">2885             assertEquals(pr.author().fullName(), reply.author().fullName().orElseThrow());</span>
<span class="line-added">2886             assertEquals(noreplyAddress(archive), reply.author().address());</span>
<span class="line-added">2887             assertEquals(listAddress1, reply.sender());</span>
<span class="line-added">2888             assertEquals(List.of(listAddress1, listAddress2), reply.recipients());</span>
<span class="line-added">2889         }</span>
<span class="line-added">2890     }</span>
2891 }
</pre>
</td>
</tr>
</table>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../email/src/main/java/org/openjdk/skara/email/Email.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>