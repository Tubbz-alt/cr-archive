<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/PullRequestCheckIssueVisitor.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IntegrateCommand.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SponsorCommand.java.udiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/PullRequestCheckIssueVisitor.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -30,14 +30,13 @@</span>
  import java.util.*;
  import java.util.logging.Logger;
  import java.util.stream.Collectors;
  
  class PullRequestCheckIssueVisitor implements IssueVisitor {
<span class="udiff-line-removed">-     private final Set&lt;String&gt; messages = new HashSet&lt;&gt;();</span>
      private final List&lt;CheckAnnotation&gt; annotations = new LinkedList&lt;&gt;();
      private final Set&lt;Check&gt; enabledChecks;
<span class="udiff-line-modified-removed">-     private final Set&lt;Class&lt;? extends Check&gt;&gt; failedChecks = new HashSet&lt;&gt;();</span>
<span class="udiff-line-modified-added">+     private final Map&lt;Class&lt;? extends Check&gt;, String&gt; failedChecks = new HashMap&lt;&gt;();</span>
  
      private boolean readyForReview;
  
      private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.pr&quot;);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -51,21 +50,34 @@</span>
      PullRequestCheckIssueVisitor(Set&lt;Check&gt; enabledChecks) {
          this.enabledChecks = enabledChecks;
          readyForReview = true;
      }
  
<span class="udiff-line-modified-removed">-     List&lt;String&gt; getMessages() {</span>
<span class="udiff-line-modified-removed">-         return new ArrayList&lt;&gt;(messages);</span>
<span class="udiff-line-modified-added">+     private void addFailureMessage(Check check, String message) {</span>
<span class="udiff-line-modified-added">+         failedChecks.put(check.getClass(), message);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     List&lt;String&gt; messages() {</span>
<span class="udiff-line-added">+         return new ArrayList&lt;&gt;(failedChecks.values());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     List&lt;String&gt; hiddenMessages() {</span>
<span class="udiff-line-added">+         return failedChecks.entrySet().stream()</span>
<span class="udiff-line-added">+                            .filter(entry -&gt; !displayedChecks.contains(entry.getKey()))</span>
<span class="udiff-line-added">+                            .map(Map.Entry::getValue)</span>
<span class="udiff-line-added">+                            .sorted()</span>
<span class="udiff-line-added">+                            .collect(Collectors.toList());</span>
      }
  
      Map&lt;String, Boolean&gt; getChecks() {
          return enabledChecks.stream()
                              .filter(check -&gt; displayedChecks.contains(check.getClass()))
                              .collect(Collectors.toMap(Check::description,
<span class="udiff-line-modified-removed">-                                                       check -&gt; !failedChecks.contains(check.getClass())));</span>
<span class="udiff-line-modified-added">+                                                       check -&gt; !failedChecks.containsKey(check.getClass())));</span>
      }
  
<span class="udiff-line-added">+ </span>
      List&lt;CheckAnnotation&gt; getAnnotations() { return annotations; }
  
      boolean isReadyForReview() {
          return readyForReview;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -79,12 +91,11 @@</span>
                       .collect(Collectors.toList());
  
          var output = new StringBuilder();
          output.append(&quot;Issue id &quot;).append(id).append(&quot; is already used in these commits:\n&quot;);
          other.forEach(h -&gt; output.append(&quot; * &quot;).append(h).append(&quot;\n&quot;));
<span class="udiff-line-modified-removed">-         messages.add(output.toString());</span>
<span class="udiff-line-removed">-         failedChecks.add(e.check().getClass());</span>
<span class="udiff-line-modified-added">+         addFailureMessage(e.check(), output.toString());</span>
          readyForReview = false;
      }
  
      @Override
      public void visit(TagIssue e) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -97,19 +108,17 @@</span>
      }
  
      @Override
      public void visit(SelfReviewIssue e)
      {
<span class="udiff-line-modified-removed">-         messages.add(&quot;Self-reviews are not allowed&quot;);</span>
<span class="udiff-line-removed">-         failedChecks.add(e.check().getClass());</span>
<span class="udiff-line-modified-added">+         addFailureMessage(e.check(), &quot;Self-reviews are not allowed&quot;);</span>
          readyForReview = false;
      }
  
      @Override
      public void visit(TooFewReviewersIssue e) {
<span class="udiff-line-modified-removed">-         messages.add(String.format(&quot;Too few reviewers with at least role %s found (have %d, need at least %d)&quot;, e.role(), e.numActual(), e.numRequired()));</span>
<span class="udiff-line-removed">-         failedChecks.add(e.check().getClass());</span>
<span class="udiff-line-modified-added">+         addFailureMessage(e.check(), String.format(&quot;Too few reviewers with at least role %s found (have %d, need at least %d)&quot;, e.role(), e.numActual(), e.numRequired()));</span>
      }
  
      @Override
      public void visit(InvalidReviewersIssue e) {
          var invalid = String.join(&quot;, &quot;, e.invalid());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -117,12 +126,11 @@</span>
      }
  
      @Override
      public void visit(MergeMessageIssue e) {
          var message = String.join(&quot;\n&quot;, e.commit().message());
<span class="udiff-line-modified-removed">-         messages.add(&quot;Merge commit message is not &quot; + e.expected() + &quot;, but: &quot; + message);</span>
<span class="udiff-line-removed">-         failedChecks.add(e.check().getClass());</span>
<span class="udiff-line-modified-added">+         addFailureMessage(e.check(), &quot;Merge commit message is not &quot; + e.expected() + &quot;, but: &quot; + message);</span>
      }
  
      @Override
      public void visit(HgTagCommitIssue e) {
          throw new IllegalStateException(&quot;Hg tag commit issue - should not happen&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -179,12 +187,11 @@</span>
          }
  
          var annotation = annotationBuilder.title(&quot;Whitespace error&quot;).build();
          annotations.add(annotation);
  
<span class="udiff-line-modified-removed">-         messages.add(&quot;Whitespace errors&quot;);</span>
<span class="udiff-line-removed">-         failedChecks.add(e.check().getClass());</span>
<span class="udiff-line-modified-added">+         addFailureMessage(e.check(), &quot;Whitespace errors&quot;);</span>
          readyForReview = false;
      }
  
      @Override
      public void visit(MessageIssue issue) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -198,27 +205,24 @@</span>
          throw new IllegalStateException(&quot;Commit message contains bad whitespace: &quot; + message);
      }
  
      @Override
      public void visit(IssuesIssue issue) {
<span class="udiff-line-modified-removed">-         messages.add(&quot;The commit message does not reference any issue. To add an issue reference to this PR, &quot; +</span>
<span class="udiff-line-modified-added">+         addFailureMessage(issue.check(), &quot;The commit message does not reference any issue. To add an issue reference to this PR, &quot; +</span>
                  &quot;edit the title to be of the format `issue number`: `message`.&quot;);
<span class="udiff-line-removed">-         failedChecks.add(issue.check().getClass());</span>
          readyForReview = false;
      }
  
      @Override
      public void visit(ExecutableIssue issue) {
<span class="udiff-line-modified-removed">-         messages.add(String.format(&quot;Executable files are not allowed (file: %s)&quot;, issue.path()));</span>
<span class="udiff-line-removed">-         failedChecks.add(issue.check().getClass());</span>
<span class="udiff-line-modified-added">+         addFailureMessage(issue.check(), String.format(&quot;Executable files are not allowed (file: %s)&quot;, issue.path()));</span>
          readyForReview = false;
      }
  
      @Override
      public void visit(SymlinkIssue issue) {
<span class="udiff-line-modified-removed">-         messages.add(String.format(&quot;Symbolic links are not allowed (file: %s)&quot;, issue.path()));</span>
<span class="udiff-line-removed">-         failedChecks.add(issue.check().getClass());</span>
<span class="udiff-line-modified-added">+         addFailureMessage(issue.check(), String.format(&quot;Symbolic links are not allowed (file: %s)&quot;, issue.path()));</span>
          readyForReview = false;
      }
  
      @Override
      public void visit(BlacklistIssue issue) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -230,10 +234,9 @@</span>
          log.fine(&quot;ignored: binary file&quot;);
      }
  
      @Override
      public void visit(ProblemListsIssue issue) {
<span class="udiff-line-modified-removed">-         failedChecks.add(issue.check().getClass());</span>
<span class="udiff-line-removed">-         messages.add(issue.issue() + &quot; is used in problem lists: &quot; + issue.files());</span>
<span class="udiff-line-modified-added">+         addFailureMessage(issue.check(), issue.issue() + &quot; is used in problem lists: &quot; + issue.files());</span>
          readyForReview = false;
      }
  }
</pre>
<center><a href="IntegrateCommand.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SponsorCommand.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>