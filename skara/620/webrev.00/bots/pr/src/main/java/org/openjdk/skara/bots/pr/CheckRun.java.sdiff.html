<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/CheckRun.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="IntegrateCommand.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/CheckRun.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
140             var error = &quot;For contributors who are not existing OpenJDK Authors, commit attribution will be taken from &quot; +
141                     &quot;the commits in the PR. However, the commits in this PR have inconsistent user names and/or &quot; +
142                     &quot;email addresses. Please amend the commits.&quot;;
143             ret.add(error);
144         }
145 
146         for (var blocker : workItem.bot.blockingCheckLabels().entrySet()) {
147             if (labels.contains(blocker.getKey())) {
148                 ret.add(blocker.getValue());
149             }
150         }
151 
152         return ret;
153     }
154 
155     private void updateCheckBuilder(CheckBuilder checkBuilder, PullRequestCheckIssueVisitor visitor, List&lt;String&gt; additionalErrors) {
156         if (visitor.isReadyForReview() &amp;&amp; additionalErrors.isEmpty()) {
157             checkBuilder.complete(true);
158         } else {
159             checkBuilder.title(&quot;Required&quot;);
<span class="line-modified">160             var summary = Stream.concat(visitor.getMessages().stream(), additionalErrors.stream())</span>
161                                 .sorted()
162                                 .map(m -&gt; &quot;- &quot; + m)
163                                 .collect(Collectors.joining(&quot;\n&quot;));
164             checkBuilder.summary(summary);
165             for (var annotation : visitor.getAnnotations()) {
166                 checkBuilder.annotation(annotation);
167             }
168             checkBuilder.complete(false);
169         }
170     }
171 
172     private void updateReadyForReview(PullRequestCheckIssueVisitor visitor, List&lt;String&gt; additionalErrors) {
173         // Additional errors are not allowed
174         if (!additionalErrors.isEmpty()) {
175             newLabels.remove(&quot;rfr&quot;);
176             return;
177         }
178 
179         // Draft requests are not for review
180         if (pr.isDraft()) {
</pre>
<hr />
<pre>
257     }
258 
259     private Optional&lt;String&gt; getContributorsList(List&lt;Comment&gt; comments) {
260         var contributors = Contributors.contributors(pr.repository().forge().currentUser(), comments)
261                                        .stream()
262                                        .map(c -&gt; &quot; * &quot; + formatContributor(c))
263                                        .collect(Collectors.joining(&quot;\n&quot;));
264         if (contributors.length() &gt; 0) {
265             return Optional.of(contributors);
266         } else {
267             return Optional.empty();
268         }
269     }
270 
271     private String getStatusMessage(List&lt;Comment&gt; comments, List&lt;Review&gt; reviews, PullRequestCheckIssueVisitor visitor, List&lt;String&gt; additionalErrors) {
272         var progressBody = new StringBuilder();
273         progressBody.append(&quot;---------\n&quot;);
274         progressBody.append(&quot;### Progress\n&quot;);
275         progressBody.append(getChecksList(visitor));
276 
<span class="line-modified">277         if (!additionalErrors.isEmpty()) {</span>



278             progressBody.append(&quot;\n\n### Error&quot;);
<span class="line-modified">279             if (additionalErrors.size() &gt; 1) {</span>
280                 progressBody.append(&quot;s&quot;);
281             }
282             progressBody.append(&quot;\n&quot;);
<span class="line-modified">283             progressBody.append(getAdditionalErrorsList(additionalErrors));</span>
284         }
285 
286         var issue = Issue.fromString(pr.title());
287         var issueProject = workItem.bot.issueProject();
288         if (issueProject != null &amp;&amp; issue.isPresent()) {
289             var allIssues = new ArrayList&lt;Issue&gt;();
290             allIssues.add(issue.get());
291             allIssues.addAll(SolvesTracker.currentSolved(pr.repository().forge().currentUser(), comments));
292             progressBody.append(&quot;\n\n### Issue&quot;);
293             if (allIssues.size() &gt; 1) {
294                 progressBody.append(&quot;s&quot;);
295             }
296             progressBody.append(&quot;\n&quot;);
297             for (var currentIssue : allIssues) {
298                 progressBody.append(&quot; * &quot;);
299                 try {
300                     var iss = issueProject.issue(currentIssue.id());
301                     if (iss.isPresent()) {
302                         progressBody.append(&quot;[&quot;);
303                         progressBody.append(iss.get().id());
</pre>
<hr />
<pre>
615                 additionalErrors = botSpecificChecks(localHash);
616             } else {
617                 if (additionalErrors.isEmpty()) {
618                     additionalErrors = List.of(&quot;This PR contains no changes&quot;);
619                 }
620             }
621             updateCheckBuilder(checkBuilder, visitor, additionalErrors);
622             updateReadyForReview(visitor, additionalErrors);
623 
624             // Calculate and update the status message if needed
625             var statusMessage = getStatusMessage(comments, activeReviews, visitor, additionalErrors);
626             var updatedBody = updateStatusMessage(statusMessage);
627 
628             // Post / update approval messages (only needed if the review itself can&#39;t contain a body)
629             if (!pr.repository().forge().supportsReviewBody()) {
630                 updateReviewedMessages(comments, allReviews);
631             }
632 
633             var commit = localRepo.lookup(localHash).orElseThrow();
634             var commitMessage = String.join(&quot;\n&quot;, commit.message());
<span class="line-modified">635             var readyForIntegration = visitor.getMessages().isEmpty() &amp;&amp; additionalErrors.isEmpty();</span>
636             updateMergeReadyComment(readyForIntegration, commitMessage, comments, activeReviews, rebasePossible);
637             if (readyForIntegration &amp;&amp; rebasePossible) {
638                 newLabels.add(&quot;ready&quot;);
639             } else {
640                 newLabels.remove(&quot;ready&quot;);
641             }
642             if (!rebasePossible) {
643                 if (!labels.contains(&quot;failed-auto-merge&quot;)) {
644                     addOutdatedComment(comments);
645                 }
646                 newLabels.add(&quot;merge-conflict&quot;);
647             } else {
648                 newLabels.remove(&quot;merge-conflict&quot;);
649             }
650 
651             var branchNames = pr.repository().branches().stream().map(HostedBranch::name).collect(Collectors.toSet());
652             if (!pr.repository().url().equals(pr.sourceRepository().url()) &amp;&amp; branchNames.contains(pr.sourceRef())) {
653                 addSourceBranchWarningComment(comments);
654             }
655 
</pre>
</td>
<td>
<hr />
<pre>
140             var error = &quot;For contributors who are not existing OpenJDK Authors, commit attribution will be taken from &quot; +
141                     &quot;the commits in the PR. However, the commits in this PR have inconsistent user names and/or &quot; +
142                     &quot;email addresses. Please amend the commits.&quot;;
143             ret.add(error);
144         }
145 
146         for (var blocker : workItem.bot.blockingCheckLabels().entrySet()) {
147             if (labels.contains(blocker.getKey())) {
148                 ret.add(blocker.getValue());
149             }
150         }
151 
152         return ret;
153     }
154 
155     private void updateCheckBuilder(CheckBuilder checkBuilder, PullRequestCheckIssueVisitor visitor, List&lt;String&gt; additionalErrors) {
156         if (visitor.isReadyForReview() &amp;&amp; additionalErrors.isEmpty()) {
157             checkBuilder.complete(true);
158         } else {
159             checkBuilder.title(&quot;Required&quot;);
<span class="line-modified">160             var summary = Stream.concat(visitor.messages().stream(), additionalErrors.stream())</span>
161                                 .sorted()
162                                 .map(m -&gt; &quot;- &quot; + m)
163                                 .collect(Collectors.joining(&quot;\n&quot;));
164             checkBuilder.summary(summary);
165             for (var annotation : visitor.getAnnotations()) {
166                 checkBuilder.annotation(annotation);
167             }
168             checkBuilder.complete(false);
169         }
170     }
171 
172     private void updateReadyForReview(PullRequestCheckIssueVisitor visitor, List&lt;String&gt; additionalErrors) {
173         // Additional errors are not allowed
174         if (!additionalErrors.isEmpty()) {
175             newLabels.remove(&quot;rfr&quot;);
176             return;
177         }
178 
179         // Draft requests are not for review
180         if (pr.isDraft()) {
</pre>
<hr />
<pre>
257     }
258 
259     private Optional&lt;String&gt; getContributorsList(List&lt;Comment&gt; comments) {
260         var contributors = Contributors.contributors(pr.repository().forge().currentUser(), comments)
261                                        .stream()
262                                        .map(c -&gt; &quot; * &quot; + formatContributor(c))
263                                        .collect(Collectors.joining(&quot;\n&quot;));
264         if (contributors.length() &gt; 0) {
265             return Optional.of(contributors);
266         } else {
267             return Optional.empty();
268         }
269     }
270 
271     private String getStatusMessage(List&lt;Comment&gt; comments, List&lt;Review&gt; reviews, PullRequestCheckIssueVisitor visitor, List&lt;String&gt; additionalErrors) {
272         var progressBody = new StringBuilder();
273         progressBody.append(&quot;---------\n&quot;);
274         progressBody.append(&quot;### Progress\n&quot;);
275         progressBody.append(getChecksList(visitor));
276 
<span class="line-modified">277         var allAdditionalErrors = Stream.concat(visitor.hiddenMessages().stream(), additionalErrors.stream())</span>
<span class="line-added">278                                         .sorted()</span>
<span class="line-added">279                                         .collect(Collectors.toList());</span>
<span class="line-added">280         if (!allAdditionalErrors.isEmpty()) {</span>
281             progressBody.append(&quot;\n\n### Error&quot;);
<span class="line-modified">282             if (allAdditionalErrors.size() &gt; 1) {</span>
283                 progressBody.append(&quot;s&quot;);
284             }
285             progressBody.append(&quot;\n&quot;);
<span class="line-modified">286             progressBody.append(getAdditionalErrorsList(allAdditionalErrors));</span>
287         }
288 
289         var issue = Issue.fromString(pr.title());
290         var issueProject = workItem.bot.issueProject();
291         if (issueProject != null &amp;&amp; issue.isPresent()) {
292             var allIssues = new ArrayList&lt;Issue&gt;();
293             allIssues.add(issue.get());
294             allIssues.addAll(SolvesTracker.currentSolved(pr.repository().forge().currentUser(), comments));
295             progressBody.append(&quot;\n\n### Issue&quot;);
296             if (allIssues.size() &gt; 1) {
297                 progressBody.append(&quot;s&quot;);
298             }
299             progressBody.append(&quot;\n&quot;);
300             for (var currentIssue : allIssues) {
301                 progressBody.append(&quot; * &quot;);
302                 try {
303                     var iss = issueProject.issue(currentIssue.id());
304                     if (iss.isPresent()) {
305                         progressBody.append(&quot;[&quot;);
306                         progressBody.append(iss.get().id());
</pre>
<hr />
<pre>
618                 additionalErrors = botSpecificChecks(localHash);
619             } else {
620                 if (additionalErrors.isEmpty()) {
621                     additionalErrors = List.of(&quot;This PR contains no changes&quot;);
622                 }
623             }
624             updateCheckBuilder(checkBuilder, visitor, additionalErrors);
625             updateReadyForReview(visitor, additionalErrors);
626 
627             // Calculate and update the status message if needed
628             var statusMessage = getStatusMessage(comments, activeReviews, visitor, additionalErrors);
629             var updatedBody = updateStatusMessage(statusMessage);
630 
631             // Post / update approval messages (only needed if the review itself can&#39;t contain a body)
632             if (!pr.repository().forge().supportsReviewBody()) {
633                 updateReviewedMessages(comments, allReviews);
634             }
635 
636             var commit = localRepo.lookup(localHash).orElseThrow();
637             var commitMessage = String.join(&quot;\n&quot;, commit.message());
<span class="line-modified">638             var readyForIntegration = visitor.messages().isEmpty() &amp;&amp; additionalErrors.isEmpty();</span>
639             updateMergeReadyComment(readyForIntegration, commitMessage, comments, activeReviews, rebasePossible);
640             if (readyForIntegration &amp;&amp; rebasePossible) {
641                 newLabels.add(&quot;ready&quot;);
642             } else {
643                 newLabels.remove(&quot;ready&quot;);
644             }
645             if (!rebasePossible) {
646                 if (!labels.contains(&quot;failed-auto-merge&quot;)) {
647                     addOutdatedComment(comments);
648                 }
649                 newLabels.add(&quot;merge-conflict&quot;);
650             } else {
651                 newLabels.remove(&quot;merge-conflict&quot;);
652             }
653 
654             var branchNames = pr.repository().branches().stream().map(HostedBranch::name).collect(Collectors.toSet());
655             if (!pr.repository().url().equals(pr.sourceRepository().url()) &amp;&amp; branchNames.contains(pr.sourceRef())) {
656                 addSourceBranchWarningComment(comments);
657             }
658 
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="IntegrateCommand.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>