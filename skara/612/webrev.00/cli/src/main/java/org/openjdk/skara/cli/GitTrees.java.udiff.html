<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff cli/src/main/java/org/openjdk/skara/cli/GitTrees.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../skara.gitconfig.udiff.html" target="_top">next &gt;</a></center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitTrees.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -30,10 +30,15 @@</span>
  import java.nio.charset.StandardCharsets;
  import java.util.*;
  import java.util.stream.Collectors;
  
  public class GitTrees {
<span class="udiff-line-added">+     private static boolean isRepository(Path root, boolean isMercurial) {</span>
<span class="udiff-line-added">+         var hidden = isMercurial ? root.resolve(&quot;.hg&quot;) : root.resolve(&quot;.git&quot;);</span>
<span class="udiff-line-added">+         return Files.exists(hidden) &amp;&amp; Files.isDirectory(hidden);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private static Path root(boolean isMercurial) throws IOException, InterruptedException {
          var pb = isMercurial ?
              new ProcessBuilder(&quot;hg&quot;, &quot;root&quot;) :
              new ProcessBuilder(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--show-toplevel&quot;);
          pb.redirectOutput(ProcessBuilder.Redirect.PIPE);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -65,10 +70,29 @@</span>
  
      private static List&lt;Path&gt; tconfig(Path root, boolean isMercurial) throws IOException {
          var subrepos = subrepos(root, isMercurial);
          var treesFile = treesFile(root, isMercurial);
          Files.write(treesFile, subrepos.stream().map(Path::toString).collect(Collectors.toList()));
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         for (var subrepo : subrepos) {</span>
<span class="udiff-line-added">+             var subSubRepos = new ArrayList&lt;Path&gt;();</span>
<span class="udiff-line-added">+             for (var repo : subrepos) {</span>
<span class="udiff-line-added">+                 if (!repo.equals(subrepo) &amp;&amp; repo.startsWith(subrepo)) {</span>
<span class="udiff-line-added">+                     subSubRepos.add(repo);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (!subSubRepos.isEmpty()) {</span>
<span class="udiff-line-added">+                 var subSubTreesFile = treesFile(root.resolve(subrepo), isMercurial);</span>
<span class="udiff-line-added">+                 Files.write(subSubTreesFile,</span>
<span class="udiff-line-added">+                             subSubRepos.stream()</span>
<span class="udiff-line-added">+                                        .map(subrepo::relativize)</span>
<span class="udiff-line-added">+                                        .map(Path::toString)</span>
<span class="udiff-line-added">+                                        .sorted()</span>
<span class="udiff-line-added">+                                        .collect(Collectors.toList()));</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          return subrepos;
      }
  
      private static List&lt;Path&gt; trees(Path root, boolean isMercurial) throws IOException {
          var file = treesFile(root, isMercurial);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -78,10 +102,22 @@</span>
          }
  
          return null;
      }
  
<span class="udiff-line-added">+     private static void treconfigure(Path root, boolean isMercurial) throws IOException {</span>
<span class="udiff-line-added">+         var existing = trees(root, isMercurial);</span>
<span class="udiff-line-added">+         if (existing != null) {</span>
<span class="udiff-line-added">+             for (var subrepo : existing) {</span>
<span class="udiff-line-added">+                 var subRoot = root.resolve(subrepo);</span>
<span class="udiff-line-added">+                 var file = treesFile(subRoot, isMercurial);</span>
<span class="udiff-line-added">+                 Files.deleteIfExists(file);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         tconfig(root, isMercurial);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      public static void main(String[] args) throws IOException, InterruptedException {
          if (args.length == 1 &amp;&amp; args[0].equals(&quot;--version&quot;)) {
              System.out.println(&quot;git-trees version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));
              System.exit(0);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -92,33 +128,44 @@</span>
          }
  
          HttpProxy.setup();
  
          var isMercurial = args.length &gt; 0 &amp;&amp; (args[0].equals(&quot;--mercurial&quot;) || args[0].equals(&quot;-m&quot;));
<span class="udiff-line-added">+         var isReconfigure = isMercurial ?</span>
<span class="udiff-line-added">+             args.length &gt; 1 &amp;&amp; args[1].equals(&quot;treconfigure&quot;) :</span>
<span class="udiff-line-added">+             args.length &gt; 0 &amp;&amp; args[0].equals(&quot;treconfigure&quot;);</span>
<span class="udiff-line-added">+ </span>
          var root = root(isMercurial);
<span class="udiff-line-added">+         if (isReconfigure) {</span>
<span class="udiff-line-added">+             treconfigure(root, isMercurial);</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          var trees = trees(root, isMercurial);
          if (trees == null) {
              trees = tconfig(root, isMercurial);
          }
  
          var command = new ArrayList&lt;String&gt;();
          command.add(isMercurial ? &quot;hg&quot; : &quot;git&quot;);
          for (var i = isMercurial ? 1 : 0; i &lt; args.length; i++) {
              command.add(args[i]);
          }
<span class="udiff-line-removed">-         System.out.println(&quot;executing: &quot; + String.join(&quot; &quot;, command));</span>
          var pb = new ProcessBuilder(command);
          pb.inheritIO();
  
          System.out.println(&quot;[&quot; + root.toString() + &quot;]&quot;);
          pb.directory(root.toFile());
          var ret = pb.start().waitFor();
  
          for (var path : trees) {
<span class="udiff-line-modified-removed">-             System.out.println(&quot;[&quot; + root.resolve(path).toString() + &quot;]&quot;);</span>
<span class="udiff-line-modified-removed">-             pb.directory(root.resolve(path).toFile());</span>
<span class="udiff-line-modified-removed">-             ret += pb.start().waitFor();</span>
<span class="udiff-line-modified-added">+             var subroot = root.resolve(path);</span>
<span class="udiff-line-modified-added">+             if (isRepository(subroot, isMercurial)) {</span>
<span class="udiff-line-modified-added">+                 System.out.println(&quot;[&quot; + root.resolve(path).toString() + &quot;]&quot;);</span>
<span class="udiff-line-added">+                 pb.directory(subroot.toFile());</span>
<span class="udiff-line-added">+                 ret += pb.start().waitFor();</span>
<span class="udiff-line-added">+             }</span>
          }
  
          System.exit(ret);
      }
  }
</pre>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../skara.gitconfig.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>