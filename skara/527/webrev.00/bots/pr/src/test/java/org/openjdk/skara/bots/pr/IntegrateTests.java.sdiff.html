<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/test/java/org/openjdk/skara/bots/pr/IntegrateTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/IntegrateCommand.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/pr/src/test/java/org/openjdk/skara/bots/pr/IntegrateTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
405             // Populate the projects repository
406             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
407             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
408             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
409             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
410 
411             // Make a change with a corresponding PR
412             var editHash = CheckableRepository.appendAndCommit(localRepo);
413             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
414             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
415 
416             // Issue a merge command not as the PR author
417             var externalPr = external.pullRequest(pr.id());
418             externalPr.addComment(&quot;/integrate&quot;);
419             TestBotRunner.runPeriodicItems(mergeBot);
420 
421             // The bot should reply with an error message
422             var error = pr.comments().stream()
423                           .filter(comment -&gt; comment.body().contains(&quot;Only the author&quot;))
424                           .count();

















































425             assertEquals(1, error);
426         }
427     }
428 
429     @Test
430     void autoRebase(TestInfo testInfo) throws IOException {
431         try (var credentials = new HostCredentials(testInfo);
432              var tempFolder = new TemporaryDirectory();
433              var pushedFolder = new TemporaryDirectory()) {
434 
435             var author = credentials.getHostedRepository();
436             var integrator = credentials.getHostedRepository();
437             var censusBuilder = credentials.getCensusBuilder()
438                                            .addCommitter(author.forge().currentUser().id())
439                                            .addReviewer(integrator.forge().currentUser().id());
440             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
441 
442             // Populate the projects repository
443             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
444             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
</pre>
</td>
<td>
<hr />
<pre>
405             // Populate the projects repository
406             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
407             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
408             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
409             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
410 
411             // Make a change with a corresponding PR
412             var editHash = CheckableRepository.appendAndCommit(localRepo);
413             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
414             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
415 
416             // Issue a merge command not as the PR author
417             var externalPr = external.pullRequest(pr.id());
418             externalPr.addComment(&quot;/integrate&quot;);
419             TestBotRunner.runPeriodicItems(mergeBot);
420 
421             // The bot should reply with an error message
422             var error = pr.comments().stream()
423                           .filter(comment -&gt; comment.body().contains(&quot;Only the author&quot;))
424                           .count();
<span class="line-added">425             assertEquals(1, error);</span>
<span class="line-added">426         }</span>
<span class="line-added">427     }</span>
<span class="line-added">428 </span>
<span class="line-added">429     @Test</span>
<span class="line-added">430     void invalidCommandSponsor(TestInfo testInfo) throws IOException {</span>
<span class="line-added">431         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">432              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">433             var author = credentials.getHostedRepository();</span>
<span class="line-added">434             var integrator = credentials.getHostedRepository();</span>
<span class="line-added">435             var external = credentials.getHostedRepository();</span>
<span class="line-added">436 </span>
<span class="line-added">437             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added">438                                            .addAuthor(author.forge().currentUser().id())</span>
<span class="line-added">439                                            .addReviewer(integrator.forge().currentUser().id())</span>
<span class="line-added">440                                            .addCommitter(external.forge().currentUser().id());</span>
<span class="line-added">441             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();</span>
<span class="line-added">442 </span>
<span class="line-added">443             // Populate the projects repository</span>
<span class="line-added">444             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
<span class="line-added">445             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added">446             assertFalse(CheckableRepository.hasBeenEdited(localRepo));</span>
<span class="line-added">447             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-added">448 </span>
<span class="line-added">449             // Make a change with a corresponding PR</span>
<span class="line-added">450             var editHash = CheckableRepository.appendAndCommit(localRepo);</span>
<span class="line-added">451             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);</span>
<span class="line-added">452             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);</span>
<span class="line-added">453 </span>
<span class="line-added">454             // Approve it as another user</span>
<span class="line-added">455             var approvalPr = integrator.pullRequest(pr.id());</span>
<span class="line-added">456             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);</span>
<span class="line-added">457             TestBotRunner.runPeriodicItems(mergeBot);</span>
<span class="line-added">458 </span>
<span class="line-added">459             // Mark it as ready for integration</span>
<span class="line-added">460             pr.addComment(&quot;/integrate&quot;);</span>
<span class="line-added">461             TestBotRunner.runPeriodicItems(mergeBot);</span>
<span class="line-added">462 </span>
<span class="line-added">463             // Issue a merge command not as the PR author</span>
<span class="line-added">464             var externalPr = external.pullRequest(pr.id());</span>
<span class="line-added">465             externalPr.addComment(&quot;/integrate&quot;);</span>
<span class="line-added">466             TestBotRunner.runPeriodicItems(mergeBot);</span>
<span class="line-added">467 </span>
<span class="line-added">468             // The bot should reply with an error message</span>
<span class="line-added">469             var error = pr.comments().stream()</span>
<span class="line-added">470                           .filter(comment -&gt; comment.body().contains(&quot;Only the author&quot;))</span>
<span class="line-added">471                           .filter(comment -&gt; comment.body().contains(&quot;did you mean to&quot;))</span>
<span class="line-added">472                           .filter(comment -&gt; comment.body().contains(&quot;`/sponsor`&quot;))</span>
<span class="line-added">473                           .count();</span>
474             assertEquals(1, error);
475         }
476     }
477 
478     @Test
479     void autoRebase(TestInfo testInfo) throws IOException {
480         try (var credentials = new HostCredentials(testInfo);
481              var tempFolder = new TemporaryDirectory();
482              var pushedFolder = new TemporaryDirectory()) {
483 
484             var author = credentials.getHostedRepository();
485             var integrator = credentials.getHostedRepository();
486             var censusBuilder = credentials.getCensusBuilder()
487                                            .addCommitter(author.forge().currentUser().id())
488                                            .addReviewer(integrator.forge().currentUser().id());
489             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
490 
491             // Populate the projects repository
492             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
493             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/IntegrateCommand.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>