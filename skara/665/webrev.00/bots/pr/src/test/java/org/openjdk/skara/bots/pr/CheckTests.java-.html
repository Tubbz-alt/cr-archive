<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.pr;
  24 
  25 import org.junit.jupiter.api.*;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.test.*;
  28 
  29 import java.io.IOException;
  30 import java.nio.charset.StandardCharsets;
  31 import java.nio.file.*;
  32 import java.nio.file.attribute.PosixFilePermission;
  33 import java.util.*;
  34 import java.util.regex.Pattern;
  35 
  36 import static org.junit.jupiter.api.Assertions.*;
  37 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  38 
  39 class CheckTests {
  40     @Test
  41     void simpleCommit(TestInfo testInfo) throws IOException {
  42         try (var credentials = new HostCredentials(testInfo);
  43              var tempFolder = new TemporaryDirectory()) {
  44             var author = credentials.getHostedRepository();
  45             var reviewer = credentials.getHostedRepository();
  46 
  47             var censusBuilder = credentials.getCensusBuilder()
  48                                            .addAuthor(author.forge().currentUser().id())
  49                                            .addReviewer(reviewer.forge().currentUser().id());
  50             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
  51 
  52             // Populate the projects repository
  53             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
  54             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
  55             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
  56 
  57             // Make a change with a corresponding PR
  58             var editHash = CheckableRepository.appendAndCommit(localRepo);
  59             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
  60             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
  61 
  62             // Check the status
  63             TestBotRunner.runPeriodicItems(checkBot);
  64 
  65             // Verify that the check succeeded
  66             var checks = pr.checks(editHash);
  67             assertEquals(1, checks.size());
  68             var check = checks.get(&quot;jcheck&quot;);
  69             assertEquals(CheckStatus.SUCCESS, check.status());
  70 
  71             // The PR should now be ready for review
  72             assertTrue(pr.labels().contains(&quot;rfr&quot;));
  73             assertFalse(pr.labels().contains(&quot;ready&quot;));
  74 
  75             // Approve it as another user
  76             var approvalPr = reviewer.pullRequest(pr.id());
  77             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
  78 
  79             // Check the status again
  80             TestBotRunner.runPeriodicItems(checkBot);
  81 
  82             // The check should now be successful
  83             checks = pr.checks(editHash);
  84             assertEquals(1, checks.size());
  85             check = checks.get(&quot;jcheck&quot;);
  86             assertEquals(CheckStatus.SUCCESS, check.status());
  87 
  88             // The PR should now be ready
  89             assertTrue(pr.labels().contains(&quot;ready&quot;));
  90         }
  91     }
  92 
  93     @Test
  94     void whitespaceIssue(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory()) {
  97 
  98             var author = credentials.getHostedRepository();
  99             var reviewer = credentials.getHostedRepository();
 100 
 101             var censusBuilder = credentials.getCensusBuilder()
 102                                            .addAuthor(author.forge().currentUser().id())
 103                                            .addReviewer(reviewer.forge().currentUser().id());
 104             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 105 
 106             // Populate the projects repository
 107             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 108             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 109             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 110 
 111             // Make a change with a corresponding PR
 112             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line with a trailing whitespace   &quot;);
 113             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 114             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 115 
 116             // Check the status
 117             TestBotRunner.runPeriodicItems(checkBot);
 118 
 119             // The PR should not be flagged as ready for review
 120             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 121 
 122             // Approve it as another user
 123             var approvalPr = reviewer.pullRequest(pr.id());
 124             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 125 
 126             // Check the status
 127             TestBotRunner.runPeriodicItems(checkBot);
 128 
 129             // Verify that the check failed
 130             var checks = pr.checks(editHash);
 131             assertEquals(1, checks.size());
 132             var check = checks.get(&quot;jcheck&quot;);
 133             assertEquals(CheckStatus.FAILURE, check.status());
 134 
 135             // The PR should not still not be flagged as ready for review
 136             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 137 
 138             // Remove the trailing whitespace in a new commit
 139             editHash = CheckableRepository.replaceAndCommit(localRepo, &quot;A line without a trailing whitespace&quot;);
 140             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 141 
 142             // Make sure that the push registered
 143             var lastHeadHash = pr.headHash();
 144             var refreshCount = 0;
 145             do {
 146                 pr = author.pullRequest(pr.id());
 147                 if (refreshCount++ &gt; 100) {
 148                     fail(&quot;The PR did not update after the new push&quot;);
 149                 }
 150             } while (pr.headHash().equals(lastHeadHash));
 151 
 152             // Check the status again
 153             TestBotRunner.runPeriodicItems(checkBot);
 154 
 155             // The PR should now be ready
 156             assertTrue(pr.labels().contains(&quot;ready&quot;));
 157 
 158             // The check should now be successful
 159             checks = pr.checks(editHash);
 160             assertEquals(1, checks.size());
 161             check = checks.get(&quot;jcheck&quot;);
 162             assertEquals(CheckStatus.SUCCESS, check.status());
 163         }
 164     }
 165 
 166     @Test
 167     void multipleReviews(TestInfo testInfo) throws IOException {
 168         try (var credentials = new HostCredentials(testInfo);
 169              var tempFolder = new TemporaryDirectory()) {
 170 
 171             var author = credentials.getHostedRepository();
 172             var reviewer = credentials.getHostedRepository();
 173             var commenter = credentials.getHostedRepository();
 174 
 175             var censusBuilder = credentials.getCensusBuilder()
 176                                            .addAuthor(author.forge().currentUser().id())
 177                                            .addReviewer(reviewer.forge().currentUser().id())
 178                                            .addReviewer(commenter.forge().currentUser().id());
 179 
 180             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 181 
 182             // Populate the projects repository
 183             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 184             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 185             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 186 
 187             // Make a change with a corresponding PR
 188             var editHash = CheckableRepository.appendAndCommit(localRepo);
 189             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 190             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 191 
 192             // Let the status bot inspect the PR
 193             TestBotRunner.runPeriodicItems(checkBot);
 194             assertFalse(authorPr.body().contains(&quot;Reviewers&quot;));
 195 
 196             // Approve it
 197             var reviewerPr = reviewer.pullRequest(authorPr.id());
 198             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Reviewers&quot;);
 199             TestBotRunner.runPeriodicItems(checkBot);
 200 
 201             // Refresh the PR and check that it has been approved
 202             authorPr = author.pullRequest(authorPr.id());
 203             assertTrue(authorPr.body().contains(&quot;Reviewers&quot;));
 204 
 205             // Update the file after approval
 206             editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Now I&#39;ve gone and changed it&quot;);
 207             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 208 
 209             // Make sure that the push registered
 210             var lastHeadHash = authorPr.headHash();
 211             var refreshCount = 0;
 212             do {
 213                 authorPr = author.pullRequest(authorPr.id());
 214                 if (refreshCount++ &gt; 100) {
 215                     fail(&quot;The PR did not update after the new push&quot;);
 216                 }
 217             } while (authorPr.headHash().equals(lastHeadHash));
 218 
 219             // Check that the review is flagged as stale
 220             TestBotRunner.runPeriodicItems(checkBot);
 221             authorPr = author.pullRequest(authorPr.id());
 222             assertTrue(authorPr.body().contains(&quot;Review applies to&quot;));
 223 
 224             // Now we can approve it again
 225             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 226             TestBotRunner.runPeriodicItems(checkBot);
 227 
 228             // Refresh the PR and check that it has been approved (once) and is no longer stale
 229             authorPr = author.pullRequest(authorPr.id());
 230             assertTrue(authorPr.body().contains(&quot;Reviewers&quot;));
 231             assertEquals(1, authorPr.body().split(&quot;Generated Reviewer&quot;, -1).length - 1);
 232             assertTrue(authorPr.reviews().size() &gt;= 1);
 233             assertFalse(authorPr.body().contains(&quot;Note&quot;));
 234 
 235             // Add a review with disapproval
 236             var commenterPr = commenter.pullRequest(authorPr.id());
 237             commenterPr.addReview(Review.Verdict.DISAPPROVED, &quot;Disapproved&quot;);
 238             TestBotRunner.runPeriodicItems(checkBot);
 239 
 240             // Refresh the PR and check that it still only approved once (but two reviews) and is no longer stale
 241             authorPr = author.pullRequest(authorPr.id());
 242             assertTrue(authorPr.body().contains(&quot;Reviewers&quot;));
 243             assertEquals(1, authorPr.body().split(&quot;Generated Reviewer&quot;, -1).length - 1);
 244             assertTrue(authorPr.reviews().size() &gt;= 2);
 245             assertFalse(authorPr.body().contains(&quot;Note&quot;));
 246         }
 247     }
 248 
 249     @Test
 250     void selfReview(TestInfo testInfo) throws IOException {
 251         try (var credentials = new HostCredentials(testInfo);
 252              var tempFolder = new TemporaryDirectory()) {
 253 
 254             var author = credentials.getHostedRepository();
 255 
 256             var censusBuilder = credentials.getCensusBuilder()
 257                                            .addReviewer(author.forge().currentUser().id());
 258 
 259             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 260 
 261             // Populate the projects repository
 262             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 263             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 264             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 265 
 266             // Make a change with a corresponding PR
 267             var editHash = CheckableRepository.appendAndCommit(localRepo);
 268             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 269             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 270 
 271             // Let the status bot inspect the PR
 272             TestBotRunner.runPeriodicItems(checkBot);
 273             assertFalse(authorPr.body().contains(&quot;Reviewers&quot;));
 274 
 275             // Approve it
 276             authorPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 277             TestBotRunner.runPeriodicItems(checkBot);
 278 
 279             // Refresh the PR and check that it has been approved
 280             authorPr = author.pullRequest(authorPr.id());
 281             assertTrue(authorPr.body().contains(&quot;Reviewers&quot;));
 282 
 283             // Verify that the check failed
 284             var checks = authorPr.checks(editHash);
 285             assertEquals(1, checks.size());
 286             var check = checks.get(&quot;jcheck&quot;);
 287             assertEquals(CheckStatus.FAILURE, check.status());
 288         }
 289     }
 290 
 291     @Test
 292     void multipleCommitters(TestInfo testInfo) throws IOException {
 293         try (var credentials = new HostCredentials(testInfo);
 294              var tempFolder = new TemporaryDirectory()) {
 295             var author = credentials.getHostedRepository();
 296             var reviewer = credentials.getHostedRepository();
 297 
 298             var censusBuilder = credentials.getCensusBuilder()
 299                                            .addReviewer(reviewer.forge().currentUser().id());
 300             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 301 
 302             // Populate the projects repository
 303             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 304             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 305             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 306 
 307             // Make two changes with different authors
 308             CheckableRepository.appendAndCommit(localRepo, &quot;First edit&quot;, &quot;Edit by number 1&quot;,
 309                                                 &quot;number1&quot;, &quot;number1@none.none&quot;);
 310             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Second edit&quot;, &quot;Edit by number 2&quot;,
 311                                                                &quot;number2&quot;, &quot;number2@none.none&quot;);
 312             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 313             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 314 
 315             // Check the status
 316             TestBotRunner.runPeriodicItems(checkBot);
 317 
 318             // Verify that the check failed
 319             var checks = pr.checks(editHash);
 320             assertEquals(1, checks.size());
 321             var check = checks.get(&quot;jcheck&quot;);
 322             assertEquals(CheckStatus.FAILURE, check.status());
 323 
 324             // Approve it as another user
 325             var approvalPr = reviewer.pullRequest(pr.id());
 326             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 327 
 328             // Check the status again
 329             TestBotRunner.runPeriodicItems(checkBot);
 330 
 331             // The check should still be failing
 332             checks = pr.checks(editHash);
 333             assertEquals(1, checks.size());
 334             check = checks.get(&quot;jcheck&quot;);
 335             assertEquals(CheckStatus.FAILURE, check.status());
 336 
 337             // The PR should not be flagged as ready for review, as multiple committers is a problem
 338             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 339         }
 340     }
 341 
 342     @Test
 343     void updatedContentFailsCheck(TestInfo testInfo) throws IOException {
 344         try (var credentials = new HostCredentials(testInfo);
 345              var tempFolder = new TemporaryDirectory()) {
 346             var author = credentials.getHostedRepository();
 347             var reviewer = credentials.getHostedRepository();
 348 
 349             var censusBuilder = credentials.getCensusBuilder()
 350                                            .addAuthor(author.forge().currentUser().id())
 351                                            .addReviewer(reviewer.forge().currentUser().id());
 352             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 353 
 354             // Populate the projects repository
 355             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 356             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 357             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 358 
 359             // Make a change with a corresponding PR
 360             var editHash = CheckableRepository.appendAndCommit(localRepo);
 361             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 362             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 363 
 364             // Check the status
 365             TestBotRunner.runPeriodicItems(checkBot);
 366 
 367             // Verify that the check passed
 368             var checks = pr.checks(editHash);
 369             assertEquals(1, checks.size());
 370             var check = checks.get(&quot;jcheck&quot;);
 371             assertEquals(CheckStatus.SUCCESS, check.status());
 372 
 373             // The PR should now be ready for review
 374             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 375             assertFalse(pr.labels().contains(&quot;ready&quot;));
 376 
 377             // Approve it as another user
 378             var approvalPr = reviewer.pullRequest(pr.id());
 379             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 380 
 381             // Check the status again
 382             TestBotRunner.runPeriodicItems(checkBot);
 383 
 384             // The check should now be successful
 385             checks = pr.checks(editHash);
 386             assertEquals(1, checks.size());
 387             check = checks.get(&quot;jcheck&quot;);
 388             assertEquals(CheckStatus.SUCCESS, check.status());
 389 
 390             // The PR should now be ready
 391             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 392             assertTrue(pr.labels().contains(&quot;ready&quot;));
 393 
 394             var addedHash = CheckableRepository.appendAndCommit(localRepo, &quot;trailing whitespace   &quot;);
 395             localRepo.push(addedHash, author.url(), &quot;edit&quot;);
 396 
 397             // Make sure that the push registered
 398             var lastHeadHash = pr.headHash();
 399             var refreshCount = 0;
 400             do {
 401                 pr = author.pullRequest(pr.id());
 402                 if (refreshCount++ &gt; 100) {
 403                     fail(&quot;The PR did not update after the new push&quot;);
 404                 }
 405             } while (pr.headHash().equals(lastHeadHash));
 406 
 407             // Check the status
 408             TestBotRunner.runPeriodicItems(checkBot);
 409 
 410             // The PR is now neither ready for review nor integration
 411             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 412             assertFalse(pr.labels().contains(&quot;ready&quot;));
 413 
 414             // The check should now be failing
 415             checks = pr.checks(addedHash);
 416             assertEquals(1, checks.size());
 417             check = checks.get(&quot;jcheck&quot;);
 418             assertEquals(CheckStatus.FAILURE, check.status());
 419         }
 420     }
 421 
 422     @Test
 423     void individualReviewComments(TestInfo testInfo) throws IOException {
 424         try (var credentials = new HostCredentials(testInfo);
 425              var tempFolder = new TemporaryDirectory()) {
 426             var author = credentials.getHostedRepository();
 427             var reviewer = credentials.getHostedRepository();
 428 
 429             // This test is only relevant on hosts not supporting proper review comment bodies
 430             assumeTrue(!author.forge().supportsReviewBody());
 431 
 432             var censusBuilder = credentials.getCensusBuilder()
 433                                            .addAuthor(author.forge().currentUser().id())
 434                                            .addReviewer(reviewer.forge().currentUser().id());
 435             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 436 
 437             // Populate the projects repository
 438             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 439             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 440             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 441 
 442             // Make a change with a corresponding PR
 443             var editHash = CheckableRepository.appendAndCommit(localRepo);
 444             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 445             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 446 
 447             // Check the status
 448             TestBotRunner.runPeriodicItems(checkBot);
 449             var comments = pr.comments();
 450             var commentCount = comments.size();
 451 
 452             // Approve it as another user
 453             var approvalPr = reviewer.pullRequest(pr.id());
 454             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 455 
 456             // Check the status again
 457             TestBotRunner.runPeriodicItems(checkBot);
 458 
 459             // There should now be two additional comments
 460             comments = pr.comments();
 461             assertEquals(commentCount + 2, comments.size());
 462             var comment = comments.get(commentCount);
 463             assertTrue(comment.body().contains(reviewer.forge().currentUser().userName()));
 464             assertTrue(comment.body().contains(&quot;approved&quot;));
 465 
 466             // Drop the review
 467             approvalPr.addReview(Review.Verdict.NONE, &quot;Unreviewed&quot;);
 468 
 469             // Check the status again
 470             TestBotRunner.runPeriodicItems(checkBot);
 471 
 472             // There should now be yet another comment
 473             comments = pr.comments();
 474             assertEquals(commentCount + 3, comments.size());
 475             comment = comments.get(commentCount + 2);
 476             assertTrue(comment.body().contains(reviewer.forge().currentUser().userName()));
 477             assertTrue(comment.body().contains(&quot;comment&quot;));
 478 
 479             // No changes should not generate additional comments
 480             TestBotRunner.runPeriodicItems(checkBot);
 481             comments = pr.comments();
 482             assertEquals(commentCount + 3, comments.size());
 483         }
 484     }
 485 
 486     @Test
 487     void mergeMessage(TestInfo testInfo) throws IOException {
 488         try (var credentials = new HostCredentials(testInfo);
 489              var tempFolder = new TemporaryDirectory();
 490              var pushedFolder = new TemporaryDirectory()) {
 491 
 492             var author = credentials.getHostedRepository();
 493             var integrator = credentials.getHostedRepository();
 494             var censusBuilder = credentials.getCensusBuilder()
 495                                            .addCommitter(author.forge().currentUser().id())
 496                                            .addReviewer(integrator.forge().currentUser().id());
 497             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
 498 
 499             // Populate the projects repository
 500             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 501             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 502             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 503             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 504 
 505             // Make a change with a corresponding PR
 506             var editHash = CheckableRepository.appendAndCommit(localRepo);
 507             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 508             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 509 
 510             // Approve it as another user
 511             var approvalPr = integrator.pullRequest(pr.id());
 512             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 513 
 514             // Get all messages up to date
 515             TestBotRunner.runPeriodicItems(mergeBot);
 516 
 517             // Push something unrelated to master
 518             localRepo.checkout(masterHash, true);
 519             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
 520             Files.writeString(unrelated, &quot;Hello&quot;);
 521             localRepo.add(unrelated);
 522             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
 523             localRepo.push(unrelatedHash, author.url(), &quot;master&quot;);
 524 
 525             // Let the bot see the changes
 526             TestBotRunner.runPeriodicItems(mergeBot);
 527 
 528             // The bot should reply with an ok message
 529             var updated = pr.comments().stream()
 530                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
 531                             .filter(comment -&gt; comment.body().contains(&quot; * &quot; + unrelatedHash.abbreviate()))
 532                             .filter(comment -&gt; comment.body().contains(&quot;please merge&quot;))
 533                             .count();
 534             assertEquals(1, updated);
 535         }
 536     }
 537 
 538     @Test
 539     void cannotRebase(TestInfo testInfo) throws IOException {
 540         try (var credentials = new HostCredentials(testInfo);
 541              var tempFolder = new TemporaryDirectory();
 542              var pushedFolder = new TemporaryDirectory()) {
 543 
 544             var author = credentials.getHostedRepository();
 545             var integrator = credentials.getHostedRepository();
 546             var censusBuilder = credentials.getCensusBuilder()
 547                                            .addCommitter(author.forge().currentUser().id())
 548                                            .addReviewer(integrator.forge().currentUser().id());
 549             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
 550 
 551             // Populate the projects repository
 552             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 553             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 554             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 555             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 556 
 557             // Make a change with a corresponding PR
 558             var editHash = CheckableRepository.appendAndCommit(localRepo);
 559             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 560             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 561 
 562             // Approve it as another user
 563             var approvalPr = integrator.pullRequest(pr.id());
 564             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 565 
 566             // Get all messages up to date
 567             TestBotRunner.runPeriodicItems(mergeBot);
 568             assertTrue(pr.labels().contains(&quot;ready&quot;));
 569 
 570             // Push something conflicting to master
 571             localRepo.checkout(masterHash, true);
 572             var conflictingHash = CheckableRepository.appendAndCommit(localRepo, &quot;This looks like a conflict&quot;);
 573             localRepo.push(conflictingHash, author.url(), &quot;master&quot;);
 574 
 575             // Let the bot see the changes
 576             TestBotRunner.runPeriodicItems(mergeBot);
 577 
 578             // The bot should not yet post the ready for integration message
 579             var updated = pr.comments().stream()
 580                             .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
 581                             .count();
 582             assertEquals(0, updated);
 583 
 584             // The PR should be flagged as outdated
 585             assertTrue(pr.labels().contains(&quot;merge-conflict&quot;));
 586             assertFalse(pr.labels().contains(&quot;ready&quot;));
 587 
 588             // An instructional message should have been bosted
 589             var help = pr.comments().stream()
 590                          .filter(comment -&gt; comment.body().contains(&quot;To resolve these merge conflicts&quot;))
 591                          .count();
 592             assertEquals(1, help);
 593 
 594             // But it should still pass jcheck
 595             var checks = pr.checks(editHash);
 596             assertEquals(1, checks.size());
 597             var check = checks.get(&quot;jcheck&quot;);
 598             assertEquals(CheckStatus.SUCCESS, check.status());
 599 
 600             // Restore the master branch
 601             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 602 
 603             // Let the bot see the changes
 604             TestBotRunner.runPeriodicItems(mergeBot);
 605 
 606             // The bot should now post an integration message
 607             updated = pr.comments().stream()
 608                         .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
 609                         .count();
 610             assertEquals(1, updated);
 611 
 612             // The PR should not be flagged as outdated
 613             assertFalse(pr.labels().contains(&quot;merge-conflict&quot;));
 614             assertTrue(pr.labels().contains(&quot;ready&quot;));
 615         }
 616     }
 617 
 618     @Test
 619     void blockingLabel(TestInfo testInfo) throws IOException {
 620         try (var credentials = new HostCredentials(testInfo);
 621              var tempFolder = new TemporaryDirectory()) {
 622             var author = credentials.getHostedRepository();
 623             var reviewer = credentials.getHostedRepository();
 624 
 625             var censusBuilder = credentials.getCensusBuilder()
 626                                            .addAuthor(author.forge().currentUser().id())
 627                                            .addReviewer(reviewer.forge().currentUser().id());
 628             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).blockingCheckLabels(Map.of(&quot;block&quot;, &quot;Test Blocker&quot;)).build();
 629 
 630             // Populate the projects repository
 631             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 632             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 633             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 634 
 635             // Make a change with a corresponding PR
 636             var editHash = CheckableRepository.appendAndCommit(localRepo);
 637             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 638             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 639             pr.addLabel(&quot;block&quot;);
 640 
 641             // Check the status
 642             TestBotRunner.runPeriodicItems(checkBot);
 643 
 644             // Verify that the check failed
 645             var checks = pr.checks(editHash);
 646             assertEquals(1, checks.size());
 647             var check = checks.get(&quot;jcheck&quot;);
 648             assertEquals(CheckStatus.FAILURE, check.status());
 649             assertTrue(check.summary().orElseThrow().contains(&quot;Test Blocker&quot;));
 650 
 651             // The PR should not yet be ready for review
 652             assertTrue(pr.labels().contains(&quot;block&quot;));
 653             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 654             assertFalse(pr.labels().contains(&quot;ready&quot;));
 655 
 656             // Check the status again
 657             pr.removeLabel(&quot;block&quot;);
 658             TestBotRunner.runPeriodicItems(checkBot);
 659 
 660             // The PR should now be ready for review
 661             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 662             assertFalse(pr.labels().contains(&quot;ready&quot;));
 663         }
 664     }
 665 
 666     @Test
 667     void emptyPRBody(TestInfo testInfo) throws IOException {
 668         try (var credentials = new HostCredentials(testInfo);
 669              var tempFolder = new TemporaryDirectory()) {
 670             var author = credentials.getHostedRepository();
 671             var reviewer = credentials.getHostedRepository();
 672 
 673             var censusBuilder = credentials.getCensusBuilder()
 674                                            .addAuthor(author.forge().currentUser().id())
 675                                            .addReviewer(reviewer.forge().currentUser().id());
 676             var checkBot = PullRequestBot.newBuilder()
 677                                          .repo(author)
 678                                          .censusRepo(censusBuilder.build())
 679                                          .build();
 680 
 681             // Populate the projects repository
 682             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 683             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 684             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 685 
 686             // Make a change with a corresponding PR
 687             var editHash = CheckableRepository.appendAndCommit(localRepo);
 688             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 689             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Another PR&quot;);
 690             pr.setBody(&quot;    &quot;);
 691 
 692             // Check the status
 693             TestBotRunner.runPeriodicItems(checkBot);
 694 
 695             // Verify that the check failed
 696             var checks = pr.checks(editHash);
 697             assertEquals(1, checks.size());
 698             var check = checks.get(&quot;jcheck&quot;);
 699             assertEquals(CheckStatus.FAILURE, check.status());
 700             assertTrue(check.summary().orElseThrow().contains(&quot;The pull request body must not be empty.&quot;));
 701 
 702             // Additional errors should be displayed in the body
 703             var updatedPr = author.pullRequest(pr.id());
 704             assertTrue(updatedPr.body().contains(&quot;## Error&quot;));
 705             assertTrue(updatedPr.body().contains(&quot;The pull request body must not be empty.&quot;));
 706 
 707             // There should be an indicator of where the pr body should be entered
 708             assertTrue(updatedPr.body().contains(&quot;Replace this text with a description of your pull request&quot;));
 709 
 710             // The PR should not yet be ready for review
 711             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 712             assertFalse(pr.labels().contains(&quot;ready&quot;));
 713 
 714             // Check the status again
 715             pr.setBody(&quot;Here&#39;s that body&quot;);
 716             TestBotRunner.runPeriodicItems(checkBot);
 717 
 718             // The PR should now be ready for review
 719             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 720             assertFalse(pr.labels().contains(&quot;ready&quot;));
 721 
 722             // The additional errors should be gone
 723             updatedPr = author.pullRequest(pr.id());
 724             assertFalse(updatedPr.body().contains(&quot;## Error&quot;));
 725             assertFalse(updatedPr.body().contains(&quot;The pull request body must not be empty.&quot;));
 726 
 727             // And no new helper marker
 728             assertFalse(updatedPr.body().contains(&quot;Replace this text with a description of your pull request&quot;));
 729         }
 730     }
 731 
 732     @Test
 733     void executableFile(TestInfo testInfo) throws IOException {
 734         try (var credentials = new HostCredentials(testInfo);
 735              var tempFolder = new TemporaryDirectory()) {
 736             var author = credentials.getHostedRepository();
 737             var reviewer = credentials.getHostedRepository();
 738 
 739             var censusBuilder = credentials.getCensusBuilder()
 740                                            .addAuthor(author.forge().currentUser().id())
 741                                            .addReviewer(reviewer.forge().currentUser().id());
 742             var checkBot = PullRequestBot.newBuilder()
 743                                          .repo(author)
 744                                          .censusRepo(censusBuilder.build())
 745                                          .build();
 746 
 747             // Populate the projects repository
 748             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(),
 749                     Path.of(&quot;executable.exe&quot;), Set.of(&quot;reviewers&quot;, &quot;executable&quot;), &quot;0.1&quot;);
 750             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 751             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 752 
 753             // Make a change with a corresponding PR
 754             Files.writeString(tempFolder.path().resolve(&quot;executable.exe&quot;), &quot;Executable file contents&quot;, StandardCharsets.UTF_8);
 755             Files.setPosixFilePermissions(tempFolder.path().resolve(&quot;executable.exe&quot;), Set.of(PosixFilePermission.OWNER_EXECUTE, PosixFilePermission.OWNER_READ));
 756             localRepo.add(Path.of(&quot;executable.exe&quot;));
 757             var editHash = localRepo.commit(&quot;Make it executable&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 758             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 759             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Another PR&quot;);
 760             pr.setBody(&quot;This should now be ready&quot;);
 761 
 762             // Check the status
 763             TestBotRunner.runPeriodicItems(checkBot);
 764 
 765             // Verify that the check failed
 766             var checks = pr.checks(editHash);
 767             assertEquals(1, checks.size());
 768             var check = checks.get(&quot;jcheck&quot;);
 769             assertEquals(CheckStatus.FAILURE, check.status());
 770             assertTrue(check.summary().orElseThrow().contains(&quot;Executable files are not allowed (file: executable.exe)&quot;));
 771 
 772             // Additional errors should be displayed in the body
 773             var updatedPr = author.pullRequest(pr.id());
 774             assertTrue(updatedPr.body().contains(&quot;## Error&quot;));
 775             assertTrue(updatedPr.body().contains(&quot;Executable files are not allowed (file: executable.exe)&quot;));
 776 
 777             // The PR should not yet be ready for review
 778             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 779             assertFalse(pr.labels().contains(&quot;ready&quot;));
 780 
 781             // Drop that error
 782             Files.setPosixFilePermissions(tempFolder.path().resolve(&quot;executable.exe&quot;), Set.of(PosixFilePermission.OWNER_READ));
 783             localRepo.add(Path.of(&quot;executable.exe&quot;));
 784             var updatedHash = localRepo.commit(&quot;Make it unexecutable&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 785             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 786             TestBotRunner.runPeriodicItems(checkBot);
 787 
 788             // The PR should now be ready for review
 789             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 790             assertFalse(pr.labels().contains(&quot;ready&quot;));
 791 
 792             // The additional errors should be gone
 793             updatedPr = author.pullRequest(pr.id());
 794             assertFalse(updatedPr.body().contains(&quot;## Error&quot;));
 795             assertFalse(updatedPr.body().contains(&quot;Executable files are not allowed&quot;));
 796         }
 797     }
 798 
 799     @Test
 800     void missingReadyLabel(TestInfo testInfo) throws IOException {
 801         try (var credentials = new HostCredentials(testInfo);
 802              var tempFolder = new TemporaryDirectory()) {
 803             var author = credentials.getHostedRepository();
 804             var reviewer = credentials.getHostedRepository();
 805 
 806             var censusBuilder = credentials.getCensusBuilder()
 807                                            .addAuthor(author.forge().currentUser().id())
 808                                            .addReviewer(reviewer.forge().currentUser().id());
 809             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).readyLabels(Set.of(&quot;good-to-go&quot;)).build();
 810 
 811             // Populate the projects repository
 812             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 813             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 814             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 815 
 816             // Make a change with a corresponding PR
 817             var editHash = CheckableRepository.appendAndCommit(localRepo);
 818             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 819             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 820 
 821             // Check the status
 822             TestBotRunner.runPeriodicItems(checkBot);
 823 
 824             // Verify that no checks have been run
 825             var checks = pr.checks(editHash);
 826             assertEquals(0, checks.size());
 827 
 828             // The PR should not yet be ready for review
 829             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 830 
 831             // Check the status again
 832             pr.addLabel(&quot;good-to-go&quot;);
 833             TestBotRunner.runPeriodicItems(checkBot);
 834 
 835             // The PR should now be ready for review
 836             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 837         }
 838     }
 839 
 840     @Test
 841     void missingReadyComment(TestInfo testInfo) throws IOException {
 842         try (var credentials = new HostCredentials(testInfo);
 843              var tempFolder = new TemporaryDirectory()) {
 844             var author = credentials.getHostedRepository();
 845             var reviewer = credentials.getHostedRepository();
 846 
 847             var censusBuilder = credentials.getCensusBuilder()
 848                                            .addAuthor(author.forge().currentUser().id())
 849                                            .addReviewer(reviewer.forge().currentUser().id());
 850             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;proceed&quot;))).build();
 851 
 852             // Populate the projects repository
 853             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 854             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 855             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 856 
 857             // Make a change with a corresponding PR
 858             var editHash = CheckableRepository.appendAndCommit(localRepo);
 859             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 860             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 861 
 862             // Check the status
 863             TestBotRunner.runPeriodicItems(checkBot);
 864 
 865             // Verify that no checks have been run
 866             var checks = pr.checks(editHash);
 867             assertEquals(0, checks.size());
 868 
 869             // The PR should not yet be ready for review
 870             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 871 
 872             // Check the status again
 873             var reviewerPr = reviewer.pullRequest(pr.id());
 874             reviewerPr.addComment(&quot;proceed&quot;);
 875             TestBotRunner.runPeriodicItems(checkBot);
 876 
 877             // The PR should now be ready for review
 878             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 879         }
 880     }
 881 
 882     @Test
 883     void issueIssue(TestInfo testInfo) throws IOException {
 884         try (var credentials = new HostCredentials(testInfo);
 885              var tempFolder = new TemporaryDirectory()) {
 886             var author = credentials.getHostedRepository();
 887             var reviewer = credentials.getHostedRepository();
 888 
 889             var censusBuilder = credentials.getCensusBuilder()
 890                                            .addAuthor(author.forge().currentUser().id())
 891                                            .addReviewer(reviewer.forge().currentUser().id());
 892             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
 893 
 894             // Populate the projects repository
 895             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 896                                                      Set.of(&quot;issues&quot;), null);
 897             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 898             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 899 
 900             // Make a change with a corresponding PR
 901             var editHash = CheckableRepository.appendAndCommit(localRepo);
 902             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 903             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 904 
 905             // Check the status
 906             TestBotRunner.runPeriodicItems(checkBot);
 907 
 908             // Verify that the check failed
 909             var checks = pr.checks(editHash);
 910             assertEquals(1, checks.size());
 911             var check = checks.get(&quot;jcheck&quot;);
 912             assertEquals(CheckStatus.FAILURE, check.status());
 913 
 914             // Add an issue to the title
 915             pr.setTitle(&quot;1234: This is a pull request&quot;);
 916 
 917             // Check the status again
 918             TestBotRunner.runPeriodicItems(checkBot);
 919 
 920             // The check should now be successful
 921             checks = pr.checks(editHash);
 922             assertEquals(1, checks.size());
 923             check = checks.get(&quot;jcheck&quot;);
 924             assertEquals(CheckStatus.SUCCESS, check.status());
 925         }
 926     }
 927 
 928     @Test
 929     void issueInSummary(TestInfo testInfo) throws IOException {
 930         try (var credentials = new HostCredentials(testInfo);
 931              var tempFolder = new TemporaryDirectory()) {
 932             var author = credentials.getHostedRepository();
 933             var reviewer = credentials.getHostedRepository();
 934             var issues = credentials.getIssueProject();
 935 
 936             var censusBuilder = credentials.getCensusBuilder()
 937                                            .addAuthor(author.forge().currentUser().id())
 938                                            .addReviewer(reviewer.forge().currentUser().id());
 939             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).issueProject(issues).build();
 940 
 941             // Populate the projects repository
 942             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 943                                                      Set.of(&quot;issues&quot;), null);
 944             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 945             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 946 
 947             var issue1 = issues.createIssue(&quot;My first issue&quot;, List.of(&quot;Hello&quot;), Map.of());
 948 
 949             // Make a change with a corresponding PR
 950             var editHash = CheckableRepository.appendAndCommit(localRepo);
 951             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 952             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, issue1.id() + &quot;: This is a pull request&quot;);
 953 
 954             // Check the status
 955             TestBotRunner.runPeriodicItems(checkBot);
 956 
 957             // The check should be successful
 958             var checks = pr.checks(editHash);
 959             assertEquals(1, checks.size());
 960             var check = checks.get(&quot;jcheck&quot;);
 961             assertEquals(CheckStatus.SUCCESS, check.status());
 962 
 963             // And the body should contain the issue title
 964             assertTrue(pr.body().contains(&quot;My first issue&quot;));
 965 
 966             // Change the issue
 967             var issue2 = issues.createIssue(&quot;My second issue&quot;, List.of(&quot;Body&quot;), Map.of());
 968             pr.setTitle(issue2.id() + &quot;: This is a pull request&quot;);
 969 
 970             // Check the status again
 971             TestBotRunner.runPeriodicItems(checkBot);
 972 
 973             // The body should contain the updated issue title
 974             assertFalse(pr.body().contains(&quot;My first issue&quot;));
 975             assertTrue(pr.body().contains(&quot;My second issue&quot;));
 976 
 977             // The PR title does not match the issue title
 978             assertTrue(pr.body().contains(&quot;Title mismatch&quot;));
 979 
 980             // Correct it
 981             pr.setTitle(issue2.id() + &quot; - &quot; + issue2.title());
 982 
 983             // Check the status again - it should now match
 984             TestBotRunner.runPeriodicItems(checkBot);
 985             assertFalse(pr.body().contains(&quot;Title mismatch&quot;));
 986 
 987             // Use an invalid issue key
 988             var issueKey = issue1.id().replace(&quot;TEST&quot;, &quot;BADPROJECT&quot;);
 989             pr.setTitle(issueKey + &quot;: This is a pull request&quot;);
 990 
 991             // Check the status again
 992             TestBotRunner.runPeriodicItems(checkBot);
 993             assertFalse(pr.body().contains(&quot;My first issue&quot;));
 994             assertFalse(pr.body().contains(&quot;My second issue&quot;));
 995             assertTrue(pr.body().contains(&quot;does not belong to the `TEST` project&quot;));
 996 
 997             // Now drop the issue key
 998             issueKey = issue1.id().replace(&quot;TEST-&quot;, &quot;&quot;);
 999             pr.setTitle(issueKey + &quot;: This is a pull request&quot;);
1000 
1001             // The body should now contain the updated issue title
1002             TestBotRunner.runPeriodicItems(checkBot);
1003             assertTrue(pr.body().contains(&quot;My first issue&quot;));
1004             assertFalse(pr.body().contains(&quot;My second issue&quot;));
1005 
1006             // Now enter an invalid issue id
1007             pr.setTitle(&quot;2384848: This is a pull request&quot;);
1008 
1009             // Check the status again
1010             TestBotRunner.runPeriodicItems(checkBot);
1011             assertFalse(pr.body().contains(&quot;My first issue&quot;));
1012             assertFalse(pr.body().contains(&quot;My second issue&quot;));
1013             assertTrue(pr.body().contains(&quot;Failed to retrieve&quot;));
1014 
1015             // The check should still be successful though
1016             checks = pr.checks(editHash);
1017             assertEquals(1, checks.size());
1018             check = checks.get(&quot;jcheck&quot;);
1019             assertEquals(CheckStatus.SUCCESS, check.status());
1020         }
1021     }
1022 
1023     @Test
1024     void cancelCheck(TestInfo testInfo) throws IOException {
1025         try (var credentials = new HostCredentials(testInfo);
1026              var tempFolder = new TemporaryDirectory()) {
1027             var author = credentials.getHostedRepository();
1028 
1029             // Populate the projects repository
1030             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1031             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1032             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1033 
1034             // Make a change with a corresponding PR
1035             var editHash = CheckableRepository.appendAndCommit(localRepo);
1036             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1037             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1038 
1039             // Verify no checks exists
1040             var checks = pr.checks(editHash);
1041             assertEquals(0, checks.size());
1042 
1043             // Create a check that is running
1044             var original = CheckBuilder.create(&quot;jcheck&quot;, editHash)
1045                                        .title(&quot;jcheck title&quot;)
1046                                        .summary(&quot;jcheck summary&quot;)
1047                                        .build();
1048             pr.createCheck(original);
1049 
1050             // Verify check is created
1051             checks = pr.checks(editHash);
1052             assertEquals(1, checks.size());
1053             var retrieved = checks.get(&quot;jcheck&quot;);
1054             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
1055             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
1056             assertEquals(CheckStatus.IN_PROGRESS, retrieved.status());
1057 
1058             // Cancel the check
1059             var cancelled = CheckBuilder.from(retrieved).cancel().build();
1060             pr.updateCheck(cancelled);
1061             checks = pr.checks(editHash);
1062             assertEquals(1, checks.size());
1063             retrieved = checks.get(&quot;jcheck&quot;);
1064             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
1065             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
1066             assertEquals(CheckStatus.CANCELLED, retrieved.status());
1067         }
1068     }
1069 
1070     @Test
1071     void rebaseBeforeCheck(TestInfo testInfo) throws IOException {
1072         try (var credentials = new HostCredentials(testInfo);
1073              var tempFolder = new TemporaryDirectory()) {
1074             var author = credentials.getHostedRepository();
1075             var reviewer = credentials.getHostedRepository();
1076 
1077             var censusBuilder = credentials.getCensusBuilder()
1078                                            .addAuthor(author.forge().currentUser().id())
1079                                            .addReviewer(reviewer.forge().currentUser().id());
1080             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1081 
1082             // Populate the projects repository
1083             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1084             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1085             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1086 
1087             // Make a change with a corresponding PR
1088             var editHash = CheckableRepository.appendAndCommit(localRepo);
1089             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1090             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1091 
1092             // Enable a new check in the target branch
1093             localRepo.checkout(masterHash, true);
1094             CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
1095                                      Set.of(&quot;author&quot;, &quot;reviewers&quot;, &quot;whitespace&quot;, &quot;issues&quot;), null);
1096             var headHash = localRepo.resolve(&quot;HEAD&quot;).orElseThrow();
1097             localRepo.push(headHash, author.url(), &quot;master&quot;, true);
1098 
1099             // Check the status
1100             TestBotRunner.runPeriodicItems(checkBot);
1101 
1102             // Verify that the check failed
1103             var checks = pr.checks(editHash);
1104             assertEquals(1, checks.size());
1105             var check = checks.get(&quot;jcheck&quot;);
1106             assertTrue(check.summary().orElseThrow().contains(&quot;commit message does not reference any issue&quot;));
1107             assertEquals(CheckStatus.FAILURE, check.status());
1108 
1109             // Adjust the title to conform and check the status again
1110             pr.setTitle(&quot;12345: This is a pull request&quot;);
1111             TestBotRunner.runPeriodicItems(checkBot);
1112 
1113             // Verify that the check passed
1114             checks = pr.checks(editHash);
1115             assertEquals(1, checks.size());
1116             check = checks.get(&quot;jcheck&quot;);
1117             assertEquals(CheckStatus.SUCCESS, check.status());
1118         }
1119     }
1120 
1121     @Test
1122     void draft(TestInfo testInfo) throws IOException {
1123         try (var credentials = new HostCredentials(testInfo);
1124              var tempFolder = new TemporaryDirectory()) {
1125             var author = credentials.getHostedRepository();
1126             var reviewer = credentials.getHostedRepository();
1127 
1128             var censusBuilder = credentials.getCensusBuilder()
1129                                            .addAuthor(author.forge().currentUser().id())
1130                                            .addReviewer(reviewer.forge().currentUser().id());
1131             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1132 
1133             // Populate the projects repository
1134             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1135             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1136             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1137 
1138             // Make a change with a corresponding PR
1139             var editHash = CheckableRepository.appendAndCommit(localRepo);
1140             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1141             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1142                                                    &quot;This is a pull request&quot;, true);
1143 
1144             // Check the status
1145             TestBotRunner.runPeriodicItems(checkBot);
1146 
1147             // Verify that the check succeeded
1148             var checks = pr.checks(editHash);
1149             assertEquals(1, checks.size());
1150             var check = checks.get(&quot;jcheck&quot;);
1151             assertEquals(CheckStatus.SUCCESS, check.status());
1152 
1153             // The PR should still not be ready for review as it is a draft
1154             assertFalse(pr.labels().contains(&quot;rfr&quot;));
1155             assertFalse(pr.labels().contains(&quot;ready&quot;));
1156         }
1157     }
1158 
1159     @Test
1160     void excessiveFailures(TestInfo testInfo) throws IOException {
1161         try (var credentials = new HostCredentials(testInfo);
1162              var tempFolder = new TemporaryDirectory()) {
1163             var author = credentials.getHostedRepository();
1164             var reviewer = credentials.getHostedRepository();
1165 
1166             var censusBuilder = credentials.getCensusBuilder()
1167                                            .addAuthor(author.forge().currentUser().id())
1168                                            .addReviewer(reviewer.forge().currentUser().id());
1169             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1170 
1171             // Populate the projects repository
1172             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1173             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1174             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1175 
1176             // Make a change with a corresponding PR containing more errors than at least GitHub can handle in a check
1177             var badContent = &quot;\tline   \n&quot;.repeat(200);
1178             var editHash = CheckableRepository.appendAndCommit(localRepo, badContent);
1179             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1180             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1181                                                    &quot;This is a pull request&quot;, true);
1182 
1183             // Check the status
1184             TestBotRunner.runPeriodicItems(checkBot);
1185 
1186             // Verify that the check failed
1187             var checks = pr.checks(editHash);
1188             assertEquals(1, checks.size());
1189             var check = checks.get(&quot;jcheck&quot;);
1190             assertEquals(CheckStatus.FAILURE, check.status());
1191         }
1192     }
1193 
1194     @Test
1195     void useJCheckConfFromTargetBranch(TestInfo testInfo) throws IOException {
1196         try (var credentials = new HostCredentials(testInfo);
1197              var tempFolder = new TemporaryDirectory()) {
1198             var author = credentials.getHostedRepository();
1199             var reviewer = credentials.getHostedRepository();
1200 
1201             var censusBuilder = credentials.getCensusBuilder()
1202                                            .addAuthor(author.forge().currentUser().id())
1203                                            .addReviewer(reviewer.forge().currentUser().id());
1204             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1205 
1206             // Populate the projects repository
1207             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1208             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1209             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1210 
1211             // Break the jcheck configuration on the &quot;edit&quot; branch
1212             var confPath = tempFolder.path().resolve(&quot;.jcheck/conf&quot;);
1213             var oldConf = Files.readString(confPath, StandardCharsets.UTF_8);
1214             Files.writeString(confPath, &quot;Hello there!&quot;, StandardCharsets.UTF_8);
1215             localRepo.add(confPath);
1216             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A change&quot;);
1217             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1218             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1219                                                    &quot;This is a pull request&quot;, true);
1220 
1221             // Check the status - should *not* throw because valid .jcheck/conf from
1222             // &quot;master&quot; branch should be used
1223             TestBotRunner.runPeriodicItems(checkBot);
1224             TestBotRunner.runPeriodicItems(checkBot);
1225             TestBotRunner.runPeriodicItems(checkBot);
1226 
1227             // Verify that the check succeeded
1228             var checks = pr.checks(editHash);
1229             assertEquals(1, checks.size());
1230             var check = checks.get(&quot;jcheck&quot;);
1231             assertEquals(CheckStatus.SUCCESS, check.status());
1232         }
1233     }
1234 
1235     @Test
1236     void noCommit(TestInfo testInfo) throws IOException {
1237         try (var credentials = new HostCredentials(testInfo);
1238              var tempFolder = new TemporaryDirectory()) {
1239             var author = credentials.getHostedRepository();
1240             var reviewer = credentials.getHostedRepository();
1241 
1242             var censusBuilder = credentials.getCensusBuilder()
1243                                            .addAuthor(author.forge().currentUser().id())
1244                                            .addReviewer(reviewer.forge().currentUser().id());
1245             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();
1246 
1247             // Populate the projects repository
1248             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1249             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1250             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1251 
1252             // Make a change with a corresponding PR
1253             var editHash = CheckableRepository.appendAndCommit(localRepo);
1254             localRepo.push(editHash, author.url(), &quot;master&quot;);
1255             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1256             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1257 
1258             // Check the status
1259             TestBotRunner.runPeriodicItems(checkBot);
1260 
1261             // Verify that the check failed
1262             var checks = pr.checks(editHash);
1263             assertEquals(1, checks.size());
1264             var check = checks.get(&quot;jcheck&quot;);
1265             assertEquals(CheckStatus.FAILURE, check.status());
1266             assertEquals(&quot;- This PR contains no changes&quot;, check.summary().orElseThrow());
1267         }
1268     }
1269 
1270     @Test
1271     void ignoreStale(TestInfo testInfo) throws IOException {
1272         try (var credentials = new HostCredentials(testInfo);
1273              var tempFolder = new TemporaryDirectory()) {
1274 
1275             var author = credentials.getHostedRepository();
1276             var reviewer = credentials.getHostedRepository();
1277 
1278             var censusBuilder = credentials.getCensusBuilder()
1279                                            .addAuthor(author.forge().currentUser().id())
1280                                            .addReviewer(reviewer.forge().currentUser().id());
1281             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).ignoreStaleReviews(true).build();
1282 
1283             // Populate the projects repository
1284             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1285             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1286             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1287 
1288             // Make a change with a corresponding PR
1289             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line with&quot;);
1290             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1291             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1292 
1293             // Check the status
1294             TestBotRunner.runPeriodicItems(checkBot);
1295 
1296             // Approve it as another user
1297             var approvalPr = reviewer.pullRequest(pr.id());
1298             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
1299 
1300             // Check the status
1301             TestBotRunner.runPeriodicItems(checkBot);
1302 
1303             // The PR should be flagged as ready
1304             assertTrue(pr.labels().contains(&quot;ready&quot;));
1305             assertFalse(pr.body().contains(&quot;Re-review required&quot;));
1306 
1307             // Add another commit
1308             editHash = CheckableRepository.replaceAndCommit(localRepo, &quot;Another line&quot;);
1309             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1310 
1311             // Make sure that the push registered
1312             var lastHeadHash = pr.headHash();
1313             var refreshCount = 0;
1314             do {
1315                 pr = author.pullRequest(pr.id());
1316                 if (refreshCount++ &gt; 100) {
1317                     fail(&quot;The PR did not update after the new push&quot;);
1318                 }
1319             } while (pr.headHash().equals(lastHeadHash));
1320 
1321             // Check the status again
1322             TestBotRunner.runPeriodicItems(checkBot);
1323 
1324             // The PR should no longer be ready, as the review is stale
1325             assertFalse(pr.labels().contains(&quot;ready&quot;));
1326             assertTrue(pr.labels().contains(&quot;rfr&quot;));
1327             assertTrue(pr.body().contains(&quot;Re-review required&quot;));
1328         }
1329     }
1330 
1331     @Test
1332     void targetBranchPattern(TestInfo testInfo) throws IOException {
1333         try (var credentials = new HostCredentials(testInfo);
1334              var tempFolder = new TemporaryDirectory()) {
1335             var author = credentials.getHostedRepository();
1336             var reviewer = credentials.getHostedRepository();
1337 
1338             var censusBuilder = credentials.getCensusBuilder()
1339                                            .addAuthor(author.forge().currentUser().id())
1340                                            .addReviewer(reviewer.forge().currentUser().id());
1341             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build())
1342                                          .allowedTargetBranches(&quot;^(?!master$).*&quot;)
1343                                          .build();
1344 
1345             // Populate the projects repository
1346             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1347             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1348             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1349             localRepo.push(masterHash, author.url(), &quot;notmaster&quot;, true);
1350 
1351             // Make a change with a corresponding PR
1352             var editHash = CheckableRepository.appendAndCommit(localRepo);
1353             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1354             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1355                                                    &quot;This is a pull request&quot;, true);
1356 
1357             // Check the status
1358             TestBotRunner.runPeriodicItems(checkBot);
1359 
1360             // Verify that the check failed
1361             var checks = pr.checks(editHash);
1362             assertEquals(1, checks.size());
1363             var check = checks.get(&quot;jcheck&quot;);
1364             assertEquals(CheckStatus.FAILURE, check.status());
1365             assertTrue(check.summary().orElseThrow().contains(&quot;The branch `master` is not allowed as target branch&quot;));
1366             assertTrue(check.summary().orElseThrow().contains(&quot;notmaster&quot;));
1367 
1368             var anotherPr = credentials.createPullRequest(author, &quot;notmaster&quot;, &quot;edit&quot;,
1369                                                    &quot;This is a pull request&quot;, true);
1370 
1371             // Check the status
1372             TestBotRunner.runPeriodicItems(checkBot);
1373 
1374             // Approve it as another user
1375             var approvalPr = reviewer.pullRequest(anotherPr.id());
1376             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
1377             TestBotRunner.runPeriodicItems(checkBot);
1378 
1379             // Verify that the check passed
1380             checks = anotherPr.checks(editHash);
1381             assertEquals(1, checks.size());
1382             check = checks.get(&quot;jcheck&quot;);
1383             assertEquals(CheckStatus.SUCCESS, check.status());
1384         }
1385     }
1386 
1387 }
    </pre>
  </body>
</html>