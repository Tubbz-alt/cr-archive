<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/pr/src/test/java/org/openjdk/skara/bots/pr/IntegrateTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.pr;
 24 
 25 import org.openjdk.skara.forge.*;
 26 import org.openjdk.skara.issuetracker.Comment;
 27 import org.openjdk.skara.test.*;
 28 import org.openjdk.skara.vcs.Repository;
 29 
 30 import org.junit.jupiter.api.*;
 31 
 32 import java.io.IOException;
 33 import java.nio.charset.StandardCharsets;
 34 import java.nio.file.*;
 35 import java.util.Set;
 36 import java.util.stream.Collectors;
 37 
 38 import static org.junit.jupiter.api.Assertions.*;
 39 import static org.openjdk.skara.bots.pr.PullRequestAsserts.assertLastCommentContains;
 40 
 41 class IntegrateTests {
 42     @Test
 43     void simpleMerge(TestInfo testInfo) throws IOException {
 44         try (var credentials = new HostCredentials(testInfo);
 45              var tempFolder = new TemporaryDirectory();
 46              var pushedFolder = new TemporaryDirectory()) {
 47 
 48             var author = credentials.getHostedRepository();
 49             var integrator = credentials.getHostedRepository();
 50             var reviewer = credentials.getHostedRepository();
 51             var censusBuilder = credentials.getCensusBuilder()
 52                                            .addCommitter(author.forge().currentUser().id())
 53                                            .addReviewer(integrator.forge().currentUser().id())
 54                                            .addReviewer(reviewer.forge().currentUser().id());
 55             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
 56 
 57             // Populate the projects repository
 58             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 59             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 60             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 61             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 62 
 63             // Make a change with a corresponding PR
 64             var editHash = CheckableRepository.appendAndCommit(localRepo);
 65             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 66             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 67 
 68             // Approve it as another user
 69             var approvalPr = integrator.pullRequest(pr.id());
 70             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 71 
 72             // The bot should reply with integration message
 73             TestBotRunner.runPeriodicItems(mergeBot);
 74             var integrateComments =
 75                 pr.comments()
 76                   .stream()
 77                   .filter(c -&gt; c.body().contains(&quot;To integrate this PR with the above commit message to the `master` branch&quot;))
 78                   .count();
 79             assertEquals(1, integrateComments);
 80 
 81             // Attempt a merge (the bot should only process the first one)
 82             pr.addComment(&quot;/integrate&quot;);
 83             pr.addComment(&quot;/integrate&quot;);
 84             pr.addComment(&quot;/integrate&quot;);
 85             TestBotRunner.runPeriodicItems(mergeBot);
 86 
 87             // The bot should reply with an ok message
 88             var pushed = pr.comments().stream()
 89                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
 90                            .count();
 91             assertEquals(1, pushed);
 92 
 93             // The change should now be present on the master branch
 94             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
 95             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
 96 
 97             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
 98             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
 99 
100             // Author and committer should be the same
101             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
102             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
103             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
104             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
105             assertTrue(pr.labels().contains(&quot;integrated&quot;));
106 
107             // Ready label should have been removed
108             assertFalse(pr.labels().contains(&quot;ready&quot;));
109         }
110     }
111 
112     @Test
113     void reviewersRetained(TestInfo testInfo) throws IOException {
114         try (var credentials = new HostCredentials(testInfo);
115              var tempFolder = new TemporaryDirectory();
116              var pushedFolder = new TemporaryDirectory()) {
117             var author = credentials.getHostedRepository();
118             var integrator = credentials.getHostedRepository();
119             var committer = credentials.getHostedRepository();
120 
121             var censusBuilder = credentials.getCensusBuilder()
122                                            .addCommitter(author.forge().currentUser().id())
123                                            .addCommitter(committer.forge().currentUser().id())
124                                            .addReviewer(integrator.forge().currentUser().id());
125             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
126 
127             // Populate the projects repository
128             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
129             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
130             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
131             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
132 
133             // Make a change with a corresponding PR
134             var editHash = CheckableRepository.appendAndCommit(localRepo);
135             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
136             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
137 
138             // Review it twice
139             var integratorPr = integrator.pullRequest(pr.id());
140             var committerPr = committer.pullRequest(pr.id());
141             integratorPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
142             committerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
143 
144             // Attempt a merge
145             pr.addComment(&quot;/integrate&quot;);
146             TestBotRunner.runPeriodicItems(mergeBot);
147 
148             // The bot should reply with an ok message
149             var pushed = pr.comments().stream()
150                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
151                            .count();
152             assertEquals(1, pushed);
153 
154             // The change should now be present on the master branch
155             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
156             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
157             var headCommit = pushedRepo.commits(&quot;HEAD&quot;).asList().get(0);
158             assertTrue(String.join(&quot;&quot;, headCommit.message())
159                              .matches(&quot;.*Reviewed-by: integrationreviewer3, integrationcommitter2$&quot;),
160                        String.join(&quot;&quot;, headCommit.message()));
161         }
162     }
163 
164     @Test
165     void notChecked(TestInfo testInfo) throws IOException {
166         try (var credentials = new HostCredentials(testInfo);
167              var tempFolder = new TemporaryDirectory()) {
168             var author = credentials.getHostedRepository();
169             var integrator = credentials.getHostedRepository();
170             var censusBuilder = credentials.getCensusBuilder()
171                                            .addAuthor(author.forge().currentUser().id());
172             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
173 
174             // Populate the projects repository
175             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
176             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
177             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
178             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
179 
180             // Make a change with a corresponding PR
181             var editHash = CheckableRepository.appendAndCommit(localRepo);
182             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
183             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
184 
185             // Attempt a merge, do not run the check from the bot
186             pr.addComment(&quot;/integrate&quot;);
187             TestBotRunner.runPeriodicItems(mergeBot, item -&gt; item instanceof CheckWorkItem);
188 
189             // The bot should reply with an error message
190             var error = pr.comments().stream()
191                           .filter(comment -&gt; comment.body().contains(&quot;merge request cannot be fulfilled at this time&quot;))
192                           .filter(comment -&gt; comment.body().contains(&quot;status check&quot;))
193                           .filter(comment -&gt; comment.body().contains(&quot;has not been performed on commit&quot;))
194                           .count();
195             assertEquals(1, error);
196         }
197     }
198 
199     @Test
200     void notReviewed(TestInfo testInfo) throws IOException {
201         try (var credentials = new HostCredentials(testInfo);
202              var tempFolder = new TemporaryDirectory()) {
203             var author = credentials.getHostedRepository();
204             var integrator = credentials.getHostedRepository();
205             var censusBuilder = credentials.getCensusBuilder()
206                                            .addAuthor(author.forge().currentUser().id());
207             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
208 
209             // Populate the projects repository - but without any checks enabled
210             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
211                                                      Set.of(), null);
212             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
213             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
214             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
215 
216             // Make a change with a corresponding PR
217             var editHash = CheckableRepository.appendAndCommit(localRepo);
218             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
219             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
220 
221             // Now enable checks
222             localRepo.checkout(masterHash, true);
223             CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
224                                      Set.of(&quot;author&quot;, &quot;reviewers&quot;, &quot;whitespace&quot;), null);
225             var updatedHash = localRepo.resolve(&quot;HEAD&quot;).orElseThrow();
226             localRepo.push(updatedHash, author.url(), &quot;master&quot;, true);
227 
228             // Attempt a merge
229             pr.addComment(&quot;/integrate&quot;);
230             TestBotRunner.runPeriodicItems(mergeBot);
231 
232             // The bot should reply with an error message
233             var error = pr.comments().stream()
234                           .filter(comment -&gt; comment.body().contains(&quot;merge request cannot be fulfilled at this time&quot;))
235                           .filter(comment -&gt; comment.body().contains(&quot;failed the final jcheck&quot;))
236                           .count();
237             assertEquals(1, error, pr.comments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n---\n&quot;)));
238         }
239     }
240 
241     @Test
242     void failedCheck(TestInfo testInfo) throws IOException {
243         try (var credentials = new HostCredentials(testInfo);
244              var tempFolder = new TemporaryDirectory()) {
245             var author = credentials.getHostedRepository();
246             var integrator = credentials.getHostedRepository();
247             var censusBuilder = credentials.getCensusBuilder()
248                                            .addAuthor(author.forge().currentUser().id());
249             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
250 
251             // Populate the projects repository
252             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
253             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
254             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
255             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
256 
257             // Make a change with a corresponding PR
258             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;trailing whitespace   &quot;);
259             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
260             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
261 
262             // Attempt a merge
263             pr.addComment(&quot;/integrate&quot;);
264             TestBotRunner.runPeriodicItems(mergeBot);
265 
266             // The bot should reply with an error message
267             var error = pr.comments().stream()
268                           .filter(comment -&gt; comment.body().contains(&quot;merge request cannot be fulfilled at this time&quot;))
269                           .filter(comment -&gt; comment.body().contains(&quot;status check&quot;))
270                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
271                           .count();
272             assertEquals(1, error);
273         }
274     }
275 
276     @Test
277     void outdatedCheck(TestInfo testInfo) throws IOException {
278         try (var credentials = new HostCredentials(testInfo);
279              var tempFolder = new TemporaryDirectory()) {
280             var author = credentials.getHostedRepository();
281             var integrator = credentials.getHostedRepository();
282             var censusBuilder = credentials.getCensusBuilder()
283                                            .addAuthor(author.forge().currentUser().id());
284             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
285 
286             // Populate the projects repository
287             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
288             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
289             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
290             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
291 
292             // Make a change with a corresponding PR
293             var editHash = CheckableRepository.appendAndCommit(localRepo);
294             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
295             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
296 
297             // Flag it as checked
298             var check = CheckBuilder.create(&quot;testcheck&quot;, editHash);
299             pr.createCheck(check.build());
300             check.complete(true);
301             pr.updateCheck(check.build());
302 
303             // Now push another change
304             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;);
305             localRepo.push(updatedHash, author.url(), &quot;edit&quot;, true);
306 
307             // Attempt a merge - avoid running checks from the bot
308             pr.addComment(&quot;/integrate&quot;);
309             TestBotRunner.runPeriodicItems(mergeBot, item -&gt; item instanceof CheckWorkItem);
310 
311             // The bot should reply with an error message
312             var error = pr.comments().stream()
313                           .filter(comment -&gt; comment.body().contains(&quot;merge request cannot be fulfilled at this time&quot;))
314                           .filter(comment -&gt; comment.body().contains(&quot;status check&quot;))
315                           .filter(comment -&gt; comment.body().contains(&quot;has not been performed on commit&quot;))
316                           .count();
317             assertEquals(1, error);
318         }
319     }
320 
321     @Test
322     void mergeNotification(TestInfo testInfo) throws IOException {
323         try (var credentials = new HostCredentials(testInfo);
324              var tempFolder = new TemporaryDirectory()) {
325             var author = credentials.getHostedRepository();
326             var integrator = credentials.getHostedRepository();
327             var reviewer = credentials.getHostedRepository();
328             var censusBuilder = credentials.getCensusBuilder()
329                                            .addAuthor(author.forge().currentUser().id())
330                                            .addReviewer(reviewer.forge().currentUser().id())
331                                            .addReviewer(integrator.forge().currentUser().id());
332             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
333 
334             // Populate the projects repository
335             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
336             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
337             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
338             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
339 
340             // Make a change with a corresponding PR
341             var editHash = CheckableRepository.appendAndCommit(localRepo);
342             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
343             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
344 
345             // Approve it as another user
346             var approvalPr = integrator.pullRequest(pr.id());
347             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
348 
349             // Let the bot see it (a few times)
350             TestBotRunner.runPeriodicItems(mergeBot);
351             TestBotRunner.runPeriodicItems(mergeBot);
352             TestBotRunner.runPeriodicItems(mergeBot);
353 
354             // The bot should reply with an instructional message (and only one)
355             var pushed = pr.comments().stream()
356                            .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
357                            .filter(comment -&gt; comment.body().contains(&quot;Reviewed-by: integrationreviewer3&quot;))
358                            .count();
359             assertEquals(1, pushed);
360 
361             // Ensure that the bot doesn&#39;t pick up on commands in the instructional message
362             var error = pr.comments().stream()
363                           .filter(comment -&gt; comment.body().contains(&quot;Only the author&quot;))
364                           .count();
365             assertEquals(0, error);
366 
367             // Drop the approval
368             approvalPr.addReview(Review.Verdict.DISAPPROVED, &quot;Disapproved&quot;);
369             TestBotRunner.runPeriodicItems(mergeBot);
370 
371             // The instructional message should have been updated
372             pushed = pr.comments().stream()
373                        .filter(comment -&gt; comment.body().contains(&quot;no longer ready for integration&quot;))
374                        .count();
375             assertEquals(1, pushed);
376 
377             // Restore the approval
378             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
379             TestBotRunner.runPeriodicItems(mergeBot);
380 
381             // The instructional message should have been updated
382             pushed = pr.comments().stream()
383                        .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
384                        .filter(comment -&gt; comment.body().contains(&quot;Reviewed-by: integrationreviewer3&quot;))
385                        .count();
386             assertEquals(1, pushed);
387 
388             // Approve it as yet another user
389             var reviewerPr = reviewer.pullRequest(pr.id());
390             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
391             TestBotRunner.runPeriodicItems(mergeBot);
392 
393             // The instructional message should have been updated
394             pushed = pr.comments().stream()
395                        .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
396                        .filter(comment -&gt; comment.body().contains(&quot;Reviewed-by: integrationreviewer3, integrationreviewer2&quot;))
397                        .count();
398             assertEquals(1, pushed);
399         }
400     }
401 
402     @Test
403     void invalidCommandAuthor(TestInfo testInfo) throws IOException {
404         try (var credentials = new HostCredentials(testInfo);
405              var tempFolder = new TemporaryDirectory()) {
406             var author = credentials.getHostedRepository();
407             var integrator = credentials.getHostedRepository();
408             var external = credentials.getHostedRepository();
409 
410             var censusBuilder = credentials.getCensusBuilder()
411                                            .addAuthor(author.forge().currentUser().id());
412             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
413 
414             // Populate the projects repository
415             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
416             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
417             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
418             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
419 
420             // Make a change with a corresponding PR
421             var editHash = CheckableRepository.appendAndCommit(localRepo);
422             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
423             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
424 
425             // Issue a merge command not as the PR author
426             var externalPr = external.pullRequest(pr.id());
427             externalPr.addComment(&quot;/integrate&quot;);
428             TestBotRunner.runPeriodicItems(mergeBot);
429 
430             // The bot should reply with an error message
431             var error = pr.comments().stream()
432                           .filter(comment -&gt; comment.body().contains(&quot;Only the author&quot;))
433                           .count();
434             assertEquals(1, error);
435         }
436     }
437 
438     @Test
439     void invalidCommandSponsor(TestInfo testInfo) throws IOException {
440         try (var credentials = new HostCredentials(testInfo);
441              var tempFolder = new TemporaryDirectory()) {
442             var author = credentials.getHostedRepository();
443             var integrator = credentials.getHostedRepository();
444             var external = credentials.getHostedRepository();
445 
446             var censusBuilder = credentials.getCensusBuilder()
447                                            .addAuthor(author.forge().currentUser().id())
448                                            .addReviewer(integrator.forge().currentUser().id())
449                                            .addCommitter(external.forge().currentUser().id());
450             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
451 
452             // Populate the projects repository
453             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
454             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
455             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
456             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
457 
458             // Make a change with a corresponding PR
459             var editHash = CheckableRepository.appendAndCommit(localRepo);
460             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
461             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
462 
463             // Approve it as another user
464             var approvalPr = integrator.pullRequest(pr.id());
465             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
466             TestBotRunner.runPeriodicItems(mergeBot);
467 
468             // Mark it as ready for integration
469             pr.addComment(&quot;/integrate&quot;);
470             TestBotRunner.runPeriodicItems(mergeBot);
471 
472             // Issue a merge command not as the PR author
473             var externalPr = external.pullRequest(pr.id());
474             externalPr.addComment(&quot;/integrate&quot;);
475             TestBotRunner.runPeriodicItems(mergeBot);
476 
477             // The bot should reply with an error message
478             var error = pr.comments().stream()
479                           .filter(comment -&gt; comment.body().contains(&quot;Only the author&quot;))
480                           .filter(comment -&gt; comment.body().contains(&quot;did you mean to&quot;))
481                           .filter(comment -&gt; comment.body().contains(&quot;`/sponsor`&quot;))
482                           .count();
483             assertEquals(1, error);
484         }
485     }
486 
487     @Test
488     void autoRebase(TestInfo testInfo) throws IOException {
489         try (var credentials = new HostCredentials(testInfo);
490              var tempFolder = new TemporaryDirectory();
491              var pushedFolder = new TemporaryDirectory()) {
492 
493             var author = credentials.getHostedRepository();
494             var integrator = credentials.getHostedRepository();
495             var censusBuilder = credentials.getCensusBuilder()
496                                            .addCommitter(author.forge().currentUser().id())
497                                            .addReviewer(integrator.forge().currentUser().id());
498             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
499 
500             // Populate the projects repository
501             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
502             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
503             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
504             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
505 
506             // Make a change with a corresponding PR
507             var editHash = CheckableRepository.appendAndCommit(localRepo);
508             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
509             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
510 
511             // Approve it as another user
512             var approvalPr = integrator.pullRequest(pr.id());
513             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
514 
515             // Push something unrelated to master
516             localRepo.checkout(masterHash, true);
517             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
518             Files.writeString(unrelated, &quot;Hello&quot;);
519             localRepo.add(unrelated);
520             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
521             localRepo.push(unrelatedHash, author.url(), &quot;master&quot;);
522 
523             // Attempt a merge (the bot should only process the first one)
524             pr.addComment(&quot;/integrate&quot;);
525             pr.addComment(&quot;/integrate&quot;);
526             pr.addComment(&quot;/integrate&quot;);
527             TestBotRunner.runPeriodicItems(mergeBot);
528 
529             // The bot should reply with an ok message
530             var pushed = pr.comments().stream()
531                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
532                            .filter(comment -&gt; comment.body().contains(&quot;commit was automatically rebased without conflicts&quot;))
533                            .count();
534             assertEquals(1, pushed);
535 
536             // The change should now be present on the master branch
537             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
538             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
539         }
540     }
541 
542     @Test
543     void retryOnFailure(TestInfo testInfo) throws IOException {
544         try (var credentials = new HostCredentials(testInfo);
545              var tempFolder = new TemporaryDirectory();
546              var censusFolder = new TemporaryDirectory()) {
547 
548             var author = credentials.getHostedRepository();
549             var integrator = credentials.getHostedRepository();
550             var censusBuilder = credentials.getCensusBuilder()
551                                            .addCommitter(author.forge().currentUser().id())
552                                            .addReviewer(integrator.forge().currentUser().id());
553             var censusRepo = censusBuilder.build();
554             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusRepo).build();
555 
556             // Populate the projects repository
557             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
558             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
559             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
560             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
561 
562             // Make a change with a corresponding PR
563             var editHash = CheckableRepository.appendAndCommit(localRepo);
564             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
565             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
566 
567             // Approve it as another user
568             var approvalPr = integrator.pullRequest(pr.id());
569             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
570 
571             // Let the bot check it
572             TestBotRunner.runPeriodicItems(mergeBot);
573 
574             // Break the census to cause an exception
575             var localCensus = Repository.materialize(censusFolder.path(), censusRepo.url(), &quot;+master:current_census&quot;);
576             var currentCensusHash = localCensus.resolve(&quot;current_census&quot;).orElseThrow();
577             Files.writeString(censusFolder.path().resolve(&quot;contributors.xml&quot;), &quot;This is not xml&quot;, StandardCharsets.UTF_8);
578             localCensus.add(censusFolder.path().resolve(&quot;contributors.xml&quot;));
579             var badCensusHash = localCensus.commit(&quot;Bad census update&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
580             localCensus.push(badCensusHash, censusRepo.url(), &quot;master&quot;, true);
581 
582             // Attempt a merge (without triggering another check)
583             pr.addComment(&quot;/integrate&quot;);
584             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(mergeBot, wi -&gt; wi instanceof CheckWorkItem));
585 
586             // Restore the census
587             localCensus.push(currentCensusHash, censusRepo.url(), &quot;master&quot;, true);
588 
589             // The bot should now retry
590             TestBotRunner.runPeriodicItems(mergeBot, wi -&gt; wi instanceof CheckWorkItem);
591 
592             // The bot should reply with an ok message
593             var pushed = pr.comments().stream()
594                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
595                            .count();
596             assertEquals(1, pushed);
597         }
598     }
599 
600     @Test
601     void cannotRebase(TestInfo testInfo) throws IOException {
602         try (var credentials = new HostCredentials(testInfo);
603              var tempFolder = new TemporaryDirectory()) {
604 
605             var author = credentials.getHostedRepository();
606             var integrator = credentials.getHostedRepository();
607             var censusBuilder = credentials.getCensusBuilder()
608                                            .addCommitter(author.forge().currentUser().id())
609                                            .addReviewer(integrator.forge().currentUser().id());
610             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
611 
612             // Populate the projects repository
613             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
614             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
615             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
616             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
617 
618             // Make a change with a corresponding PR
619             var editHash = CheckableRepository.appendAndCommit(localRepo);
620             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
621             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
622 
623             // Approve it as another user
624             var approvalPr = integrator.pullRequest(pr.id());
625             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
626 
627             // Push something conflicting to master
628             localRepo.checkout(masterHash, true);
629             var conflictingHash = CheckableRepository.appendAndCommit(localRepo, &quot;This looks like a conflict&quot;);
630             localRepo.push(conflictingHash, author.url(), &quot;master&quot;);
631 
632             // Attempt an integration
633             pr.addComment(&quot;/integrate&quot;);
634             TestBotRunner.runPeriodicItems(mergeBot);
635 
636             // The bot should reply with an error message
637             var error = pr.comments().stream()
638                           .filter(comment -&gt; comment.body().contains(&quot;It was not possible to rebase your changes automatically.&quot;))
639                           .filter(comment -&gt; comment.body().contains(&quot;Please merge `master`&quot;))
640                           .count();
641             assertEquals(1, error);
642         }
643     }
644 
645     @Test
646     void noAutoRebase(TestInfo testInfo) throws IOException {
647         try (var credentials = new HostCredentials(testInfo);
648              var tempFolder = new TemporaryDirectory();
649              var pushedFolder = new TemporaryDirectory()) {
650 
651             var author = credentials.getHostedRepository();
652             var integrator = credentials.getHostedRepository();
653             var censusBuilder = credentials.getCensusBuilder()
654                                            .addCommitter(author.forge().currentUser().id())
655                                            .addReviewer(integrator.forge().currentUser().id());
656             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
657 
658             // Populate the projects repository
659             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
660             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
661             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
662             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
663 
664             // Make a change with a corresponding PR
665             var editHash = CheckableRepository.appendAndCommit(localRepo);
666             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
667             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
668 
669             // Approve it as another user
670             var approvalPr = integrator.pullRequest(pr.id());
671             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
672 
673             // Push something unrelated to master
674             localRepo.checkout(masterHash, true);
675             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
676             Files.writeString(unrelated, &quot;Hello&quot;);
677             localRepo.add(unrelated);
678             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
679             localRepo.push(unrelatedHash, author.url(), &quot;master&quot;);
680 
681             // Attempt a merge
682             pr.addComment(&quot;/integrate &quot; + masterHash);
683             TestBotRunner.runPeriodicItems(mergeBot);
684 
685             // The bot should reply with an error message
686             assertLastCommentContains(pr, &quot;the target branch is no longer at the requested hash&quot;);
687 
688             // Now use the correct target hash
689             pr.addComment(&quot;/integrate &quot; + unrelatedHash);
690             TestBotRunner.runPeriodicItems(mergeBot);
691 
692             // The bot should reply with an ok message
693             assertLastCommentContains(pr, &quot;Pushed as commit&quot;);
694 
695             // The change should now be present on the master branch
696             var pushedRepo = Repository.materialize(pushedFolder.path(), author.url(), &quot;master&quot;);
697             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
698         }
699     }
700 
701     @Test
702     void missingContributingFile(TestInfo testInfo) throws IOException {
703         try (var credentials = new HostCredentials(testInfo);
704              var tempFolder = new TemporaryDirectory();
705              var pushedFolder = new TemporaryDirectory()) {
706 
707             var author = credentials.getHostedRepository();
708             var integrator = credentials.getHostedRepository();
709             var censusBuilder = credentials.getCensusBuilder()
710                                            .addCommitter(author.forge().currentUser().id())
711                                            .addReviewer(integrator.forge().currentUser().id());
712             var prBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
713 
714             // Populate the projects repository
715             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
716             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
717             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
718             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
719 
720             // Make a change with a corresponding PR
721             var editHash = CheckableRepository.appendAndCommit(localRepo);
722             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
723             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
724 
725             // Approve it as another user
726             var approvalPr = integrator.pullRequest(pr.id());
727             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
728 
729             TestBotRunner.runPeriodicItems(prBot);
730 
731             // The bot should reply with an instructional message and no link to CONTRIBUTING.md
732             var lastComment = pr.comments().get(pr.comments().size() - 1);
733             assertFalse(lastComment.body().contains(&quot;CONTRIBUTING.md&quot;));
734         }
735     }
736 
737     @Test
738     void existingContributingFile(TestInfo testInfo) throws IOException {
739         try (var credentials = new HostCredentials(testInfo);
740              var tempFolder = new TemporaryDirectory();
741              var pushedFolder = new TemporaryDirectory()) {
742 
743             var author = credentials.getHostedRepository();
744             var integrator = credentials.getHostedRepository();
745             var censusBuilder = credentials.getCensusBuilder()
746                                            .addCommitter(author.forge().currentUser().id())
747                                            .addReviewer(integrator.forge().currentUser().id());
748             var prBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();
749 
750             // Populate the projects repository
751             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
752             var contributingFile = localRepo.root().resolve(&quot;CONTRIBUTING.md&quot;);
753             Files.writeString(contributingFile, &quot;Patches welcome!\n&quot;);
754             localRepo.add(contributingFile);
755             localRepo.commit(&quot;Add CONTRIBUTING.md&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
756             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
757             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
758             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
759 
760             // Make a change with a corresponding PR
761             var editHash = CheckableRepository.appendAndCommit(localRepo);
762             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
763             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
764 
765             // Approve it as another user
766             var approvalPr = integrator.pullRequest(pr.id());
767             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
768 
769             TestBotRunner.runPeriodicItems(prBot);
770 
771             // The bot should reply with an instructional message and no link to CONTRIBUTING.md
772             var lastComment = pr.comments().get(pr.comments().size() - 1);
773             assertTrue(lastComment.body().contains(&quot;CONTRIBUTING.md&quot;));
774         }
775     }
776 }
    </pre>
  </body>
</html>