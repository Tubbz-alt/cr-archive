<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveItem.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ReviewArchive.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveItem.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
134                                () -&gt; ArchiveMessages.composeReplyHeader(parent.createdAt(), hostUserToEmailAuthor.author(parent.author())),
135                                () -&gt; ArchiveMessages.composeReviewComment(pr, reviewComment) ,
136                                () -&gt; ArchiveMessages.composeReplyFooter(pr));
137     }
138 
139     private static Pattern mentionPattern = Pattern.compile(&quot;^@([\\w-]+).*&quot;);
140 
141     private static Optional&lt;ArchiveItem&gt; findLastMention(String commentText, List&lt;ArchiveItem&gt; eligibleParents) {
142         var mentionMatcher = mentionPattern.matcher(commentText);
143         if (mentionMatcher.matches()) {
144             var username = mentionMatcher.group(1);
145             for (int i = eligibleParents.size() - 1; i != 0; --i) {
146                 if (eligibleParents.get(i).author.userName().equals(username)) {
147                     return Optional.of(eligibleParents.get(i));
148                 }
149             }
150         }
151         return Optional.empty();
152     }
153 






















154     static ArchiveItem findParent(List&lt;ArchiveItem&gt; generated, Comment comment) {
155         ArchiveItem lastCommentOrReview = generated.get(0);
156         var eligible = new ArrayList&lt;ArchiveItem&gt;();
157         eligible.add(lastCommentOrReview);
158         for (var item : generated) {
159             if (item.id().startsWith(&quot;pc&quot;) || item.id().startsWith(&quot;rv&quot;)) {
160                 if (item.createdAt().isBefore(comment.createdAt()) &amp;&amp; item.createdAt().isAfter(lastCommentOrReview.createdAt())) {
161                     lastCommentOrReview = item;
162                     eligible.add(lastCommentOrReview);
163                 }
164             }
165         }
166 
167         var lastMention = findLastMention(comment.body(), eligible);
168         if (lastMention.isPresent()) {
169             return lastMention.get();
170         }




171 
172         return lastCommentOrReview;
173     }
174 
175     static ArchiveItem findRevisionItem(List&lt;ArchiveItem&gt; generated, Hash hash) {
176         // Parent is revision update mail with the hash
177         ArchiveItem lastRevisionItem = generated.get(0);
178         for (var item : generated) {
179             if (item.id().startsWith(&quot;ha&quot;)) {
180                 lastRevisionItem = item;
181             }
182             if (item.id().equals(&quot;ha&quot; + hash.hex())) {
183                 return item;
184             }
185         }
186         return lastRevisionItem;
187     }
188 
189     static ArchiveItem findReviewCommentItem(List&lt;ArchiveItem&gt; generated, ReviewComment reviewComment) {
190         for (var item : generated) {
</pre>
</td>
<td>
<hr />
<pre>
134                                () -&gt; ArchiveMessages.composeReplyHeader(parent.createdAt(), hostUserToEmailAuthor.author(parent.author())),
135                                () -&gt; ArchiveMessages.composeReviewComment(pr, reviewComment) ,
136                                () -&gt; ArchiveMessages.composeReplyFooter(pr));
137     }
138 
139     private static Pattern mentionPattern = Pattern.compile(&quot;^@([\\w-]+).*&quot;);
140 
141     private static Optional&lt;ArchiveItem&gt; findLastMention(String commentText, List&lt;ArchiveItem&gt; eligibleParents) {
142         var mentionMatcher = mentionPattern.matcher(commentText);
143         if (mentionMatcher.matches()) {
144             var username = mentionMatcher.group(1);
145             for (int i = eligibleParents.size() - 1; i != 0; --i) {
146                 if (eligibleParents.get(i).author.userName().equals(username)) {
147                     return Optional.of(eligibleParents.get(i));
148                 }
149             }
150         }
151         return Optional.empty();
152     }
153 
<span class="line-added">154     static boolean containsQuote(String quote, String body) {</span>
<span class="line-added">155         var compactQuote = quote.lines()</span>
<span class="line-added">156                                 .takeWhile(line -&gt; line.startsWith(&quot;&gt;&quot;))</span>
<span class="line-added">157                                 .map(line -&gt; line.replaceAll(&quot;\\W&quot;, &quot;&quot;))</span>
<span class="line-added">158                                 .collect(Collectors.joining());</span>
<span class="line-added">159         if (!compactQuote.isBlank()) {</span>
<span class="line-added">160             var compactBody = body.replaceAll(&quot;\\W&quot;, &quot;&quot;);</span>
<span class="line-added">161             return compactBody.contains(compactQuote);</span>
<span class="line-added">162         } else {</span>
<span class="line-added">163             return false;</span>
<span class="line-added">164         }</span>
<span class="line-added">165     }</span>
<span class="line-added">166 </span>
<span class="line-added">167     private static Optional&lt;ArchiveItem&gt; findLastQuoted(String commentText, List&lt;ArchiveItem&gt; eligibleParents) {</span>
<span class="line-added">168         for (int i = eligibleParents.size() - 1; i != 0; --i) {</span>
<span class="line-added">169             if (containsQuote(commentText, eligibleParents.get(i).body())) {</span>
<span class="line-added">170                 return Optional.of(eligibleParents.get(i));</span>
<span class="line-added">171             }</span>
<span class="line-added">172         }</span>
<span class="line-added">173         return Optional.empty();</span>
<span class="line-added">174     }</span>
<span class="line-added">175 </span>
176     static ArchiveItem findParent(List&lt;ArchiveItem&gt; generated, Comment comment) {
177         ArchiveItem lastCommentOrReview = generated.get(0);
178         var eligible = new ArrayList&lt;ArchiveItem&gt;();
179         eligible.add(lastCommentOrReview);
180         for (var item : generated) {
181             if (item.id().startsWith(&quot;pc&quot;) || item.id().startsWith(&quot;rv&quot;)) {
182                 if (item.createdAt().isBefore(comment.createdAt()) &amp;&amp; item.createdAt().isAfter(lastCommentOrReview.createdAt())) {
183                     lastCommentOrReview = item;
184                     eligible.add(lastCommentOrReview);
185                 }
186             }
187         }
188 
189         var lastMention = findLastMention(comment.body(), eligible);
190         if (lastMention.isPresent()) {
191             return lastMention.get();
192         }
<span class="line-added">193         var lastQuoted = findLastQuoted(comment.body(), eligible);</span>
<span class="line-added">194         if (lastQuoted.isPresent()) {</span>
<span class="line-added">195             return lastQuoted.get();</span>
<span class="line-added">196         }</span>
197 
198         return lastCommentOrReview;
199     }
200 
201     static ArchiveItem findRevisionItem(List&lt;ArchiveItem&gt; generated, Hash hash) {
202         // Parent is revision update mail with the hash
203         ArchiveItem lastRevisionItem = generated.get(0);
204         for (var item : generated) {
205             if (item.id().startsWith(&quot;ha&quot;)) {
206                 lastRevisionItem = item;
207             }
208             if (item.id().equals(&quot;ha&quot; + hash.hex())) {
209                 return item;
210             }
211         }
212         return lastRevisionItem;
213     }
214 
215     static ArchiveItem findReviewCommentItem(List&lt;ArchiveItem&gt; generated, ReviewComment reviewComment) {
216         for (var item : generated) {
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ReviewArchive.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>