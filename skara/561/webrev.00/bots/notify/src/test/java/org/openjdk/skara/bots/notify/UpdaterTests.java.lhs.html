<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.notify;
  24 
  25 import org.openjdk.skara.email.*;
  26 import org.openjdk.skara.forge.HostedRepository;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.json.*;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.storage.StorageBuilder;
  31 import org.openjdk.skara.test.*;
  32 import org.openjdk.skara.vcs.*;
  33 import org.openjdk.skara.vcs.Tag;
  34 import org.openjdk.skara.vcs.openjdk.OpenJDKTag;
  35 
  36 import org.junit.jupiter.api.*;
  37 
  38 import java.io.IOException;
  39 import java.net.URI;
  40 import java.nio.charset.StandardCharsets;
  41 import java.nio.file.*;
  42 import java.time.Duration;
  43 import java.util.*;
  44 import java.util.regex.Pattern;
  45 import java.util.stream.Collectors;
  46 
  47 import static org.junit.jupiter.api.Assertions.*;
  48 import static org.openjdk.skara.issuetracker.Issue.State.*;
  49 
  50 class UpdaterTests {
  51     private List&lt;Path&gt; findJsonFiles(Path folder, String partialName) throws IOException {
  52         return Files.walk(folder)
  53                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
  54                     .filter(path -&gt; path.toString().contains(partialName))
  55                     .collect(Collectors.toList());
  56     }
  57 
  58     private StorageBuilder&lt;UpdatedTag&gt; createTagStorage(HostedRepository repository) {
  59         return new StorageBuilder&lt;UpdatedTag&gt;(&quot;tags.txt&quot;)
  60                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);
  61     }
  62 
  63     private StorageBuilder&lt;UpdatedBranch&gt; createBranchStorage(HostedRepository repository) {
  64         return new StorageBuilder&lt;UpdatedBranch&gt;(&quot;branches.txt&quot;)
  65                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);
  66     }
  67 
  68     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {
  69         return new StorageBuilder&lt;PullRequestIssues&gt;(&quot;prissues.txt&quot;)
  70                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated prissues&quot;);
  71     }
  72 
  73     private Set&lt;String&gt; fixVersions(Issue issue) {
  74         if (!issue.properties().containsKey(&quot;fixVersions&quot;)) {
  75             return Set.of();
  76         }
  77         return issue.properties().get(&quot;fixVersions&quot;).stream()
  78                     .map(JSONValue::asString)
  79                     .collect(Collectors.toSet());
  80     }
  81 
  82     @Test
  83     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
  84         try (var credentials = new HostCredentials(testInfo);
  85              var tempFolder = new TemporaryDirectory()) {
  86             var repo = credentials.getHostedRepository();
  87             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
  88             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
  89             credentials.commitLock(localRepo);
  90             localRepo.pushAll(repo.url());
  91 
  92             var tagStorage = createTagStorage(repo);
  93             var branchStorage = createBranchStorage(repo);
  94             var prIssuesStorage = createPullRequestIssuesStorage(repo);
  95             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
  96             Files.createDirectory(jsonFolder);
  97             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  98 
  99             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
 100             var notifyBot = NotifyBot.newBuilder()
 101                                      .repository(repo)
 102                                      .storagePath(storageFolder)
 103                                      .branches(Pattern.compile(&quot;master&quot;))
 104                                      .tagStorageBuilder(tagStorage)
 105                                      .branchStorageBuilder(branchStorage)
 106                                      .prIssuesStorageBuilder(prIssuesStorage)
 107                                      .updaters(List.of(updater))
 108                                      .build();
 109 
 110             TestBotRunner.runPeriodicItems(notifyBot);
 111             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 112 
 113             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 114             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 115             TestBotRunner.runPeriodicItems(notifyBot);
 116             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 117             assertEquals(1, jsonFiles.size());
 118             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 119             var json = JSON.parse(jsonData);
 120             assertEquals(1, json.asArray().size());
 121             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 122             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 123                                                   .map(JSONValue::asString)
 124                                                   .collect(Collectors.toList()));
 125         }
 126     }
 127 
 128     @Test
 129     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
 130         try (var credentials = new HostCredentials(testInfo);
 131              var tempFolder = new TemporaryDirectory()) {
 132             var repo = credentials.getHostedRepository();
 133             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 134             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 135             credentials.commitLock(localRepo);
 136             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 137             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 138             localRepo.pushAll(repo.url());
 139 
 140             var tagStorage = createTagStorage(repo);
 141             var branchStorage = createBranchStorage(repo);
 142             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 143             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 144             Files.createDirectory(jsonFolder);
 145             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
 146 
 147             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
 148             var notifyBot = NotifyBot.newBuilder()
 149                                      .repository(repo)
 150                                      .storagePath(storageFolder)
 151                                      .branches(Pattern.compile(&quot;master&quot;))
 152                                      .tagStorageBuilder(tagStorage)
 153                                      .branchStorageBuilder(branchStorage)
 154                                      .prIssuesStorageBuilder(prIssuesStorage)
 155                                      .updaters(List.of(updater))
 156                                      .build();
 157 
 158             TestBotRunner.runPeriodicItems(notifyBot);
 159             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 160 
 161             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 162             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 163             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 164             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
 165             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 166             localRepo.pushAll(repo.url());
 167 
 168             TestBotRunner.runPeriodicItems(notifyBot);
 169             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 170             assertEquals(3, jsonFiles.size());
 171 
 172             for (var file : jsonFiles) {
 173                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
 174                 var json = JSON.parse(jsonData);
 175 
 176                 if (json.asArray().get(0).contains(&quot;date&quot;)) {
 177                     assertEquals(2, json.asArray().size());
 178                     assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 179                                                           .map(JSONValue::asString)
 180                                                           .collect(Collectors.toList()));
 181                     assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 182                     assertEquals(&quot;team&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 183                     assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(1).get(&quot;issue&quot;).asArray().stream()
 184                                                           .map(JSONValue::asString)
 185                                                           .collect(Collectors.toList()));
 186                     assertEquals(repo.webUrl(editHash2).toString(), json.asArray().get(1).get(&quot;url&quot;).asString());
 187                     assertEquals(&quot;team&quot;, json.asArray().get(1).get(&quot;build&quot;).asString());
 188                 } else {
 189                     assertEquals(1, json.asArray().size());
 190                     if (json.asArray().get(0).get(&quot;build&quot;).asString().equals(&quot;b02&quot;)) {
 191                         assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 192                                                               .map(JSONValue::asString)
 193                                                               .collect(Collectors.toList()));
 194                     } else {
 195                         assertEquals(&quot;b04&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 196                         assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 197                                                               .map(JSONValue::asString)
 198                                                               .collect(Collectors.toList()));
 199                     }
 200                 }
 201             }
 202         }
 203     }
 204 
 205     @Test
 206     void testMailingList(TestInfo testInfo) throws IOException {
 207         try (var listServer = new TestMailmanServer();
 208              var credentials = new HostCredentials(testInfo);
 209              var tempFolder = new TemporaryDirectory()) {
 210             var repo = credentials.getHostedRepository();
 211             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 212             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 213             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 214             credentials.commitLock(localRepo);
 215             localRepo.pushAll(repo.url());
 216 
 217             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 218             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 219             var mailmanList = mailmanServer.getList(listAddress.address());
 220             var tagStorage = createTagStorage(repo);
 221             var branchStorage = createBranchStorage(repo);
 222             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 223             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 224 
 225             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 226             var updater = MailingListUpdater.newBuilder()
 227                                             .list(mailmanList)
 228                                             .recipient(listAddress)
 229                                             .sender(sender)
 230                                             .reportNewTags(false)
 231                                             .reportNewBranches(false)
 232                                             .reportNewBuilds(false)
 233                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 234                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
 235                                             .build();
 236             var notifyBot = NotifyBot.newBuilder()
 237                                      .repository(repo)
 238                                      .storagePath(storageFolder)
 239                                      .branches(Pattern.compile(&quot;master&quot;))
 240                                      .tagStorageBuilder(tagStorage)
 241                                      .branchStorageBuilder(branchStorage)
 242                                      .prIssuesStorageBuilder(prIssuesStorage)
 243                                      .updaters(List.of(updater))
 244                                      .build();
 245 
 246             // No mail should be sent on the first run as there is no history
 247             TestBotRunner.runPeriodicItems(notifyBot);
 248             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 249 
 250             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 251             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 252             TestBotRunner.runPeriodicItems(notifyBot);
 253             listServer.processIncoming();
 254 
 255             var conversations = mailmanList.conversations(Duration.ofDays(1));
 256             var email = conversations.get(0).first();
 257             assertEquals(listAddress, email.sender());
 258             assertEquals(sender, email.author());
 259             assertEquals(email.recipients(), List.of(listAddress));
 260             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
 261             assertFalse(email.subject().contains(&quot;master&quot;));
 262             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 263             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 264             assertFalse(email.body().contains(&quot;Committer&quot;));
 265             assertFalse(email.body().contains(masterHash.abbreviate()));
 266             assertTrue(email.hasHeader(&quot;extra1&quot;));
 267             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 268             assertTrue(email.hasHeader(&quot;extra2&quot;));
 269             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
<a name="1" id="anc1"></a>



 270         }
 271     }
 272 
 273     @Test
 274     void testMailingListMultiple(TestInfo testInfo) throws IOException {
 275         try (var listServer = new TestMailmanServer();
 276              var credentials = new HostCredentials(testInfo);
 277              var tempFolder = new TemporaryDirectory()) {
 278             var repo = credentials.getHostedRepository();
 279             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 280             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 281             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 282             credentials.commitLock(localRepo);
 283             localRepo.pushAll(repo.url());
 284 
 285             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 286             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 287             var mailmanList = mailmanServer.getList(listAddress.address());
 288             var tagStorage = createTagStorage(repo);
 289             var branchStorage = createBranchStorage(repo);
 290             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 291             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 292 
 293             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 294             var updater = MailingListUpdater.newBuilder()
 295                                             .list(mailmanList)
 296                                             .recipient(listAddress)
 297                                             .sender(sender)
 298                                             .reportNewTags(false)
 299                                             .reportNewBranches(false)
 300                                             .reportNewBuilds(false)
 301                                             .build();
 302             var notifyBot = NotifyBot.newBuilder()
 303                                      .repository(repo)
 304                                      .storagePath(storageFolder)
 305                                      .branches(Pattern.compile(&quot;master&quot;))
 306                                      .tagStorageBuilder(tagStorage)
 307                                      .branchStorageBuilder(branchStorage)
 308                                      .prIssuesStorageBuilder(prIssuesStorage)
 309                                      .updaters(List.of(updater))
 310                                      .build();
 311 
 312             // No mail should be sent on the first run as there is no history
 313             TestBotRunner.runPeriodicItems(notifyBot);
 314             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 315 
 316             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 317                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 318             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 319             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 320                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 321             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 322 
 323             TestBotRunner.runPeriodicItems(notifyBot);
 324             listServer.processIncoming();
 325 
 326             var conversations = mailmanList.conversations(Duration.ofDays(1));
 327             var email = conversations.get(0).first();
 328             assertEquals(listAddress, email.sender());
 329             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());
 330             assertEquals(email.recipients(), List.of(listAddress));
 331             assertTrue(email.subject().contains(&quot;: 2 new changesets&quot;));
 332             assertFalse(email.subject().contains(&quot;master&quot;));
 333             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 334             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 335             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 336             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 337             assertFalse(email.body().contains(masterHash.abbreviate()));
<a name="2" id="anc2"></a>



 338         }
 339     }
 340 
 341     @Test
 342     void testMailingListSponsored(TestInfo testInfo) throws IOException {
 343         try (var listServer = new TestMailmanServer();
 344              var credentials = new HostCredentials(testInfo);
 345              var tempFolder = new TemporaryDirectory()) {
 346             var repo = credentials.getHostedRepository();
 347             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 348             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 349             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 350             credentials.commitLock(localRepo);
 351             localRepo.pushAll(repo.url());
 352 
 353             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 354             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 355             var mailmanList = mailmanServer.getList(listAddress.address());
 356             var tagStorage = createTagStorage(repo);
 357             var branchStorage = createBranchStorage(repo);
 358             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 359             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 360 
 361             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 362             var updater = MailingListUpdater.newBuilder()
 363                                             .list(mailmanList)
 364                                             .recipient(listAddress)
 365                                             .sender(sender)
 366                                             .reportNewTags(false)
 367                                             .reportNewBranches(false)
 368                                             .reportNewBuilds(false)
 369                                             .build();
 370             var notifyBot = NotifyBot.newBuilder()
 371                                      .repository(repo)
 372                                      .storagePath(storageFolder)
 373                                      .branches(Pattern.compile(&quot;master&quot;))
 374                                      .tagStorageBuilder(tagStorage)
 375                                      .branchStorageBuilder(branchStorage)
 376                                      .prIssuesStorageBuilder(prIssuesStorage)
 377                                      .updaters(List.of(updater))
 378                                      .build();
 379 
 380             // No mail should be sent on the first run as there is no history
 381             TestBotRunner.runPeriodicItems(notifyBot);
 382             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 383 
 384             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 385                                                                &quot;author&quot;, &quot;author@test.test&quot;,
 386                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);
 387             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 388             TestBotRunner.runPeriodicItems(notifyBot);
 389             listServer.processIncoming();
 390 
 391             var conversations = mailmanList.conversations(Duration.ofDays(1));
 392             var email = conversations.get(0).first();
 393             assertEquals(listAddress, email.sender());
 394             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
 395             assertEquals(email.recipients(), List.of(listAddress));
 396             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 397             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 398             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
 399             assertTrue(email.body().contains(&quot;Committer: committer &lt;committer@test.test&gt;&quot;));
 400             assertFalse(email.body().contains(masterHash.abbreviate()));
 401         }
 402     }
 403 
 404     @Test
 405     void testMailingListMultipleBranches(TestInfo testInfo) throws IOException {
 406         try (var listServer = new TestMailmanServer();
 407              var credentials = new HostCredentials(testInfo);
 408              var tempFolder = new TemporaryDirectory()) {
 409             var repo = credentials.getHostedRepository();
 410             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 411             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 412             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 413             credentials.commitLock(localRepo);
 414             var branch = localRepo.branch(masterHash, &quot;another&quot;);
 415             localRepo.pushAll(repo.url());
 416 
 417             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 418             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 419             var mailmanList = mailmanServer.getList(listAddress.address());
 420             var tagStorage = createTagStorage(repo);
 421             var branchStorage = createBranchStorage(repo);
 422             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 423             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 424 
 425             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 426             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 427             var updater = MailingListUpdater.newBuilder()
 428                                             .list(mailmanList)
 429                                             .recipient(listAddress)
 430                                             .sender(sender)
 431                                             .author(author)
 432                                             .includeBranch(true)
 433                                             .reportNewTags(false)
 434                                             .reportNewBranches(false)
 435                                             .reportNewBuilds(false)
 436                                             .build();
 437             var notifyBot = NotifyBot.newBuilder()
 438                                      .repository(repo)
 439                                      .storagePath(storageFolder)
 440                                      .branches(Pattern.compile(&quot;master|another&quot;))
 441                                      .tagStorageBuilder(tagStorage)
 442                                      .branchStorageBuilder(branchStorage)
 443                                      .prIssuesStorageBuilder(prIssuesStorage)
 444                                      .updaters(List.of(updater))
 445                                      .build();
 446 
 447             // No mail should be sent on the first run as there is no history
 448             TestBotRunner.runPeriodicItems(notifyBot);
 449             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 450 
 451             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 452             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 453             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
 454             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 455 
 456             TestBotRunner.runPeriodicItems(notifyBot);
 457             listServer.processIncoming();
 458 
 459             var conversations = mailmanList.conversations(Duration.ofDays(1));
 460             var email = conversations.get(0).first();
 461             assertEquals(listAddress, email.sender());
 462             assertEquals(author, email.author());
 463             assertEquals(email.recipients(), List.of(listAddress));
 464             assertFalse(email.subject().contains(&quot;another&quot;));
 465             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
 466             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 467             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 468             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 469             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 470             assertFalse(email.body().contains(masterHash.abbreviate()));
 471             assertFalse(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
<a name="3" id="anc3"></a>



 472 
 473             localRepo.checkout(branch, true);
 474             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);
 475             localRepo.push(editHash3, repo.url(), &quot;another&quot;);
 476 
 477             TestBotRunner.runPeriodicItems(notifyBot);
 478             listServer.processIncoming();
 479 
 480             conversations = mailmanList.conversations(Duration.ofDays(1));
 481             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 482             email = conversations.get(0).first();
 483             assertEquals(author, email.author());
 484             assertEquals(listAddress, email.sender());
 485             assertEquals(email.recipients(), List.of(listAddress));
 486             assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));
 487             assertFalse(email.subject().contains(&quot;master&quot;));
 488             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));
 489             assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 490             assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 491             assertFalse(email.body().contains(&quot;3456789A: Even more fixes&quot;));
<a name="4" id="anc4"></a>



 492         }
 493     }
 494 
 495     @Test
 496     void testMailingListPROnly(TestInfo testInfo) throws IOException {
 497         try (var listServer = new TestMailmanServer();
 498              var credentials = new HostCredentials(testInfo);
 499              var tempFolder = new TemporaryDirectory()) {
 500             var repo = credentials.getHostedRepository();
 501             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 502             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 503             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 504             credentials.commitLock(localRepo);
 505             localRepo.pushAll(repo.url());
 506 
 507             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 508             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 509             var mailmanList = mailmanServer.getList(listAddress.address());
 510             var tagStorage = createTagStorage(repo);
 511             var branchStorage = createBranchStorage(repo);
 512             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 513             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 514 
 515             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 516             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 517             var updater = MailingListUpdater.newBuilder()
 518                                             .list(mailmanList)
 519                                             .recipient(listAddress)
 520                                             .sender(sender)
 521                                             .author(author)
 522                                             .reportNewTags(false)
 523                                             .reportNewBranches(false)
 524                                             .reportNewBuilds(false)
 525                                             .mode(MailingListUpdater.Mode.PR_ONLY)
 526                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;))
 527                                             .build();
 528             var notifyBot = NotifyBot.newBuilder()
 529                                      .repository(repo)
 530                                      .storagePath(storageFolder)
 531                                      .branches(Pattern.compile(&quot;master&quot;))
 532                                      .tagStorageBuilder(tagStorage)
 533                                      .branchStorageBuilder(branchStorage)
 534                                      .prIssuesStorageBuilder(prIssuesStorage)
 535                                      .updaters(List.of(updater))
 536                                      .build();
 537 
 538             // No mail should be sent on the first run as there is no history
 539             TestBotRunner.runPeriodicItems(notifyBot);
 540             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 541 
 542             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 543             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 544             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 545 
 546             // Create a potentially conflicting one
 547             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 548             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 549             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 550 
 551             // PR hasn&#39;t been integrated yet, so there should be no mail
 552             TestBotRunner.runPeriodicItems(notifyBot);
 553             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 554 
 555             // Simulate an RFR email
 556             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
 557                     .recipient(listAddress)
 558                     .build();
 559             mailmanList.post(rfr);
 560             listServer.processIncoming();
 561 
 562             // And an integration
 563             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 564             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 565             TestBotRunner.runPeriodicItems(notifyBot);
 566             listServer.processIncoming();
 567 
 568             var conversations = mailmanList.conversations(Duration.ofDays(1));
 569             assertEquals(1, conversations.size());
 570             var first = conversations.get(0).first();
 571             var email = conversations.get(0).replies(first).get(0);
 572             assertEquals(listAddress, email.sender());
 573             assertEquals(author, email.author());
 574             assertEquals(email.recipients(), List.of(listAddress));
 575             assertEquals(&quot;[Integrated] RFR: My PR&quot;, email.subject());
 576             assertFalse(email.subject().contains(&quot;master&quot;));
 577             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 578             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 579             assertFalse(email.body().contains(&quot;Committer&quot;));
 580             assertFalse(email.body().contains(masterHash.abbreviate()));
 581             assertTrue(email.hasHeader(&quot;extra1&quot;));
 582             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
<a name="5" id="anc5"></a>



 583 
 584             // Now push the other one without a matching PR - PR_ONLY will not generate a mail
 585             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 586             TestBotRunner.runPeriodicItems(notifyBot);
 587             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofSeconds(1)));
 588         }
 589     }
 590 
 591     @Test
 592     void testMailingListPROnlyMultipleBranches(TestInfo testInfo) throws IOException {
 593         try (var listServer = new TestMailmanServer();
 594              var credentials = new HostCredentials(testInfo);
 595              var tempFolder = new TemporaryDirectory()) {
 596             var repo = credentials.getHostedRepository();
 597             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 598             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 599             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 600             credentials.commitLock(localRepo);
 601             localRepo.pushAll(repo.url());
 602 
 603             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 604             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 605             var mailmanList = mailmanServer.getList(listAddress.address());
 606             var tagStorage = createTagStorage(repo);
 607             var branchStorage = createBranchStorage(repo);
 608             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 609             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 610 
 611             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 612             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 613             var updater = MailingListUpdater.newBuilder()
 614                                             .list(mailmanList)
 615                                             .recipient(listAddress)
 616                                             .sender(sender)
 617                                             .author(author)
 618                                             .reportNewTags(false)
 619                                             .reportNewBranches(false)
 620                                             .reportNewBuilds(false)
 621                                             .includeBranch(true)
 622                                             .mode(MailingListUpdater.Mode.PR)
 623                                             .build();
 624             var notifyBot = NotifyBot.newBuilder()
 625                                      .repository(repo)
 626                                      .storagePath(storageFolder)
 627                                      .branches(Pattern.compile(&quot;master|other&quot;))
 628                                      .tagStorageBuilder(tagStorage)
 629                                      .branchStorageBuilder(branchStorage)
 630                                      .prIssuesStorageBuilder(prIssuesStorage)
 631                                      .updaters(List.of(updater))
 632                                      .build();
 633 
 634             // Populate our known branches
 635             localRepo.push(masterHash, repo.url(), &quot;master&quot;, true);
 636             localRepo.push(masterHash, repo.url(), &quot;other&quot;, true);
 637 
 638             // No mail should be sent on the first run as there is no history
 639             TestBotRunner.runPeriodicItems(notifyBot);
 640             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 641 
 642             localRepo.checkout(masterHash, true);
 643             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 644             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 645             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 646 
 647             // PR hasn&#39;t been integrated yet, so there should be no mail
 648             TestBotRunner.runPeriodicItems(notifyBot);
 649             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 650 
 651             // Simulate an RFR email
 652             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
 653                            .recipient(listAddress)
 654                            .build();
 655             mailmanList.post(rfr);
 656             listServer.processIncoming();
 657 
 658             // And an integration (but it hasn&#39;t reached master just yet)
 659             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 660 
 661             // Now push the same commit to another branch
 662             localRepo.push(editHash, repo.url(), &quot;other&quot;);
 663             TestBotRunner.runPeriodicItems(notifyBot);
 664             listServer.processIncoming();
 665 
 666             // This one should generate a plain integration mail
 667             var conversations = mailmanList.conversations(Duration.ofDays(1));
 668             assertEquals(2, conversations.size());
 669             var secondEmail = conversations.get(0).first();
 670             if (secondEmail.subject().contains(&quot;RFR&quot;)) {
 671                 secondEmail = conversations.get(1).first();
 672             }
 673             assertEquals(&quot;git: test: other: 23456789: More fixes&quot;, secondEmail.subject());
 674         }
 675     }
 676 
 677     @Test
 678     void testMailingListPR(TestInfo testInfo) throws IOException {
 679         try (var listServer = new TestMailmanServer();
 680              var credentials = new HostCredentials(testInfo);
 681              var tempFolder = new TemporaryDirectory()) {
 682             var repo = credentials.getHostedRepository();
 683             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 684             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 685             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 686             credentials.commitLock(localRepo);
 687             localRepo.pushAll(repo.url());
 688 
 689             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 690             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 691             var mailmanList = mailmanServer.getList(listAddress.address());
 692             var tagStorage = createTagStorage(repo);
 693             var branchStorage = createBranchStorage(repo);
 694             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 695             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 696 
 697             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 698             var updater = MailingListUpdater.newBuilder()
 699                                             .list(mailmanList)
 700                                             .recipient(listAddress)
 701                                             .sender(sender)
 702                                             .reportNewTags(false)
 703                                             .reportNewBranches(false)
 704                                             .reportNewBuilds(false)
 705                                             .mode(MailingListUpdater.Mode.PR)
 706                                             .build();
 707             var notifyBot = NotifyBot.newBuilder()
 708                                      .repository(repo)
 709                                      .storagePath(storageFolder)
 710                                      .branches(Pattern.compile(&quot;master&quot;))
 711                                      .tagStorageBuilder(tagStorage)
 712                                      .branchStorageBuilder(branchStorage)
 713                                      .prIssuesStorageBuilder(prIssuesStorage)
 714                                      .updaters(List.of(updater))
 715                                      .build();
 716 
 717             // No mail should be sent on the first run as there is no history
 718             TestBotRunner.runPeriodicItems(notifyBot);
 719             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 720 
 721             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 722             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 723             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 724 
 725             // Create a potentially conflicting one
 726             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 727             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 728             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 729 
 730             // PR hasn&#39;t been integrated yet, so there should be no mail
 731             TestBotRunner.runPeriodicItems(notifyBot);
 732             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 733 
 734             // Simulate an RFR email
 735             var rfr = Email.create(&quot;[repo/branch] RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 736                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 737                            .recipient(listAddress)
 738                            .build();
 739             mailmanList.post(rfr);
 740             listServer.processIncoming();
 741 
 742             // And an integration
 743             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 744             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 745 
 746             // Push the other one without a matching PR
 747             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 748 
 749             TestBotRunner.runPeriodicItems(notifyBot);
 750             listServer.processIncoming();
 751             listServer.processIncoming();
 752 
 753             var conversations = mailmanList.conversations(Duration.ofDays(1));
 754             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 755             assertEquals(2, conversations.size());
 756 
 757             var prConversation = conversations.get(0);
 758             var pushConversation = conversations.get(1);
 759 
 760             var prEmail = prConversation.replies(prConversation.first()).get(0);
 761             assertEquals(listAddress, prEmail.sender());
 762             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
 763             assertEquals(prEmail.recipients(), List.of(listAddress));
 764             assertEquals(&quot;[Integrated] [repo/branch] RFR: My PR&quot;, prEmail.subject());
 765             assertFalse(prEmail.subject().contains(&quot;master&quot;));
 766             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 767             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
 768             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
 769             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
 770 
 771             var pushEmail = pushConversation.first();
 772             assertEquals(listAddress, pushEmail.sender());
 773             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 774             assertEquals(pushEmail.recipients(), List.of(listAddress));
 775             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 776         }
 777     }
 778 
 779     @Test
 780     void testMailingListPROnce(TestInfo testInfo) throws IOException {
 781         try (var listServer = new TestMailmanServer();
 782              var credentials = new HostCredentials(testInfo);
 783              var tempFolder = new TemporaryDirectory()) {
 784             var repo = credentials.getHostedRepository();
 785             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 786             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 787             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 788             localRepo.branch(masterHash, &quot;other&quot;);
 789             credentials.commitLock(localRepo);
 790             localRepo.pushAll(repo.url());
 791 
 792             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 793             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 794             var mailmanList = mailmanServer.getList(listAddress.address());
 795             var tagStorage = createTagStorage(repo);
 796             var branchStorage = createBranchStorage(repo);
 797             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 798             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 799 
 800             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 801             var updater = MailingListUpdater.newBuilder()
 802                                             .list(mailmanList)
 803                                             .recipient(listAddress)
 804                                             .sender(sender)
 805                                             .author(null)
 806                                             .reportNewTags(false)
 807                                             .reportNewBranches(false)
 808                                             .reportNewBuilds(false)
 809                                             .mode(MailingListUpdater.Mode.PR)
 810                                             .build();
 811             var notifyBot = NotifyBot.newBuilder()
 812                                      .repository(repo)
 813                                      .storagePath(storageFolder)
 814                                      .branches(Pattern.compile(&quot;master|other&quot;))
 815                                      .tagStorageBuilder(tagStorage)
 816                                      .branchStorageBuilder(branchStorage)
 817                                      .prIssuesStorageBuilder(prIssuesStorage)
 818                                      .updaters(List.of(updater))
 819                                      .build();
 820 
 821             // No mail should be sent on the first run as there is no history
 822             TestBotRunner.runPeriodicItems(notifyBot);
 823             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 824 
 825             localRepo.checkout(masterHash, true);
 826             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 827             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 828             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 829 
 830             // PR hasn&#39;t been integrated yet, so there should be no mail
 831             TestBotRunner.runPeriodicItems(notifyBot);
 832             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 833 
 834             // Simulate an RFR email
 835             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 836                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 837                            .recipient(listAddress)
 838                            .build();
 839             mailmanList.post(rfr);
 840             listServer.processIncoming();
 841 
 842             // And an integration
 843             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 844             localRepo.push(editHash, repo.url(), &quot;master&quot;, true);
 845 
 846             TestBotRunner.runPeriodicItems(notifyBot);
 847             listServer.processIncoming();
 848 
 849             var conversations = mailmanList.conversations(Duration.ofDays(1));
 850             assertEquals(1, conversations.size());
 851 
 852             var prConversation = conversations.get(0);
 853             var prEmail = prConversation.replies(prConversation.first()).get(0);
 854             assertEquals(listAddress, prEmail.sender());
 855             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
 856             assertEquals(prEmail.recipients(), List.of(listAddress));
 857             assertEquals(&quot;[Integrated] RFR: My PR&quot;, prEmail.subject());
 858             assertFalse(prEmail.subject().contains(&quot;master&quot;));
 859             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 860             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
 861             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
 862             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
 863 
 864             // Now push the change to another monitored branch
 865             localRepo.push(editHash, repo.url(), &quot;other&quot;, true);
 866             TestBotRunner.runPeriodicItems(notifyBot);
 867             listServer.processIncoming();
 868 
 869             // The change should now end up as a separate notification thread
 870             conversations = mailmanList.conversations(Duration.ofDays(1));
 871             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 872             assertEquals(2, conversations.size());
 873 
 874             var pushConversation = conversations.get(1);
 875             var pushEmail = pushConversation.first();
 876             assertEquals(listAddress, pushEmail.sender());
 877             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 878             assertEquals(pushEmail.recipients(), List.of(listAddress));
 879             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 880         }
 881     }
 882 
 883     @Test
 884     void testMailinglistTag(TestInfo testInfo) throws IOException {
 885         try (var credentials = new HostCredentials(testInfo);
 886              var tempFolder = new TemporaryDirectory();
 887              var listServer = new TestMailmanServer()) {
 888             var repo = credentials.getHostedRepository();
 889             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 890             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 891             credentials.commitLock(localRepo);
 892             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 893             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 894             localRepo.pushAll(repo.url());
 895 
 896             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 897             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 898             var mailmanList = mailmanServer.getList(listAddress.address());
 899             var tagStorage = createTagStorage(repo);
 900             var branchStorage = createBranchStorage(repo);
 901             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 902             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 903 
 904             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 905             var updater = MailingListUpdater.newBuilder()
 906                                             .list(mailmanList)
 907                                             .recipient(listAddress)
 908                                             .sender(sender)
 909                                             .reportNewBranches(false)
 910                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 911                                             .build();
 912             var prOnlyUpdater = MailingListUpdater.newBuilder()
 913                                                   .list(mailmanList)
 914                                                   .recipient(listAddress)
 915                                                   .sender(sender)
 916                                                   .reportNewTags(false)
 917                                                   .reportNewBranches(false)
 918                                                   .reportNewBuilds(false)
 919                                                   .mode(MailingListUpdater.Mode.PR_ONLY)
 920                                                   .build();
 921             var notifyBot = NotifyBot.newBuilder()
 922                                      .repository(repo)
 923                                      .storagePath(storageFolder)
 924                                      .branches(Pattern.compile(&quot;master&quot;))
 925                                      .tagStorageBuilder(tagStorage)
 926                                      .branchStorageBuilder(branchStorage)
 927                                      .prIssuesStorageBuilder(prIssuesStorage)
 928                                      .updaters(List.of(updater, prOnlyUpdater))
 929                                      .build();
 930 
 931             // No mail should be sent on the first run as there is no history
 932             TestBotRunner.runPeriodicItems(notifyBot);
 933             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 934 
 935             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 936             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 937             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 938             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 939             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 940             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 941             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 942             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 943             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 944             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 945             localRepo.pushAll(repo.url());
 946 
 947             TestBotRunner.runPeriodicItems(notifyBot);
 948             listServer.processIncoming();
 949             listServer.processIncoming();
 950             listServer.processIncoming();
 951             listServer.processIncoming();
 952 
 953             var conversations = mailmanList.conversations(Duration.ofDays(1));
 954             assertEquals(4, conversations.size());
 955 
 956             for (var conversation : conversations) {
 957                 var email = conversation.first();
 958                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 959                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 960                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 961                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 962                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 963                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 964                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 965                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 966                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 967                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 968                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 969                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 970                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 971                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 972                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 973                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 974                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 975                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 976                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 977                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 978                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 979                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 980                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 981                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 982                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 983                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 984                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 985                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 986                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 987                     assertTrue(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 988                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 989                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 990                 } else {
 991                     fail(&quot;Mismatched subject: &quot; + email.subject());
 992                 }
 993                 assertTrue(email.hasHeader(&quot;extra1&quot;));
 994                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 995                 assertTrue(email.hasHeader(&quot;extra2&quot;));
 996                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 997             }
 998         }
 999     }
1000 
1001     @Test
1002     void testMailinglistPlainTags(TestInfo testInfo) throws IOException {
1003         try (var credentials = new HostCredentials(testInfo);
1004              var tempFolder = new TemporaryDirectory();
1005              var listServer = new TestMailmanServer()) {
1006             var repo = credentials.getHostedRepository();
1007             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1008             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
1009             credentials.commitLock(localRepo);
1010             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1011             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
1012             localRepo.pushAll(repo.url());
1013 
1014             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1015             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1016             var mailmanList = mailmanServer.getList(listAddress.address());
1017             var tagStorage = createTagStorage(repo);
1018             var branchStorage = createBranchStorage(repo);
1019             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1020             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1021 
1022             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1023             var updater = MailingListUpdater.newBuilder()
1024                                             .list(mailmanList)
1025                                             .recipient(listAddress)
1026                                             .sender(sender)
1027                                             .reportNewBranches(false)
1028                                             .reportNewBuilds(false)
1029                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1030                                             .build();
1031             var prOnlyUpdater = MailingListUpdater.newBuilder()
1032                                                   .list(mailmanList)
1033                                                   .recipient(listAddress)
1034                                                   .sender(sender)
1035                                                   .reportNewTags(false)
1036                                                   .reportNewBranches(false)
1037                                                   .reportNewBuilds(false)
1038                                                   .mode(MailingListUpdater.Mode.PR_ONLY)
1039                                                   .build();
1040             var notifyBot = NotifyBot.newBuilder()
1041                                      .repository(repo)
1042                                      .storagePath(storageFolder)
1043                                      .branches(Pattern.compile(&quot;master&quot;))
1044                                      .tagStorageBuilder(tagStorage)
1045                                      .branchStorageBuilder(branchStorage)
1046                                      .prIssuesStorageBuilder(prIssuesStorage)
1047                                      .updaters(List.of(updater, prOnlyUpdater))
1048                                      .build();
1049 
1050             // No mail should be sent on the first run as there is no history
1051             TestBotRunner.runPeriodicItems(notifyBot);
1052             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1053 
1054             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1055             localRepo.fetch(repo.url(), &quot;history:history&quot;);
1056             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
1057             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
1058             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
1059             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
1060             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
1061             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
1062             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
1063             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
1064             localRepo.pushAll(repo.url());
1065 
1066             TestBotRunner.runPeriodicItems(notifyBot);
1067             listServer.processIncoming();
1068             listServer.processIncoming();
1069             listServer.processIncoming();
1070             listServer.processIncoming();
1071 
1072             var conversations = mailmanList.conversations(Duration.ofDays(1));
1073             assertEquals(4, conversations.size());
1074 
1075             for (var conversation : conversations) {
1076                 var email = conversation.first();
1077                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
1078                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
1079                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
1080                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
1081                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
1082                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
1083                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
1084                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
1085                 } else {
1086                     fail(&quot;Mismatched subject: &quot; + email.subject());
1087                 }
1088                 assertTrue(email.hasHeader(&quot;extra1&quot;));
1089                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
1090                 assertTrue(email.hasHeader(&quot;extra2&quot;));
1091                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1092             }
1093         }
1094     }
1095 
1096     @Test
1097     void testMailingListBranch(TestInfo testInfo) throws IOException {
1098         try (var listServer = new TestMailmanServer();
1099              var credentials = new HostCredentials(testInfo);
1100              var tempFolder = new TemporaryDirectory()) {
1101             var repo = credentials.getHostedRepository();
1102             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1103             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1104             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1105             credentials.commitLock(localRepo);
1106             localRepo.pushAll(repo.url());
1107 
1108             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1109             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1110             var mailmanList = mailmanServer.getList(listAddress.address());
1111             var tagStorage = createTagStorage(repo);
1112             var branchStorage = createBranchStorage(repo);
1113             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1114             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1115 
1116             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1117             var updater = MailingListUpdater.newBuilder()
1118                                             .list(mailmanList)
1119                                             .recipient(listAddress)
1120                                             .sender(sender)
1121                                             .reportNewTags(false)
1122                                             .reportNewBuilds(false)
1123                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1124                                             .build();
1125             var notifyBot = NotifyBot.newBuilder()
1126                                      .repository(repo)
1127                                      .storagePath(storageFolder)
1128                                      .branches(Pattern.compile(&quot;master|newbranch.&quot;))
1129                                      .tagStorageBuilder(tagStorage)
1130                                      .branchStorageBuilder(branchStorage)
1131                                      .prIssuesStorageBuilder(prIssuesStorage)
1132                                      .updaters(List.of(updater))
1133                                      .build();
1134 
1135             // No mail should be sent on the first run as there is no history
1136             TestBotRunner.runPeriodicItems(notifyBot);
1137             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1138 
1139             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
1140             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1141             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
1142             TestBotRunner.runPeriodicItems(notifyBot);
1143             listServer.processIncoming();
1144 
1145             var conversations = mailmanList.conversations(Duration.ofDays(1));
1146             var email = conversations.get(0).first();
1147             assertEquals(listAddress, email.sender());
1148             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
1149             assertEquals(email.recipients(), List.of(listAddress));
1150             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());
1151             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));
1152             assertTrue(email.hasHeader(&quot;extra1&quot;));
1153             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
1154             assertTrue(email.hasHeader(&quot;extra2&quot;));
1155             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1156 
1157             TestBotRunner.runPeriodicItems(notifyBot);
1158             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1159 
1160             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);
1161             TestBotRunner.runPeriodicItems(notifyBot);
1162             listServer.processIncoming();
1163 
1164             var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()
1165                                              .filter(c -&gt; !c.equals(conversations.get(0)))
1166                                              .findFirst().orElseThrow();
1167             email = newConversation.first();
1168             assertEquals(listAddress, email.sender());
1169             assertEquals(sender, email.author());
1170             assertEquals(email.recipients(), List.of(listAddress));
1171             assertEquals(&quot;git: test: created branch newbranch2 based on the branch newbranch1 containing 0 unique commits&quot;, email.subject());
1172             assertEquals(&quot;The new branch newbranch2 is currently identical to the newbranch1 branch.&quot;, email.body());
1173         }
1174     }
1175 
1176     @Test
1177     void testMailingListBranchPrefix(TestInfo testInfo) throws IOException {
1178         try (var listServer = new TestMailmanServer();
1179              var credentials = new HostCredentials(testInfo);
1180              var tempFolder = new TemporaryDirectory()) {
1181             var repo = credentials.getHostedRepository();
1182             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1183             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1184             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1185             credentials.commitLock(localRepo);
1186             localRepo.pushAll(repo.url());
1187 
1188             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1189             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1190             var mailmanList = mailmanServer.getList(listAddress.address());
1191             var tagStorage = createTagStorage(repo);
1192             var branchStorage = createBranchStorage(repo);
1193             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1194             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1195 
1196             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1197             var updater = MailingListUpdater.newBuilder()
1198                                             .list(mailmanList)
1199                                             .recipient(listAddress)
1200                                             .sender(sender)
1201                                             .reportNewTags(false)
1202                                             .reportNewBranches(false)
1203                                             .reportNewBuilds(false)
1204                                             .mode(MailingListUpdater.Mode.PR)
1205                                             .repoInSubject(true)
1206                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
1207                                             .build();
1208             var notifyBot = NotifyBot.newBuilder()
1209                                      .repository(repo)
1210                                      .storagePath(storageFolder)
1211                                      .branches(Pattern.compile(&quot;master&quot;))
1212                                      .tagStorageBuilder(tagStorage)
1213                                      .branchStorageBuilder(branchStorage)
1214                                      .prIssuesStorageBuilder(prIssuesStorage)
1215                                      .updaters(List.of(updater))
1216                                      .build();
1217 
1218             // No mail should be sent on the first run as there is no history
1219             TestBotRunner.runPeriodicItems(notifyBot);
1220             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1221 
1222             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1223             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
1224             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
1225 
1226             // PR hasn&#39;t been integrated yet, so there should be no mail
1227             TestBotRunner.runPeriodicItems(notifyBot);
1228             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1229 
1230             // Simulate an RFR email
1231             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
1232                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
1233                            .recipient(listAddress)
1234                            .build();
1235             mailmanList.post(rfr);
1236             listServer.processIncoming();
1237 
1238             // And an integration
1239             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
1240             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1241 
1242             TestBotRunner.runPeriodicItems(notifyBot);
1243             listServer.processIncoming();
1244 
1245             var conversations = mailmanList.conversations(Duration.ofDays(1));
1246             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
1247             assertEquals(1, conversations.size());
1248 
1249             var prConversation = conversations.get(0);
1250 
1251             var prEmail = prConversation.replies(prConversation.first()).get(0);
1252             assertEquals(listAddress, prEmail.sender());
1253             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
1254             assertEquals(prEmail.recipients(), List.of(listAddress));
1255             assertEquals(&quot;[&quot; + repo.name() + &quot;:master] [Integrated] RFR: My PR&quot;, prEmail.subject());
1256             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
1257             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
1258             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
1259             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
1260         }
1261     }
1262 
1263     @Test
1264     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
1265         try (var listServer = new TestMailmanServer();
1266              var credentials = new HostCredentials(testInfo);
1267              var tempFolder = new TemporaryDirectory()) {
1268             var repo = credentials.getHostedRepository();
1269             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1270             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1271             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1272             credentials.commitLock(localRepo);
1273             localRepo.pushAll(repo.url());
1274 
1275             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1276             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1277             var mailmanList = mailmanServer.getList(listAddress.address());
1278             var tagStorage = createTagStorage(repo);
1279             var branchStorage = createBranchStorage(repo);
1280             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1281             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1282 
1283             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1284             var updater = MailingListUpdater.newBuilder()
1285                                             .list(mailmanList)
1286                                             .recipient(listAddress)
1287                                             .sender(sender)
1288                                             .reportNewTags(false)
1289                                             .reportNewBranches(false)
1290                                             .reportNewBuilds(false)
1291                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1292                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
1293                                             .build();
1294             var notifyBot = NotifyBot.newBuilder()
1295                                      .repository(repo)
1296                                      .storagePath(storageFolder)
1297                                      .branches(Pattern.compile(&quot;master&quot;))
1298                                      .tagStorageBuilder(tagStorage)
1299                                      .branchStorageBuilder(branchStorage)
1300                                      .prIssuesStorageBuilder(prIssuesStorage)
1301                                      .updaters(List.of(updater))
1302                                      .build();
1303 
1304             // No mail should be sent on the first run as there is no history
1305             TestBotRunner.runPeriodicItems(notifyBot);
1306             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1307 
1308             // Save history state
1309             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);
1310 
1311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1312             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1313             TestBotRunner.runPeriodicItems(notifyBot);
1314             listServer.processIncoming();
1315 
1316             var conversations = mailmanList.conversations(Duration.ofDays(1));
1317             assertEquals(1, conversations.size());
1318 
1319             // Reset the history
1320             localRepo.push(historyHash, repo.url(), &quot;history&quot;, true);
1321             TestBotRunner.runPeriodicItems(notifyBot);
1322             listServer.processIncoming();
1323 
1324             // There should now be a duplicate mail
1325             conversations = mailmanList.conversations(Duration.ofDays(1));
1326             assertEquals(2, conversations.size());
1327         }
1328     }
1329 
1330     @Test
1331     void testIssue(TestInfo testInfo) throws IOException {
1332         try (var credentials = new HostCredentials(testInfo);
1333              var tempFolder = new TemporaryDirectory()) {
1334             var repo = credentials.getHostedRepository();
1335             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1336             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1337             credentials.commitLock(localRepo);
1338             localRepo.pushAll(repo.url());
1339 
1340             var tagStorage = createTagStorage(repo);
1341             var branchStorage = createBranchStorage(repo);
1342             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1343             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1344 
1345             var issueProject = credentials.getIssueProject();
1346             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1347             var updater = IssueUpdater.newBuilder()
1348                                       .issueProject(issueProject)
1349                                       .reviewLink(false)
1350                                       .commitIcon(commitIcon)
1351                                       .setFixVersion(true)
1352                                       .build();
1353             var notifyBot = NotifyBot.newBuilder()
1354                                      .repository(repo)
1355                                      .storagePath(storageFolder)
1356                                      .branches(Pattern.compile(&quot;master&quot;))
1357                                      .tagStorageBuilder(tagStorage)
1358                                      .branchStorageBuilder(branchStorage)
1359                                      .prIssuesStorageBuilder(prIssuesStorage)
1360                                      .updaters(List.of(updater))
1361                                      .build();
1362 
1363             // Initialize history
1364             TestBotRunner.runPeriodicItems(notifyBot);
1365 
1366             // Create an issue and commit a fix
1367             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1368             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1369             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1370             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1371             TestBotRunner.runPeriodicItems(notifyBot);
1372 
1373             // The changeset should be reflected in a comment
1374             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1375 
1376             var comments = updatedIssue.comments();
1377             assertEquals(1, comments.size());
1378             var comment = comments.get(0);
1379             assertTrue(comment.body().contains(editHash.abbreviate()));
1380 
1381             // And in a link
1382             var links = updatedIssue.links();
1383             assertEquals(1, links.size());
1384             var link = links.get(0);
1385             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1386             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1387             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1388 
1389             // As well as a fixVersion
1390             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1391 
1392             // The issue should be assigned and resolved
1393             assertEquals(RESOLVED, updatedIssue.state());
1394             assertEquals(List.of(issueProject.issueTracker().currentUser()), updatedIssue.assignees());
1395         }
1396     }
1397 
1398     @Test
1399     void testIssueNoVersion(TestInfo testInfo) throws IOException {
1400         try (var credentials = new HostCredentials(testInfo);
1401              var tempFolder = new TemporaryDirectory()) {
1402             var repo = credentials.getHostedRepository();
1403             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1404             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1405             credentials.commitLock(localRepo);
1406             localRepo.pushAll(repo.url());
1407 
1408             var tagStorage = createTagStorage(repo);
1409             var branchStorage = createBranchStorage(repo);
1410             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1411             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1412 
1413             var issueProject = credentials.getIssueProject();
1414             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1415             var updater = IssueUpdater.newBuilder()
1416                                       .issueProject(issueProject)
1417                                       .reviewLink(false)
1418                                       .commitIcon(commitIcon)
1419                                       .setFixVersion(true)
1420                                       .build();
1421             var notifyBot = NotifyBot.newBuilder()
1422                                      .repository(repo)
1423                                      .storagePath(storageFolder)
1424                                      .branches(Pattern.compile(&quot;master&quot;))
1425                                      .tagStorageBuilder(tagStorage)
1426                                      .branchStorageBuilder(branchStorage)
1427                                      .prIssuesStorageBuilder(prIssuesStorage)
1428                                      .updaters(List.of(updater))
1429                                      .build();
1430 
1431             // Initialize history
1432             TestBotRunner.runPeriodicItems(notifyBot);
1433 
1434             // Create an issue and commit a fix
1435             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1436             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1437             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1438             TestBotRunner.runPeriodicItems(notifyBot);
1439 
1440             // The changeset should be reflected in a comment
1441             var comments = issue.comments();
1442             assertEquals(1, comments.size());
1443             var comment = comments.get(0);
1444             assertTrue(comment.body().contains(editHash.abbreviate()));
1445 
1446             // But not in the fixVersion
1447             assertEquals(Set.of(), fixVersions(issue));
1448         }
1449     }
1450 
1451     @Test
1452     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
1453         try (var credentials = new HostCredentials(testInfo);
1454              var tempFolder = new TemporaryDirectory()) {
1455             var repo = credentials.getHostedRepository();
1456             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1457             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1458             credentials.commitLock(localRepo);
1459             localRepo.pushAll(repo.url());
1460 
1461             var tagStorage = createTagStorage(repo);
1462             var branchStorage = createBranchStorage(repo);
1463             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1464             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1465 
1466             var issueProject = credentials.getIssueProject();
1467             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1468             var updater = IssueUpdater.newBuilder()
1469                                       .issueProject(issueProject)
1470                                       .reviewLink(false)
1471                                       .commitLink(false)
1472                                       .commitIcon(commitIcon)
1473                                       .setFixVersion(true)
1474                                       .fixVersions(Map.of(&quot;master&quot;, &quot;2.0&quot;))
1475                                       .build();
1476             var notifyBot = NotifyBot.newBuilder()
1477                                      .repository(repo)
1478                                      .storagePath(storageFolder)
1479                                      .branches(Pattern.compile(&quot;master&quot;))
1480                                      .tagStorageBuilder(tagStorage)
1481                                      .branchStorageBuilder(branchStorage)
1482                                      .prIssuesStorageBuilder(prIssuesStorage)
1483                                      .updaters(List.of(updater))
1484                                      .build();
1485 
1486             // Initialize history
1487             TestBotRunner.runPeriodicItems(notifyBot);
1488 
1489             // Create an issue and commit a fix
1490             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1491             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1492             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1493             TestBotRunner.runPeriodicItems(notifyBot);
1494 
1495             // The changeset should not reflected in a comment
1496             var comments = issue.comments();
1497             assertEquals(1, comments.size());
1498             var comment = comments.get(0);
1499             assertTrue(comment.body().contains(editHash.abbreviate()));
1500 
1501             // As well as a fixVersion - but not the one from the repo
1502             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
1503 
1504             // And no commit link
1505             var links = issue.links();
1506             assertEquals(0, links.size());
1507         }
1508     }
1509 
1510     @Test
1511     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1512         try (var credentials = new HostCredentials(testInfo);
1513              var tempFolder = new TemporaryDirectory()) {
1514             var repo = credentials.getHostedRepository();
1515             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1516             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1517             credentials.commitLock(localRepo);
1518             localRepo.pushAll(repo.url());
1519 
1520             var tagStorage = createTagStorage(repo);
1521             var branchStorage = createBranchStorage(repo);
1522             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1523             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1524 
1525             var issueProject = credentials.getIssueProject();
1526             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1527             var updater = IssueUpdater.newBuilder()
1528                                       .issueProject(issueProject)
1529                                       .reviewLink(false)
1530                                       .commitIcon(commitIcon)
1531                                       .setFixVersion(true)
1532                                       .build();
1533             var notifyBot = NotifyBot.newBuilder()
1534                                      .repository(repo)
1535                                      .storagePath(storageFolder)
1536                                      .branches(Pattern.compile(&quot;master&quot;))
1537                                      .tagStorageBuilder(tagStorage)
1538                                      .branchStorageBuilder(branchStorage)
1539                                      .prIssuesStorageBuilder(prIssuesStorage)
1540                                      .updaters(List.of(updater))
1541                                      .build();
1542 
1543             // Initialize history
1544             TestBotRunner.runPeriodicItems(notifyBot);
1545 
1546             // Save the state
1547             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1548 
1549             // Create an issue and commit a fix
1550             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1551             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1552             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1553             TestBotRunner.runPeriodicItems(notifyBot);
1554 
1555             // The changeset should be reflected in a comment
1556             var comments = issue.comments();
1557             assertEquals(1, comments.size());
1558             var comment = comments.get(0);
1559             assertTrue(comment.body().contains(editHash.abbreviate()));
1560 
1561             // And in a link
1562             var links = issue.links();
1563             assertEquals(1, links.size());
1564             var link = links.get(0);
1565             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1566             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1567             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1568 
1569             // As well as a fixVersion
1570             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));
1571 
1572             // Wipe the history
1573             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
1574 
1575             // Run it again
1576             TestBotRunner.runPeriodicItems(notifyBot);
1577 
1578             // There should be no new comments, links or fixVersions
1579             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1580             assertEquals(1, updatedIssue.comments().size());
1581             assertEquals(1, updatedIssue.links().size());
1582             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1583         }
1584     }
1585 
1586     @Test
1587     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1588         try (var credentials = new HostCredentials(testInfo);
1589              var tempFolder = new TemporaryDirectory()) {
1590             var repo = credentials.getHostedRepository();
1591             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1592             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1593             credentials.commitLock(localRepo);
1594             localRepo.pushAll(repo.url());
1595 
1596             var tagStorage = createTagStorage(repo);
1597             var branchStorage = createBranchStorage(repo);
1598             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1599             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1600 
1601             var issueProject = credentials.getIssueProject();
1602             var updater = IssueUpdater.newBuilder()
1603                                       .issueProject(issueProject)
1604                                       .reviewLink(false)
1605                                       .commitLink(false)
1606                                       .setFixVersion(true)
1607                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))
1608                                       .build();
1609             var notifyBot = NotifyBot.newBuilder()
1610                                      .repository(repo)
1611                                      .storagePath(storageFolder)
1612                                      .branches(Pattern.compile(&quot;master&quot;))
1613                                      .tagStorageBuilder(tagStorage)
1614                                      .branchStorageBuilder(branchStorage)
1615                                      .prIssuesStorageBuilder(prIssuesStorage)
1616                                      .updaters(List.of(updater))
1617                                      .build();
1618 
1619             // Initialize history
1620             TestBotRunner.runPeriodicItems(notifyBot);
1621 
1622             // Create an issue and commit a fix
1623             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1624             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1625 
1626             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1627             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1628             TestBotRunner.runPeriodicItems(notifyBot);
1629 
1630             // The fixVersion should have been updated
1631             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1632         }
1633     }
1634 
1635     @Test
1636     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1637         try (var credentials = new HostCredentials(testInfo);
1638              var tempFolder = new TemporaryDirectory()) {
1639             var repo = credentials.getHostedRepository();
1640             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1641             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1642             credentials.commitLock(localRepo);
1643             localRepo.pushAll(repo.url());
1644 
1645             var tagStorage = createTagStorage(repo);
1646             var branchStorage = createBranchStorage(repo);
1647             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1648             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1649 
1650             var issueProject = credentials.getIssueProject();
1651             var updater = IssueUpdater.newBuilder()
1652                                       .issueProject(issueProject)
1653                                       .reviewLink(false)
1654                                       .commitLink(false)
1655                                       .setFixVersion(true)
1656                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))
1657                                       .build();
1658             var notifyBot = NotifyBot.newBuilder()
1659                                      .repository(repo)
1660                                      .storagePath(storageFolder)
1661                                      .branches(Pattern.compile(&quot;master&quot;))
1662                                      .tagStorageBuilder(tagStorage)
1663                                      .branchStorageBuilder(branchStorage)
1664                                      .prIssuesStorageBuilder(prIssuesStorage)
1665                                      .updaters(List.of(updater))
1666                                      .build();
1667 
1668             // Initialize history
1669             TestBotRunner.runPeriodicItems(notifyBot);
1670 
1671             // Create an issue and commit a fix
1672             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1673             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1674 
1675             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1676             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1677             TestBotRunner.runPeriodicItems(notifyBot);
1678 
1679             // The fixVersion should have been updated
1680             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1681         }
1682     }
1683 
1684     @Test
1685     void testIssueBackport(TestInfo testInfo) throws IOException {
1686         try (var credentials = new HostCredentials(testInfo);
1687              var tempFolder = new TemporaryDirectory()) {
1688             var repo = credentials.getHostedRepository();
1689             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1690             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1691             credentials.commitLock(localRepo);
1692             localRepo.pushAll(repo.url());
1693 
1694             var tagStorage = createTagStorage(repo);
1695             var branchStorage = createBranchStorage(repo);
1696             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1697             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1698 
1699             var issueProject = credentials.getIssueProject();
1700             var updater = IssueUpdater.newBuilder()
1701                                       .issueProject(issueProject)
1702                                       .reviewLink(false)
1703                                       .commitLink(false)
1704                                       .setFixVersion(true)
1705                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12.0.2&quot;))
1706                                       .build();
1707             var notifyBot = NotifyBot.newBuilder()
1708                                      .repository(repo)
1709                                      .storagePath(storageFolder)
1710                                      .branches(Pattern.compile(&quot;master&quot;))
1711                                      .tagStorageBuilder(tagStorage)
1712                                      .branchStorageBuilder(branchStorage)
1713                                      .prIssuesStorageBuilder(prIssuesStorage)
1714                                      .updaters(List.of(updater))
1715                                      .build();
1716 
1717             // Initialize history
1718             TestBotRunner.runPeriodicItems(notifyBot);
1719 
1720             // Create an issue and commit a fix
1721             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),
1722                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),
1723                                                         &quot;customfield_10008&quot;, JSON.object()
1724                                                                                  .put(&quot;id&quot;, 244)
1725                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),
1726                                                         &quot;customfield_10005&quot;, JSON.array()
1727                                                                                  .add(JSON.object()
1728                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)
1729                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))
1730                                                                                  .add(JSON.object()
1731                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)
1732                                                                                           .put(&quot;value&quot;, &quot;other&quot;))
1733                                                  ));
1734             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
1735             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
1736 
1737             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1738             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1739             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1740             TestBotRunner.runPeriodicItems(notifyBot);
1741 
1742             // The fixVersion should not have been updated
1743             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1744             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));
1745             assertEquals(OPEN, updatedIssue.state());
1746             assertEquals(List.of(), updatedIssue.assignees());
1747 
1748             // There should be a link
1749             var links = updatedIssue.links();
1750             assertEquals(1, links.size());
1751             var link = links.get(0);
1752             var backport = link.issue().orElseThrow();
1753 
1754             // The backport issue should have a correct fixVersion and assignee
1755             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));
1756             assertEquals(RESOLVED, backport.state());
1757             assertEquals(List.of(issueProject.issueTracker().currentUser()), backport.assignees());
1758 
1759             // Custom properties should also propagate
1760             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());
1761             assertEquals(244, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;id&quot;).asInt());
1762             assertEquals(&quot;java.io&quot;, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;name&quot;).asString());
1763             assertEquals(2, backport.properties().get(&quot;customfield_10005&quot;).asArray().size());
1764         }
1765     }
1766 
1767     @Test
1768     void testPullRequest(TestInfo testInfo) throws IOException {
1769         try (var credentials = new HostCredentials(testInfo);
1770              var tempFolder = new TemporaryDirectory()) {
1771             var repo = credentials.getHostedRepository();
1772             var reviewer = credentials.getHostedRepository();
1773             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1774             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1775             credentials.commitLock(localRepo);
1776             localRepo.pushAll(repo.url());
1777 
1778             var tagStorage = createTagStorage(repo);
1779             var branchStorage = createBranchStorage(repo);
1780             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1781             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1782 
1783             var issueProject = credentials.getIssueProject();
1784             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1785             var updater = IssueUpdater.newBuilder()
1786                                       .issueProject(issueProject)
1787                                       .reviewIcon(reviewIcon)
1788                                       .commitLink(false)
1789                                       .build();
1790             var notifyBot = NotifyBot.newBuilder()
1791                                      .repository(repo)
1792                                      .storagePath(storageFolder)
1793                                      .branches(Pattern.compile(&quot;master&quot;))
1794                                      .tagStorageBuilder(tagStorage)
1795                                      .branchStorageBuilder(branchStorage)
1796                                      .prIssuesStorageBuilder(prIssuesStorage)
1797                                      .prUpdaters(List.of(updater))
1798                                      .readyLabels(Set.of(&quot;rfr&quot;))
1799                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
1800                                      .build();
1801 
1802             // Initialize history
1803             TestBotRunner.runPeriodicItems(notifyBot);
1804 
1805             // Create an issue and a pull request to fix it
1806             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1807             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1808             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1809             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1810             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1811             TestBotRunner.runPeriodicItems(notifyBot);
1812 
1813             // The issue should not yet contain a link to the PR
1814             var links = issue.links();
1815             assertEquals(0, links.size());
1816 
1817             // Just a label isn&#39;t enough
1818             pr.addLabel(&quot;rfr&quot;);
1819             TestBotRunner.runPeriodicItems(notifyBot);
1820             links = issue.links();
1821             assertEquals(0, links.size());
1822 
1823             // Neither is just a comment
1824             pr.removeLabel(&quot;rfr&quot;);
1825             var reviewPr = reviewer.pullRequest(pr.id());
1826             reviewPr.addComment(&quot;This is now ready&quot;);
1827             TestBotRunner.runPeriodicItems(notifyBot);
1828             links = issue.links();
1829             assertEquals(0, links.size());
1830 
1831             // Both are needed
1832             pr.addLabel(&quot;rfr&quot;);
1833             TestBotRunner.runPeriodicItems(notifyBot);
1834 
1835             // The issue should now contain a link to the PR
1836             links = issue.links();
1837             assertEquals(1, links.size());
1838             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1839             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1840 
1841             // Add another issue
1842             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1843             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n * [&quot; + issue2.id() +
1844                                &quot;](http://www.test2.test/): The second issue&quot;);
1845             TestBotRunner.runPeriodicItems(notifyBot);
1846 
1847             // Both issues should contain a link to the PR
1848             var links1 = issue.links();
1849             assertEquals(1, links1.size());
1850             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());
1851             var links2 = issue2.links();
1852             assertEquals(1, links2.size());
1853             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1854 
1855             // Drop the first one
1856             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
1857             TestBotRunner.runPeriodicItems(notifyBot);
1858 
1859             // Only the second issue should now contain a link to the PR
1860             links1 = issue.links();
1861             assertEquals(0, links1.size());
1862             links2 = issue2.links();
1863             assertEquals(1, links2.size());
1864             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1865         }
1866     }
1867 
1868     @Test
1869     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
1870         try (var credentials = new HostCredentials(testInfo);
1871              var tempFolder = new TemporaryDirectory()) {
1872             var repo = credentials.getHostedRepository();
1873             var reviewer = credentials.getHostedRepository();
1874             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1875             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1876             credentials.commitLock(localRepo);
1877             localRepo.pushAll(repo.url());
1878 
1879             var tagStorage = createTagStorage(repo);
1880             var branchStorage = createBranchStorage(repo);
1881             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1882             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1883 
1884             var issueProject = credentials.getIssueProject();
1885             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1886             var updater = IssueUpdater.newBuilder()
1887                                       .issueProject(issueProject)
1888                                       .reviewLink(false)
1889                                       .reviewIcon(reviewIcon)
1890                                       .commitLink(false)
1891                                       .build();
1892             var notifyBot = NotifyBot.newBuilder()
1893                                      .repository(repo)
1894                                      .storagePath(storageFolder)
1895                                      .branches(Pattern.compile(&quot;master&quot;))
1896                                      .tagStorageBuilder(tagStorage)
1897                                      .branchStorageBuilder(branchStorage)
1898                                      .prIssuesStorageBuilder(prIssuesStorage)
1899                                      .prUpdaters(List.of(updater)).readyLabels(Set.of(&quot;rfr&quot;))
1900                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
1901                                      .build();
1902             // Initialize history
1903             TestBotRunner.runPeriodicItems(notifyBot);
1904 
1905             // Create an issue and a pull request to fix it
1906             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1907             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1908             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1909             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1910             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1911             TestBotRunner.runPeriodicItems(notifyBot);
1912 
1913             // Add required label
1914             pr.addLabel(&quot;rfr&quot;);
1915             TestBotRunner.runPeriodicItems(notifyBot);
1916 
1917             // And the required comment
1918             var reviewPr = reviewer.pullRequest(pr.id());
1919             reviewPr.addComment(&quot;This is now ready&quot;);
1920             TestBotRunner.runPeriodicItems(notifyBot);
1921 
1922             // The issue should still not contain a link to the PR
1923             var links = issue.links();
1924             assertEquals(0, links.size());
1925         }
1926     }
1927 
1928     @Test
1929     void testPullRequestPROnly(TestInfo testInfo) throws IOException {
1930         try (var credentials = new HostCredentials(testInfo);
1931              var tempFolder = new TemporaryDirectory()) {
1932             var repo = credentials.getHostedRepository();
1933             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1934             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1935             credentials.commitLock(localRepo);
1936             localRepo.pushAll(repo.url());
1937 
1938             var tagStorage = createTagStorage(repo);
1939             var branchStorage = createBranchStorage(repo);
1940             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1941             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1942 
1943             var issueProject = credentials.getIssueProject();
1944             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1945             var updater = IssueUpdater.newBuilder()
1946                                       .issueProject(issueProject)
1947                                       .reviewIcon(reviewIcon)
1948                                       .commitLink(false)
1949                                       .prOnly(true)
1950                                       .build();
1951             var notifyBot = NotifyBot.newBuilder()
1952                                      .repository(repo)
1953                                      .storagePath(storageFolder)
1954                                      .branches(Pattern.compile(&quot;.*&quot;))
1955                                      .tagStorageBuilder(tagStorage)
1956                                      .branchStorageBuilder(branchStorage)
1957                                      .prIssuesStorageBuilder(prIssuesStorage)
1958                                      .updaters(List.of(updater))
1959                                      .prUpdaters(List.of(updater))
1960                                      .build();
1961 
1962             // Initialize history
1963             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
1964             TestBotRunner.runPeriodicItems(notifyBot);
1965 
1966             // Create an issue and a pull request to fix it
1967             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1968             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1969             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1970             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
1971             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1972             TestBotRunner.runPeriodicItems(notifyBot);
1973 
1974             // The issue should now contain a link to the PR
1975             var links = issue.links();
1976             assertEquals(1, links.size());
1977             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1978             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1979 
1980             // Simulate integration
1981             localRepo.push(editHash, repo.url(), &quot;other&quot;);
1982             TestBotRunner.runPeriodicItems(notifyBot);
1983 
1984             // The changeset should be reflected in a comment
1985             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1986 
1987             var comments = updatedIssue.comments();
1988             assertEquals(1, comments.size());
1989             var comment = comments.get(0);
1990             assertTrue(comment.body().contains(editHash.abbreviate()));
1991 
1992             // Now simulate a merge to another branch
1993             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1994             TestBotRunner.runPeriodicItems(notifyBot);
1995 
1996             // No additional comment should have been made
1997             updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1998             comments = updatedIssue.comments();
1999             assertEquals(1, comments.size());
2000         }
2001     }
2002 
2003     private static class TestRepositoryUpdateConsumer implements RepositoryUpdateConsumer {
2004         private final String name;
2005         private final boolean idempotent;
2006         private int updateCount = 0;
2007         private boolean shouldFail = false;
2008 
2009         TestRepositoryUpdateConsumer(String name, boolean idempotent) {
2010             this.name = name;
2011             this.idempotent = idempotent;
2012         }
2013 
2014         @Override
2015         public void handleCommits(HostedRepository repository, Repository localRepository, List&lt;Commit&gt; commits,
2016                                   Branch branch) throws NonRetriableException {
2017             updateCount++;
2018             if (shouldFail) {
2019                 if (idempotent) {
2020                     throw new RuntimeException(&quot;induced failure&quot;);
2021                 } else {
2022                     throw new NonRetriableException(new RuntimeException(&quot;unretriable failure&quot;));
2023                 }
2024             }
2025         }
2026 
2027         @Override
2028         public void handleOpenJDKTagCommits(HostedRepository repository, Repository localRepository,
2029          List&lt;Commit&gt; commits, OpenJDKTag tag, Tag.Annotated annotated) {
2030             throw new RuntimeException(&quot;unexpected&quot;);
2031         }
2032 
2033         @Override
2034         public void handleTagCommit(HostedRepository repository, Repository localRepository, Commit commit, Tag tag,
2035          Tag.Annotated annotation) {
2036             throw new RuntimeException(&quot;unexpected&quot;);
2037         }
2038 
2039         @Override
2040         public void handleNewBranch(HostedRepository repository, Repository localRepository, List&lt;Commit&gt; commits,
2041          Branch parent, Branch branch) {
2042             throw new RuntimeException(&quot;unexpected&quot;);
2043         }
2044 
2045         @Override
2046         public String name() {
2047             return name;
2048         }
2049     }
2050 
2051     @Test
2052     void testIdempotenceMix(TestInfo testInfo) throws IOException {
2053         try (var credentials = new HostCredentials(testInfo);
2054              var tempFolder = new TemporaryDirectory()) {
2055             var repo = credentials.getHostedRepository();
2056             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
2057             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
2058             credentials.commitLock(localRepo);
2059             localRepo.pushAll(repo.url());
2060 
2061             var tagStorage = createTagStorage(repo);
2062             var branchStorage = createBranchStorage(repo);
2063             var prIssuesStorage = createPullRequestIssuesStorage(repo);
2064             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
2065 
2066             var idempotent = new TestRepositoryUpdateConsumer(&quot;i&quot;, true);
2067             var nonIdempotent = new TestRepositoryUpdateConsumer(&quot;ni&quot;, false);
2068             var notifyBot = NotifyBot.newBuilder()
2069                                      .repository(repo)
2070                                      .storagePath(storageFolder)
2071                                      .branches(Pattern.compile(&quot;master&quot;))
2072                                      .tagStorageBuilder(tagStorage)
2073                                      .branchStorageBuilder(branchStorage)
2074                                      .prIssuesStorageBuilder(prIssuesStorage)
2075                                      .updaters(List.of(idempotent, nonIdempotent))
2076                                      .build();
2077 
2078             // Initialize history
2079             TestBotRunner.runPeriodicItems(notifyBot);
2080 
2081             // Create an issue and commit a fix
2082             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix stuff&quot;);
2083             localRepo.push(editHash, repo.url(), &quot;master&quot;);
2084             TestBotRunner.runPeriodicItems(notifyBot);
2085 
2086             // Both updaters should have run
2087             assertEquals(1, idempotent.updateCount);
2088             assertEquals(1, nonIdempotent.updateCount);
2089 
2090             var nextEditHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;Fix more stuff&quot;);
2091             localRepo.push(nextEditHash, repo.url(), &quot;master&quot;);
2092 
2093             idempotent.shouldFail = true;
2094             nonIdempotent.shouldFail = true;
2095             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(notifyBot));
2096 
2097             // Both updaters should have run again
2098             assertEquals(2, idempotent.updateCount);
2099             assertEquals(2, nonIdempotent.updateCount);
2100 
2101             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(notifyBot));
2102 
2103             // But now only the idempotent one should have been retried
2104             assertEquals(3, idempotent.updateCount);
2105             assertEquals(2, nonIdempotent.updateCount);
2106         }
2107     }
2108 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>