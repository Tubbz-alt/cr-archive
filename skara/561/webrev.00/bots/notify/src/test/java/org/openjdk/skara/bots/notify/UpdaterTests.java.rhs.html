<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.notify;
  24 
  25 import org.openjdk.skara.email.*;
  26 import org.openjdk.skara.forge.HostedRepository;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.json.*;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.storage.StorageBuilder;
  31 import org.openjdk.skara.test.*;
  32 import org.openjdk.skara.vcs.*;
  33 import org.openjdk.skara.vcs.Tag;
  34 import org.openjdk.skara.vcs.openjdk.OpenJDKTag;
  35 
  36 import org.junit.jupiter.api.*;
  37 
  38 import java.io.IOException;
  39 import java.net.URI;
  40 import java.nio.charset.StandardCharsets;
  41 import java.nio.file.*;
  42 import java.time.Duration;
  43 import java.util.*;
  44 import java.util.regex.Pattern;
  45 import java.util.stream.Collectors;
  46 
  47 import static org.junit.jupiter.api.Assertions.*;
  48 import static org.openjdk.skara.issuetracker.Issue.State.*;
  49 
  50 class UpdaterTests {
  51     private List&lt;Path&gt; findJsonFiles(Path folder, String partialName) throws IOException {
  52         return Files.walk(folder)
  53                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
  54                     .filter(path -&gt; path.toString().contains(partialName))
  55                     .collect(Collectors.toList());
  56     }
  57 
  58     private StorageBuilder&lt;UpdatedTag&gt; createTagStorage(HostedRepository repository) {
  59         return new StorageBuilder&lt;UpdatedTag&gt;(&quot;tags.txt&quot;)
  60                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);
  61     }
  62 
  63     private StorageBuilder&lt;UpdatedBranch&gt; createBranchStorage(HostedRepository repository) {
  64         return new StorageBuilder&lt;UpdatedBranch&gt;(&quot;branches.txt&quot;)
  65                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);
  66     }
  67 
  68     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {
  69         return new StorageBuilder&lt;PullRequestIssues&gt;(&quot;prissues.txt&quot;)
  70                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated prissues&quot;);
  71     }
  72 
  73     private Set&lt;String&gt; fixVersions(Issue issue) {
  74         if (!issue.properties().containsKey(&quot;fixVersions&quot;)) {
  75             return Set.of();
  76         }
  77         return issue.properties().get(&quot;fixVersions&quot;).stream()
  78                     .map(JSONValue::asString)
  79                     .collect(Collectors.toSet());
  80     }
  81 
  82     @Test
  83     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
  84         try (var credentials = new HostCredentials(testInfo);
  85              var tempFolder = new TemporaryDirectory()) {
  86             var repo = credentials.getHostedRepository();
  87             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
  88             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
  89             credentials.commitLock(localRepo);
  90             localRepo.pushAll(repo.url());
  91 
  92             var tagStorage = createTagStorage(repo);
  93             var branchStorage = createBranchStorage(repo);
  94             var prIssuesStorage = createPullRequestIssuesStorage(repo);
  95             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
  96             Files.createDirectory(jsonFolder);
  97             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  98 
  99             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
 100             var notifyBot = NotifyBot.newBuilder()
 101                                      .repository(repo)
 102                                      .storagePath(storageFolder)
 103                                      .branches(Pattern.compile(&quot;master&quot;))
 104                                      .tagStorageBuilder(tagStorage)
 105                                      .branchStorageBuilder(branchStorage)
 106                                      .prIssuesStorageBuilder(prIssuesStorage)
 107                                      .updaters(List.of(updater))
 108                                      .build();
 109 
 110             TestBotRunner.runPeriodicItems(notifyBot);
 111             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 112 
 113             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 114             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 115             TestBotRunner.runPeriodicItems(notifyBot);
 116             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 117             assertEquals(1, jsonFiles.size());
 118             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 119             var json = JSON.parse(jsonData);
 120             assertEquals(1, json.asArray().size());
 121             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 122             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 123                                                   .map(JSONValue::asString)
 124                                                   .collect(Collectors.toList()));
 125         }
 126     }
 127 
 128     @Test
 129     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
 130         try (var credentials = new HostCredentials(testInfo);
 131              var tempFolder = new TemporaryDirectory()) {
 132             var repo = credentials.getHostedRepository();
 133             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 134             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 135             credentials.commitLock(localRepo);
 136             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 137             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 138             localRepo.pushAll(repo.url());
 139 
 140             var tagStorage = createTagStorage(repo);
 141             var branchStorage = createBranchStorage(repo);
 142             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 143             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 144             Files.createDirectory(jsonFolder);
 145             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
 146 
 147             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
 148             var notifyBot = NotifyBot.newBuilder()
 149                                      .repository(repo)
 150                                      .storagePath(storageFolder)
 151                                      .branches(Pattern.compile(&quot;master&quot;))
 152                                      .tagStorageBuilder(tagStorage)
 153                                      .branchStorageBuilder(branchStorage)
 154                                      .prIssuesStorageBuilder(prIssuesStorage)
 155                                      .updaters(List.of(updater))
 156                                      .build();
 157 
 158             TestBotRunner.runPeriodicItems(notifyBot);
 159             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 160 
 161             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 162             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 163             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 164             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
 165             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 166             localRepo.pushAll(repo.url());
 167 
 168             TestBotRunner.runPeriodicItems(notifyBot);
 169             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 170             assertEquals(3, jsonFiles.size());
 171 
 172             for (var file : jsonFiles) {
 173                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
 174                 var json = JSON.parse(jsonData);
 175 
 176                 if (json.asArray().get(0).contains(&quot;date&quot;)) {
 177                     assertEquals(2, json.asArray().size());
 178                     assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 179                                                           .map(JSONValue::asString)
 180                                                           .collect(Collectors.toList()));
 181                     assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 182                     assertEquals(&quot;team&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 183                     assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(1).get(&quot;issue&quot;).asArray().stream()
 184                                                           .map(JSONValue::asString)
 185                                                           .collect(Collectors.toList()));
 186                     assertEquals(repo.webUrl(editHash2).toString(), json.asArray().get(1).get(&quot;url&quot;).asString());
 187                     assertEquals(&quot;team&quot;, json.asArray().get(1).get(&quot;build&quot;).asString());
 188                 } else {
 189                     assertEquals(1, json.asArray().size());
 190                     if (json.asArray().get(0).get(&quot;build&quot;).asString().equals(&quot;b02&quot;)) {
 191                         assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 192                                                               .map(JSONValue::asString)
 193                                                               .collect(Collectors.toList()));
 194                     } else {
 195                         assertEquals(&quot;b04&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 196                         assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 197                                                               .map(JSONValue::asString)
 198                                                               .collect(Collectors.toList()));
 199                     }
 200                 }
 201             }
 202         }
 203     }
 204 
 205     @Test
 206     void testMailingList(TestInfo testInfo) throws IOException {
 207         try (var listServer = new TestMailmanServer();
 208              var credentials = new HostCredentials(testInfo);
 209              var tempFolder = new TemporaryDirectory()) {
 210             var repo = credentials.getHostedRepository();
 211             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 212             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 213             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 214             credentials.commitLock(localRepo);
 215             localRepo.pushAll(repo.url());
 216 
 217             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 218             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 219             var mailmanList = mailmanServer.getList(listAddress.address());
 220             var tagStorage = createTagStorage(repo);
 221             var branchStorage = createBranchStorage(repo);
 222             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 223             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 224 
 225             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 226             var updater = MailingListUpdater.newBuilder()
 227                                             .list(mailmanList)
 228                                             .recipient(listAddress)
 229                                             .sender(sender)
 230                                             .reportNewTags(false)
 231                                             .reportNewBranches(false)
 232                                             .reportNewBuilds(false)
 233                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 234                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
 235                                             .build();
 236             var notifyBot = NotifyBot.newBuilder()
 237                                      .repository(repo)
 238                                      .storagePath(storageFolder)
 239                                      .branches(Pattern.compile(&quot;master&quot;))
 240                                      .tagStorageBuilder(tagStorage)
 241                                      .branchStorageBuilder(branchStorage)
 242                                      .prIssuesStorageBuilder(prIssuesStorage)
 243                                      .updaters(List.of(updater))
 244                                      .build();
 245 
 246             // No mail should be sent on the first run as there is no history
 247             TestBotRunner.runPeriodicItems(notifyBot);
 248             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 249 
 250             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 251             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 252             TestBotRunner.runPeriodicItems(notifyBot);
 253             listServer.processIncoming();
 254 
 255             var conversations = mailmanList.conversations(Duration.ofDays(1));
 256             var email = conversations.get(0).first();
 257             assertEquals(listAddress, email.sender());
 258             assertEquals(sender, email.author());
 259             assertEquals(email.recipients(), List.of(listAddress));
 260             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
 261             assertFalse(email.subject().contains(&quot;master&quot;));
 262             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 263             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 264             assertFalse(email.body().contains(&quot;Committer&quot;));
 265             assertFalse(email.body().contains(masterHash.abbreviate()));
 266             assertTrue(email.hasHeader(&quot;extra1&quot;));
 267             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 268             assertTrue(email.hasHeader(&quot;extra2&quot;));
 269             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
<a name="1" id="anc1"></a><span class="line-added"> 270             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="line-added"> 271             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="line-added"> 272             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="line-added"> 273             assertEquals(editHash.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
 274         }
 275     }
 276 
 277     @Test
 278     void testMailingListMultiple(TestInfo testInfo) throws IOException {
 279         try (var listServer = new TestMailmanServer();
 280              var credentials = new HostCredentials(testInfo);
 281              var tempFolder = new TemporaryDirectory()) {
 282             var repo = credentials.getHostedRepository();
 283             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 284             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 285             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 286             credentials.commitLock(localRepo);
 287             localRepo.pushAll(repo.url());
 288 
 289             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 290             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 291             var mailmanList = mailmanServer.getList(listAddress.address());
 292             var tagStorage = createTagStorage(repo);
 293             var branchStorage = createBranchStorage(repo);
 294             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 295             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 296 
 297             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 298             var updater = MailingListUpdater.newBuilder()
 299                                             .list(mailmanList)
 300                                             .recipient(listAddress)
 301                                             .sender(sender)
 302                                             .reportNewTags(false)
 303                                             .reportNewBranches(false)
 304                                             .reportNewBuilds(false)
 305                                             .build();
 306             var notifyBot = NotifyBot.newBuilder()
 307                                      .repository(repo)
 308                                      .storagePath(storageFolder)
 309                                      .branches(Pattern.compile(&quot;master&quot;))
 310                                      .tagStorageBuilder(tagStorage)
 311                                      .branchStorageBuilder(branchStorage)
 312                                      .prIssuesStorageBuilder(prIssuesStorage)
 313                                      .updaters(List.of(updater))
 314                                      .build();
 315 
 316             // No mail should be sent on the first run as there is no history
 317             TestBotRunner.runPeriodicItems(notifyBot);
 318             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 319 
 320             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 321                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 322             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 323             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 324                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 325             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 326 
 327             TestBotRunner.runPeriodicItems(notifyBot);
 328             listServer.processIncoming();
 329 
 330             var conversations = mailmanList.conversations(Duration.ofDays(1));
 331             var email = conversations.get(0).first();
 332             assertEquals(listAddress, email.sender());
 333             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());
 334             assertEquals(email.recipients(), List.of(listAddress));
 335             assertTrue(email.subject().contains(&quot;: 2 new changesets&quot;));
 336             assertFalse(email.subject().contains(&quot;master&quot;));
 337             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 338             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 339             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 340             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 341             assertFalse(email.body().contains(masterHash.abbreviate()));
<a name="2" id="anc2"></a><span class="line-added"> 342             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="line-added"> 343             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="line-added"> 344             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="line-added"> 345             assertEquals(editHash1.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
 346         }
 347     }
 348 
 349     @Test
 350     void testMailingListSponsored(TestInfo testInfo) throws IOException {
 351         try (var listServer = new TestMailmanServer();
 352              var credentials = new HostCredentials(testInfo);
 353              var tempFolder = new TemporaryDirectory()) {
 354             var repo = credentials.getHostedRepository();
 355             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 356             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 357             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 358             credentials.commitLock(localRepo);
 359             localRepo.pushAll(repo.url());
 360 
 361             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 362             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 363             var mailmanList = mailmanServer.getList(listAddress.address());
 364             var tagStorage = createTagStorage(repo);
 365             var branchStorage = createBranchStorage(repo);
 366             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 367             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 368 
 369             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 370             var updater = MailingListUpdater.newBuilder()
 371                                             .list(mailmanList)
 372                                             .recipient(listAddress)
 373                                             .sender(sender)
 374                                             .reportNewTags(false)
 375                                             .reportNewBranches(false)
 376                                             .reportNewBuilds(false)
 377                                             .build();
 378             var notifyBot = NotifyBot.newBuilder()
 379                                      .repository(repo)
 380                                      .storagePath(storageFolder)
 381                                      .branches(Pattern.compile(&quot;master&quot;))
 382                                      .tagStorageBuilder(tagStorage)
 383                                      .branchStorageBuilder(branchStorage)
 384                                      .prIssuesStorageBuilder(prIssuesStorage)
 385                                      .updaters(List.of(updater))
 386                                      .build();
 387 
 388             // No mail should be sent on the first run as there is no history
 389             TestBotRunner.runPeriodicItems(notifyBot);
 390             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 391 
 392             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 393                                                                &quot;author&quot;, &quot;author@test.test&quot;,
 394                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);
 395             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 396             TestBotRunner.runPeriodicItems(notifyBot);
 397             listServer.processIncoming();
 398 
 399             var conversations = mailmanList.conversations(Duration.ofDays(1));
 400             var email = conversations.get(0).first();
 401             assertEquals(listAddress, email.sender());
 402             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
 403             assertEquals(email.recipients(), List.of(listAddress));
 404             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 405             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 406             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
 407             assertTrue(email.body().contains(&quot;Committer: committer &lt;committer@test.test&gt;&quot;));
 408             assertFalse(email.body().contains(masterHash.abbreviate()));
 409         }
 410     }
 411 
 412     @Test
 413     void testMailingListMultipleBranches(TestInfo testInfo) throws IOException {
 414         try (var listServer = new TestMailmanServer();
 415              var credentials = new HostCredentials(testInfo);
 416              var tempFolder = new TemporaryDirectory()) {
 417             var repo = credentials.getHostedRepository();
 418             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 419             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 420             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 421             credentials.commitLock(localRepo);
 422             var branch = localRepo.branch(masterHash, &quot;another&quot;);
 423             localRepo.pushAll(repo.url());
 424 
 425             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 426             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 427             var mailmanList = mailmanServer.getList(listAddress.address());
 428             var tagStorage = createTagStorage(repo);
 429             var branchStorage = createBranchStorage(repo);
 430             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 431             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 432 
 433             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 434             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 435             var updater = MailingListUpdater.newBuilder()
 436                                             .list(mailmanList)
 437                                             .recipient(listAddress)
 438                                             .sender(sender)
 439                                             .author(author)
 440                                             .includeBranch(true)
 441                                             .reportNewTags(false)
 442                                             .reportNewBranches(false)
 443                                             .reportNewBuilds(false)
 444                                             .build();
 445             var notifyBot = NotifyBot.newBuilder()
 446                                      .repository(repo)
 447                                      .storagePath(storageFolder)
 448                                      .branches(Pattern.compile(&quot;master|another&quot;))
 449                                      .tagStorageBuilder(tagStorage)
 450                                      .branchStorageBuilder(branchStorage)
 451                                      .prIssuesStorageBuilder(prIssuesStorage)
 452                                      .updaters(List.of(updater))
 453                                      .build();
 454 
 455             // No mail should be sent on the first run as there is no history
 456             TestBotRunner.runPeriodicItems(notifyBot);
 457             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 458 
 459             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 460             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 461             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
 462             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 463 
 464             TestBotRunner.runPeriodicItems(notifyBot);
 465             listServer.processIncoming();
 466 
 467             var conversations = mailmanList.conversations(Duration.ofDays(1));
 468             var email = conversations.get(0).first();
 469             assertEquals(listAddress, email.sender());
 470             assertEquals(author, email.author());
 471             assertEquals(email.recipients(), List.of(listAddress));
 472             assertFalse(email.subject().contains(&quot;another&quot;));
 473             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
 474             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 475             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 476             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 477             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 478             assertFalse(email.body().contains(masterHash.abbreviate()));
 479             assertFalse(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
<a name="3" id="anc3"></a><span class="line-added"> 480             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="line-added"> 481             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="line-added"> 482             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="line-added"> 483             assertEquals(editHash1.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
 484 
 485             localRepo.checkout(branch, true);
 486             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);
 487             localRepo.push(editHash3, repo.url(), &quot;another&quot;);
 488 
 489             TestBotRunner.runPeriodicItems(notifyBot);
 490             listServer.processIncoming();
 491 
 492             conversations = mailmanList.conversations(Duration.ofDays(1));
 493             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 494             email = conversations.get(0).first();
 495             assertEquals(author, email.author());
 496             assertEquals(listAddress, email.sender());
 497             assertEquals(email.recipients(), List.of(listAddress));
 498             assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));
 499             assertFalse(email.subject().contains(&quot;master&quot;));
 500             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));
 501             assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 502             assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 503             assertFalse(email.body().contains(&quot;3456789A: Even more fixes&quot;));
<a name="4" id="anc4"></a><span class="line-added"> 504             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="line-added"> 505             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="line-added"> 506             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="line-added"> 507             assertEquals(editHash3.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
 508         }
 509     }
 510 
 511     @Test
 512     void testMailingListPROnly(TestInfo testInfo) throws IOException {
 513         try (var listServer = new TestMailmanServer();
 514              var credentials = new HostCredentials(testInfo);
 515              var tempFolder = new TemporaryDirectory()) {
 516             var repo = credentials.getHostedRepository();
 517             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 518             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 519             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 520             credentials.commitLock(localRepo);
 521             localRepo.pushAll(repo.url());
 522 
 523             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 524             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 525             var mailmanList = mailmanServer.getList(listAddress.address());
 526             var tagStorage = createTagStorage(repo);
 527             var branchStorage = createBranchStorage(repo);
 528             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 529             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 530 
 531             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 532             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 533             var updater = MailingListUpdater.newBuilder()
 534                                             .list(mailmanList)
 535                                             .recipient(listAddress)
 536                                             .sender(sender)
 537                                             .author(author)
 538                                             .reportNewTags(false)
 539                                             .reportNewBranches(false)
 540                                             .reportNewBuilds(false)
 541                                             .mode(MailingListUpdater.Mode.PR_ONLY)
 542                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;))
 543                                             .build();
 544             var notifyBot = NotifyBot.newBuilder()
 545                                      .repository(repo)
 546                                      .storagePath(storageFolder)
 547                                      .branches(Pattern.compile(&quot;master&quot;))
 548                                      .tagStorageBuilder(tagStorage)
 549                                      .branchStorageBuilder(branchStorage)
 550                                      .prIssuesStorageBuilder(prIssuesStorage)
 551                                      .updaters(List.of(updater))
 552                                      .build();
 553 
 554             // No mail should be sent on the first run as there is no history
 555             TestBotRunner.runPeriodicItems(notifyBot);
 556             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 557 
 558             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 559             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 560             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 561 
 562             // Create a potentially conflicting one
 563             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 564             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 565             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 566 
 567             // PR hasn&#39;t been integrated yet, so there should be no mail
 568             TestBotRunner.runPeriodicItems(notifyBot);
 569             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 570 
 571             // Simulate an RFR email
 572             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
 573                     .recipient(listAddress)
 574                     .build();
 575             mailmanList.post(rfr);
 576             listServer.processIncoming();
 577 
 578             // And an integration
 579             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 580             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 581             TestBotRunner.runPeriodicItems(notifyBot);
 582             listServer.processIncoming();
 583 
 584             var conversations = mailmanList.conversations(Duration.ofDays(1));
 585             assertEquals(1, conversations.size());
 586             var first = conversations.get(0).first();
 587             var email = conversations.get(0).replies(first).get(0);
 588             assertEquals(listAddress, email.sender());
 589             assertEquals(author, email.author());
 590             assertEquals(email.recipients(), List.of(listAddress));
 591             assertEquals(&quot;[Integrated] RFR: My PR&quot;, email.subject());
 592             assertFalse(email.subject().contains(&quot;master&quot;));
 593             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 594             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 595             assertFalse(email.body().contains(&quot;Committer&quot;));
 596             assertFalse(email.body().contains(masterHash.abbreviate()));
 597             assertTrue(email.hasHeader(&quot;extra1&quot;));
 598             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
<a name="5" id="anc5"></a><span class="line-added"> 599             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));</span>
<span class="line-added"> 600             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));</span>
<span class="line-added"> 601             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));</span>
<span class="line-added"> 602             assertEquals(editHash.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));</span>
 603 
 604             // Now push the other one without a matching PR - PR_ONLY will not generate a mail
 605             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 606             TestBotRunner.runPeriodicItems(notifyBot);
 607             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofSeconds(1)));
 608         }
 609     }
 610 
 611     @Test
 612     void testMailingListPROnlyMultipleBranches(TestInfo testInfo) throws IOException {
 613         try (var listServer = new TestMailmanServer();
 614              var credentials = new HostCredentials(testInfo);
 615              var tempFolder = new TemporaryDirectory()) {
 616             var repo = credentials.getHostedRepository();
 617             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 618             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 619             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 620             credentials.commitLock(localRepo);
 621             localRepo.pushAll(repo.url());
 622 
 623             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 624             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 625             var mailmanList = mailmanServer.getList(listAddress.address());
 626             var tagStorage = createTagStorage(repo);
 627             var branchStorage = createBranchStorage(repo);
 628             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 629             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 630 
 631             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 632             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 633             var updater = MailingListUpdater.newBuilder()
 634                                             .list(mailmanList)
 635                                             .recipient(listAddress)
 636                                             .sender(sender)
 637                                             .author(author)
 638                                             .reportNewTags(false)
 639                                             .reportNewBranches(false)
 640                                             .reportNewBuilds(false)
 641                                             .includeBranch(true)
 642                                             .mode(MailingListUpdater.Mode.PR)
 643                                             .build();
 644             var notifyBot = NotifyBot.newBuilder()
 645                                      .repository(repo)
 646                                      .storagePath(storageFolder)
 647                                      .branches(Pattern.compile(&quot;master|other&quot;))
 648                                      .tagStorageBuilder(tagStorage)
 649                                      .branchStorageBuilder(branchStorage)
 650                                      .prIssuesStorageBuilder(prIssuesStorage)
 651                                      .updaters(List.of(updater))
 652                                      .build();
 653 
 654             // Populate our known branches
 655             localRepo.push(masterHash, repo.url(), &quot;master&quot;, true);
 656             localRepo.push(masterHash, repo.url(), &quot;other&quot;, true);
 657 
 658             // No mail should be sent on the first run as there is no history
 659             TestBotRunner.runPeriodicItems(notifyBot);
 660             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 661 
 662             localRepo.checkout(masterHash, true);
 663             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 664             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 665             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 666 
 667             // PR hasn&#39;t been integrated yet, so there should be no mail
 668             TestBotRunner.runPeriodicItems(notifyBot);
 669             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 670 
 671             // Simulate an RFR email
 672             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
 673                            .recipient(listAddress)
 674                            .build();
 675             mailmanList.post(rfr);
 676             listServer.processIncoming();
 677 
 678             // And an integration (but it hasn&#39;t reached master just yet)
 679             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 680 
 681             // Now push the same commit to another branch
 682             localRepo.push(editHash, repo.url(), &quot;other&quot;);
 683             TestBotRunner.runPeriodicItems(notifyBot);
 684             listServer.processIncoming();
 685 
 686             // This one should generate a plain integration mail
 687             var conversations = mailmanList.conversations(Duration.ofDays(1));
 688             assertEquals(2, conversations.size());
 689             var secondEmail = conversations.get(0).first();
 690             if (secondEmail.subject().contains(&quot;RFR&quot;)) {
 691                 secondEmail = conversations.get(1).first();
 692             }
 693             assertEquals(&quot;git: test: other: 23456789: More fixes&quot;, secondEmail.subject());
 694         }
 695     }
 696 
 697     @Test
 698     void testMailingListPR(TestInfo testInfo) throws IOException {
 699         try (var listServer = new TestMailmanServer();
 700              var credentials = new HostCredentials(testInfo);
 701              var tempFolder = new TemporaryDirectory()) {
 702             var repo = credentials.getHostedRepository();
 703             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 704             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 705             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 706             credentials.commitLock(localRepo);
 707             localRepo.pushAll(repo.url());
 708 
 709             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 710             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 711             var mailmanList = mailmanServer.getList(listAddress.address());
 712             var tagStorage = createTagStorage(repo);
 713             var branchStorage = createBranchStorage(repo);
 714             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 715             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 716 
 717             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 718             var updater = MailingListUpdater.newBuilder()
 719                                             .list(mailmanList)
 720                                             .recipient(listAddress)
 721                                             .sender(sender)
 722                                             .reportNewTags(false)
 723                                             .reportNewBranches(false)
 724                                             .reportNewBuilds(false)
 725                                             .mode(MailingListUpdater.Mode.PR)
 726                                             .build();
 727             var notifyBot = NotifyBot.newBuilder()
 728                                      .repository(repo)
 729                                      .storagePath(storageFolder)
 730                                      .branches(Pattern.compile(&quot;master&quot;))
 731                                      .tagStorageBuilder(tagStorage)
 732                                      .branchStorageBuilder(branchStorage)
 733                                      .prIssuesStorageBuilder(prIssuesStorage)
 734                                      .updaters(List.of(updater))
 735                                      .build();
 736 
 737             // No mail should be sent on the first run as there is no history
 738             TestBotRunner.runPeriodicItems(notifyBot);
 739             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 740 
 741             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 742             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 743             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 744 
 745             // Create a potentially conflicting one
 746             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 747             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 748             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 749 
 750             // PR hasn&#39;t been integrated yet, so there should be no mail
 751             TestBotRunner.runPeriodicItems(notifyBot);
 752             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 753 
 754             // Simulate an RFR email
 755             var rfr = Email.create(&quot;[repo/branch] RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 756                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 757                            .recipient(listAddress)
 758                            .build();
 759             mailmanList.post(rfr);
 760             listServer.processIncoming();
 761 
 762             // And an integration
 763             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 764             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 765 
 766             // Push the other one without a matching PR
 767             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 768 
 769             TestBotRunner.runPeriodicItems(notifyBot);
 770             listServer.processIncoming();
 771             listServer.processIncoming();
 772 
 773             var conversations = mailmanList.conversations(Duration.ofDays(1));
 774             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 775             assertEquals(2, conversations.size());
 776 
 777             var prConversation = conversations.get(0);
 778             var pushConversation = conversations.get(1);
 779 
 780             var prEmail = prConversation.replies(prConversation.first()).get(0);
 781             assertEquals(listAddress, prEmail.sender());
 782             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
 783             assertEquals(prEmail.recipients(), List.of(listAddress));
 784             assertEquals(&quot;[Integrated] [repo/branch] RFR: My PR&quot;, prEmail.subject());
 785             assertFalse(prEmail.subject().contains(&quot;master&quot;));
 786             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 787             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
 788             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
 789             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
 790 
 791             var pushEmail = pushConversation.first();
 792             assertEquals(listAddress, pushEmail.sender());
 793             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 794             assertEquals(pushEmail.recipients(), List.of(listAddress));
 795             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 796         }
 797     }
 798 
 799     @Test
 800     void testMailingListPROnce(TestInfo testInfo) throws IOException {
 801         try (var listServer = new TestMailmanServer();
 802              var credentials = new HostCredentials(testInfo);
 803              var tempFolder = new TemporaryDirectory()) {
 804             var repo = credentials.getHostedRepository();
 805             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 806             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 807             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 808             localRepo.branch(masterHash, &quot;other&quot;);
 809             credentials.commitLock(localRepo);
 810             localRepo.pushAll(repo.url());
 811 
 812             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 813             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 814             var mailmanList = mailmanServer.getList(listAddress.address());
 815             var tagStorage = createTagStorage(repo);
 816             var branchStorage = createBranchStorage(repo);
 817             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 818             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 819 
 820             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 821             var updater = MailingListUpdater.newBuilder()
 822                                             .list(mailmanList)
 823                                             .recipient(listAddress)
 824                                             .sender(sender)
 825                                             .author(null)
 826                                             .reportNewTags(false)
 827                                             .reportNewBranches(false)
 828                                             .reportNewBuilds(false)
 829                                             .mode(MailingListUpdater.Mode.PR)
 830                                             .build();
 831             var notifyBot = NotifyBot.newBuilder()
 832                                      .repository(repo)
 833                                      .storagePath(storageFolder)
 834                                      .branches(Pattern.compile(&quot;master|other&quot;))
 835                                      .tagStorageBuilder(tagStorage)
 836                                      .branchStorageBuilder(branchStorage)
 837                                      .prIssuesStorageBuilder(prIssuesStorage)
 838                                      .updaters(List.of(updater))
 839                                      .build();
 840 
 841             // No mail should be sent on the first run as there is no history
 842             TestBotRunner.runPeriodicItems(notifyBot);
 843             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 844 
 845             localRepo.checkout(masterHash, true);
 846             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 847             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 848             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 849 
 850             // PR hasn&#39;t been integrated yet, so there should be no mail
 851             TestBotRunner.runPeriodicItems(notifyBot);
 852             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 853 
 854             // Simulate an RFR email
 855             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 856                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 857                            .recipient(listAddress)
 858                            .build();
 859             mailmanList.post(rfr);
 860             listServer.processIncoming();
 861 
 862             // And an integration
 863             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 864             localRepo.push(editHash, repo.url(), &quot;master&quot;, true);
 865 
 866             TestBotRunner.runPeriodicItems(notifyBot);
 867             listServer.processIncoming();
 868 
 869             var conversations = mailmanList.conversations(Duration.ofDays(1));
 870             assertEquals(1, conversations.size());
 871 
 872             var prConversation = conversations.get(0);
 873             var prEmail = prConversation.replies(prConversation.first()).get(0);
 874             assertEquals(listAddress, prEmail.sender());
 875             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
 876             assertEquals(prEmail.recipients(), List.of(listAddress));
 877             assertEquals(&quot;[Integrated] RFR: My PR&quot;, prEmail.subject());
 878             assertFalse(prEmail.subject().contains(&quot;master&quot;));
 879             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 880             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
 881             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
 882             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
 883 
 884             // Now push the change to another monitored branch
 885             localRepo.push(editHash, repo.url(), &quot;other&quot;, true);
 886             TestBotRunner.runPeriodicItems(notifyBot);
 887             listServer.processIncoming();
 888 
 889             // The change should now end up as a separate notification thread
 890             conversations = mailmanList.conversations(Duration.ofDays(1));
 891             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 892             assertEquals(2, conversations.size());
 893 
 894             var pushConversation = conversations.get(1);
 895             var pushEmail = pushConversation.first();
 896             assertEquals(listAddress, pushEmail.sender());
 897             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 898             assertEquals(pushEmail.recipients(), List.of(listAddress));
 899             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 900         }
 901     }
 902 
 903     @Test
 904     void testMailinglistTag(TestInfo testInfo) throws IOException {
 905         try (var credentials = new HostCredentials(testInfo);
 906              var tempFolder = new TemporaryDirectory();
 907              var listServer = new TestMailmanServer()) {
 908             var repo = credentials.getHostedRepository();
 909             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 910             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 911             credentials.commitLock(localRepo);
 912             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 913             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 914             localRepo.pushAll(repo.url());
 915 
 916             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 917             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 918             var mailmanList = mailmanServer.getList(listAddress.address());
 919             var tagStorage = createTagStorage(repo);
 920             var branchStorage = createBranchStorage(repo);
 921             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 922             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 923 
 924             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 925             var updater = MailingListUpdater.newBuilder()
 926                                             .list(mailmanList)
 927                                             .recipient(listAddress)
 928                                             .sender(sender)
 929                                             .reportNewBranches(false)
 930                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 931                                             .build();
 932             var prOnlyUpdater = MailingListUpdater.newBuilder()
 933                                                   .list(mailmanList)
 934                                                   .recipient(listAddress)
 935                                                   .sender(sender)
 936                                                   .reportNewTags(false)
 937                                                   .reportNewBranches(false)
 938                                                   .reportNewBuilds(false)
 939                                                   .mode(MailingListUpdater.Mode.PR_ONLY)
 940                                                   .build();
 941             var notifyBot = NotifyBot.newBuilder()
 942                                      .repository(repo)
 943                                      .storagePath(storageFolder)
 944                                      .branches(Pattern.compile(&quot;master&quot;))
 945                                      .tagStorageBuilder(tagStorage)
 946                                      .branchStorageBuilder(branchStorage)
 947                                      .prIssuesStorageBuilder(prIssuesStorage)
 948                                      .updaters(List.of(updater, prOnlyUpdater))
 949                                      .build();
 950 
 951             // No mail should be sent on the first run as there is no history
 952             TestBotRunner.runPeriodicItems(notifyBot);
 953             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 954 
 955             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 956             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 957             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 958             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 959             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 960             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 961             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 962             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 963             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 964             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 965             localRepo.pushAll(repo.url());
 966 
 967             TestBotRunner.runPeriodicItems(notifyBot);
 968             listServer.processIncoming();
 969             listServer.processIncoming();
 970             listServer.processIncoming();
 971             listServer.processIncoming();
 972 
 973             var conversations = mailmanList.conversations(Duration.ofDays(1));
 974             assertEquals(4, conversations.size());
 975 
 976             for (var conversation : conversations) {
 977                 var email = conversation.first();
 978                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 979                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 980                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 981                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 982                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 983                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 984                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 985                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 986                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 987                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 988                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 989                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 990                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 991                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 992                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 993                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 994                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 995                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 996                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 997                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 998                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 999                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
1000                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
1001                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
1002                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
1003                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
1004                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
1005                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
1006                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
1007                     assertTrue(email.body().contains(&quot;67890123: Brand new fixes&quot;));
1008                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
1009                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
1010                 } else {
1011                     fail(&quot;Mismatched subject: &quot; + email.subject());
1012                 }
1013                 assertTrue(email.hasHeader(&quot;extra1&quot;));
1014                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
1015                 assertTrue(email.hasHeader(&quot;extra2&quot;));
1016                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1017             }
1018         }
1019     }
1020 
1021     @Test
1022     void testMailinglistPlainTags(TestInfo testInfo) throws IOException {
1023         try (var credentials = new HostCredentials(testInfo);
1024              var tempFolder = new TemporaryDirectory();
1025              var listServer = new TestMailmanServer()) {
1026             var repo = credentials.getHostedRepository();
1027             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1028             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
1029             credentials.commitLock(localRepo);
1030             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1031             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
1032             localRepo.pushAll(repo.url());
1033 
1034             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1035             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1036             var mailmanList = mailmanServer.getList(listAddress.address());
1037             var tagStorage = createTagStorage(repo);
1038             var branchStorage = createBranchStorage(repo);
1039             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1040             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1041 
1042             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1043             var updater = MailingListUpdater.newBuilder()
1044                                             .list(mailmanList)
1045                                             .recipient(listAddress)
1046                                             .sender(sender)
1047                                             .reportNewBranches(false)
1048                                             .reportNewBuilds(false)
1049                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1050                                             .build();
1051             var prOnlyUpdater = MailingListUpdater.newBuilder()
1052                                                   .list(mailmanList)
1053                                                   .recipient(listAddress)
1054                                                   .sender(sender)
1055                                                   .reportNewTags(false)
1056                                                   .reportNewBranches(false)
1057                                                   .reportNewBuilds(false)
1058                                                   .mode(MailingListUpdater.Mode.PR_ONLY)
1059                                                   .build();
1060             var notifyBot = NotifyBot.newBuilder()
1061                                      .repository(repo)
1062                                      .storagePath(storageFolder)
1063                                      .branches(Pattern.compile(&quot;master&quot;))
1064                                      .tagStorageBuilder(tagStorage)
1065                                      .branchStorageBuilder(branchStorage)
1066                                      .prIssuesStorageBuilder(prIssuesStorage)
1067                                      .updaters(List.of(updater, prOnlyUpdater))
1068                                      .build();
1069 
1070             // No mail should be sent on the first run as there is no history
1071             TestBotRunner.runPeriodicItems(notifyBot);
1072             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1073 
1074             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1075             localRepo.fetch(repo.url(), &quot;history:history&quot;);
1076             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
1077             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
1078             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
1079             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
1080             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
1081             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
1082             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
1083             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
1084             localRepo.pushAll(repo.url());
1085 
1086             TestBotRunner.runPeriodicItems(notifyBot);
1087             listServer.processIncoming();
1088             listServer.processIncoming();
1089             listServer.processIncoming();
1090             listServer.processIncoming();
1091 
1092             var conversations = mailmanList.conversations(Duration.ofDays(1));
1093             assertEquals(4, conversations.size());
1094 
1095             for (var conversation : conversations) {
1096                 var email = conversation.first();
1097                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
1098                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
1099                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
1100                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
1101                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
1102                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
1103                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
1104                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
1105                 } else {
1106                     fail(&quot;Mismatched subject: &quot; + email.subject());
1107                 }
1108                 assertTrue(email.hasHeader(&quot;extra1&quot;));
1109                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
1110                 assertTrue(email.hasHeader(&quot;extra2&quot;));
1111                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1112             }
1113         }
1114     }
1115 
1116     @Test
1117     void testMailingListBranch(TestInfo testInfo) throws IOException {
1118         try (var listServer = new TestMailmanServer();
1119              var credentials = new HostCredentials(testInfo);
1120              var tempFolder = new TemporaryDirectory()) {
1121             var repo = credentials.getHostedRepository();
1122             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1123             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1124             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1125             credentials.commitLock(localRepo);
1126             localRepo.pushAll(repo.url());
1127 
1128             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1129             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1130             var mailmanList = mailmanServer.getList(listAddress.address());
1131             var tagStorage = createTagStorage(repo);
1132             var branchStorage = createBranchStorage(repo);
1133             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1134             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1135 
1136             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1137             var updater = MailingListUpdater.newBuilder()
1138                                             .list(mailmanList)
1139                                             .recipient(listAddress)
1140                                             .sender(sender)
1141                                             .reportNewTags(false)
1142                                             .reportNewBuilds(false)
1143                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1144                                             .build();
1145             var notifyBot = NotifyBot.newBuilder()
1146                                      .repository(repo)
1147                                      .storagePath(storageFolder)
1148                                      .branches(Pattern.compile(&quot;master|newbranch.&quot;))
1149                                      .tagStorageBuilder(tagStorage)
1150                                      .branchStorageBuilder(branchStorage)
1151                                      .prIssuesStorageBuilder(prIssuesStorage)
1152                                      .updaters(List.of(updater))
1153                                      .build();
1154 
1155             // No mail should be sent on the first run as there is no history
1156             TestBotRunner.runPeriodicItems(notifyBot);
1157             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1158 
1159             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
1160             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1161             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
1162             TestBotRunner.runPeriodicItems(notifyBot);
1163             listServer.processIncoming();
1164 
1165             var conversations = mailmanList.conversations(Duration.ofDays(1));
1166             var email = conversations.get(0).first();
1167             assertEquals(listAddress, email.sender());
1168             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
1169             assertEquals(email.recipients(), List.of(listAddress));
1170             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());
1171             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));
1172             assertTrue(email.hasHeader(&quot;extra1&quot;));
1173             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
1174             assertTrue(email.hasHeader(&quot;extra2&quot;));
1175             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1176 
1177             TestBotRunner.runPeriodicItems(notifyBot);
1178             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1179 
1180             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);
1181             TestBotRunner.runPeriodicItems(notifyBot);
1182             listServer.processIncoming();
1183 
1184             var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()
1185                                              .filter(c -&gt; !c.equals(conversations.get(0)))
1186                                              .findFirst().orElseThrow();
1187             email = newConversation.first();
1188             assertEquals(listAddress, email.sender());
1189             assertEquals(sender, email.author());
1190             assertEquals(email.recipients(), List.of(listAddress));
1191             assertEquals(&quot;git: test: created branch newbranch2 based on the branch newbranch1 containing 0 unique commits&quot;, email.subject());
1192             assertEquals(&quot;The new branch newbranch2 is currently identical to the newbranch1 branch.&quot;, email.body());
1193         }
1194     }
1195 
1196     @Test
1197     void testMailingListBranchPrefix(TestInfo testInfo) throws IOException {
1198         try (var listServer = new TestMailmanServer();
1199              var credentials = new HostCredentials(testInfo);
1200              var tempFolder = new TemporaryDirectory()) {
1201             var repo = credentials.getHostedRepository();
1202             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1203             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1204             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1205             credentials.commitLock(localRepo);
1206             localRepo.pushAll(repo.url());
1207 
1208             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1209             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1210             var mailmanList = mailmanServer.getList(listAddress.address());
1211             var tagStorage = createTagStorage(repo);
1212             var branchStorage = createBranchStorage(repo);
1213             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1214             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1215 
1216             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1217             var updater = MailingListUpdater.newBuilder()
1218                                             .list(mailmanList)
1219                                             .recipient(listAddress)
1220                                             .sender(sender)
1221                                             .reportNewTags(false)
1222                                             .reportNewBranches(false)
1223                                             .reportNewBuilds(false)
1224                                             .mode(MailingListUpdater.Mode.PR)
1225                                             .repoInSubject(true)
1226                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
1227                                             .build();
1228             var notifyBot = NotifyBot.newBuilder()
1229                                      .repository(repo)
1230                                      .storagePath(storageFolder)
1231                                      .branches(Pattern.compile(&quot;master&quot;))
1232                                      .tagStorageBuilder(tagStorage)
1233                                      .branchStorageBuilder(branchStorage)
1234                                      .prIssuesStorageBuilder(prIssuesStorage)
1235                                      .updaters(List.of(updater))
1236                                      .build();
1237 
1238             // No mail should be sent on the first run as there is no history
1239             TestBotRunner.runPeriodicItems(notifyBot);
1240             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1241 
1242             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1243             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
1244             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
1245 
1246             // PR hasn&#39;t been integrated yet, so there should be no mail
1247             TestBotRunner.runPeriodicItems(notifyBot);
1248             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1249 
1250             // Simulate an RFR email
1251             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
1252                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
1253                            .recipient(listAddress)
1254                            .build();
1255             mailmanList.post(rfr);
1256             listServer.processIncoming();
1257 
1258             // And an integration
1259             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
1260             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1261 
1262             TestBotRunner.runPeriodicItems(notifyBot);
1263             listServer.processIncoming();
1264 
1265             var conversations = mailmanList.conversations(Duration.ofDays(1));
1266             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
1267             assertEquals(1, conversations.size());
1268 
1269             var prConversation = conversations.get(0);
1270 
1271             var prEmail = prConversation.replies(prConversation.first()).get(0);
1272             assertEquals(listAddress, prEmail.sender());
1273             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
1274             assertEquals(prEmail.recipients(), List.of(listAddress));
1275             assertEquals(&quot;[&quot; + repo.name() + &quot;:master] [Integrated] RFR: My PR&quot;, prEmail.subject());
1276             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
1277             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
1278             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
1279             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
1280         }
1281     }
1282 
1283     @Test
1284     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
1285         try (var listServer = new TestMailmanServer();
1286              var credentials = new HostCredentials(testInfo);
1287              var tempFolder = new TemporaryDirectory()) {
1288             var repo = credentials.getHostedRepository();
1289             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1290             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1291             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1292             credentials.commitLock(localRepo);
1293             localRepo.pushAll(repo.url());
1294 
1295             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1296             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1297             var mailmanList = mailmanServer.getList(listAddress.address());
1298             var tagStorage = createTagStorage(repo);
1299             var branchStorage = createBranchStorage(repo);
1300             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1301             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1302 
1303             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1304             var updater = MailingListUpdater.newBuilder()
1305                                             .list(mailmanList)
1306                                             .recipient(listAddress)
1307                                             .sender(sender)
1308                                             .reportNewTags(false)
1309                                             .reportNewBranches(false)
1310                                             .reportNewBuilds(false)
1311                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1312                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
1313                                             .build();
1314             var notifyBot = NotifyBot.newBuilder()
1315                                      .repository(repo)
1316                                      .storagePath(storageFolder)
1317                                      .branches(Pattern.compile(&quot;master&quot;))
1318                                      .tagStorageBuilder(tagStorage)
1319                                      .branchStorageBuilder(branchStorage)
1320                                      .prIssuesStorageBuilder(prIssuesStorage)
1321                                      .updaters(List.of(updater))
1322                                      .build();
1323 
1324             // No mail should be sent on the first run as there is no history
1325             TestBotRunner.runPeriodicItems(notifyBot);
1326             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1327 
1328             // Save history state
1329             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);
1330 
1331             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1332             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1333             TestBotRunner.runPeriodicItems(notifyBot);
1334             listServer.processIncoming();
1335 
1336             var conversations = mailmanList.conversations(Duration.ofDays(1));
1337             assertEquals(1, conversations.size());
1338 
1339             // Reset the history
1340             localRepo.push(historyHash, repo.url(), &quot;history&quot;, true);
1341             TestBotRunner.runPeriodicItems(notifyBot);
1342             listServer.processIncoming();
1343 
1344             // There should now be a duplicate mail
1345             conversations = mailmanList.conversations(Duration.ofDays(1));
1346             assertEquals(2, conversations.size());
1347         }
1348     }
1349 
1350     @Test
1351     void testIssue(TestInfo testInfo) throws IOException {
1352         try (var credentials = new HostCredentials(testInfo);
1353              var tempFolder = new TemporaryDirectory()) {
1354             var repo = credentials.getHostedRepository();
1355             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1356             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1357             credentials.commitLock(localRepo);
1358             localRepo.pushAll(repo.url());
1359 
1360             var tagStorage = createTagStorage(repo);
1361             var branchStorage = createBranchStorage(repo);
1362             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1363             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1364 
1365             var issueProject = credentials.getIssueProject();
1366             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1367             var updater = IssueUpdater.newBuilder()
1368                                       .issueProject(issueProject)
1369                                       .reviewLink(false)
1370                                       .commitIcon(commitIcon)
1371                                       .setFixVersion(true)
1372                                       .build();
1373             var notifyBot = NotifyBot.newBuilder()
1374                                      .repository(repo)
1375                                      .storagePath(storageFolder)
1376                                      .branches(Pattern.compile(&quot;master&quot;))
1377                                      .tagStorageBuilder(tagStorage)
1378                                      .branchStorageBuilder(branchStorage)
1379                                      .prIssuesStorageBuilder(prIssuesStorage)
1380                                      .updaters(List.of(updater))
1381                                      .build();
1382 
1383             // Initialize history
1384             TestBotRunner.runPeriodicItems(notifyBot);
1385 
1386             // Create an issue and commit a fix
1387             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1388             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1389             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1390             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1391             TestBotRunner.runPeriodicItems(notifyBot);
1392 
1393             // The changeset should be reflected in a comment
1394             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1395 
1396             var comments = updatedIssue.comments();
1397             assertEquals(1, comments.size());
1398             var comment = comments.get(0);
1399             assertTrue(comment.body().contains(editHash.abbreviate()));
1400 
1401             // And in a link
1402             var links = updatedIssue.links();
1403             assertEquals(1, links.size());
1404             var link = links.get(0);
1405             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1406             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1407             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1408 
1409             // As well as a fixVersion
1410             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1411 
1412             // The issue should be assigned and resolved
1413             assertEquals(RESOLVED, updatedIssue.state());
1414             assertEquals(List.of(issueProject.issueTracker().currentUser()), updatedIssue.assignees());
1415         }
1416     }
1417 
1418     @Test
1419     void testIssueNoVersion(TestInfo testInfo) throws IOException {
1420         try (var credentials = new HostCredentials(testInfo);
1421              var tempFolder = new TemporaryDirectory()) {
1422             var repo = credentials.getHostedRepository();
1423             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1424             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1425             credentials.commitLock(localRepo);
1426             localRepo.pushAll(repo.url());
1427 
1428             var tagStorage = createTagStorage(repo);
1429             var branchStorage = createBranchStorage(repo);
1430             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1431             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1432 
1433             var issueProject = credentials.getIssueProject();
1434             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1435             var updater = IssueUpdater.newBuilder()
1436                                       .issueProject(issueProject)
1437                                       .reviewLink(false)
1438                                       .commitIcon(commitIcon)
1439                                       .setFixVersion(true)
1440                                       .build();
1441             var notifyBot = NotifyBot.newBuilder()
1442                                      .repository(repo)
1443                                      .storagePath(storageFolder)
1444                                      .branches(Pattern.compile(&quot;master&quot;))
1445                                      .tagStorageBuilder(tagStorage)
1446                                      .branchStorageBuilder(branchStorage)
1447                                      .prIssuesStorageBuilder(prIssuesStorage)
1448                                      .updaters(List.of(updater))
1449                                      .build();
1450 
1451             // Initialize history
1452             TestBotRunner.runPeriodicItems(notifyBot);
1453 
1454             // Create an issue and commit a fix
1455             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1456             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1457             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1458             TestBotRunner.runPeriodicItems(notifyBot);
1459 
1460             // The changeset should be reflected in a comment
1461             var comments = issue.comments();
1462             assertEquals(1, comments.size());
1463             var comment = comments.get(0);
1464             assertTrue(comment.body().contains(editHash.abbreviate()));
1465 
1466             // But not in the fixVersion
1467             assertEquals(Set.of(), fixVersions(issue));
1468         }
1469     }
1470 
1471     @Test
1472     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
1473         try (var credentials = new HostCredentials(testInfo);
1474              var tempFolder = new TemporaryDirectory()) {
1475             var repo = credentials.getHostedRepository();
1476             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1477             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1478             credentials.commitLock(localRepo);
1479             localRepo.pushAll(repo.url());
1480 
1481             var tagStorage = createTagStorage(repo);
1482             var branchStorage = createBranchStorage(repo);
1483             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1484             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1485 
1486             var issueProject = credentials.getIssueProject();
1487             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1488             var updater = IssueUpdater.newBuilder()
1489                                       .issueProject(issueProject)
1490                                       .reviewLink(false)
1491                                       .commitLink(false)
1492                                       .commitIcon(commitIcon)
1493                                       .setFixVersion(true)
1494                                       .fixVersions(Map.of(&quot;master&quot;, &quot;2.0&quot;))
1495                                       .build();
1496             var notifyBot = NotifyBot.newBuilder()
1497                                      .repository(repo)
1498                                      .storagePath(storageFolder)
1499                                      .branches(Pattern.compile(&quot;master&quot;))
1500                                      .tagStorageBuilder(tagStorage)
1501                                      .branchStorageBuilder(branchStorage)
1502                                      .prIssuesStorageBuilder(prIssuesStorage)
1503                                      .updaters(List.of(updater))
1504                                      .build();
1505 
1506             // Initialize history
1507             TestBotRunner.runPeriodicItems(notifyBot);
1508 
1509             // Create an issue and commit a fix
1510             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1511             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1512             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1513             TestBotRunner.runPeriodicItems(notifyBot);
1514 
1515             // The changeset should not reflected in a comment
1516             var comments = issue.comments();
1517             assertEquals(1, comments.size());
1518             var comment = comments.get(0);
1519             assertTrue(comment.body().contains(editHash.abbreviate()));
1520 
1521             // As well as a fixVersion - but not the one from the repo
1522             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
1523 
1524             // And no commit link
1525             var links = issue.links();
1526             assertEquals(0, links.size());
1527         }
1528     }
1529 
1530     @Test
1531     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1532         try (var credentials = new HostCredentials(testInfo);
1533              var tempFolder = new TemporaryDirectory()) {
1534             var repo = credentials.getHostedRepository();
1535             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1536             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1537             credentials.commitLock(localRepo);
1538             localRepo.pushAll(repo.url());
1539 
1540             var tagStorage = createTagStorage(repo);
1541             var branchStorage = createBranchStorage(repo);
1542             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1543             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1544 
1545             var issueProject = credentials.getIssueProject();
1546             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1547             var updater = IssueUpdater.newBuilder()
1548                                       .issueProject(issueProject)
1549                                       .reviewLink(false)
1550                                       .commitIcon(commitIcon)
1551                                       .setFixVersion(true)
1552                                       .build();
1553             var notifyBot = NotifyBot.newBuilder()
1554                                      .repository(repo)
1555                                      .storagePath(storageFolder)
1556                                      .branches(Pattern.compile(&quot;master&quot;))
1557                                      .tagStorageBuilder(tagStorage)
1558                                      .branchStorageBuilder(branchStorage)
1559                                      .prIssuesStorageBuilder(prIssuesStorage)
1560                                      .updaters(List.of(updater))
1561                                      .build();
1562 
1563             // Initialize history
1564             TestBotRunner.runPeriodicItems(notifyBot);
1565 
1566             // Save the state
1567             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1568 
1569             // Create an issue and commit a fix
1570             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1571             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1572             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1573             TestBotRunner.runPeriodicItems(notifyBot);
1574 
1575             // The changeset should be reflected in a comment
1576             var comments = issue.comments();
1577             assertEquals(1, comments.size());
1578             var comment = comments.get(0);
1579             assertTrue(comment.body().contains(editHash.abbreviate()));
1580 
1581             // And in a link
1582             var links = issue.links();
1583             assertEquals(1, links.size());
1584             var link = links.get(0);
1585             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1586             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1587             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1588 
1589             // As well as a fixVersion
1590             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));
1591 
1592             // Wipe the history
1593             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
1594 
1595             // Run it again
1596             TestBotRunner.runPeriodicItems(notifyBot);
1597 
1598             // There should be no new comments, links or fixVersions
1599             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1600             assertEquals(1, updatedIssue.comments().size());
1601             assertEquals(1, updatedIssue.links().size());
1602             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1603         }
1604     }
1605 
1606     @Test
1607     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1608         try (var credentials = new HostCredentials(testInfo);
1609              var tempFolder = new TemporaryDirectory()) {
1610             var repo = credentials.getHostedRepository();
1611             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1612             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1613             credentials.commitLock(localRepo);
1614             localRepo.pushAll(repo.url());
1615 
1616             var tagStorage = createTagStorage(repo);
1617             var branchStorage = createBranchStorage(repo);
1618             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1619             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1620 
1621             var issueProject = credentials.getIssueProject();
1622             var updater = IssueUpdater.newBuilder()
1623                                       .issueProject(issueProject)
1624                                       .reviewLink(false)
1625                                       .commitLink(false)
1626                                       .setFixVersion(true)
1627                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))
1628                                       .build();
1629             var notifyBot = NotifyBot.newBuilder()
1630                                      .repository(repo)
1631                                      .storagePath(storageFolder)
1632                                      .branches(Pattern.compile(&quot;master&quot;))
1633                                      .tagStorageBuilder(tagStorage)
1634                                      .branchStorageBuilder(branchStorage)
1635                                      .prIssuesStorageBuilder(prIssuesStorage)
1636                                      .updaters(List.of(updater))
1637                                      .build();
1638 
1639             // Initialize history
1640             TestBotRunner.runPeriodicItems(notifyBot);
1641 
1642             // Create an issue and commit a fix
1643             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1644             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1645 
1646             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1647             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1648             TestBotRunner.runPeriodicItems(notifyBot);
1649 
1650             // The fixVersion should have been updated
1651             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1652         }
1653     }
1654 
1655     @Test
1656     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1657         try (var credentials = new HostCredentials(testInfo);
1658              var tempFolder = new TemporaryDirectory()) {
1659             var repo = credentials.getHostedRepository();
1660             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1661             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1662             credentials.commitLock(localRepo);
1663             localRepo.pushAll(repo.url());
1664 
1665             var tagStorage = createTagStorage(repo);
1666             var branchStorage = createBranchStorage(repo);
1667             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1668             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1669 
1670             var issueProject = credentials.getIssueProject();
1671             var updater = IssueUpdater.newBuilder()
1672                                       .issueProject(issueProject)
1673                                       .reviewLink(false)
1674                                       .commitLink(false)
1675                                       .setFixVersion(true)
1676                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))
1677                                       .build();
1678             var notifyBot = NotifyBot.newBuilder()
1679                                      .repository(repo)
1680                                      .storagePath(storageFolder)
1681                                      .branches(Pattern.compile(&quot;master&quot;))
1682                                      .tagStorageBuilder(tagStorage)
1683                                      .branchStorageBuilder(branchStorage)
1684                                      .prIssuesStorageBuilder(prIssuesStorage)
1685                                      .updaters(List.of(updater))
1686                                      .build();
1687 
1688             // Initialize history
1689             TestBotRunner.runPeriodicItems(notifyBot);
1690 
1691             // Create an issue and commit a fix
1692             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1693             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1694 
1695             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1696             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1697             TestBotRunner.runPeriodicItems(notifyBot);
1698 
1699             // The fixVersion should have been updated
1700             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1701         }
1702     }
1703 
1704     @Test
1705     void testIssueBackport(TestInfo testInfo) throws IOException {
1706         try (var credentials = new HostCredentials(testInfo);
1707              var tempFolder = new TemporaryDirectory()) {
1708             var repo = credentials.getHostedRepository();
1709             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1710             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1711             credentials.commitLock(localRepo);
1712             localRepo.pushAll(repo.url());
1713 
1714             var tagStorage = createTagStorage(repo);
1715             var branchStorage = createBranchStorage(repo);
1716             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1717             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1718 
1719             var issueProject = credentials.getIssueProject();
1720             var updater = IssueUpdater.newBuilder()
1721                                       .issueProject(issueProject)
1722                                       .reviewLink(false)
1723                                       .commitLink(false)
1724                                       .setFixVersion(true)
1725                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12.0.2&quot;))
1726                                       .build();
1727             var notifyBot = NotifyBot.newBuilder()
1728                                      .repository(repo)
1729                                      .storagePath(storageFolder)
1730                                      .branches(Pattern.compile(&quot;master&quot;))
1731                                      .tagStorageBuilder(tagStorage)
1732                                      .branchStorageBuilder(branchStorage)
1733                                      .prIssuesStorageBuilder(prIssuesStorage)
1734                                      .updaters(List.of(updater))
1735                                      .build();
1736 
1737             // Initialize history
1738             TestBotRunner.runPeriodicItems(notifyBot);
1739 
1740             // Create an issue and commit a fix
1741             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),
1742                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),
1743                                                         &quot;customfield_10008&quot;, JSON.object()
1744                                                                                  .put(&quot;id&quot;, 244)
1745                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),
1746                                                         &quot;customfield_10005&quot;, JSON.array()
1747                                                                                  .add(JSON.object()
1748                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)
1749                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))
1750                                                                                  .add(JSON.object()
1751                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)
1752                                                                                           .put(&quot;value&quot;, &quot;other&quot;))
1753                                                  ));
1754             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
1755             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
1756 
1757             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1758             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1759             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1760             TestBotRunner.runPeriodicItems(notifyBot);
1761 
1762             // The fixVersion should not have been updated
1763             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1764             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));
1765             assertEquals(OPEN, updatedIssue.state());
1766             assertEquals(List.of(), updatedIssue.assignees());
1767 
1768             // There should be a link
1769             var links = updatedIssue.links();
1770             assertEquals(1, links.size());
1771             var link = links.get(0);
1772             var backport = link.issue().orElseThrow();
1773 
1774             // The backport issue should have a correct fixVersion and assignee
1775             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));
1776             assertEquals(RESOLVED, backport.state());
1777             assertEquals(List.of(issueProject.issueTracker().currentUser()), backport.assignees());
1778 
1779             // Custom properties should also propagate
1780             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());
1781             assertEquals(244, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;id&quot;).asInt());
1782             assertEquals(&quot;java.io&quot;, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;name&quot;).asString());
1783             assertEquals(2, backport.properties().get(&quot;customfield_10005&quot;).asArray().size());
1784         }
1785     }
1786 
1787     @Test
1788     void testPullRequest(TestInfo testInfo) throws IOException {
1789         try (var credentials = new HostCredentials(testInfo);
1790              var tempFolder = new TemporaryDirectory()) {
1791             var repo = credentials.getHostedRepository();
1792             var reviewer = credentials.getHostedRepository();
1793             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1794             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1795             credentials.commitLock(localRepo);
1796             localRepo.pushAll(repo.url());
1797 
1798             var tagStorage = createTagStorage(repo);
1799             var branchStorage = createBranchStorage(repo);
1800             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1801             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1802 
1803             var issueProject = credentials.getIssueProject();
1804             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1805             var updater = IssueUpdater.newBuilder()
1806                                       .issueProject(issueProject)
1807                                       .reviewIcon(reviewIcon)
1808                                       .commitLink(false)
1809                                       .build();
1810             var notifyBot = NotifyBot.newBuilder()
1811                                      .repository(repo)
1812                                      .storagePath(storageFolder)
1813                                      .branches(Pattern.compile(&quot;master&quot;))
1814                                      .tagStorageBuilder(tagStorage)
1815                                      .branchStorageBuilder(branchStorage)
1816                                      .prIssuesStorageBuilder(prIssuesStorage)
1817                                      .prUpdaters(List.of(updater))
1818                                      .readyLabels(Set.of(&quot;rfr&quot;))
1819                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
1820                                      .build();
1821 
1822             // Initialize history
1823             TestBotRunner.runPeriodicItems(notifyBot);
1824 
1825             // Create an issue and a pull request to fix it
1826             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1827             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1828             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1829             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1830             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1831             TestBotRunner.runPeriodicItems(notifyBot);
1832 
1833             // The issue should not yet contain a link to the PR
1834             var links = issue.links();
1835             assertEquals(0, links.size());
1836 
1837             // Just a label isn&#39;t enough
1838             pr.addLabel(&quot;rfr&quot;);
1839             TestBotRunner.runPeriodicItems(notifyBot);
1840             links = issue.links();
1841             assertEquals(0, links.size());
1842 
1843             // Neither is just a comment
1844             pr.removeLabel(&quot;rfr&quot;);
1845             var reviewPr = reviewer.pullRequest(pr.id());
1846             reviewPr.addComment(&quot;This is now ready&quot;);
1847             TestBotRunner.runPeriodicItems(notifyBot);
1848             links = issue.links();
1849             assertEquals(0, links.size());
1850 
1851             // Both are needed
1852             pr.addLabel(&quot;rfr&quot;);
1853             TestBotRunner.runPeriodicItems(notifyBot);
1854 
1855             // The issue should now contain a link to the PR
1856             links = issue.links();
1857             assertEquals(1, links.size());
1858             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1859             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1860 
1861             // Add another issue
1862             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1863             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n * [&quot; + issue2.id() +
1864                                &quot;](http://www.test2.test/): The second issue&quot;);
1865             TestBotRunner.runPeriodicItems(notifyBot);
1866 
1867             // Both issues should contain a link to the PR
1868             var links1 = issue.links();
1869             assertEquals(1, links1.size());
1870             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());
1871             var links2 = issue2.links();
1872             assertEquals(1, links2.size());
1873             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1874 
1875             // Drop the first one
1876             pr.setBody(&quot;\n\n### Issues\n * [&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
1877             TestBotRunner.runPeriodicItems(notifyBot);
1878 
1879             // Only the second issue should now contain a link to the PR
1880             links1 = issue.links();
1881             assertEquals(0, links1.size());
1882             links2 = issue2.links();
1883             assertEquals(1, links2.size());
1884             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1885         }
1886     }
1887 
1888     @Test
1889     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
1890         try (var credentials = new HostCredentials(testInfo);
1891              var tempFolder = new TemporaryDirectory()) {
1892             var repo = credentials.getHostedRepository();
1893             var reviewer = credentials.getHostedRepository();
1894             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1895             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1896             credentials.commitLock(localRepo);
1897             localRepo.pushAll(repo.url());
1898 
1899             var tagStorage = createTagStorage(repo);
1900             var branchStorage = createBranchStorage(repo);
1901             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1902             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1903 
1904             var issueProject = credentials.getIssueProject();
1905             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1906             var updater = IssueUpdater.newBuilder()
1907                                       .issueProject(issueProject)
1908                                       .reviewLink(false)
1909                                       .reviewIcon(reviewIcon)
1910                                       .commitLink(false)
1911                                       .build();
1912             var notifyBot = NotifyBot.newBuilder()
1913                                      .repository(repo)
1914                                      .storagePath(storageFolder)
1915                                      .branches(Pattern.compile(&quot;master&quot;))
1916                                      .tagStorageBuilder(tagStorage)
1917                                      .branchStorageBuilder(branchStorage)
1918                                      .prIssuesStorageBuilder(prIssuesStorage)
1919                                      .prUpdaters(List.of(updater)).readyLabels(Set.of(&quot;rfr&quot;))
1920                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
1921                                      .build();
1922             // Initialize history
1923             TestBotRunner.runPeriodicItems(notifyBot);
1924 
1925             // Create an issue and a pull request to fix it
1926             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1927             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1928             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1929             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1930             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1931             TestBotRunner.runPeriodicItems(notifyBot);
1932 
1933             // Add required label
1934             pr.addLabel(&quot;rfr&quot;);
1935             TestBotRunner.runPeriodicItems(notifyBot);
1936 
1937             // And the required comment
1938             var reviewPr = reviewer.pullRequest(pr.id());
1939             reviewPr.addComment(&quot;This is now ready&quot;);
1940             TestBotRunner.runPeriodicItems(notifyBot);
1941 
1942             // The issue should still not contain a link to the PR
1943             var links = issue.links();
1944             assertEquals(0, links.size());
1945         }
1946     }
1947 
1948     @Test
1949     void testPullRequestPROnly(TestInfo testInfo) throws IOException {
1950         try (var credentials = new HostCredentials(testInfo);
1951              var tempFolder = new TemporaryDirectory()) {
1952             var repo = credentials.getHostedRepository();
1953             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1954             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1955             credentials.commitLock(localRepo);
1956             localRepo.pushAll(repo.url());
1957 
1958             var tagStorage = createTagStorage(repo);
1959             var branchStorage = createBranchStorage(repo);
1960             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1961             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1962 
1963             var issueProject = credentials.getIssueProject();
1964             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1965             var updater = IssueUpdater.newBuilder()
1966                                       .issueProject(issueProject)
1967                                       .reviewIcon(reviewIcon)
1968                                       .commitLink(false)
1969                                       .prOnly(true)
1970                                       .build();
1971             var notifyBot = NotifyBot.newBuilder()
1972                                      .repository(repo)
1973                                      .storagePath(storageFolder)
1974                                      .branches(Pattern.compile(&quot;.*&quot;))
1975                                      .tagStorageBuilder(tagStorage)
1976                                      .branchStorageBuilder(branchStorage)
1977                                      .prIssuesStorageBuilder(prIssuesStorage)
1978                                      .updaters(List.of(updater))
1979                                      .prUpdaters(List.of(updater))
1980                                      .build();
1981 
1982             // Initialize history
1983             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
1984             TestBotRunner.runPeriodicItems(notifyBot);
1985 
1986             // Create an issue and a pull request to fix it
1987             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1988             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1989             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1990             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
1991             pr.setBody(&quot;\n\n### Issue\n * [&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1992             TestBotRunner.runPeriodicItems(notifyBot);
1993 
1994             // The issue should now contain a link to the PR
1995             var links = issue.links();
1996             assertEquals(1, links.size());
1997             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1998             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1999 
2000             // Simulate integration
2001             localRepo.push(editHash, repo.url(), &quot;other&quot;);
2002             TestBotRunner.runPeriodicItems(notifyBot);
2003 
2004             // The changeset should be reflected in a comment
2005             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
2006 
2007             var comments = updatedIssue.comments();
2008             assertEquals(1, comments.size());
2009             var comment = comments.get(0);
2010             assertTrue(comment.body().contains(editHash.abbreviate()));
2011 
2012             // Now simulate a merge to another branch
2013             localRepo.push(editHash, repo.url(), &quot;master&quot;);
2014             TestBotRunner.runPeriodicItems(notifyBot);
2015 
2016             // No additional comment should have been made
2017             updatedIssue = issueProject.issue(issue.id()).orElseThrow();
2018             comments = updatedIssue.comments();
2019             assertEquals(1, comments.size());
2020         }
2021     }
2022 
2023     private static class TestRepositoryUpdateConsumer implements RepositoryUpdateConsumer {
2024         private final String name;
2025         private final boolean idempotent;
2026         private int updateCount = 0;
2027         private boolean shouldFail = false;
2028 
2029         TestRepositoryUpdateConsumer(String name, boolean idempotent) {
2030             this.name = name;
2031             this.idempotent = idempotent;
2032         }
2033 
2034         @Override
2035         public void handleCommits(HostedRepository repository, Repository localRepository, List&lt;Commit&gt; commits,
2036                                   Branch branch) throws NonRetriableException {
2037             updateCount++;
2038             if (shouldFail) {
2039                 if (idempotent) {
2040                     throw new RuntimeException(&quot;induced failure&quot;);
2041                 } else {
2042                     throw new NonRetriableException(new RuntimeException(&quot;unretriable failure&quot;));
2043                 }
2044             }
2045         }
2046 
2047         @Override
2048         public void handleOpenJDKTagCommits(HostedRepository repository, Repository localRepository,
2049          List&lt;Commit&gt; commits, OpenJDKTag tag, Tag.Annotated annotated) {
2050             throw new RuntimeException(&quot;unexpected&quot;);
2051         }
2052 
2053         @Override
2054         public void handleTagCommit(HostedRepository repository, Repository localRepository, Commit commit, Tag tag,
2055          Tag.Annotated annotation) {
2056             throw new RuntimeException(&quot;unexpected&quot;);
2057         }
2058 
2059         @Override
2060         public void handleNewBranch(HostedRepository repository, Repository localRepository, List&lt;Commit&gt; commits,
2061          Branch parent, Branch branch) {
2062             throw new RuntimeException(&quot;unexpected&quot;);
2063         }
2064 
2065         @Override
2066         public String name() {
2067             return name;
2068         }
2069     }
2070 
2071     @Test
2072     void testIdempotenceMix(TestInfo testInfo) throws IOException {
2073         try (var credentials = new HostCredentials(testInfo);
2074              var tempFolder = new TemporaryDirectory()) {
2075             var repo = credentials.getHostedRepository();
2076             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
2077             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
2078             credentials.commitLock(localRepo);
2079             localRepo.pushAll(repo.url());
2080 
2081             var tagStorage = createTagStorage(repo);
2082             var branchStorage = createBranchStorage(repo);
2083             var prIssuesStorage = createPullRequestIssuesStorage(repo);
2084             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
2085 
2086             var idempotent = new TestRepositoryUpdateConsumer(&quot;i&quot;, true);
2087             var nonIdempotent = new TestRepositoryUpdateConsumer(&quot;ni&quot;, false);
2088             var notifyBot = NotifyBot.newBuilder()
2089                                      .repository(repo)
2090                                      .storagePath(storageFolder)
2091                                      .branches(Pattern.compile(&quot;master&quot;))
2092                                      .tagStorageBuilder(tagStorage)
2093                                      .branchStorageBuilder(branchStorage)
2094                                      .prIssuesStorageBuilder(prIssuesStorage)
2095                                      .updaters(List.of(idempotent, nonIdempotent))
2096                                      .build();
2097 
2098             // Initialize history
2099             TestBotRunner.runPeriodicItems(notifyBot);
2100 
2101             // Create an issue and commit a fix
2102             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix stuff&quot;);
2103             localRepo.push(editHash, repo.url(), &quot;master&quot;);
2104             TestBotRunner.runPeriodicItems(notifyBot);
2105 
2106             // Both updaters should have run
2107             assertEquals(1, idempotent.updateCount);
2108             assertEquals(1, nonIdempotent.updateCount);
2109 
2110             var nextEditHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;Fix more stuff&quot;);
2111             localRepo.push(nextEditHash, repo.url(), &quot;master&quot;);
2112 
2113             idempotent.shouldFail = true;
2114             nonIdempotent.shouldFail = true;
2115             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(notifyBot));
2116 
2117             // Both updaters should have run again
2118             assertEquals(2, idempotent.updateCount);
2119             assertEquals(2, nonIdempotent.updateCount);
2120 
2121             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(notifyBot));
2122 
2123             // But now only the idempotent one should have been retried
2124             assertEquals(3, idempotent.updateCount);
2125             assertEquals(2, nonIdempotent.updateCount);
2126         }
2127     }
2128 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>