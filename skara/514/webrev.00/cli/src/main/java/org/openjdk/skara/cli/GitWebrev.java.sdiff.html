<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff cli/src/main/java/org/openjdk/skara/cli/GitWebrev.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitWebrev.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 23 package org.openjdk.skara.cli;
 24 
 25 import org.openjdk.skara.args.*;
 26 import org.openjdk.skara.proxy.HttpProxy;
 27 import org.openjdk.skara.vcs.*;
 28 import org.openjdk.skara.webrev.*;
 29 import org.openjdk.skara.version.Version;
 30 
 31 import java.io.*;
 32 import java.net.URI;
 33 import java.net.URISyntaxException;
 34 import java.net.http.HttpClient;
 35 import java.net.http.HttpRequest;
 36 import java.net.http.HttpResponse;
 37 import java.nio.file.*;
 38 import java.util.*;
 39 import java.util.regex.Pattern;
 40 import java.util.stream.Collectors;
 41 
 42 public class GitWebrev {


 43     private static void clearDirectory(Path directory) {
 44         try {
 45             Files.walk(directory)
 46                     .map(Path::toFile)
 47                     .sorted(Comparator.reverseOrder())
 48                     .forEach(File::delete);
 49         } catch (IOException io) {
 50             throw new RuntimeException(io);
 51         }
 52     }
 53 
 54     private static String arg(String name, Arguments args, ReadOnlyRepository repo) throws IOException {
 55         if (args.contains(name)) {
 56             return args.get(name).asString();
 57         }
 58 
 59         var config = repo.config(&quot;webrev.&quot; + name);
 60         if (config.size() == 1) {
 61             return config.get(0);
 62         }
</pre>
<hr />
<pre>
210             } else {
211                 if (noOutgoing) {
212                     rev = resolve(repo, &quot;HEAD&quot;);
213                 } else {
214                     var commits = repo.commitMetadata(&quot;origin..HEAD&quot;, true);
215                     rev = resolve(repo, commits.get(0).hash().hex() + &quot;^&quot;);
216                 }
217             }
218         }
219 
220         var issue = arguments.contains(&quot;cr&quot;) ? arguments.get(&quot;cr&quot;).asString() : null;
221         if (issue != null) {
222             if (issue.startsWith(&quot;http&quot;)) {
223                 var uri = URI.create(issue);
224                 issue = Path.of(uri.getPath()).getFileName().toString();
225             } else if (isDigit(issue.charAt(0))) {
226                 issue = &quot;JDK-&quot; + issue;
227             }
228         }
229         if (issue == null) {
<span class="line-modified">230             var pattern = Pattern.compile(&quot;(?:(JDK|CODETOOLS|JMC|SKARA)-)?([0-9]+).*&quot;);</span>
231             var currentBranch = repo.currentBranch();
232             if (currentBranch.isPresent()) {
233                 var branchName = currentBranch.get().name().toUpperCase();
234                 var m = pattern.matcher(branchName);
235                 if (m.matches()) {
236                     var project = m.group(1);
237                     if (project == null) {
238                         project = &quot;JDK&quot;;
239                     }
240                     var id = m.group(2);
241                     issue = project + &quot;-&quot; + id;
242                 }
243             }
244         }
245 
246         var out = arg(&quot;output&quot;, arguments, repo);
247         if (out == null) {
248             out = &quot;webrev&quot;;
249         }
250         var output = Path.of(out);
</pre>
<hr />
<pre>
274             username = repo.username().orElse(System.getProperty(&quot;user.name&quot;));
275         }
276         var author = Author.fromString(username);
277 
278         if (Files.exists(output)) {
279             clearDirectory(output);
280         }
281 
282         List&lt;Path&gt; files = List.of();
283         if (arguments.at(0).isPresent()) {
284             var path = arguments.at(0).via(Path::of);
285             if (path.equals(Path.of(&quot;-&quot;))) {
286                 var reader = new BufferedReader(new InputStreamReader(System.in));
287                 files = reader.lines().map(Path::of).collect(Collectors.toList());
288             } else {
289                 files = Files.readAllLines(path).stream().map(Path::of).collect(Collectors.toList());
290             }
291         }
292 
293         var jbs = &quot;https://bugs.openjdk.java.net/browse/&quot;;



294         Webrev.repository(repo)
295               .output(output)
296               .title(title)
297               .upstream(upstream)
298               .username(author.name())
299               .commitLinker(hash -&gt; upstreamURL == null ? null : upstreamURL + &quot;/commit/&quot; + hash)
<span class="line-modified">300               .issueLinker(id -&gt; jbs + (isDigit(id.charAt(0)) ? &quot;JDK-&quot; : &quot;&quot;) + id)</span>
301               .issue(issue)
302               .version(version)
303               .files(files)
304               .generate(rev);
305     }
306 
307     private static void apply(String[] args) throws Exception {
308         var inputs = List.of(
309             Input.position(0)
310                  .describe(&quot;webrev url&quot;)
311                  .singular()
312                  .required());
313 
314         var parser = new ArgumentParser(&quot;git webrev apply&quot;, List.of(), inputs);
315         var arguments = parser.parse(args);
316 
317         var cwd = Paths.get(&quot;&quot;).toAbsolutePath();
318         var repository = Repository.get(cwd).orElseGet(() -&gt; {
319             System.err.println(String.format(&quot;error: %s is not a repository&quot;, cwd.toString()));
320             System.exit(1);
</pre>
</td>
<td>
<hr />
<pre>
 23 package org.openjdk.skara.cli;
 24 
 25 import org.openjdk.skara.args.*;
 26 import org.openjdk.skara.proxy.HttpProxy;
 27 import org.openjdk.skara.vcs.*;
 28 import org.openjdk.skara.webrev.*;
 29 import org.openjdk.skara.version.Version;
 30 
 31 import java.io.*;
 32 import java.net.URI;
 33 import java.net.URISyntaxException;
 34 import java.net.http.HttpClient;
 35 import java.net.http.HttpRequest;
 36 import java.net.http.HttpResponse;
 37 import java.nio.file.*;
 38 import java.util.*;
 39 import java.util.regex.Pattern;
 40 import java.util.stream.Collectors;
 41 
 42 public class GitWebrev {
<span class="line-added"> 43     private static final List&lt;String&gt; KNOWN_JBS_PROJECTS =</span>
<span class="line-added"> 44         List.of(&quot;JDK&quot;, &quot;CODETOOLS&quot;, &quot;SKARA&quot;, &quot;JMC&quot;);</span>
 45     private static void clearDirectory(Path directory) {
 46         try {
 47             Files.walk(directory)
 48                     .map(Path::toFile)
 49                     .sorted(Comparator.reverseOrder())
 50                     .forEach(File::delete);
 51         } catch (IOException io) {
 52             throw new RuntimeException(io);
 53         }
 54     }
 55 
 56     private static String arg(String name, Arguments args, ReadOnlyRepository repo) throws IOException {
 57         if (args.contains(name)) {
 58             return args.get(name).asString();
 59         }
 60 
 61         var config = repo.config(&quot;webrev.&quot; + name);
 62         if (config.size() == 1) {
 63             return config.get(0);
 64         }
</pre>
<hr />
<pre>
212             } else {
213                 if (noOutgoing) {
214                     rev = resolve(repo, &quot;HEAD&quot;);
215                 } else {
216                     var commits = repo.commitMetadata(&quot;origin..HEAD&quot;, true);
217                     rev = resolve(repo, commits.get(0).hash().hex() + &quot;^&quot;);
218                 }
219             }
220         }
221 
222         var issue = arguments.contains(&quot;cr&quot;) ? arguments.get(&quot;cr&quot;).asString() : null;
223         if (issue != null) {
224             if (issue.startsWith(&quot;http&quot;)) {
225                 var uri = URI.create(issue);
226                 issue = Path.of(uri.getPath()).getFileName().toString();
227             } else if (isDigit(issue.charAt(0))) {
228                 issue = &quot;JDK-&quot; + issue;
229             }
230         }
231         if (issue == null) {
<span class="line-modified">232             var pattern = Pattern.compile(&quot;(?:(&quot; + String.join(&quot;|&quot;, KNOWN_JBS_PROJECTS) + &quot;)-)?([0-9]+).*&quot;);</span>
233             var currentBranch = repo.currentBranch();
234             if (currentBranch.isPresent()) {
235                 var branchName = currentBranch.get().name().toUpperCase();
236                 var m = pattern.matcher(branchName);
237                 if (m.matches()) {
238                     var project = m.group(1);
239                     if (project == null) {
240                         project = &quot;JDK&quot;;
241                     }
242                     var id = m.group(2);
243                     issue = project + &quot;-&quot; + id;
244                 }
245             }
246         }
247 
248         var out = arg(&quot;output&quot;, arguments, repo);
249         if (out == null) {
250             out = &quot;webrev&quot;;
251         }
252         var output = Path.of(out);
</pre>
<hr />
<pre>
276             username = repo.username().orElse(System.getProperty(&quot;user.name&quot;));
277         }
278         var author = Author.fromString(username);
279 
280         if (Files.exists(output)) {
281             clearDirectory(output);
282         }
283 
284         List&lt;Path&gt; files = List.of();
285         if (arguments.at(0).isPresent()) {
286             var path = arguments.at(0).via(Path::of);
287             if (path.equals(Path.of(&quot;-&quot;))) {
288                 var reader = new BufferedReader(new InputStreamReader(System.in));
289                 files = reader.lines().map(Path::of).collect(Collectors.toList());
290             } else {
291                 files = Files.readAllLines(path).stream().map(Path::of).collect(Collectors.toList());
292             }
293         }
294 
295         var jbs = &quot;https://bugs.openjdk.java.net/browse/&quot;;
<span class="line-added">296         var issueParts = issue != null ? issue.split(&quot;-&quot;) : new String[0];</span>
<span class="line-added">297         var jbsProject = issueParts.length == 2 &amp;&amp; KNOWN_JBS_PROJECTS.contains(issueParts[0])?</span>
<span class="line-added">298             issueParts[0] : &quot;JDK&quot;;</span>
299         Webrev.repository(repo)
300               .output(output)
301               .title(title)
302               .upstream(upstream)
303               .username(author.name())
304               .commitLinker(hash -&gt; upstreamURL == null ? null : upstreamURL + &quot;/commit/&quot; + hash)
<span class="line-modified">305               .issueLinker(id -&gt; jbs + (isDigit(id.charAt(0)) ? jbsProject + &quot;-&quot; : &quot;&quot;) + id)</span>
306               .issue(issue)
307               .version(version)
308               .files(files)
309               .generate(rev);
310     }
311 
312     private static void apply(String[] args) throws Exception {
313         var inputs = List.of(
314             Input.position(0)
315                  .describe(&quot;webrev url&quot;)
316                  .singular()
317                  .required());
318 
319         var parser = new ArgumentParser(&quot;git webrev apply&quot;, List.of(), inputs);
320         var arguments = parser.parse(args);
321 
322         var cwd = Paths.get(&quot;&quot;).toAbsolutePath();
323         var repository = Repository.get(cwd).orElseGet(() -&gt; {
324             System.err.println(String.format(&quot;error: %s is not a repository&quot;, cwd.toString()));
325             System.exit(1);
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>