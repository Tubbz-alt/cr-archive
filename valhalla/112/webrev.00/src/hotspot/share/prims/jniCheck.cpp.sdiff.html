<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/prims/jniCheck.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/hotspot/share/prims/jniCheck.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 351   if (!aOop-&gt;is_typeArray()) {
 352      ReportJNIFatalError(thr, fatal_prim_type_array_expected);
 353   }
 354   return aOop;
 355 }
 356 
 357 static inline void
 358 check_primitive_array_type(JavaThread* thr, jarray jArray, BasicType elementType)
 359 {
 360   BasicType array_type;
 361   arrayOop aOop;
 362 
 363   aOop = check_is_primitive_array(thr, jArray);
 364   array_type = TypeArrayKlass::cast(aOop-&gt;klass())-&gt;element_type();
 365   if (array_type != elementType) {
 366     ReportJNIFatalError(thr, fatal_element_type_mismatch);
 367   }
 368 }
 369 
 370 static inline void
<span class="line-modified"> 371 check_is_obj_array(JavaThread* thr, jarray jArray) {</span>
 372   arrayOop aOop = check_is_array(thr, jArray);
<span class="line-modified"> 373   if (!aOop-&gt;is_objArray()) {</span>
 374     ReportJNIFatalError(thr, fatal_object_array_expected);
 375   }
 376 }
 377 
 378 /*
 379  * Copy and wrap array elements for bounds checking.
 380  * Remember the original elements (GuardedMemory::get_tag())
 381  */
 382 static void* check_jni_wrap_copy_array(JavaThread* thr, jarray array,
 383     void* orig_elements) {
 384   void* result;
 385   IN_VM(
 386     oop a = JNIHandles::resolve_non_null(array);
 387     size_t len = arrayOop(a)-&gt;length() &lt;&lt;
 388         TypeArrayKlass::cast(a-&gt;klass())-&gt;log2_element_size();
 389     result = GuardedMemory::wrap_copy(orig_elements, len, orig_elements);
 390   )
 391   return result;
 392 }
 393 
</pre>
<hr />
<pre>
 470 
 471 oop jniCheck::validate_object(JavaThread* thr, jobject obj) {
 472   if (obj == NULL) return NULL;
 473   ASSERT_OOPS_ALLOWED;
 474   oop oopObj = jniCheck::validate_handle(thr, obj);
 475   if (oopObj == NULL) {
 476     ReportJNIFatalError(thr, fatal_bad_ref_to_jni);
 477   }
 478   return oopObj;
 479 }
 480 
 481 // Warn if a class descriptor is in decorated form; class descriptors
 482 // passed to JNI findClass should not be decorated unless they are
 483 // array descriptors.
 484 void jniCheck::validate_class_descriptor(JavaThread* thr, const char* name) {
 485   if (name == NULL) return;  // implementation accepts NULL so just return
 486 
 487   size_t len = strlen(name);
 488 
 489   if (len &gt;= 2 &amp;&amp;
<span class="line-modified"> 490       name[0] == JVM_SIGNATURE_CLASS &amp;&amp;            // &#39;L&#39;</span>
 491       name[len-1] == JVM_SIGNATURE_ENDCLASS ) {    // &#39;;&#39;
 492     char msg[JVM_MAXPATHLEN];
 493     jio_snprintf(msg, JVM_MAXPATHLEN, &quot;%s%s%s&quot;,
 494                  warn_bad_class_descriptor1, name, warn_bad_class_descriptor2);
 495     ReportJNIWarning(thr, msg);
 496   }
 497 
 498   // Verify that the class name given is a valid utf8 string
 499   if (!UTF8::is_legal_utf8((const unsigned char*)name, (int)strlen(name), false)) {
 500     char msg[JVM_MAXPATHLEN];
 501     jio_snprintf(msg, JVM_MAXPATHLEN, &quot;%s%s%s&quot;, fatal_non_utf8_class_name1, name, fatal_non_utf8_class_name2);
 502     ReportJNIFatalError(thr, msg);
 503   }
 504 }
 505 
 506 Klass* jniCheck::validate_class(JavaThread* thr, jclass clazz, bool allow_primitive) {
 507   ASSERT_OOPS_ALLOWED;
 508   oop mirror = jniCheck::validate_handle(thr, clazz);
 509   if (mirror == NULL) {
 510     ReportJNIFatalError(thr, fatal_received_null_class);
</pre>
<hr />
<pre>
1619     return result;
1620 JNI_END
1621 
1622 JNI_ENTRY_CHECKED(jobjectArray,
1623   checked_jni_NewObjectArray(JNIEnv *env,
1624                              jsize len,
1625                              jclass clazz,
1626                              jobject init))
1627     functionEnter(thr);
1628     jobjectArray result = UNCHECKED()-&gt;NewObjectArray(env,len,clazz,init);
1629     functionExit(thr);
1630     return result;
1631 JNI_END
1632 
1633 JNI_ENTRY_CHECKED(jobject,
1634   checked_jni_GetObjectArrayElement(JNIEnv *env,
1635                                     jobjectArray array,
1636                                     jsize index))
1637     functionEnter(thr);
1638     IN_VM(
<span class="line-modified">1639       check_is_obj_array(thr, array);</span>
1640     )
1641     jobject result = UNCHECKED()-&gt;GetObjectArrayElement(env,array,index);
1642     functionExit(thr);
1643     return result;
1644 JNI_END
1645 
1646 JNI_ENTRY_CHECKED(void,
1647   checked_jni_SetObjectArrayElement(JNIEnv *env,
1648                                     jobjectArray array,
1649                                     jsize index,
1650                                     jobject val))
1651     functionEnter(thr);
1652     IN_VM(
<span class="line-modified">1653       check_is_obj_array(thr, array);</span>
1654     )
1655     UNCHECKED()-&gt;SetObjectArrayElement(env,array,index,val);
1656     functionExit(thr);
1657 JNI_END
1658 
1659 #define WRAPPER_NewScalarArray(Return, Result) \
1660 JNI_ENTRY_CHECKED(Return, \
1661   checked_jni_New##Result##Array(JNIEnv *env, \
1662                                  jsize len)) \
1663     functionEnter(thr); \
1664     Return result = UNCHECKED()-&gt;New##Result##Array(env,len); \
1665     functionExit(thr); \
1666     return (Return) result; \
1667 JNI_END
1668 
1669 WRAPPER_NewScalarArray(jbooleanArray, Boolean)
1670 WRAPPER_NewScalarArray(jbyteArray, Byte)
1671 WRAPPER_NewScalarArray(jshortArray, Short)
1672 WRAPPER_NewScalarArray(jcharArray, Char)
1673 WRAPPER_NewScalarArray(jintArray, Int)
</pre>
</td>
<td>
<hr />
<pre>
 351   if (!aOop-&gt;is_typeArray()) {
 352      ReportJNIFatalError(thr, fatal_prim_type_array_expected);
 353   }
 354   return aOop;
 355 }
 356 
 357 static inline void
 358 check_primitive_array_type(JavaThread* thr, jarray jArray, BasicType elementType)
 359 {
 360   BasicType array_type;
 361   arrayOop aOop;
 362 
 363   aOop = check_is_primitive_array(thr, jArray);
 364   array_type = TypeArrayKlass::cast(aOop-&gt;klass())-&gt;element_type();
 365   if (array_type != elementType) {
 366     ReportJNIFatalError(thr, fatal_element_type_mismatch);
 367   }
 368 }
 369 
 370 static inline void
<span class="line-modified"> 371 check_is_obj_or_inline_array(JavaThread* thr, jarray jArray) {</span>
 372   arrayOop aOop = check_is_array(thr, jArray);
<span class="line-modified"> 373   if (!aOop-&gt;is_objArray() &amp;&amp; !aOop-&gt;is_valueArray()) {</span>
 374     ReportJNIFatalError(thr, fatal_object_array_expected);
 375   }
 376 }
 377 
 378 /*
 379  * Copy and wrap array elements for bounds checking.
 380  * Remember the original elements (GuardedMemory::get_tag())
 381  */
 382 static void* check_jni_wrap_copy_array(JavaThread* thr, jarray array,
 383     void* orig_elements) {
 384   void* result;
 385   IN_VM(
 386     oop a = JNIHandles::resolve_non_null(array);
 387     size_t len = arrayOop(a)-&gt;length() &lt;&lt;
 388         TypeArrayKlass::cast(a-&gt;klass())-&gt;log2_element_size();
 389     result = GuardedMemory::wrap_copy(orig_elements, len, orig_elements);
 390   )
 391   return result;
 392 }
 393 
</pre>
<hr />
<pre>
 470 
 471 oop jniCheck::validate_object(JavaThread* thr, jobject obj) {
 472   if (obj == NULL) return NULL;
 473   ASSERT_OOPS_ALLOWED;
 474   oop oopObj = jniCheck::validate_handle(thr, obj);
 475   if (oopObj == NULL) {
 476     ReportJNIFatalError(thr, fatal_bad_ref_to_jni);
 477   }
 478   return oopObj;
 479 }
 480 
 481 // Warn if a class descriptor is in decorated form; class descriptors
 482 // passed to JNI findClass should not be decorated unless they are
 483 // array descriptors.
 484 void jniCheck::validate_class_descriptor(JavaThread* thr, const char* name) {
 485   if (name == NULL) return;  // implementation accepts NULL so just return
 486 
 487   size_t len = strlen(name);
 488 
 489   if (len &gt;= 2 &amp;&amp;
<span class="line-modified"> 490       (name[0] == JVM_SIGNATURE_CLASS || name[0] == JVM_SIGNATURE_INLINE_TYPE) &amp;&amp; // &#39;L&#39; or &#39;Q&#39;</span>
 491       name[len-1] == JVM_SIGNATURE_ENDCLASS ) {    // &#39;;&#39;
 492     char msg[JVM_MAXPATHLEN];
 493     jio_snprintf(msg, JVM_MAXPATHLEN, &quot;%s%s%s&quot;,
 494                  warn_bad_class_descriptor1, name, warn_bad_class_descriptor2);
 495     ReportJNIWarning(thr, msg);
 496   }
 497 
 498   // Verify that the class name given is a valid utf8 string
 499   if (!UTF8::is_legal_utf8((const unsigned char*)name, (int)strlen(name), false)) {
 500     char msg[JVM_MAXPATHLEN];
 501     jio_snprintf(msg, JVM_MAXPATHLEN, &quot;%s%s%s&quot;, fatal_non_utf8_class_name1, name, fatal_non_utf8_class_name2);
 502     ReportJNIFatalError(thr, msg);
 503   }
 504 }
 505 
 506 Klass* jniCheck::validate_class(JavaThread* thr, jclass clazz, bool allow_primitive) {
 507   ASSERT_OOPS_ALLOWED;
 508   oop mirror = jniCheck::validate_handle(thr, clazz);
 509   if (mirror == NULL) {
 510     ReportJNIFatalError(thr, fatal_received_null_class);
</pre>
<hr />
<pre>
1619     return result;
1620 JNI_END
1621 
1622 JNI_ENTRY_CHECKED(jobjectArray,
1623   checked_jni_NewObjectArray(JNIEnv *env,
1624                              jsize len,
1625                              jclass clazz,
1626                              jobject init))
1627     functionEnter(thr);
1628     jobjectArray result = UNCHECKED()-&gt;NewObjectArray(env,len,clazz,init);
1629     functionExit(thr);
1630     return result;
1631 JNI_END
1632 
1633 JNI_ENTRY_CHECKED(jobject,
1634   checked_jni_GetObjectArrayElement(JNIEnv *env,
1635                                     jobjectArray array,
1636                                     jsize index))
1637     functionEnter(thr);
1638     IN_VM(
<span class="line-modified">1639       check_is_obj_or_inline_array(thr, array);</span>
1640     )
1641     jobject result = UNCHECKED()-&gt;GetObjectArrayElement(env,array,index);
1642     functionExit(thr);
1643     return result;
1644 JNI_END
1645 
1646 JNI_ENTRY_CHECKED(void,
1647   checked_jni_SetObjectArrayElement(JNIEnv *env,
1648                                     jobjectArray array,
1649                                     jsize index,
1650                                     jobject val))
1651     functionEnter(thr);
1652     IN_VM(
<span class="line-modified">1653       check_is_obj_or_inline_array(thr, array);</span>
1654     )
1655     UNCHECKED()-&gt;SetObjectArrayElement(env,array,index,val);
1656     functionExit(thr);
1657 JNI_END
1658 
1659 #define WRAPPER_NewScalarArray(Return, Result) \
1660 JNI_ENTRY_CHECKED(Return, \
1661   checked_jni_New##Result##Array(JNIEnv *env, \
1662                                  jsize len)) \
1663     functionEnter(thr); \
1664     Return result = UNCHECKED()-&gt;New##Result##Array(env,len); \
1665     functionExit(thr); \
1666     return (Return) result; \
1667 JNI_END
1668 
1669 WRAPPER_NewScalarArray(jbooleanArray, Boolean)
1670 WRAPPER_NewScalarArray(jbyteArray, Byte)
1671 WRAPPER_NewScalarArray(jshortArray, Short)
1672 WRAPPER_NewScalarArray(jcharArray, Char)
1673 WRAPPER_NewScalarArray(jintArray, Int)
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>