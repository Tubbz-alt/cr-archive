<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/classfile/systemDictionary.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="placeholders.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionary.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/systemDictionary.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 491   // The instanceKlass is kept alive because the class loader is on the stack,
 492   // which keeps the loader_data alive, as well as all instanceKlasses in
 493   // the loader_data. parseClassFile adds the instanceKlass to loader_data.
 494   {
 495     MutexLocker mu(THREAD, SystemDictionary_lock);
 496     placeholders()-&gt;find_and_remove(p_index, p_hash, child_name, loader_data, PlaceholderTable::LOAD_SUPER, THREAD);
 497     SystemDictionary_lock-&gt;notify_all();
 498   }
 499   if (HAS_PENDING_EXCEPTION || superk == NULL) {
 500     // can null superk
 501     Klass* k = handle_resolution_exception(super_name, true, superk, THREAD);
 502     assert(k == NULL || k == superk, &quot;must be&quot;);
 503     if (k == NULL) {
 504       superk = NULL;
 505     }
 506   }
 507 
 508   return superk;
 509 }
 510 
<span class="line-modified"> 511 Klass* SystemDictionary::resolve_flattenable_field_or_fail(AllFieldStream* fs,</span>
 512                                                            Handle class_loader,
 513                                                            Handle protection_domain,
 514                                                            bool throw_error,
 515                                                            TRAPS) {
 516   Symbol* class_name = fs-&gt;signature()-&gt;fundamental_name(THREAD);
 517   class_loader = Handle(THREAD, java_lang_ClassLoader::non_reflection_class_loader(class_loader()));
 518   ClassLoaderData* loader_data = class_loader_data(class_loader);
 519   unsigned int p_hash = placeholders()-&gt;compute_hash(class_name);
 520   int p_index = placeholders()-&gt;hash_to_index(p_hash);
 521   bool throw_circularity_error = false;
 522   PlaceholderEntry* oldprobe;
 523 
 524   {
 525     MutexLocker mu(THREAD, SystemDictionary_lock);
 526     oldprobe = placeholders()-&gt;get_entry(p_index, p_hash, class_name, loader_data);
 527     if (oldprobe != NULL &amp;&amp;
<span class="line-modified"> 528       oldprobe-&gt;check_seen_thread(THREAD, PlaceholderTable::FLATTENABLE_FIELD)) {</span>
 529       throw_circularity_error = true;
 530 
 531     } else {
 532       placeholders()-&gt;find_and_add(p_index, p_hash, class_name, loader_data,
<span class="line-modified"> 533                                    PlaceholderTable::FLATTENABLE_FIELD, NULL, THREAD);</span>
 534     }
 535   }
 536 
 537   Klass* klass = NULL;
 538   if (!throw_circularity_error) {
 539     klass = SystemDictionary::resolve_or_fail(class_name, class_loader,
 540                                                protection_domain, true, THREAD);
 541   } else {
 542     ResourceMark rm(THREAD);
 543     THROW_MSG_NULL(vmSymbols::java_lang_ClassCircularityError(), class_name-&gt;as_C_string());
 544   }
 545 
 546   {
 547     MutexLocker mu(THREAD, SystemDictionary_lock);
 548     placeholders()-&gt;find_and_remove(p_index, p_hash, class_name, loader_data,
<span class="line-modified"> 549                                     PlaceholderTable::FLATTENABLE_FIELD, THREAD);</span>
 550   }
 551 
 552   class_name-&gt;decrement_refcount();
 553   return klass;
 554 }
 555 
 556 void SystemDictionary::validate_protection_domain(InstanceKlass* klass,
 557                                                   Handle class_loader,
 558                                                   Handle protection_domain,
 559                                                   TRAPS) {
 560   // Now we have to call back to java to check if the initating class has access
 561   JavaValue result(T_VOID);
 562   LogTarget(Debug, protectiondomain) lt;
 563   if (lt.is_enabled()) {
 564     ResourceMark rm(THREAD);
 565     // Print out trace information
 566     LogStream ls(lt);
 567     ls.print_cr(&quot;Checking package access&quot;);
 568     if (class_loader() != NULL) {
 569       ls.print(&quot;class loader: &quot;);
</pre>
</td>
<td>
<hr />
<pre>
 491   // The instanceKlass is kept alive because the class loader is on the stack,
 492   // which keeps the loader_data alive, as well as all instanceKlasses in
 493   // the loader_data. parseClassFile adds the instanceKlass to loader_data.
 494   {
 495     MutexLocker mu(THREAD, SystemDictionary_lock);
 496     placeholders()-&gt;find_and_remove(p_index, p_hash, child_name, loader_data, PlaceholderTable::LOAD_SUPER, THREAD);
 497     SystemDictionary_lock-&gt;notify_all();
 498   }
 499   if (HAS_PENDING_EXCEPTION || superk == NULL) {
 500     // can null superk
 501     Klass* k = handle_resolution_exception(super_name, true, superk, THREAD);
 502     assert(k == NULL || k == superk, &quot;must be&quot;);
 503     if (k == NULL) {
 504       superk = NULL;
 505     }
 506   }
 507 
 508   return superk;
 509 }
 510 
<span class="line-modified"> 511 Klass* SystemDictionary::resolve_inline_field_or_fail(AllFieldStream* fs,</span>
 512                                                            Handle class_loader,
 513                                                            Handle protection_domain,
 514                                                            bool throw_error,
 515                                                            TRAPS) {
 516   Symbol* class_name = fs-&gt;signature()-&gt;fundamental_name(THREAD);
 517   class_loader = Handle(THREAD, java_lang_ClassLoader::non_reflection_class_loader(class_loader()));
 518   ClassLoaderData* loader_data = class_loader_data(class_loader);
 519   unsigned int p_hash = placeholders()-&gt;compute_hash(class_name);
 520   int p_index = placeholders()-&gt;hash_to_index(p_hash);
 521   bool throw_circularity_error = false;
 522   PlaceholderEntry* oldprobe;
 523 
 524   {
 525     MutexLocker mu(THREAD, SystemDictionary_lock);
 526     oldprobe = placeholders()-&gt;get_entry(p_index, p_hash, class_name, loader_data);
 527     if (oldprobe != NULL &amp;&amp;
<span class="line-modified"> 528       oldprobe-&gt;check_seen_thread(THREAD, PlaceholderTable::INLINE_FIELD)) {</span>
 529       throw_circularity_error = true;
 530 
 531     } else {
 532       placeholders()-&gt;find_and_add(p_index, p_hash, class_name, loader_data,
<span class="line-modified"> 533                                    PlaceholderTable::INLINE_FIELD, NULL, THREAD);</span>
 534     }
 535   }
 536 
 537   Klass* klass = NULL;
 538   if (!throw_circularity_error) {
 539     klass = SystemDictionary::resolve_or_fail(class_name, class_loader,
 540                                                protection_domain, true, THREAD);
 541   } else {
 542     ResourceMark rm(THREAD);
 543     THROW_MSG_NULL(vmSymbols::java_lang_ClassCircularityError(), class_name-&gt;as_C_string());
 544   }
 545 
 546   {
 547     MutexLocker mu(THREAD, SystemDictionary_lock);
 548     placeholders()-&gt;find_and_remove(p_index, p_hash, class_name, loader_data,
<span class="line-modified"> 549                                     PlaceholderTable::INLINE_FIELD, THREAD);</span>
 550   }
 551 
 552   class_name-&gt;decrement_refcount();
 553   return klass;
 554 }
 555 
 556 void SystemDictionary::validate_protection_domain(InstanceKlass* klass,
 557                                                   Handle class_loader,
 558                                                   Handle protection_domain,
 559                                                   TRAPS) {
 560   // Now we have to call back to java to check if the initating class has access
 561   JavaValue result(T_VOID);
 562   LogTarget(Debug, protectiondomain) lt;
 563   if (lt.is_enabled()) {
 564     ResourceMark rm(THREAD);
 565     // Print out trace information
 566     LogStream ls(lt);
 567     ls.print_cr(&quot;Checking package access&quot;);
 568     if (class_loader() != NULL) {
 569       ls.print(&quot;class loader: &quot;);
</pre>
</td>
</tr>
</table>
<center><a href="placeholders.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionary.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>