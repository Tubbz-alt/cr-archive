<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/hotspot/jtreg/runtime/valhalla/valuetypes/TestJNIArrays.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 import jdk.test.lib.Asserts;
 26 
 27 import java.lang.reflect.*;
 28 import java.util.Random;
 29 import java.util.Arrays;
 30 import java.util.Comparator;
 31 
 32 import jdk.internal.misc.Unsafe;
 33 import jdk.internal.vm.jni.SubElementSelector;
 34 
 35 /*
 36  * @test
 37  * @summary Test flattened arrays accesses through JNI
 38  * @modules java.base/jdk.internal.misc java.base/jdk.internal.vm.jni
 39  * @library /testlibrary /test/lib
 40  * @requires (os.simpleArch == &quot;x64&quot;)
 41  * @requires (os.family == &quot;linux&quot; | os.family == &quot;mac&quot;)
 42  * @compile -XDallowWithFieldOperator TestJNIArrays.java
 43  * @run main/othervm/native/timeout=3000 -XX:InlineArrayElemMaxFlatSize=128 -XX:+PrintFlattenableLayouts -XX:+UseCompressedOops TestJNIArrays
 44  * @run main/othervm/native/timeout=3000 -XX:InlineArrayElemMaxFlatSize=128 -XX:+PrintFlattenableLayouts -XX:-UseCompressedOops TestJNIArrays
 45  */
 46 public class TestJNIArrays {
 47 
 48     static final Unsafe U = Unsafe.getUnsafe();
 49 
 50     public static final int ARRAY_SIZE = 1024;
 51     static long seed;
 52     static Random random;
 53 
 54     static {
 55         seed = System.nanoTime();
 56         System.out.println(&quot;Seed = &quot; + seed);
 57         random = new Random(seed);
 58     }
 59 
 60     static {
 61         System.loadLibrary(&quot;TestJNIArrays&quot;);
 62     }
 63 
 64     static inline class IntInt {
 65         int i0;
 66         int i1;
 67 
 68         public IntInt(int i0, int i1) {
 69             this.i0 = i0;
 70             this.i1 = i1;
 71         }
 72     }
 73 
 74     static class IntIntComparator implements Comparator&lt;IntInt.ref&gt; {
 75         public int compare(IntInt.ref a, IntInt.ref b) {
 76             if (a.i0 &lt; b.i0) return -1;
 77             if (a.i0 &gt; b.i0) return 1;
 78             if (a.i1 &lt; b.i1) return -1;
 79             if (a.i1 &gt; b.i1) return 1;
 80             return 0;
 81         }
 82     }
 83 
 84     static inline class Containee {
 85         float f;
 86         short s;
 87 
 88         Containee(float f, short s) {
 89             this.f = f;
 90             this.s = s;
 91         }
 92     }
 93 
 94     static inline class Container {
 95         double d;
 96         Containee c;
 97         byte b;
 98 
 99         Container(double d, Containee c, byte b) {
100             this.d = d ;
101             this.c = c;
102             this.b = b;
103         }
104 
105         Container setc(Containee c) {
106             Container res = __WithField(this.c, c);
107             return res;
108         }
109 
110     }
111 
112     static inline class LongLongLongLong {
113         long l0, l1, l2, l3;
114 
115         public LongLongLongLong(long l0, long l1, long l2, long l3) {
116             this.l0 = l0;
117             this.l1 = l1;
118             this.l2 = l2;
119             this.l3 = l3;
120         }
121     }
122 
123     static inline class BigValue {
124         long l0 = 0, l1 = 0,   l2 = 0, l3 = 0, l4 = 0, l5 = 0, l6 = 0, l7 = 0, l8 = 0, l9 = 0;
125         long l10 = 0, l11 = 0, l12 = 0, l13 = 0, l14 = 0, l15 = 0, l16 = 0, l17 = 0, l18 = 0, l19 = 0;
126         long l20 = 0, l21 = 0, l22 = 0, l23 = 0, l24 = 0, l25 = 0, l26 = 0, l27 = 0, l28 = 0, l29 = 0;
127         long l30 = 0, l31 = 0, l32 = 0, l33 = 0, l34 = 0, l35 = 0, l36 = 0, l37 = 0, l38 = 0, l39 = 0;
128     }
129 
130     static inline class ValueWithOops {
131         String s = &quot;bonjour&quot;;
132         int i = 0;
133         Containee c = new Containee(2.3f, (short)4);
134         BigValue b = new BigValue();
135     }
136 
137     public static void main(String[] args) {
138         TestJNIArrays test = new TestJNIArrays();
139         test.checkGetFlattenedArrayElementSize();
140         test.checkGetFlattenedArrayElementClass();
141         test.checkGetFieldOffsetInFlattenedLayout();
142         test.checkGetFlattenedArrayElements();
143         test.checkSubElementAPI();
144         test.checkBehaviors();
145 
146         // TODO: move these to micro-benchmark or out of tier1 testing...
147         // test.measureInitializationTime(1024 * 1024 * 10 , 1000);
148         // test.measureInitializationTime2(1024 * 1024 * 10 , 1000);
149         // test.measureUpdateTime2(1024 * 1024 * 10, 1000);
150         // test.measureSortingTime(1024 * 1024, 100); // reduced number of iterations because Java sorting is slow (because of generics?)
151         //test.measureInitializationTime3(1024 * 1024 * 2 , 10);
152     }
153 
154     void checkSubElementAPI() {
155         Throwable e = null;
156         ValueWithOops[] arrayWithOops = new ValueWithOops[100];
157         ValueWithOops v = new ValueWithOops();
158         for (int i = 0; i &lt; 100; i++) {
159             arrayWithOops[i] = v;
160         }
161         SubElementSelector selector1 = createSubElementSelector(arrayWithOops);
162         SubElementSelector selector2 = getSubElementSelector(selector1, ValueWithOops.class, &quot;s&quot;, &quot;Ljava/lang/String;&quot;);
163         String s = (String) getObjectSubElement(arrayWithOops, selector2, 1);
164         System.out.println(&quot;s = &quot; + s);
165         Asserts.assertEquals(s.equals(&quot;bonjour&quot;), true, &quot;Wrong string, expecting \&quot;bonjour\&quot;, got &quot; + s);
166         SubElementSelector selector3 = getSubElementSelector(selector1, ValueWithOops.class, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;);
167         Containee c = (Containee) getObjectSubElement(arrayWithOops, selector3, 2);
168         Asserts.assertEquals(c.f, 2.3f, &quot;Wrong float value: &quot; + c.f);
169         Asserts.assertEquals(c.s, (short)4, &quot;Wrong short value &quot; + c.s);
170         setObjectSubElement(arrayWithOops, selector2, 1, &quot;Hello&quot;);
171         Asserts.assertEquals(arrayWithOops[1].s.equals(&quot;Hello&quot;), true, &quot;Wrong string, expecting \&quot;Hello\&quot;, got &quot; + s);
172         Integer myInteger = new Integer(345);
173         e = null;
174         try {
175             setObjectSubElement(arrayWithOops, selector2, 1, myInteger);
176         } catch(Throwable t) {
177             e = t;
178         }
179         Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);
180         Asserts.assertEquals(e.getClass(), java.lang.ArrayStoreException.class, &quot;Wrong exception type&quot;);
181         c = new Containee(9.8f, (short)-3);
182         setObjectSubElement(arrayWithOops, selector3, 2, c);
183         Asserts.assertEquals(c.f, 9.8f, &quot;Wrong float value: &quot; + c.f);
184         Asserts.assertEquals(c.s, (short)-3, &quot;Wrong short value &quot; + c.s);
185         e = null;
186         try {
187             setObjectSubElement(arrayWithOops, selector3, 2, null);
188         } catch(Throwable t) {
189             e = t;
190         }
191         Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);
192         Asserts.assertEquals(e.getClass(), java.lang.ArrayStoreException.class, &quot;Wrong exception type&quot;);
193         SubElementSelector selector4 = getSubElementSelector(selector3, TestJNIArrays.Containee.class, &quot;s&quot;, &quot;S&quot;);
194         short s2 = getShortSubElement(arrayWithOops, selector4, 3);
195         Asserts.assertEquals(s2, (short)4, &quot;Wrong short value &quot; + s2);
196         setShortSubElement(arrayWithOops, selector4, 3, (short)7);
197         Asserts.assertEquals(arrayWithOops[3].c.s, (short)7, &quot;Wrong short value &quot; + arrayWithOops[3].c.s);
198         e = null;
199         try {
200             // should fail because selector4 designates a field with type short, not int
201             getIntSubElement(arrayWithOops, selector4, 3);
202         } catch(Throwable t) {
203             e = t;
204         }
205         Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);
206         Asserts.assertEquals(e.getClass(), java.lang.IllegalArgumentException.class, &quot;Wrong exception type&quot;);
207         SubElementSelector selector5 = getSubElementSelector(selector1, ValueWithOops.class, &quot;b&quot;, &quot;QTestJNIArrays$BigValue;&quot;);
208         e = null;
209         try {
210             // Should fail because selector5 designates a non-flattened field
211             SubElementSelector selector6 = getSubElementSelector(selector5, TestJNIArrays.BigValue.class, &quot;l0&quot;, &quot;J&quot;);
212         } catch(Throwable t) {
213             e = t;
214         }
215         Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);
216         Asserts.assertEquals(e.getClass(), java.lang.IllegalArgumentException.class, &quot;Wrong exception type&quot;);
217         System.gc();
218     }
219 
220     void checkGetFlattenedArrayElementSize() {
221         Throwable exception = null;
222         try {
223             Object o = new Object();
224             GetFlattenedArrayElementSizeWrapper(o);
225         } catch(Throwable t) {
226             exception = t;
227         }
228         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
229         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);
230         exception = null;
231         try {
232             int[] array = new int[16];
233             Object o = array;
234             GetFlattenedArrayElementSizeWrapper(o);
235         } catch(Throwable t) {
236             exception = t;
237         }
238         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
239         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);
240         exception = null;
241         try {
242             GetFlattenedArrayElementSizeWrapper(new String[16]);
243         } catch(Throwable t) {
244             exception = t;
245         }
246         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
247         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);
248         exception = null;
249         try {
250             // Array of BigValue should not be flattened because BigValue is *big*
251             GetFlattenedArrayElementSizeWrapper(new BigValue[16]);
252         } catch(Throwable t) {
253             exception = t;
254         }
255         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
256         Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);
257         exception = null;
258         int size = -1;
259         try {
260             size = GetFlattenedArrayElementSizeWrapper(new IntInt[16]);
261         } catch(Throwable t) {
262             exception = t;
263         }
264         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);
265         Asserts.assertEquals(size, 8, &quot;Wrong size&quot;);
266     }
267 
268     void checkGetFlattenedArrayElementClass() {
269         Throwable exception = null;
270         try {
271             Object o = new Object();
272             GetFlattenedArrayElementClassWrapper(o);
273         } catch(Throwable t) {
274             exception = t;
275         }
276         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
277         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);
278         exception = null;
279         try {
280             int[] array = new int[16];
281             Object o = array;
282             GetFlattenedArrayElementClassWrapper(o);
283         } catch(Throwable t) {
284             exception = t;
285         }
286         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
287         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);
288         exception = null;
289         try {
290             GetFlattenedArrayElementClassWrapper(new String[16]);
291         } catch(Throwable t) {
292             exception = t;
293         }
294         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
295         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);
296         exception = null;
297         try {
298             // Array of BigValue should not be flattened because BigValue is *big*
299             GetFlattenedArrayElementClassWrapper(new BigValue[16]);
300         } catch(Throwable t) {
301             exception = t;
302         }
303         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
304         Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);
305         exception = null;
306         Class c = null;
307         try {
308             c = GetFlattenedArrayElementClassWrapper(new IntInt[16]);
309         } catch(Throwable t) {
310             exception = t;
311         }
312         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);
313         Asserts.assertEquals(c, IntInt.class, &quot;Wrong class&quot;);
314     }
315 
316     void checkGetFieldOffsetInFlattenedLayout() {
317         Throwable exception = null;
318         try {
319             Object o = new Object();
320             GetFieldOffsetInFlattenedLayoutWrapper(o.getClass(), &quot;foo&quot;, &quot;I&quot;, true);
321         } catch(Throwable t) {
322             exception = t;
323         }
324         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
325         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);
326         exception = null;
327         try {
328             int[] array = new int[16];
329             GetFieldOffsetInFlattenedLayoutWrapper(array.getClass(), &quot;foo&quot;, &quot;I&quot;, true);
330         } catch(Throwable t) {
331             exception = t;
332         }
333         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
334         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);
335         exception = null;
336         try {
337             String[] array = new String[16];
338             GetFieldOffsetInFlattenedLayoutWrapper(array.getClass(), &quot;foo&quot;, &quot;I&quot;, true);
339         } catch(Throwable t) {
340             exception = t;
341         }
342         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
343         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);
344         exception = null;
345         Containee ce  = new Containee(3.4f, (short)5);
346         Container c = new Container(123.876, ce, (byte)7);
347         Class&lt;?&gt; cclass = c.getClass();
348         Container[] containerArray = new Container[32];
349         int elementSize = GetFlattenedArrayElementSizeWrapper(containerArray);
350         int offset = -1;
351         try {
352             offset = GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;d&quot;, &quot;D&quot;, false);
353         } catch(Throwable t) {
354             exception = t;
355         }
356         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);
357         Field f = null;
358         try {
359             f = cclass.getDeclaredField(&quot;d&quot;);
360         } catch(NoSuchFieldException e) {
361             e.printStackTrace();
362             return;
363         }
364         Asserts.assertEquals(U.valueHeaderSize(cclass) + offset, U.objectFieldOffset(cclass, f.getName()),
365                              &quot;Incorrect offset&quot;);
366         Asserts.assertLessThan(offset, elementSize, &quot;Invalid offset&quot;);
367         exception = null;
368         try {
369             // Field c should be flattened, so last argument is true, no exception expected
370             GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;, true);
371         } catch(Throwable t) {
372             exception = t;
373         }
374         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);
375         Asserts.assertLessThan(offset, elementSize, &quot;Invalid offset&quot;);
376         exception = null;
377         try {
378             // Field c should be flattened, with last argument being false, exception expected from the wrapper
379             GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;, false);
380         } catch(Throwable t) {
381             exception = t;
382         }
383         Asserts.assertNotNull(exception, &quot;Wrapper should have thrown a RuntimeException&quot;);
384         Asserts.assertEquals(exception.getClass(), RuntimeException.class , &quot;Wrong exception type&quot;);
385     }
386 
387     void checkGetFlattenedArrayElements() {
388         Throwable exception = null;
389         Object o = new Object();
390         try {
391             GetFlattenedArrayElementsWrapper(o);
392         } catch(Throwable t) {
393             exception = t;
394         }
395         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
396         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);
397         exception = null;
398         int[] a1 = new int[16];
399         o = a1;
400         try {
401             GetFlattenedArrayElementsWrapper(o);
402         } catch(Throwable t) {
403             exception = t;
404         }
405         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
406         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);
407         exception = null;
408         try {
409             GetFlattenedArrayElementsWrapper(new String[16]);
410         } catch(Throwable t) {
411             exception = t;
412         }
413         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
414         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);
415         exception = null;
416         try {
417             // Array of BigValue should not be flattened because BigValue is *big*
418             GetFlattenedArrayElementsWrapper(new BigValue[16]);
419         } catch(Throwable t) {
420             exception = t;
421         }
422         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
423         Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);
424         exception = null;
425         try {
426             // Direct native access to flattened arrays is not allowed if elements contain oops
427             GetFlattenedArrayElementsWrapper(new ValueWithOops[16]);
428         } catch(Throwable t) {
429             exception = t;
430         }
431         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);
432         Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);
433         exception = null;
434         long addr = 0;
435         IntInt[] a2 = new IntInt[16];
436         try {
437             addr = GetFlattenedArrayElementsWrapper(a2);
438         } catch(Throwable t) {
439             exception = t;
440         }
441         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);
442         if (exception == null) {
443             ReleaseFlattenedArrayElementsWrapper(a2, addr, 0);
444         }
445     }
446 
447     void checkBehaviors() {
448         System.out.println(&quot;Check 1&quot;);
449         IntInt[] array = new IntInt[ARRAY_SIZE];
450         int value = getIntFieldAtIndex(array, 1, &quot;i0&quot;, &quot;I&quot;);
451         Asserts.assertEquals(value, 0, &quot;Initial value must be zero&quot;);
452         printArrayInformation(array);
453         int i0_value = 42;
454         int i1_value = -314;
455         initializeIntIntArrayBuffer(array, i0_value, i1_value);
456         System.gc();
457         for (int i = 0; i &lt; array.length; i++) {
458             Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);
459             Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);
460         }
461         System.out.println(&quot;Check 2&quot;);
462         array = new IntInt[ARRAY_SIZE];
463         i0_value = -194;
464         i1_value = 91;
465         initializeIntIntArrayFields(array, i0_value, i1_value);
466         System.gc();
467         for (int i = 0; i &lt; array.length; i++) {
468             Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);
469             Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);
470         }
471         System.out.println(&quot;Check 3&quot;);
472         array = new IntInt[ARRAY_SIZE];
473         initializeIntIntArrayJava(array, i0_value, i1_value);
474         System.gc();
475         for (int i = 0; i &lt; array.length; i++) {
476             Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);
477             Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);
478         }
479         System.out.println(&quot;Check 4&quot;);
480         random = new Random(seed);
481         array = new IntInt[ARRAY_SIZE];
482         for (int i = 0; i &lt; ARRAY_SIZE; i++) {
483             array[i] = new IntInt(random.nextInt(), random.nextInt());
484         }
485         sortIntIntArray(array);
486         System.gc();
487         for (int i = 0; i &lt; array.length - 1; i++) {
488             Asserts.assertLessThanOrEqual(array[i].i0, array[i+1].i0, &quot;Incorrect i0 fields ordering at index &quot; + i);
489             if (array[i].i0 == array[i+1].i0) {
490                 Asserts.assertLessThanOrEqual(array[i].i1, array[i+1].i1, &quot;Incorrect i1 fields ordering at index &quot; + i);
491             }
492         }
493         System.out.println(&quot;Check 5&quot;);
494         random = new Random(seed);
495         array = new IntInt[ARRAY_SIZE];
496         for (int i = 0; i &lt; ARRAY_SIZE; i++) {
497             array[i] = new IntInt(random.nextInt(), random.nextInt());
498         }
499         Arrays.sort(array, new IntIntComparator());
500         System.gc();
501         for (int i = 0; i &lt; array.length - 1; i++) {
502             Asserts.assertLessThanOrEqual(array[i].i0, array[i+1].i0, &quot;Incorrect i0 fields ordering at index &quot; + i);
503             if (array[i].i0 == array[i+1].i0) {
504                 Asserts.assertLessThanOrEqual(array[i].i1, array[i+1].i1, &quot;Incorrect i1 fields ordering at index &quot; + i);
505             }
506         }
507         System.out.println(&quot;Check 6&quot;);
508         Container[] array2 = new Container[ARRAY_SIZE];
509         double d  = 1.23456789;
510         float f = -987.654321f;
511         short s = -512;
512         byte b = 127;
513         Containee c = new Containee(f,s);
514         Container c2 = new Container(d, c, b);
515         initializeContainerArray(array2, d, f, s, b);
516         System.gc();
517         for (int i = 0; i &lt; array2.length; i++) {
518             Asserts.assertEquals(array2[i], c2, &quot;Incorrect value at index &quot; + i);
519             Asserts.assertEquals(array2[i].d, d, &quot;Incorrect d value at index &quot; + i);
520             Asserts.assertEquals(array2[i].c.f, f, &quot;Incorrect f value at index &quot; + i);
521             Asserts.assertEquals(array2[i].c.s, s, &quot;Incorrect s value at index &quot; + i);
522             Asserts.assertEquals(array2[i].b, b, &quot;Incorrect b value at inde &quot; +i);
523         }
524         System.out.println(&quot;Check 7&quot;);
525         f = 19.2837465f;
526         s = 231;
527         updateContainerArray(array2, f, s);
528         System.gc();
529         for (int i = 0; i &lt; array2.length; i++) {
530             Asserts.assertEquals(array2[i].d, d, &quot;Incorrect d value at index &quot; + i);
531             Asserts.assertEquals(array2[i].c.f, f, &quot;Incorrect f value at index &quot; + i);
532             Asserts.assertEquals(array2[i].c.s, s, &quot;Incorrect s value at index &quot; + i);
533             Asserts.assertEquals(array2[i].b, b, &quot;Incorrect b value at inde &quot; +i);
534         }
535         System.out.println(&quot;Check 8&quot;);
536         long l0 = 52467923;
537         long l1= -7854022;
538         long l2 = 230947485;
539         long l3 = -752497024;
540         LongLongLongLong[] array3 = new LongLongLongLong[ARRAY_SIZE/8];
541         initializeLongLongLongLongArray(array3, l0, l1, l2, l3);
542         System.gc();
543         for (int i = 0; i &lt; array3.length; i++) {
544             Asserts.assertEquals(array3[i].l0, l0, &quot;Bad value of l0 at index &quot; + i);
545             Asserts.assertEquals(array3[i].l1, l1, &quot;Bad value of l1 at index &quot; + i);
546             Asserts.assertEquals(array3[i].l2, l2, &quot;Bad value of l2 at index &quot; + i);
547             Asserts.assertEquals(array3[i].l3, l3, &quot;Bad value of l3 at index &quot; + i);
548         }
549     }
550 
551     void initializeIntIntArrayJava(IntInt[] array, int i0, int i1) {
552         IntInt ii = new IntInt(i0, i1);
553         for (int i = 0; i &lt; array.length; i++) {
554             array[i] = ii;
555         }
556     }
557 
558     void initializeContainerArrayJava(Container[] array, double d, float f, short s, byte b) {
559         Containee c = new Containee(f,s);
560         Container c2 = new Container(d, c, b);
561         for (int i = 0; i &lt; array.length; i++) {
562             array[i] = c2;
563         }
564     }
565 
566     void updateContainerArrayJava(Container[] array, float f, short s) {
567         Containee c = new Containee(f, s);
568         for (int i = 0; i &lt; array.length; i++) {
569             array[i] = array[i].setc(c);;
570         }
571     }
572 
573     void initializeLongLongLongLongArrayJava(LongLongLongLong[] array, long l0, long l1, long l2, long l3) {
574         LongLongLongLong llll = new LongLongLongLong(l0, l1, l2, l3);
575         for (int i = 0; i &lt; array.length; i++) {
576             array[i] = llll;
577         }
578     }
579 
580     void measureInitializationTime(int array_size, int iterations) {
581         System.out.println(&quot;\nInitialization time for IntInt[]:&quot;);
582         long[] start = new long[iterations];
583         long[] end = new long[iterations];
584 
585 
586         System.out.println(&quot;\nJava:&quot;);
587         // Warmup
588         for (int i = 0; i &lt; 10; i++) {
589             IntInt[] array = new IntInt[array_size];
590             initializeIntIntArrayJava(array, 42, -314);
591         }
592         // Measure
593         for (int i = 0; i &lt; iterations; i++) {
594             IntInt[] array = new IntInt[array_size];
595             start[i] = System.nanoTime();
596             initializeIntIntArrayJava(array, 42, -314);
597             end[i] = System.nanoTime();
598         }
599         // Results
600         computeStatistics(start, end);
601 
602         System.out.println(&quot;\nNative(memcpy):&quot;);
603         // Warmup
604         for (int i = 0; i &lt; 10; i++) {
605             IntInt[] array = new IntInt[array_size];
606             initializeIntIntArrayBuffer(array, 42, -314);
607         }
608         // Measure
609         for (int i = 0; i &lt; iterations; i++) {
610             IntInt[] array = new IntInt[array_size];
611             start[i] = System.nanoTime();
612             initializeIntIntArrayBuffer(array, 42, -314);
613             end[i] = System.nanoTime();
614         }
615         // Results
616         computeStatistics(start, end);
617 
618 
619         System.out.println(&quot;\nNative(fields):&quot;);
620         // Warmup
621         for (int i = 0; i &lt; 10; i++) {
622             IntInt[] array = new IntInt[array_size];
623             initializeIntIntArrayFields(array, 42, -314);
624         }
625         // Measure
626         for (int i = 0; i &lt; iterations; i++) {
627             IntInt[] array = new IntInt[array_size];
628             start[i] = System.nanoTime();
629             initializeIntIntArrayFields(array, 42, -314);
630             end[i] = System.nanoTime();
631         }
632         // Results
633         computeStatistics(start, end);
634     }
635 
636     void measureInitializationTime2(int array_size, int iterations) {
637         System.out.println(&quot;\nInitialization time for Container[]:&quot;);
638         long[] start = new long[iterations];
639         long[] end = new long[iterations];
640 
641         double d = 0.369852147;
642         float f = -321.654987f;
643         short s = -3579;
644         byte b = 42;
645 
646         System.out.println(&quot;\nJava:&quot;);
647         // Warmup
648         for (int i = 0; i &lt; 10; i++) {
649             Container[] array = new Container[array_size];
650             initializeContainerArrayJava(array, d, f, s, b);
651         }
652         // Measure
653         for (int i = 0; i &lt; iterations; i++) {
654             Container[] array = new Container[array_size];
655             start[i] = System.nanoTime();
656             initializeContainerArrayJava(array, d, f, s, b);
657             end[i] = System.nanoTime();
658         }
659         // Results
660         computeStatistics(start, end);
661 
662         System.out.println(&quot;\nNative:&quot;);
663         // Warmup
664         for (int i = 0; i &lt; 10; i++) {
665             Container[] array = new Container[array_size];
666             initializeContainerArray(array, d, f, s, b);
667         }
668         // Measure
669         for (int i = 0; i &lt; iterations; i++) {
670             Container[] array = new Container[array_size];
671             start[i] = System.nanoTime();
672             initializeContainerArray(array, d, f, s, b);
673             end[i] = System.nanoTime();
674         }
675         // Results
676         computeStatistics(start, end);
677     }
678 
679     void measureUpdateTime2(int array_size, int iterations) {
680         System.out.println(&quot;\nUpdating Container[]:&quot;);
681         long[] start = new long[iterations];
682         long[] end = new long[iterations];
683 
684         double d = 0.369852147;
685         float f = -321.654987f;
686         short s = -3579;
687         byte b = 42;
688 
689         Containee c = new Containee(f,s);
690         Container c2 = new Container(d, c, b);
691 
692         System.out.println(&quot;\nJava:&quot;);
693         // Warmup
694         for (int i = 0; i &lt; 10; i++) {
695             Container[] array = new Container[array_size];
696             for (int j = 0; j &lt; array.length; j++) {
697                 array[j] = c2;
698             }
699             updateContainerArrayJava(array, f, s);
700         }
701         // Measure
702         for (int i = 0; i &lt; iterations; i++) {
703             Container[] array = new Container[array_size];
704             for (int j = 0; j &lt; array.length; j++) {
705                 array[i] = c2;
706             }
707             start[i] = System.nanoTime();
708             updateContainerArrayJava(array, f, s);
709             end[i] = System.nanoTime();
710         }
711         // Results
712         computeStatistics(start, end);
713 
714         System.out.println(&quot;\nNative:&quot;);
715         // Warmup
716         for (int i = 0; i &lt; 10; i++) {
717             Container[] array = new Container[array_size];
718             for (int j = 0; j &lt; array.length; j++) {
719                 array[i] = c2;
720             }
721             updateContainerArray(array, f, s);
722         }
723         // Measure
724         for (int i = 0; i &lt; iterations; i++) {
725             Container[] array = new Container[array_size];
726             for (int j = 0; j &lt; array.length; j++) {
727                 array[i] = c2;
728             }
729             start[i] = System.nanoTime();
730             updateContainerArray(array, f, s);
731             end[i] = System.nanoTime();
732         }
733         // Results
734         computeStatistics(start, end);
735     }
736 
737     void measureSortingTime(int array_size, int iterations) {
738         System.out.println(&quot;\nSorting time:&quot;);
739         long[] start = new long[iterations];
740         long[] end = new long[iterations];
741 
742         random = new Random(seed);
743         System.out.println(&quot;\nJava:&quot;);
744         IntIntComparator comparator = new IntIntComparator();
745         // Warmup
746         for (int i = 0; i &lt; 10; i++) {
747             IntInt[] array = new IntInt[array_size];
748             array = new IntInt[array_size];
749             for (int j = 0; j &lt; array_size; j++) {
750                 array[j] = new IntInt(random.nextInt(), random.nextInt());
751             }
752             Arrays.sort(array, comparator);
753         }
754         // Measure
755         for (int i = 0; i &lt; iterations; i++) {
756             IntInt[] array = new IntInt[array_size];
757             for (int j = 0; j &lt; array_size; j++) {
758                 array[j] = new IntInt(random.nextInt(), random.nextInt());
759             }
760             start[i] = System.nanoTime();
761             Arrays.sort(array, comparator);
762             end[i] = System.nanoTime();
763         }
764         // Results
765         computeStatistics(start, end);
766 
767         random = new Random(seed);
768         System.out.println(&quot;\nNative:&quot;);
769         // Warmup
770         for (int i = 0; i &lt; 10; i++) {
771             IntInt[] array = new IntInt[array_size];
772             array = new IntInt[array_size];
773             for (int j = 0; j &lt; array_size; j++) {
774                 array[j] = new IntInt(random.nextInt(), random.nextInt());
775             }
776             sortIntIntArray(array);
777         }
778         // Measure
779         for (int i = 0; i &lt; iterations; i++) {
780             IntInt[] array = new IntInt[array_size];
781             for (int j = 0; j &lt; array_size; j++) {
782                 array[j] = new IntInt(random.nextInt(), random.nextInt());
783             }
784             start[i] = System.nanoTime();
785             sortIntIntArray(array);
786             end[i] = System.nanoTime();
787         }
788         // Results
789         computeStatistics(start, end);
790     }
791 
792 
793     void measureInitializationTime3(int array_size, int iterations) {
794         System.out.println(&quot;\nInitialization time for LongLongLongLong[]:&quot;);
795         long[] start = new long[iterations];
796         long[] end = new long[iterations];
797 
798         long l0 = 123456;
799         long l1 = -987654;
800         long l2 = 192837;
801         long l3 = -56473829;
802 
803         System.out.println(&quot;\nJava:&quot;);
804         // Warmup
805         for (int i = 0; i &lt; 10; i++) {
806             LongLongLongLong[] array = new LongLongLongLong[array_size];
807             initializeLongLongLongLongArrayJava(array, l0, l1, l2, l3);
808         }
809         // Measure
810         for (int i = 0; i &lt; iterations; i++) {
811             LongLongLongLong[] array = new LongLongLongLong[array_size];
812             start[i] = System.nanoTime();
813             initializeLongLongLongLongArrayJava(array, l0, l1, l2, l3);
814             end[i] = System.nanoTime();
815         }
816         // Results
817         computeStatistics(start, end);
818 
819         System.out.println(&quot;\nNative:&quot;);
820         // Warmup
821         for (int i = 0; i &lt; 10; i++) {
822             LongLongLongLong[] array = new LongLongLongLong[array_size];
823             initializeLongLongLongLongArray(array, l0, l1, l2, l3);
824         }
825         // Measure
826         for (int i = 0; i &lt; iterations; i++) {
827             LongLongLongLong[] array = new LongLongLongLong[array_size];
828             start[i] = System.nanoTime();
829             initializeLongLongLongLongArray(array, l0, l1, l2, l3);
830             end[i] = System.nanoTime();
831         }
832         // Results
833         computeStatistics(start, end);
834     }
835 
836     void computeStatistics(long[] start, long[] end) {
837         int iterations = start.length;
838         long[] duration = new long[iterations];
839         long sum = 0;
840         long min = end[0] - start[0];
841         long max = min;
842         double var = 0.0;
843         for (int i = 0 ; i &lt; iterations; i++) {
844             duration[i] = end[i] - start[i];
845             if (duration[i] &lt; min) min = duration[i];
846             if (duration[i] &gt; max) max = duration[i];
847             sum += duration[i];
848             double d = (double) duration[i];
849             var += Math.pow(d, 2);
850         }
851         double avg = (sum/iterations) / 1000;
852         double std = (Math.sqrt(var/iterations - Math.pow(sum/iterations, 2))) / 1000;
853         System.out.println(String.format(&quot;Avg: %8.2f us&quot;, avg));
854         System.out.println(String.format(&quot;Std: %8.2f us&quot;, std));
855         System.out.println(String.format(&quot;Min: %8d us&quot;, (min/1000)));
856         System.out.println(String.format(&quot;Max: %8d us&quot;, (max/1000)));
857     }
858 
859     native int GetFlattenedArrayElementSizeWrapper(Object array);
860     native Class GetFlattenedArrayElementClassWrapper(Object array);
861     native long GetFlattenedArrayElementsWrapper(Object array);
862     native void ReleaseFlattenedArrayElementsWrapper(Object array, long addr,int mode);
863     native int GetFieldOffsetInFlattenedLayoutWrapper(Class klass, String name, String signature, boolean flattened);
864 
865     native int getIntFieldAtIndex(Object[] array, int index, String fieldName, String FieldSignature);
866     native void printArrayInformation(Object[] array);
867 
868     native void initializeIntIntArrayBuffer(Object[] array, int i0, int i1);
869     native void initializeIntIntArrayFields(Object[] array, int i0, int i1);
870     native void sortIntIntArray(Object[] array);
871 
872     native void initializeContainerArray(Object[] array, double d, float f, short s, byte b);
873     native void updateContainerArray(Object[] array, float f, short s);
874 
875     native void initializeLongLongLongLongArray(Object[] array, long l0, long l1, long l2, long l3);
876 
877     native SubElementSelector createSubElementSelector(Object[] array);
878     native SubElementSelector getSubElementSelector(SubElementSelector selector, Class&lt;?&gt; klass, String name, String signature);
879     native Object getObjectSubElement(Object[] array, SubElementSelector selector, int index);
880     native void setObjectSubElement(Object[] array, SubElementSelector selector, int index, Object value);
881 
882     native short getShortSubElement(Object[] array, SubElementSelector selector, int index);
883     native void setShortSubElement(Object[] array, SubElementSelector selector, int index, short value);
884     native int getIntSubElement(Object[] array, SubElementSelector selector, int index);
885     native void setIntSubElement(Object[] array, SubElementSelector selector, int index, int value);
886 }
    </pre>
  </body>
</html>