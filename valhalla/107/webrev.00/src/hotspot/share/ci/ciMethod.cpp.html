<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/ci/ciMethod.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;ci/ciCallProfile.hpp&quot;
  27 #include &quot;ci/ciExceptionHandler.hpp&quot;
  28 #include &quot;ci/ciInstanceKlass.hpp&quot;
  29 #include &quot;ci/ciMethod.hpp&quot;
  30 #include &quot;ci/ciMethodBlocks.hpp&quot;
  31 #include &quot;ci/ciMethodData.hpp&quot;
  32 #include &quot;ci/ciStreams.hpp&quot;
  33 #include &quot;ci/ciSymbol.hpp&quot;
  34 #include &quot;ci/ciReplay.hpp&quot;
  35 #include &quot;ci/ciUtilities.inline.hpp&quot;
  36 #include &quot;classfile/systemDictionary.hpp&quot;
  37 #include &quot;compiler/abstractCompiler.hpp&quot;
  38 #include &quot;compiler/methodLiveness.hpp&quot;
  39 #include &quot;interpreter/interpreter.hpp&quot;
  40 #include &quot;interpreter/linkResolver.hpp&quot;
  41 #include &quot;interpreter/oopMapCache.hpp&quot;
  42 #include &quot;memory/allocation.inline.hpp&quot;
  43 #include &quot;memory/resourceArea.hpp&quot;
  44 #include &quot;oops/generateOopMap.hpp&quot;
  45 #include &quot;oops/method.inline.hpp&quot;
  46 #include &quot;oops/oop.inline.hpp&quot;
  47 #include &quot;prims/nativeLookup.hpp&quot;
  48 #include &quot;runtime/deoptimization.hpp&quot;
  49 #include &quot;runtime/handles.inline.hpp&quot;
  50 #include &quot;runtime/sharedRuntime.hpp&quot;
  51 #include &quot;utilities/bitMap.inline.hpp&quot;
  52 #include &quot;utilities/xmlstream.hpp&quot;
  53 #ifdef COMPILER2
  54 #include &quot;ci/bcEscapeAnalyzer.hpp&quot;
  55 #include &quot;ci/ciTypeFlow.hpp&quot;
  56 #include &quot;oops/method.hpp&quot;
  57 #endif
  58 
  59 // ciMethod
  60 //
  61 // This class represents a Method* in the HotSpot virtual
  62 // machine.
  63 
  64 
  65 // ------------------------------------------------------------------
  66 // ciMethod::ciMethod
  67 //
  68 // Loaded method.
  69 ciMethod::ciMethod(const methodHandle&amp; h_m, ciInstanceKlass* holder) :
  70   ciMetadata(h_m()),
  71   _holder(holder)
  72 {
  73   assert(h_m() != NULL, &quot;no null method&quot;);
  74 
  75   if (LogTouchedMethods) {
  76     h_m-&gt;log_touched(Thread::current());
  77   }
  78   // These fields are always filled in in loaded methods.
  79   _flags = ciFlags(h_m-&gt;access_flags());
  80 
  81   // Easy to compute, so fill them in now.
  82   _max_stack          = h_m-&gt;max_stack();
  83   _max_locals         = h_m-&gt;max_locals();
  84   _code_size          = h_m-&gt;code_size();
  85   _intrinsic_id       = h_m-&gt;intrinsic_id();
  86   _handler_count      = h_m-&gt;exception_table_length();
  87   _size_of_parameters = h_m-&gt;size_of_parameters();
  88   _uses_monitors      = h_m-&gt;access_flags().has_monitor_bytecodes();
  89   _balanced_monitors  = !_uses_monitors || h_m-&gt;access_flags().is_monitor_matching();
  90   _is_c1_compilable   = !h_m-&gt;is_not_c1_compilable();
  91   _is_c2_compilable   = !h_m-&gt;is_not_c2_compilable();
  92   _can_be_parsed      = true;
  93   _has_reserved_stack_access = h_m-&gt;has_reserved_stack_access();
  94   _is_overpass        = h_m-&gt;is_overpass();
  95   // Lazy fields, filled in on demand.  Require allocation.
  96   _code               = NULL;
  97   _exception_handlers = NULL;
  98   _liveness           = NULL;
  99   _method_blocks = NULL;
 100 #if defined(COMPILER2)
 101   _flow               = NULL;
 102   _bcea               = NULL;
 103 #endif // COMPILER2
 104 
 105   ciEnv *env = CURRENT_ENV;
 106   if (env-&gt;jvmti_can_hotswap_or_post_breakpoint()) {
 107     // 6328518 check hotswap conditions under the right lock.
 108     MutexLocker locker(Compile_lock);
 109     if (Dependencies::check_evol_method(h_m()) != NULL) {
 110       _is_c1_compilable = false;
 111       _is_c2_compilable = false;
 112       _can_be_parsed = false;
 113     }
 114   } else {
 115     DEBUG_ONLY(CompilerThread::current()-&gt;check_possible_safepoint());
 116   }
 117 
 118   if (h_m-&gt;method_holder()-&gt;is_linked()) {
 119     _can_be_statically_bound = h_m-&gt;can_be_statically_bound();
 120   } else {
 121     // Have to use a conservative value in this case.
 122     _can_be_statically_bound = false;
 123   }
 124 
 125   // Adjust the definition of this condition to be more useful:
 126   // %%% take these conditions into account in vtable generation
 127   if (!_can_be_statically_bound &amp;&amp; h_m-&gt;is_private())
 128     _can_be_statically_bound = true;
 129   if (_can_be_statically_bound &amp;&amp; h_m-&gt;is_abstract())
 130     _can_be_statically_bound = false;
 131 
 132   // generating _signature may allow GC and therefore move m.
 133   // These fields are always filled in.
 134   _name = env-&gt;get_symbol(h_m-&gt;name());
 135   ciSymbol* sig_symbol = env-&gt;get_symbol(h_m-&gt;signature());
 136   constantPoolHandle cpool(Thread::current(), h_m-&gt;constants());
 137   _signature = new (env-&gt;arena()) ciSignature(_holder, cpool, sig_symbol);
 138   _method_data = NULL;
 139   _nmethod_age = h_m-&gt;nmethod_age();
 140   // Take a snapshot of these values, so they will be commensurate with the MDO.
 141   if (ProfileInterpreter || TieredCompilation) {
 142     int invcnt = h_m-&gt;interpreter_invocation_count();
 143     // if the value overflowed report it as max int
 144     _interpreter_invocation_count = invcnt &lt; 0 ? max_jint : invcnt ;
 145     _interpreter_throwout_count   = h_m-&gt;interpreter_throwout_count();
 146   } else {
 147     _interpreter_invocation_count = 0;
 148     _interpreter_throwout_count = 0;
 149   }
 150   if (_interpreter_invocation_count == 0)
 151     _interpreter_invocation_count = 1;
 152   _instructions_size = -1;
 153 #ifdef ASSERT
 154   if (ReplayCompiles) {
 155     ciReplay::initialize(this);
 156   }
 157 #endif
 158 }
 159 
 160 
 161 // ------------------------------------------------------------------
 162 // ciMethod::ciMethod
 163 //
 164 // Unloaded method.
 165 ciMethod::ciMethod(ciInstanceKlass* holder,
 166                    ciSymbol*        name,
 167                    ciSymbol*        signature,
 168                    ciInstanceKlass* accessor) :
 169   ciMetadata((Metadata*)NULL),
 170   _name(                   name),
 171   _holder(                 holder),
 172   _method_data(            NULL),
 173   _method_blocks(          NULL),
 174   _intrinsic_id(           vmIntrinsics::_none),
 175   _instructions_size(-1),
 176   _can_be_statically_bound(false),
 177   _liveness(               NULL)
 178 #if defined(COMPILER2)
 179   ,
 180   _flow(                   NULL),
 181   _bcea(                   NULL)
 182 #endif // COMPILER2
 183 {
 184   // Usually holder and accessor are the same type but in some cases
 185   // the holder has the wrong class loader (e.g. invokedynamic call
 186   // sites) so we pass the accessor.
 187   _signature = new (CURRENT_ENV-&gt;arena()) ciSignature(accessor, constantPoolHandle(), signature);
 188 }
 189 
 190 
 191 // ------------------------------------------------------------------
 192 // ciMethod::load_code
 193 //
 194 // Load the bytecodes and exception handler table for this method.
 195 void ciMethod::load_code() {
 196   VM_ENTRY_MARK;
 197   assert(is_loaded(), &quot;only loaded methods have code&quot;);
 198 
 199   Method* me = get_Method();
 200   Arena* arena = CURRENT_THREAD_ENV-&gt;arena();
 201 
 202   // Load the bytecodes.
 203   _code = (address)arena-&gt;Amalloc(code_size());
 204   memcpy(_code, me-&gt;code_base(), code_size());
 205 
 206 #if INCLUDE_JVMTI
 207   // Revert any breakpoint bytecodes in ci&#39;s copy
 208   if (me-&gt;number_of_breakpoints() &gt; 0) {
 209     BreakpointInfo* bp = me-&gt;method_holder()-&gt;breakpoints();
 210     for (; bp != NULL; bp = bp-&gt;next()) {
 211       if (bp-&gt;match(me)) {
 212         code_at_put(bp-&gt;bci(), bp-&gt;orig_bytecode());
 213       }
 214     }
 215   }
 216 #endif
 217 
 218   // And load the exception table.
 219   ExceptionTable exc_table(me);
 220 
 221   // Allocate one extra spot in our list of exceptions.  This
 222   // last entry will be used to represent the possibility that
 223   // an exception escapes the method.  See ciExceptionHandlerStream
 224   // for details.
 225   _exception_handlers =
 226     (ciExceptionHandler**)arena-&gt;Amalloc(sizeof(ciExceptionHandler*)
 227                                          * (_handler_count + 1));
 228   if (_handler_count &gt; 0) {
 229     for (int i=0; i&lt;_handler_count; i++) {
 230       _exception_handlers[i] = new (arena) ciExceptionHandler(
 231                                 holder(),
 232             /* start    */      exc_table.start_pc(i),
 233             /* limit    */      exc_table.end_pc(i),
 234             /* goto pc  */      exc_table.handler_pc(i),
 235             /* cp index */      exc_table.catch_type_index(i));
 236     }
 237   }
 238 
 239   // Put an entry at the end of our list to represent the possibility
 240   // of exceptional exit.
 241   _exception_handlers[_handler_count] =
 242     new (arena) ciExceptionHandler(holder(), 0, code_size(), -1, 0);
 243 
 244   if (CIPrintMethodCodes) {
 245     print_codes();
 246   }
 247 }
 248 
 249 
 250 // ------------------------------------------------------------------
 251 // ciMethod::has_linenumber_table
 252 //
 253 // length unknown until decompression
 254 bool    ciMethod::has_linenumber_table() const {
 255   check_is_loaded();
 256   VM_ENTRY_MARK;
 257   return get_Method()-&gt;has_linenumber_table();
 258 }
 259 
 260 
 261 // ------------------------------------------------------------------
 262 // ciMethod::compressed_linenumber_table
 263 u_char* ciMethod::compressed_linenumber_table() const {
 264   check_is_loaded();
 265   VM_ENTRY_MARK;
 266   return get_Method()-&gt;compressed_linenumber_table();
 267 }
 268 
 269 
 270 // ------------------------------------------------------------------
 271 // ciMethod::line_number_from_bci
 272 int ciMethod::line_number_from_bci(int bci) const {
 273   check_is_loaded();
 274   VM_ENTRY_MARK;
 275   return get_Method()-&gt;line_number_from_bci(bci);
 276 }
 277 
 278 
 279 // ------------------------------------------------------------------
 280 // ciMethod::vtable_index
 281 //
 282 // Get the position of this method&#39;s entry in the vtable, if any.
 283 int ciMethod::vtable_index() {
 284   check_is_loaded();
 285   assert(holder()-&gt;is_linked(), &quot;must be linked&quot;);
 286   VM_ENTRY_MARK;
 287   return get_Method()-&gt;vtable_index();
 288 }
 289 
 290 
 291 // ------------------------------------------------------------------
 292 // ciMethod::native_entry
 293 //
 294 // Get the address of this method&#39;s native code, if any.
 295 address ciMethod::native_entry() {
 296   check_is_loaded();
 297   assert(flags().is_native(), &quot;must be native method&quot;);
 298   VM_ENTRY_MARK;
 299   Method* method = get_Method();
 300   address entry = method-&gt;native_function();
 301   assert(entry != NULL, &quot;must be valid entry point&quot;);
 302   return entry;
 303 }
 304 
 305 
 306 // ------------------------------------------------------------------
 307 // ciMethod::interpreter_entry
 308 //
 309 // Get the entry point for running this method in the interpreter.
 310 address ciMethod::interpreter_entry() {
 311   check_is_loaded();
 312   VM_ENTRY_MARK;
 313   methodHandle mh(THREAD, get_Method());
 314   return Interpreter::entry_for_method(mh);
 315 }
 316 
 317 
 318 // ------------------------------------------------------------------
 319 // ciMethod::uses_balanced_monitors
 320 //
 321 // Does this method use monitors in a strict stack-disciplined manner?
 322 bool ciMethod::has_balanced_monitors() {
 323   check_is_loaded();
 324   if (_balanced_monitors) return true;
 325 
 326   // Analyze the method to see if monitors are used properly.
 327   VM_ENTRY_MARK;
 328   methodHandle method(THREAD, get_Method());
 329   assert(method-&gt;has_monitor_bytecodes(), &quot;should have checked this&quot;);
 330 
 331   // Check to see if a previous compilation computed the
 332   // monitor-matching analysis.
 333   if (method-&gt;guaranteed_monitor_matching()) {
 334     _balanced_monitors = true;
 335     return true;
 336   }
 337 
 338   {
 339     EXCEPTION_MARK;
 340     ResourceMark rm(THREAD);
 341     GeneratePairingInfo gpi(method);
 342     gpi.compute_map(CATCH);
 343     if (!gpi.monitor_safe()) {
 344       return false;
 345     }
 346     method-&gt;set_guaranteed_monitor_matching();
 347     _balanced_monitors = true;
 348   }
 349   return true;
 350 }
 351 
 352 
 353 // ------------------------------------------------------------------
 354 // ciMethod::get_flow_analysis
 355 ciTypeFlow* ciMethod::get_flow_analysis() {
 356 #if defined(COMPILER2)
 357   if (_flow == NULL) {
 358     ciEnv* env = CURRENT_ENV;
 359     _flow = new (env-&gt;arena()) ciTypeFlow(env, this);
 360     _flow-&gt;do_flow();
 361   }
 362   return _flow;
 363 #else // COMPILER2
 364   ShouldNotReachHere();
 365   return NULL;
 366 #endif // COMPILER2
 367 }
 368 
 369 
 370 // ------------------------------------------------------------------
 371 // ciMethod::get_osr_flow_analysis
 372 ciTypeFlow* ciMethod::get_osr_flow_analysis(int osr_bci) {
 373 #if defined(COMPILER2)
 374   // OSR entry points are always place after a call bytecode of some sort
 375   assert(osr_bci &gt;= 0, &quot;must supply valid OSR entry point&quot;);
 376   ciEnv* env = CURRENT_ENV;
 377   ciTypeFlow* flow = new (env-&gt;arena()) ciTypeFlow(env, this, osr_bci);
 378   flow-&gt;do_flow();
 379   return flow;
 380 #else // COMPILER2
 381   ShouldNotReachHere();
 382   return NULL;
 383 #endif // COMPILER2
 384 }
 385 
 386 // ------------------------------------------------------------------
 387 // ciMethod::raw_liveness_at_bci
 388 //
 389 // Which local variables are live at a specific bci?
 390 MethodLivenessResult ciMethod::raw_liveness_at_bci(int bci) {
 391   check_is_loaded();
 392   if (_liveness == NULL) {
 393     // Create the liveness analyzer.
 394     Arena* arena = CURRENT_ENV-&gt;arena();
 395     _liveness = new (arena) MethodLiveness(arena, this);
 396     _liveness-&gt;compute_liveness();
 397   }
 398   return _liveness-&gt;get_liveness_at(bci);
 399 }
 400 
 401 // ------------------------------------------------------------------
 402 // ciMethod::liveness_at_bci
 403 //
 404 // Which local variables are live at a specific bci?  When debugging
 405 // will return true for all locals in some cases to improve debug
 406 // information.
 407 MethodLivenessResult ciMethod::liveness_at_bci(int bci) {
 408   if (CURRENT_ENV-&gt;should_retain_local_variables() || DeoptimizeALot) {
 409     // Keep all locals live for the user&#39;s edification and amusement.
 410     MethodLivenessResult result(_max_locals);
 411     result.set_range(0, _max_locals);
 412     result.set_is_valid();
 413     return result;
 414   }
 415   return raw_liveness_at_bci(bci);
 416 }
 417 
 418 // ciMethod::live_local_oops_at_bci
 419 //
 420 // find all the live oops in the locals array for a particular bci
 421 // Compute what the interpreter believes by using the interpreter
 422 // oopmap generator. This is used as a double check during osr to
 423 // guard against conservative result from MethodLiveness making us
 424 // think a dead oop is live.  MethodLiveness is conservative in the
 425 // sense that it may consider locals to be live which cannot be live,
 426 // like in the case where a local could contain an oop or  a primitive
 427 // along different paths.  In that case the local must be dead when
 428 // those paths merge. Since the interpreter&#39;s viewpoint is used when
 429 // gc&#39;ing an interpreter frame we need to use its viewpoint  during
 430 // OSR when loading the locals.
 431 
 432 ResourceBitMap ciMethod::live_local_oops_at_bci(int bci) {
 433   VM_ENTRY_MARK;
 434   InterpreterOopMap mask;
 435   OopMapCache::compute_one_oop_map(methodHandle(THREAD, get_Method()), bci, &amp;mask);
 436   int mask_size = max_locals();
 437   ResourceBitMap result(mask_size);
 438   int i;
 439   for (i = 0; i &lt; mask_size ; i++ ) {
 440     if (mask.is_oop(i)) result.set_bit(i);
 441   }
 442   return result;
 443 }
 444 
 445 
 446 #ifdef COMPILER1
 447 // ------------------------------------------------------------------
 448 // ciMethod::bci_block_start
 449 //
 450 // Marks all bcis where a new basic block starts
 451 const BitMap&amp; ciMethod::bci_block_start() {
 452   check_is_loaded();
 453   if (_liveness == NULL) {
 454     // Create the liveness analyzer.
 455     Arena* arena = CURRENT_ENV-&gt;arena();
 456     _liveness = new (arena) MethodLiveness(arena, this);
 457     _liveness-&gt;compute_liveness();
 458   }
 459 
 460   return _liveness-&gt;get_bci_block_start();
 461 }
 462 #endif // COMPILER1
 463 
 464 
 465 // ------------------------------------------------------------------
 466 // ciMethod::check_overflow
 467 //
 468 // Check whether the profile counter is overflowed and adjust if true.
 469 // For invoke* it will turn negative values into max_jint,
 470 // and for checkcast/aastore/instanceof turn positive values into min_jint.
 471 int ciMethod::check_overflow(int c, Bytecodes::Code code) {
 472   switch (code) {
 473     case Bytecodes::_aastore:    // fall-through
 474     case Bytecodes::_checkcast:  // fall-through
 475     case Bytecodes::_instanceof: {
 476       return (c &gt; 0 ? min_jint : c); // always non-positive
 477     }
 478     default: {
 479       assert(Bytecodes::is_invoke(code), &quot;%s&quot;, Bytecodes::name(code));
 480       return (c &lt; 0 ? max_jint : c); // always non-negative
 481     }
 482   }
 483 }
 484 
 485 
 486 // ------------------------------------------------------------------
 487 // ciMethod::call_profile_at_bci
 488 //
 489 // Get the ciCallProfile for the invocation of this method.
 490 // Also reports receiver types for non-call type checks (if TypeProfileCasts).
 491 ciCallProfile ciMethod::call_profile_at_bci(int bci) {
 492   ResourceMark rm;
 493   ciCallProfile result;
 494   if (method_data() != NULL &amp;&amp; method_data()-&gt;is_mature()) {
 495     ciProfileData* data = method_data()-&gt;bci_to_data(bci);
 496     if (data != NULL &amp;&amp; data-&gt;is_CounterData()) {
 497       // Every profiled call site has a counter.
 498       int count = check_overflow(data-&gt;as_CounterData()-&gt;count(), java_code_at_bci(bci));
 499 
 500       if (!data-&gt;is_ReceiverTypeData()) {
 501         result._receiver_count[0] = 0;  // that&#39;s a definite zero
 502       } else { // ReceiverTypeData is a subclass of CounterData
 503         ciReceiverTypeData* call = (ciReceiverTypeData*)data-&gt;as_ReceiverTypeData();
 504         // In addition, virtual call sites have receiver type information
 505         int receivers_count_total = 0;
 506         int morphism = 0;
 507         // Precompute morphism for the possible fixup
 508         for (uint i = 0; i &lt; call-&gt;row_limit(); i++) {
 509           ciKlass* receiver = call-&gt;receiver(i);
 510           if (receiver == NULL)  continue;
 511           morphism++;
 512         }
 513         int epsilon = 0;
 514         if (TieredCompilation) {
 515           // For a call, it is assumed that either the type of the receiver(s)
 516           // is recorded or an associated counter is incremented, but not both. With
 517           // tiered compilation, however, both can happen due to the interpreter and
 518           // C1 profiling invocations differently. Address that inconsistency here.
 519           if (morphism == 1 &amp;&amp; count &gt; 0) {
 520             epsilon = count;
 521             count = 0;
 522           }
 523         }
 524         for (uint i = 0; i &lt; call-&gt;row_limit(); i++) {
 525           ciKlass* receiver = call-&gt;receiver(i);
 526           if (receiver == NULL)  continue;
 527           int rcount = saturated_add(call-&gt;receiver_count(i), epsilon);
 528           if (rcount == 0) rcount = 1; // Should be valid value
 529           receivers_count_total = saturated_add(receivers_count_total, rcount);
 530           // Add the receiver to result data.
 531           result.add_receiver(receiver, rcount);
 532           // If we extend profiling to record methods,
 533           // we will set result._method also.
 534         }
 535         // Determine call site&#39;s morphism.
 536         // The call site count is 0 with known morphism (only 1 or 2 receivers)
 537         // or &lt; 0 in the case of a type check failure for checkcast, aastore, instanceof.
 538         // The call site count is &gt; 0 in the case of a polymorphic virtual call.
 539         if (morphism &gt; 0 &amp;&amp; morphism == result._limit) {
 540            // The morphism &lt;= MorphismLimit.
 541            if ((morphism &lt;  ciCallProfile::MorphismLimit) ||
 542                (morphism == ciCallProfile::MorphismLimit &amp;&amp; count == 0)) {
 543 #ifdef ASSERT
 544              if (count &gt; 0) {
 545                this-&gt;print_short_name(tty);
 546                tty-&gt;print_cr(&quot; @ bci:%d&quot;, bci);
 547                this-&gt;print_codes();
 548                assert(false, &quot;this call site should not be polymorphic&quot;);
 549              }
 550 #endif
 551              result._morphism = morphism;
 552            }
 553         }
 554         // Make the count consistent if this is a call profile. If count is
 555         // zero or less, presume that this is a typecheck profile and
 556         // do nothing.  Otherwise, increase count to be the sum of all
 557         // receiver&#39;s counts.
 558         if (count &gt;= 0) {
 559           count = saturated_add(count, receivers_count_total);
 560         }
 561       }
 562       result._count = count;
 563     }
 564   }
 565   return result;
 566 }
 567 
 568 // ------------------------------------------------------------------
 569 // Add new receiver and sort data by receiver&#39;s profile count.
 570 void ciCallProfile::add_receiver(ciKlass* receiver, int receiver_count) {
 571   // Add new receiver and sort data by receiver&#39;s counts when we have space
 572   // for it otherwise replace the less called receiver (less called receiver
 573   // is placed to the last array element which is not used).
 574   // First array&#39;s element contains most called receiver.
 575   int i = _limit;
 576   for (; i &gt; 0 &amp;&amp; receiver_count &gt; _receiver_count[i-1]; i--) {
 577     _receiver[i] = _receiver[i-1];
 578     _receiver_count[i] = _receiver_count[i-1];
 579   }
 580   _receiver[i] = receiver;
 581   _receiver_count[i] = receiver_count;
 582   if (_limit &lt; MorphismLimit) _limit++;
 583 }
 584 
 585 
 586 void ciMethod::assert_virtual_call_type_ok(int bci) {
 587   assert(java_code_at_bci(bci) == Bytecodes::_invokevirtual ||
 588          java_code_at_bci(bci) == Bytecodes::_invokeinterface, &quot;unexpected bytecode %s&quot;, Bytecodes::name(java_code_at_bci(bci)));
 589 }
 590 
 591 void ciMethod::assert_call_type_ok(int bci) {
 592   assert(java_code_at_bci(bci) == Bytecodes::_invokestatic ||
 593          java_code_at_bci(bci) == Bytecodes::_invokespecial ||
 594          java_code_at_bci(bci) == Bytecodes::_invokedynamic, &quot;unexpected bytecode %s&quot;, Bytecodes::name(java_code_at_bci(bci)));
 595 }
 596 
 597 /**
 598  * Check whether profiling provides a type for the argument i to the
 599  * call at bci bci
 600  *
 601  * @param [in]bci         bci of the call
 602  * @param [in]i           argument number
 603  * @param [out]type       profiled type of argument, NULL if none
 604  * @param [out]ptr_kind   whether always null, never null or maybe null
 605  * @return                true if profiling exists
 606  *
 607  */
 608 bool ciMethod::argument_profiled_type(int bci, int i, ciKlass*&amp; type, ProfilePtrKind&amp; ptr_kind) {
 609   if (MethodData::profile_parameters() &amp;&amp; method_data() != NULL &amp;&amp; method_data()-&gt;is_mature()) {
 610     ciProfileData* data = method_data()-&gt;bci_to_data(bci);
 611     if (data != NULL) {
 612       if (data-&gt;is_VirtualCallTypeData()) {
 613         assert_virtual_call_type_ok(bci);
 614         ciVirtualCallTypeData* call = (ciVirtualCallTypeData*)data-&gt;as_VirtualCallTypeData();
 615         if (i &gt;= call-&gt;number_of_arguments()) {
 616           return false;
 617         }
 618         type = call-&gt;valid_argument_type(i);
 619         ptr_kind = call-&gt;argument_ptr_kind(i);
 620         return true;
 621       } else if (data-&gt;is_CallTypeData()) {
 622         assert_call_type_ok(bci);
 623         ciCallTypeData* call = (ciCallTypeData*)data-&gt;as_CallTypeData();
 624         if (i &gt;= call-&gt;number_of_arguments()) {
 625           return false;
 626         }
 627         type = call-&gt;valid_argument_type(i);
 628         ptr_kind = call-&gt;argument_ptr_kind(i);
 629         return true;
 630       }
 631     }
 632   }
 633   return false;
 634 }
 635 
 636 /**
 637  * Check whether profiling provides a type for the return value from
 638  * the call at bci bci
 639  *
 640  * @param [in]bci         bci of the call
 641  * @param [out]type       profiled type of argument, NULL if none
 642  * @param [out]ptr_kind   whether always null, never null or maybe null
 643  * @return                true if profiling exists
 644  *
 645  */
 646 bool ciMethod::return_profiled_type(int bci, ciKlass*&amp; type, ProfilePtrKind&amp; ptr_kind) {
 647   if (MethodData::profile_return() &amp;&amp; method_data() != NULL &amp;&amp; method_data()-&gt;is_mature()) {
 648     ciProfileData* data = method_data()-&gt;bci_to_data(bci);
 649     if (data != NULL) {
 650       if (data-&gt;is_VirtualCallTypeData()) {
 651         assert_virtual_call_type_ok(bci);
 652         ciVirtualCallTypeData* call = (ciVirtualCallTypeData*)data-&gt;as_VirtualCallTypeData();
 653         if (call-&gt;has_return()) {
 654           type = call-&gt;valid_return_type();
 655           ptr_kind = call-&gt;return_ptr_kind();
 656           return true;
 657         }
 658       } else if (data-&gt;is_CallTypeData()) {
 659         assert_call_type_ok(bci);
 660         ciCallTypeData* call = (ciCallTypeData*)data-&gt;as_CallTypeData();
 661         if (call-&gt;has_return()) {
 662           type = call-&gt;valid_return_type();
 663           ptr_kind = call-&gt;return_ptr_kind();
 664         }
 665         return true;
 666       }
 667     }
 668   }
 669   return false;
 670 }
 671 
 672 /**
 673  * Check whether profiling provides a type for the parameter i
 674  *
 675  * @param [in]i           parameter number
 676  * @param [out]type       profiled type of parameter, NULL if none
 677  * @param [out]ptr_kind   whether always null, never null or maybe null
 678  * @return                true if profiling exists
 679  *
 680  */
 681 bool ciMethod::parameter_profiled_type(int i, ciKlass*&amp; type, ProfilePtrKind&amp; ptr_kind) {
 682   if (MethodData::profile_parameters() &amp;&amp; method_data() != NULL &amp;&amp; method_data()-&gt;is_mature()) {
 683     ciParametersTypeData* parameters = method_data()-&gt;parameters_type_data();
 684     if (parameters != NULL &amp;&amp; i &lt; parameters-&gt;number_of_parameters()) {
 685       type = parameters-&gt;valid_parameter_type(i);
 686       ptr_kind = parameters-&gt;parameter_ptr_kind(i);
 687       return true;
 688     }
 689   }
 690   return false;
 691 }
 692 
 693 bool ciMethod::array_access_profiled_type(int bci, ciKlass*&amp; array_type, ciKlass*&amp; element_type, ProfilePtrKind&amp; element_ptr, bool &amp;flat_array, bool &amp;null_free_array) {
 694   if (method_data() != NULL &amp;&amp; method_data()-&gt;is_mature()) {
 695     ciProfileData* data = method_data()-&gt;bci_to_data(bci);
 696     if (data != NULL &amp;&amp; data-&gt;is_ArrayLoadStoreData()) {
 697       ciArrayLoadStoreData* array_access = (ciArrayLoadStoreData*)data-&gt;as_ArrayLoadStoreData();
 698       array_type = array_access-&gt;array()-&gt;valid_type();
 699       element_type = array_access-&gt;element()-&gt;valid_type();
 700       element_ptr = array_access-&gt;element()-&gt;ptr_kind();
 701       flat_array = array_access-&gt;flat_array();
 702       null_free_array = array_access-&gt;null_free_array();
 703       return true;
 704     }
 705   }
 706   return false;
 707 }
 708 
 709 
 710 // ------------------------------------------------------------------
 711 // ciMethod::find_monomorphic_target
 712 //
 713 // Given a certain calling environment, find the monomorphic target
 714 // for the call.  Return NULL if the call is not monomorphic in
 715 // its calling environment, or if there are only abstract methods.
 716 // The returned method is never abstract.
 717 // Note: If caller uses a non-null result, it must inform dependencies
 718 // via assert_unique_concrete_method or assert_leaf_type.
 719 ciMethod* ciMethod::find_monomorphic_target(ciInstanceKlass* caller,
 720                                             ciInstanceKlass* callee_holder,
 721                                             ciInstanceKlass* actual_recv,
 722                                             bool check_access) {
 723   check_is_loaded();
 724 
 725   if (actual_recv-&gt;is_interface()) {
 726     // %%% We cannot trust interface types, yet.  See bug 6312651.
 727     return NULL;
 728   }
 729 
 730   ciMethod* root_m = resolve_invoke(caller, actual_recv, check_access);
 731   if (root_m == NULL) {
 732     // Something went wrong looking up the actual receiver method.
 733     return NULL;
 734   }
 735   assert(!root_m-&gt;is_abstract(), &quot;resolve_invoke promise&quot;);
 736 
 737   // Make certain quick checks even if UseCHA is false.
 738 
 739   // Is it private or final?
 740   if (root_m-&gt;can_be_statically_bound()) {
 741     return root_m;
 742   }
 743 
 744   if (actual_recv-&gt;is_leaf_type() &amp;&amp; actual_recv == root_m-&gt;holder()) {
 745     // Easy case.  There is no other place to put a method, so don&#39;t bother
 746     // to go through the VM_ENTRY_MARK and all the rest.
 747     return root_m;
 748   }
 749 
 750   // Array methods (clone, hashCode, etc.) are always statically bound.
 751   // If we were to see an array type here, we&#39;d return root_m.
 752   // However, this method processes only ciInstanceKlasses.  (See 4962591.)
 753   // The inline_native_clone intrinsic narrows Object to T[] properly,
 754   // so there is no need to do the same job here.
 755 
 756   if (!UseCHA)  return NULL;
 757 
 758   VM_ENTRY_MARK;
 759 
 760   // Disable CHA for default methods for now
 761   if (root_m-&gt;is_default_method()) {
 762     return NULL;
 763   }
 764 
 765   methodHandle target;
 766   {
 767     MutexLocker locker(Compile_lock);
 768     Klass* context = actual_recv-&gt;get_Klass();
 769     target = methodHandle(THREAD, Dependencies::find_unique_concrete_method(context,
 770                                                        root_m-&gt;get_Method()));
 771     // %%% Should upgrade this ciMethod API to look for 1 or 2 concrete methods.
 772   }
 773 
 774 #ifndef PRODUCT
 775   if (TraceDependencies &amp;&amp; target() != NULL &amp;&amp; target() != root_m-&gt;get_Method()) {
 776     tty-&gt;print(&quot;found a non-root unique target method&quot;);
 777     tty-&gt;print_cr(&quot;  context = %s&quot;, actual_recv-&gt;get_Klass()-&gt;external_name());
 778     tty-&gt;print(&quot;  method  = &quot;);
 779     target-&gt;print_short_name(tty);
 780     tty-&gt;cr();
 781   }
 782 #endif //PRODUCT
 783 
 784   if (target() == NULL) {
 785     return NULL;
 786   }
 787   if (target() == root_m-&gt;get_Method()) {
 788     return root_m;
 789   }
 790   if (!root_m-&gt;is_public() &amp;&amp;
 791       !root_m-&gt;is_protected()) {
 792     // If we are going to reason about inheritance, it&#39;s easiest
 793     // if the method in question is public, protected, or private.
 794     // If the answer is not root_m, it is conservatively correct
 795     // to return NULL, even if the CHA encountered irrelevant
 796     // methods in other packages.
 797     // %%% TO DO: Work out logic for package-private methods
 798     // with the same name but different vtable indexes.
 799     return NULL;
 800   }
 801   assert(!target()-&gt;is_abstract(), &quot;not allowed&quot;);
 802   return CURRENT_THREAD_ENV-&gt;get_method(target());
 803 }
 804 
 805 // ------------------------------------------------------------------
 806 // ciMethod::can_be_statically_bound
 807 //
 808 // Tries to determine whether a method can be statically bound in some context.
 809 bool ciMethod::can_be_statically_bound(ciInstanceKlass* context) const {
 810   return (holder() == context) &amp;&amp; can_be_statically_bound();
 811 }
 812 
 813 // ------------------------------------------------------------------
 814 // ciMethod::resolve_invoke
 815 //
 816 // Given a known receiver klass, find the target for the call.
 817 // Return NULL if the call has no target or the target is abstract.
 818 ciMethod* ciMethod::resolve_invoke(ciKlass* caller, ciKlass* exact_receiver, bool check_access) {
 819    check_is_loaded();
 820    VM_ENTRY_MARK;
 821 
 822    Klass* caller_klass = caller-&gt;get_Klass();
 823    Klass* recv         = exact_receiver-&gt;get_Klass();
 824    Klass* resolved     = holder()-&gt;get_Klass();
 825    Symbol* h_name      = name()-&gt;get_symbol();
 826    Symbol* h_signature = signature()-&gt;get_symbol();
 827 
 828    LinkInfo link_info(resolved, h_name, h_signature, caller_klass,
 829                       check_access ? LinkInfo::needs_access_check : LinkInfo::skip_access_check);
 830    Method* m = NULL;
 831    // Only do exact lookup if receiver klass has been linked.  Otherwise,
 832    // the vtable has not been setup, and the LinkResolver will fail.
 833    if (recv-&gt;is_array_klass()
 834         ||
 835        (InstanceKlass::cast(recv)-&gt;is_linked() &amp;&amp; !exact_receiver-&gt;is_interface())) {
 836      if (holder()-&gt;is_interface()) {
 837        m = LinkResolver::resolve_interface_call_or_null(recv, link_info);
 838      } else {
 839        m = LinkResolver::resolve_virtual_call_or_null(recv, link_info);
 840      }
 841    }
 842 
 843    if (m == NULL) {
 844      // Return NULL only if there was a problem with lookup (uninitialized class, etc.)
 845      return NULL;
 846    }
 847 
 848    ciMethod* result = this;
 849    if (m != get_Method()) {
 850      result = CURRENT_THREAD_ENV-&gt;get_method(m);
 851    }
 852 
 853    // Don&#39;t return abstract methods because they aren&#39;t
 854    // optimizable or interesting.
 855    if (result-&gt;is_abstract()) {
 856      return NULL;
 857    } else {
 858      return result;
 859    }
 860 }
 861 
 862 // ------------------------------------------------------------------
 863 // ciMethod::resolve_vtable_index
 864 //
 865 // Given a known receiver klass, find the vtable index for the call.
 866 // Return Method::invalid_vtable_index if the vtable_index is unknown.
 867 int ciMethod::resolve_vtable_index(ciKlass* caller, ciKlass* receiver) {
 868    check_is_loaded();
 869 
 870    int vtable_index = Method::invalid_vtable_index;
 871    // Only do lookup if receiver klass has been linked.  Otherwise,
 872    // the vtable has not been setup, and the LinkResolver will fail.
 873    if (!receiver-&gt;is_interface()
 874        &amp;&amp; (!receiver-&gt;is_instance_klass() ||
 875            receiver-&gt;as_instance_klass()-&gt;is_linked())) {
 876      VM_ENTRY_MARK;
 877 
 878      Klass* caller_klass = caller-&gt;get_Klass();
 879      Klass* recv         = receiver-&gt;get_Klass();
 880      Symbol* h_name = name()-&gt;get_symbol();
 881      Symbol* h_signature = signature()-&gt;get_symbol();
 882 
 883      LinkInfo link_info(recv, h_name, h_signature, caller_klass);
 884      vtable_index = LinkResolver::resolve_virtual_vtable_index(recv, link_info);
 885      if (vtable_index == Method::nonvirtual_vtable_index) {
 886        // A statically bound method.  Return &quot;no such index&quot;.
 887        vtable_index = Method::invalid_vtable_index;
 888      }
 889    }
 890 
 891    return vtable_index;
 892 }
 893 
 894 // ------------------------------------------------------------------
 895 // ciMethod::interpreter_call_site_count
 896 int ciMethod::interpreter_call_site_count(int bci) {
 897   if (method_data() != NULL) {
 898     ResourceMark rm;
 899     ciProfileData* data = method_data()-&gt;bci_to_data(bci);
 900     if (data != NULL &amp;&amp; data-&gt;is_CounterData()) {
 901       return scale_count(data-&gt;as_CounterData()-&gt;count());
 902     }
 903   }
 904   return -1;  // unknown
 905 }
 906 
 907 // ------------------------------------------------------------------
 908 // ciMethod::get_field_at_bci
 909 ciField* ciMethod::get_field_at_bci(int bci, bool &amp;will_link) {
 910   ciBytecodeStream iter(this);
 911   iter.reset_to_bci(bci);
 912   iter.next();
 913   return iter.get_field(will_link);
 914 }
 915 
 916 // ------------------------------------------------------------------
 917 // ciMethod::get_method_at_bci
 918 ciMethod* ciMethod::get_method_at_bci(int bci, bool &amp;will_link, ciSignature* *declared_signature) {
 919   ciBytecodeStream iter(this);
 920   iter.reset_to_bci(bci);
 921   iter.next();
 922   return iter.get_method(will_link, declared_signature);
 923 }
 924 
 925 // ------------------------------------------------------------------
 926 ciKlass* ciMethod::get_declared_method_holder_at_bci(int bci) {
 927   ciBytecodeStream iter(this);
 928   iter.reset_to_bci(bci);
 929   iter.next();
 930   return iter.get_declared_method_holder();
 931 }
 932 
 933 // ------------------------------------------------------------------
 934 // Adjust a CounterData count to be commensurate with
 935 // interpreter_invocation_count.  If the MDO exists for
 936 // only 25% of the time the method exists, then the
 937 // counts in the MDO should be scaled by 4X, so that
 938 // they can be usefully and stably compared against the
 939 // invocation counts in methods.
 940 int ciMethod::scale_count(int count, float prof_factor) {
 941   if (count &gt; 0 &amp;&amp; method_data() != NULL) {
 942     int counter_life;
 943     int method_life = interpreter_invocation_count();
 944     if (TieredCompilation) {
 945       // In tiered the MDO&#39;s life is measured directly, so just use the snapshotted counters
 946       counter_life = MAX2(method_data()-&gt;invocation_count(), method_data()-&gt;backedge_count());
 947     } else {
 948       int current_mileage = method_data()-&gt;current_mileage();
 949       int creation_mileage = method_data()-&gt;creation_mileage();
 950       counter_life = current_mileage - creation_mileage;
 951     }
 952 
 953     // counter_life due to backedge_counter could be &gt; method_life
 954     if (counter_life &gt; method_life)
 955       counter_life = method_life;
 956     if (0 &lt; counter_life &amp;&amp; counter_life &lt;= method_life) {
 957       count = (int)((double)count * prof_factor * method_life / counter_life + 0.5);
 958       count = (count &gt; 0) ? count : 1;
 959     }
 960   }
 961   return count;
 962 }
 963 
 964 
 965 // ------------------------------------------------------------------
 966 // ciMethod::is_special_get_caller_class_method
 967 //
 968 bool ciMethod::is_ignored_by_security_stack_walk() const {
 969   check_is_loaded();
 970   VM_ENTRY_MARK;
 971   return get_Method()-&gt;is_ignored_by_security_stack_walk();
 972 }
 973 
 974 // ------------------------------------------------------------------
 975 // ciMethod::needs_clinit_barrier
 976 //
 977 bool ciMethod::needs_clinit_barrier() const {
 978   check_is_loaded();
 979   return is_static() &amp;&amp; !holder()-&gt;is_initialized();
 980 }
 981 
 982 // ------------------------------------------------------------------
 983 // invokedynamic support
 984 
 985 // ------------------------------------------------------------------
 986 // ciMethod::is_method_handle_intrinsic
 987 //
 988 // Return true if the method is an instance of the JVM-generated
 989 // signature-polymorphic MethodHandle methods, _invokeBasic, _linkToVirtual, etc.
 990 bool ciMethod::is_method_handle_intrinsic() const {
 991   vmIntrinsics::ID iid = _intrinsic_id;  // do not check if loaded
 992   return (MethodHandles::is_signature_polymorphic(iid) &amp;&amp;
 993           MethodHandles::is_signature_polymorphic_intrinsic(iid));
 994 }
 995 
 996 // ------------------------------------------------------------------
 997 // ciMethod::is_compiled_lambda_form
 998 //
 999 // Return true if the method is a generated MethodHandle adapter.
1000 // These are built by Java code.
1001 bool ciMethod::is_compiled_lambda_form() const {
1002   vmIntrinsics::ID iid = _intrinsic_id;  // do not check if loaded
1003   return iid == vmIntrinsics::_compiledLambdaForm;
1004 }
1005 
1006 // ------------------------------------------------------------------
1007 // ciMethod::is_object_constructor
1008 //
1009 bool ciMethod::is_object_constructor() const {
1010    return (name() == ciSymbol::object_initializer_name()
1011            &amp;&amp; signature()-&gt;return_type()-&gt;is_void());
1012    // Note:  We can&#39;t test is_static, because that would
1013    // require the method to be loaded.  Sometimes it isn&#39;t.
1014 }
1015 
1016 // ------------------------------------------------------------------
1017 // ciMethod::is_static_init_factory
1018 //
1019 bool ciMethod::is_static_init_factory() const {
1020    return (name() == ciSymbol::object_initializer_name()
1021            &amp;&amp; !signature()-&gt;return_type()-&gt;is_void());
1022    // Note:  We can&#39;t test is_static, because that would
1023    // require the method to be loaded.  Sometimes it isn&#39;t.
1024 }
1025 
1026 // ------------------------------------------------------------------
1027 // ciMethod::has_member_arg
1028 //
1029 // Return true if the method is a linker intrinsic like _linkToVirtual.
1030 // These are built by the JVM.
1031 bool ciMethod::has_member_arg() const {
1032   vmIntrinsics::ID iid = _intrinsic_id;  // do not check if loaded
1033   return (MethodHandles::is_signature_polymorphic(iid) &amp;&amp;
1034           MethodHandles::has_member_arg(iid));
1035 }
1036 
1037 // ------------------------------------------------------------------
1038 // ciMethod::ensure_method_data
1039 //
1040 // Generate new MethodData* objects at compile time.
1041 // Return true if allocation was successful or no MDO is required.
1042 bool ciMethod::ensure_method_data(const methodHandle&amp; h_m) {
1043   EXCEPTION_CONTEXT;
1044   if (is_native() || is_abstract() || h_m()-&gt;is_accessor()) {
1045     return true;
1046   }
1047   if (h_m()-&gt;method_data() == NULL) {
1048     Method::build_interpreter_method_data(h_m, THREAD);
1049     if (HAS_PENDING_EXCEPTION) {
1050       CLEAR_PENDING_EXCEPTION;
1051     }
1052   }
1053   if (h_m()-&gt;method_data() != NULL) {
1054     _method_data = CURRENT_ENV-&gt;get_method_data(h_m()-&gt;method_data());
1055     _method_data-&gt;load_data();
1056     return true;
1057   } else {
1058     _method_data = CURRENT_ENV-&gt;get_empty_methodData();
1059     return false;
1060   }
1061 }
1062 
1063 // public, retroactive version
1064 bool ciMethod::ensure_method_data() {
1065   bool result = true;
1066   if (_method_data == NULL || _method_data-&gt;is_empty()) {
1067     GUARDED_VM_ENTRY({
1068       methodHandle mh(Thread::current(), get_Method());
1069       result = ensure_method_data(mh);
1070     });
1071   }
1072   return result;
1073 }
1074 
1075 
1076 // ------------------------------------------------------------------
1077 // ciMethod::method_data
1078 //
1079 ciMethodData* ciMethod::method_data() {
1080   if (_method_data != NULL) {
1081     return _method_data;
1082   }
1083   VM_ENTRY_MARK;
1084   ciEnv* env = CURRENT_ENV;
1085   Thread* my_thread = JavaThread::current();
1086   methodHandle h_m(my_thread, get_Method());
1087 
1088   if (h_m()-&gt;method_data() != NULL) {
1089     _method_data = CURRENT_ENV-&gt;get_method_data(h_m()-&gt;method_data());
1090     _method_data-&gt;load_data();
1091   } else {
1092     _method_data = CURRENT_ENV-&gt;get_empty_methodData();
1093   }
1094   return _method_data;
1095 
1096 }
1097 
1098 // ------------------------------------------------------------------
1099 // ciMethod::method_data_or_null
1100 // Returns a pointer to ciMethodData if MDO exists on the VM side,
1101 // NULL otherwise.
1102 ciMethodData* ciMethod::method_data_or_null() {
1103   ciMethodData *md = method_data();
1104   if (md-&gt;is_empty()) {
1105     return NULL;
1106   }
1107   return md;
1108 }
1109 
1110 // ------------------------------------------------------------------
1111 // ciMethod::ensure_method_counters
1112 //
1113 MethodCounters* ciMethod::ensure_method_counters() {
1114   check_is_loaded();
1115   VM_ENTRY_MARK;
1116   methodHandle mh(THREAD, get_Method());
1117   MethodCounters* method_counters = mh-&gt;get_method_counters(CHECK_NULL);
1118   return method_counters;
1119 }
1120 
1121 // ------------------------------------------------------------------
1122 // ciMethod::has_option
1123 //
1124 bool ciMethod::has_option(const char* option) {
1125   check_is_loaded();
1126   VM_ENTRY_MARK;
1127   methodHandle mh(THREAD, get_Method());
1128   return CompilerOracle::has_option_string(mh, option);
1129 }
1130 
1131 // ------------------------------------------------------------------
1132 // ciMethod::has_option_value
1133 //
1134 bool ciMethod::has_option_value(const char* option, double&amp; value) {
1135   check_is_loaded();
1136   VM_ENTRY_MARK;
1137   methodHandle mh(THREAD, get_Method());
1138   return CompilerOracle::has_option_value(mh, option, value);
1139 }
1140 // ------------------------------------------------------------------
1141 // ciMethod::can_be_compiled
1142 //
1143 // Have previous compilations of this method succeeded?
1144 bool ciMethod::can_be_compiled() {
1145   check_is_loaded();
1146   ciEnv* env = CURRENT_ENV;
1147   if (is_c1_compile(env-&gt;comp_level())) {
1148     return _is_c1_compilable;
1149   }
1150   return _is_c2_compilable;
1151 }
1152 
1153 // ------------------------------------------------------------------
1154 // ciMethod::set_not_compilable
1155 //
1156 // Tell the VM that this method cannot be compiled at all.
1157 void ciMethod::set_not_compilable(const char* reason) {
1158   check_is_loaded();
1159   VM_ENTRY_MARK;
1160   ciEnv* env = CURRENT_ENV;
1161   if (is_c1_compile(env-&gt;comp_level())) {
1162     _is_c1_compilable = false;
1163   } else {
1164     _is_c2_compilable = false;
1165   }
1166   get_Method()-&gt;set_not_compilable(reason, env-&gt;comp_level());
1167 }
1168 
1169 // ------------------------------------------------------------------
1170 // ciMethod::can_be_osr_compiled
1171 //
1172 // Have previous compilations of this method succeeded?
1173 //
1174 // Implementation note: the VM does not currently keep track
1175 // of failed OSR compilations per bci.  The entry_bci parameter
1176 // is currently unused.
1177 bool ciMethod::can_be_osr_compiled(int entry_bci) {
1178   check_is_loaded();
1179   VM_ENTRY_MARK;
1180   ciEnv* env = CURRENT_ENV;
1181   return !get_Method()-&gt;is_not_osr_compilable(env-&gt;comp_level());
1182 }
1183 
1184 // ------------------------------------------------------------------
1185 // ciMethod::has_compiled_code
1186 bool ciMethod::has_compiled_code() {
1187   return instructions_size() &gt; 0;
1188 }
1189 
1190 int ciMethod::comp_level() {
1191   check_is_loaded();
1192   VM_ENTRY_MARK;
1193   CompiledMethod* nm = get_Method()-&gt;code();
1194   if (nm != NULL) return nm-&gt;comp_level();
1195   return 0;
1196 }
1197 
1198 int ciMethod::highest_osr_comp_level() {
1199   check_is_loaded();
1200   VM_ENTRY_MARK;
1201   return get_Method()-&gt;highest_osr_comp_level();
1202 }
1203 
1204 // ------------------------------------------------------------------
1205 // ciMethod::code_size_for_inlining
1206 //
1207 // Code size for inlining decisions.  This method returns a code
1208 // size of 1 for methods which has the ForceInline annotation.
1209 int ciMethod::code_size_for_inlining() {
1210   check_is_loaded();
1211   if (get_Method()-&gt;force_inline()) {
1212     return 1;
1213   }
1214   return code_size();
1215 }
1216 
1217 // ------------------------------------------------------------------
1218 // ciMethod::instructions_size
1219 //
1220 // This is a rough metric for &quot;fat&quot; methods, compared before inlining
1221 // with InlineSmallCode.  The CodeBlob::code_size accessor includes
1222 // junk like exception handler, stubs, and constant table, which are
1223 // not highly relevant to an inlined method.  So we use the more
1224 // specific accessor nmethod::insts_size.
1225 int ciMethod::instructions_size() {
1226   if (_instructions_size == -1) {
1227     GUARDED_VM_ENTRY(
1228                      CompiledMethod* code = get_Method()-&gt;code();
1229                      if (code != NULL &amp;&amp; (code-&gt;comp_level() == CompLevel_full_optimization)) {
1230                        _instructions_size = code-&gt;insts_end() - code-&gt;verified_entry_point();
1231                      } else {
1232                        _instructions_size = 0;
1233                      }
1234                      );
1235   }
1236   return _instructions_size;
1237 }
1238 
1239 // ------------------------------------------------------------------
1240 // ciMethod::log_nmethod_identity
1241 void ciMethod::log_nmethod_identity(xmlStream* log) {
1242   GUARDED_VM_ENTRY(
1243     CompiledMethod* code = get_Method()-&gt;code();
1244     if (code != NULL) {
1245       code-&gt;log_identity(log);
1246     }
1247   )
1248 }
1249 
1250 // ------------------------------------------------------------------
1251 // ciMethod::is_not_reached
1252 bool ciMethod::is_not_reached(int bci) {
1253   check_is_loaded();
1254   VM_ENTRY_MARK;
1255   return Interpreter::is_not_reached(
1256                methodHandle(THREAD, get_Method()), bci);
1257 }
1258 
1259 // ------------------------------------------------------------------
1260 // ciMethod::was_never_executed
1261 bool ciMethod::was_executed_more_than(int times) {
1262   VM_ENTRY_MARK;
1263   return get_Method()-&gt;was_executed_more_than(times);
1264 }
1265 
1266 // ------------------------------------------------------------------
1267 // ciMethod::has_unloaded_classes_in_signature
1268 bool ciMethod::has_unloaded_classes_in_signature() {
1269   VM_ENTRY_MARK;
1270   {
1271     EXCEPTION_MARK;
1272     methodHandle m(THREAD, get_Method());
1273     bool has_unloaded = Method::has_unloaded_classes_in_signature(m, (JavaThread *)THREAD);
1274     if( HAS_PENDING_EXCEPTION ) {
1275       CLEAR_PENDING_EXCEPTION;
1276       return true;     // Declare that we may have unloaded classes
1277     }
1278     return has_unloaded;
1279   }
1280 }
1281 
1282 // ------------------------------------------------------------------
1283 // ciMethod::is_klass_loaded
1284 bool ciMethod::is_klass_loaded(int refinfo_index, bool must_be_resolved) const {
1285   VM_ENTRY_MARK;
1286   return get_Method()-&gt;is_klass_loaded(refinfo_index, must_be_resolved);
1287 }
1288 
1289 // ------------------------------------------------------------------
1290 // ciMethod::check_call
1291 bool ciMethod::check_call(int refinfo_index, bool is_static) const {
1292   // This method is used only in C2 from InlineTree::ok_to_inline,
1293   // and is only used under -Xcomp.
1294   // It appears to fail when applied to an invokeinterface call site.
1295   // FIXME: Remove this method and resolve_method_statically; refactor to use the other LinkResolver entry points.
1296   VM_ENTRY_MARK;
1297   {
1298     EXCEPTION_MARK;
1299     HandleMark hm(THREAD);
1300     constantPoolHandle pool (THREAD, get_Method()-&gt;constants());
1301     Bytecodes::Code code = (is_static ? Bytecodes::_invokestatic : Bytecodes::_invokevirtual);
1302     Method* spec_method = LinkResolver::resolve_method_statically(code, pool, refinfo_index, THREAD);
1303     if (HAS_PENDING_EXCEPTION) {
1304       CLEAR_PENDING_EXCEPTION;
1305       return false;
1306     } else {
1307       return (spec_method-&gt;is_static() == is_static);
1308     }
1309   }
1310   return false;
1311 }
1312 
1313 // ------------------------------------------------------------------
1314 // ciMethod::profile_aging
1315 //
1316 // Should the method be compiled with an age counter?
1317 bool ciMethod::profile_aging() const {
1318   return UseCodeAging &amp;&amp; (!MethodCounters::is_nmethod_hot(nmethod_age()) &amp;&amp;
1319                           !MethodCounters::is_nmethod_age_unset(nmethod_age()));
1320 }
1321 // ------------------------------------------------------------------
1322 // ciMethod::print_codes
1323 //
1324 // Print the bytecodes for this method.
1325 void ciMethod::print_codes_on(outputStream* st) {
1326   check_is_loaded();
1327   GUARDED_VM_ENTRY(get_Method()-&gt;print_codes_on(st);)
1328 }
1329 
1330 
1331 #define FETCH_FLAG_FROM_VM(flag_accessor) { \
1332   check_is_loaded(); \
1333   VM_ENTRY_MARK; \
1334   return get_Method()-&gt;flag_accessor(); \
1335 }
1336 
1337 bool ciMethod::is_empty_method() const {         FETCH_FLAG_FROM_VM(is_empty_method); }
1338 bool ciMethod::is_vanilla_constructor() const {  FETCH_FLAG_FROM_VM(is_vanilla_constructor); }
1339 bool ciMethod::has_loops      () const {         FETCH_FLAG_FROM_VM(has_loops); }
1340 bool ciMethod::has_jsrs       () const {         FETCH_FLAG_FROM_VM(has_jsrs);  }
1341 bool ciMethod::is_getter      () const {         FETCH_FLAG_FROM_VM(is_getter); }
1342 bool ciMethod::is_setter      () const {         FETCH_FLAG_FROM_VM(is_setter); }
1343 bool ciMethod::is_accessor    () const {         FETCH_FLAG_FROM_VM(is_accessor); }
1344 bool ciMethod::is_object_constructor_or_class_initializer() const { FETCH_FLAG_FROM_VM(is_object_constructor_or_class_initializer); }
1345 
1346 bool ciMethod::is_boxing_method() const {
1347   if (holder()-&gt;is_box_klass()) {
1348     switch (intrinsic_id()) {
1349       case vmIntrinsics::_Boolean_valueOf:
1350       case vmIntrinsics::_Byte_valueOf:
1351       case vmIntrinsics::_Character_valueOf:
1352       case vmIntrinsics::_Short_valueOf:
1353       case vmIntrinsics::_Integer_valueOf:
1354       case vmIntrinsics::_Long_valueOf:
1355       case vmIntrinsics::_Float_valueOf:
1356       case vmIntrinsics::_Double_valueOf:
1357         return true;
1358       default:
1359         return false;
1360     }
1361   }
1362   return false;
1363 }
1364 
1365 bool ciMethod::is_unboxing_method() const {
1366   if (holder()-&gt;is_box_klass()) {
1367     switch (intrinsic_id()) {
1368       case vmIntrinsics::_booleanValue:
1369       case vmIntrinsics::_byteValue:
1370       case vmIntrinsics::_charValue:
1371       case vmIntrinsics::_shortValue:
1372       case vmIntrinsics::_intValue:
1373       case vmIntrinsics::_longValue:
1374       case vmIntrinsics::_floatValue:
1375       case vmIntrinsics::_doubleValue:
1376         return true;
1377       default:
1378         return false;
1379     }
1380   }
1381   return false;
1382 }
1383 
1384 BCEscapeAnalyzer  *ciMethod::get_bcea() {
1385 #ifdef COMPILER2
1386   if (_bcea == NULL) {
1387     _bcea = new (CURRENT_ENV-&gt;arena()) BCEscapeAnalyzer(this, NULL);
1388   }
1389   return _bcea;
1390 #else // COMPILER2
1391   ShouldNotReachHere();
1392   return NULL;
1393 #endif // COMPILER2
1394 }
1395 
1396 ciMethodBlocks  *ciMethod::get_method_blocks() {
1397   Arena *arena = CURRENT_ENV-&gt;arena();
1398   if (_method_blocks == NULL) {
1399     _method_blocks = new (arena) ciMethodBlocks(arena, this);
1400   }
1401   return _method_blocks;
1402 }
1403 
1404 #undef FETCH_FLAG_FROM_VM
1405 
1406 void ciMethod::dump_name_as_ascii(outputStream* st) {
1407   Method* method = get_Method();
1408   st-&gt;print(&quot;%s %s %s&quot;,
1409             method-&gt;klass_name()-&gt;as_quoted_ascii(),
1410             method-&gt;name()-&gt;as_quoted_ascii(),
1411             method-&gt;signature()-&gt;as_quoted_ascii());
1412 }
1413 
1414 void ciMethod::dump_replay_data(outputStream* st) {
1415   ResourceMark rm;
1416   Method* method = get_Method();
1417   MethodCounters* mcs = method-&gt;method_counters();
1418   st-&gt;print(&quot;ciMethod &quot;);
1419   dump_name_as_ascii(st);
1420   st-&gt;print_cr(&quot; %d %d %d %d %d&quot;,
1421                mcs == NULL ? 0 : mcs-&gt;invocation_counter()-&gt;raw_counter(),
1422                mcs == NULL ? 0 : mcs-&gt;backedge_counter()-&gt;raw_counter(),
1423                interpreter_invocation_count(),
1424                interpreter_throwout_count(),
1425                _instructions_size);
1426 }
1427 
1428 // ------------------------------------------------------------------
1429 // ciMethod::print_codes
1430 //
1431 // Print a range of the bytecodes for this method.
1432 void ciMethod::print_codes_on(int from, int to, outputStream* st) {
1433   check_is_loaded();
1434   GUARDED_VM_ENTRY(get_Method()-&gt;print_codes_on(from, to, st);)
1435 }
1436 
1437 // ------------------------------------------------------------------
1438 // ciMethod::print_name
1439 //
1440 // Print the name of this method, including signature and some flags.
1441 void ciMethod::print_name(outputStream* st) {
1442   check_is_loaded();
1443   GUARDED_VM_ENTRY(get_Method()-&gt;print_name(st);)
1444 }
1445 
1446 // ------------------------------------------------------------------
1447 // ciMethod::print_short_name
1448 //
1449 // Print the name of this method, without signature.
1450 void ciMethod::print_short_name(outputStream* st) {
1451   if (is_loaded()) {
1452     GUARDED_VM_ENTRY(get_Method()-&gt;print_short_name(st););
1453   } else {
1454     // Fall back if method is not loaded.
1455     holder()-&gt;print_name_on(st);
1456     st-&gt;print(&quot;::&quot;);
1457     name()-&gt;print_symbol_on(st);
1458     if (WizardMode)
1459       signature()-&gt;as_symbol()-&gt;print_symbol_on(st);
1460   }
1461 }
1462 
1463 // ------------------------------------------------------------------
1464 // ciMethod::print_impl
1465 //
1466 // Implementation of the print method.
1467 void ciMethod::print_impl(outputStream* st) {
1468   ciMetadata::print_impl(st);
1469   st-&gt;print(&quot; name=&quot;);
1470   name()-&gt;print_symbol_on(st);
1471   st-&gt;print(&quot; holder=&quot;);
1472   holder()-&gt;print_name_on(st);
1473   st-&gt;print(&quot; signature=&quot;);
1474   signature()-&gt;as_symbol()-&gt;print_symbol_on(st);
1475   if (is_loaded()) {
1476     st-&gt;print(&quot; loaded=true&quot;);
1477     st-&gt;print(&quot; arg_size=%d&quot;, arg_size());
1478     st-&gt;print(&quot; flags=&quot;);
1479     flags().print_member_flags(st);
1480   } else {
1481     st-&gt;print(&quot; loaded=false&quot;);
1482   }
1483 }
1484 
1485 // ------------------------------------------------------------------
1486 
1487 static BasicType erase_to_word_type(BasicType bt) {
1488   if (is_subword_type(bt))   return T_INT;
1489   if (is_reference_type(bt)) return T_OBJECT;
1490   if (bt == T_INLINE_TYPE)   return T_OBJECT;
1491   return bt;
1492 }
1493 
1494 static bool basic_types_match(ciType* t1, ciType* t2) {
1495   if (t1 == t2)  return true;
1496   return erase_to_word_type(t1-&gt;basic_type()) == erase_to_word_type(t2-&gt;basic_type());
1497 }
1498 
1499 bool ciMethod::is_consistent_info(ciMethod* declared_method, ciMethod* resolved_method) {
1500   bool invoke_through_mh_intrinsic = declared_method-&gt;is_method_handle_intrinsic() &amp;&amp;
1501                                   !resolved_method-&gt;is_method_handle_intrinsic();
1502 
1503   if (!invoke_through_mh_intrinsic) {
1504     // Method name &amp; descriptor should stay the same.
1505     // Signatures may reference unloaded types and thus they may be not strictly equal.
1506     ciSymbol* declared_signature = declared_method-&gt;signature()-&gt;as_symbol();
1507     ciSymbol* resolved_signature = resolved_method-&gt;signature()-&gt;as_symbol();
1508 
1509     return (declared_method-&gt;name()-&gt;equals(resolved_method-&gt;name())) &amp;&amp;
1510            (declared_signature-&gt;equals(resolved_signature));
1511   }
1512 
1513   ciMethod* linker = declared_method;
1514   ciMethod* target = resolved_method;
1515   // Linkers have appendix argument which is not passed to callee.
1516   int has_appendix = MethodHandles::has_member_arg(linker-&gt;intrinsic_id()) ? 1 : 0;
1517   if (linker-&gt;arg_size() != (target-&gt;arg_size() + has_appendix)) {
1518     return false; // argument slot count mismatch
1519   }
1520 
1521   ciSignature* linker_sig = linker-&gt;signature();
1522   ciSignature* target_sig = target-&gt;signature();
1523 
1524   if (linker_sig-&gt;count() + (linker-&gt;is_static() ? 0 : 1) !=
1525       target_sig-&gt;count() + (target-&gt;is_static() ? 0 : 1) + has_appendix) {
1526     return false; // argument count mismatch
1527   }
1528 
1529   int sbase = 0, rbase = 0;
1530   switch (linker-&gt;intrinsic_id()) {
1531     case vmIntrinsics::_linkToVirtual:
1532     case vmIntrinsics::_linkToInterface:
1533     case vmIntrinsics::_linkToSpecial: {
1534       if (target-&gt;is_static()) {
1535         return false;
1536       }
1537       if (linker_sig-&gt;type_at(0)-&gt;is_primitive_type()) {
1538         return false;  // receiver should be an oop
1539       }
1540       sbase = 1; // skip receiver
1541       break;
1542     }
1543     case vmIntrinsics::_linkToStatic: {
1544       if (!target-&gt;is_static()) {
1545         return false;
1546       }
1547       break;
1548     }
1549     case vmIntrinsics::_invokeBasic: {
1550       if (target-&gt;is_static()) {
1551         if (target_sig-&gt;type_at(0)-&gt;is_primitive_type()) {
1552           return false; // receiver should be an oop
1553         }
1554         rbase = 1; // skip receiver
1555       }
1556       break;
1557     }
1558     default:
1559       break;
1560   }
1561   assert(target_sig-&gt;count() - rbase == linker_sig-&gt;count() - sbase - has_appendix, &quot;argument count mismatch&quot;);
1562   int arg_count = target_sig-&gt;count() - rbase;
1563   for (int i = 0; i &lt; arg_count; i++) {
1564     if (!basic_types_match(linker_sig-&gt;type_at(sbase + i), target_sig-&gt;type_at(rbase + i))) {
1565       return false;
1566     }
1567   }
1568   // Only check the return type if the symbolic info has non-void return type.
1569   // I.e. the return value of the resolved method can be dropped.
1570   if (!linker-&gt;return_type()-&gt;is_void() &amp;&amp;
1571       !basic_types_match(linker-&gt;return_type(), target-&gt;return_type())) {
1572     return false;
1573   }
1574   return true; // no mismatch found
1575 }
1576 
1577 // ------------------------------------------------------------------
1578 
1579 bool ciMethod::has_scalarized_args() const {
1580   VM_ENTRY_MARK;
1581   return get_Method()-&gt;has_scalarized_args();
1582 }
1583 
1584 const GrowableArray&lt;SigEntry&gt;* ciMethod::get_sig_cc() {
1585   VM_ENTRY_MARK;
1586   if (get_Method()-&gt;adapter() == NULL) {
1587     return NULL;
1588   }
1589   return get_Method()-&gt;adapter()-&gt;get_sig_cc();
1590 }
    </pre>
  </body>
</html>