<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/c1/c1_LIRGenerator.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2005, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;c1/c1_Compilation.hpp&quot;
  27 #include &quot;c1/c1_Defs.hpp&quot;
  28 #include &quot;c1/c1_FrameMap.hpp&quot;
  29 #include &quot;c1/c1_Instruction.hpp&quot;
  30 #include &quot;c1/c1_LIRAssembler.hpp&quot;
  31 #include &quot;c1/c1_LIRGenerator.hpp&quot;
  32 #include &quot;c1/c1_ValueStack.hpp&quot;
  33 #include &quot;ci/ciArrayKlass.hpp&quot;
  34 #include &quot;ci/ciInstance.hpp&quot;
  35 #include &quot;ci/ciObjArray.hpp&quot;
  36 #include &quot;ci/ciUtilities.hpp&quot;
  37 #include &quot;ci/ciValueArrayKlass.hpp&quot;
  38 #include &quot;ci/ciValueKlass.hpp&quot;
  39 #include &quot;gc/shared/barrierSet.hpp&quot;
  40 #include &quot;gc/shared/c1/barrierSetC1.hpp&quot;
  41 #include &quot;oops/klass.inline.hpp&quot;
  42 #include &quot;runtime/arguments.hpp&quot;
  43 #include &quot;runtime/sharedRuntime.hpp&quot;
  44 #include &quot;runtime/stubRoutines.hpp&quot;
  45 #include &quot;runtime/vm_version.hpp&quot;
  46 #include &quot;utilities/bitMap.inline.hpp&quot;
  47 #include &quot;utilities/macros.hpp&quot;
  48 #include &quot;utilities/powerOfTwo.hpp&quot;
  49 
  50 #ifdef ASSERT
  51 #define __ gen()-&gt;lir(__FILE__, __LINE__)-&gt;
  52 #else
  53 #define __ gen()-&gt;lir()-&gt;
  54 #endif
  55 
  56 #ifndef PATCHED_ADDR
  57 #define PATCHED_ADDR  (max_jint)
  58 #endif
  59 
  60 void PhiResolverState::reset() {
  61   _virtual_operands.clear();
  62   _other_operands.clear();
  63   _vreg_table.clear();
  64 }
  65 
  66 
  67 //--------------------------------------------------------------
  68 // PhiResolver
  69 
  70 // Resolves cycles:
  71 //
  72 //  r1 := r2  becomes  temp := r1
  73 //  r2 := r1           r1 := r2
  74 //                     r2 := temp
  75 // and orders moves:
  76 //
  77 //  r2 := r3  becomes  r1 := r2
  78 //  r1 := r2           r2 := r3
  79 
  80 PhiResolver::PhiResolver(LIRGenerator* gen)
  81  : _gen(gen)
  82  , _state(gen-&gt;resolver_state())
  83  , _temp(LIR_OprFact::illegalOpr)
  84 {
  85   // reinitialize the shared state arrays
  86   _state.reset();
  87 }
  88 
  89 
  90 void PhiResolver::emit_move(LIR_Opr src, LIR_Opr dest) {
  91   assert(src-&gt;is_valid(), &quot;&quot;);
  92   assert(dest-&gt;is_valid(), &quot;&quot;);
  93   __ move(src, dest);
  94 }
  95 
  96 
  97 void PhiResolver::move_temp_to(LIR_Opr dest) {
  98   assert(_temp-&gt;is_valid(), &quot;&quot;);
  99   emit_move(_temp, dest);
 100   NOT_PRODUCT(_temp = LIR_OprFact::illegalOpr);
 101 }
 102 
 103 
 104 void PhiResolver::move_to_temp(LIR_Opr src) {
 105   assert(_temp-&gt;is_illegal(), &quot;&quot;);
 106   _temp = _gen-&gt;new_register(src-&gt;type());
 107   emit_move(src, _temp);
 108 }
 109 
 110 
 111 // Traverse assignment graph in depth first order and generate moves in post order
 112 // ie. two assignments: b := c, a := b start with node c:
 113 // Call graph: move(NULL, c) -&gt; move(c, b) -&gt; move(b, a)
 114 // Generates moves in this order: move b to a and move c to b
 115 // ie. cycle a := b, b := a start with node a
 116 // Call graph: move(NULL, a) -&gt; move(a, b) -&gt; move(b, a)
 117 // Generates moves in this order: move b to temp, move a to b, move temp to a
 118 void PhiResolver::move(ResolveNode* src, ResolveNode* dest) {
 119   if (!dest-&gt;visited()) {
 120     dest-&gt;set_visited();
 121     for (int i = dest-&gt;no_of_destinations()-1; i &gt;= 0; i --) {
 122       move(dest, dest-&gt;destination_at(i));
 123     }
 124   } else if (!dest-&gt;start_node()) {
 125     // cylce in graph detected
 126     assert(_loop == NULL, &quot;only one loop valid!&quot;);
 127     _loop = dest;
 128     move_to_temp(src-&gt;operand());
 129     return;
 130   } // else dest is a start node
 131 
 132   if (!dest-&gt;assigned()) {
 133     if (_loop == dest) {
 134       move_temp_to(dest-&gt;operand());
 135       dest-&gt;set_assigned();
 136     } else if (src != NULL) {
 137       emit_move(src-&gt;operand(), dest-&gt;operand());
 138       dest-&gt;set_assigned();
 139     }
 140   }
 141 }
 142 
 143 
 144 PhiResolver::~PhiResolver() {
 145   int i;
 146   // resolve any cycles in moves from and to virtual registers
 147   for (i = virtual_operands().length() - 1; i &gt;= 0; i --) {
 148     ResolveNode* node = virtual_operands().at(i);
 149     if (!node-&gt;visited()) {
 150       _loop = NULL;
 151       move(NULL, node);
 152       node-&gt;set_start_node();
 153       assert(_temp-&gt;is_illegal(), &quot;move_temp_to() call missing&quot;);
 154     }
 155   }
 156 
 157   // generate move for move from non virtual register to abitrary destination
 158   for (i = other_operands().length() - 1; i &gt;= 0; i --) {
 159     ResolveNode* node = other_operands().at(i);
 160     for (int j = node-&gt;no_of_destinations() - 1; j &gt;= 0; j --) {
 161       emit_move(node-&gt;operand(), node-&gt;destination_at(j)-&gt;operand());
 162     }
 163   }
 164 }
 165 
 166 
 167 ResolveNode* PhiResolver::create_node(LIR_Opr opr, bool source) {
 168   ResolveNode* node;
 169   if (opr-&gt;is_virtual()) {
 170     int vreg_num = opr-&gt;vreg_number();
 171     node = vreg_table().at_grow(vreg_num, NULL);
 172     assert(node == NULL || node-&gt;operand() == opr, &quot;&quot;);
 173     if (node == NULL) {
 174       node = new ResolveNode(opr);
 175       vreg_table().at_put(vreg_num, node);
 176     }
 177     // Make sure that all virtual operands show up in the list when
 178     // they are used as the source of a move.
 179     if (source &amp;&amp; !virtual_operands().contains(node)) {
 180       virtual_operands().append(node);
 181     }
 182   } else {
 183     assert(source, &quot;&quot;);
 184     node = new ResolveNode(opr);
 185     other_operands().append(node);
 186   }
 187   return node;
 188 }
 189 
 190 
 191 void PhiResolver::move(LIR_Opr src, LIR_Opr dest) {
 192   assert(dest-&gt;is_virtual(), &quot;&quot;);
 193   // tty-&gt;print(&quot;move &quot;); src-&gt;print(); tty-&gt;print(&quot; to &quot;); dest-&gt;print(); tty-&gt;cr();
 194   assert(src-&gt;is_valid(), &quot;&quot;);
 195   assert(dest-&gt;is_valid(), &quot;&quot;);
 196   ResolveNode* source = source_node(src);
 197   source-&gt;append(destination_node(dest));
 198 }
 199 
 200 
 201 //--------------------------------------------------------------
 202 // LIRItem
 203 
 204 void LIRItem::set_result(LIR_Opr opr) {
 205   assert(value()-&gt;operand()-&gt;is_illegal() || value()-&gt;operand()-&gt;is_constant(), &quot;operand should never change&quot;);
 206   value()-&gt;set_operand(opr);
 207 
 208   if (opr-&gt;is_virtual()) {
 209     _gen-&gt;_instruction_for_operand.at_put_grow(opr-&gt;vreg_number(), value(), NULL);
 210   }
 211 
 212   _result = opr;
 213 }
 214 
 215 void LIRItem::load_item() {
 216   assert(!_gen-&gt;in_conditional_code(), &quot;LIRItem cannot be loaded in conditional code&quot;);
 217 
 218   if (result()-&gt;is_illegal()) {
 219     // update the items result
 220     _result = value()-&gt;operand();
 221   }
 222   if (!result()-&gt;is_register()) {
 223     LIR_Opr reg = _gen-&gt;new_register(value()-&gt;type());
 224     __ move(result(), reg);
 225     if (result()-&gt;is_constant()) {
 226       _result = reg;
 227     } else {
 228       set_result(reg);
 229     }
 230   }
 231 }
 232 
 233 
 234 void LIRItem::load_for_store(BasicType type) {
 235   if (_gen-&gt;can_store_as_constant(value(), type)) {
 236     _result = value()-&gt;operand();
 237     if (!_result-&gt;is_constant()) {
 238       _result = LIR_OprFact::value_type(value()-&gt;type());
 239     }
 240   } else if (type == T_BYTE || type == T_BOOLEAN) {
 241     load_byte_item();
 242   } else {
 243     load_item();
 244   }
 245 }
 246 
 247 void LIRItem::load_item_force(LIR_Opr reg) {
 248   LIR_Opr r = result();
 249   if (r != reg) {
 250 #if !defined(ARM) &amp;&amp; !defined(E500V2)
 251     if (r-&gt;type() != reg-&gt;type()) {
 252       // moves between different types need an intervening spill slot
 253       r = _gen-&gt;force_to_spill(r, reg-&gt;type());
 254     }
 255 #endif
 256     __ move(r, reg);
 257     _result = reg;
 258   }
 259 }
 260 
 261 ciObject* LIRItem::get_jobject_constant() const {
 262   ObjectType* oc = type()-&gt;as_ObjectType();
 263   if (oc) {
 264     return oc-&gt;constant_value();
 265   }
 266   return NULL;
 267 }
 268 
 269 
 270 jint LIRItem::get_jint_constant() const {
 271   assert(is_constant() &amp;&amp; value() != NULL, &quot;&quot;);
 272   assert(type()-&gt;as_IntConstant() != NULL, &quot;type check&quot;);
 273   return type()-&gt;as_IntConstant()-&gt;value();
 274 }
 275 
 276 
 277 jint LIRItem::get_address_constant() const {
 278   assert(is_constant() &amp;&amp; value() != NULL, &quot;&quot;);
 279   assert(type()-&gt;as_AddressConstant() != NULL, &quot;type check&quot;);
 280   return type()-&gt;as_AddressConstant()-&gt;value();
 281 }
 282 
 283 
 284 jfloat LIRItem::get_jfloat_constant() const {
 285   assert(is_constant() &amp;&amp; value() != NULL, &quot;&quot;);
 286   assert(type()-&gt;as_FloatConstant() != NULL, &quot;type check&quot;);
 287   return type()-&gt;as_FloatConstant()-&gt;value();
 288 }
 289 
 290 
 291 jdouble LIRItem::get_jdouble_constant() const {
 292   assert(is_constant() &amp;&amp; value() != NULL, &quot;&quot;);
 293   assert(type()-&gt;as_DoubleConstant() != NULL, &quot;type check&quot;);
 294   return type()-&gt;as_DoubleConstant()-&gt;value();
 295 }
 296 
 297 
 298 jlong LIRItem::get_jlong_constant() const {
 299   assert(is_constant() &amp;&amp; value() != NULL, &quot;&quot;);
 300   assert(type()-&gt;as_LongConstant() != NULL, &quot;type check&quot;);
 301   return type()-&gt;as_LongConstant()-&gt;value();
 302 }
 303 
 304 
 305 
 306 //--------------------------------------------------------------
 307 
 308 
 309 void LIRGenerator::block_do_prolog(BlockBegin* block) {
 310 #ifndef PRODUCT
 311   if (PrintIRWithLIR) {
 312     block-&gt;print();
 313   }
 314 #endif
 315 
 316   // set up the list of LIR instructions
 317   assert(block-&gt;lir() == NULL, &quot;LIR list already computed for this block&quot;);
 318   _lir = new LIR_List(compilation(), block);
 319   block-&gt;set_lir(_lir);
 320 
 321   __ branch_destination(block-&gt;label());
 322 
 323   if (LIRTraceExecution &amp;&amp;
 324       Compilation::current()-&gt;hir()-&gt;start()-&gt;block_id() != block-&gt;block_id() &amp;&amp;
 325       !block-&gt;is_set(BlockBegin::exception_entry_flag)) {
 326     assert(block-&gt;lir()-&gt;instructions_list()-&gt;length() == 1, &quot;should come right after br_dst&quot;);
 327     trace_block_entry(block);
 328   }
 329 }
 330 
 331 
 332 void LIRGenerator::block_do_epilog(BlockBegin* block) {
 333 #ifndef PRODUCT
 334   if (PrintIRWithLIR) {
 335     tty-&gt;cr();
 336   }
 337 #endif
 338 
 339   // LIR_Opr for unpinned constants shouldn&#39;t be referenced by other
 340   // blocks so clear them out after processing the block.
 341   for (int i = 0; i &lt; _unpinned_constants.length(); i++) {
 342     _unpinned_constants.at(i)-&gt;clear_operand();
 343   }
 344   _unpinned_constants.trunc_to(0);
 345 
 346   // clear our any registers for other local constants
 347   _constants.trunc_to(0);
 348   _reg_for_constants.trunc_to(0);
 349 }
 350 
 351 
 352 void LIRGenerator::block_do(BlockBegin* block) {
 353   CHECK_BAILOUT();
 354 
 355   block_do_prolog(block);
 356   set_block(block);
 357 
 358   for (Instruction* instr = block; instr != NULL; instr = instr-&gt;next()) {
 359     if (instr-&gt;is_pinned()) do_root(instr);
 360   }
 361 
 362   set_block(NULL);
 363   block_do_epilog(block);
 364 }
 365 
 366 
 367 //-------------------------LIRGenerator-----------------------------
 368 
 369 // This is where the tree-walk starts; instr must be root;
 370 void LIRGenerator::do_root(Value instr) {
 371   CHECK_BAILOUT();
 372 
 373   InstructionMark im(compilation(), instr);
 374 
 375   assert(instr-&gt;is_pinned(), &quot;use only with roots&quot;);
 376   assert(instr-&gt;subst() == instr, &quot;shouldn&#39;t have missed substitution&quot;);
 377 
 378   instr-&gt;visit(this);
 379 
 380   assert(!instr-&gt;has_uses() || instr-&gt;operand()-&gt;is_valid() ||
 381          instr-&gt;as_Constant() != NULL || bailed_out(), &quot;invalid item set&quot;);
 382 }
 383 
 384 
 385 // This is called for each node in tree; the walk stops if a root is reached
 386 void LIRGenerator::walk(Value instr) {
 387   InstructionMark im(compilation(), instr);
 388   //stop walk when encounter a root
 389   if ((instr-&gt;is_pinned() &amp;&amp; instr-&gt;as_Phi() == NULL) || instr-&gt;operand()-&gt;is_valid()) {
 390     assert(instr-&gt;operand() != LIR_OprFact::illegalOpr || instr-&gt;as_Constant() != NULL, &quot;this root has not yet been visited&quot;);
 391   } else {
 392     assert(instr-&gt;subst() == instr, &quot;shouldn&#39;t have missed substitution&quot;);
 393     instr-&gt;visit(this);
 394     // assert(instr-&gt;use_count() &gt; 0 || instr-&gt;as_Phi() != NULL, &quot;leaf instruction must have a use&quot;);
 395   }
 396 }
 397 
 398 
 399 CodeEmitInfo* LIRGenerator::state_for(Instruction* x, ValueStack* state, bool ignore_xhandler) {
 400   assert(state != NULL, &quot;state must be defined&quot;);
 401 
 402 #ifndef PRODUCT
 403   state-&gt;verify();
 404 #endif
 405 
 406   ValueStack* s = state;
 407   for_each_state(s) {
 408     if (s-&gt;kind() == ValueStack::EmptyExceptionState) {
 409       assert(s-&gt;stack_size() == 0 &amp;&amp; s-&gt;locals_size() == 0 &amp;&amp; (s-&gt;locks_size() == 0 || s-&gt;locks_size() == 1), &quot;state must be empty&quot;);
 410       continue;
 411     }
 412 
 413     int index;
 414     Value value;
 415     for_each_stack_value(s, index, value) {
 416       assert(value-&gt;subst() == value, &quot;missed substitution&quot;);
 417       if (!value-&gt;is_pinned() &amp;&amp; value-&gt;as_Constant() == NULL &amp;&amp; value-&gt;as_Local() == NULL) {
 418         walk(value);
 419         assert(value-&gt;operand()-&gt;is_valid(), &quot;must be evaluated now&quot;);
 420       }
 421     }
 422 
 423     int bci = s-&gt;bci();
 424     IRScope* scope = s-&gt;scope();
 425     ciMethod* method = scope-&gt;method();
 426 
 427     MethodLivenessResult liveness = method-&gt;liveness_at_bci(bci);
 428     if (bci == SynchronizationEntryBCI) {
 429       if (x-&gt;as_ExceptionObject() || x-&gt;as_Throw()) {
 430         // all locals are dead on exit from the synthetic unlocker
 431         liveness.clear();
 432       } else {
 433         assert(x-&gt;as_MonitorEnter() || x-&gt;as_ProfileInvoke(), &quot;only other cases are MonitorEnter and ProfileInvoke&quot;);
 434       }
 435     }
 436     if (!liveness.is_valid()) {
 437       // Degenerate or breakpointed method.
 438       bailout(&quot;Degenerate or breakpointed method&quot;);
 439     } else {
 440       assert((int)liveness.size() == s-&gt;locals_size(), &quot;error in use of liveness&quot;);
 441       for_each_local_value(s, index, value) {
 442         assert(value-&gt;subst() == value, &quot;missed substition&quot;);
 443         if (liveness.at(index) &amp;&amp; !value-&gt;type()-&gt;is_illegal()) {
 444           if (!value-&gt;is_pinned() &amp;&amp; value-&gt;as_Constant() == NULL &amp;&amp; value-&gt;as_Local() == NULL) {
 445             walk(value);
 446             assert(value-&gt;operand()-&gt;is_valid(), &quot;must be evaluated now&quot;);
 447           }
 448         } else {
 449           // NULL out this local so that linear scan can assume that all non-NULL values are live.
 450           s-&gt;invalidate_local(index);
 451         }
 452       }
 453     }
 454   }
 455 
 456   return new CodeEmitInfo(state, ignore_xhandler ? NULL : x-&gt;exception_handlers(), x-&gt;check_flag(Instruction::DeoptimizeOnException));
 457 }
 458 
 459 
 460 CodeEmitInfo* LIRGenerator::state_for(Instruction* x) {
 461   return state_for(x, x-&gt;exception_state());
 462 }
 463 
 464 
 465 void LIRGenerator::klass2reg_with_patching(LIR_Opr r, ciMetadata* obj, CodeEmitInfo* info, bool need_resolve) {
 466   /* C2 relies on constant pool entries being resolved (ciTypeFlow), so if TieredCompilation
 467    * is active and the class hasn&#39;t yet been resolved we need to emit a patch that resolves
 468    * the class. */
 469   if ((TieredCompilation &amp;&amp; need_resolve) || !obj-&gt;is_loaded() || PatchALot) {
 470     assert(info != NULL, &quot;info must be set if class is not loaded&quot;);
 471     __ klass2reg_patch(NULL, r, info);
 472   } else {
 473     // no patching needed
 474     __ metadata2reg(obj-&gt;constant_encoding(), r);
 475   }
 476 }
 477 
 478 
 479 void LIRGenerator::array_range_check(LIR_Opr array, LIR_Opr index,
 480                                     CodeEmitInfo* null_check_info, CodeEmitInfo* range_check_info) {
 481   CodeStub* stub = new RangeCheckStub(range_check_info, index, array);
 482   if (index-&gt;is_constant()) {
 483     cmp_mem_int(lir_cond_belowEqual, array, arrayOopDesc::length_offset_in_bytes(),
 484                 index-&gt;as_jint(), null_check_info);
 485     __ branch(lir_cond_belowEqual, stub); // forward branch
 486   } else {
 487     cmp_reg_mem(lir_cond_aboveEqual, index, array,
 488                 arrayOopDesc::length_offset_in_bytes(), T_INT, null_check_info);
 489     __ branch(lir_cond_aboveEqual, stub); // forward branch
 490   }
 491 }
 492 
 493 
 494 void LIRGenerator::nio_range_check(LIR_Opr buffer, LIR_Opr index, LIR_Opr result, CodeEmitInfo* info) {
 495   CodeStub* stub = new RangeCheckStub(info, index);
 496   if (index-&gt;is_constant()) {
 497     cmp_mem_int(lir_cond_belowEqual, buffer, java_nio_Buffer::limit_offset(), index-&gt;as_jint(), info);
 498     __ branch(lir_cond_belowEqual, stub); // forward branch
 499   } else {
 500     cmp_reg_mem(lir_cond_aboveEqual, index, buffer,
 501                 java_nio_Buffer::limit_offset(), T_INT, info);
 502     __ branch(lir_cond_aboveEqual, stub); // forward branch
 503   }
 504   __ move(index, result);
 505 }
 506 
 507 
 508 
 509 void LIRGenerator::arithmetic_op(Bytecodes::Code code, LIR_Opr result, LIR_Opr left, LIR_Opr right, bool is_strictfp, LIR_Opr tmp_op, CodeEmitInfo* info) {
 510   LIR_Opr result_op = result;
 511   LIR_Opr left_op   = left;
 512   LIR_Opr right_op  = right;
 513 
 514   if (TwoOperandLIRForm &amp;&amp; left_op != result_op) {
 515     assert(right_op != result_op, &quot;malformed&quot;);
 516     __ move(left_op, result_op);
 517     left_op = result_op;
 518   }
 519 
 520   switch(code) {
 521     case Bytecodes::_dadd:
 522     case Bytecodes::_fadd:
 523     case Bytecodes::_ladd:
 524     case Bytecodes::_iadd:  __ add(left_op, right_op, result_op); break;
 525     case Bytecodes::_fmul:
 526     case Bytecodes::_lmul:  __ mul(left_op, right_op, result_op); break;
 527 
 528     case Bytecodes::_dmul:
 529       {
 530         if (is_strictfp) {
 531           __ mul_strictfp(left_op, right_op, result_op, tmp_op); break;
 532         } else {
 533           __ mul(left_op, right_op, result_op); break;
 534         }
 535       }
 536       break;
 537 
 538     case Bytecodes::_imul:
 539       {
 540         bool did_strength_reduce = false;
 541 
 542         if (right-&gt;is_constant()) {
 543           jint c = right-&gt;as_jint();
 544           if (c &gt; 0 &amp;&amp; is_power_of_2(c)) {
 545             // do not need tmp here
 546             __ shift_left(left_op, exact_log2(c), result_op);
 547             did_strength_reduce = true;
 548           } else {
 549             did_strength_reduce = strength_reduce_multiply(left_op, c, result_op, tmp_op);
 550           }
 551         }
 552         // we couldn&#39;t strength reduce so just emit the multiply
 553         if (!did_strength_reduce) {
 554           __ mul(left_op, right_op, result_op);
 555         }
 556       }
 557       break;
 558 
 559     case Bytecodes::_dsub:
 560     case Bytecodes::_fsub:
 561     case Bytecodes::_lsub:
 562     case Bytecodes::_isub: __ sub(left_op, right_op, result_op); break;
 563 
 564     case Bytecodes::_fdiv: __ div (left_op, right_op, result_op); break;
 565     // ldiv and lrem are implemented with a direct runtime call
 566 
 567     case Bytecodes::_ddiv:
 568       {
 569         if (is_strictfp) {
 570           __ div_strictfp (left_op, right_op, result_op, tmp_op); break;
 571         } else {
 572           __ div (left_op, right_op, result_op); break;
 573         }
 574       }
 575       break;
 576 
 577     case Bytecodes::_drem:
 578     case Bytecodes::_frem: __ rem (left_op, right_op, result_op); break;
 579 
 580     default: ShouldNotReachHere();
 581   }
 582 }
 583 
 584 
 585 void LIRGenerator::arithmetic_op_int(Bytecodes::Code code, LIR_Opr result, LIR_Opr left, LIR_Opr right, LIR_Opr tmp) {
 586   arithmetic_op(code, result, left, right, false, tmp);
 587 }
 588 
 589 
 590 void LIRGenerator::arithmetic_op_long(Bytecodes::Code code, LIR_Opr result, LIR_Opr left, LIR_Opr right, CodeEmitInfo* info) {
 591   arithmetic_op(code, result, left, right, false, LIR_OprFact::illegalOpr, info);
 592 }
 593 
 594 
 595 void LIRGenerator::arithmetic_op_fpu(Bytecodes::Code code, LIR_Opr result, LIR_Opr left, LIR_Opr right, bool is_strictfp, LIR_Opr tmp) {
 596   arithmetic_op(code, result, left, right, is_strictfp, tmp);
 597 }
 598 
 599 
 600 void LIRGenerator::shift_op(Bytecodes::Code code, LIR_Opr result_op, LIR_Opr value, LIR_Opr count, LIR_Opr tmp) {
 601 
 602   if (TwoOperandLIRForm &amp;&amp; value != result_op
 603       // Only 32bit right shifts require two operand form on S390.
 604       S390_ONLY(&amp;&amp; (code == Bytecodes::_ishr || code == Bytecodes::_iushr))) {
 605     assert(count != result_op, &quot;malformed&quot;);
 606     __ move(value, result_op);
 607     value = result_op;
 608   }
 609 
 610   assert(count-&gt;is_constant() || count-&gt;is_register(), &quot;must be&quot;);
 611   switch(code) {
 612   case Bytecodes::_ishl:
 613   case Bytecodes::_lshl: __ shift_left(value, count, result_op, tmp); break;
 614   case Bytecodes::_ishr:
 615   case Bytecodes::_lshr: __ shift_right(value, count, result_op, tmp); break;
 616   case Bytecodes::_iushr:
 617   case Bytecodes::_lushr: __ unsigned_shift_right(value, count, result_op, tmp); break;
 618   default: ShouldNotReachHere();
 619   }
 620 }
 621 
 622 
 623 void LIRGenerator::logic_op (Bytecodes::Code code, LIR_Opr result_op, LIR_Opr left_op, LIR_Opr right_op) {
 624   if (TwoOperandLIRForm &amp;&amp; left_op != result_op) {
 625     assert(right_op != result_op, &quot;malformed&quot;);
 626     __ move(left_op, result_op);
 627     left_op = result_op;
 628   }
 629 
 630   switch(code) {
 631     case Bytecodes::_iand:
 632     case Bytecodes::_land:  __ logical_and(left_op, right_op, result_op); break;
 633 
 634     case Bytecodes::_ior:
 635     case Bytecodes::_lor:   __ logical_or(left_op, right_op, result_op);  break;
 636 
 637     case Bytecodes::_ixor:
 638     case Bytecodes::_lxor:  __ logical_xor(left_op, right_op, result_op); break;
 639 
 640     default: ShouldNotReachHere();
 641   }
 642 }
 643 
 644 
 645 void LIRGenerator::monitor_enter(LIR_Opr object, LIR_Opr lock, LIR_Opr hdr, LIR_Opr scratch, int monitor_no,
 646                                  CodeEmitInfo* info_for_exception, CodeEmitInfo* info, CodeStub* throw_imse_stub) {
 647   if (!GenerateSynchronizationCode) return;
 648   // for slow path, use debug info for state after successful locking
 649   CodeStub* slow_path = new MonitorEnterStub(object, lock, info, throw_imse_stub, scratch);
 650   __ load_stack_address_monitor(monitor_no, lock);
 651   // for handling NullPointerException, use debug info representing just the lock stack before this monitorenter
 652   __ lock_object(hdr, object, lock, scratch, slow_path, info_for_exception, throw_imse_stub);
 653 }
 654 
 655 
 656 void LIRGenerator::monitor_exit(LIR_Opr object, LIR_Opr lock, LIR_Opr new_hdr, LIR_Opr scratch, int monitor_no) {
 657   if (!GenerateSynchronizationCode) return;
 658   // setup registers
 659   LIR_Opr hdr = lock;
 660   lock = new_hdr;
 661   CodeStub* slow_path = new MonitorExitStub(lock, UseFastLocking, monitor_no);
 662   __ load_stack_address_monitor(monitor_no, lock);
 663   __ unlock_object(hdr, object, lock, scratch, slow_path);
 664 }
 665 
 666 #ifndef PRODUCT
 667 void LIRGenerator::print_if_not_loaded(const NewInstance* new_instance) {
 668   if (PrintNotLoaded &amp;&amp; !new_instance-&gt;klass()-&gt;is_loaded()) {
 669     tty-&gt;print_cr(&quot;   ###class not loaded at new bci %d&quot;, new_instance-&gt;printable_bci());
 670   } else if (PrintNotLoaded &amp;&amp; (TieredCompilation &amp;&amp; new_instance-&gt;is_unresolved())) {
 671     tty-&gt;print_cr(&quot;   ###class not resolved at new bci %d&quot;, new_instance-&gt;printable_bci());
 672   }
 673 }
 674 #endif
 675 
 676 void LIRGenerator::new_instance(LIR_Opr dst, ciInstanceKlass* klass, bool is_unresolved, LIR_Opr scratch1, LIR_Opr scratch2, LIR_Opr scratch3, LIR_Opr scratch4, LIR_Opr klass_reg, CodeEmitInfo* info) {
 677   klass2reg_with_patching(klass_reg, klass, info, is_unresolved);
 678   // If klass is not loaded we do not know if the klass has finalizers:
 679   if (UseFastNewInstance &amp;&amp; klass-&gt;is_loaded()
 680       &amp;&amp; !Klass::layout_helper_needs_slow_path(klass-&gt;layout_helper())) {
 681 
 682     Runtime1::StubID stub_id = klass-&gt;is_initialized() ? Runtime1::fast_new_instance_id : Runtime1::fast_new_instance_init_check_id;
 683 
 684     CodeStub* slow_path = new NewInstanceStub(klass_reg, dst, klass, info, stub_id);
 685 
 686     assert(klass-&gt;is_loaded(), &quot;must be loaded&quot;);
 687     // allocate space for instance
 688     assert(klass-&gt;size_helper() &gt;= 0, &quot;illegal instance size&quot;);
 689     const int instance_size = align_object_size(klass-&gt;size_helper());
 690     __ allocate_object(dst, scratch1, scratch2, scratch3, scratch4,
 691                        oopDesc::header_size(), instance_size, klass_reg, !klass-&gt;is_initialized(), slow_path);
 692   } else {
 693     CodeStub* slow_path = new NewInstanceStub(klass_reg, dst, klass, info, Runtime1::new_instance_id);
 694     __ branch(lir_cond_always, slow_path);
 695     __ branch_destination(slow_path-&gt;continuation());
 696   }
 697 }
 698 
 699 
 700 static bool is_constant_zero(Instruction* inst) {
 701   IntConstant* c = inst-&gt;type()-&gt;as_IntConstant();
 702   if (c) {
 703     return (c-&gt;value() == 0);
 704   }
 705   return false;
 706 }
 707 
 708 
 709 static bool positive_constant(Instruction* inst) {
 710   IntConstant* c = inst-&gt;type()-&gt;as_IntConstant();
 711   if (c) {
 712     return (c-&gt;value() &gt;= 0);
 713   }
 714   return false;
 715 }
 716 
 717 
 718 static ciArrayKlass* as_array_klass(ciType* type) {
 719   if (type != NULL &amp;&amp; type-&gt;is_array_klass() &amp;&amp; type-&gt;is_loaded()) {
 720     return (ciArrayKlass*)type;
 721   } else {
 722     return NULL;
 723   }
 724 }
 725 
 726 static ciType* phi_declared_type(Phi* phi) {
 727   ciType* t = phi-&gt;operand_at(0)-&gt;declared_type();
 728   if (t == NULL) {
 729     return NULL;
 730   }
 731   for(int i = 1; i &lt; phi-&gt;operand_count(); i++) {
 732     if (t != phi-&gt;operand_at(i)-&gt;declared_type()) {
 733       return NULL;
 734     }
 735   }
 736   return t;
 737 }
 738 
 739 void LIRGenerator::arraycopy_helper(Intrinsic* x, int* flagsp, ciArrayKlass** expected_typep) {
 740   Instruction* src     = x-&gt;argument_at(0);
 741   Instruction* src_pos = x-&gt;argument_at(1);
 742   Instruction* dst     = x-&gt;argument_at(2);
 743   Instruction* dst_pos = x-&gt;argument_at(3);
 744   Instruction* length  = x-&gt;argument_at(4);
 745 
 746   // first try to identify the likely type of the arrays involved
 747   ciArrayKlass* expected_type = NULL;
 748   bool is_exact = false, src_objarray = false, dst_objarray = false;
 749   {
 750     ciArrayKlass* src_exact_type    = as_array_klass(src-&gt;exact_type());
 751     ciArrayKlass* src_declared_type = as_array_klass(src-&gt;declared_type());
 752     Phi* phi;
 753     if (src_declared_type == NULL &amp;&amp; (phi = src-&gt;as_Phi()) != NULL) {
 754       src_declared_type = as_array_klass(phi_declared_type(phi));
 755     }
 756     ciArrayKlass* dst_exact_type    = as_array_klass(dst-&gt;exact_type());
 757     ciArrayKlass* dst_declared_type = as_array_klass(dst-&gt;declared_type());
 758     if (dst_declared_type == NULL &amp;&amp; (phi = dst-&gt;as_Phi()) != NULL) {
 759       dst_declared_type = as_array_klass(phi_declared_type(phi));
 760     }
 761 
 762     if (src_exact_type != NULL &amp;&amp; src_exact_type == dst_exact_type) {
 763       // the types exactly match so the type is fully known
 764       is_exact = true;
 765       expected_type = src_exact_type;
 766     } else if (dst_exact_type != NULL &amp;&amp; dst_exact_type-&gt;is_obj_array_klass()) {
 767       ciArrayKlass* dst_type = (ciArrayKlass*) dst_exact_type;
 768       ciArrayKlass* src_type = NULL;
 769       if (src_exact_type != NULL &amp;&amp; src_exact_type-&gt;is_obj_array_klass()) {
 770         src_type = (ciArrayKlass*) src_exact_type;
 771       } else if (src_declared_type != NULL &amp;&amp; src_declared_type-&gt;is_obj_array_klass()) {
 772         src_type = (ciArrayKlass*) src_declared_type;
 773       }
 774       if (src_type != NULL) {
 775         if (src_type-&gt;element_type()-&gt;is_subtype_of(dst_type-&gt;element_type())) {
 776           is_exact = true;
 777           expected_type = dst_type;
 778         }
 779       }
 780     }
 781     // at least pass along a good guess
 782     if (expected_type == NULL) expected_type = dst_exact_type;
 783     if (expected_type == NULL) expected_type = src_declared_type;
 784     if (expected_type == NULL) expected_type = dst_declared_type;
 785 
 786     src_objarray = (src_exact_type &amp;&amp; src_exact_type-&gt;is_obj_array_klass()) || (src_declared_type &amp;&amp; src_declared_type-&gt;is_obj_array_klass());
 787     dst_objarray = (dst_exact_type &amp;&amp; dst_exact_type-&gt;is_obj_array_klass()) || (dst_declared_type &amp;&amp; dst_declared_type-&gt;is_obj_array_klass());
 788   }
 789 
 790   // if a probable array type has been identified, figure out if any
 791   // of the required checks for a fast case can be elided.
 792   int flags = LIR_OpArrayCopy::all_flags;
 793 
 794   if (!src-&gt;is_loaded_flattened_array() &amp;&amp; !dst-&gt;is_loaded_flattened_array()) {
 795     flags &amp;= ~LIR_OpArrayCopy::always_slow_path;
 796   }
 797   if (!src-&gt;maybe_flattened_array()) {
 798     flags &amp;= ~LIR_OpArrayCopy::src_valuetype_check;
 799   }
 800   if (!dst-&gt;maybe_flattened_array() &amp;&amp; !dst-&gt;maybe_null_free_array()) {
 801     flags &amp;= ~LIR_OpArrayCopy::dst_valuetype_check;
 802   }
 803 
 804   if (!src_objarray)
 805     flags &amp;= ~LIR_OpArrayCopy::src_objarray;
 806   if (!dst_objarray)
 807     flags &amp;= ~LIR_OpArrayCopy::dst_objarray;
 808 
 809   if (!x-&gt;arg_needs_null_check(0))
 810     flags &amp;= ~LIR_OpArrayCopy::src_null_check;
 811   if (!x-&gt;arg_needs_null_check(2))
 812     flags &amp;= ~LIR_OpArrayCopy::dst_null_check;
 813 
 814 
 815   if (expected_type != NULL) {
 816     Value length_limit = NULL;
 817 
 818     IfOp* ifop = length-&gt;as_IfOp();
 819     if (ifop != NULL) {
 820       // look for expressions like min(v, a.length) which ends up as
 821       //   x &gt; y ? y : x  or  x &gt;= y ? y : x
 822       if ((ifop-&gt;cond() == If::gtr || ifop-&gt;cond() == If::geq) &amp;&amp;
 823           ifop-&gt;x() == ifop-&gt;fval() &amp;&amp;
 824           ifop-&gt;y() == ifop-&gt;tval()) {
 825         length_limit = ifop-&gt;y();
 826       }
 827     }
 828 
 829     // try to skip null checks and range checks
 830     NewArray* src_array = src-&gt;as_NewArray();
 831     if (src_array != NULL) {
 832       flags &amp;= ~LIR_OpArrayCopy::src_null_check;
 833       if (length_limit != NULL &amp;&amp;
 834           src_array-&gt;length() == length_limit &amp;&amp;
 835           is_constant_zero(src_pos)) {
 836         flags &amp;= ~LIR_OpArrayCopy::src_range_check;
 837       }
 838     }
 839 
 840     NewArray* dst_array = dst-&gt;as_NewArray();
 841     if (dst_array != NULL) {
 842       flags &amp;= ~LIR_OpArrayCopy::dst_null_check;
 843       if (length_limit != NULL &amp;&amp;
 844           dst_array-&gt;length() == length_limit &amp;&amp;
 845           is_constant_zero(dst_pos)) {
 846         flags &amp;= ~LIR_OpArrayCopy::dst_range_check;
 847       }
 848     }
 849 
 850     // check from incoming constant values
 851     if (positive_constant(src_pos))
 852       flags &amp;= ~LIR_OpArrayCopy::src_pos_positive_check;
 853     if (positive_constant(dst_pos))
 854       flags &amp;= ~LIR_OpArrayCopy::dst_pos_positive_check;
 855     if (positive_constant(length))
 856       flags &amp;= ~LIR_OpArrayCopy::length_positive_check;
 857 
 858     // see if the range check can be elided, which might also imply
 859     // that src or dst is non-null.
 860     ArrayLength* al = length-&gt;as_ArrayLength();
 861     if (al != NULL) {
 862       if (al-&gt;array() == src) {
 863         // it&#39;s the length of the source array
 864         flags &amp;= ~LIR_OpArrayCopy::length_positive_check;
 865         flags &amp;= ~LIR_OpArrayCopy::src_null_check;
 866         if (is_constant_zero(src_pos))
 867           flags &amp;= ~LIR_OpArrayCopy::src_range_check;
 868       }
 869       if (al-&gt;array() == dst) {
 870         // it&#39;s the length of the destination array
 871         flags &amp;= ~LIR_OpArrayCopy::length_positive_check;
 872         flags &amp;= ~LIR_OpArrayCopy::dst_null_check;
 873         if (is_constant_zero(dst_pos))
 874           flags &amp;= ~LIR_OpArrayCopy::dst_range_check;
 875       }
 876     }
 877     if (is_exact) {
 878       flags &amp;= ~LIR_OpArrayCopy::type_check;
 879     }
 880   }
 881 
 882   IntConstant* src_int = src_pos-&gt;type()-&gt;as_IntConstant();
 883   IntConstant* dst_int = dst_pos-&gt;type()-&gt;as_IntConstant();
 884   if (src_int &amp;&amp; dst_int) {
 885     int s_offs = src_int-&gt;value();
 886     int d_offs = dst_int-&gt;value();
 887     if (src_int-&gt;value() &gt;= dst_int-&gt;value()) {
 888       flags &amp;= ~LIR_OpArrayCopy::overlapping;
 889     }
 890     if (expected_type != NULL) {
 891       BasicType t = expected_type-&gt;element_type()-&gt;basic_type();
 892       int element_size = type2aelembytes(t);
 893       if (((arrayOopDesc::base_offset_in_bytes(t) + s_offs * element_size) % HeapWordSize == 0) &amp;&amp;
 894           ((arrayOopDesc::base_offset_in_bytes(t) + d_offs * element_size) % HeapWordSize == 0)) {
 895         flags &amp;= ~LIR_OpArrayCopy::unaligned;
 896       }
 897     }
 898   } else if (src_pos == dst_pos || is_constant_zero(dst_pos)) {
 899     // src and dest positions are the same, or dst is zero so assume
 900     // nonoverlapping copy.
 901     flags &amp;= ~LIR_OpArrayCopy::overlapping;
 902   }
 903 
 904   if (src == dst) {
 905     // moving within a single array so no type checks are needed
 906     if (flags &amp; LIR_OpArrayCopy::type_check) {
 907       flags &amp;= ~LIR_OpArrayCopy::type_check;
 908     }
 909   }
 910   *flagsp = flags;
 911   *expected_typep = (ciArrayKlass*)expected_type;
 912 }
 913 
 914 
 915 LIR_Opr LIRGenerator::round_item(LIR_Opr opr) {
 916   assert(opr-&gt;is_register(), &quot;why spill if item is not register?&quot;);
 917 
 918   if (strict_fp_requires_explicit_rounding) {
 919 #ifdef IA32
 920     if (UseSSE &lt; 1 &amp;&amp; opr-&gt;is_single_fpu()) {
 921       LIR_Opr result = new_register(T_FLOAT);
 922       set_vreg_flag(result, must_start_in_memory);
 923       assert(opr-&gt;is_register(), &quot;only a register can be spilled&quot;);
 924       assert(opr-&gt;value_type()-&gt;is_float(), &quot;rounding only for floats available&quot;);
 925       __ roundfp(opr, LIR_OprFact::illegalOpr, result);
 926       return result;
 927     }
 928 #else
 929     Unimplemented();
 930 #endif // IA32
 931   }
 932   return opr;
 933 }
 934 
 935 
 936 LIR_Opr LIRGenerator::force_to_spill(LIR_Opr value, BasicType t) {
 937   assert(type2size[t] == type2size[value-&gt;type()],
 938          &quot;size mismatch: t=%s, value-&gt;type()=%s&quot;, type2name(t), type2name(value-&gt;type()));
 939   if (!value-&gt;is_register()) {
 940     // force into a register
 941     LIR_Opr r = new_register(value-&gt;type());
 942     __ move(value, r);
 943     value = r;
 944   }
 945 
 946   // create a spill location
 947   LIR_Opr tmp = new_register(t);
 948   set_vreg_flag(tmp, LIRGenerator::must_start_in_memory);
 949 
 950   // move from register to spill
 951   __ move(value, tmp);
 952   return tmp;
 953 }
 954 
 955 void LIRGenerator::profile_branch(If* if_instr, If::Condition cond) {
 956   if (if_instr-&gt;should_profile()) {
 957     ciMethod* method = if_instr-&gt;profiled_method();
 958     assert(method != NULL, &quot;method should be set if branch is profiled&quot;);
 959     ciMethodData* md = method-&gt;method_data_or_null();
 960     assert(md != NULL, &quot;Sanity&quot;);
 961     ciProfileData* data = md-&gt;bci_to_data(if_instr-&gt;profiled_bci());
 962     assert(data != NULL, &quot;must have profiling data&quot;);
 963     assert(data-&gt;is_BranchData(), &quot;need BranchData for two-way branches&quot;);
 964     int taken_count_offset     = md-&gt;byte_offset_of_slot(data, BranchData::taken_offset());
 965     int not_taken_count_offset = md-&gt;byte_offset_of_slot(data, BranchData::not_taken_offset());
 966     if (if_instr-&gt;is_swapped()) {
 967       int t = taken_count_offset;
 968       taken_count_offset = not_taken_count_offset;
 969       not_taken_count_offset = t;
 970     }
 971 
 972     LIR_Opr md_reg = new_register(T_METADATA);
 973     __ metadata2reg(md-&gt;constant_encoding(), md_reg);
 974 
 975     LIR_Opr data_offset_reg = new_pointer_register();
 976     __ cmove(lir_cond(cond),
 977              LIR_OprFact::intptrConst(taken_count_offset),
 978              LIR_OprFact::intptrConst(not_taken_count_offset),
 979              data_offset_reg, as_BasicType(if_instr-&gt;x()-&gt;type()));
 980 
 981     // MDO cells are intptr_t, so the data_reg width is arch-dependent.
 982     LIR_Opr data_reg = new_pointer_register();
 983     LIR_Address* data_addr = new LIR_Address(md_reg, data_offset_reg, data_reg-&gt;type());
 984     __ move(data_addr, data_reg);
 985     // Use leal instead of add to avoid destroying condition codes on x86
 986     LIR_Address* fake_incr_value = new LIR_Address(data_reg, DataLayout::counter_increment, T_INT);
 987     __ leal(LIR_OprFact::address(fake_incr_value), data_reg);
 988     __ move(data_reg, data_addr);
 989   }
 990 }
 991 
 992 // Phi technique:
 993 // This is about passing live values from one basic block to the other.
 994 // In code generated with Java it is rather rare that more than one
 995 // value is on the stack from one basic block to the other.
 996 // We optimize our technique for efficient passing of one value
 997 // (of type long, int, double..) but it can be extended.
 998 // When entering or leaving a basic block, all registers and all spill
 999 // slots are release and empty. We use the released registers
1000 // and spill slots to pass the live values from one block
1001 // to the other. The topmost value, i.e., the value on TOS of expression
1002 // stack is passed in registers. All other values are stored in spilling
1003 // area. Every Phi has an index which designates its spill slot
1004 // At exit of a basic block, we fill the register(s) and spill slots.
1005 // At entry of a basic block, the block_prolog sets up the content of phi nodes
1006 // and locks necessary registers and spilling slots.
1007 
1008 
1009 // move current value to referenced phi function
1010 void LIRGenerator::move_to_phi(PhiResolver* resolver, Value cur_val, Value sux_val) {
1011   Phi* phi = sux_val-&gt;as_Phi();
1012   // cur_val can be null without phi being null in conjunction with inlining
1013   if (phi != NULL &amp;&amp; cur_val != NULL &amp;&amp; cur_val != phi &amp;&amp; !phi-&gt;is_illegal()) {
1014     Phi* cur_phi = cur_val-&gt;as_Phi();
1015     if (cur_phi != NULL &amp;&amp; cur_phi-&gt;is_illegal()) {
1016       // Phi and local would need to get invalidated
1017       // (which is unexpected for Linear Scan).
1018       // But this case is very rare so we simply bail out.
1019       bailout(&quot;propagation of illegal phi&quot;);
1020       return;
1021     }
1022     LIR_Opr operand = cur_val-&gt;operand();
1023     if (operand-&gt;is_illegal()) {
1024       assert(cur_val-&gt;as_Constant() != NULL || cur_val-&gt;as_Local() != NULL,
1025              &quot;these can be produced lazily&quot;);
1026       operand = operand_for_instruction(cur_val);
1027     }
1028     resolver-&gt;move(operand, operand_for_instruction(phi));
1029   }
1030 }
1031 
1032 
1033 // Moves all stack values into their PHI position
1034 void LIRGenerator::move_to_phi(ValueStack* cur_state) {
1035   BlockBegin* bb = block();
1036   if (bb-&gt;number_of_sux() == 1) {
1037     BlockBegin* sux = bb-&gt;sux_at(0);
1038     assert(sux-&gt;number_of_preds() &gt; 0, &quot;invalid CFG&quot;);
1039 
1040     // a block with only one predecessor never has phi functions
1041     if (sux-&gt;number_of_preds() &gt; 1) {
1042       PhiResolver resolver(this);
1043 
1044       ValueStack* sux_state = sux-&gt;state();
1045       Value sux_value;
1046       int index;
1047 
1048       assert(cur_state-&gt;scope() == sux_state-&gt;scope(), &quot;not matching&quot;);
1049       assert(cur_state-&gt;locals_size() == sux_state-&gt;locals_size(), &quot;not matching&quot;);
1050       assert(cur_state-&gt;stack_size() == sux_state-&gt;stack_size(), &quot;not matching&quot;);
1051 
1052       for_each_stack_value(sux_state, index, sux_value) {
1053         move_to_phi(&amp;resolver, cur_state-&gt;stack_at(index), sux_value);
1054       }
1055 
1056       for_each_local_value(sux_state, index, sux_value) {
1057         move_to_phi(&amp;resolver, cur_state-&gt;local_at(index), sux_value);
1058       }
1059 
1060       assert(cur_state-&gt;caller_state() == sux_state-&gt;caller_state(), &quot;caller states must be equal&quot;);
1061     }
1062   }
1063 }
1064 
1065 
1066 LIR_Opr LIRGenerator::new_register(BasicType type) {
1067   int vreg = _virtual_register_number;
1068   // add a little fudge factor for the bailout, since the bailout is
1069   // only checked periodically.  This gives a few extra registers to
1070   // hand out before we really run out, which helps us keep from
1071   // tripping over assertions.
1072   if (vreg + 20 &gt;= LIR_OprDesc::vreg_max) {
1073     bailout(&quot;out of virtual registers&quot;);
1074     if (vreg + 2 &gt;= LIR_OprDesc::vreg_max) {
1075       // wrap it around
1076       _virtual_register_number = LIR_OprDesc::vreg_base;
1077     }
1078   }
1079   _virtual_register_number += 1;
1080   return LIR_OprFact::virtual_register(vreg, type);
1081 }
1082 
1083 
1084 // Try to lock using register in hint
1085 LIR_Opr LIRGenerator::rlock(Value instr) {
1086   return new_register(instr-&gt;type());
1087 }
1088 
1089 
1090 // does an rlock and sets result
1091 LIR_Opr LIRGenerator::rlock_result(Value x) {
1092   LIR_Opr reg = rlock(x);
1093   set_result(x, reg);
1094   return reg;
1095 }
1096 
1097 
1098 // does an rlock and sets result
1099 LIR_Opr LIRGenerator::rlock_result(Value x, BasicType type) {
1100   LIR_Opr reg;
1101   switch (type) {
1102   case T_BYTE:
1103   case T_BOOLEAN:
1104     reg = rlock_byte(type);
1105     break;
1106   default:
1107     reg = rlock(x);
1108     break;
1109   }
1110 
1111   set_result(x, reg);
1112   return reg;
1113 }
1114 
1115 
1116 //---------------------------------------------------------------------
1117 ciObject* LIRGenerator::get_jobject_constant(Value value) {
1118   ObjectType* oc = value-&gt;type()-&gt;as_ObjectType();
1119   if (oc) {
1120     return oc-&gt;constant_value();
1121   }
1122   return NULL;
1123 }
1124 
1125 
1126 void LIRGenerator::do_ExceptionObject(ExceptionObject* x) {
1127   assert(block()-&gt;is_set(BlockBegin::exception_entry_flag), &quot;ExceptionObject only allowed in exception handler block&quot;);
1128   assert(block()-&gt;next() == x, &quot;ExceptionObject must be first instruction of block&quot;);
1129 
1130   // no moves are created for phi functions at the begin of exception
1131   // handlers, so assign operands manually here
1132   for_each_phi_fun(block(), phi,
1133                    if (!phi-&gt;is_illegal()) { operand_for_instruction(phi); });
1134 
1135   LIR_Opr thread_reg = getThreadPointer();
1136   __ move_wide(new LIR_Address(thread_reg, in_bytes(JavaThread::exception_oop_offset()), T_OBJECT),
1137                exceptionOopOpr());
1138   __ move_wide(LIR_OprFact::oopConst(NULL),
1139                new LIR_Address(thread_reg, in_bytes(JavaThread::exception_oop_offset()), T_OBJECT));
1140   __ move_wide(LIR_OprFact::oopConst(NULL),
1141                new LIR_Address(thread_reg, in_bytes(JavaThread::exception_pc_offset()), T_OBJECT));
1142 
1143   LIR_Opr result = new_register(T_OBJECT);
1144   __ move(exceptionOopOpr(), result);
1145   set_result(x, result);
1146 }
1147 
1148 
1149 //----------------------------------------------------------------------
1150 //----------------------------------------------------------------------
1151 //----------------------------------------------------------------------
1152 //----------------------------------------------------------------------
1153 //                        visitor functions
1154 //----------------------------------------------------------------------
1155 //----------------------------------------------------------------------
1156 //----------------------------------------------------------------------
1157 //----------------------------------------------------------------------
1158 
1159 void LIRGenerator::do_Phi(Phi* x) {
1160   // phi functions are never visited directly
1161   ShouldNotReachHere();
1162 }
1163 
1164 
1165 // Code for a constant is generated lazily unless the constant is frequently used and can&#39;t be inlined.
1166 void LIRGenerator::do_Constant(Constant* x) {
1167   if (x-&gt;state_before() != NULL) {
1168     // Any constant with a ValueStack requires patching so emit the patch here
1169     LIR_Opr reg = rlock_result(x);
1170     CodeEmitInfo* info = state_for(x, x-&gt;state_before());
1171     __ oop2reg_patch(NULL, reg, info);
1172   } else if (x-&gt;use_count() &gt; 1 &amp;&amp; !can_inline_as_constant(x)) {
1173     if (!x-&gt;is_pinned()) {
1174       // unpinned constants are handled specially so that they can be
1175       // put into registers when they are used multiple times within a
1176       // block.  After the block completes their operand will be
1177       // cleared so that other blocks can&#39;t refer to that register.
1178       set_result(x, load_constant(x));
1179     } else {
1180       LIR_Opr res = x-&gt;operand();
1181       if (!res-&gt;is_valid()) {
1182         res = LIR_OprFact::value_type(x-&gt;type());
1183       }
1184       if (res-&gt;is_constant()) {
1185         LIR_Opr reg = rlock_result(x);
1186         __ move(res, reg);
1187       } else {
1188         set_result(x, res);
1189       }
1190     }
1191   } else {
1192     set_result(x, LIR_OprFact::value_type(x-&gt;type()));
1193   }
1194 }
1195 
1196 
1197 void LIRGenerator::do_Local(Local* x) {
1198   // operand_for_instruction has the side effect of setting the result
1199   // so there&#39;s no need to do it here.
1200   operand_for_instruction(x);
1201 }
1202 
1203 
1204 void LIRGenerator::do_IfInstanceOf(IfInstanceOf* x) {
1205   Unimplemented();
1206 }
1207 
1208 
1209 void LIRGenerator::do_Return(Return* x) {
1210   if (compilation()-&gt;env()-&gt;dtrace_method_probes()) {
1211     BasicTypeList signature;
1212     signature.append(LP64_ONLY(T_LONG) NOT_LP64(T_INT));    // thread
1213     signature.append(T_METADATA); // Method*
1214     LIR_OprList* args = new LIR_OprList();
1215     args-&gt;append(getThreadPointer());
1216     LIR_Opr meth = new_register(T_METADATA);
1217     __ metadata2reg(method()-&gt;constant_encoding(), meth);
1218     args-&gt;append(meth);
1219     call_runtime(&amp;signature, args, CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_exit), voidType, NULL);
1220   }
1221 
1222   if (x-&gt;type()-&gt;is_void()) {
1223     __ return_op(LIR_OprFact::illegalOpr);
1224   } else {
1225     LIR_Opr reg = result_register_for(x-&gt;type(), /*callee=*/true);
1226     LIRItem result(x-&gt;result(), this);
1227 
1228     result.load_item_force(reg);
1229     __ return_op(result.result());
1230   }
1231   set_no_result(x);
1232 }
1233 
1234 // Examble: ref.get()
1235 // Combination of LoadField and g1 pre-write barrier
1236 void LIRGenerator::do_Reference_get(Intrinsic* x) {
1237 
1238   const int referent_offset = java_lang_ref_Reference::referent_offset();
1239 
1240   assert(x-&gt;number_of_arguments() == 1, &quot;wrong type&quot;);
1241 
1242   LIRItem reference(x-&gt;argument_at(0), this);
1243   reference.load_item();
1244 
1245   // need to perform the null check on the reference objecy
1246   CodeEmitInfo* info = NULL;
1247   if (x-&gt;needs_null_check()) {
1248     info = state_for(x);
1249   }
1250 
1251   LIR_Opr result = rlock_result(x, T_OBJECT);
1252   access_load_at(IN_HEAP | ON_WEAK_OOP_REF, T_OBJECT,
1253                  reference, LIR_OprFact::intConst(referent_offset), result);
1254 }
1255 
1256 // Example: clazz.isInstance(object)
1257 void LIRGenerator::do_isInstance(Intrinsic* x) {
1258   assert(x-&gt;number_of_arguments() == 2, &quot;wrong type&quot;);
1259 
1260   // TODO could try to substitute this node with an equivalent InstanceOf
1261   // if clazz is known to be a constant Class. This will pick up newly found
1262   // constants after HIR construction. I&#39;ll leave this to a future change.
1263 
1264   // as a first cut, make a simple leaf call to runtime to stay platform independent.
1265   // could follow the aastore example in a future change.
1266 
1267   LIRItem clazz(x-&gt;argument_at(0), this);
1268   LIRItem object(x-&gt;argument_at(1), this);
1269   clazz.load_item();
1270   object.load_item();
1271   LIR_Opr result = rlock_result(x);
1272 
1273   // need to perform null check on clazz
1274   if (x-&gt;needs_null_check()) {
1275     CodeEmitInfo* info = state_for(x);
1276     __ null_check(clazz.result(), info);
1277   }
1278 
1279   LIR_Opr call_result = call_runtime(clazz.value(), object.value(),
1280                                      CAST_FROM_FN_PTR(address, Runtime1::is_instance_of),
1281                                      x-&gt;type(),
1282                                      NULL); // NULL CodeEmitInfo results in a leaf call
1283   __ move(call_result, result);
1284 }
1285 
1286 // Example: object.getClass ()
1287 void LIRGenerator::do_getClass(Intrinsic* x) {
1288   assert(x-&gt;number_of_arguments() == 1, &quot;wrong type&quot;);
1289 
1290   LIRItem rcvr(x-&gt;argument_at(0), this);
1291   rcvr.load_item();
1292   LIR_Opr temp = new_register(T_METADATA);
1293   LIR_Opr result = rlock_result(x);
1294 
1295   // need to perform the null check on the rcvr
1296   CodeEmitInfo* info = NULL;
1297   if (x-&gt;needs_null_check()) {
1298     info = state_for(x);
1299   }
1300 
1301   // FIXME T_ADDRESS should actually be T_METADATA but it can&#39;t because the
1302   // meaning of these two is mixed up (see JDK-8026837).
1303   __ move(new LIR_Address(rcvr.result(), oopDesc::klass_offset_in_bytes(), T_ADDRESS), temp, info);
1304   __ move_wide(new LIR_Address(temp, in_bytes(Klass::java_mirror_offset()), T_ADDRESS), temp);
1305   // mirror = ((OopHandle)mirror)-&gt;resolve();
1306   access_load(IN_NATIVE, T_OBJECT,
1307               LIR_OprFact::address(new LIR_Address(temp, T_OBJECT)), result);
1308 }
1309 
1310 // java.lang.Class::isPrimitive()
1311 void LIRGenerator::do_isPrimitive(Intrinsic* x) {
1312   assert(x-&gt;number_of_arguments() == 1, &quot;wrong type&quot;);
1313 
1314   LIRItem rcvr(x-&gt;argument_at(0), this);
1315   rcvr.load_item();
1316   LIR_Opr temp = new_register(T_METADATA);
1317   LIR_Opr result = rlock_result(x);
1318 
1319   CodeEmitInfo* info = NULL;
1320   if (x-&gt;needs_null_check()) {
1321     info = state_for(x);
1322   }
1323 
1324   __ move(new LIR_Address(rcvr.result(), java_lang_Class::klass_offset(), T_ADDRESS), temp, info);
1325   __ cmp(lir_cond_notEqual, temp, LIR_OprFact::metadataConst(0));
1326   __ cmove(lir_cond_notEqual, LIR_OprFact::intConst(0), LIR_OprFact::intConst(1), result, T_BOOLEAN);
1327 }
1328 
1329 
1330 // Example: Thread.currentThread()
1331 void LIRGenerator::do_currentThread(Intrinsic* x) {
1332   assert(x-&gt;number_of_arguments() == 0, &quot;wrong type&quot;);
1333   LIR_Opr reg = rlock_result(x);
1334   __ move_wide(new LIR_Address(getThreadPointer(), in_bytes(JavaThread::threadObj_offset()), T_OBJECT), reg);
1335 }
1336 
1337 
1338 void LIRGenerator::do_RegisterFinalizer(Intrinsic* x) {
1339   assert(x-&gt;number_of_arguments() == 1, &quot;wrong type&quot;);
1340   LIRItem receiver(x-&gt;argument_at(0), this);
1341 
1342   receiver.load_item();
1343   BasicTypeList signature;
1344   signature.append(T_OBJECT); // receiver
1345   LIR_OprList* args = new LIR_OprList();
1346   args-&gt;append(receiver.result());
1347   CodeEmitInfo* info = state_for(x, x-&gt;state());
1348   call_runtime(&amp;signature, args,
1349                CAST_FROM_FN_PTR(address, Runtime1::entry_for(Runtime1::register_finalizer_id)),
1350                voidType, info);
1351 
1352   set_no_result(x);
1353 }
1354 
1355 
1356 //------------------------local access--------------------------------------
1357 
1358 LIR_Opr LIRGenerator::operand_for_instruction(Instruction* x) {
1359   if (x-&gt;operand()-&gt;is_illegal()) {
1360     Constant* c = x-&gt;as_Constant();
1361     if (c != NULL) {
1362       x-&gt;set_operand(LIR_OprFact::value_type(c-&gt;type()));
1363     } else {
1364       assert(x-&gt;as_Phi() || x-&gt;as_Local() != NULL, &quot;only for Phi and Local&quot;);
1365       // allocate a virtual register for this local or phi
1366       x-&gt;set_operand(rlock(x));
1367       _instruction_for_operand.at_put_grow(x-&gt;operand()-&gt;vreg_number(), x, NULL);
1368     }
1369   }
1370   return x-&gt;operand();
1371 }
1372 
1373 
1374 Instruction* LIRGenerator::instruction_for_opr(LIR_Opr opr) {
1375   if (opr-&gt;is_virtual()) {
1376     return instruction_for_vreg(opr-&gt;vreg_number());
1377   }
1378   return NULL;
1379 }
1380 
1381 
1382 Instruction* LIRGenerator::instruction_for_vreg(int reg_num) {
1383   if (reg_num &lt; _instruction_for_operand.length()) {
1384     return _instruction_for_operand.at(reg_num);
1385   }
1386   return NULL;
1387 }
1388 
1389 
1390 void LIRGenerator::set_vreg_flag(int vreg_num, VregFlag f) {
1391   if (_vreg_flags.size_in_bits() == 0) {
1392     BitMap2D temp(100, num_vreg_flags);
1393     _vreg_flags = temp;
1394   }
1395   _vreg_flags.at_put_grow(vreg_num, f, true);
1396 }
1397 
1398 bool LIRGenerator::is_vreg_flag_set(int vreg_num, VregFlag f) {
1399   if (!_vreg_flags.is_valid_index(vreg_num, f)) {
1400     return false;
1401   }
1402   return _vreg_flags.at(vreg_num, f);
1403 }
1404 
1405 
1406 // Block local constant handling.  This code is useful for keeping
1407 // unpinned constants and constants which aren&#39;t exposed in the IR in
1408 // registers.  Unpinned Constant instructions have their operands
1409 // cleared when the block is finished so that other blocks can&#39;t end
1410 // up referring to their registers.
1411 
1412 LIR_Opr LIRGenerator::load_constant(Constant* x) {
1413   assert(!x-&gt;is_pinned(), &quot;only for unpinned constants&quot;);
1414   _unpinned_constants.append(x);
1415   return load_constant(LIR_OprFact::value_type(x-&gt;type())-&gt;as_constant_ptr());
1416 }
1417 
1418 
1419 LIR_Opr LIRGenerator::load_constant(LIR_Const* c) {
1420   BasicType t = c-&gt;type();
1421   for (int i = 0; i &lt; _constants.length(); i++) {
1422     LIR_Const* other = _constants.at(i);
1423     if (t == other-&gt;type()) {
1424       switch (t) {
1425       case T_INT:
1426       case T_FLOAT:
1427         if (c-&gt;as_jint_bits() != other-&gt;as_jint_bits()) continue;
1428         break;
1429       case T_LONG:
1430       case T_DOUBLE:
1431         if (c-&gt;as_jint_hi_bits() != other-&gt;as_jint_hi_bits()) continue;
1432         if (c-&gt;as_jint_lo_bits() != other-&gt;as_jint_lo_bits()) continue;
1433         break;
1434       case T_OBJECT:
1435         if (c-&gt;as_jobject() != other-&gt;as_jobject()) continue;
1436         break;
1437       default:
1438         break;
1439       }
1440       return _reg_for_constants.at(i);
1441     }
1442   }
1443 
1444   LIR_Opr result = new_register(t);
1445   __ move((LIR_Opr)c, result);
1446   if (!in_conditional_code()) {
1447     _constants.append(c);
1448     _reg_for_constants.append(result);
1449   }
1450   return result;
1451 }
1452 
1453 void LIRGenerator::set_in_conditional_code(bool v) {
1454   assert(v != _in_conditional_code, &quot;must change state&quot;);
1455   _in_conditional_code = v;
1456 }
1457 
1458 
1459 //------------------------field access--------------------------------------
1460 
1461 void LIRGenerator::do_CompareAndSwap(Intrinsic* x, ValueType* type) {
1462   assert(x-&gt;number_of_arguments() == 4, &quot;wrong type&quot;);
1463   LIRItem obj   (x-&gt;argument_at(0), this);  // object
1464   LIRItem offset(x-&gt;argument_at(1), this);  // offset of field
1465   LIRItem cmp   (x-&gt;argument_at(2), this);  // value to compare with field
1466   LIRItem val   (x-&gt;argument_at(3), this);  // replace field with val if matches cmp
1467   assert(obj.type()-&gt;tag() == objectTag, &quot;invalid type&quot;);
1468 
1469   // In 64bit the type can be long, sparc doesn&#39;t have this assert
1470   // assert(offset.type()-&gt;tag() == intTag, &quot;invalid type&quot;);
1471 
1472   assert(cmp.type()-&gt;tag() == type-&gt;tag(), &quot;invalid type&quot;);
1473   assert(val.type()-&gt;tag() == type-&gt;tag(), &quot;invalid type&quot;);
1474 
1475   LIR_Opr result = access_atomic_cmpxchg_at(IN_HEAP, as_BasicType(type),
1476                                             obj, offset, cmp, val);
1477   set_result(x, result);
1478 }
1479 
1480 // Comment copied form templateTable_i486.cpp
1481 // ----------------------------------------------------------------------------
1482 // Volatile variables demand their effects be made known to all CPU&#39;s in
1483 // order.  Store buffers on most chips allow reads &amp; writes to reorder; the
1484 // JMM&#39;s ReadAfterWrite.java test fails in -Xint mode without some kind of
1485 // memory barrier (i.e., it&#39;s not sufficient that the interpreter does not
1486 // reorder volatile references, the hardware also must not reorder them).
1487 //
1488 // According to the new Java Memory Model (JMM):
1489 // (1) All volatiles are serialized wrt to each other.
1490 // ALSO reads &amp; writes act as aquire &amp; release, so:
1491 // (2) A read cannot let unrelated NON-volatile memory refs that happen after
1492 // the read float up to before the read.  It&#39;s OK for non-volatile memory refs
1493 // that happen before the volatile read to float down below it.
1494 // (3) Similar a volatile write cannot let unrelated NON-volatile memory refs
1495 // that happen BEFORE the write float down to after the write.  It&#39;s OK for
1496 // non-volatile memory refs that happen after the volatile write to float up
1497 // before it.
1498 //
1499 // We only put in barriers around volatile refs (they are expensive), not
1500 // _between_ memory refs (that would require us to track the flavor of the
1501 // previous memory refs).  Requirements (2) and (3) require some barriers
1502 // before volatile stores and after volatile loads.  These nearly cover
1503 // requirement (1) but miss the volatile-store-volatile-load case.  This final
1504 // case is placed after volatile-stores although it could just as well go
1505 // before volatile-loads.
1506 
1507 
1508 void LIRGenerator::do_StoreField(StoreField* x) {
1509   bool needs_patching = x-&gt;needs_patching();
1510   bool is_volatile = x-&gt;field()-&gt;is_volatile();
1511   BasicType field_type = x-&gt;field_type();
1512 
1513   CodeEmitInfo* info = NULL;
1514   if (needs_patching) {
1515     assert(x-&gt;explicit_null_check() == NULL, &quot;can&#39;t fold null check into patching field access&quot;);
1516     info = state_for(x, x-&gt;state_before());
1517   } else if (x-&gt;needs_null_check()) {
1518     NullCheck* nc = x-&gt;explicit_null_check();
1519     if (nc == NULL) {
1520       info = state_for(x);
1521     } else {
1522       info = state_for(nc);
1523     }
1524   }
1525 
1526   LIRItem object(x-&gt;obj(), this);
1527   LIRItem value(x-&gt;value(),  this);
1528 
1529   object.load_item();
1530 
1531   if (is_volatile || needs_patching) {
1532     // load item if field is volatile (fewer special cases for volatiles)
1533     // load item if field not initialized
1534     // load item if field not constant
1535     // because of code patching we cannot inline constants
1536     if (field_type == T_BYTE || field_type == T_BOOLEAN) {
1537       value.load_byte_item();
1538     } else  {
1539       value.load_item();
1540     }
1541   } else {
1542     value.load_for_store(field_type);
1543   }
1544 
1545   set_no_result(x);
1546 
1547 #ifndef PRODUCT
1548   if (PrintNotLoaded &amp;&amp; needs_patching) {
1549     tty-&gt;print_cr(&quot;   ###class not loaded at store_%s bci %d&quot;,
1550                   x-&gt;is_static() ?  &quot;static&quot; : &quot;field&quot;, x-&gt;printable_bci());
1551   }
1552 #endif
1553 
1554   if (x-&gt;needs_null_check() &amp;&amp;
1555       (needs_patching ||
1556        MacroAssembler::needs_explicit_null_check(x-&gt;offset()))) {
1557     if (needs_patching &amp;&amp; x-&gt;field()-&gt;is_flattenable()) {
1558       // We are storing a field of type &quot;QT;&quot; into holder class H, but H is not yet
1559       // loaded. (If H had been loaded, then T must also have already been loaded
1560       // due to the &quot;Q&quot; signature, and needs_patching would be false).
1561       assert(!x-&gt;field()-&gt;holder()-&gt;is_loaded(), &quot;must be&quot;);
1562       // We don&#39;t know the offset of this field. Let&#39;s deopt and recompile.
1563       CodeStub* stub = new DeoptimizeStub(new CodeEmitInfo(info),
1564                                           Deoptimization::Reason_unloaded,
1565                                           Deoptimization::Action_make_not_entrant);
1566       __ branch(lir_cond_always, stub);
1567     } else {
1568       // Emit an explicit null check because the offset is too large.
1569       // If the class is not loaded and the object is NULL, we need to deoptimize to throw a
1570       // NoClassDefFoundError in the interpreter instead of an implicit NPE from compiled code.
1571       __ null_check(object.result(), new CodeEmitInfo(info), /* deoptimize */ needs_patching);
1572     }
1573   }
1574 
1575   DecoratorSet decorators = IN_HEAP;
1576   if (is_volatile) {
1577     decorators |= MO_SEQ_CST;
1578   }
1579   if (needs_patching) {
1580     decorators |= C1_NEEDS_PATCHING;
1581   }
1582 
1583   access_store_at(decorators, field_type, object, LIR_OprFact::intConst(x-&gt;offset()),
1584                   value.result(), info != NULL ? new CodeEmitInfo(info) : NULL, info);
1585 }
1586 
1587 // FIXME -- I can&#39;t find any other way to pass an address to access_load_at().
1588 class TempResolvedAddress: public Instruction {
1589  public:
1590   TempResolvedAddress(ValueType* type, LIR_Opr addr) : Instruction(type) {
1591     set_operand(addr);
1592   }
1593   virtual void input_values_do(ValueVisitor*) {}
1594   virtual void visit(InstructionVisitor* v)   {}
1595   virtual const char* name() const  { return &quot;TempResolvedAddress&quot;; }
1596 };
1597 
1598 void LIRGenerator::access_flattened_array(bool is_load, LIRItem&amp; array, LIRItem&amp; index, LIRItem&amp; obj_item) {
1599   // Find the starting address of the source (inside the array)
1600   ciType* array_type = array.value()-&gt;declared_type();
1601   ciValueArrayKlass* value_array_klass = array_type-&gt;as_value_array_klass();
1602   assert(value_array_klass-&gt;is_loaded(), &quot;must be&quot;);
1603 
1604   ciValueKlass* elem_klass = value_array_klass-&gt;element_klass()-&gt;as_value_klass();
1605   int array_header_size = value_array_klass-&gt;array_header_in_bytes();
1606   int shift = value_array_klass-&gt;log2_element_size();
1607 
1608 #ifndef _LP64
1609   LIR_Opr index_op = new_register(T_INT);
1610   // FIXME -- on 32-bit, the shift below can overflow, so we need to check that
1611   // the top (shift+1) bits of index_op must be zero, or
1612   // else throw ArrayIndexOutOfBoundsException
1613   if (index.result()-&gt;is_constant()) {
1614     jint const_index = index.result()-&gt;as_jint();
1615     __ move(LIR_OprFact::intConst(const_index &lt;&lt; shift), index_op);
1616   } else {
1617     __ shift_left(index_op, shift, index.result());
1618   }
1619 #else
1620   LIR_Opr index_op = new_register(T_LONG);
1621   if (index.result()-&gt;is_constant()) {
1622     jint const_index = index.result()-&gt;as_jint();
1623     __ move(LIR_OprFact::longConst(const_index &lt;&lt; shift), index_op);
1624   } else {
1625     __ convert(Bytecodes::_i2l, index.result(), index_op);
1626     // Need to shift manually, as LIR_Address can scale only up to 3.
1627     __ shift_left(index_op, shift, index_op);
1628   }
1629 #endif
1630 
1631   LIR_Opr elm_op = new_pointer_register();
1632   LIR_Address* elm_address = new LIR_Address(array.result(), index_op, array_header_size, T_ADDRESS);
1633   __ leal(LIR_OprFact::address(elm_address), elm_op);
1634 
1635   for (int i = 0; i &lt; elem_klass-&gt;nof_nonstatic_fields(); i++) {
1636     ciField* inner_field = elem_klass-&gt;nonstatic_field_at(i);
1637     assert(!inner_field-&gt;is_flattened(), &quot;flattened fields must have been expanded&quot;);
1638     int obj_offset = inner_field-&gt;offset();
1639     int elm_offset = obj_offset - elem_klass-&gt;first_field_offset(); // object header is not stored in array.
1640 
1641     BasicType field_type = inner_field-&gt;type()-&gt;basic_type();
1642     switch (field_type) {
1643     case T_BYTE:
1644     case T_BOOLEAN:
1645     case T_SHORT:
1646     case T_CHAR:
1647      field_type = T_INT;
1648       break;
1649     default:
1650       break;
1651     }
1652 
1653     LIR_Opr temp = new_register(field_type);
1654     TempResolvedAddress* elm_resolved_addr = new TempResolvedAddress(as_ValueType(field_type), elm_op);
1655     LIRItem elm_item(elm_resolved_addr, this);
1656 
1657     DecoratorSet decorators = IN_HEAP;
1658     if (is_load) {
1659       access_load_at(decorators, field_type,
1660                      elm_item, LIR_OprFact::intConst(elm_offset), temp,
1661                      NULL, NULL);
1662       access_store_at(decorators, field_type,
1663                       obj_item, LIR_OprFact::intConst(obj_offset), temp,
1664                       NULL, NULL);
1665     } else {
1666       access_load_at(decorators, field_type,
1667                      obj_item, LIR_OprFact::intConst(obj_offset), temp,
1668                      NULL, NULL);
1669       access_store_at(decorators, field_type,
1670                       elm_item, LIR_OprFact::intConst(elm_offset), temp,
1671                       NULL, NULL);
1672     }
1673   }
1674 }
1675 
1676 void LIRGenerator::check_flattened_array(LIR_Opr array, LIR_Opr value, CodeStub* slow_path) {
1677   LIR_Opr tmp = new_register(T_METADATA);
1678   __ check_flattened_array(array, value, tmp, slow_path);
1679 }
1680 
1681 void LIRGenerator::check_null_free_array(LIRItem&amp; array, LIRItem&amp; value, CodeEmitInfo* info) {
1682   LabelObj* L_end = new LabelObj();
1683   LIR_Opr tmp = new_register(T_METADATA);
1684   __ check_null_free_array(array.result(), tmp);
1685   __ branch(lir_cond_equal, L_end-&gt;label());
1686   __ null_check(value.result(), info);
1687   __ branch_destination(L_end-&gt;label());
1688 }
1689 
1690 bool LIRGenerator::needs_flattened_array_store_check(StoreIndexed* x) {
1691   if (x-&gt;elt_type() == T_OBJECT &amp;&amp; x-&gt;array()-&gt;maybe_flattened_array()) {
1692     ciType* type = x-&gt;value()-&gt;declared_type();
1693     if (type != NULL &amp;&amp; type-&gt;is_klass()) {
1694       ciKlass* klass = type-&gt;as_klass();
1695       if (!klass-&gt;can_be_value_klass() || (klass-&gt;is_valuetype() &amp;&amp; !klass-&gt;as_value_klass()-&gt;flatten_array())) {
1696         // This is known to be a non-flattenable object. If the array is flattened,
1697         // it will be caught by the code generated by array_store_check().
1698         return false;
1699       }
1700     }
1701     // We&#39;re not 100% sure, so let&#39;s do the flattened_array_store_check.
1702     return true;
1703   }
1704   return false;
1705 }
1706 
1707 bool LIRGenerator::needs_null_free_array_store_check(StoreIndexed* x) {
1708   return x-&gt;elt_type() == T_OBJECT &amp;&amp; x-&gt;array()-&gt;maybe_null_free_array();
1709 }
1710 
1711 void LIRGenerator::do_StoreIndexed(StoreIndexed* x) {
1712   assert(x-&gt;is_pinned(),&quot;&quot;);
1713   assert(x-&gt;elt_type() != T_ARRAY, &quot;never used&quot;);
1714   bool is_loaded_flattened_array = x-&gt;array()-&gt;is_loaded_flattened_array();
1715   bool needs_range_check = x-&gt;compute_needs_range_check();
1716   bool use_length = x-&gt;length() != NULL;
1717   bool obj_store = is_reference_type(x-&gt;elt_type());
1718   bool needs_store_check = obj_store &amp;&amp; !(is_loaded_flattened_array &amp;&amp; x-&gt;is_exact_flattened_array_store()) &amp;&amp;
1719                                         (x-&gt;value()-&gt;as_Constant() == NULL ||
1720                                          !get_jobject_constant(x-&gt;value())-&gt;is_null_object());
1721 
1722   LIRItem array(x-&gt;array(), this);
1723   LIRItem index(x-&gt;index(), this);
1724   LIRItem value(x-&gt;value(), this);
1725   LIRItem length(this);
1726 
1727   array.load_item();
1728   index.load_nonconstant();
1729 
1730   if (use_length &amp;&amp; needs_range_check) {
1731     length.set_instruction(x-&gt;length());
1732     length.load_item();
1733   }
1734 
1735   if (needs_store_check || x-&gt;check_boolean()
1736       || is_loaded_flattened_array || needs_flattened_array_store_check(x) || needs_null_free_array_store_check(x)) {
1737     value.load_item();
1738   } else {
1739     value.load_for_store(x-&gt;elt_type());
1740   }
1741 
1742   set_no_result(x);
1743 
1744   // the CodeEmitInfo must be duplicated for each different
1745   // LIR-instruction because spilling can occur anywhere between two
1746   // instructions and so the debug information must be different
1747   CodeEmitInfo* range_check_info = state_for(x);
1748   CodeEmitInfo* null_check_info = NULL;
1749   if (x-&gt;needs_null_check()) {
1750     null_check_info = new CodeEmitInfo(range_check_info);
1751   }
1752 
1753   if (GenerateRangeChecks &amp;&amp; needs_range_check) {
1754     if (use_length) {
1755       __ cmp(lir_cond_belowEqual, length.result(), index.result());
1756       __ branch(lir_cond_belowEqual, new RangeCheckStub(range_check_info, index.result(), array.result()));
1757     } else {
1758       array_range_check(array.result(), index.result(), null_check_info, range_check_info);
1759       // range_check also does the null check
1760       null_check_info = NULL;
1761     }
1762   }
1763 
1764   if (x-&gt;should_profile()) {
1765     ciMethodData* md = NULL;
1766     ciArrayLoadStoreData* load_store = NULL;
1767     profile_array_type(x, md, load_store);
1768     if (is_loaded_flattened_array) {
1769       int flag = ArrayLoadStoreData::flat_array_byte_constant() | ArrayLoadStoreData::null_free_array_byte_constant();
1770       assert(md != NULL, &quot;should have been initialized&quot;);
1771       profile_array_load_store_flags(md, load_store, flag);
1772     } else if (x-&gt;array()-&gt;maybe_null_free_array()) {
1773       profile_null_free_array(array, md, load_store);
1774     }
1775     profile_element_type(x-&gt;value(), md, load_store);
1776   }
1777 
1778   if (GenerateArrayStoreCheck &amp;&amp; needs_store_check) {
1779     CodeEmitInfo* store_check_info = new CodeEmitInfo(range_check_info);
1780     array_store_check(value.result(), array.result(), store_check_info, NULL, -1);
1781   }
1782 
1783   if (is_loaded_flattened_array) {
1784     if (!x-&gt;value()-&gt;is_never_null()) {
1785       __ null_check(value.result(), new CodeEmitInfo(range_check_info));
1786     }
1787     access_flattened_array(false, array, index, value);
1788   } else {
1789     StoreFlattenedArrayStub* slow_path = NULL;
1790 
1791     if (needs_flattened_array_store_check(x)) {
1792       // Check if we indeed have a flattened array
1793       index.load_item();
1794       slow_path = new StoreFlattenedArrayStub(array.result(), index.result(), value.result(), state_for(x, x-&gt;state_before()));
1795       check_flattened_array(array.result(), value.result(), slow_path);
1796       set_in_conditional_code(true);
1797     } else if (needs_null_free_array_store_check(x)) {
1798       CodeEmitInfo* info = new CodeEmitInfo(range_check_info);
1799       check_null_free_array(array, value, info);
1800     }
1801 
1802     DecoratorSet decorators = IN_HEAP | IS_ARRAY;
1803     if (x-&gt;check_boolean()) {
1804       decorators |= C1_MASK_BOOLEAN;
1805     }
1806 
1807     access_store_at(decorators, x-&gt;elt_type(), array, index.result(), value.result(),
1808                     NULL, null_check_info);
1809     if (slow_path != NULL) {
1810       __ branch_destination(slow_path-&gt;continuation());
1811       set_in_conditional_code(false);
1812     }
1813   }
1814 }
1815 
1816 void LIRGenerator::access_load_at(DecoratorSet decorators, BasicType type,
1817                                   LIRItem&amp; base, LIR_Opr offset, LIR_Opr result,
1818                                   CodeEmitInfo* patch_info, CodeEmitInfo* load_emit_info) {
1819   decorators |= ACCESS_READ;
1820   LIRAccess access(this, decorators, base, offset, type, patch_info, load_emit_info);
1821   if (access.is_raw()) {
1822     _barrier_set-&gt;BarrierSetC1::load_at(access, result);
1823   } else {
1824     _barrier_set-&gt;load_at(access, result);
1825   }
1826 }
1827 
1828 void LIRGenerator::access_load(DecoratorSet decorators, BasicType type,
1829                                LIR_Opr addr, LIR_Opr result) {
1830   decorators |= ACCESS_READ;
1831   LIRAccess access(this, decorators, LIR_OprFact::illegalOpr, LIR_OprFact::illegalOpr, type);
1832   access.set_resolved_addr(addr);
1833   if (access.is_raw()) {
1834     _barrier_set-&gt;BarrierSetC1::load(access, result);
1835   } else {
1836     _barrier_set-&gt;load(access, result);
1837   }
1838 }
1839 
1840 void LIRGenerator::access_store_at(DecoratorSet decorators, BasicType type,
1841                                    LIRItem&amp; base, LIR_Opr offset, LIR_Opr value,
1842                                    CodeEmitInfo* patch_info, CodeEmitInfo* store_emit_info) {
1843   decorators |= ACCESS_WRITE;
1844   LIRAccess access(this, decorators, base, offset, type, patch_info, store_emit_info);
1845   if (access.is_raw()) {
1846     _barrier_set-&gt;BarrierSetC1::store_at(access, value);
1847   } else {
1848     _barrier_set-&gt;store_at(access, value);
1849   }
1850 }
1851 
1852 LIR_Opr LIRGenerator::access_atomic_cmpxchg_at(DecoratorSet decorators, BasicType type,
1853                                                LIRItem&amp; base, LIRItem&amp; offset, LIRItem&amp; cmp_value, LIRItem&amp; new_value) {
1854   decorators |= ACCESS_READ;
1855   decorators |= ACCESS_WRITE;
1856   // Atomic operations are SEQ_CST by default
1857   decorators |= ((decorators &amp; MO_DECORATOR_MASK) == 0) ? MO_SEQ_CST : 0;
1858   LIRAccess access(this, decorators, base, offset, type);
1859   if (access.is_raw()) {
1860     return _barrier_set-&gt;BarrierSetC1::atomic_cmpxchg_at(access, cmp_value, new_value);
1861   } else {
1862     return _barrier_set-&gt;atomic_cmpxchg_at(access, cmp_value, new_value);
1863   }
1864 }
1865 
1866 LIR_Opr LIRGenerator::access_atomic_xchg_at(DecoratorSet decorators, BasicType type,
1867                                             LIRItem&amp; base, LIRItem&amp; offset, LIRItem&amp; value) {
1868   decorators |= ACCESS_READ;
1869   decorators |= ACCESS_WRITE;
1870   // Atomic operations are SEQ_CST by default
1871   decorators |= ((decorators &amp; MO_DECORATOR_MASK) == 0) ? MO_SEQ_CST : 0;
1872   LIRAccess access(this, decorators, base, offset, type);
1873   if (access.is_raw()) {
1874     return _barrier_set-&gt;BarrierSetC1::atomic_xchg_at(access, value);
1875   } else {
1876     return _barrier_set-&gt;atomic_xchg_at(access, value);
1877   }
1878 }
1879 
1880 LIR_Opr LIRGenerator::access_atomic_add_at(DecoratorSet decorators, BasicType type,
1881                                            LIRItem&amp; base, LIRItem&amp; offset, LIRItem&amp; value) {
1882   decorators |= ACCESS_READ;
1883   decorators |= ACCESS_WRITE;
1884   // Atomic operations are SEQ_CST by default
1885   decorators |= ((decorators &amp; MO_DECORATOR_MASK) == 0) ? MO_SEQ_CST : 0;
1886   LIRAccess access(this, decorators, base, offset, type);
1887   if (access.is_raw()) {
1888     return _barrier_set-&gt;BarrierSetC1::atomic_add_at(access, value);
1889   } else {
1890     return _barrier_set-&gt;atomic_add_at(access, value);
1891   }
1892 }
1893 
1894 LIR_Opr LIRGenerator::access_resolve(DecoratorSet decorators, LIR_Opr obj) {
1895   // Use stronger ACCESS_WRITE|ACCESS_READ by default.
1896   if ((decorators &amp; (ACCESS_READ | ACCESS_WRITE)) == 0) {
1897     decorators |= ACCESS_READ | ACCESS_WRITE;
1898   }
1899 
1900   return _barrier_set-&gt;resolve(this, decorators, obj);
1901 }
1902 
1903 Constant* LIRGenerator::flattenable_load_field_prolog(LoadField* x, CodeEmitInfo* info) {
1904   ciField* field = x-&gt;field();
1905   ciInstanceKlass* holder = field-&gt;holder();
1906   Constant* default_value = NULL;
1907 
1908   // Unloaded &quot;QV;&quot; klasses are represented by a ciInstanceKlass
1909   bool field_type_unloaded = field-&gt;type()-&gt;is_instance_klass() &amp;&amp; !field-&gt;type()-&gt;as_instance_klass()-&gt;is_loaded();
1910 
1911   // Check for edge cases (1), (2) and (3) for getstatic and getfield
1912   bool deopt = false;
1913   bool need_default = false;
1914   if (field-&gt;is_static()) {
1915       // (1) holder is unloaded -- no problem: it will be loaded by patching, and field offset will be determined.
1916       // No check needed here.
1917 
1918     if (field_type_unloaded) {
1919       // (2) field type is unloaded -- problem: we don&#39;t know what the default value is. Let&#39;s deopt.
1920       //                               FIXME: consider getting the default value in patching code.
1921       deopt = true;
1922     } else {
1923       need_default = true;
1924     }
1925 
1926       // (3) field is not flattened -- we don&#39;t care: static fields are never flattened.
1927       // No check needed here.
1928   } else {
1929     if (!holder-&gt;is_loaded()) {
1930       // (1) holder is unloaded -- problem: we needed the field offset back in GraphBuilder::access_field()
1931       //                           FIXME: consider getting field offset in patching code (but only if the field
1932       //                           type was loaded at compilation time).
1933       deopt = true;
1934     } else if (field_type_unloaded) {
1935       // (2) field type is unloaded -- problem: we don&#39;t know whether it&#39;s flattened or not. Let&#39;s deopt
1936       deopt = true;
1937     } else if (!field-&gt;is_flattened()) {
1938       // (3) field is not flattened -- need default value in cases of uninitialized field
1939       need_default = true;
1940     }
1941   }
1942 
1943   if (deopt) {
1944     assert(!need_default, &quot;deopt and need_default cannot both be true&quot;);
1945     assert(x-&gt;needs_patching(), &quot;must be&quot;);
1946     assert(info != NULL, &quot;must be&quot;);
1947     CodeStub* stub = new DeoptimizeStub(new CodeEmitInfo(info),
1948                                         Deoptimization::Reason_unloaded,
1949                                         Deoptimization::Action_make_not_entrant);
1950     __ branch(lir_cond_always, stub);
1951   } else if (need_default) {
1952     assert(!field_type_unloaded, &quot;must be&quot;);
1953     assert(field-&gt;type()-&gt;is_valuetype(), &quot;must be&quot;);
1954     ciValueKlass* value_klass = field-&gt;type()-&gt;as_value_klass();
1955     assert(value_klass-&gt;is_loaded(), &quot;must be&quot;);
1956 
1957     if (field-&gt;is_static() &amp;&amp; holder-&gt;is_loaded()) {
1958       ciInstance* mirror = field-&gt;holder()-&gt;java_mirror();
1959       ciObject* val = mirror-&gt;field_value(field).as_object();
1960       if (val-&gt;is_null_object()) {
1961         // This is a non-nullable static field, but it&#39;s not initialized.
1962         // We need to do a null check, and replace it with the default value.
1963       } else {
1964         // No need to perform null check on this static field
1965         need_default = false;
1966       }
1967     }
1968 
1969     if (need_default) {
1970       default_value = new Constant(new InstanceConstant(value_klass-&gt;default_value_instance()));
1971     }
1972   }
1973 
1974   return default_value;
1975 }
1976 
1977 void LIRGenerator::do_LoadField(LoadField* x) {
1978   bool needs_patching = x-&gt;needs_patching();
1979   bool is_volatile = x-&gt;field()-&gt;is_volatile();
1980   BasicType field_type = x-&gt;field_type();
1981 
1982   CodeEmitInfo* info = NULL;
1983   if (needs_patching) {
1984     assert(x-&gt;explicit_null_check() == NULL, &quot;can&#39;t fold null check into patching field access&quot;);
1985     info = state_for(x, x-&gt;state_before());
1986   } else if (x-&gt;needs_null_check()) {
1987     NullCheck* nc = x-&gt;explicit_null_check();
1988     if (nc == NULL) {
1989       info = state_for(x);
1990     } else {
1991       info = state_for(nc);
1992     }
1993   }
1994 
1995   LIRItem object(x-&gt;obj(), this);
1996 
1997   object.load_item();
1998 
1999 #ifndef PRODUCT
2000   if (PrintNotLoaded &amp;&amp; needs_patching) {
2001     tty-&gt;print_cr(&quot;   ###class not loaded at load_%s bci %d&quot;,
2002                   x-&gt;is_static() ?  &quot;static&quot; : &quot;field&quot;, x-&gt;printable_bci());
2003   }
2004 #endif
2005 
2006   Constant* default_value = NULL;
2007   if (x-&gt;field()-&gt;is_flattenable()) {
2008     default_value = flattenable_load_field_prolog(x, info);
2009   }
2010 
2011   bool stress_deopt = StressLoopInvariantCodeMotion &amp;&amp; info &amp;&amp; info-&gt;deoptimize_on_exception();
2012   if (x-&gt;needs_null_check() &amp;&amp;
2013       (needs_patching ||
2014        MacroAssembler::needs_explicit_null_check(x-&gt;offset()) ||
2015        stress_deopt)) {
2016     LIR_Opr obj = object.result();
2017     if (stress_deopt) {
2018       obj = new_register(T_OBJECT);
2019       __ move(LIR_OprFact::oopConst(NULL), obj);
2020     }
2021     // Emit an explicit null check because the offset is too large.
2022     // If the class is not loaded and the object is NULL, we need to deoptimize to throw a
2023     // NoClassDefFoundError in the interpreter instead of an implicit NPE from compiled code.
2024     __ null_check(obj, new CodeEmitInfo(info), /* deoptimize */ needs_patching);
2025   }
2026 
2027   DecoratorSet decorators = IN_HEAP;
2028   if (is_volatile) {
2029     decorators |= MO_SEQ_CST;
2030   }
2031   if (needs_patching) {
2032     decorators |= C1_NEEDS_PATCHING;
2033   }
2034 
2035   LIR_Opr result = rlock_result(x, field_type);
2036   access_load_at(decorators, field_type,
2037                  object, LIR_OprFact::intConst(x-&gt;offset()), result,
2038                  info ? new CodeEmitInfo(info) : NULL, info);
2039 
2040   if (default_value != NULL) {
2041     LabelObj* L_end = new LabelObj();
2042     __ cmp(lir_cond_notEqual, result, LIR_OprFact::oopConst(NULL));
2043     __ branch(lir_cond_notEqual, L_end-&gt;label());
2044     set_in_conditional_code(true);
2045     __ move(load_constant(default_value), result);
2046     __ branch_destination(L_end-&gt;label());
2047     set_in_conditional_code(false);
2048   }
2049 }
2050 
2051 
2052 //------------------------java.nio.Buffer.checkIndex------------------------
2053 
2054 // int java.nio.Buffer.checkIndex(int)
2055 void LIRGenerator::do_NIOCheckIndex(Intrinsic* x) {
2056   // NOTE: by the time we are in checkIndex() we are guaranteed that
2057   // the buffer is non-null (because checkIndex is package-private and
2058   // only called from within other methods in the buffer).
2059   assert(x-&gt;number_of_arguments() == 2, &quot;wrong type&quot;);
2060   LIRItem buf  (x-&gt;argument_at(0), this);
2061   LIRItem index(x-&gt;argument_at(1), this);
2062   buf.load_item();
2063   index.load_item();
2064 
2065   LIR_Opr result = rlock_result(x);
2066   if (GenerateRangeChecks) {
2067     CodeEmitInfo* info = state_for(x);
2068     CodeStub* stub = new RangeCheckStub(info, index.result());
2069     LIR_Opr buf_obj = access_resolve(IS_NOT_NULL | ACCESS_READ, buf.result());
2070     if (index.result()-&gt;is_constant()) {
2071       cmp_mem_int(lir_cond_belowEqual, buf_obj, java_nio_Buffer::limit_offset(), index.result()-&gt;as_jint(), info);
2072       __ branch(lir_cond_belowEqual, stub);
2073     } else {
2074       cmp_reg_mem(lir_cond_aboveEqual, index.result(), buf_obj,
2075                   java_nio_Buffer::limit_offset(), T_INT, info);
2076       __ branch(lir_cond_aboveEqual, stub);
2077     }
2078     __ move(index.result(), result);
2079   } else {
2080     // Just load the index into the result register
2081     __ move(index.result(), result);
2082   }
2083 }
2084 
2085 
2086 //------------------------array access--------------------------------------
2087 
2088 
2089 void LIRGenerator::do_ArrayLength(ArrayLength* x) {
2090   LIRItem array(x-&gt;array(), this);
2091   array.load_item();
2092   LIR_Opr reg = rlock_result(x);
2093 
2094   CodeEmitInfo* info = NULL;
2095   if (x-&gt;needs_null_check()) {
2096     NullCheck* nc = x-&gt;explicit_null_check();
2097     if (nc == NULL) {
2098       info = state_for(x);
2099     } else {
2100       info = state_for(nc);
2101     }
2102     if (StressLoopInvariantCodeMotion &amp;&amp; info-&gt;deoptimize_on_exception()) {
2103       LIR_Opr obj = new_register(T_OBJECT);
2104       __ move(LIR_OprFact::oopConst(NULL), obj);
2105       __ null_check(obj, new CodeEmitInfo(info));
2106     }
2107   }
2108   __ load(new LIR_Address(array.result(), arrayOopDesc::length_offset_in_bytes(), T_INT), reg, info, lir_patch_none);
2109 }
2110 
2111 
2112 void LIRGenerator::do_LoadIndexed(LoadIndexed* x) {
2113   bool use_length = x-&gt;length() != NULL;
2114   LIRItem array(x-&gt;array(), this);
2115   LIRItem index(x-&gt;index(), this);
2116   LIRItem length(this);
2117   bool needs_range_check = x-&gt;compute_needs_range_check();
2118 
2119   if (use_length &amp;&amp; needs_range_check) {
2120     length.set_instruction(x-&gt;length());
2121     length.load_item();
2122   }
2123 
2124   array.load_item();
2125   if (index.is_constant() &amp;&amp; can_inline_as_constant(x-&gt;index())) {
2126     // let it be a constant
2127     index.dont_load_item();
2128   } else {
2129     index.load_item();
2130   }
2131 
2132   CodeEmitInfo* range_check_info = state_for(x);
2133   CodeEmitInfo* null_check_info = NULL;
2134   if (x-&gt;needs_null_check()) {
2135     NullCheck* nc = x-&gt;explicit_null_check();
2136     if (nc != NULL) {
2137       null_check_info = state_for(nc);
2138     } else {
2139       null_check_info = range_check_info;
2140     }
2141     if (StressLoopInvariantCodeMotion &amp;&amp; null_check_info-&gt;deoptimize_on_exception()) {
2142       LIR_Opr obj = new_register(T_OBJECT);
2143       __ move(LIR_OprFact::oopConst(NULL), obj);
2144       __ null_check(obj, new CodeEmitInfo(null_check_info));
2145     }
2146   }
2147 
2148   if (GenerateRangeChecks &amp;&amp; needs_range_check) {
2149     if (StressLoopInvariantCodeMotion &amp;&amp; range_check_info-&gt;deoptimize_on_exception()) {
2150       __ branch(lir_cond_always, new RangeCheckStub(range_check_info, index.result(), array.result()));
2151     } else if (use_length) {
2152       // TODO: use a (modified) version of array_range_check that does not require a
2153       //       constant length to be loaded to a register
2154       __ cmp(lir_cond_belowEqual, length.result(), index.result());
2155       __ branch(lir_cond_belowEqual, new RangeCheckStub(range_check_info, index.result(), array.result()));
2156     } else {
2157       array_range_check(array.result(), index.result(), null_check_info, range_check_info);
2158       // The range check performs the null check, so clear it out for the load
2159       null_check_info = NULL;
2160     }
2161   }
2162 
2163   ciMethodData* md = NULL;
2164   ciArrayLoadStoreData* load_store = NULL;
2165   if (x-&gt;should_profile()) {
2166     profile_array_type(x, md, load_store);
2167   }
2168 
2169   Value element;
2170   if (x-&gt;vt() != NULL) {
2171     assert(x-&gt;array()-&gt;is_loaded_flattened_array(), &quot;must be&quot;);
2172     // Find the destination address (of the NewValueTypeInstance).
2173     LIR_Opr obj = x-&gt;vt()-&gt;operand();
2174     LIRItem obj_item(x-&gt;vt(), this);
2175 
2176     access_flattened_array(true, array, index, obj_item);
2177     set_no_result(x);
2178     element = x-&gt;vt();
2179     if (x-&gt;should_profile()) {
2180       int flag = ArrayLoadStoreData::flat_array_byte_constant() | ArrayLoadStoreData::null_free_array_byte_constant();
2181       profile_array_load_store_flags(md, load_store, flag);
2182     }
2183   } else {
2184     LIR_Opr result = rlock_result(x, x-&gt;elt_type());
2185     LoadFlattenedArrayStub* slow_path = NULL;
2186 
2187     if (x-&gt;should_profile() &amp;&amp; x-&gt;array()-&gt;maybe_null_free_array()) {
2188       profile_null_free_array(array, md, load_store);
2189     }
2190 
2191     if (x-&gt;elt_type() == T_OBJECT &amp;&amp; x-&gt;array()-&gt;maybe_flattened_array()) {
2192       index.load_item();
2193       // if we are loading from flattened array, load it using a runtime call
2194       slow_path = new LoadFlattenedArrayStub(array.result(), index.result(), result, state_for(x, x-&gt;state_before()));
2195       check_flattened_array(array.result(), LIR_OprFact::illegalOpr, slow_path);
2196       set_in_conditional_code(true);
2197     }
2198 
2199     DecoratorSet decorators = IN_HEAP | IS_ARRAY;
2200     access_load_at(decorators, x-&gt;elt_type(),
2201                    array, index.result(), result,
2202                    NULL, null_check_info);
2203 
2204     if (slow_path != NULL) {
2205       __ branch_destination(slow_path-&gt;continuation());
2206       set_in_conditional_code(false);
2207     }
2208 
2209     element = x;
2210   }
2211 
2212   if (x-&gt;should_profile()) {
2213     profile_element_type(element, md, load_store);
2214   }
2215 }
2216 
2217 void LIRGenerator::do_WithField(WithField* x) {
2218   // This happens only when a class X uses the withfield bytecode to refer to
2219   // an inline class V, where V has not yet been loaded. This is not a common
2220   // case. Let&#39;s just deoptimize.
2221   CodeEmitInfo* info = state_for(x, x-&gt;state_before());
2222   CodeStub* stub = new DeoptimizeStub(new CodeEmitInfo(info),
2223                                       Deoptimization::Reason_unloaded,
2224                                       Deoptimization::Action_make_not_entrant);
2225   __ branch(lir_cond_always, stub);
2226   LIR_Opr reg = rlock_result(x, T_OBJECT);
2227   __ move(LIR_OprFact::oopConst(NULL), reg);
2228 }
2229 
2230 void LIRGenerator::do_DefaultValue(DefaultValue* x) {
2231   // Same as withfield above. Let&#39;s deoptimize.
2232   CodeEmitInfo* info = state_for(x, x-&gt;state_before());
2233   CodeStub* stub = new DeoptimizeStub(new CodeEmitInfo(info),
2234                                       Deoptimization::Reason_unloaded,
2235                                       Deoptimization::Action_make_not_entrant);
2236   __ branch(lir_cond_always, stub);
2237   LIR_Opr reg = rlock_result(x, T_OBJECT);
2238   __ move(LIR_OprFact::oopConst(NULL), reg);
2239 }
2240 
2241 void LIRGenerator::do_NullCheck(NullCheck* x) {
2242   if (x-&gt;can_trap()) {
2243     LIRItem value(x-&gt;obj(), this);
2244     value.load_item();
2245     CodeEmitInfo* info = state_for(x);
2246     __ null_check(value.result(), info);
2247   }
2248 }
2249 
2250 
2251 void LIRGenerator::do_TypeCast(TypeCast* x) {
2252   LIRItem value(x-&gt;obj(), this);
2253   value.load_item();
2254   // the result is the same as from the node we are casting
2255   set_result(x, value.result());
2256 }
2257 
2258 
2259 void LIRGenerator::do_Throw(Throw* x) {
2260   LIRItem exception(x-&gt;exception(), this);
2261   exception.load_item();
2262   set_no_result(x);
2263   LIR_Opr exception_opr = exception.result();
2264   CodeEmitInfo* info = state_for(x, x-&gt;state());
2265 
2266 #ifndef PRODUCT
2267   if (PrintC1Statistics) {
2268     increment_counter(Runtime1::throw_count_address(), T_INT);
2269   }
2270 #endif
2271 
2272   // check if the instruction has an xhandler in any of the nested scopes
2273   bool unwind = false;
2274   if (info-&gt;exception_handlers()-&gt;length() == 0) {
2275     // this throw is not inside an xhandler
2276     unwind = true;
2277   } else {
2278     // get some idea of the throw type
2279     bool type_is_exact = true;
2280     ciType* throw_type = x-&gt;exception()-&gt;exact_type();
2281     if (throw_type == NULL) {
2282       type_is_exact = false;
2283       throw_type = x-&gt;exception()-&gt;declared_type();
2284     }
2285     if (throw_type != NULL &amp;&amp; throw_type-&gt;is_instance_klass()) {
2286       ciInstanceKlass* throw_klass = (ciInstanceKlass*)throw_type;
2287       unwind = !x-&gt;exception_handlers()-&gt;could_catch(throw_klass, type_is_exact);
2288     }
2289   }
2290 
2291   // do null check before moving exception oop into fixed register
2292   // to avoid a fixed interval with an oop during the null check.
2293   // Use a copy of the CodeEmitInfo because debug information is
2294   // different for null_check and throw.
2295   if (x-&gt;exception()-&gt;as_NewInstance() == NULL &amp;&amp; x-&gt;exception()-&gt;as_ExceptionObject() == NULL) {
2296     // if the exception object wasn&#39;t created using new then it might be null.
2297     __ null_check(exception_opr, new CodeEmitInfo(info, x-&gt;state()-&gt;copy(ValueStack::ExceptionState, x-&gt;state()-&gt;bci())));
2298   }
2299 
2300   if (compilation()-&gt;env()-&gt;jvmti_can_post_on_exceptions()) {
2301     // we need to go through the exception lookup path to get JVMTI
2302     // notification done
2303     unwind = false;
2304   }
2305 
2306   // move exception oop into fixed register
2307   __ move(exception_opr, exceptionOopOpr());
2308 
2309   if (unwind) {
2310     __ unwind_exception(exceptionOopOpr());
2311   } else {
2312     __ throw_exception(exceptionPcOpr(), exceptionOopOpr(), info);
2313   }
2314 }
2315 
2316 
2317 void LIRGenerator::do_RoundFP(RoundFP* x) {
2318   assert(strict_fp_requires_explicit_rounding, &quot;not required&quot;);
2319 
2320   LIRItem input(x-&gt;input(), this);
2321   input.load_item();
2322   LIR_Opr input_opr = input.result();
2323   assert(input_opr-&gt;is_register(), &quot;why round if value is not in a register?&quot;);
2324   assert(input_opr-&gt;is_single_fpu() || input_opr-&gt;is_double_fpu(), &quot;input should be floating-point value&quot;);
2325   if (input_opr-&gt;is_single_fpu()) {
2326     set_result(x, round_item(input_opr)); // This code path not currently taken
2327   } else {
2328     LIR_Opr result = new_register(T_DOUBLE);
2329     set_vreg_flag(result, must_start_in_memory);
2330     __ roundfp(input_opr, LIR_OprFact::illegalOpr, result);
2331     set_result(x, result);
2332   }
2333 }
2334 
2335 // Here UnsafeGetRaw may have x-&gt;base() and x-&gt;index() be int or long
2336 // on both 64 and 32 bits. Expecting x-&gt;base() to be always long on 64bit.
2337 void LIRGenerator::do_UnsafeGetRaw(UnsafeGetRaw* x) {
2338   LIRItem base(x-&gt;base(), this);
2339   LIRItem idx(this);
2340 
2341   base.load_item();
2342   if (x-&gt;has_index()) {
2343     idx.set_instruction(x-&gt;index());
2344     idx.load_nonconstant();
2345   }
2346 
2347   LIR_Opr reg = rlock_result(x, x-&gt;basic_type());
2348 
2349   int   log2_scale = 0;
2350   if (x-&gt;has_index()) {
2351     log2_scale = x-&gt;log2_scale();
2352   }
2353 
2354   assert(!x-&gt;has_index() || idx.value() == x-&gt;index(), &quot;should match&quot;);
2355 
2356   LIR_Opr base_op = base.result();
2357   LIR_Opr index_op = idx.result();
2358 #ifndef _LP64
2359   if (base_op-&gt;type() == T_LONG) {
2360     base_op = new_register(T_INT);
2361     __ convert(Bytecodes::_l2i, base.result(), base_op);
2362   }
2363   if (x-&gt;has_index()) {
2364     if (index_op-&gt;type() == T_LONG) {
2365       LIR_Opr long_index_op = index_op;
2366       if (index_op-&gt;is_constant()) {
2367         long_index_op = new_register(T_LONG);
2368         __ move(index_op, long_index_op);
2369       }
2370       index_op = new_register(T_INT);
2371       __ convert(Bytecodes::_l2i, long_index_op, index_op);
2372     } else {
2373       assert(x-&gt;index()-&gt;type()-&gt;tag() == intTag, &quot;must be&quot;);
2374     }
2375   }
2376   // At this point base and index should be all ints.
2377   assert(base_op-&gt;type() == T_INT &amp;&amp; !base_op-&gt;is_constant(), &quot;base should be an non-constant int&quot;);
2378   assert(!x-&gt;has_index() || index_op-&gt;type() == T_INT, &quot;index should be an int&quot;);
2379 #else
2380   if (x-&gt;has_index()) {
2381     if (index_op-&gt;type() == T_INT) {
2382       if (!index_op-&gt;is_constant()) {
2383         index_op = new_register(T_LONG);
2384         __ convert(Bytecodes::_i2l, idx.result(), index_op);
2385       }
2386     } else {
2387       assert(index_op-&gt;type() == T_LONG, &quot;must be&quot;);
2388       if (index_op-&gt;is_constant()) {
2389         index_op = new_register(T_LONG);
2390         __ move(idx.result(), index_op);
2391       }
2392     }
2393   }
2394   // At this point base is a long non-constant
2395   // Index is a long register or a int constant.
2396   // We allow the constant to stay an int because that would allow us a more compact encoding by
2397   // embedding an immediate offset in the address expression. If we have a long constant, we have to
2398   // move it into a register first.
2399   assert(base_op-&gt;type() == T_LONG &amp;&amp; !base_op-&gt;is_constant(), &quot;base must be a long non-constant&quot;);
2400   assert(!x-&gt;has_index() || (index_op-&gt;type() == T_INT &amp;&amp; index_op-&gt;is_constant()) ||
2401                             (index_op-&gt;type() == T_LONG &amp;&amp; !index_op-&gt;is_constant()), &quot;unexpected index type&quot;);
2402 #endif
2403 
2404   BasicType dst_type = x-&gt;basic_type();
2405 
2406   LIR_Address* addr;
2407   if (index_op-&gt;is_constant()) {
2408     assert(log2_scale == 0, &quot;must not have a scale&quot;);
2409     assert(index_op-&gt;type() == T_INT, &quot;only int constants supported&quot;);
2410     addr = new LIR_Address(base_op, index_op-&gt;as_jint(), dst_type);
2411   } else {
2412 #ifdef X86
2413     addr = new LIR_Address(base_op, index_op, LIR_Address::Scale(log2_scale), 0, dst_type);
2414 #elif defined(GENERATE_ADDRESS_IS_PREFERRED)
2415     addr = generate_address(base_op, index_op, log2_scale, 0, dst_type);
2416 #else
2417     if (index_op-&gt;is_illegal() || log2_scale == 0) {
2418       addr = new LIR_Address(base_op, index_op, dst_type);
2419     } else {
2420       LIR_Opr tmp = new_pointer_register();
2421       __ shift_left(index_op, log2_scale, tmp);
2422       addr = new LIR_Address(base_op, tmp, dst_type);
2423     }
2424 #endif
2425   }
2426 
2427   if (x-&gt;may_be_unaligned() &amp;&amp; (dst_type == T_LONG || dst_type == T_DOUBLE)) {
2428     __ unaligned_move(addr, reg);
2429   } else {
2430     if (dst_type == T_OBJECT &amp;&amp; x-&gt;is_wide()) {
2431       __ move_wide(addr, reg);
2432     } else {
2433       __ move(addr, reg);
2434     }
2435   }
2436 }
2437 
2438 
2439 void LIRGenerator::do_UnsafePutRaw(UnsafePutRaw* x) {
2440   int  log2_scale = 0;
2441   BasicType type = x-&gt;basic_type();
2442 
2443   if (x-&gt;has_index()) {
2444     log2_scale = x-&gt;log2_scale();
2445   }
2446 
2447   LIRItem base(x-&gt;base(), this);
2448   LIRItem value(x-&gt;value(), this);
2449   LIRItem idx(this);
2450 
2451   base.load_item();
2452   if (x-&gt;has_index()) {
2453     idx.set_instruction(x-&gt;index());
2454     idx.load_item();
2455   }
2456 
2457   if (type == T_BYTE || type == T_BOOLEAN) {
2458     value.load_byte_item();
2459   } else {
2460     value.load_item();
2461   }
2462 
2463   set_no_result(x);
2464 
2465   LIR_Opr base_op = base.result();
2466   LIR_Opr index_op = idx.result();
2467 
2468 #ifdef GENERATE_ADDRESS_IS_PREFERRED
2469   LIR_Address* addr = generate_address(base_op, index_op, log2_scale, 0, x-&gt;basic_type());
2470 #else
2471 #ifndef _LP64
2472   if (base_op-&gt;type() == T_LONG) {
2473     base_op = new_register(T_INT);
2474     __ convert(Bytecodes::_l2i, base.result(), base_op);
2475   }
2476   if (x-&gt;has_index()) {
2477     if (index_op-&gt;type() == T_LONG) {
2478       index_op = new_register(T_INT);
2479       __ convert(Bytecodes::_l2i, idx.result(), index_op);
2480     }
2481   }
2482   // At this point base and index should be all ints and not constants
2483   assert(base_op-&gt;type() == T_INT &amp;&amp; !base_op-&gt;is_constant(), &quot;base should be an non-constant int&quot;);
2484   assert(!x-&gt;has_index() || (index_op-&gt;type() == T_INT &amp;&amp; !index_op-&gt;is_constant()), &quot;index should be an non-constant int&quot;);
2485 #else
2486   if (x-&gt;has_index()) {
2487     if (index_op-&gt;type() == T_INT) {
2488       index_op = new_register(T_LONG);
2489       __ convert(Bytecodes::_i2l, idx.result(), index_op);
2490     }
2491   }
2492   // At this point base and index are long and non-constant
2493   assert(base_op-&gt;type() == T_LONG &amp;&amp; !base_op-&gt;is_constant(), &quot;base must be a non-constant long&quot;);
2494   assert(!x-&gt;has_index() || (index_op-&gt;type() == T_LONG &amp;&amp; !index_op-&gt;is_constant()), &quot;index must be a non-constant long&quot;);
2495 #endif
2496 
2497   if (log2_scale != 0) {
2498     // temporary fix (platform dependent code without shift on Intel would be better)
2499     // TODO: ARM also allows embedded shift in the address
2500     LIR_Opr tmp = new_pointer_register();
2501     if (TwoOperandLIRForm) {
2502       __ move(index_op, tmp);
2503       index_op = tmp;
2504     }
2505     __ shift_left(index_op, log2_scale, tmp);
2506     if (!TwoOperandLIRForm) {
2507       index_op = tmp;
2508     }
2509   }
2510 
2511   LIR_Address* addr = new LIR_Address(base_op, index_op, x-&gt;basic_type());
2512 #endif // !GENERATE_ADDRESS_IS_PREFERRED
2513   __ move(value.result(), addr);
2514 }
2515 
2516 
2517 void LIRGenerator::do_UnsafeGetObject(UnsafeGetObject* x) {
2518   BasicType type = x-&gt;basic_type();
2519   LIRItem src(x-&gt;object(), this);
2520   LIRItem off(x-&gt;offset(), this);
2521 
2522   off.load_item();
2523   src.load_item();
2524 
2525   DecoratorSet decorators = IN_HEAP | C1_UNSAFE_ACCESS;
2526 
2527   if (x-&gt;is_volatile()) {
2528     decorators |= MO_SEQ_CST;
2529   }
2530   if (type == T_BOOLEAN) {
2531     decorators |= C1_MASK_BOOLEAN;
2532   }
2533   if (is_reference_type(type)) {
2534     decorators |= ON_UNKNOWN_OOP_REF;
2535   }
2536 
2537   LIR_Opr result = rlock_result(x, type);
2538   access_load_at(decorators, type,
2539                  src, off.result(), result);
2540 }
2541 
2542 
2543 void LIRGenerator::do_UnsafePutObject(UnsafePutObject* x) {
2544   BasicType type = x-&gt;basic_type();
2545   LIRItem src(x-&gt;object(), this);
2546   LIRItem off(x-&gt;offset(), this);
2547   LIRItem data(x-&gt;value(), this);
2548 
2549   src.load_item();
2550   if (type == T_BOOLEAN || type == T_BYTE) {
2551     data.load_byte_item();
2552   } else {
2553     data.load_item();
2554   }
2555   off.load_item();
2556 
2557   set_no_result(x);
2558 
2559   DecoratorSet decorators = IN_HEAP | C1_UNSAFE_ACCESS;
2560   if (is_reference_type(type)) {
2561     decorators |= ON_UNKNOWN_OOP_REF;
2562   }
2563   if (x-&gt;is_volatile()) {
2564     decorators |= MO_SEQ_CST;
2565   }
2566   access_store_at(decorators, type, src, off.result(), data.result());
2567 }
2568 
2569 void LIRGenerator::do_UnsafeGetAndSetObject(UnsafeGetAndSetObject* x) {
2570   BasicType type = x-&gt;basic_type();
2571   LIRItem src(x-&gt;object(), this);
2572   LIRItem off(x-&gt;offset(), this);
2573   LIRItem value(x-&gt;value(), this);
2574 
2575   DecoratorSet decorators = IN_HEAP | C1_UNSAFE_ACCESS | MO_SEQ_CST;
2576 
2577   if (is_reference_type(type)) {
2578     decorators |= ON_UNKNOWN_OOP_REF;
2579   }
2580 
2581   LIR_Opr result;
2582   if (x-&gt;is_add()) {
2583     result = access_atomic_add_at(decorators, type, src, off, value);
2584   } else {
2585     result = access_atomic_xchg_at(decorators, type, src, off, value);
2586   }
2587   set_result(x, result);
2588 }
2589 
2590 void LIRGenerator::do_SwitchRanges(SwitchRangeArray* x, LIR_Opr value, BlockBegin* default_sux) {
2591   int lng = x-&gt;length();
2592 
2593   for (int i = 0; i &lt; lng; i++) {
2594     C1SwitchRange* one_range = x-&gt;at(i);
2595     int low_key = one_range-&gt;low_key();
2596     int high_key = one_range-&gt;high_key();
2597     BlockBegin* dest = one_range-&gt;sux();
2598     if (low_key == high_key) {
2599       __ cmp(lir_cond_equal, value, low_key);
2600       __ branch(lir_cond_equal, dest);
2601     } else if (high_key - low_key == 1) {
2602       __ cmp(lir_cond_equal, value, low_key);
2603       __ branch(lir_cond_equal, dest);
2604       __ cmp(lir_cond_equal, value, high_key);
2605       __ branch(lir_cond_equal, dest);
2606     } else {
2607       LabelObj* L = new LabelObj();
2608       __ cmp(lir_cond_less, value, low_key);
2609       __ branch(lir_cond_less, L-&gt;label());
2610       __ cmp(lir_cond_lessEqual, value, high_key);
2611       __ branch(lir_cond_lessEqual, dest);
2612       __ branch_destination(L-&gt;label());
2613     }
2614   }
2615   __ jump(default_sux);
2616 }
2617 
2618 
2619 SwitchRangeArray* LIRGenerator::create_lookup_ranges(TableSwitch* x) {
2620   SwitchRangeList* res = new SwitchRangeList();
2621   int len = x-&gt;length();
2622   if (len &gt; 0) {
2623     BlockBegin* sux = x-&gt;sux_at(0);
2624     int key = x-&gt;lo_key();
2625     BlockBegin* default_sux = x-&gt;default_sux();
2626     C1SwitchRange* range = new C1SwitchRange(key, sux);
2627     for (int i = 0; i &lt; len; i++, key++) {
2628       BlockBegin* new_sux = x-&gt;sux_at(i);
2629       if (sux == new_sux) {
2630         // still in same range
2631         range-&gt;set_high_key(key);
2632       } else {
2633         // skip tests which explicitly dispatch to the default
2634         if (sux != default_sux) {
2635           res-&gt;append(range);
2636         }
2637         range = new C1SwitchRange(key, new_sux);
2638       }
2639       sux = new_sux;
2640     }
2641     if (res-&gt;length() == 0 || res-&gt;last() != range)  res-&gt;append(range);
2642   }
2643   return res;
2644 }
2645 
2646 
2647 // we expect the keys to be sorted by increasing value
2648 SwitchRangeArray* LIRGenerator::create_lookup_ranges(LookupSwitch* x) {
2649   SwitchRangeList* res = new SwitchRangeList();
2650   int len = x-&gt;length();
2651   if (len &gt; 0) {
2652     BlockBegin* default_sux = x-&gt;default_sux();
2653     int key = x-&gt;key_at(0);
2654     BlockBegin* sux = x-&gt;sux_at(0);
2655     C1SwitchRange* range = new C1SwitchRange(key, sux);
2656     for (int i = 1; i &lt; len; i++) {
2657       int new_key = x-&gt;key_at(i);
2658       BlockBegin* new_sux = x-&gt;sux_at(i);
2659       if (key+1 == new_key &amp;&amp; sux == new_sux) {
2660         // still in same range
2661         range-&gt;set_high_key(new_key);
2662       } else {
2663         // skip tests which explicitly dispatch to the default
2664         if (range-&gt;sux() != default_sux) {
2665           res-&gt;append(range);
2666         }
2667         range = new C1SwitchRange(new_key, new_sux);
2668       }
2669       key = new_key;
2670       sux = new_sux;
2671     }
2672     if (res-&gt;length() == 0 || res-&gt;last() != range)  res-&gt;append(range);
2673   }
2674   return res;
2675 }
2676 
2677 
2678 void LIRGenerator::do_TableSwitch(TableSwitch* x) {
2679   LIRItem tag(x-&gt;tag(), this);
2680   tag.load_item();
2681   set_no_result(x);
2682 
2683   if (x-&gt;is_safepoint()) {
2684     __ safepoint(safepoint_poll_register(), state_for(x, x-&gt;state_before()));
2685   }
2686 
2687   // move values into phi locations
2688   move_to_phi(x-&gt;state());
2689 
2690   int lo_key = x-&gt;lo_key();
2691   int len = x-&gt;length();
2692   assert(lo_key &lt;= (lo_key + (len - 1)), &quot;integer overflow&quot;);
2693   LIR_Opr value = tag.result();
2694 
2695   if (compilation()-&gt;env()-&gt;comp_level() == CompLevel_full_profile &amp;&amp; UseSwitchProfiling) {
2696     ciMethod* method = x-&gt;state()-&gt;scope()-&gt;method();
2697     ciMethodData* md = method-&gt;method_data_or_null();
2698     assert(md != NULL, &quot;Sanity&quot;);
2699     ciProfileData* data = md-&gt;bci_to_data(x-&gt;state()-&gt;bci());
2700     assert(data != NULL, &quot;must have profiling data&quot;);
2701     assert(data-&gt;is_MultiBranchData(), &quot;bad profile data?&quot;);
2702     int default_count_offset = md-&gt;byte_offset_of_slot(data, MultiBranchData::default_count_offset());
2703     LIR_Opr md_reg = new_register(T_METADATA);
2704     __ metadata2reg(md-&gt;constant_encoding(), md_reg);
2705     LIR_Opr data_offset_reg = new_pointer_register();
2706     LIR_Opr tmp_reg = new_pointer_register();
2707 
2708     __ move(LIR_OprFact::intptrConst(default_count_offset), data_offset_reg);
2709     for (int i = 0; i &lt; len; i++) {
2710       int count_offset = md-&gt;byte_offset_of_slot(data, MultiBranchData::case_count_offset(i));
2711       __ cmp(lir_cond_equal, value, i + lo_key);
2712       __ move(data_offset_reg, tmp_reg);
2713       __ cmove(lir_cond_equal,
2714                LIR_OprFact::intptrConst(count_offset),
2715                tmp_reg,
2716                data_offset_reg, T_INT);
2717     }
2718 
2719     LIR_Opr data_reg = new_pointer_register();
2720     LIR_Address* data_addr = new LIR_Address(md_reg, data_offset_reg, data_reg-&gt;type());
2721     __ move(data_addr, data_reg);
2722     __ add(data_reg, LIR_OprFact::intptrConst(1), data_reg);
2723     __ move(data_reg, data_addr);
2724   }
2725 
2726   if (UseTableRanges) {
2727     do_SwitchRanges(create_lookup_ranges(x), value, x-&gt;default_sux());
2728   } else {
2729     for (int i = 0; i &lt; len; i++) {
2730       __ cmp(lir_cond_equal, value, i + lo_key);
2731       __ branch(lir_cond_equal, x-&gt;sux_at(i));
2732     }
2733     __ jump(x-&gt;default_sux());
2734   }
2735 }
2736 
2737 
2738 void LIRGenerator::do_LookupSwitch(LookupSwitch* x) {
2739   LIRItem tag(x-&gt;tag(), this);
2740   tag.load_item();
2741   set_no_result(x);
2742 
2743   if (x-&gt;is_safepoint()) {
2744     __ safepoint(safepoint_poll_register(), state_for(x, x-&gt;state_before()));
2745   }
2746 
2747   // move values into phi locations
2748   move_to_phi(x-&gt;state());
2749 
2750   LIR_Opr value = tag.result();
2751   int len = x-&gt;length();
2752 
2753   if (compilation()-&gt;env()-&gt;comp_level() == CompLevel_full_profile &amp;&amp; UseSwitchProfiling) {
2754     ciMethod* method = x-&gt;state()-&gt;scope()-&gt;method();
2755     ciMethodData* md = method-&gt;method_data_or_null();
2756     assert(md != NULL, &quot;Sanity&quot;);
2757     ciProfileData* data = md-&gt;bci_to_data(x-&gt;state()-&gt;bci());
2758     assert(data != NULL, &quot;must have profiling data&quot;);
2759     assert(data-&gt;is_MultiBranchData(), &quot;bad profile data?&quot;);
2760     int default_count_offset = md-&gt;byte_offset_of_slot(data, MultiBranchData::default_count_offset());
2761     LIR_Opr md_reg = new_register(T_METADATA);
2762     __ metadata2reg(md-&gt;constant_encoding(), md_reg);
2763     LIR_Opr data_offset_reg = new_pointer_register();
2764     LIR_Opr tmp_reg = new_pointer_register();
2765 
2766     __ move(LIR_OprFact::intptrConst(default_count_offset), data_offset_reg);
2767     for (int i = 0; i &lt; len; i++) {
2768       int count_offset = md-&gt;byte_offset_of_slot(data, MultiBranchData::case_count_offset(i));
2769       __ cmp(lir_cond_equal, value, x-&gt;key_at(i));
2770       __ move(data_offset_reg, tmp_reg);
2771       __ cmove(lir_cond_equal,
2772                LIR_OprFact::intptrConst(count_offset),
2773                tmp_reg,
2774                data_offset_reg, T_INT);
2775     }
2776 
2777     LIR_Opr data_reg = new_pointer_register();
2778     LIR_Address* data_addr = new LIR_Address(md_reg, data_offset_reg, data_reg-&gt;type());
2779     __ move(data_addr, data_reg);
2780     __ add(data_reg, LIR_OprFact::intptrConst(1), data_reg);
2781     __ move(data_reg, data_addr);
2782   }
2783 
2784   if (UseTableRanges) {
2785     do_SwitchRanges(create_lookup_ranges(x), value, x-&gt;default_sux());
2786   } else {
2787     int len = x-&gt;length();
2788     for (int i = 0; i &lt; len; i++) {
2789       __ cmp(lir_cond_equal, value, x-&gt;key_at(i));
2790       __ branch(lir_cond_equal, x-&gt;sux_at(i));
2791     }
2792     __ jump(x-&gt;default_sux());
2793   }
2794 }
2795 
2796 
2797 void LIRGenerator::do_Goto(Goto* x) {
2798   set_no_result(x);
2799 
2800   if (block()-&gt;next()-&gt;as_OsrEntry()) {
2801     // need to free up storage used for OSR entry point
2802     LIR_Opr osrBuffer = block()-&gt;next()-&gt;operand();
2803     BasicTypeList signature;
2804     signature.append(NOT_LP64(T_INT) LP64_ONLY(T_LONG)); // pass a pointer to osrBuffer
2805     CallingConvention* cc = frame_map()-&gt;c_calling_convention(&amp;signature);
2806     __ move(osrBuffer, cc-&gt;args()-&gt;at(0));
2807     __ call_runtime_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::OSR_migration_end),
2808                          getThreadTemp(), LIR_OprFact::illegalOpr, cc-&gt;args());
2809   }
2810 
2811   if (x-&gt;is_safepoint()) {
2812     ValueStack* state = x-&gt;state_before() ? x-&gt;state_before() : x-&gt;state();
2813 
2814     // increment backedge counter if needed
2815     CodeEmitInfo* info = state_for(x, state);
2816     increment_backedge_counter(info, x-&gt;profiled_bci());
2817     CodeEmitInfo* safepoint_info = state_for(x, state);
2818     __ safepoint(safepoint_poll_register(), safepoint_info);
2819   }
2820 
2821   // Gotos can be folded Ifs, handle this case.
2822   if (x-&gt;should_profile()) {
2823     ciMethod* method = x-&gt;profiled_method();
2824     assert(method != NULL, &quot;method should be set if branch is profiled&quot;);
2825     ciMethodData* md = method-&gt;method_data_or_null();
2826     assert(md != NULL, &quot;Sanity&quot;);
2827     ciProfileData* data = md-&gt;bci_to_data(x-&gt;profiled_bci());
2828     assert(data != NULL, &quot;must have profiling data&quot;);
2829     int offset;
2830     if (x-&gt;direction() == Goto::taken) {
2831       assert(data-&gt;is_BranchData(), &quot;need BranchData for two-way branches&quot;);
2832       offset = md-&gt;byte_offset_of_slot(data, BranchData::taken_offset());
2833     } else if (x-&gt;direction() == Goto::not_taken) {
2834       assert(data-&gt;is_BranchData(), &quot;need BranchData for two-way branches&quot;);
2835       offset = md-&gt;byte_offset_of_slot(data, BranchData::not_taken_offset());
2836     } else {
2837       assert(data-&gt;is_JumpData(), &quot;need JumpData for branches&quot;);
2838       offset = md-&gt;byte_offset_of_slot(data, JumpData::taken_offset());
2839     }
2840     LIR_Opr md_reg = new_register(T_METADATA);
2841     __ metadata2reg(md-&gt;constant_encoding(), md_reg);
2842 
2843     increment_counter(new LIR_Address(md_reg, offset,
2844                                       NOT_LP64(T_INT) LP64_ONLY(T_LONG)), DataLayout::counter_increment);
2845   }
2846 
2847   // emit phi-instruction move after safepoint since this simplifies
2848   // describing the state as the safepoint.
2849   move_to_phi(x-&gt;state());
2850 
2851   __ jump(x-&gt;default_sux());
2852 }
2853 
2854 /**
2855  * Emit profiling code if needed for arguments, parameters, return value types
2856  *
2857  * @param md                    MDO the code will update at runtime
2858  * @param md_base_offset        common offset in the MDO for this profile and subsequent ones
2859  * @param md_offset             offset in the MDO (on top of md_base_offset) for this profile
2860  * @param profiled_k            current profile
2861  * @param obj                   IR node for the object to be profiled
2862  * @param mdp                   register to hold the pointer inside the MDO (md + md_base_offset).
2863  *                              Set once we find an update to make and use for next ones.
2864  * @param not_null              true if we know obj cannot be null
2865  * @param signature_at_call_k   signature at call for obj
2866  * @param callee_signature_k    signature of callee for obj
2867  *                              at call and callee signatures differ at method handle call
2868  * @return                      the only klass we know will ever be seen at this profile point
2869  */
2870 ciKlass* LIRGenerator::profile_type(ciMethodData* md, int md_base_offset, int md_offset, intptr_t profiled_k,
2871                                     Value obj, LIR_Opr&amp; mdp, bool not_null, ciKlass* signature_at_call_k,
2872                                     ciKlass* callee_signature_k) {
2873   ciKlass* result = NULL;
2874   bool do_null = !not_null &amp;&amp; !TypeEntries::was_null_seen(profiled_k);
2875   bool do_update = !TypeEntries::is_type_unknown(profiled_k);
2876   // known not to be null or null bit already set and already set to
2877   // unknown: nothing we can do to improve profiling
2878   if (!do_null &amp;&amp; !do_update) {
2879     return result;
2880   }
2881 
2882   ciKlass* exact_klass = NULL;
2883   Compilation* comp = Compilation::current();
2884   if (do_update) {
2885     // try to find exact type, using CHA if possible, so that loading
2886     // the klass from the object can be avoided
2887     ciType* type = obj-&gt;exact_type();
2888     if (type == NULL) {
2889       type = obj-&gt;declared_type();
2890       type = comp-&gt;cha_exact_type(type);
2891     }
2892     assert(type == NULL || type-&gt;is_klass(), &quot;type should be class&quot;);
2893     exact_klass = (type != NULL &amp;&amp; type-&gt;is_loaded()) ? (ciKlass*)type : NULL;
2894 
2895     do_update = exact_klass == NULL || ciTypeEntries::valid_ciklass(profiled_k) != exact_klass;
2896   }
2897 
2898   if (!do_null &amp;&amp; !do_update) {
2899     return result;
2900   }
2901 
2902   ciKlass* exact_signature_k = NULL;
2903   if (do_update &amp;&amp; signature_at_call_k != NULL) {
2904     // Is the type from the signature exact (the only one possible)?
2905     exact_signature_k = signature_at_call_k-&gt;exact_klass();
2906     if (exact_signature_k == NULL) {
2907       exact_signature_k = comp-&gt;cha_exact_type(signature_at_call_k);
2908     } else {
2909       result = exact_signature_k;
2910       // Known statically. No need to emit any code: prevent
2911       // LIR_Assembler::emit_profile_type() from emitting useless code
2912       profiled_k = ciTypeEntries::with_status(result, profiled_k);
2913     }
2914     // exact_klass and exact_signature_k can be both non NULL but
2915     // different if exact_klass is loaded after the ciObject for
2916     // exact_signature_k is created.
2917     if (exact_klass == NULL &amp;&amp; exact_signature_k != NULL &amp;&amp; exact_klass != exact_signature_k) {
2918       // sometimes the type of the signature is better than the best type
2919       // the compiler has
2920       exact_klass = exact_signature_k;
2921     }
2922     if (callee_signature_k != NULL &amp;&amp;
2923         callee_signature_k != signature_at_call_k) {
2924       ciKlass* improved_klass = callee_signature_k-&gt;exact_klass();
2925       if (improved_klass == NULL) {
2926         improved_klass = comp-&gt;cha_exact_type(callee_signature_k);
2927       }
2928       if (exact_klass == NULL &amp;&amp; improved_klass != NULL &amp;&amp; exact_klass != improved_klass) {
2929         exact_klass = exact_signature_k;
2930       }
2931     }
2932     do_update = exact_klass == NULL || ciTypeEntries::valid_ciklass(profiled_k) != exact_klass;
2933   }
2934 
2935   if (!do_null &amp;&amp; !do_update) {
2936     return result;
2937   }
2938 
2939   if (mdp == LIR_OprFact::illegalOpr) {
2940     mdp = new_register(T_METADATA);
2941     __ metadata2reg(md-&gt;constant_encoding(), mdp);
2942     if (md_base_offset != 0) {
2943       LIR_Address* base_type_address = new LIR_Address(mdp, md_base_offset, T_ADDRESS);
2944       mdp = new_pointer_register();
2945       __ leal(LIR_OprFact::address(base_type_address), mdp);
2946     }
2947   }
2948   LIRItem value(obj, this);
2949   value.load_item();
2950   __ profile_type(new LIR_Address(mdp, md_offset, T_METADATA),
2951                   value.result(), exact_klass, profiled_k, new_pointer_register(), not_null, exact_signature_k != NULL);
2952   return result;
2953 }
2954 
2955 // profile parameters on entry to the root of the compilation
2956 void LIRGenerator::profile_parameters(Base* x) {
2957   if (compilation()-&gt;profile_parameters()) {
2958     CallingConvention* args = compilation()-&gt;frame_map()-&gt;incoming_arguments();
2959     ciMethodData* md = scope()-&gt;method()-&gt;method_data_or_null();
2960     assert(md != NULL, &quot;Sanity&quot;);
2961 
2962     if (md-&gt;parameters_type_data() != NULL) {
2963       ciParametersTypeData* parameters_type_data = md-&gt;parameters_type_data();
2964       ciTypeStackSlotEntries* parameters =  parameters_type_data-&gt;parameters();
2965       LIR_Opr mdp = LIR_OprFact::illegalOpr;
2966       for (int java_index = 0, i = 0, j = 0; j &lt; parameters_type_data-&gt;number_of_parameters(); i++) {
2967         LIR_Opr src = args-&gt;at(i);
2968         assert(!src-&gt;is_illegal(), &quot;check&quot;);
2969         BasicType t = src-&gt;type();
2970         if (is_reference_type(t)) {
2971           intptr_t profiled_k = parameters-&gt;type(j);
2972           Local* local = x-&gt;state()-&gt;local_at(java_index)-&gt;as_Local();
2973           ciKlass* exact = profile_type(md, md-&gt;byte_offset_of_slot(parameters_type_data, ParametersTypeData::type_offset(0)),
2974                                         in_bytes(ParametersTypeData::type_offset(j)) - in_bytes(ParametersTypeData::type_offset(0)),
2975                                         profiled_k, local, mdp, false, local-&gt;declared_type()-&gt;as_klass(), NULL);
2976           // If the profile is known statically set it once for all and do not emit any code
2977           if (exact != NULL) {
2978             md-&gt;set_parameter_type(j, exact);
2979           }
2980           j++;
2981         }
2982         java_index += type2size[t];
2983       }
2984     }
2985   }
2986 }
2987 
2988 void LIRGenerator::profile_array_load_store_flags(ciMethodData* md, ciArrayLoadStoreData* load_store, int flag, LIR_Opr mdp) {
2989   assert(md != NULL &amp;&amp; load_store != NULL, &quot;should have been initialized&quot;);
2990   if (mdp == NULL) {
2991     mdp = new_register(T_METADATA);
2992     __ metadata2reg(md-&gt;constant_encoding(), mdp);
2993   }
2994   LIR_Address* addr = new LIR_Address(mdp, md-&gt;byte_offset_of_slot(load_store, DataLayout::flags_offset()), T_BYTE);
2995   LIR_Opr id = new_register(T_INT);
2996   __ move(addr, id);
2997   __ logical_or(id, LIR_OprFact::intConst(flag), id);
2998   __ store(id, addr);
2999 }
3000 
3001 void LIRGenerator::profile_null_free_array(LIRItem array, ciMethodData* md, ciArrayLoadStoreData* load_store) {
3002   LabelObj* L_end = new LabelObj();
3003   LIR_Opr tmp = new_register(T_METADATA);
3004   LIR_Opr mdp = new_register(T_METADATA);
3005   assert(md != NULL, &quot;should have been initialized&quot;);
3006   __ metadata2reg(md-&gt;constant_encoding(), mdp);
3007   __ check_null_free_array(array.result(), tmp);
3008   __ branch(lir_cond_equal, L_end-&gt;label());
3009 
3010   profile_array_load_store_flags(md, load_store, ArrayLoadStoreData::null_free_array_byte_constant(), mdp);
3011 
3012   __ branch_destination(L_end-&gt;label());
3013 }
3014 
3015 void LIRGenerator::profile_array_type(AccessIndexed* x, ciMethodData*&amp; md, ciArrayLoadStoreData*&amp; load_store) {
3016   int bci = x-&gt;profiled_bci();
3017   md = x-&gt;profiled_method()-&gt;method_data();
3018   assert(md != NULL, &quot;Sanity&quot;);
3019   ciProfileData* data = md-&gt;bci_to_data(bci);
3020   assert(data != NULL &amp;&amp; data-&gt;is_ArrayLoadStoreData(), &quot;incorrect profiling entry&quot;);
3021   load_store = (ciArrayLoadStoreData*)data;
3022   LIR_Opr mdp = LIR_OprFact::illegalOpr;
3023   profile_type(md, md-&gt;byte_offset_of_slot(load_store, ArrayLoadStoreData::array_offset()), 0,
3024                load_store-&gt;array()-&gt;type(), x-&gt;array(), mdp, true, NULL, NULL);
3025 }
3026 
3027 void LIRGenerator::profile_element_type(Value element, ciMethodData* md, ciArrayLoadStoreData* load_store) {
3028   assert(md != NULL &amp;&amp; load_store != NULL, &quot;should have been initialized&quot;);
3029   LIR_Opr mdp = LIR_OprFact::illegalOpr;
3030   profile_type(md, md-&gt;byte_offset_of_slot(load_store, ArrayLoadStoreData::element_offset()), 0,
3031                load_store-&gt;element()-&gt;type(), element, mdp, false, NULL, NULL);
3032 }
3033 
3034 
3035 void LIRGenerator::do_Base(Base* x) {
3036   __ std_entry(LIR_OprFact::illegalOpr);
3037   // Emit moves from physical registers / stack slots to virtual registers
3038   CallingConvention* args = compilation()-&gt;frame_map()-&gt;incoming_arguments();
3039   IRScope* irScope = compilation()-&gt;hir()-&gt;top_scope();
3040   int java_index = 0;
3041   for (int i = 0; i &lt; args-&gt;length(); i++) {
3042     LIR_Opr src = args-&gt;at(i);
3043     assert(!src-&gt;is_illegal(), &quot;check&quot;);
3044     BasicType t = src-&gt;type();
3045 
3046     // Types which are smaller than int are passed as int, so
3047     // correct the type which passed.
3048     switch (t) {
3049     case T_BYTE:
3050     case T_BOOLEAN:
3051     case T_SHORT:
3052     case T_CHAR:
3053       t = T_INT;
3054       break;
3055     default:
3056       break;
3057     }
3058 
3059     LIR_Opr dest = new_register(t);
3060     __ move(src, dest);
3061 
3062     // Assign new location to Local instruction for this local
3063     Local* local = x-&gt;state()-&gt;local_at(java_index)-&gt;as_Local();
3064     assert(local != NULL, &quot;Locals for incoming arguments must have been created&quot;);
3065 #ifndef __SOFTFP__
3066     // The java calling convention passes double as long and float as int.
3067     assert(as_ValueType(t)-&gt;tag() == local-&gt;type()-&gt;tag(), &quot;check&quot;);
3068 #endif // __SOFTFP__
3069     local-&gt;set_operand(dest);
3070     _instruction_for_operand.at_put_grow(dest-&gt;vreg_number(), local, NULL);
3071     java_index += type2size[t];
3072   }
3073 
3074   if (compilation()-&gt;env()-&gt;dtrace_method_probes()) {
3075     BasicTypeList signature;
3076     signature.append(LP64_ONLY(T_LONG) NOT_LP64(T_INT));    // thread
3077     signature.append(T_METADATA); // Method*
3078     LIR_OprList* args = new LIR_OprList();
3079     args-&gt;append(getThreadPointer());
3080     LIR_Opr meth = new_register(T_METADATA);
3081     __ metadata2reg(method()-&gt;constant_encoding(), meth);
3082     args-&gt;append(meth);
3083     call_runtime(&amp;signature, args, CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_entry), voidType, NULL);
3084   }
3085 
3086   if (method()-&gt;is_synchronized()) {
3087     LIR_Opr obj;
3088     if (method()-&gt;is_static()) {
3089       obj = new_register(T_OBJECT);
3090       __ oop2reg(method()-&gt;holder()-&gt;java_mirror()-&gt;constant_encoding(), obj);
3091     } else {
3092       Local* receiver = x-&gt;state()-&gt;local_at(0)-&gt;as_Local();
3093       assert(receiver != NULL, &quot;must already exist&quot;);
3094       obj = receiver-&gt;operand();
3095     }
3096     assert(obj-&gt;is_valid(), &quot;must be valid&quot;);
3097 
3098     if (method()-&gt;is_synchronized() &amp;&amp; GenerateSynchronizationCode) {
3099       LIR_Opr lock = syncLockOpr();
3100       __ load_stack_address_monitor(0, lock);
3101 
3102       CodeEmitInfo* info = new CodeEmitInfo(scope()-&gt;start()-&gt;state()-&gt;copy(ValueStack::StateBefore, SynchronizationEntryBCI), NULL, x-&gt;check_flag(Instruction::DeoptimizeOnException));
3103       CodeStub* slow_path = new MonitorEnterStub(obj, lock, info);
3104 
3105       // receiver is guaranteed non-NULL so don&#39;t need CodeEmitInfo
3106       __ lock_object(syncTempOpr(), obj, lock, new_register(T_OBJECT), slow_path, NULL);
3107     }
3108   }
3109   if (compilation()-&gt;age_code()) {
3110     CodeEmitInfo* info = new CodeEmitInfo(scope()-&gt;start()-&gt;state()-&gt;copy(ValueStack::StateBefore, 0), NULL, false);
3111     decrement_age(info);
3112   }
3113   // increment invocation counters if needed
3114   if (!method()-&gt;is_accessor()) { // Accessors do not have MDOs, so no counting.
3115     profile_parameters(x);
3116     CodeEmitInfo* info = new CodeEmitInfo(scope()-&gt;start()-&gt;state()-&gt;copy(ValueStack::StateBefore, SynchronizationEntryBCI), NULL, false);
3117     increment_invocation_counter(info);
3118   }
3119   if (method()-&gt;has_scalarized_args()) {
3120     // Check if deoptimization was triggered (i.e. orig_pc was set) while buffering scalarized value type arguments
3121     // in the entry point (see comments in frame::deoptimize). If so, deoptimize only now that we have the right state.
3122     CodeEmitInfo* info = new CodeEmitInfo(scope()-&gt;start()-&gt;state()-&gt;copy(ValueStack::StateBefore, 0), NULL, false);
3123     CodeStub* deopt_stub = new DeoptimizeStub(info, Deoptimization::Reason_none, Deoptimization::Action_none);
3124     __ append(new LIR_Op0(lir_check_orig_pc));
3125     __ branch(lir_cond_notEqual, deopt_stub);
3126   }
3127 
3128   // all blocks with a successor must end with an unconditional jump
3129   // to the successor even if they are consecutive
3130   __ jump(x-&gt;default_sux());
3131 }
3132 
3133 
3134 void LIRGenerator::do_OsrEntry(OsrEntry* x) {
3135   // construct our frame and model the production of incoming pointer
3136   // to the OSR buffer.
3137   __ osr_entry(LIR_Assembler::osrBufferPointer());
3138   LIR_Opr result = rlock_result(x);
3139   __ move(LIR_Assembler::osrBufferPointer(), result);
3140 }
3141 
3142 void LIRGenerator::invoke_load_one_argument(LIRItem* param, LIR_Opr loc) {
3143   if (loc-&gt;is_register()) {
3144     param-&gt;load_item_force(loc);
3145   } else {
3146     LIR_Address* addr = loc-&gt;as_address_ptr();
3147     param-&gt;load_for_store(addr-&gt;type());
3148     assert(addr-&gt;type() != T_INLINE_TYPE, &quot;not supported yet&quot;);
3149     if (addr-&gt;type() == T_OBJECT) {
3150       __ move_wide(param-&gt;result(), addr);
3151     } else {
3152       if (addr-&gt;type() == T_LONG || addr-&gt;type() == T_DOUBLE) {
3153         __ unaligned_move(param-&gt;result(), addr);
3154       } else {
3155         __ move(param-&gt;result(), addr);
3156       }
3157     }
3158   }
3159 }
3160 
3161 void LIRGenerator::invoke_load_arguments(Invoke* x, LIRItemList* args, const LIR_OprList* arg_list) {
3162   assert(args-&gt;length() == arg_list-&gt;length(),
3163          &quot;args=%d, arg_list=%d&quot;, args-&gt;length(), arg_list-&gt;length());
3164   for (int i = x-&gt;has_receiver() ? 1 : 0; i &lt; args-&gt;length(); i++) {
3165     LIRItem* param = args-&gt;at(i);
3166     LIR_Opr loc = arg_list-&gt;at(i);
3167     invoke_load_one_argument(param, loc);
3168   }
3169 
3170   if (x-&gt;has_receiver()) {
3171     LIRItem* receiver = args-&gt;at(0);
3172     LIR_Opr loc = arg_list-&gt;at(0);
3173     if (loc-&gt;is_register()) {
3174       receiver-&gt;load_item_force(loc);
3175     } else {
3176       assert(loc-&gt;is_address(), &quot;just checking&quot;);
3177       receiver-&gt;load_for_store(T_OBJECT);
3178       __ move_wide(receiver-&gt;result(), loc-&gt;as_address_ptr());
3179     }
3180   }
3181 }
3182 
3183 
3184 // Visits all arguments, returns appropriate items without loading them
3185 LIRItemList* LIRGenerator::invoke_visit_arguments(Invoke* x) {
3186   LIRItemList* argument_items = new LIRItemList();
3187   if (x-&gt;has_receiver()) {
3188     LIRItem* receiver = new LIRItem(x-&gt;receiver(), this);
3189     argument_items-&gt;append(receiver);
3190   }
3191   for (int i = 0; i &lt; x-&gt;number_of_arguments(); i++) {
3192     LIRItem* param = new LIRItem(x-&gt;argument_at(i), this);
3193     argument_items-&gt;append(param);
3194   }
3195   return argument_items;
3196 }
3197 
3198 
3199 // The invoke with receiver has following phases:
3200 //   a) traverse and load/lock receiver;
3201 //   b) traverse all arguments -&gt; item-array (invoke_visit_argument)
3202 //   c) push receiver on stack
3203 //   d) load each of the items and push on stack
3204 //   e) unlock receiver
3205 //   f) move receiver into receiver-register %o0
3206 //   g) lock result registers and emit call operation
3207 //
3208 // Before issuing a call, we must spill-save all values on stack
3209 // that are in caller-save register. &quot;spill-save&quot; moves those registers
3210 // either in a free callee-save register or spills them if no free
3211 // callee save register is available.
3212 //
3213 // The problem is where to invoke spill-save.
3214 // - if invoked between e) and f), we may lock callee save
3215 //   register in &quot;spill-save&quot; that destroys the receiver register
3216 //   before f) is executed
3217 // - if we rearrange f) to be earlier (by loading %o0) it
3218 //   may destroy a value on the stack that is currently in %o0
3219 //   and is waiting to be spilled
3220 // - if we keep the receiver locked while doing spill-save,
3221 //   we cannot spill it as it is spill-locked
3222 //
3223 void LIRGenerator::do_Invoke(Invoke* x) {
3224   CallingConvention* cc = frame_map()-&gt;java_calling_convention(x-&gt;signature(), true);
3225 
3226   LIR_OprList* arg_list = cc-&gt;args();
3227   LIRItemList* args = invoke_visit_arguments(x);
3228   LIR_Opr receiver = LIR_OprFact::illegalOpr;
3229 
3230   // setup result register
3231   LIR_Opr result_register = LIR_OprFact::illegalOpr;
3232   if (x-&gt;type() != voidType) {
3233     result_register = result_register_for(x-&gt;type());
3234   }
3235 
3236   CodeEmitInfo* info = state_for(x, x-&gt;state());
3237 
3238   invoke_load_arguments(x, args, arg_list);
3239 
3240   if (x-&gt;has_receiver()) {
3241     args-&gt;at(0)-&gt;load_item_force(LIR_Assembler::receiverOpr());
3242     receiver = args-&gt;at(0)-&gt;result();
3243   }
3244 
3245   // emit invoke code
3246   assert(receiver-&gt;is_illegal() || receiver-&gt;is_equal(LIR_Assembler::receiverOpr()), &quot;must match&quot;);
3247 
3248   // JSR 292
3249   // Preserve the SP over MethodHandle call sites, if needed.
3250   ciMethod* target = x-&gt;target();
3251   bool is_method_handle_invoke = (// %%% FIXME: Are both of these relevant?
3252                                   target-&gt;is_method_handle_intrinsic() ||
3253                                   target-&gt;is_compiled_lambda_form());
3254   if (is_method_handle_invoke) {
3255     info-&gt;set_is_method_handle_invoke(true);
3256     if(FrameMap::method_handle_invoke_SP_save_opr() != LIR_OprFact::illegalOpr) {
3257         __ move(FrameMap::stack_pointer(), FrameMap::method_handle_invoke_SP_save_opr());
3258     }
3259   }
3260 
3261   switch (x-&gt;code()) {
3262     case Bytecodes::_invokestatic:
3263       __ call_static(target, result_register,
3264                      SharedRuntime::get_resolve_static_call_stub(),
3265                      arg_list, info);
3266       break;
3267     case Bytecodes::_invokespecial:
3268     case Bytecodes::_invokevirtual:
3269     case Bytecodes::_invokeinterface:
3270       // for loaded and final (method or class) target we still produce an inline cache,
3271       // in order to be able to call mixed mode
3272       if (x-&gt;code() == Bytecodes::_invokespecial || x-&gt;target_is_final()) {
3273         __ call_opt_virtual(target, receiver, result_register,
3274                             SharedRuntime::get_resolve_opt_virtual_call_stub(),
3275                             arg_list, info);
3276       } else if (x-&gt;vtable_index() &lt; 0) {
3277         __ call_icvirtual(target, receiver, result_register,
3278                           SharedRuntime::get_resolve_virtual_call_stub(),
3279                           arg_list, info);
3280       } else {
3281         int entry_offset = in_bytes(Klass::vtable_start_offset()) + x-&gt;vtable_index() * vtableEntry::size_in_bytes();
3282         int vtable_offset = entry_offset + vtableEntry::method_offset_in_bytes();
3283         __ call_virtual(target, receiver, result_register, vtable_offset, arg_list, info);
3284       }
3285       break;
3286     case Bytecodes::_invokedynamic: {
3287       __ call_dynamic(target, receiver, result_register,
3288                       SharedRuntime::get_resolve_static_call_stub(),
3289                       arg_list, info);
3290       break;
3291     }
3292     default:
3293       fatal(&quot;unexpected bytecode: %s&quot;, Bytecodes::name(x-&gt;code()));
3294       break;
3295   }
3296 
3297   // JSR 292
3298   // Restore the SP after MethodHandle call sites, if needed.
3299   if (is_method_handle_invoke
3300       &amp;&amp; FrameMap::method_handle_invoke_SP_save_opr() != LIR_OprFact::illegalOpr) {
3301     __ move(FrameMap::method_handle_invoke_SP_save_opr(), FrameMap::stack_pointer());
3302   }
3303 
3304   if (x-&gt;type()-&gt;is_float() || x-&gt;type()-&gt;is_double()) {
3305     // Force rounding of results from non-strictfp when in strictfp
3306     // scope (or when we don&#39;t know the strictness of the callee, to
3307     // be safe.)
3308     if (method()-&gt;is_strict()) {
3309       if (!x-&gt;target_is_loaded() || !x-&gt;target_is_strictfp()) {
3310         result_register = round_item(result_register);
3311       }
3312     }
3313   }
3314 
3315   if (result_register-&gt;is_valid()) {
3316     LIR_Opr result = rlock_result(x);
3317     __ move(result_register, result);
3318   }
3319 }
3320 
3321 
3322 void LIRGenerator::do_FPIntrinsics(Intrinsic* x) {
3323   assert(x-&gt;number_of_arguments() == 1, &quot;wrong type&quot;);
3324   LIRItem value       (x-&gt;argument_at(0), this);
3325   LIR_Opr reg = rlock_result(x);
3326   value.load_item();
3327   LIR_Opr tmp = force_to_spill(value.result(), as_BasicType(x-&gt;type()));
3328   __ move(tmp, reg);
3329 }
3330 
3331 
3332 
3333 // Code for  :  x-&gt;x() {x-&gt;cond()} x-&gt;y() ? x-&gt;tval() : x-&gt;fval()
3334 void LIRGenerator::do_IfOp(IfOp* x) {
3335 #ifdef ASSERT
3336   {
3337     ValueTag xtag = x-&gt;x()-&gt;type()-&gt;tag();
3338     ValueTag ttag = x-&gt;tval()-&gt;type()-&gt;tag();
3339     assert(xtag == intTag || xtag == objectTag, &quot;cannot handle others&quot;);
3340     assert(ttag == addressTag || ttag == intTag || ttag == objectTag || ttag == longTag, &quot;cannot handle others&quot;);
3341     assert(ttag == x-&gt;fval()-&gt;type()-&gt;tag(), &quot;cannot handle others&quot;);
3342   }
3343 #endif
3344 
3345   LIRItem left(x-&gt;x(), this);
3346   LIRItem right(x-&gt;y(), this);
3347   left.load_item();
3348   if (can_inline_as_constant(right.value()) &amp;&amp; !x-&gt;substitutability_check()) {
3349     right.dont_load_item();
3350   } else {
3351     // substitutability_check() needs to use right as a base register.
3352     right.load_item();
3353   }
3354 
3355   LIRItem t_val(x-&gt;tval(), this);
3356   LIRItem f_val(x-&gt;fval(), this);
3357   t_val.dont_load_item();
3358   f_val.dont_load_item();
3359 
3360   if (x-&gt;substitutability_check()) {
3361     substitutability_check(x, left, right, t_val, f_val);
3362   } else {
3363     LIR_Opr reg = rlock_result(x);
3364     __ cmp(lir_cond(x-&gt;cond()), left.result(), right.result());
3365     __ cmove(lir_cond(x-&gt;cond()), t_val.result(), f_val.result(), reg, as_BasicType(x-&gt;x()-&gt;type()));
3366   }
3367 }
3368 
3369 void LIRGenerator::substitutability_check(IfOp* x, LIRItem&amp; left, LIRItem&amp; right, LIRItem&amp; t_val, LIRItem&amp; f_val) {
3370   assert(x-&gt;cond() == If::eql || x-&gt;cond() == If::neq, &quot;must be&quot;);
3371   bool is_acmpeq = (x-&gt;cond() == If::eql);
3372   LIR_Opr equal_result     = is_acmpeq ? t_val.result() : f_val.result();
3373   LIR_Opr not_equal_result = is_acmpeq ? f_val.result() : t_val.result();
3374   LIR_Opr result = rlock_result(x);
3375   CodeEmitInfo* info = state_for(x, x-&gt;state_before());
3376 
3377   substitutability_check_common(x-&gt;x(), x-&gt;y(), left, right, equal_result, not_equal_result, result, info);
3378 }
3379 
3380 void LIRGenerator::substitutability_check(If* x, LIRItem&amp; left, LIRItem&amp; right) {
3381   LIR_Opr equal_result     = LIR_OprFact::intConst(1);
3382   LIR_Opr not_equal_result = LIR_OprFact::intConst(0);
3383   LIR_Opr result = new_register(T_INT);
3384   CodeEmitInfo* info = state_for(x, x-&gt;state_before());
3385 
3386   substitutability_check_common(x-&gt;x(), x-&gt;y(), left, right, equal_result, not_equal_result, result, info);
3387 
3388   assert(x-&gt;cond() == If::eql || x-&gt;cond() == If::neq, &quot;must be&quot;);
3389   __ cmp(lir_cond(x-&gt;cond()), result, equal_result);
3390 }
3391 
3392 void LIRGenerator::substitutability_check_common(Value left_val, Value right_val, LIRItem&amp; left, LIRItem&amp; right,
3393                                                  LIR_Opr equal_result, LIR_Opr not_equal_result, LIR_Opr result,
3394                                                  CodeEmitInfo* info) {
3395   LIR_Opr tmp1 = LIR_OprFact::illegalOpr;
3396   LIR_Opr tmp2 = LIR_OprFact::illegalOpr;
3397   LIR_Opr left_klass_op = LIR_OprFact::illegalOpr;
3398   LIR_Opr right_klass_op = LIR_OprFact::illegalOpr;
3399 
3400   ciKlass* left_klass  = left_val -&gt;as_loaded_klass_or_null();
3401   ciKlass* right_klass = right_val-&gt;as_loaded_klass_or_null();
3402 
3403   if ((left_klass == NULL || right_klass == NULL) ||// The klass is still unloaded, or came from a Phi node.
3404       !left_klass-&gt;is_valuetype() || !right_klass-&gt;is_valuetype()) {
3405     init_temps_for_substitutability_check(tmp1, tmp2);
3406   }
3407 
3408   if (left_klass != NULL &amp;&amp; left_klass-&gt;is_valuetype() &amp;&amp; left_klass == right_klass) {
3409     // No need to load klass -- the operands are statically known to be the same value klass.
3410   } else {
3411     BasicType t_klass = UseCompressedOops ? T_INT : T_METADATA;
3412     left_klass_op = new_register(t_klass);
3413     right_klass_op = new_register(t_klass);
3414   }
3415 
3416   CodeStub* slow_path = new SubstitutabilityCheckStub(left.result(), right.result(), info);
3417   __ substitutability_check(result, left.result(), right.result(), equal_result, not_equal_result,
3418                             tmp1, tmp2,
3419                             left_klass, right_klass, left_klass_op, right_klass_op, info, slow_path);
3420 }
3421 
3422 #ifdef JFR_HAVE_INTRINSICS
3423 void LIRGenerator::do_ClassIDIntrinsic(Intrinsic* x) {
3424   CodeEmitInfo* info = state_for(x);
3425   CodeEmitInfo* info2 = new CodeEmitInfo(info); // Clone for the second null check
3426 
3427   assert(info != NULL, &quot;must have info&quot;);
3428   LIRItem arg(x-&gt;argument_at(0), this);
3429 
3430   arg.load_item();
3431   LIR_Opr klass = new_register(T_METADATA);
3432   __ move(new LIR_Address(arg.result(), java_lang_Class::klass_offset(), T_ADDRESS), klass, info);
3433   LIR_Opr id = new_register(T_LONG);
3434   ByteSize offset = KLASS_TRACE_ID_OFFSET;
3435   LIR_Address* trace_id_addr = new LIR_Address(klass, in_bytes(offset), T_LONG);
3436 
3437   __ move(trace_id_addr, id);
3438   __ logical_or(id, LIR_OprFact::longConst(0x01l), id);
3439   __ store(id, trace_id_addr);
3440 
3441 #ifdef TRACE_ID_META_BITS
3442   __ logical_and(id, LIR_OprFact::longConst(~TRACE_ID_META_BITS), id);
3443 #endif
3444 #ifdef TRACE_ID_SHIFT
3445   __ unsigned_shift_right(id, TRACE_ID_SHIFT, id);
3446 #endif
3447 
3448   __ move(id, rlock_result(x));
3449 }
3450 
3451 void LIRGenerator::do_getEventWriter(Intrinsic* x) {
3452   LabelObj* L_end = new LabelObj();
3453 
3454   // FIXME T_ADDRESS should actually be T_METADATA but it can&#39;t because the
3455   // meaning of these two is mixed up (see JDK-8026837).
3456   LIR_Address* jobj_addr = new LIR_Address(getThreadPointer(),
3457                                            in_bytes(THREAD_LOCAL_WRITER_OFFSET_JFR),
3458                                            T_ADDRESS);
3459   LIR_Opr result = rlock_result(x);
3460   __ move(LIR_OprFact::oopConst(NULL), result);
3461   LIR_Opr jobj = new_register(T_METADATA);
3462   __ move_wide(jobj_addr, jobj);
3463   __ cmp(lir_cond_equal, jobj, LIR_OprFact::metadataConst(0));
3464   __ branch(lir_cond_equal, L_end-&gt;label());
3465 
3466   access_load(IN_NATIVE, T_OBJECT, LIR_OprFact::address(new LIR_Address(jobj, T_OBJECT)), result);
3467 
3468   __ branch_destination(L_end-&gt;label());
3469 }
3470 
3471 #endif
3472 
3473 
3474 void LIRGenerator::do_RuntimeCall(address routine, Intrinsic* x) {
3475   assert(x-&gt;number_of_arguments() == 0, &quot;wrong type&quot;);
3476   // Enforce computation of _reserved_argument_area_size which is required on some platforms.
3477   BasicTypeList signature;
3478   CallingConvention* cc = frame_map()-&gt;c_calling_convention(&amp;signature);
3479   LIR_Opr reg = result_register_for(x-&gt;type());
3480   __ call_runtime_leaf(routine, getThreadTemp(),
3481                        reg, new LIR_OprList());
3482   LIR_Opr result = rlock_result(x);
3483   __ move(reg, result);
3484 }
3485 
3486 
3487 
3488 void LIRGenerator::do_Intrinsic(Intrinsic* x) {
3489   switch (x-&gt;id()) {
3490   case vmIntrinsics::_intBitsToFloat      :
3491   case vmIntrinsics::_doubleToRawLongBits :
3492   case vmIntrinsics::_longBitsToDouble    :
3493   case vmIntrinsics::_floatToRawIntBits   : {
3494     do_FPIntrinsics(x);
3495     break;
3496   }
3497 
3498 #ifdef JFR_HAVE_INTRINSICS
3499   case vmIntrinsics::_getClassId:
3500     do_ClassIDIntrinsic(x);
3501     break;
3502   case vmIntrinsics::_getEventWriter:
3503     do_getEventWriter(x);
3504     break;
3505   case vmIntrinsics::_counterTime:
3506     do_RuntimeCall(CAST_FROM_FN_PTR(address, JFR_TIME_FUNCTION), x);
3507     break;
3508 #endif
3509 
3510   case vmIntrinsics::_currentTimeMillis:
3511     do_RuntimeCall(CAST_FROM_FN_PTR(address, os::javaTimeMillis), x);
3512     break;
3513 
3514   case vmIntrinsics::_nanoTime:
3515     do_RuntimeCall(CAST_FROM_FN_PTR(address, os::javaTimeNanos), x);
3516     break;
3517 
3518   case vmIntrinsics::_Object_init:    do_RegisterFinalizer(x); break;
3519   case vmIntrinsics::_isInstance:     do_isInstance(x);    break;
3520   case vmIntrinsics::_isPrimitive:    do_isPrimitive(x);   break;
3521   case vmIntrinsics::_getClass:       do_getClass(x);      break;
3522   case vmIntrinsics::_currentThread:  do_currentThread(x); break;
3523 
3524   case vmIntrinsics::_dlog:           // fall through
3525   case vmIntrinsics::_dlog10:         // fall through
3526   case vmIntrinsics::_dabs:           // fall through
3527   case vmIntrinsics::_dsqrt:          // fall through
3528   case vmIntrinsics::_dtan:           // fall through
3529   case vmIntrinsics::_dsin :          // fall through
3530   case vmIntrinsics::_dcos :          // fall through
3531   case vmIntrinsics::_dexp :          // fall through
3532   case vmIntrinsics::_dpow :          do_MathIntrinsic(x); break;
3533   case vmIntrinsics::_arraycopy:      do_ArrayCopy(x);     break;
3534 
3535   case vmIntrinsics::_fmaD:           do_FmaIntrinsic(x); break;
3536   case vmIntrinsics::_fmaF:           do_FmaIntrinsic(x); break;
3537 
3538   // java.nio.Buffer.checkIndex
3539   case vmIntrinsics::_checkIndex:     do_NIOCheckIndex(x); break;
3540 
3541   case vmIntrinsics::_compareAndSetReference:
3542     do_CompareAndSwap(x, objectType);
3543     break;
3544   case vmIntrinsics::_compareAndSetInt:
3545     do_CompareAndSwap(x, intType);
3546     break;
3547   case vmIntrinsics::_compareAndSetLong:
3548     do_CompareAndSwap(x, longType);
3549     break;
3550 
3551   case vmIntrinsics::_loadFence :
3552     __ membar_acquire();
3553     break;
3554   case vmIntrinsics::_storeFence:
3555     __ membar_release();
3556     break;
3557   case vmIntrinsics::_fullFence :
3558     __ membar();
3559     break;
3560   case vmIntrinsics::_onSpinWait:
3561     __ on_spin_wait();
3562     break;
3563   case vmIntrinsics::_Reference_get:
3564     do_Reference_get(x);
3565     break;
3566 
3567   case vmIntrinsics::_updateCRC32:
3568   case vmIntrinsics::_updateBytesCRC32:
3569   case vmIntrinsics::_updateByteBufferCRC32:
3570     do_update_CRC32(x);
3571     break;
3572 
3573   case vmIntrinsics::_updateBytesCRC32C:
3574   case vmIntrinsics::_updateDirectByteBufferCRC32C:
3575     do_update_CRC32C(x);
3576     break;
3577 
3578   case vmIntrinsics::_vectorizedMismatch:
3579     do_vectorizedMismatch(x);
3580     break;
3581 
3582   default: ShouldNotReachHere(); break;
3583   }
3584 }
3585 
3586 void LIRGenerator::profile_arguments(ProfileCall* x) {
3587   if (compilation()-&gt;profile_arguments()) {
3588     int bci = x-&gt;bci_of_invoke();
3589     ciMethodData* md = x-&gt;method()-&gt;method_data_or_null();
3590     assert(md != NULL, &quot;Sanity&quot;);
3591     ciProfileData* data = md-&gt;bci_to_data(bci);
3592     if (data != NULL) {
3593       if ((data-&gt;is_CallTypeData() &amp;&amp; data-&gt;as_CallTypeData()-&gt;has_arguments()) ||
3594           (data-&gt;is_VirtualCallTypeData() &amp;&amp; data-&gt;as_VirtualCallTypeData()-&gt;has_arguments())) {
3595         ByteSize extra = data-&gt;is_CallTypeData() ? CallTypeData::args_data_offset() : VirtualCallTypeData::args_data_offset();
3596         int base_offset = md-&gt;byte_offset_of_slot(data, extra);
3597         LIR_Opr mdp = LIR_OprFact::illegalOpr;
3598         ciTypeStackSlotEntries* args = data-&gt;is_CallTypeData() ? ((ciCallTypeData*)data)-&gt;args() : ((ciVirtualCallTypeData*)data)-&gt;args();
3599 
3600         Bytecodes::Code bc = x-&gt;method()-&gt;java_code_at_bci(bci);
3601         int start = 0;
3602         int stop = data-&gt;is_CallTypeData() ? ((ciCallTypeData*)data)-&gt;number_of_arguments() : ((ciVirtualCallTypeData*)data)-&gt;number_of_arguments();
3603         if (x-&gt;callee()-&gt;is_loaded() &amp;&amp; x-&gt;callee()-&gt;is_static() &amp;&amp; Bytecodes::has_receiver(bc)) {
3604           // first argument is not profiled at call (method handle invoke)
3605           assert(x-&gt;method()-&gt;raw_code_at_bci(bci) == Bytecodes::_invokehandle, &quot;invokehandle expected&quot;);
3606           start = 1;
3607         }
3608         ciSignature* callee_signature = x-&gt;callee()-&gt;signature();
3609         // method handle call to virtual method
3610         bool has_receiver = x-&gt;callee()-&gt;is_loaded() &amp;&amp; !x-&gt;callee()-&gt;is_static() &amp;&amp; !Bytecodes::has_receiver(bc);
3611         ciSignatureStream callee_signature_stream(callee_signature, has_receiver ? x-&gt;callee()-&gt;holder() : NULL);
3612 
3613         bool ignored_will_link;
3614         ciSignature* signature_at_call = NULL;
3615         x-&gt;method()-&gt;get_method_at_bci(bci, ignored_will_link, &amp;signature_at_call);
3616         ciSignatureStream signature_at_call_stream(signature_at_call);
3617 
3618         // if called through method handle invoke, some arguments may have been popped
3619         for (int i = 0; i &lt; stop &amp;&amp; i+start &lt; x-&gt;nb_profiled_args(); i++) {
3620           int off = in_bytes(TypeEntriesAtCall::argument_type_offset(i)) - in_bytes(TypeEntriesAtCall::args_data_offset());
3621           ciKlass* exact = profile_type(md, base_offset, off,
3622               args-&gt;type(i), x-&gt;profiled_arg_at(i+start), mdp,
3623               !x-&gt;arg_needs_null_check(i+start),
3624               signature_at_call_stream.next_klass(), callee_signature_stream.next_klass());
3625           if (exact != NULL) {
3626             md-&gt;set_argument_type(bci, i, exact);
3627           }
3628         }
3629       } else {
3630 #ifdef ASSERT
3631         Bytecodes::Code code = x-&gt;method()-&gt;raw_code_at_bci(x-&gt;bci_of_invoke());
3632         int n = x-&gt;nb_profiled_args();
3633         assert(MethodData::profile_parameters() &amp;&amp; (MethodData::profile_arguments_jsr292_only() ||
3634             (x-&gt;inlined() &amp;&amp; ((code == Bytecodes::_invokedynamic &amp;&amp; n &lt;= 1) || (code == Bytecodes::_invokehandle &amp;&amp; n &lt;= 2)))),
3635             &quot;only at JSR292 bytecodes&quot;);
3636 #endif
3637       }
3638     }
3639   }
3640 }
3641 
3642 // profile parameters on entry to an inlined method
3643 void LIRGenerator::profile_parameters_at_call(ProfileCall* x) {
3644   if (compilation()-&gt;profile_parameters() &amp;&amp; x-&gt;inlined()) {
3645     ciMethodData* md = x-&gt;callee()-&gt;method_data_or_null();
3646     if (md != NULL) {
3647       ciParametersTypeData* parameters_type_data = md-&gt;parameters_type_data();
3648       if (parameters_type_data != NULL) {
3649         ciTypeStackSlotEntries* parameters =  parameters_type_data-&gt;parameters();
3650         LIR_Opr mdp = LIR_OprFact::illegalOpr;
3651         bool has_receiver = !x-&gt;callee()-&gt;is_static();
3652         ciSignature* sig = x-&gt;callee()-&gt;signature();
3653         ciSignatureStream sig_stream(sig, has_receiver ? x-&gt;callee()-&gt;holder() : NULL);
3654         int i = 0; // to iterate on the Instructions
3655         Value arg = x-&gt;recv();
3656         bool not_null = false;
3657         int bci = x-&gt;bci_of_invoke();
3658         Bytecodes::Code bc = x-&gt;method()-&gt;java_code_at_bci(bci);
3659         // The first parameter is the receiver so that&#39;s what we start
3660         // with if it exists. One exception is method handle call to
3661         // virtual method: the receiver is in the args list
3662         if (arg == NULL || !Bytecodes::has_receiver(bc)) {
3663           i = 1;
3664           arg = x-&gt;profiled_arg_at(0);
3665           not_null = !x-&gt;arg_needs_null_check(0);
3666         }
3667         int k = 0; // to iterate on the profile data
3668         for (;;) {
3669           intptr_t profiled_k = parameters-&gt;type(k);
3670           ciKlass* exact = profile_type(md, md-&gt;byte_offset_of_slot(parameters_type_data, ParametersTypeData::type_offset(0)),
3671                                         in_bytes(ParametersTypeData::type_offset(k)) - in_bytes(ParametersTypeData::type_offset(0)),
3672                                         profiled_k, arg, mdp, not_null, sig_stream.next_klass(), NULL);
3673           // If the profile is known statically set it once for all and do not emit any code
3674           if (exact != NULL) {
3675             md-&gt;set_parameter_type(k, exact);
3676           }
3677           k++;
3678           if (k &gt;= parameters_type_data-&gt;number_of_parameters()) {
3679 #ifdef ASSERT
3680             int extra = 0;
3681             if (MethodData::profile_arguments() &amp;&amp; TypeProfileParmsLimit != -1 &amp;&amp;
3682                 x-&gt;nb_profiled_args() &gt;= TypeProfileParmsLimit &amp;&amp;
3683                 x-&gt;recv() != NULL &amp;&amp; Bytecodes::has_receiver(bc)) {
3684               extra += 1;
3685             }
3686             assert(i == x-&gt;nb_profiled_args() - extra || (TypeProfileParmsLimit != -1 &amp;&amp; TypeProfileArgsLimit &gt; TypeProfileParmsLimit), &quot;unused parameters?&quot;);
3687 #endif
3688             break;
3689           }
3690           arg = x-&gt;profiled_arg_at(i);
3691           not_null = !x-&gt;arg_needs_null_check(i);
3692           i++;
3693         }
3694       }
3695     }
3696   }
3697 }
3698 
3699 void LIRGenerator::do_ProfileCall(ProfileCall* x) {
3700   // Need recv in a temporary register so it interferes with the other temporaries
3701   LIR_Opr recv = LIR_OprFact::illegalOpr;
3702   LIR_Opr mdo = new_register(T_METADATA);
3703   // tmp is used to hold the counters on SPARC
3704   LIR_Opr tmp = new_pointer_register();
3705 
3706   if (x-&gt;nb_profiled_args() &gt; 0) {
3707     profile_arguments(x);
3708   }
3709 
3710   // profile parameters on inlined method entry including receiver
3711   if (x-&gt;recv() != NULL || x-&gt;nb_profiled_args() &gt; 0) {
3712     profile_parameters_at_call(x);
3713   }
3714 
3715   if (x-&gt;recv() != NULL) {
3716     LIRItem value(x-&gt;recv(), this);
3717     value.load_item();
3718     recv = new_register(T_OBJECT);
3719     __ move(value.result(), recv);
3720   }
3721   __ profile_call(x-&gt;method(), x-&gt;bci_of_invoke(), x-&gt;callee(), mdo, recv, tmp, x-&gt;known_holder());
3722 }
3723 
3724 void LIRGenerator::do_ProfileReturnType(ProfileReturnType* x) {
3725   int bci = x-&gt;bci_of_invoke();
3726   ciMethodData* md = x-&gt;method()-&gt;method_data_or_null();
3727   assert(md != NULL, &quot;Sanity&quot;);
3728   ciProfileData* data = md-&gt;bci_to_data(bci);
3729   if (data != NULL) {
3730     assert(data-&gt;is_CallTypeData() || data-&gt;is_VirtualCallTypeData(), &quot;wrong profile data type&quot;);
3731     ciSingleTypeEntry* ret = data-&gt;is_CallTypeData() ? ((ciCallTypeData*)data)-&gt;ret() : ((ciVirtualCallTypeData*)data)-&gt;ret();
3732     LIR_Opr mdp = LIR_OprFact::illegalOpr;
3733 
3734     bool ignored_will_link;
3735     ciSignature* signature_at_call = NULL;
3736     x-&gt;method()-&gt;get_method_at_bci(bci, ignored_will_link, &amp;signature_at_call);
3737 
3738     // The offset within the MDO of the entry to update may be too large
3739     // to be used in load/store instructions on some platforms. So have
3740     // profile_type() compute the address of the profile in a register.
3741     ciKlass* exact = profile_type(md, md-&gt;byte_offset_of_slot(data, ret-&gt;type_offset()), 0,
3742         ret-&gt;type(), x-&gt;ret(), mdp,
3743         !x-&gt;needs_null_check(),
3744         signature_at_call-&gt;return_type()-&gt;as_klass(),
3745         x-&gt;callee()-&gt;signature()-&gt;return_type()-&gt;as_klass());
3746     if (exact != NULL) {
3747       md-&gt;set_return_type(bci, exact);
3748     }
3749   }
3750 }
3751 
3752 void LIRGenerator::do_ProfileInvoke(ProfileInvoke* x) {
3753   // We can safely ignore accessors here, since c2 will inline them anyway,
3754   // accessors are also always mature.
3755   if (!x-&gt;inlinee()-&gt;is_accessor()) {
3756     CodeEmitInfo* info = state_for(x, x-&gt;state(), true);
3757     // Notify the runtime very infrequently only to take care of counter overflows
3758     int freq_log = Tier23InlineeNotifyFreqLog;
3759     double scale;
3760     if (_method-&gt;has_option_value(&quot;CompileThresholdScaling&quot;, scale)) {
3761       freq_log = CompilerConfig::scaled_freq_log(freq_log, scale);
3762     }
3763     increment_event_counter_impl(info, x-&gt;inlinee(), LIR_OprFact::intConst(InvocationCounter::count_increment), right_n_bits(freq_log), InvocationEntryBci, false, true);
3764   }
3765 }
3766 
3767 void LIRGenerator::increment_backedge_counter_conditionally(LIR_Condition cond, LIR_Opr left, LIR_Opr right, CodeEmitInfo* info, int left_bci, int right_bci, int bci) {
3768   if (compilation()-&gt;count_backedges()) {
3769 #if defined(X86) &amp;&amp; !defined(_LP64)
3770     // BEWARE! On 32-bit x86 cmp clobbers its left argument so we need a temp copy.
3771     LIR_Opr left_copy = new_register(left-&gt;type());
3772     __ move(left, left_copy);
3773     __ cmp(cond, left_copy, right);
3774 #else
3775     __ cmp(cond, left, right);
3776 #endif
3777     LIR_Opr step = new_register(T_INT);
3778     LIR_Opr plus_one = LIR_OprFact::intConst(InvocationCounter::count_increment);
3779     LIR_Opr zero = LIR_OprFact::intConst(0);
3780     __ cmove(cond,
3781         (left_bci &lt; bci) ? plus_one : zero,
3782         (right_bci &lt; bci) ? plus_one : zero,
3783         step, left-&gt;type());
3784     increment_backedge_counter(info, step, bci);
3785   }
3786 }
3787 
3788 
3789 void LIRGenerator::increment_event_counter(CodeEmitInfo* info, LIR_Opr step, int bci, bool backedge) {
3790   int freq_log = 0;
3791   int level = compilation()-&gt;env()-&gt;comp_level();
3792   if (level == CompLevel_limited_profile) {
3793     freq_log = (backedge ? Tier2BackedgeNotifyFreqLog : Tier2InvokeNotifyFreqLog);
3794   } else if (level == CompLevel_full_profile) {
3795     freq_log = (backedge ? Tier3BackedgeNotifyFreqLog : Tier3InvokeNotifyFreqLog);
3796   } else {
3797     ShouldNotReachHere();
3798   }
3799   // Increment the appropriate invocation/backedge counter and notify the runtime.
3800   double scale;
3801   if (_method-&gt;has_option_value(&quot;CompileThresholdScaling&quot;, scale)) {
3802     freq_log = CompilerConfig::scaled_freq_log(freq_log, scale);
3803   }
3804   increment_event_counter_impl(info, info-&gt;scope()-&gt;method(), step, right_n_bits(freq_log), bci, backedge, true);
3805 }
3806 
3807 void LIRGenerator::decrement_age(CodeEmitInfo* info) {
3808   ciMethod* method = info-&gt;scope()-&gt;method();
3809   MethodCounters* mc_adr = method-&gt;ensure_method_counters();
3810   if (mc_adr != NULL) {
3811     LIR_Opr mc = new_pointer_register();
3812     __ move(LIR_OprFact::intptrConst(mc_adr), mc);
3813     int offset = in_bytes(MethodCounters::nmethod_age_offset());
3814     LIR_Address* counter = new LIR_Address(mc, offset, T_INT);
3815     LIR_Opr result = new_register(T_INT);
3816     __ load(counter, result);
3817     __ sub(result, LIR_OprFact::intConst(1), result);
3818     __ store(result, counter);
3819     // DeoptimizeStub will reexecute from the current state in code info.
3820     CodeStub* deopt = new DeoptimizeStub(info, Deoptimization::Reason_tenured,
3821                                          Deoptimization::Action_make_not_entrant);
3822     __ cmp(lir_cond_lessEqual, result, LIR_OprFact::intConst(0));
3823     __ branch(lir_cond_lessEqual, deopt);
3824   }
3825 }
3826 
3827 
3828 void LIRGenerator::increment_event_counter_impl(CodeEmitInfo* info,
3829                                                 ciMethod *method, LIR_Opr step, int frequency,
3830                                                 int bci, bool backedge, bool notify) {
3831   assert(frequency == 0 || is_power_of_2(frequency + 1), &quot;Frequency must be x^2 - 1 or 0&quot;);
3832   int level = _compilation-&gt;env()-&gt;comp_level();
3833   assert(level &gt; CompLevel_simple, &quot;Shouldn&#39;t be here&quot;);
3834 
3835   int offset = -1;
3836   LIR_Opr counter_holder = NULL;
3837   if (level == CompLevel_limited_profile) {
3838     MethodCounters* counters_adr = method-&gt;ensure_method_counters();
3839     if (counters_adr == NULL) {
3840       bailout(&quot;method counters allocation failed&quot;);
3841       return;
3842     }
3843     counter_holder = new_pointer_register();
3844     __ move(LIR_OprFact::intptrConst(counters_adr), counter_holder);
3845     offset = in_bytes(backedge ? MethodCounters::backedge_counter_offset() :
3846                                  MethodCounters::invocation_counter_offset());
3847   } else if (level == CompLevel_full_profile) {
3848     counter_holder = new_register(T_METADATA);
3849     offset = in_bytes(backedge ? MethodData::backedge_counter_offset() :
3850                                  MethodData::invocation_counter_offset());
3851     ciMethodData* md = method-&gt;method_data_or_null();
3852     assert(md != NULL, &quot;Sanity&quot;);
3853     __ metadata2reg(md-&gt;constant_encoding(), counter_holder);
3854   } else {
3855     ShouldNotReachHere();
3856   }
3857   LIR_Address* counter = new LIR_Address(counter_holder, offset, T_INT);
3858   LIR_Opr result = new_register(T_INT);
3859   __ load(counter, result);
3860   __ add(result, step, result);
3861   __ store(result, counter);
3862   if (notify &amp;&amp; (!backedge || UseOnStackReplacement)) {
3863     LIR_Opr meth = LIR_OprFact::metadataConst(method-&gt;constant_encoding());
3864     // The bci for info can point to cmp for if&#39;s we want the if bci
3865     CodeStub* overflow = new CounterOverflowStub(info, bci, meth);
3866     int freq = frequency &lt;&lt; InvocationCounter::count_shift;
3867     if (freq == 0) {
3868       if (!step-&gt;is_constant()) {
3869         __ cmp(lir_cond_notEqual, step, LIR_OprFact::intConst(0));
3870         __ branch(lir_cond_notEqual, overflow);
3871       } else {
3872         __ branch(lir_cond_always, overflow);
3873       }
3874     } else {
3875       LIR_Opr mask = load_immediate(freq, T_INT);
3876       if (!step-&gt;is_constant()) {
3877         // If step is 0, make sure the overflow check below always fails
3878         __ cmp(lir_cond_notEqual, step, LIR_OprFact::intConst(0));
3879         __ cmove(lir_cond_notEqual, result, LIR_OprFact::intConst(InvocationCounter::count_increment), result, T_INT);
3880       }
3881       __ logical_and(result, mask, result);
3882       __ cmp(lir_cond_equal, result, LIR_OprFact::intConst(0));
3883       __ branch(lir_cond_equal, overflow);
3884     }
3885     __ branch_destination(overflow-&gt;continuation());
3886   }
3887 }
3888 
3889 void LIRGenerator::do_RuntimeCall(RuntimeCall* x) {
3890   LIR_OprList* args = new LIR_OprList(x-&gt;number_of_arguments());
3891   BasicTypeList* signature = new BasicTypeList(x-&gt;number_of_arguments());
3892 
3893   if (x-&gt;pass_thread()) {
3894     signature-&gt;append(LP64_ONLY(T_LONG) NOT_LP64(T_INT));    // thread
3895     args-&gt;append(getThreadPointer());
3896   }
3897 
3898   for (int i = 0; i &lt; x-&gt;number_of_arguments(); i++) {
3899     Value a = x-&gt;argument_at(i);
3900     LIRItem* item = new LIRItem(a, this);
3901     item-&gt;load_item();
3902     args-&gt;append(item-&gt;result());
3903     signature-&gt;append(as_BasicType(a-&gt;type()));
3904   }
3905 
3906   LIR_Opr result = call_runtime(signature, args, x-&gt;entry(), x-&gt;type(), NULL);
3907   if (x-&gt;type() == voidType) {
3908     set_no_result(x);
3909   } else {
3910     __ move(result, rlock_result(x));
3911   }
3912 }
3913 
3914 #ifdef ASSERT
3915 void LIRGenerator::do_Assert(Assert *x) {
3916   ValueTag tag = x-&gt;x()-&gt;type()-&gt;tag();
3917   If::Condition cond = x-&gt;cond();
3918 
3919   LIRItem xitem(x-&gt;x(), this);
3920   LIRItem yitem(x-&gt;y(), this);
3921   LIRItem* xin = &amp;xitem;
3922   LIRItem* yin = &amp;yitem;
3923 
3924   assert(tag == intTag, &quot;Only integer assertions are valid!&quot;);
3925 
3926   xin-&gt;load_item();
3927   yin-&gt;dont_load_item();
3928 
3929   set_no_result(x);
3930 
3931   LIR_Opr left = xin-&gt;result();
3932   LIR_Opr right = yin-&gt;result();
3933 
3934   __ lir_assert(lir_cond(x-&gt;cond()), left, right, x-&gt;message(), true);
3935 }
3936 #endif
3937 
3938 void LIRGenerator::do_RangeCheckPredicate(RangeCheckPredicate *x) {
3939 
3940 
3941   Instruction *a = x-&gt;x();
3942   Instruction *b = x-&gt;y();
3943   if (!a || StressRangeCheckElimination) {
3944     assert(!b || StressRangeCheckElimination, &quot;B must also be null&quot;);
3945 
3946     CodeEmitInfo *info = state_for(x, x-&gt;state());
3947     CodeStub* stub = new PredicateFailedStub(info);
3948 
3949     __ jump(stub);
3950   } else if (a-&gt;type()-&gt;as_IntConstant() &amp;&amp; b-&gt;type()-&gt;as_IntConstant()) {
3951     int a_int = a-&gt;type()-&gt;as_IntConstant()-&gt;value();
3952     int b_int = b-&gt;type()-&gt;as_IntConstant()-&gt;value();
3953 
3954     bool ok = false;
3955 
3956     switch(x-&gt;cond()) {
3957       case Instruction::eql: ok = (a_int == b_int); break;
3958       case Instruction::neq: ok = (a_int != b_int); break;
3959       case Instruction::lss: ok = (a_int &lt; b_int); break;
3960       case Instruction::leq: ok = (a_int &lt;= b_int); break;
3961       case Instruction::gtr: ok = (a_int &gt; b_int); break;
3962       case Instruction::geq: ok = (a_int &gt;= b_int); break;
3963       case Instruction::aeq: ok = ((unsigned int)a_int &gt;= (unsigned int)b_int); break;
3964       case Instruction::beq: ok = ((unsigned int)a_int &lt;= (unsigned int)b_int); break;
3965       default: ShouldNotReachHere();
3966     }
3967 
3968     if (ok) {
3969 
3970       CodeEmitInfo *info = state_for(x, x-&gt;state());
3971       CodeStub* stub = new PredicateFailedStub(info);
3972 
3973       __ jump(stub);
3974     }
3975   } else {
3976 
3977     ValueTag tag = x-&gt;x()-&gt;type()-&gt;tag();
3978     If::Condition cond = x-&gt;cond();
3979     LIRItem xitem(x-&gt;x(), this);
3980     LIRItem yitem(x-&gt;y(), this);
3981     LIRItem* xin = &amp;xitem;
3982     LIRItem* yin = &amp;yitem;
3983 
3984     assert(tag == intTag, &quot;Only integer deoptimizations are valid!&quot;);
3985 
3986     xin-&gt;load_item();
3987     yin-&gt;dont_load_item();
3988     set_no_result(x);
3989 
3990     LIR_Opr left = xin-&gt;result();
3991     LIR_Opr right = yin-&gt;result();
3992 
3993     CodeEmitInfo *info = state_for(x, x-&gt;state());
3994     CodeStub* stub = new PredicateFailedStub(info);
3995 
3996     __ cmp(lir_cond(cond), left, right);
3997     __ branch(lir_cond(cond), stub);
3998   }
3999 }
4000 
4001 
4002 LIR_Opr LIRGenerator::call_runtime(Value arg1, address entry, ValueType* result_type, CodeEmitInfo* info) {
4003   LIRItemList args(1);
4004   LIRItem value(arg1, this);
4005   args.append(&amp;value);
4006   BasicTypeList signature;
4007   signature.append(as_BasicType(arg1-&gt;type()));
4008 
4009   return call_runtime(&amp;signature, &amp;args, entry, result_type, info);
4010 }
4011 
4012 
4013 LIR_Opr LIRGenerator::call_runtime(Value arg1, Value arg2, address entry, ValueType* result_type, CodeEmitInfo* info) {
4014   LIRItemList args(2);
4015   LIRItem value1(arg1, this);
4016   LIRItem value2(arg2, this);
4017   args.append(&amp;value1);
4018   args.append(&amp;value2);
4019   BasicTypeList signature;
4020   signature.append(as_BasicType(arg1-&gt;type()));
4021   signature.append(as_BasicType(arg2-&gt;type()));
4022 
4023   return call_runtime(&amp;signature, &amp;args, entry, result_type, info);
4024 }
4025 
4026 
4027 LIR_Opr LIRGenerator::call_runtime(BasicTypeArray* signature, LIR_OprList* args,
4028                                    address entry, ValueType* result_type, CodeEmitInfo* info) {
4029   // get a result register
4030   LIR_Opr phys_reg = LIR_OprFact::illegalOpr;
4031   LIR_Opr result = LIR_OprFact::illegalOpr;
4032   if (result_type-&gt;tag() != voidTag) {
4033     result = new_register(result_type);
4034     phys_reg = result_register_for(result_type);
4035   }
4036 
4037   // move the arguments into the correct location
4038   CallingConvention* cc = frame_map()-&gt;c_calling_convention(signature);
4039   assert(cc-&gt;length() == args-&gt;length(), &quot;argument mismatch&quot;);
4040   for (int i = 0; i &lt; args-&gt;length(); i++) {
4041     LIR_Opr arg = args-&gt;at(i);
4042     LIR_Opr loc = cc-&gt;at(i);
4043     if (loc-&gt;is_register()) {
4044       __ move(arg, loc);
4045     } else {
4046       LIR_Address* addr = loc-&gt;as_address_ptr();
4047 //           if (!can_store_as_constant(arg)) {
4048 //             LIR_Opr tmp = new_register(arg-&gt;type());
4049 //             __ move(arg, tmp);
4050 //             arg = tmp;
4051 //           }
4052       if (addr-&gt;type() == T_LONG || addr-&gt;type() == T_DOUBLE) {
4053         __ unaligned_move(arg, addr);
4054       } else {
4055         __ move(arg, addr);
4056       }
4057     }
4058   }
4059 
4060   if (info) {
4061     __ call_runtime(entry, getThreadTemp(), phys_reg, cc-&gt;args(), info);
4062   } else {
4063     __ call_runtime_leaf(entry, getThreadTemp(), phys_reg, cc-&gt;args());
4064   }
4065   if (result-&gt;is_valid()) {
4066     __ move(phys_reg, result);
4067   }
4068   return result;
4069 }
4070 
4071 
4072 LIR_Opr LIRGenerator::call_runtime(BasicTypeArray* signature, LIRItemList* args,
4073                                    address entry, ValueType* result_type, CodeEmitInfo* info) {
4074   // get a result register
4075   LIR_Opr phys_reg = LIR_OprFact::illegalOpr;
4076   LIR_Opr result = LIR_OprFact::illegalOpr;
4077   if (result_type-&gt;tag() != voidTag) {
4078     result = new_register(result_type);
4079     phys_reg = result_register_for(result_type);
4080   }
4081 
4082   // move the arguments into the correct location
4083   CallingConvention* cc = frame_map()-&gt;c_calling_convention(signature);
4084 
4085   assert(cc-&gt;length() == args-&gt;length(), &quot;argument mismatch&quot;);
4086   for (int i = 0; i &lt; args-&gt;length(); i++) {
4087     LIRItem* arg = args-&gt;at(i);
4088     LIR_Opr loc = cc-&gt;at(i);
4089     if (loc-&gt;is_register()) {
4090       arg-&gt;load_item_force(loc);
4091     } else {
4092       LIR_Address* addr = loc-&gt;as_address_ptr();
4093       arg-&gt;load_for_store(addr-&gt;type());
4094       if (addr-&gt;type() == T_LONG || addr-&gt;type() == T_DOUBLE) {
4095         __ unaligned_move(arg-&gt;result(), addr);
4096       } else {
4097         __ move(arg-&gt;result(), addr);
4098       }
4099     }
4100   }
4101 
4102   if (info) {
4103     __ call_runtime(entry, getThreadTemp(), phys_reg, cc-&gt;args(), info);
4104   } else {
4105     __ call_runtime_leaf(entry, getThreadTemp(), phys_reg, cc-&gt;args());
4106   }
4107   if (result-&gt;is_valid()) {
4108     __ move(phys_reg, result);
4109   }
4110   return result;
4111 }
4112 
4113 void LIRGenerator::do_MemBar(MemBar* x) {
4114   LIR_Code code = x-&gt;code();
4115   switch(code) {
4116   case lir_membar_acquire   : __ membar_acquire(); break;
4117   case lir_membar_release   : __ membar_release(); break;
4118   case lir_membar           : __ membar(); break;
4119   case lir_membar_loadload  : __ membar_loadload(); break;
4120   case lir_membar_storestore: __ membar_storestore(); break;
4121   case lir_membar_loadstore : __ membar_loadstore(); break;
4122   case lir_membar_storeload : __ membar_storeload(); break;
4123   default                   : ShouldNotReachHere(); break;
4124   }
4125 }
4126 
4127 LIR_Opr LIRGenerator::mask_boolean(LIR_Opr array, LIR_Opr value, CodeEmitInfo*&amp; null_check_info) {
4128   LIR_Opr value_fixed = rlock_byte(T_BYTE);
4129   if (TwoOperandLIRForm) {
4130     __ move(value, value_fixed);
4131     __ logical_and(value_fixed, LIR_OprFact::intConst(1), value_fixed);
4132   } else {
4133     __ logical_and(value, LIR_OprFact::intConst(1), value_fixed);
4134   }
4135   LIR_Opr klass = new_register(T_METADATA);
4136   __ move(new LIR_Address(array, oopDesc::klass_offset_in_bytes(), T_ADDRESS), klass, null_check_info);
4137   null_check_info = NULL;
4138   LIR_Opr layout = new_register(T_INT);
4139   __ move(new LIR_Address(klass, in_bytes(Klass::layout_helper_offset()), T_INT), layout);
4140   int diffbit = Klass::layout_helper_boolean_diffbit();
4141   __ logical_and(layout, LIR_OprFact::intConst(diffbit), layout);
4142   __ cmp(lir_cond_notEqual, layout, LIR_OprFact::intConst(0));
4143   __ cmove(lir_cond_notEqual, value_fixed, value, value_fixed, T_BYTE);
4144   value = value_fixed;
4145   return value;
4146 }
4147 
4148 LIR_Opr LIRGenerator::maybe_mask_boolean(StoreIndexed* x, LIR_Opr array, LIR_Opr value, CodeEmitInfo*&amp; null_check_info) {
4149   if (x-&gt;check_boolean()) {
4150     value = mask_boolean(array, value, null_check_info);
4151   }
4152   return value;
4153 }
    </pre>
  </body>
</html>