<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/prims/jni.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../opto/valuetypenode.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jniCheck.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/prims/jni.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 879 
 880   friend class SignatureIterator;  // so do_parameters_on can call do_type
 881   void do_type(BasicType type) {
 882     switch (type) {
 883     // these are coerced to int when using va_arg
 884     case T_BYTE:
 885     case T_CHAR:
 886     case T_SHORT:
 887     case T_INT:         push_int(va_arg(_ap, jint)); break;
 888     case T_BOOLEAN:     push_boolean((jboolean) va_arg(_ap, jint)); break;
 889 
 890     // each of these paths is exercised by the various jck Call[Static,Nonvirtual,][Void,Int,..]Method[A,V,] tests
 891 
 892     case T_LONG:        push_long(va_arg(_ap, jlong)); break;
 893     // float is coerced to double w/ va_arg
 894     case T_FLOAT:       push_float((jfloat) va_arg(_ap, jdouble)); break;
 895     case T_DOUBLE:      push_double(va_arg(_ap, jdouble)); break;
 896 
 897     case T_ARRAY:
 898     case T_OBJECT:
<span class="line-modified"> 899     case T_VALUETYPE:   push_object(va_arg(_ap, jobject)); break;</span>
 900     default:            ShouldNotReachHere();
 901     }
 902   }
 903 
 904  public:
 905   JNI_ArgumentPusherVaArg(jmethodID method_id, va_list rap)
 906       : JNI_ArgumentPusher(Method::resolve_jmethod_id(method_id)) {
 907     set_ap(rap);
 908   }
 909 
 910   virtual void push_arguments_on(JavaCallArguments* arguments) {
 911     _arguments = arguments;
 912     do_parameters_on(this);
 913   }
 914 };
 915 
 916 
 917 class JNI_ArgumentPusherArray : public JNI_ArgumentPusher {
 918  protected:
 919   const jvalue *_ap;
 920 
 921   inline void set_ap(const jvalue *rap) { _ap = rap; }
 922 
 923   friend class SignatureIterator;  // so do_parameters_on can call do_type
 924   void do_type(BasicType type) {
 925     switch (type) {
 926     case T_CHAR:        push_int((_ap++)-&gt;c); break;
 927     case T_SHORT:       push_int((_ap++)-&gt;s); break;
 928     case T_BYTE:        push_int((_ap++)-&gt;b); break;
 929     case T_INT:         push_int((_ap++)-&gt;i); break;
 930     case T_BOOLEAN:     push_boolean((_ap++)-&gt;z); break;
 931     case T_LONG:        push_long((_ap++)-&gt;j); break;
 932     case T_FLOAT:       push_float((_ap++)-&gt;f); break;
 933     case T_DOUBLE:      push_double((_ap++)-&gt;d); break;
 934     case T_ARRAY:
 935     case T_OBJECT:
<span class="line-modified"> 936     case T_VALUETYPE:   push_object((_ap++)-&gt;l); break;</span>
 937     default:            ShouldNotReachHere();
 938     }
 939   }
 940 
 941  public:
 942   JNI_ArgumentPusherArray(jmethodID method_id, const jvalue *rap)
 943       : JNI_ArgumentPusher(Method::resolve_jmethod_id(method_id)) {
 944     set_ap(rap);
 945   }
 946 
 947   virtual void push_arguments_on(JavaCallArguments* arguments) {
 948     _arguments = arguments;
 949     do_parameters_on(this);
 950   }
 951 };
 952 
 953 
 954 enum JNICallType {
 955   JNI_STATIC,
 956   JNI_VIRTUAL,
</pre>
<hr />
<pre>
1070 
1071   HOTSPOT_JNI_NEWOBJECTA_ENTRY(env, clazz, (uintptr_t) methodID);
1072 
1073   jobject obj = NULL;
1074   DT_RETURN_MARK(NewObjectA, jobject, (const jobject)obj);
1075 
1076   oop clazzoop = JNIHandles::resolve_non_null(clazz);
1077   Klass* k = java_lang_Class::as_Klass(clazzoop);
1078   if (k == NULL) {
1079     ResourceMark rm(THREAD);
1080     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
1081   }
1082 
1083   if (!k-&gt;is_inline_klass()) {
1084     instanceOop i = InstanceKlass::allocate_instance(clazzoop, CHECK_NULL);
1085     obj = JNIHandles::make_local(env, i);
1086     JavaValue jvalue(T_VOID);
1087     JNI_ArgumentPusherArray ap(methodID, args);
1088     jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
1089   } else {
<span class="line-modified">1090     JavaValue jvalue(T_VALUETYPE);</span>
1091     JNI_ArgumentPusherArray ap(methodID, args);
1092     jni_invoke_static(env, &amp;jvalue, NULL, JNI_STATIC, methodID, &amp;ap, CHECK_NULL);
1093     obj = jvalue.get_jobject();
1094   }
1095   return obj;
1096   JNI_END
1097 
1098 
1099 DT_RETURN_MARK_DECL(NewObjectV, jobject
1100                     , HOTSPOT_JNI_NEWOBJECTV_RETURN(_ret_ref));
1101 
1102 JNI_ENTRY(jobject, jni_NewObjectV(JNIEnv *env, jclass clazz, jmethodID methodID, va_list args))
1103   JNIWrapper(&quot;NewObjectV&quot;);
1104 
1105   HOTSPOT_JNI_NEWOBJECTV_ENTRY(env, clazz, (uintptr_t) methodID);
1106 
1107   jobject obj = NULL;
1108   DT_RETURN_MARK(NewObjectV, jobject, (const jobject&amp;)obj);
1109 
1110   oop clazzoop = JNIHandles::resolve_non_null(clazz);
1111   Klass* k = java_lang_Class::as_Klass(clazzoop);
1112   if (k == NULL) {
1113     ResourceMark rm(THREAD);
1114     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
1115   }
1116 
1117   if (!k-&gt;is_inline_klass()) {
1118     instanceOop i = InstanceKlass::allocate_instance(clazzoop, CHECK_NULL);
1119     obj = JNIHandles::make_local(env, i);
1120     JavaValue jvalue(T_VOID);
1121     JNI_ArgumentPusherVaArg ap(methodID, args);
1122     jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
1123   } else {
<span class="line-modified">1124     JavaValue jvalue(T_VALUETYPE);</span>
1125     JNI_ArgumentPusherVaArg ap(methodID, args);
1126     jni_invoke_static(env, &amp;jvalue, NULL, JNI_STATIC, methodID, &amp;ap, CHECK_NULL);
1127     obj = jvalue.get_jobject();
1128   }
1129   return obj;
1130 JNI_END
1131 
1132 
1133 DT_RETURN_MARK_DECL(NewObject, jobject
1134                     , HOTSPOT_JNI_NEWOBJECT_RETURN(_ret_ref));
1135 
1136 JNI_ENTRY(jobject, jni_NewObject(JNIEnv *env, jclass clazz, jmethodID methodID, ...))
1137   JNIWrapper(&quot;NewObject&quot;);
1138 
1139   HOTSPOT_JNI_NEWOBJECT_ENTRY(env, clazz, (uintptr_t) methodID);
1140 
1141   jobject obj = NULL;
1142   DT_RETURN_MARK(NewObject, jobject, (const jobject&amp;)obj);
1143 
1144   oop clazzoop = JNIHandles::resolve_non_null(clazz);
1145   Klass* k = java_lang_Class::as_Klass(clazzoop);
1146   if (k == NULL) {
1147     ResourceMark rm(THREAD);
1148     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
1149   }
1150 
1151   if (!k-&gt;is_inline_klass()) {
1152     instanceOop i = InstanceKlass::allocate_instance(clazzoop, CHECK_NULL);
1153     obj = JNIHandles::make_local(env, i);
1154     va_list args;
1155     va_start(args, methodID);
1156     JavaValue jvalue(T_VOID);
1157     JNI_ArgumentPusherVaArg ap(methodID, args);
1158     jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
1159     va_end(args);
1160   } else {
1161     va_list args;
1162     va_start(args, methodID);
<span class="line-modified">1163     JavaValue jvalue(T_VALUETYPE);</span>
1164     JNI_ArgumentPusherVaArg ap(methodID, args);
1165     jni_invoke_static(env, &amp;jvalue, NULL, JNI_STATIC, methodID, &amp;ap, CHECK_NULL);
1166     va_end(args);
1167     obj = jvalue.get_jobject();
1168   }
1169   return obj;
1170 JNI_END
1171 
1172 
1173 JNI_ENTRY(jclass, jni_GetObjectClass(JNIEnv *env, jobject obj))
1174   JNIWrapper(&quot;GetObjectClass&quot;);
1175 
1176   HOTSPOT_JNI_GETOBJECTCLASS_ENTRY(env, obj);
1177 
1178   Klass* k = JNIHandles::resolve_non_null(obj)-&gt;klass();
1179   jclass ret =
1180     (jclass) JNIHandles::make_local(env, k-&gt;java_mirror());
1181 
1182   HOTSPOT_JNI_GETOBJECTCLASS_RETURN(ret);
1183   return ret;
</pre>
</td>
<td>
<hr />
<pre>
 879 
 880   friend class SignatureIterator;  // so do_parameters_on can call do_type
 881   void do_type(BasicType type) {
 882     switch (type) {
 883     // these are coerced to int when using va_arg
 884     case T_BYTE:
 885     case T_CHAR:
 886     case T_SHORT:
 887     case T_INT:         push_int(va_arg(_ap, jint)); break;
 888     case T_BOOLEAN:     push_boolean((jboolean) va_arg(_ap, jint)); break;
 889 
 890     // each of these paths is exercised by the various jck Call[Static,Nonvirtual,][Void,Int,..]Method[A,V,] tests
 891 
 892     case T_LONG:        push_long(va_arg(_ap, jlong)); break;
 893     // float is coerced to double w/ va_arg
 894     case T_FLOAT:       push_float((jfloat) va_arg(_ap, jdouble)); break;
 895     case T_DOUBLE:      push_double(va_arg(_ap, jdouble)); break;
 896 
 897     case T_ARRAY:
 898     case T_OBJECT:
<span class="line-modified"> 899     case T_INLINE_TYPE: push_object(va_arg(_ap, jobject)); break;</span>
 900     default:            ShouldNotReachHere();
 901     }
 902   }
 903 
 904  public:
 905   JNI_ArgumentPusherVaArg(jmethodID method_id, va_list rap)
 906       : JNI_ArgumentPusher(Method::resolve_jmethod_id(method_id)) {
 907     set_ap(rap);
 908   }
 909 
 910   virtual void push_arguments_on(JavaCallArguments* arguments) {
 911     _arguments = arguments;
 912     do_parameters_on(this);
 913   }
 914 };
 915 
 916 
 917 class JNI_ArgumentPusherArray : public JNI_ArgumentPusher {
 918  protected:
 919   const jvalue *_ap;
 920 
 921   inline void set_ap(const jvalue *rap) { _ap = rap; }
 922 
 923   friend class SignatureIterator;  // so do_parameters_on can call do_type
 924   void do_type(BasicType type) {
 925     switch (type) {
 926     case T_CHAR:        push_int((_ap++)-&gt;c); break;
 927     case T_SHORT:       push_int((_ap++)-&gt;s); break;
 928     case T_BYTE:        push_int((_ap++)-&gt;b); break;
 929     case T_INT:         push_int((_ap++)-&gt;i); break;
 930     case T_BOOLEAN:     push_boolean((_ap++)-&gt;z); break;
 931     case T_LONG:        push_long((_ap++)-&gt;j); break;
 932     case T_FLOAT:       push_float((_ap++)-&gt;f); break;
 933     case T_DOUBLE:      push_double((_ap++)-&gt;d); break;
 934     case T_ARRAY:
 935     case T_OBJECT:
<span class="line-modified"> 936     case T_INLINE_TYPE: push_object((_ap++)-&gt;l); break;</span>
 937     default:            ShouldNotReachHere();
 938     }
 939   }
 940 
 941  public:
 942   JNI_ArgumentPusherArray(jmethodID method_id, const jvalue *rap)
 943       : JNI_ArgumentPusher(Method::resolve_jmethod_id(method_id)) {
 944     set_ap(rap);
 945   }
 946 
 947   virtual void push_arguments_on(JavaCallArguments* arguments) {
 948     _arguments = arguments;
 949     do_parameters_on(this);
 950   }
 951 };
 952 
 953 
 954 enum JNICallType {
 955   JNI_STATIC,
 956   JNI_VIRTUAL,
</pre>
<hr />
<pre>
1070 
1071   HOTSPOT_JNI_NEWOBJECTA_ENTRY(env, clazz, (uintptr_t) methodID);
1072 
1073   jobject obj = NULL;
1074   DT_RETURN_MARK(NewObjectA, jobject, (const jobject)obj);
1075 
1076   oop clazzoop = JNIHandles::resolve_non_null(clazz);
1077   Klass* k = java_lang_Class::as_Klass(clazzoop);
1078   if (k == NULL) {
1079     ResourceMark rm(THREAD);
1080     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
1081   }
1082 
1083   if (!k-&gt;is_inline_klass()) {
1084     instanceOop i = InstanceKlass::allocate_instance(clazzoop, CHECK_NULL);
1085     obj = JNIHandles::make_local(env, i);
1086     JavaValue jvalue(T_VOID);
1087     JNI_ArgumentPusherArray ap(methodID, args);
1088     jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
1089   } else {
<span class="line-modified">1090     JavaValue jvalue(T_INLINE_TYPE);</span>
1091     JNI_ArgumentPusherArray ap(methodID, args);
1092     jni_invoke_static(env, &amp;jvalue, NULL, JNI_STATIC, methodID, &amp;ap, CHECK_NULL);
1093     obj = jvalue.get_jobject();
1094   }
1095   return obj;
1096   JNI_END
1097 
1098 
1099 DT_RETURN_MARK_DECL(NewObjectV, jobject
1100                     , HOTSPOT_JNI_NEWOBJECTV_RETURN(_ret_ref));
1101 
1102 JNI_ENTRY(jobject, jni_NewObjectV(JNIEnv *env, jclass clazz, jmethodID methodID, va_list args))
1103   JNIWrapper(&quot;NewObjectV&quot;);
1104 
1105   HOTSPOT_JNI_NEWOBJECTV_ENTRY(env, clazz, (uintptr_t) methodID);
1106 
1107   jobject obj = NULL;
1108   DT_RETURN_MARK(NewObjectV, jobject, (const jobject&amp;)obj);
1109 
1110   oop clazzoop = JNIHandles::resolve_non_null(clazz);
1111   Klass* k = java_lang_Class::as_Klass(clazzoop);
1112   if (k == NULL) {
1113     ResourceMark rm(THREAD);
1114     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
1115   }
1116 
1117   if (!k-&gt;is_inline_klass()) {
1118     instanceOop i = InstanceKlass::allocate_instance(clazzoop, CHECK_NULL);
1119     obj = JNIHandles::make_local(env, i);
1120     JavaValue jvalue(T_VOID);
1121     JNI_ArgumentPusherVaArg ap(methodID, args);
1122     jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
1123   } else {
<span class="line-modified">1124     JavaValue jvalue(T_INLINE_TYPE);</span>
1125     JNI_ArgumentPusherVaArg ap(methodID, args);
1126     jni_invoke_static(env, &amp;jvalue, NULL, JNI_STATIC, methodID, &amp;ap, CHECK_NULL);
1127     obj = jvalue.get_jobject();
1128   }
1129   return obj;
1130 JNI_END
1131 
1132 
1133 DT_RETURN_MARK_DECL(NewObject, jobject
1134                     , HOTSPOT_JNI_NEWOBJECT_RETURN(_ret_ref));
1135 
1136 JNI_ENTRY(jobject, jni_NewObject(JNIEnv *env, jclass clazz, jmethodID methodID, ...))
1137   JNIWrapper(&quot;NewObject&quot;);
1138 
1139   HOTSPOT_JNI_NEWOBJECT_ENTRY(env, clazz, (uintptr_t) methodID);
1140 
1141   jobject obj = NULL;
1142   DT_RETURN_MARK(NewObject, jobject, (const jobject&amp;)obj);
1143 
1144   oop clazzoop = JNIHandles::resolve_non_null(clazz);
1145   Klass* k = java_lang_Class::as_Klass(clazzoop);
1146   if (k == NULL) {
1147     ResourceMark rm(THREAD);
1148     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
1149   }
1150 
1151   if (!k-&gt;is_inline_klass()) {
1152     instanceOop i = InstanceKlass::allocate_instance(clazzoop, CHECK_NULL);
1153     obj = JNIHandles::make_local(env, i);
1154     va_list args;
1155     va_start(args, methodID);
1156     JavaValue jvalue(T_VOID);
1157     JNI_ArgumentPusherVaArg ap(methodID, args);
1158     jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
1159     va_end(args);
1160   } else {
1161     va_list args;
1162     va_start(args, methodID);
<span class="line-modified">1163     JavaValue jvalue(T_INLINE_TYPE);</span>
1164     JNI_ArgumentPusherVaArg ap(methodID, args);
1165     jni_invoke_static(env, &amp;jvalue, NULL, JNI_STATIC, methodID, &amp;ap, CHECK_NULL);
1166     va_end(args);
1167     obj = jvalue.get_jobject();
1168   }
1169   return obj;
1170 JNI_END
1171 
1172 
1173 JNI_ENTRY(jclass, jni_GetObjectClass(JNIEnv *env, jobject obj))
1174   JNIWrapper(&quot;GetObjectClass&quot;);
1175 
1176   HOTSPOT_JNI_GETOBJECTCLASS_ENTRY(env, obj);
1177 
1178   Klass* k = JNIHandles::resolve_non_null(obj)-&gt;klass();
1179   jclass ret =
1180     (jclass) JNIHandles::make_local(env, k-&gt;java_mirror());
1181 
1182   HOTSPOT_JNI_GETOBJECTCLASS_RETURN(ret);
1183   return ret;
</pre>
</td>
</tr>
</table>
<center><a href="../opto/valuetypenode.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jniCheck.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>