<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/compiler/valhalla/valuetypes/TestLWorld.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../src/hotspot/share/opto/valuetypenode.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="ValueTypeTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/compiler/valhalla/valuetypes/TestLWorld.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -2405,11 +2405,11 @@</span>
              field = 0x42;
          }
      }
  
      @Warmup(10000)
<span class="udiff-line-modified-removed">-     @Test(match = { CLASS_CHECK_TRAP }, matchCount = { 2 }, failOn = LOAD_UNKNOWN_VALUE + ALLOC_G)</span>
<span class="udiff-line-modified-added">+     @Test(match = { CLASS_CHECK_TRAP }, matchCount = { 2 }, failOn = LOAD_UNKNOWN_VALUE + ALLOC_G + MEMBAR)</span>
      public Object test92(Object[] array) {
          // Dummy loops to ensure we run enough passes of split if
          for (int i = 0; i &lt; 2; i++) {
              for (int j = 0; j &lt; 2; j++) {
                for (int k = 0; k &lt; 2; k++) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2469,11 +2469,11 @@</span>
              }
          }
      }
  
      @Warmup(10000)
<span class="udiff-line-modified-removed">-     @Test(match = { CLASS_CHECK_TRAP, LOOP }, matchCount = { 2, 1 }, failOn = LOAD_UNKNOWN_VALUE + ALLOC_G)</span>
<span class="udiff-line-modified-added">+     @Test(match = { CLASS_CHECK_TRAP, LOOP }, matchCount = { 2, 1 }, failOn = LOAD_UNKNOWN_VALUE + ALLOC_G + MEMBAR)</span>
      public int test94(Object[] array) {
          int res = 0;
          for (int i = 1; i &lt; 4; i *= 2) {
              Object v = array[i];
              res += (Integer)v;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2738,11 +2738,11 @@</span>
      class MyObject4 extends NoValueImplementors1 {
  
      }
  
      // Loading from an abstract class array does not require a flatness check if the abstract class has a non-static field
<span class="udiff-line-modified-removed">-     @Test(failOn = ALLOC_G + ALLOCA_G + LOAD_UNKNOWN_VALUE + STORE_UNKNOWN_VALUE + VALUE_ARRAY_NULL_GUARD)</span>
<span class="udiff-line-modified-added">+     @Test(failOn = ALLOC_G + MEMBAR + ALLOCA_G + LOAD_UNKNOWN_VALUE + STORE_UNKNOWN_VALUE + VALUE_ARRAY_NULL_GUARD)</span>
      public NoValueImplementors1 test103(NoValueImplementors1[] array, int i) {
          return array[i];
      }
  
      @DontCompile
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2803,11 +2803,11 @@</span>
      class MyObject5 extends NoValueImplementors2 {
  
      }
  
      // Loading from an abstract class array does not require a flatness check if the abstract class has no value implementor
<span class="udiff-line-modified-removed">-     @Test(failOn = ALLOC_G + ALLOCA_G + LOAD_UNKNOWN_VALUE + STORE_UNKNOWN_VALUE + VALUE_ARRAY_NULL_GUARD)</span>
<span class="udiff-line-modified-added">+     @Test(failOn = ALLOC_G + MEMBAR + ALLOCA_G + LOAD_UNKNOWN_VALUE + STORE_UNKNOWN_VALUE + VALUE_ARRAY_NULL_GUARD)</span>
      public NoValueImplementors2 test105(NoValueImplementors2[] array, int i) {
          return array[i];
      }
  
      @DontCompile
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2902,6 +2902,175 @@</span>
                                          for (int i = 0; i &lt; dst1.length; i++) {
                                              Asserts.assertEquals(dst1[i], testValue2);
                                              Asserts.assertEquals(dst2[i], o1);
                                          } });
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Escape analysis tests</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static interface WrapperInterface {</span>
<span class="udiff-line-added">+         long value();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static inline class LongWrapper implements WrapperInterface {</span>
<span class="udiff-line-added">+         final static LongWrapper ZERO = new LongWrapper(0);</span>
<span class="udiff-line-added">+         long val;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         LongWrapper(long val) {</span>
<span class="udiff-line-added">+             this.val = val;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         static LongWrapper wrap(long val) {</span>
<span class="udiff-line-added">+             return (val == 0L) ? LongWrapper.ZERO : new LongWrapper(val);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public long value() {</span>
<span class="udiff-line-added">+             return val;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static class InterfaceBox {</span>
<span class="udiff-line-added">+         WrapperInterface content;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         InterfaceBox(long val) {</span>
<span class="udiff-line-added">+             this.content = LongWrapper.wrap(val);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         static InterfaceBox box(long val) {</span>
<span class="udiff-line-added">+             return new InterfaceBox(val);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static class ObjectBox {</span>
<span class="udiff-line-added">+         Object content;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         ObjectBox(long val) {</span>
<span class="udiff-line-added">+             this.content = LongWrapper.wrap(val);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         static ObjectBox box(long val) {</span>
<span class="udiff-line-added">+             return new ObjectBox(val);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static class RefBox {</span>
<span class="udiff-line-added">+         LongWrapper.ref content;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         RefBox(long val) {</span>
<span class="udiff-line-added">+             this.content = LongWrapper.wrap(val);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         static RefBox box(long val) {</span>
<span class="udiff-line-added">+             return new RefBox(val);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static class InlineBox {</span>
<span class="udiff-line-added">+         LongWrapper content;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         InlineBox(long val) {</span>
<span class="udiff-line-added">+             this.content = LongWrapper.wrap(val);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         static InlineBox box(long val) {</span>
<span class="udiff-line-added">+             return new InlineBox(val);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static class GenericBox&lt;T&gt; {</span>
<span class="udiff-line-added">+         T content;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         static GenericBox&lt;LongWrapper.ref&gt; box(long val) {</span>
<span class="udiff-line-added">+             GenericBox&lt;LongWrapper.ref&gt; res = new GenericBox&lt;&gt;();</span>
<span class="udiff-line-added">+             res.content = LongWrapper.wrap(val);</span>
<span class="udiff-line-added">+             return res;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     long[] lArr = {0L, rL, 0L, rL, 0L, rL, 0L, rL, 0L, rL};</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Test removal of allocations when inline type instance is wrapped into box object</span>
<span class="udiff-line-added">+     @Warmup(10000) // Make sure value() call on WrapperInterface is inlined</span>
<span class="udiff-line-added">+     @Test(failOn = ALLOC_G + MEMBAR, match = { PREDICATE_TRAP }, matchCount = { 1 })</span>
<span class="udiff-line-added">+     public long test109() {</span>
<span class="udiff-line-added">+         long res = 0;</span>
<span class="udiff-line-added">+         for (int i = 0 ; i &lt; lArr.length; i++) {</span>
<span class="udiff-line-added">+             res += InterfaceBox.box(lArr[i]).content.value();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return res;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @DontCompile</span>
<span class="udiff-line-added">+     public void test109_verifier(boolean warmup) {</span>
<span class="udiff-line-added">+         long res = test109();</span>
<span class="udiff-line-added">+         Asserts.assertEquals(res, 5*rL);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Same as test109 but with ObjectBox</span>
<span class="udiff-line-added">+     @Test(failOn = ALLOC_G + MEMBAR, match = { PREDICATE_TRAP }, matchCount = { 1 })</span>
<span class="udiff-line-added">+     @Warmup(10000) // Make sure value() call on WrapperInterface is inlined</span>
<span class="udiff-line-added">+     public long test110(long[] arr) {</span>
<span class="udiff-line-added">+         long res = 0;</span>
<span class="udiff-line-added">+         for (int i = 0 ; i &lt; arr.length; i++) {</span>
<span class="udiff-line-added">+             res += ((WrapperInterface)ObjectBox.box(lArr[i]).content).value();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return res;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @DontCompile</span>
<span class="udiff-line-added">+     public void test110_verifier(boolean warmup) {</span>
<span class="udiff-line-added">+         long[] arr = {0L, rL, 0L, rL, 0L};</span>
<span class="udiff-line-added">+         long res = test110(arr);</span>
<span class="udiff-line-added">+         Asserts.assertEquals(res, 2*rL);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Same as test109 but with RefBox</span>
<span class="udiff-line-added">+     @Test(failOn = ALLOC_G + MEMBAR, match = { PREDICATE_TRAP }, matchCount = { 1 })</span>
<span class="udiff-line-added">+     public long test111(long[] arr) {</span>
<span class="udiff-line-added">+         long res = 0;</span>
<span class="udiff-line-added">+         for (int i = 0 ; i &lt; arr.length; i++) {</span>
<span class="udiff-line-added">+             res += RefBox.box(lArr[i]).content.value();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return res;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @DontCompile</span>
<span class="udiff-line-added">+     public void test111_verifier(boolean warmup) {</span>
<span class="udiff-line-added">+         long[] arr = {0L, rL, 0L, rL, 0L};</span>
<span class="udiff-line-added">+         long res = test111(arr);</span>
<span class="udiff-line-added">+         Asserts.assertEquals(res, 2*rL);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Same as test109 but with InlineBox</span>
<span class="udiff-line-added">+     @Test(failOn = ALLOC_G + MEMBAR, match = { PREDICATE_TRAP }, matchCount = { 1 })</span>
<span class="udiff-line-added">+     public long test112(long[] arr) {</span>
<span class="udiff-line-added">+         long res = 0;</span>
<span class="udiff-line-added">+         for (int i = 0 ; i &lt; arr.length; i++) {</span>
<span class="udiff-line-added">+             res += InlineBox.box(lArr[i]).content.value();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return res;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @DontCompile</span>
<span class="udiff-line-added">+     public void test112_verifier(boolean warmup) {</span>
<span class="udiff-line-added">+         long[] arr = {0L, rL, 0L, rL, 0L};</span>
<span class="udiff-line-added">+         long res = test112(arr);</span>
<span class="udiff-line-added">+         Asserts.assertEquals(res, 2*rL);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Same as test109 but with GenericBox</span>
<span class="udiff-line-added">+     @Test(failOn = ALLOC_G + MEMBAR, match = { PREDICATE_TRAP }, matchCount = { 1 })</span>
<span class="udiff-line-added">+     public long test113(long[] arr) {</span>
<span class="udiff-line-added">+         long res = 0;</span>
<span class="udiff-line-added">+         for (int i = 0 ; i &lt; arr.length; i++) {</span>
<span class="udiff-line-added">+             res += GenericBox.box(lArr[i]).content.value();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return res;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @DontCompile</span>
<span class="udiff-line-added">+     public void test113_verifier(boolean warmup) {</span>
<span class="udiff-line-added">+         long[] arr = {0L, rL, 0L, rL, 0L};</span>
<span class="udiff-line-added">+         long res = test113(arr);</span>
<span class="udiff-line-added">+         Asserts.assertEquals(res, 2*rL);</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="../../../../../../src/hotspot/share/opto/valuetypenode.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="ValueTypeTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>