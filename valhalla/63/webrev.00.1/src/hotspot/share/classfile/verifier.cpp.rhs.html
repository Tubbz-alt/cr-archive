<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/classfile/verifier.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1998, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classFileStream.hpp&quot;
  28 #include &quot;classfile/classLoader.hpp&quot;
  29 #include &quot;classfile/javaClasses.hpp&quot;
  30 #include &quot;classfile/stackMapTable.hpp&quot;
  31 #include &quot;classfile/stackMapFrame.hpp&quot;
  32 #include &quot;classfile/stackMapTableFormat.hpp&quot;
  33 #include &quot;classfile/symbolTable.hpp&quot;
  34 #include &quot;classfile/systemDictionary.hpp&quot;
  35 #include &quot;classfile/verifier.hpp&quot;
  36 #include &quot;classfile/vmSymbols.hpp&quot;
  37 #include &quot;interpreter/bytecodes.hpp&quot;
  38 #include &quot;interpreter/bytecodeStream.hpp&quot;
  39 #include &quot;logging/log.hpp&quot;
  40 #include &quot;logging/logStream.hpp&quot;
  41 #include &quot;memory/oopFactory.hpp&quot;
  42 #include &quot;memory/resourceArea.hpp&quot;
  43 #include &quot;memory/universe.hpp&quot;
  44 #include &quot;oops/constantPool.inline.hpp&quot;
  45 #include &quot;oops/instanceKlass.hpp&quot;
  46 #include &quot;oops/oop.inline.hpp&quot;
  47 #include &quot;oops/typeArrayOop.hpp&quot;
  48 #include &quot;runtime/fieldDescriptor.hpp&quot;
  49 #include &quot;runtime/handles.inline.hpp&quot;
  50 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  51 #include &quot;runtime/javaCalls.hpp&quot;
  52 #include &quot;runtime/jniHandles.inline.hpp&quot;
  53 #include &quot;runtime/os.hpp&quot;
  54 #include &quot;runtime/safepointVerifiers.hpp&quot;
  55 #include &quot;runtime/thread.hpp&quot;
  56 #include &quot;services/threadService.hpp&quot;
  57 #include &quot;utilities/align.hpp&quot;
  58 #include &quot;utilities/bytes.hpp&quot;
  59 
  60 #define NOFAILOVER_MAJOR_VERSION                       51
  61 #define NONZERO_PADDING_BYTES_IN_SWITCH_MAJOR_VERSION  51
  62 #define STATIC_METHOD_IN_INTERFACE_MAJOR_VERSION       52
<a name="1" id="anc1"></a><span class="line-added">  63 #define VALUETYPE_MAJOR_VERSION                        56</span>
  64 #define MAX_ARRAY_DIMENSIONS 255
  65 
  66 // Access to external entry for VerifyClassForMajorVersion - old byte code verifier
  67 
  68 extern &quot;C&quot; {
  69   typedef jboolean (*verify_byte_codes_fn_t)(JNIEnv *, jclass, char *, jint, jint);
  70 }
  71 
  72 static verify_byte_codes_fn_t volatile _verify_byte_codes_fn = NULL;
  73 
  74 static verify_byte_codes_fn_t verify_byte_codes_fn() {
  75 
  76   if (_verify_byte_codes_fn != NULL)
  77     return _verify_byte_codes_fn;
  78 
  79   MutexLocker locker(Verify_lock);
  80 
  81   if (_verify_byte_codes_fn != NULL)
  82     return _verify_byte_codes_fn;
  83 
  84   // Load verify dll
  85   char buffer[JVM_MAXPATHLEN];
  86   char ebuf[1024];
  87   if (!os::dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(), &quot;verify&quot;))
  88     return NULL; // Caller will throw VerifyError
  89 
  90   void *lib_handle = os::dll_load(buffer, ebuf, sizeof(ebuf));
  91   if (lib_handle == NULL)
  92     return NULL; // Caller will throw VerifyError
  93 
  94   void *fn = os::dll_lookup(lib_handle, &quot;VerifyClassForMajorVersion&quot;);
  95   if (fn == NULL)
  96     return NULL; // Caller will throw VerifyError
  97 
  98   return _verify_byte_codes_fn = CAST_TO_FN_PTR(verify_byte_codes_fn_t, fn);
  99 }
 100 
 101 
 102 // Methods in Verifier
 103 
 104 bool Verifier::should_verify_for(oop class_loader, bool should_verify_class) {
 105   return (class_loader == NULL || !should_verify_class) ?
 106     BytecodeVerificationLocal : BytecodeVerificationRemote;
 107 }
 108 
 109 bool Verifier::relax_access_for(oop loader) {
 110   bool trusted = java_lang_ClassLoader::is_trusted_loader(loader);
 111   bool need_verify =
 112     // verifyAll
 113     (BytecodeVerificationLocal &amp;&amp; BytecodeVerificationRemote) ||
 114     // verifyRemote
 115     (!BytecodeVerificationLocal &amp;&amp; BytecodeVerificationRemote &amp;&amp; !trusted);
 116   return !need_verify;
 117 }
 118 
 119 void Verifier::trace_class_resolution(Klass* resolve_class, InstanceKlass* verify_class) {
 120   assert(verify_class != NULL, &quot;Unexpected null verify_class&quot;);
 121   ResourceMark rm;
 122   Symbol* s = verify_class-&gt;source_file_name();
 123   const char* source_file = (s != NULL ? s-&gt;as_C_string() : NULL);
 124   const char* verify = verify_class-&gt;external_name();
 125   const char* resolve = resolve_class-&gt;external_name();
 126   // print in a single call to reduce interleaving between threads
 127   if (source_file != NULL) {
 128     log_debug(class, resolve)(&quot;%s %s %s (verification)&quot;, verify, resolve, source_file);
 129   } else {
 130     log_debug(class, resolve)(&quot;%s %s (verification)&quot;, verify, resolve);
 131   }
 132 }
 133 
 134 // Prints the end-verification message to the appropriate output.
 135 void Verifier::log_end_verification(outputStream* st, const char* klassName, Symbol* exception_name, TRAPS) {
 136   if (HAS_PENDING_EXCEPTION) {
 137     st-&gt;print(&quot;Verification for %s has&quot;, klassName);
 138     st-&gt;print_cr(&quot; exception pending %s &quot;,
 139                  PENDING_EXCEPTION-&gt;klass()-&gt;external_name());
 140   } else if (exception_name != NULL) {
 141     st-&gt;print_cr(&quot;Verification for %s failed&quot;, klassName);
 142   }
 143   st-&gt;print_cr(&quot;End class verification for: %s&quot;, klassName);
 144 }
 145 
 146 bool Verifier::verify(InstanceKlass* klass, bool should_verify_class, TRAPS) {
 147   HandleMark hm(THREAD);
 148   ResourceMark rm(THREAD);
 149 
 150   // Eagerly allocate the identity hash code for a klass. This is a fallout
 151   // from 6320749 and 8059924: hash code generator is not supposed to be called
 152   // during the safepoint, but it allows to sneak the hashcode in during
 153   // verification. Without this eager hashcode generation, we may end up
 154   // installing the hashcode during some other operation, which may be at
 155   // safepoint -- blowing up the checks. It was previously done as the side
 156   // effect (sic!) for external_name(), but instead of doing that, we opt to
 157   // explicitly push the hashcode in here. This is signify the following block
 158   // is IMPORTANT:
 159   if (klass-&gt;java_mirror() != NULL) {
 160     klass-&gt;java_mirror()-&gt;identity_hash();
 161   }
 162 
 163   if (!is_eligible_for_verification(klass, should_verify_class)) {
 164     return true;
 165   }
 166 
 167   // Timer includes any side effects of class verification (resolution,
 168   // etc), but not recursive calls to Verifier::verify().
 169   JavaThread* jt = (JavaThread*)THREAD;
 170   PerfClassTraceTime timer(ClassLoader::perf_class_verify_time(),
 171                            ClassLoader::perf_class_verify_selftime(),
 172                            ClassLoader::perf_classes_verified(),
 173                            jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
 174                            jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
 175                            PerfClassTraceTime::CLASS_VERIFY);
 176 
 177   // If the class should be verified, first see if we can use the split
 178   // verifier.  If not, or if verification fails and can failover, then
 179   // call the inference verifier.
 180   Symbol* exception_name = NULL;
 181   const size_t message_buffer_len = klass-&gt;name()-&gt;utf8_length() + 1024;
 182   char* message_buffer = NULL;
 183   char* exception_message = NULL;
 184 
 185   log_info(class, init)(&quot;Start class verification for: %s&quot;, klass-&gt;external_name());
 186   if (klass-&gt;major_version() &gt;= STACKMAP_ATTRIBUTE_MAJOR_VERSION) {
 187     ClassVerifier split_verifier(klass, THREAD);
 188     split_verifier.verify_class(THREAD);
 189     exception_name = split_verifier.result();
 190 
 191     // If DumpSharedSpaces is set then don&#39;t fall back to the old verifier on
 192     // verification failure. If a class fails verification with the split verifier,
 193     // it might fail the CDS runtime verifier constraint check. In that case, we
 194     // don&#39;t want to share the class. We only archive classes that pass the split
 195     // verifier.
 196     bool can_failover = !DumpSharedSpaces &amp;&amp;
 197       klass-&gt;major_version() &lt; NOFAILOVER_MAJOR_VERSION;
 198 
 199     if (can_failover &amp;&amp; !HAS_PENDING_EXCEPTION &amp;&amp;  // Split verifier doesn&#39;t set PENDING_EXCEPTION for failure
 200         (exception_name == vmSymbols::java_lang_VerifyError() ||
 201          exception_name == vmSymbols::java_lang_ClassFormatError())) {
 202       log_info(verification)(&quot;Fail over class verification to old verifier for: %s&quot;, klass-&gt;external_name());
 203       log_info(class, init)(&quot;Fail over class verification to old verifier for: %s&quot;, klass-&gt;external_name());
 204       message_buffer = NEW_RESOURCE_ARRAY(char, message_buffer_len);
 205       exception_message = message_buffer;
 206       exception_name = inference_verify(
 207         klass, message_buffer, message_buffer_len, THREAD);
 208     }
 209     if (exception_name != NULL) {
 210       exception_message = split_verifier.exception_message();
 211     }
 212   } else {
 213     message_buffer = NEW_RESOURCE_ARRAY(char, message_buffer_len);
 214     exception_message = message_buffer;
 215     exception_name = inference_verify(
 216         klass, message_buffer, message_buffer_len, THREAD);
 217   }
 218 
 219   LogTarget(Info, class, init) lt1;
 220   if (lt1.is_enabled()) {
 221     LogStream ls(lt1);
 222     log_end_verification(&amp;ls, klass-&gt;external_name(), exception_name, THREAD);
 223   }
 224   LogTarget(Info, verification) lt2;
 225   if (lt2.is_enabled()) {
 226     LogStream ls(lt2);
 227     log_end_verification(&amp;ls, klass-&gt;external_name(), exception_name, THREAD);
 228   }
 229 
 230   if (HAS_PENDING_EXCEPTION) {
 231     return false; // use the existing exception
 232   } else if (exception_name == NULL) {
 233     return true; // verification succeeded
 234   } else { // VerifyError or ClassFormatError to be created and thrown
 235     Klass* kls =
 236       SystemDictionary::resolve_or_fail(exception_name, true, CHECK_false);
 237     if (log_is_enabled(Debug, class, resolve)) {
 238       Verifier::trace_class_resolution(kls, klass);
 239     }
 240 
 241     while (kls != NULL) {
 242       if (kls == klass) {
 243         // If the class being verified is the exception we&#39;re creating
 244         // or one of it&#39;s superclasses, we&#39;re in trouble and are going
 245         // to infinitely recurse when we try to initialize the exception.
 246         // So bail out here by throwing the preallocated VM error.
 247         THROW_OOP_(Universe::virtual_machine_error_instance(), false);
 248       }
 249       kls = kls-&gt;super();
 250     }
 251     if (message_buffer != NULL) {
 252       message_buffer[message_buffer_len - 1] = &#39;\0&#39;; // just to be sure
 253     }
 254     assert(exception_message != NULL, &quot;&quot;);
 255     THROW_MSG_(exception_name, exception_message, false);
 256   }
 257 }
 258 
 259 bool Verifier::is_eligible_for_verification(InstanceKlass* klass, bool should_verify_class) {
 260   Symbol* name = klass-&gt;name();
 261   Klass* refl_magic_klass = SystemDictionary::reflect_MagicAccessorImpl_klass();
 262 
 263   bool is_reflect = refl_magic_klass != NULL &amp;&amp; klass-&gt;is_subtype_of(refl_magic_klass);
 264 
 265   return (should_verify_for(klass-&gt;class_loader(), should_verify_class) &amp;&amp;
 266     // return if the class is a bootstrapping class
 267     // or defineClass specified not to verify by default (flags override passed arg)
<a name="2" id="anc2"></a><span class="line-modified"> 268     // We need to skip the following four for bootstrapping</span>
 269     name != vmSymbols::java_lang_Object() &amp;&amp;
 270     name != vmSymbols::java_lang_Class() &amp;&amp;
 271     name != vmSymbols::java_lang_String() &amp;&amp;
 272     name != vmSymbols::java_lang_Throwable() &amp;&amp;
 273 
 274     // Can not verify the bytecodes for shared classes because they have
 275     // already been rewritten to contain constant pool cache indices,
 276     // which the verifier can&#39;t understand.
 277     // Shared classes shouldn&#39;t have stackmaps either.
 278     !klass-&gt;is_shared() &amp;&amp;
 279 
 280     // As of the fix for 4486457 we disable verification for all of the
 281     // dynamically-generated bytecodes associated with the 1.4
 282     // reflection implementation, not just those associated with
 283     // jdk/internal/reflect/SerializationConstructorAccessor.
 284     // NOTE: this is called too early in the bootstrapping process to be
 285     // guarded by Universe::is_gte_jdk14x_version().
 286     // Also for lambda generated code, gte jdk8
 287     (!is_reflect));
 288 }
 289 
 290 Symbol* Verifier::inference_verify(
 291     InstanceKlass* klass, char* message, size_t message_len, TRAPS) {
 292   JavaThread* thread = (JavaThread*)THREAD;
 293   JNIEnv *env = thread-&gt;jni_environment();
 294 
 295   verify_byte_codes_fn_t verify_func = verify_byte_codes_fn();
 296 
 297   if (verify_func == NULL) {
 298     jio_snprintf(message, message_len, &quot;Could not link verifier&quot;);
 299     return vmSymbols::java_lang_VerifyError();
 300   }
 301 
 302   ResourceMark rm(THREAD);
 303   log_info(verification)(&quot;Verifying class %s with old format&quot;, klass-&gt;external_name());
 304 
 305   jclass cls = (jclass) JNIHandles::make_local(env, klass-&gt;java_mirror());
 306   jint result;
 307 
 308   {
 309     HandleMark hm(thread);
 310     ThreadToNativeFromVM ttn(thread);
 311     // ThreadToNativeFromVM takes care of changing thread_state, so safepoint
 312     // code knows that we have left the VM
 313 
 314     result = (*verify_func)(env, cls, message, (int)message_len, klass-&gt;major_version());
 315   }
 316 
 317   JNIHandles::destroy_local(cls);
 318 
 319   // These numbers are chosen so that VerifyClassCodes interface doesn&#39;t need
 320   // to be changed (still return jboolean (unsigned char)), and result is
 321   // 1 when verification is passed.
 322   if (result == 0) {
 323     return vmSymbols::java_lang_VerifyError();
 324   } else if (result == 1) {
 325     return NULL; // verified.
 326   } else if (result == 2) {
 327     THROW_MSG_(vmSymbols::java_lang_OutOfMemoryError(), message, NULL);
 328   } else if (result == 3) {
 329     return vmSymbols::java_lang_ClassFormatError();
 330   } else {
 331     ShouldNotReachHere();
 332     return NULL;
 333   }
 334 }
 335 
 336 TypeOrigin TypeOrigin::null() {
 337   return TypeOrigin();
 338 }
 339 TypeOrigin TypeOrigin::local(u2 index, StackMapFrame* frame) {
 340   assert(frame != NULL, &quot;Must have a frame&quot;);
 341   return TypeOrigin(CF_LOCALS, index, StackMapFrame::copy(frame),
 342      frame-&gt;local_at(index));
 343 }
 344 TypeOrigin TypeOrigin::stack(u2 index, StackMapFrame* frame) {
 345   assert(frame != NULL, &quot;Must have a frame&quot;);
 346   return TypeOrigin(CF_STACK, index, StackMapFrame::copy(frame),
 347       frame-&gt;stack_at(index));
 348 }
 349 TypeOrigin TypeOrigin::sm_local(u2 index, StackMapFrame* frame) {
 350   assert(frame != NULL, &quot;Must have a frame&quot;);
 351   return TypeOrigin(SM_LOCALS, index, StackMapFrame::copy(frame),
 352       frame-&gt;local_at(index));
 353 }
 354 TypeOrigin TypeOrigin::sm_stack(u2 index, StackMapFrame* frame) {
 355   assert(frame != NULL, &quot;Must have a frame&quot;);
 356   return TypeOrigin(SM_STACK, index, StackMapFrame::copy(frame),
 357       frame-&gt;stack_at(index));
 358 }
 359 TypeOrigin TypeOrigin::bad_index(u2 index) {
 360   return TypeOrigin(BAD_INDEX, index, NULL, VerificationType::bogus_type());
 361 }
 362 TypeOrigin TypeOrigin::cp(u2 index, VerificationType vt) {
 363   return TypeOrigin(CONST_POOL, index, NULL, vt);
 364 }
 365 TypeOrigin TypeOrigin::signature(VerificationType vt) {
 366   return TypeOrigin(SIG, 0, NULL, vt);
 367 }
 368 TypeOrigin TypeOrigin::implicit(VerificationType t) {
 369   return TypeOrigin(IMPLICIT, 0, NULL, t);
 370 }
 371 TypeOrigin TypeOrigin::frame(StackMapFrame* frame) {
 372   return TypeOrigin(FRAME_ONLY, 0, StackMapFrame::copy(frame),
 373                     VerificationType::bogus_type());
 374 }
 375 
 376 void TypeOrigin::reset_frame() {
 377   if (_frame != NULL) {
 378     _frame-&gt;restore();
 379   }
 380 }
 381 
 382 void TypeOrigin::details(outputStream* ss) const {
 383   _type.print_on(ss);
 384   switch (_origin) {
 385     case CF_LOCALS:
 386       ss-&gt;print(&quot; (current frame, locals[%d])&quot;, _index);
 387       break;
 388     case CF_STACK:
 389       ss-&gt;print(&quot; (current frame, stack[%d])&quot;, _index);
 390       break;
 391     case SM_LOCALS:
 392       ss-&gt;print(&quot; (stack map, locals[%d])&quot;, _index);
 393       break;
 394     case SM_STACK:
 395       ss-&gt;print(&quot; (stack map, stack[%d])&quot;, _index);
 396       break;
 397     case CONST_POOL:
 398       ss-&gt;print(&quot; (constant pool %d)&quot;, _index);
 399       break;
 400     case SIG:
 401       ss-&gt;print(&quot; (from method signature)&quot;);
 402       break;
 403     case IMPLICIT:
 404     case FRAME_ONLY:
 405     case NONE:
 406     default:
 407       ;
 408   }
 409 }
 410 
 411 #ifdef ASSERT
 412 void TypeOrigin::print_on(outputStream* str) const {
 413   str-&gt;print(&quot;{%d,%d,%p:&quot;, _origin, _index, _frame);
 414   if (_frame != NULL) {
 415     _frame-&gt;print_on(str);
 416   } else {
 417     str-&gt;print(&quot;null&quot;);
 418   }
 419   str-&gt;print(&quot;,&quot;);
 420   _type.print_on(str);
 421   str-&gt;print(&quot;}&quot;);
 422 }
 423 #endif
 424 
 425 void ErrorContext::details(outputStream* ss, const Method* method) const {
 426   if (is_valid()) {
 427     ss-&gt;cr();
 428     ss-&gt;print_cr(&quot;Exception Details:&quot;);
 429     location_details(ss, method);
 430     reason_details(ss);
 431     frame_details(ss);
 432     bytecode_details(ss, method);
 433     handler_details(ss, method);
 434     stackmap_details(ss, method);
 435   }
 436 }
 437 
 438 void ErrorContext::reason_details(outputStream* ss) const {
 439   streamIndentor si(ss);
 440   ss-&gt;indent().print_cr(&quot;Reason:&quot;);
 441   streamIndentor si2(ss);
 442   ss-&gt;indent().print(&quot;%s&quot;, &quot;&quot;);
 443   switch (_fault) {
 444     case INVALID_BYTECODE:
 445       ss-&gt;print(&quot;Error exists in the bytecode&quot;);
 446       break;
 447     case WRONG_TYPE:
 448       if (_expected.is_valid()) {
 449         ss-&gt;print(&quot;Type &quot;);
 450         _type.details(ss);
 451         ss-&gt;print(&quot; is not assignable to &quot;);
 452         _expected.details(ss);
 453       } else {
 454         ss-&gt;print(&quot;Invalid type: &quot;);
 455         _type.details(ss);
 456       }
 457       break;
 458     case FLAGS_MISMATCH:
 459       if (_expected.is_valid()) {
 460         ss-&gt;print(&quot;Current frame&#39;s flags are not assignable &quot;
 461                   &quot;to stack map frame&#39;s.&quot;);
 462       } else {
 463         ss-&gt;print(&quot;Current frame&#39;s flags are invalid in this context.&quot;);
 464       }
 465       break;
 466     case BAD_CP_INDEX:
 467       ss-&gt;print(&quot;Constant pool index %d is invalid&quot;, _type.index());
 468       break;
 469     case BAD_LOCAL_INDEX:
 470       ss-&gt;print(&quot;Local index %d is invalid&quot;, _type.index());
 471       break;
 472     case LOCALS_SIZE_MISMATCH:
 473       ss-&gt;print(&quot;Current frame&#39;s local size doesn&#39;t match stackmap.&quot;);
 474       break;
 475     case STACK_SIZE_MISMATCH:
 476       ss-&gt;print(&quot;Current frame&#39;s stack size doesn&#39;t match stackmap.&quot;);
 477       break;
 478     case STACK_OVERFLOW:
 479       ss-&gt;print(&quot;Exceeded max stack size.&quot;);
 480       break;
 481     case STACK_UNDERFLOW:
 482       ss-&gt;print(&quot;Attempt to pop empty stack.&quot;);
 483       break;
 484     case MISSING_STACKMAP:
 485       ss-&gt;print(&quot;Expected stackmap frame at this location.&quot;);
 486       break;
 487     case BAD_STACKMAP:
 488       ss-&gt;print(&quot;Invalid stackmap specification.&quot;);
 489       break;
<a name="3" id="anc3"></a><span class="line-added"> 490     case WRONG_VALUE_TYPE:</span>
<span class="line-added"> 491       ss-&gt;print(&quot;Type &quot;);</span>
<span class="line-added"> 492       _type.details(ss);</span>
<span class="line-added"> 493       ss-&gt;print(&quot; and type &quot;);</span>
<span class="line-added"> 494       _expected.details(ss);</span>
<span class="line-added"> 495       ss-&gt;print(&quot; must be identical inline types.&quot;);</span>
<span class="line-added"> 496       break;</span>
 497     case UNKNOWN:
 498     default:
 499       ShouldNotReachHere();
 500       ss-&gt;print_cr(&quot;Unknown&quot;);
 501   }
 502   ss-&gt;cr();
 503 }
 504 
 505 void ErrorContext::location_details(outputStream* ss, const Method* method) const {
 506   if (_bci != -1 &amp;&amp; method != NULL) {
 507     streamIndentor si(ss);
 508     const char* bytecode_name = &quot;&lt;invalid&gt;&quot;;
 509     if (method-&gt;validate_bci(_bci) != -1) {
 510       Bytecodes::Code code = Bytecodes::code_or_bp_at(method-&gt;bcp_from(_bci));
 511       if (Bytecodes::is_defined(code)) {
 512           bytecode_name = Bytecodes::name(code);
 513       } else {
 514           bytecode_name = &quot;&lt;illegal&gt;&quot;;
 515       }
 516     }
 517     InstanceKlass* ik = method-&gt;method_holder();
 518     ss-&gt;indent().print_cr(&quot;Location:&quot;);
 519     streamIndentor si2(ss);
 520     ss-&gt;indent().print_cr(&quot;%s.%s%s @%d: %s&quot;,
 521         ik-&gt;name()-&gt;as_C_string(), method-&gt;name()-&gt;as_C_string(),
 522         method-&gt;signature()-&gt;as_C_string(), _bci, bytecode_name);
 523   }
 524 }
 525 
 526 void ErrorContext::frame_details(outputStream* ss) const {
 527   streamIndentor si(ss);
 528   if (_type.is_valid() &amp;&amp; _type.frame() != NULL) {
 529     ss-&gt;indent().print_cr(&quot;Current Frame:&quot;);
 530     streamIndentor si2(ss);
 531     _type.frame()-&gt;print_on(ss);
 532   }
 533   if (_expected.is_valid() &amp;&amp; _expected.frame() != NULL) {
 534     ss-&gt;indent().print_cr(&quot;Stackmap Frame:&quot;);
 535     streamIndentor si2(ss);
 536     _expected.frame()-&gt;print_on(ss);
 537   }
 538 }
 539 
 540 void ErrorContext::bytecode_details(outputStream* ss, const Method* method) const {
 541   if (method != NULL) {
 542     streamIndentor si(ss);
 543     ss-&gt;indent().print_cr(&quot;Bytecode:&quot;);
 544     streamIndentor si2(ss);
 545     ss-&gt;print_data(method-&gt;code_base(), method-&gt;code_size(), false);
 546   }
 547 }
 548 
 549 void ErrorContext::handler_details(outputStream* ss, const Method* method) const {
 550   if (method != NULL) {
 551     streamIndentor si(ss);
 552     ExceptionTable table(method);
 553     if (table.length() &gt; 0) {
 554       ss-&gt;indent().print_cr(&quot;Exception Handler Table:&quot;);
 555       streamIndentor si2(ss);
 556       for (int i = 0; i &lt; table.length(); ++i) {
 557         ss-&gt;indent().print_cr(&quot;bci [%d, %d] =&gt; handler: %d&quot;, table.start_pc(i),
 558             table.end_pc(i), table.handler_pc(i));
 559       }
 560     }
 561   }
 562 }
 563 
 564 void ErrorContext::stackmap_details(outputStream* ss, const Method* method) const {
 565   if (method != NULL &amp;&amp; method-&gt;has_stackmap_table()) {
 566     streamIndentor si(ss);
 567     ss-&gt;indent().print_cr(&quot;Stackmap Table:&quot;);
 568     Array&lt;u1&gt;* data = method-&gt;stackmap_data();
 569     stack_map_table* sm_table =
 570         stack_map_table::at((address)data-&gt;adr_at(0));
 571     stack_map_frame* sm_frame = sm_table-&gt;entries();
 572     streamIndentor si2(ss);
 573     int current_offset = -1;
 574     address end_of_sm_table = (address)sm_table + method-&gt;stackmap_data()-&gt;length();
 575     for (u2 i = 0; i &lt; sm_table-&gt;number_of_entries(); ++i) {
 576       ss-&gt;indent();
 577       if (!sm_frame-&gt;verify((address)sm_frame, end_of_sm_table)) {
 578         sm_frame-&gt;print_truncated(ss, current_offset);
 579         return;
 580       }
 581       sm_frame-&gt;print_on(ss, current_offset);
 582       ss-&gt;cr();
 583       current_offset += sm_frame-&gt;offset_delta();
 584       sm_frame = sm_frame-&gt;next();
 585     }
 586   }
 587 }
 588 
 589 // Methods in ClassVerifier
 590 
<a name="4" id="anc4"></a><span class="line-added"> 591 VerificationType reference_or_valuetype(InstanceKlass* klass) {</span>
<span class="line-added"> 592   if (klass-&gt;is_value()) {</span>
<span class="line-added"> 593     return VerificationType::valuetype_type(klass-&gt;name());</span>
<span class="line-added"> 594   } else {</span>
<span class="line-added"> 595     return VerificationType::reference_type(klass-&gt;name());</span>
<span class="line-added"> 596   }</span>
<span class="line-added"> 597 }</span>
<span class="line-added"> 598 </span>
 599 ClassVerifier::ClassVerifier(
 600     InstanceKlass* klass, TRAPS)
 601     : _thread(THREAD), _previous_symbol(NULL), _symbols(NULL), _exception_type(NULL),
 602       _message(NULL), _method_signatures_table(NULL), _klass(klass) {
<a name="5" id="anc5"></a><span class="line-modified"> 603   _this_type = reference_or_valuetype(klass);</span>
 604 }
 605 
 606 ClassVerifier::~ClassVerifier() {
 607   // Decrement the reference count for any symbols created.
 608   if (_symbols != NULL) {
 609     for (int i = 0; i &lt; _symbols-&gt;length(); i++) {
 610       Symbol* s = _symbols-&gt;at(i);
 611       s-&gt;decrement_refcount();
 612     }
 613   }
 614 }
 615 
 616 VerificationType ClassVerifier::object_type() const {
 617   return VerificationType::reference_type(vmSymbols::java_lang_Object());
 618 }
 619 
 620 TypeOrigin ClassVerifier::ref_ctx(const char* sig) {
 621   VerificationType vt = VerificationType::reference_type(
 622                          create_temporary_symbol(sig, (int)strlen(sig)));
 623   return TypeOrigin::implicit(vt);
 624 }
 625 
 626 void ClassVerifier::verify_class(TRAPS) {
 627   log_info(verification)(&quot;Verifying class %s with new format&quot;, _klass-&gt;external_name());
 628 
 629   // Either verifying both local and remote classes or just remote classes.
 630   assert(BytecodeVerificationRemote, &quot;Should not be here&quot;);
 631 
 632   // Create hash table containing method signatures.
 633   method_signatures_table_type method_signatures_table;
 634   set_method_signatures_table(&amp;method_signatures_table);
 635 
 636   Array&lt;Method*&gt;* methods = _klass-&gt;methods();
 637   int num_methods = methods-&gt;length();
 638 
 639   for (int index = 0; index &lt; num_methods; index++) {
 640     // Check for recursive re-verification before each method.
 641     if (was_recursively_verified())  return;
 642 
 643     Method* m = methods-&gt;at(index);
 644     if (m-&gt;is_native() || m-&gt;is_abstract() || m-&gt;is_overpass()) {
 645       // If m is native or abstract, skip it.  It is checked in class file
 646       // parser that methods do not override a final method.  Overpass methods
 647       // are trusted since the VM generates them.
 648       continue;
 649     }
 650     verify_method(methodHandle(THREAD, m), CHECK_VERIFY(this));
 651   }
 652 
 653   if (was_recursively_verified()){
 654     log_info(verification)(&quot;Recursive verification detected for: %s&quot;, _klass-&gt;external_name());
 655     log_info(class, init)(&quot;Recursive verification detected for: %s&quot;,
 656                         _klass-&gt;external_name());
 657   }
 658 }
 659 
 660 // Translate the signature entries into verification types and save them in
 661 // the growable array.  Also, save the count of arguments.
 662 void ClassVerifier::translate_signature(Symbol* const method_sig,
 663                                         sig_as_verification_types* sig_verif_types,
 664                                         TRAPS) {
 665   SignatureStream sig_stream(method_sig);
 666   VerificationType sig_type[2];
 667   int sig_i = 0;
 668   GrowableArray&lt;VerificationType&gt;* verif_types = sig_verif_types-&gt;sig_verif_types();
 669 
 670   // Translate the signature arguments into verification types.
 671   while (!sig_stream.at_return_type()) {
 672     int n = change_sig_to_verificationType(&amp;sig_stream, sig_type);
 673     assert(n &lt;= 2, &quot;Unexpected signature type&quot;);
 674 
 675     // Store verification type(s).  Longs and Doubles each have two verificationTypes.
 676     for (int x = 0; x &lt; n; x++) {
 677       verif_types-&gt;push(sig_type[x]);
 678     }
 679     sig_i += n;
 680     sig_stream.next();
 681   }
 682 
 683   // Set final arg count, not including the return type.  The final arg count will
 684   // be compared with sig_verify_types&#39; length to see if there is a return type.
 685   sig_verif_types-&gt;set_num_args(sig_i);
 686 
 687   // Store verification type(s) for the return type, if there is one.
 688   if (sig_stream.type() != T_VOID) {
 689     int n = change_sig_to_verificationType(&amp;sig_stream, sig_type);
 690     assert(n &lt;= 2, &quot;Unexpected signature return type&quot;);
 691     for (int y = 0; y &lt; n; y++) {
 692       verif_types-&gt;push(sig_type[y]);
 693     }
 694   }
 695 }
 696 
 697 void ClassVerifier::create_method_sig_entry(sig_as_verification_types* sig_verif_types,
 698                                             int sig_index, TRAPS) {
 699   // Translate the signature into verification types.
 700   ConstantPool* cp = _klass-&gt;constants();
 701   Symbol* const method_sig = cp-&gt;symbol_at(sig_index);
 702   translate_signature(method_sig, sig_verif_types, CHECK_VERIFY(this));
 703 
 704   // Add the list of this signature&#39;s verification types to the table.
 705   bool is_unique = method_signatures_table()-&gt;put(sig_index, sig_verif_types);
 706   assert(is_unique, &quot;Duplicate entries in method_signature_table&quot;);
 707 }
 708 
 709 void ClassVerifier::verify_method(const methodHandle&amp; m, TRAPS) {
 710   HandleMark hm(THREAD);
 711   _method = m;   // initialize _method
 712   log_info(verification)(&quot;Verifying method %s&quot;, m-&gt;name_and_sig_as_C_string());
 713 
 714 // For clang, the only good constant format string is a literal constant format string.
 715 #define bad_type_msg &quot;Bad type on operand stack in %s&quot;
 716 
 717   int32_t max_stack = m-&gt;verifier_max_stack();
 718   int32_t max_locals = m-&gt;max_locals();
 719   constantPoolHandle cp(THREAD, m-&gt;constants());
 720 
 721   // Method signature was checked in ClassFileParser.
 722   assert(SignatureVerifier::is_valid_method_signature(m-&gt;signature()),
 723          &quot;Invalid method signature&quot;);
 724 
 725   // Initial stack map frame: offset is 0, stack is initially empty.
 726   StackMapFrame current_frame(max_locals, max_stack, this);
 727   // Set initial locals
 728   VerificationType return_type = current_frame.set_locals_from_arg(
 729     m, current_type(), CHECK_VERIFY(this));
 730 
 731   int32_t stackmap_index = 0; // index to the stackmap array
 732 
 733   u4 code_length = m-&gt;code_size();
 734 
 735   // Scan the bytecode and map each instruction&#39;s start offset to a number.
 736   char* code_data = generate_code_data(m, code_length, CHECK_VERIFY(this));
 737 
 738   int ex_min = code_length;
 739   int ex_max = -1;
 740   // Look through each item on the exception table. Each of the fields must refer
 741   // to a legal instruction.
 742   if (was_recursively_verified()) return;
 743   verify_exception_handler_table(
 744     code_length, code_data, ex_min, ex_max, CHECK_VERIFY(this));
 745 
 746   // Look through each entry on the local variable table and make sure
 747   // its range of code array offsets is valid. (4169817)
 748   if (m-&gt;has_localvariable_table()) {
 749     verify_local_variable_table(code_length, code_data, CHECK_VERIFY(this));
 750   }
 751 
 752   Array&lt;u1&gt;* stackmap_data = m-&gt;stackmap_data();
 753   StackMapStream stream(stackmap_data);
 754   StackMapReader reader(this, &amp;stream, code_data, code_length, THREAD);
 755   StackMapTable stackmap_table(&amp;reader, &amp;current_frame, max_locals, max_stack,
 756                                code_data, code_length, CHECK_VERIFY(this));
 757 
 758   LogTarget(Debug, verification) lt;
 759   if (lt.is_enabled()) {
 760     ResourceMark rm(THREAD);
 761     LogStream ls(lt);
 762     stackmap_table.print_on(&amp;ls);
 763   }
 764 
 765   RawBytecodeStream bcs(m);
 766 
 767   // Scan the byte code linearly from the start to the end
 768   bool no_control_flow = false; // Set to true when there is no direct control
 769                                 // flow from current instruction to the next
 770                                 // instruction in sequence
 771 
 772   Bytecodes::Code opcode;
 773   while (!bcs.is_last_bytecode()) {
 774     // Check for recursive re-verification before each bytecode.
 775     if (was_recursively_verified())  return;
 776 
 777     opcode = bcs.raw_next();
 778     u2 bci = bcs.bci();
 779 
 780     // Set current frame&#39;s offset to bci
 781     current_frame.set_offset(bci);
 782     current_frame.set_mark();
 783 
 784     // Make sure every offset in stackmap table point to the beginning to
 785     // an instruction. Match current_frame to stackmap_table entry with
 786     // the same offset if exists.
 787     stackmap_index = verify_stackmap_table(
 788       stackmap_index, bci, &amp;current_frame, &amp;stackmap_table,
 789       no_control_flow, CHECK_VERIFY(this));
 790 
 791 
 792     bool this_uninit = false;  // Set to true when invokespecial &lt;init&gt; initialized &#39;this&#39;
 793     bool verified_exc_handlers = false;
 794 
 795     // Merge with the next instruction
 796     {
 797       u2 index;
 798       int target;
 799       VerificationType type, type2;
 800       VerificationType atype;
 801 
 802       LogTarget(Debug, verification) lt;
 803       if (lt.is_enabled()) {
 804         ResourceMark rm(THREAD);
 805         LogStream ls(lt);
 806         current_frame.print_on(&amp;ls);
 807         lt.print(&quot;offset = %d,  opcode = %s&quot;, bci,
 808                  opcode == Bytecodes::_illegal ? &quot;illegal&quot; : Bytecodes::name(opcode));
 809       }
 810 
 811       // Make sure wide instruction is in correct format
 812       if (bcs.is_wide()) {
 813         if (opcode != Bytecodes::_iinc   &amp;&amp; opcode != Bytecodes::_iload  &amp;&amp;
 814             opcode != Bytecodes::_aload  &amp;&amp; opcode != Bytecodes::_lload  &amp;&amp;
 815             opcode != Bytecodes::_istore &amp;&amp; opcode != Bytecodes::_astore &amp;&amp;
 816             opcode != Bytecodes::_lstore &amp;&amp; opcode != Bytecodes::_fload  &amp;&amp;
 817             opcode != Bytecodes::_dload  &amp;&amp; opcode != Bytecodes::_fstore &amp;&amp;
 818             opcode != Bytecodes::_dstore) {
 819           /* Unreachable?  RawBytecodeStream&#39;s raw_next() returns &#39;illegal&#39;
 820            * if we encounter a wide instruction that modifies an invalid
 821            * opcode (not one of the ones listed above) */
 822           verify_error(ErrorContext::bad_code(bci), &quot;Bad wide instruction&quot;);
 823           return;
 824         }
 825       }
 826 
 827       // Look for possible jump target in exception handlers and see if it
 828       // matches current_frame.  Do this check here for astore*, dstore*,
 829       // fstore*, istore*, and lstore* opcodes because they can change the type
 830       // state by adding a local.  JVM Spec says that the incoming type state
 831       // should be used for this check.  So, do the check here before a possible
 832       // local is added to the type state.
 833       if (Bytecodes::is_store_into_local(opcode) &amp;&amp; bci &gt;= ex_min &amp;&amp; bci &lt; ex_max) {
 834         if (was_recursively_verified()) return;
 835         verify_exception_handler_targets(
 836           bci, this_uninit, &amp;current_frame, &amp;stackmap_table, CHECK_VERIFY(this));
 837         verified_exc_handlers = true;
 838       }
 839 
 840       if (was_recursively_verified()) return;
 841 
 842       switch (opcode) {
 843         case Bytecodes::_nop :
 844           no_control_flow = false; break;
 845         case Bytecodes::_aconst_null :
 846           current_frame.push_stack(
 847             VerificationType::null_type(), CHECK_VERIFY(this));
 848           no_control_flow = false; break;
 849         case Bytecodes::_iconst_m1 :
 850         case Bytecodes::_iconst_0 :
 851         case Bytecodes::_iconst_1 :
 852         case Bytecodes::_iconst_2 :
 853         case Bytecodes::_iconst_3 :
 854         case Bytecodes::_iconst_4 :
 855         case Bytecodes::_iconst_5 :
 856           current_frame.push_stack(
 857             VerificationType::integer_type(), CHECK_VERIFY(this));
 858           no_control_flow = false; break;
 859         case Bytecodes::_lconst_0 :
 860         case Bytecodes::_lconst_1 :
 861           current_frame.push_stack_2(
 862             VerificationType::long_type(),
 863             VerificationType::long2_type(), CHECK_VERIFY(this));
 864           no_control_flow = false; break;
 865         case Bytecodes::_fconst_0 :
 866         case Bytecodes::_fconst_1 :
 867         case Bytecodes::_fconst_2 :
 868           current_frame.push_stack(
 869             VerificationType::float_type(), CHECK_VERIFY(this));
 870           no_control_flow = false; break;
 871         case Bytecodes::_dconst_0 :
 872         case Bytecodes::_dconst_1 :
 873           current_frame.push_stack_2(
 874             VerificationType::double_type(),
 875             VerificationType::double2_type(), CHECK_VERIFY(this));
 876           no_control_flow = false; break;
 877         case Bytecodes::_sipush :
 878         case Bytecodes::_bipush :
 879           current_frame.push_stack(
 880             VerificationType::integer_type(), CHECK_VERIFY(this));
 881           no_control_flow = false; break;
 882         case Bytecodes::_ldc :
 883           verify_ldc(
 884             opcode, bcs.get_index_u1(), &amp;current_frame,
 885             cp, bci, CHECK_VERIFY(this));
 886           no_control_flow = false; break;
 887         case Bytecodes::_ldc_w :
 888         case Bytecodes::_ldc2_w :
 889           verify_ldc(
 890             opcode, bcs.get_index_u2(), &amp;current_frame,
 891             cp, bci, CHECK_VERIFY(this));
 892           no_control_flow = false; break;
 893         case Bytecodes::_iload :
 894           verify_iload(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
 895           no_control_flow = false; break;
 896         case Bytecodes::_iload_0 :
 897         case Bytecodes::_iload_1 :
 898         case Bytecodes::_iload_2 :
 899         case Bytecodes::_iload_3 :
 900           index = opcode - Bytecodes::_iload_0;
 901           verify_iload(index, &amp;current_frame, CHECK_VERIFY(this));
 902           no_control_flow = false; break;
 903         case Bytecodes::_lload :
 904           verify_lload(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
 905           no_control_flow = false; break;
 906         case Bytecodes::_lload_0 :
 907         case Bytecodes::_lload_1 :
 908         case Bytecodes::_lload_2 :
 909         case Bytecodes::_lload_3 :
 910           index = opcode - Bytecodes::_lload_0;
 911           verify_lload(index, &amp;current_frame, CHECK_VERIFY(this));
 912           no_control_flow = false; break;
 913         case Bytecodes::_fload :
 914           verify_fload(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
 915           no_control_flow = false; break;
 916         case Bytecodes::_fload_0 :
 917         case Bytecodes::_fload_1 :
 918         case Bytecodes::_fload_2 :
 919         case Bytecodes::_fload_3 :
 920           index = opcode - Bytecodes::_fload_0;
 921           verify_fload(index, &amp;current_frame, CHECK_VERIFY(this));
 922           no_control_flow = false; break;
 923         case Bytecodes::_dload :
 924           verify_dload(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
 925           no_control_flow = false; break;
 926         case Bytecodes::_dload_0 :
 927         case Bytecodes::_dload_1 :
 928         case Bytecodes::_dload_2 :
 929         case Bytecodes::_dload_3 :
 930           index = opcode - Bytecodes::_dload_0;
 931           verify_dload(index, &amp;current_frame, CHECK_VERIFY(this));
 932           no_control_flow = false; break;
 933         case Bytecodes::_aload :
 934           verify_aload(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
 935           no_control_flow = false; break;
 936         case Bytecodes::_aload_0 :
 937         case Bytecodes::_aload_1 :
 938         case Bytecodes::_aload_2 :
 939         case Bytecodes::_aload_3 :
 940           index = opcode - Bytecodes::_aload_0;
 941           verify_aload(index, &amp;current_frame, CHECK_VERIFY(this));
 942           no_control_flow = false; break;
 943         case Bytecodes::_iaload :
 944           type = current_frame.pop_stack(
 945             VerificationType::integer_type(), CHECK_VERIFY(this));
 946           atype = current_frame.pop_stack(
 947             VerificationType::reference_check(), CHECK_VERIFY(this));
 948           if (!atype.is_int_array()) {
 949             verify_error(ErrorContext::bad_type(bci,
 950                 current_frame.stack_top_ctx(), ref_ctx(&quot;[I&quot;)),
 951                 bad_type_msg, &quot;iaload&quot;);
 952             return;
 953           }
 954           current_frame.push_stack(
 955             VerificationType::integer_type(), CHECK_VERIFY(this));
 956           no_control_flow = false; break;
 957         case Bytecodes::_baload :
 958           type = current_frame.pop_stack(
 959             VerificationType::integer_type(), CHECK_VERIFY(this));
 960           atype = current_frame.pop_stack(
 961             VerificationType::reference_check(), CHECK_VERIFY(this));
 962           if (!atype.is_bool_array() &amp;&amp; !atype.is_byte_array()) {
 963             verify_error(
 964                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
 965                 bad_type_msg, &quot;baload&quot;);
 966             return;
 967           }
 968           current_frame.push_stack(
 969             VerificationType::integer_type(), CHECK_VERIFY(this));
 970           no_control_flow = false; break;
 971         case Bytecodes::_caload :
 972           type = current_frame.pop_stack(
 973             VerificationType::integer_type(), CHECK_VERIFY(this));
 974           atype = current_frame.pop_stack(
 975             VerificationType::reference_check(), CHECK_VERIFY(this));
 976           if (!atype.is_char_array()) {
 977             verify_error(ErrorContext::bad_type(bci,
 978                 current_frame.stack_top_ctx(), ref_ctx(&quot;[C&quot;)),
 979                 bad_type_msg, &quot;caload&quot;);
 980             return;
 981           }
 982           current_frame.push_stack(
 983             VerificationType::integer_type(), CHECK_VERIFY(this));
 984           no_control_flow = false; break;
 985         case Bytecodes::_saload :
 986           type = current_frame.pop_stack(
 987             VerificationType::integer_type(), CHECK_VERIFY(this));
 988           atype = current_frame.pop_stack(
 989             VerificationType::reference_check(), CHECK_VERIFY(this));
 990           if (!atype.is_short_array()) {
 991             verify_error(ErrorContext::bad_type(bci,
 992                 current_frame.stack_top_ctx(), ref_ctx(&quot;[S&quot;)),
 993                 bad_type_msg, &quot;saload&quot;);
 994             return;
 995           }
 996           current_frame.push_stack(
 997             VerificationType::integer_type(), CHECK_VERIFY(this));
 998           no_control_flow = false; break;
 999         case Bytecodes::_laload :
1000           type = current_frame.pop_stack(
1001             VerificationType::integer_type(), CHECK_VERIFY(this));
1002           atype = current_frame.pop_stack(
1003             VerificationType::reference_check(), CHECK_VERIFY(this));
1004           if (!atype.is_long_array()) {
1005             verify_error(ErrorContext::bad_type(bci,
1006                 current_frame.stack_top_ctx(), ref_ctx(&quot;[J&quot;)),
1007                 bad_type_msg, &quot;laload&quot;);
1008             return;
1009           }
1010           current_frame.push_stack_2(
1011             VerificationType::long_type(),
1012             VerificationType::long2_type(), CHECK_VERIFY(this));
1013           no_control_flow = false; break;
1014         case Bytecodes::_faload :
1015           type = current_frame.pop_stack(
1016             VerificationType::integer_type(), CHECK_VERIFY(this));
1017           atype = current_frame.pop_stack(
1018             VerificationType::reference_check(), CHECK_VERIFY(this));
1019           if (!atype.is_float_array()) {
1020             verify_error(ErrorContext::bad_type(bci,
1021                 current_frame.stack_top_ctx(), ref_ctx(&quot;[F&quot;)),
1022                 bad_type_msg, &quot;faload&quot;);
1023             return;
1024           }
1025           current_frame.push_stack(
1026             VerificationType::float_type(), CHECK_VERIFY(this));
1027           no_control_flow = false; break;
1028         case Bytecodes::_daload :
1029           type = current_frame.pop_stack(
1030             VerificationType::integer_type(), CHECK_VERIFY(this));
1031           atype = current_frame.pop_stack(
1032             VerificationType::reference_check(), CHECK_VERIFY(this));
1033           if (!atype.is_double_array()) {
1034             verify_error(ErrorContext::bad_type(bci,
1035                 current_frame.stack_top_ctx(), ref_ctx(&quot;[D&quot;)),
1036                 bad_type_msg, &quot;daload&quot;);
1037             return;
1038           }
1039           current_frame.push_stack_2(
1040             VerificationType::double_type(),
1041             VerificationType::double2_type(), CHECK_VERIFY(this));
1042           no_control_flow = false; break;
1043         case Bytecodes::_aaload : {
1044           type = current_frame.pop_stack(
1045             VerificationType::integer_type(), CHECK_VERIFY(this));
1046           atype = current_frame.pop_stack(
1047             VerificationType::reference_check(), CHECK_VERIFY(this));
<a name="6" id="anc6"></a><span class="line-modified">1048           if (!atype.is_nonscalar_array()) {</span>
1049             verify_error(ErrorContext::bad_type(bci,
1050                 current_frame.stack_top_ctx(),
1051                 TypeOrigin::implicit(VerificationType::reference_check())),
1052                 bad_type_msg, &quot;aaload&quot;);
1053             return;
1054           }
1055           if (atype.is_null()) {
1056             current_frame.push_stack(
1057               VerificationType::null_type(), CHECK_VERIFY(this));
1058           } else {
1059             VerificationType component =
1060               atype.get_component(this, CHECK_VERIFY(this));
1061             current_frame.push_stack(component, CHECK_VERIFY(this));
1062           }
1063           no_control_flow = false; break;
1064         }
1065         case Bytecodes::_istore :
1066           verify_istore(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
1067           no_control_flow = false; break;
1068         case Bytecodes::_istore_0 :
1069         case Bytecodes::_istore_1 :
1070         case Bytecodes::_istore_2 :
1071         case Bytecodes::_istore_3 :
1072           index = opcode - Bytecodes::_istore_0;
1073           verify_istore(index, &amp;current_frame, CHECK_VERIFY(this));
1074           no_control_flow = false; break;
1075         case Bytecodes::_lstore :
1076           verify_lstore(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
1077           no_control_flow = false; break;
1078         case Bytecodes::_lstore_0 :
1079         case Bytecodes::_lstore_1 :
1080         case Bytecodes::_lstore_2 :
1081         case Bytecodes::_lstore_3 :
1082           index = opcode - Bytecodes::_lstore_0;
1083           verify_lstore(index, &amp;current_frame, CHECK_VERIFY(this));
1084           no_control_flow = false; break;
1085         case Bytecodes::_fstore :
1086           verify_fstore(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
1087           no_control_flow = false; break;
1088         case Bytecodes::_fstore_0 :
1089         case Bytecodes::_fstore_1 :
1090         case Bytecodes::_fstore_2 :
1091         case Bytecodes::_fstore_3 :
1092           index = opcode - Bytecodes::_fstore_0;
1093           verify_fstore(index, &amp;current_frame, CHECK_VERIFY(this));
1094           no_control_flow = false; break;
1095         case Bytecodes::_dstore :
1096           verify_dstore(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
1097           no_control_flow = false; break;
1098         case Bytecodes::_dstore_0 :
1099         case Bytecodes::_dstore_1 :
1100         case Bytecodes::_dstore_2 :
1101         case Bytecodes::_dstore_3 :
1102           index = opcode - Bytecodes::_dstore_0;
1103           verify_dstore(index, &amp;current_frame, CHECK_VERIFY(this));
1104           no_control_flow = false; break;
1105         case Bytecodes::_astore :
1106           verify_astore(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
1107           no_control_flow = false; break;
1108         case Bytecodes::_astore_0 :
1109         case Bytecodes::_astore_1 :
1110         case Bytecodes::_astore_2 :
1111         case Bytecodes::_astore_3 :
1112           index = opcode - Bytecodes::_astore_0;
1113           verify_astore(index, &amp;current_frame, CHECK_VERIFY(this));
1114           no_control_flow = false; break;
1115         case Bytecodes::_iastore :
1116           type = current_frame.pop_stack(
1117             VerificationType::integer_type(), CHECK_VERIFY(this));
1118           type2 = current_frame.pop_stack(
1119             VerificationType::integer_type(), CHECK_VERIFY(this));
1120           atype = current_frame.pop_stack(
1121             VerificationType::reference_check(), CHECK_VERIFY(this));
1122           if (!atype.is_int_array()) {
1123             verify_error(ErrorContext::bad_type(bci,
1124                 current_frame.stack_top_ctx(), ref_ctx(&quot;[I&quot;)),
1125                 bad_type_msg, &quot;iastore&quot;);
1126             return;
1127           }
1128           no_control_flow = false; break;
1129         case Bytecodes::_bastore :
1130           type = current_frame.pop_stack(
1131             VerificationType::integer_type(), CHECK_VERIFY(this));
1132           type2 = current_frame.pop_stack(
1133             VerificationType::integer_type(), CHECK_VERIFY(this));
1134           atype = current_frame.pop_stack(
1135             VerificationType::reference_check(), CHECK_VERIFY(this));
1136           if (!atype.is_bool_array() &amp;&amp; !atype.is_byte_array()) {
1137             verify_error(
1138                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
1139                 bad_type_msg, &quot;bastore&quot;);
1140             return;
1141           }
1142           no_control_flow = false; break;
1143         case Bytecodes::_castore :
1144           current_frame.pop_stack(
1145             VerificationType::integer_type(), CHECK_VERIFY(this));
1146           current_frame.pop_stack(
1147             VerificationType::integer_type(), CHECK_VERIFY(this));
1148           atype = current_frame.pop_stack(
1149             VerificationType::reference_check(), CHECK_VERIFY(this));
1150           if (!atype.is_char_array()) {
1151             verify_error(ErrorContext::bad_type(bci,
1152                 current_frame.stack_top_ctx(), ref_ctx(&quot;[C&quot;)),
1153                 bad_type_msg, &quot;castore&quot;);
1154             return;
1155           }
1156           no_control_flow = false; break;
1157         case Bytecodes::_sastore :
1158           current_frame.pop_stack(
1159             VerificationType::integer_type(), CHECK_VERIFY(this));
1160           current_frame.pop_stack(
1161             VerificationType::integer_type(), CHECK_VERIFY(this));
1162           atype = current_frame.pop_stack(
1163             VerificationType::reference_check(), CHECK_VERIFY(this));
1164           if (!atype.is_short_array()) {
1165             verify_error(ErrorContext::bad_type(bci,
1166                 current_frame.stack_top_ctx(), ref_ctx(&quot;[S&quot;)),
1167                 bad_type_msg, &quot;sastore&quot;);
1168             return;
1169           }
1170           no_control_flow = false; break;
1171         case Bytecodes::_lastore :
1172           current_frame.pop_stack_2(
1173             VerificationType::long2_type(),
1174             VerificationType::long_type(), CHECK_VERIFY(this));
1175           current_frame.pop_stack(
1176             VerificationType::integer_type(), CHECK_VERIFY(this));
1177           atype = current_frame.pop_stack(
1178             VerificationType::reference_check(), CHECK_VERIFY(this));
1179           if (!atype.is_long_array()) {
1180             verify_error(ErrorContext::bad_type(bci,
1181                 current_frame.stack_top_ctx(), ref_ctx(&quot;[J&quot;)),
1182                 bad_type_msg, &quot;lastore&quot;);
1183             return;
1184           }
1185           no_control_flow = false; break;
1186         case Bytecodes::_fastore :
1187           current_frame.pop_stack(
1188             VerificationType::float_type(), CHECK_VERIFY(this));
1189           current_frame.pop_stack
1190             (VerificationType::integer_type(), CHECK_VERIFY(this));
1191           atype = current_frame.pop_stack(
1192             VerificationType::reference_check(), CHECK_VERIFY(this));
1193           if (!atype.is_float_array()) {
1194             verify_error(ErrorContext::bad_type(bci,
1195                 current_frame.stack_top_ctx(), ref_ctx(&quot;[F&quot;)),
1196                 bad_type_msg, &quot;fastore&quot;);
1197             return;
1198           }
1199           no_control_flow = false; break;
1200         case Bytecodes::_dastore :
1201           current_frame.pop_stack_2(
1202             VerificationType::double2_type(),
1203             VerificationType::double_type(), CHECK_VERIFY(this));
1204           current_frame.pop_stack(
1205             VerificationType::integer_type(), CHECK_VERIFY(this));
1206           atype = current_frame.pop_stack(
1207             VerificationType::reference_check(), CHECK_VERIFY(this));
1208           if (!atype.is_double_array()) {
1209             verify_error(ErrorContext::bad_type(bci,
1210                 current_frame.stack_top_ctx(), ref_ctx(&quot;[D&quot;)),
1211                 bad_type_msg, &quot;dastore&quot;);
1212             return;
1213           }
1214           no_control_flow = false; break;
1215         case Bytecodes::_aastore :
1216           type = current_frame.pop_stack(object_type(), CHECK_VERIFY(this));
1217           type2 = current_frame.pop_stack(
1218             VerificationType::integer_type(), CHECK_VERIFY(this));
1219           atype = current_frame.pop_stack(
1220             VerificationType::reference_check(), CHECK_VERIFY(this));
1221           // more type-checking is done at runtime
<a name="7" id="anc7"></a><span class="line-modified">1222           if (!atype.is_nonscalar_array()) {</span>
1223             verify_error(ErrorContext::bad_type(bci,
1224                 current_frame.stack_top_ctx(),
1225                 TypeOrigin::implicit(VerificationType::reference_check())),
1226                 bad_type_msg, &quot;aastore&quot;);
1227             return;
1228           }
1229           // 4938384: relaxed constraint in JVMS 3nd edition.
1230           no_control_flow = false; break;
1231         case Bytecodes::_pop :
1232           current_frame.pop_stack(
1233             VerificationType::category1_check(), CHECK_VERIFY(this));
1234           no_control_flow = false; break;
1235         case Bytecodes::_pop2 :
1236           type = current_frame.pop_stack(CHECK_VERIFY(this));
1237           if (type.is_category1()) {
1238             current_frame.pop_stack(
1239               VerificationType::category1_check(), CHECK_VERIFY(this));
1240           } else if (type.is_category2_2nd()) {
1241             current_frame.pop_stack(
1242               VerificationType::category2_check(), CHECK_VERIFY(this));
1243           } else {
1244             /* Unreachable? Would need a category2_1st on TOS
1245              * which does not appear possible. */
1246             verify_error(
1247                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
1248                 bad_type_msg, &quot;pop2&quot;);
1249             return;
1250           }
1251           no_control_flow = false; break;
1252         case Bytecodes::_dup :
1253           type = current_frame.pop_stack(
1254             VerificationType::category1_check(), CHECK_VERIFY(this));
1255           current_frame.push_stack(type, CHECK_VERIFY(this));
1256           current_frame.push_stack(type, CHECK_VERIFY(this));
1257           no_control_flow = false; break;
1258         case Bytecodes::_dup_x1 :
1259           type = current_frame.pop_stack(
1260             VerificationType::category1_check(), CHECK_VERIFY(this));
1261           type2 = current_frame.pop_stack(
1262             VerificationType::category1_check(), CHECK_VERIFY(this));
1263           current_frame.push_stack(type, CHECK_VERIFY(this));
1264           current_frame.push_stack(type2, CHECK_VERIFY(this));
1265           current_frame.push_stack(type, CHECK_VERIFY(this));
1266           no_control_flow = false; break;
1267         case Bytecodes::_dup_x2 :
1268         {
1269           VerificationType type3;
1270           type = current_frame.pop_stack(
1271             VerificationType::category1_check(), CHECK_VERIFY(this));
1272           type2 = current_frame.pop_stack(CHECK_VERIFY(this));
1273           if (type2.is_category1()) {
1274             type3 = current_frame.pop_stack(
1275               VerificationType::category1_check(), CHECK_VERIFY(this));
1276           } else if (type2.is_category2_2nd()) {
1277             type3 = current_frame.pop_stack(
1278               VerificationType::category2_check(), CHECK_VERIFY(this));
1279           } else {
1280             /* Unreachable? Would need a category2_1st at stack depth 2 with
1281              * a category1 on TOS which does not appear possible. */
1282             verify_error(ErrorContext::bad_type(
1283                 bci, current_frame.stack_top_ctx()), bad_type_msg, &quot;dup_x2&quot;);
1284             return;
1285           }
1286           current_frame.push_stack(type, CHECK_VERIFY(this));
1287           current_frame.push_stack(type3, CHECK_VERIFY(this));
1288           current_frame.push_stack(type2, CHECK_VERIFY(this));
1289           current_frame.push_stack(type, CHECK_VERIFY(this));
1290           no_control_flow = false; break;
1291         }
1292         case Bytecodes::_dup2 :
1293           type = current_frame.pop_stack(CHECK_VERIFY(this));
1294           if (type.is_category1()) {
1295             type2 = current_frame.pop_stack(
1296               VerificationType::category1_check(), CHECK_VERIFY(this));
1297           } else if (type.is_category2_2nd()) {
1298             type2 = current_frame.pop_stack(
1299               VerificationType::category2_check(), CHECK_VERIFY(this));
1300           } else {
1301             /* Unreachable?  Would need a category2_1st on TOS which does not
1302              * appear possible. */
1303             verify_error(
1304                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
1305                 bad_type_msg, &quot;dup2&quot;);
1306             return;
1307           }
1308           current_frame.push_stack(type2, CHECK_VERIFY(this));
1309           current_frame.push_stack(type, CHECK_VERIFY(this));
1310           current_frame.push_stack(type2, CHECK_VERIFY(this));
1311           current_frame.push_stack(type, CHECK_VERIFY(this));
1312           no_control_flow = false; break;
1313         case Bytecodes::_dup2_x1 :
1314         {
1315           VerificationType type3;
1316           type = current_frame.pop_stack(CHECK_VERIFY(this));
1317           if (type.is_category1()) {
1318             type2 = current_frame.pop_stack(
1319               VerificationType::category1_check(), CHECK_VERIFY(this));
1320           } else if (type.is_category2_2nd()) {
1321             type2 = current_frame.pop_stack(
1322               VerificationType::category2_check(), CHECK_VERIFY(this));
1323           } else {
1324             /* Unreachable?  Would need a category2_1st on TOS which does
1325              * not appear possible. */
1326             verify_error(
1327                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
1328                 bad_type_msg, &quot;dup2_x1&quot;);
1329             return;
1330           }
1331           type3 = current_frame.pop_stack(
1332             VerificationType::category1_check(), CHECK_VERIFY(this));
1333           current_frame.push_stack(type2, CHECK_VERIFY(this));
1334           current_frame.push_stack(type, CHECK_VERIFY(this));
1335           current_frame.push_stack(type3, CHECK_VERIFY(this));
1336           current_frame.push_stack(type2, CHECK_VERIFY(this));
1337           current_frame.push_stack(type, CHECK_VERIFY(this));
1338           no_control_flow = false; break;
1339         }
1340         case Bytecodes::_dup2_x2 :
1341         {
1342           VerificationType type3, type4;
1343           type = current_frame.pop_stack(CHECK_VERIFY(this));
1344           if (type.is_category1()) {
1345             type2 = current_frame.pop_stack(
1346               VerificationType::category1_check(), CHECK_VERIFY(this));
1347           } else if (type.is_category2_2nd()) {
1348             type2 = current_frame.pop_stack(
1349               VerificationType::category2_check(), CHECK_VERIFY(this));
1350           } else {
1351             /* Unreachable?  Would need a category2_1st on TOS which does
1352              * not appear possible. */
1353             verify_error(
1354                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
1355                 bad_type_msg, &quot;dup2_x2&quot;);
1356             return;
1357           }
1358           type3 = current_frame.pop_stack(CHECK_VERIFY(this));
1359           if (type3.is_category1()) {
1360             type4 = current_frame.pop_stack(
1361               VerificationType::category1_check(), CHECK_VERIFY(this));
1362           } else if (type3.is_category2_2nd()) {
1363             type4 = current_frame.pop_stack(
1364               VerificationType::category2_check(), CHECK_VERIFY(this));
1365           } else {
1366             /* Unreachable?  Would need a category2_1st on TOS after popping
1367              * a long/double or two category 1&#39;s, which does not
1368              * appear possible. */
1369             verify_error(
1370                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
1371                 bad_type_msg, &quot;dup2_x2&quot;);
1372             return;
1373           }
1374           current_frame.push_stack(type2, CHECK_VERIFY(this));
1375           current_frame.push_stack(type, CHECK_VERIFY(this));
1376           current_frame.push_stack(type4, CHECK_VERIFY(this));
1377           current_frame.push_stack(type3, CHECK_VERIFY(this));
1378           current_frame.push_stack(type2, CHECK_VERIFY(this));
1379           current_frame.push_stack(type, CHECK_VERIFY(this));
1380           no_control_flow = false; break;
1381         }
1382         case Bytecodes::_swap :
1383           type = current_frame.pop_stack(
1384             VerificationType::category1_check(), CHECK_VERIFY(this));
1385           type2 = current_frame.pop_stack(
1386             VerificationType::category1_check(), CHECK_VERIFY(this));
1387           current_frame.push_stack(type, CHECK_VERIFY(this));
1388           current_frame.push_stack(type2, CHECK_VERIFY(this));
1389           no_control_flow = false; break;
1390         case Bytecodes::_iadd :
1391         case Bytecodes::_isub :
1392         case Bytecodes::_imul :
1393         case Bytecodes::_idiv :
1394         case Bytecodes::_irem :
1395         case Bytecodes::_ishl :
1396         case Bytecodes::_ishr :
1397         case Bytecodes::_iushr :
1398         case Bytecodes::_ior :
1399         case Bytecodes::_ixor :
1400         case Bytecodes::_iand :
1401           current_frame.pop_stack(
1402             VerificationType::integer_type(), CHECK_VERIFY(this));
1403           // fall through
1404         case Bytecodes::_ineg :
1405           current_frame.pop_stack(
1406             VerificationType::integer_type(), CHECK_VERIFY(this));
1407           current_frame.push_stack(
1408             VerificationType::integer_type(), CHECK_VERIFY(this));
1409           no_control_flow = false; break;
1410         case Bytecodes::_ladd :
1411         case Bytecodes::_lsub :
1412         case Bytecodes::_lmul :
1413         case Bytecodes::_ldiv :
1414         case Bytecodes::_lrem :
1415         case Bytecodes::_land :
1416         case Bytecodes::_lor :
1417         case Bytecodes::_lxor :
1418           current_frame.pop_stack_2(
1419             VerificationType::long2_type(),
1420             VerificationType::long_type(), CHECK_VERIFY(this));
1421           // fall through
1422         case Bytecodes::_lneg :
1423           current_frame.pop_stack_2(
1424             VerificationType::long2_type(),
1425             VerificationType::long_type(), CHECK_VERIFY(this));
1426           current_frame.push_stack_2(
1427             VerificationType::long_type(),
1428             VerificationType::long2_type(), CHECK_VERIFY(this));
1429           no_control_flow = false; break;
1430         case Bytecodes::_lshl :
1431         case Bytecodes::_lshr :
1432         case Bytecodes::_lushr :
1433           current_frame.pop_stack(
1434             VerificationType::integer_type(), CHECK_VERIFY(this));
1435           current_frame.pop_stack_2(
1436             VerificationType::long2_type(),
1437             VerificationType::long_type(), CHECK_VERIFY(this));
1438           current_frame.push_stack_2(
1439             VerificationType::long_type(),
1440             VerificationType::long2_type(), CHECK_VERIFY(this));
1441           no_control_flow = false; break;
1442         case Bytecodes::_fadd :
1443         case Bytecodes::_fsub :
1444         case Bytecodes::_fmul :
1445         case Bytecodes::_fdiv :
1446         case Bytecodes::_frem :
1447           current_frame.pop_stack(
1448             VerificationType::float_type(), CHECK_VERIFY(this));
1449           // fall through
1450         case Bytecodes::_fneg :
1451           current_frame.pop_stack(
1452             VerificationType::float_type(), CHECK_VERIFY(this));
1453           current_frame.push_stack(
1454             VerificationType::float_type(), CHECK_VERIFY(this));
1455           no_control_flow = false; break;
1456         case Bytecodes::_dadd :
1457         case Bytecodes::_dsub :
1458         case Bytecodes::_dmul :
1459         case Bytecodes::_ddiv :
1460         case Bytecodes::_drem :
1461           current_frame.pop_stack_2(
1462             VerificationType::double2_type(),
1463             VerificationType::double_type(), CHECK_VERIFY(this));
1464           // fall through
1465         case Bytecodes::_dneg :
1466           current_frame.pop_stack_2(
1467             VerificationType::double2_type(),
1468             VerificationType::double_type(), CHECK_VERIFY(this));
1469           current_frame.push_stack_2(
1470             VerificationType::double_type(),
1471             VerificationType::double2_type(), CHECK_VERIFY(this));
1472           no_control_flow = false; break;
1473         case Bytecodes::_iinc :
1474           verify_iinc(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
1475           no_control_flow = false; break;
1476         case Bytecodes::_i2l :
1477           type = current_frame.pop_stack(
1478             VerificationType::integer_type(), CHECK_VERIFY(this));
1479           current_frame.push_stack_2(
1480             VerificationType::long_type(),
1481             VerificationType::long2_type(), CHECK_VERIFY(this));
1482           no_control_flow = false; break;
1483        case Bytecodes::_l2i :
1484           current_frame.pop_stack_2(
1485             VerificationType::long2_type(),
1486             VerificationType::long_type(), CHECK_VERIFY(this));
1487           current_frame.push_stack(
1488             VerificationType::integer_type(), CHECK_VERIFY(this));
1489           no_control_flow = false; break;
1490         case Bytecodes::_i2f :
1491           current_frame.pop_stack(
1492             VerificationType::integer_type(), CHECK_VERIFY(this));
1493           current_frame.push_stack(
1494             VerificationType::float_type(), CHECK_VERIFY(this));
1495           no_control_flow = false; break;
1496         case Bytecodes::_i2d :
1497           current_frame.pop_stack(
1498             VerificationType::integer_type(), CHECK_VERIFY(this));
1499           current_frame.push_stack_2(
1500             VerificationType::double_type(),
1501             VerificationType::double2_type(), CHECK_VERIFY(this));
1502           no_control_flow = false; break;
1503         case Bytecodes::_l2f :
1504           current_frame.pop_stack_2(
1505             VerificationType::long2_type(),
1506             VerificationType::long_type(), CHECK_VERIFY(this));
1507           current_frame.push_stack(
1508             VerificationType::float_type(), CHECK_VERIFY(this));
1509           no_control_flow = false; break;
1510         case Bytecodes::_l2d :
1511           current_frame.pop_stack_2(
1512             VerificationType::long2_type(),
1513             VerificationType::long_type(), CHECK_VERIFY(this));
1514           current_frame.push_stack_2(
1515             VerificationType::double_type(),
1516             VerificationType::double2_type(), CHECK_VERIFY(this));
1517           no_control_flow = false; break;
1518         case Bytecodes::_f2i :
1519           current_frame.pop_stack(
1520             VerificationType::float_type(), CHECK_VERIFY(this));
1521           current_frame.push_stack(
1522             VerificationType::integer_type(), CHECK_VERIFY(this));
1523           no_control_flow = false; break;
1524         case Bytecodes::_f2l :
1525           current_frame.pop_stack(
1526             VerificationType::float_type(), CHECK_VERIFY(this));
1527           current_frame.push_stack_2(
1528             VerificationType::long_type(),
1529             VerificationType::long2_type(), CHECK_VERIFY(this));
1530           no_control_flow = false; break;
1531         case Bytecodes::_f2d :
1532           current_frame.pop_stack(
1533             VerificationType::float_type(), CHECK_VERIFY(this));
1534           current_frame.push_stack_2(
1535             VerificationType::double_type(),
1536             VerificationType::double2_type(), CHECK_VERIFY(this));
1537           no_control_flow = false; break;
1538         case Bytecodes::_d2i :
1539           current_frame.pop_stack_2(
1540             VerificationType::double2_type(),
1541             VerificationType::double_type(), CHECK_VERIFY(this));
1542           current_frame.push_stack(
1543             VerificationType::integer_type(), CHECK_VERIFY(this));
1544           no_control_flow = false; break;
1545         case Bytecodes::_d2l :
1546           current_frame.pop_stack_2(
1547             VerificationType::double2_type(),
1548             VerificationType::double_type(), CHECK_VERIFY(this));
1549           current_frame.push_stack_2(
1550             VerificationType::long_type(),
1551             VerificationType::long2_type(), CHECK_VERIFY(this));
1552           no_control_flow = false; break;
1553         case Bytecodes::_d2f :
1554           current_frame.pop_stack_2(
1555             VerificationType::double2_type(),
1556             VerificationType::double_type(), CHECK_VERIFY(this));
1557           current_frame.push_stack(
1558             VerificationType::float_type(), CHECK_VERIFY(this));
1559           no_control_flow = false; break;
1560         case Bytecodes::_i2b :
1561         case Bytecodes::_i2c :
1562         case Bytecodes::_i2s :
1563           current_frame.pop_stack(
1564             VerificationType::integer_type(), CHECK_VERIFY(this));
1565           current_frame.push_stack(
1566             VerificationType::integer_type(), CHECK_VERIFY(this));
1567           no_control_flow = false; break;
1568         case Bytecodes::_lcmp :
1569           current_frame.pop_stack_2(
1570             VerificationType::long2_type(),
1571             VerificationType::long_type(), CHECK_VERIFY(this));
1572           current_frame.pop_stack_2(
1573             VerificationType::long2_type(),
1574             VerificationType::long_type(), CHECK_VERIFY(this));
1575           current_frame.push_stack(
1576             VerificationType::integer_type(), CHECK_VERIFY(this));
1577           no_control_flow = false; break;
1578         case Bytecodes::_fcmpl :
1579         case Bytecodes::_fcmpg :
1580           current_frame.pop_stack(
1581             VerificationType::float_type(), CHECK_VERIFY(this));
1582           current_frame.pop_stack(
1583             VerificationType::float_type(), CHECK_VERIFY(this));
1584           current_frame.push_stack(
1585             VerificationType::integer_type(), CHECK_VERIFY(this));
1586           no_control_flow = false; break;
1587         case Bytecodes::_dcmpl :
1588         case Bytecodes::_dcmpg :
1589           current_frame.pop_stack_2(
1590             VerificationType::double2_type(),
1591             VerificationType::double_type(), CHECK_VERIFY(this));
1592           current_frame.pop_stack_2(
1593             VerificationType::double2_type(),
1594             VerificationType::double_type(), CHECK_VERIFY(this));
1595           current_frame.push_stack(
1596             VerificationType::integer_type(), CHECK_VERIFY(this));
1597           no_control_flow = false; break;
1598         case Bytecodes::_if_icmpeq:
1599         case Bytecodes::_if_icmpne:
1600         case Bytecodes::_if_icmplt:
1601         case Bytecodes::_if_icmpge:
1602         case Bytecodes::_if_icmpgt:
1603         case Bytecodes::_if_icmple:
1604           current_frame.pop_stack(
1605             VerificationType::integer_type(), CHECK_VERIFY(this));
1606           // fall through
1607         case Bytecodes::_ifeq:
1608         case Bytecodes::_ifne:
1609         case Bytecodes::_iflt:
1610         case Bytecodes::_ifge:
1611         case Bytecodes::_ifgt:
1612         case Bytecodes::_ifle:
1613           current_frame.pop_stack(
1614             VerificationType::integer_type(), CHECK_VERIFY(this));
1615           target = bcs.dest();
1616           stackmap_table.check_jump_target(
1617             &amp;current_frame, target, CHECK_VERIFY(this));
1618           no_control_flow = false; break;
1619         case Bytecodes::_if_acmpeq :
1620         case Bytecodes::_if_acmpne :
1621           current_frame.pop_stack(
<a name="8" id="anc8"></a><span class="line-modified">1622             VerificationType::nonscalar_check(), CHECK_VERIFY(this));</span>
1623           // fall through
1624         case Bytecodes::_ifnull :
1625         case Bytecodes::_ifnonnull :
1626           current_frame.pop_stack(
<a name="9" id="anc9"></a><span class="line-modified">1627             VerificationType::nonscalar_check(), CHECK_VERIFY(this));</span>
1628           target = bcs.dest();
1629           stackmap_table.check_jump_target
1630             (&amp;current_frame, target, CHECK_VERIFY(this));
1631           no_control_flow = false; break;
1632         case Bytecodes::_goto :
1633           target = bcs.dest();
1634           stackmap_table.check_jump_target(
1635             &amp;current_frame, target, CHECK_VERIFY(this));
1636           no_control_flow = true; break;
1637         case Bytecodes::_goto_w :
1638           target = bcs.dest_w();
1639           stackmap_table.check_jump_target(
1640             &amp;current_frame, target, CHECK_VERIFY(this));
1641           no_control_flow = true; break;
1642         case Bytecodes::_tableswitch :
1643         case Bytecodes::_lookupswitch :
1644           verify_switch(
1645             &amp;bcs, code_length, code_data, &amp;current_frame,
1646             &amp;stackmap_table, CHECK_VERIFY(this));
1647           no_control_flow = true; break;
1648         case Bytecodes::_ireturn :
1649           type = current_frame.pop_stack(
1650             VerificationType::integer_type(), CHECK_VERIFY(this));
1651           verify_return_value(return_type, type, bci,
1652                               &amp;current_frame, CHECK_VERIFY(this));
1653           no_control_flow = true; break;
1654         case Bytecodes::_lreturn :
1655           type2 = current_frame.pop_stack(
1656             VerificationType::long2_type(), CHECK_VERIFY(this));
1657           type = current_frame.pop_stack(
1658             VerificationType::long_type(), CHECK_VERIFY(this));
1659           verify_return_value(return_type, type, bci,
1660                               &amp;current_frame, CHECK_VERIFY(this));
1661           no_control_flow = true; break;
1662         case Bytecodes::_freturn :
1663           type = current_frame.pop_stack(
1664             VerificationType::float_type(), CHECK_VERIFY(this));
1665           verify_return_value(return_type, type, bci,
1666                               &amp;current_frame, CHECK_VERIFY(this));
1667           no_control_flow = true; break;
1668         case Bytecodes::_dreturn :
1669           type2 = current_frame.pop_stack(
1670             VerificationType::double2_type(),  CHECK_VERIFY(this));
1671           type = current_frame.pop_stack(
1672             VerificationType::double_type(), CHECK_VERIFY(this));
1673           verify_return_value(return_type, type, bci,
1674                               &amp;current_frame, CHECK_VERIFY(this));
1675           no_control_flow = true; break;
1676         case Bytecodes::_areturn :
1677           type = current_frame.pop_stack(
<a name="10" id="anc10"></a><span class="line-modified">1678             VerificationType::nonscalar_check(), CHECK_VERIFY(this));</span>
1679           verify_return_value(return_type, type, bci,
1680                               &amp;current_frame, CHECK_VERIFY(this));
1681           no_control_flow = true; break;
1682         case Bytecodes::_return :
1683           if (return_type != VerificationType::bogus_type()) {
1684             verify_error(ErrorContext::bad_code(bci),
1685                          &quot;Method expects a return value&quot;);
1686             return;
1687           }
1688           // Make sure &quot;this&quot; has been initialized if current method is an
1689           // &lt;init&gt;.
<a name="11" id="anc11"></a><span class="line-modified">1690           if (_method-&gt;is_object_constructor() &amp;&amp;</span>
1691               current_frame.flag_this_uninit()) {
1692             verify_error(ErrorContext::bad_code(bci),
1693                          &quot;Constructor must call super() or this() &quot;
1694                          &quot;before return&quot;);
1695             return;
1696           }
1697           no_control_flow = true; break;
1698         case Bytecodes::_getstatic :
1699         case Bytecodes::_putstatic :
1700           // pass TRUE, operand can be an array type for getstatic/putstatic.
1701           verify_field_instructions(
1702             &amp;bcs, &amp;current_frame, cp, true, CHECK_VERIFY(this));
1703           no_control_flow = false; break;
1704         case Bytecodes::_getfield :
1705         case Bytecodes::_putfield :
1706           // pass FALSE, operand can&#39;t be an array type for getfield/putfield.
1707           verify_field_instructions(
1708             &amp;bcs, &amp;current_frame, cp, false, CHECK_VERIFY(this));
1709           no_control_flow = false; break;
<a name="12" id="anc12"></a><span class="line-added">1710         case Bytecodes::_withfield :</span>
<span class="line-added">1711           if (_klass-&gt;major_version() &lt; VALUETYPE_MAJOR_VERSION) {</span>
<span class="line-added">1712             class_format_error(</span>
<span class="line-added">1713               &quot;withfield not supported by this class file version (%d.%d), class %s&quot;,</span>
<span class="line-added">1714               _klass-&gt;major_version(), _klass-&gt;minor_version(), _klass-&gt;external_name());</span>
<span class="line-added">1715             return;</span>
<span class="line-added">1716           }</span>
<span class="line-added">1717           // pass FALSE, operand can&#39;t be an array type for withfield.</span>
<span class="line-added">1718           verify_field_instructions(</span>
<span class="line-added">1719             &amp;bcs, &amp;current_frame, cp, false, CHECK_VERIFY(this));</span>
<span class="line-added">1720           no_control_flow = false; break;</span>
1721         case Bytecodes::_invokevirtual :
1722         case Bytecodes::_invokespecial :
1723         case Bytecodes::_invokestatic :
<a name="13" id="anc13"></a>



1724         case Bytecodes::_invokeinterface :
1725         case Bytecodes::_invokedynamic :
1726           verify_invoke_instructions(
1727             &amp;bcs, code_length, &amp;current_frame, (bci &gt;= ex_min &amp;&amp; bci &lt; ex_max),
<a name="14" id="anc14"></a><span class="line-modified">1728             &amp;this_uninit, cp, &amp;stackmap_table, CHECK_VERIFY(this));</span>
1729           no_control_flow = false; break;
1730         case Bytecodes::_new :
1731         {
1732           index = bcs.get_index_u2();
1733           verify_cp_class_type(bci, index, cp, CHECK_VERIFY(this));
1734           VerificationType new_class_type =
1735             cp_index_to_type(index, cp, CHECK_VERIFY(this));
1736           if (!new_class_type.is_object()) {
1737             verify_error(ErrorContext::bad_type(bci,
1738                 TypeOrigin::cp(index, new_class_type)),
1739                 &quot;Illegal new instruction&quot;);
1740             return;
1741           }
1742           type = VerificationType::uninitialized_type(bci);
1743           current_frame.push_stack(type, CHECK_VERIFY(this));
1744           no_control_flow = false; break;
1745         }
<a name="15" id="anc15"></a><span class="line-added">1746         case Bytecodes::_defaultvalue :</span>
<span class="line-added">1747         {</span>
<span class="line-added">1748           if (_klass-&gt;major_version() &lt; VALUETYPE_MAJOR_VERSION) {</span>
<span class="line-added">1749             class_format_error(</span>
<span class="line-added">1750               &quot;defaultvalue not supported by this class file version (%d.%d), class %s&quot;,</span>
<span class="line-added">1751               _klass-&gt;major_version(), _klass-&gt;minor_version(), _klass-&gt;external_name());</span>
<span class="line-added">1752             return;</span>
<span class="line-added">1753           }</span>
<span class="line-added">1754           index = bcs.get_index_u2();</span>
<span class="line-added">1755           verify_cp_class_type(bci, index, cp, CHECK_VERIFY(this));</span>
<span class="line-added">1756           VerificationType ref_type = cp_index_to_type(index, cp, CHECK_VERIFY(this));</span>
<span class="line-added">1757           if (!ref_type.is_object()) {</span>
<span class="line-added">1758             verify_error(ErrorContext::bad_type(bci,</span>
<span class="line-added">1759                 TypeOrigin::cp(index, ref_type)),</span>
<span class="line-added">1760                 &quot;Illegal defaultvalue instruction&quot;);</span>
<span class="line-added">1761             return;</span>
<span class="line-added">1762           }</span>
<span class="line-added">1763           VerificationType value_type =</span>
<span class="line-added">1764             VerificationType::change_ref_to_valuetype(ref_type);</span>
<span class="line-added">1765           current_frame.push_stack(value_type, CHECK_VERIFY(this));</span>
<span class="line-added">1766           no_control_flow = false; break;</span>
<span class="line-added">1767         }</span>
1768         case Bytecodes::_newarray :
1769           type = get_newarray_type(bcs.get_index(), bci, CHECK_VERIFY(this));
1770           current_frame.pop_stack(
1771             VerificationType::integer_type(),  CHECK_VERIFY(this));
1772           current_frame.push_stack(type, CHECK_VERIFY(this));
1773           no_control_flow = false; break;
1774         case Bytecodes::_anewarray :
1775           verify_anewarray(
1776             bci, bcs.get_index_u2(), cp, &amp;current_frame, CHECK_VERIFY(this));
1777           no_control_flow = false; break;
1778         case Bytecodes::_arraylength :
1779           type = current_frame.pop_stack(
1780             VerificationType::reference_check(), CHECK_VERIFY(this));
1781           if (!(type.is_null() || type.is_array())) {
1782             verify_error(ErrorContext::bad_type(
1783                 bci, current_frame.stack_top_ctx()),
1784                 bad_type_msg, &quot;arraylength&quot;);
1785           }
1786           current_frame.push_stack(
1787             VerificationType::integer_type(), CHECK_VERIFY(this));
1788           no_control_flow = false; break;
1789         case Bytecodes::_checkcast :
1790         {
1791           index = bcs.get_index_u2();
1792           verify_cp_class_type(bci, index, cp, CHECK_VERIFY(this));
1793           current_frame.pop_stack(object_type(), CHECK_VERIFY(this));
1794           VerificationType klass_type = cp_index_to_type(
1795             index, cp, CHECK_VERIFY(this));
1796           current_frame.push_stack(klass_type, CHECK_VERIFY(this));
1797           no_control_flow = false; break;
1798         }
1799         case Bytecodes::_instanceof : {
1800           index = bcs.get_index_u2();
1801           verify_cp_class_type(bci, index, cp, CHECK_VERIFY(this));
1802           current_frame.pop_stack(object_type(), CHECK_VERIFY(this));
1803           current_frame.push_stack(
1804             VerificationType::integer_type(), CHECK_VERIFY(this));
1805           no_control_flow = false; break;
1806         }
1807         case Bytecodes::_monitorenter :
<a name="16" id="anc16"></a><span class="line-modified">1808         case Bytecodes::_monitorexit : {</span>
<span class="line-modified">1809           VerificationType ref = current_frame.pop_stack(</span>
<span class="line-modified">1810             VerificationType::nonscalar_check(), CHECK_VERIFY(this));</span>
1811           no_control_flow = false; break;
<a name="17" id="anc17"></a><span class="line-added">1812         }</span>
1813         case Bytecodes::_multianewarray :
1814         {
1815           index = bcs.get_index_u2();
1816           u2 dim = *(bcs.bcp()+3);
1817           verify_cp_class_type(bci, index, cp, CHECK_VERIFY(this));
1818           VerificationType new_array_type =
1819             cp_index_to_type(index, cp, CHECK_VERIFY(this));
1820           if (!new_array_type.is_array()) {
1821             verify_error(ErrorContext::bad_type(bci,
1822                 TypeOrigin::cp(index, new_array_type)),
1823                 &quot;Illegal constant pool index in multianewarray instruction&quot;);
1824             return;
1825           }
1826           if (dim &lt; 1 || new_array_type.dimensions() &lt; dim) {
1827             verify_error(ErrorContext::bad_code(bci),
1828                 &quot;Illegal dimension in multianewarray instruction: %d&quot;, dim);
1829             return;
1830           }
1831           for (int i = 0; i &lt; dim; i++) {
1832             current_frame.pop_stack(
1833               VerificationType::integer_type(), CHECK_VERIFY(this));
1834           }
1835           current_frame.push_stack(new_array_type, CHECK_VERIFY(this));
1836           no_control_flow = false; break;
1837         }
1838         case Bytecodes::_athrow :
1839           type = VerificationType::reference_type(
1840             vmSymbols::java_lang_Throwable());
1841           current_frame.pop_stack(type, CHECK_VERIFY(this));
1842           no_control_flow = true; break;
1843         default:
1844           // We only need to check the valid bytecodes in class file.
1845           // And jsr and ret are not in the new class file format in JDK1.5.
1846           verify_error(ErrorContext::bad_code(bci),
1847               &quot;Bad instruction: %02x&quot;, opcode);
1848           no_control_flow = false;
1849           return;
1850       }  // end switch
1851     }  // end Merge with the next instruction
1852 
1853     // Look for possible jump target in exception handlers and see if it matches
1854     // current_frame.  Don&#39;t do this check if it has already been done (for
1855     // ([a,d,f,i,l]store* opcodes).  This check cannot be done earlier because
1856     // opcodes, such as invokespecial, may set the this_uninit flag.
1857     assert(!(verified_exc_handlers &amp;&amp; this_uninit),
1858       &quot;Exception handler targets got verified before this_uninit got set&quot;);
1859     if (!verified_exc_handlers &amp;&amp; bci &gt;= ex_min &amp;&amp; bci &lt; ex_max) {
1860       if (was_recursively_verified()) return;
1861       verify_exception_handler_targets(
1862         bci, this_uninit, &amp;current_frame, &amp;stackmap_table, CHECK_VERIFY(this));
1863     }
1864   } // end while
1865 
1866   // Make sure that control flow does not fall through end of the method
1867   if (!no_control_flow) {
1868     verify_error(ErrorContext::bad_code(code_length),
1869         &quot;Control flow falls through code end&quot;);
1870     return;
1871   }
1872 }
1873 
1874 #undef bad_type_message
1875 
1876 char* ClassVerifier::generate_code_data(const methodHandle&amp; m, u4 code_length, TRAPS) {
1877   char* code_data = NEW_RESOURCE_ARRAY(char, code_length);
1878   memset(code_data, 0, sizeof(char) * code_length);
1879   RawBytecodeStream bcs(m);
1880 
1881   while (!bcs.is_last_bytecode()) {
1882     if (bcs.raw_next() != Bytecodes::_illegal) {
1883       int bci = bcs.bci();
1884       if (bcs.raw_code() == Bytecodes::_new) {
1885         code_data[bci] = NEW_OFFSET;
1886       } else {
1887         code_data[bci] = BYTECODE_OFFSET;
1888       }
1889     } else {
1890       verify_error(ErrorContext::bad_code(bcs.bci()), &quot;Bad instruction&quot;);
1891       return NULL;
1892     }
1893   }
1894 
1895   return code_data;
1896 }
1897 
1898 // Since this method references the constant pool, call was_recursively_verified()
1899 // before calling this method to make sure a prior class load did not cause the
1900 // current class to get verified.
1901 void ClassVerifier::verify_exception_handler_table(u4 code_length, char* code_data, int&amp; min, int&amp; max, TRAPS) {
1902   ExceptionTable exhandlers(_method());
1903   int exlength = exhandlers.length();
1904   constantPoolHandle cp (THREAD, _method-&gt;constants());
1905 
1906   for(int i = 0; i &lt; exlength; i++) {
1907     u2 start_pc = exhandlers.start_pc(i);
1908     u2 end_pc = exhandlers.end_pc(i);
1909     u2 handler_pc = exhandlers.handler_pc(i);
1910     if (start_pc &gt;= code_length || code_data[start_pc] == 0) {
1911       class_format_error(&quot;Illegal exception table start_pc %d&quot;, start_pc);
1912       return;
1913     }
1914     if (end_pc != code_length) {   // special case: end_pc == code_length
1915       if (end_pc &gt; code_length || code_data[end_pc] == 0) {
1916         class_format_error(&quot;Illegal exception table end_pc %d&quot;, end_pc);
1917         return;
1918       }
1919     }
1920     if (handler_pc &gt;= code_length || code_data[handler_pc] == 0) {
1921       class_format_error(&quot;Illegal exception table handler_pc %d&quot;, handler_pc);
1922       return;
1923     }
1924     int catch_type_index = exhandlers.catch_type_index(i);
1925     if (catch_type_index != 0) {
1926       VerificationType catch_type = cp_index_to_type(
1927         catch_type_index, cp, CHECK_VERIFY(this));
1928       VerificationType throwable =
1929         VerificationType::reference_type(vmSymbols::java_lang_Throwable());
1930       bool is_subclass = throwable.is_assignable_from(
1931         catch_type, this, false, CHECK_VERIFY(this));
1932       if (!is_subclass) {
1933         // 4286534: should throw VerifyError according to recent spec change
1934         verify_error(ErrorContext::bad_type(handler_pc,
1935             TypeOrigin::cp(catch_type_index, catch_type),
1936             TypeOrigin::implicit(throwable)),
1937             &quot;Catch type is not a subclass &quot;
1938             &quot;of Throwable in exception handler %d&quot;, handler_pc);
1939         return;
1940       }
1941     }
1942     if (start_pc &lt; min) min = start_pc;
1943     if (end_pc &gt; max) max = end_pc;
1944   }
1945 }
1946 
1947 void ClassVerifier::verify_local_variable_table(u4 code_length, char* code_data, TRAPS) {
1948   int localvariable_table_length = _method-&gt;localvariable_table_length();
1949   if (localvariable_table_length &gt; 0) {
1950     LocalVariableTableElement* table = _method-&gt;localvariable_table_start();
1951     for (int i = 0; i &lt; localvariable_table_length; i++) {
1952       u2 start_bci = table[i].start_bci;
1953       u2 length = table[i].length;
1954 
1955       if (start_bci &gt;= code_length || code_data[start_bci] == 0) {
1956         class_format_error(
1957           &quot;Illegal local variable table start_pc %d&quot;, start_bci);
1958         return;
1959       }
1960       u4 end_bci = (u4)(start_bci + length);
1961       if (end_bci != code_length) {
1962         if (end_bci &gt;= code_length || code_data[end_bci] == 0) {
1963           class_format_error( &quot;Illegal local variable table length %d&quot;, length);
1964           return;
1965         }
1966       }
1967     }
1968   }
1969 }
1970 
1971 u2 ClassVerifier::verify_stackmap_table(u2 stackmap_index, u2 bci,
1972                                         StackMapFrame* current_frame,
1973                                         StackMapTable* stackmap_table,
1974                                         bool no_control_flow, TRAPS) {
1975   if (stackmap_index &lt; stackmap_table-&gt;get_frame_count()) {
1976     u2 this_offset = stackmap_table-&gt;get_offset(stackmap_index);
1977     if (no_control_flow &amp;&amp; this_offset &gt; bci) {
1978       verify_error(ErrorContext::missing_stackmap(bci),
1979                    &quot;Expecting a stack map frame&quot;);
1980       return 0;
1981     }
1982     if (this_offset == bci) {
1983       ErrorContext ctx;
1984       // See if current stack map can be assigned to the frame in table.
1985       // current_frame is the stackmap frame got from the last instruction.
1986       // If matched, current_frame will be updated by this method.
1987       bool matches = stackmap_table-&gt;match_stackmap(
1988         current_frame, this_offset, stackmap_index,
1989         !no_control_flow, true, &amp;ctx, CHECK_VERIFY_(this, 0));
1990       if (!matches) {
1991         // report type error
1992         verify_error(ctx, &quot;Instruction type does not match stack map&quot;);
1993         return 0;
1994       }
1995       stackmap_index++;
1996     } else if (this_offset &lt; bci) {
1997       // current_offset should have met this_offset.
1998       class_format_error(&quot;Bad stack map offset %d&quot;, this_offset);
1999       return 0;
2000     }
2001   } else if (no_control_flow) {
2002     verify_error(ErrorContext::bad_code(bci), &quot;Expecting a stack map frame&quot;);
2003     return 0;
2004   }
2005   return stackmap_index;
2006 }
2007 
2008 // Since this method references the constant pool, call was_recursively_verified()
2009 // before calling this method to make sure a prior class load did not cause the
2010 // current class to get verified.
2011 void ClassVerifier::verify_exception_handler_targets(u2 bci, bool this_uninit,
2012                                                      StackMapFrame* current_frame,
2013                                                      StackMapTable* stackmap_table, TRAPS) {
2014   constantPoolHandle cp (THREAD, _method-&gt;constants());
2015   ExceptionTable exhandlers(_method());
2016   int exlength = exhandlers.length();
2017   for(int i = 0; i &lt; exlength; i++) {
2018     u2 start_pc = exhandlers.start_pc(i);
2019     u2 end_pc = exhandlers.end_pc(i);
2020     u2 handler_pc = exhandlers.handler_pc(i);
2021     int catch_type_index = exhandlers.catch_type_index(i);
2022     if(bci &gt;= start_pc &amp;&amp; bci &lt; end_pc) {
2023       u1 flags = current_frame-&gt;flags();
2024       if (this_uninit) {  flags |= FLAG_THIS_UNINIT; }
2025       StackMapFrame* new_frame = current_frame-&gt;frame_in_exception_handler(flags);
2026       if (catch_type_index != 0) {
2027         if (was_recursively_verified()) return;
2028         // We know that this index refers to a subclass of Throwable
2029         VerificationType catch_type = cp_index_to_type(
2030           catch_type_index, cp, CHECK_VERIFY(this));
2031         new_frame-&gt;push_stack(catch_type, CHECK_VERIFY(this));
2032       } else {
2033         VerificationType throwable =
2034           VerificationType::reference_type(vmSymbols::java_lang_Throwable());
2035         new_frame-&gt;push_stack(throwable, CHECK_VERIFY(this));
2036       }
2037       ErrorContext ctx;
2038       bool matches = stackmap_table-&gt;match_stackmap(
2039         new_frame, handler_pc, true, false, &amp;ctx, CHECK_VERIFY(this));
2040       if (!matches) {
2041         verify_error(ctx, &quot;Stack map does not match the one at &quot;
2042             &quot;exception handler %d&quot;, handler_pc);
2043         return;
2044       }
2045     }
2046   }
2047 }
2048 
2049 void ClassVerifier::verify_cp_index(
2050     u2 bci, const constantPoolHandle&amp; cp, int index, TRAPS) {
2051   int nconstants = cp-&gt;length();
2052   if ((index &lt;= 0) || (index &gt;= nconstants)) {
2053     verify_error(ErrorContext::bad_cp_index(bci, index),
2054         &quot;Illegal constant pool index %d in class %s&quot;,
2055         index, cp-&gt;pool_holder()-&gt;external_name());
2056     return;
2057   }
2058 }
2059 
2060 void ClassVerifier::verify_cp_type(
2061     u2 bci, int index, const constantPoolHandle&amp; cp, unsigned int types, TRAPS) {
2062 
2063   // In some situations, bytecode rewriting may occur while we&#39;re verifying.
2064   // In this case, a constant pool cache exists and some indices refer to that
2065   // instead.  Be sure we don&#39;t pick up such indices by accident.
2066   // We must check was_recursively_verified() before we get here.
2067   guarantee(cp-&gt;cache() == NULL, &quot;not rewritten yet&quot;);
2068 
2069   verify_cp_index(bci, cp, index, CHECK_VERIFY(this));
2070   unsigned int tag = cp-&gt;tag_at(index).value();
<a name="18" id="anc18"></a><span class="line-added">2071 </span>
2072   if ((types &amp; (1 &lt;&lt; tag)) == 0) {
2073     verify_error(ErrorContext::bad_cp_index(bci, index),
2074       &quot;Illegal type at constant pool entry %d in class %s&quot;,
2075       index, cp-&gt;pool_holder()-&gt;external_name());
2076     return;
2077   }
2078 }
2079 
2080 void ClassVerifier::verify_cp_class_type(
2081     u2 bci, int index, const constantPoolHandle&amp; cp, TRAPS) {
2082   verify_cp_index(bci, cp, index, CHECK_VERIFY(this));
2083   constantTag tag = cp-&gt;tag_at(index);
2084   if (!tag.is_klass() &amp;&amp; !tag.is_unresolved_klass()) {
2085     verify_error(ErrorContext::bad_cp_index(bci, index),
2086         &quot;Illegal type at constant pool entry %d in class %s&quot;,
2087         index, cp-&gt;pool_holder()-&gt;external_name());
2088     return;
2089   }
2090 }
2091 
2092 void ClassVerifier::verify_error(ErrorContext ctx, const char* msg, ...) {
2093   stringStream ss;
2094 
2095   ctx.reset_frames();
2096   _exception_type = vmSymbols::java_lang_VerifyError();
2097   _error_context = ctx;
2098   va_list va;
2099   va_start(va, msg);
2100   ss.vprint(msg, va);
2101   va_end(va);
2102   _message = ss.as_string();
2103 #ifdef ASSERT
2104   ResourceMark rm;
2105   const char* exception_name = _exception_type-&gt;as_C_string();
2106   Exceptions::debug_check_abort(exception_name, NULL);
2107 #endif // ndef ASSERT
2108 }
2109 
2110 void ClassVerifier::class_format_error(const char* msg, ...) {
2111   stringStream ss;
2112   _exception_type = vmSymbols::java_lang_ClassFormatError();
2113   va_list va;
2114   va_start(va, msg);
2115   ss.vprint(msg, va);
2116   va_end(va);
2117   if (!_method.is_null()) {
2118     ss.print(&quot; in method &#39;&quot;);
2119     _method-&gt;print_external_name(&amp;ss);
2120     ss.print(&quot;&#39;&quot;);
2121   }
2122   _message = ss.as_string();
2123 }
2124 
2125 Klass* ClassVerifier::load_class(Symbol* name, TRAPS) {
2126   HandleMark hm(THREAD);
2127   // Get current loader and protection domain first.
2128   oop loader = current_class()-&gt;class_loader();
2129   oop protection_domain = current_class()-&gt;protection_domain();
2130 
2131   assert(name_in_supers(name, current_class()), &quot;name should be a super class&quot;);
2132 
2133   Klass* kls = SystemDictionary::resolve_or_fail(
2134     name, Handle(THREAD, loader), Handle(THREAD, protection_domain),
2135     true, THREAD);
2136 
2137   if (kls != NULL) {
2138     if (log_is_enabled(Debug, class, resolve)) {
2139       Verifier::trace_class_resolution(kls, current_class());
2140     }
2141   }
2142   return kls;
2143 }
2144 
2145 bool ClassVerifier::is_protected_access(InstanceKlass* this_class,
2146                                         Klass* target_class,
2147                                         Symbol* field_name,
2148                                         Symbol* field_sig,
2149                                         bool is_method) {
2150   NoSafepointVerifier nosafepoint;
2151 
2152   // If target class isn&#39;t a super class of this class, we don&#39;t worry about this case
2153   if (!this_class-&gt;is_subclass_of(target_class)) {
2154     return false;
2155   }
2156   // Check if the specified method or field is protected
2157   InstanceKlass* target_instance = InstanceKlass::cast(target_class);
2158   fieldDescriptor fd;
2159   if (is_method) {
2160     Method* m = target_instance-&gt;uncached_lookup_method(field_name, field_sig, Klass::find_overpass);
2161     if (m != NULL &amp;&amp; m-&gt;is_protected()) {
2162       if (!this_class-&gt;is_same_class_package(m-&gt;method_holder())) {
2163         return true;
2164       }
2165     }
2166   } else {
2167     Klass* member_klass = target_instance-&gt;find_field(field_name, field_sig, &amp;fd);
2168     if (member_klass != NULL &amp;&amp; fd.is_protected()) {
2169       if (!this_class-&gt;is_same_class_package(member_klass)) {
2170         return true;
2171       }
2172     }
2173   }
2174   return false;
2175 }
2176 
2177 void ClassVerifier::verify_ldc(
2178     int opcode, u2 index, StackMapFrame* current_frame,
2179     const constantPoolHandle&amp; cp, u2 bci, TRAPS) {
2180   verify_cp_index(bci, cp, index, CHECK_VERIFY(this));
2181   constantTag tag = cp-&gt;tag_at(index);
2182   unsigned int types = 0;
2183   if (opcode == Bytecodes::_ldc || opcode == Bytecodes::_ldc_w) {
2184     if (!tag.is_unresolved_klass()) {
2185       types = (1 &lt;&lt; JVM_CONSTANT_Integer) | (1 &lt;&lt; JVM_CONSTANT_Float)
<a name="19" id="anc19"></a><span class="line-modified">2186             | (1 &lt;&lt; JVM_CONSTANT_String) | (1 &lt;&lt; JVM_CONSTANT_Class)</span>
2187             | (1 &lt;&lt; JVM_CONSTANT_MethodHandle) | (1 &lt;&lt; JVM_CONSTANT_MethodType)
2188             | (1 &lt;&lt; JVM_CONSTANT_Dynamic);
2189       // Note:  The class file parser already verified the legality of
2190       // MethodHandle and MethodType constants.
2191       verify_cp_type(bci, index, cp, types, CHECK_VERIFY(this));
2192     }
2193   } else {
2194     assert(opcode == Bytecodes::_ldc2_w, &quot;must be ldc2_w&quot;);
2195     types = (1 &lt;&lt; JVM_CONSTANT_Double) | (1 &lt;&lt; JVM_CONSTANT_Long)
2196           | (1 &lt;&lt; JVM_CONSTANT_Dynamic);
2197     verify_cp_type(bci, index, cp, types, CHECK_VERIFY(this));
2198   }
2199   if (tag.is_string() &amp;&amp; cp-&gt;is_pseudo_string_at(index)) {
2200     current_frame-&gt;push_stack(object_type(), CHECK_VERIFY(this));
2201   } else if (tag.is_string()) {
2202     current_frame-&gt;push_stack(
2203       VerificationType::reference_type(
2204         vmSymbols::java_lang_String()), CHECK_VERIFY(this));
2205   } else if (tag.is_klass() || tag.is_unresolved_klass()) {
2206     current_frame-&gt;push_stack(
2207       VerificationType::reference_type(
2208         vmSymbols::java_lang_Class()), CHECK_VERIFY(this));
2209   } else if (tag.is_int()) {
2210     current_frame-&gt;push_stack(
2211       VerificationType::integer_type(), CHECK_VERIFY(this));
2212   } else if (tag.is_float()) {
2213     current_frame-&gt;push_stack(
2214       VerificationType::float_type(), CHECK_VERIFY(this));
2215   } else if (tag.is_double()) {
2216     current_frame-&gt;push_stack_2(
2217       VerificationType::double_type(),
2218       VerificationType::double2_type(), CHECK_VERIFY(this));
2219   } else if (tag.is_long()) {
2220     current_frame-&gt;push_stack_2(
2221       VerificationType::long_type(),
2222       VerificationType::long2_type(), CHECK_VERIFY(this));
2223   } else if (tag.is_method_handle()) {
2224     current_frame-&gt;push_stack(
2225       VerificationType::reference_type(
2226         vmSymbols::java_lang_invoke_MethodHandle()), CHECK_VERIFY(this));
2227   } else if (tag.is_method_type()) {
2228     current_frame-&gt;push_stack(
2229       VerificationType::reference_type(
2230         vmSymbols::java_lang_invoke_MethodType()), CHECK_VERIFY(this));
2231   } else if (tag.is_dynamic_constant()) {
2232     Symbol* constant_type = cp-&gt;uncached_signature_ref_at(index);
2233     // Field signature was checked in ClassFileParser.
2234     assert(SignatureVerifier::is_valid_type_signature(constant_type),
2235            &quot;Invalid type for dynamic constant&quot;);
2236     assert(sizeof(VerificationType) == sizeof(uintptr_t),
2237           &quot;buffer type must match VerificationType size&quot;);
2238     uintptr_t constant_type_buffer[2];
2239     VerificationType* v_constant_type = (VerificationType*)constant_type_buffer;
2240     SignatureStream sig_stream(constant_type, false);
2241     int n = change_sig_to_verificationType(&amp;sig_stream, v_constant_type);
2242     int opcode_n = (opcode == Bytecodes::_ldc2_w ? 2 : 1);
2243     if (n != opcode_n) {
2244       // wrong kind of ldc; reverify against updated type mask
2245       types &amp;= ~(1 &lt;&lt; JVM_CONSTANT_Dynamic);
2246       verify_cp_type(bci, index, cp, types, CHECK_VERIFY(this));
2247     }
2248     for (int i = 0; i &lt; n; i++) {
2249       current_frame-&gt;push_stack(v_constant_type[i], CHECK_VERIFY(this));
2250     }
2251   } else {
2252     /* Unreachable? verify_cp_type has already validated the cp type. */
2253     verify_error(
2254         ErrorContext::bad_cp_index(bci, index), &quot;Invalid index in ldc&quot;);
2255     return;
2256   }
2257 }
2258 
2259 void ClassVerifier::verify_switch(
2260     RawBytecodeStream* bcs, u4 code_length, char* code_data,
2261     StackMapFrame* current_frame, StackMapTable* stackmap_table, TRAPS) {
2262   int bci = bcs-&gt;bci();
2263   address bcp = bcs-&gt;bcp();
2264   address aligned_bcp = align_up(bcp + 1, jintSize);
2265 
2266   if (_klass-&gt;major_version() &lt; NONZERO_PADDING_BYTES_IN_SWITCH_MAJOR_VERSION) {
2267     // 4639449 &amp; 4647081: padding bytes must be 0
2268     u2 padding_offset = 1;
2269     while ((bcp + padding_offset) &lt; aligned_bcp) {
2270       if(*(bcp + padding_offset) != 0) {
2271         verify_error(ErrorContext::bad_code(bci),
2272                      &quot;Nonzero padding byte in lookupswitch or tableswitch&quot;);
2273         return;
2274       }
2275       padding_offset++;
2276     }
2277   }
2278 
2279   int default_offset = (int) Bytes::get_Java_u4(aligned_bcp);
2280   int keys, delta;
2281   current_frame-&gt;pop_stack(
2282     VerificationType::integer_type(), CHECK_VERIFY(this));
2283   if (bcs-&gt;raw_code() == Bytecodes::_tableswitch) {
2284     jint low = (jint)Bytes::get_Java_u4(aligned_bcp + jintSize);
2285     jint high = (jint)Bytes::get_Java_u4(aligned_bcp + 2*jintSize);
2286     if (low &gt; high) {
2287       verify_error(ErrorContext::bad_code(bci),
2288           &quot;low must be less than or equal to high in tableswitch&quot;);
2289       return;
2290     }
2291     keys = high - low + 1;
2292     if (keys &lt; 0) {
2293       verify_error(ErrorContext::bad_code(bci), &quot;too many keys in tableswitch&quot;);
2294       return;
2295     }
2296     delta = 1;
2297   } else {
2298     keys = (int)Bytes::get_Java_u4(aligned_bcp + jintSize);
2299     if (keys &lt; 0) {
2300       verify_error(ErrorContext::bad_code(bci),
2301                    &quot;number of keys in lookupswitch less than 0&quot;);
2302       return;
2303     }
2304     delta = 2;
2305     // Make sure that the lookupswitch items are sorted
2306     for (int i = 0; i &lt; (keys - 1); i++) {
2307       jint this_key = Bytes::get_Java_u4(aligned_bcp + (2+2*i)*jintSize);
2308       jint next_key = Bytes::get_Java_u4(aligned_bcp + (2+2*i+2)*jintSize);
2309       if (this_key &gt;= next_key) {
2310         verify_error(ErrorContext::bad_code(bci),
2311                      &quot;Bad lookupswitch instruction&quot;);
2312         return;
2313       }
2314     }
2315   }
2316   int target = bci + default_offset;
2317   stackmap_table-&gt;check_jump_target(current_frame, target, CHECK_VERIFY(this));
2318   for (int i = 0; i &lt; keys; i++) {
2319     // Because check_jump_target() may safepoint, the bytecode could have
2320     // moved, which means &#39;aligned_bcp&#39; is no good and needs to be recalculated.
2321     aligned_bcp = align_up(bcs-&gt;bcp() + 1, jintSize);
2322     target = bci + (jint)Bytes::get_Java_u4(aligned_bcp+(3+i*delta)*jintSize);
2323     stackmap_table-&gt;check_jump_target(
2324       current_frame, target, CHECK_VERIFY(this));
2325   }
2326   NOT_PRODUCT(aligned_bcp = NULL);  // no longer valid at this point
2327 }
2328 
2329 bool ClassVerifier::name_in_supers(
2330     Symbol* ref_name, InstanceKlass* current) {
2331   Klass* super = current-&gt;super();
2332   while (super != NULL) {
2333     if (super-&gt;name() == ref_name) {
2334       return true;
2335     }
2336     super = super-&gt;super();
2337   }
2338   return false;
2339 }
2340 
2341 void ClassVerifier::verify_field_instructions(RawBytecodeStream* bcs,
2342                                               StackMapFrame* current_frame,
2343                                               const constantPoolHandle&amp; cp,
2344                                               bool allow_arrays,
2345                                               TRAPS) {
2346   u2 index = bcs-&gt;get_index_u2();
2347   verify_cp_type(bcs-&gt;bci(), index, cp,
2348       1 &lt;&lt; JVM_CONSTANT_Fieldref, CHECK_VERIFY(this));
2349 
2350   // Get field name and signature
2351   Symbol* field_name = cp-&gt;name_ref_at(index);
2352   Symbol* field_sig = cp-&gt;signature_ref_at(index);
2353 
2354   // Field signature was checked in ClassFileParser.
2355   assert(SignatureVerifier::is_valid_type_signature(field_sig),
2356          &quot;Invalid field signature&quot;);
2357 
2358   // Get referenced class type
2359   VerificationType ref_class_type = cp_ref_index_to_type(
2360     index, cp, CHECK_VERIFY(this));
2361   if (!ref_class_type.is_object() &amp;&amp;
<a name="20" id="anc20"></a><span class="line-modified">2362       (!allow_arrays || !ref_class_type.is_array())) {</span>
2363     verify_error(ErrorContext::bad_type(bcs-&gt;bci(),
2364         TypeOrigin::cp(index, ref_class_type)),
2365         &quot;Expecting reference to class in class %s at constant pool index %d&quot;,
2366         _klass-&gt;external_name(), index);
2367     return;
2368   }
<a name="21" id="anc21"></a><span class="line-added">2369 </span>
2370   VerificationType target_class_type = ref_class_type;
2371 
2372   assert(sizeof(VerificationType) == sizeof(uintptr_t),
2373         &quot;buffer type must match VerificationType size&quot;);
2374   uintptr_t field_type_buffer[2];
2375   VerificationType* field_type = (VerificationType*)field_type_buffer;
2376   // If we make a VerificationType[2] array directly, the compiler calls
2377   // to the c-runtime library to do the allocation instead of just
2378   // stack allocating it.  Plus it would run constructors.  This shows up
2379   // in performance profiles.
2380 
2381   SignatureStream sig_stream(field_sig, false);
2382   VerificationType stack_object_type;
2383   int n = change_sig_to_verificationType(&amp;sig_stream, field_type);
2384   u2 bci = bcs-&gt;bci();
2385   bool is_assignable;
2386   switch (bcs-&gt;raw_code()) {
2387     case Bytecodes::_getstatic: {
2388       for (int i = 0; i &lt; n; i++) {
2389         current_frame-&gt;push_stack(field_type[i], CHECK_VERIFY(this));
2390       }
2391       break;
2392     }
2393     case Bytecodes::_putstatic: {
2394       for (int i = n - 1; i &gt;= 0; i--) {
2395         current_frame-&gt;pop_stack(field_type[i], CHECK_VERIFY(this));
2396       }
2397       break;
2398     }
<a name="22" id="anc22"></a><span class="line-added">2399     case Bytecodes::_withfield: {</span>
<span class="line-added">2400       for (int i = n - 1; i &gt;= 0; i--) {</span>
<span class="line-added">2401         current_frame-&gt;pop_stack(field_type[i], CHECK_VERIFY(this));</span>
<span class="line-added">2402       }</span>
<span class="line-added">2403       // stack_object_type and target_class_type must be the same value type.</span>
<span class="line-added">2404       stack_object_type =</span>
<span class="line-added">2405         current_frame-&gt;pop_stack(VerificationType::valuetype_check(), CHECK_VERIFY(this));</span>
<span class="line-added">2406       VerificationType target_value_type =</span>
<span class="line-added">2407         VerificationType::change_ref_to_valuetype(target_class_type);</span>
<span class="line-added">2408       if (!stack_object_type.equals(target_value_type)) {</span>
<span class="line-added">2409         verify_error(ErrorContext::bad_value_type(bci,</span>
<span class="line-added">2410             current_frame-&gt;stack_top_ctx(),</span>
<span class="line-added">2411             TypeOrigin::cp(index, target_class_type)),</span>
<span class="line-added">2412             &quot;Invalid type on operand stack in withfield instruction&quot;);</span>
<span class="line-added">2413         return;</span>
<span class="line-added">2414       }</span>
<span class="line-added">2415       current_frame-&gt;push_stack(target_value_type, CHECK_VERIFY(this));</span>
<span class="line-added">2416       break;</span>
<span class="line-added">2417     }</span>
2418     case Bytecodes::_getfield: {
2419       stack_object_type = current_frame-&gt;pop_stack(
2420         target_class_type, CHECK_VERIFY(this));
2421       for (int i = 0; i &lt; n; i++) {
2422         current_frame-&gt;push_stack(field_type[i], CHECK_VERIFY(this));
2423       }
2424       goto check_protected;
2425     }
2426     case Bytecodes::_putfield: {
2427       for (int i = n - 1; i &gt;= 0; i--) {
2428         current_frame-&gt;pop_stack(field_type[i], CHECK_VERIFY(this));
2429       }
2430       stack_object_type = current_frame-&gt;pop_stack(CHECK_VERIFY(this));
2431 
2432       // The JVMS 2nd edition allows field initialization before the superclass
2433       // initializer, if the field is defined within the current class.
2434       fieldDescriptor fd;
2435       if (stack_object_type == VerificationType::uninitialized_this_type() &amp;&amp;
2436           target_class_type.equals(current_type()) &amp;&amp;
2437           _klass-&gt;find_local_field(field_name, field_sig, &amp;fd)) {
2438         stack_object_type = current_type();
2439       }
2440       is_assignable = target_class_type.is_assignable_from(
2441         stack_object_type, this, false, CHECK_VERIFY(this));
2442       if (!is_assignable) {
2443         verify_error(ErrorContext::bad_type(bci,
2444             current_frame-&gt;stack_top_ctx(),
2445             TypeOrigin::cp(index, target_class_type)),
2446             &quot;Bad type on operand stack in putfield&quot;);
2447         return;
2448       }
2449     }
2450     check_protected: {
2451       if (_this_type == stack_object_type)
2452         break; // stack_object_type must be assignable to _current_class_type
2453       if (was_recursively_verified()) return;
2454       Symbol* ref_class_name =
2455         cp-&gt;klass_name_at(cp-&gt;klass_ref_index_at(index));
2456       if (!name_in_supers(ref_class_name, current_class()))
2457         // stack_object_type must be assignable to _current_class_type since:
2458         // 1. stack_object_type must be assignable to ref_class.
2459         // 2. ref_class must be _current_class or a subclass of it. It can&#39;t
2460         //    be a superclass of it. See revised JVMS 5.4.4.
2461         break;
2462 
2463       Klass* ref_class_oop = load_class(ref_class_name, CHECK);
2464       if (is_protected_access(current_class(), ref_class_oop, field_name,
2465                               field_sig, false)) {
2466         // It&#39;s protected access, check if stack object is assignable to
2467         // current class.
2468         is_assignable = current_type().is_assignable_from(
2469           stack_object_type, this, true, CHECK_VERIFY(this));
2470         if (!is_assignable) {
2471           verify_error(ErrorContext::bad_type(bci,
2472               current_frame-&gt;stack_top_ctx(),
2473               TypeOrigin::implicit(current_type())),
2474               &quot;Bad access to protected data in getfield&quot;);
2475           return;
2476         }
2477       }
2478       break;
2479     }
2480     default: ShouldNotReachHere();
2481   }
2482 }
2483 
2484 // Look at the method&#39;s handlers.  If the bci is in the handler&#39;s try block
2485 // then check if the handler_pc is already on the stack.  If not, push it
2486 // unless the handler has already been scanned.
2487 void ClassVerifier::push_handlers(ExceptionTable* exhandlers,
2488                                   GrowableArray&lt;u4&gt;* handler_list,
2489                                   GrowableArray&lt;u4&gt;* handler_stack,
2490                                   u4 bci) {
2491   int exlength = exhandlers-&gt;length();
2492   for(int x = 0; x &lt; exlength; x++) {
2493     if (bci &gt;= exhandlers-&gt;start_pc(x) &amp;&amp; bci &lt; exhandlers-&gt;end_pc(x)) {
2494       u4 exhandler_pc = exhandlers-&gt;handler_pc(x);
2495       if (!handler_list-&gt;contains(exhandler_pc)) {
2496         handler_stack-&gt;append_if_missing(exhandler_pc);
2497         handler_list-&gt;append(exhandler_pc);
2498       }
2499     }
2500   }
2501 }
2502 
2503 // Return TRUE if all code paths starting with start_bc_offset end in
2504 // bytecode athrow or loop.
2505 bool ClassVerifier::ends_in_athrow(u4 start_bc_offset) {
2506   ResourceMark rm;
2507   // Create bytecode stream.
2508   RawBytecodeStream bcs(method());
2509   u4 code_length = method()-&gt;code_size();
2510   bcs.set_start(start_bc_offset);
2511   u4 target;
2512   // Create stack for storing bytecode start offsets for if* and *switch.
2513   GrowableArray&lt;u4&gt;* bci_stack = new GrowableArray&lt;u4&gt;(30);
2514   // Create stack for handlers for try blocks containing this handler.
2515   GrowableArray&lt;u4&gt;* handler_stack = new GrowableArray&lt;u4&gt;(30);
2516   // Create list of handlers that have been pushed onto the handler_stack
2517   // so that handlers embedded inside of their own TRY blocks only get
2518   // scanned once.
2519   GrowableArray&lt;u4&gt;* handler_list = new GrowableArray&lt;u4&gt;(30);
2520   // Create list of visited branch opcodes (goto* and if*).
2521   GrowableArray&lt;u4&gt;* visited_branches = new GrowableArray&lt;u4&gt;(30);
2522   ExceptionTable exhandlers(_method());
2523 
2524   while (true) {
2525     if (bcs.is_last_bytecode()) {
2526       // if no more starting offsets to parse or if at the end of the
2527       // method then return false.
2528       if ((bci_stack-&gt;is_empty()) || ((u4)bcs.end_bci() == code_length))
2529         return false;
2530       // Pop a bytecode starting offset and scan from there.
2531       bcs.set_start(bci_stack-&gt;pop());
2532     }
2533     Bytecodes::Code opcode = bcs.raw_next();
2534     u4 bci = bcs.bci();
2535 
2536     // If the bytecode is in a TRY block, push its handlers so they
2537     // will get parsed.
2538     push_handlers(&amp;exhandlers, handler_list, handler_stack, bci);
2539 
2540     switch (opcode) {
2541       case Bytecodes::_if_icmpeq:
2542       case Bytecodes::_if_icmpne:
2543       case Bytecodes::_if_icmplt:
2544       case Bytecodes::_if_icmpge:
2545       case Bytecodes::_if_icmpgt:
2546       case Bytecodes::_if_icmple:
2547       case Bytecodes::_ifeq:
2548       case Bytecodes::_ifne:
2549       case Bytecodes::_iflt:
2550       case Bytecodes::_ifge:
2551       case Bytecodes::_ifgt:
2552       case Bytecodes::_ifle:
2553       case Bytecodes::_if_acmpeq:
2554       case Bytecodes::_if_acmpne:
2555       case Bytecodes::_ifnull:
2556       case Bytecodes::_ifnonnull:
2557         target = bcs.dest();
2558         if (visited_branches-&gt;contains(bci)) {
2559           if (bci_stack-&gt;is_empty()) {
2560             if (handler_stack-&gt;is_empty()) {
2561               return true;
2562             } else {
2563               // Parse the catch handlers for try blocks containing athrow.
2564               bcs.set_start(handler_stack-&gt;pop());
2565             }
2566           } else {
2567             // Pop a bytecode starting offset and scan from there.
2568             bcs.set_start(bci_stack-&gt;pop());
2569           }
2570         } else {
2571           if (target &gt; bci) { // forward branch
2572             if (target &gt;= code_length) return false;
2573             // Push the branch target onto the stack.
2574             bci_stack-&gt;push(target);
2575             // then, scan bytecodes starting with next.
2576             bcs.set_start(bcs.next_bci());
2577           } else { // backward branch
2578             // Push bytecode offset following backward branch onto the stack.
2579             bci_stack-&gt;push(bcs.next_bci());
2580             // Check bytecodes starting with branch target.
2581             bcs.set_start(target);
2582           }
2583           // Record target so we don&#39;t branch here again.
2584           visited_branches-&gt;append(bci);
2585         }
2586         break;
2587 
2588       case Bytecodes::_goto:
2589       case Bytecodes::_goto_w:
2590         target = (opcode == Bytecodes::_goto ? bcs.dest() : bcs.dest_w());
2591         if (visited_branches-&gt;contains(bci)) {
2592           if (bci_stack-&gt;is_empty()) {
2593             if (handler_stack-&gt;is_empty()) {
2594               return true;
2595             } else {
2596               // Parse the catch handlers for try blocks containing athrow.
2597               bcs.set_start(handler_stack-&gt;pop());
2598             }
2599           } else {
2600             // Been here before, pop new starting offset from stack.
2601             bcs.set_start(bci_stack-&gt;pop());
2602           }
2603         } else {
2604           if (target &gt;= code_length) return false;
2605           // Continue scanning from the target onward.
2606           bcs.set_start(target);
2607           // Record target so we don&#39;t branch here again.
2608           visited_branches-&gt;append(bci);
2609         }
2610         break;
2611 
2612       // Check that all switch alternatives end in &#39;athrow&#39; bytecodes. Since it
2613       // is  difficult to determine where each switch alternative ends, parse
2614       // each switch alternative until either hit a &#39;return&#39;, &#39;athrow&#39;, or reach
2615       // the end of the method&#39;s bytecodes.  This is gross but should be okay
2616       // because:
2617       // 1. tableswitch and lookupswitch byte codes in handlers for ctor explicit
2618       //    constructor invocations should be rare.
2619       // 2. if each switch alternative ends in an athrow then the parsing should be
2620       //    short.  If there is no athrow then it is bogus code, anyway.
2621       case Bytecodes::_lookupswitch:
2622       case Bytecodes::_tableswitch:
2623         {
2624           address aligned_bcp = align_up(bcs.bcp() + 1, jintSize);
2625           u4 default_offset = Bytes::get_Java_u4(aligned_bcp) + bci;
2626           int keys, delta;
2627           if (opcode == Bytecodes::_tableswitch) {
2628             jint low = (jint)Bytes::get_Java_u4(aligned_bcp + jintSize);
2629             jint high = (jint)Bytes::get_Java_u4(aligned_bcp + 2*jintSize);
2630             // This is invalid, but let the regular bytecode verifier
2631             // report this because the user will get a better error message.
2632             if (low &gt; high) return true;
2633             keys = high - low + 1;
2634             delta = 1;
2635           } else {
2636             keys = (int)Bytes::get_Java_u4(aligned_bcp + jintSize);
2637             delta = 2;
2638           }
2639           // Invalid, let the regular bytecode verifier deal with it.
2640           if (keys &lt; 0) return true;
2641 
2642           // Push the offset of the next bytecode onto the stack.
2643           bci_stack-&gt;push(bcs.next_bci());
2644 
2645           // Push the switch alternatives onto the stack.
2646           for (int i = 0; i &lt; keys; i++) {
2647             u4 target = bci + (jint)Bytes::get_Java_u4(aligned_bcp+(3+i*delta)*jintSize);
2648             if (target &gt; code_length) return false;
2649             bci_stack-&gt;push(target);
2650           }
2651 
2652           // Start bytecode parsing for the switch at the default alternative.
2653           if (default_offset &gt; code_length) return false;
2654           bcs.set_start(default_offset);
2655           break;
2656         }
2657 
2658       case Bytecodes::_return:
2659         return false;
2660 
2661       case Bytecodes::_athrow:
2662         {
2663           if (bci_stack-&gt;is_empty()) {
2664             if (handler_stack-&gt;is_empty()) {
2665               return true;
2666             } else {
2667               // Parse the catch handlers for try blocks containing athrow.
2668               bcs.set_start(handler_stack-&gt;pop());
2669             }
2670           } else {
2671             // Pop a bytecode offset and starting scanning from there.
2672             bcs.set_start(bci_stack-&gt;pop());
2673           }
2674         }
2675         break;
2676 
2677       default:
2678         ;
2679     } // end switch
2680   } // end while loop
2681 
2682   return false;
2683 }
2684 
2685 void ClassVerifier::verify_invoke_init(
2686     RawBytecodeStream* bcs, u2 ref_class_index, VerificationType ref_class_type,
2687     StackMapFrame* current_frame, u4 code_length, bool in_try_block,
2688     bool *this_uninit, const constantPoolHandle&amp; cp, StackMapTable* stackmap_table,
2689     TRAPS) {
2690   u2 bci = bcs-&gt;bci();
2691   VerificationType type = current_frame-&gt;pop_stack(
2692     VerificationType::reference_check(), CHECK_VERIFY(this));
2693   if (type == VerificationType::uninitialized_this_type()) {
2694     // The method must be an &lt;init&gt; method of this class or its superclass
2695     Klass* superk = current_class()-&gt;super();
2696     if (ref_class_type.name() != current_class()-&gt;name() &amp;&amp;
2697         ref_class_type.name() != superk-&gt;name()) {
2698       verify_error(ErrorContext::bad_type(bci,
2699           TypeOrigin::implicit(ref_class_type),
2700           TypeOrigin::implicit(current_type())),
2701           &quot;Bad &lt;init&gt; method call&quot;);
2702       return;
2703     }
2704 
2705     // If this invokespecial call is done from inside of a TRY block then make
2706     // sure that all catch clause paths end in a throw.  Otherwise, this can
2707     // result in returning an incomplete object.
2708     if (in_try_block) {
2709       ExceptionTable exhandlers(_method());
2710       int exlength = exhandlers.length();
2711       for(int i = 0; i &lt; exlength; i++) {
2712         u2 start_pc = exhandlers.start_pc(i);
2713         u2 end_pc = exhandlers.end_pc(i);
2714 
2715         if (bci &gt;= start_pc &amp;&amp; bci &lt; end_pc) {
2716           if (!ends_in_athrow(exhandlers.handler_pc(i))) {
2717             verify_error(ErrorContext::bad_code(bci),
2718               &quot;Bad &lt;init&gt; method call from after the start of a try block&quot;);
2719             return;
2720           } else if (log_is_enabled(Debug, verification)) {
2721             ResourceMark rm(THREAD);
2722             log_debug(verification)(&quot;Survived call to ends_in_athrow(): %s&quot;,
2723                                           current_class()-&gt;name()-&gt;as_C_string());
2724           }
2725         }
2726       }
2727 
2728       // Check the exception handler target stackmaps with the locals from the
2729       // incoming stackmap (before initialize_object() changes them to outgoing
2730       // state).
2731       if (was_recursively_verified()) return;
2732       verify_exception_handler_targets(bci, true, current_frame,
2733                                        stackmap_table, CHECK_VERIFY(this));
2734     } // in_try_block
2735 
2736     current_frame-&gt;initialize_object(type, current_type());
2737     *this_uninit = true;
2738   } else if (type.is_uninitialized()) {
2739     u2 new_offset = type.bci();
2740     address new_bcp = bcs-&gt;bcp() - bci + new_offset;
2741     if (new_offset &gt; (code_length - 3) || (*new_bcp) != Bytecodes::_new) {
2742       /* Unreachable?  Stack map parsing ensures valid type and new
2743        * instructions have a valid BCI. */
2744       verify_error(ErrorContext::bad_code(new_offset),
2745                    &quot;Expecting new instruction&quot;);
2746       return;
2747     }
2748     u2 new_class_index = Bytes::get_Java_u2(new_bcp + 1);
2749     if (was_recursively_verified()) return;
2750     verify_cp_class_type(bci, new_class_index, cp, CHECK_VERIFY(this));
2751 
2752     // The method must be an &lt;init&gt; method of the indicated class
2753     VerificationType new_class_type = cp_index_to_type(
2754       new_class_index, cp, CHECK_VERIFY(this));
2755     if (!new_class_type.equals(ref_class_type)) {
2756       verify_error(ErrorContext::bad_type(bci,
2757           TypeOrigin::cp(new_class_index, new_class_type),
2758           TypeOrigin::cp(ref_class_index, ref_class_type)),
2759           &quot;Call to wrong &lt;init&gt; method&quot;);
2760       return;
2761     }
2762     // According to the VM spec, if the referent class is a superclass of the
2763     // current class, and is in a different runtime package, and the method is
2764     // protected, then the objectref must be the current class or a subclass
2765     // of the current class.
2766     VerificationType objectref_type = new_class_type;
2767     if (name_in_supers(ref_class_type.name(), current_class())) {
2768       Klass* ref_klass = load_class(ref_class_type.name(), CHECK);
2769       if (was_recursively_verified()) return;
2770       Method* m = InstanceKlass::cast(ref_klass)-&gt;uncached_lookup_method(
2771         vmSymbols::object_initializer_name(),
2772         cp-&gt;signature_ref_at(bcs-&gt;get_index_u2()),
2773         Klass::find_overpass);
2774       // Do nothing if method is not found.  Let resolution detect the error.
2775       if (m != NULL) {
2776         InstanceKlass* mh = m-&gt;method_holder();
2777         if (m-&gt;is_protected() &amp;&amp; !mh-&gt;is_same_class_package(_klass)) {
2778           bool assignable = current_type().is_assignable_from(
2779             objectref_type, this, true, CHECK_VERIFY(this));
2780           if (!assignable) {
2781             verify_error(ErrorContext::bad_type(bci,
2782                 TypeOrigin::cp(new_class_index, objectref_type),
2783                 TypeOrigin::implicit(current_type())),
2784                 &quot;Bad access to protected &lt;init&gt; method&quot;);
2785             return;
2786           }
2787         }
2788       }
2789     }
2790     // Check the exception handler target stackmaps with the locals from the
2791     // incoming stackmap (before initialize_object() changes them to outgoing
2792     // state).
2793     if (in_try_block) {
2794       if (was_recursively_verified()) return;
2795       verify_exception_handler_targets(bci, *this_uninit, current_frame,
2796                                        stackmap_table, CHECK_VERIFY(this));
2797     }
2798     current_frame-&gt;initialize_object(type, new_class_type);
2799   } else {
2800     verify_error(ErrorContext::bad_type(bci, current_frame-&gt;stack_top_ctx()),
2801         &quot;Bad operand type when invoking &lt;init&gt;&quot;);
2802     return;
2803   }
2804 }
2805 
2806 bool ClassVerifier::is_same_or_direct_interface(
2807     InstanceKlass* klass,
2808     VerificationType klass_type,
2809     VerificationType ref_class_type) {
2810   if (ref_class_type.equals(klass_type)) return true;
2811   Array&lt;InstanceKlass*&gt;* local_interfaces = klass-&gt;local_interfaces();
2812   if (local_interfaces != NULL) {
2813     for (int x = 0; x &lt; local_interfaces-&gt;length(); x++) {
2814       InstanceKlass* k = local_interfaces-&gt;at(x);
2815       assert (k != NULL &amp;&amp; k-&gt;is_interface(), &quot;invalid interface&quot;);
2816       if (ref_class_type.equals(VerificationType::reference_type(k-&gt;name()))) {
2817         return true;
2818       }
2819     }
2820   }
2821   return false;
2822 }
2823 
2824 void ClassVerifier::verify_invoke_instructions(
2825     RawBytecodeStream* bcs, u4 code_length, StackMapFrame* current_frame,
<a name="23" id="anc23"></a><span class="line-modified">2826     bool in_try_block, bool *this_uninit,</span>
2827     const constantPoolHandle&amp; cp, StackMapTable* stackmap_table, TRAPS) {
2828   // Make sure the constant pool item is the right type
2829   u2 index = bcs-&gt;get_index_u2();
2830   Bytecodes::Code opcode = bcs-&gt;raw_code();
2831   unsigned int types = 0;
2832   switch (opcode) {
2833     case Bytecodes::_invokeinterface:
2834       types = 1 &lt;&lt; JVM_CONSTANT_InterfaceMethodref;
2835       break;
2836     case Bytecodes::_invokedynamic:
2837       types = 1 &lt;&lt; JVM_CONSTANT_InvokeDynamic;
2838       break;
2839     case Bytecodes::_invokespecial:
2840     case Bytecodes::_invokestatic:
2841       types = (_klass-&gt;major_version() &lt; STATIC_METHOD_IN_INTERFACE_MAJOR_VERSION) ?
2842         (1 &lt;&lt; JVM_CONSTANT_Methodref) :
2843         ((1 &lt;&lt; JVM_CONSTANT_InterfaceMethodref) | (1 &lt;&lt; JVM_CONSTANT_Methodref));
2844       break;
2845     default:
2846       types = 1 &lt;&lt; JVM_CONSTANT_Methodref;
2847   }
2848   verify_cp_type(bcs-&gt;bci(), index, cp, types, CHECK_VERIFY(this));
2849 
2850   // Get method name and signature
2851   Symbol* method_name = cp-&gt;name_ref_at(index);
2852   Symbol* method_sig = cp-&gt;signature_ref_at(index);
2853 
2854   // Method signature was checked in ClassFileParser.
2855   assert(SignatureVerifier::is_valid_method_signature(method_sig),
2856          &quot;Invalid method signature&quot;);
2857 
<a name="24" id="anc24"></a><span class="line-modified">2858   // Get referenced class</span>
2859   VerificationType ref_class_type;
2860   if (opcode == Bytecodes::_invokedynamic) {
2861     if (_klass-&gt;major_version() &lt; Verifier::INVOKEDYNAMIC_MAJOR_VERSION) {
2862       class_format_error(
2863         &quot;invokedynamic instructions not supported by this class file version (%d), class %s&quot;,
2864         _klass-&gt;major_version(), _klass-&gt;external_name());
2865       return;
2866     }
2867   } else {
2868     ref_class_type = cp_ref_index_to_type(index, cp, CHECK_VERIFY(this));
2869   }
2870 
2871   assert(sizeof(VerificationType) == sizeof(uintptr_t),
2872         &quot;buffer type must match VerificationType size&quot;);
2873 
2874   // Get the UTF8 index for this signature.
2875   int sig_index = cp-&gt;signature_ref_index_at(cp-&gt;name_and_type_ref_index_at(index));
2876 
2877   // Get the signature&#39;s verification types.
2878   sig_as_verification_types* mth_sig_verif_types;
2879   sig_as_verification_types** mth_sig_verif_types_ptr = method_signatures_table()-&gt;get(sig_index);
2880   if (mth_sig_verif_types_ptr != NULL) {
2881     // Found the entry for the signature&#39;s verification types in the hash table.
2882     mth_sig_verif_types = *mth_sig_verif_types_ptr;
2883     assert(mth_sig_verif_types != NULL, &quot;Unexpected NULL sig_as_verification_types value&quot;);
2884   } else {
2885     // Not found, add the entry to the table.
2886     GrowableArray&lt;VerificationType&gt;* verif_types = new GrowableArray&lt;VerificationType&gt;(10);
2887     mth_sig_verif_types = new sig_as_verification_types(verif_types);
2888     create_method_sig_entry(mth_sig_verif_types, sig_index, CHECK_VERIFY(this));
2889   }
2890 
2891   // Get the number of arguments for this signature.
2892   int nargs = mth_sig_verif_types-&gt;num_args();
2893 
2894   // Check instruction operands
2895   u2 bci = bcs-&gt;bci();
2896   if (opcode == Bytecodes::_invokeinterface) {
2897     address bcp = bcs-&gt;bcp();
2898     // 4905268: count operand in invokeinterface should be nargs+1, not nargs.
2899     // JSR202 spec: The count operand of an invokeinterface instruction is valid if it is
2900     // the difference between the size of the operand stack before and after the instruction
2901     // executes.
2902     if (*(bcp+3) != (nargs+1)) {
2903       verify_error(ErrorContext::bad_code(bci),
2904           &quot;Inconsistent args count operand in invokeinterface&quot;);
2905       return;
2906     }
2907     if (*(bcp+4) != 0) {
2908       verify_error(ErrorContext::bad_code(bci),
2909           &quot;Fourth operand byte of invokeinterface must be zero&quot;);
2910       return;
2911     }
2912   }
2913 
2914   if (opcode == Bytecodes::_invokedynamic) {
2915     address bcp = bcs-&gt;bcp();
2916     if (*(bcp+3) != 0 || *(bcp+4) != 0) {
2917       verify_error(ErrorContext::bad_code(bci),
2918           &quot;Third and fourth operand bytes of invokedynamic must be zero&quot;);
2919       return;
2920     }
2921   }
2922 
2923   if (method_name-&gt;char_at(0) == JVM_SIGNATURE_SPECIAL) {
<a name="25" id="anc25"></a><span class="line-modified">2924     // Make sure &lt;init&gt; can only be invoked by invokespecial or invokestatic.</span>
<span class="line-modified">2925     // The allowed invocation mode of &lt;init&gt; depends on its signature.</span>
<span class="line-added">2926     if ((opcode != Bytecodes::_invokespecial &amp;&amp;</span>
<span class="line-added">2927          opcode != Bytecodes::_invokestatic) ||</span>
2928         method_name != vmSymbols::object_initializer_name()) {
2929       verify_error(ErrorContext::bad_code(bci),
2930           &quot;Illegal call to internal method&quot;);
2931       return;
2932     }
2933   } else if (opcode == Bytecodes::_invokespecial
2934              &amp;&amp; !is_same_or_direct_interface(current_class(), current_type(), ref_class_type)
2935              &amp;&amp; !ref_class_type.equals(VerificationType::reference_type(
<a name="26" id="anc26"></a><span class="line-modified">2936                   current_class()-&gt;super()-&gt;name()))) { // super() can never be a value_type.</span>
2937     bool subtype = false;
2938     bool have_imr_indirect = cp-&gt;tag_at(index).value() == JVM_CONSTANT_InterfaceMethodref;
2939     if (!current_class()-&gt;is_unsafe_anonymous()) {
2940       subtype = ref_class_type.is_assignable_from(
2941                  current_type(), this, false, CHECK_VERIFY(this));
2942     } else {
<a name="27" id="anc27"></a><span class="line-modified">2943       InstanceKlass* unsafe_host = current_class()-&gt;unsafe_anonymous_host();</span>
<span class="line-modified">2944       VerificationType unsafe_anonymous_host_type = reference_or_valuetype(unsafe_host);</span>
2945       subtype = ref_class_type.is_assignable_from(unsafe_anonymous_host_type, this, false, CHECK_VERIFY(this));
2946 
2947       // If invokespecial of IMR, need to recheck for same or
2948       // direct interface relative to the host class
2949       have_imr_indirect = (have_imr_indirect &amp;&amp;
2950                            !is_same_or_direct_interface(
<a name="28" id="anc28"></a><span class="line-modified">2951                              unsafe_host,</span>
2952                              unsafe_anonymous_host_type, ref_class_type));
2953     }
2954     if (!subtype) {
2955       verify_error(ErrorContext::bad_code(bci),
2956           &quot;Bad invokespecial instruction: &quot;
2957           &quot;current class isn&#39;t assignable to reference class.&quot;);
2958        return;
2959     } else if (have_imr_indirect) {
2960       verify_error(ErrorContext::bad_code(bci),
2961           &quot;Bad invokespecial instruction: &quot;
2962           &quot;interface method reference is in an indirect superinterface.&quot;);
2963       return;
2964     }
2965 
2966   }
2967 
2968   // Get the verification types for the method&#39;s arguments.
2969   GrowableArray&lt;VerificationType&gt;* sig_verif_types = mth_sig_verif_types-&gt;sig_verif_types();
2970   assert(sig_verif_types != NULL, &quot;Missing signature&#39;s array of verification types&quot;);
2971   // Match method descriptor with operand stack
2972   // The arguments are on the stack in descending order.
2973   for (int i = nargs - 1; i &gt;= 0; i--) { // Run backwards
2974     current_frame-&gt;pop_stack(sig_verif_types-&gt;at(i), CHECK_VERIFY(this));
2975   }
2976 
2977   // Check objectref on operand stack
2978   if (opcode != Bytecodes::_invokestatic &amp;&amp;
2979       opcode != Bytecodes::_invokedynamic) {
2980     if (method_name == vmSymbols::object_initializer_name()) {  // &lt;init&gt; method
<a name="29" id="anc29"></a><span class="line-added">2981       // (use of &lt;init&gt; as a static factory is handled under invokestatic)</span>
2982       verify_invoke_init(bcs, index, ref_class_type, current_frame,
2983         code_length, in_try_block, this_uninit, cp, stackmap_table,
2984         CHECK_VERIFY(this));
2985       if (was_recursively_verified()) return;
2986     } else {   // other methods
2987       // Ensures that target class is assignable to method class.
2988       if (opcode == Bytecodes::_invokespecial) {
2989         if (!current_class()-&gt;is_unsafe_anonymous()) {
2990           current_frame-&gt;pop_stack(current_type(), CHECK_VERIFY(this));
2991         } else {
2992           // anonymous class invokespecial calls: check if the
2993           // objectref is a subtype of the unsafe_anonymous_host of the current class
2994           // to allow an anonymous class to reference methods in the unsafe_anonymous_host
2995           VerificationType top = current_frame-&gt;pop_stack(CHECK_VERIFY(this));
<a name="30" id="anc30"></a><span class="line-modified">2996 </span>
<span class="line-modified">2997           InstanceKlass* unsafe_host = current_class()-&gt;unsafe_anonymous_host();</span>
<span class="line-modified">2998           VerificationType host_type = reference_or_valuetype(unsafe_host);</span>
<span class="line-added">2999           bool subtype = host_type.is_assignable_from(top, this, false, CHECK_VERIFY(this));</span>
3000           if (!subtype) {
3001             verify_error( ErrorContext::bad_type(current_frame-&gt;offset(),
3002               current_frame-&gt;stack_top_ctx(),
3003               TypeOrigin::implicit(top)),
3004               &quot;Bad type on operand stack&quot;);
3005             return;
3006           }
3007         }
3008       } else if (opcode == Bytecodes::_invokevirtual) {
3009         VerificationType stack_object_type =
3010           current_frame-&gt;pop_stack(ref_class_type, CHECK_VERIFY(this));
3011         if (current_type() != stack_object_type) {
3012           if (was_recursively_verified()) return;
3013           assert(cp-&gt;cache() == NULL, &quot;not rewritten yet&quot;);
3014           Symbol* ref_class_name =
3015             cp-&gt;klass_name_at(cp-&gt;klass_ref_index_at(index));
3016           // See the comments in verify_field_instructions() for
3017           // the rationale behind this.
3018           if (name_in_supers(ref_class_name, current_class())) {
3019             Klass* ref_class = load_class(ref_class_name, CHECK);
3020             if (is_protected_access(
3021                   _klass, ref_class, method_name, method_sig, true)) {
3022               // It&#39;s protected access, check if stack object is
3023               // assignable to current class.
3024               bool is_assignable = current_type().is_assignable_from(
3025                 stack_object_type, this, true, CHECK_VERIFY(this));
3026               if (!is_assignable) {
3027                 if (ref_class_type.name() == vmSymbols::java_lang_Object()
3028                     &amp;&amp; stack_object_type.is_array()
3029                     &amp;&amp; method_name == vmSymbols::clone_name()) {
3030                   // Special case: arrays pretend to implement public Object
3031                   // clone().
3032                 } else {
3033                   verify_error(ErrorContext::bad_type(bci,
3034                       current_frame-&gt;stack_top_ctx(),
3035                       TypeOrigin::implicit(current_type())),
3036                       &quot;Bad access to protected data in invokevirtual&quot;);
3037                   return;
3038                 }
3039               }
3040             }
3041           }
3042         }
3043       } else {
3044         assert(opcode == Bytecodes::_invokeinterface, &quot;Unexpected opcode encountered&quot;);
3045         current_frame-&gt;pop_stack(ref_class_type, CHECK_VERIFY(this));
3046       }
3047     }
3048   }
3049   // Push the result type.
3050   int sig_verif_types_len = sig_verif_types-&gt;length();
3051   if (sig_verif_types_len &gt; nargs) {  // There&#39;s a return type
<a name="31" id="anc31"></a><span class="line-modified">3052     if (method_name == vmSymbols::object_initializer_name() &amp;&amp;</span>
<span class="line-modified">3053         opcode != Bytecodes::_invokestatic) {</span>
<span class="line-modified">3054       // an &lt;init&gt; method must have a void return type, unless it&#39;s a static factory</span>

3055       verify_error(ErrorContext::bad_code(bci),
3056           &quot;Return type must be void in &lt;init&gt; method&quot;);
3057       return;
3058     }
3059 
3060     assert(sig_verif_types_len &lt;= nargs + 2,
3061            &quot;Signature verification types array return type is bogus&quot;);
3062     for (int i = nargs; i &lt; sig_verif_types_len; i++) {
3063       assert(i == nargs || sig_verif_types-&gt;at(i).is_long2() ||
3064              sig_verif_types-&gt;at(i).is_double2(), &quot;Unexpected return verificationType&quot;);
3065       current_frame-&gt;push_stack(sig_verif_types-&gt;at(i), CHECK_VERIFY(this));
3066     }
<a name="32" id="anc32"></a><span class="line-added">3067   } else {</span>
<span class="line-added">3068     // an &lt;init&gt; method may not have a void return type, if it&#39;s a static factory</span>
<span class="line-added">3069     if (method_name == vmSymbols::object_initializer_name() &amp;&amp;</span>
<span class="line-added">3070         opcode != Bytecodes::_invokespecial) {</span>
<span class="line-added">3071       verify_error(ErrorContext::bad_code(bci),</span>
<span class="line-added">3072           &quot;Return type must be non-void in &lt;init&gt; static factory method&quot;);</span>
<span class="line-added">3073       return;</span>
<span class="line-added">3074     }</span>
3075   }
3076 }
3077 
3078 VerificationType ClassVerifier::get_newarray_type(
3079     u2 index, u2 bci, TRAPS) {
3080   const char* from_bt[] = {
3081     NULL, NULL, NULL, NULL, &quot;[Z&quot;, &quot;[C&quot;, &quot;[F&quot;, &quot;[D&quot;, &quot;[B&quot;, &quot;[S&quot;, &quot;[I&quot;, &quot;[J&quot;,
3082   };
3083   if (index &lt; T_BOOLEAN || index &gt; T_LONG) {
3084     verify_error(ErrorContext::bad_code(bci), &quot;Illegal newarray instruction&quot;);
3085     return VerificationType::bogus_type();
3086   }
3087 
3088   // from_bt[index] contains the array signature which has a length of 2
3089   Symbol* sig = create_temporary_symbol(from_bt[index], 2);
3090   return VerificationType::reference_type(sig);
3091 }
3092 
3093 void ClassVerifier::verify_anewarray(
3094     u2 bci, u2 index, const constantPoolHandle&amp; cp,
3095     StackMapFrame* current_frame, TRAPS) {
3096   verify_cp_class_type(bci, index, cp, CHECK_VERIFY(this));
3097   current_frame-&gt;pop_stack(
3098     VerificationType::integer_type(), CHECK_VERIFY(this));
3099 
3100   if (was_recursively_verified()) return;
3101   VerificationType component_type =
3102     cp_index_to_type(index, cp, CHECK_VERIFY(this));
3103   int length;
3104   char* arr_sig_str;
3105   if (component_type.is_array()) {     // it&#39;s an array
3106     const char* component_name = component_type.name()-&gt;as_utf8();
3107     // Check for more than MAX_ARRAY_DIMENSIONS
3108     length = (int)strlen(component_name);
3109     if (length &gt; MAX_ARRAY_DIMENSIONS &amp;&amp;
3110         component_name[MAX_ARRAY_DIMENSIONS - 1] == JVM_SIGNATURE_ARRAY) {
3111       verify_error(ErrorContext::bad_code(bci),
3112         &quot;Illegal anewarray instruction, array has more than 255 dimensions&quot;);
3113     }
3114     // add one dimension to component
3115     length++;
3116     arr_sig_str = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, length + 1);
3117     int n = os::snprintf(arr_sig_str, length + 1, &quot;%c%s&quot;,
3118                          JVM_SIGNATURE_ARRAY, component_name);
3119     assert(n == length, &quot;Unexpected number of characters in string&quot;);
3120   } else {         // it&#39;s an object or interface
3121     const char* component_name = component_type.name()-&gt;as_utf8();
<a name="33" id="anc33"></a><span class="line-modified">3122     char Q_or_L = component_type.is_valuetype() ? JVM_SIGNATURE_VALUETYPE : JVM_SIGNATURE_CLASS;</span>
<span class="line-added">3123     // add one dimension to component with &#39;L&#39; or &#39;Q&#39; prepended and &#39;;&#39; appended.</span>
3124     length = (int)strlen(component_name) + 3;
3125     arr_sig_str = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, length + 1);
3126     int n = os::snprintf(arr_sig_str, length + 1, &quot;%c%c%s;&quot;,
<a name="34" id="anc34"></a><span class="line-modified">3127                          JVM_SIGNATURE_ARRAY, Q_or_L, component_name);</span>
3128     assert(n == length, &quot;Unexpected number of characters in string&quot;);
3129   }
3130   Symbol* arr_sig = create_temporary_symbol(arr_sig_str, length);
3131   VerificationType new_array_type = VerificationType::reference_type(arr_sig);
3132   current_frame-&gt;push_stack(new_array_type, CHECK_VERIFY(this));
3133 }
3134 
3135 void ClassVerifier::verify_iload(u2 index, StackMapFrame* current_frame, TRAPS) {
3136   current_frame-&gt;get_local(
3137     index, VerificationType::integer_type(), CHECK_VERIFY(this));
3138   current_frame-&gt;push_stack(
3139     VerificationType::integer_type(), CHECK_VERIFY(this));
3140 }
3141 
3142 void ClassVerifier::verify_lload(u2 index, StackMapFrame* current_frame, TRAPS) {
3143   current_frame-&gt;get_local_2(
3144     index, VerificationType::long_type(),
3145     VerificationType::long2_type(), CHECK_VERIFY(this));
3146   current_frame-&gt;push_stack_2(
3147     VerificationType::long_type(),
3148     VerificationType::long2_type(), CHECK_VERIFY(this));
3149 }
3150 
3151 void ClassVerifier::verify_fload(u2 index, StackMapFrame* current_frame, TRAPS) {
3152   current_frame-&gt;get_local(
3153     index, VerificationType::float_type(), CHECK_VERIFY(this));
3154   current_frame-&gt;push_stack(
3155     VerificationType::float_type(), CHECK_VERIFY(this));
3156 }
3157 
3158 void ClassVerifier::verify_dload(u2 index, StackMapFrame* current_frame, TRAPS) {
3159   current_frame-&gt;get_local_2(
3160     index, VerificationType::double_type(),
3161     VerificationType::double2_type(), CHECK_VERIFY(this));
3162   current_frame-&gt;push_stack_2(
3163     VerificationType::double_type(),
3164     VerificationType::double2_type(), CHECK_VERIFY(this));
3165 }
3166 
3167 void ClassVerifier::verify_aload(u2 index, StackMapFrame* current_frame, TRAPS) {
3168   VerificationType type = current_frame-&gt;get_local(
<a name="35" id="anc35"></a><span class="line-modified">3169     index, VerificationType::nonscalar_check(), CHECK_VERIFY(this));</span>
3170   current_frame-&gt;push_stack(type, CHECK_VERIFY(this));
3171 }
3172 
3173 void ClassVerifier::verify_istore(u2 index, StackMapFrame* current_frame, TRAPS) {
3174   current_frame-&gt;pop_stack(
3175     VerificationType::integer_type(), CHECK_VERIFY(this));
3176   current_frame-&gt;set_local(
3177     index, VerificationType::integer_type(), CHECK_VERIFY(this));
3178 }
3179 
3180 void ClassVerifier::verify_lstore(u2 index, StackMapFrame* current_frame, TRAPS) {
3181   current_frame-&gt;pop_stack_2(
3182     VerificationType::long2_type(),
3183     VerificationType::long_type(), CHECK_VERIFY(this));
3184   current_frame-&gt;set_local_2(
3185     index, VerificationType::long_type(),
3186     VerificationType::long2_type(), CHECK_VERIFY(this));
3187 }
3188 
3189 void ClassVerifier::verify_fstore(u2 index, StackMapFrame* current_frame, TRAPS) {
3190   current_frame-&gt;pop_stack(VerificationType::float_type(), CHECK_VERIFY(this));
3191   current_frame-&gt;set_local(
3192     index, VerificationType::float_type(), CHECK_VERIFY(this));
3193 }
3194 
3195 void ClassVerifier::verify_dstore(u2 index, StackMapFrame* current_frame, TRAPS) {
3196   current_frame-&gt;pop_stack_2(
3197     VerificationType::double2_type(),
3198     VerificationType::double_type(), CHECK_VERIFY(this));
3199   current_frame-&gt;set_local_2(
3200     index, VerificationType::double_type(),
3201     VerificationType::double2_type(), CHECK_VERIFY(this));
3202 }
3203 
3204 void ClassVerifier::verify_astore(u2 index, StackMapFrame* current_frame, TRAPS) {
3205   VerificationType type = current_frame-&gt;pop_stack(
<a name="36" id="anc36"></a><span class="line-modified">3206     VerificationType::nonscalar_check(), CHECK_VERIFY(this));</span>
3207   current_frame-&gt;set_local(index, type, CHECK_VERIFY(this));
3208 }
3209 
3210 void ClassVerifier::verify_iinc(u2 index, StackMapFrame* current_frame, TRAPS) {
3211   VerificationType type = current_frame-&gt;get_local(
3212     index, VerificationType::integer_type(), CHECK_VERIFY(this));
3213   current_frame-&gt;set_local(index, type, CHECK_VERIFY(this));
3214 }
3215 
3216 void ClassVerifier::verify_return_value(
3217     VerificationType return_type, VerificationType type, u2 bci,
3218     StackMapFrame* current_frame, TRAPS) {
3219   if (return_type == VerificationType::bogus_type()) {
3220     verify_error(ErrorContext::bad_type(bci,
3221         current_frame-&gt;stack_top_ctx(), TypeOrigin::signature(return_type)),
3222         &quot;Method expects a return value&quot;);
3223     return;
3224   }
3225   bool match = return_type.is_assignable_from(type, this, false, CHECK_VERIFY(this));
3226   if (!match) {
3227     verify_error(ErrorContext::bad_type(bci,
3228         current_frame-&gt;stack_top_ctx(), TypeOrigin::signature(return_type)),
3229         &quot;Bad return type&quot;);
3230     return;
3231   }
3232 }
3233 
3234 // The verifier creates symbols which are substrings of Symbols.
3235 // These are stored in the verifier until the end of verification so that
3236 // they can be reference counted.
3237 Symbol* ClassVerifier::create_temporary_symbol(const char *name, int length) {
3238   // Quick deduplication check
3239   if (_previous_symbol != NULL &amp;&amp; _previous_symbol-&gt;equals(name, length)) {
3240     return _previous_symbol;
3241   }
3242   Symbol* sym = SymbolTable::new_symbol(name, length);
3243   if (!sym-&gt;is_permanent()) {
3244     if (_symbols == NULL) {
3245       _symbols = new GrowableArray&lt;Symbol*&gt;(50, 0, NULL);
3246     }
3247     _symbols-&gt;push(sym);
3248   }
3249   _previous_symbol = sym;
3250   return sym;
3251 }
<a name="37" id="anc37"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="37" type="hidden" />
</body>
</html>