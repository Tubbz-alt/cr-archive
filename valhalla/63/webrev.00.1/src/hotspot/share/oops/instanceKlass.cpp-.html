<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/oops/instanceKlass.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;aot/aotLoader.hpp&quot;
  28 #include &quot;classfile/classFileParser.hpp&quot;
  29 #include &quot;classfile/classFileStream.hpp&quot;
  30 #include &quot;classfile/classLoader.hpp&quot;
  31 #include &quot;classfile/classLoaderData.inline.hpp&quot;
  32 #include &quot;classfile/javaClasses.hpp&quot;
  33 #include &quot;classfile/moduleEntry.hpp&quot;
  34 #include &quot;classfile/resolutionErrors.hpp&quot;
  35 #include &quot;classfile/symbolTable.hpp&quot;
  36 #include &quot;classfile/systemDictionary.hpp&quot;
  37 #include &quot;classfile/systemDictionaryShared.hpp&quot;
  38 #include &quot;classfile/verifier.hpp&quot;
  39 #include &quot;classfile/vmSymbols.hpp&quot;
  40 #include &quot;code/dependencyContext.hpp&quot;
  41 #include &quot;compiler/compileBroker.hpp&quot;
  42 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  43 #include &quot;interpreter/oopMapCache.hpp&quot;
  44 #include &quot;interpreter/rewriter.hpp&quot;
  45 #include &quot;jvmtifiles/jvmti.h&quot;
  46 #include &quot;logging/log.hpp&quot;
  47 #include &quot;logging/logMessage.hpp&quot;
  48 #include &quot;logging/logStream.hpp&quot;
  49 #include &quot;memory/allocation.inline.hpp&quot;
  50 #include &quot;memory/iterator.inline.hpp&quot;
  51 #include &quot;memory/metadataFactory.hpp&quot;
  52 #include &quot;memory/metaspaceClosure.hpp&quot;
  53 #include &quot;memory/metaspaceShared.hpp&quot;
  54 #include &quot;memory/oopFactory.hpp&quot;
  55 #include &quot;memory/resourceArea.hpp&quot;
  56 #include &quot;memory/universe.hpp&quot;
  57 #include &quot;oops/fieldStreams.inline.hpp&quot;
  58 #include &quot;oops/constantPool.hpp&quot;
  59 #include &quot;oops/instanceClassLoaderKlass.hpp&quot;
  60 #include &quot;oops/instanceKlass.inline.hpp&quot;
  61 #include &quot;oops/instanceMirrorKlass.hpp&quot;
  62 #include &quot;oops/instanceOop.hpp&quot;
  63 #include &quot;oops/klass.inline.hpp&quot;
  64 #include &quot;oops/method.hpp&quot;
  65 #include &quot;oops/oop.inline.hpp&quot;
  66 #include &quot;oops/recordComponent.hpp&quot;
  67 #include &quot;oops/symbol.hpp&quot;
  68 #include &quot;prims/jvmtiExport.hpp&quot;
  69 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  70 #include &quot;prims/jvmtiThreadState.hpp&quot;
  71 #include &quot;prims/methodComparator.hpp&quot;
  72 #include &quot;runtime/atomic.hpp&quot;
  73 #include &quot;runtime/biasedLocking.hpp&quot;
  74 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  75 #include &quot;runtime/handles.inline.hpp&quot;
  76 #include &quot;runtime/javaCalls.hpp&quot;
  77 #include &quot;runtime/mutexLocker.hpp&quot;
  78 #include &quot;runtime/orderAccess.hpp&quot;
  79 #include &quot;runtime/thread.inline.hpp&quot;
  80 #include &quot;services/classLoadingService.hpp&quot;
  81 #include &quot;services/threadService.hpp&quot;
  82 #include &quot;utilities/dtrace.hpp&quot;
  83 #include &quot;utilities/events.hpp&quot;
  84 #include &quot;utilities/macros.hpp&quot;
  85 #include &quot;utilities/stringUtils.hpp&quot;
  86 #ifdef COMPILER1
  87 #include &quot;c1/c1_Compiler.hpp&quot;
  88 #endif
  89 #if INCLUDE_JFR
  90 #include &quot;jfr/jfrEvents.hpp&quot;
  91 #endif
  92 
  93 
  94 #ifdef DTRACE_ENABLED
  95 
  96 
  97 #define HOTSPOT_CLASS_INITIALIZATION_required HOTSPOT_CLASS_INITIALIZATION_REQUIRED
  98 #define HOTSPOT_CLASS_INITIALIZATION_recursive HOTSPOT_CLASS_INITIALIZATION_RECURSIVE
  99 #define HOTSPOT_CLASS_INITIALIZATION_concurrent HOTSPOT_CLASS_INITIALIZATION_CONCURRENT
 100 #define HOTSPOT_CLASS_INITIALIZATION_erroneous HOTSPOT_CLASS_INITIALIZATION_ERRONEOUS
 101 #define HOTSPOT_CLASS_INITIALIZATION_super__failed HOTSPOT_CLASS_INITIALIZATION_SUPER_FAILED
 102 #define HOTSPOT_CLASS_INITIALIZATION_clinit HOTSPOT_CLASS_INITIALIZATION_CLINIT
 103 #define HOTSPOT_CLASS_INITIALIZATION_error HOTSPOT_CLASS_INITIALIZATION_ERROR
 104 #define HOTSPOT_CLASS_INITIALIZATION_end HOTSPOT_CLASS_INITIALIZATION_END
 105 #define DTRACE_CLASSINIT_PROBE(type, thread_type)                \
 106   {                                                              \
 107     char* data = NULL;                                           \
 108     int len = 0;                                                 \
 109     Symbol* clss_name = name();                                  \
 110     if (clss_name != NULL) {                                     \
 111       data = (char*)clss_name-&gt;bytes();                          \
 112       len = clss_name-&gt;utf8_length();                            \
 113     }                                                            \
 114     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 115       data, len, (void*)class_loader(), thread_type);            \
 116   }
 117 
 118 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)     \
 119   {                                                              \
 120     char* data = NULL;                                           \
 121     int len = 0;                                                 \
 122     Symbol* clss_name = name();                                  \
 123     if (clss_name != NULL) {                                     \
 124       data = (char*)clss_name-&gt;bytes();                          \
 125       len = clss_name-&gt;utf8_length();                            \
 126     }                                                            \
 127     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 128       data, len, (void*)class_loader(), thread_type, wait);      \
 129   }
 130 
 131 #else //  ndef DTRACE_ENABLED
 132 
 133 #define DTRACE_CLASSINIT_PROBE(type, thread_type)
 134 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)
 135 
 136 #endif //  ndef DTRACE_ENABLED
 137 
 138 
 139 static inline bool is_class_loader(const Symbol* class_name,
 140                                    const ClassFileParser&amp; parser) {
 141   assert(class_name != NULL, &quot;invariant&quot;);
 142 
 143   if (class_name == vmSymbols::java_lang_ClassLoader()) {
 144     return true;
 145   }
 146 
 147   if (SystemDictionary::ClassLoader_klass_loaded()) {
 148     const Klass* const super_klass = parser.super_klass();
 149     if (super_klass != NULL) {
 150       if (super_klass-&gt;is_subtype_of(SystemDictionary::ClassLoader_klass())) {
 151         return true;
 152       }
 153     }
 154   }
 155   return false;
 156 }
 157 
 158 // private: called to verify that k is a static member of this nest.
 159 // We know that k is an instance class in the same package and hence the
 160 // same classloader.
 161 bool InstanceKlass::has_nest_member(InstanceKlass* k, TRAPS) const {
 162   assert(!is_hidden(), &quot;unexpected hidden class&quot;);
 163   if (_nest_members == NULL || _nest_members == Universe::the_empty_short_array()) {
 164     if (log_is_enabled(Trace, class, nestmates)) {
 165       ResourceMark rm(THREAD);
 166       log_trace(class, nestmates)(&quot;Checked nest membership of %s in non-nest-host class %s&quot;,
 167                                   k-&gt;external_name(), this-&gt;external_name());
 168     }
 169     return false;
 170   }
 171 
 172   if (log_is_enabled(Trace, class, nestmates)) {
 173     ResourceMark rm(THREAD);
 174     log_trace(class, nestmates)(&quot;Checking nest membership of %s in %s&quot;,
 175                                 k-&gt;external_name(), this-&gt;external_name());
 176   }
 177 
 178   // Check for a resolved cp entry , else fall back to a name check.
 179   // We don&#39;t want to resolve any class other than the one being checked.
 180   for (int i = 0; i &lt; _nest_members-&gt;length(); i++) {
 181     int cp_index = _nest_members-&gt;at(i);
 182     if (_constants-&gt;tag_at(cp_index).is_klass()) {
 183       Klass* k2 = _constants-&gt;klass_at(cp_index, THREAD);
 184       assert(!HAS_PENDING_EXCEPTION || PENDING_EXCEPTION-&gt;is_a(SystemDictionary::VirtualMachineError_klass()),
 185              &quot;Exceptions should not be possible here&quot;);
 186       if (k2 == k) {
 187         log_trace(class, nestmates)(&quot;- class is listed at nest_members[%d] =&gt; cp[%d]&quot;, i, cp_index);
 188         return true;
 189       }
 190     }
 191     else {
 192       Symbol* name = _constants-&gt;klass_name_at(cp_index);
 193       if (name == k-&gt;name()) {
 194         log_trace(class, nestmates)(&quot;- Found it at nest_members[%d] =&gt; cp[%d]&quot;, i, cp_index);
 195 
 196         // Names match so check actual klass. This may trigger class loading if
 197         // it doesn&#39;t match though that should be impossible as it means one classloader
 198         // has defined two different classes with the same name! A compiler thread won&#39;t be
 199         // able to perform that loading but we can&#39;t exclude the compiler threads from
 200         // executing this logic. But it should actually be impossible to trigger loading here.
 201         Klass* k2 = _constants-&gt;klass_at(cp_index, THREAD);
 202         assert(!HAS_PENDING_EXCEPTION || PENDING_EXCEPTION-&gt;is_a(SystemDictionary::VirtualMachineError_klass()),
 203                &quot;Exceptions should not be possible here&quot;);
 204         if (k2 == k) {
 205           log_trace(class, nestmates)(&quot;- class is listed as a nest member&quot;);
 206           return true;
 207         }
 208         else {
 209           // same name but different klass!
 210           log_trace(class, nestmates)(&quot; - klass comparison failed!&quot;);
 211           // can&#39;t have two names the same, so we&#39;re done
 212           return false;
 213         }
 214       }
 215     }
 216   }
 217   log_trace(class, nestmates)(&quot;- class is NOT a nest member!&quot;);
 218   return false;
 219 }
 220 
 221 // Return nest-host class, resolving, validating and saving it if needed.
 222 // In cases where this is called from a thread that cannot do classloading
 223 // (such as a native JIT thread) then we simply return NULL, which in turn
 224 // causes the access check to return false. Such code will retry the access
 225 // from a more suitable environment later. Otherwise the _nest_host is always
 226 // set once this method returns.
 227 // Any errors from nest-host resolution must be preserved so they can be queried
 228 // from higher-level access checking code, and reported as part of access checking
 229 // exceptions.
 230 // VirtualMachineErrors are propagated with a NULL return.
 231 // Under any conditions where the _nest_host can be set to non-NULL the resulting
 232 // value of it and, if applicable, the nest host resolution/validation error,
 233 // are idempotent.
 234 InstanceKlass* InstanceKlass::nest_host(TRAPS) {
 235   InstanceKlass* nest_host_k = _nest_host;
 236   if (nest_host_k != NULL) {
 237     return nest_host_k;
 238   }
 239 
 240   ResourceMark rm(THREAD);
 241 
 242   // need to resolve and save our nest-host class.
 243   if (_nest_host_index != 0) { // we have a real nest_host
 244     // Before trying to resolve check if we&#39;re in a suitable context
 245     if (!THREAD-&gt;can_call_java() &amp;&amp; !_constants-&gt;tag_at(_nest_host_index).is_klass()) {
 246       log_trace(class, nestmates)(&quot;Rejected resolution of nest-host of %s in unsuitable thread&quot;,
 247                                   this-&gt;external_name());
 248       return NULL; // sentinel to say &quot;try again from a different context&quot;
 249     }
 250 
 251     log_trace(class, nestmates)(&quot;Resolving nest-host of %s using cp entry for %s&quot;,
 252                                 this-&gt;external_name(),
 253                                 _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string());
 254 
 255     Klass* k = _constants-&gt;klass_at(_nest_host_index, THREAD);
 256     if (HAS_PENDING_EXCEPTION) {
 257       if (PENDING_EXCEPTION-&gt;is_a(SystemDictionary::VirtualMachineError_klass())) {
 258         return NULL; // propagate VMEs
 259       }
 260       stringStream ss;
 261       char* target_host_class = _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string();
 262       ss.print(&quot;Nest host resolution of %s with host %s failed: &quot;,
 263                this-&gt;external_name(), target_host_class);
 264       java_lang_Throwable::print(PENDING_EXCEPTION, &amp;ss);
 265       const char* msg = ss.as_string(true /* on C-heap */);
 266       constantPoolHandle cph(THREAD, constants());
 267       SystemDictionary::add_nest_host_error(cph, _nest_host_index, msg);
 268       CLEAR_PENDING_EXCEPTION;
 269 
 270       log_trace(class, nestmates)(&quot;%s&quot;, msg);
 271     } else {
 272       // A valid nest-host is an instance class in the current package that lists this
 273       // class as a nest member. If any of these conditions are not met the class is
 274       // its own nest-host.
 275       const char* error = NULL;
 276 
 277       // JVMS 5.4.4 indicates package check comes first
 278       if (is_same_class_package(k)) {
 279         // Now check actual membership. We can&#39;t be a member if our &quot;host&quot; is
 280         // not an instance class.
 281         if (k-&gt;is_instance_klass()) {
 282           nest_host_k = InstanceKlass::cast(k);
 283           bool is_member = nest_host_k-&gt;has_nest_member(this, THREAD);
 284           // exception is rare, perhaps impossible
 285           if (!HAS_PENDING_EXCEPTION) {
 286             if (is_member) {
 287               _nest_host = nest_host_k; // save resolved nest-host value
 288 
 289               log_trace(class, nestmates)(&quot;Resolved nest-host of %s to %s&quot;,
 290                                           this-&gt;external_name(), k-&gt;external_name());
 291               return nest_host_k;
 292             } else {
 293               error = &quot;current type is not listed as a nest member&quot;;
 294             }
 295           } else {
 296             if (PENDING_EXCEPTION-&gt;is_a(SystemDictionary::VirtualMachineError_klass())) {
 297               return NULL; // propagate VMEs
 298             }
 299             stringStream ss;
 300             ss.print(&quot;exception on member check: &quot;);
 301             java_lang_Throwable::print(PENDING_EXCEPTION, &amp;ss);
 302             error = ss.as_string();
 303           }
 304         } else {
 305           error = &quot;host is not an instance class&quot;;
 306         }
 307       } else {
 308         error = &quot;types are in different packages&quot;;
 309       }
 310 
 311       // something went wrong, so record what and log it
 312       {
 313         stringStream ss;
 314         ss.print(&quot;Type %s (loader: %s) is not a nest member of type %s (loader: %s): %s&quot;,
 315                  this-&gt;external_name(),
 316                  this-&gt;class_loader_data()-&gt;loader_name_and_id(),
 317                  k-&gt;external_name(),
 318                  k-&gt;class_loader_data()-&gt;loader_name_and_id(),
 319                  error);
 320         const char* msg = ss.as_string(true /* on C-heap */);
 321         constantPoolHandle cph(THREAD, constants());
 322         SystemDictionary::add_nest_host_error(cph, _nest_host_index, msg);
 323         log_trace(class, nestmates)(&quot;%s&quot;, msg);
 324       }
 325     }
 326   } else {
 327     log_trace(class, nestmates)(&quot;Type %s is not part of a nest: setting nest-host to self&quot;,
 328                                 this-&gt;external_name());
 329   }
 330 
 331   // Either not in an explicit nest, or else an error occurred, so
 332   // the nest-host is set to `this`. Any thread that sees this assignment
 333   // will also see any setting of nest_host_error(), if applicable.
 334   return (_nest_host = this);
 335 }
 336 
 337 // Dynamic nest member support: set this class&#39;s nest host to the given class.
 338 // This occurs as part of the class definition, as soon as the instanceKlass
 339 // has been created and doesn&#39;t require further resolution. The code:
 340 //    lookup().defineHiddenClass(bytes_for_X, NESTMATE);
 341 // results in:
 342 //    class_of_X.set_nest_host(lookup().lookupClass().getNestHost())
 343 // If it has an explicit _nest_host_index or _nest_members, these will be ignored.
 344 // We also know the &quot;host&quot; is a valid nest-host in the same package so we can
 345 // assert some of those facts.
 346 void InstanceKlass::set_nest_host(InstanceKlass* host, TRAPS) {
 347   assert(is_hidden(), &quot;must be a hidden class&quot;);
 348   assert(host != NULL, &quot;NULL nest host specified&quot;);
 349   assert(_nest_host == NULL, &quot;current class has resolved nest-host&quot;);
 350   assert(nest_host_error(THREAD) == NULL, &quot;unexpected nest host resolution error exists: %s&quot;,
 351          nest_host_error(THREAD));
 352   assert((host-&gt;_nest_host == NULL &amp;&amp; host-&gt;_nest_host_index == 0) ||
 353          (host-&gt;_nest_host == host), &quot;proposed host is not a valid nest-host&quot;);
 354   // Can&#39;t assert this as package is not set yet:
 355   // assert(is_same_class_package(host), &quot;proposed host is in wrong package&quot;);
 356 
 357   if (log_is_enabled(Trace, class, nestmates)) {
 358     ResourceMark rm(THREAD);
 359     const char* msg = &quot;&quot;;
 360     // a hidden class does not expect a statically defined nest-host
 361     if (_nest_host_index &gt; 0) {
 362       msg = &quot;(the NestHost attribute in the current class is ignored)&quot;;
 363     } else if (_nest_members != NULL &amp;&amp; _nest_members != Universe::the_empty_short_array()) {
 364       msg = &quot;(the NestMembers attribute in the current class is ignored)&quot;;
 365     }
 366     log_trace(class, nestmates)(&quot;Injected type %s into the nest of %s %s&quot;,
 367                                 this-&gt;external_name(),
 368                                 host-&gt;external_name(),
 369                                 msg);
 370   }
 371   // set dynamic nest host
 372   _nest_host = host;
 373   // Record dependency to keep nest host from being unloaded before this class.
 374   ClassLoaderData* this_key = class_loader_data();
 375   this_key-&gt;record_dependency(host);
 376 }
 377 
 378 // check if &#39;this&#39; and k are nestmates (same nest_host), or k is our nest_host,
 379 // or we are k&#39;s nest_host - all of which is covered by comparing the two
 380 // resolved_nest_hosts.
 381 // Any exceptions (i.e. VMEs) are propagated.
 382 bool InstanceKlass::has_nestmate_access_to(InstanceKlass* k, TRAPS) {
 383 
 384   assert(this != k, &quot;this should be handled by higher-level code&quot;);
 385 
 386   // Per JVMS 5.4.4 we first resolve and validate the current class, then
 387   // the target class k.
 388 
 389   InstanceKlass* cur_host = nest_host(CHECK_false);
 390   if (cur_host == NULL) {
 391     return false;
 392   }
 393 
 394   Klass* k_nest_host = k-&gt;nest_host(CHECK_false);
 395   if (k_nest_host == NULL) {
 396     return false;
 397   }
 398 
 399   bool access = (cur_host == k_nest_host);
 400 
 401   ResourceMark rm(THREAD);
 402   log_trace(class, nestmates)(&quot;Class %s does %shave nestmate access to %s&quot;,
 403                               this-&gt;external_name(),
 404                               access ? &quot;&quot; : &quot;NOT &quot;,
 405                               k-&gt;external_name());
 406   return access;
 407 }
 408 
 409 const char* InstanceKlass::nest_host_error(TRAPS) {
 410   if (_nest_host_index == 0) {
 411     return NULL;
 412   } else {
 413     constantPoolHandle cph(THREAD, constants());
 414     return SystemDictionary::find_nest_host_error(cph, (int)_nest_host_index);
 415   }
 416 }
 417 
 418 InstanceKlass* InstanceKlass::allocate_instance_klass(const ClassFileParser&amp; parser, TRAPS) {
 419   bool is_hidden_or_anonymous = parser.is_hidden() || parser.is_unsafe_anonymous();
 420   const int size = InstanceKlass::size(parser.vtable_size(),
 421                                        parser.itable_size(),
 422                                        nonstatic_oop_map_size(parser.total_oop_map_count()),
 423                                        parser.is_interface(),
 424                                        parser.is_unsafe_anonymous(),
 425                                        should_store_fingerprint(is_hidden_or_anonymous));
 426 
 427   const Symbol* const class_name = parser.class_name();
 428   assert(class_name != NULL, &quot;invariant&quot;);
 429   ClassLoaderData* loader_data = parser.loader_data();
 430   assert(loader_data != NULL, &quot;invariant&quot;);
 431 
 432   InstanceKlass* ik;
 433 
 434   // Allocation
 435   if (REF_NONE == parser.reference_type()) {
 436     if (class_name == vmSymbols::java_lang_Class()) {
 437       // mirror
 438       ik = new (loader_data, size, THREAD) InstanceMirrorKlass(parser);
 439     }
 440     else if (is_class_loader(class_name, parser)) {
 441       // class loader
 442       ik = new (loader_data, size, THREAD) InstanceClassLoaderKlass(parser);
 443     } else {
 444       // normal
 445       ik = new (loader_data, size, THREAD) InstanceKlass(parser, InstanceKlass::_misc_kind_other);
 446     }
 447   } else {
 448     // reference
 449     ik = new (loader_data, size, THREAD) InstanceRefKlass(parser);
 450   }
 451 
 452   // Check for pending exception before adding to the loader data and incrementing
 453   // class count.  Can get OOM here.
 454   if (HAS_PENDING_EXCEPTION) {
 455     return NULL;
 456   }
 457 
 458   return ik;
 459 }
 460 
 461 
 462 // copy method ordering from resource area to Metaspace
 463 void InstanceKlass::copy_method_ordering(const intArray* m, TRAPS) {
 464   if (m != NULL) {
 465     // allocate a new array and copy contents (memcpy?)
 466     _method_ordering = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), m-&gt;length(), CHECK);
 467     for (int i = 0; i &lt; m-&gt;length(); i++) {
 468       _method_ordering-&gt;at_put(i, m-&gt;at(i));
 469     }
 470   } else {
 471     _method_ordering = Universe::the_empty_int_array();
 472   }
 473 }
 474 
 475 // create a new array of vtable_indices for default methods
 476 Array&lt;int&gt;* InstanceKlass::create_new_default_vtable_indices(int len, TRAPS) {
 477   Array&lt;int&gt;* vtable_indices = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), len, CHECK_NULL);
 478   assert(default_vtable_indices() == NULL, &quot;only create once&quot;);
 479   set_default_vtable_indices(vtable_indices);
 480   return vtable_indices;
 481 }
 482 
 483 InstanceKlass::InstanceKlass(const ClassFileParser&amp; parser, unsigned kind, KlassID id) :
 484   Klass(id),
 485   _nest_members(NULL),
 486   _nest_host_index(0),
 487   _nest_host(NULL),
 488   _record_components(NULL),
 489   _static_field_size(parser.static_field_size()),
 490   _nonstatic_oop_map_size(nonstatic_oop_map_size(parser.total_oop_map_count())),
 491   _itable_len(parser.itable_size()),
 492   _init_thread(NULL),
 493   _init_state(allocated),
 494   _reference_type(parser.reference_type())
 495 {
 496   set_vtable_length(parser.vtable_size());
 497   set_kind(kind);
 498   set_access_flags(parser.access_flags());
 499   if (parser.is_hidden()) set_is_hidden();
 500   set_is_unsafe_anonymous(parser.is_unsafe_anonymous());
 501   set_layout_helper(Klass::instance_layout_helper(parser.layout_size(),
 502                                                     false));
 503 
 504   assert(NULL == _methods, &quot;underlying memory not zeroed?&quot;);
 505   assert(is_instance_klass(), &quot;is layout incorrect?&quot;);
 506   assert(size_helper() == parser.layout_size(), &quot;incorrect size_helper?&quot;);
 507 
 508   if (Arguments::is_dumping_archive()) {
 509     SystemDictionaryShared::init_dumptime_info(this);
 510   }
 511 
 512   // Set biased locking bit for all instances of this class; it will be
 513   // cleared if revocation occurs too often for this type
 514   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled()) {
 515     set_prototype_header(markWord::biased_locking_prototype());
 516   }
 517 }
 518 
 519 void InstanceKlass::deallocate_methods(ClassLoaderData* loader_data,
 520                                        Array&lt;Method*&gt;* methods) {
 521   if (methods != NULL &amp;&amp; methods != Universe::the_empty_method_array() &amp;&amp;
 522       !methods-&gt;is_shared()) {
 523     for (int i = 0; i &lt; methods-&gt;length(); i++) {
 524       Method* method = methods-&gt;at(i);
 525       if (method == NULL) continue;  // maybe null if error processing
 526       // Only want to delete methods that are not executing for RedefineClasses.
 527       // The previous version will point to them so they&#39;re not totally dangling
 528       assert (!method-&gt;on_stack(), &quot;shouldn&#39;t be called with methods on stack&quot;);
 529       MetadataFactory::free_metadata(loader_data, method);
 530     }
 531     MetadataFactory::free_array&lt;Method*&gt;(loader_data, methods);
 532   }
 533 }
 534 
 535 void InstanceKlass::deallocate_interfaces(ClassLoaderData* loader_data,
 536                                           const Klass* super_klass,
 537                                           Array&lt;InstanceKlass*&gt;* local_interfaces,
 538                                           Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
 539   // Only deallocate transitive interfaces if not empty, same as super class
 540   // or same as local interfaces.  See code in parseClassFile.
 541   Array&lt;InstanceKlass*&gt;* ti = transitive_interfaces;
 542   if (ti != Universe::the_empty_instance_klass_array() &amp;&amp; ti != local_interfaces) {
 543     // check that the interfaces don&#39;t come from super class
 544     Array&lt;InstanceKlass*&gt;* sti = (super_klass == NULL) ? NULL :
 545                     InstanceKlass::cast(super_klass)-&gt;transitive_interfaces();
 546     if (ti != sti &amp;&amp; ti != NULL &amp;&amp; !ti-&gt;is_shared()) {
 547       MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, ti);
 548     }
 549   }
 550 
 551   // local interfaces can be empty
 552   if (local_interfaces != Universe::the_empty_instance_klass_array() &amp;&amp;
 553       local_interfaces != NULL &amp;&amp; !local_interfaces-&gt;is_shared()) {
 554     MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, local_interfaces);
 555   }
 556 }
 557 
 558 void InstanceKlass::deallocate_record_components(ClassLoaderData* loader_data,
 559                                                  Array&lt;RecordComponent*&gt;* record_components) {
 560   if (record_components != NULL &amp;&amp; !record_components-&gt;is_shared()) {
 561     for (int i = 0; i &lt; record_components-&gt;length(); i++) {
 562       RecordComponent* record_component = record_components-&gt;at(i);
 563       MetadataFactory::free_metadata(loader_data, record_component);
 564     }
 565     MetadataFactory::free_array&lt;RecordComponent*&gt;(loader_data, record_components);
 566   }
 567 }
 568 
 569 // This function deallocates the metadata and C heap pointers that the
 570 // InstanceKlass points to.
 571 void InstanceKlass::deallocate_contents(ClassLoaderData* loader_data) {
 572 
 573   // Orphan the mirror first, CMS thinks it&#39;s still live.
 574   if (java_mirror() != NULL) {
 575     java_lang_Class::set_klass(java_mirror(), NULL);
 576   }
 577 
 578   // Also remove mirror from handles
 579   loader_data-&gt;remove_handle(_java_mirror);
 580 
 581   // Need to take this class off the class loader data list.
 582   loader_data-&gt;remove_class(this);
 583 
 584   // The array_klass for this class is created later, after error handling.
 585   // For class redefinition, we keep the original class so this scratch class
 586   // doesn&#39;t have an array class.  Either way, assert that there is nothing
 587   // to deallocate.
 588   assert(array_klasses() == NULL, &quot;array classes shouldn&#39;t be created for this class yet&quot;);
 589 
 590   // Release C heap allocated data that this might point to, which includes
 591   // reference counting symbol names.
 592   release_C_heap_structures();
 593 
 594   deallocate_methods(loader_data, methods());
 595   set_methods(NULL);
 596 
 597   deallocate_record_components(loader_data, record_components());
 598   set_record_components(NULL);
 599 
 600   if (method_ordering() != NULL &amp;&amp;
 601       method_ordering() != Universe::the_empty_int_array() &amp;&amp;
 602       !method_ordering()-&gt;is_shared()) {
 603     MetadataFactory::free_array&lt;int&gt;(loader_data, method_ordering());
 604   }
 605   set_method_ordering(NULL);
 606 
 607   // default methods can be empty
 608   if (default_methods() != NULL &amp;&amp;
 609       default_methods() != Universe::the_empty_method_array() &amp;&amp;
 610       !default_methods()-&gt;is_shared()) {
 611     MetadataFactory::free_array&lt;Method*&gt;(loader_data, default_methods());
 612   }
 613   // Do NOT deallocate the default methods, they are owned by superinterfaces.
 614   set_default_methods(NULL);
 615 
 616   // default methods vtable indices can be empty
 617   if (default_vtable_indices() != NULL &amp;&amp;
 618       !default_vtable_indices()-&gt;is_shared()) {
 619     MetadataFactory::free_array&lt;int&gt;(loader_data, default_vtable_indices());
 620   }
 621   set_default_vtable_indices(NULL);
 622 
 623 
 624   // This array is in Klass, but remove it with the InstanceKlass since
 625   // this place would be the only caller and it can share memory with transitive
 626   // interfaces.
 627   if (secondary_supers() != NULL &amp;&amp;
 628       secondary_supers() != Universe::the_empty_klass_array() &amp;&amp;
 629       // see comments in compute_secondary_supers about the following cast
 630       (address)(secondary_supers()) != (address)(transitive_interfaces()) &amp;&amp;
 631       !secondary_supers()-&gt;is_shared()) {
 632     MetadataFactory::free_array&lt;Klass*&gt;(loader_data, secondary_supers());
 633   }
 634   set_secondary_supers(NULL);
 635 
 636   deallocate_interfaces(loader_data, super(), local_interfaces(), transitive_interfaces());
 637   set_transitive_interfaces(NULL);
 638   set_local_interfaces(NULL);
 639 
 640   if (fields() != NULL &amp;&amp; !fields()-&gt;is_shared()) {
 641     MetadataFactory::free_array&lt;jushort&gt;(loader_data, fields());
 642   }
 643   set_fields(NULL, 0);
 644 
 645   // If a method from a redefined class is using this constant pool, don&#39;t
 646   // delete it, yet.  The new class&#39;s previous version will point to this.
 647   if (constants() != NULL) {
 648     assert (!constants()-&gt;on_stack(), &quot;shouldn&#39;t be called if anything is onstack&quot;);
 649     if (!constants()-&gt;is_shared()) {
 650       MetadataFactory::free_metadata(loader_data, constants());
 651     }
 652     // Delete any cached resolution errors for the constant pool
 653     SystemDictionary::delete_resolution_error(constants());
 654 
 655     set_constants(NULL);
 656   }
 657 
 658   if (inner_classes() != NULL &amp;&amp;
 659       inner_classes() != Universe::the_empty_short_array() &amp;&amp;
 660       !inner_classes()-&gt;is_shared()) {
 661     MetadataFactory::free_array&lt;jushort&gt;(loader_data, inner_classes());
 662   }
 663   set_inner_classes(NULL);
 664 
 665   if (nest_members() != NULL &amp;&amp;
 666       nest_members() != Universe::the_empty_short_array() &amp;&amp;
 667       !nest_members()-&gt;is_shared()) {
 668     MetadataFactory::free_array&lt;jushort&gt;(loader_data, nest_members());
 669   }
 670   set_nest_members(NULL);
 671 
 672   // We should deallocate the Annotations instance if it&#39;s not in shared spaces.
 673   if (annotations() != NULL &amp;&amp; !annotations()-&gt;is_shared()) {
 674     MetadataFactory::free_metadata(loader_data, annotations());
 675   }
 676   set_annotations(NULL);
 677 
 678   if (Arguments::is_dumping_archive()) {
 679     SystemDictionaryShared::remove_dumptime_info(this);
 680   }
 681 }
 682 
 683 bool InstanceKlass::should_be_initialized() const {
 684   return !is_initialized();
 685 }
 686 
 687 klassItable InstanceKlass::itable() const {
 688   return klassItable(const_cast&lt;InstanceKlass*&gt;(this));
 689 }
 690 
 691 void InstanceKlass::eager_initialize(Thread *thread) {
 692   if (!EagerInitialization) return;
 693 
 694   if (this-&gt;is_not_initialized()) {
 695     // abort if the the class has a class initializer
 696     if (this-&gt;class_initializer() != NULL) return;
 697 
 698     // abort if it is java.lang.Object (initialization is handled in genesis)
 699     Klass* super_klass = super();
 700     if (super_klass == NULL) return;
 701 
 702     // abort if the super class should be initialized
 703     if (!InstanceKlass::cast(super_klass)-&gt;is_initialized()) return;
 704 
 705     // call body to expose the this pointer
 706     eager_initialize_impl();
 707   }
 708 }
 709 
 710 // JVMTI spec thinks there are signers and protection domain in the
 711 // instanceKlass.  These accessors pretend these fields are there.
 712 // The hprof specification also thinks these fields are in InstanceKlass.
 713 oop InstanceKlass::protection_domain() const {
 714   // return the protection_domain from the mirror
 715   return java_lang_Class::protection_domain(java_mirror());
 716 }
 717 
 718 // To remove these from requires an incompatible change and CCC request.
 719 objArrayOop InstanceKlass::signers() const {
 720   // return the signers from the mirror
 721   return java_lang_Class::signers(java_mirror());
 722 }
 723 
 724 oop InstanceKlass::init_lock() const {
 725   // return the init lock from the mirror
 726   oop lock = java_lang_Class::init_lock(java_mirror());
 727   // Prevent reordering with any access of initialization state
 728   OrderAccess::loadload();
 729   assert((oop)lock != NULL || !is_not_initialized(), // initialized or in_error state
 730          &quot;only fully initialized state can have a null lock&quot;);
 731   return lock;
 732 }
 733 
 734 // Set the initialization lock to null so the object can be GC&#39;ed.  Any racing
 735 // threads to get this lock will see a null lock and will not lock.
 736 // That&#39;s okay because they all check for initialized state after getting
 737 // the lock and return.
 738 void InstanceKlass::fence_and_clear_init_lock() {
 739   // make sure previous stores are all done, notably the init_state.
 740   OrderAccess::storestore();
 741   java_lang_Class::set_init_lock(java_mirror(), NULL);
 742   assert(!is_not_initialized(), &quot;class must be initialized now&quot;);
 743 }
 744 
 745 void InstanceKlass::eager_initialize_impl() {
 746   EXCEPTION_MARK;
 747   HandleMark hm(THREAD);
 748   Handle h_init_lock(THREAD, init_lock());
 749   ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 750 
 751   // abort if someone beat us to the initialization
 752   if (!is_not_initialized()) return;  // note: not equivalent to is_initialized()
 753 
 754   ClassState old_state = init_state();
 755   link_class_impl(THREAD);
 756   if (HAS_PENDING_EXCEPTION) {
 757     CLEAR_PENDING_EXCEPTION;
 758     // Abort if linking the class throws an exception.
 759 
 760     // Use a test to avoid redundantly resetting the state if there&#39;s
 761     // no change.  Set_init_state() asserts that state changes make
 762     // progress, whereas here we might just be spinning in place.
 763     if (old_state != _init_state)
 764       set_init_state(old_state);
 765   } else {
 766     // linking successfull, mark class as initialized
 767     set_init_state(fully_initialized);
 768     fence_and_clear_init_lock();
 769     // trace
 770     if (log_is_enabled(Info, class, init)) {
 771       ResourceMark rm(THREAD);
 772       log_info(class, init)(&quot;[Initialized %s without side effects]&quot;, external_name());
 773     }
 774   }
 775 }
 776 
 777 
 778 // See &quot;The Virtual Machine Specification&quot; section 2.16.5 for a detailed explanation of the class initialization
 779 // process. The step comments refers to the procedure described in that section.
 780 // Note: implementation moved to static method to expose the this pointer.
 781 void InstanceKlass::initialize(TRAPS) {
 782   if (this-&gt;should_be_initialized()) {
 783     initialize_impl(CHECK);
 784     // Note: at this point the class may be initialized
 785     //       OR it may be in the state of being initialized
 786     //       in case of recursive initialization!
 787   } else {
 788     assert(is_initialized(), &quot;sanity check&quot;);
 789   }
 790 }
 791 
 792 
 793 bool InstanceKlass::verify_code(TRAPS) {
 794   // 1) Verify the bytecodes
 795   return Verifier::verify(this, should_verify_class(), THREAD);
 796 }
 797 
 798 void InstanceKlass::link_class(TRAPS) {
 799   assert(is_loaded(), &quot;must be loaded&quot;);
 800   if (!is_linked()) {
 801     link_class_impl(CHECK);
 802   }
 803 }
 804 
 805 // Called to verify that a class can link during initialization, without
 806 // throwing a VerifyError.
 807 bool InstanceKlass::link_class_or_fail(TRAPS) {
 808   assert(is_loaded(), &quot;must be loaded&quot;);
 809   if (!is_linked()) {
 810     link_class_impl(CHECK_false);
 811   }
 812   return is_linked();
 813 }
 814 
 815 bool InstanceKlass::link_class_impl(TRAPS) {
 816   if (DumpSharedSpaces &amp;&amp; SystemDictionaryShared::has_class_failed_verification(this)) {
 817     // This is for CDS dumping phase only -- we use the in_error_state to indicate that
 818     // the class has failed verification. Throwing the NoClassDefFoundError here is just
 819     // a convenient way to stop repeat attempts to verify the same (bad) class.
 820     //
 821     // Note that the NoClassDefFoundError is not part of the JLS, and should not be thrown
 822     // if we are executing Java code. This is not a problem for CDS dumping phase since
 823     // it doesn&#39;t execute any Java code.
 824     ResourceMark rm(THREAD);
 825     Exceptions::fthrow(THREAD_AND_LOCATION,
 826                        vmSymbols::java_lang_NoClassDefFoundError(),
 827                        &quot;Class %s, or one of its supertypes, failed class initialization&quot;,
 828                        external_name());
 829     return false;
 830   }
 831   // return if already verified
 832   if (is_linked()) {
 833     return true;
 834   }
 835 
 836   // Timing
 837   // timer handles recursion
 838   assert(THREAD-&gt;is_Java_thread(), &quot;non-JavaThread in link_class_impl&quot;);
 839   JavaThread* jt = (JavaThread*)THREAD;
 840 
 841   // link super class before linking this class
 842   Klass* super_klass = super();
 843   if (super_klass != NULL) {
 844     if (super_klass-&gt;is_interface()) {  // check if super class is an interface
 845       ResourceMark rm(THREAD);
 846       Exceptions::fthrow(
 847         THREAD_AND_LOCATION,
 848         vmSymbols::java_lang_IncompatibleClassChangeError(),
 849         &quot;class %s has interface %s as super class&quot;,
 850         external_name(),
 851         super_klass-&gt;external_name()
 852       );
 853       return false;
 854     }
 855 
 856     InstanceKlass* ik_super = InstanceKlass::cast(super_klass);
 857     ik_super-&gt;link_class_impl(CHECK_false);
 858   }
 859 
 860   // link all interfaces implemented by this class before linking this class
 861   Array&lt;InstanceKlass*&gt;* interfaces = local_interfaces();
 862   int num_interfaces = interfaces-&gt;length();
 863   for (int index = 0; index &lt; num_interfaces; index++) {
 864     InstanceKlass* interk = interfaces-&gt;at(index);
 865     interk-&gt;link_class_impl(CHECK_false);
 866   }
 867 
 868   // in case the class is linked in the process of linking its superclasses
 869   if (is_linked()) {
 870     return true;
 871   }
 872 
 873   // trace only the link time for this klass that includes
 874   // the verification time
 875   PerfClassTraceTime vmtimer(ClassLoader::perf_class_link_time(),
 876                              ClassLoader::perf_class_link_selftime(),
 877                              ClassLoader::perf_classes_linked(),
 878                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
 879                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
 880                              PerfClassTraceTime::CLASS_LINK);
 881 
 882   // verification &amp; rewriting
 883   {
 884     HandleMark hm(THREAD);
 885     Handle h_init_lock(THREAD, init_lock());
 886     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 887     // rewritten will have been set if loader constraint error found
 888     // on an earlier link attempt
 889     // don&#39;t verify or rewrite if already rewritten
 890     //
 891 
 892     if (!is_linked()) {
 893       if (!is_rewritten()) {
 894         {
 895           bool verify_ok = verify_code(THREAD);
 896           if (!verify_ok) {
 897             return false;
 898           }
 899         }
 900 
 901         // Just in case a side-effect of verify linked this class already
 902         // (which can sometimes happen since the verifier loads classes
 903         // using custom class loaders, which are free to initialize things)
 904         if (is_linked()) {
 905           return true;
 906         }
 907 
 908         // also sets rewritten
 909         rewrite_class(CHECK_false);
 910       } else if (is_shared()) {
 911         SystemDictionaryShared::check_verification_constraints(this, CHECK_false);
 912       }
 913 
 914       // relocate jsrs and link methods after they are all rewritten
 915       link_methods(CHECK_false);
 916 
 917       // Initialize the vtable and interface table after
 918       // methods have been rewritten since rewrite may
 919       // fabricate new Method*s.
 920       // also does loader constraint checking
 921       //
 922       // initialize_vtable and initialize_itable need to be rerun for
 923       // a shared class if the class is not loaded by the NULL classloader.
 924       ClassLoaderData * loader_data = class_loader_data();
 925       if (!(is_shared() &amp;&amp;
 926             loader_data-&gt;is_the_null_class_loader_data())) {
 927         vtable().initialize_vtable(true, CHECK_false);
 928         itable().initialize_itable(true, CHECK_false);
 929       }
 930 #ifdef ASSERT
 931       else {
 932         vtable().verify(tty, true);
 933         // In case itable verification is ever added.
 934         // itable().verify(tty, true);
 935       }
 936 #endif
 937       set_init_state(linked);
 938       if (JvmtiExport::should_post_class_prepare()) {
 939         Thread *thread = THREAD;
 940         assert(thread-&gt;is_Java_thread(), &quot;thread-&gt;is_Java_thread()&quot;);
 941         JvmtiExport::post_class_prepare((JavaThread *) thread, this);
 942       }
 943     }
 944   }
 945   return true;
 946 }
 947 
 948 // Rewrite the byte codes of all of the methods of a class.
 949 // The rewriter must be called exactly once. Rewriting must happen after
 950 // verification but before the first method of the class is executed.
 951 void InstanceKlass::rewrite_class(TRAPS) {
 952   assert(is_loaded(), &quot;must be loaded&quot;);
 953   if (is_rewritten()) {
 954     assert(is_shared(), &quot;rewriting an unshared class?&quot;);
 955     return;
 956   }
 957   Rewriter::rewrite(this, CHECK);
 958   set_rewritten();
 959 }
 960 
 961 // Now relocate and link method entry points after class is rewritten.
 962 // This is outside is_rewritten flag. In case of an exception, it can be
 963 // executed more than once.
 964 void InstanceKlass::link_methods(TRAPS) {
 965   int len = methods()-&gt;length();
 966   for (int i = len-1; i &gt;= 0; i--) {
 967     methodHandle m(THREAD, methods()-&gt;at(i));
 968 
 969     // Set up method entry points for compiler and interpreter    .
 970     m-&gt;link_method(m, CHECK);
 971   }
 972 }
 973 
 974 // Eagerly initialize superinterfaces that declare default methods (concrete instance: any access)
 975 void InstanceKlass::initialize_super_interfaces(TRAPS) {
 976   assert (has_nonstatic_concrete_methods(), &quot;caller should have checked this&quot;);
 977   for (int i = 0; i &lt; local_interfaces()-&gt;length(); ++i) {
 978     InstanceKlass* ik = local_interfaces()-&gt;at(i);
 979 
 980     // Initialization is depth first search ie. we start with top of the inheritance tree
 981     // has_nonstatic_concrete_methods drives searching superinterfaces since it
 982     // means has_nonstatic_concrete_methods in its superinterface hierarchy
 983     if (ik-&gt;has_nonstatic_concrete_methods()) {
 984       ik-&gt;initialize_super_interfaces(CHECK);
 985     }
 986 
 987     // Only initialize() interfaces that &quot;declare&quot; concrete methods.
 988     if (ik-&gt;should_be_initialized() &amp;&amp; ik-&gt;declares_nonstatic_concrete_methods()) {
 989       ik-&gt;initialize(CHECK);
 990     }
 991   }
 992 }
 993 
 994 void InstanceKlass::initialize_impl(TRAPS) {
 995   HandleMark hm(THREAD);
 996 
 997   // Make sure klass is linked (verified) before initialization
 998   // A class could already be verified, since it has been reflected upon.
 999   link_class(CHECK);
1000 
1001   DTRACE_CLASSINIT_PROBE(required, -1);
1002 
1003   bool wait = false;
1004 
1005   assert(THREAD-&gt;is_Java_thread(), &quot;non-JavaThread in initialize_impl&quot;);
1006   JavaThread* jt = (JavaThread*)THREAD;
1007 
1008   // refer to the JVM book page 47 for description of steps
1009   // Step 1
1010   {
1011     Handle h_init_lock(THREAD, init_lock());
1012     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
1013 
1014     // Step 2
1015     // If we were to use wait() instead of waitInterruptibly() then
1016     // we might end up throwing IE from link/symbol resolution sites
1017     // that aren&#39;t expected to throw.  This would wreak havoc.  See 6320309.
1018     while (is_being_initialized() &amp;&amp; !is_reentrant_initialization(jt)) {
1019       wait = true;
1020       jt-&gt;set_class_to_be_initialized(this);
1021       ol.wait_uninterruptibly(jt);
1022       jt-&gt;set_class_to_be_initialized(NULL);
1023     }
1024 
1025     // Step 3
1026     if (is_being_initialized() &amp;&amp; is_reentrant_initialization(jt)) {
1027       DTRACE_CLASSINIT_PROBE_WAIT(recursive, -1, wait);
1028       return;
1029     }
1030 
1031     // Step 4
1032     if (is_initialized()) {
1033       DTRACE_CLASSINIT_PROBE_WAIT(concurrent, -1, wait);
1034       return;
1035     }
1036 
1037     // Step 5
1038     if (is_in_error_state()) {
1039       DTRACE_CLASSINIT_PROBE_WAIT(erroneous, -1, wait);
1040       ResourceMark rm(THREAD);
1041       const char* desc = &quot;Could not initialize class &quot;;
1042       const char* className = external_name();
1043       size_t msglen = strlen(desc) + strlen(className) + 1;
1044       char* message = NEW_RESOURCE_ARRAY(char, msglen);
1045       if (NULL == message) {
1046         // Out of memory: can&#39;t create detailed error message
1047           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), className);
1048       } else {
1049         jio_snprintf(message, msglen, &quot;%s%s&quot;, desc, className);
1050           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), message);
1051       }
1052     }
1053 
1054     // Step 6
1055     set_init_state(being_initialized);
1056     set_init_thread(jt);
1057   }
1058 
1059   // Step 7
1060   // Next, if C is a class rather than an interface, initialize it&#39;s super class and super
1061   // interfaces.
1062   if (!is_interface()) {
1063     Klass* super_klass = super();
1064     if (super_klass != NULL &amp;&amp; super_klass-&gt;should_be_initialized()) {
1065       super_klass-&gt;initialize(THREAD);
1066     }
1067     // If C implements any interface that declares a non-static, concrete method,
1068     // the initialization of C triggers initialization of its super interfaces.
1069     // Only need to recurse if has_nonstatic_concrete_methods which includes declaring and
1070     // having a superinterface that declares, non-static, concrete methods
1071     if (!HAS_PENDING_EXCEPTION &amp;&amp; has_nonstatic_concrete_methods()) {
1072       initialize_super_interfaces(THREAD);
1073     }
1074 
1075     // If any exceptions, complete abruptly, throwing the same exception as above.
1076     if (HAS_PENDING_EXCEPTION) {
1077       Handle e(THREAD, PENDING_EXCEPTION);
1078       CLEAR_PENDING_EXCEPTION;
1079       {
1080         EXCEPTION_MARK;
1081         // Locks object, set state, and notify all waiting threads
1082         set_initialization_state_and_notify(initialization_error, THREAD);
1083         CLEAR_PENDING_EXCEPTION;
1084       }
1085       DTRACE_CLASSINIT_PROBE_WAIT(super__failed, -1, wait);
1086       THROW_OOP(e());
1087     }
1088   }
1089 
1090 
1091   // Look for aot compiled methods for this klass, including class initializer.
1092   AOTLoader::load_for_klass(this, THREAD);
1093 
1094   // Step 8
1095   {
1096     DTRACE_CLASSINIT_PROBE_WAIT(clinit, -1, wait);
1097     // Timer includes any side effects of class initialization (resolution,
1098     // etc), but not recursive entry into call_class_initializer().
1099     PerfClassTraceTime timer(ClassLoader::perf_class_init_time(),
1100                              ClassLoader::perf_class_init_selftime(),
1101                              ClassLoader::perf_classes_inited(),
1102                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
1103                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
1104                              PerfClassTraceTime::CLASS_CLINIT);
1105     call_class_initializer(THREAD);
1106   }
1107 
1108   // Step 9
1109   if (!HAS_PENDING_EXCEPTION) {
1110     set_initialization_state_and_notify(fully_initialized, CHECK);
1111     {
1112       debug_only(vtable().verify(tty, true);)
1113     }
1114   }
1115   else {
1116     // Step 10 and 11
1117     Handle e(THREAD, PENDING_EXCEPTION);
1118     CLEAR_PENDING_EXCEPTION;
1119     // JVMTI has already reported the pending exception
1120     // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1121     JvmtiExport::clear_detected_exception(jt);
1122     {
1123       EXCEPTION_MARK;
1124       set_initialization_state_and_notify(initialization_error, THREAD);
1125       CLEAR_PENDING_EXCEPTION;   // ignore any exception thrown, class initialization error is thrown below
1126       // JVMTI has already reported the pending exception
1127       // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1128       JvmtiExport::clear_detected_exception(jt);
1129     }
1130     DTRACE_CLASSINIT_PROBE_WAIT(error, -1, wait);
1131     if (e-&gt;is_a(SystemDictionary::Error_klass())) {
1132       THROW_OOP(e());
1133     } else {
1134       JavaCallArguments args(e);
1135       THROW_ARG(vmSymbols::java_lang_ExceptionInInitializerError(),
1136                 vmSymbols::throwable_void_signature(),
1137                 &amp;args);
1138     }
1139   }
1140   DTRACE_CLASSINIT_PROBE_WAIT(end, -1, wait);
1141 }
1142 
1143 
1144 void InstanceKlass::set_initialization_state_and_notify(ClassState state, TRAPS) {
1145   Handle h_init_lock(THREAD, init_lock());
1146   if (h_init_lock() != NULL) {
1147     ObjectLocker ol(h_init_lock, THREAD);
1148     set_init_thread(NULL); // reset _init_thread before changing _init_state
1149     set_init_state(state);
1150     fence_and_clear_init_lock();
1151     ol.notify_all(CHECK);
1152   } else {
1153     assert(h_init_lock() != NULL, &quot;The initialization state should never be set twice&quot;);
1154     set_init_thread(NULL); // reset _init_thread before changing _init_state
1155     set_init_state(state);
1156   }
1157 }
1158 
1159 Klass* InstanceKlass::implementor() const {
1160   Klass* volatile* k = adr_implementor();
1161   if (k == NULL) {
1162     return NULL;
1163   } else {
1164     // This load races with inserts, and therefore needs acquire.
1165     Klass* kls = Atomic::load_acquire(k);
1166     if (kls != NULL &amp;&amp; !kls-&gt;is_loader_alive()) {
1167       return NULL;  // don&#39;t return unloaded class
1168     } else {
1169       return kls;
1170     }
1171   }
1172 }
1173 
1174 
1175 void InstanceKlass::set_implementor(Klass* k) {
1176   assert_locked_or_safepoint(Compile_lock);
1177   assert(is_interface(), &quot;not interface&quot;);
1178   Klass* volatile* addr = adr_implementor();
1179   assert(addr != NULL, &quot;null addr&quot;);
1180   if (addr != NULL) {
1181     Atomic::release_store(addr, k);
1182   }
1183 }
1184 
1185 int  InstanceKlass::nof_implementors() const {
1186   Klass* k = implementor();
1187   if (k == NULL) {
1188     return 0;
1189   } else if (k != this) {
1190     return 1;
1191   } else {
1192     return 2;
1193   }
1194 }
1195 
1196 // The embedded _implementor field can only record one implementor.
1197 // When there are more than one implementors, the _implementor field
1198 // is set to the interface Klass* itself. Following are the possible
1199 // values for the _implementor field:
1200 //   NULL                  - no implementor
1201 //   implementor Klass*    - one implementor
1202 //   self                  - more than one implementor
1203 //
1204 // The _implementor field only exists for interfaces.
1205 void InstanceKlass::add_implementor(Klass* k) {
1206   if (Universe::is_fully_initialized()) {
1207     assert_lock_strong(Compile_lock);
1208   }
1209   assert(is_interface(), &quot;not interface&quot;);
1210   // Filter out my subinterfaces.
1211   // (Note: Interfaces are never on the subklass list.)
1212   if (InstanceKlass::cast(k)-&gt;is_interface()) return;
1213 
1214   // Filter out subclasses whose supers already implement me.
1215   // (Note: CHA must walk subclasses of direct implementors
1216   // in order to locate indirect implementors.)
1217   Klass* sk = k-&gt;super();
1218   if (sk != NULL &amp;&amp; InstanceKlass::cast(sk)-&gt;implements_interface(this))
1219     // We only need to check one immediate superclass, since the
1220     // implements_interface query looks at transitive_interfaces.
1221     // Any supers of the super have the same (or fewer) transitive_interfaces.
1222     return;
1223 
1224   Klass* ik = implementor();
1225   if (ik == NULL) {
1226     set_implementor(k);
1227   } else if (ik != this &amp;&amp; ik != k) {
1228     // There is already an implementor. Use itself as an indicator of
1229     // more than one implementors.
1230     set_implementor(this);
1231   }
1232 
1233   // The implementor also implements the transitive_interfaces
1234   for (int index = 0; index &lt; local_interfaces()-&gt;length(); index++) {
1235     InstanceKlass::cast(local_interfaces()-&gt;at(index))-&gt;add_implementor(k);
1236   }
1237 }
1238 
1239 void InstanceKlass::init_implementor() {
1240   if (is_interface()) {
1241     set_implementor(NULL);
1242   }
1243 }
1244 
1245 
1246 void InstanceKlass::process_interfaces(Thread *thread) {
1247   // link this class into the implementors list of every interface it implements
1248   for (int i = local_interfaces()-&gt;length() - 1; i &gt;= 0; i--) {
1249     assert(local_interfaces()-&gt;at(i)-&gt;is_klass(), &quot;must be a klass&quot;);
1250     InstanceKlass* interf = InstanceKlass::cast(local_interfaces()-&gt;at(i));
1251     assert(interf-&gt;is_interface(), &quot;expected interface&quot;);
1252     interf-&gt;add_implementor(this);
1253   }
1254 }
1255 
1256 bool InstanceKlass::can_be_primary_super_slow() const {
1257   if (is_interface())
1258     return false;
1259   else
1260     return Klass::can_be_primary_super_slow();
1261 }
1262 
1263 GrowableArray&lt;Klass*&gt;* InstanceKlass::compute_secondary_supers(int num_extra_slots,
1264                                                                Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
1265   // The secondaries are the implemented interfaces.
1266   Array&lt;InstanceKlass*&gt;* interfaces = transitive_interfaces;
1267   int num_secondaries = num_extra_slots + interfaces-&gt;length();
1268   if (num_secondaries == 0) {
1269     // Must share this for correct bootstrapping!
1270     set_secondary_supers(Universe::the_empty_klass_array());
1271     return NULL;
1272   } else if (num_extra_slots == 0) {
1273     // The secondary super list is exactly the same as the transitive interfaces, so
1274     // let&#39;s use it instead of making a copy.
1275     // Redefine classes has to be careful not to delete this!
1276     // We need the cast because Array&lt;Klass*&gt; is NOT a supertype of Array&lt;InstanceKlass*&gt;,
1277     // (but it&#39;s safe to do here because we won&#39;t write into _secondary_supers from this point on).
1278     set_secondary_supers((Array&lt;Klass*&gt;*)(address)interfaces);
1279     return NULL;
1280   } else {
1281     // Copy transitive interfaces to a temporary growable array to be constructed
1282     // into the secondary super list with extra slots.
1283     GrowableArray&lt;Klass*&gt;* secondaries = new GrowableArray&lt;Klass*&gt;(interfaces-&gt;length());
1284     for (int i = 0; i &lt; interfaces-&gt;length(); i++) {
1285       secondaries-&gt;push(interfaces-&gt;at(i));
1286     }
1287     return secondaries;
1288   }
1289 }
1290 
1291 bool InstanceKlass::implements_interface(Klass* k) const {
1292   if (this == k) return true;
1293   assert(k-&gt;is_interface(), &quot;should be an interface class&quot;);
1294   for (int i = 0; i &lt; transitive_interfaces()-&gt;length(); i++) {
1295     if (transitive_interfaces()-&gt;at(i) == k) {
1296       return true;
1297     }
1298   }
1299   return false;
1300 }
1301 
1302 bool InstanceKlass::is_same_or_direct_interface(Klass *k) const {
1303   // Verify direct super interface
1304   if (this == k) return true;
1305   assert(k-&gt;is_interface(), &quot;should be an interface class&quot;);
1306   for (int i = 0; i &lt; local_interfaces()-&gt;length(); i++) {
1307     if (local_interfaces()-&gt;at(i) == k) {
1308       return true;
1309     }
1310   }
1311   return false;
1312 }
1313 
1314 objArrayOop InstanceKlass::allocate_objArray(int n, int length, TRAPS) {
1315   check_array_allocation_length(length, arrayOopDesc::max_array_length(T_OBJECT), CHECK_NULL);
1316   int size = objArrayOopDesc::object_size(length);
1317   Klass* ak = array_klass(n, CHECK_NULL);
1318   objArrayOop o = (objArrayOop)Universe::heap()-&gt;array_allocate(ak, size, length,
1319                                                                 /* do_zero */ true, CHECK_NULL);
1320   return o;
1321 }
1322 
1323 instanceOop InstanceKlass::register_finalizer(instanceOop i, TRAPS) {
1324   if (TraceFinalizerRegistration) {
1325     tty-&gt;print(&quot;Registered &quot;);
1326     i-&gt;print_value_on(tty);
1327     tty-&gt;print_cr(&quot; (&quot; INTPTR_FORMAT &quot;) as finalizable&quot;, p2i(i));
1328   }
1329   instanceHandle h_i(THREAD, i);
1330   // Pass the handle as argument, JavaCalls::call expects oop as jobjects
1331   JavaValue result(T_VOID);
1332   JavaCallArguments args(h_i);
1333   methodHandle mh (THREAD, Universe::finalizer_register_method());
1334   JavaCalls::call(&amp;result, mh, &amp;args, CHECK_NULL);
1335   return h_i();
1336 }
1337 
1338 instanceOop InstanceKlass::allocate_instance(TRAPS) {
1339   bool has_finalizer_flag = has_finalizer(); // Query before possible GC
1340   int size = size_helper();  // Query before forming handle.
1341 
1342   instanceOop i;
1343 
1344   i = (instanceOop)Universe::heap()-&gt;obj_allocate(this, size, CHECK_NULL);
1345   if (has_finalizer_flag &amp;&amp; !RegisterFinalizersAtInit) {
1346     i = register_finalizer(i, CHECK_NULL);
1347   }
1348   return i;
1349 }
1350 
1351 instanceHandle InstanceKlass::allocate_instance_handle(TRAPS) {
1352   return instanceHandle(THREAD, allocate_instance(THREAD));
1353 }
1354 
1355 void InstanceKlass::check_valid_for_instantiation(bool throwError, TRAPS) {
1356   if (is_interface() || is_abstract()) {
1357     ResourceMark rm(THREAD);
1358     THROW_MSG(throwError ? vmSymbols::java_lang_InstantiationError()
1359               : vmSymbols::java_lang_InstantiationException(), external_name());
1360   }
1361   if (this == SystemDictionary::Class_klass()) {
1362     ResourceMark rm(THREAD);
1363     THROW_MSG(throwError ? vmSymbols::java_lang_IllegalAccessError()
1364               : vmSymbols::java_lang_IllegalAccessException(), external_name());
1365   }
1366 }
1367 
1368 Klass* InstanceKlass::array_klass_impl(bool or_null, int n, TRAPS) {
1369   // Need load-acquire for lock-free read
1370   if (array_klasses_acquire() == NULL) {
1371     if (or_null) return NULL;
1372 
1373     ResourceMark rm(THREAD);
1374     JavaThread *jt = (JavaThread *)THREAD;
1375     {
1376       // Atomic creation of array_klasses
1377       MutexLocker ma(THREAD, MultiArray_lock);
1378 
1379       // Check if update has already taken place
1380       if (array_klasses() == NULL) {
1381         Klass*    k = ObjArrayKlass::allocate_objArray_klass(class_loader_data(), 1, this, CHECK_NULL);
1382         // use &#39;release&#39; to pair with lock-free load
1383         release_set_array_klasses(k);
1384       }
1385     }
1386   }
1387   // _this will always be set at this point
1388   ObjArrayKlass* oak = (ObjArrayKlass*)array_klasses();
1389   if (or_null) {
1390     return oak-&gt;array_klass_or_null(n);
1391   }
1392   return oak-&gt;array_klass(n, THREAD);
1393 }
1394 
1395 Klass* InstanceKlass::array_klass_impl(bool or_null, TRAPS) {
1396   return array_klass_impl(or_null, 1, THREAD);
1397 }
1398 
1399 static int call_class_initializer_counter = 0;   // for debugging
1400 
1401 Method* InstanceKlass::class_initializer() const {
1402   Method* clinit = find_method(
1403       vmSymbols::class_initializer_name(), vmSymbols::void_method_signature());
1404   if (clinit != NULL &amp;&amp; clinit-&gt;has_valid_initializer_flags()) {
1405     return clinit;
1406   }
1407   return NULL;
1408 }
1409 
1410 void InstanceKlass::call_class_initializer(TRAPS) {
1411   if (ReplayCompiles &amp;&amp;
1412       (ReplaySuppressInitializers == 1 ||
1413        (ReplaySuppressInitializers &gt;= 2 &amp;&amp; class_loader() != NULL))) {
1414     // Hide the existence of the initializer for the purpose of replaying the compile
1415     return;
1416   }
1417 
1418   methodHandle h_method(THREAD, class_initializer());
1419   assert(!is_initialized(), &quot;we cannot initialize twice&quot;);
1420   LogTarget(Info, class, init) lt;
1421   if (lt.is_enabled()) {
1422     ResourceMark rm(THREAD);
1423     LogStream ls(lt);
1424     ls.print(&quot;%d Initializing &quot;, call_class_initializer_counter++);
1425     name()-&gt;print_value_on(&amp;ls);
1426     ls.print_cr(&quot;%s (&quot; INTPTR_FORMAT &quot;)&quot;, h_method() == NULL ? &quot;(no method)&quot; : &quot;&quot;, p2i(this));
1427   }
1428   if (h_method() != NULL) {
1429     JavaCallArguments args; // No arguments
1430     JavaValue result(T_VOID);
1431     JavaCalls::call(&amp;result, h_method, &amp;args, CHECK); // Static call (no args)
1432   }
1433 }
1434 
1435 
1436 void InstanceKlass::mask_for(const methodHandle&amp; method, int bci,
1437   InterpreterOopMap* entry_for) {
1438   // Lazily create the _oop_map_cache at first request
1439   // Lock-free access requires load_acquire.
1440   OopMapCache* oop_map_cache = Atomic::load_acquire(&amp;_oop_map_cache);
1441   if (oop_map_cache == NULL) {
1442     MutexLocker x(OopMapCacheAlloc_lock);
1443     // Check if _oop_map_cache was allocated while we were waiting for this lock
1444     if ((oop_map_cache = _oop_map_cache) == NULL) {
1445       oop_map_cache = new OopMapCache();
1446       // Ensure _oop_map_cache is stable, since it is examined without a lock
1447       Atomic::release_store(&amp;_oop_map_cache, oop_map_cache);
1448     }
1449   }
1450   // _oop_map_cache is constant after init; lookup below does its own locking.
1451   oop_map_cache-&gt;lookup(method, bci, entry_for);
1452 }
1453 
1454 bool InstanceKlass::contains_field_offset(int offset) {
1455   fieldDescriptor fd;
1456   return find_field_from_offset(offset, false, &amp;fd);
1457 }
1458 
1459 bool InstanceKlass::find_local_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1460   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1461     Symbol* f_name = fs.name();
1462     Symbol* f_sig  = fs.signature();
1463     if (f_name == name &amp;&amp; f_sig == sig) {
1464       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1465       return true;
1466     }
1467   }
1468   return false;
1469 }
1470 
1471 
1472 Klass* InstanceKlass::find_interface_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1473   const int n = local_interfaces()-&gt;length();
1474   for (int i = 0; i &lt; n; i++) {
1475     Klass* intf1 = local_interfaces()-&gt;at(i);
1476     assert(intf1-&gt;is_interface(), &quot;just checking type&quot;);
1477     // search for field in current interface
1478     if (InstanceKlass::cast(intf1)-&gt;find_local_field(name, sig, fd)) {
1479       assert(fd-&gt;is_static(), &quot;interface field must be static&quot;);
1480       return intf1;
1481     }
1482     // search for field in direct superinterfaces
1483     Klass* intf2 = InstanceKlass::cast(intf1)-&gt;find_interface_field(name, sig, fd);
1484     if (intf2 != NULL) return intf2;
1485   }
1486   // otherwise field lookup fails
1487   return NULL;
1488 }
1489 
1490 
1491 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1492   // search order according to newest JVM spec (5.4.3.2, p.167).
1493   // 1) search for field in current klass
1494   if (find_local_field(name, sig, fd)) {
1495     return const_cast&lt;InstanceKlass*&gt;(this);
1496   }
1497   // 2) search for field recursively in direct superinterfaces
1498   { Klass* intf = find_interface_field(name, sig, fd);
1499     if (intf != NULL) return intf;
1500   }
1501   // 3) apply field lookup recursively if superclass exists
1502   { Klass* supr = super();
1503     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, fd);
1504   }
1505   // 4) otherwise field lookup fails
1506   return NULL;
1507 }
1508 
1509 
1510 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, bool is_static, fieldDescriptor* fd) const {
1511   // search order according to newest JVM spec (5.4.3.2, p.167).
1512   // 1) search for field in current klass
1513   if (find_local_field(name, sig, fd)) {
1514     if (fd-&gt;is_static() == is_static) return const_cast&lt;InstanceKlass*&gt;(this);
1515   }
1516   // 2) search for field recursively in direct superinterfaces
1517   if (is_static) {
1518     Klass* intf = find_interface_field(name, sig, fd);
1519     if (intf != NULL) return intf;
1520   }
1521   // 3) apply field lookup recursively if superclass exists
1522   { Klass* supr = super();
1523     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, is_static, fd);
1524   }
1525   // 4) otherwise field lookup fails
1526   return NULL;
1527 }
1528 
1529 
1530 bool InstanceKlass::find_local_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1531   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1532     if (fs.offset() == offset) {
1533       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1534       if (fd-&gt;is_static() == is_static) return true;
1535     }
1536   }
1537   return false;
1538 }
1539 
1540 
1541 bool InstanceKlass::find_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1542   Klass* klass = const_cast&lt;InstanceKlass*&gt;(this);
1543   while (klass != NULL) {
1544     if (InstanceKlass::cast(klass)-&gt;find_local_field_from_offset(offset, is_static, fd)) {
1545       return true;
1546     }
1547     klass = klass-&gt;super();
1548   }
1549   return false;
1550 }
1551 
1552 
1553 void InstanceKlass::methods_do(void f(Method* method)) {
1554   // Methods aren&#39;t stable until they are loaded.  This can be read outside
1555   // a lock through the ClassLoaderData for profiling
1556   if (!is_loaded()) {
1557     return;
1558   }
1559 
1560   int len = methods()-&gt;length();
1561   for (int index = 0; index &lt; len; index++) {
1562     Method* m = methods()-&gt;at(index);
1563     assert(m-&gt;is_method(), &quot;must be method&quot;);
1564     f(m);
1565   }
1566 }
1567 
1568 
1569 void InstanceKlass::do_local_static_fields(FieldClosure* cl) {
1570   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1571     if (fs.access_flags().is_static()) {
1572       fieldDescriptor&amp; fd = fs.field_descriptor();
1573       cl-&gt;do_field(&amp;fd);
1574     }
1575   }
1576 }
1577 
1578 
1579 void InstanceKlass::do_local_static_fields(void f(fieldDescriptor*, Handle, TRAPS), Handle mirror, TRAPS) {
1580   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1581     if (fs.access_flags().is_static()) {
1582       fieldDescriptor&amp; fd = fs.field_descriptor();
1583       f(&amp;fd, mirror, CHECK);
1584     }
1585   }
1586 }
1587 
1588 
1589 static int compare_fields_by_offset(int* a, int* b) {
1590   return a[0] - b[0];
1591 }
1592 
1593 void InstanceKlass::do_nonstatic_fields(FieldClosure* cl) {
1594   InstanceKlass* super = superklass();
1595   if (super != NULL) {
1596     super-&gt;do_nonstatic_fields(cl);
1597   }
1598   fieldDescriptor fd;
1599   int length = java_fields_count();
1600   // In DebugInfo nonstatic fields are sorted by offset.
1601   int* fields_sorted = NEW_C_HEAP_ARRAY(int, 2*(length+1), mtClass);
1602   int j = 0;
1603   for (int i = 0; i &lt; length; i += 1) {
1604     fd.reinitialize(this, i);
1605     if (!fd.is_static()) {
1606       fields_sorted[j + 0] = fd.offset();
1607       fields_sorted[j + 1] = i;
1608       j += 2;
1609     }
1610   }
1611   if (j &gt; 0) {
1612     length = j;
1613     // _sort_Fn is defined in growableArray.hpp.
1614     qsort(fields_sorted, length/2, 2*sizeof(int), (_sort_Fn)compare_fields_by_offset);
1615     for (int i = 0; i &lt; length; i += 2) {
1616       fd.reinitialize(this, fields_sorted[i + 1]);
1617       assert(!fd.is_static() &amp;&amp; fd.offset() == fields_sorted[i], &quot;only nonstatic fields&quot;);
1618       cl-&gt;do_field(&amp;fd);
1619     }
1620   }
1621   FREE_C_HEAP_ARRAY(int, fields_sorted);
1622 }
1623 
1624 
1625 void InstanceKlass::array_klasses_do(void f(Klass* k, TRAPS), TRAPS) {
1626   if (array_klasses() != NULL)
1627     ArrayKlass::cast(array_klasses())-&gt;array_klasses_do(f, THREAD);
1628 }
1629 
1630 void InstanceKlass::array_klasses_do(void f(Klass* k)) {
1631   if (array_klasses() != NULL)
1632     ArrayKlass::cast(array_klasses())-&gt;array_klasses_do(f);
1633 }
1634 
1635 #ifdef ASSERT
1636 static int linear_search(const Array&lt;Method*&gt;* methods,
1637                          const Symbol* name,
1638                          const Symbol* signature) {
1639   const int len = methods-&gt;length();
1640   for (int index = 0; index &lt; len; index++) {
1641     const Method* const m = methods-&gt;at(index);
1642     assert(m-&gt;is_method(), &quot;must be method&quot;);
1643     if (m-&gt;signature() == signature &amp;&amp; m-&gt;name() == name) {
1644        return index;
1645     }
1646   }
1647   return -1;
1648 }
1649 #endif
1650 
1651 bool InstanceKlass::_disable_method_binary_search = false;
1652 
1653 NOINLINE int linear_search(const Array&lt;Method*&gt;* methods, const Symbol* name) {
1654   int len = methods-&gt;length();
1655   int l = 0;
1656   int h = len - 1;
1657   while (l &lt;= h) {
1658     Method* m = methods-&gt;at(l);
1659     if (m-&gt;name() == name) {
1660       return l;
1661     }
1662     l++;
1663   }
1664   return -1;
1665 }
1666 
1667 inline int InstanceKlass::quick_search(const Array&lt;Method*&gt;* methods, const Symbol* name) {
1668   if (_disable_method_binary_search) {
1669     assert(DynamicDumpSharedSpaces, &quot;must be&quot;);
1670     // At the final stage of dynamic dumping, the methods array may not be sorted
1671     // by ascending addresses of their names, so we can&#39;t use binary search anymore.
1672     // However, methods with the same name are still laid out consecutively inside the
1673     // methods array, so let&#39;s look for the first one that matches.
1674     return linear_search(methods, name);
1675   }
1676 
1677   int len = methods-&gt;length();
1678   int l = 0;
1679   int h = len - 1;
1680 
1681   // methods are sorted by ascending addresses of their names, so do binary search
1682   while (l &lt;= h) {
1683     int mid = (l + h) &gt;&gt; 1;
1684     Method* m = methods-&gt;at(mid);
1685     assert(m-&gt;is_method(), &quot;must be method&quot;);
1686     int res = m-&gt;name()-&gt;fast_compare(name);
1687     if (res == 0) {
1688       return mid;
1689     } else if (res &lt; 0) {
1690       l = mid + 1;
1691     } else {
1692       h = mid - 1;
1693     }
1694   }
1695   return -1;
1696 }
1697 
1698 // find_method looks up the name/signature in the local methods array
1699 Method* InstanceKlass::find_method(const Symbol* name,
1700                                    const Symbol* signature) const {
1701   return find_method_impl(name, signature, find_overpass, find_static, find_private);
1702 }
1703 
1704 Method* InstanceKlass::find_method_impl(const Symbol* name,
1705                                         const Symbol* signature,
1706                                         OverpassLookupMode overpass_mode,
1707                                         StaticLookupMode static_mode,
1708                                         PrivateLookupMode private_mode) const {
1709   return InstanceKlass::find_method_impl(methods(),
1710                                          name,
1711                                          signature,
1712                                          overpass_mode,
1713                                          static_mode,
1714                                          private_mode);
1715 }
1716 
1717 // find_instance_method looks up the name/signature in the local methods array
1718 // and skips over static methods
1719 Method* InstanceKlass::find_instance_method(const Array&lt;Method*&gt;* methods,
1720                                             const Symbol* name,
1721                                             const Symbol* signature,
1722                                             PrivateLookupMode private_mode) {
1723   Method* const meth = InstanceKlass::find_method_impl(methods,
1724                                                  name,
1725                                                  signature,
1726                                                  find_overpass,
1727                                                  skip_static,
1728                                                  private_mode);
1729   assert(((meth == NULL) || !meth-&gt;is_static()),
1730     &quot;find_instance_method should have skipped statics&quot;);
1731   return meth;
1732 }
1733 
1734 // find_instance_method looks up the name/signature in the local methods array
1735 // and skips over static methods
1736 Method* InstanceKlass::find_instance_method(const Symbol* name,
1737                                             const Symbol* signature,
1738                                             PrivateLookupMode private_mode) const {
1739   return InstanceKlass::find_instance_method(methods(), name, signature, private_mode);
1740 }
1741 
1742 // Find looks up the name/signature in the local methods array
1743 // and filters on the overpass, static and private flags
1744 // This returns the first one found
1745 // note that the local methods array can have up to one overpass, one static
1746 // and one instance (private or not) with the same name/signature
1747 Method* InstanceKlass::find_local_method(const Symbol* name,
1748                                          const Symbol* signature,
1749                                          OverpassLookupMode overpass_mode,
1750                                          StaticLookupMode static_mode,
1751                                          PrivateLookupMode private_mode) const {
1752   return InstanceKlass::find_method_impl(methods(),
1753                                          name,
1754                                          signature,
1755                                          overpass_mode,
1756                                          static_mode,
1757                                          private_mode);
1758 }
1759 
1760 // Find looks up the name/signature in the local methods array
1761 // and filters on the overpass, static and private flags
1762 // This returns the first one found
1763 // note that the local methods array can have up to one overpass, one static
1764 // and one instance (private or not) with the same name/signature
1765 Method* InstanceKlass::find_local_method(const Array&lt;Method*&gt;* methods,
1766                                          const Symbol* name,
1767                                          const Symbol* signature,
1768                                          OverpassLookupMode overpass_mode,
1769                                          StaticLookupMode static_mode,
1770                                          PrivateLookupMode private_mode) {
1771   return InstanceKlass::find_method_impl(methods,
1772                                          name,
1773                                          signature,
1774                                          overpass_mode,
1775                                          static_mode,
1776                                          private_mode);
1777 }
1778 
1779 Method* InstanceKlass::find_method(const Array&lt;Method*&gt;* methods,
1780                                    const Symbol* name,
1781                                    const Symbol* signature) {
1782   return InstanceKlass::find_method_impl(methods,
1783                                          name,
1784                                          signature,
1785                                          find_overpass,
1786                                          find_static,
1787                                          find_private);
1788 }
1789 
1790 Method* InstanceKlass::find_method_impl(const Array&lt;Method*&gt;* methods,
1791                                         const Symbol* name,
1792                                         const Symbol* signature,
1793                                         OverpassLookupMode overpass_mode,
1794                                         StaticLookupMode static_mode,
1795                                         PrivateLookupMode private_mode) {
1796   int hit = find_method_index(methods, name, signature, overpass_mode, static_mode, private_mode);
1797   return hit &gt;= 0 ? methods-&gt;at(hit): NULL;
1798 }
1799 
1800 // true if method matches signature and conforms to skipping_X conditions.
1801 static bool method_matches(const Method* m,
1802                            const Symbol* signature,
1803                            bool skipping_overpass,
1804                            bool skipping_static,
1805                            bool skipping_private) {
1806   return ((m-&gt;signature() == signature) &amp;&amp;
1807     (!skipping_overpass || !m-&gt;is_overpass()) &amp;&amp;
1808     (!skipping_static || !m-&gt;is_static()) &amp;&amp;
1809     (!skipping_private || !m-&gt;is_private()));
1810 }
1811 
1812 // Used directly for default_methods to find the index into the
1813 // default_vtable_indices, and indirectly by find_method
1814 // find_method_index looks in the local methods array to return the index
1815 // of the matching name/signature. If, overpass methods are being ignored,
1816 // the search continues to find a potential non-overpass match.  This capability
1817 // is important during method resolution to prefer a static method, for example,
1818 // over an overpass method.
1819 // There is the possibility in any _method&#39;s array to have the same name/signature
1820 // for a static method, an overpass method and a local instance method
1821 // To correctly catch a given method, the search criteria may need
1822 // to explicitly skip the other two. For local instance methods, it
1823 // is often necessary to skip private methods
1824 int InstanceKlass::find_method_index(const Array&lt;Method*&gt;* methods,
1825                                      const Symbol* name,
1826                                      const Symbol* signature,
1827                                      OverpassLookupMode overpass_mode,
1828                                      StaticLookupMode static_mode,
1829                                      PrivateLookupMode private_mode) {
1830   const bool skipping_overpass = (overpass_mode == skip_overpass);
1831   const bool skipping_static = (static_mode == skip_static);
1832   const bool skipping_private = (private_mode == skip_private);
1833   const int hit = quick_search(methods, name);
1834   if (hit != -1) {
1835     const Method* const m = methods-&gt;at(hit);
1836 
1837     // Do linear search to find matching signature.  First, quick check
1838     // for common case, ignoring overpasses if requested.
1839     if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1840       return hit;
1841     }
1842 
1843     // search downwards through overloaded methods
1844     int i;
1845     for (i = hit - 1; i &gt;= 0; --i) {
1846         const Method* const m = methods-&gt;at(i);
1847         assert(m-&gt;is_method(), &quot;must be method&quot;);
1848         if (m-&gt;name() != name) {
1849           break;
1850         }
1851         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1852           return i;
1853         }
1854     }
1855     // search upwards
1856     for (i = hit + 1; i &lt; methods-&gt;length(); ++i) {
1857         const Method* const m = methods-&gt;at(i);
1858         assert(m-&gt;is_method(), &quot;must be method&quot;);
1859         if (m-&gt;name() != name) {
1860           break;
1861         }
1862         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1863           return i;
1864         }
1865     }
1866     // not found
1867 #ifdef ASSERT
1868     const int index = (skipping_overpass || skipping_static || skipping_private) ? -1 :
1869       linear_search(methods, name, signature);
1870     assert(-1 == index, &quot;binary search should have found entry %d&quot;, index);
1871 #endif
1872   }
1873   return -1;
1874 }
1875 
1876 int InstanceKlass::find_method_by_name(const Symbol* name, int* end) const {
1877   return find_method_by_name(methods(), name, end);
1878 }
1879 
1880 int InstanceKlass::find_method_by_name(const Array&lt;Method*&gt;* methods,
1881                                        const Symbol* name,
1882                                        int* end_ptr) {
1883   assert(end_ptr != NULL, &quot;just checking&quot;);
1884   int start = quick_search(methods, name);
1885   int end = start + 1;
1886   if (start != -1) {
1887     while (start - 1 &gt;= 0 &amp;&amp; (methods-&gt;at(start - 1))-&gt;name() == name) --start;
1888     while (end &lt; methods-&gt;length() &amp;&amp; (methods-&gt;at(end))-&gt;name() == name) ++end;
1889     *end_ptr = end;
1890     return start;
1891   }
1892   return -1;
1893 }
1894 
1895 // uncached_lookup_method searches both the local class methods array and all
1896 // superclasses methods arrays, skipping any overpass methods in superclasses,
1897 // and possibly skipping private methods.
1898 Method* InstanceKlass::uncached_lookup_method(const Symbol* name,
1899                                               const Symbol* signature,
1900                                               OverpassLookupMode overpass_mode,
1901                                               PrivateLookupMode private_mode) const {
1902   OverpassLookupMode overpass_local_mode = overpass_mode;
1903   const Klass* klass = this;
1904   while (klass != NULL) {
1905     Method* const method = InstanceKlass::cast(klass)-&gt;find_method_impl(name,
1906                                                                         signature,
1907                                                                         overpass_local_mode,
1908                                                                         find_static,
1909                                                                         private_mode);
1910     if (method != NULL) {
1911       return method;
1912     }
1913     klass = klass-&gt;super();
1914     overpass_local_mode = skip_overpass;   // Always ignore overpass methods in superclasses
1915   }
1916   return NULL;
1917 }
1918 
1919 #ifdef ASSERT
1920 // search through class hierarchy and return true if this class or
1921 // one of the superclasses was redefined
1922 bool InstanceKlass::has_redefined_this_or_super() const {
1923   const Klass* klass = this;
1924   while (klass != NULL) {
1925     if (InstanceKlass::cast(klass)-&gt;has_been_redefined()) {
1926       return true;
1927     }
1928     klass = klass-&gt;super();
1929   }
1930   return false;
1931 }
1932 #endif
1933 
1934 // lookup a method in the default methods list then in all transitive interfaces
1935 // Do NOT return private or static methods
1936 Method* InstanceKlass::lookup_method_in_ordered_interfaces(Symbol* name,
1937                                                          Symbol* signature) const {
1938   Method* m = NULL;
1939   if (default_methods() != NULL) {
1940     m = find_method(default_methods(), name, signature);
1941   }
1942   // Look up interfaces
1943   if (m == NULL) {
1944     m = lookup_method_in_all_interfaces(name, signature, find_defaults);
1945   }
1946   return m;
1947 }
1948 
1949 // lookup a method in all the interfaces that this class implements
1950 // Do NOT return private or static methods, new in JDK8 which are not externally visible
1951 // They should only be found in the initial InterfaceMethodRef
1952 Method* InstanceKlass::lookup_method_in_all_interfaces(Symbol* name,
1953                                                        Symbol* signature,
1954                                                        DefaultsLookupMode defaults_mode) const {
1955   Array&lt;InstanceKlass*&gt;* all_ifs = transitive_interfaces();
1956   int num_ifs = all_ifs-&gt;length();
1957   InstanceKlass *ik = NULL;
1958   for (int i = 0; i &lt; num_ifs; i++) {
1959     ik = all_ifs-&gt;at(i);
1960     Method* m = ik-&gt;lookup_method(name, signature);
1961     if (m != NULL &amp;&amp; m-&gt;is_public() &amp;&amp; !m-&gt;is_static() &amp;&amp;
1962         ((defaults_mode != skip_defaults) || !m-&gt;is_default_method())) {
1963       return m;
1964     }
1965   }
1966   return NULL;
1967 }
1968 
1969 /* jni_id_for_impl for jfieldIds only */
1970 JNIid* InstanceKlass::jni_id_for_impl(int offset) {
1971   MutexLocker ml(JfieldIdCreation_lock);
1972   // Retry lookup after we got the lock
1973   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
1974   if (probe == NULL) {
1975     // Slow case, allocate new static field identifier
1976     probe = new JNIid(this, offset, jni_ids());
1977     set_jni_ids(probe);
1978   }
1979   return probe;
1980 }
1981 
1982 
1983 /* jni_id_for for jfieldIds only */
1984 JNIid* InstanceKlass::jni_id_for(int offset) {
1985   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
1986   if (probe == NULL) {
1987     probe = jni_id_for_impl(offset);
1988   }
1989   return probe;
1990 }
1991 
1992 u2 InstanceKlass::enclosing_method_data(int offset) const {
1993   const Array&lt;jushort&gt;* const inner_class_list = inner_classes();
1994   if (inner_class_list == NULL) {
1995     return 0;
1996   }
1997   const int length = inner_class_list-&gt;length();
1998   if (length % inner_class_next_offset == 0) {
1999     return 0;
2000   }
2001   const int index = length - enclosing_method_attribute_size;
2002   assert(offset &lt; enclosing_method_attribute_size, &quot;invalid offset&quot;);
2003   return inner_class_list-&gt;at(index + offset);
2004 }
2005 
2006 void InstanceKlass::set_enclosing_method_indices(u2 class_index,
2007                                                  u2 method_index) {
2008   Array&lt;jushort&gt;* inner_class_list = inner_classes();
2009   assert (inner_class_list != NULL, &quot;_inner_classes list is not set up&quot;);
2010   int length = inner_class_list-&gt;length();
2011   if (length % inner_class_next_offset == enclosing_method_attribute_size) {
2012     int index = length - enclosing_method_attribute_size;
2013     inner_class_list-&gt;at_put(
2014       index + enclosing_method_class_index_offset, class_index);
2015     inner_class_list-&gt;at_put(
2016       index + enclosing_method_method_index_offset, method_index);
2017   }
2018 }
2019 
2020 // Lookup or create a jmethodID.
2021 // This code is called by the VMThread and JavaThreads so the
2022 // locking has to be done very carefully to avoid deadlocks
2023 // and/or other cache consistency problems.
2024 //
2025 jmethodID InstanceKlass::get_jmethod_id(const methodHandle&amp; method_h) {
2026   size_t idnum = (size_t)method_h-&gt;method_idnum();
2027   jmethodID* jmeths = methods_jmethod_ids_acquire();
2028   size_t length = 0;
2029   jmethodID id = NULL;
2030 
2031   // We use a double-check locking idiom here because this cache is
2032   // performance sensitive. In the normal system, this cache only
2033   // transitions from NULL to non-NULL which is safe because we use
2034   // release_set_methods_jmethod_ids() to advertise the new cache.
2035   // A partially constructed cache should never be seen by a racing
2036   // thread. We also use release_store() to save a new jmethodID
2037   // in the cache so a partially constructed jmethodID should never be
2038   // seen either. Cache reads of existing jmethodIDs proceed without a
2039   // lock, but cache writes of a new jmethodID requires uniqueness and
2040   // creation of the cache itself requires no leaks so a lock is
2041   // generally acquired in those two cases.
2042   //
2043   // If the RedefineClasses() API has been used, then this cache can
2044   // grow and we&#39;ll have transitions from non-NULL to bigger non-NULL.
2045   // Cache creation requires no leaks and we require safety between all
2046   // cache accesses and freeing of the old cache so a lock is generally
2047   // acquired when the RedefineClasses() API has been used.
2048 
2049   if (jmeths != NULL) {
2050     // the cache already exists
2051     if (!idnum_can_increment()) {
2052       // the cache can&#39;t grow so we can just get the current values
2053       get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2054     } else {
2055       // cache can grow so we have to be more careful
2056       if (Threads::number_of_threads() == 0 ||
2057           SafepointSynchronize::is_at_safepoint()) {
2058         // we&#39;re single threaded or at a safepoint - no locking needed
2059         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2060       } else {
2061         MutexLocker ml(JmethodIdCreation_lock, Mutex::_no_safepoint_check_flag);
2062         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2063       }
2064     }
2065   }
2066   // implied else:
2067   // we need to allocate a cache so default length and id values are good
2068 
2069   if (jmeths == NULL ||   // no cache yet
2070       length &lt;= idnum ||  // cache is too short
2071       id == NULL) {       // cache doesn&#39;t contain entry
2072 
2073     // This function can be called by the VMThread so we have to do all
2074     // things that might block on a safepoint before grabbing the lock.
2075     // Otherwise, we can deadlock with the VMThread or have a cache
2076     // consistency issue. These vars keep track of what we might have
2077     // to free after the lock is dropped.
2078     jmethodID  to_dealloc_id     = NULL;
2079     jmethodID* to_dealloc_jmeths = NULL;
2080 
2081     // may not allocate new_jmeths or use it if we allocate it
2082     jmethodID* new_jmeths = NULL;
2083     if (length &lt;= idnum) {
2084       // allocate a new cache that might be used
2085       size_t size = MAX2(idnum+1, (size_t)idnum_allocated_count());
2086       new_jmeths = NEW_C_HEAP_ARRAY(jmethodID, size+1, mtClass);
2087       memset(new_jmeths, 0, (size+1)*sizeof(jmethodID));
2088       // cache size is stored in element[0], other elements offset by one
2089       new_jmeths[0] = (jmethodID)size;
2090     }
2091 
2092     // allocate a new jmethodID that might be used
2093     jmethodID new_id = NULL;
2094     if (method_h-&gt;is_old() &amp;&amp; !method_h-&gt;is_obsolete()) {
2095       // The method passed in is old (but not obsolete), we need to use the current version
2096       Method* current_method = method_with_idnum((int)idnum);
2097       assert(current_method != NULL, &quot;old and but not obsolete, so should exist&quot;);
2098       new_id = Method::make_jmethod_id(class_loader_data(), current_method);
2099     } else {
2100       // It is the current version of the method or an obsolete method,
2101       // use the version passed in
2102       new_id = Method::make_jmethod_id(class_loader_data(), method_h());
2103     }
2104 
2105     if (Threads::number_of_threads() == 0 ||
2106         SafepointSynchronize::is_at_safepoint()) {
2107       // we&#39;re single threaded or at a safepoint - no locking needed
2108       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
2109                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
2110     } else {
2111       MutexLocker ml(JmethodIdCreation_lock, Mutex::_no_safepoint_check_flag);
2112       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
2113                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
2114     }
2115 
2116     // The lock has been dropped so we can free resources.
2117     // Free up either the old cache or the new cache if we allocated one.
2118     if (to_dealloc_jmeths != NULL) {
2119       FreeHeap(to_dealloc_jmeths);
2120     }
2121     // free up the new ID since it wasn&#39;t needed
2122     if (to_dealloc_id != NULL) {
2123       Method::destroy_jmethod_id(class_loader_data(), to_dealloc_id);
2124     }
2125   }
2126   return id;
2127 }
2128 
2129 // Figure out how many jmethodIDs haven&#39;t been allocated, and make
2130 // sure space for them is pre-allocated.  This makes getting all
2131 // method ids much, much faster with classes with more than 8
2132 // methods, and has a *substantial* effect on performance with jvmti
2133 // code that loads all jmethodIDs for all classes.
2134 void InstanceKlass::ensure_space_for_methodids(int start_offset) {
2135   int new_jmeths = 0;
2136   int length = methods()-&gt;length();
2137   for (int index = start_offset; index &lt; length; index++) {
2138     Method* m = methods()-&gt;at(index);
2139     jmethodID id = m-&gt;find_jmethod_id_or_null();
2140     if (id == NULL) {
2141       new_jmeths++;
2142     }
2143   }
2144   if (new_jmeths != 0) {
2145     Method::ensure_jmethod_ids(class_loader_data(), new_jmeths);
2146   }
2147 }
2148 
2149 // Common code to fetch the jmethodID from the cache or update the
2150 // cache with the new jmethodID. This function should never do anything
2151 // that causes the caller to go to a safepoint or we can deadlock with
2152 // the VMThread or have cache consistency issues.
2153 //
2154 jmethodID InstanceKlass::get_jmethod_id_fetch_or_update(
2155             size_t idnum, jmethodID new_id,
2156             jmethodID* new_jmeths, jmethodID* to_dealloc_id_p,
2157             jmethodID** to_dealloc_jmeths_p) {
2158   assert(new_id != NULL, &quot;sanity check&quot;);
2159   assert(to_dealloc_id_p != NULL, &quot;sanity check&quot;);
2160   assert(to_dealloc_jmeths_p != NULL, &quot;sanity check&quot;);
2161   assert(Threads::number_of_threads() == 0 ||
2162          SafepointSynchronize::is_at_safepoint() ||
2163          JmethodIdCreation_lock-&gt;owned_by_self(), &quot;sanity check&quot;);
2164 
2165   // reacquire the cache - we are locked, single threaded or at a safepoint
2166   jmethodID* jmeths = methods_jmethod_ids_acquire();
2167   jmethodID  id     = NULL;
2168   size_t     length = 0;
2169 
2170   if (jmeths == NULL ||                         // no cache yet
2171       (length = (size_t)jmeths[0]) &lt;= idnum) {  // cache is too short
2172     if (jmeths != NULL) {
2173       // copy any existing entries from the old cache
2174       for (size_t index = 0; index &lt; length; index++) {
2175         new_jmeths[index+1] = jmeths[index+1];
2176       }
2177       *to_dealloc_jmeths_p = jmeths;  // save old cache for later delete
2178     }
2179     release_set_methods_jmethod_ids(jmeths = new_jmeths);
2180   } else {
2181     // fetch jmethodID (if any) from the existing cache
2182     id = jmeths[idnum+1];
2183     *to_dealloc_jmeths_p = new_jmeths;  // save new cache for later delete
2184   }
2185   if (id == NULL) {
2186     // No matching jmethodID in the existing cache or we have a new
2187     // cache or we just grew the cache. This cache write is done here
2188     // by the first thread to win the foot race because a jmethodID
2189     // needs to be unique once it is generally available.
2190     id = new_id;
2191 
2192     // The jmethodID cache can be read while unlocked so we have to
2193     // make sure the new jmethodID is complete before installing it
2194     // in the cache.
2195     Atomic::release_store(&amp;jmeths[idnum+1], id);
2196   } else {
2197     *to_dealloc_id_p = new_id; // save new id for later delete
2198   }
2199   return id;
2200 }
2201 
2202 
2203 // Common code to get the jmethodID cache length and the jmethodID
2204 // value at index idnum if there is one.
2205 //
2206 void InstanceKlass::get_jmethod_id_length_value(jmethodID* cache,
2207        size_t idnum, size_t *length_p, jmethodID* id_p) {
2208   assert(cache != NULL, &quot;sanity check&quot;);
2209   assert(length_p != NULL, &quot;sanity check&quot;);
2210   assert(id_p != NULL, &quot;sanity check&quot;);
2211 
2212   // cache size is stored in element[0], other elements offset by one
2213   *length_p = (size_t)cache[0];
2214   if (*length_p &lt;= idnum) {  // cache is too short
2215     *id_p = NULL;
2216   } else {
2217     *id_p = cache[idnum+1];  // fetch jmethodID (if any)
2218   }
2219 }
2220 
2221 
2222 // Lookup a jmethodID, NULL if not found.  Do no blocking, no allocations, no handles
2223 jmethodID InstanceKlass::jmethod_id_or_null(Method* method) {
2224   size_t idnum = (size_t)method-&gt;method_idnum();
2225   jmethodID* jmeths = methods_jmethod_ids_acquire();
2226   size_t length;                                // length assigned as debugging crumb
2227   jmethodID id = NULL;
2228   if (jmeths != NULL &amp;&amp;                         // If there is a cache
2229       (length = (size_t)jmeths[0]) &gt; idnum) {   // and if it is long enough,
2230     id = jmeths[idnum+1];                       // Look up the id (may be NULL)
2231   }
2232   return id;
2233 }
2234 
2235 inline DependencyContext InstanceKlass::dependencies() {
2236   DependencyContext dep_context(&amp;_dep_context, &amp;_dep_context_last_cleaned);
2237   return dep_context;
2238 }
2239 
2240 int InstanceKlass::mark_dependent_nmethods(KlassDepChange&amp; changes) {
2241   return dependencies().mark_dependent_nmethods(changes);
2242 }
2243 
2244 void InstanceKlass::add_dependent_nmethod(nmethod* nm) {
2245   dependencies().add_dependent_nmethod(nm);
2246 }
2247 
2248 void InstanceKlass::remove_dependent_nmethod(nmethod* nm) {
2249   dependencies().remove_dependent_nmethod(nm);
2250 }
2251 
2252 void InstanceKlass::clean_dependency_context() {
2253   dependencies().clean_unloading_dependents();
2254 }
2255 
2256 #ifndef PRODUCT
2257 void InstanceKlass::print_dependent_nmethods(bool verbose) {
2258   dependencies().print_dependent_nmethods(verbose);
2259 }
2260 
2261 bool InstanceKlass::is_dependent_nmethod(nmethod* nm) {
2262   return dependencies().is_dependent_nmethod(nm);
2263 }
2264 #endif //PRODUCT
2265 
2266 void InstanceKlass::clean_weak_instanceklass_links() {
2267   clean_implementors_list();
2268   clean_method_data();
2269 }
2270 
2271 void InstanceKlass::clean_implementors_list() {
2272   assert(is_loader_alive(), &quot;this klass should be live&quot;);
2273   if (is_interface()) {
2274     assert (ClassUnloading, &quot;only called for ClassUnloading&quot;);
2275     for (;;) {
2276       // Use load_acquire due to competing with inserts
2277       Klass* impl = Atomic::load_acquire(adr_implementor());
2278       if (impl != NULL &amp;&amp; !impl-&gt;is_loader_alive()) {
2279         // NULL this field, might be an unloaded klass or NULL
2280         Klass* volatile* klass = adr_implementor();
2281         if (Atomic::cmpxchg(klass, impl, (Klass*)NULL) == impl) {
2282           // Successfully unlinking implementor.
2283           if (log_is_enabled(Trace, class, unload)) {
2284             ResourceMark rm;
2285             log_trace(class, unload)(&quot;unlinking class (implementor): %s&quot;, impl-&gt;external_name());
2286           }
2287           return;
2288         }
2289       } else {
2290         return;
2291       }
2292     }
2293   }
2294 }
2295 
2296 void InstanceKlass::clean_method_data() {
2297   for (int m = 0; m &lt; methods()-&gt;length(); m++) {
2298     MethodData* mdo = methods()-&gt;at(m)-&gt;method_data();
2299     if (mdo != NULL) {
2300       MutexLocker ml(SafepointSynchronize::is_at_safepoint() ? NULL : mdo-&gt;extra_data_lock());
2301       mdo-&gt;clean_method_data(/*always_clean*/false);
2302     }
2303   }
2304 }
2305 
2306 bool InstanceKlass::supers_have_passed_fingerprint_checks() {
2307   if (java_super() != NULL &amp;&amp; !java_super()-&gt;has_passed_fingerprint_check()) {
2308     ResourceMark rm;
2309     log_trace(class, fingerprint)(&quot;%s : super %s not fingerprinted&quot;, external_name(), java_super()-&gt;external_name());
2310     return false;
2311   }
2312 
2313   Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
2314   if (local_interfaces != NULL) {
2315     int length = local_interfaces-&gt;length();
2316     for (int i = 0; i &lt; length; i++) {
2317       InstanceKlass* intf = local_interfaces-&gt;at(i);
2318       if (!intf-&gt;has_passed_fingerprint_check()) {
2319         ResourceMark rm;
2320         log_trace(class, fingerprint)(&quot;%s : interface %s not fingerprinted&quot;, external_name(), intf-&gt;external_name());
2321         return false;
2322       }
2323     }
2324   }
2325 
2326   return true;
2327 }
2328 
2329 bool InstanceKlass::should_store_fingerprint(bool is_hidden_or_anonymous) {
2330 #if INCLUDE_AOT
2331   // We store the fingerprint into the InstanceKlass only in the following 2 cases:
2332   if (CalculateClassFingerprint) {
2333     // (1) We are running AOT to generate a shared library.
2334     return true;
2335   }
2336   if (Arguments::is_dumping_archive()) {
2337     // (2) We are running -Xshare:dump or -XX:ArchiveClassesAtExit to create a shared archive
2338     return true;
2339   }
2340   if (UseAOT &amp;&amp; is_hidden_or_anonymous) {
2341     // (3) We are using AOT code from a shared library and see a hidden or unsafe anonymous class
2342     return true;
2343   }
2344 #endif
2345 
2346   // In all other cases we might set the _misc_has_passed_fingerprint_check bit,
2347   // but do not store the 64-bit fingerprint to save space.
2348   return false;
2349 }
2350 
2351 bool InstanceKlass::has_stored_fingerprint() const {
2352 #if INCLUDE_AOT
2353   return should_store_fingerprint() || is_shared();
2354 #else
2355   return false;
2356 #endif
2357 }
2358 
2359 uint64_t InstanceKlass::get_stored_fingerprint() const {
2360   address adr = adr_fingerprint();
2361   if (adr != NULL) {
2362     return (uint64_t)Bytes::get_native_u8(adr); // adr may not be 64-bit aligned
2363   }
2364   return 0;
2365 }
2366 
2367 void InstanceKlass::store_fingerprint(uint64_t fingerprint) {
2368   address adr = adr_fingerprint();
2369   if (adr != NULL) {
2370     Bytes::put_native_u8(adr, (u8)fingerprint); // adr may not be 64-bit aligned
2371 
2372     ResourceMark rm;
2373     log_trace(class, fingerprint)(&quot;stored as &quot; PTR64_FORMAT &quot; for class %s&quot;, fingerprint, external_name());
2374   }
2375 }
2376 
2377 void InstanceKlass::metaspace_pointers_do(MetaspaceClosure* it) {
2378   Klass::metaspace_pointers_do(it);
2379 
2380   if (log_is_enabled(Trace, cds)) {
2381     ResourceMark rm;
2382     log_trace(cds)(&quot;Iter(InstanceKlass): %p (%s)&quot;, this, external_name());
2383   }
2384 
2385   it-&gt;push(&amp;_annotations);
2386   it-&gt;push((Klass**)&amp;_array_klasses);
2387   it-&gt;push(&amp;_constants);
2388   it-&gt;push(&amp;_inner_classes);
2389   it-&gt;push(&amp;_array_name);
2390 #if INCLUDE_JVMTI
2391   it-&gt;push(&amp;_previous_versions);
2392 #endif
2393   it-&gt;push(&amp;_methods);
2394   it-&gt;push(&amp;_default_methods);
2395   it-&gt;push(&amp;_local_interfaces);
2396   it-&gt;push(&amp;_transitive_interfaces);
2397   it-&gt;push(&amp;_method_ordering);
2398   it-&gt;push(&amp;_default_vtable_indices);
2399   it-&gt;push(&amp;_fields);
2400 
2401   if (itable_length() &gt; 0) {
2402     itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
2403     int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
2404     int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
2405                          / itableOffsetEntry::size();
2406 
2407     for (int i = 0; i &lt; nof_interfaces; i ++, ioe ++) {
2408       if (ioe-&gt;interface_klass() != NULL) {
2409         it-&gt;push(ioe-&gt;interface_klass_addr());
2410         itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
2411         int n = klassItable::method_count_for_interface(ioe-&gt;interface_klass());
2412         for (int index = 0; index &lt; n; index ++) {
2413           it-&gt;push(ime[index].method_addr());
2414         }
2415       }
2416     }
2417   }
2418 
2419   it-&gt;push(&amp;_nest_members);
2420   it-&gt;push(&amp;_record_components);
2421 }
2422 
2423 void InstanceKlass::remove_unshareable_info() {
2424   Klass::remove_unshareable_info();
2425 
2426   if (SystemDictionaryShared::has_class_failed_verification(this)) {
2427     // Classes are attempted to link during dumping and may fail,
2428     // but these classes are still in the dictionary and class list in CLD.
2429     // If the class has failed verification, there is nothing else to remove.
2430     return;
2431   }
2432 
2433   // Reset to the &#39;allocated&#39; state to prevent any premature accessing to
2434   // a shared class at runtime while the class is still being loaded and
2435   // restored. A class&#39; init_state is set to &#39;loaded&#39; at runtime when it&#39;s
2436   // being added to class hierarchy (see SystemDictionary:::add_to_hierarchy()).
2437   _init_state = allocated;
2438 
2439   { // Otherwise this needs to take out the Compile_lock.
2440     assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
2441     init_implementor();
2442   }
2443 
2444   constants()-&gt;remove_unshareable_info();
2445 
2446   for (int i = 0; i &lt; methods()-&gt;length(); i++) {
2447     Method* m = methods()-&gt;at(i);
2448     m-&gt;remove_unshareable_info();
2449   }
2450 
2451   // do array classes also.
2452   if (array_klasses() != NULL) {
2453     array_klasses()-&gt;remove_unshareable_info();
2454   }
2455 
2456   // These are not allocated from metaspace. They are safe to set to NULL.
2457   _source_debug_extension = NULL;
2458   _dep_context = NULL;
2459   _osr_nmethods_head = NULL;
2460 #if INCLUDE_JVMTI
2461   _breakpoints = NULL;
2462   _previous_versions = NULL;
2463   _cached_class_file = NULL;
2464   _jvmti_cached_class_field_map = NULL;
2465 #endif
2466 
2467   _init_thread = NULL;
2468   _methods_jmethod_ids = NULL;
2469   _jni_ids = NULL;
2470   _oop_map_cache = NULL;
2471   // clear _nest_host to ensure re-load at runtime
2472   _nest_host = NULL;
2473   _package_entry = NULL;
2474   _dep_context_last_cleaned = 0;
2475 }
2476 
2477 void InstanceKlass::remove_java_mirror() {
2478   Klass::remove_java_mirror();
2479 
2480   // do array classes also.
2481   if (array_klasses() != NULL) {
2482     array_klasses()-&gt;remove_java_mirror();
2483   }
2484 }
2485 
2486 void InstanceKlass::restore_unshareable_info(ClassLoaderData* loader_data, Handle protection_domain,
2487                                              PackageEntry* pkg_entry, TRAPS) {
2488   // SystemDictionary::add_to_hierarchy() sets the init_state to loaded
2489   // before the InstanceKlass is added to the SystemDictionary. Make
2490   // sure the current state is &lt;loaded.
2491   assert(!is_loaded(), &quot;invalid init state&quot;);
2492   set_package(loader_data, pkg_entry, CHECK);
2493   Klass::restore_unshareable_info(loader_data, protection_domain, CHECK);
2494 
2495   Array&lt;Method*&gt;* methods = this-&gt;methods();
2496   int num_methods = methods-&gt;length();
2497   for (int index = 0; index &lt; num_methods; ++index) {
2498     methods-&gt;at(index)-&gt;restore_unshareable_info(CHECK);
2499   }
2500   if (JvmtiExport::has_redefined_a_class()) {
2501     // Reinitialize vtable because RedefineClasses may have changed some
2502     // entries in this vtable for super classes so the CDS vtable might
2503     // point to old or obsolete entries.  RedefineClasses doesn&#39;t fix up
2504     // vtables in the shared system dictionary, only the main one.
2505     // It also redefines the itable too so fix that too.
2506     vtable().initialize_vtable(false, CHECK);
2507     itable().initialize_itable(false, CHECK);
2508   }
2509 
2510   // restore constant pool resolved references
2511   constants()-&gt;restore_unshareable_info(CHECK);
2512 
2513   if (array_klasses() != NULL) {
2514     // Array classes have null protection domain.
2515     // --&gt; see ArrayKlass::complete_create_array_klass()
2516     ArrayKlass::cast(array_klasses())-&gt;restore_unshareable_info(ClassLoaderData::the_null_class_loader_data(), Handle(), CHECK);
2517   }
2518 
2519   // Initialize current biased locking state.
2520   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled()) {
2521     set_prototype_header(markWord::biased_locking_prototype());
2522   }
2523 }
2524 
2525 void InstanceKlass::set_shared_class_loader_type(s2 loader_type) {
2526   switch (loader_type) {
2527   case ClassLoader::BOOT_LOADER:
2528     _misc_flags |= _misc_is_shared_boot_class;
2529     break;
2530   case ClassLoader::PLATFORM_LOADER:
2531     _misc_flags |= _misc_is_shared_platform_class;
2532     break;
2533   case ClassLoader::APP_LOADER:
2534     _misc_flags |= _misc_is_shared_app_class;
2535     break;
2536   default:
2537     ShouldNotReachHere();
2538     break;
2539   }
2540 }
2541 
2542 #if INCLUDE_JVMTI
2543 static void clear_all_breakpoints(Method* m) {
2544   m-&gt;clear_all_breakpoints();
2545 }
2546 #endif
2547 
2548 void InstanceKlass::unload_class(InstanceKlass* ik) {
2549   // Release dependencies.
2550   ik-&gt;dependencies().remove_all_dependents();
2551 
2552   // notify the debugger
2553   if (JvmtiExport::should_post_class_unload()) {
2554     JvmtiExport::post_class_unload(ik);
2555   }
2556 
2557   // notify ClassLoadingService of class unload
2558   ClassLoadingService::notify_class_unloaded(ik);
2559 
2560   if (Arguments::is_dumping_archive()) {
2561     SystemDictionaryShared::remove_dumptime_info(ik);
2562   }
2563 
2564   if (log_is_enabled(Info, class, unload)) {
2565     ResourceMark rm;
2566     log_info(class, unload)(&quot;unloading class %s &quot; INTPTR_FORMAT, ik-&gt;external_name(), p2i(ik));
2567   }
2568 
2569   Events::log_class_unloading(Thread::current(), ik);
2570 
2571 #if INCLUDE_JFR
2572   assert(ik != NULL, &quot;invariant&quot;);
2573   EventClassUnload event;
2574   event.set_unloadedClass(ik);
2575   event.set_definingClassLoader(ik-&gt;class_loader_data());
2576   event.commit();
2577 #endif
2578 }
2579 
2580 static void method_release_C_heap_structures(Method* m) {
2581   m-&gt;release_C_heap_structures();
2582 }
2583 
2584 void InstanceKlass::release_C_heap_structures(InstanceKlass* ik) {
2585   // Clean up C heap
2586   ik-&gt;release_C_heap_structures();
2587   ik-&gt;constants()-&gt;release_C_heap_structures();
2588 
2589   // Deallocate and call destructors for MDO mutexes
2590   ik-&gt;methods_do(method_release_C_heap_structures);
2591 
2592 }
2593 
2594 void InstanceKlass::release_C_heap_structures() {
2595   // Can&#39;t release the constant pool here because the constant pool can be
2596   // deallocated separately from the InstanceKlass for default methods and
2597   // redefine classes.
2598 
2599   // Deallocate oop map cache
2600   if (_oop_map_cache != NULL) {
2601     delete _oop_map_cache;
2602     _oop_map_cache = NULL;
2603   }
2604 
2605   // Deallocate JNI identifiers for jfieldIDs
2606   JNIid::deallocate(jni_ids());
2607   set_jni_ids(NULL);
2608 
2609   jmethodID* jmeths = methods_jmethod_ids_acquire();
2610   if (jmeths != (jmethodID*)NULL) {
2611     release_set_methods_jmethod_ids(NULL);
2612     FreeHeap(jmeths);
2613   }
2614 
2615   assert(_dep_context == NULL,
2616          &quot;dependencies should already be cleaned&quot;);
2617 
2618 #if INCLUDE_JVMTI
2619   // Deallocate breakpoint records
2620   if (breakpoints() != 0x0) {
2621     methods_do(clear_all_breakpoints);
2622     assert(breakpoints() == 0x0, &quot;should have cleared breakpoints&quot;);
2623   }
2624 
2625   // deallocate the cached class file
2626   if (_cached_class_file != NULL) {
2627     os::free(_cached_class_file);
2628     _cached_class_file = NULL;
2629   }
2630 #endif
2631 
2632   // Decrement symbol reference counts associated with the unloaded class.
2633   if (_name != NULL) _name-&gt;decrement_refcount();
2634 
2635   // unreference array name derived from this class name (arrays of an unloaded
2636   // class can&#39;t be referenced anymore).
2637   if (_array_name != NULL)  _array_name-&gt;decrement_refcount();
2638   FREE_C_HEAP_ARRAY(char, _source_debug_extension);
2639 }
2640 
2641 void InstanceKlass::set_source_debug_extension(const char* array, int length) {
2642   if (array == NULL) {
2643     _source_debug_extension = NULL;
2644   } else {
2645     // Adding one to the attribute length in order to store a null terminator
2646     // character could cause an overflow because the attribute length is
2647     // already coded with an u4 in the classfile, but in practice, it&#39;s
2648     // unlikely to happen.
2649     assert((length+1) &gt; length, &quot;Overflow checking&quot;);
2650     char* sde = NEW_C_HEAP_ARRAY(char, (length + 1), mtClass);
2651     for (int i = 0; i &lt; length; i++) {
2652       sde[i] = array[i];
2653     }
2654     sde[length] = &#39;\0&#39;;
2655     _source_debug_extension = sde;
2656   }
2657 }
2658 
2659 const char* InstanceKlass::signature_name() const {
2660   int hash_len = 0;
2661   char hash_buf[40];
2662 
2663   // If this is an unsafe anonymous class, append a hash to make the name unique
2664   if (is_unsafe_anonymous()) {
2665     intptr_t hash = (java_mirror() != NULL) ? java_mirror()-&gt;identity_hash() : 0;
2666     jio_snprintf(hash_buf, sizeof(hash_buf), &quot;/&quot; UINTX_FORMAT, (uintx)hash);
2667     hash_len = (int)strlen(hash_buf);
2668   }
2669 
2670   // Get the internal name as a c string
2671   const char* src = (const char*) (name()-&gt;as_C_string());
2672   const int src_length = (int)strlen(src);
2673 
2674   char* dest = NEW_RESOURCE_ARRAY(char, src_length + hash_len + 3);
2675 
2676   // Add L as type indicator
2677   int dest_index = 0;
2678   dest[dest_index++] = JVM_SIGNATURE_CLASS;
2679 
2680   // Add the actual class name
2681   for (int src_index = 0; src_index &lt; src_length; ) {
2682     dest[dest_index++] = src[src_index++];
2683   }
2684 
2685   if (is_hidden()) { // Replace the last &#39;+&#39; with a &#39;.&#39;.
2686     for (int index = (int)src_length; index &gt; 0; index--) {
2687       if (dest[index] == &#39;+&#39;) {
2688         dest[index] = JVM_SIGNATURE_DOT;
2689         break;
2690       }
2691     }
2692   }
2693 
2694   // If we have a hash, append it
2695   for (int hash_index = 0; hash_index &lt; hash_len; ) {
2696     dest[dest_index++] = hash_buf[hash_index++];
2697   }
2698 
2699   // Add the semicolon and the NULL
2700   dest[dest_index++] = JVM_SIGNATURE_ENDCLASS;
2701   dest[dest_index] = &#39;\0&#39;;
2702   return dest;
2703 }
2704 
2705 ModuleEntry* InstanceKlass::module() const {
2706   // For an unsafe anonymous class return the host class&#39; module
2707   if (is_unsafe_anonymous()) {
2708     assert(unsafe_anonymous_host() != NULL, &quot;unsafe anonymous class must have a host class&quot;);
2709     return unsafe_anonymous_host()-&gt;module();
2710   }
2711 
2712   if (is_hidden() &amp;&amp;
2713       in_unnamed_package() &amp;&amp;
2714       class_loader_data()-&gt;has_class_mirror_holder()) {
2715     // For a non-strong hidden class defined to an unnamed package,
2716     // its (class held) CLD will not have an unnamed module created for it.
2717     // Two choices to find the correct ModuleEntry:
2718     // 1. If hidden class is within a nest, use nest host&#39;s module
2719     // 2. Find the unnamed module off from the class loader
2720     // For now option #2 is used since a nest host is not set until
2721     // after the instance class is created in jvm_lookup_define_class().
2722     if (class_loader_data()-&gt;is_boot_class_loader_data()) {
2723       return ClassLoaderData::the_null_class_loader_data()-&gt;unnamed_module();
2724     } else {
2725       oop module = java_lang_ClassLoader::unnamedModule(class_loader_data()-&gt;class_loader());
2726       assert(java_lang_Module::is_instance(module), &quot;Not an instance of java.lang.Module&quot;);
2727       return java_lang_Module::module_entry(module);
2728     }
2729   }
2730 
2731   // Class is in a named package
2732   if (!in_unnamed_package()) {
2733     return _package_entry-&gt;module();
2734   }
2735 
2736   // Class is in an unnamed package, return its loader&#39;s unnamed module
2737   return class_loader_data()-&gt;unnamed_module();
2738 }
2739 
2740 void InstanceKlass::set_package(ClassLoaderData* loader_data, PackageEntry* pkg_entry, TRAPS) {
2741 
2742   // ensure java/ packages only loaded by boot or platform builtin loaders
2743   // not needed for shared class since CDS does not archive prohibited classes.
2744   if (!is_shared()) {
2745     check_prohibited_package(name(), loader_data, CHECK);
2746   }
2747 
2748   TempNewSymbol pkg_name = pkg_entry != NULL ? pkg_entry-&gt;name() : ClassLoader::package_from_class_name(name());
2749 
2750   if (pkg_name != NULL &amp;&amp; loader_data != NULL) {
2751 
2752     // Find in class loader&#39;s package entry table.
2753     _package_entry = pkg_entry != NULL ? pkg_entry : loader_data-&gt;packages()-&gt;lookup_only(pkg_name);
2754 
2755     // If the package name is not found in the loader&#39;s package
2756     // entry table, it is an indication that the package has not
2757     // been defined. Consider it defined within the unnamed module.
2758     if (_package_entry == NULL) {
2759 
2760       if (!ModuleEntryTable::javabase_defined()) {
2761         // Before java.base is defined during bootstrapping, define all packages in
2762         // the java.base module.  If a non-java.base package is erroneously placed
2763         // in the java.base module it will be caught later when java.base
2764         // is defined by ModuleEntryTable::verify_javabase_packages check.
2765         assert(ModuleEntryTable::javabase_moduleEntry() != NULL, JAVA_BASE_NAME &quot; module is NULL&quot;);
2766         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name, ModuleEntryTable::javabase_moduleEntry());
2767       } else {
2768         assert(loader_data-&gt;unnamed_module() != NULL, &quot;unnamed module is NULL&quot;);
2769         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name,
2770                                                          loader_data-&gt;unnamed_module());
2771       }
2772 
2773       // A package should have been successfully created
2774       DEBUG_ONLY(ResourceMark rm(THREAD));
2775       assert(_package_entry != NULL, &quot;Package entry for class %s not found, loader %s&quot;,
2776              name()-&gt;as_C_string(), loader_data-&gt;loader_name_and_id());
2777     }
2778 
2779     if (log_is_enabled(Debug, module)) {
2780       ResourceMark rm(THREAD);
2781       ModuleEntry* m = _package_entry-&gt;module();
2782       log_trace(module)(&quot;Setting package: class: %s, package: %s, loader: %s, module: %s&quot;,
2783                         external_name(),
2784                         pkg_name-&gt;as_C_string(),
2785                         loader_data-&gt;loader_name_and_id(),
2786                         (m-&gt;is_named() ? m-&gt;name()-&gt;as_C_string() : UNNAMED_MODULE));
2787     }
2788   } else {
2789     ResourceMark rm(THREAD);
2790     log_trace(module)(&quot;Setting package: class: %s, package: unnamed, loader: %s, module: %s&quot;,
2791                       external_name(),
2792                       (loader_data != NULL) ? loader_data-&gt;loader_name_and_id() : &quot;NULL&quot;,
2793                       UNNAMED_MODULE);
2794   }
2795 }
2796 
2797 // Function set_classpath_index checks if the package of the InstanceKlass is in the
2798 // boot loader&#39;s package entry table.  If so, then it sets the classpath_index
2799 // in the package entry record.
2800 //
2801 // The classpath_index field is used to find the entry on the boot loader class
2802 // path for packages with classes loaded by the boot loader from -Xbootclasspath/a
2803 // in an unnamed module.  It is also used to indicate (for all packages whose
2804 // classes are loaded by the boot loader) that at least one of the package&#39;s
2805 // classes has been loaded.
2806 void InstanceKlass::set_classpath_index(s2 path_index, TRAPS) {
2807   if (_package_entry != NULL) {
2808     DEBUG_ONLY(PackageEntryTable* pkg_entry_tbl = ClassLoaderData::the_null_class_loader_data()-&gt;packages();)
2809     assert(pkg_entry_tbl-&gt;lookup_only(_package_entry-&gt;name()) == _package_entry, &quot;Should be same&quot;);
2810     assert(path_index != -1, &quot;Unexpected classpath_index&quot;);
2811     _package_entry-&gt;set_classpath_index(path_index);
2812   }
2813 }
2814 
2815 // different versions of is_same_class_package
2816 
2817 bool InstanceKlass::is_same_class_package(const Klass* class2) const {
2818   oop classloader1 = this-&gt;class_loader();
2819   PackageEntry* classpkg1 = this-&gt;package();
2820   if (class2-&gt;is_objArray_klass()) {
2821     class2 = ObjArrayKlass::cast(class2)-&gt;bottom_klass();
2822   }
2823 
2824   oop classloader2;
2825   PackageEntry* classpkg2;
2826   if (class2-&gt;is_instance_klass()) {
2827     classloader2 = class2-&gt;class_loader();
2828     classpkg2 = class2-&gt;package();
2829   } else {
2830     assert(class2-&gt;is_typeArray_klass(), &quot;should be type array&quot;);
2831     classloader2 = NULL;
2832     classpkg2 = NULL;
2833   }
2834 
2835   // Same package is determined by comparing class loader
2836   // and package entries. Both must be the same. This rule
2837   // applies even to classes that are defined in the unnamed
2838   // package, they still must have the same class loader.
2839   if ((classloader1 == classloader2) &amp;&amp; (classpkg1 == classpkg2)) {
2840     return true;
2841   }
2842 
2843   return false;
2844 }
2845 
2846 // return true if this class and other_class are in the same package. Classloader
2847 // and classname information is enough to determine a class&#39;s package
2848 bool InstanceKlass::is_same_class_package(oop other_class_loader,
2849                                           const Symbol* other_class_name) const {
2850   if (class_loader() != other_class_loader) {
2851     return false;
2852   }
2853   if (name()-&gt;fast_compare(other_class_name) == 0) {
2854      return true;
2855   }
2856 
2857   {
2858     ResourceMark rm;
2859 
2860     bool bad_class_name = false;
2861     TempNewSymbol other_pkg = ClassLoader::package_from_class_name(other_class_name, &amp;bad_class_name);
2862     if (bad_class_name) {
2863       return false;
2864     }
2865     // Check that package_from_class_name() returns NULL, not &quot;&quot;, if there is no package.
2866     assert(other_pkg == NULL || other_pkg-&gt;utf8_length() &gt; 0, &quot;package name is empty string&quot;);
2867 
2868     const Symbol* const this_package_name =
2869       this-&gt;package() != NULL ? this-&gt;package()-&gt;name() : NULL;
2870 
2871     if (this_package_name == NULL || other_pkg == NULL) {
2872       // One of the two doesn&#39;t have a package.  Only return true if the other
2873       // one also doesn&#39;t have a package.
2874       return this_package_name == other_pkg;
2875     }
2876 
2877     // Check if package is identical
2878     return this_package_name-&gt;fast_compare(other_pkg) == 0;
2879   }
2880 }
2881 
2882 // Returns true iff super_method can be overridden by a method in targetclassname
2883 // See JLS 3rd edition 8.4.6.1
2884 // Assumes name-signature match
2885 // &quot;this&quot; is InstanceKlass of super_method which must exist
2886 // note that the InstanceKlass of the method in the targetclassname has not always been created yet
2887 bool InstanceKlass::is_override(const methodHandle&amp; super_method, Handle targetclassloader, Symbol* targetclassname, TRAPS) {
2888    // Private methods can not be overridden
2889    if (super_method-&gt;is_private()) {
2890      return false;
2891    }
2892    // If super method is accessible, then override
2893    if ((super_method-&gt;is_protected()) ||
2894        (super_method-&gt;is_public())) {
2895      return true;
2896    }
2897    // Package-private methods are not inherited outside of package
2898    assert(super_method-&gt;is_package_private(), &quot;must be package private&quot;);
2899    return(is_same_class_package(targetclassloader(), targetclassname));
2900 }
2901 
2902 // Only boot and platform class loaders can define classes in &quot;java/&quot; packages.
2903 void InstanceKlass::check_prohibited_package(Symbol* class_name,
2904                                              ClassLoaderData* loader_data,
2905                                              TRAPS) {
2906   if (!loader_data-&gt;is_boot_class_loader_data() &amp;&amp;
2907       !loader_data-&gt;is_platform_class_loader_data() &amp;&amp;
2908       class_name != NULL) {
2909     ResourceMark rm(THREAD);
2910     char* name = class_name-&gt;as_C_string();
2911     if (strncmp(name, JAVAPKG, JAVAPKG_LEN) == 0 &amp;&amp; name[JAVAPKG_LEN] == &#39;/&#39;) {
2912       TempNewSymbol pkg_name = ClassLoader::package_from_class_name(class_name);
2913       assert(pkg_name != NULL, &quot;Error in parsing package name starting with &#39;java/&#39;&quot;);
2914       name = pkg_name-&gt;as_C_string();
2915       const char* class_loader_name = loader_data-&gt;loader_name_and_id();
2916       StringUtils::replace_no_expand(name, &quot;/&quot;, &quot;.&quot;);
2917       const char* msg_text1 = &quot;Class loader (instance of): &quot;;
2918       const char* msg_text2 = &quot; tried to load prohibited package name: &quot;;
2919       size_t len = strlen(msg_text1) + strlen(class_loader_name) + strlen(msg_text2) + strlen(name) + 1;
2920       char* message = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, len);
2921       jio_snprintf(message, len, &quot;%s%s%s%s&quot;, msg_text1, class_loader_name, msg_text2, name);
2922       THROW_MSG(vmSymbols::java_lang_SecurityException(), message);
2923     }
2924   }
2925   return;
2926 }
2927 
2928 bool InstanceKlass::find_inner_classes_attr(int* ooff, int* noff, TRAPS) const {
2929   constantPoolHandle i_cp(THREAD, constants());
2930   for (InnerClassesIterator iter(this); !iter.done(); iter.next()) {
2931     int ioff = iter.inner_class_info_index();
2932     if (ioff != 0) {
2933       // Check to see if the name matches the class we&#39;re looking for
2934       // before attempting to find the class.
2935       if (i_cp-&gt;klass_name_at_matches(this, ioff)) {
2936         Klass* inner_klass = i_cp-&gt;klass_at(ioff, CHECK_false);
2937         if (this == inner_klass) {
2938           *ooff = iter.outer_class_info_index();
2939           *noff = iter.inner_name_index();
2940           return true;
2941         }
2942       }
2943     }
2944   }
2945   return false;
2946 }
2947 
2948 InstanceKlass* InstanceKlass::compute_enclosing_class(bool* inner_is_member, TRAPS) const {
2949   InstanceKlass* outer_klass = NULL;
2950   *inner_is_member = false;
2951   int ooff = 0, noff = 0;
2952   bool has_inner_classes_attr = find_inner_classes_attr(&amp;ooff, &amp;noff, THREAD);
2953   if (has_inner_classes_attr) {
2954     constantPoolHandle i_cp(THREAD, constants());
2955     if (ooff != 0) {
2956       Klass* ok = i_cp-&gt;klass_at(ooff, CHECK_NULL);
2957       outer_klass = InstanceKlass::cast(ok);
2958       *inner_is_member = true;
2959     }
2960     if (NULL == outer_klass) {
2961       // It may be a local or anonymous class; try for that.
2962       int encl_method_class_idx = enclosing_method_class_index();
2963       if (encl_method_class_idx != 0) {
2964         Klass* ok = i_cp-&gt;klass_at(encl_method_class_idx, CHECK_NULL);
2965         outer_klass = InstanceKlass::cast(ok);
2966         *inner_is_member = false;
2967       }
2968     }
2969   }
2970 
2971   // If no inner class attribute found for this class.
2972   if (NULL == outer_klass) return NULL;
2973 
2974   // Throws an exception if outer klass has not declared k as an inner klass
2975   // We need evidence that each klass knows about the other, or else
2976   // the system could allow a spoof of an inner class to gain access rights.
2977   Reflection::check_for_inner_class(outer_klass, this, *inner_is_member, CHECK_NULL);
2978   return outer_klass;
2979 }
2980 
2981 jint InstanceKlass::compute_modifier_flags(TRAPS) const {
2982   jint access = access_flags().as_int();
2983 
2984   // But check if it happens to be member class.
2985   InnerClassesIterator iter(this);
2986   for (; !iter.done(); iter.next()) {
2987     int ioff = iter.inner_class_info_index();
2988     // Inner class attribute can be zero, skip it.
2989     // Strange but true:  JVM spec. allows null inner class refs.
2990     if (ioff == 0) continue;
2991 
2992     // only look at classes that are already loaded
2993     // since we are looking for the flags for our self.
2994     Symbol* inner_name = constants()-&gt;klass_name_at(ioff);
2995     if (name() == inner_name) {
2996       // This is really a member class.
2997       access = iter.inner_access_flags();
2998       break;
2999     }
3000   }
3001   // Remember to strip ACC_SUPER bit
3002   return (access &amp; (~JVM_ACC_SUPER)) &amp; JVM_ACC_WRITTEN_FLAGS;
3003 }
3004 
3005 jint InstanceKlass::jvmti_class_status() const {
3006   jint result = 0;
3007 
3008   if (is_linked()) {
3009     result |= JVMTI_CLASS_STATUS_VERIFIED | JVMTI_CLASS_STATUS_PREPARED;
3010   }
3011 
3012   if (is_initialized()) {
3013     assert(is_linked(), &quot;Class status is not consistent&quot;);
3014     result |= JVMTI_CLASS_STATUS_INITIALIZED;
3015   }
3016   if (is_in_error_state()) {
3017     result |= JVMTI_CLASS_STATUS_ERROR;
3018   }
3019   return result;
3020 }
3021 
3022 Method* InstanceKlass::method_at_itable(Klass* holder, int index, TRAPS) {
3023   itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
3024   int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
3025   int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
3026                        / itableOffsetEntry::size();
3027 
3028   for (int cnt = 0 ; ; cnt ++, ioe ++) {
3029     // If the interface isn&#39;t implemented by the receiver class,
3030     // the VM should throw IncompatibleClassChangeError.
3031     if (cnt &gt;= nof_interfaces) {
3032       ResourceMark rm(THREAD);
3033       stringStream ss;
3034       bool same_module = (module() == holder-&gt;module());
3035       ss.print(&quot;Receiver class %s does not implement &quot;
3036                &quot;the interface %s defining the method to be called &quot;
3037                &quot;(%s%s%s)&quot;,
3038                external_name(), holder-&gt;external_name(),
3039                (same_module) ? joint_in_module_of_loader(holder) : class_in_module_of_loader(),
3040                (same_module) ? &quot;&quot; : &quot;; &quot;,
3041                (same_module) ? &quot;&quot; : holder-&gt;class_in_module_of_loader());
3042       THROW_MSG_NULL(vmSymbols::java_lang_IncompatibleClassChangeError(), ss.as_string());
3043     }
3044 
3045     Klass* ik = ioe-&gt;interface_klass();
3046     if (ik == holder) break;
3047   }
3048 
3049   itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
3050   Method* m = ime[index].method();
3051   if (m == NULL) {
3052     THROW_NULL(vmSymbols::java_lang_AbstractMethodError());
3053   }
3054   return m;
3055 }
3056 
3057 
3058 #if INCLUDE_JVMTI
3059 // update default_methods for redefineclasses for methods that are
3060 // not yet in the vtable due to concurrent subclass define and superinterface
3061 // redefinition
3062 // Note: those in the vtable, should have been updated via adjust_method_entries
3063 void InstanceKlass::adjust_default_methods(bool* trace_name_printed) {
3064   // search the default_methods for uses of either obsolete or EMCP methods
3065   if (default_methods() != NULL) {
3066     for (int index = 0; index &lt; default_methods()-&gt;length(); index ++) {
3067       Method* old_method = default_methods()-&gt;at(index);
3068       if (old_method == NULL || !old_method-&gt;is_old()) {
3069         continue; // skip uninteresting entries
3070       }
3071       assert(!old_method-&gt;is_deleted(), &quot;default methods may not be deleted&quot;);
3072       Method* new_method = old_method-&gt;get_new_method();
3073       default_methods()-&gt;at_put(index, new_method);
3074 
3075       if (log_is_enabled(Info, redefine, class, update)) {
3076         ResourceMark rm;
3077         if (!(*trace_name_printed)) {
3078           log_info(redefine, class, update)
3079             (&quot;adjust: klassname=%s default methods from name=%s&quot;,
3080              external_name(), old_method-&gt;method_holder()-&gt;external_name());
3081           *trace_name_printed = true;
3082         }
3083         log_debug(redefine, class, update, vtables)
3084           (&quot;default method update: %s(%s) &quot;,
3085            new_method-&gt;name()-&gt;as_C_string(), new_method-&gt;signature()-&gt;as_C_string());
3086       }
3087     }
3088   }
3089 }
3090 #endif // INCLUDE_JVMTI
3091 
3092 // On-stack replacement stuff
3093 void InstanceKlass::add_osr_nmethod(nmethod* n) {
3094   assert_lock_strong(CompiledMethod_lock);
3095 #ifndef PRODUCT
3096   if (TieredCompilation) {
3097       nmethod * prev = lookup_osr_nmethod(n-&gt;method(), n-&gt;osr_entry_bci(), n-&gt;comp_level(), true);
3098       assert(prev == NULL || !prev-&gt;is_in_use(),
3099       &quot;redundunt OSR recompilation detected. memory leak in CodeCache!&quot;);
3100   }
3101 #endif
3102   // only one compilation can be active
3103   {
3104     assert(n-&gt;is_osr_method(), &quot;wrong kind of nmethod&quot;);
3105     n-&gt;set_osr_link(osr_nmethods_head());
3106     set_osr_nmethods_head(n);
3107     // Raise the highest osr level if necessary
3108     if (TieredCompilation) {
3109       Method* m = n-&gt;method();
3110       m-&gt;set_highest_osr_comp_level(MAX2(m-&gt;highest_osr_comp_level(), n-&gt;comp_level()));
3111     }
3112   }
3113 
3114   // Get rid of the osr methods for the same bci that have lower levels.
3115   if (TieredCompilation) {
3116     for (int l = CompLevel_limited_profile; l &lt; n-&gt;comp_level(); l++) {
3117       nmethod *inv = lookup_osr_nmethod(n-&gt;method(), n-&gt;osr_entry_bci(), l, true);
3118       if (inv != NULL &amp;&amp; inv-&gt;is_in_use()) {
3119         inv-&gt;make_not_entrant();
3120       }
3121     }
3122   }
3123 }
3124 
3125 // Remove osr nmethod from the list. Return true if found and removed.
3126 bool InstanceKlass::remove_osr_nmethod(nmethod* n) {
3127   // This is a short non-blocking critical region, so the no safepoint check is ok.
3128   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock
3129                  , Mutex::_no_safepoint_check_flag);
3130   assert(n-&gt;is_osr_method(), &quot;wrong kind of nmethod&quot;);
3131   nmethod* last = NULL;
3132   nmethod* cur  = osr_nmethods_head();
3133   int max_level = CompLevel_none;  // Find the max comp level excluding n
3134   Method* m = n-&gt;method();
3135   // Search for match
3136   bool found = false;
3137   while(cur != NULL &amp;&amp; cur != n) {
3138     if (TieredCompilation &amp;&amp; m == cur-&gt;method()) {
3139       // Find max level before n
3140       max_level = MAX2(max_level, cur-&gt;comp_level());
3141     }
3142     last = cur;
3143     cur = cur-&gt;osr_link();
3144   }
3145   nmethod* next = NULL;
3146   if (cur == n) {
3147     found = true;
3148     next = cur-&gt;osr_link();
3149     if (last == NULL) {
3150       // Remove first element
3151       set_osr_nmethods_head(next);
3152     } else {
3153       last-&gt;set_osr_link(next);
3154     }
3155   }
3156   n-&gt;set_osr_link(NULL);
3157   if (TieredCompilation) {
3158     cur = next;
3159     while (cur != NULL) {
3160       // Find max level after n
3161       if (m == cur-&gt;method()) {
3162         max_level = MAX2(max_level, cur-&gt;comp_level());
3163       }
3164       cur = cur-&gt;osr_link();
3165     }
3166     m-&gt;set_highest_osr_comp_level(max_level);
3167   }
3168   return found;
3169 }
3170 
3171 int InstanceKlass::mark_osr_nmethods(const Method* m) {
3172   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock,
3173                  Mutex::_no_safepoint_check_flag);
3174   nmethod* osr = osr_nmethods_head();
3175   int found = 0;
3176   while (osr != NULL) {
3177     assert(osr-&gt;is_osr_method(), &quot;wrong kind of nmethod found in chain&quot;);
3178     if (osr-&gt;method() == m) {
3179       osr-&gt;mark_for_deoptimization();
3180       found++;
3181     }
3182     osr = osr-&gt;osr_link();
3183   }
3184   return found;
3185 }
3186 
3187 nmethod* InstanceKlass::lookup_osr_nmethod(const Method* m, int bci, int comp_level, bool match_level) const {
3188   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock,
3189                  Mutex::_no_safepoint_check_flag);
3190   nmethod* osr = osr_nmethods_head();
3191   nmethod* best = NULL;
3192   while (osr != NULL) {
3193     assert(osr-&gt;is_osr_method(), &quot;wrong kind of nmethod found in chain&quot;);
3194     // There can be a time when a c1 osr method exists but we are waiting
3195     // for a c2 version. When c2 completes its osr nmethod we will trash
3196     // the c1 version and only be able to find the c2 version. However
3197     // while we overflow in the c1 code at back branches we don&#39;t want to
3198     // try and switch to the same code as we are already running
3199 
3200     if (osr-&gt;method() == m &amp;&amp;
3201         (bci == InvocationEntryBci || osr-&gt;osr_entry_bci() == bci)) {
3202       if (match_level) {
3203         if (osr-&gt;comp_level() == comp_level) {
3204           // Found a match - return it.
3205           return osr;
3206         }
3207       } else {
3208         if (best == NULL || (osr-&gt;comp_level() &gt; best-&gt;comp_level())) {
3209           if (osr-&gt;comp_level() == CompLevel_highest_tier) {
3210             // Found the best possible - return it.
3211             return osr;
3212           }
3213           best = osr;
3214         }
3215       }
3216     }
3217     osr = osr-&gt;osr_link();
3218   }
3219 
3220   assert(match_level == false || best == NULL, &quot;shouldn&#39;t pick up anything if match_level is set&quot;);
3221   if (best != NULL &amp;&amp; best-&gt;comp_level() &gt;= comp_level) {
3222     return best;
3223   }
3224   return NULL;
3225 }
3226 
3227 // -----------------------------------------------------------------------------------------------------
3228 // Printing
3229 
3230 #ifndef PRODUCT
3231 
3232 #define BULLET  &quot; - &quot;
3233 
3234 static const char* state_names[] = {
3235   &quot;allocated&quot;, &quot;loaded&quot;, &quot;linked&quot;, &quot;being_initialized&quot;, &quot;fully_initialized&quot;, &quot;initialization_error&quot;
3236 };
3237 
3238 static void print_vtable(intptr_t* start, int len, outputStream* st) {
3239   for (int i = 0; i &lt; len; i++) {
3240     intptr_t e = start[i];
3241     st-&gt;print(&quot;%d : &quot; INTPTR_FORMAT, i, e);
3242     if (MetaspaceObj::is_valid((Metadata*)e)) {
3243       st-&gt;print(&quot; &quot;);
3244       ((Metadata*)e)-&gt;print_value_on(st);
3245     }
3246     st-&gt;cr();
3247   }
3248 }
3249 
3250 static void print_vtable(vtableEntry* start, int len, outputStream* st) {
3251   return print_vtable(reinterpret_cast&lt;intptr_t*&gt;(start), len, st);
3252 }
3253 
3254 void InstanceKlass::print_on(outputStream* st) const {
3255   assert(is_klass(), &quot;must be klass&quot;);
3256   Klass::print_on(st);
3257 
3258   st-&gt;print(BULLET&quot;instance size:     %d&quot;, size_helper());                        st-&gt;cr();
3259   st-&gt;print(BULLET&quot;klass size:        %d&quot;, size());                               st-&gt;cr();
3260   st-&gt;print(BULLET&quot;access:            &quot;); access_flags().print_on(st);            st-&gt;cr();
3261   st-&gt;print(BULLET&quot;state:             &quot;); st-&gt;print_cr(&quot;%s&quot;, state_names[_init_state]);
3262   st-&gt;print(BULLET&quot;name:              &quot;); name()-&gt;print_value_on(st);             st-&gt;cr();
3263   st-&gt;print(BULLET&quot;super:             &quot;); Metadata::print_value_on_maybe_null(st, super()); st-&gt;cr();
3264   st-&gt;print(BULLET&quot;sub:               &quot;);
3265   Klass* sub = subklass();
3266   int n;
3267   for (n = 0; sub != NULL; n++, sub = sub-&gt;next_sibling()) {
3268     if (n &lt; MaxSubklassPrintSize) {
3269       sub-&gt;print_value_on(st);
3270       st-&gt;print(&quot;   &quot;);
3271     }
3272   }
3273   if (n &gt;= MaxSubklassPrintSize) st-&gt;print(&quot;(&quot; INTX_FORMAT &quot; more klasses...)&quot;, n - MaxSubklassPrintSize);
3274   st-&gt;cr();
3275 
3276   if (is_interface()) {
3277     st-&gt;print_cr(BULLET&quot;nof implementors:  %d&quot;, nof_implementors());
3278     if (nof_implementors() == 1) {
3279       st-&gt;print_cr(BULLET&quot;implementor:    &quot;);
3280       st-&gt;print(&quot;   &quot;);
3281       implementor()-&gt;print_value_on(st);
3282       st-&gt;cr();
3283     }
3284   }
3285 
3286   st-&gt;print(BULLET&quot;arrays:            &quot;); Metadata::print_value_on_maybe_null(st, array_klasses()); st-&gt;cr();
3287   st-&gt;print(BULLET&quot;methods:           &quot;); methods()-&gt;print_value_on(st);                  st-&gt;cr();
3288   if (Verbose || WizardMode) {
3289     Array&lt;Method*&gt;* method_array = methods();
3290     for (int i = 0; i &lt; method_array-&gt;length(); i++) {
3291       st-&gt;print(&quot;%d : &quot;, i); method_array-&gt;at(i)-&gt;print_value(); st-&gt;cr();
3292     }
3293   }
3294   st-&gt;print(BULLET&quot;method ordering:   &quot;); method_ordering()-&gt;print_value_on(st);      st-&gt;cr();
3295   st-&gt;print(BULLET&quot;default_methods:   &quot;); default_methods()-&gt;print_value_on(st);      st-&gt;cr();
3296   if (Verbose &amp;&amp; default_methods() != NULL) {
3297     Array&lt;Method*&gt;* method_array = default_methods();
3298     for (int i = 0; i &lt; method_array-&gt;length(); i++) {
3299       st-&gt;print(&quot;%d : &quot;, i); method_array-&gt;at(i)-&gt;print_value(); st-&gt;cr();
3300     }
3301   }
3302   if (default_vtable_indices() != NULL) {
3303     st-&gt;print(BULLET&quot;default vtable indices:   &quot;); default_vtable_indices()-&gt;print_value_on(st);       st-&gt;cr();
3304   }
3305   st-&gt;print(BULLET&quot;local interfaces:  &quot;); local_interfaces()-&gt;print_value_on(st);      st-&gt;cr();
3306   st-&gt;print(BULLET&quot;trans. interfaces: &quot;); transitive_interfaces()-&gt;print_value_on(st); st-&gt;cr();
3307   st-&gt;print(BULLET&quot;constants:         &quot;); constants()-&gt;print_value_on(st);         st-&gt;cr();
3308   if (class_loader_data() != NULL) {
3309     st-&gt;print(BULLET&quot;class loader data:  &quot;);
3310     class_loader_data()-&gt;print_value_on(st);
3311     st-&gt;cr();
3312   }
3313   st-&gt;print(BULLET&quot;unsafe anonymous host class:        &quot;); Metadata::print_value_on_maybe_null(st, unsafe_anonymous_host()); st-&gt;cr();
3314   if (source_file_name() != NULL) {
3315     st-&gt;print(BULLET&quot;source file:       &quot;);
3316     source_file_name()-&gt;print_value_on(st);
3317     st-&gt;cr();
3318   }
3319   if (source_debug_extension() != NULL) {
3320     st-&gt;print(BULLET&quot;source debug extension:       &quot;);
3321     st-&gt;print(&quot;%s&quot;, source_debug_extension());
3322     st-&gt;cr();
3323   }
3324   st-&gt;print(BULLET&quot;class annotations:       &quot;); class_annotations()-&gt;print_value_on(st); st-&gt;cr();
3325   st-&gt;print(BULLET&quot;class type annotations:  &quot;); class_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3326   st-&gt;print(BULLET&quot;field annotations:       &quot;); fields_annotations()-&gt;print_value_on(st); st-&gt;cr();
3327   st-&gt;print(BULLET&quot;field type annotations:  &quot;); fields_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3328   {
3329     bool have_pv = false;
3330     // previous versions are linked together through the InstanceKlass
3331     for (InstanceKlass* pv_node = previous_versions();
3332          pv_node != NULL;
3333          pv_node = pv_node-&gt;previous_versions()) {
3334       if (!have_pv)
3335         st-&gt;print(BULLET&quot;previous version:  &quot;);
3336       have_pv = true;
3337       pv_node-&gt;constants()-&gt;print_value_on(st);
3338     }
3339     if (have_pv) st-&gt;cr();
3340   }
3341 
3342   if (generic_signature() != NULL) {
3343     st-&gt;print(BULLET&quot;generic signature: &quot;);
3344     generic_signature()-&gt;print_value_on(st);
3345     st-&gt;cr();
3346   }
3347   st-&gt;print(BULLET&quot;inner classes:     &quot;); inner_classes()-&gt;print_value_on(st);     st-&gt;cr();
3348   st-&gt;print(BULLET&quot;nest members:     &quot;); nest_members()-&gt;print_value_on(st);     st-&gt;cr();
3349   if (record_components() != NULL) {
3350     st-&gt;print(BULLET&quot;record components:     &quot;); record_components()-&gt;print_value_on(st);     st-&gt;cr();
3351   }
3352   if (java_mirror() != NULL) {
3353     st-&gt;print(BULLET&quot;java mirror:       &quot;);
3354     java_mirror()-&gt;print_value_on(st);
3355     st-&gt;cr();
3356   } else {
3357     st-&gt;print_cr(BULLET&quot;java mirror:       NULL&quot;);
3358   }
3359   st-&gt;print(BULLET&quot;vtable length      %d  (start addr: &quot; INTPTR_FORMAT &quot;)&quot;, vtable_length(), p2i(start_of_vtable())); st-&gt;cr();
3360   if (vtable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(start_of_vtable(), vtable_length(), st);
3361   st-&gt;print(BULLET&quot;itable length      %d (start addr: &quot; INTPTR_FORMAT &quot;)&quot;, itable_length(), p2i(start_of_itable())); st-&gt;cr();
3362   if (itable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(start_of_itable(), itable_length(), st);
3363   st-&gt;print_cr(BULLET&quot;---- static fields (%d words):&quot;, static_field_size());
3364   FieldPrinter print_static_field(st);
3365   ((InstanceKlass*)this)-&gt;do_local_static_fields(&amp;print_static_field);
3366   st-&gt;print_cr(BULLET&quot;---- non-static fields (%d words):&quot;, nonstatic_field_size());
3367   FieldPrinter print_nonstatic_field(st);
3368   InstanceKlass* ik = const_cast&lt;InstanceKlass*&gt;(this);
3369   ik-&gt;do_nonstatic_fields(&amp;print_nonstatic_field);
3370 
3371   st-&gt;print(BULLET&quot;non-static oop maps: &quot;);
3372   OopMapBlock* map     = start_of_nonstatic_oop_maps();
3373   OopMapBlock* end_map = map + nonstatic_oop_map_count();
3374   while (map &lt; end_map) {
3375     st-&gt;print(&quot;%d-%d &quot;, map-&gt;offset(), map-&gt;offset() + heapOopSize*(map-&gt;count() - 1));
3376     map++;
3377   }
3378   st-&gt;cr();
3379 }
3380 
3381 #endif //PRODUCT
3382 
3383 void InstanceKlass::print_value_on(outputStream* st) const {
3384   assert(is_klass(), &quot;must be klass&quot;);
3385   if (Verbose || WizardMode)  access_flags().print_on(st);
3386   name()-&gt;print_value_on(st);
3387 }
3388 
3389 #ifndef PRODUCT
3390 
3391 void FieldPrinter::do_field(fieldDescriptor* fd) {
3392   _st-&gt;print(BULLET);
3393    if (_obj == NULL) {
3394      fd-&gt;print_on(_st);
3395      _st-&gt;cr();
3396    } else {
3397      fd-&gt;print_on_for(_st, _obj);
3398      _st-&gt;cr();
3399    }
3400 }
3401 
3402 
3403 void InstanceKlass::oop_print_on(oop obj, outputStream* st) {
3404   Klass::oop_print_on(obj, st);
3405 
3406   if (this == SystemDictionary::String_klass()) {
3407     typeArrayOop value  = java_lang_String::value(obj);
3408     juint        length = java_lang_String::length(obj);
3409     if (value != NULL &amp;&amp;
3410         value-&gt;is_typeArray() &amp;&amp;
3411         length &lt;= (juint) value-&gt;length()) {
3412       st-&gt;print(BULLET&quot;string: &quot;);
3413       java_lang_String::print(obj, st);
3414       st-&gt;cr();
3415       if (!WizardMode)  return;  // that is enough
3416     }
3417   }
3418 
3419   st-&gt;print_cr(BULLET&quot;---- fields (total size %d words):&quot;, oop_size(obj));
3420   FieldPrinter print_field(st, obj);
3421   do_nonstatic_fields(&amp;print_field);
3422 
3423   if (this == SystemDictionary::Class_klass()) {
3424     st-&gt;print(BULLET&quot;signature: &quot;);
3425     java_lang_Class::print_signature(obj, st);
3426     st-&gt;cr();
3427     Klass* mirrored_klass = java_lang_Class::as_Klass(obj);
3428     st-&gt;print(BULLET&quot;fake entry for mirror: &quot;);
3429     Metadata::print_value_on_maybe_null(st, mirrored_klass);
3430     st-&gt;cr();
3431     Klass* array_klass = java_lang_Class::array_klass_acquire(obj);
3432     st-&gt;print(BULLET&quot;fake entry for array: &quot;);
3433     Metadata::print_value_on_maybe_null(st, array_klass);
3434     st-&gt;cr();
3435     st-&gt;print_cr(BULLET&quot;fake entry for oop_size: %d&quot;, java_lang_Class::oop_size(obj));
3436     st-&gt;print_cr(BULLET&quot;fake entry for static_oop_field_count: %d&quot;, java_lang_Class::static_oop_field_count(obj));
3437     Klass* real_klass = java_lang_Class::as_Klass(obj);
3438     if (real_klass != NULL &amp;&amp; real_klass-&gt;is_instance_klass()) {
3439       InstanceKlass::cast(real_klass)-&gt;do_local_static_fields(&amp;print_field);
3440     }
3441   } else if (this == SystemDictionary::MethodType_klass()) {
3442     st-&gt;print(BULLET&quot;signature: &quot;);
3443     java_lang_invoke_MethodType::print_signature(obj, st);
3444     st-&gt;cr();
3445   }
3446 }
3447 
3448 bool InstanceKlass::verify_itable_index(int i) {
3449   int method_count = klassItable::method_count_for_interface(this);
3450   assert(i &gt;= 0 &amp;&amp; i &lt; method_count, &quot;index out of bounds&quot;);
3451   return true;
3452 }
3453 
3454 #endif //PRODUCT
3455 
3456 void InstanceKlass::oop_print_value_on(oop obj, outputStream* st) {
3457   st-&gt;print(&quot;a &quot;);
3458   name()-&gt;print_value_on(st);
3459   obj-&gt;print_address_on(st);
3460   if (this == SystemDictionary::String_klass()
3461       &amp;&amp; java_lang_String::value(obj) != NULL) {
3462     ResourceMark rm;
3463     int len = java_lang_String::length(obj);
3464     int plen = (len &lt; 24 ? len : 12);
3465     char* str = java_lang_String::as_utf8_string(obj, 0, plen);
3466     st-&gt;print(&quot; = \&quot;%s\&quot;&quot;, str);
3467     if (len &gt; plen)
3468       st-&gt;print(&quot;...[%d]&quot;, len);
3469   } else if (this == SystemDictionary::Class_klass()) {
3470     Klass* k = java_lang_Class::as_Klass(obj);
3471     st-&gt;print(&quot; = &quot;);
3472     if (k != NULL) {
3473       k-&gt;print_value_on(st);
3474     } else {
3475       const char* tname = type2name(java_lang_Class::primitive_type(obj));
3476       st-&gt;print(&quot;%s&quot;, tname ? tname : &quot;type?&quot;);
3477     }
3478   } else if (this == SystemDictionary::MethodType_klass()) {
3479     st-&gt;print(&quot; = &quot;);
3480     java_lang_invoke_MethodType::print_signature(obj, st);
3481   } else if (java_lang_boxing_object::is_instance(obj)) {
3482     st-&gt;print(&quot; = &quot;);
3483     java_lang_boxing_object::print(obj, st);
3484   } else if (this == SystemDictionary::LambdaForm_klass()) {
3485     oop vmentry = java_lang_invoke_LambdaForm::vmentry(obj);
3486     if (vmentry != NULL) {
3487       st-&gt;print(&quot; =&gt; &quot;);
3488       vmentry-&gt;print_value_on(st);
3489     }
3490   } else if (this == SystemDictionary::MemberName_klass()) {
3491     Metadata* vmtarget = java_lang_invoke_MemberName::vmtarget(obj);
3492     if (vmtarget != NULL) {
3493       st-&gt;print(&quot; = &quot;);
3494       vmtarget-&gt;print_value_on(st);
3495     } else {
3496       java_lang_invoke_MemberName::clazz(obj)-&gt;print_value_on(st);
3497       st-&gt;print(&quot;.&quot;);
3498       java_lang_invoke_MemberName::name(obj)-&gt;print_value_on(st);
3499     }
3500   }
3501 }
3502 
3503 const char* InstanceKlass::internal_name() const {
3504   return external_name();
3505 }
3506 
3507 void InstanceKlass::print_class_load_logging(ClassLoaderData* loader_data,
3508                                              const char* module_name,
3509                                              const ClassFileStream* cfs) const {
3510   if (!log_is_enabled(Info, class, load)) {
3511     return;
3512   }
3513 
3514   ResourceMark rm;
3515   LogMessage(class, load) msg;
3516   stringStream info_stream;
3517 
3518   // Name and class hierarchy info
3519   info_stream.print(&quot;%s&quot;, external_name());
3520 
3521   // Source
3522   if (cfs != NULL) {
3523     if (cfs-&gt;source() != NULL) {
3524       if (module_name != NULL) {
3525         // When the boot loader created the stream, it didn&#39;t know the module name
3526         // yet. Let&#39;s format it now.
3527         if (cfs-&gt;from_boot_loader_modules_image()) {
3528           info_stream.print(&quot; source: jrt:/%s&quot;, module_name);
3529         } else {
3530           info_stream.print(&quot; source: %s&quot;, cfs-&gt;source());
3531         }
3532       } else {
3533         info_stream.print(&quot; source: %s&quot;, cfs-&gt;source());
3534       }
3535     } else if (loader_data == ClassLoaderData::the_null_class_loader_data()) {
3536       Thread* THREAD = Thread::current();
3537       Klass* caller =
3538             THREAD-&gt;is_Java_thread()
3539                 ? ((JavaThread*)THREAD)-&gt;security_get_caller_class(1)
3540                 : NULL;
3541       // caller can be NULL, for example, during a JVMTI VM_Init hook
3542       if (caller != NULL) {
3543         info_stream.print(&quot; source: instance of %s&quot;, caller-&gt;external_name());
3544       } else {
3545         // source is unknown
3546       }
3547     } else {
3548       oop class_loader = loader_data-&gt;class_loader();
3549       info_stream.print(&quot; source: %s&quot;, class_loader-&gt;klass()-&gt;external_name());
3550     }
3551   } else {
3552     assert(this-&gt;is_shared(), &quot;must be&quot;);
3553     if (MetaspaceShared::is_shared_dynamic((void*)this)) {
3554       info_stream.print(&quot; source: shared objects file (top)&quot;);
3555     } else {
3556       info_stream.print(&quot; source: shared objects file&quot;);
3557     }
3558   }
3559 
3560   msg.info(&quot;%s&quot;, info_stream.as_string());
3561 
3562   if (log_is_enabled(Debug, class, load)) {
3563     stringStream debug_stream;
3564 
3565     // Class hierarchy info
3566     debug_stream.print(&quot; klass: &quot; INTPTR_FORMAT &quot; super: &quot; INTPTR_FORMAT,
3567                        p2i(this),  p2i(superklass()));
3568 
3569     // Interfaces
3570     if (local_interfaces() != NULL &amp;&amp; local_interfaces()-&gt;length() &gt; 0) {
3571       debug_stream.print(&quot; interfaces:&quot;);
3572       int length = local_interfaces()-&gt;length();
3573       for (int i = 0; i &lt; length; i++) {
3574         debug_stream.print(&quot; &quot; INTPTR_FORMAT,
3575                            p2i(InstanceKlass::cast(local_interfaces()-&gt;at(i))));
3576       }
3577     }
3578 
3579     // Class loader
3580     debug_stream.print(&quot; loader: [&quot;);
3581     loader_data-&gt;print_value_on(&amp;debug_stream);
3582     debug_stream.print(&quot;]&quot;);
3583 
3584     // Classfile checksum
3585     if (cfs) {
3586       debug_stream.print(&quot; bytes: %d checksum: %08x&quot;,
3587                          cfs-&gt;length(),
3588                          ClassLoader::crc32(0, (const char*)cfs-&gt;buffer(),
3589                          cfs-&gt;length()));
3590     }
3591 
3592     msg.debug(&quot;%s&quot;, debug_stream.as_string());
3593   }
3594 }
3595 
3596 // Verification
3597 
3598 class VerifyFieldClosure: public BasicOopIterateClosure {
3599  protected:
3600   template &lt;class T&gt; void do_oop_work(T* p) {
3601     oop obj = RawAccess&lt;&gt;::oop_load(p);
3602     if (!oopDesc::is_oop_or_null(obj)) {
3603       tty-&gt;print_cr(&quot;Failed: &quot; PTR_FORMAT &quot; -&gt; &quot; PTR_FORMAT, p2i(p), p2i(obj));
3604       Universe::print_on(tty);
3605       guarantee(false, &quot;boom&quot;);
3606     }
3607   }
3608  public:
3609   virtual void do_oop(oop* p)       { VerifyFieldClosure::do_oop_work(p); }
3610   virtual void do_oop(narrowOop* p) { VerifyFieldClosure::do_oop_work(p); }
3611 };
3612 
3613 void InstanceKlass::verify_on(outputStream* st) {
3614 #ifndef PRODUCT
3615   // Avoid redundant verifies, this really should be in product.
3616   if (_verify_count == Universe::verify_count()) return;
3617   _verify_count = Universe::verify_count();
3618 #endif
3619 
3620   // Verify Klass
3621   Klass::verify_on(st);
3622 
3623   // Verify that klass is present in ClassLoaderData
3624   guarantee(class_loader_data()-&gt;contains_klass(this),
3625             &quot;this class isn&#39;t found in class loader data&quot;);
3626 
3627   // Verify vtables
3628   if (is_linked()) {
3629     // $$$ This used to be done only for m/s collections.  Doing it
3630     // always seemed a valid generalization.  (DLD -- 6/00)
3631     vtable().verify(st);
3632   }
3633 
3634   // Verify first subklass
3635   if (subklass() != NULL) {
3636     guarantee(subklass()-&gt;is_klass(), &quot;should be klass&quot;);
3637   }
3638 
3639   // Verify siblings
3640   Klass* super = this-&gt;super();
3641   Klass* sib = next_sibling();
3642   if (sib != NULL) {
3643     if (sib == this) {
3644       fatal(&quot;subclass points to itself &quot; PTR_FORMAT, p2i(sib));
3645     }
3646 
3647     guarantee(sib-&gt;is_klass(), &quot;should be klass&quot;);
3648     guarantee(sib-&gt;super() == super, &quot;siblings should have same superklass&quot;);
3649   }
3650 
3651   // Verify local interfaces
3652   if (local_interfaces()) {
3653     Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
3654     for (int j = 0; j &lt; local_interfaces-&gt;length(); j++) {
3655       InstanceKlass* e = local_interfaces-&gt;at(j);
3656       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), &quot;invalid local interface&quot;);
3657     }
3658   }
3659 
3660   // Verify transitive interfaces
3661   if (transitive_interfaces() != NULL) {
3662     Array&lt;InstanceKlass*&gt;* transitive_interfaces = this-&gt;transitive_interfaces();
3663     for (int j = 0; j &lt; transitive_interfaces-&gt;length(); j++) {
3664       InstanceKlass* e = transitive_interfaces-&gt;at(j);
3665       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), &quot;invalid transitive interface&quot;);
3666     }
3667   }
3668 
3669   // Verify methods
3670   if (methods() != NULL) {
3671     Array&lt;Method*&gt;* methods = this-&gt;methods();
3672     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3673       guarantee(methods-&gt;at(j)-&gt;is_method(), &quot;non-method in methods array&quot;);
3674     }
3675     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3676       Method* m1 = methods-&gt;at(j);
3677       Method* m2 = methods-&gt;at(j + 1);
3678       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, &quot;methods not sorted correctly&quot;);
3679     }
3680   }
3681 
3682   // Verify method ordering
3683   if (method_ordering() != NULL) {
3684     Array&lt;int&gt;* method_ordering = this-&gt;method_ordering();
3685     int length = method_ordering-&gt;length();
3686     if (JvmtiExport::can_maintain_original_method_order() ||
3687         ((UseSharedSpaces || Arguments::is_dumping_archive()) &amp;&amp; length != 0)) {
3688       guarantee(length == methods()-&gt;length(), &quot;invalid method ordering length&quot;);
3689       jlong sum = 0;
3690       for (int j = 0; j &lt; length; j++) {
3691         int original_index = method_ordering-&gt;at(j);
3692         guarantee(original_index &gt;= 0, &quot;invalid method ordering index&quot;);
3693         guarantee(original_index &lt; length, &quot;invalid method ordering index&quot;);
3694         sum += original_index;
3695       }
3696       // Verify sum of indices 0,1,...,length-1
3697       guarantee(sum == ((jlong)length*(length-1))/2, &quot;invalid method ordering sum&quot;);
3698     } else {
3699       guarantee(length == 0, &quot;invalid method ordering length&quot;);
3700     }
3701   }
3702 
3703   // Verify default methods
3704   if (default_methods() != NULL) {
3705     Array&lt;Method*&gt;* methods = this-&gt;default_methods();
3706     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3707       guarantee(methods-&gt;at(j)-&gt;is_method(), &quot;non-method in methods array&quot;);
3708     }
3709     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3710       Method* m1 = methods-&gt;at(j);
3711       Method* m2 = methods-&gt;at(j + 1);
3712       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, &quot;methods not sorted correctly&quot;);
3713     }
3714   }
3715 
3716   // Verify JNI static field identifiers
3717   if (jni_ids() != NULL) {
3718     jni_ids()-&gt;verify(this);
3719   }
3720 
3721   // Verify other fields
3722   if (array_klasses() != NULL) {
3723     guarantee(array_klasses()-&gt;is_klass(), &quot;should be klass&quot;);
3724   }
3725   if (constants() != NULL) {
3726     guarantee(constants()-&gt;is_constantPool(), &quot;should be constant pool&quot;);
3727   }
3728   const Klass* anonymous_host = unsafe_anonymous_host();
3729   if (anonymous_host != NULL) {
3730     guarantee(anonymous_host-&gt;is_klass(), &quot;should be klass&quot;);
3731   }
3732 }
3733 
3734 void InstanceKlass::oop_verify_on(oop obj, outputStream* st) {
3735   Klass::oop_verify_on(obj, st);
3736   VerifyFieldClosure blk;
3737   obj-&gt;oop_iterate(&amp;blk);
3738 }
3739 
3740 
3741 // JNIid class for jfieldIDs only
3742 // Note to reviewers:
3743 // These JNI functions are just moved over to column 1 and not changed
3744 // in the compressed oops workspace.
3745 JNIid::JNIid(Klass* holder, int offset, JNIid* next) {
3746   _holder = holder;
3747   _offset = offset;
3748   _next = next;
3749   debug_only(_is_static_field_id = false;)
3750 }
3751 
3752 
3753 JNIid* JNIid::find(int offset) {
3754   JNIid* current = this;
3755   while (current != NULL) {
3756     if (current-&gt;offset() == offset) return current;
3757     current = current-&gt;next();
3758   }
3759   return NULL;
3760 }
3761 
3762 void JNIid::deallocate(JNIid* current) {
3763   while (current != NULL) {
3764     JNIid* next = current-&gt;next();
3765     delete current;
3766     current = next;
3767   }
3768 }
3769 
3770 
3771 void JNIid::verify(Klass* holder) {
3772   int first_field_offset  = InstanceMirrorKlass::offset_of_static_fields();
3773   int end_field_offset;
3774   end_field_offset = first_field_offset + (InstanceKlass::cast(holder)-&gt;static_field_size() * wordSize);
3775 
3776   JNIid* current = this;
3777   while (current != NULL) {
3778     guarantee(current-&gt;holder() == holder, &quot;Invalid klass in JNIid&quot;);
3779 #ifdef ASSERT
3780     int o = current-&gt;offset();
3781     if (current-&gt;is_static_field_id()) {
3782       guarantee(o &gt;= first_field_offset  &amp;&amp; o &lt; end_field_offset,  &quot;Invalid static field offset in JNIid&quot;);
3783     }
3784 #endif
3785     current = current-&gt;next();
3786   }
3787 }
3788 
3789 void InstanceKlass::set_init_state(ClassState state) {
3790 #ifdef ASSERT
3791   bool good_state = is_shared() ? (_init_state &lt;= state)
3792                                                : (_init_state &lt; state);
3793   assert(good_state || state == allocated, &quot;illegal state transition&quot;);
3794 #endif
3795   assert(_init_thread == NULL, &quot;should be cleared before state change&quot;);
3796   _init_state = (u1)state;
3797 }
3798 
3799 #if INCLUDE_JVMTI
3800 
3801 // RedefineClasses() support for previous versions
3802 
3803 // Globally, there is at least one previous version of a class to walk
3804 // during class unloading, which is saved because old methods in the class
3805 // are still running.   Otherwise the previous version list is cleaned up.
3806 bool InstanceKlass::_has_previous_versions = false;
3807 
3808 // Returns true if there are previous versions of a class for class
3809 // unloading only. Also resets the flag to false. purge_previous_version
3810 // will set the flag to true if there are any left, i.e., if there&#39;s any
3811 // work to do for next time. This is to avoid the expensive code cache
3812 // walk in CLDG::clean_deallocate_lists().
3813 bool InstanceKlass::has_previous_versions_and_reset() {
3814   bool ret = _has_previous_versions;
3815   log_trace(redefine, class, iklass, purge)(&quot;Class unloading: has_previous_versions = %s&quot;,
3816      ret ? &quot;true&quot; : &quot;false&quot;);
3817   _has_previous_versions = false;
3818   return ret;
3819 }
3820 
3821 // Purge previous versions before adding new previous versions of the class and
3822 // during class unloading.
3823 void InstanceKlass::purge_previous_version_list() {
3824   assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
3825   assert(has_been_redefined(), &quot;Should only be called for main class&quot;);
3826 
3827   // Quick exit.
3828   if (previous_versions() == NULL) {
3829     return;
3830   }
3831 
3832   // This klass has previous versions so see what we can cleanup
3833   // while it is safe to do so.
3834 
3835   int deleted_count = 0;    // leave debugging breadcrumbs
3836   int live_count = 0;
3837   ClassLoaderData* loader_data = class_loader_data();
3838   assert(loader_data != NULL, &quot;should never be null&quot;);
3839 
3840   ResourceMark rm;
3841   log_trace(redefine, class, iklass, purge)(&quot;%s: previous versions&quot;, external_name());
3842 
3843   // previous versions are linked together through the InstanceKlass
3844   InstanceKlass* pv_node = previous_versions();
3845   InstanceKlass* last = this;
3846   int version = 0;
3847 
3848   // check the previous versions list
3849   for (; pv_node != NULL; ) {
3850 
3851     ConstantPool* pvcp = pv_node-&gt;constants();
3852     assert(pvcp != NULL, &quot;cp ref was unexpectedly cleared&quot;);
3853 
3854     if (!pvcp-&gt;on_stack()) {
3855       // If the constant pool isn&#39;t on stack, none of the methods
3856       // are executing.  Unlink this previous_version.
3857       // The previous version InstanceKlass is on the ClassLoaderData deallocate list
3858       // so will be deallocated during the next phase of class unloading.
3859       log_trace(redefine, class, iklass, purge)
3860         (&quot;previous version &quot; INTPTR_FORMAT &quot; is dead.&quot;, p2i(pv_node));
3861       // For debugging purposes.
3862       pv_node-&gt;set_is_scratch_class();
3863       // Unlink from previous version list.
3864       assert(pv_node-&gt;class_loader_data() == loader_data, &quot;wrong loader_data&quot;);
3865       InstanceKlass* next = pv_node-&gt;previous_versions();
3866       pv_node-&gt;link_previous_versions(NULL);   // point next to NULL
3867       last-&gt;link_previous_versions(next);
3868       // Add to the deallocate list after unlinking
3869       loader_data-&gt;add_to_deallocate_list(pv_node);
3870       pv_node = next;
3871       deleted_count++;
3872       version++;
3873       continue;
3874     } else {
3875       log_trace(redefine, class, iklass, purge)(&quot;previous version &quot; INTPTR_FORMAT &quot; is alive&quot;, p2i(pv_node));
3876       assert(pvcp-&gt;pool_holder() != NULL, &quot;Constant pool with no holder&quot;);
3877       guarantee (!loader_data-&gt;is_unloading(), &quot;unloaded classes can&#39;t be on the stack&quot;);
3878       live_count++;
3879       // found a previous version for next time we do class unloading
3880       _has_previous_versions = true;
3881     }
3882 
3883     // At least one method is live in this previous version.
3884     // Reset dead EMCP methods not to get breakpoints.
3885     // All methods are deallocated when all of the methods for this class are no
3886     // longer running.
3887     Array&lt;Method*&gt;* method_refs = pv_node-&gt;methods();
3888     if (method_refs != NULL) {
3889       log_trace(redefine, class, iklass, purge)(&quot;previous methods length=%d&quot;, method_refs-&gt;length());
3890       for (int j = 0; j &lt; method_refs-&gt;length(); j++) {
3891         Method* method = method_refs-&gt;at(j);
3892 
3893         if (!method-&gt;on_stack()) {
3894           // no breakpoints for non-running methods
3895           if (method-&gt;is_running_emcp()) {
3896             method-&gt;set_running_emcp(false);
3897           }
3898         } else {
3899           assert (method-&gt;is_obsolete() || method-&gt;is_running_emcp(),
3900                   &quot;emcp method cannot run after emcp bit is cleared&quot;);
3901           log_trace(redefine, class, iklass, purge)
3902             (&quot;purge: %s(%s): prev method @%d in version @%d is alive&quot;,
3903              method-&gt;name()-&gt;as_C_string(), method-&gt;signature()-&gt;as_C_string(), j, version);
3904         }
3905       }
3906     }
3907     // next previous version
3908     last = pv_node;
3909     pv_node = pv_node-&gt;previous_versions();
3910     version++;
3911   }
3912   log_trace(redefine, class, iklass, purge)
3913     (&quot;previous version stats: live=%d, deleted=%d&quot;, live_count, deleted_count);
3914 }
3915 
3916 void InstanceKlass::mark_newly_obsolete_methods(Array&lt;Method*&gt;* old_methods,
3917                                                 int emcp_method_count) {
3918   int obsolete_method_count = old_methods-&gt;length() - emcp_method_count;
3919 
3920   if (emcp_method_count != 0 &amp;&amp; obsolete_method_count != 0 &amp;&amp;
3921       _previous_versions != NULL) {
3922     // We have a mix of obsolete and EMCP methods so we have to
3923     // clear out any matching EMCP method entries the hard way.
3924     int local_count = 0;
3925     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
3926       Method* old_method = old_methods-&gt;at(i);
3927       if (old_method-&gt;is_obsolete()) {
3928         // only obsolete methods are interesting
3929         Symbol* m_name = old_method-&gt;name();
3930         Symbol* m_signature = old_method-&gt;signature();
3931 
3932         // previous versions are linked together through the InstanceKlass
3933         int j = 0;
3934         for (InstanceKlass* prev_version = _previous_versions;
3935              prev_version != NULL;
3936              prev_version = prev_version-&gt;previous_versions(), j++) {
3937 
3938           Array&lt;Method*&gt;* method_refs = prev_version-&gt;methods();
3939           for (int k = 0; k &lt; method_refs-&gt;length(); k++) {
3940             Method* method = method_refs-&gt;at(k);
3941 
3942             if (!method-&gt;is_obsolete() &amp;&amp;
3943                 method-&gt;name() == m_name &amp;&amp;
3944                 method-&gt;signature() == m_signature) {
3945               // The current RedefineClasses() call has made all EMCP
3946               // versions of this method obsolete so mark it as obsolete
3947               log_trace(redefine, class, iklass, add)
3948                 (&quot;%s(%s): flush obsolete method @%d in version @%d&quot;,
3949                  m_name-&gt;as_C_string(), m_signature-&gt;as_C_string(), k, j);
3950 
3951               method-&gt;set_is_obsolete();
3952               break;
3953             }
3954           }
3955 
3956           // The previous loop may not find a matching EMCP method, but
3957           // that doesn&#39;t mean that we can optimize and not go any
3958           // further back in the PreviousVersion generations. The EMCP
3959           // method for this generation could have already been made obsolete,
3960           // but there still may be an older EMCP method that has not
3961           // been made obsolete.
3962         }
3963 
3964         if (++local_count &gt;= obsolete_method_count) {
3965           // no more obsolete methods so bail out now
3966           break;
3967         }
3968       }
3969     }
3970   }
3971 }
3972 
3973 // Save the scratch_class as the previous version if any of the methods are running.
3974 // The previous_versions are used to set breakpoints in EMCP methods and they are
3975 // also used to clean MethodData links to redefined methods that are no longer running.
3976 void InstanceKlass::add_previous_version(InstanceKlass* scratch_class,
3977                                          int emcp_method_count) {
3978   assert(Thread::current()-&gt;is_VM_thread(),
3979          &quot;only VMThread can add previous versions&quot;);
3980 
3981   ResourceMark rm;
3982   log_trace(redefine, class, iklass, add)
3983     (&quot;adding previous version ref for %s, EMCP_cnt=%d&quot;, scratch_class-&gt;external_name(), emcp_method_count);
3984 
3985   // Clean out old previous versions for this class
3986   purge_previous_version_list();
3987 
3988   // Mark newly obsolete methods in remaining previous versions.  An EMCP method from
3989   // a previous redefinition may be made obsolete by this redefinition.
3990   Array&lt;Method*&gt;* old_methods = scratch_class-&gt;methods();
3991   mark_newly_obsolete_methods(old_methods, emcp_method_count);
3992 
3993   // If the constant pool for this previous version of the class
3994   // is not marked as being on the stack, then none of the methods
3995   // in this previous version of the class are on the stack so
3996   // we don&#39;t need to add this as a previous version.
3997   ConstantPool* cp_ref = scratch_class-&gt;constants();
3998   if (!cp_ref-&gt;on_stack()) {
3999     log_trace(redefine, class, iklass, add)(&quot;scratch class not added; no methods are running&quot;);
4000     // For debugging purposes.
4001     scratch_class-&gt;set_is_scratch_class();
4002     scratch_class-&gt;class_loader_data()-&gt;add_to_deallocate_list(scratch_class);
4003     return;
4004   }
4005 
4006   if (emcp_method_count != 0) {
4007     // At least one method is still running, check for EMCP methods
4008     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
4009       Method* old_method = old_methods-&gt;at(i);
4010       if (!old_method-&gt;is_obsolete() &amp;&amp; old_method-&gt;on_stack()) {
4011         // if EMCP method (not obsolete) is on the stack, mark as EMCP so that
4012         // we can add breakpoints for it.
4013 
4014         // We set the method-&gt;on_stack bit during safepoints for class redefinition
4015         // and use this bit to set the is_running_emcp bit.
4016         // After the safepoint, the on_stack bit is cleared and the running emcp
4017         // method may exit.   If so, we would set a breakpoint in a method that
4018         // is never reached, but this won&#39;t be noticeable to the programmer.
4019         old_method-&gt;set_running_emcp(true);
4020         log_trace(redefine, class, iklass, add)
4021           (&quot;EMCP method %s is on_stack &quot; INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
4022       } else if (!old_method-&gt;is_obsolete()) {
4023         log_trace(redefine, class, iklass, add)
4024           (&quot;EMCP method %s is NOT on_stack &quot; INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
4025       }
4026     }
4027   }
4028 
4029   // Add previous version if any methods are still running.
4030   // Set has_previous_version flag for processing during class unloading.
4031   _has_previous_versions = true;
4032   log_trace(redefine, class, iklass, add) (&quot;scratch class added; one of its methods is on_stack.&quot;);
4033   assert(scratch_class-&gt;previous_versions() == NULL, &quot;shouldn&#39;t have a previous version&quot;);
4034   scratch_class-&gt;link_previous_versions(previous_versions());
4035   link_previous_versions(scratch_class);
4036 } // end add_previous_version()
4037 
4038 #endif // INCLUDE_JVMTI
4039 
4040 Method* InstanceKlass::method_with_idnum(int idnum) {
4041   Method* m = NULL;
4042   if (idnum &lt; methods()-&gt;length()) {
4043     m = methods()-&gt;at(idnum);
4044   }
4045   if (m == NULL || m-&gt;method_idnum() != idnum) {
4046     for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
4047       m = methods()-&gt;at(index);
4048       if (m-&gt;method_idnum() == idnum) {
4049         return m;
4050       }
4051     }
4052     // None found, return null for the caller to handle.
4053     return NULL;
4054   }
4055   return m;
4056 }
4057 
4058 
4059 Method* InstanceKlass::method_with_orig_idnum(int idnum) {
4060   if (idnum &gt;= methods()-&gt;length()) {
4061     return NULL;
4062   }
4063   Method* m = methods()-&gt;at(idnum);
4064   if (m != NULL &amp;&amp; m-&gt;orig_method_idnum() == idnum) {
4065     return m;
4066   }
4067   // Obsolete method idnum does not match the original idnum
4068   for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
4069     m = methods()-&gt;at(index);
4070     if (m-&gt;orig_method_idnum() == idnum) {
4071       return m;
4072     }
4073   }
4074   // None found, return null for the caller to handle.
4075   return NULL;
4076 }
4077 
4078 
4079 Method* InstanceKlass::method_with_orig_idnum(int idnum, int version) {
4080   InstanceKlass* holder = get_klass_version(version);
4081   if (holder == NULL) {
4082     return NULL; // The version of klass is gone, no method is found
4083   }
4084   Method* method = holder-&gt;method_with_orig_idnum(idnum);
4085   return method;
4086 }
4087 
4088 #if INCLUDE_JVMTI
4089 JvmtiCachedClassFileData* InstanceKlass::get_cached_class_file() {
4090   return _cached_class_file;
4091 }
4092 
4093 jint InstanceKlass::get_cached_class_file_len() {
4094   return VM_RedefineClasses::get_cached_class_file_len(_cached_class_file);
4095 }
4096 
4097 unsigned char * InstanceKlass::get_cached_class_file_bytes() {
4098   return VM_RedefineClasses::get_cached_class_file_bytes(_cached_class_file);
4099 }
4100 #endif
    </pre>
  </body>
</html>