<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.jdwp.agent/share/native/libjdwp/util.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../jdk.jdi/share/classes/com/sun/tools/jdi/JNITypeParser.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../jdk.unsupported/share/classes/sun/misc/Unsafe.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jdwp.agent/share/native/libjdwp/util.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 275             saveGlobalRef(env, localAgentProperties, &amp;(gdata-&gt;agent_properties));
 276             if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {
 277                 JNI_FUNC_PTR(env,ExceptionClear)(env);
 278                 EXIT_ERROR(AGENT_ERROR_INTERNAL,
 279                     &quot;Exception occurred calling VMSupport.getAgentProperties&quot;);
 280             }
 281         }
 282 
 283     } END_WITH_LOCAL_REFS(env);
 284 
 285 }
 286 
 287 void
 288 util_reset(void)
 289 {
 290 }
 291 
 292 jboolean
 293 isObjectTag(jbyte tag) {
 294     return (tag == JDWP_TAG(OBJECT)) ||

 295            (tag == JDWP_TAG(STRING)) ||
 296            (tag == JDWP_TAG(THREAD)) ||
 297            (tag == JDWP_TAG(THREAD_GROUP)) ||
 298            (tag == JDWP_TAG(CLASS_LOADER)) ||
 299            (tag == JDWP_TAG(CLASS_OBJECT)) ||
 300            (tag == JDWP_TAG(ARRAY));
 301 }
 302 
 303 jbyte
 304 specificTypeKey(JNIEnv *env, jobject object)
 305 {
 306     if (object == NULL) {
 307         return JDWP_TAG(OBJECT);
 308     } else if (JNI_FUNC_PTR(env,IsInstanceOf)(env, object, gdata-&gt;stringClass)) {
 309         return JDWP_TAG(STRING);
 310     } else if (JNI_FUNC_PTR(env,IsInstanceOf)(env, object, gdata-&gt;threadClass)) {
 311         return JDWP_TAG(THREAD);
 312     } else if (JNI_FUNC_PTR(env,IsInstanceOf)(env, object, gdata-&gt;threadGroupClass)) {
 313         return JDWP_TAG(THREAD_GROUP);
 314     } else if (JNI_FUNC_PTR(env,IsInstanceOf)(env, object, gdata-&gt;classLoaderClass)) {
</pre>
<hr />
<pre>
 333                 jfieldID field)
 334 {
 335     jclass clazz;
 336     char *signature = NULL;
 337     jvmtiError error;
 338     jbyte typeKey;
 339 
 340     clazz = JNI_FUNC_PTR(env,GetObjectClass)(env, object);
 341     error = fieldSignature(clazz, field, NULL, &amp;signature, NULL);
 342     if (error != JVMTI_ERROR_NONE) {
 343         outStream_setError(out, map2jdwpError(error));
 344         return;
 345     }
 346     typeKey = signature[0];
 347     jvmtiDeallocate(signature);
 348 
 349     /*
 350      * For primitive types, the type key is bounced back as is. Objects
 351      * are handled in the switch statement below.
 352      */
<span class="line-modified"> 353     if ((typeKey != JDWP_TAG(OBJECT)) &amp;&amp; (typeKey != JDWP_TAG(ARRAY))) {</span>
 354         (void)outStream_writeByte(out, typeKey);
 355     }
 356 
 357     switch (typeKey) {
 358         case JDWP_TAG(OBJECT):
<span class="line-modified"> 359         case JDWP_TAG(ARRAY):   {</span>

 360             jobject value = JNI_FUNC_PTR(env,GetObjectField)(env, object, field);
 361             (void)outStream_writeByte(out, specificTypeKey(env, value));
 362             (void)outStream_writeObjectRef(env, out, value);
 363             break;
 364         }
 365 
 366         case JDWP_TAG(BYTE):
 367             (void)outStream_writeByte(out,
 368                       JNI_FUNC_PTR(env,GetByteField)(env, object, field));
 369             break;
 370 
 371         case JDWP_TAG(CHAR):
 372             (void)outStream_writeChar(out,
 373                       JNI_FUNC_PTR(env,GetCharField)(env, object, field));
 374             break;
 375 
 376         case JDWP_TAG(FLOAT):
 377             (void)outStream_writeFloat(out,
 378                       JNI_FUNC_PTR(env,GetFloatField)(env, object, field));
 379             break;
</pre>
<hr />
<pre>
 408 static void
 409 writeStaticFieldValue(JNIEnv *env, PacketOutputStream *out, jclass clazz,
 410                       jfieldID field)
 411 {
 412     jvmtiError error;
 413     char *signature = NULL;
 414     jbyte typeKey;
 415 
 416     error = fieldSignature(clazz, field, NULL, &amp;signature, NULL);
 417     if (error != JVMTI_ERROR_NONE) {
 418         outStream_setError(out, map2jdwpError(error));
 419         return;
 420     }
 421     typeKey = signature[0];
 422     jvmtiDeallocate(signature);
 423 
 424     /*
 425      * For primitive types, the type key is bounced back as is. Objects
 426      * are handled in the switch statement below.
 427      */
<span class="line-modified"> 428     if ((typeKey != JDWP_TAG(OBJECT)) &amp;&amp; (typeKey != JDWP_TAG(ARRAY))) {</span>
 429         (void)outStream_writeByte(out, typeKey);
 430     }
 431 
 432     switch (typeKey) {
 433         case JDWP_TAG(OBJECT):
<span class="line-modified"> 434         case JDWP_TAG(ARRAY):   {</span>

 435             jobject value = JNI_FUNC_PTR(env,GetStaticObjectField)(env, clazz, field);
 436             (void)outStream_writeByte(out, specificTypeKey(env, value));
 437             (void)outStream_writeObjectRef(env, out, value);
 438             break;
 439         }
 440 
 441         case JDWP_TAG(BYTE):
 442             (void)outStream_writeByte(out,
 443                       JNI_FUNC_PTR(env,GetStaticByteField)(env, clazz, field));
 444             break;
 445 
 446         case JDWP_TAG(CHAR):
 447             (void)outStream_writeChar(out,
 448                       JNI_FUNC_PTR(env,GetStaticCharField)(env, clazz, field));
 449             break;
 450 
 451         case JDWP_TAG(FLOAT):
 452             (void)outStream_writeFloat(out,
 453                       JNI_FUNC_PTR(env,GetStaticFloatField)(env, clazz, field));
 454             break;
</pre>
</td>
<td>
<hr />
<pre>
 275             saveGlobalRef(env, localAgentProperties, &amp;(gdata-&gt;agent_properties));
 276             if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {
 277                 JNI_FUNC_PTR(env,ExceptionClear)(env);
 278                 EXIT_ERROR(AGENT_ERROR_INTERNAL,
 279                     &quot;Exception occurred calling VMSupport.getAgentProperties&quot;);
 280             }
 281         }
 282 
 283     } END_WITH_LOCAL_REFS(env);
 284 
 285 }
 286 
 287 void
 288 util_reset(void)
 289 {
 290 }
 291 
 292 jboolean
 293 isObjectTag(jbyte tag) {
 294     return (tag == JDWP_TAG(OBJECT)) ||
<span class="line-added"> 295            (tag == JDWP_TAG(INLINE_OBJECT)) ||</span>
 296            (tag == JDWP_TAG(STRING)) ||
 297            (tag == JDWP_TAG(THREAD)) ||
 298            (tag == JDWP_TAG(THREAD_GROUP)) ||
 299            (tag == JDWP_TAG(CLASS_LOADER)) ||
 300            (tag == JDWP_TAG(CLASS_OBJECT)) ||
 301            (tag == JDWP_TAG(ARRAY));
 302 }
 303 
 304 jbyte
 305 specificTypeKey(JNIEnv *env, jobject object)
 306 {
 307     if (object == NULL) {
 308         return JDWP_TAG(OBJECT);
 309     } else if (JNI_FUNC_PTR(env,IsInstanceOf)(env, object, gdata-&gt;stringClass)) {
 310         return JDWP_TAG(STRING);
 311     } else if (JNI_FUNC_PTR(env,IsInstanceOf)(env, object, gdata-&gt;threadClass)) {
 312         return JDWP_TAG(THREAD);
 313     } else if (JNI_FUNC_PTR(env,IsInstanceOf)(env, object, gdata-&gt;threadGroupClass)) {
 314         return JDWP_TAG(THREAD_GROUP);
 315     } else if (JNI_FUNC_PTR(env,IsInstanceOf)(env, object, gdata-&gt;classLoaderClass)) {
</pre>
<hr />
<pre>
 334                 jfieldID field)
 335 {
 336     jclass clazz;
 337     char *signature = NULL;
 338     jvmtiError error;
 339     jbyte typeKey;
 340 
 341     clazz = JNI_FUNC_PTR(env,GetObjectClass)(env, object);
 342     error = fieldSignature(clazz, field, NULL, &amp;signature, NULL);
 343     if (error != JVMTI_ERROR_NONE) {
 344         outStream_setError(out, map2jdwpError(error));
 345         return;
 346     }
 347     typeKey = signature[0];
 348     jvmtiDeallocate(signature);
 349 
 350     /*
 351      * For primitive types, the type key is bounced back as is. Objects
 352      * are handled in the switch statement below.
 353      */
<span class="line-modified"> 354     if ((typeKey != JDWP_TAG(OBJECT)) &amp;&amp; (typeKey != JDWP_TAG(ARRAY)) &amp;&amp; (typeKey != JDWP_TAG(INLINE_OBJECT))) {</span>
 355         (void)outStream_writeByte(out, typeKey);
 356     }
 357 
 358     switch (typeKey) {
 359         case JDWP_TAG(OBJECT):
<span class="line-modified"> 360         case JDWP_TAG(ARRAY):</span>
<span class="line-added"> 361         case JDWP_TAG(INLINE_OBJECT): {</span>
 362             jobject value = JNI_FUNC_PTR(env,GetObjectField)(env, object, field);
 363             (void)outStream_writeByte(out, specificTypeKey(env, value));
 364             (void)outStream_writeObjectRef(env, out, value);
 365             break;
 366         }
 367 
 368         case JDWP_TAG(BYTE):
 369             (void)outStream_writeByte(out,
 370                       JNI_FUNC_PTR(env,GetByteField)(env, object, field));
 371             break;
 372 
 373         case JDWP_TAG(CHAR):
 374             (void)outStream_writeChar(out,
 375                       JNI_FUNC_PTR(env,GetCharField)(env, object, field));
 376             break;
 377 
 378         case JDWP_TAG(FLOAT):
 379             (void)outStream_writeFloat(out,
 380                       JNI_FUNC_PTR(env,GetFloatField)(env, object, field));
 381             break;
</pre>
<hr />
<pre>
 410 static void
 411 writeStaticFieldValue(JNIEnv *env, PacketOutputStream *out, jclass clazz,
 412                       jfieldID field)
 413 {
 414     jvmtiError error;
 415     char *signature = NULL;
 416     jbyte typeKey;
 417 
 418     error = fieldSignature(clazz, field, NULL, &amp;signature, NULL);
 419     if (error != JVMTI_ERROR_NONE) {
 420         outStream_setError(out, map2jdwpError(error));
 421         return;
 422     }
 423     typeKey = signature[0];
 424     jvmtiDeallocate(signature);
 425 
 426     /*
 427      * For primitive types, the type key is bounced back as is. Objects
 428      * are handled in the switch statement below.
 429      */
<span class="line-modified"> 430     if ((typeKey != JDWP_TAG(OBJECT)) &amp;&amp; (typeKey != JDWP_TAG(ARRAY)) &amp;&amp; (typeKey != JDWP_TAG(INLINE_OBJECT))) {</span>
 431         (void)outStream_writeByte(out, typeKey);
 432     }
 433 
 434     switch (typeKey) {
 435         case JDWP_TAG(OBJECT):
<span class="line-modified"> 436         case JDWP_TAG(ARRAY):</span>
<span class="line-added"> 437         case JDWP_TAG(INLINE_OBJECT): {</span>
 438             jobject value = JNI_FUNC_PTR(env,GetStaticObjectField)(env, clazz, field);
 439             (void)outStream_writeByte(out, specificTypeKey(env, value));
 440             (void)outStream_writeObjectRef(env, out, value);
 441             break;
 442         }
 443 
 444         case JDWP_TAG(BYTE):
 445             (void)outStream_writeByte(out,
 446                       JNI_FUNC_PTR(env,GetStaticByteField)(env, clazz, field));
 447             break;
 448 
 449         case JDWP_TAG(CHAR):
 450             (void)outStream_writeChar(out,
 451                       JNI_FUNC_PTR(env,GetStaticCharField)(env, clazz, field));
 452             break;
 453 
 454         case JDWP_TAG(FLOAT):
 455             (void)outStream_writeFloat(out,
 456                       JNI_FUNC_PTR(env,GetStaticFloatField)(env, clazz, field));
 457             break;
</pre>
</td>
</tr>
</table>
<center><a href="../../../../jdk.jdi/share/classes/com/sun/tools/jdi/JNITypeParser.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../jdk.unsupported/share/classes/sun/misc/Unsafe.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>