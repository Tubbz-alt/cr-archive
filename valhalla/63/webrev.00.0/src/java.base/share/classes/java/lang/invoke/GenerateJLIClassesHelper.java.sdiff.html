<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/java/lang/invoke/GenerateJLIClassesHelper.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../System.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="InnerClassLambdaMetafactory.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/lang/invoke/GenerateJLIClassesHelper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
179                 names.add(callSiteForm.kind.defaultLambdaName);
180 
181                 LambdaForm methodHandleForm = Invokers.callSiteForm(callSiteMethodTypes[i], false);
182                 forms.add(methodHandleForm);
183                 names.add(methodHandleForm.kind.defaultLambdaName);
184             }
185         }
186 
187         return generateCodeBytesForLFs(className,
188                 names.toArray(new String[0]),
189                 forms.toArray(new LambdaForm[0]));
190     }
191 
192     /*
193      * Generate customized code for a set of LambdaForms of specified types into
194      * a class with a specified name.
195      */
196     private static byte[] generateCodeBytesForLFs(String className,
197             String[] names, LambdaForm[] forms) {
198 

199         ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_MAXS + ClassWriter.COMPUTE_FRAMES);
200         cw.visit(Opcodes.V1_8, Opcodes.ACC_PRIVATE + Opcodes.ACC_FINAL + Opcodes.ACC_SUPER,
201                 className, null, InvokerBytecodeGenerator.INVOKER_SUPER_NAME, null);
202         cw.visitSource(className.substring(className.lastIndexOf(&#39;/&#39;) + 1), null);
203 
204         for (int i = 0; i &lt; forms.length; i++) {
<span class="line-modified">205             addMethod(className, names[i], forms[i],</span>
<span class="line-modified">206                     forms[i].methodType(), cw);</span>


207         }
<span class="line-modified">208         return cw.toByteArray();</span>
<span class="line-removed">209     }</span>
<span class="line-removed">210 </span>
<span class="line-removed">211     private static void addMethod(String className, String methodName, LambdaForm form,</span>
<span class="line-removed">212             MethodType type, ClassWriter cw) {</span>
<span class="line-removed">213         InvokerBytecodeGenerator g</span>
<span class="line-removed">214                 = new InvokerBytecodeGenerator(className, methodName, form, type);</span>
<span class="line-removed">215         g.setClassWriter(cw);</span>
216         g.addMethod();
217     }
218 
219     private static LambdaForm makeReinvokerFor(MethodType type) {
220         MethodHandle emptyHandle = MethodHandles.empty(type);
221         return DelegatingMethodHandle.makeReinvokerForm(emptyHandle,
222                 MethodTypeForm.LF_REBIND,
223                 BoundMethodHandle.speciesData_L(),
224                 BoundMethodHandle.speciesData_L().getterFunction(0));
225     }
226 
227     private static LambdaForm makeDelegateFor(MethodType type) {
228         MethodHandle handle = MethodHandles.empty(type);
229         return DelegatingMethodHandle.makeReinvokerForm(
230                 handle,
231                 MethodTypeForm.LF_DELEGATE,
232                 DelegatingMethodHandle.class,
233                 DelegatingMethodHandle.NF_getTarget);
234     }
235 
</pre>
</td>
<td>
<hr />
<pre>
179                 names.add(callSiteForm.kind.defaultLambdaName);
180 
181                 LambdaForm methodHandleForm = Invokers.callSiteForm(callSiteMethodTypes[i], false);
182                 forms.add(methodHandleForm);
183                 names.add(methodHandleForm.kind.defaultLambdaName);
184             }
185         }
186 
187         return generateCodeBytesForLFs(className,
188                 names.toArray(new String[0]),
189                 forms.toArray(new LambdaForm[0]));
190     }
191 
192     /*
193      * Generate customized code for a set of LambdaForms of specified types into
194      * a class with a specified name.
195      */
196     private static byte[] generateCodeBytesForLFs(String className,
197             String[] names, LambdaForm[] forms) {
198 
<span class="line-added">199 </span>
200         ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_MAXS + ClassWriter.COMPUTE_FRAMES);
201         cw.visit(Opcodes.V1_8, Opcodes.ACC_PRIVATE + Opcodes.ACC_FINAL + Opcodes.ACC_SUPER,
202                 className, null, InvokerBytecodeGenerator.INVOKER_SUPER_NAME, null);
203         cw.visitSource(className.substring(className.lastIndexOf(&#39;/&#39;) + 1), null);
204 
205         for (int i = 0; i &lt; forms.length; i++) {
<span class="line-modified">206             InvokerBytecodeGenerator g</span>
<span class="line-modified">207                 = new InvokerBytecodeGenerator(className, names[i], forms[i], forms[i].methodType());</span>
<span class="line-added">208             g.setClassWriter(cw);</span>
<span class="line-added">209             g.addMethod();</span>
210         }
<span class="line-modified">211 </span>







212         return cw.toByteArray();
213     }
214 
215     private static LambdaForm makeReinvokerFor(MethodType type) {
216         MethodHandle emptyHandle = MethodHandles.empty(type);
217         return DelegatingMethodHandle.makeReinvokerForm(emptyHandle,
218                 MethodTypeForm.LF_REBIND,
219                 BoundMethodHandle.speciesData_L(),
220                 BoundMethodHandle.speciesData_L().getterFunction(0));
221     }
222 
223     private static LambdaForm makeDelegateFor(MethodType type) {
224         MethodHandle handle = MethodHandles.empty(type);
225         return DelegatingMethodHandle.makeReinvokerForm(
226                 handle,
227                 MethodTypeForm.LF_DELEGATE,
228                 DelegatingMethodHandle.class,
229                 DelegatingMethodHandle.NF_getTarget);
230     }
231 
</pre>
</td>
</tr>
</table>
<center><a href="../System.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="InnerClassLambdaMetafactory.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>