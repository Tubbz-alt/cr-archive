<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/opto/library_call.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;asm/macroAssembler.hpp&quot;
  27 #include &quot;ci/ciUtilities.inline.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;compiler/compileBroker.hpp&quot;
  31 #include &quot;compiler/compileLog.hpp&quot;
  32 #include &quot;gc/shared/barrierSet.hpp&quot;
  33 #include &quot;jfr/support/jfrIntrinsics.hpp&quot;
  34 #include &quot;memory/resourceArea.hpp&quot;
  35 #include &quot;oops/klass.inline.hpp&quot;
  36 #include &quot;oops/objArrayKlass.hpp&quot;
  37 #include &quot;opto/addnode.hpp&quot;
  38 #include &quot;opto/arraycopynode.hpp&quot;
  39 #include &quot;opto/c2compiler.hpp&quot;
  40 #include &quot;opto/callGenerator.hpp&quot;
  41 #include &quot;opto/castnode.hpp&quot;
  42 #include &quot;opto/cfgnode.hpp&quot;
  43 #include &quot;opto/convertnode.hpp&quot;
  44 #include &quot;opto/countbitsnode.hpp&quot;
  45 #include &quot;opto/intrinsicnode.hpp&quot;
  46 #include &quot;opto/idealKit.hpp&quot;
  47 #include &quot;opto/mathexactnode.hpp&quot;
  48 #include &quot;opto/movenode.hpp&quot;
  49 #include &quot;opto/mulnode.hpp&quot;
  50 #include &quot;opto/narrowptrnode.hpp&quot;
  51 #include &quot;opto/opaquenode.hpp&quot;
  52 #include &quot;opto/parse.hpp&quot;
  53 #include &quot;opto/runtime.hpp&quot;
  54 #include &quot;opto/rootnode.hpp&quot;
  55 #include &quot;opto/subnode.hpp&quot;
  56 #include &quot;opto/valuetypenode.hpp&quot;
  57 #include &quot;prims/nativeLookup.hpp&quot;
  58 #include &quot;prims/unsafe.hpp&quot;
  59 #include &quot;runtime/objectMonitor.hpp&quot;
  60 #include &quot;runtime/sharedRuntime.hpp&quot;
  61 #include &quot;utilities/macros.hpp&quot;
  62 #include &quot;utilities/powerOfTwo.hpp&quot;
  63 
  64 class LibraryIntrinsic : public InlineCallGenerator {
  65   // Extend the set of intrinsics known to the runtime:
  66  public:
  67  private:
  68   bool             _is_virtual;
  69   bool             _does_virtual_dispatch;
  70   int8_t           _predicates_count;  // Intrinsic is predicated by several conditions
  71   int8_t           _last_predicate; // Last generated predicate
  72   vmIntrinsics::ID _intrinsic_id;
  73 
  74  public:
  75   LibraryIntrinsic(ciMethod* m, bool is_virtual, int predicates_count, bool does_virtual_dispatch, vmIntrinsics::ID id)
  76     : InlineCallGenerator(m),
  77       _is_virtual(is_virtual),
  78       _does_virtual_dispatch(does_virtual_dispatch),
  79       _predicates_count((int8_t)predicates_count),
  80       _last_predicate((int8_t)-1),
  81       _intrinsic_id(id)
  82   {
  83   }
  84   virtual bool is_intrinsic() const { return true; }
  85   virtual bool is_virtual()   const { return _is_virtual; }
  86   virtual bool is_predicated() const { return _predicates_count &gt; 0; }
  87   virtual int  predicates_count() const { return _predicates_count; }
  88   virtual bool does_virtual_dispatch()   const { return _does_virtual_dispatch; }
  89   virtual JVMState* generate(JVMState* jvms);
  90   virtual Node* generate_predicate(JVMState* jvms, int predicate);
  91   vmIntrinsics::ID intrinsic_id() const { return _intrinsic_id; }
  92 };
  93 
  94 
  95 // Local helper class for LibraryIntrinsic:
  96 class LibraryCallKit : public GraphKit {
  97  private:
  98   LibraryIntrinsic* _intrinsic;     // the library intrinsic being called
  99   Node*             _result;        // the result node, if any
 100   int               _reexecute_sp;  // the stack pointer when bytecode needs to be reexecuted
 101 
 102   const TypeOopPtr* sharpen_unsafe_type(Compile::AliasType* alias_type, const TypePtr *adr_type);
 103 
 104  public:
 105   LibraryCallKit(JVMState* jvms, LibraryIntrinsic* intrinsic)
 106     : GraphKit(jvms),
 107       _intrinsic(intrinsic),
 108       _result(NULL)
 109   {
 110     // Check if this is a root compile.  In that case we don&#39;t have a caller.
 111     if (!jvms-&gt;has_method()) {
 112       _reexecute_sp = sp();
 113     } else {
 114       // Find out how many arguments the interpreter needs when deoptimizing
 115       // and save the stack pointer value so it can used by uncommon_trap.
 116       // We find the argument count by looking at the declared signature.
 117       bool ignored_will_link;
 118       ciSignature* declared_signature = NULL;
 119       ciMethod* ignored_callee = caller()-&gt;get_method_at_bci(bci(), ignored_will_link, &amp;declared_signature);
 120       const int nargs = declared_signature-&gt;arg_size_for_bc(caller()-&gt;java_code_at_bci(bci()));
 121       _reexecute_sp = sp() + nargs;  // &quot;push&quot; arguments back on stack
 122     }
 123   }
 124 
 125   virtual LibraryCallKit* is_LibraryCallKit() const { return (LibraryCallKit*)this; }
 126 
 127   ciMethod*         caller()    const    { return jvms()-&gt;method(); }
 128   int               bci()       const    { return jvms()-&gt;bci(); }
 129   LibraryIntrinsic* intrinsic() const    { return _intrinsic; }
 130   vmIntrinsics::ID  intrinsic_id() const { return _intrinsic-&gt;intrinsic_id(); }
 131   ciMethod*         callee()    const    { return _intrinsic-&gt;method(); }
 132 
 133   bool  try_to_inline(int predicate);
 134   Node* try_to_predicate(int predicate);
 135 
 136   void push_result() {
 137     // Push the result onto the stack.
 138     Node* res = result();
 139     if (!stopped() &amp;&amp; res != NULL) {
 140       BasicType bt = res-&gt;bottom_type()-&gt;basic_type();
 141       if (C-&gt;inlining_incrementally() &amp;&amp; res-&gt;is_ValueType()) {
 142         // The caller expects an oop when incrementally inlining an intrinsic that returns an
 143         // inline type. Make sure the call is re-executed if the allocation triggers a deoptimization.
 144         PreserveReexecuteState preexecs(this);
 145         jvms()-&gt;set_should_reexecute(true);
 146         res = ValueTypePtrNode::make_from_value_type(this, res-&gt;as_ValueType());
 147       }
 148       push_node(bt, res);
 149     }
 150   }
 151 
 152  private:
 153   void fatal_unexpected_iid(vmIntrinsics::ID iid) {
 154     fatal(&quot;unexpected intrinsic %d: %s&quot;, iid, vmIntrinsics::name_at(iid));
 155   }
 156 
 157   void  set_result(Node* n) { assert(_result == NULL, &quot;only set once&quot;); _result = n; }
 158   void  set_result(RegionNode* region, PhiNode* value);
 159   Node*     result() { return _result; }
 160 
 161   virtual int reexecute_sp() { return _reexecute_sp; }
 162 
 163   // Helper functions to inline natives
 164   Node* generate_guard(Node* test, RegionNode* region, float true_prob);
 165   Node* generate_slow_guard(Node* test, RegionNode* region);
 166   Node* generate_fair_guard(Node* test, RegionNode* region);
 167   Node* generate_negative_guard(Node* index, RegionNode* region,
 168                                 // resulting CastII of index:
 169                                 Node* *pos_index = NULL);
 170   Node* generate_limit_guard(Node* offset, Node* subseq_length,
 171                              Node* array_length,
 172                              RegionNode* region);
 173   void  generate_string_range_check(Node* array, Node* offset,
 174                                     Node* length, bool char_count);
 175   Node* generate_current_thread(Node* &amp;tls_output);
 176   Node* load_klass_from_mirror_common(Node* mirror, bool never_see_null,
 177                                       RegionNode* region, int null_path,
 178                                       int offset);
 179   Node* load_klass_from_mirror(Node* mirror, bool never_see_null,
 180                                RegionNode* region, int null_path) {
 181     int offset = java_lang_Class::klass_offset_in_bytes();
 182     return load_klass_from_mirror_common(mirror, never_see_null,
 183                                          region, null_path,
 184                                          offset);
 185   }
 186   Node* load_array_klass_from_mirror(Node* mirror, bool never_see_null,
 187                                      RegionNode* region, int null_path) {
 188     int offset = java_lang_Class::array_klass_offset_in_bytes();
 189     return load_klass_from_mirror_common(mirror, never_see_null,
 190                                          region, null_path,
 191                                          offset);
 192   }
 193   Node* generate_access_flags_guard(Node* kls,
 194                                     int modifier_mask, int modifier_bits,
 195                                     RegionNode* region);
 196   Node* generate_interface_guard(Node* kls, RegionNode* region);
 197   Node* generate_value_guard(Node* kls, RegionNode* region);
 198 
 199   enum ArrayKind {
 200     AnyArray,
 201     NonArray,
 202     ObjectArray,
 203     NonObjectArray,
 204     TypeArray,
 205     ValueArray
 206   };
 207 
 208   Node* generate_array_guard(Node* kls, RegionNode* region) {
 209     return generate_array_guard_common(kls, region, AnyArray);
 210   }
 211   Node* generate_non_array_guard(Node* kls, RegionNode* region) {
 212     return generate_array_guard_common(kls, region, NonArray);
 213   }
 214   Node* generate_objArray_guard(Node* kls, RegionNode* region) {
 215     return generate_array_guard_common(kls, region, ObjectArray);
 216   }
 217   Node* generate_non_objArray_guard(Node* kls, RegionNode* region) {
 218     return generate_array_guard_common(kls, region, NonObjectArray);
 219   }
 220   Node* generate_typeArray_guard(Node* kls, RegionNode* region) {
 221     return generate_array_guard_common(kls, region, TypeArray);
 222   }
 223   Node* generate_valueArray_guard(Node* kls, RegionNode* region) {
 224     assert(ValueArrayFlatten, &quot;can never be flattened&quot;);
 225     return generate_array_guard_common(kls, region, ValueArray);
 226   }
 227   Node* generate_array_guard_common(Node* kls, RegionNode* region, ArrayKind kind);
 228   Node* generate_virtual_guard(Node* obj_klass, RegionNode* slow_region);
 229   CallJavaNode* generate_method_call(vmIntrinsics::ID method_id,
 230                                      bool is_virtual = false, bool is_static = false);
 231   CallJavaNode* generate_method_call_static(vmIntrinsics::ID method_id) {
 232     return generate_method_call(method_id, false, true);
 233   }
 234   CallJavaNode* generate_method_call_virtual(vmIntrinsics::ID method_id) {
 235     return generate_method_call(method_id, true, false);
 236   }
 237   Node * load_field_from_object(Node * fromObj, const char * fieldName, const char * fieldTypeString, bool is_exact, bool is_static, ciInstanceKlass * fromKls);
 238   Node * field_address_from_object(Node * fromObj, const char * fieldName, const char * fieldTypeString, bool is_exact, bool is_static, ciInstanceKlass * fromKls);
 239 
 240   Node* make_string_method_node(int opcode, Node* str1_start, Node* cnt1, Node* str2_start, Node* cnt2, StrIntrinsicNode::ArgEnc ae);
 241   bool inline_string_compareTo(StrIntrinsicNode::ArgEnc ae);
 242   bool inline_string_indexOf(StrIntrinsicNode::ArgEnc ae);
 243   bool inline_string_indexOfI(StrIntrinsicNode::ArgEnc ae);
 244   Node* make_indexOf_node(Node* src_start, Node* src_count, Node* tgt_start, Node* tgt_count,
 245                           RegionNode* region, Node* phi, StrIntrinsicNode::ArgEnc ae);
 246   bool inline_string_indexOfChar();
 247   bool inline_string_equals(StrIntrinsicNode::ArgEnc ae);
 248   bool inline_string_toBytesU();
 249   bool inline_string_getCharsU();
 250   bool inline_string_copy(bool compress);
 251   bool inline_string_char_access(bool is_store);
 252   Node* round_double_node(Node* n);
 253   bool runtime_math(const TypeFunc* call_type, address funcAddr, const char* funcName);
 254   bool inline_math_native(vmIntrinsics::ID id);
 255   bool inline_math(vmIntrinsics::ID id);
 256   bool inline_double_math(vmIntrinsics::ID id);
 257   template &lt;typename OverflowOp&gt;
 258   bool inline_math_overflow(Node* arg1, Node* arg2);
 259   void inline_math_mathExact(Node* math, Node* test);
 260   bool inline_math_addExactI(bool is_increment);
 261   bool inline_math_addExactL(bool is_increment);
 262   bool inline_math_multiplyExactI();
 263   bool inline_math_multiplyExactL();
 264   bool inline_math_multiplyHigh();
 265   bool inline_math_negateExactI();
 266   bool inline_math_negateExactL();
 267   bool inline_math_subtractExactI(bool is_decrement);
 268   bool inline_math_subtractExactL(bool is_decrement);
 269   bool inline_min_max(vmIntrinsics::ID id);
 270   bool inline_notify(vmIntrinsics::ID id);
 271   Node* generate_min_max(vmIntrinsics::ID id, Node* x, Node* y);
 272   // This returns Type::AnyPtr, RawPtr, or OopPtr.
 273   int classify_unsafe_addr(Node* &amp;base, Node* &amp;offset, BasicType type);
 274   Node* make_unsafe_address(Node*&amp; base, Node* offset, DecoratorSet decorators, BasicType type = T_ILLEGAL, bool can_cast = false);
 275 
 276   typedef enum { Relaxed, Opaque, Volatile, Acquire, Release } AccessKind;
 277   DecoratorSet mo_decorator_for_access_kind(AccessKind kind);
 278   bool inline_unsafe_access(bool is_store, BasicType type, AccessKind kind, bool is_unaligned);
 279   static bool klass_needs_init_guard(Node* kls);
 280   bool inline_unsafe_allocate();
 281   bool inline_unsafe_newArray(bool uninitialized);
 282   bool inline_unsafe_writeback0();
 283   bool inline_unsafe_writebackSync0(bool is_pre);
 284   bool inline_unsafe_copyMemory();
 285   bool inline_unsafe_make_private_buffer();
 286   bool inline_unsafe_finish_private_buffer();
 287   bool inline_native_currentThread();
 288 
 289   bool inline_native_time_funcs(address method, const char* funcName);
 290 #ifdef JFR_HAVE_INTRINSICS
 291   bool inline_native_classID();
 292   bool inline_native_getEventWriter();
 293 #endif
 294   bool inline_native_Class_query(vmIntrinsics::ID id);
 295   bool inline_native_subtype_check();
 296   bool inline_native_getLength();
 297   bool inline_array_copyOf(bool is_copyOfRange);
 298   bool inline_array_equals(StrIntrinsicNode::ArgEnc ae);
 299   bool inline_preconditions_checkIndex();
 300   void copy_to_clone(Node* obj, Node* alloc_obj, Node* obj_size, bool is_array);
 301   bool inline_native_clone(bool is_virtual);
 302   bool inline_native_Reflection_getCallerClass();
 303   // Helper function for inlining native object hash method
 304   bool inline_native_hashcode(bool is_virtual, bool is_static);
 305   bool inline_native_getClass();
 306 
 307   // Helper functions for inlining arraycopy
 308   bool inline_arraycopy();
 309   AllocateArrayNode* tightly_coupled_allocation(Node* ptr,
 310                                                 RegionNode* slow_region);
 311   JVMState* arraycopy_restore_alloc_state(AllocateArrayNode* alloc, int&amp; saved_reexecute_sp);
 312   void arraycopy_move_allocation_here(AllocateArrayNode* alloc, Node* dest, JVMState* saved_jvms, int saved_reexecute_sp,
 313                                       uint new_idx);
 314 
 315   typedef enum { LS_get_add, LS_get_set, LS_cmp_swap, LS_cmp_swap_weak, LS_cmp_exchange } LoadStoreKind;
 316   bool inline_unsafe_load_store(BasicType type,  LoadStoreKind kind, AccessKind access_kind);
 317   bool inline_unsafe_fence(vmIntrinsics::ID id);
 318   bool inline_onspinwait();
 319   bool inline_fp_conversions(vmIntrinsics::ID id);
 320   bool inline_number_methods(vmIntrinsics::ID id);
 321   bool inline_reference_get();
 322   bool inline_Class_cast();
 323   bool inline_aescrypt_Block(vmIntrinsics::ID id);
 324   bool inline_cipherBlockChaining_AESCrypt(vmIntrinsics::ID id);
 325   bool inline_electronicCodeBook_AESCrypt(vmIntrinsics::ID id);
 326   bool inline_counterMode_AESCrypt(vmIntrinsics::ID id);
 327   Node* inline_cipherBlockChaining_AESCrypt_predicate(bool decrypting);
 328   Node* inline_electronicCodeBook_AESCrypt_predicate(bool decrypting);
 329   Node* inline_counterMode_AESCrypt_predicate();
 330   Node* get_key_start_from_aescrypt_object(Node* aescrypt_object);
 331   Node* get_original_key_start_from_aescrypt_object(Node* aescrypt_object);
 332   bool inline_ghash_processBlocks();
 333   bool inline_base64_encodeBlock();
 334   bool inline_sha_implCompress(vmIntrinsics::ID id);
 335   bool inline_digestBase_implCompressMB(int predicate);
 336   bool inline_sha_implCompressMB(Node* digestBaseObj, ciInstanceKlass* instklass_SHA,
 337                                  bool long_state, address stubAddr, const char *stubName,
 338                                  Node* src_start, Node* ofs, Node* limit);
 339   Node* get_state_from_sha_object(Node *sha_object);
 340   Node* get_state_from_sha5_object(Node *sha_object);
 341   Node* inline_digestBase_implCompressMB_predicate(int predicate);
 342   bool inline_encodeISOArray();
 343   bool inline_updateCRC32();
 344   bool inline_updateBytesCRC32();
 345   bool inline_updateByteBufferCRC32();
 346   Node* get_table_from_crc32c_class(ciInstanceKlass *crc32c_class);
 347   bool inline_updateBytesCRC32C();
 348   bool inline_updateDirectByteBufferCRC32C();
 349   bool inline_updateBytesAdler32();
 350   bool inline_updateByteBufferAdler32();
 351   bool inline_multiplyToLen();
 352   bool inline_hasNegatives();
 353   bool inline_squareToLen();
 354   bool inline_mulAdd();
 355   bool inline_montgomeryMultiply();
 356   bool inline_montgomerySquare();
 357   bool inline_bigIntegerShift(bool isRightShift);
 358   bool inline_vectorizedMismatch();
 359   bool inline_fma(vmIntrinsics::ID id);
 360   bool inline_character_compare(vmIntrinsics::ID id);
 361   bool inline_fp_min_max(vmIntrinsics::ID id);
 362 
 363   bool inline_profileBoolean();
 364   bool inline_isCompileConstant();
 365   void clear_upper_avx() {
 366 #ifdef X86
 367     if (UseAVX &gt;= 2) {
 368       C-&gt;set_clear_upper_avx(true);
 369     }
 370 #endif
 371   }
 372 };
 373 
 374 //---------------------------make_vm_intrinsic----------------------------
 375 CallGenerator* Compile::make_vm_intrinsic(ciMethod* m, bool is_virtual) {
 376   vmIntrinsics::ID id = m-&gt;intrinsic_id();
 377   assert(id != vmIntrinsics::_none, &quot;must be a VM intrinsic&quot;);
 378 
 379   if (!m-&gt;is_loaded()) {
 380     // Do not attempt to inline unloaded methods.
 381     return NULL;
 382   }
 383 
 384   C2Compiler* compiler = (C2Compiler*)CompileBroker::compiler(CompLevel_full_optimization);
 385   bool is_available = false;
 386 
 387   {
 388     // For calling is_intrinsic_supported and is_intrinsic_disabled_by_flag
 389     // the compiler must transition to &#39;_thread_in_vm&#39; state because both
 390     // methods access VM-internal data.
 391     VM_ENTRY_MARK;
 392     methodHandle mh(THREAD, m-&gt;get_Method());
 393     is_available = compiler != NULL &amp;&amp; compiler-&gt;is_intrinsic_supported(mh, is_virtual) &amp;&amp;
 394                    !C-&gt;directive()-&gt;is_intrinsic_disabled(mh) &amp;&amp;
 395                    !vmIntrinsics::is_disabled_by_flags(mh);
 396 
 397   }
 398 
 399   if (is_available) {
 400     assert(id &lt;= vmIntrinsics::LAST_COMPILER_INLINE, &quot;caller responsibility&quot;);
 401     assert(id != vmIntrinsics::_Object_init &amp;&amp; id != vmIntrinsics::_invoke, &quot;enum out of order?&quot;);
 402     return new LibraryIntrinsic(m, is_virtual,
 403                                 vmIntrinsics::predicates_needed(id),
 404                                 vmIntrinsics::does_virtual_dispatch(id),
 405                                 (vmIntrinsics::ID) id);
 406   } else {
 407     return NULL;
 408   }
 409 }
 410 
 411 //----------------------register_library_intrinsics-----------------------
 412 // Initialize this file&#39;s data structures, for each Compile instance.
 413 void Compile::register_library_intrinsics() {
 414   // Nothing to do here.
 415 }
 416 
 417 JVMState* LibraryIntrinsic::generate(JVMState* jvms) {
 418   LibraryCallKit kit(jvms, this);
 419   Compile* C = kit.C;
 420   int nodes = C-&gt;unique();
 421 #ifndef PRODUCT
 422   if ((C-&gt;print_intrinsics() || C-&gt;print_inlining()) &amp;&amp; Verbose) {
 423     char buf[1000];
 424     const char* str = vmIntrinsics::short_name_as_C_string(intrinsic_id(), buf, sizeof(buf));
 425     tty-&gt;print_cr(&quot;Intrinsic %s&quot;, str);
 426   }
 427 #endif
 428   ciMethod* callee = kit.callee();
 429   const int bci    = kit.bci();
 430 
 431   // Try to inline the intrinsic.
 432   if ((CheckIntrinsics ? callee-&gt;intrinsic_candidate() : true) &amp;&amp;
 433       kit.try_to_inline(_last_predicate)) {
 434     const char *inline_msg = is_virtual() ? &quot;(intrinsic, virtual)&quot;
 435                                           : &quot;(intrinsic)&quot;;
 436     CompileTask::print_inlining_ul(callee, jvms-&gt;depth() - 1, bci, inline_msg);
 437     if (C-&gt;print_intrinsics() || C-&gt;print_inlining()) {
 438       C-&gt;print_inlining(callee, jvms-&gt;depth() - 1, bci, inline_msg);
 439     }
 440     C-&gt;gather_intrinsic_statistics(intrinsic_id(), is_virtual(), Compile::_intrinsic_worked);
 441     if (C-&gt;log()) {
 442       C-&gt;log()-&gt;elem(&quot;intrinsic id=&#39;%s&#39;%s nodes=&#39;%d&#39;&quot;,
 443                      vmIntrinsics::name_at(intrinsic_id()),
 444                      (is_virtual() ? &quot; virtual=&#39;1&#39;&quot; : &quot;&quot;),
 445                      C-&gt;unique() - nodes);
 446     }
 447     // Push the result from the inlined method onto the stack.
 448     kit.push_result();
 449     C-&gt;print_inlining_update(this);
 450     return kit.transfer_exceptions_into_jvms();
 451   }
 452 
 453   // The intrinsic bailed out
 454   if (jvms-&gt;has_method()) {
 455     // Not a root compile.
 456     const char* msg;
 457     if (callee-&gt;intrinsic_candidate()) {
 458       msg = is_virtual() ? &quot;failed to inline (intrinsic, virtual)&quot; : &quot;failed to inline (intrinsic)&quot;;
 459     } else {
 460       msg = is_virtual() ? &quot;failed to inline (intrinsic, virtual), method not annotated&quot;
 461                          : &quot;failed to inline (intrinsic), method not annotated&quot;;
 462     }
 463     CompileTask::print_inlining_ul(callee, jvms-&gt;depth() - 1, bci, msg);
 464     if (C-&gt;print_intrinsics() || C-&gt;print_inlining()) {
 465       C-&gt;print_inlining(callee, jvms-&gt;depth() - 1, bci, msg);
 466     }
 467   } else {
 468     // Root compile
 469     ResourceMark rm;
 470     stringStream msg_stream;
 471     msg_stream.print(&quot;Did not generate intrinsic %s%s at bci:%d in&quot;,
 472                      vmIntrinsics::name_at(intrinsic_id()),
 473                      is_virtual() ? &quot; (virtual)&quot; : &quot;&quot;, bci);
 474     const char *msg = msg_stream.as_string();
 475     log_debug(jit, inlining)(&quot;%s&quot;, msg);
 476     if (C-&gt;print_intrinsics() || C-&gt;print_inlining()) {
 477       tty-&gt;print(&quot;%s&quot;, msg);
 478     }
 479   }
 480   C-&gt;gather_intrinsic_statistics(intrinsic_id(), is_virtual(), Compile::_intrinsic_failed);
 481   C-&gt;print_inlining_update(this);
 482   return NULL;
 483 }
 484 
 485 Node* LibraryIntrinsic::generate_predicate(JVMState* jvms, int predicate) {
 486   LibraryCallKit kit(jvms, this);
 487   Compile* C = kit.C;
 488   int nodes = C-&gt;unique();
 489   _last_predicate = predicate;
 490 #ifndef PRODUCT
 491   assert(is_predicated() &amp;&amp; predicate &lt; predicates_count(), &quot;sanity&quot;);
 492   if ((C-&gt;print_intrinsics() || C-&gt;print_inlining()) &amp;&amp; Verbose) {
 493     char buf[1000];
 494     const char* str = vmIntrinsics::short_name_as_C_string(intrinsic_id(), buf, sizeof(buf));
 495     tty-&gt;print_cr(&quot;Predicate for intrinsic %s&quot;, str);
 496   }
 497 #endif
 498   ciMethod* callee = kit.callee();
 499   const int bci    = kit.bci();
 500 
 501   Node* slow_ctl = kit.try_to_predicate(predicate);
 502   if (!kit.failing()) {
 503     const char *inline_msg = is_virtual() ? &quot;(intrinsic, virtual, predicate)&quot;
 504                                           : &quot;(intrinsic, predicate)&quot;;
 505     CompileTask::print_inlining_ul(callee, jvms-&gt;depth() - 1, bci, inline_msg);
 506     if (C-&gt;print_intrinsics() || C-&gt;print_inlining()) {
 507       C-&gt;print_inlining(callee, jvms-&gt;depth() - 1, bci, inline_msg);
 508     }
 509     C-&gt;gather_intrinsic_statistics(intrinsic_id(), is_virtual(), Compile::_intrinsic_worked);
 510     if (C-&gt;log()) {
 511       C-&gt;log()-&gt;elem(&quot;predicate_intrinsic id=&#39;%s&#39;%s nodes=&#39;%d&#39;&quot;,
 512                      vmIntrinsics::name_at(intrinsic_id()),
 513                      (is_virtual() ? &quot; virtual=&#39;1&#39;&quot; : &quot;&quot;),
 514                      C-&gt;unique() - nodes);
 515     }
 516     return slow_ctl; // Could be NULL if the check folds.
 517   }
 518 
 519   // The intrinsic bailed out
 520   if (jvms-&gt;has_method()) {
 521     // Not a root compile.
 522     const char* msg = &quot;failed to generate predicate for intrinsic&quot;;
 523     CompileTask::print_inlining_ul(kit.callee(), jvms-&gt;depth() - 1, bci, msg);
 524     if (C-&gt;print_intrinsics() || C-&gt;print_inlining()) {
 525       C-&gt;print_inlining(kit.callee(), jvms-&gt;depth() - 1, bci, msg);
 526     }
 527   } else {
 528     // Root compile
 529     ResourceMark rm;
 530     stringStream msg_stream;
 531     msg_stream.print(&quot;Did not generate intrinsic %s%s at bci:%d in&quot;,
 532                      vmIntrinsics::name_at(intrinsic_id()),
 533                      is_virtual() ? &quot; (virtual)&quot; : &quot;&quot;, bci);
 534     const char *msg = msg_stream.as_string();
 535     log_debug(jit, inlining)(&quot;%s&quot;, msg);
 536     if (C-&gt;print_intrinsics() || C-&gt;print_inlining()) {
 537       C-&gt;print_inlining_stream()-&gt;print(&quot;%s&quot;, msg);
 538     }
 539   }
 540   C-&gt;gather_intrinsic_statistics(intrinsic_id(), is_virtual(), Compile::_intrinsic_failed);
 541   return NULL;
 542 }
 543 
 544 bool LibraryCallKit::try_to_inline(int predicate) {
 545   // Handle symbolic names for otherwise undistinguished boolean switches:
 546   const bool is_store       = true;
 547   const bool is_compress    = true;
 548   const bool is_static      = true;
 549   const bool is_volatile    = true;
 550 
 551   if (!jvms()-&gt;has_method()) {
 552     // Root JVMState has a null method.
 553     assert(map()-&gt;memory()-&gt;Opcode() == Op_Parm, &quot;&quot;);
 554     // Insert the memory aliasing node
 555     set_all_memory(reset_memory());
 556   }
 557   assert(merged_memory(), &quot;&quot;);
 558 
 559 
 560   switch (intrinsic_id()) {
 561   case vmIntrinsics::_hashCode:                 return inline_native_hashcode(intrinsic()-&gt;is_virtual(), !is_static);
 562   case vmIntrinsics::_identityHashCode:         return inline_native_hashcode(/*!virtual*/ false,         is_static);
 563   case vmIntrinsics::_getClass:                 return inline_native_getClass();
 564 
 565   case vmIntrinsics::_ceil:
 566   case vmIntrinsics::_floor:
 567   case vmIntrinsics::_rint:
 568   case vmIntrinsics::_dsin:
 569   case vmIntrinsics::_dcos:
 570   case vmIntrinsics::_dtan:
 571   case vmIntrinsics::_dabs:
 572   case vmIntrinsics::_fabs:
 573   case vmIntrinsics::_iabs:
 574   case vmIntrinsics::_labs:
 575   case vmIntrinsics::_datan2:
 576   case vmIntrinsics::_dsqrt:
 577   case vmIntrinsics::_dexp:
 578   case vmIntrinsics::_dlog:
 579   case vmIntrinsics::_dlog10:
 580   case vmIntrinsics::_dpow:                     return inline_math_native(intrinsic_id());
 581 
 582   case vmIntrinsics::_min:
 583   case vmIntrinsics::_max:                      return inline_min_max(intrinsic_id());
 584 
 585   case vmIntrinsics::_notify:
 586   case vmIntrinsics::_notifyAll:
 587     return inline_notify(intrinsic_id());
 588 
 589   case vmIntrinsics::_addExactI:                return inline_math_addExactI(false /* add */);
 590   case vmIntrinsics::_addExactL:                return inline_math_addExactL(false /* add */);
 591   case vmIntrinsics::_decrementExactI:          return inline_math_subtractExactI(true /* decrement */);
 592   case vmIntrinsics::_decrementExactL:          return inline_math_subtractExactL(true /* decrement */);
 593   case vmIntrinsics::_incrementExactI:          return inline_math_addExactI(true /* increment */);
 594   case vmIntrinsics::_incrementExactL:          return inline_math_addExactL(true /* increment */);
 595   case vmIntrinsics::_multiplyExactI:           return inline_math_multiplyExactI();
 596   case vmIntrinsics::_multiplyExactL:           return inline_math_multiplyExactL();
 597   case vmIntrinsics::_multiplyHigh:             return inline_math_multiplyHigh();
 598   case vmIntrinsics::_negateExactI:             return inline_math_negateExactI();
 599   case vmIntrinsics::_negateExactL:             return inline_math_negateExactL();
 600   case vmIntrinsics::_subtractExactI:           return inline_math_subtractExactI(false /* subtract */);
 601   case vmIntrinsics::_subtractExactL:           return inline_math_subtractExactL(false /* subtract */);
 602 
 603   case vmIntrinsics::_arraycopy:                return inline_arraycopy();
 604 
 605   case vmIntrinsics::_compareToL:               return inline_string_compareTo(StrIntrinsicNode::LL);
 606   case vmIntrinsics::_compareToU:               return inline_string_compareTo(StrIntrinsicNode::UU);
 607   case vmIntrinsics::_compareToLU:              return inline_string_compareTo(StrIntrinsicNode::LU);
 608   case vmIntrinsics::_compareToUL:              return inline_string_compareTo(StrIntrinsicNode::UL);
 609 
 610   case vmIntrinsics::_indexOfL:                 return inline_string_indexOf(StrIntrinsicNode::LL);
 611   case vmIntrinsics::_indexOfU:                 return inline_string_indexOf(StrIntrinsicNode::UU);
 612   case vmIntrinsics::_indexOfUL:                return inline_string_indexOf(StrIntrinsicNode::UL);
 613   case vmIntrinsics::_indexOfIL:                return inline_string_indexOfI(StrIntrinsicNode::LL);
 614   case vmIntrinsics::_indexOfIU:                return inline_string_indexOfI(StrIntrinsicNode::UU);
 615   case vmIntrinsics::_indexOfIUL:               return inline_string_indexOfI(StrIntrinsicNode::UL);
 616   case vmIntrinsics::_indexOfU_char:            return inline_string_indexOfChar();
 617 
 618   case vmIntrinsics::_equalsL:                  return inline_string_equals(StrIntrinsicNode::LL);
 619   case vmIntrinsics::_equalsU:                  return inline_string_equals(StrIntrinsicNode::UU);
 620 
 621   case vmIntrinsics::_toBytesStringU:           return inline_string_toBytesU();
 622   case vmIntrinsics::_getCharsStringU:          return inline_string_getCharsU();
 623   case vmIntrinsics::_getCharStringU:           return inline_string_char_access(!is_store);
 624   case vmIntrinsics::_putCharStringU:           return inline_string_char_access( is_store);
 625 
 626   case vmIntrinsics::_compressStringC:
 627   case vmIntrinsics::_compressStringB:          return inline_string_copy( is_compress);
 628   case vmIntrinsics::_inflateStringC:
 629   case vmIntrinsics::_inflateStringB:           return inline_string_copy(!is_compress);
 630 
 631   case vmIntrinsics::_makePrivateBuffer:        return inline_unsafe_make_private_buffer();
 632   case vmIntrinsics::_finishPrivateBuffer:      return inline_unsafe_finish_private_buffer();
 633   case vmIntrinsics::_getReference:             return inline_unsafe_access(!is_store, T_OBJECT,   Relaxed, false);
 634   case vmIntrinsics::_getBoolean:               return inline_unsafe_access(!is_store, T_BOOLEAN,  Relaxed, false);
 635   case vmIntrinsics::_getByte:                  return inline_unsafe_access(!is_store, T_BYTE,     Relaxed, false);
 636   case vmIntrinsics::_getShort:                 return inline_unsafe_access(!is_store, T_SHORT,    Relaxed, false);
 637   case vmIntrinsics::_getChar:                  return inline_unsafe_access(!is_store, T_CHAR,     Relaxed, false);
 638   case vmIntrinsics::_getInt:                   return inline_unsafe_access(!is_store, T_INT,      Relaxed, false);
 639   case vmIntrinsics::_getLong:                  return inline_unsafe_access(!is_store, T_LONG,     Relaxed, false);
 640   case vmIntrinsics::_getFloat:                 return inline_unsafe_access(!is_store, T_FLOAT,    Relaxed, false);
 641   case vmIntrinsics::_getDouble:                return inline_unsafe_access(!is_store, T_DOUBLE,   Relaxed, false);
 642   case vmIntrinsics::_getValue:                 return inline_unsafe_access(!is_store, T_VALUETYPE,Relaxed, false);
 643 
 644   case vmIntrinsics::_putReference:             return inline_unsafe_access( is_store, T_OBJECT,   Relaxed, false);
 645   case vmIntrinsics::_putBoolean:               return inline_unsafe_access( is_store, T_BOOLEAN,  Relaxed, false);
 646   case vmIntrinsics::_putByte:                  return inline_unsafe_access( is_store, T_BYTE,     Relaxed, false);
 647   case vmIntrinsics::_putShort:                 return inline_unsafe_access( is_store, T_SHORT,    Relaxed, false);
 648   case vmIntrinsics::_putChar:                  return inline_unsafe_access( is_store, T_CHAR,     Relaxed, false);
 649   case vmIntrinsics::_putInt:                   return inline_unsafe_access( is_store, T_INT,      Relaxed, false);
 650   case vmIntrinsics::_putLong:                  return inline_unsafe_access( is_store, T_LONG,     Relaxed, false);
 651   case vmIntrinsics::_putFloat:                 return inline_unsafe_access( is_store, T_FLOAT,    Relaxed, false);
 652   case vmIntrinsics::_putDouble:                return inline_unsafe_access( is_store, T_DOUBLE,   Relaxed, false);
 653   case vmIntrinsics::_putValue:                 return inline_unsafe_access( is_store, T_VALUETYPE,Relaxed, false);
 654 
 655   case vmIntrinsics::_getReferenceVolatile:     return inline_unsafe_access(!is_store, T_OBJECT,   Volatile, false);
 656   case vmIntrinsics::_getBooleanVolatile:       return inline_unsafe_access(!is_store, T_BOOLEAN,  Volatile, false);
 657   case vmIntrinsics::_getByteVolatile:          return inline_unsafe_access(!is_store, T_BYTE,     Volatile, false);
 658   case vmIntrinsics::_getShortVolatile:         return inline_unsafe_access(!is_store, T_SHORT,    Volatile, false);
 659   case vmIntrinsics::_getCharVolatile:          return inline_unsafe_access(!is_store, T_CHAR,     Volatile, false);
 660   case vmIntrinsics::_getIntVolatile:           return inline_unsafe_access(!is_store, T_INT,      Volatile, false);
 661   case vmIntrinsics::_getLongVolatile:          return inline_unsafe_access(!is_store, T_LONG,     Volatile, false);
 662   case vmIntrinsics::_getFloatVolatile:         return inline_unsafe_access(!is_store, T_FLOAT,    Volatile, false);
 663   case vmIntrinsics::_getDoubleVolatile:        return inline_unsafe_access(!is_store, T_DOUBLE,   Volatile, false);
 664 
 665   case vmIntrinsics::_putReferenceVolatile:     return inline_unsafe_access( is_store, T_OBJECT,   Volatile, false);
 666   case vmIntrinsics::_putBooleanVolatile:       return inline_unsafe_access( is_store, T_BOOLEAN,  Volatile, false);
 667   case vmIntrinsics::_putByteVolatile:          return inline_unsafe_access( is_store, T_BYTE,     Volatile, false);
 668   case vmIntrinsics::_putShortVolatile:         return inline_unsafe_access( is_store, T_SHORT,    Volatile, false);
 669   case vmIntrinsics::_putCharVolatile:          return inline_unsafe_access( is_store, T_CHAR,     Volatile, false);
 670   case vmIntrinsics::_putIntVolatile:           return inline_unsafe_access( is_store, T_INT,      Volatile, false);
 671   case vmIntrinsics::_putLongVolatile:          return inline_unsafe_access( is_store, T_LONG,     Volatile, false);
 672   case vmIntrinsics::_putFloatVolatile:         return inline_unsafe_access( is_store, T_FLOAT,    Volatile, false);
 673   case vmIntrinsics::_putDoubleVolatile:        return inline_unsafe_access( is_store, T_DOUBLE,   Volatile, false);
 674 
 675   case vmIntrinsics::_getShortUnaligned:        return inline_unsafe_access(!is_store, T_SHORT,    Relaxed, true);
 676   case vmIntrinsics::_getCharUnaligned:         return inline_unsafe_access(!is_store, T_CHAR,     Relaxed, true);
 677   case vmIntrinsics::_getIntUnaligned:          return inline_unsafe_access(!is_store, T_INT,      Relaxed, true);
 678   case vmIntrinsics::_getLongUnaligned:         return inline_unsafe_access(!is_store, T_LONG,     Relaxed, true);
 679 
 680   case vmIntrinsics::_putShortUnaligned:        return inline_unsafe_access( is_store, T_SHORT,    Relaxed, true);
 681   case vmIntrinsics::_putCharUnaligned:         return inline_unsafe_access( is_store, T_CHAR,     Relaxed, true);
 682   case vmIntrinsics::_putIntUnaligned:          return inline_unsafe_access( is_store, T_INT,      Relaxed, true);
 683   case vmIntrinsics::_putLongUnaligned:         return inline_unsafe_access( is_store, T_LONG,     Relaxed, true);
 684 
 685   case vmIntrinsics::_getReferenceAcquire:      return inline_unsafe_access(!is_store, T_OBJECT,   Acquire, false);
 686   case vmIntrinsics::_getBooleanAcquire:        return inline_unsafe_access(!is_store, T_BOOLEAN,  Acquire, false);
 687   case vmIntrinsics::_getByteAcquire:           return inline_unsafe_access(!is_store, T_BYTE,     Acquire, false);
 688   case vmIntrinsics::_getShortAcquire:          return inline_unsafe_access(!is_store, T_SHORT,    Acquire, false);
 689   case vmIntrinsics::_getCharAcquire:           return inline_unsafe_access(!is_store, T_CHAR,     Acquire, false);
 690   case vmIntrinsics::_getIntAcquire:            return inline_unsafe_access(!is_store, T_INT,      Acquire, false);
 691   case vmIntrinsics::_getLongAcquire:           return inline_unsafe_access(!is_store, T_LONG,     Acquire, false);
 692   case vmIntrinsics::_getFloatAcquire:          return inline_unsafe_access(!is_store, T_FLOAT,    Acquire, false);
 693   case vmIntrinsics::_getDoubleAcquire:         return inline_unsafe_access(!is_store, T_DOUBLE,   Acquire, false);
 694 
 695   case vmIntrinsics::_putReferenceRelease:      return inline_unsafe_access( is_store, T_OBJECT,   Release, false);
 696   case vmIntrinsics::_putBooleanRelease:        return inline_unsafe_access( is_store, T_BOOLEAN,  Release, false);
 697   case vmIntrinsics::_putByteRelease:           return inline_unsafe_access( is_store, T_BYTE,     Release, false);
 698   case vmIntrinsics::_putShortRelease:          return inline_unsafe_access( is_store, T_SHORT,    Release, false);
 699   case vmIntrinsics::_putCharRelease:           return inline_unsafe_access( is_store, T_CHAR,     Release, false);
 700   case vmIntrinsics::_putIntRelease:            return inline_unsafe_access( is_store, T_INT,      Release, false);
 701   case vmIntrinsics::_putLongRelease:           return inline_unsafe_access( is_store, T_LONG,     Release, false);
 702   case vmIntrinsics::_putFloatRelease:          return inline_unsafe_access( is_store, T_FLOAT,    Release, false);
 703   case vmIntrinsics::_putDoubleRelease:         return inline_unsafe_access( is_store, T_DOUBLE,   Release, false);
 704 
 705   case vmIntrinsics::_getReferenceOpaque:       return inline_unsafe_access(!is_store, T_OBJECT,   Opaque, false);
 706   case vmIntrinsics::_getBooleanOpaque:         return inline_unsafe_access(!is_store, T_BOOLEAN,  Opaque, false);
 707   case vmIntrinsics::_getByteOpaque:            return inline_unsafe_access(!is_store, T_BYTE,     Opaque, false);
 708   case vmIntrinsics::_getShortOpaque:           return inline_unsafe_access(!is_store, T_SHORT,    Opaque, false);
 709   case vmIntrinsics::_getCharOpaque:            return inline_unsafe_access(!is_store, T_CHAR,     Opaque, false);
 710   case vmIntrinsics::_getIntOpaque:             return inline_unsafe_access(!is_store, T_INT,      Opaque, false);
 711   case vmIntrinsics::_getLongOpaque:            return inline_unsafe_access(!is_store, T_LONG,     Opaque, false);
 712   case vmIntrinsics::_getFloatOpaque:           return inline_unsafe_access(!is_store, T_FLOAT,    Opaque, false);
 713   case vmIntrinsics::_getDoubleOpaque:          return inline_unsafe_access(!is_store, T_DOUBLE,   Opaque, false);
 714 
 715   case vmIntrinsics::_putReferenceOpaque:       return inline_unsafe_access( is_store, T_OBJECT,   Opaque, false);
 716   case vmIntrinsics::_putBooleanOpaque:         return inline_unsafe_access( is_store, T_BOOLEAN,  Opaque, false);
 717   case vmIntrinsics::_putByteOpaque:            return inline_unsafe_access( is_store, T_BYTE,     Opaque, false);
 718   case vmIntrinsics::_putShortOpaque:           return inline_unsafe_access( is_store, T_SHORT,    Opaque, false);
 719   case vmIntrinsics::_putCharOpaque:            return inline_unsafe_access( is_store, T_CHAR,     Opaque, false);
 720   case vmIntrinsics::_putIntOpaque:             return inline_unsafe_access( is_store, T_INT,      Opaque, false);
 721   case vmIntrinsics::_putLongOpaque:            return inline_unsafe_access( is_store, T_LONG,     Opaque, false);
 722   case vmIntrinsics::_putFloatOpaque:           return inline_unsafe_access( is_store, T_FLOAT,    Opaque, false);
 723   case vmIntrinsics::_putDoubleOpaque:          return inline_unsafe_access( is_store, T_DOUBLE,   Opaque, false);
 724 
 725   case vmIntrinsics::_compareAndSetReference:   return inline_unsafe_load_store(T_OBJECT, LS_cmp_swap,      Volatile);
 726   case vmIntrinsics::_compareAndSetByte:        return inline_unsafe_load_store(T_BYTE,   LS_cmp_swap,      Volatile);
 727   case vmIntrinsics::_compareAndSetShort:       return inline_unsafe_load_store(T_SHORT,  LS_cmp_swap,      Volatile);
 728   case vmIntrinsics::_compareAndSetInt:         return inline_unsafe_load_store(T_INT,    LS_cmp_swap,      Volatile);
 729   case vmIntrinsics::_compareAndSetLong:        return inline_unsafe_load_store(T_LONG,   LS_cmp_swap,      Volatile);
 730 
 731   case vmIntrinsics::_weakCompareAndSetReferencePlain:     return inline_unsafe_load_store(T_OBJECT, LS_cmp_swap_weak, Relaxed);
 732   case vmIntrinsics::_weakCompareAndSetReferenceAcquire:   return inline_unsafe_load_store(T_OBJECT, LS_cmp_swap_weak, Acquire);
 733   case vmIntrinsics::_weakCompareAndSetReferenceRelease:   return inline_unsafe_load_store(T_OBJECT, LS_cmp_swap_weak, Release);
 734   case vmIntrinsics::_weakCompareAndSetReference:          return inline_unsafe_load_store(T_OBJECT, LS_cmp_swap_weak, Volatile);
 735   case vmIntrinsics::_weakCompareAndSetBytePlain:          return inline_unsafe_load_store(T_BYTE,   LS_cmp_swap_weak, Relaxed);
 736   case vmIntrinsics::_weakCompareAndSetByteAcquire:        return inline_unsafe_load_store(T_BYTE,   LS_cmp_swap_weak, Acquire);
 737   case vmIntrinsics::_weakCompareAndSetByteRelease:        return inline_unsafe_load_store(T_BYTE,   LS_cmp_swap_weak, Release);
 738   case vmIntrinsics::_weakCompareAndSetByte:               return inline_unsafe_load_store(T_BYTE,   LS_cmp_swap_weak, Volatile);
 739   case vmIntrinsics::_weakCompareAndSetShortPlain:         return inline_unsafe_load_store(T_SHORT,  LS_cmp_swap_weak, Relaxed);
 740   case vmIntrinsics::_weakCompareAndSetShortAcquire:       return inline_unsafe_load_store(T_SHORT,  LS_cmp_swap_weak, Acquire);
 741   case vmIntrinsics::_weakCompareAndSetShortRelease:       return inline_unsafe_load_store(T_SHORT,  LS_cmp_swap_weak, Release);
 742   case vmIntrinsics::_weakCompareAndSetShort:              return inline_unsafe_load_store(T_SHORT,  LS_cmp_swap_weak, Volatile);
 743   case vmIntrinsics::_weakCompareAndSetIntPlain:           return inline_unsafe_load_store(T_INT,    LS_cmp_swap_weak, Relaxed);
 744   case vmIntrinsics::_weakCompareAndSetIntAcquire:         return inline_unsafe_load_store(T_INT,    LS_cmp_swap_weak, Acquire);
 745   case vmIntrinsics::_weakCompareAndSetIntRelease:         return inline_unsafe_load_store(T_INT,    LS_cmp_swap_weak, Release);
 746   case vmIntrinsics::_weakCompareAndSetInt:                return inline_unsafe_load_store(T_INT,    LS_cmp_swap_weak, Volatile);
 747   case vmIntrinsics::_weakCompareAndSetLongPlain:          return inline_unsafe_load_store(T_LONG,   LS_cmp_swap_weak, Relaxed);
 748   case vmIntrinsics::_weakCompareAndSetLongAcquire:        return inline_unsafe_load_store(T_LONG,   LS_cmp_swap_weak, Acquire);
 749   case vmIntrinsics::_weakCompareAndSetLongRelease:        return inline_unsafe_load_store(T_LONG,   LS_cmp_swap_weak, Release);
 750   case vmIntrinsics::_weakCompareAndSetLong:               return inline_unsafe_load_store(T_LONG,   LS_cmp_swap_weak, Volatile);
 751 
 752   case vmIntrinsics::_compareAndExchangeReference:         return inline_unsafe_load_store(T_OBJECT, LS_cmp_exchange,  Volatile);
 753   case vmIntrinsics::_compareAndExchangeReferenceAcquire:  return inline_unsafe_load_store(T_OBJECT, LS_cmp_exchange,  Acquire);
 754   case vmIntrinsics::_compareAndExchangeReferenceRelease:  return inline_unsafe_load_store(T_OBJECT, LS_cmp_exchange,  Release);
 755   case vmIntrinsics::_compareAndExchangeByte:              return inline_unsafe_load_store(T_BYTE,   LS_cmp_exchange,  Volatile);
 756   case vmIntrinsics::_compareAndExchangeByteAcquire:       return inline_unsafe_load_store(T_BYTE,   LS_cmp_exchange,  Acquire);
 757   case vmIntrinsics::_compareAndExchangeByteRelease:       return inline_unsafe_load_store(T_BYTE,   LS_cmp_exchange,  Release);
 758   case vmIntrinsics::_compareAndExchangeShort:             return inline_unsafe_load_store(T_SHORT,  LS_cmp_exchange,  Volatile);
 759   case vmIntrinsics::_compareAndExchangeShortAcquire:      return inline_unsafe_load_store(T_SHORT,  LS_cmp_exchange,  Acquire);
 760   case vmIntrinsics::_compareAndExchangeShortRelease:      return inline_unsafe_load_store(T_SHORT,  LS_cmp_exchange,  Release);
 761   case vmIntrinsics::_compareAndExchangeInt:               return inline_unsafe_load_store(T_INT,    LS_cmp_exchange,  Volatile);
 762   case vmIntrinsics::_compareAndExchangeIntAcquire:        return inline_unsafe_load_store(T_INT,    LS_cmp_exchange,  Acquire);
 763   case vmIntrinsics::_compareAndExchangeIntRelease:        return inline_unsafe_load_store(T_INT,    LS_cmp_exchange,  Release);
 764   case vmIntrinsics::_compareAndExchangeLong:              return inline_unsafe_load_store(T_LONG,   LS_cmp_exchange,  Volatile);
 765   case vmIntrinsics::_compareAndExchangeLongAcquire:       return inline_unsafe_load_store(T_LONG,   LS_cmp_exchange,  Acquire);
 766   case vmIntrinsics::_compareAndExchangeLongRelease:       return inline_unsafe_load_store(T_LONG,   LS_cmp_exchange,  Release);
 767 
 768   case vmIntrinsics::_getAndAddByte:                    return inline_unsafe_load_store(T_BYTE,   LS_get_add,       Volatile);
 769   case vmIntrinsics::_getAndAddShort:                   return inline_unsafe_load_store(T_SHORT,  LS_get_add,       Volatile);
 770   case vmIntrinsics::_getAndAddInt:                     return inline_unsafe_load_store(T_INT,    LS_get_add,       Volatile);
 771   case vmIntrinsics::_getAndAddLong:                    return inline_unsafe_load_store(T_LONG,   LS_get_add,       Volatile);
 772 
 773   case vmIntrinsics::_getAndSetByte:                    return inline_unsafe_load_store(T_BYTE,   LS_get_set,       Volatile);
 774   case vmIntrinsics::_getAndSetShort:                   return inline_unsafe_load_store(T_SHORT,  LS_get_set,       Volatile);
 775   case vmIntrinsics::_getAndSetInt:                     return inline_unsafe_load_store(T_INT,    LS_get_set,       Volatile);
 776   case vmIntrinsics::_getAndSetLong:                    return inline_unsafe_load_store(T_LONG,   LS_get_set,       Volatile);
 777   case vmIntrinsics::_getAndSetReference:               return inline_unsafe_load_store(T_OBJECT, LS_get_set,       Volatile);
 778 
 779   case vmIntrinsics::_loadFence:
 780   case vmIntrinsics::_storeFence:
 781   case vmIntrinsics::_fullFence:                return inline_unsafe_fence(intrinsic_id());
 782 
 783   case vmIntrinsics::_onSpinWait:               return inline_onspinwait();
 784 
 785   case vmIntrinsics::_currentThread:            return inline_native_currentThread();
 786 
 787 #ifdef JFR_HAVE_INTRINSICS
 788   case vmIntrinsics::_counterTime:              return inline_native_time_funcs(CAST_FROM_FN_PTR(address, JFR_TIME_FUNCTION), &quot;counterTime&quot;);
 789   case vmIntrinsics::_getClassId:               return inline_native_classID();
 790   case vmIntrinsics::_getEventWriter:           return inline_native_getEventWriter();
 791 #endif
 792   case vmIntrinsics::_currentTimeMillis:        return inline_native_time_funcs(CAST_FROM_FN_PTR(address, os::javaTimeMillis), &quot;currentTimeMillis&quot;);
 793   case vmIntrinsics::_nanoTime:                 return inline_native_time_funcs(CAST_FROM_FN_PTR(address, os::javaTimeNanos), &quot;nanoTime&quot;);
 794   case vmIntrinsics::_writeback0:               return inline_unsafe_writeback0();
 795   case vmIntrinsics::_writebackPreSync0:        return inline_unsafe_writebackSync0(true);
 796   case vmIntrinsics::_writebackPostSync0:       return inline_unsafe_writebackSync0(false);
 797   case vmIntrinsics::_allocateInstance:         return inline_unsafe_allocate();
 798   case vmIntrinsics::_copyMemory:               return inline_unsafe_copyMemory();
 799   case vmIntrinsics::_getLength:                return inline_native_getLength();
 800   case vmIntrinsics::_copyOf:                   return inline_array_copyOf(false);
 801   case vmIntrinsics::_copyOfRange:              return inline_array_copyOf(true);
 802   case vmIntrinsics::_equalsB:                  return inline_array_equals(StrIntrinsicNode::LL);
 803   case vmIntrinsics::_equalsC:                  return inline_array_equals(StrIntrinsicNode::UU);
 804   case vmIntrinsics::_Preconditions_checkIndex: return inline_preconditions_checkIndex();
 805   case vmIntrinsics::_clone:                    return inline_native_clone(intrinsic()-&gt;is_virtual());
 806 
 807   case vmIntrinsics::_allocateUninitializedArray: return inline_unsafe_newArray(true);
 808   case vmIntrinsics::_newArray:                   return inline_unsafe_newArray(false);
 809 
 810   case vmIntrinsics::_isAssignableFrom:         return inline_native_subtype_check();
 811 
 812   case vmIntrinsics::_isInstance:
 813   case vmIntrinsics::_getModifiers:
 814   case vmIntrinsics::_isInterface:
 815   case vmIntrinsics::_isArray:
 816   case vmIntrinsics::_isPrimitive:
 817   case vmIntrinsics::_getSuperclass:
 818   case vmIntrinsics::_getClassAccessFlags:      return inline_native_Class_query(intrinsic_id());
 819 
 820   case vmIntrinsics::_floatToRawIntBits:
 821   case vmIntrinsics::_floatToIntBits:
 822   case vmIntrinsics::_intBitsToFloat:
 823   case vmIntrinsics::_doubleToRawLongBits:
 824   case vmIntrinsics::_doubleToLongBits:
 825   case vmIntrinsics::_longBitsToDouble:         return inline_fp_conversions(intrinsic_id());
 826 
 827   case vmIntrinsics::_numberOfLeadingZeros_i:
 828   case vmIntrinsics::_numberOfLeadingZeros_l:
 829   case vmIntrinsics::_numberOfTrailingZeros_i:
 830   case vmIntrinsics::_numberOfTrailingZeros_l:
 831   case vmIntrinsics::_bitCount_i:
 832   case vmIntrinsics::_bitCount_l:
 833   case vmIntrinsics::_reverseBytes_i:
 834   case vmIntrinsics::_reverseBytes_l:
 835   case vmIntrinsics::_reverseBytes_s:
 836   case vmIntrinsics::_reverseBytes_c:           return inline_number_methods(intrinsic_id());
 837 
 838   case vmIntrinsics::_getCallerClass:           return inline_native_Reflection_getCallerClass();
 839 
 840   case vmIntrinsics::_Reference_get:            return inline_reference_get();
 841 
 842   case vmIntrinsics::_Class_cast:               return inline_Class_cast();
 843 
 844   case vmIntrinsics::_aescrypt_encryptBlock:
 845   case vmIntrinsics::_aescrypt_decryptBlock:    return inline_aescrypt_Block(intrinsic_id());
 846 
 847   case vmIntrinsics::_cipherBlockChaining_encryptAESCrypt:
 848   case vmIntrinsics::_cipherBlockChaining_decryptAESCrypt:
 849     return inline_cipherBlockChaining_AESCrypt(intrinsic_id());
 850 
 851   case vmIntrinsics::_electronicCodeBook_encryptAESCrypt:
 852   case vmIntrinsics::_electronicCodeBook_decryptAESCrypt:
 853     return inline_electronicCodeBook_AESCrypt(intrinsic_id());
 854 
 855   case vmIntrinsics::_counterMode_AESCrypt:
 856     return inline_counterMode_AESCrypt(intrinsic_id());
 857 
 858   case vmIntrinsics::_sha_implCompress:
 859   case vmIntrinsics::_sha2_implCompress:
 860   case vmIntrinsics::_sha5_implCompress:
 861     return inline_sha_implCompress(intrinsic_id());
 862 
 863   case vmIntrinsics::_digestBase_implCompressMB:
 864     return inline_digestBase_implCompressMB(predicate);
 865 
 866   case vmIntrinsics::_multiplyToLen:
 867     return inline_multiplyToLen();
 868 
 869   case vmIntrinsics::_squareToLen:
 870     return inline_squareToLen();
 871 
 872   case vmIntrinsics::_mulAdd:
 873     return inline_mulAdd();
 874 
 875   case vmIntrinsics::_montgomeryMultiply:
 876     return inline_montgomeryMultiply();
 877   case vmIntrinsics::_montgomerySquare:
 878     return inline_montgomerySquare();
 879 
 880   case vmIntrinsics::_bigIntegerRightShiftWorker:
 881     return inline_bigIntegerShift(true);
 882   case vmIntrinsics::_bigIntegerLeftShiftWorker:
 883     return inline_bigIntegerShift(false);
 884 
 885   case vmIntrinsics::_vectorizedMismatch:
 886     return inline_vectorizedMismatch();
 887 
 888   case vmIntrinsics::_ghash_processBlocks:
 889     return inline_ghash_processBlocks();
 890   case vmIntrinsics::_base64_encodeBlock:
 891     return inline_base64_encodeBlock();
 892 
 893   case vmIntrinsics::_encodeISOArray:
 894   case vmIntrinsics::_encodeByteISOArray:
 895     return inline_encodeISOArray();
 896 
 897   case vmIntrinsics::_updateCRC32:
 898     return inline_updateCRC32();
 899   case vmIntrinsics::_updateBytesCRC32:
 900     return inline_updateBytesCRC32();
 901   case vmIntrinsics::_updateByteBufferCRC32:
 902     return inline_updateByteBufferCRC32();
 903 
 904   case vmIntrinsics::_updateBytesCRC32C:
 905     return inline_updateBytesCRC32C();
 906   case vmIntrinsics::_updateDirectByteBufferCRC32C:
 907     return inline_updateDirectByteBufferCRC32C();
 908 
 909   case vmIntrinsics::_updateBytesAdler32:
 910     return inline_updateBytesAdler32();
 911   case vmIntrinsics::_updateByteBufferAdler32:
 912     return inline_updateByteBufferAdler32();
 913 
 914   case vmIntrinsics::_profileBoolean:
 915     return inline_profileBoolean();
 916   case vmIntrinsics::_isCompileConstant:
 917     return inline_isCompileConstant();
 918 
 919   case vmIntrinsics::_hasNegatives:
 920     return inline_hasNegatives();
 921 
 922   case vmIntrinsics::_fmaD:
 923   case vmIntrinsics::_fmaF:
 924     return inline_fma(intrinsic_id());
 925 
 926   case vmIntrinsics::_isDigit:
 927   case vmIntrinsics::_isLowerCase:
 928   case vmIntrinsics::_isUpperCase:
 929   case vmIntrinsics::_isWhitespace:
 930     return inline_character_compare(intrinsic_id());
 931 
 932   case vmIntrinsics::_maxF:
 933   case vmIntrinsics::_minF:
 934   case vmIntrinsics::_maxD:
 935   case vmIntrinsics::_minD:
 936     return inline_fp_min_max(intrinsic_id());
 937 
 938   default:
 939     // If you get here, it may be that someone has added a new intrinsic
 940     // to the list in vmSymbols.hpp without implementing it here.
 941 #ifndef PRODUCT
 942     if ((PrintMiscellaneous &amp;&amp; (Verbose || WizardMode)) || PrintOpto) {
 943       tty-&gt;print_cr(&quot;*** Warning: Unimplemented intrinsic %s(%d)&quot;,
 944                     vmIntrinsics::name_at(intrinsic_id()), intrinsic_id());
 945     }
 946 #endif
 947     return false;
 948   }
 949 }
 950 
 951 Node* LibraryCallKit::try_to_predicate(int predicate) {
 952   if (!jvms()-&gt;has_method()) {
 953     // Root JVMState has a null method.
 954     assert(map()-&gt;memory()-&gt;Opcode() == Op_Parm, &quot;&quot;);
 955     // Insert the memory aliasing node
 956     set_all_memory(reset_memory());
 957   }
 958   assert(merged_memory(), &quot;&quot;);
 959 
 960   switch (intrinsic_id()) {
 961   case vmIntrinsics::_cipherBlockChaining_encryptAESCrypt:
 962     return inline_cipherBlockChaining_AESCrypt_predicate(false);
 963   case vmIntrinsics::_cipherBlockChaining_decryptAESCrypt:
 964     return inline_cipherBlockChaining_AESCrypt_predicate(true);
 965   case vmIntrinsics::_electronicCodeBook_encryptAESCrypt:
 966     return inline_electronicCodeBook_AESCrypt_predicate(false);
 967   case vmIntrinsics::_electronicCodeBook_decryptAESCrypt:
 968     return inline_electronicCodeBook_AESCrypt_predicate(true);
 969   case vmIntrinsics::_counterMode_AESCrypt:
 970     return inline_counterMode_AESCrypt_predicate();
 971   case vmIntrinsics::_digestBase_implCompressMB:
 972     return inline_digestBase_implCompressMB_predicate(predicate);
 973 
 974   default:
 975     // If you get here, it may be that someone has added a new intrinsic
 976     // to the list in vmSymbols.hpp without implementing it here.
 977 #ifndef PRODUCT
 978     if ((PrintMiscellaneous &amp;&amp; (Verbose || WizardMode)) || PrintOpto) {
 979       tty-&gt;print_cr(&quot;*** Warning: Unimplemented predicate for intrinsic %s(%d)&quot;,
 980                     vmIntrinsics::name_at(intrinsic_id()), intrinsic_id());
 981     }
 982 #endif
 983     Node* slow_ctl = control();
 984     set_control(top()); // No fast path instrinsic
 985     return slow_ctl;
 986   }
 987 }
 988 
 989 //------------------------------set_result-------------------------------
 990 // Helper function for finishing intrinsics.
 991 void LibraryCallKit::set_result(RegionNode* region, PhiNode* value) {
 992   record_for_igvn(region);
 993   set_control(_gvn.transform(region));
 994   set_result( _gvn.transform(value));
 995   assert(value-&gt;type()-&gt;basic_type() == result()-&gt;bottom_type()-&gt;basic_type(), &quot;sanity&quot;);
 996 }
 997 
 998 //------------------------------generate_guard---------------------------
 999 // Helper function for generating guarded fast-slow graph structures.
1000 // The given &#39;test&#39;, if true, guards a slow path.  If the test fails
1001 // then a fast path can be taken.  (We generally hope it fails.)
1002 // In all cases, GraphKit::control() is updated to the fast path.
1003 // The returned value represents the control for the slow path.
1004 // The return value is never &#39;top&#39;; it is either a valid control
1005 // or NULL if it is obvious that the slow path can never be taken.
1006 // Also, if region and the slow control are not NULL, the slow edge
1007 // is appended to the region.
1008 Node* LibraryCallKit::generate_guard(Node* test, RegionNode* region, float true_prob) {
1009   if (stopped()) {
1010     // Already short circuited.
1011     return NULL;
1012   }
1013 
1014   // Build an if node and its projections.
1015   // If test is true we take the slow path, which we assume is uncommon.
1016   if (_gvn.type(test) == TypeInt::ZERO) {
1017     // The slow branch is never taken.  No need to build this guard.
1018     return NULL;
1019   }
1020 
1021   IfNode* iff = create_and_map_if(control(), test, true_prob, COUNT_UNKNOWN);
1022 
1023   Node* if_slow = _gvn.transform(new IfTrueNode(iff));
1024   if (if_slow == top()) {
1025     // The slow branch is never taken.  No need to build this guard.
1026     return NULL;
1027   }
1028 
1029   if (region != NULL)
1030     region-&gt;add_req(if_slow);
1031 
1032   Node* if_fast = _gvn.transform(new IfFalseNode(iff));
1033   set_control(if_fast);
1034 
1035   return if_slow;
1036 }
1037 
1038 inline Node* LibraryCallKit::generate_slow_guard(Node* test, RegionNode* region) {
1039   return generate_guard(test, region, PROB_UNLIKELY_MAG(3));
1040 }
1041 inline Node* LibraryCallKit::generate_fair_guard(Node* test, RegionNode* region) {
1042   return generate_guard(test, region, PROB_FAIR);
1043 }
1044 
1045 inline Node* LibraryCallKit::generate_negative_guard(Node* index, RegionNode* region,
1046                                                      Node* *pos_index) {
1047   if (stopped())
1048     return NULL;                // already stopped
1049   if (_gvn.type(index)-&gt;higher_equal(TypeInt::POS)) // [0,maxint]
1050     return NULL;                // index is already adequately typed
1051   Node* cmp_lt = _gvn.transform(new CmpINode(index, intcon(0)));
1052   Node* bol_lt = _gvn.transform(new BoolNode(cmp_lt, BoolTest::lt));
1053   Node* is_neg = generate_guard(bol_lt, region, PROB_MIN);
1054   if (is_neg != NULL &amp;&amp; pos_index != NULL) {
1055     // Emulate effect of Parse::adjust_map_after_if.
1056     Node* ccast = new CastIINode(index, TypeInt::POS);
1057     ccast-&gt;set_req(0, control());
1058     (*pos_index) = _gvn.transform(ccast);
1059   }
1060   return is_neg;
1061 }
1062 
1063 // Make sure that &#39;position&#39; is a valid limit index, in [0..length].
1064 // There are two equivalent plans for checking this:
1065 //   A. (offset + copyLength)  unsigned&lt;=  arrayLength
1066 //   B. offset  &lt;=  (arrayLength - copyLength)
1067 // We require that all of the values above, except for the sum and
1068 // difference, are already known to be non-negative.
1069 // Plan A is robust in the face of overflow, if offset and copyLength
1070 // are both hugely positive.
1071 //
1072 // Plan B is less direct and intuitive, but it does not overflow at
1073 // all, since the difference of two non-negatives is always
1074 // representable.  Whenever Java methods must perform the equivalent
1075 // check they generally use Plan B instead of Plan A.
1076 // For the moment we use Plan A.
1077 inline Node* LibraryCallKit::generate_limit_guard(Node* offset,
1078                                                   Node* subseq_length,
1079                                                   Node* array_length,
1080                                                   RegionNode* region) {
1081   if (stopped())
1082     return NULL;                // already stopped
1083   bool zero_offset = _gvn.type(offset) == TypeInt::ZERO;
1084   if (zero_offset &amp;&amp; subseq_length-&gt;eqv_uncast(array_length))
1085     return NULL;                // common case of whole-array copy
1086   Node* last = subseq_length;
1087   if (!zero_offset)             // last += offset
1088     last = _gvn.transform(new AddINode(last, offset));
1089   Node* cmp_lt = _gvn.transform(new CmpUNode(array_length, last));
1090   Node* bol_lt = _gvn.transform(new BoolNode(cmp_lt, BoolTest::lt));
1091   Node* is_over = generate_guard(bol_lt, region, PROB_MIN);
1092   return is_over;
1093 }
1094 
1095 // Emit range checks for the given String.value byte array
1096 void LibraryCallKit::generate_string_range_check(Node* array, Node* offset, Node* count, bool char_count) {
1097   if (stopped()) {
1098     return; // already stopped
1099   }
1100   RegionNode* bailout = new RegionNode(1);
1101   record_for_igvn(bailout);
1102   if (char_count) {
1103     // Convert char count to byte count
1104     count = _gvn.transform(new LShiftINode(count, intcon(1)));
1105   }
1106 
1107   // Offset and count must not be negative
1108   generate_negative_guard(offset, bailout);
1109   generate_negative_guard(count, bailout);
1110   // Offset + count must not exceed length of array
1111   generate_limit_guard(offset, count, load_array_length(array), bailout);
1112 
1113   if (bailout-&gt;req() &gt; 1) {
1114     PreserveJVMState pjvms(this);
1115     set_control(_gvn.transform(bailout));
1116     uncommon_trap(Deoptimization::Reason_intrinsic,
1117                   Deoptimization::Action_maybe_recompile);
1118   }
1119 }
1120 
1121 //--------------------------generate_current_thread--------------------
1122 Node* LibraryCallKit::generate_current_thread(Node* &amp;tls_output) {
1123   ciKlass*    thread_klass = env()-&gt;Thread_klass();
1124   const Type* thread_type  = TypeOopPtr::make_from_klass(thread_klass)-&gt;cast_to_ptr_type(TypePtr::NotNull);
1125   Node* thread = _gvn.transform(new ThreadLocalNode());
1126   Node* p = basic_plus_adr(top()/*!oop*/, thread, in_bytes(JavaThread::threadObj_offset()));
1127   Node* threadObj = _gvn.transform(LoadNode::make(_gvn, NULL, immutable_memory(), p, p-&gt;bottom_type()-&gt;is_ptr(), thread_type, T_OBJECT, MemNode::unordered));
1128   tls_output = thread;
1129   return threadObj;
1130 }
1131 
1132 
1133 //------------------------------make_string_method_node------------------------
1134 // Helper method for String intrinsic functions. This version is called with
1135 // str1 and str2 pointing to byte[] nodes containing Latin1 or UTF16 encoded
1136 // characters (depending on &#39;is_byte&#39;). cnt1 and cnt2 are pointing to Int nodes
1137 // containing the lengths of str1 and str2.
1138 Node* LibraryCallKit::make_string_method_node(int opcode, Node* str1_start, Node* cnt1, Node* str2_start, Node* cnt2, StrIntrinsicNode::ArgEnc ae) {
1139   Node* result = NULL;
1140   switch (opcode) {
1141   case Op_StrIndexOf:
1142     result = new StrIndexOfNode(control(), memory(TypeAryPtr::BYTES),
1143                                 str1_start, cnt1, str2_start, cnt2, ae);
1144     break;
1145   case Op_StrComp:
1146     result = new StrCompNode(control(), memory(TypeAryPtr::BYTES),
1147                              str1_start, cnt1, str2_start, cnt2, ae);
1148     break;
1149   case Op_StrEquals:
1150     // We already know that cnt1 == cnt2 here (checked in &#39;inline_string_equals&#39;).
1151     // Use the constant length if there is one because optimized match rule may exist.
1152     result = new StrEqualsNode(control(), memory(TypeAryPtr::BYTES),
1153                                str1_start, str2_start, cnt2-&gt;is_Con() ? cnt2 : cnt1, ae);
1154     break;
1155   default:
1156     ShouldNotReachHere();
1157     return NULL;
1158   }
1159 
1160   // All these intrinsics have checks.
1161   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
1162   clear_upper_avx();
1163 
1164   return _gvn.transform(result);
1165 }
1166 
1167 //------------------------------inline_string_compareTo------------------------
1168 bool LibraryCallKit::inline_string_compareTo(StrIntrinsicNode::ArgEnc ae) {
1169   Node* arg1 = argument(0);
1170   Node* arg2 = argument(1);
1171 
1172   arg1 = must_be_not_null(arg1, true);
1173   arg2 = must_be_not_null(arg2, true);
1174 
1175   // Get start addr and length of first argument
1176   Node* arg1_start  = array_element_address(arg1, intcon(0), T_BYTE);
1177   Node* arg1_cnt    = load_array_length(arg1);
1178 
1179   // Get start addr and length of second argument
1180   Node* arg2_start  = array_element_address(arg2, intcon(0), T_BYTE);
1181   Node* arg2_cnt    = load_array_length(arg2);
1182 
1183   Node* result = make_string_method_node(Op_StrComp, arg1_start, arg1_cnt, arg2_start, arg2_cnt, ae);
1184   set_result(result);
1185   return true;
1186 }
1187 
1188 //------------------------------inline_string_equals------------------------
1189 bool LibraryCallKit::inline_string_equals(StrIntrinsicNode::ArgEnc ae) {
1190   Node* arg1 = argument(0);
1191   Node* arg2 = argument(1);
1192 
1193   // paths (plus control) merge
1194   RegionNode* region = new RegionNode(3);
1195   Node* phi = new PhiNode(region, TypeInt::BOOL);
1196 
1197   if (!stopped()) {
1198 
1199     arg1 = must_be_not_null(arg1, true);
1200     arg2 = must_be_not_null(arg2, true);
1201 
1202     // Get start addr and length of first argument
1203     Node* arg1_start  = array_element_address(arg1, intcon(0), T_BYTE);
1204     Node* arg1_cnt    = load_array_length(arg1);
1205 
1206     // Get start addr and length of second argument
1207     Node* arg2_start  = array_element_address(arg2, intcon(0), T_BYTE);
1208     Node* arg2_cnt    = load_array_length(arg2);
1209 
1210     // Check for arg1_cnt != arg2_cnt
1211     Node* cmp = _gvn.transform(new CmpINode(arg1_cnt, arg2_cnt));
1212     Node* bol = _gvn.transform(new BoolNode(cmp, BoolTest::ne));
1213     Node* if_ne = generate_slow_guard(bol, NULL);
1214     if (if_ne != NULL) {
1215       phi-&gt;init_req(2, intcon(0));
1216       region-&gt;init_req(2, if_ne);
1217     }
1218 
1219     // Check for count == 0 is done by assembler code for StrEquals.
1220 
1221     if (!stopped()) {
1222       Node* equals = make_string_method_node(Op_StrEquals, arg1_start, arg1_cnt, arg2_start, arg2_cnt, ae);
1223       phi-&gt;init_req(1, equals);
1224       region-&gt;init_req(1, control());
1225     }
1226   }
1227 
1228   // post merge
1229   set_control(_gvn.transform(region));
1230   record_for_igvn(region);
1231 
1232   set_result(_gvn.transform(phi));
1233   return true;
1234 }
1235 
1236 //------------------------------inline_array_equals----------------------------
1237 bool LibraryCallKit::inline_array_equals(StrIntrinsicNode::ArgEnc ae) {
1238   assert(ae == StrIntrinsicNode::UU || ae == StrIntrinsicNode::LL, &quot;unsupported array types&quot;);
1239   Node* arg1 = argument(0);
1240   Node* arg2 = argument(1);
1241 
1242   const TypeAryPtr* mtype = (ae == StrIntrinsicNode::UU) ? TypeAryPtr::CHARS : TypeAryPtr::BYTES;
1243   set_result(_gvn.transform(new AryEqNode(control(), memory(mtype), arg1, arg2, ae)));
1244   clear_upper_avx();
1245 
1246   return true;
1247 }
1248 
1249 //------------------------------inline_hasNegatives------------------------------
1250 bool LibraryCallKit::inline_hasNegatives() {
1251   if (too_many_traps(Deoptimization::Reason_intrinsic)) {
1252     return false;
1253   }
1254 
1255   assert(callee()-&gt;signature()-&gt;size() == 3, &quot;hasNegatives has 3 parameters&quot;);
1256   // no receiver since it is static method
1257   Node* ba         = argument(0);
1258   Node* offset     = argument(1);
1259   Node* len        = argument(2);
1260 
1261   ba = must_be_not_null(ba, true);
1262 
1263   // Range checks
1264   generate_string_range_check(ba, offset, len, false);
1265   if (stopped()) {
1266     return true;
1267   }
1268   Node* ba_start = array_element_address(ba, offset, T_BYTE);
1269   Node* result = new HasNegativesNode(control(), memory(TypeAryPtr::BYTES), ba_start, len);
1270   set_result(_gvn.transform(result));
1271   return true;
1272 }
1273 
1274 bool LibraryCallKit::inline_preconditions_checkIndex() {
1275   Node* index = argument(0);
1276   Node* length = argument(1);
1277   if (too_many_traps(Deoptimization::Reason_intrinsic) || too_many_traps(Deoptimization::Reason_range_check)) {
1278     return false;
1279   }
1280 
1281   Node* len_pos_cmp = _gvn.transform(new CmpINode(length, intcon(0)));
1282   Node* len_pos_bol = _gvn.transform(new BoolNode(len_pos_cmp, BoolTest::ge));
1283 
1284   {
1285     BuildCutout unless(this, len_pos_bol, PROB_MAX);
1286     uncommon_trap(Deoptimization::Reason_intrinsic,
1287                   Deoptimization::Action_make_not_entrant);
1288   }
1289 
1290   if (stopped()) {
1291     return false;
1292   }
1293 
1294   Node* rc_cmp = _gvn.transform(new CmpUNode(index, length));
1295   BoolTest::mask btest = BoolTest::lt;
1296   Node* rc_bool = _gvn.transform(new BoolNode(rc_cmp, btest));
1297   RangeCheckNode* rc = new RangeCheckNode(control(), rc_bool, PROB_MAX, COUNT_UNKNOWN);
1298   _gvn.set_type(rc, rc-&gt;Value(&amp;_gvn));
1299   if (!rc_bool-&gt;is_Con()) {
1300     record_for_igvn(rc);
1301   }
1302   set_control(_gvn.transform(new IfTrueNode(rc)));
1303   {
1304     PreserveJVMState pjvms(this);
1305     set_control(_gvn.transform(new IfFalseNode(rc)));
1306     uncommon_trap(Deoptimization::Reason_range_check,
1307                   Deoptimization::Action_make_not_entrant);
1308   }
1309 
1310   if (stopped()) {
1311     return false;
1312   }
1313 
1314   Node* result = new CastIINode(index, TypeInt::make(0, _gvn.type(length)-&gt;is_int()-&gt;_hi, Type::WidenMax));
1315   result-&gt;set_req(0, control());
1316   result = _gvn.transform(result);
1317   set_result(result);
1318   replace_in_map(index, result);
1319   clear_upper_avx();
1320   return true;
1321 }
1322 
1323 //------------------------------inline_string_indexOf------------------------
1324 bool LibraryCallKit::inline_string_indexOf(StrIntrinsicNode::ArgEnc ae) {
1325   if (!Matcher::match_rule_supported(Op_StrIndexOf)) {
1326     return false;
1327   }
1328   Node* src = argument(0);
1329   Node* tgt = argument(1);
1330 
1331   // Make the merge point
1332   RegionNode* result_rgn = new RegionNode(4);
1333   Node*       result_phi = new PhiNode(result_rgn, TypeInt::INT);
1334 
1335   src = must_be_not_null(src, true);
1336   tgt = must_be_not_null(tgt, true);
1337 
1338   // Get start addr and length of source string
1339   Node* src_start = array_element_address(src, intcon(0), T_BYTE);
1340   Node* src_count = load_array_length(src);
1341 
1342   // Get start addr and length of substring
1343   Node* tgt_start = array_element_address(tgt, intcon(0), T_BYTE);
1344   Node* tgt_count = load_array_length(tgt);
1345 
1346   if (ae == StrIntrinsicNode::UU || ae == StrIntrinsicNode::UL) {
1347     // Divide src size by 2 if String is UTF16 encoded
1348     src_count = _gvn.transform(new RShiftINode(src_count, intcon(1)));
1349   }
1350   if (ae == StrIntrinsicNode::UU) {
1351     // Divide substring size by 2 if String is UTF16 encoded
1352     tgt_count = _gvn.transform(new RShiftINode(tgt_count, intcon(1)));
1353   }
1354 
1355   Node* result = make_indexOf_node(src_start, src_count, tgt_start, tgt_count, result_rgn, result_phi, ae);
1356   if (result != NULL) {
1357     result_phi-&gt;init_req(3, result);
1358     result_rgn-&gt;init_req(3, control());
1359   }
1360   set_control(_gvn.transform(result_rgn));
1361   record_for_igvn(result_rgn);
1362   set_result(_gvn.transform(result_phi));
1363 
1364   return true;
1365 }
1366 
1367 //-----------------------------inline_string_indexOf-----------------------
1368 bool LibraryCallKit::inline_string_indexOfI(StrIntrinsicNode::ArgEnc ae) {
1369   if (too_many_traps(Deoptimization::Reason_intrinsic)) {
1370     return false;
1371   }
1372   if (!Matcher::match_rule_supported(Op_StrIndexOf)) {
1373     return false;
1374   }
1375   assert(callee()-&gt;signature()-&gt;size() == 5, &quot;String.indexOf() has 5 arguments&quot;);
1376   Node* src         = argument(0); // byte[]
1377   Node* src_count   = argument(1); // char count
1378   Node* tgt         = argument(2); // byte[]
1379   Node* tgt_count   = argument(3); // char count
1380   Node* from_index  = argument(4); // char index
1381 
1382   src = must_be_not_null(src, true);
1383   tgt = must_be_not_null(tgt, true);
1384 
1385   // Multiply byte array index by 2 if String is UTF16 encoded
1386   Node* src_offset = (ae == StrIntrinsicNode::LL) ? from_index : _gvn.transform(new LShiftINode(from_index, intcon(1)));
1387   src_count = _gvn.transform(new SubINode(src_count, from_index));
1388   Node* src_start = array_element_address(src, src_offset, T_BYTE);
1389   Node* tgt_start = array_element_address(tgt, intcon(0), T_BYTE);
1390 
1391   // Range checks
1392   generate_string_range_check(src, src_offset, src_count, ae != StrIntrinsicNode::LL);
1393   generate_string_range_check(tgt, intcon(0), tgt_count, ae == StrIntrinsicNode::UU);
1394   if (stopped()) {
1395     return true;
1396   }
1397 
1398   RegionNode* region = new RegionNode(5);
1399   Node* phi = new PhiNode(region, TypeInt::INT);
1400 
1401   Node* result = make_indexOf_node(src_start, src_count, tgt_start, tgt_count, region, phi, ae);
1402   if (result != NULL) {
1403     // The result is index relative to from_index if substring was found, -1 otherwise.
1404     // Generate code which will fold into cmove.
1405     Node* cmp = _gvn.transform(new CmpINode(result, intcon(0)));
1406     Node* bol = _gvn.transform(new BoolNode(cmp, BoolTest::lt));
1407 
1408     Node* if_lt = generate_slow_guard(bol, NULL);
1409     if (if_lt != NULL) {
1410       // result == -1
1411       phi-&gt;init_req(3, result);
1412       region-&gt;init_req(3, if_lt);
1413     }
1414     if (!stopped()) {
1415       result = _gvn.transform(new AddINode(result, from_index));
1416       phi-&gt;init_req(4, result);
1417       region-&gt;init_req(4, control());
1418     }
1419   }
1420 
1421   set_control(_gvn.transform(region));
1422   record_for_igvn(region);
1423   set_result(_gvn.transform(phi));
1424   clear_upper_avx();
1425 
1426   return true;
1427 }
1428 
1429 // Create StrIndexOfNode with fast path checks
1430 Node* LibraryCallKit::make_indexOf_node(Node* src_start, Node* src_count, Node* tgt_start, Node* tgt_count,
1431                                         RegionNode* region, Node* phi, StrIntrinsicNode::ArgEnc ae) {
1432   // Check for substr count &gt; string count
1433   Node* cmp = _gvn.transform(new CmpINode(tgt_count, src_count));
1434   Node* bol = _gvn.transform(new BoolNode(cmp, BoolTest::gt));
1435   Node* if_gt = generate_slow_guard(bol, NULL);
1436   if (if_gt != NULL) {
1437     phi-&gt;init_req(1, intcon(-1));
1438     region-&gt;init_req(1, if_gt);
1439   }
1440   if (!stopped()) {
1441     // Check for substr count == 0
1442     cmp = _gvn.transform(new CmpINode(tgt_count, intcon(0)));
1443     bol = _gvn.transform(new BoolNode(cmp, BoolTest::eq));
1444     Node* if_zero = generate_slow_guard(bol, NULL);
1445     if (if_zero != NULL) {
1446       phi-&gt;init_req(2, intcon(0));
1447       region-&gt;init_req(2, if_zero);
1448     }
1449   }
1450   if (!stopped()) {
1451     return make_string_method_node(Op_StrIndexOf, src_start, src_count, tgt_start, tgt_count, ae);
1452   }
1453   return NULL;
1454 }
1455 
1456 //-----------------------------inline_string_indexOfChar-----------------------
1457 bool LibraryCallKit::inline_string_indexOfChar() {
1458   if (too_many_traps(Deoptimization::Reason_intrinsic)) {
1459     return false;
1460   }
1461   if (!Matcher::match_rule_supported(Op_StrIndexOfChar)) {
1462     return false;
1463   }
1464   assert(callee()-&gt;signature()-&gt;size() == 4, &quot;String.indexOfChar() has 4 arguments&quot;);
1465   Node* src         = argument(0); // byte[]
1466   Node* tgt         = argument(1); // tgt is int ch
1467   Node* from_index  = argument(2);
1468   Node* max         = argument(3);
1469 
1470   src = must_be_not_null(src, true);
1471 
1472   Node* src_offset = _gvn.transform(new LShiftINode(from_index, intcon(1)));
1473   Node* src_start = array_element_address(src, src_offset, T_BYTE);
1474   Node* src_count = _gvn.transform(new SubINode(max, from_index));
1475 
1476   // Range checks
1477   generate_string_range_check(src, src_offset, src_count, true);
1478   if (stopped()) {
1479     return true;
1480   }
1481 
1482   RegionNode* region = new RegionNode(3);
1483   Node* phi = new PhiNode(region, TypeInt::INT);
1484 
1485   Node* result = new StrIndexOfCharNode(control(), memory(TypeAryPtr::BYTES), src_start, src_count, tgt, StrIntrinsicNode::none);
1486   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
1487   _gvn.transform(result);
1488 
1489   Node* cmp = _gvn.transform(new CmpINode(result, intcon(0)));
1490   Node* bol = _gvn.transform(new BoolNode(cmp, BoolTest::lt));
1491 
1492   Node* if_lt = generate_slow_guard(bol, NULL);
1493   if (if_lt != NULL) {
1494     // result == -1
1495     phi-&gt;init_req(2, result);
1496     region-&gt;init_req(2, if_lt);
1497   }
1498   if (!stopped()) {
1499     result = _gvn.transform(new AddINode(result, from_index));
1500     phi-&gt;init_req(1, result);
1501     region-&gt;init_req(1, control());
1502   }
1503   set_control(_gvn.transform(region));
1504   record_for_igvn(region);
1505   set_result(_gvn.transform(phi));
1506 
1507   return true;
1508 }
1509 //---------------------------inline_string_copy---------------------
1510 // compressIt == true --&gt; generate a compressed copy operation (compress char[]/byte[] to byte[])
1511 //   int StringUTF16.compress(char[] src, int srcOff, byte[] dst, int dstOff, int len)
1512 //   int StringUTF16.compress(byte[] src, int srcOff, byte[] dst, int dstOff, int len)
1513 // compressIt == false --&gt; generate an inflated copy operation (inflate byte[] to char[]/byte[])
1514 //   void StringLatin1.inflate(byte[] src, int srcOff, char[] dst, int dstOff, int len)
1515 //   void StringLatin1.inflate(byte[] src, int srcOff, byte[] dst, int dstOff, int len)
1516 bool LibraryCallKit::inline_string_copy(bool compress) {
1517   if (too_many_traps(Deoptimization::Reason_intrinsic)) {
1518     return false;
1519   }
1520   int nargs = 5;  // 2 oops, 3 ints
1521   assert(callee()-&gt;signature()-&gt;size() == nargs, &quot;string copy has 5 arguments&quot;);
1522 
1523   Node* src         = argument(0);
1524   Node* src_offset  = argument(1);
1525   Node* dst         = argument(2);
1526   Node* dst_offset  = argument(3);
1527   Node* length      = argument(4);
1528 
1529   // Check for allocation before we add nodes that would confuse
1530   // tightly_coupled_allocation()
1531   AllocateArrayNode* alloc = tightly_coupled_allocation(dst, NULL);
1532 
1533   // Figure out the size and type of the elements we will be copying.
1534   const Type* src_type = src-&gt;Value(&amp;_gvn);
1535   const Type* dst_type = dst-&gt;Value(&amp;_gvn);
1536   BasicType src_elem = src_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
1537   BasicType dst_elem = dst_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
1538   assert((compress &amp;&amp; dst_elem == T_BYTE &amp;&amp; (src_elem == T_BYTE || src_elem == T_CHAR)) ||
1539          (!compress &amp;&amp; src_elem == T_BYTE &amp;&amp; (dst_elem == T_BYTE || dst_elem == T_CHAR)),
1540          &quot;Unsupported array types for inline_string_copy&quot;);
1541 
1542   src = must_be_not_null(src, true);
1543   dst = must_be_not_null(dst, true);
1544 
1545   // Convert char[] offsets to byte[] offsets
1546   bool convert_src = (compress &amp;&amp; src_elem == T_BYTE);
1547   bool convert_dst = (!compress &amp;&amp; dst_elem == T_BYTE);
1548   if (convert_src) {
1549     src_offset = _gvn.transform(new LShiftINode(src_offset, intcon(1)));
1550   } else if (convert_dst) {
1551     dst_offset = _gvn.transform(new LShiftINode(dst_offset, intcon(1)));
1552   }
1553 
1554   // Range checks
1555   generate_string_range_check(src, src_offset, length, convert_src);
1556   generate_string_range_check(dst, dst_offset, length, convert_dst);
1557   if (stopped()) {
1558     return true;
1559   }
1560 
1561   Node* src_start = array_element_address(src, src_offset, src_elem);
1562   Node* dst_start = array_element_address(dst, dst_offset, dst_elem);
1563   // &#39;src_start&#39; points to src array + scaled offset
1564   // &#39;dst_start&#39; points to dst array + scaled offset
1565   Node* count = NULL;
1566   if (compress) {
1567     count = compress_string(src_start, TypeAryPtr::get_array_body_type(src_elem), dst_start, length);
1568   } else {
1569     inflate_string(src_start, dst_start, TypeAryPtr::get_array_body_type(dst_elem), length);
1570   }
1571 
1572   if (alloc != NULL) {
1573     if (alloc-&gt;maybe_set_complete(&amp;_gvn)) {
1574       // &quot;You break it, you buy it.&quot;
1575       InitializeNode* init = alloc-&gt;initialization();
1576       assert(init-&gt;is_complete(), &quot;we just did this&quot;);
1577       init-&gt;set_complete_with_arraycopy();
1578       assert(dst-&gt;is_CheckCastPP(), &quot;sanity&quot;);
1579       assert(dst-&gt;in(0)-&gt;in(0) == init, &quot;dest pinned&quot;);
1580     }
1581     // Do not let stores that initialize this object be reordered with
1582     // a subsequent store that would make this object accessible by
1583     // other threads.
1584     // Record what AllocateNode this StoreStore protects so that
1585     // escape analysis can go from the MemBarStoreStoreNode to the
1586     // AllocateNode and eliminate the MemBarStoreStoreNode if possible
1587     // based on the escape status of the AllocateNode.
1588     insert_mem_bar(Op_MemBarStoreStore, alloc-&gt;proj_out_or_null(AllocateNode::RawAddress));
1589   }
1590   if (compress) {
1591     set_result(_gvn.transform(count));
1592   }
1593   clear_upper_avx();
1594 
1595   return true;
1596 }
1597 
1598 #ifdef _LP64
1599 #define XTOP ,top() /*additional argument*/
1600 #else  //_LP64
1601 #define XTOP        /*no additional argument*/
1602 #endif //_LP64
1603 
1604 //------------------------inline_string_toBytesU--------------------------
1605 // public static byte[] StringUTF16.toBytes(char[] value, int off, int len)
1606 bool LibraryCallKit::inline_string_toBytesU() {
1607   if (too_many_traps(Deoptimization::Reason_intrinsic)) {
1608     return false;
1609   }
1610   // Get the arguments.
1611   Node* value     = argument(0);
1612   Node* offset    = argument(1);
1613   Node* length    = argument(2);
1614 
1615   Node* newcopy = NULL;
1616 
1617   // Set the original stack and the reexecute bit for the interpreter to reexecute
1618   // the bytecode that invokes StringUTF16.toBytes() if deoptimization happens.
1619   { PreserveReexecuteState preexecs(this);
1620     jvms()-&gt;set_should_reexecute(true);
1621 
1622     // Check if a null path was taken unconditionally.
1623     value = null_check(value);
1624 
1625     RegionNode* bailout = new RegionNode(1);
1626     record_for_igvn(bailout);
1627 
1628     // Range checks
1629     generate_negative_guard(offset, bailout);
1630     generate_negative_guard(length, bailout);
1631     generate_limit_guard(offset, length, load_array_length(value), bailout);
1632     // Make sure that resulting byte[] length does not overflow Integer.MAX_VALUE
1633     generate_limit_guard(length, intcon(0), intcon(max_jint/2), bailout);
1634 
1635     if (bailout-&gt;req() &gt; 1) {
1636       PreserveJVMState pjvms(this);
1637       set_control(_gvn.transform(bailout));
1638       uncommon_trap(Deoptimization::Reason_intrinsic,
1639                     Deoptimization::Action_maybe_recompile);
1640     }
1641     if (stopped()) {
1642       return true;
1643     }
1644 
1645     Node* size = _gvn.transform(new LShiftINode(length, intcon(1)));
1646     Node* klass_node = makecon(TypeKlassPtr::make(ciTypeArrayKlass::make(T_BYTE)));
1647     newcopy = new_array(klass_node, size, 0);  // no arguments to push
1648     AllocateArrayNode* alloc = tightly_coupled_allocation(newcopy, NULL);
1649 
1650     // Calculate starting addresses.
1651     Node* src_start = array_element_address(value, offset, T_CHAR);
1652     Node* dst_start = basic_plus_adr(newcopy, arrayOopDesc::base_offset_in_bytes(T_BYTE));
1653 
1654     // Check if src array address is aligned to HeapWordSize (dst is always aligned)
1655     const TypeInt* toffset = gvn().type(offset)-&gt;is_int();
1656     bool aligned = toffset-&gt;is_con() &amp;&amp; ((toffset-&gt;get_con() * type2aelembytes(T_CHAR)) % HeapWordSize == 0);
1657 
1658     // Figure out which arraycopy runtime method to call (disjoint, uninitialized).
1659     const char* copyfunc_name = &quot;arraycopy&quot;;
1660     address     copyfunc_addr = StubRoutines::select_arraycopy_function(T_CHAR, aligned, true, copyfunc_name, true);
1661     Node* call = make_runtime_call(RC_LEAF|RC_NO_FP,
1662                       OptoRuntime::fast_arraycopy_Type(),
1663                       copyfunc_addr, copyfunc_name, TypeRawPtr::BOTTOM,
1664                       src_start, dst_start, ConvI2X(length) XTOP);
1665     // Do not let reads from the cloned object float above the arraycopy.
1666     if (alloc != NULL) {
1667       if (alloc-&gt;maybe_set_complete(&amp;_gvn)) {
1668         // &quot;You break it, you buy it.&quot;
1669         InitializeNode* init = alloc-&gt;initialization();
1670         assert(init-&gt;is_complete(), &quot;we just did this&quot;);
1671         init-&gt;set_complete_with_arraycopy();
1672         assert(newcopy-&gt;is_CheckCastPP(), &quot;sanity&quot;);
1673         assert(newcopy-&gt;in(0)-&gt;in(0) == init, &quot;dest pinned&quot;);
1674       }
1675       // Do not let stores that initialize this object be reordered with
1676       // a subsequent store that would make this object accessible by
1677       // other threads.
1678       // Record what AllocateNode this StoreStore protects so that
1679       // escape analysis can go from the MemBarStoreStoreNode to the
1680       // AllocateNode and eliminate the MemBarStoreStoreNode if possible
1681       // based on the escape status of the AllocateNode.
1682       insert_mem_bar(Op_MemBarStoreStore, alloc-&gt;proj_out_or_null(AllocateNode::RawAddress));
1683     } else {
1684       insert_mem_bar(Op_MemBarCPUOrder);
1685     }
1686   } // original reexecute is set back here
1687 
1688   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
1689   if (!stopped()) {
1690     set_result(newcopy);
1691   }
1692   clear_upper_avx();
1693 
1694   return true;
1695 }
1696 
1697 //------------------------inline_string_getCharsU--------------------------
1698 // public void StringUTF16.getChars(byte[] src, int srcBegin, int srcEnd, char dst[], int dstBegin)
1699 bool LibraryCallKit::inline_string_getCharsU() {
1700   if (too_many_traps(Deoptimization::Reason_intrinsic)) {
1701     return false;
1702   }
1703 
1704   // Get the arguments.
1705   Node* src       = argument(0);
1706   Node* src_begin = argument(1);
1707   Node* src_end   = argument(2); // exclusive offset (i &lt; src_end)
1708   Node* dst       = argument(3);
1709   Node* dst_begin = argument(4);
1710 
1711   // Check for allocation before we add nodes that would confuse
1712   // tightly_coupled_allocation()
1713   AllocateArrayNode* alloc = tightly_coupled_allocation(dst, NULL);
1714 
1715   // Check if a null path was taken unconditionally.
1716   src = null_check(src);
1717   dst = null_check(dst);
1718   if (stopped()) {
1719     return true;
1720   }
1721 
1722   // Get length and convert char[] offset to byte[] offset
1723   Node* length = _gvn.transform(new SubINode(src_end, src_begin));
1724   src_begin = _gvn.transform(new LShiftINode(src_begin, intcon(1)));
1725 
1726   // Range checks
1727   generate_string_range_check(src, src_begin, length, true);
1728   generate_string_range_check(dst, dst_begin, length, false);
1729   if (stopped()) {
1730     return true;
1731   }
1732 
1733   if (!stopped()) {
1734     // Calculate starting addresses.
1735     Node* src_start = array_element_address(src, src_begin, T_BYTE);
1736     Node* dst_start = array_element_address(dst, dst_begin, T_CHAR);
1737 
1738     // Check if array addresses are aligned to HeapWordSize
1739     const TypeInt* tsrc = gvn().type(src_begin)-&gt;is_int();
1740     const TypeInt* tdst = gvn().type(dst_begin)-&gt;is_int();
1741     bool aligned = tsrc-&gt;is_con() &amp;&amp; ((tsrc-&gt;get_con() * type2aelembytes(T_BYTE)) % HeapWordSize == 0) &amp;&amp;
1742                    tdst-&gt;is_con() &amp;&amp; ((tdst-&gt;get_con() * type2aelembytes(T_CHAR)) % HeapWordSize == 0);
1743 
1744     // Figure out which arraycopy runtime method to call (disjoint, uninitialized).
1745     const char* copyfunc_name = &quot;arraycopy&quot;;
1746     address     copyfunc_addr = StubRoutines::select_arraycopy_function(T_CHAR, aligned, true, copyfunc_name, true);
1747     Node* call = make_runtime_call(RC_LEAF|RC_NO_FP,
1748                       OptoRuntime::fast_arraycopy_Type(),
1749                       copyfunc_addr, copyfunc_name, TypeRawPtr::BOTTOM,
1750                       src_start, dst_start, ConvI2X(length) XTOP);
1751     // Do not let reads from the cloned object float above the arraycopy.
1752     if (alloc != NULL) {
1753       if (alloc-&gt;maybe_set_complete(&amp;_gvn)) {
1754         // &quot;You break it, you buy it.&quot;
1755         InitializeNode* init = alloc-&gt;initialization();
1756         assert(init-&gt;is_complete(), &quot;we just did this&quot;);
1757         init-&gt;set_complete_with_arraycopy();
1758         assert(dst-&gt;is_CheckCastPP(), &quot;sanity&quot;);
1759         assert(dst-&gt;in(0)-&gt;in(0) == init, &quot;dest pinned&quot;);
1760       }
1761       // Do not let stores that initialize this object be reordered with
1762       // a subsequent store that would make this object accessible by
1763       // other threads.
1764       // Record what AllocateNode this StoreStore protects so that
1765       // escape analysis can go from the MemBarStoreStoreNode to the
1766       // AllocateNode and eliminate the MemBarStoreStoreNode if possible
1767       // based on the escape status of the AllocateNode.
1768       insert_mem_bar(Op_MemBarStoreStore, alloc-&gt;proj_out_or_null(AllocateNode::RawAddress));
1769     } else {
1770       insert_mem_bar(Op_MemBarCPUOrder);
1771     }
1772   }
1773 
1774   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
1775   return true;
1776 }
1777 
1778 //----------------------inline_string_char_access----------------------------
1779 // Store/Load char to/from byte[] array.
1780 // static void StringUTF16.putChar(byte[] val, int index, int c)
1781 // static char StringUTF16.getChar(byte[] val, int index)
1782 bool LibraryCallKit::inline_string_char_access(bool is_store) {
1783   Node* value  = argument(0);
1784   Node* index  = argument(1);
1785   Node* ch = is_store ? argument(2) : NULL;
1786 
1787   // This intrinsic accesses byte[] array as char[] array. Computing the offsets
1788   // correctly requires matched array shapes.
1789   assert (arrayOopDesc::base_offset_in_bytes(T_CHAR) == arrayOopDesc::base_offset_in_bytes(T_BYTE),
1790           &quot;sanity: byte[] and char[] bases agree&quot;);
1791   assert (type2aelembytes(T_CHAR) == type2aelembytes(T_BYTE)*2,
1792           &quot;sanity: byte[] and char[] scales agree&quot;);
1793 
1794   // Bail when getChar over constants is requested: constant folding would
1795   // reject folding mismatched char access over byte[]. A normal inlining for getChar
1796   // Java method would constant fold nicely instead.
1797   if (!is_store &amp;&amp; value-&gt;is_Con() &amp;&amp; index-&gt;is_Con()) {
1798     return false;
1799   }
1800 
1801   value = must_be_not_null(value, true);
1802 
1803   Node* adr = array_element_address(value, index, T_CHAR);
1804   if (adr-&gt;is_top()) {
1805     return false;
1806   }
1807   if (is_store) {
1808     access_store_at(value, adr, TypeAryPtr::BYTES, ch, TypeInt::CHAR, T_CHAR, IN_HEAP | MO_UNORDERED | C2_MISMATCHED);
1809   } else {
1810     ch = access_load_at(value, adr, TypeAryPtr::BYTES, TypeInt::CHAR, T_CHAR, IN_HEAP | MO_UNORDERED | C2_MISMATCHED | C2_CONTROL_DEPENDENT_LOAD);
1811     set_result(ch);
1812   }
1813   return true;
1814 }
1815 
1816 //--------------------------round_double_node--------------------------------
1817 // Round a double node if necessary.
1818 Node* LibraryCallKit::round_double_node(Node* n) {
1819   if (Matcher::strict_fp_requires_explicit_rounding) {
1820 #ifdef IA32
1821     if (UseSSE &lt; 2) {
1822       n = _gvn.transform(new RoundDoubleNode(NULL, n));
1823     }
1824 #else
1825     Unimplemented();
1826 #endif // IA32
1827   }
1828   return n;
1829 }
1830 
1831 //------------------------------inline_math-----------------------------------
1832 // public static double Math.abs(double)
1833 // public static double Math.sqrt(double)
1834 // public static double Math.log(double)
1835 // public static double Math.log10(double)
1836 bool LibraryCallKit::inline_double_math(vmIntrinsics::ID id) {
1837   Node* arg = round_double_node(argument(0));
1838   Node* n = NULL;
1839   switch (id) {
1840   case vmIntrinsics::_dabs:   n = new AbsDNode(                arg);  break;
1841   case vmIntrinsics::_dsqrt:  n = new SqrtDNode(C, control(),  arg);  break;
1842   case vmIntrinsics::_ceil:   n = RoundDoubleModeNode::make(_gvn, arg, RoundDoubleModeNode::rmode_ceil); break;
1843   case vmIntrinsics::_floor:  n = RoundDoubleModeNode::make(_gvn, arg, RoundDoubleModeNode::rmode_floor); break;
1844   case vmIntrinsics::_rint:   n = RoundDoubleModeNode::make(_gvn, arg, RoundDoubleModeNode::rmode_rint); break;
1845   default:  fatal_unexpected_iid(id);  break;
1846   }
1847   set_result(_gvn.transform(n));
1848   return true;
1849 }
1850 
1851 //------------------------------inline_math-----------------------------------
1852 // public static float Math.abs(float)
1853 // public static int Math.abs(int)
1854 // public static long Math.abs(long)
1855 bool LibraryCallKit::inline_math(vmIntrinsics::ID id) {
1856   Node* arg = argument(0);
1857   Node* n = NULL;
1858   switch (id) {
1859   case vmIntrinsics::_fabs:   n = new AbsFNode(                arg);  break;
1860   case vmIntrinsics::_iabs:   n = new AbsINode(                arg);  break;
1861   case vmIntrinsics::_labs:   n = new AbsLNode(                arg);  break;
1862   default:  fatal_unexpected_iid(id);  break;
1863   }
1864   set_result(_gvn.transform(n));
1865   return true;
1866 }
1867 
1868 //------------------------------runtime_math-----------------------------
1869 bool LibraryCallKit::runtime_math(const TypeFunc* call_type, address funcAddr, const char* funcName) {
1870   assert(call_type == OptoRuntime::Math_DD_D_Type() || call_type == OptoRuntime::Math_D_D_Type(),
1871          &quot;must be (DD)D or (D)D type&quot;);
1872 
1873   // Inputs
1874   Node* a = round_double_node(argument(0));
1875   Node* b = (call_type == OptoRuntime::Math_DD_D_Type()) ? round_double_node(argument(2)) : NULL;
1876 
1877   const TypePtr* no_memory_effects = NULL;
1878   Node* trig = make_runtime_call(RC_LEAF, call_type, funcAddr, funcName,
1879                                  no_memory_effects,
1880                                  a, top(), b, b ? top() : NULL);
1881   Node* value = _gvn.transform(new ProjNode(trig, TypeFunc::Parms+0));
1882 #ifdef ASSERT
1883   Node* value_top = _gvn.transform(new ProjNode(trig, TypeFunc::Parms+1));
1884   assert(value_top == top(), &quot;second value must be top&quot;);
1885 #endif
1886 
1887   set_result(value);
1888   return true;
1889 }
1890 
1891 //------------------------------inline_math_native-----------------------------
1892 bool LibraryCallKit::inline_math_native(vmIntrinsics::ID id) {
1893 #define FN_PTR(f) CAST_FROM_FN_PTR(address, f)
1894   switch (id) {
1895     // These intrinsics are not properly supported on all hardware
1896   case vmIntrinsics::_dsin:
1897     return StubRoutines::dsin() != NULL ?
1898       runtime_math(OptoRuntime::Math_D_D_Type(), StubRoutines::dsin(), &quot;dsin&quot;) :
1899       runtime_math(OptoRuntime::Math_D_D_Type(), FN_PTR(SharedRuntime::dsin),   &quot;SIN&quot;);
1900   case vmIntrinsics::_dcos:
1901     return StubRoutines::dcos() != NULL ?
1902       runtime_math(OptoRuntime::Math_D_D_Type(), StubRoutines::dcos(), &quot;dcos&quot;) :
1903       runtime_math(OptoRuntime::Math_D_D_Type(), FN_PTR(SharedRuntime::dcos),   &quot;COS&quot;);
1904   case vmIntrinsics::_dtan:
1905     return StubRoutines::dtan() != NULL ?
1906       runtime_math(OptoRuntime::Math_D_D_Type(), StubRoutines::dtan(), &quot;dtan&quot;) :
1907       runtime_math(OptoRuntime::Math_D_D_Type(), FN_PTR(SharedRuntime::dtan), &quot;TAN&quot;);
1908   case vmIntrinsics::_dlog:
1909     return StubRoutines::dlog() != NULL ?
1910       runtime_math(OptoRuntime::Math_D_D_Type(), StubRoutines::dlog(), &quot;dlog&quot;) :
1911       runtime_math(OptoRuntime::Math_D_D_Type(), FN_PTR(SharedRuntime::dlog),   &quot;LOG&quot;);
1912   case vmIntrinsics::_dlog10:
1913     return StubRoutines::dlog10() != NULL ?
1914       runtime_math(OptoRuntime::Math_D_D_Type(), StubRoutines::dlog10(), &quot;dlog10&quot;) :
1915       runtime_math(OptoRuntime::Math_D_D_Type(), FN_PTR(SharedRuntime::dlog10), &quot;LOG10&quot;);
1916 
1917     // These intrinsics are supported on all hardware
1918   case vmIntrinsics::_ceil:
1919   case vmIntrinsics::_floor:
1920   case vmIntrinsics::_rint:   return Matcher::match_rule_supported(Op_RoundDoubleMode) ? inline_double_math(id) : false;
1921   case vmIntrinsics::_dsqrt:  return Matcher::match_rule_supported(Op_SqrtD) ? inline_double_math(id) : false;
1922   case vmIntrinsics::_dabs:   return Matcher::has_match_rule(Op_AbsD)   ? inline_double_math(id) : false;
1923   case vmIntrinsics::_fabs:   return Matcher::match_rule_supported(Op_AbsF)   ? inline_math(id) : false;
1924   case vmIntrinsics::_iabs:   return Matcher::match_rule_supported(Op_AbsI)   ? inline_math(id) : false;
1925   case vmIntrinsics::_labs:   return Matcher::match_rule_supported(Op_AbsL)   ? inline_math(id) : false;
1926 
1927   case vmIntrinsics::_dexp:
1928     return StubRoutines::dexp() != NULL ?
1929       runtime_math(OptoRuntime::Math_D_D_Type(), StubRoutines::dexp(),  &quot;dexp&quot;) :
1930       runtime_math(OptoRuntime::Math_D_D_Type(), FN_PTR(SharedRuntime::dexp),  &quot;EXP&quot;);
1931   case vmIntrinsics::_dpow: {
1932     Node* exp = round_double_node(argument(2));
1933     const TypeD* d = _gvn.type(exp)-&gt;isa_double_constant();
1934     if (d != NULL &amp;&amp; d-&gt;getd() == 2.0) {
1935       // Special case: pow(x, 2.0) =&gt; x * x
1936       Node* base = round_double_node(argument(0));
1937       set_result(_gvn.transform(new MulDNode(base, base)));
1938       return true;
1939     }
1940     return StubRoutines::dpow() != NULL ?
1941       runtime_math(OptoRuntime::Math_DD_D_Type(), StubRoutines::dpow(),  &quot;dpow&quot;) :
1942       runtime_math(OptoRuntime::Math_DD_D_Type(), FN_PTR(SharedRuntime::dpow),  &quot;POW&quot;);
1943   }
1944 #undef FN_PTR
1945 
1946    // These intrinsics are not yet correctly implemented
1947   case vmIntrinsics::_datan2:
1948     return false;
1949 
1950   default:
1951     fatal_unexpected_iid(id);
1952     return false;
1953   }
1954 }
1955 
1956 static bool is_simple_name(Node* n) {
1957   return (n-&gt;req() == 1         // constant
1958           || (n-&gt;is_Type() &amp;&amp; n-&gt;as_Type()-&gt;type()-&gt;singleton())
1959           || n-&gt;is_Proj()       // parameter or return value
1960           || n-&gt;is_Phi()        // local of some sort
1961           );
1962 }
1963 
1964 //----------------------------inline_notify-----------------------------------*
1965 bool LibraryCallKit::inline_notify(vmIntrinsics::ID id) {
1966   const TypeFunc* ftype = OptoRuntime::monitor_notify_Type();
1967   address func;
1968   if (id == vmIntrinsics::_notify) {
1969     func = OptoRuntime::monitor_notify_Java();
1970   } else {
1971     func = OptoRuntime::monitor_notifyAll_Java();
1972   }
1973   Node* call = make_runtime_call(RC_NO_LEAF, ftype, func, NULL, TypeRawPtr::BOTTOM, argument(0));
1974   make_slow_call_ex(call, env()-&gt;Throwable_klass(), false);
1975   return true;
1976 }
1977 
1978 
1979 //----------------------------inline_min_max-----------------------------------
1980 bool LibraryCallKit::inline_min_max(vmIntrinsics::ID id) {
1981   set_result(generate_min_max(id, argument(0), argument(1)));
1982   return true;
1983 }
1984 
1985 void LibraryCallKit::inline_math_mathExact(Node* math, Node *test) {
1986   Node* bol = _gvn.transform( new BoolNode(test, BoolTest::overflow) );
1987   IfNode* check = create_and_map_if(control(), bol, PROB_UNLIKELY_MAG(3), COUNT_UNKNOWN);
1988   Node* fast_path = _gvn.transform( new IfFalseNode(check));
1989   Node* slow_path = _gvn.transform( new IfTrueNode(check) );
1990 
1991   {
1992     PreserveJVMState pjvms(this);
1993     PreserveReexecuteState preexecs(this);
1994     jvms()-&gt;set_should_reexecute(true);
1995 
1996     set_control(slow_path);
1997     set_i_o(i_o());
1998 
1999     uncommon_trap(Deoptimization::Reason_intrinsic,
2000                   Deoptimization::Action_none);
2001   }
2002 
2003   set_control(fast_path);
2004   set_result(math);
2005 }
2006 
2007 template &lt;typename OverflowOp&gt;
2008 bool LibraryCallKit::inline_math_overflow(Node* arg1, Node* arg2) {
2009   typedef typename OverflowOp::MathOp MathOp;
2010 
2011   MathOp* mathOp = new MathOp(arg1, arg2);
2012   Node* operation = _gvn.transform( mathOp );
2013   Node* ofcheck = _gvn.transform( new OverflowOp(arg1, arg2) );
2014   inline_math_mathExact(operation, ofcheck);
2015   return true;
2016 }
2017 
2018 bool LibraryCallKit::inline_math_addExactI(bool is_increment) {
2019   return inline_math_overflow&lt;OverflowAddINode&gt;(argument(0), is_increment ? intcon(1) : argument(1));
2020 }
2021 
2022 bool LibraryCallKit::inline_math_addExactL(bool is_increment) {
2023   return inline_math_overflow&lt;OverflowAddLNode&gt;(argument(0), is_increment ? longcon(1) : argument(2));
2024 }
2025 
2026 bool LibraryCallKit::inline_math_subtractExactI(bool is_decrement) {
2027   return inline_math_overflow&lt;OverflowSubINode&gt;(argument(0), is_decrement ? intcon(1) : argument(1));
2028 }
2029 
2030 bool LibraryCallKit::inline_math_subtractExactL(bool is_decrement) {
2031   return inline_math_overflow&lt;OverflowSubLNode&gt;(argument(0), is_decrement ? longcon(1) : argument(2));
2032 }
2033 
2034 bool LibraryCallKit::inline_math_negateExactI() {
2035   return inline_math_overflow&lt;OverflowSubINode&gt;(intcon(0), argument(0));
2036 }
2037 
2038 bool LibraryCallKit::inline_math_negateExactL() {
2039   return inline_math_overflow&lt;OverflowSubLNode&gt;(longcon(0), argument(0));
2040 }
2041 
2042 bool LibraryCallKit::inline_math_multiplyExactI() {
2043   return inline_math_overflow&lt;OverflowMulINode&gt;(argument(0), argument(1));
2044 }
2045 
2046 bool LibraryCallKit::inline_math_multiplyExactL() {
2047   return inline_math_overflow&lt;OverflowMulLNode&gt;(argument(0), argument(2));
2048 }
2049 
2050 bool LibraryCallKit::inline_math_multiplyHigh() {
2051   set_result(_gvn.transform(new MulHiLNode(argument(0), argument(2))));
2052   return true;
2053 }
2054 
2055 Node*
2056 LibraryCallKit::generate_min_max(vmIntrinsics::ID id, Node* x0, Node* y0) {
2057   // These are the candidate return value:
2058   Node* xvalue = x0;
2059   Node* yvalue = y0;
2060 
2061   if (xvalue == yvalue) {
2062     return xvalue;
2063   }
2064 
2065   bool want_max = (id == vmIntrinsics::_max);
2066 
2067   const TypeInt* txvalue = _gvn.type(xvalue)-&gt;isa_int();
2068   const TypeInt* tyvalue = _gvn.type(yvalue)-&gt;isa_int();
2069   if (txvalue == NULL || tyvalue == NULL)  return top();
2070   // This is not really necessary, but it is consistent with a
2071   // hypothetical MaxINode::Value method:
2072   int widen = MAX2(txvalue-&gt;_widen, tyvalue-&gt;_widen);
2073 
2074   // %%% This folding logic should (ideally) be in a different place.
2075   // Some should be inside IfNode, and there to be a more reliable
2076   // transformation of ?: style patterns into cmoves.  We also want
2077   // more powerful optimizations around cmove and min/max.
2078 
2079   // Try to find a dominating comparison of these guys.
2080   // It can simplify the index computation for Arrays.copyOf
2081   // and similar uses of System.arraycopy.
2082   // First, compute the normalized version of CmpI(x, y).
2083   int   cmp_op = Op_CmpI;
2084   Node* xkey = xvalue;
2085   Node* ykey = yvalue;
2086   Node* ideal_cmpxy = _gvn.transform(new CmpINode(xkey, ykey));
2087   if (ideal_cmpxy-&gt;is_Cmp()) {
2088     // E.g., if we have CmpI(length - offset, count),
2089     // it might idealize to CmpI(length, count + offset)
2090     cmp_op = ideal_cmpxy-&gt;Opcode();
2091     xkey = ideal_cmpxy-&gt;in(1);
2092     ykey = ideal_cmpxy-&gt;in(2);
2093   }
2094 
2095   // Start by locating any relevant comparisons.
2096   Node* start_from = (xkey-&gt;outcnt() &lt; ykey-&gt;outcnt()) ? xkey : ykey;
2097   Node* cmpxy = NULL;
2098   Node* cmpyx = NULL;
2099   for (DUIterator_Fast kmax, k = start_from-&gt;fast_outs(kmax); k &lt; kmax; k++) {
2100     Node* cmp = start_from-&gt;fast_out(k);
2101     if (cmp-&gt;outcnt() &gt; 0 &amp;&amp;            // must have prior uses
2102         cmp-&gt;in(0) == NULL &amp;&amp;           // must be context-independent
2103         cmp-&gt;Opcode() == cmp_op) {      // right kind of compare
2104       if (cmp-&gt;in(1) == xkey &amp;&amp; cmp-&gt;in(2) == ykey)  cmpxy = cmp;
2105       if (cmp-&gt;in(1) == ykey &amp;&amp; cmp-&gt;in(2) == xkey)  cmpyx = cmp;
2106     }
2107   }
2108 
2109   const int NCMPS = 2;
2110   Node* cmps[NCMPS] = { cmpxy, cmpyx };
2111   int cmpn;
2112   for (cmpn = 0; cmpn &lt; NCMPS; cmpn++) {
2113     if (cmps[cmpn] != NULL)  break;     // find a result
2114   }
2115   if (cmpn &lt; NCMPS) {
2116     // Look for a dominating test that tells us the min and max.
2117     int depth = 0;                // Limit search depth for speed
2118     Node* dom = control();
2119     for (; dom != NULL; dom = IfNode::up_one_dom(dom, true)) {
2120       if (++depth &gt;= 100)  break;
2121       Node* ifproj = dom;
2122       if (!ifproj-&gt;is_Proj())  continue;
2123       Node* iff = ifproj-&gt;in(0);
2124       if (!iff-&gt;is_If())  continue;
2125       Node* bol = iff-&gt;in(1);
2126       if (!bol-&gt;is_Bool())  continue;
2127       Node* cmp = bol-&gt;in(1);
2128       if (cmp == NULL)  continue;
2129       for (cmpn = 0; cmpn &lt; NCMPS; cmpn++)
2130         if (cmps[cmpn] == cmp)  break;
2131       if (cmpn == NCMPS)  continue;
2132       BoolTest::mask btest = bol-&gt;as_Bool()-&gt;_test._test;
2133       if (ifproj-&gt;is_IfFalse())  btest = BoolTest(btest).negate();
2134       if (cmp-&gt;in(1) == ykey)    btest = BoolTest(btest).commute();
2135       // At this point, we know that &#39;x btest y&#39; is true.
2136       switch (btest) {
2137       case BoolTest::eq:
2138         // They are proven equal, so we can collapse the min/max.
2139         // Either value is the answer.  Choose the simpler.
2140         if (is_simple_name(yvalue) &amp;&amp; !is_simple_name(xvalue))
2141           return yvalue;
2142         return xvalue;
2143       case BoolTest::lt:          // x &lt; y
2144       case BoolTest::le:          // x &lt;= y
2145         return (want_max ? yvalue : xvalue);
2146       case BoolTest::gt:          // x &gt; y
2147       case BoolTest::ge:          // x &gt;= y
2148         return (want_max ? xvalue : yvalue);
2149       default:
2150         break;
2151       }
2152     }
2153   }
2154 
2155   // We failed to find a dominating test.
2156   // Let&#39;s pick a test that might GVN with prior tests.
2157   Node*          best_bol   = NULL;
2158   BoolTest::mask best_btest = BoolTest::illegal;
2159   for (cmpn = 0; cmpn &lt; NCMPS; cmpn++) {
2160     Node* cmp = cmps[cmpn];
2161     if (cmp == NULL)  continue;
2162     for (DUIterator_Fast jmax, j = cmp-&gt;fast_outs(jmax); j &lt; jmax; j++) {
2163       Node* bol = cmp-&gt;fast_out(j);
2164       if (!bol-&gt;is_Bool())  continue;
2165       BoolTest::mask btest = bol-&gt;as_Bool()-&gt;_test._test;
2166       if (btest == BoolTest::eq || btest == BoolTest::ne)  continue;
2167       if (cmp-&gt;in(1) == ykey)   btest = BoolTest(btest).commute();
2168       if (bol-&gt;outcnt() &gt; (best_bol == NULL ? 0 : best_bol-&gt;outcnt())) {
2169         best_bol   = bol-&gt;as_Bool();
2170         best_btest = btest;
2171       }
2172     }
2173   }
2174 
2175   Node* answer_if_true  = NULL;
2176   Node* answer_if_false = NULL;
2177   switch (best_btest) {
2178   default:
2179     if (cmpxy == NULL)
2180       cmpxy = ideal_cmpxy;
2181     best_bol = _gvn.transform(new BoolNode(cmpxy, BoolTest::lt));
2182     // and fall through:
2183   case BoolTest::lt:          // x &lt; y
2184   case BoolTest::le:          // x &lt;= y
2185     answer_if_true  = (want_max ? yvalue : xvalue);
2186     answer_if_false = (want_max ? xvalue : yvalue);
2187     break;
2188   case BoolTest::gt:          // x &gt; y
2189   case BoolTest::ge:          // x &gt;= y
2190     answer_if_true  = (want_max ? xvalue : yvalue);
2191     answer_if_false = (want_max ? yvalue : xvalue);
2192     break;
2193   }
2194 
2195   jint hi, lo;
2196   if (want_max) {
2197     // We can sharpen the minimum.
2198     hi = MAX2(txvalue-&gt;_hi, tyvalue-&gt;_hi);
2199     lo = MAX2(txvalue-&gt;_lo, tyvalue-&gt;_lo);
2200   } else {
2201     // We can sharpen the maximum.
2202     hi = MIN2(txvalue-&gt;_hi, tyvalue-&gt;_hi);
2203     lo = MIN2(txvalue-&gt;_lo, tyvalue-&gt;_lo);
2204   }
2205 
2206   // Use a flow-free graph structure, to avoid creating excess control edges
2207   // which could hinder other optimizations.
2208   // Since Math.min/max is often used with arraycopy, we want
2209   // tightly_coupled_allocation to be able to see beyond min/max expressions.
2210   Node* cmov = CMoveNode::make(NULL, best_bol,
2211                                answer_if_false, answer_if_true,
2212                                TypeInt::make(lo, hi, widen));
2213 
2214   return _gvn.transform(cmov);
2215 
2216   /*
2217   // This is not as desirable as it may seem, since Min and Max
2218   // nodes do not have a full set of optimizations.
2219   // And they would interfere, anyway, with &#39;if&#39; optimizations
2220   // and with CMoveI canonical forms.
2221   switch (id) {
2222   case vmIntrinsics::_min:
2223     result_val = _gvn.transform(new (C, 3) MinINode(x,y)); break;
2224   case vmIntrinsics::_max:
2225     result_val = _gvn.transform(new (C, 3) MaxINode(x,y)); break;
2226   default:
2227     ShouldNotReachHere();
2228   }
2229   */
2230 }
2231 
2232 inline int
2233 LibraryCallKit::classify_unsafe_addr(Node* &amp;base, Node* &amp;offset, BasicType type) {
2234   const TypePtr* base_type = TypePtr::NULL_PTR;
2235   if (base != NULL)  base_type = _gvn.type(base)-&gt;isa_ptr();
2236   if (base_type == NULL) {
2237     // Unknown type.
2238     return Type::AnyPtr;
2239   } else if (base_type == TypePtr::NULL_PTR) {
2240     // Since this is a NULL+long form, we have to switch to a rawptr.
2241     base   = _gvn.transform(new CastX2PNode(offset));
2242     offset = MakeConX(0);
2243     return Type::RawPtr;
2244   } else if (base_type-&gt;base() == Type::RawPtr) {
2245     return Type::RawPtr;
2246   } else if (base_type-&gt;isa_oopptr()) {
2247     // Base is never null =&gt; always a heap address.
2248     if (!TypePtr::NULL_PTR-&gt;higher_equal(base_type)) {
2249       return Type::OopPtr;
2250     }
2251     // Offset is small =&gt; always a heap address.
2252     const TypeX* offset_type = _gvn.type(offset)-&gt;isa_intptr_t();
2253     if (offset_type != NULL &amp;&amp;
2254         base_type-&gt;offset() == 0 &amp;&amp;     // (should always be?)
2255         offset_type-&gt;_lo &gt;= 0 &amp;&amp;
2256         !MacroAssembler::needs_explicit_null_check(offset_type-&gt;_hi)) {
2257       return Type::OopPtr;
2258     } else if (type == T_OBJECT) {
2259       // off heap access to an oop doesn&#39;t make any sense. Has to be on
2260       // heap.
2261       return Type::OopPtr;
2262     }
2263     // Otherwise, it might either be oop+off or NULL+addr.
2264     return Type::AnyPtr;
2265   } else {
2266     // No information:
2267     return Type::AnyPtr;
2268   }
2269 }
2270 
2271 inline Node* LibraryCallKit::make_unsafe_address(Node*&amp; base, Node* offset, DecoratorSet decorators, BasicType type, bool can_cast) {
2272   Node* uncasted_base = base;
2273   int kind = classify_unsafe_addr(uncasted_base, offset, type);
2274   if (kind == Type::RawPtr) {
2275     return basic_plus_adr(top(), uncasted_base, offset);
2276   } else if (kind == Type::AnyPtr) {
2277     assert(base == uncasted_base, &quot;unexpected base change&quot;);
2278     if (can_cast) {
2279       if (!_gvn.type(base)-&gt;speculative_maybe_null() &amp;&amp;
2280           !too_many_traps(Deoptimization::Reason_speculate_null_check)) {
2281         // According to profiling, this access is always on
2282         // heap. Casting the base to not null and thus avoiding membars
2283         // around the access should allow better optimizations
2284         Node* null_ctl = top();
2285         base = null_check_oop(base, &amp;null_ctl, true, true, true);
2286         assert(null_ctl-&gt;is_top(), &quot;no null control here&quot;);
2287         return basic_plus_adr(base, offset);
2288       } else if (_gvn.type(base)-&gt;speculative_always_null() &amp;&amp;
2289                  !too_many_traps(Deoptimization::Reason_speculate_null_assert)) {
2290         // According to profiling, this access is always off
2291         // heap.
2292         base = null_assert(base);
2293         Node* raw_base = _gvn.transform(new CastX2PNode(offset));
2294         offset = MakeConX(0);
2295         return basic_plus_adr(top(), raw_base, offset);
2296       }
2297     }
2298     // We don&#39;t know if it&#39;s an on heap or off heap access. Fall back
2299     // to raw memory access.
2300     Node* raw = _gvn.transform(new CheckCastPPNode(control(), base, TypeRawPtr::BOTTOM));
2301     return basic_plus_adr(top(), raw, offset);
2302   } else {
2303     assert(base == uncasted_base, &quot;unexpected base change&quot;);
2304     // We know it&#39;s an on heap access so base can&#39;t be null
2305     if (TypePtr::NULL_PTR-&gt;higher_equal(_gvn.type(base))) {
2306       base = must_be_not_null(base, true);
2307     }
2308     return basic_plus_adr(base, offset);
2309   }
2310 }
2311 
2312 //--------------------------inline_number_methods-----------------------------
2313 // inline int     Integer.numberOfLeadingZeros(int)
2314 // inline int        Long.numberOfLeadingZeros(long)
2315 //
2316 // inline int     Integer.numberOfTrailingZeros(int)
2317 // inline int        Long.numberOfTrailingZeros(long)
2318 //
2319 // inline int     Integer.bitCount(int)
2320 // inline int        Long.bitCount(long)
2321 //
2322 // inline char  Character.reverseBytes(char)
2323 // inline short     Short.reverseBytes(short)
2324 // inline int     Integer.reverseBytes(int)
2325 // inline long       Long.reverseBytes(long)
2326 bool LibraryCallKit::inline_number_methods(vmIntrinsics::ID id) {
2327   Node* arg = argument(0);
2328   Node* n = NULL;
2329   switch (id) {
2330   case vmIntrinsics::_numberOfLeadingZeros_i:   n = new CountLeadingZerosINode( arg);  break;
2331   case vmIntrinsics::_numberOfLeadingZeros_l:   n = new CountLeadingZerosLNode( arg);  break;
2332   case vmIntrinsics::_numberOfTrailingZeros_i:  n = new CountTrailingZerosINode(arg);  break;
2333   case vmIntrinsics::_numberOfTrailingZeros_l:  n = new CountTrailingZerosLNode(arg);  break;
2334   case vmIntrinsics::_bitCount_i:               n = new PopCountINode(          arg);  break;
2335   case vmIntrinsics::_bitCount_l:               n = new PopCountLNode(          arg);  break;
2336   case vmIntrinsics::_reverseBytes_c:           n = new ReverseBytesUSNode(0,   arg);  break;
2337   case vmIntrinsics::_reverseBytes_s:           n = new ReverseBytesSNode( 0,   arg);  break;
2338   case vmIntrinsics::_reverseBytes_i:           n = new ReverseBytesINode( 0,   arg);  break;
2339   case vmIntrinsics::_reverseBytes_l:           n = new ReverseBytesLNode( 0,   arg);  break;
2340   default:  fatal_unexpected_iid(id);  break;
2341   }
2342   set_result(_gvn.transform(n));
2343   return true;
2344 }
2345 
2346 //----------------------------inline_unsafe_access----------------------------
2347 
2348 const TypeOopPtr* LibraryCallKit::sharpen_unsafe_type(Compile::AliasType* alias_type, const TypePtr *adr_type) {
2349   // Attempt to infer a sharper value type from the offset and base type.
2350   ciKlass* sharpened_klass = NULL;
2351 
2352   // See if it is an instance field, with an object type.
2353   if (alias_type-&gt;field() != NULL) {
2354     if (alias_type-&gt;field()-&gt;type()-&gt;is_klass()) {
2355       sharpened_klass = alias_type-&gt;field()-&gt;type()-&gt;as_klass();
2356     }
2357   }
2358 
2359   // See if it is a narrow oop array.
2360   if (adr_type-&gt;isa_aryptr()) {
2361     if (adr_type-&gt;offset() &gt;= objArrayOopDesc::base_offset_in_bytes()) {
2362       const TypeOopPtr *elem_type = adr_type-&gt;is_aryptr()-&gt;elem()-&gt;isa_oopptr();
2363       if (elem_type != NULL) {
2364         sharpened_klass = elem_type-&gt;klass();
2365       }
2366     }
2367   }
2368 
2369   // The sharpened class might be unloaded if there is no class loader
2370   // contraint in place.
2371   if (sharpened_klass != NULL &amp;&amp; sharpened_klass-&gt;is_loaded()) {
2372     const TypeOopPtr* tjp = TypeOopPtr::make_from_klass(sharpened_klass);
2373 
2374 #ifndef PRODUCT
2375     if (C-&gt;print_intrinsics() || C-&gt;print_inlining()) {
2376       tty-&gt;print(&quot;  from base type:  &quot;);  adr_type-&gt;dump(); tty-&gt;cr();
2377       tty-&gt;print(&quot;  sharpened value: &quot;);  tjp-&gt;dump();      tty-&gt;cr();
2378     }
2379 #endif
2380     // Sharpen the value type.
2381     return tjp;
2382   }
2383   return NULL;
2384 }
2385 
2386 DecoratorSet LibraryCallKit::mo_decorator_for_access_kind(AccessKind kind) {
2387   switch (kind) {
2388       case Relaxed:
2389         return MO_UNORDERED;
2390       case Opaque:
2391         return MO_RELAXED;
2392       case Acquire:
2393         return MO_ACQUIRE;
2394       case Release:
2395         return MO_RELEASE;
2396       case Volatile:
2397         return MO_SEQ_CST;
2398       default:
2399         ShouldNotReachHere();
2400         return 0;
2401   }
2402 }
2403 
2404 bool LibraryCallKit::inline_unsafe_access(bool is_store, const BasicType type, const AccessKind kind, const bool unaligned) {
2405   if (callee()-&gt;is_static())  return false;  // caller must have the capability!
2406   DecoratorSet decorators = C2_UNSAFE_ACCESS;
2407   guarantee(!is_store || kind != Acquire, &quot;Acquire accesses can be produced only for loads&quot;);
2408   guarantee( is_store || kind != Release, &quot;Release accesses can be produced only for stores&quot;);
2409   assert(type != T_OBJECT || !unaligned, &quot;unaligned access not supported with object type&quot;);
2410 
2411   if (is_reference_type(type)) {
2412     decorators |= ON_UNKNOWN_OOP_REF;
2413   }
2414 
2415   if (unaligned) {
2416     decorators |= C2_UNALIGNED;
2417   }
2418 
2419 #ifndef PRODUCT
2420   {
2421     ResourceMark rm;
2422     // Check the signatures.
2423     ciSignature* sig = callee()-&gt;signature();
2424 #ifdef ASSERT
2425     if (!is_store) {
2426       // Object getReference(Object base, int/long offset), etc.
2427       BasicType rtype = sig-&gt;return_type()-&gt;basic_type();
2428       assert(rtype == type || (rtype == T_OBJECT &amp;&amp; type == T_VALUETYPE), &quot;getter must return the expected value&quot;);
2429       assert(sig-&gt;count() == 2 || (type == T_VALUETYPE &amp;&amp; sig-&gt;count() == 3), &quot;oop getter has 2 or 3 arguments&quot;);
2430       assert(sig-&gt;type_at(0)-&gt;basic_type() == T_OBJECT, &quot;getter base is object&quot;);
2431       assert(sig-&gt;type_at(1)-&gt;basic_type() == T_LONG, &quot;getter offset is correct&quot;);
2432     } else {
2433       // void putReference(Object base, int/long offset, Object x), etc.
2434       assert(sig-&gt;return_type()-&gt;basic_type() == T_VOID, &quot;putter must not return a value&quot;);
2435       assert(sig-&gt;count() == 3 || (type == T_VALUETYPE &amp;&amp; sig-&gt;count() == 4), &quot;oop putter has 3 arguments&quot;);
2436       assert(sig-&gt;type_at(0)-&gt;basic_type() == T_OBJECT, &quot;putter base is object&quot;);
2437       assert(sig-&gt;type_at(1)-&gt;basic_type() == T_LONG, &quot;putter offset is correct&quot;);
2438       BasicType vtype = sig-&gt;type_at(sig-&gt;count()-1)-&gt;basic_type();
2439       assert(vtype == type || (type == T_VALUETYPE &amp;&amp; vtype == T_OBJECT), &quot;putter must accept the expected value&quot;);
2440     }
2441 #endif // ASSERT
2442  }
2443 #endif //PRODUCT
2444 
2445   C-&gt;set_has_unsafe_access(true);  // Mark eventual nmethod as &quot;unsafe&quot;.
2446 
2447   Node* receiver = argument(0);  // type: oop
2448 
2449   // Build address expression.
2450   Node* adr;
2451   Node* heap_base_oop = top();
2452   Node* offset = top();
2453   Node* val;
2454 
2455   // The base is either a Java object or a value produced by Unsafe.staticFieldBase
2456   Node* base = argument(1);  // type: oop
2457   // The offset is a value produced by Unsafe.staticFieldOffset or Unsafe.objectFieldOffset
2458   offset = argument(2);  // type: long
2459   // We currently rely on the cookies produced by Unsafe.xxxFieldOffset
2460   // to be plain byte offsets, which are also the same as those accepted
2461   // by oopDesc::field_addr.
2462   assert(Unsafe_field_offset_to_byte_offset(11) == 11,
2463          &quot;fieldOffset must be byte-scaled&quot;);
2464 
2465   ciValueKlass* value_klass = NULL;
2466   if (type == T_VALUETYPE) {
2467     Node* cls = null_check(argument(4));
2468     if (stopped()) {
2469       return true;
2470     }
2471     Node* kls = load_klass_from_mirror(cls, false, NULL, 0);
2472     const TypeKlassPtr* kls_t = _gvn.type(kls)-&gt;isa_klassptr();
2473     if (!kls_t-&gt;klass_is_exact()) {
2474       return false;
2475     }
2476     ciKlass* klass = kls_t-&gt;klass();
2477     if (!klass-&gt;is_valuetype()) {
2478       return false;
2479     }
2480     value_klass = klass-&gt;as_value_klass();
2481   }
2482 
2483   receiver = null_check(receiver);
2484   if (stopped()) {
2485     return true;
2486   }
2487 
2488   if (base-&gt;is_ValueType()) {
2489     ValueTypeNode* vt = base-&gt;as_ValueType();
2490 
2491     if (is_store) {
2492       if (!vt-&gt;is_allocated(&amp;_gvn) || !_gvn.type(vt)-&gt;is_valuetype()-&gt;larval()) {
2493         return false;
2494       }
2495       base = vt-&gt;get_oop();
2496     } else {
2497       if (offset-&gt;is_Con()) {
2498         long off = find_long_con(offset, 0);
2499         ciValueKlass* vk = vt-&gt;type()-&gt;value_klass();
2500         if ((long)(int)off != off || !vk-&gt;contains_field_offset(off)) {
2501           return false;
2502         }
2503 
2504         ciField* f = vk-&gt;get_non_flattened_field_by_offset((int)off);
2505 
2506         if (f != NULL) {
2507           BasicType bt = f-&gt;layout_type();
2508           if (bt == T_ARRAY || bt == T_NARROWOOP) {
2509             bt = T_OBJECT;
2510           }
2511           if (bt == type) {
2512             if (bt != T_VALUETYPE || f-&gt;type() == value_klass) {
2513               set_result(vt-&gt;field_value_by_offset((int)off, false));
2514               return true;
2515             }
2516           }
2517         }
2518       }
2519       // Re-execute the unsafe access if allocation triggers deoptimization.
2520       PreserveReexecuteState preexecs(this);
2521       jvms()-&gt;set_should_reexecute(true);
2522       vt = vt-&gt;allocate(this)-&gt;as_ValueType();
2523       base = vt-&gt;get_oop();
2524     }
2525   }
2526 
2527   // 32-bit machines ignore the high half!
2528   offset = ConvL2X(offset);
2529   adr = make_unsafe_address(base, offset, is_store ? ACCESS_WRITE : ACCESS_READ, type, kind == Relaxed);
2530 
2531   if (_gvn.type(base)-&gt;isa_ptr() == TypePtr::NULL_PTR) {
2532     if (type != T_OBJECT &amp;&amp; (value_klass == NULL || !value_klass-&gt;has_object_fields())) {
2533       decorators |= IN_NATIVE; // off-heap primitive access
2534     } else {
2535       return false; // off-heap oop accesses are not supported
2536     }
2537   } else {
2538     heap_base_oop = base; // on-heap or mixed access
2539   }
2540 
2541   // Can base be NULL? Otherwise, always on-heap access.
2542   bool can_access_non_heap = TypePtr::NULL_PTR-&gt;higher_equal(_gvn.type(base));
2543 
2544   if (!can_access_non_heap) {
2545     decorators |= IN_HEAP;
2546   }
2547 
2548   val = is_store ? argument(4 + (type == T_VALUETYPE ? 1 : 0)) : NULL;
2549 
2550   const TypePtr* adr_type = _gvn.type(adr)-&gt;isa_ptr();
2551   if (adr_type == TypePtr::NULL_PTR) {
2552     return false; // off-heap access with zero address
2553   }
2554 
2555   // Try to categorize the address.
2556   Compile::AliasType* alias_type = C-&gt;alias_type(adr_type);
2557   assert(alias_type-&gt;index() != Compile::AliasIdxBot, &quot;no bare pointers here&quot;);
2558 
2559   if (alias_type-&gt;adr_type() == TypeInstPtr::KLASS ||
2560       alias_type-&gt;adr_type() == TypeAryPtr::RANGE) {
2561     return false; // not supported
2562   }
2563 
2564   bool mismatched = false;
2565   BasicType bt = T_ILLEGAL;
2566   ciField* field = NULL;
2567   if (adr_type-&gt;isa_instptr()) {
2568     const TypeInstPtr* instptr = adr_type-&gt;is_instptr();
2569     ciInstanceKlass* k = instptr-&gt;klass()-&gt;as_instance_klass();
2570     int off = instptr-&gt;offset();
2571     if (instptr-&gt;const_oop() != NULL &amp;&amp;
2572         instptr-&gt;klass() == ciEnv::current()-&gt;Class_klass() &amp;&amp;
2573         instptr-&gt;offset() &gt;= (instptr-&gt;klass()-&gt;as_instance_klass()-&gt;size_helper() * wordSize)) {
2574       k = instptr-&gt;const_oop()-&gt;as_instance()-&gt;java_lang_Class_klass()-&gt;as_instance_klass();
2575       field = k-&gt;get_field_by_offset(off, true);
2576     } else {
2577       field = k-&gt;get_non_flattened_field_by_offset(off);
2578     }
2579     if (field != NULL) {
2580       bt = field-&gt;layout_type();
2581     }
2582     assert(bt == alias_type-&gt;basic_type() || bt == T_VALUETYPE, &quot;should match&quot;);
2583     if (field != NULL &amp;&amp; bt == T_VALUETYPE &amp;&amp; !field-&gt;is_flattened()) {
2584       bt = T_OBJECT;
2585     }
2586   } else {
2587     bt = alias_type-&gt;basic_type();
2588   }
2589 
2590   if (bt != T_ILLEGAL) {
2591     assert(alias_type-&gt;adr_type()-&gt;is_oopptr(), &quot;should be on-heap access&quot;);
2592     if (bt == T_BYTE &amp;&amp; adr_type-&gt;isa_aryptr()) {
2593       // Alias type doesn&#39;t differentiate between byte[] and boolean[]).
2594       // Use address type to get the element type.
2595       bt = adr_type-&gt;is_aryptr()-&gt;elem()-&gt;array_element_basic_type();
2596     }
2597     if (bt == T_ARRAY || bt == T_NARROWOOP) {
2598       // accessing an array field with getReference is not a mismatch
2599       bt = T_OBJECT;
2600     }
2601     if ((bt == T_OBJECT) != (type == T_OBJECT)) {
2602       // Don&#39;t intrinsify mismatched object accesses
2603       return false;
2604     }
2605     mismatched = (bt != type);
2606   } else if (alias_type-&gt;adr_type()-&gt;isa_oopptr()) {
2607     mismatched = true; // conservatively mark all &quot;wide&quot; on-heap accesses as mismatched
2608   }
2609 
2610   if (type == T_VALUETYPE) {
2611     if (adr_type-&gt;isa_instptr()) {
2612       if (field == NULL || field-&gt;type() != value_klass) {
2613         mismatched = true;
2614       }
2615     } else if (adr_type-&gt;isa_aryptr()) {
2616       const Type* elem = adr_type-&gt;is_aryptr()-&gt;elem();
2617       if (!elem-&gt;isa_valuetype()) {
2618         mismatched = true;
2619       } else if (elem-&gt;value_klass() != value_klass) {
2620         mismatched = true;
2621       }
2622     }
2623     if (is_store) {
2624       const Type* val_t = _gvn.type(val);
2625       if (!val_t-&gt;isa_valuetype() || val_t-&gt;value_klass() != value_klass) {
2626         return false;
2627       }
2628     }
2629   }
2630 
2631   assert(!mismatched || alias_type-&gt;adr_type()-&gt;is_oopptr(), &quot;off-heap access can&#39;t be mismatched&quot;);
2632 
2633   if (mismatched) {
2634     decorators |= C2_MISMATCHED;
2635   }
2636 
2637   // First guess at the value type.
2638   const Type *value_type = Type::get_const_basic_type(type);
2639 
2640   // Figure out the memory ordering.
2641   decorators |= mo_decorator_for_access_kind(kind);
2642 
2643   if (!is_store) {
2644     if (type == T_OBJECT) {
2645       const TypeOopPtr* tjp = sharpen_unsafe_type(alias_type, adr_type);
2646       if (tjp != NULL) {
2647         value_type = tjp;
2648       }
2649     } else if (type == T_VALUETYPE) {
2650       value_type = NULL;
2651     }
2652   }
2653 
2654   // Heap pointers get a null-check from the interpreter,
2655   // as a courtesy.  However, this is not guaranteed by Unsafe,
2656   // and it is not possible to fully distinguish unintended nulls
2657   // from intended ones in this API.
2658 
2659   if (!is_store) {
2660     Node* p = NULL;
2661     // Try to constant fold a load from a constant field
2662 
2663     if (heap_base_oop != top() &amp;&amp; field != NULL &amp;&amp; field-&gt;is_constant() &amp;&amp; !mismatched) {
2664       // final or stable field
2665       p = make_constant_from_field(field, heap_base_oop);
2666     }
2667 
2668     if (p == NULL) { // Could not constant fold the load
2669       if (type == T_VALUETYPE) {
2670         if (adr_type-&gt;isa_instptr() &amp;&amp; !mismatched) {
2671           ciInstanceKlass* holder = adr_type-&gt;is_instptr()-&gt;klass()-&gt;as_instance_klass();
2672           int offset = adr_type-&gt;is_instptr()-&gt;offset();
2673           p = ValueTypeNode::make_from_flattened(this, value_klass, base, base, holder, offset, decorators);
2674         } else {
2675           p = ValueTypeNode::make_from_flattened(this, value_klass, base, adr, NULL, 0, decorators);
2676         }
2677       } else {
2678         p = access_load_at(heap_base_oop, adr, adr_type, value_type, type, decorators);
2679       }
2680       // Normalize the value returned by getBoolean in the following cases
2681       if (type == T_BOOLEAN &amp;&amp;
2682           (mismatched ||
2683            heap_base_oop == top() ||                  // - heap_base_oop is NULL or
2684            (can_access_non_heap &amp;&amp; field == NULL))    // - heap_base_oop is potentially NULL
2685                                                       //   and the unsafe access is made to large offset
2686                                                       //   (i.e., larger than the maximum offset necessary for any
2687                                                       //   field access)
2688             ) {
2689           IdealKit ideal = IdealKit(this);
2690 #define __ ideal.
2691           IdealVariable normalized_result(ideal);
2692           __ declarations_done();
2693           __ set(normalized_result, p);
2694           __ if_then(p, BoolTest::ne, ideal.ConI(0));
2695           __ set(normalized_result, ideal.ConI(1));
2696           ideal.end_if();
2697           final_sync(ideal);
2698           p = __ value(normalized_result);
2699 #undef __
2700       }
2701     }
2702     if (type == T_ADDRESS) {
2703       p = gvn().transform(new CastP2XNode(NULL, p));
2704       p = ConvX2UL(p);
2705     }
2706     if (field != NULL &amp;&amp; field-&gt;is_flattenable() &amp;&amp; !field-&gt;is_flattened()) {
2707       // Load a non-flattened but flattenable value type from memory
2708       if (value_type-&gt;value_klass()-&gt;is_scalarizable()) {
2709         p = ValueTypeNode::make_from_oop(this, p, value_type-&gt;value_klass());
2710       } else {
2711         p = null2default(p, value_type-&gt;value_klass());
2712       }
2713     }
2714     // The load node has the control of the preceding MemBarCPUOrder.  All
2715     // following nodes will have the control of the MemBarCPUOrder inserted at
2716     // the end of this method.  So, pushing the load onto the stack at a later
2717     // point is fine.
2718     set_result(p);
2719   } else {
2720     if (bt == T_ADDRESS) {
2721       // Repackage the long as a pointer.
2722       val = ConvL2X(val);
2723       val = gvn().transform(new CastX2PNode(val));
2724     }
2725     if (type == T_VALUETYPE) {
2726       if (adr_type-&gt;isa_instptr() &amp;&amp; !mismatched) {
2727         ciInstanceKlass* holder = adr_type-&gt;is_instptr()-&gt;klass()-&gt;as_instance_klass();
2728         int offset = adr_type-&gt;is_instptr()-&gt;offset();
2729         val-&gt;as_ValueType()-&gt;store_flattened(this, base, base, holder, offset, decorators);
2730       } else {
2731         val-&gt;as_ValueType()-&gt;store_flattened(this, base, adr, NULL, 0, decorators);
2732       }
2733     } else {
2734       access_store_at(heap_base_oop, adr, adr_type, val, value_type, type, decorators);
2735     }
2736   }
2737 
2738   if (argument(1)-&gt;is_ValueType() &amp;&amp; is_store) {
2739     Node* value = ValueTypeNode::make_from_oop(this, base, _gvn.type(base)-&gt;value_klass());
2740     value = value-&gt;as_ValueType()-&gt;make_larval(this, false);
2741     replace_in_map(argument(1), value);
2742   }
2743 
2744   return true;
2745 }
2746 
2747 bool LibraryCallKit::inline_unsafe_make_private_buffer() {
2748   Node* receiver = argument(0);
2749   Node* value = argument(1);
2750 
2751   receiver = null_check(receiver);
2752   if (stopped()) {
2753     return true;
2754   }
2755 
2756   if (!value-&gt;is_ValueType()) {
2757     return false;
2758   }
2759 
2760   set_result(value-&gt;as_ValueType()-&gt;make_larval(this, true));
2761 
2762   return true;
2763 }
2764 
2765 bool LibraryCallKit::inline_unsafe_finish_private_buffer() {
2766   Node* receiver = argument(0);
2767   Node* buffer = argument(1);
2768 
2769   receiver = null_check(receiver);
2770   if (stopped()) {
2771     return true;
2772   }
2773 
2774   if (!buffer-&gt;is_ValueType()) {
2775     return false;
2776   }
2777 
2778   ValueTypeNode* vt = buffer-&gt;as_ValueType();
2779   if (!vt-&gt;is_allocated(&amp;_gvn) || !_gvn.type(vt)-&gt;is_valuetype()-&gt;larval()) {
2780     return false;
2781   }
2782 
2783   set_result(vt-&gt;finish_larval(this));
2784 
2785   return true;
2786 }
2787 
2788 //----------------------------inline_unsafe_load_store----------------------------
2789 // This method serves a couple of different customers (depending on LoadStoreKind):
2790 //
2791 // LS_cmp_swap:
2792 //
2793 //   boolean compareAndSetReference(Object o, long offset, Object expected, Object x);
2794 //   boolean compareAndSetInt(   Object o, long offset, int    expected, int    x);
2795 //   boolean compareAndSetLong(  Object o, long offset, long   expected, long   x);
2796 //
2797 // LS_cmp_swap_weak:
2798 //
2799 //   boolean weakCompareAndSetReference(       Object o, long offset, Object expected, Object x);
2800 //   boolean weakCompareAndSetReferencePlain(  Object o, long offset, Object expected, Object x);
2801 //   boolean weakCompareAndSetReferenceAcquire(Object o, long offset, Object expected, Object x);
2802 //   boolean weakCompareAndSetReferenceRelease(Object o, long offset, Object expected, Object x);
2803 //
2804 //   boolean weakCompareAndSetInt(          Object o, long offset, int    expected, int    x);
2805 //   boolean weakCompareAndSetIntPlain(     Object o, long offset, int    expected, int    x);
2806 //   boolean weakCompareAndSetIntAcquire(   Object o, long offset, int    expected, int    x);
2807 //   boolean weakCompareAndSetIntRelease(   Object o, long offset, int    expected, int    x);
2808 //
2809 //   boolean weakCompareAndSetLong(         Object o, long offset, long   expected, long   x);
2810 //   boolean weakCompareAndSetLongPlain(    Object o, long offset, long   expected, long   x);
2811 //   boolean weakCompareAndSetLongAcquire(  Object o, long offset, long   expected, long   x);
2812 //   boolean weakCompareAndSetLongRelease(  Object o, long offset, long   expected, long   x);
2813 //
2814 // LS_cmp_exchange:
2815 //
2816 //   Object compareAndExchangeReferenceVolatile(Object o, long offset, Object expected, Object x);
2817 //   Object compareAndExchangeReferenceAcquire( Object o, long offset, Object expected, Object x);
2818 //   Object compareAndExchangeReferenceRelease( Object o, long offset, Object expected, Object x);
2819 //
2820 //   Object compareAndExchangeIntVolatile(   Object o, long offset, Object expected, Object x);
2821 //   Object compareAndExchangeIntAcquire(    Object o, long offset, Object expected, Object x);
2822 //   Object compareAndExchangeIntRelease(    Object o, long offset, Object expected, Object x);
2823 //
2824 //   Object compareAndExchangeLongVolatile(  Object o, long offset, Object expected, Object x);
2825 //   Object compareAndExchangeLongAcquire(   Object o, long offset, Object expected, Object x);
2826 //   Object compareAndExchangeLongRelease(   Object o, long offset, Object expected, Object x);
2827 //
2828 // LS_get_add:
2829 //
2830 //   int  getAndAddInt( Object o, long offset, int  delta)
2831 //   long getAndAddLong(Object o, long offset, long delta)
2832 //
2833 // LS_get_set:
2834 //
2835 //   int    getAndSet(Object o, long offset, int    newValue)
2836 //   long   getAndSet(Object o, long offset, long   newValue)
2837 //   Object getAndSet(Object o, long offset, Object newValue)
2838 //
2839 bool LibraryCallKit::inline_unsafe_load_store(const BasicType type, const LoadStoreKind kind, const AccessKind access_kind) {
2840   // This basic scheme here is the same as inline_unsafe_access, but
2841   // differs in enough details that combining them would make the code
2842   // overly confusing.  (This is a true fact! I originally combined
2843   // them, but even I was confused by it!) As much code/comments as
2844   // possible are retained from inline_unsafe_access though to make
2845   // the correspondences clearer. - dl
2846 
2847   if (callee()-&gt;is_static())  return false;  // caller must have the capability!
2848 
2849   DecoratorSet decorators = C2_UNSAFE_ACCESS;
2850   decorators |= mo_decorator_for_access_kind(access_kind);
2851 
2852 #ifndef PRODUCT
2853   BasicType rtype;
2854   {
2855     ResourceMark rm;
2856     // Check the signatures.
2857     ciSignature* sig = callee()-&gt;signature();
2858     rtype = sig-&gt;return_type()-&gt;basic_type();
2859     switch(kind) {
2860       case LS_get_add:
2861       case LS_get_set: {
2862       // Check the signatures.
2863 #ifdef ASSERT
2864       assert(rtype == type, &quot;get and set must return the expected type&quot;);
2865       assert(sig-&gt;count() == 3, &quot;get and set has 3 arguments&quot;);
2866       assert(sig-&gt;type_at(0)-&gt;basic_type() == T_OBJECT, &quot;get and set base is object&quot;);
2867       assert(sig-&gt;type_at(1)-&gt;basic_type() == T_LONG, &quot;get and set offset is long&quot;);
2868       assert(sig-&gt;type_at(2)-&gt;basic_type() == type, &quot;get and set must take expected type as new value/delta&quot;);
2869       assert(access_kind == Volatile, &quot;mo is not passed to intrinsic nodes in current implementation&quot;);
2870 #endif // ASSERT
2871         break;
2872       }
2873       case LS_cmp_swap:
2874       case LS_cmp_swap_weak: {
2875       // Check the signatures.
2876 #ifdef ASSERT
2877       assert(rtype == T_BOOLEAN, &quot;CAS must return boolean&quot;);
2878       assert(sig-&gt;count() == 4, &quot;CAS has 4 arguments&quot;);
2879       assert(sig-&gt;type_at(0)-&gt;basic_type() == T_OBJECT, &quot;CAS base is object&quot;);
2880       assert(sig-&gt;type_at(1)-&gt;basic_type() == T_LONG, &quot;CAS offset is long&quot;);
2881 #endif // ASSERT
2882         break;
2883       }
2884       case LS_cmp_exchange: {
2885       // Check the signatures.
2886 #ifdef ASSERT
2887       assert(rtype == type, &quot;CAS must return the expected type&quot;);
2888       assert(sig-&gt;count() == 4, &quot;CAS has 4 arguments&quot;);
2889       assert(sig-&gt;type_at(0)-&gt;basic_type() == T_OBJECT, &quot;CAS base is object&quot;);
2890       assert(sig-&gt;type_at(1)-&gt;basic_type() == T_LONG, &quot;CAS offset is long&quot;);
2891 #endif // ASSERT
2892         break;
2893       }
2894       default:
2895         ShouldNotReachHere();
2896     }
2897   }
2898 #endif //PRODUCT
2899 
2900   C-&gt;set_has_unsafe_access(true);  // Mark eventual nmethod as &quot;unsafe&quot;.
2901 
2902   // Get arguments:
2903   Node* receiver = NULL;
2904   Node* base     = NULL;
2905   Node* offset   = NULL;
2906   Node* oldval   = NULL;
2907   Node* newval   = NULL;
2908   switch(kind) {
2909     case LS_cmp_swap:
2910     case LS_cmp_swap_weak:
2911     case LS_cmp_exchange: {
2912       const bool two_slot_type = type2size[type] == 2;
2913       receiver = argument(0);  // type: oop
2914       base     = argument(1);  // type: oop
2915       offset   = argument(2);  // type: long
2916       oldval   = argument(4);  // type: oop, int, or long
2917       newval   = argument(two_slot_type ? 6 : 5);  // type: oop, int, or long
2918       break;
2919     }
2920     case LS_get_add:
2921     case LS_get_set: {
2922       receiver = argument(0);  // type: oop
2923       base     = argument(1);  // type: oop
2924       offset   = argument(2);  // type: long
2925       oldval   = NULL;
2926       newval   = argument(4);  // type: oop, int, or long
2927       break;
2928     }
2929     default:
2930       ShouldNotReachHere();
2931   }
2932 
2933   // Build field offset expression.
2934   // We currently rely on the cookies produced by Unsafe.xxxFieldOffset
2935   // to be plain byte offsets, which are also the same as those accepted
2936   // by oopDesc::field_addr.
2937   assert(Unsafe_field_offset_to_byte_offset(11) == 11, &quot;fieldOffset must be byte-scaled&quot;);
2938   // 32-bit machines ignore the high half of long offsets
2939   offset = ConvL2X(offset);
2940   Node* adr = make_unsafe_address(base, offset, ACCESS_WRITE | ACCESS_READ, type, false);
2941   const TypePtr *adr_type = _gvn.type(adr)-&gt;isa_ptr();
2942 
2943   Compile::AliasType* alias_type = C-&gt;alias_type(adr_type);
2944   BasicType bt = alias_type-&gt;basic_type();
2945   if (bt != T_ILLEGAL &amp;&amp;
2946       (is_reference_type(bt) != (type == T_OBJECT))) {
2947     // Don&#39;t intrinsify mismatched object accesses.
2948     return false;
2949   }
2950 
2951   // For CAS, unlike inline_unsafe_access, there seems no point in
2952   // trying to refine types. Just use the coarse types here.
2953   assert(alias_type-&gt;index() != Compile::AliasIdxBot, &quot;no bare pointers here&quot;);
2954   const Type *value_type = Type::get_const_basic_type(type);
2955 
2956   switch (kind) {
2957     case LS_get_set:
2958     case LS_cmp_exchange: {
2959       if (type == T_OBJECT) {
2960         const TypeOopPtr* tjp = sharpen_unsafe_type(alias_type, adr_type);
2961         if (tjp != NULL) {
2962           value_type = tjp;
2963         }
2964       }
2965       break;
2966     }
2967     case LS_cmp_swap:
2968     case LS_cmp_swap_weak:
2969     case LS_get_add:
2970       break;
2971     default:
2972       ShouldNotReachHere();
2973   }
2974 
2975   // Null check receiver.
2976   receiver = null_check(receiver);
2977   if (stopped()) {
2978     return true;
2979   }
2980 
2981   int alias_idx = C-&gt;get_alias_index(adr_type);
2982 
2983   if (is_reference_type(type)) {
2984     decorators |= IN_HEAP | ON_UNKNOWN_OOP_REF;
2985 
2986     // Transformation of a value which could be NULL pointer (CastPP #NULL)
2987     // could be delayed during Parse (for example, in adjust_map_after_if()).
2988     // Execute transformation here to avoid barrier generation in such case.
2989     if (_gvn.type(newval) == TypePtr::NULL_PTR)
2990       newval = _gvn.makecon(TypePtr::NULL_PTR);
2991 
2992     if (oldval != NULL &amp;&amp; _gvn.type(oldval) == TypePtr::NULL_PTR) {
2993       // Refine the value to a null constant, when it is known to be null
2994       oldval = _gvn.makecon(TypePtr::NULL_PTR);
2995     }
2996   }
2997 
2998   Node* result = NULL;
2999   switch (kind) {
3000     case LS_cmp_exchange: {
3001       result = access_atomic_cmpxchg_val_at(base, adr, adr_type, alias_idx,
3002                                             oldval, newval, value_type, type, decorators);
3003       break;
3004     }
3005     case LS_cmp_swap_weak:
3006       decorators |= C2_WEAK_CMPXCHG;
3007     case LS_cmp_swap: {
3008       result = access_atomic_cmpxchg_bool_at(base, adr, adr_type, alias_idx,
3009                                              oldval, newval, value_type, type, decorators);
3010       break;
3011     }
3012     case LS_get_set: {
3013       result = access_atomic_xchg_at(base, adr, adr_type, alias_idx,
3014                                      newval, value_type, type, decorators);
3015       break;
3016     }
3017     case LS_get_add: {
3018       result = access_atomic_add_at(base, adr, adr_type, alias_idx,
3019                                     newval, value_type, type, decorators);
3020       break;
3021     }
3022     default:
3023       ShouldNotReachHere();
3024   }
3025 
3026   assert(type2size[result-&gt;bottom_type()-&gt;basic_type()] == type2size[rtype], &quot;result type should match&quot;);
3027   set_result(result);
3028   return true;
3029 }
3030 
3031 bool LibraryCallKit::inline_unsafe_fence(vmIntrinsics::ID id) {
3032   // Regardless of form, don&#39;t allow previous ld/st to move down,
3033   // then issue acquire, release, or volatile mem_bar.
3034   insert_mem_bar(Op_MemBarCPUOrder);
3035   switch(id) {
3036     case vmIntrinsics::_loadFence:
3037       insert_mem_bar(Op_LoadFence);
3038       return true;
3039     case vmIntrinsics::_storeFence:
3040       insert_mem_bar(Op_StoreFence);
3041       return true;
3042     case vmIntrinsics::_fullFence:
3043       insert_mem_bar(Op_MemBarVolatile);
3044       return true;
3045     default:
3046       fatal_unexpected_iid(id);
3047       return false;
3048   }
3049 }
3050 
3051 bool LibraryCallKit::inline_onspinwait() {
3052   insert_mem_bar(Op_OnSpinWait);
3053   return true;
3054 }
3055 
3056 bool LibraryCallKit::klass_needs_init_guard(Node* kls) {
3057   if (!kls-&gt;is_Con()) {
3058     return true;
3059   }
3060   const TypeKlassPtr* klsptr = kls-&gt;bottom_type()-&gt;isa_klassptr();
3061   if (klsptr == NULL) {
3062     return true;
3063   }
3064   ciInstanceKlass* ik = klsptr-&gt;klass()-&gt;as_instance_klass();
3065   // don&#39;t need a guard for a klass that is already initialized
3066   return !ik-&gt;is_initialized();
3067 }
3068 
3069 //----------------------------inline_unsafe_writeback0-------------------------
3070 // public native void Unsafe.writeback0(long address)
3071 bool LibraryCallKit::inline_unsafe_writeback0() {
3072   if (!Matcher::has_match_rule(Op_CacheWB)) {
3073     return false;
3074   }
3075 #ifndef PRODUCT
3076   assert(Matcher::has_match_rule(Op_CacheWBPreSync), &quot;found match rule for CacheWB but not CacheWBPreSync&quot;);
3077   assert(Matcher::has_match_rule(Op_CacheWBPostSync), &quot;found match rule for CacheWB but not CacheWBPostSync&quot;);
3078   ciSignature* sig = callee()-&gt;signature();
3079   assert(sig-&gt;type_at(0)-&gt;basic_type() == T_LONG, &quot;Unsafe_writeback0 address is long!&quot;);
3080 #endif
3081   null_check_receiver();  // null-check, then ignore
3082   Node *addr = argument(1);
3083   addr = new CastX2PNode(addr);
3084   addr = _gvn.transform(addr);
3085   Node *flush = new CacheWBNode(control(), memory(TypeRawPtr::BOTTOM), addr);
3086   flush = _gvn.transform(flush);
3087   set_memory(flush, TypeRawPtr::BOTTOM);
3088   return true;
3089 }
3090 
3091 //----------------------------inline_unsafe_writeback0-------------------------
3092 // public native void Unsafe.writeback0(long address)
3093 bool LibraryCallKit::inline_unsafe_writebackSync0(bool is_pre) {
3094   if (is_pre &amp;&amp; !Matcher::has_match_rule(Op_CacheWBPreSync)) {
3095     return false;
3096   }
3097   if (!is_pre &amp;&amp; !Matcher::has_match_rule(Op_CacheWBPostSync)) {
3098     return false;
3099   }
3100 #ifndef PRODUCT
3101   assert(Matcher::has_match_rule(Op_CacheWB),
3102          (is_pre ? &quot;found match rule for CacheWBPreSync but not CacheWB&quot;
3103                 : &quot;found match rule for CacheWBPostSync but not CacheWB&quot;));
3104 
3105 #endif
3106   null_check_receiver();  // null-check, then ignore
3107   Node *sync;
3108   if (is_pre) {
3109     sync = new CacheWBPreSyncNode(control(), memory(TypeRawPtr::BOTTOM));
3110   } else {
3111     sync = new CacheWBPostSyncNode(control(), memory(TypeRawPtr::BOTTOM));
3112   }
3113   sync = _gvn.transform(sync);
3114   set_memory(sync, TypeRawPtr::BOTTOM);
3115   return true;
3116 }
3117 
3118 //----------------------------inline_unsafe_allocate---------------------------
3119 // public native Object Unsafe.allocateInstance(Class&lt;?&gt; cls);
3120 bool LibraryCallKit::inline_unsafe_allocate() {
3121   if (callee()-&gt;is_static())  return false;  // caller must have the capability!
3122 
3123   null_check_receiver();  // null-check, then ignore
3124   Node* cls = null_check(argument(1));
3125   if (stopped())  return true;
3126 
3127   Node* kls = load_klass_from_mirror(cls, false, NULL, 0);
3128   kls = null_check(kls);
3129   if (stopped())  return true;  // argument was like int.class
3130 
3131   Node* test = NULL;
3132   if (LibraryCallKit::klass_needs_init_guard(kls)) {
3133     // Note:  The argument might still be an illegal value like
3134     // Serializable.class or Object[].class.   The runtime will handle it.
3135     // But we must make an explicit check for initialization.
3136     Node* insp = basic_plus_adr(kls, in_bytes(InstanceKlass::init_state_offset()));
3137     // Use T_BOOLEAN for InstanceKlass::_init_state so the compiler
3138     // can generate code to load it as unsigned byte.
3139     Node* inst = make_load(NULL, insp, TypeInt::UBYTE, T_BOOLEAN, MemNode::unordered);
3140     Node* bits = intcon(InstanceKlass::fully_initialized);
3141     test = _gvn.transform(new SubINode(inst, bits));
3142     // The &#39;test&#39; is non-zero if we need to take a slow path.
3143   }
3144 
3145   Node* obj = new_instance(kls, test);
3146   set_result(obj);
3147   return true;
3148 }
3149 
3150 //------------------------inline_native_time_funcs--------------
3151 // inline code for System.currentTimeMillis() and System.nanoTime()
3152 // these have the same type and signature
3153 bool LibraryCallKit::inline_native_time_funcs(address funcAddr, const char* funcName) {
3154   const TypeFunc* tf = OptoRuntime::void_long_Type();
3155   const TypePtr* no_memory_effects = NULL;
3156   Node* time = make_runtime_call(RC_LEAF, tf, funcAddr, funcName, no_memory_effects);
3157   Node* value = _gvn.transform(new ProjNode(time, TypeFunc::Parms+0));
3158 #ifdef ASSERT
3159   Node* value_top = _gvn.transform(new ProjNode(time, TypeFunc::Parms+1));
3160   assert(value_top == top(), &quot;second value must be top&quot;);
3161 #endif
3162   set_result(value);
3163   return true;
3164 }
3165 
3166 #ifdef JFR_HAVE_INTRINSICS
3167 
3168 /*
3169 * oop -&gt; myklass
3170 * myklass-&gt;trace_id |= USED
3171 * return myklass-&gt;trace_id &amp; ~0x3
3172 */
3173 bool LibraryCallKit::inline_native_classID() {
3174   Node* cls = null_check(argument(0), T_OBJECT);
3175   Node* kls = load_klass_from_mirror(cls, false, NULL, 0);
3176   kls = null_check(kls, T_OBJECT);
3177 
3178   ByteSize offset = KLASS_TRACE_ID_OFFSET;
3179   Node* insp = basic_plus_adr(kls, in_bytes(offset));
3180   Node* tvalue = make_load(NULL, insp, TypeLong::LONG, T_LONG, MemNode::unordered);
3181 
3182   Node* clsused = longcon(0x01l); // set the class bit
3183   Node* orl = _gvn.transform(new OrLNode(tvalue, clsused));
3184   const TypePtr *adr_type = _gvn.type(insp)-&gt;isa_ptr();
3185   store_to_memory(control(), insp, orl, T_LONG, adr_type, MemNode::unordered);
3186 
3187 #ifdef TRACE_ID_META_BITS
3188   Node* mbits = longcon(~TRACE_ID_META_BITS);
3189   tvalue = _gvn.transform(new AndLNode(tvalue, mbits));
3190 #endif
3191 #ifdef TRACE_ID_SHIFT
3192   Node* cbits = intcon(TRACE_ID_SHIFT);
3193   tvalue = _gvn.transform(new URShiftLNode(tvalue, cbits));
3194 #endif
3195 
3196   set_result(tvalue);
3197   return true;
3198 
3199 }
3200 
3201 bool LibraryCallKit::inline_native_getEventWriter() {
3202   Node* tls_ptr = _gvn.transform(new ThreadLocalNode());
3203 
3204   Node* jobj_ptr = basic_plus_adr(top(), tls_ptr,
3205                                   in_bytes(THREAD_LOCAL_WRITER_OFFSET_JFR));
3206 
3207   Node* jobj = make_load(control(), jobj_ptr, TypeRawPtr::BOTTOM, T_ADDRESS, MemNode::unordered);
3208 
3209   Node* jobj_cmp_null = _gvn.transform( new CmpPNode(jobj, null()) );
3210   Node* test_jobj_eq_null  = _gvn.transform( new BoolNode(jobj_cmp_null, BoolTest::eq) );
3211 
3212   IfNode* iff_jobj_null =
3213     create_and_map_if(control(), test_jobj_eq_null, PROB_MIN, COUNT_UNKNOWN);
3214 
3215   enum { _normal_path = 1,
3216          _null_path = 2,
3217          PATH_LIMIT };
3218 
3219   RegionNode* result_rgn = new RegionNode(PATH_LIMIT);
3220   PhiNode*    result_val = new PhiNode(result_rgn, TypeInstPtr::BOTTOM);
3221 
3222   Node* jobj_is_null = _gvn.transform(new IfTrueNode(iff_jobj_null));
3223   result_rgn-&gt;init_req(_null_path, jobj_is_null);
3224   result_val-&gt;init_req(_null_path, null());
3225 
3226   Node* jobj_is_not_null = _gvn.transform(new IfFalseNode(iff_jobj_null));
3227   set_control(jobj_is_not_null);
3228   Node* res = access_load(jobj, TypeInstPtr::NOTNULL, T_OBJECT,
3229                           IN_NATIVE | C2_CONTROL_DEPENDENT_LOAD);
3230   result_rgn-&gt;init_req(_normal_path, control());
3231   result_val-&gt;init_req(_normal_path, res);
3232 
3233   set_result(result_rgn, result_val);
3234 
3235   return true;
3236 }
3237 
3238 #endif // JFR_HAVE_INTRINSICS
3239 
3240 //------------------------inline_native_currentThread------------------
3241 bool LibraryCallKit::inline_native_currentThread() {
3242   Node* junk = NULL;
3243   set_result(generate_current_thread(junk));
3244   return true;
3245 }
3246 
3247 //-----------------------load_klass_from_mirror_common-------------------------
3248 // Given a java mirror (a java.lang.Class oop), load its corresponding klass oop.
3249 // Test the klass oop for null (signifying a primitive Class like Integer.TYPE),
3250 // and branch to the given path on the region.
3251 // If never_see_null, take an uncommon trap on null, so we can optimistically
3252 // compile for the non-null case.
3253 // If the region is NULL, force never_see_null = true.
3254 Node* LibraryCallKit::load_klass_from_mirror_common(Node* mirror,
3255                                                     bool never_see_null,
3256                                                     RegionNode* region,
3257                                                     int null_path,
3258                                                     int offset) {
3259   if (region == NULL)  never_see_null = true;
3260   Node* p = basic_plus_adr(mirror, offset);
3261   const TypeKlassPtr*  kls_type = TypeKlassPtr::OBJECT_OR_NULL;
3262   Node* kls = _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), p, TypeRawPtr::BOTTOM, kls_type));
3263   Node* null_ctl = top();
3264   kls = null_check_oop(kls, &amp;null_ctl, never_see_null);
3265   if (region != NULL) {
3266     // Set region-&gt;in(null_path) if the mirror is a primitive (e.g, int.class).
3267     region-&gt;init_req(null_path, null_ctl);
3268   } else {
3269     assert(null_ctl == top(), &quot;no loose ends&quot;);
3270   }
3271   return kls;
3272 }
3273 
3274 //--------------------(inline_native_Class_query helpers)---------------------
3275 // Use this for JVM_ACC_INTERFACE, JVM_ACC_IS_CLONEABLE_FAST, JVM_ACC_HAS_FINALIZER.
3276 // Fall through if (mods &amp; mask) == bits, take the guard otherwise.
3277 Node* LibraryCallKit::generate_access_flags_guard(Node* kls, int modifier_mask, int modifier_bits, RegionNode* region) {
3278   // Branch around if the given klass has the given modifier bit set.
3279   // Like generate_guard, adds a new path onto the region.
3280   Node* modp = basic_plus_adr(kls, in_bytes(Klass::access_flags_offset()));
3281   Node* mods = make_load(NULL, modp, TypeInt::INT, T_INT, MemNode::unordered);
3282   Node* mask = intcon(modifier_mask);
3283   Node* bits = intcon(modifier_bits);
3284   Node* mbit = _gvn.transform(new AndINode(mods, mask));
3285   Node* cmp  = _gvn.transform(new CmpINode(mbit, bits));
3286   Node* bol  = _gvn.transform(new BoolNode(cmp, BoolTest::ne));
3287   return generate_fair_guard(bol, region);
3288 }
3289 
3290 Node* LibraryCallKit::generate_interface_guard(Node* kls, RegionNode* region) {
3291   return generate_access_flags_guard(kls, JVM_ACC_INTERFACE, 0, region);
3292 }
3293 
3294 Node* LibraryCallKit::generate_value_guard(Node* kls, RegionNode* region) {
3295   return generate_access_flags_guard(kls, JVM_ACC_VALUE, 0, region);
3296 }
3297 
3298 //-------------------------inline_native_Class_query-------------------
3299 bool LibraryCallKit::inline_native_Class_query(vmIntrinsics::ID id) {
3300   const Type* return_type = TypeInt::BOOL;
3301   Node* prim_return_value = top();  // what happens if it&#39;s a primitive class?
3302   bool never_see_null = !too_many_traps(Deoptimization::Reason_null_check);
3303   bool expect_prim = false;     // most of these guys expect to work on refs
3304 
3305   enum { _normal_path = 1, _prim_path = 2, PATH_LIMIT };
3306 
3307   Node* mirror = argument(0);
3308   Node* obj    = top();
3309 
3310   switch (id) {
3311   case vmIntrinsics::_isInstance:
3312     // nothing is an instance of a primitive type
3313     prim_return_value = intcon(0);
3314     obj = argument(1);
3315     break;
3316   case vmIntrinsics::_getModifiers:
3317     prim_return_value = intcon(JVM_ACC_ABSTRACT | JVM_ACC_FINAL | JVM_ACC_PUBLIC);
3318     assert(is_power_of_2((int)JVM_ACC_WRITTEN_FLAGS+1), &quot;change next line&quot;);
3319     return_type = TypeInt::make(0, JVM_ACC_WRITTEN_FLAGS, Type::WidenMin);
3320     break;
3321   case vmIntrinsics::_isInterface:
3322     prim_return_value = intcon(0);
3323     break;
3324   case vmIntrinsics::_isArray:
3325     prim_return_value = intcon(0);
3326     expect_prim = true;  // cf. ObjectStreamClass.getClassSignature
3327     break;
3328   case vmIntrinsics::_isPrimitive:
3329     prim_return_value = intcon(1);
3330     expect_prim = true;  // obviously
3331     break;
3332   case vmIntrinsics::_getSuperclass:
3333     prim_return_value = null();
3334     return_type = TypeInstPtr::MIRROR-&gt;cast_to_ptr_type(TypePtr::BotPTR);
3335     break;
3336   case vmIntrinsics::_getClassAccessFlags:
3337     prim_return_value = intcon(JVM_ACC_ABSTRACT | JVM_ACC_FINAL | JVM_ACC_PUBLIC);
3338     return_type = TypeInt::INT;  // not bool!  6297094
3339     break;
3340   default:
3341     fatal_unexpected_iid(id);
3342     break;
3343   }
3344 
3345   const TypeInstPtr* mirror_con = _gvn.type(mirror)-&gt;isa_instptr();
3346   if (mirror_con == NULL)  return false;  // cannot happen?
3347 
3348 #ifndef PRODUCT
3349   if (C-&gt;print_intrinsics() || C-&gt;print_inlining()) {
3350     ciType* k = mirror_con-&gt;java_mirror_type();
3351     if (k) {
3352       tty-&gt;print(&quot;Inlining %s on constant Class &quot;, vmIntrinsics::name_at(intrinsic_id()));
3353       k-&gt;print_name();
3354       tty-&gt;cr();
3355     }
3356   }
3357 #endif
3358 
3359   // Null-check the mirror, and the mirror&#39;s klass ptr (in case it is a primitive).
3360   RegionNode* region = new RegionNode(PATH_LIMIT);
3361   record_for_igvn(region);
3362   PhiNode* phi = new PhiNode(region, return_type);
3363 
3364   // The mirror will never be null of Reflection.getClassAccessFlags, however
3365   // it may be null for Class.isInstance or Class.getModifiers. Throw a NPE
3366   // if it is. See bug 4774291.
3367 
3368   // For Reflection.getClassAccessFlags(), the null check occurs in
3369   // the wrong place; see inline_unsafe_access(), above, for a similar
3370   // situation.
3371   mirror = null_check(mirror);
3372   // If mirror or obj is dead, only null-path is taken.
3373   if (stopped())  return true;
3374 
3375   if (expect_prim)  never_see_null = false;  // expect nulls (meaning prims)
3376 
3377   // Now load the mirror&#39;s klass metaobject, and null-check it.
3378   // Side-effects region with the control path if the klass is null.
3379   Node* kls = load_klass_from_mirror(mirror, never_see_null, region, _prim_path);
3380   // If kls is null, we have a primitive mirror.
3381   phi-&gt;init_req(_prim_path, prim_return_value);
3382   if (stopped()) { set_result(region, phi); return true; }
3383   bool safe_for_replace = (region-&gt;in(_prim_path) == top());
3384 
3385   Node* p;  // handy temp
3386   Node* null_ctl;
3387 
3388   // Now that we have the non-null klass, we can perform the real query.
3389   // For constant classes, the query will constant-fold in LoadNode::Value.
3390   Node* query_value = top();
3391   switch (id) {
3392   case vmIntrinsics::_isInstance:
3393     // nothing is an instance of a primitive type
3394     query_value = gen_instanceof(obj, kls, safe_for_replace);
3395     break;
3396 
3397   case vmIntrinsics::_getModifiers:
3398     p = basic_plus_adr(kls, in_bytes(Klass::modifier_flags_offset()));
3399     query_value = make_load(NULL, p, TypeInt::INT, T_INT, MemNode::unordered);
3400     break;
3401 
3402   case vmIntrinsics::_isInterface:
3403     // (To verify this code sequence, check the asserts in JVM_IsInterface.)
3404     if (generate_interface_guard(kls, region) != NULL)
3405       // A guard was added.  If the guard is taken, it was an interface.
3406       phi-&gt;add_req(intcon(1));
3407     // If we fall through, it&#39;s a plain class.
3408     query_value = intcon(0);
3409     break;
3410 
3411   case vmIntrinsics::_isArray:
3412     // (To verify this code sequence, check the asserts in JVM_IsArrayClass.)
3413     if (generate_array_guard(kls, region) != NULL)
3414       // A guard was added.  If the guard is taken, it was an array.
3415       phi-&gt;add_req(intcon(1));
3416     // If we fall through, it&#39;s a plain class.
3417     query_value = intcon(0);
3418     break;
3419 
3420   case vmIntrinsics::_isPrimitive:
3421     query_value = intcon(0); // &quot;normal&quot; path produces false
3422     break;
3423 
3424   case vmIntrinsics::_getSuperclass:
3425     // The rules here are somewhat unfortunate, but we can still do better
3426     // with random logic than with a JNI call.
3427     // Interfaces store null or Object as _super, but must report null.
3428     // Arrays store an intermediate super as _super, but must report Object.
3429     // Other types can report the actual _super.
3430     // (To verify this code sequence, check the asserts in JVM_IsInterface.)
3431     if (generate_interface_guard(kls, region) != NULL)
3432       // A guard was added.  If the guard is taken, it was an interface.
3433       phi-&gt;add_req(null());
3434     if (generate_array_guard(kls, region) != NULL)
3435       // A guard was added.  If the guard is taken, it was an array.
3436       phi-&gt;add_req(makecon(TypeInstPtr::make(env()-&gt;Object_klass()-&gt;java_mirror())));
3437     // If we fall through, it&#39;s a plain class.  Get its _super.
3438     p = basic_plus_adr(kls, in_bytes(Klass::super_offset()));
3439     kls = _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), p, TypeRawPtr::BOTTOM, TypeKlassPtr::OBJECT_OR_NULL));
3440     null_ctl = top();
3441     kls = null_check_oop(kls, &amp;null_ctl);
3442     if (null_ctl != top()) {
3443       // If the guard is taken, Object.superClass is null (both klass and mirror).
3444       region-&gt;add_req(null_ctl);
3445       phi   -&gt;add_req(null());
3446     }
3447     if (!stopped()) {
3448       query_value = load_mirror_from_klass(kls);
3449     }
3450     break;
3451 
3452   case vmIntrinsics::_getClassAccessFlags:
3453     p = basic_plus_adr(kls, in_bytes(Klass::access_flags_offset()));
3454     query_value = make_load(NULL, p, TypeInt::INT, T_INT, MemNode::unordered);
3455     break;
3456 
3457   default:
3458     fatal_unexpected_iid(id);
3459     break;
3460   }
3461 
3462   // Fall-through is the normal case of a query to a real class.
3463   phi-&gt;init_req(1, query_value);
3464   region-&gt;init_req(1, control());
3465 
3466   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
3467   set_result(region, phi);
3468   return true;
3469 }
3470 
3471 //-------------------------inline_Class_cast-------------------
3472 bool LibraryCallKit::inline_Class_cast() {
3473   Node* mirror = argument(0); // Class
3474   Node* obj    = argument(1);
3475   const TypeInstPtr* mirror_con = _gvn.type(mirror)-&gt;isa_instptr();
3476   if (mirror_con == NULL) {
3477     return false;  // dead path (mirror-&gt;is_top()).
3478   }
3479   if (obj == NULL || obj-&gt;is_top()) {
3480     return false;  // dead path
3481   }
3482   ciKlass* obj_klass = NULL;
3483   const Type* obj_t = _gvn.type(obj);
3484   if (obj-&gt;is_ValueType()) {
3485     obj_klass = obj_t-&gt;value_klass();
3486   } else if (obj_t-&gt;isa_oopptr()) {
3487     obj_klass = obj_t-&gt;is_oopptr()-&gt;klass();
3488   }
3489 
3490   // First, see if Class.cast() can be folded statically.
3491   // java_mirror_type() returns non-null for compile-time Class constants.
3492   ciType* tm = mirror_con-&gt;java_mirror_type();
3493   if (tm != NULL &amp;&amp; tm-&gt;is_klass() &amp;&amp; obj_klass != NULL) {
3494     if (!obj_klass-&gt;is_loaded()) {
3495       // Don&#39;t use intrinsic when class is not loaded.
3496       return false;
3497     } else {
3498       if (!obj-&gt;is_ValueType() &amp;&amp; tm-&gt;as_klass()-&gt;is_valuetype()) {
3499         // Casting to .val, check for null
3500         obj = null_check(obj);
3501         if (stopped()) {
3502           return true;
3503         }
3504       }
3505       int static_res = C-&gt;static_subtype_check(tm-&gt;as_klass(), obj_klass);
3506       if (static_res == Compile::SSC_always_true) {
3507         // isInstance() is true - fold the code.
3508         set_result(obj);
3509         return true;
3510       } else if (static_res == Compile::SSC_always_false) {
3511         // Don&#39;t use intrinsic, have to throw ClassCastException.
3512         // If the reference is null, the non-intrinsic bytecode will
3513         // be optimized appropriately.
3514         return false;
3515       }
3516     }
3517   }
3518 
3519   // Bailout intrinsic and do normal inlining if exception path is frequent.
3520   if (too_many_traps(Deoptimization::Reason_intrinsic)) {
3521     return false;
3522   }
3523 
3524   // Generate dynamic checks.
3525   // Class.cast() is java implementation of _checkcast bytecode.
3526   // Do checkcast (Parse::do_checkcast()) optimizations here.
3527 
3528   mirror = null_check(mirror);
3529   // If mirror is dead, only null-path is taken.
3530   if (stopped()) {
3531     return true;
3532   }
3533 
3534   // Not-subtype or the mirror&#39;s klass ptr is NULL (in case it is a primitive).
3535   enum { _bad_type_path = 1, _prim_path = 2, _npe_path = 3, PATH_LIMIT };
3536   RegionNode* region = new RegionNode(PATH_LIMIT);
3537   record_for_igvn(region);
3538 
3539   // Now load the mirror&#39;s klass metaobject, and null-check it.
3540   // If kls is null, we have a primitive mirror and
3541   // nothing is an instance of a primitive type.
3542   Node* kls = load_klass_from_mirror(mirror, false, region, _prim_path);
3543 
3544   Node* res = top();
3545   if (!stopped()) {
3546     if (EnableValhalla &amp;&amp; !obj-&gt;is_ValueType()) {
3547       // Check if we are casting to .val
3548       Node* is_val_kls = generate_value_guard(kls, NULL);
3549       if (is_val_kls != NULL) {
3550         RegionNode* r = new RegionNode(3);
3551         record_for_igvn(r);
3552         r-&gt;init_req(1, control());
3553 
3554         // Casting to .val, check for null
3555         set_control(is_val_kls);
3556         Node* null_ctr = top();
3557         null_check_oop(obj, &amp;null_ctr);
3558         region-&gt;init_req(_npe_path, null_ctr);
3559         r-&gt;init_req(2, control());
3560 
3561         set_control(_gvn.transform(r));
3562       }
3563     }
3564 
3565     Node* bad_type_ctrl = top();
3566     // Do checkcast optimizations.
3567     res = gen_checkcast(obj, kls, &amp;bad_type_ctrl);
3568     region-&gt;init_req(_bad_type_path, bad_type_ctrl);
3569   }
3570   if (region-&gt;in(_prim_path) != top() ||
3571       region-&gt;in(_bad_type_path) != top() ||
3572       region-&gt;in(_npe_path) != top()) {
3573     // Let Interpreter throw ClassCastException.
3574     PreserveJVMState pjvms(this);
3575     set_control(_gvn.transform(region));
3576     uncommon_trap(Deoptimization::Reason_intrinsic,
3577                   Deoptimization::Action_maybe_recompile);
3578   }
3579   if (!stopped()) {
3580     set_result(res);
3581   }
3582   return true;
3583 }
3584 
3585 
3586 //--------------------------inline_native_subtype_check------------------------
3587 // This intrinsic takes the JNI calls out of the heart of
3588 // UnsafeFieldAccessorImpl.set, which improves Field.set, readObject, etc.
3589 bool LibraryCallKit::inline_native_subtype_check() {
3590   // Pull both arguments off the stack.
3591   Node* args[2];                // two java.lang.Class mirrors: superc, subc
3592   args[0] = argument(0);
3593   args[1] = argument(1);
3594   Node* klasses[2];             // corresponding Klasses: superk, subk
3595   klasses[0] = klasses[1] = top();
3596 
3597   enum {
3598     // A full decision tree on {superc is prim, subc is prim}:
3599     _prim_0_path = 1,           // {P,N} =&gt; false
3600                                 // {P,P} &amp; superc!=subc =&gt; false
3601     _prim_same_path,            // {P,P} &amp; superc==subc =&gt; true
3602     _prim_1_path,               // {N,P} =&gt; false
3603     _ref_subtype_path,          // {N,N} &amp; subtype check wins =&gt; true
3604     _both_ref_path,             // {N,N} &amp; subtype check loses =&gt; false
3605     PATH_LIMIT
3606   };
3607 
3608   RegionNode* region = new RegionNode(PATH_LIMIT);
3609   RegionNode* prim_region = new RegionNode(2);
3610   Node*       phi    = new PhiNode(region, TypeInt::BOOL);
3611   record_for_igvn(region);
3612   record_for_igvn(prim_region);
3613 
3614   const TypePtr* adr_type = TypeRawPtr::BOTTOM;   // memory type of loads
3615   const TypeKlassPtr* kls_type = TypeKlassPtr::OBJECT_OR_NULL;
3616   int class_klass_offset = java_lang_Class::klass_offset_in_bytes();
3617 
3618   // First null-check both mirrors and load each mirror&#39;s klass metaobject.
3619   int which_arg;
3620   for (which_arg = 0; which_arg &lt;= 1; which_arg++) {
3621     Node* arg = args[which_arg];
3622     arg = null_check(arg);
3623     if (stopped())  break;
3624     args[which_arg] = arg;
3625 
3626     Node* p = basic_plus_adr(arg, class_klass_offset);
3627     Node* kls = LoadKlassNode::make(_gvn, NULL, immutable_memory(), p, adr_type, kls_type);
3628     klasses[which_arg] = _gvn.transform(kls);
3629   }
3630 
3631   // Having loaded both klasses, test each for null.
3632   bool never_see_null = !too_many_traps(Deoptimization::Reason_null_check);
3633   for (which_arg = 0; which_arg &lt;= 1; which_arg++) {
3634     Node* kls = klasses[which_arg];
3635     Node* null_ctl = top();
3636     kls = null_check_oop(kls, &amp;null_ctl, never_see_null);
3637     if (which_arg == 0) {
3638       prim_region-&gt;init_req(1, null_ctl);
3639     } else {
3640       region-&gt;init_req(_prim_1_path, null_ctl);
3641     }
3642     if (stopped())  break;
3643     klasses[which_arg] = kls;
3644   }
3645 
3646   if (!stopped()) {
3647     // now we have two reference types, in klasses[0..1]
3648     Node* subk   = klasses[1];  // the argument to isAssignableFrom
3649     Node* superk = klasses[0];  // the receiver
3650     region-&gt;set_req(_both_ref_path, gen_subtype_check(subk, superk));
3651     // now we have a successful reference subtype check
3652     region-&gt;set_req(_ref_subtype_path, control());
3653   }
3654 
3655   // If both operands are primitive (both klasses null), then
3656   // we must return true when they are identical primitives.
3657   // It is convenient to test this after the first null klass check.
3658   // This path is also used if superc is a value mirror.
3659   set_control(_gvn.transform(prim_region));
3660   if (!stopped()) {
3661     // Since superc is primitive, make a guard for the superc==subc case.
3662     Node* cmp_eq = _gvn.transform(new CmpPNode(args[0], args[1]));
3663     Node* bol_eq = _gvn.transform(new BoolNode(cmp_eq, BoolTest::eq));
3664     generate_fair_guard(bol_eq, region);
3665     if (region-&gt;req() == PATH_LIMIT+1) {
3666       // A guard was added.  If the added guard is taken, superc==subc.
3667       region-&gt;swap_edges(PATH_LIMIT, _prim_same_path);
3668       region-&gt;del_req(PATH_LIMIT);
3669     }
3670     region-&gt;set_req(_prim_0_path, control()); // Not equal after all.
3671   }
3672 
3673   // these are the only paths that produce &#39;true&#39;:
3674   phi-&gt;set_req(_prim_same_path,   intcon(1));
3675   phi-&gt;set_req(_ref_subtype_path, intcon(1));
3676 
3677   // pull together the cases:
3678   assert(region-&gt;req() == PATH_LIMIT, &quot;sane region&quot;);
3679   for (uint i = 1; i &lt; region-&gt;req(); i++) {
3680     Node* ctl = region-&gt;in(i);
3681     if (ctl == NULL || ctl == top()) {
3682       region-&gt;set_req(i, top());
3683       phi   -&gt;set_req(i, top());
3684     } else if (phi-&gt;in(i) == NULL) {
3685       phi-&gt;set_req(i, intcon(0)); // all other paths produce &#39;false&#39;
3686     }
3687   }
3688 
3689   set_control(_gvn.transform(region));
3690   set_result(_gvn.transform(phi));
3691   return true;
3692 }
3693 
3694 //---------------------generate_array_guard_common------------------------
3695 Node* LibraryCallKit::generate_array_guard_common(Node* kls, RegionNode* region, ArrayKind kind) {
3696 
3697   if (stopped()) {
3698     return NULL;
3699   }
3700 
3701   // Like generate_guard, adds a new path onto the region.
3702   jint  layout_con = 0;
3703   Node* layout_val = get_layout_helper(kls, layout_con);
3704   if (layout_val == NULL) {
3705     bool query = 0;
3706     switch(kind) {
3707       case ObjectArray:    query = Klass::layout_helper_is_objArray(layout_con); break;
3708       case NonObjectArray: query = !Klass::layout_helper_is_objArray(layout_con); break;
3709       case TypeArray:      query = Klass::layout_helper_is_typeArray(layout_con); break;
3710       case ValueArray:     query = Klass::layout_helper_is_valueArray(layout_con); break;
3711       case AnyArray:       query = Klass::layout_helper_is_array(layout_con); break;
3712       case NonArray:       query = !Klass::layout_helper_is_array(layout_con); break;
3713       default:
3714         ShouldNotReachHere();
3715     }
3716     if (!query) {
3717       return NULL;                       // never a branch
3718     } else {                             // always a branch
3719       Node* always_branch = control();
3720       if (region != NULL)
3721         region-&gt;add_req(always_branch);
3722       set_control(top());
3723       return always_branch;
3724     }
3725   }
3726   unsigned int value = 0;
3727   BoolTest::mask btest = BoolTest::illegal;
3728   switch(kind) {
3729     case ObjectArray:
3730     case NonObjectArray: {
3731       value = Klass::_lh_array_tag_obj_value;
3732       layout_val = _gvn.transform(new RShiftINode(layout_val, intcon(Klass::_lh_array_tag_shift)));
3733       btest = kind == ObjectArray ? BoolTest::eq : BoolTest::ne;
3734       break;
3735     }
3736     case TypeArray: {
3737       value = Klass::_lh_array_tag_type_value;
3738       layout_val = _gvn.transform(new RShiftINode(layout_val, intcon(Klass::_lh_array_tag_shift)));
3739       btest = BoolTest::eq;
3740       break;
3741     }
3742     case ValueArray: {
3743       value = Klass::_lh_array_tag_vt_value;
3744       layout_val = _gvn.transform(new RShiftINode(layout_val, intcon(Klass::_lh_array_tag_shift)));
3745       btest = BoolTest::eq;
3746       break;
3747     }
3748     case AnyArray:    value = Klass::_lh_neutral_value; btest = BoolTest::lt; break;
3749     case NonArray:    value = Klass::_lh_neutral_value; btest = BoolTest::gt; break;
3750     default:
3751       ShouldNotReachHere();
3752   }
3753   // Now test the correct condition.
3754   jint nval = (jint)value;
3755   Node* cmp = _gvn.transform(new CmpINode(layout_val, intcon(nval)));
3756   Node* bol = _gvn.transform(new BoolNode(cmp, btest));
3757   return generate_fair_guard(bol, region);
3758 }
3759 
3760 
3761 //-----------------------inline_native_newArray--------------------------
3762 // private static native Object java.lang.reflect.Array.newArray(Class&lt;?&gt; componentType, int length);
3763 // private        native Object Unsafe.allocateUninitializedArray0(Class&lt;?&gt; cls, int size);
3764 bool LibraryCallKit::inline_unsafe_newArray(bool uninitialized) {
3765   Node* mirror;
3766   Node* count_val;
3767   if (uninitialized) {
3768     mirror    = argument(1);
3769     count_val = argument(2);
3770   } else {
3771     mirror    = argument(0);
3772     count_val = argument(1);
3773   }
3774 
3775   mirror = null_check(mirror);
3776   // If mirror or obj is dead, only null-path is taken.
3777   if (stopped())  return true;
3778 
3779   enum { _normal_path = 1, _slow_path = 2, PATH_LIMIT };
3780   RegionNode* result_reg = new RegionNode(PATH_LIMIT);
3781   PhiNode*    result_val = new PhiNode(result_reg, TypeInstPtr::NOTNULL);
3782   PhiNode*    result_io  = new PhiNode(result_reg, Type::ABIO);
3783   PhiNode*    result_mem = new PhiNode(result_reg, Type::MEMORY, TypePtr::BOTTOM);
3784 
3785   bool never_see_null = !too_many_traps(Deoptimization::Reason_null_check);
3786   Node* klass_node = load_array_klass_from_mirror(mirror, never_see_null,
3787                                                   result_reg, _slow_path);
3788   Node* normal_ctl   = control();
3789   Node* no_array_ctl = result_reg-&gt;in(_slow_path);
3790 
3791   // Generate code for the slow case.  We make a call to newArray().
3792   set_control(no_array_ctl);
3793   if (!stopped()) {
3794     // Either the input type is void.class, or else the
3795     // array klass has not yet been cached.  Either the
3796     // ensuing call will throw an exception, or else it
3797     // will cache the array klass for next time.
3798     PreserveJVMState pjvms(this);
3799     CallJavaNode* slow_call = generate_method_call_static(vmIntrinsics::_newArray);
3800     Node* slow_result = set_results_for_java_call(slow_call);
3801     // this-&gt;control() comes from set_results_for_java_call
3802     result_reg-&gt;set_req(_slow_path, control());
3803     result_val-&gt;set_req(_slow_path, slow_result);
3804     result_io -&gt;set_req(_slow_path, i_o());
3805     result_mem-&gt;set_req(_slow_path, reset_memory());
3806   }
3807 
3808   set_control(normal_ctl);
3809   if (!stopped()) {
3810     // Normal case:  The array type has been cached in the java.lang.Class.
3811     // The following call works fine even if the array type is polymorphic.
3812     // It could be a dynamic mix of int[], boolean[], Object[], etc.
3813     Node* obj = new_array(klass_node, count_val, 0);  // no arguments to push
3814     result_reg-&gt;init_req(_normal_path, control());
3815     result_val-&gt;init_req(_normal_path, obj);
3816     result_io -&gt;init_req(_normal_path, i_o());
3817     result_mem-&gt;init_req(_normal_path, reset_memory());
3818 
3819     if (uninitialized) {
3820       // Mark the allocation so that zeroing is skipped
3821       AllocateArrayNode* alloc = AllocateArrayNode::Ideal_array_allocation(obj, &amp;_gvn);
3822       alloc-&gt;maybe_set_complete(&amp;_gvn);
3823     }
3824   }
3825 
3826   // Return the combined state.
3827   set_i_o(        _gvn.transform(result_io)  );
3828   set_all_memory( _gvn.transform(result_mem));
3829 
3830   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
3831   set_result(result_reg, result_val);
3832   return true;
3833 }
3834 
3835 //----------------------inline_native_getLength--------------------------
3836 // public static native int java.lang.reflect.Array.getLength(Object array);
3837 bool LibraryCallKit::inline_native_getLength() {
3838   if (too_many_traps(Deoptimization::Reason_intrinsic))  return false;
3839 
3840   Node* array = null_check(argument(0));
3841   // If array is dead, only null-path is taken.
3842   if (stopped())  return true;
3843 
3844   // Deoptimize if it is a non-array.
3845   Node* non_array = generate_non_array_guard(load_object_klass(array), NULL);
3846 
3847   if (non_array != NULL) {
3848     PreserveJVMState pjvms(this);
3849     set_control(non_array);
3850     uncommon_trap(Deoptimization::Reason_intrinsic,
3851                   Deoptimization::Action_maybe_recompile);
3852   }
3853 
3854   // If control is dead, only non-array-path is taken.
3855   if (stopped())  return true;
3856 
3857   // The works fine even if the array type is polymorphic.
3858   // It could be a dynamic mix of int[], boolean[], Object[], etc.
3859   Node* result = load_array_length(array);
3860 
3861   C-&gt;set_has_split_ifs(true);  // Has chance for split-if optimization
3862   set_result(result);
3863   return true;
3864 }
3865 
3866 //------------------------inline_array_copyOf----------------------------
3867 // public static &lt;T,U&gt; T[] java.util.Arrays.copyOf(     U[] original, int newLength,         Class&lt;? extends T[]&gt; newType);
3868 // public static &lt;T,U&gt; T[] java.util.Arrays.copyOfRange(U[] original, int from,      int to, Class&lt;? extends T[]&gt; newType);
3869 bool LibraryCallKit::inline_array_copyOf(bool is_copyOfRange) {
3870   if (too_many_traps(Deoptimization::Reason_intrinsic))  return false;
3871 
3872   // Get the arguments.
3873   Node* original          = argument(0);
3874   Node* start             = is_copyOfRange? argument(1): intcon(0);
3875   Node* end               = is_copyOfRange? argument(2): argument(1);
3876   Node* array_type_mirror = is_copyOfRange? argument(3): argument(2);
3877 
3878   const TypeAryPtr* original_t = _gvn.type(original)-&gt;isa_aryptr();
3879   const TypeInstPtr* mirror_t = _gvn.type(array_type_mirror)-&gt;isa_instptr();
3880   if (EnableValhalla &amp;&amp; ValueArrayFlatten &amp;&amp;
3881       (original_t == NULL || mirror_t == NULL ||
3882        (mirror_t-&gt;java_mirror_type() == NULL &amp;&amp;
3883         (original_t-&gt;elem()-&gt;isa_valuetype() ||
3884          (original_t-&gt;elem()-&gt;make_oopptr() != NULL &amp;&amp;
3885           original_t-&gt;elem()-&gt;make_oopptr()-&gt;can_be_value_type()))))) {
3886     // We need to know statically if the copy is to a flattened array
3887     // or not but can&#39;t tell.
3888     return false;
3889   }
3890 
3891   Node* newcopy = NULL;
3892 
3893   // Set the original stack and the reexecute bit for the interpreter to reexecute
3894   // the bytecode that invokes Arrays.copyOf if deoptimization happens.
3895   { PreserveReexecuteState preexecs(this);
3896     jvms()-&gt;set_should_reexecute(true);
3897 
3898     array_type_mirror = null_check(array_type_mirror);
3899     original          = null_check(original);
3900 
3901     // Check if a null path was taken unconditionally.
3902     if (stopped())  return true;
3903 
3904     Node* orig_length = load_array_length(original);
3905 
3906     Node* klass_node = load_klass_from_mirror(array_type_mirror, false, NULL, 0);
3907     klass_node = null_check(klass_node);
3908 
3909     RegionNode* bailout = new RegionNode(1);
3910     record_for_igvn(bailout);
3911 
3912     // Despite the generic type of Arrays.copyOf, the mirror might be int, int[], etc.
3913     // Bail out if that is so.
3914     // Value type array may have object field that would require a
3915     // write barrier. Conservatively, go to slow path.
3916     BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
3917     Node* not_objArray = !bs-&gt;array_copy_requires_gc_barriers(false, T_OBJECT, false, BarrierSetC2::Parsing) ?
3918         generate_typeArray_guard(klass_node, bailout) : generate_non_objArray_guard(klass_node, bailout);
3919     if (not_objArray != NULL) {
3920       // Improve the klass node&#39;s type from the new optimistic assumption:
3921       ciKlass* ak = ciArrayKlass::make(env()-&gt;Object_klass());
3922       const Type* akls = TypeKlassPtr::make(TypePtr::NotNull, ak, Type::Offset(0), false);
3923       Node* cast = new CastPPNode(klass_node, akls);
3924       cast-&gt;init_req(0, control());
3925       klass_node = _gvn.transform(cast);
3926     }
3927 
3928     Node* original_kls = load_object_klass(original);
3929     // ArrayCopyNode:Ideal may transform the ArrayCopyNode to
3930     // loads/stores but it is legal only if we&#39;re sure the
3931     // Arrays.copyOf would succeed. So we need all input arguments
3932     // to the copyOf to be validated, including that the copy to the
3933     // new array won&#39;t trigger an ArrayStoreException. That subtype
3934     // check can be optimized if we know something on the type of
3935     // the input array from type speculation.
3936     if (_gvn.type(klass_node)-&gt;singleton() &amp;&amp; !stopped()) {
3937       ciKlass* subk   = _gvn.type(original_kls)-&gt;is_klassptr()-&gt;klass();
3938       ciKlass* superk = _gvn.type(klass_node)-&gt;is_klassptr()-&gt;klass();
3939 
3940       int test = C-&gt;static_subtype_check(superk, subk);
3941       if (test != Compile::SSC_always_true &amp;&amp; test != Compile::SSC_always_false) {
3942         const TypeOopPtr* t_original = _gvn.type(original)-&gt;is_oopptr();
3943         if (t_original-&gt;speculative_type() != NULL) {
3944           original = maybe_cast_profiled_obj(original, t_original-&gt;speculative_type(), true);
3945           original_kls = load_object_klass(original);
3946         }
3947       }
3948     }
3949 
3950     if (ValueArrayFlatten) {
3951       // Either both or neither new array klass and original array
3952       // klass must be flattened
3953       Node* is_flat = generate_valueArray_guard(klass_node, NULL);
3954       if (!original_t-&gt;is_not_flat()) {
3955         generate_valueArray_guard(original_kls, bailout);
3956       }
3957       if (is_flat != NULL) {
3958         RegionNode* r = new RegionNode(2);
3959         record_for_igvn(r);
3960         r-&gt;init_req(1, control());
3961         set_control(is_flat);
3962         if (!original_t-&gt;is_not_flat()) {
3963           generate_valueArray_guard(original_kls, r);
3964         }
3965         bailout-&gt;add_req(control());
3966         set_control(_gvn.transform(r));
3967       }
3968     }
3969 
3970     // Bail out if either start or end is negative.
3971     generate_negative_guard(start, bailout, &amp;start);
3972     generate_negative_guard(end,   bailout, &amp;end);
3973 
3974     Node* length = end;
3975     if (_gvn.type(start) != TypeInt::ZERO) {
3976       length = _gvn.transform(new SubINode(end, start));
3977     }
3978 
3979     // Bail out if length is negative.
3980     // Without this the new_array would throw
3981     // NegativeArraySizeException but IllegalArgumentException is what
3982     // should be thrown
3983     generate_negative_guard(length, bailout, &amp;length);
3984 
3985     if (bailout-&gt;req() &gt; 1) {
3986       PreserveJVMState pjvms(this);
3987       set_control(_gvn.transform(bailout));
3988       uncommon_trap(Deoptimization::Reason_intrinsic,
3989                     Deoptimization::Action_maybe_recompile);
3990     }
3991 
3992     if (!stopped()) {
3993       // How many elements will we copy from the original?
3994       // The answer is MinI(orig_length - start, length).
3995       Node* orig_tail = _gvn.transform(new SubINode(orig_length, start));
3996       Node* moved = generate_min_max(vmIntrinsics::_min, orig_tail, length);
3997 
3998       // Generate a direct call to the right arraycopy function(s).
3999       // We know the copy is disjoint but we might not know if the
4000       // oop stores need checking.
4001       // Extreme case:  Arrays.copyOf((Integer[])x, 10, String[].class).
4002       // This will fail a store-check if x contains any non-nulls.
4003 
4004       bool validated = false;
4005       // Reason_class_check rather than Reason_intrinsic because we
4006       // want to intrinsify even if this traps.
4007       if (!too_many_traps(Deoptimization::Reason_class_check)) {
4008         Node* not_subtype_ctrl = gen_subtype_check(original, klass_node);
4009 
4010         if (not_subtype_ctrl != top()) {
4011           PreserveJVMState pjvms(this);
4012           set_control(not_subtype_ctrl);
4013           uncommon_trap(Deoptimization::Reason_class_check,
4014                         Deoptimization::Action_make_not_entrant);
4015           assert(stopped(), &quot;Should be stopped&quot;);
4016         }
4017         validated = true;
4018       }
4019 
4020       if (!stopped()) {
4021         newcopy = new_array(klass_node, length, 0);  // no arguments to push
4022 
4023         ArrayCopyNode* ac = ArrayCopyNode::make(this, true, original, start, newcopy, intcon(0), moved, true, false,
4024                                                 original_kls, klass_node);
4025         if (!is_copyOfRange) {
4026           ac-&gt;set_copyof(validated);
4027         } else {
4028           ac-&gt;set_copyofrange(validated);
4029         }
4030         Node* n = _gvn.transform(ac);
4031         if (n == ac) {
4032           ac-&gt;connect_outputs(this);
4033         } else {
4034           assert(validated, &quot;shouldn&#39;t transform if all arguments not validated&quot;);
4035           set_all_memory(n);
4036         }
4037       }
4038     }
4039   } // original reexecute is set back here
4040 
4041   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
4042   if (!stopped()) {
4043     set_result(newcopy);
4044   }
4045   return true;
4046 }
4047 
4048 
4049 //----------------------generate_virtual_guard---------------------------
4050 // Helper for hashCode and clone.  Peeks inside the vtable to avoid a call.
4051 Node* LibraryCallKit::generate_virtual_guard(Node* obj_klass,
4052                                              RegionNode* slow_region) {
4053   ciMethod* method = callee();
4054   int vtable_index = method-&gt;vtable_index();
4055   assert(vtable_index &gt;= 0 || vtable_index == Method::nonvirtual_vtable_index,
4056          &quot;bad index %d&quot;, vtable_index);
4057   // Get the Method* out of the appropriate vtable entry.
4058   int entry_offset  = in_bytes(Klass::vtable_start_offset()) +
4059                      vtable_index*vtableEntry::size_in_bytes() +
4060                      vtableEntry::method_offset_in_bytes();
4061   Node* entry_addr  = basic_plus_adr(obj_klass, entry_offset);
4062   Node* target_call = make_load(NULL, entry_addr, TypePtr::NOTNULL, T_ADDRESS, MemNode::unordered);
4063 
4064   // Compare the target method with the expected method (e.g., Object.hashCode).
4065   const TypePtr* native_call_addr = TypeMetadataPtr::make(method);
4066 
4067   Node* native_call = makecon(native_call_addr);
4068   Node* chk_native  = _gvn.transform(new CmpPNode(target_call, native_call));
4069   Node* test_native = _gvn.transform(new BoolNode(chk_native, BoolTest::ne));
4070 
4071   return generate_slow_guard(test_native, slow_region);
4072 }
4073 
4074 //-----------------------generate_method_call----------------------------
4075 // Use generate_method_call to make a slow-call to the real
4076 // method if the fast path fails.  An alternative would be to
4077 // use a stub like OptoRuntime::slow_arraycopy_Java.
4078 // This only works for expanding the current library call,
4079 // not another intrinsic.  (E.g., don&#39;t use this for making an
4080 // arraycopy call inside of the copyOf intrinsic.)
4081 CallJavaNode*
4082 LibraryCallKit::generate_method_call(vmIntrinsics::ID method_id, bool is_virtual, bool is_static) {
4083   // When compiling the intrinsic method itself, do not use this technique.
4084   guarantee(callee() != C-&gt;method(), &quot;cannot make slow-call to self&quot;);
4085 
4086   ciMethod* method = callee();
4087   // ensure the JVMS we have will be correct for this call
4088   guarantee(method_id == method-&gt;intrinsic_id(), &quot;must match&quot;);
4089 
4090   const TypeFunc* tf = TypeFunc::make(method);
4091   CallJavaNode* slow_call;
4092   if (is_static) {
4093     assert(!is_virtual, &quot;&quot;);
4094     slow_call = new CallStaticJavaNode(C, tf,
4095                            SharedRuntime::get_resolve_static_call_stub(),
4096                            method, bci());
4097   } else if (is_virtual) {
4098     null_check_receiver();
4099     int vtable_index = Method::invalid_vtable_index;
4100     if (UseInlineCaches) {
4101       // Suppress the vtable call
4102     } else {
4103       // hashCode and clone are not a miranda methods,
4104       // so the vtable index is fixed.
4105       // No need to use the linkResolver to get it.
4106        vtable_index = method-&gt;vtable_index();
4107        assert(vtable_index &gt;= 0 || vtable_index == Method::nonvirtual_vtable_index,
4108               &quot;bad index %d&quot;, vtable_index);
4109     }
4110     slow_call = new CallDynamicJavaNode(tf,
4111                           SharedRuntime::get_resolve_virtual_call_stub(),
4112                           method, vtable_index, bci());
4113   } else {  // neither virtual nor static:  opt_virtual
4114     null_check_receiver();
4115     slow_call = new CallStaticJavaNode(C, tf,
4116                                 SharedRuntime::get_resolve_opt_virtual_call_stub(),
4117                                 method, bci());
4118     slow_call-&gt;set_optimized_virtual(true);
4119   }
4120   if (CallGenerator::is_inlined_method_handle_intrinsic(this-&gt;method(), bci(), callee())) {
4121     // To be able to issue a direct call (optimized virtual or virtual)
4122     // and skip a call to MH.linkTo*/invokeBasic adapter, additional information
4123     // about the method being invoked should be attached to the call site to
4124     // make resolution logic work (see SharedRuntime::resolve_{virtual,opt_virtual}_call_C).
4125     slow_call-&gt;set_override_symbolic_info(true);
4126   }
4127   set_arguments_for_java_call(slow_call);
4128   set_edges_for_java_call(slow_call);
4129   return slow_call;
4130 }
4131 
4132 
4133 /**
4134  * Build special case code for calls to hashCode on an object. This call may
4135  * be virtual (invokevirtual) or bound (invokespecial). For each case we generate
4136  * slightly different code.
4137  */
4138 bool LibraryCallKit::inline_native_hashcode(bool is_virtual, bool is_static) {
4139   assert(is_static == callee()-&gt;is_static(), &quot;correct intrinsic selection&quot;);
4140   assert(!(is_virtual &amp;&amp; is_static), &quot;either virtual, special, or static&quot;);
4141 
4142   enum { _slow_path = 1, _fast_path, _null_path, PATH_LIMIT };
4143 
4144   RegionNode* result_reg = new RegionNode(PATH_LIMIT);
4145   PhiNode*    result_val = new PhiNode(result_reg, TypeInt::INT);
4146   PhiNode*    result_io  = new PhiNode(result_reg, Type::ABIO);
4147   PhiNode*    result_mem = new PhiNode(result_reg, Type::MEMORY, TypePtr::BOTTOM);
4148   Node* obj = argument(0);
4149 
4150   if (obj-&gt;is_ValueType() || gvn().type(obj)-&gt;is_valuetypeptr()) {
4151     return false;
4152   }
4153 
4154   if (!is_static) {
4155     // Check for hashing null object
4156     obj = null_check_receiver();
4157     if (stopped())  return true;        // unconditionally null
4158     result_reg-&gt;init_req(_null_path, top());
4159     result_val-&gt;init_req(_null_path, top());
4160   } else {
4161     // Do a null check, and return zero if null.
4162     // System.identityHashCode(null) == 0
4163     Node* null_ctl = top();
4164     obj = null_check_oop(obj, &amp;null_ctl);
4165     result_reg-&gt;init_req(_null_path, null_ctl);
4166     result_val-&gt;init_req(_null_path, _gvn.intcon(0));
4167   }
4168 
4169   // Unconditionally null?  Then return right away.
4170   if (stopped()) {
4171     set_control( result_reg-&gt;in(_null_path));
4172     if (!stopped())
4173       set_result(result_val-&gt;in(_null_path));
4174     return true;
4175   }
4176 
4177   // We only go to the fast case code if we pass a number of guards.  The
4178   // paths which do not pass are accumulated in the slow_region.
4179   RegionNode* slow_region = new RegionNode(1);
4180   record_for_igvn(slow_region);
4181 
4182   // If this is a virtual call, we generate a funny guard.  We pull out
4183   // the vtable entry corresponding to hashCode() from the target object.
4184   // If the target method which we are calling happens to be the native
4185   // Object hashCode() method, we pass the guard.  We do not need this
4186   // guard for non-virtual calls -- the caller is known to be the native
4187   // Object hashCode().
4188   if (is_virtual) {
4189     // After null check, get the object&#39;s klass.
4190     Node* obj_klass = load_object_klass(obj);
4191     generate_virtual_guard(obj_klass, slow_region);
4192   }
4193 
4194   // Get the header out of the object, use LoadMarkNode when available
4195   Node* header_addr = basic_plus_adr(obj, oopDesc::mark_offset_in_bytes());
4196   // The control of the load must be NULL. Otherwise, the load can move before
4197   // the null check after castPP removal.
4198   Node* no_ctrl = NULL;
4199   Node* header = make_load(no_ctrl, header_addr, TypeX_X, TypeX_X-&gt;basic_type(), MemNode::unordered);
4200 
4201   // Test the header to see if it is unlocked.
4202   // This also serves as guard against value types (they have the always_locked_pattern set).
4203   Node *lock_mask      = _gvn.MakeConX(markWord::biased_lock_mask_in_place);
4204   Node *lmasked_header = _gvn.transform(new AndXNode(header, lock_mask));
4205   Node *unlocked_val   = _gvn.MakeConX(markWord::unlocked_value);
4206   Node *chk_unlocked   = _gvn.transform(new CmpXNode( lmasked_header, unlocked_val));
4207   Node *test_unlocked  = _gvn.transform(new BoolNode( chk_unlocked, BoolTest::ne));
4208 
4209   generate_slow_guard(test_unlocked, slow_region);
4210 
4211   // Get the hash value and check to see that it has been properly assigned.
4212   // We depend on hash_mask being at most 32 bits and avoid the use of
4213   // hash_mask_in_place because it could be larger than 32 bits in a 64-bit
4214   // vm: see markWord.hpp.
4215   Node *hash_mask      = _gvn.intcon(markWord::hash_mask);
4216   Node *hash_shift     = _gvn.intcon(markWord::hash_shift);
4217   Node *hshifted_header= _gvn.transform(new URShiftXNode(header, hash_shift));
4218   // This hack lets the hash bits live anywhere in the mark object now, as long
4219   // as the shift drops the relevant bits into the low 32 bits.  Note that
4220   // Java spec says that HashCode is an int so there&#39;s no point in capturing
4221   // an &#39;X&#39;-sized hashcode (32 in 32-bit build or 64 in 64-bit build).
4222   hshifted_header      = ConvX2I(hshifted_header);
4223   Node *hash_val       = _gvn.transform(new AndINode(hshifted_header, hash_mask));
4224 
4225   Node *no_hash_val    = _gvn.intcon(markWord::no_hash);
4226   Node *chk_assigned   = _gvn.transform(new CmpINode( hash_val, no_hash_val));
4227   Node *test_assigned  = _gvn.transform(new BoolNode( chk_assigned, BoolTest::eq));
4228 
4229   generate_slow_guard(test_assigned, slow_region);
4230 
4231   Node* init_mem = reset_memory();
4232   // fill in the rest of the null path:
4233   result_io -&gt;init_req(_null_path, i_o());
4234   result_mem-&gt;init_req(_null_path, init_mem);
4235 
4236   result_val-&gt;init_req(_fast_path, hash_val);
4237   result_reg-&gt;init_req(_fast_path, control());
4238   result_io -&gt;init_req(_fast_path, i_o());
4239   result_mem-&gt;init_req(_fast_path, init_mem);
4240 
4241   // Generate code for the slow case.  We make a call to hashCode().
4242   set_control(_gvn.transform(slow_region));
4243   if (!stopped()) {
4244     // No need for PreserveJVMState, because we&#39;re using up the present state.
4245     set_all_memory(init_mem);
4246     vmIntrinsics::ID hashCode_id = is_static ? vmIntrinsics::_identityHashCode : vmIntrinsics::_hashCode;
4247     CallJavaNode* slow_call = generate_method_call(hashCode_id, is_virtual, is_static);
4248     Node* slow_result = set_results_for_java_call(slow_call);
4249     // this-&gt;control() comes from set_results_for_java_call
4250     result_reg-&gt;init_req(_slow_path, control());
4251     result_val-&gt;init_req(_slow_path, slow_result);
4252     result_io  -&gt;set_req(_slow_path, i_o());
4253     result_mem -&gt;set_req(_slow_path, reset_memory());
4254   }
4255 
4256   // Return the combined state.
4257   set_i_o(        _gvn.transform(result_io)  );
4258   set_all_memory( _gvn.transform(result_mem));
4259 
4260   set_result(result_reg, result_val);
4261   return true;
4262 }
4263 
4264 //---------------------------inline_native_getClass----------------------------
4265 // public final native Class&lt;?&gt; java.lang.Object.getClass();
4266 //
4267 // Build special case code for calls to getClass on an object.
4268 bool LibraryCallKit::inline_native_getClass() {
4269   Node* obj = argument(0);
4270   if (obj-&gt;is_ValueType()) {
4271     ciKlass* vk = _gvn.type(obj)-&gt;value_klass();
4272     set_result(makecon(TypeInstPtr::make(vk-&gt;java_mirror())));
4273     return true;
4274   }
4275   obj = null_check_receiver();
4276   if (stopped())  return true;
4277   set_result(load_mirror_from_klass(load_object_klass(obj)));
4278   return true;
4279 }
4280 
4281 //-----------------inline_native_Reflection_getCallerClass---------------------
4282 // public static native Class&lt;?&gt; sun.reflect.Reflection.getCallerClass();
4283 //
4284 // In the presence of deep enough inlining, getCallerClass() becomes a no-op.
4285 //
4286 // NOTE: This code must perform the same logic as JVM_GetCallerClass
4287 // in that it must skip particular security frames and checks for
4288 // caller sensitive methods.
4289 bool LibraryCallKit::inline_native_Reflection_getCallerClass() {
4290 #ifndef PRODUCT
4291   if ((C-&gt;print_intrinsics() || C-&gt;print_inlining()) &amp;&amp; Verbose) {
4292     tty-&gt;print_cr(&quot;Attempting to inline sun.reflect.Reflection.getCallerClass&quot;);
4293   }
4294 #endif
4295 
4296   if (!jvms()-&gt;has_method()) {
4297 #ifndef PRODUCT
4298     if ((C-&gt;print_intrinsics() || C-&gt;print_inlining()) &amp;&amp; Verbose) {
4299       tty-&gt;print_cr(&quot;  Bailing out because intrinsic was inlined at top level&quot;);
4300     }
4301 #endif
4302     return false;
4303   }
4304 
4305   // Walk back up the JVM state to find the caller at the required
4306   // depth.
4307   JVMState* caller_jvms = jvms();
4308 
4309   // Cf. JVM_GetCallerClass
4310   // NOTE: Start the loop at depth 1 because the current JVM state does
4311   // not include the Reflection.getCallerClass() frame.
4312   for (int n = 1; caller_jvms != NULL; caller_jvms = caller_jvms-&gt;caller(), n++) {
4313     ciMethod* m = caller_jvms-&gt;method();
4314     switch (n) {
4315     case 0:
4316       fatal(&quot;current JVM state does not include the Reflection.getCallerClass frame&quot;);
4317       break;
4318     case 1:
4319       // Frame 0 and 1 must be caller sensitive (see JVM_GetCallerClass).
4320       if (!m-&gt;caller_sensitive()) {
4321 #ifndef PRODUCT
4322         if ((C-&gt;print_intrinsics() || C-&gt;print_inlining()) &amp;&amp; Verbose) {
4323           tty-&gt;print_cr(&quot;  Bailing out: CallerSensitive annotation expected at frame %d&quot;, n);
4324         }
4325 #endif
4326         return false;  // bail-out; let JVM_GetCallerClass do the work
4327       }
4328       break;
4329     default:
4330       if (!m-&gt;is_ignored_by_security_stack_walk()) {
4331         // We have reached the desired frame; return the holder class.
4332         // Acquire method holder as java.lang.Class and push as constant.
4333         ciInstanceKlass* caller_klass = caller_jvms-&gt;method()-&gt;holder();
4334         ciInstance* caller_mirror = caller_klass-&gt;java_mirror();
4335         set_result(makecon(TypeInstPtr::make(caller_mirror)));
4336 
4337 #ifndef PRODUCT
4338         if ((C-&gt;print_intrinsics() || C-&gt;print_inlining()) &amp;&amp; Verbose) {
4339           tty-&gt;print_cr(&quot;  Succeeded: caller = %d) %s.%s, JVMS depth = %d&quot;, n, caller_klass-&gt;name()-&gt;as_utf8(), caller_jvms-&gt;method()-&gt;name()-&gt;as_utf8(), jvms()-&gt;depth());
4340           tty-&gt;print_cr(&quot;  JVM state at this point:&quot;);
4341           for (int i = jvms()-&gt;depth(), n = 1; i &gt;= 1; i--, n++) {
4342             ciMethod* m = jvms()-&gt;of_depth(i)-&gt;method();
4343             tty-&gt;print_cr(&quot;   %d) %s.%s&quot;, n, m-&gt;holder()-&gt;name()-&gt;as_utf8(), m-&gt;name()-&gt;as_utf8());
4344           }
4345         }
4346 #endif
4347         return true;
4348       }
4349       break;
4350     }
4351   }
4352 
4353 #ifndef PRODUCT
4354   if ((C-&gt;print_intrinsics() || C-&gt;print_inlining()) &amp;&amp; Verbose) {
4355     tty-&gt;print_cr(&quot;  Bailing out because caller depth exceeded inlining depth = %d&quot;, jvms()-&gt;depth());
4356     tty-&gt;print_cr(&quot;  JVM state at this point:&quot;);
4357     for (int i = jvms()-&gt;depth(), n = 1; i &gt;= 1; i--, n++) {
4358       ciMethod* m = jvms()-&gt;of_depth(i)-&gt;method();
4359       tty-&gt;print_cr(&quot;   %d) %s.%s&quot;, n, m-&gt;holder()-&gt;name()-&gt;as_utf8(), m-&gt;name()-&gt;as_utf8());
4360     }
4361   }
4362 #endif
4363 
4364   return false;  // bail-out; let JVM_GetCallerClass do the work
4365 }
4366 
4367 bool LibraryCallKit::inline_fp_conversions(vmIntrinsics::ID id) {
4368   Node* arg = argument(0);
4369   Node* result = NULL;
4370 
4371   switch (id) {
4372   case vmIntrinsics::_floatToRawIntBits:    result = new MoveF2INode(arg);  break;
4373   case vmIntrinsics::_intBitsToFloat:       result = new MoveI2FNode(arg);  break;
4374   case vmIntrinsics::_doubleToRawLongBits:  result = new MoveD2LNode(arg);  break;
4375   case vmIntrinsics::_longBitsToDouble:     result = new MoveL2DNode(arg);  break;
4376 
4377   case vmIntrinsics::_doubleToLongBits: {
4378     // two paths (plus control) merge in a wood
4379     RegionNode *r = new RegionNode(3);
4380     Node *phi = new PhiNode(r, TypeLong::LONG);
4381 
4382     Node *cmpisnan = _gvn.transform(new CmpDNode(arg, arg));
4383     // Build the boolean node
4384     Node *bolisnan = _gvn.transform(new BoolNode(cmpisnan, BoolTest::ne));
4385 
4386     // Branch either way.
4387     // NaN case is less traveled, which makes all the difference.
4388     IfNode *ifisnan = create_and_xform_if(control(), bolisnan, PROB_STATIC_FREQUENT, COUNT_UNKNOWN);
4389     Node *opt_isnan = _gvn.transform(ifisnan);
4390     assert( opt_isnan-&gt;is_If(), &quot;Expect an IfNode&quot;);
4391     IfNode *opt_ifisnan = (IfNode*)opt_isnan;
4392     Node *iftrue = _gvn.transform(new IfTrueNode(opt_ifisnan));
4393 
4394     set_control(iftrue);
4395 
4396     static const jlong nan_bits = CONST64(0x7ff8000000000000);
4397     Node *slow_result = longcon(nan_bits); // return NaN
4398     phi-&gt;init_req(1, _gvn.transform( slow_result ));
4399     r-&gt;init_req(1, iftrue);
4400 
4401     // Else fall through
4402     Node *iffalse = _gvn.transform(new IfFalseNode(opt_ifisnan));
4403     set_control(iffalse);
4404 
4405     phi-&gt;init_req(2, _gvn.transform(new MoveD2LNode(arg)));
4406     r-&gt;init_req(2, iffalse);
4407 
4408     // Post merge
4409     set_control(_gvn.transform(r));
4410     record_for_igvn(r);
4411 
4412     C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
4413     result = phi;
4414     assert(result-&gt;bottom_type()-&gt;isa_long(), &quot;must be&quot;);
4415     break;
4416   }
4417 
4418   case vmIntrinsics::_floatToIntBits: {
4419     // two paths (plus control) merge in a wood
4420     RegionNode *r = new RegionNode(3);
4421     Node *phi = new PhiNode(r, TypeInt::INT);
4422 
4423     Node *cmpisnan = _gvn.transform(new CmpFNode(arg, arg));
4424     // Build the boolean node
4425     Node *bolisnan = _gvn.transform(new BoolNode(cmpisnan, BoolTest::ne));
4426 
4427     // Branch either way.
4428     // NaN case is less traveled, which makes all the difference.
4429     IfNode *ifisnan = create_and_xform_if(control(), bolisnan, PROB_STATIC_FREQUENT, COUNT_UNKNOWN);
4430     Node *opt_isnan = _gvn.transform(ifisnan);
4431     assert( opt_isnan-&gt;is_If(), &quot;Expect an IfNode&quot;);
4432     IfNode *opt_ifisnan = (IfNode*)opt_isnan;
4433     Node *iftrue = _gvn.transform(new IfTrueNode(opt_ifisnan));
4434 
4435     set_control(iftrue);
4436 
4437     static const jint nan_bits = 0x7fc00000;
4438     Node *slow_result = makecon(TypeInt::make(nan_bits)); // return NaN
4439     phi-&gt;init_req(1, _gvn.transform( slow_result ));
4440     r-&gt;init_req(1, iftrue);
4441 
4442     // Else fall through
4443     Node *iffalse = _gvn.transform(new IfFalseNode(opt_ifisnan));
4444     set_control(iffalse);
4445 
4446     phi-&gt;init_req(2, _gvn.transform(new MoveF2INode(arg)));
4447     r-&gt;init_req(2, iffalse);
4448 
4449     // Post merge
4450     set_control(_gvn.transform(r));
4451     record_for_igvn(r);
4452 
4453     C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
4454     result = phi;
4455     assert(result-&gt;bottom_type()-&gt;isa_int(), &quot;must be&quot;);
4456     break;
4457   }
4458 
4459   default:
4460     fatal_unexpected_iid(id);
4461     break;
4462   }
4463   set_result(_gvn.transform(result));
4464   return true;
4465 }
4466 
4467 //----------------------inline_unsafe_copyMemory-------------------------
4468 // public native void Unsafe.copyMemory0(Object srcBase, long srcOffset, Object destBase, long destOffset, long bytes);
4469 bool LibraryCallKit::inline_unsafe_copyMemory() {
4470   if (callee()-&gt;is_static())  return false;  // caller must have the capability!
4471   null_check_receiver();  // null-check receiver
4472   if (stopped())  return true;
4473 
4474   C-&gt;set_has_unsafe_access(true);  // Mark eventual nmethod as &quot;unsafe&quot;.
4475 
4476   Node* src_ptr =         argument(1);   // type: oop
4477   Node* src_off = ConvL2X(argument(2));  // type: long
4478   Node* dst_ptr =         argument(4);   // type: oop
4479   Node* dst_off = ConvL2X(argument(5));  // type: long
4480   Node* size    = ConvL2X(argument(7));  // type: long
4481 
4482   assert(Unsafe_field_offset_to_byte_offset(11) == 11,
4483          &quot;fieldOffset must be byte-scaled&quot;);
4484 
4485   Node* src = make_unsafe_address(src_ptr, src_off, ACCESS_READ);
4486   Node* dst = make_unsafe_address(dst_ptr, dst_off, ACCESS_WRITE);
4487 
4488   // Conservatively insert a memory barrier on all memory slices.
4489   // Do not let writes of the copy source or destination float below the copy.
4490   insert_mem_bar(Op_MemBarCPUOrder);
4491 
4492   Node* thread = _gvn.transform(new ThreadLocalNode());
4493   Node* doing_unsafe_access_addr = basic_plus_adr(top(), thread, in_bytes(JavaThread::doing_unsafe_access_offset()));
4494   BasicType doing_unsafe_access_bt = T_BYTE;
4495   assert((sizeof(bool) * CHAR_BIT) == 8, &quot;not implemented&quot;);
4496 
4497   // update volatile field
4498   store_to_memory(control(), doing_unsafe_access_addr, intcon(1), doing_unsafe_access_bt, Compile::AliasIdxRaw, MemNode::unordered);
4499 
4500   // Call it.  Note that the length argument is not scaled.
4501   make_runtime_call(RC_LEAF|RC_NO_FP,
4502                     OptoRuntime::fast_arraycopy_Type(),
4503                     StubRoutines::unsafe_arraycopy(),
4504                     &quot;unsafe_arraycopy&quot;,
4505                     TypeRawPtr::BOTTOM,
4506                     src, dst, size XTOP);
4507 
4508   store_to_memory(control(), doing_unsafe_access_addr, intcon(0), doing_unsafe_access_bt, Compile::AliasIdxRaw, MemNode::unordered);
4509 
4510   // Do not let reads of the copy destination float above the copy.
4511   insert_mem_bar(Op_MemBarCPUOrder);
4512 
4513   return true;
4514 }
4515 
4516 //------------------------clone_coping-----------------------------------
4517 // Helper function for inline_native_clone.
4518 void LibraryCallKit::copy_to_clone(Node* obj, Node* alloc_obj, Node* obj_size, bool is_array) {
4519   assert(obj_size != NULL, &quot;&quot;);
4520   Node* raw_obj = alloc_obj-&gt;in(1);
4521   assert(alloc_obj-&gt;is_CheckCastPP() &amp;&amp; raw_obj-&gt;is_Proj() &amp;&amp; raw_obj-&gt;in(0)-&gt;is_Allocate(), &quot;&quot;);
4522 
4523   AllocateNode* alloc = NULL;
4524   if (ReduceBulkZeroing) {
4525     // We will be completely responsible for initializing this object -
4526     // mark Initialize node as complete.
4527     alloc = AllocateNode::Ideal_allocation(alloc_obj, &amp;_gvn);
4528     // The object was just allocated - there should be no any stores!
4529     guarantee(alloc != NULL &amp;&amp; alloc-&gt;maybe_set_complete(&amp;_gvn), &quot;&quot;);
4530     // Mark as complete_with_arraycopy so that on AllocateNode
4531     // expansion, we know this AllocateNode is initialized by an array
4532     // copy and a StoreStore barrier exists after the array copy.
4533     alloc-&gt;initialization()-&gt;set_complete_with_arraycopy();
4534   }
4535 
4536   Node* size = _gvn.transform(obj_size);
4537   // Exclude the header but include array length to copy by 8 bytes words.
4538   // Can&#39;t use base_offset_in_bytes(bt) since basic type is unknown.
4539   int base_off = BarrierSetC2::arraycopy_payload_base_offset(is_array);
4540   Node* countx = size;
4541   countx = _gvn.transform(new SubXNode(countx, MakeConX(base_off)));
4542   countx = _gvn.transform(new URShiftXNode(countx, intcon(LogBytesPerLong)));
4543 
4544   access_clone(obj, alloc_obj, countx, is_array);
4545 
4546   // Do not let reads from the cloned object float above the arraycopy.
4547   if (alloc != NULL) {
4548     // Do not let stores that initialize this object be reordered with
4549     // a subsequent store that would make this object accessible by
4550     // other threads.
4551     // Record what AllocateNode this StoreStore protects so that
4552     // escape analysis can go from the MemBarStoreStoreNode to the
4553     // AllocateNode and eliminate the MemBarStoreStoreNode if possible
4554     // based on the escape status of the AllocateNode.
4555     insert_mem_bar(Op_MemBarStoreStore, alloc-&gt;proj_out_or_null(AllocateNode::RawAddress));
4556   } else {
4557     insert_mem_bar(Op_MemBarCPUOrder);
4558   }
4559 }
4560 
4561 //------------------------inline_native_clone----------------------------
4562 // protected native Object java.lang.Object.clone();
4563 //
4564 // Here are the simple edge cases:
4565 //  null receiver =&gt; normal trap
4566 //  virtual and clone was overridden =&gt; slow path to out-of-line clone
4567 //  not cloneable or finalizer =&gt; slow path to out-of-line Object.clone
4568 //
4569 // The general case has two steps, allocation and copying.
4570 // Allocation has two cases, and uses GraphKit::new_instance or new_array.
4571 //
4572 // Copying also has two cases, oop arrays and everything else.
4573 // Oop arrays use arrayof_oop_arraycopy (same as System.arraycopy).
4574 // Everything else uses the tight inline loop supplied by CopyArrayNode.
4575 //
4576 // These steps fold up nicely if and when the cloned object&#39;s klass
4577 // can be sharply typed as an object array, a type array, or an instance.
4578 //
4579 bool LibraryCallKit::inline_native_clone(bool is_virtual) {
4580   PhiNode* result_val;
4581 
4582   // Set the reexecute bit for the interpreter to reexecute
4583   // the bytecode that invokes Object.clone if deoptimization happens.
4584   { PreserveReexecuteState preexecs(this);
4585     jvms()-&gt;set_should_reexecute(true);
4586 
4587     Node* obj = argument(0);
4588     if (obj-&gt;is_ValueType()) {
4589       return false;
4590     }
4591 
4592     obj = null_check_receiver();
4593     if (stopped())  return true;
4594 
4595     const TypeOopPtr* obj_type = _gvn.type(obj)-&gt;is_oopptr();
4596 
4597     // If we are going to clone an instance, we need its exact type to
4598     // know the number and types of fields to convert the clone to
4599     // loads/stores. Maybe a speculative type can help us.
4600     if (!obj_type-&gt;klass_is_exact() &amp;&amp;
4601         obj_type-&gt;speculative_type() != NULL &amp;&amp;
4602         obj_type-&gt;speculative_type()-&gt;is_instance_klass() &amp;&amp;
4603         !obj_type-&gt;speculative_type()-&gt;is_valuetype()) {
4604       ciInstanceKlass* spec_ik = obj_type-&gt;speculative_type()-&gt;as_instance_klass();
4605       if (spec_ik-&gt;nof_nonstatic_fields() &lt;= ArrayCopyLoadStoreMaxElem &amp;&amp;
4606           !spec_ik-&gt;has_injected_fields()) {
4607         ciKlass* k = obj_type-&gt;klass();
4608         if (!k-&gt;is_instance_klass() ||
4609             k-&gt;as_instance_klass()-&gt;is_interface() ||
4610             k-&gt;as_instance_klass()-&gt;has_subklass()) {
4611           obj = maybe_cast_profiled_obj(obj, obj_type-&gt;speculative_type(), false);
4612         }
4613       }
4614     }
4615 
4616     // Conservatively insert a memory barrier on all memory slices.
4617     // Do not let writes into the original float below the clone.
4618     insert_mem_bar(Op_MemBarCPUOrder);
4619 
4620     // paths into result_reg:
4621     enum {
4622       _slow_path = 1,     // out-of-line call to clone method (virtual or not)
4623       _objArray_path,     // plain array allocation, plus arrayof_oop_arraycopy
4624       _array_path,        // plain array allocation, plus arrayof_long_arraycopy
4625       _instance_path,     // plain instance allocation, plus arrayof_long_arraycopy
4626       PATH_LIMIT
4627     };
4628     RegionNode* result_reg = new RegionNode(PATH_LIMIT);
4629     result_val             = new PhiNode(result_reg, TypeInstPtr::NOTNULL);
4630     PhiNode*    result_i_o = new PhiNode(result_reg, Type::ABIO);
4631     PhiNode*    result_mem = new PhiNode(result_reg, Type::MEMORY, TypePtr::BOTTOM);
4632     record_for_igvn(result_reg);
4633 
4634     Node* obj_klass = load_object_klass(obj);
4635     // We only go to the fast case code if we pass a number of guards.
4636     // The paths which do not pass are accumulated in the slow_region.
4637     RegionNode* slow_region = new RegionNode(1);
4638     record_for_igvn(slow_region);
4639 
4640     Node* array_ctl = generate_array_guard(obj_klass, (RegionNode*)NULL);
4641     if (array_ctl != NULL) {
4642       // It&#39;s an array.
4643       PreserveJVMState pjvms(this);
4644       set_control(array_ctl);
4645 
4646       BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
4647       if (bs-&gt;array_copy_requires_gc_barriers(true, T_OBJECT, true, BarrierSetC2::Parsing) &amp;&amp;
4648           (!obj_type-&gt;isa_aryptr() || !obj_type-&gt;is_aryptr()-&gt;is_not_flat())) {
4649         // Flattened value type array may have object field that would require a
4650         // write barrier. Conservatively, go to slow path.
4651         generate_valueArray_guard(obj_klass, slow_region);
4652       }
4653 
4654       if (!stopped()) {
4655         Node* obj_length = load_array_length(obj);
4656         Node* obj_size  = NULL;
4657         Node* alloc_obj = new_array(obj_klass, obj_length, 0, &amp;obj_size);  // no arguments to push
4658 
4659         BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
4660         if (bs-&gt;array_copy_requires_gc_barriers(true, T_OBJECT, true, BarrierSetC2::Parsing)) {
4661           // If it is an oop array, it requires very special treatment,
4662           // because gc barriers are required when accessing the array.
4663           Node* is_obja = generate_objArray_guard(obj_klass, (RegionNode*)NULL);
4664           if (is_obja != NULL) {
4665             PreserveJVMState pjvms2(this);
4666             set_control(is_obja);
4667             // Generate a direct call to the right arraycopy function(s).
4668             Node* alloc = tightly_coupled_allocation(alloc_obj, NULL);
4669             ArrayCopyNode* ac = ArrayCopyNode::make(this, true, obj, intcon(0), alloc_obj, intcon(0), obj_length, alloc != NULL, false);
4670             ac-&gt;set_clone_oop_array();
4671             Node* n = _gvn.transform(ac);
4672             assert(n == ac, &quot;cannot disappear&quot;);
4673             ac-&gt;connect_outputs(this);
4674 
4675             result_reg-&gt;init_req(_objArray_path, control());
4676             result_val-&gt;init_req(_objArray_path, alloc_obj);
4677             result_i_o -&gt;set_req(_objArray_path, i_o());
4678             result_mem -&gt;set_req(_objArray_path, reset_memory());
4679           }
4680         }
4681         // Otherwise, there are no barriers to worry about.
4682         // (We can dispense with card marks if we know the allocation
4683         //  comes out of eden (TLAB)...  In fact, ReduceInitialCardMarks
4684         //  causes the non-eden paths to take compensating steps to
4685         //  simulate a fresh allocation, so that no further
4686         //  card marks are required in compiled code to initialize
4687         //  the object.)
4688 
4689         if (!stopped()) {
4690           copy_to_clone(obj, alloc_obj, obj_size, true);
4691 
4692           // Present the results of the copy.
4693           result_reg-&gt;init_req(_array_path, control());
4694           result_val-&gt;init_req(_array_path, alloc_obj);
4695           result_i_o -&gt;set_req(_array_path, i_o());
4696           result_mem -&gt;set_req(_array_path, reset_memory());
4697         }
4698       }
4699     }
4700 
4701     if (!stopped()) {
4702       // It&#39;s an instance (we did array above).  Make the slow-path tests.
4703       // If this is a virtual call, we generate a funny guard.  We grab
4704       // the vtable entry corresponding to clone() from the target object.
4705       // If the target method which we are calling happens to be the
4706       // Object clone() method, we pass the guard.  We do not need this
4707       // guard for non-virtual calls; the caller is known to be the native
4708       // Object clone().
4709       if (is_virtual) {
4710         generate_virtual_guard(obj_klass, slow_region);
4711       }
4712 
4713       // The object must be easily cloneable and must not have a finalizer.
4714       // Both of these conditions may be checked in a single test.
4715       // We could optimize the test further, but we don&#39;t care.
4716       generate_access_flags_guard(obj_klass,
4717                                   // Test both conditions:
4718                                   JVM_ACC_IS_CLONEABLE_FAST | JVM_ACC_HAS_FINALIZER,
4719                                   // Must be cloneable but not finalizer:
4720                                   JVM_ACC_IS_CLONEABLE_FAST,
4721                                   slow_region);
4722     }
4723 
4724     if (!stopped()) {
4725       // It&#39;s an instance, and it passed the slow-path tests.
4726       PreserveJVMState pjvms(this);
4727       Node* obj_size  = NULL;
4728       // Need to deoptimize on exception from allocation since Object.clone intrinsic
4729       // is reexecuted if deoptimization occurs and there could be problems when merging
4730       // exception state between multiple Object.clone versions (reexecute=true vs reexecute=false).
4731       Node* alloc_obj = new_instance(obj_klass, NULL, &amp;obj_size, /*deoptimize_on_exception=*/true);
4732 
4733       copy_to_clone(obj, alloc_obj, obj_size, false);
4734 
4735       // Present the results of the slow call.
4736       result_reg-&gt;init_req(_instance_path, control());
4737       result_val-&gt;init_req(_instance_path, alloc_obj);
4738       result_i_o -&gt;set_req(_instance_path, i_o());
4739       result_mem -&gt;set_req(_instance_path, reset_memory());
4740     }
4741 
4742     // Generate code for the slow case.  We make a call to clone().
4743     set_control(_gvn.transform(slow_region));
4744     if (!stopped()) {
4745       PreserveJVMState pjvms(this);
4746       CallJavaNode* slow_call = generate_method_call(vmIntrinsics::_clone, is_virtual);
4747       // We need to deoptimize on exception (see comment above)
4748       Node* slow_result = set_results_for_java_call(slow_call, false, /* deoptimize */ true);
4749       // this-&gt;control() comes from set_results_for_java_call
4750       result_reg-&gt;init_req(_slow_path, control());
4751       result_val-&gt;init_req(_slow_path, slow_result);
4752       result_i_o -&gt;set_req(_slow_path, i_o());
4753       result_mem -&gt;set_req(_slow_path, reset_memory());
4754     }
4755 
4756     // Return the combined state.
4757     set_control(    _gvn.transform(result_reg));
4758     set_i_o(        _gvn.transform(result_i_o));
4759     set_all_memory( _gvn.transform(result_mem));
4760   } // original reexecute is set back here
4761 
4762   set_result(_gvn.transform(result_val));
4763   return true;
4764 }
4765 
4766 // If we have a tightly coupled allocation, the arraycopy may take care
4767 // of the array initialization. If one of the guards we insert between
4768 // the allocation and the arraycopy causes a deoptimization, an
4769 // unitialized array will escape the compiled method. To prevent that
4770 // we set the JVM state for uncommon traps between the allocation and
4771 // the arraycopy to the state before the allocation so, in case of
4772 // deoptimization, we&#39;ll reexecute the allocation and the
4773 // initialization.
4774 JVMState* LibraryCallKit::arraycopy_restore_alloc_state(AllocateArrayNode* alloc, int&amp; saved_reexecute_sp) {
4775   if (alloc != NULL) {
4776     ciMethod* trap_method = alloc-&gt;jvms()-&gt;method();
4777     int trap_bci = alloc-&gt;jvms()-&gt;bci();
4778 
4779     if (!C-&gt;too_many_traps(trap_method, trap_bci, Deoptimization::Reason_intrinsic) &amp;&amp;
4780         !C-&gt;too_many_traps(trap_method, trap_bci, Deoptimization::Reason_null_check)) {
4781       // Make sure there&#39;s no store between the allocation and the
4782       // arraycopy otherwise visible side effects could be rexecuted
4783       // in case of deoptimization and cause incorrect execution.
4784       bool no_interfering_store = true;
4785       Node* mem = alloc-&gt;in(TypeFunc::Memory);
4786       if (mem-&gt;is_MergeMem()) {
4787         for (MergeMemStream mms(merged_memory(), mem-&gt;as_MergeMem()); mms.next_non_empty2(); ) {
4788           Node* n = mms.memory();
4789           if (n != mms.memory2() &amp;&amp; !(n-&gt;is_Proj() &amp;&amp; n-&gt;in(0) == alloc-&gt;initialization())) {
4790             assert(n-&gt;is_Store(), &quot;what else?&quot;);
4791             no_interfering_store = false;
4792             break;
4793           }
4794         }
4795       } else {
4796         for (MergeMemStream mms(merged_memory()); mms.next_non_empty(); ) {
4797           Node* n = mms.memory();
4798           if (n != mem &amp;&amp; !(n-&gt;is_Proj() &amp;&amp; n-&gt;in(0) == alloc-&gt;initialization())) {
4799             assert(n-&gt;is_Store(), &quot;what else?&quot;);
4800             no_interfering_store = false;
4801             break;
4802           }
4803         }
4804       }
4805 
4806       if (no_interfering_store) {
4807         JVMState* old_jvms = alloc-&gt;jvms()-&gt;clone_shallow(C);
4808         uint size = alloc-&gt;req();
4809         SafePointNode* sfpt = new SafePointNode(size, old_jvms);
4810         old_jvms-&gt;set_map(sfpt);
4811         for (uint i = 0; i &lt; size; i++) {
4812           sfpt-&gt;init_req(i, alloc-&gt;in(i));
4813         }
4814         // re-push array length for deoptimization
4815         sfpt-&gt;ins_req(old_jvms-&gt;stkoff() + old_jvms-&gt;sp(), alloc-&gt;in(AllocateNode::ALength));
4816         old_jvms-&gt;set_sp(old_jvms-&gt;sp()+1);
4817         old_jvms-&gt;set_monoff(old_jvms-&gt;monoff()+1);
4818         old_jvms-&gt;set_scloff(old_jvms-&gt;scloff()+1);
4819         old_jvms-&gt;set_endoff(old_jvms-&gt;endoff()+1);
4820         old_jvms-&gt;set_should_reexecute(true);
4821 
4822         sfpt-&gt;set_i_o(map()-&gt;i_o());
4823         sfpt-&gt;set_memory(map()-&gt;memory());
4824         sfpt-&gt;set_control(map()-&gt;control());
4825 
4826         JVMState* saved_jvms = jvms();
4827         saved_reexecute_sp = _reexecute_sp;
4828 
4829         set_jvms(sfpt-&gt;jvms());
4830         _reexecute_sp = jvms()-&gt;sp();
4831 
4832         return saved_jvms;
4833       }
4834     }
4835   }
4836   return NULL;
4837 }
4838 
4839 // In case of a deoptimization, we restart execution at the
4840 // allocation, allocating a new array. We would leave an uninitialized
4841 // array in the heap that GCs wouldn&#39;t expect. Move the allocation
4842 // after the traps so we don&#39;t allocate the array if we
4843 // deoptimize. This is possible because tightly_coupled_allocation()
4844 // guarantees there&#39;s no observer of the allocated array at this point
4845 // and the control flow is simple enough.
4846 void LibraryCallKit::arraycopy_move_allocation_here(AllocateArrayNode* alloc, Node* dest, JVMState* saved_jvms,
4847                                                     int saved_reexecute_sp, uint new_idx) {
4848   if (saved_jvms != NULL &amp;&amp; !stopped()) {
4849     assert(alloc != NULL, &quot;only with a tightly coupled allocation&quot;);
4850     // restore JVM state to the state at the arraycopy
4851     saved_jvms-&gt;map()-&gt;set_control(map()-&gt;control());
4852     assert(saved_jvms-&gt;map()-&gt;memory() == map()-&gt;memory(), &quot;memory state changed?&quot;);
4853     assert(saved_jvms-&gt;map()-&gt;i_o() == map()-&gt;i_o(), &quot;IO state changed?&quot;);
4854     // If we&#39;ve improved the types of some nodes (null check) while
4855     // emitting the guards, propagate them to the current state
4856     map()-&gt;replaced_nodes().apply(saved_jvms-&gt;map(), new_idx);
4857     set_jvms(saved_jvms);
4858     _reexecute_sp = saved_reexecute_sp;
4859 
4860     // Remove the allocation from above the guards
4861     CallProjections* callprojs = alloc-&gt;extract_projections(true);
4862     InitializeNode* init = alloc-&gt;initialization();
4863     Node* alloc_mem = alloc-&gt;in(TypeFunc::Memory);
4864     C-&gt;gvn_replace_by(callprojs-&gt;fallthrough_ioproj, alloc-&gt;in(TypeFunc::I_O));
4865     C-&gt;gvn_replace_by(init-&gt;proj_out(TypeFunc::Memory), alloc_mem);
4866     C-&gt;gvn_replace_by(init-&gt;proj_out(TypeFunc::Control), alloc-&gt;in(0));
4867 
4868     // move the allocation here (after the guards)
4869     _gvn.hash_delete(alloc);
4870     alloc-&gt;set_req(TypeFunc::Control, control());
4871     alloc-&gt;set_req(TypeFunc::I_O, i_o());
4872     Node *mem = reset_memory();
4873     set_all_memory(mem);
4874     alloc-&gt;set_req(TypeFunc::Memory, mem);
4875     set_control(init-&gt;proj_out_or_null(TypeFunc::Control));
4876     set_i_o(callprojs-&gt;fallthrough_ioproj);
4877 
4878     // Update memory as done in GraphKit::set_output_for_allocation()
4879     const TypeInt* length_type = _gvn.find_int_type(alloc-&gt;in(AllocateNode::ALength));
4880     const TypeOopPtr* ary_type = _gvn.type(alloc-&gt;in(AllocateNode::KlassNode))-&gt;is_klassptr()-&gt;as_instance_type();
4881     if (ary_type-&gt;isa_aryptr() &amp;&amp; length_type != NULL) {
4882       ary_type = ary_type-&gt;is_aryptr()-&gt;cast_to_size(length_type);
4883     }
4884     const TypePtr* telemref = ary_type-&gt;add_offset(Type::OffsetBot);
4885     int            elemidx  = C-&gt;get_alias_index(telemref);
4886     set_memory(init-&gt;proj_out_or_null(TypeFunc::Memory), Compile::AliasIdxRaw);
4887     set_memory(init-&gt;proj_out_or_null(TypeFunc::Memory), elemidx);
4888 
4889     Node* allocx = _gvn.transform(alloc);
4890     assert(allocx == alloc, &quot;where has the allocation gone?&quot;);
4891     assert(dest-&gt;is_CheckCastPP(), &quot;not an allocation result?&quot;);
4892 
4893     _gvn.hash_delete(dest);
4894     dest-&gt;set_req(0, control());
4895     Node* destx = _gvn.transform(dest);
4896     assert(destx == dest, &quot;where has the allocation result gone?&quot;);
4897   }
4898 }
4899 
4900 
4901 //------------------------------inline_arraycopy-----------------------
4902 // public static native void java.lang.System.arraycopy(Object src,  int  srcPos,
4903 //                                                      Object dest, int destPos,
4904 //                                                      int length);
4905 bool LibraryCallKit::inline_arraycopy() {
4906   // Get the arguments.
4907   Node* src         = argument(0);  // type: oop
4908   Node* src_offset  = argument(1);  // type: int
4909   Node* dest        = argument(2);  // type: oop
4910   Node* dest_offset = argument(3);  // type: int
4911   Node* length      = argument(4);  // type: int
4912 
4913   uint new_idx = C-&gt;unique();
4914 
4915   // Check for allocation before we add nodes that would confuse
4916   // tightly_coupled_allocation()
4917   AllocateArrayNode* alloc = tightly_coupled_allocation(dest, NULL);
4918 
4919   int saved_reexecute_sp = -1;
4920   JVMState* saved_jvms = arraycopy_restore_alloc_state(alloc, saved_reexecute_sp);
4921   // See arraycopy_restore_alloc_state() comment
4922   // if alloc == NULL we don&#39;t have to worry about a tightly coupled allocation so we can emit all needed guards
4923   // if saved_jvms != NULL (then alloc != NULL) then we can handle guards and a tightly coupled allocation
4924   // if saved_jvms == NULL and alloc != NULL, we can&#39;t emit any guards
4925   bool can_emit_guards = (alloc == NULL || saved_jvms != NULL);
4926 
4927   // The following tests must be performed
4928   // (1) src and dest are arrays.
4929   // (2) src and dest arrays must have elements of the same BasicType
4930   // (3) src and dest must not be null.
4931   // (4) src_offset must not be negative.
4932   // (5) dest_offset must not be negative.
4933   // (6) length must not be negative.
4934   // (7) src_offset + length must not exceed length of src.
4935   // (8) dest_offset + length must not exceed length of dest.
4936   // (9) each element of an oop array must be assignable
4937 
4938   // (3) src and dest must not be null.
4939   // always do this here because we need the JVM state for uncommon traps
4940   Node* null_ctl = top();
4941   src  = saved_jvms != NULL ? null_check_oop(src, &amp;null_ctl, true, true) : null_check(src,  T_ARRAY);
4942   assert(null_ctl-&gt;is_top(), &quot;no null control here&quot;);
4943   dest = null_check(dest, T_ARRAY);
4944 
4945   if (!can_emit_guards) {
4946     // if saved_jvms == NULL and alloc != NULL, we don&#39;t emit any
4947     // guards but the arraycopy node could still take advantage of a
4948     // tightly allocated allocation. tightly_coupled_allocation() is
4949     // called again to make sure it takes the null check above into
4950     // account: the null check is mandatory and if it caused an
4951     // uncommon trap to be emitted then the allocation can&#39;t be
4952     // considered tightly coupled in this context.
4953     alloc = tightly_coupled_allocation(dest, NULL);
4954   }
4955 
4956   bool validated = false;
4957 
4958   const Type* src_type  = _gvn.type(src);
4959   const Type* dest_type = _gvn.type(dest);
4960   const TypeAryPtr* top_src  = src_type-&gt;isa_aryptr();
4961   const TypeAryPtr* top_dest = dest_type-&gt;isa_aryptr();
4962 
4963   // Do we have the type of src?
4964   bool has_src = (top_src != NULL &amp;&amp; top_src-&gt;klass() != NULL);
4965   // Do we have the type of dest?
4966   bool has_dest = (top_dest != NULL &amp;&amp; top_dest-&gt;klass() != NULL);
4967   // Is the type for src from speculation?
4968   bool src_spec = false;
4969   // Is the type for dest from speculation?
4970   bool dest_spec = false;
4971 
4972   if ((!has_src || !has_dest) &amp;&amp; can_emit_guards) {
4973     // We don&#39;t have sufficient type information, let&#39;s see if
4974     // speculative types can help. We need to have types for both src
4975     // and dest so that it pays off.
4976 
4977     // Do we already have or could we have type information for src
4978     bool could_have_src = has_src;
4979     // Do we already have or could we have type information for dest
4980     bool could_have_dest = has_dest;
4981 
4982     ciKlass* src_k = NULL;
4983     if (!has_src) {
4984       src_k = src_type-&gt;speculative_type_not_null();
4985       if (src_k != NULL &amp;&amp; src_k-&gt;is_array_klass()) {
4986         could_have_src = true;
4987       }
4988     }
4989 
4990     ciKlass* dest_k = NULL;
4991     if (!has_dest) {
4992       dest_k = dest_type-&gt;speculative_type_not_null();
4993       if (dest_k != NULL &amp;&amp; dest_k-&gt;is_array_klass()) {
4994         could_have_dest = true;
4995       }
4996     }
4997 
4998     if (could_have_src &amp;&amp; could_have_dest) {
4999       // This is going to pay off so emit the required guards
5000       if (!has_src) {
5001         src = maybe_cast_profiled_obj(src, src_k, true);
5002         src_type  = _gvn.type(src);
5003         top_src  = src_type-&gt;isa_aryptr();
5004         has_src = (top_src != NULL &amp;&amp; top_src-&gt;klass() != NULL);
5005         src_spec = true;
5006       }
5007       if (!has_dest) {
5008         dest = maybe_cast_profiled_obj(dest, dest_k, true);
5009         dest_type  = _gvn.type(dest);
5010         top_dest  = dest_type-&gt;isa_aryptr();
5011         has_dest = (top_dest != NULL &amp;&amp; top_dest-&gt;klass() != NULL);
5012         dest_spec = true;
5013       }
5014     }
5015   }
5016 
5017   if (has_src &amp;&amp; has_dest &amp;&amp; can_emit_guards) {
5018     BasicType src_elem  = top_src-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5019     BasicType dest_elem = top_dest-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5020     if (src_elem  == T_ARRAY)  src_elem  = T_OBJECT;
5021     if (dest_elem == T_ARRAY)  dest_elem = T_OBJECT;
5022 
5023     if (src_elem == dest_elem &amp;&amp; src_elem == T_OBJECT) {
5024       // If both arrays are object arrays then having the exact types
5025       // for both will remove the need for a subtype check at runtime
5026       // before the call and may make it possible to pick a faster copy
5027       // routine (without a subtype check on every element)
5028       // Do we have the exact type of src?
5029       bool could_have_src = src_spec;
5030       // Do we have the exact type of dest?
5031       bool could_have_dest = dest_spec;
5032       ciKlass* src_k = top_src-&gt;klass();
5033       ciKlass* dest_k = top_dest-&gt;klass();
5034       if (!src_spec) {
5035         src_k = src_type-&gt;speculative_type_not_null();
5036         if (src_k != NULL &amp;&amp; src_k-&gt;is_array_klass()) {
5037           could_have_src = true;
5038         }
5039       }
5040       if (!dest_spec) {
5041         dest_k = dest_type-&gt;speculative_type_not_null();
5042         if (dest_k != NULL &amp;&amp; dest_k-&gt;is_array_klass()) {
5043           could_have_dest = true;
5044         }
5045       }
5046       if (could_have_src &amp;&amp; could_have_dest) {
5047         // If we can have both exact types, emit the missing guards
5048         if (could_have_src &amp;&amp; !src_spec) {
5049           src = maybe_cast_profiled_obj(src, src_k, true);
5050         }
5051         if (could_have_dest &amp;&amp; !dest_spec) {
5052           dest = maybe_cast_profiled_obj(dest, dest_k, true);
5053         }
5054       }
5055     }
5056   }
5057 
5058   ciMethod* trap_method = method();
5059   int trap_bci = bci();
5060   if (saved_jvms != NULL) {
5061     trap_method = alloc-&gt;jvms()-&gt;method();
5062     trap_bci = alloc-&gt;jvms()-&gt;bci();
5063   }
5064 
5065   bool negative_length_guard_generated = false;
5066 
5067   if (!C-&gt;too_many_traps(trap_method, trap_bci, Deoptimization::Reason_intrinsic) &amp;&amp;
5068       can_emit_guards &amp;&amp;
5069       !src-&gt;is_top() &amp;&amp; !dest-&gt;is_top()) {
5070     // validate arguments: enables transformation the ArrayCopyNode
5071     validated = true;
5072 
5073     RegionNode* slow_region = new RegionNode(1);
5074     record_for_igvn(slow_region);
5075 
5076     // (1) src and dest are arrays.
5077     generate_non_array_guard(load_object_klass(src), slow_region);
5078     generate_non_array_guard(load_object_klass(dest), slow_region);
5079 
5080     // (2) src and dest arrays must have elements of the same BasicType
5081     // done at macro expansion or at Ideal transformation time
5082 
5083     // (4) src_offset must not be negative.
5084     generate_negative_guard(src_offset, slow_region);
5085 
5086     // (5) dest_offset must not be negative.
5087     generate_negative_guard(dest_offset, slow_region);
5088 
5089     // (7) src_offset + length must not exceed length of src.
5090     generate_limit_guard(src_offset, length,
5091                          load_array_length(src),
5092                          slow_region);
5093 
5094     // (8) dest_offset + length must not exceed length of dest.
5095     generate_limit_guard(dest_offset, length,
5096                          load_array_length(dest),
5097                          slow_region);
5098 
5099     // (6) length must not be negative.
5100     // This is also checked in generate_arraycopy() during macro expansion, but
5101     // we also have to check it here for the case where the ArrayCopyNode will
5102     // be eliminated by Escape Analysis.
5103     if (EliminateAllocations) {
5104       generate_negative_guard(length, slow_region);
5105       negative_length_guard_generated = true;
5106     }
5107 
5108     // (9) each element of an oop array must be assignable
5109     Node* dest_klass = load_object_klass(dest);
5110     if (src != dest) {
5111       Node* not_subtype_ctrl = gen_subtype_check(src, dest_klass);
5112 
5113       if (not_subtype_ctrl != top()) {
5114         PreserveJVMState pjvms(this);
5115         set_control(not_subtype_ctrl);
5116         uncommon_trap(Deoptimization::Reason_intrinsic,
5117                       Deoptimization::Action_make_not_entrant);
5118         assert(stopped(), &quot;Should be stopped&quot;);
5119       }
5120     }
5121 
5122     const TypeKlassPtr* dest_klass_t = _gvn.type(dest_klass)-&gt;is_klassptr();
5123     const Type* toop = TypeOopPtr::make_from_klass(dest_klass_t-&gt;klass());
5124     src = _gvn.transform(new CheckCastPPNode(control(), src, toop));
5125     src_type = _gvn.type(src);
5126     top_src  = src_type-&gt;isa_aryptr();
5127 
5128     if (top_dest != NULL &amp;&amp; !top_dest-&gt;elem()-&gt;isa_valuetype() &amp;&amp; !top_dest-&gt;is_not_flat()) {
5129       generate_valueArray_guard(dest_klass, slow_region);
5130     }
5131 
5132     if (top_src != NULL &amp;&amp; !top_src-&gt;elem()-&gt;isa_valuetype() &amp;&amp; !top_src-&gt;is_not_flat()) {
5133       Node* src_klass = load_object_klass(src);
5134       generate_valueArray_guard(src_klass, slow_region);
5135     }
5136 
5137     {
5138       PreserveJVMState pjvms(this);
5139       set_control(_gvn.transform(slow_region));
5140       uncommon_trap(Deoptimization::Reason_intrinsic,
5141                     Deoptimization::Action_make_not_entrant);
5142       assert(stopped(), &quot;Should be stopped&quot;);
5143     }
5144   }
5145 
5146   arraycopy_move_allocation_here(alloc, dest, saved_jvms, saved_reexecute_sp, new_idx);
5147 
5148   if (stopped()) {
5149     return true;
5150   }
5151 
5152   ArrayCopyNode* ac = ArrayCopyNode::make(this, true, src, src_offset, dest, dest_offset, length, alloc != NULL, negative_length_guard_generated,
5153                                           // Create LoadRange and LoadKlass nodes for use during macro expansion here
5154                                           // so the compiler has a chance to eliminate them: during macro expansion,
5155                                           // we have to set their control (CastPP nodes are eliminated).
5156                                           load_object_klass(src), load_object_klass(dest),
5157                                           load_array_length(src), load_array_length(dest));
5158 
5159   ac-&gt;set_arraycopy(validated);
5160 
5161   Node* n = _gvn.transform(ac);
5162   if (n == ac) {
5163     ac-&gt;connect_outputs(this);
5164   } else {
5165     assert(validated, &quot;shouldn&#39;t transform if all arguments not validated&quot;);
5166     set_all_memory(n);
5167   }
5168   clear_upper_avx();
5169 
5170 
5171   return true;
5172 }
5173 
5174 
5175 // Helper function which determines if an arraycopy immediately follows
5176 // an allocation, with no intervening tests or other escapes for the object.
5177 AllocateArrayNode*
5178 LibraryCallKit::tightly_coupled_allocation(Node* ptr,
5179                                            RegionNode* slow_region) {
5180   if (stopped())             return NULL;  // no fast path
5181   if (C-&gt;AliasLevel() == 0)  return NULL;  // no MergeMems around
5182 
5183   AllocateArrayNode* alloc = AllocateArrayNode::Ideal_array_allocation(ptr, &amp;_gvn);
5184   if (alloc == NULL)  return NULL;
5185 
5186   Node* rawmem = memory(Compile::AliasIdxRaw);
5187   // Is the allocation&#39;s memory state untouched?
5188   if (!(rawmem-&gt;is_Proj() &amp;&amp; rawmem-&gt;in(0)-&gt;is_Initialize())) {
5189     // Bail out if there have been raw-memory effects since the allocation.
5190     // (Example:  There might have been a call or safepoint.)
5191     return NULL;
5192   }
5193   rawmem = rawmem-&gt;in(0)-&gt;as_Initialize()-&gt;memory(Compile::AliasIdxRaw);
5194   if (!(rawmem-&gt;is_Proj() &amp;&amp; rawmem-&gt;in(0) == alloc)) {
5195     return NULL;
5196   }
5197 
5198   // There must be no unexpected observers of this allocation.
5199   for (DUIterator_Fast imax, i = ptr-&gt;fast_outs(imax); i &lt; imax; i++) {
5200     Node* obs = ptr-&gt;fast_out(i);
5201     if (obs != this-&gt;map()) {
5202       return NULL;
5203     }
5204   }
5205 
5206   // This arraycopy must unconditionally follow the allocation of the ptr.
5207   Node* alloc_ctl = ptr-&gt;in(0);
5208   Node* ctl = control();
5209   while (ctl != alloc_ctl) {
5210     // There may be guards which feed into the slow_region.
5211     // Any other control flow means that we might not get a chance
5212     // to finish initializing the allocated object.
5213     if ((ctl-&gt;is_IfFalse() || ctl-&gt;is_IfTrue()) &amp;&amp; ctl-&gt;in(0)-&gt;is_If()) {
5214       IfNode* iff = ctl-&gt;in(0)-&gt;as_If();
5215       Node* not_ctl = iff-&gt;proj_out_or_null(1 - ctl-&gt;as_Proj()-&gt;_con);
5216       assert(not_ctl != NULL &amp;&amp; not_ctl != ctl, &quot;found alternate&quot;);
5217       if (slow_region != NULL &amp;&amp; slow_region-&gt;find_edge(not_ctl) &gt;= 1) {
5218         ctl = iff-&gt;in(0);       // This test feeds the known slow_region.
5219         continue;
5220       }
5221       // One more try:  Various low-level checks bottom out in
5222       // uncommon traps.  If the debug-info of the trap omits
5223       // any reference to the allocation, as we&#39;ve already
5224       // observed, then there can be no objection to the trap.
5225       bool found_trap = false;
5226       for (DUIterator_Fast jmax, j = not_ctl-&gt;fast_outs(jmax); j &lt; jmax; j++) {
5227         Node* obs = not_ctl-&gt;fast_out(j);
5228         if (obs-&gt;in(0) == not_ctl &amp;&amp; obs-&gt;is_Call() &amp;&amp;
5229             (obs-&gt;as_Call()-&gt;entry_point() == SharedRuntime::uncommon_trap_blob()-&gt;entry_point())) {
5230           found_trap = true; break;
5231         }
5232       }
5233       if (found_trap) {
5234         ctl = iff-&gt;in(0);       // This test feeds a harmless uncommon trap.
5235         continue;
5236       }
5237     }
5238     return NULL;
5239   }
5240 
5241   // If we get this far, we have an allocation which immediately
5242   // precedes the arraycopy, and we can take over zeroing the new object.
5243   // The arraycopy will finish the initialization, and provide
5244   // a new control state to which we will anchor the destination pointer.
5245 
5246   return alloc;
5247 }
5248 
5249 //-------------inline_encodeISOArray-----------------------------------
5250 // encode char[] to byte[] in ISO_8859_1
5251 bool LibraryCallKit::inline_encodeISOArray() {
5252   assert(callee()-&gt;signature()-&gt;size() == 5, &quot;encodeISOArray has 5 parameters&quot;);
5253   // no receiver since it is static method
5254   Node *src         = argument(0);
5255   Node *src_offset  = argument(1);
5256   Node *dst         = argument(2);
5257   Node *dst_offset  = argument(3);
5258   Node *length      = argument(4);
5259 
5260   src = must_be_not_null(src, true);
5261   dst = must_be_not_null(dst, true);
5262 
5263   const Type* src_type = src-&gt;Value(&amp;_gvn);
5264   const Type* dst_type = dst-&gt;Value(&amp;_gvn);
5265   const TypeAryPtr* top_src = src_type-&gt;isa_aryptr();
5266   const TypeAryPtr* top_dest = dst_type-&gt;isa_aryptr();
5267   if (top_src  == NULL || top_src-&gt;klass()  == NULL ||
5268       top_dest == NULL || top_dest-&gt;klass() == NULL) {
5269     // failed array check
5270     return false;
5271   }
5272 
5273   // Figure out the size and type of the elements we will be copying.
5274   BasicType src_elem = src_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5275   BasicType dst_elem = dst_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5276   if (!((src_elem == T_CHAR) || (src_elem== T_BYTE)) || dst_elem != T_BYTE) {
5277     return false;
5278   }
5279 
5280   Node* src_start = array_element_address(src, src_offset, T_CHAR);
5281   Node* dst_start = array_element_address(dst, dst_offset, dst_elem);
5282   // &#39;src_start&#39; points to src array + scaled offset
5283   // &#39;dst_start&#39; points to dst array + scaled offset
5284 
5285   const TypeAryPtr* mtype = TypeAryPtr::BYTES;
5286   Node* enc = new EncodeISOArrayNode(control(), memory(mtype), src_start, dst_start, length);
5287   enc = _gvn.transform(enc);
5288   Node* res_mem = _gvn.transform(new SCMemProjNode(enc));
5289   set_memory(res_mem, mtype);
5290   set_result(enc);
5291   clear_upper_avx();
5292 
5293   return true;
5294 }
5295 
5296 //-------------inline_multiplyToLen-----------------------------------
5297 bool LibraryCallKit::inline_multiplyToLen() {
5298   assert(UseMultiplyToLenIntrinsic, &quot;not implemented on this platform&quot;);
5299 
5300   address stubAddr = StubRoutines::multiplyToLen();
5301   if (stubAddr == NULL) {
5302     return false; // Intrinsic&#39;s stub is not implemented on this platform
5303   }
5304   const char* stubName = &quot;multiplyToLen&quot;;
5305 
5306   assert(callee()-&gt;signature()-&gt;size() == 5, &quot;multiplyToLen has 5 parameters&quot;);
5307 
5308   // no receiver because it is a static method
5309   Node* x    = argument(0);
5310   Node* xlen = argument(1);
5311   Node* y    = argument(2);
5312   Node* ylen = argument(3);
5313   Node* z    = argument(4);
5314 
5315   x = must_be_not_null(x, true);
5316   y = must_be_not_null(y, true);
5317 
5318   const Type* x_type = x-&gt;Value(&amp;_gvn);
5319   const Type* y_type = y-&gt;Value(&amp;_gvn);
5320   const TypeAryPtr* top_x = x_type-&gt;isa_aryptr();
5321   const TypeAryPtr* top_y = y_type-&gt;isa_aryptr();
5322   if (top_x  == NULL || top_x-&gt;klass()  == NULL ||
5323       top_y == NULL || top_y-&gt;klass() == NULL) {
5324     // failed array check
5325     return false;
5326   }
5327 
5328   BasicType x_elem = x_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5329   BasicType y_elem = y_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5330   if (x_elem != T_INT || y_elem != T_INT) {
5331     return false;
5332   }
5333 
5334   // Set the original stack and the reexecute bit for the interpreter to reexecute
5335   // the bytecode that invokes BigInteger.multiplyToLen() if deoptimization happens
5336   // on the return from z array allocation in runtime.
5337   { PreserveReexecuteState preexecs(this);
5338     jvms()-&gt;set_should_reexecute(true);
5339 
5340     Node* x_start = array_element_address(x, intcon(0), x_elem);
5341     Node* y_start = array_element_address(y, intcon(0), y_elem);
5342     // &#39;x_start&#39; points to x array + scaled xlen
5343     // &#39;y_start&#39; points to y array + scaled ylen
5344 
5345     // Allocate the result array
5346     Node* zlen = _gvn.transform(new AddINode(xlen, ylen));
5347     ciKlass* klass = ciTypeArrayKlass::make(T_INT);
5348     Node* klass_node = makecon(TypeKlassPtr::make(klass));
5349 
5350     IdealKit ideal(this);
5351 
5352 #define __ ideal.
5353      Node* one = __ ConI(1);
5354      Node* zero = __ ConI(0);
5355      IdealVariable need_alloc(ideal), z_alloc(ideal);  __ declarations_done();
5356      __ set(need_alloc, zero);
5357      __ set(z_alloc, z);
5358      __ if_then(z, BoolTest::eq, null()); {
5359        __ increment (need_alloc, one);
5360      } __ else_(); {
5361        // Update graphKit memory and control from IdealKit.
5362        sync_kit(ideal);
5363        Node *cast = new CastPPNode(z, TypePtr::NOTNULL);
5364        cast-&gt;init_req(0, control());
5365        _gvn.set_type(cast, cast-&gt;bottom_type());
5366        C-&gt;record_for_igvn(cast);
5367 
5368        Node* zlen_arg = load_array_length(cast);
5369        // Update IdealKit memory and control from graphKit.
5370        __ sync_kit(this);
5371        __ if_then(zlen_arg, BoolTest::lt, zlen); {
5372          __ increment (need_alloc, one);
5373        } __ end_if();
5374      } __ end_if();
5375 
5376      __ if_then(__ value(need_alloc), BoolTest::ne, zero); {
5377        // Update graphKit memory and control from IdealKit.
5378        sync_kit(ideal);
5379        Node * narr = new_array(klass_node, zlen, 1);
5380        // Update IdealKit memory and control from graphKit.
5381        __ sync_kit(this);
5382        __ set(z_alloc, narr);
5383      } __ end_if();
5384 
5385      sync_kit(ideal);
5386      z = __ value(z_alloc);
5387      // Can&#39;t use TypeAryPtr::INTS which uses Bottom offset.
5388      _gvn.set_type(z, TypeOopPtr::make_from_klass(klass));
5389      // Final sync IdealKit and GraphKit.
5390      final_sync(ideal);
5391 #undef __
5392 
5393     Node* z_start = array_element_address(z, intcon(0), T_INT);
5394 
5395     Node* call = make_runtime_call(RC_LEAF|RC_NO_FP,
5396                                    OptoRuntime::multiplyToLen_Type(),
5397                                    stubAddr, stubName, TypePtr::BOTTOM,
5398                                    x_start, xlen, y_start, ylen, z_start, zlen);
5399   } // original reexecute is set back here
5400 
5401   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
5402   set_result(z);
5403   return true;
5404 }
5405 
5406 //-------------inline_squareToLen------------------------------------
5407 bool LibraryCallKit::inline_squareToLen() {
5408   assert(UseSquareToLenIntrinsic, &quot;not implemented on this platform&quot;);
5409 
5410   address stubAddr = StubRoutines::squareToLen();
5411   if (stubAddr == NULL) {
5412     return false; // Intrinsic&#39;s stub is not implemented on this platform
5413   }
5414   const char* stubName = &quot;squareToLen&quot;;
5415 
5416   assert(callee()-&gt;signature()-&gt;size() == 4, &quot;implSquareToLen has 4 parameters&quot;);
5417 
5418   Node* x    = argument(0);
5419   Node* len  = argument(1);
5420   Node* z    = argument(2);
5421   Node* zlen = argument(3);
5422 
5423   x = must_be_not_null(x, true);
5424   z = must_be_not_null(z, true);
5425 
5426   const Type* x_type = x-&gt;Value(&amp;_gvn);
5427   const Type* z_type = z-&gt;Value(&amp;_gvn);
5428   const TypeAryPtr* top_x = x_type-&gt;isa_aryptr();
5429   const TypeAryPtr* top_z = z_type-&gt;isa_aryptr();
5430   if (top_x  == NULL || top_x-&gt;klass()  == NULL ||
5431       top_z  == NULL || top_z-&gt;klass()  == NULL) {
5432     // failed array check
5433     return false;
5434   }
5435 
5436   BasicType x_elem = x_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5437   BasicType z_elem = z_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5438   if (x_elem != T_INT || z_elem != T_INT) {
5439     return false;
5440   }
5441 
5442 
5443   Node* x_start = array_element_address(x, intcon(0), x_elem);
5444   Node* z_start = array_element_address(z, intcon(0), z_elem);
5445 
5446   Node*  call = make_runtime_call(RC_LEAF|RC_NO_FP,
5447                                   OptoRuntime::squareToLen_Type(),
5448                                   stubAddr, stubName, TypePtr::BOTTOM,
5449                                   x_start, len, z_start, zlen);
5450 
5451   set_result(z);
5452   return true;
5453 }
5454 
5455 //-------------inline_mulAdd------------------------------------------
5456 bool LibraryCallKit::inline_mulAdd() {
5457   assert(UseMulAddIntrinsic, &quot;not implemented on this platform&quot;);
5458 
5459   address stubAddr = StubRoutines::mulAdd();
5460   if (stubAddr == NULL) {
5461     return false; // Intrinsic&#39;s stub is not implemented on this platform
5462   }
5463   const char* stubName = &quot;mulAdd&quot;;
5464 
5465   assert(callee()-&gt;signature()-&gt;size() == 5, &quot;mulAdd has 5 parameters&quot;);
5466 
5467   Node* out      = argument(0);
5468   Node* in       = argument(1);
5469   Node* offset   = argument(2);
5470   Node* len      = argument(3);
5471   Node* k        = argument(4);
5472 
5473   out = must_be_not_null(out, true);
5474 
5475   const Type* out_type = out-&gt;Value(&amp;_gvn);
5476   const Type* in_type = in-&gt;Value(&amp;_gvn);
5477   const TypeAryPtr* top_out = out_type-&gt;isa_aryptr();
5478   const TypeAryPtr* top_in = in_type-&gt;isa_aryptr();
5479   if (top_out  == NULL || top_out-&gt;klass()  == NULL ||
5480       top_in == NULL || top_in-&gt;klass() == NULL) {
5481     // failed array check
5482     return false;
5483   }
5484 
5485   BasicType out_elem = out_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5486   BasicType in_elem = in_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5487   if (out_elem != T_INT || in_elem != T_INT) {
5488     return false;
5489   }
5490 
5491   Node* outlen = load_array_length(out);
5492   Node* new_offset = _gvn.transform(new SubINode(outlen, offset));
5493   Node* out_start = array_element_address(out, intcon(0), out_elem);
5494   Node* in_start = array_element_address(in, intcon(0), in_elem);
5495 
5496   Node*  call = make_runtime_call(RC_LEAF|RC_NO_FP,
5497                                   OptoRuntime::mulAdd_Type(),
5498                                   stubAddr, stubName, TypePtr::BOTTOM,
5499                                   out_start,in_start, new_offset, len, k);
5500   Node* result = _gvn.transform(new ProjNode(call, TypeFunc::Parms));
5501   set_result(result);
5502   return true;
5503 }
5504 
5505 //-------------inline_montgomeryMultiply-----------------------------------
5506 bool LibraryCallKit::inline_montgomeryMultiply() {
5507   address stubAddr = StubRoutines::montgomeryMultiply();
5508   if (stubAddr == NULL) {
5509     return false; // Intrinsic&#39;s stub is not implemented on this platform
5510   }
5511 
5512   assert(UseMontgomeryMultiplyIntrinsic, &quot;not implemented on this platform&quot;);
5513   const char* stubName = &quot;montgomery_multiply&quot;;
5514 
5515   assert(callee()-&gt;signature()-&gt;size() == 7, &quot;montgomeryMultiply has 7 parameters&quot;);
5516 
5517   Node* a    = argument(0);
5518   Node* b    = argument(1);
5519   Node* n    = argument(2);
5520   Node* len  = argument(3);
5521   Node* inv  = argument(4);
5522   Node* m    = argument(6);
5523 
5524   const Type* a_type = a-&gt;Value(&amp;_gvn);
5525   const TypeAryPtr* top_a = a_type-&gt;isa_aryptr();
5526   const Type* b_type = b-&gt;Value(&amp;_gvn);
5527   const TypeAryPtr* top_b = b_type-&gt;isa_aryptr();
5528   const Type* n_type = a-&gt;Value(&amp;_gvn);
5529   const TypeAryPtr* top_n = n_type-&gt;isa_aryptr();
5530   const Type* m_type = a-&gt;Value(&amp;_gvn);
5531   const TypeAryPtr* top_m = m_type-&gt;isa_aryptr();
5532   if (top_a  == NULL || top_a-&gt;klass()  == NULL ||
5533       top_b == NULL || top_b-&gt;klass()  == NULL ||
5534       top_n == NULL || top_n-&gt;klass()  == NULL ||
5535       top_m == NULL || top_m-&gt;klass()  == NULL) {
5536     // failed array check
5537     return false;
5538   }
5539 
5540   BasicType a_elem = a_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5541   BasicType b_elem = b_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5542   BasicType n_elem = n_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5543   BasicType m_elem = m_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5544   if (a_elem != T_INT || b_elem != T_INT || n_elem != T_INT || m_elem != T_INT) {
5545     return false;
5546   }
5547 
5548   // Make the call
5549   {
5550     Node* a_start = array_element_address(a, intcon(0), a_elem);
5551     Node* b_start = array_element_address(b, intcon(0), b_elem);
5552     Node* n_start = array_element_address(n, intcon(0), n_elem);
5553     Node* m_start = array_element_address(m, intcon(0), m_elem);
5554 
5555     Node* call = make_runtime_call(RC_LEAF,
5556                                    OptoRuntime::montgomeryMultiply_Type(),
5557                                    stubAddr, stubName, TypePtr::BOTTOM,
5558                                    a_start, b_start, n_start, len, inv, top(),
5559                                    m_start);
5560     set_result(m);
5561   }
5562 
5563   return true;
5564 }
5565 
5566 bool LibraryCallKit::inline_montgomerySquare() {
5567   address stubAddr = StubRoutines::montgomerySquare();
5568   if (stubAddr == NULL) {
5569     return false; // Intrinsic&#39;s stub is not implemented on this platform
5570   }
5571 
5572   assert(UseMontgomerySquareIntrinsic, &quot;not implemented on this platform&quot;);
5573   const char* stubName = &quot;montgomery_square&quot;;
5574 
5575   assert(callee()-&gt;signature()-&gt;size() == 6, &quot;montgomerySquare has 6 parameters&quot;);
5576 
5577   Node* a    = argument(0);
5578   Node* n    = argument(1);
5579   Node* len  = argument(2);
5580   Node* inv  = argument(3);
5581   Node* m    = argument(5);
5582 
5583   const Type* a_type = a-&gt;Value(&amp;_gvn);
5584   const TypeAryPtr* top_a = a_type-&gt;isa_aryptr();
5585   const Type* n_type = a-&gt;Value(&amp;_gvn);
5586   const TypeAryPtr* top_n = n_type-&gt;isa_aryptr();
5587   const Type* m_type = a-&gt;Value(&amp;_gvn);
5588   const TypeAryPtr* top_m = m_type-&gt;isa_aryptr();
5589   if (top_a  == NULL || top_a-&gt;klass()  == NULL ||
5590       top_n == NULL || top_n-&gt;klass()  == NULL ||
5591       top_m == NULL || top_m-&gt;klass()  == NULL) {
5592     // failed array check
5593     return false;
5594   }
5595 
5596   BasicType a_elem = a_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5597   BasicType n_elem = n_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5598   BasicType m_elem = m_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5599   if (a_elem != T_INT || n_elem != T_INT || m_elem != T_INT) {
5600     return false;
5601   }
5602 
5603   // Make the call
5604   {
5605     Node* a_start = array_element_address(a, intcon(0), a_elem);
5606     Node* n_start = array_element_address(n, intcon(0), n_elem);
5607     Node* m_start = array_element_address(m, intcon(0), m_elem);
5608 
5609     Node* call = make_runtime_call(RC_LEAF,
5610                                    OptoRuntime::montgomerySquare_Type(),
5611                                    stubAddr, stubName, TypePtr::BOTTOM,
5612                                    a_start, n_start, len, inv, top(),
5613                                    m_start);
5614     set_result(m);
5615   }
5616 
5617   return true;
5618 }
5619 
5620 bool LibraryCallKit::inline_bigIntegerShift(bool isRightShift) {
5621   address stubAddr = NULL;
5622   const char* stubName = NULL;
5623 
5624   stubAddr = isRightShift? StubRoutines::bigIntegerRightShift(): StubRoutines::bigIntegerLeftShift();
5625   if (stubAddr == NULL) {
5626     return false; // Intrinsic&#39;s stub is not implemented on this platform
5627   }
5628 
5629   stubName = isRightShift? &quot;bigIntegerRightShiftWorker&quot; : &quot;bigIntegerLeftShiftWorker&quot;;
5630 
5631   assert(callee()-&gt;signature()-&gt;size() == 5, &quot;expected 5 arguments&quot;);
5632 
5633   Node* newArr = argument(0);
5634   Node* oldArr = argument(1);
5635   Node* newIdx = argument(2);
5636   Node* shiftCount = argument(3);
5637   Node* numIter = argument(4);
5638 
5639   const Type* newArr_type = newArr-&gt;Value(&amp;_gvn);
5640   const TypeAryPtr* top_newArr = newArr_type-&gt;isa_aryptr();
5641   const Type* oldArr_type = oldArr-&gt;Value(&amp;_gvn);
5642   const TypeAryPtr* top_oldArr = oldArr_type-&gt;isa_aryptr();
5643   if (top_newArr == NULL || top_newArr-&gt;klass() == NULL || top_oldArr == NULL
5644       || top_oldArr-&gt;klass() == NULL) {
5645     return false;
5646   }
5647 
5648   BasicType newArr_elem = newArr_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5649   BasicType oldArr_elem = oldArr_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5650   if (newArr_elem != T_INT || oldArr_elem != T_INT) {
5651     return false;
5652   }
5653 
5654   // Make the call
5655   {
5656     Node* newArr_start = array_element_address(newArr, intcon(0), newArr_elem);
5657     Node* oldArr_start = array_element_address(oldArr, intcon(0), oldArr_elem);
5658 
5659     Node* call = make_runtime_call(RC_LEAF,
5660                                    OptoRuntime::bigIntegerShift_Type(),
5661                                    stubAddr,
5662                                    stubName,
5663                                    TypePtr::BOTTOM,
5664                                    newArr_start,
5665                                    oldArr_start,
5666                                    newIdx,
5667                                    shiftCount,
5668                                    numIter);
5669   }
5670 
5671   return true;
5672 }
5673 
5674 //-------------inline_vectorizedMismatch------------------------------
5675 bool LibraryCallKit::inline_vectorizedMismatch() {
5676   assert(UseVectorizedMismatchIntrinsic, &quot;not implementated on this platform&quot;);
5677 
5678   address stubAddr = StubRoutines::vectorizedMismatch();
5679   if (stubAddr == NULL) {
5680     return false; // Intrinsic&#39;s stub is not implemented on this platform
5681   }
5682   const char* stubName = &quot;vectorizedMismatch&quot;;
5683   int size_l = callee()-&gt;signature()-&gt;size();
5684   assert(callee()-&gt;signature()-&gt;size() == 8, &quot;vectorizedMismatch has 6 parameters&quot;);
5685 
5686   Node* obja = argument(0);
5687   Node* aoffset = argument(1);
5688   Node* objb = argument(3);
5689   Node* boffset = argument(4);
5690   Node* length = argument(6);
5691   Node* scale = argument(7);
5692 
5693   const Type* a_type = obja-&gt;Value(&amp;_gvn);
5694   const Type* b_type = objb-&gt;Value(&amp;_gvn);
5695   const TypeAryPtr* top_a = a_type-&gt;isa_aryptr();
5696   const TypeAryPtr* top_b = b_type-&gt;isa_aryptr();
5697   if (top_a == NULL || top_a-&gt;klass() == NULL ||
5698     top_b == NULL || top_b-&gt;klass() == NULL) {
5699     // failed array check
5700     return false;
5701   }
5702 
5703   Node* call;
5704   jvms()-&gt;set_should_reexecute(true);
5705 
5706   Node* obja_adr = make_unsafe_address(obja, aoffset, ACCESS_READ);
5707   Node* objb_adr = make_unsafe_address(objb, boffset, ACCESS_READ);
5708 
5709   call = make_runtime_call(RC_LEAF,
5710     OptoRuntime::vectorizedMismatch_Type(),
5711     stubAddr, stubName, TypePtr::BOTTOM,
5712     obja_adr, objb_adr, length, scale);
5713 
5714   Node* result = _gvn.transform(new ProjNode(call, TypeFunc::Parms));
5715   set_result(result);
5716   return true;
5717 }
5718 
5719 /**
5720  * Calculate CRC32 for byte.
5721  * int java.util.zip.CRC32.update(int crc, int b)
5722  */
5723 bool LibraryCallKit::inline_updateCRC32() {
5724   assert(UseCRC32Intrinsics, &quot;need AVX and LCMUL instructions support&quot;);
5725   assert(callee()-&gt;signature()-&gt;size() == 2, &quot;update has 2 parameters&quot;);
5726   // no receiver since it is static method
5727   Node* crc  = argument(0); // type: int
5728   Node* b    = argument(1); // type: int
5729 
5730   /*
5731    *    int c = ~ crc;
5732    *    b = timesXtoThe32[(b ^ c) &amp; 0xFF];
5733    *    b = b ^ (c &gt;&gt;&gt; 8);
5734    *    crc = ~b;
5735    */
5736 
5737   Node* M1 = intcon(-1);
5738   crc = _gvn.transform(new XorINode(crc, M1));
5739   Node* result = _gvn.transform(new XorINode(crc, b));
5740   result = _gvn.transform(new AndINode(result, intcon(0xFF)));
5741 
5742   Node* base = makecon(TypeRawPtr::make(StubRoutines::crc_table_addr()));
5743   Node* offset = _gvn.transform(new LShiftINode(result, intcon(0x2)));
5744   Node* adr = basic_plus_adr(top(), base, ConvI2X(offset));
5745   result = make_load(control(), adr, TypeInt::INT, T_INT, MemNode::unordered);
5746 
5747   crc = _gvn.transform(new URShiftINode(crc, intcon(8)));
5748   result = _gvn.transform(new XorINode(crc, result));
5749   result = _gvn.transform(new XorINode(result, M1));
5750   set_result(result);
5751   return true;
5752 }
5753 
5754 /**
5755  * Calculate CRC32 for byte[] array.
5756  * int java.util.zip.CRC32.updateBytes(int crc, byte[] buf, int off, int len)
5757  */
5758 bool LibraryCallKit::inline_updateBytesCRC32() {
5759   assert(UseCRC32Intrinsics, &quot;need AVX and LCMUL instructions support&quot;);
5760   assert(callee()-&gt;signature()-&gt;size() == 4, &quot;updateBytes has 4 parameters&quot;);
5761   // no receiver since it is static method
5762   Node* crc     = argument(0); // type: int
5763   Node* src     = argument(1); // type: oop
5764   Node* offset  = argument(2); // type: int
5765   Node* length  = argument(3); // type: int
5766 
5767   const Type* src_type = src-&gt;Value(&amp;_gvn);
5768   const TypeAryPtr* top_src = src_type-&gt;isa_aryptr();
5769   if (top_src  == NULL || top_src-&gt;klass()  == NULL) {
5770     // failed array check
5771     return false;
5772   }
5773 
5774   // Figure out the size and type of the elements we will be copying.
5775   BasicType src_elem = src_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5776   if (src_elem != T_BYTE) {
5777     return false;
5778   }
5779 
5780   // &#39;src_start&#39; points to src array + scaled offset
5781   src = must_be_not_null(src, true);
5782   Node* src_start = array_element_address(src, offset, src_elem);
5783 
5784   // We assume that range check is done by caller.
5785   // TODO: generate range check (offset+length &lt; src.length) in debug VM.
5786 
5787   // Call the stub.
5788   address stubAddr = StubRoutines::updateBytesCRC32();
5789   const char *stubName = &quot;updateBytesCRC32&quot;;
5790 
5791   Node* call = make_runtime_call(RC_LEAF|RC_NO_FP, OptoRuntime::updateBytesCRC32_Type(),
5792                                  stubAddr, stubName, TypePtr::BOTTOM,
5793                                  crc, src_start, length);
5794   Node* result = _gvn.transform(new ProjNode(call, TypeFunc::Parms));
5795   set_result(result);
5796   return true;
5797 }
5798 
5799 /**
5800  * Calculate CRC32 for ByteBuffer.
5801  * int java.util.zip.CRC32.updateByteBuffer(int crc, long buf, int off, int len)
5802  */
5803 bool LibraryCallKit::inline_updateByteBufferCRC32() {
5804   assert(UseCRC32Intrinsics, &quot;need AVX and LCMUL instructions support&quot;);
5805   assert(callee()-&gt;signature()-&gt;size() == 5, &quot;updateByteBuffer has 4 parameters and one is long&quot;);
5806   // no receiver since it is static method
5807   Node* crc     = argument(0); // type: int
5808   Node* src     = argument(1); // type: long
5809   Node* offset  = argument(3); // type: int
5810   Node* length  = argument(4); // type: int
5811 
5812   src = ConvL2X(src);  // adjust Java long to machine word
5813   Node* base = _gvn.transform(new CastX2PNode(src));
5814   offset = ConvI2X(offset);
5815 
5816   // &#39;src_start&#39; points to src array + scaled offset
5817   Node* src_start = basic_plus_adr(top(), base, offset);
5818 
5819   // Call the stub.
5820   address stubAddr = StubRoutines::updateBytesCRC32();
5821   const char *stubName = &quot;updateBytesCRC32&quot;;
5822 
5823   Node* call = make_runtime_call(RC_LEAF|RC_NO_FP, OptoRuntime::updateBytesCRC32_Type(),
5824                                  stubAddr, stubName, TypePtr::BOTTOM,
5825                                  crc, src_start, length);
5826   Node* result = _gvn.transform(new ProjNode(call, TypeFunc::Parms));
5827   set_result(result);
5828   return true;
5829 }
5830 
5831 //------------------------------get_table_from_crc32c_class-----------------------
5832 Node * LibraryCallKit::get_table_from_crc32c_class(ciInstanceKlass *crc32c_class) {
5833   Node* table = load_field_from_object(NULL, &quot;byteTable&quot;, &quot;[I&quot;, /*is_exact*/ false, /*is_static*/ true, crc32c_class);
5834   assert (table != NULL, &quot;wrong version of java.util.zip.CRC32C&quot;);
5835 
5836   return table;
5837 }
5838 
5839 //------------------------------inline_updateBytesCRC32C-----------------------
5840 //
5841 // Calculate CRC32C for byte[] array.
5842 // int java.util.zip.CRC32C.updateBytes(int crc, byte[] buf, int off, int end)
5843 //
5844 bool LibraryCallKit::inline_updateBytesCRC32C() {
5845   assert(UseCRC32CIntrinsics, &quot;need CRC32C instruction support&quot;);
5846   assert(callee()-&gt;signature()-&gt;size() == 4, &quot;updateBytes has 4 parameters&quot;);
5847   assert(callee()-&gt;holder()-&gt;is_loaded(), &quot;CRC32C class must be loaded&quot;);
5848   // no receiver since it is a static method
5849   Node* crc     = argument(0); // type: int
5850   Node* src     = argument(1); // type: oop
5851   Node* offset  = argument(2); // type: int
5852   Node* end     = argument(3); // type: int
5853 
5854   Node* length = _gvn.transform(new SubINode(end, offset));
5855 
5856   const Type* src_type = src-&gt;Value(&amp;_gvn);
5857   const TypeAryPtr* top_src = src_type-&gt;isa_aryptr();
5858   if (top_src  == NULL || top_src-&gt;klass()  == NULL) {
5859     // failed array check
5860     return false;
5861   }
5862 
5863   // Figure out the size and type of the elements we will be copying.
5864   BasicType src_elem = src_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5865   if (src_elem != T_BYTE) {
5866     return false;
5867   }
5868 
5869   // &#39;src_start&#39; points to src array + scaled offset
5870   src = must_be_not_null(src, true);
5871   Node* src_start = array_element_address(src, offset, src_elem);
5872 
5873   // static final int[] byteTable in class CRC32C
5874   Node* table = get_table_from_crc32c_class(callee()-&gt;holder());
5875   table = must_be_not_null(table, true);
5876   Node* table_start = array_element_address(table, intcon(0), T_INT);
5877 
5878   // We assume that range check is done by caller.
5879   // TODO: generate range check (offset+length &lt; src.length) in debug VM.
5880 
5881   // Call the stub.
5882   address stubAddr = StubRoutines::updateBytesCRC32C();
5883   const char *stubName = &quot;updateBytesCRC32C&quot;;
5884 
5885   Node* call = make_runtime_call(RC_LEAF, OptoRuntime::updateBytesCRC32C_Type(),
5886                                  stubAddr, stubName, TypePtr::BOTTOM,
5887                                  crc, src_start, length, table_start);
5888   Node* result = _gvn.transform(new ProjNode(call, TypeFunc::Parms));
5889   set_result(result);
5890   return true;
5891 }
5892 
5893 //------------------------------inline_updateDirectByteBufferCRC32C-----------------------
5894 //
5895 // Calculate CRC32C for DirectByteBuffer.
5896 // int java.util.zip.CRC32C.updateDirectByteBuffer(int crc, long buf, int off, int end)
5897 //
5898 bool LibraryCallKit::inline_updateDirectByteBufferCRC32C() {
5899   assert(UseCRC32CIntrinsics, &quot;need CRC32C instruction support&quot;);
5900   assert(callee()-&gt;signature()-&gt;size() == 5, &quot;updateDirectByteBuffer has 4 parameters and one is long&quot;);
5901   assert(callee()-&gt;holder()-&gt;is_loaded(), &quot;CRC32C class must be loaded&quot;);
5902   // no receiver since it is a static method
5903   Node* crc     = argument(0); // type: int
5904   Node* src     = argument(1); // type: long
5905   Node* offset  = argument(3); // type: int
5906   Node* end     = argument(4); // type: int
5907 
5908   Node* length = _gvn.transform(new SubINode(end, offset));
5909 
5910   src = ConvL2X(src);  // adjust Java long to machine word
5911   Node* base = _gvn.transform(new CastX2PNode(src));
5912   offset = ConvI2X(offset);
5913 
5914   // &#39;src_start&#39; points to src array + scaled offset
5915   Node* src_start = basic_plus_adr(top(), base, offset);
5916 
5917   // static final int[] byteTable in class CRC32C
5918   Node* table = get_table_from_crc32c_class(callee()-&gt;holder());
5919   table = must_be_not_null(table, true);
5920   Node* table_start = array_element_address(table, intcon(0), T_INT);
5921 
5922   // Call the stub.
5923   address stubAddr = StubRoutines::updateBytesCRC32C();
5924   const char *stubName = &quot;updateBytesCRC32C&quot;;
5925 
5926   Node* call = make_runtime_call(RC_LEAF, OptoRuntime::updateBytesCRC32C_Type(),
5927                                  stubAddr, stubName, TypePtr::BOTTOM,
5928                                  crc, src_start, length, table_start);
5929   Node* result = _gvn.transform(new ProjNode(call, TypeFunc::Parms));
5930   set_result(result);
5931   return true;
5932 }
5933 
5934 //------------------------------inline_updateBytesAdler32----------------------
5935 //
5936 // Calculate Adler32 checksum for byte[] array.
5937 // int java.util.zip.Adler32.updateBytes(int crc, byte[] buf, int off, int len)
5938 //
5939 bool LibraryCallKit::inline_updateBytesAdler32() {
5940   assert(UseAdler32Intrinsics, &quot;Adler32 Instrinsic support need&quot;); // check if we actually need to check this flag or check a different one
5941   assert(callee()-&gt;signature()-&gt;size() == 4, &quot;updateBytes has 4 parameters&quot;);
5942   assert(callee()-&gt;holder()-&gt;is_loaded(), &quot;Adler32 class must be loaded&quot;);
5943   // no receiver since it is static method
5944   Node* crc     = argument(0); // type: int
5945   Node* src     = argument(1); // type: oop
5946   Node* offset  = argument(2); // type: int
5947   Node* length  = argument(3); // type: int
5948 
5949   const Type* src_type = src-&gt;Value(&amp;_gvn);
5950   const TypeAryPtr* top_src = src_type-&gt;isa_aryptr();
5951   if (top_src  == NULL || top_src-&gt;klass()  == NULL) {
5952     // failed array check
5953     return false;
5954   }
5955 
5956   // Figure out the size and type of the elements we will be copying.
5957   BasicType src_elem = src_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
5958   if (src_elem != T_BYTE) {
5959     return false;
5960   }
5961 
5962   // &#39;src_start&#39; points to src array + scaled offset
5963   Node* src_start = array_element_address(src, offset, src_elem);
5964 
5965   // We assume that range check is done by caller.
5966   // TODO: generate range check (offset+length &lt; src.length) in debug VM.
5967 
5968   // Call the stub.
5969   address stubAddr = StubRoutines::updateBytesAdler32();
5970   const char *stubName = &quot;updateBytesAdler32&quot;;
5971 
5972   Node* call = make_runtime_call(RC_LEAF, OptoRuntime::updateBytesAdler32_Type(),
5973                                  stubAddr, stubName, TypePtr::BOTTOM,
5974                                  crc, src_start, length);
5975   Node* result = _gvn.transform(new ProjNode(call, TypeFunc::Parms));
5976   set_result(result);
5977   return true;
5978 }
5979 
5980 //------------------------------inline_updateByteBufferAdler32---------------
5981 //
5982 // Calculate Adler32 checksum for DirectByteBuffer.
5983 // int java.util.zip.Adler32.updateByteBuffer(int crc, long buf, int off, int len)
5984 //
5985 bool LibraryCallKit::inline_updateByteBufferAdler32() {
5986   assert(UseAdler32Intrinsics, &quot;Adler32 Instrinsic support need&quot;); // check if we actually need to check this flag or check a different one
5987   assert(callee()-&gt;signature()-&gt;size() == 5, &quot;updateByteBuffer has 4 parameters and one is long&quot;);
5988   assert(callee()-&gt;holder()-&gt;is_loaded(), &quot;Adler32 class must be loaded&quot;);
5989   // no receiver since it is static method
5990   Node* crc     = argument(0); // type: int
5991   Node* src     = argument(1); // type: long
5992   Node* offset  = argument(3); // type: int
5993   Node* length  = argument(4); // type: int
5994 
5995   src = ConvL2X(src);  // adjust Java long to machine word
5996   Node* base = _gvn.transform(new CastX2PNode(src));
5997   offset = ConvI2X(offset);
5998 
5999   // &#39;src_start&#39; points to src array + scaled offset
6000   Node* src_start = basic_plus_adr(top(), base, offset);
6001 
6002   // Call the stub.
6003   address stubAddr = StubRoutines::updateBytesAdler32();
6004   const char *stubName = &quot;updateBytesAdler32&quot;;
6005 
6006   Node* call = make_runtime_call(RC_LEAF, OptoRuntime::updateBytesAdler32_Type(),
6007                                  stubAddr, stubName, TypePtr::BOTTOM,
6008                                  crc, src_start, length);
6009 
6010   Node* result = _gvn.transform(new ProjNode(call, TypeFunc::Parms));
6011   set_result(result);
6012   return true;
6013 }
6014 
6015 //----------------------------inline_reference_get----------------------------
6016 // public T java.lang.ref.Reference.get();
6017 bool LibraryCallKit::inline_reference_get() {
6018   const int referent_offset = java_lang_ref_Reference::referent_offset;
6019   guarantee(referent_offset &gt; 0, &quot;should have already been set&quot;);
6020 
6021   // Get the argument:
6022   Node* reference_obj = null_check_receiver();
6023   if (stopped()) return true;
6024 
6025   const TypeInstPtr* tinst = _gvn.type(reference_obj)-&gt;isa_instptr();
6026   assert(tinst != NULL, &quot;obj is null&quot;);
6027   assert(tinst-&gt;klass()-&gt;is_loaded(), &quot;obj is not loaded&quot;);
6028   ciInstanceKlass* referenceKlass = tinst-&gt;klass()-&gt;as_instance_klass();
6029   ciField* field = referenceKlass-&gt;get_field_by_name(ciSymbol::make(&quot;referent&quot;),
6030                                                      ciSymbol::make(&quot;Ljava/lang/Object;&quot;),
6031                                                      false);
6032   assert (field != NULL, &quot;undefined field&quot;);
6033 
6034   Node* adr = basic_plus_adr(reference_obj, reference_obj, referent_offset);
6035   const TypePtr* adr_type = C-&gt;alias_type(field)-&gt;adr_type();
6036 
6037   ciInstanceKlass* klass = env()-&gt;Object_klass();
6038   const TypeOopPtr* object_type = TypeOopPtr::make_from_klass(klass);
6039 
6040   DecoratorSet decorators = IN_HEAP | ON_WEAK_OOP_REF;
6041   Node* result = access_load_at(reference_obj, adr, adr_type, object_type, T_OBJECT, decorators);
6042   // Add memory barrier to prevent commoning reads from this field
6043   // across safepoint since GC can change its value.
6044   insert_mem_bar(Op_MemBarCPUOrder);
6045 
6046   set_result(result);
6047   return true;
6048 }
6049 
6050 
6051 Node * LibraryCallKit::load_field_from_object(Node * fromObj, const char * fieldName, const char * fieldTypeString,
6052                                               bool is_exact=true, bool is_static=false,
6053                                               ciInstanceKlass * fromKls=NULL) {
6054   if (fromKls == NULL) {
6055     const TypeInstPtr* tinst = _gvn.type(fromObj)-&gt;isa_instptr();
6056     assert(tinst != NULL, &quot;obj is null&quot;);
6057     assert(tinst-&gt;klass()-&gt;is_loaded(), &quot;obj is not loaded&quot;);
6058     assert(!is_exact || tinst-&gt;klass_is_exact(), &quot;klass not exact&quot;);
6059     fromKls = tinst-&gt;klass()-&gt;as_instance_klass();
6060   } else {
6061     assert(is_static, &quot;only for static field access&quot;);
6062   }
6063   ciField* field = fromKls-&gt;get_field_by_name(ciSymbol::make(fieldName),
6064                                               ciSymbol::make(fieldTypeString),
6065                                               is_static);
6066 
6067   assert (field != NULL, &quot;undefined field&quot;);
6068   if (field == NULL) return (Node *) NULL;
6069 
6070   if (is_static) {
6071     const TypeInstPtr* tip = TypeInstPtr::make(fromKls-&gt;java_mirror());
6072     fromObj = makecon(tip);
6073   }
6074 
6075   // Next code  copied from Parse::do_get_xxx():
6076 
6077   // Compute address and memory type.
6078   int offset  = field-&gt;offset_in_bytes();
6079   bool is_vol = field-&gt;is_volatile();
6080   ciType* field_klass = field-&gt;type();
6081   assert(field_klass-&gt;is_loaded(), &quot;should be loaded&quot;);
6082   const TypePtr* adr_type = C-&gt;alias_type(field)-&gt;adr_type();
6083   Node *adr = basic_plus_adr(fromObj, fromObj, offset);
6084   BasicType bt = field-&gt;layout_type();
6085 
6086   // Build the resultant type of the load
6087   const Type *type;
6088   if (bt == T_OBJECT) {
6089     type = TypeOopPtr::make_from_klass(field_klass-&gt;as_klass());
6090   } else {
6091     type = Type::get_const_basic_type(bt);
6092   }
6093 
6094   DecoratorSet decorators = IN_HEAP;
6095 
6096   if (is_vol) {
6097     decorators |= MO_SEQ_CST;
6098   }
6099 
6100   return access_load_at(fromObj, adr, adr_type, type, bt, decorators);
6101 }
6102 
6103 Node * LibraryCallKit::field_address_from_object(Node * fromObj, const char * fieldName, const char * fieldTypeString,
6104                                                  bool is_exact = true, bool is_static = false,
6105                                                  ciInstanceKlass * fromKls = NULL) {
6106   if (fromKls == NULL) {
6107     const TypeInstPtr* tinst = _gvn.type(fromObj)-&gt;isa_instptr();
6108     assert(tinst != NULL, &quot;obj is null&quot;);
6109     assert(tinst-&gt;klass()-&gt;is_loaded(), &quot;obj is not loaded&quot;);
6110     assert(!is_exact || tinst-&gt;klass_is_exact(), &quot;klass not exact&quot;);
6111     fromKls = tinst-&gt;klass()-&gt;as_instance_klass();
6112   }
6113   else {
6114     assert(is_static, &quot;only for static field access&quot;);
6115   }
6116   ciField* field = fromKls-&gt;get_field_by_name(ciSymbol::make(fieldName),
6117     ciSymbol::make(fieldTypeString),
6118     is_static);
6119 
6120   assert(field != NULL, &quot;undefined field&quot;);
6121   assert(!field-&gt;is_volatile(), &quot;not defined for volatile fields&quot;);
6122 
6123   if (is_static) {
6124     const TypeInstPtr* tip = TypeInstPtr::make(fromKls-&gt;java_mirror());
6125     fromObj = makecon(tip);
6126   }
6127 
6128   // Next code  copied from Parse::do_get_xxx():
6129 
6130   // Compute address and memory type.
6131   int offset = field-&gt;offset_in_bytes();
6132   Node *adr = basic_plus_adr(fromObj, fromObj, offset);
6133 
6134   return adr;
6135 }
6136 
6137 //------------------------------inline_aescrypt_Block-----------------------
6138 bool LibraryCallKit::inline_aescrypt_Block(vmIntrinsics::ID id) {
6139   address stubAddr = NULL;
6140   const char *stubName;
6141   assert(UseAES, &quot;need AES instruction support&quot;);
6142 
6143   switch(id) {
6144   case vmIntrinsics::_aescrypt_encryptBlock:
6145     stubAddr = StubRoutines::aescrypt_encryptBlock();
6146     stubName = &quot;aescrypt_encryptBlock&quot;;
6147     break;
6148   case vmIntrinsics::_aescrypt_decryptBlock:
6149     stubAddr = StubRoutines::aescrypt_decryptBlock();
6150     stubName = &quot;aescrypt_decryptBlock&quot;;
6151     break;
6152   default:
6153     break;
6154   }
6155   if (stubAddr == NULL) return false;
6156 
6157   Node* aescrypt_object = argument(0);
6158   Node* src             = argument(1);
6159   Node* src_offset      = argument(2);
6160   Node* dest            = argument(3);
6161   Node* dest_offset     = argument(4);
6162 
6163   src = must_be_not_null(src, true);
6164   dest = must_be_not_null(dest, true);
6165 
6166   // (1) src and dest are arrays.
6167   const Type* src_type = src-&gt;Value(&amp;_gvn);
6168   const Type* dest_type = dest-&gt;Value(&amp;_gvn);
6169   const TypeAryPtr* top_src = src_type-&gt;isa_aryptr();
6170   const TypeAryPtr* top_dest = dest_type-&gt;isa_aryptr();
6171   assert (top_src  != NULL &amp;&amp; top_src-&gt;klass()  != NULL &amp;&amp;  top_dest != NULL &amp;&amp; top_dest-&gt;klass() != NULL, &quot;args are strange&quot;);
6172 
6173   // for the quick and dirty code we will skip all the checks.
6174   // we are just trying to get the call to be generated.
6175   Node* src_start  = src;
6176   Node* dest_start = dest;
6177   if (src_offset != NULL || dest_offset != NULL) {
6178     assert(src_offset != NULL &amp;&amp; dest_offset != NULL, &quot;&quot;);
6179     src_start  = array_element_address(src,  src_offset,  T_BYTE);
6180     dest_start = array_element_address(dest, dest_offset, T_BYTE);
6181   }
6182 
6183   // now need to get the start of its expanded key array
6184   // this requires a newer class file that has this array as littleEndian ints, otherwise we revert to java
6185   Node* k_start = get_key_start_from_aescrypt_object(aescrypt_object);
6186   if (k_start == NULL) return false;
6187 
6188   if (Matcher::pass_original_key_for_aes()) {
6189     // on SPARC we need to pass the original key since key expansion needs to happen in intrinsics due to
6190     // compatibility issues between Java key expansion and SPARC crypto instructions
6191     Node* original_k_start = get_original_key_start_from_aescrypt_object(aescrypt_object);
6192     if (original_k_start == NULL) return false;
6193 
6194     // Call the stub.
6195     make_runtime_call(RC_LEAF|RC_NO_FP, OptoRuntime::aescrypt_block_Type(),
6196                       stubAddr, stubName, TypePtr::BOTTOM,
6197                       src_start, dest_start, k_start, original_k_start);
6198   } else {
6199     // Call the stub.
6200     make_runtime_call(RC_LEAF|RC_NO_FP, OptoRuntime::aescrypt_block_Type(),
6201                       stubAddr, stubName, TypePtr::BOTTOM,
6202                       src_start, dest_start, k_start);
6203   }
6204 
6205   return true;
6206 }
6207 
6208 //------------------------------inline_cipherBlockChaining_AESCrypt-----------------------
6209 bool LibraryCallKit::inline_cipherBlockChaining_AESCrypt(vmIntrinsics::ID id) {
6210   address stubAddr = NULL;
6211   const char *stubName = NULL;
6212 
6213   assert(UseAES, &quot;need AES instruction support&quot;);
6214 
6215   switch(id) {
6216   case vmIntrinsics::_cipherBlockChaining_encryptAESCrypt:
6217     stubAddr = StubRoutines::cipherBlockChaining_encryptAESCrypt();
6218     stubName = &quot;cipherBlockChaining_encryptAESCrypt&quot;;
6219     break;
6220   case vmIntrinsics::_cipherBlockChaining_decryptAESCrypt:
6221     stubAddr = StubRoutines::cipherBlockChaining_decryptAESCrypt();
6222     stubName = &quot;cipherBlockChaining_decryptAESCrypt&quot;;
6223     break;
6224   default:
6225     break;
6226   }
6227   if (stubAddr == NULL) return false;
6228 
6229   Node* cipherBlockChaining_object = argument(0);
6230   Node* src                        = argument(1);
6231   Node* src_offset                 = argument(2);
6232   Node* len                        = argument(3);
6233   Node* dest                       = argument(4);
6234   Node* dest_offset                = argument(5);
6235 
6236   src = must_be_not_null(src, false);
6237   dest = must_be_not_null(dest, false);
6238 
6239   // (1) src and dest are arrays.
6240   const Type* src_type = src-&gt;Value(&amp;_gvn);
6241   const Type* dest_type = dest-&gt;Value(&amp;_gvn);
6242   const TypeAryPtr* top_src = src_type-&gt;isa_aryptr();
6243   const TypeAryPtr* top_dest = dest_type-&gt;isa_aryptr();
6244   assert (top_src  != NULL &amp;&amp; top_src-&gt;klass()  != NULL
6245           &amp;&amp;  top_dest != NULL &amp;&amp; top_dest-&gt;klass() != NULL, &quot;args are strange&quot;);
6246 
6247   // checks are the responsibility of the caller
6248   Node* src_start  = src;
6249   Node* dest_start = dest;
6250   if (src_offset != NULL || dest_offset != NULL) {
6251     assert(src_offset != NULL &amp;&amp; dest_offset != NULL, &quot;&quot;);
6252     src_start  = array_element_address(src,  src_offset,  T_BYTE);
6253     dest_start = array_element_address(dest, dest_offset, T_BYTE);
6254   }
6255 
6256   // if we are in this set of code, we &quot;know&quot; the embeddedCipher is an AESCrypt object
6257   // (because of the predicated logic executed earlier).
6258   // so we cast it here safely.
6259   // this requires a newer class file that has this array as littleEndian ints, otherwise we revert to java
6260 
6261   Node* embeddedCipherObj = load_field_from_object(cipherBlockChaining_object, &quot;embeddedCipher&quot;, &quot;Lcom/sun/crypto/provider/SymmetricCipher;&quot;, /*is_exact*/ false);
6262   if (embeddedCipherObj == NULL) return false;
6263 
6264   // cast it to what we know it will be at runtime
6265   const TypeInstPtr* tinst = _gvn.type(cipherBlockChaining_object)-&gt;isa_instptr();
6266   assert(tinst != NULL, &quot;CBC obj is null&quot;);
6267   assert(tinst-&gt;klass()-&gt;is_loaded(), &quot;CBC obj is not loaded&quot;);
6268   ciKlass* klass_AESCrypt = tinst-&gt;klass()-&gt;as_instance_klass()-&gt;find_klass(ciSymbol::make(&quot;com/sun/crypto/provider/AESCrypt&quot;));
6269   assert(klass_AESCrypt-&gt;is_loaded(), &quot;predicate checks that this class is loaded&quot;);
6270 
6271   ciInstanceKlass* instklass_AESCrypt = klass_AESCrypt-&gt;as_instance_klass();
6272   const TypeKlassPtr* aklass = TypeKlassPtr::make(instklass_AESCrypt);
6273   const TypeOopPtr* xtype = aklass-&gt;as_instance_type();
6274   Node* aescrypt_object = new CheckCastPPNode(control(), embeddedCipherObj, xtype);
6275   aescrypt_object = _gvn.transform(aescrypt_object);
6276 
6277   // we need to get the start of the aescrypt_object&#39;s expanded key array
6278   Node* k_start = get_key_start_from_aescrypt_object(aescrypt_object);
6279   if (k_start == NULL) return false;
6280 
6281   // similarly, get the start address of the r vector
6282   Node* objRvec = load_field_from_object(cipherBlockChaining_object, &quot;r&quot;, &quot;[B&quot;, /*is_exact*/ false);
6283   if (objRvec == NULL) return false;
6284   Node* r_start = array_element_address(objRvec, intcon(0), T_BYTE);
6285 
6286   Node* cbcCrypt;
6287   if (Matcher::pass_original_key_for_aes()) {
6288     // on SPARC we need to pass the original key since key expansion needs to happen in intrinsics due to
6289     // compatibility issues between Java key expansion and SPARC crypto instructions
6290     Node* original_k_start = get_original_key_start_from_aescrypt_object(aescrypt_object);
6291     if (original_k_start == NULL) return false;
6292 
6293     // Call the stub, passing src_start, dest_start, k_start, r_start, src_len and original_k_start
6294     cbcCrypt = make_runtime_call(RC_LEAF|RC_NO_FP,
6295                                  OptoRuntime::cipherBlockChaining_aescrypt_Type(),
6296                                  stubAddr, stubName, TypePtr::BOTTOM,
6297                                  src_start, dest_start, k_start, r_start, len, original_k_start);
6298   } else {
6299     // Call the stub, passing src_start, dest_start, k_start, r_start and src_len
6300     cbcCrypt = make_runtime_call(RC_LEAF|RC_NO_FP,
6301                                  OptoRuntime::cipherBlockChaining_aescrypt_Type(),
6302                                  stubAddr, stubName, TypePtr::BOTTOM,
6303                                  src_start, dest_start, k_start, r_start, len);
6304   }
6305 
6306   // return cipher length (int)
6307   Node* retvalue = _gvn.transform(new ProjNode(cbcCrypt, TypeFunc::Parms));
6308   set_result(retvalue);
6309   return true;
6310 }
6311 
6312 //------------------------------inline_electronicCodeBook_AESCrypt-----------------------
6313 bool LibraryCallKit::inline_electronicCodeBook_AESCrypt(vmIntrinsics::ID id) {
6314   address stubAddr = NULL;
6315   const char *stubName = NULL;
6316 
6317   assert(UseAES, &quot;need AES instruction support&quot;);
6318 
6319   switch (id) {
6320   case vmIntrinsics::_electronicCodeBook_encryptAESCrypt:
6321     stubAddr = StubRoutines::electronicCodeBook_encryptAESCrypt();
6322     stubName = &quot;electronicCodeBook_encryptAESCrypt&quot;;
6323     break;
6324   case vmIntrinsics::_electronicCodeBook_decryptAESCrypt:
6325     stubAddr = StubRoutines::electronicCodeBook_decryptAESCrypt();
6326     stubName = &quot;electronicCodeBook_decryptAESCrypt&quot;;
6327     break;
6328   default:
6329     break;
6330   }
6331 
6332   if (stubAddr == NULL) return false;
6333 
6334   Node* electronicCodeBook_object = argument(0);
6335   Node* src                       = argument(1);
6336   Node* src_offset                = argument(2);
6337   Node* len                       = argument(3);
6338   Node* dest                      = argument(4);
6339   Node* dest_offset               = argument(5);
6340 
6341   // (1) src and dest are arrays.
6342   const Type* src_type = src-&gt;Value(&amp;_gvn);
6343   const Type* dest_type = dest-&gt;Value(&amp;_gvn);
6344   const TypeAryPtr* top_src = src_type-&gt;isa_aryptr();
6345   const TypeAryPtr* top_dest = dest_type-&gt;isa_aryptr();
6346   assert(top_src != NULL &amp;&amp; top_src-&gt;klass() != NULL
6347          &amp;&amp;  top_dest != NULL &amp;&amp; top_dest-&gt;klass() != NULL, &quot;args are strange&quot;);
6348 
6349   // checks are the responsibility of the caller
6350   Node* src_start = src;
6351   Node* dest_start = dest;
6352   if (src_offset != NULL || dest_offset != NULL) {
6353     assert(src_offset != NULL &amp;&amp; dest_offset != NULL, &quot;&quot;);
6354     src_start = array_element_address(src, src_offset, T_BYTE);
6355     dest_start = array_element_address(dest, dest_offset, T_BYTE);
6356   }
6357 
6358   // if we are in this set of code, we &quot;know&quot; the embeddedCipher is an AESCrypt object
6359   // (because of the predicated logic executed earlier).
6360   // so we cast it here safely.
6361   // this requires a newer class file that has this array as littleEndian ints, otherwise we revert to java
6362 
6363   Node* embeddedCipherObj = load_field_from_object(electronicCodeBook_object, &quot;embeddedCipher&quot;, &quot;Lcom/sun/crypto/provider/SymmetricCipher;&quot;, /*is_exact*/ false);
6364   if (embeddedCipherObj == NULL) return false;
6365 
6366   // cast it to what we know it will be at runtime
6367   const TypeInstPtr* tinst = _gvn.type(electronicCodeBook_object)-&gt;isa_instptr();
6368   assert(tinst != NULL, &quot;ECB obj is null&quot;);
6369   assert(tinst-&gt;klass()-&gt;is_loaded(), &quot;ECB obj is not loaded&quot;);
6370   ciKlass* klass_AESCrypt = tinst-&gt;klass()-&gt;as_instance_klass()-&gt;find_klass(ciSymbol::make(&quot;com/sun/crypto/provider/AESCrypt&quot;));
6371   assert(klass_AESCrypt-&gt;is_loaded(), &quot;predicate checks that this class is loaded&quot;);
6372 
6373   ciInstanceKlass* instklass_AESCrypt = klass_AESCrypt-&gt;as_instance_klass();
6374   const TypeKlassPtr* aklass = TypeKlassPtr::make(instklass_AESCrypt);
6375   const TypeOopPtr* xtype = aklass-&gt;as_instance_type();
6376   Node* aescrypt_object = new CheckCastPPNode(control(), embeddedCipherObj, xtype);
6377   aescrypt_object = _gvn.transform(aescrypt_object);
6378 
6379   // we need to get the start of the aescrypt_object&#39;s expanded key array
6380   Node* k_start = get_key_start_from_aescrypt_object(aescrypt_object);
6381   if (k_start == NULL) return false;
6382 
6383   Node* ecbCrypt;
6384   if (Matcher::pass_original_key_for_aes()) {
6385     // no SPARC version for AES/ECB intrinsics now.
6386     return false;
6387   }
6388   // Call the stub, passing src_start, dest_start, k_start, r_start and src_len
6389   ecbCrypt = make_runtime_call(RC_LEAF | RC_NO_FP,
6390                                OptoRuntime::electronicCodeBook_aescrypt_Type(),
6391                                stubAddr, stubName, TypePtr::BOTTOM,
6392                                src_start, dest_start, k_start, len);
6393 
6394   // return cipher length (int)
6395   Node* retvalue = _gvn.transform(new ProjNode(ecbCrypt, TypeFunc::Parms));
6396   set_result(retvalue);
6397   return true;
6398 }
6399 
6400 //------------------------------inline_counterMode_AESCrypt-----------------------
6401 bool LibraryCallKit::inline_counterMode_AESCrypt(vmIntrinsics::ID id) {
6402   assert(UseAES, &quot;need AES instruction support&quot;);
6403   if (!UseAESCTRIntrinsics) return false;
6404 
6405   address stubAddr = NULL;
6406   const char *stubName = NULL;
6407   if (id == vmIntrinsics::_counterMode_AESCrypt) {
6408     stubAddr = StubRoutines::counterMode_AESCrypt();
6409     stubName = &quot;counterMode_AESCrypt&quot;;
6410   }
6411   if (stubAddr == NULL) return false;
6412 
6413   Node* counterMode_object = argument(0);
6414   Node* src = argument(1);
6415   Node* src_offset = argument(2);
6416   Node* len = argument(3);
6417   Node* dest = argument(4);
6418   Node* dest_offset = argument(5);
6419 
6420   // (1) src and dest are arrays.
6421   const Type* src_type = src-&gt;Value(&amp;_gvn);
6422   const Type* dest_type = dest-&gt;Value(&amp;_gvn);
6423   const TypeAryPtr* top_src = src_type-&gt;isa_aryptr();
6424   const TypeAryPtr* top_dest = dest_type-&gt;isa_aryptr();
6425   assert(top_src != NULL &amp;&amp; top_src-&gt;klass() != NULL &amp;&amp;
6426          top_dest != NULL &amp;&amp; top_dest-&gt;klass() != NULL, &quot;args are strange&quot;);
6427 
6428   // checks are the responsibility of the caller
6429   Node* src_start = src;
6430   Node* dest_start = dest;
6431   if (src_offset != NULL || dest_offset != NULL) {
6432     assert(src_offset != NULL &amp;&amp; dest_offset != NULL, &quot;&quot;);
6433     src_start = array_element_address(src, src_offset, T_BYTE);
6434     dest_start = array_element_address(dest, dest_offset, T_BYTE);
6435   }
6436 
6437   // if we are in this set of code, we &quot;know&quot; the embeddedCipher is an AESCrypt object
6438   // (because of the predicated logic executed earlier).
6439   // so we cast it here safely.
6440   // this requires a newer class file that has this array as littleEndian ints, otherwise we revert to java
6441   Node* embeddedCipherObj = load_field_from_object(counterMode_object, &quot;embeddedCipher&quot;, &quot;Lcom/sun/crypto/provider/SymmetricCipher;&quot;, /*is_exact*/ false);
6442   if (embeddedCipherObj == NULL) return false;
6443   // cast it to what we know it will be at runtime
6444   const TypeInstPtr* tinst = _gvn.type(counterMode_object)-&gt;isa_instptr();
6445   assert(tinst != NULL, &quot;CTR obj is null&quot;);
6446   assert(tinst-&gt;klass()-&gt;is_loaded(), &quot;CTR obj is not loaded&quot;);
6447   ciKlass* klass_AESCrypt = tinst-&gt;klass()-&gt;as_instance_klass()-&gt;find_klass(ciSymbol::make(&quot;com/sun/crypto/provider/AESCrypt&quot;));
6448   assert(klass_AESCrypt-&gt;is_loaded(), &quot;predicate checks that this class is loaded&quot;);
6449   ciInstanceKlass* instklass_AESCrypt = klass_AESCrypt-&gt;as_instance_klass();
6450   const TypeKlassPtr* aklass = TypeKlassPtr::make(instklass_AESCrypt);
6451   const TypeOopPtr* xtype = aklass-&gt;as_instance_type();
6452   Node* aescrypt_object = new CheckCastPPNode(control(), embeddedCipherObj, xtype);
6453   aescrypt_object = _gvn.transform(aescrypt_object);
6454   // we need to get the start of the aescrypt_object&#39;s expanded key array
6455   Node* k_start = get_key_start_from_aescrypt_object(aescrypt_object);
6456   if (k_start == NULL) return false;
6457   // similarly, get the start address of the r vector
6458   Node* obj_counter = load_field_from_object(counterMode_object, &quot;counter&quot;, &quot;[B&quot;, /*is_exact*/ false);
6459   if (obj_counter == NULL) return false;
6460   Node* cnt_start = array_element_address(obj_counter, intcon(0), T_BYTE);
6461 
6462   Node* saved_encCounter = load_field_from_object(counterMode_object, &quot;encryptedCounter&quot;, &quot;[B&quot;, /*is_exact*/ false);
6463   if (saved_encCounter == NULL) return false;
6464   Node* saved_encCounter_start = array_element_address(saved_encCounter, intcon(0), T_BYTE);
6465   Node* used = field_address_from_object(counterMode_object, &quot;used&quot;, &quot;I&quot;, /*is_exact*/ false);
6466 
6467   Node* ctrCrypt;
6468   if (Matcher::pass_original_key_for_aes()) {
6469     // no SPARC version for AES/CTR intrinsics now.
6470     return false;
6471   }
6472   // Call the stub, passing src_start, dest_start, k_start, r_start and src_len
6473   ctrCrypt = make_runtime_call(RC_LEAF|RC_NO_FP,
6474                                OptoRuntime::counterMode_aescrypt_Type(),
6475                                stubAddr, stubName, TypePtr::BOTTOM,
6476                                src_start, dest_start, k_start, cnt_start, len, saved_encCounter_start, used);
6477 
6478   // return cipher length (int)
6479   Node* retvalue = _gvn.transform(new ProjNode(ctrCrypt, TypeFunc::Parms));
6480   set_result(retvalue);
6481   return true;
6482 }
6483 
6484 //------------------------------get_key_start_from_aescrypt_object-----------------------
6485 Node * LibraryCallKit::get_key_start_from_aescrypt_object(Node *aescrypt_object) {
6486 #if defined(PPC64) || defined(S390)
6487   // MixColumns for decryption can be reduced by preprocessing MixColumns with round keys.
6488   // Intel&#39;s extention is based on this optimization and AESCrypt generates round keys by preprocessing MixColumns.
6489   // However, ppc64 vncipher processes MixColumns and requires the same round keys with encryption.
6490   // The ppc64 stubs of encryption and decryption use the same round keys (sessionK[0]).
6491   Node* objSessionK = load_field_from_object(aescrypt_object, &quot;sessionK&quot;, &quot;[[I&quot;, /*is_exact*/ false);
6492   assert (objSessionK != NULL, &quot;wrong version of com.sun.crypto.provider.AESCrypt&quot;);
6493   if (objSessionK == NULL) {
6494     return (Node *) NULL;
6495   }
6496   Node* objAESCryptKey = load_array_element(control(), objSessionK, intcon(0), TypeAryPtr::OOPS);
6497 #else
6498   Node* objAESCryptKey = load_field_from_object(aescrypt_object, &quot;K&quot;, &quot;[I&quot;, /*is_exact*/ false);
6499 #endif // PPC64
6500   assert (objAESCryptKey != NULL, &quot;wrong version of com.sun.crypto.provider.AESCrypt&quot;);
6501   if (objAESCryptKey == NULL) return (Node *) NULL;
6502 
6503   // now have the array, need to get the start address of the K array
6504   Node* k_start = array_element_address(objAESCryptKey, intcon(0), T_INT);
6505   return k_start;
6506 }
6507 
6508 //------------------------------get_original_key_start_from_aescrypt_object-----------------------
6509 Node * LibraryCallKit::get_original_key_start_from_aescrypt_object(Node *aescrypt_object) {
6510   Node* objAESCryptKey = load_field_from_object(aescrypt_object, &quot;lastKey&quot;, &quot;[B&quot;, /*is_exact*/ false);
6511   assert (objAESCryptKey != NULL, &quot;wrong version of com.sun.crypto.provider.AESCrypt&quot;);
6512   if (objAESCryptKey == NULL) return (Node *) NULL;
6513 
6514   // now have the array, need to get the start address of the lastKey array
6515   Node* original_k_start = array_element_address(objAESCryptKey, intcon(0), T_BYTE);
6516   return original_k_start;
6517 }
6518 
6519 //----------------------------inline_cipherBlockChaining_AESCrypt_predicate----------------------------
6520 // Return node representing slow path of predicate check.
6521 // the pseudo code we want to emulate with this predicate is:
6522 // for encryption:
6523 //    if (embeddedCipherObj instanceof AESCrypt) do_intrinsic, else do_javapath
6524 // for decryption:
6525 //    if ((embeddedCipherObj instanceof AESCrypt) &amp;&amp; (cipher!=plain)) do_intrinsic, else do_javapath
6526 //    note cipher==plain is more conservative than the original java code but that&#39;s OK
6527 //
6528 Node* LibraryCallKit::inline_cipherBlockChaining_AESCrypt_predicate(bool decrypting) {
6529   // The receiver was checked for NULL already.
6530   Node* objCBC = argument(0);
6531 
6532   Node* src = argument(1);
6533   Node* dest = argument(4);
6534 
6535   // Load embeddedCipher field of CipherBlockChaining object.
6536   Node* embeddedCipherObj = load_field_from_object(objCBC, &quot;embeddedCipher&quot;, &quot;Lcom/sun/crypto/provider/SymmetricCipher;&quot;, /*is_exact*/ false);
6537 
6538   // get AESCrypt klass for instanceOf check
6539   // AESCrypt might not be loaded yet if some other SymmetricCipher got us to this compile point
6540   // will have same classloader as CipherBlockChaining object
6541   const TypeInstPtr* tinst = _gvn.type(objCBC)-&gt;isa_instptr();
6542   assert(tinst != NULL, &quot;CBCobj is null&quot;);
6543   assert(tinst-&gt;klass()-&gt;is_loaded(), &quot;CBCobj is not loaded&quot;);
6544 
6545   // we want to do an instanceof comparison against the AESCrypt class
6546   ciKlass* klass_AESCrypt = tinst-&gt;klass()-&gt;as_instance_klass()-&gt;find_klass(ciSymbol::make(&quot;com/sun/crypto/provider/AESCrypt&quot;));
6547   if (!klass_AESCrypt-&gt;is_loaded()) {
6548     // if AESCrypt is not even loaded, we never take the intrinsic fast path
6549     Node* ctrl = control();
6550     set_control(top()); // no regular fast path
6551     return ctrl;
6552   }
6553 
6554   src = must_be_not_null(src, true);
6555   dest = must_be_not_null(dest, true);
6556 
6557   // Resolve oops to stable for CmpP below.
6558   ciInstanceKlass* instklass_AESCrypt = klass_AESCrypt-&gt;as_instance_klass();
6559 
6560   Node* instof = gen_instanceof(embeddedCipherObj, makecon(TypeKlassPtr::make(instklass_AESCrypt)));
6561   Node* cmp_instof  = _gvn.transform(new CmpINode(instof, intcon(1)));
6562   Node* bool_instof  = _gvn.transform(new BoolNode(cmp_instof, BoolTest::ne));
6563 
6564   Node* instof_false = generate_guard(bool_instof, NULL, PROB_MIN);
6565 
6566   // for encryption, we are done
6567   if (!decrypting)
6568     return instof_false;  // even if it is NULL
6569 
6570   // for decryption, we need to add a further check to avoid
6571   // taking the intrinsic path when cipher and plain are the same
6572   // see the original java code for why.
6573   RegionNode* region = new RegionNode(3);
6574   region-&gt;init_req(1, instof_false);
6575 
6576   Node* cmp_src_dest = _gvn.transform(new CmpPNode(src, dest));
6577   Node* bool_src_dest = _gvn.transform(new BoolNode(cmp_src_dest, BoolTest::eq));
6578   Node* src_dest_conjoint = generate_guard(bool_src_dest, NULL, PROB_MIN);
6579   region-&gt;init_req(2, src_dest_conjoint);
6580 
6581   record_for_igvn(region);
6582   return _gvn.transform(region);
6583 }
6584 
6585 //----------------------------inline_electronicCodeBook_AESCrypt_predicate----------------------------
6586 // Return node representing slow path of predicate check.
6587 // the pseudo code we want to emulate with this predicate is:
6588 // for encryption:
6589 //    if (embeddedCipherObj instanceof AESCrypt) do_intrinsic, else do_javapath
6590 // for decryption:
6591 //    if ((embeddedCipherObj instanceof AESCrypt) &amp;&amp; (cipher!=plain)) do_intrinsic, else do_javapath
6592 //    note cipher==plain is more conservative than the original java code but that&#39;s OK
6593 //
6594 Node* LibraryCallKit::inline_electronicCodeBook_AESCrypt_predicate(bool decrypting) {
6595   // The receiver was checked for NULL already.
6596   Node* objECB = argument(0);
6597 
6598   // Load embeddedCipher field of ElectronicCodeBook object.
6599   Node* embeddedCipherObj = load_field_from_object(objECB, &quot;embeddedCipher&quot;, &quot;Lcom/sun/crypto/provider/SymmetricCipher;&quot;, /*is_exact*/ false);
6600 
6601   // get AESCrypt klass for instanceOf check
6602   // AESCrypt might not be loaded yet if some other SymmetricCipher got us to this compile point
6603   // will have same classloader as ElectronicCodeBook object
6604   const TypeInstPtr* tinst = _gvn.type(objECB)-&gt;isa_instptr();
6605   assert(tinst != NULL, &quot;ECBobj is null&quot;);
6606   assert(tinst-&gt;klass()-&gt;is_loaded(), &quot;ECBobj is not loaded&quot;);
6607 
6608   // we want to do an instanceof comparison against the AESCrypt class
6609   ciKlass* klass_AESCrypt = tinst-&gt;klass()-&gt;as_instance_klass()-&gt;find_klass(ciSymbol::make(&quot;com/sun/crypto/provider/AESCrypt&quot;));
6610   if (!klass_AESCrypt-&gt;is_loaded()) {
6611     // if AESCrypt is not even loaded, we never take the intrinsic fast path
6612     Node* ctrl = control();
6613     set_control(top()); // no regular fast path
6614     return ctrl;
6615   }
6616   ciInstanceKlass* instklass_AESCrypt = klass_AESCrypt-&gt;as_instance_klass();
6617 
6618   Node* instof = gen_instanceof(embeddedCipherObj, makecon(TypeKlassPtr::make(instklass_AESCrypt)));
6619   Node* cmp_instof = _gvn.transform(new CmpINode(instof, intcon(1)));
6620   Node* bool_instof = _gvn.transform(new BoolNode(cmp_instof, BoolTest::ne));
6621 
6622   Node* instof_false = generate_guard(bool_instof, NULL, PROB_MIN);
6623 
6624   // for encryption, we are done
6625   if (!decrypting)
6626     return instof_false;  // even if it is NULL
6627 
6628   // for decryption, we need to add a further check to avoid
6629   // taking the intrinsic path when cipher and plain are the same
6630   // see the original java code for why.
6631   RegionNode* region = new RegionNode(3);
6632   region-&gt;init_req(1, instof_false);
6633   Node* src = argument(1);
6634   Node* dest = argument(4);
6635   Node* cmp_src_dest = _gvn.transform(new CmpPNode(src, dest));
6636   Node* bool_src_dest = _gvn.transform(new BoolNode(cmp_src_dest, BoolTest::eq));
6637   Node* src_dest_conjoint = generate_guard(bool_src_dest, NULL, PROB_MIN);
6638   region-&gt;init_req(2, src_dest_conjoint);
6639 
6640   record_for_igvn(region);
6641   return _gvn.transform(region);
6642 }
6643 
6644 //----------------------------inline_counterMode_AESCrypt_predicate----------------------------
6645 // Return node representing slow path of predicate check.
6646 // the pseudo code we want to emulate with this predicate is:
6647 // for encryption:
6648 //    if (embeddedCipherObj instanceof AESCrypt) do_intrinsic, else do_javapath
6649 // for decryption:
6650 //    if ((embeddedCipherObj instanceof AESCrypt) &amp;&amp; (cipher!=plain)) do_intrinsic, else do_javapath
6651 //    note cipher==plain is more conservative than the original java code but that&#39;s OK
6652 //
6653 
6654 Node* LibraryCallKit::inline_counterMode_AESCrypt_predicate() {
6655   // The receiver was checked for NULL already.
6656   Node* objCTR = argument(0);
6657 
6658   // Load embeddedCipher field of CipherBlockChaining object.
6659   Node* embeddedCipherObj = load_field_from_object(objCTR, &quot;embeddedCipher&quot;, &quot;Lcom/sun/crypto/provider/SymmetricCipher;&quot;, /*is_exact*/ false);
6660 
6661   // get AESCrypt klass for instanceOf check
6662   // AESCrypt might not be loaded yet if some other SymmetricCipher got us to this compile point
6663   // will have same classloader as CipherBlockChaining object
6664   const TypeInstPtr* tinst = _gvn.type(objCTR)-&gt;isa_instptr();
6665   assert(tinst != NULL, &quot;CTRobj is null&quot;);
6666   assert(tinst-&gt;klass()-&gt;is_loaded(), &quot;CTRobj is not loaded&quot;);
6667 
6668   // we want to do an instanceof comparison against the AESCrypt class
6669   ciKlass* klass_AESCrypt = tinst-&gt;klass()-&gt;as_instance_klass()-&gt;find_klass(ciSymbol::make(&quot;com/sun/crypto/provider/AESCrypt&quot;));
6670   if (!klass_AESCrypt-&gt;is_loaded()) {
6671     // if AESCrypt is not even loaded, we never take the intrinsic fast path
6672     Node* ctrl = control();
6673     set_control(top()); // no regular fast path
6674     return ctrl;
6675   }
6676 
6677   ciInstanceKlass* instklass_AESCrypt = klass_AESCrypt-&gt;as_instance_klass();
6678   Node* instof = gen_instanceof(embeddedCipherObj, makecon(TypeKlassPtr::make(instklass_AESCrypt)));
6679   Node* cmp_instof = _gvn.transform(new CmpINode(instof, intcon(1)));
6680   Node* bool_instof = _gvn.transform(new BoolNode(cmp_instof, BoolTest::ne));
6681   Node* instof_false = generate_guard(bool_instof, NULL, PROB_MIN);
6682 
6683   return instof_false; // even if it is NULL
6684 }
6685 
6686 //------------------------------inline_ghash_processBlocks
6687 bool LibraryCallKit::inline_ghash_processBlocks() {
6688   address stubAddr;
6689   const char *stubName;
6690   assert(UseGHASHIntrinsics, &quot;need GHASH intrinsics support&quot;);
6691 
6692   stubAddr = StubRoutines::ghash_processBlocks();
6693   stubName = &quot;ghash_processBlocks&quot;;
6694 
6695   Node* data           = argument(0);
6696   Node* offset         = argument(1);
6697   Node* len            = argument(2);
6698   Node* state          = argument(3);
6699   Node* subkeyH        = argument(4);
6700 
6701   state = must_be_not_null(state, true);
6702   subkeyH = must_be_not_null(subkeyH, true);
6703   data = must_be_not_null(data, true);
6704 
6705   Node* state_start  = array_element_address(state, intcon(0), T_LONG);
6706   assert(state_start, &quot;state is NULL&quot;);
6707   Node* subkeyH_start  = array_element_address(subkeyH, intcon(0), T_LONG);
6708   assert(subkeyH_start, &quot;subkeyH is NULL&quot;);
6709   Node* data_start  = array_element_address(data, offset, T_BYTE);
6710   assert(data_start, &quot;data is NULL&quot;);
6711 
6712   Node* ghash = make_runtime_call(RC_LEAF|RC_NO_FP,
6713                                   OptoRuntime::ghash_processBlocks_Type(),
6714                                   stubAddr, stubName, TypePtr::BOTTOM,
6715                                   state_start, subkeyH_start, data_start, len);
6716   return true;
6717 }
6718 
6719 bool LibraryCallKit::inline_base64_encodeBlock() {
6720   address stubAddr;
6721   const char *stubName;
6722   assert(UseBASE64Intrinsics, &quot;need Base64 intrinsics support&quot;);
6723   assert(callee()-&gt;signature()-&gt;size() == 6, &quot;base64_encodeBlock has 6 parameters&quot;);
6724   stubAddr = StubRoutines::base64_encodeBlock();
6725   stubName = &quot;encodeBlock&quot;;
6726 
6727   if (!stubAddr) return false;
6728   Node* base64obj = argument(0);
6729   Node* src = argument(1);
6730   Node* offset = argument(2);
6731   Node* len = argument(3);
6732   Node* dest = argument(4);
6733   Node* dp = argument(5);
6734   Node* isURL = argument(6);
6735 
6736   src = must_be_not_null(src, true);
6737   dest = must_be_not_null(dest, true);
6738 
6739   Node* src_start = array_element_address(src, intcon(0), T_BYTE);
6740   assert(src_start, &quot;source array is NULL&quot;);
6741   Node* dest_start = array_element_address(dest, intcon(0), T_BYTE);
6742   assert(dest_start, &quot;destination array is NULL&quot;);
6743 
6744   Node* base64 = make_runtime_call(RC_LEAF,
6745                                    OptoRuntime::base64_encodeBlock_Type(),
6746                                    stubAddr, stubName, TypePtr::BOTTOM,
6747                                    src_start, offset, len, dest_start, dp, isURL);
6748   return true;
6749 }
6750 
6751 //------------------------------inline_sha_implCompress-----------------------
6752 //
6753 // Calculate SHA (i.e., SHA-1) for single-block byte[] array.
6754 // void com.sun.security.provider.SHA.implCompress(byte[] buf, int ofs)
6755 //
6756 // Calculate SHA2 (i.e., SHA-244 or SHA-256) for single-block byte[] array.
6757 // void com.sun.security.provider.SHA2.implCompress(byte[] buf, int ofs)
6758 //
6759 // Calculate SHA5 (i.e., SHA-384 or SHA-512) for single-block byte[] array.
6760 // void com.sun.security.provider.SHA5.implCompress(byte[] buf, int ofs)
6761 //
6762 bool LibraryCallKit::inline_sha_implCompress(vmIntrinsics::ID id) {
6763   assert(callee()-&gt;signature()-&gt;size() == 2, &quot;sha_implCompress has 2 parameters&quot;);
6764 
6765   Node* sha_obj = argument(0);
6766   Node* src     = argument(1); // type oop
6767   Node* ofs     = argument(2); // type int
6768 
6769   const Type* src_type = src-&gt;Value(&amp;_gvn);
6770   const TypeAryPtr* top_src = src_type-&gt;isa_aryptr();
6771   if (top_src  == NULL || top_src-&gt;klass()  == NULL) {
6772     // failed array check
6773     return false;
6774   }
6775   // Figure out the size and type of the elements we will be copying.
6776   BasicType src_elem = src_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
6777   if (src_elem != T_BYTE) {
6778     return false;
6779   }
6780   // &#39;src_start&#39; points to src array + offset
6781   src = must_be_not_null(src, true);
6782   Node* src_start = array_element_address(src, ofs, src_elem);
6783   Node* state = NULL;
6784   address stubAddr;
6785   const char *stubName;
6786 
6787   switch(id) {
6788   case vmIntrinsics::_sha_implCompress:
6789     assert(UseSHA1Intrinsics, &quot;need SHA1 instruction support&quot;);
6790     state = get_state_from_sha_object(sha_obj);
6791     stubAddr = StubRoutines::sha1_implCompress();
6792     stubName = &quot;sha1_implCompress&quot;;
6793     break;
6794   case vmIntrinsics::_sha2_implCompress:
6795     assert(UseSHA256Intrinsics, &quot;need SHA256 instruction support&quot;);
6796     state = get_state_from_sha_object(sha_obj);
6797     stubAddr = StubRoutines::sha256_implCompress();
6798     stubName = &quot;sha256_implCompress&quot;;
6799     break;
6800   case vmIntrinsics::_sha5_implCompress:
6801     assert(UseSHA512Intrinsics, &quot;need SHA512 instruction support&quot;);
6802     state = get_state_from_sha5_object(sha_obj);
6803     stubAddr = StubRoutines::sha512_implCompress();
6804     stubName = &quot;sha512_implCompress&quot;;
6805     break;
6806   default:
6807     fatal_unexpected_iid(id);
6808     return false;
6809   }
6810   if (state == NULL) return false;
6811 
6812   assert(stubAddr != NULL, &quot;Stub is generated&quot;);
6813   if (stubAddr == NULL) return false;
6814 
6815   // Call the stub.
6816   Node* call = make_runtime_call(RC_LEAF|RC_NO_FP, OptoRuntime::sha_implCompress_Type(),
6817                                  stubAddr, stubName, TypePtr::BOTTOM,
6818                                  src_start, state);
6819 
6820   return true;
6821 }
6822 
6823 //------------------------------inline_digestBase_implCompressMB-----------------------
6824 //
6825 // Calculate SHA/SHA2/SHA5 for multi-block byte[] array.
6826 // int com.sun.security.provider.DigestBase.implCompressMultiBlock(byte[] b, int ofs, int limit)
6827 //
6828 bool LibraryCallKit::inline_digestBase_implCompressMB(int predicate) {
6829   assert(UseSHA1Intrinsics || UseSHA256Intrinsics || UseSHA512Intrinsics,
6830          &quot;need SHA1/SHA256/SHA512 instruction support&quot;);
6831   assert((uint)predicate &lt; 3, &quot;sanity&quot;);
6832   assert(callee()-&gt;signature()-&gt;size() == 3, &quot;digestBase_implCompressMB has 3 parameters&quot;);
6833 
6834   Node* digestBase_obj = argument(0); // The receiver was checked for NULL already.
6835   Node* src            = argument(1); // byte[] array
6836   Node* ofs            = argument(2); // type int
6837   Node* limit          = argument(3); // type int
6838 
6839   const Type* src_type = src-&gt;Value(&amp;_gvn);
6840   const TypeAryPtr* top_src = src_type-&gt;isa_aryptr();
6841   if (top_src  == NULL || top_src-&gt;klass()  == NULL) {
6842     // failed array check
6843     return false;
6844   }
6845   // Figure out the size and type of the elements we will be copying.
6846   BasicType src_elem = src_type-&gt;isa_aryptr()-&gt;klass()-&gt;as_array_klass()-&gt;element_type()-&gt;basic_type();
6847   if (src_elem != T_BYTE) {
6848     return false;
6849   }
6850   // &#39;src_start&#39; points to src array + offset
6851   src = must_be_not_null(src, false);
6852   Node* src_start = array_element_address(src, ofs, src_elem);
6853 
6854   const char* klass_SHA_name = NULL;
6855   const char* stub_name = NULL;
6856   address     stub_addr = NULL;
6857   bool        long_state = false;
6858 
6859   switch (predicate) {
6860   case 0:
6861     if (UseSHA1Intrinsics) {
6862       klass_SHA_name = &quot;sun/security/provider/SHA&quot;;
6863       stub_name = &quot;sha1_implCompressMB&quot;;
6864       stub_addr = StubRoutines::sha1_implCompressMB();
6865     }
6866     break;
6867   case 1:
6868     if (UseSHA256Intrinsics) {
6869       klass_SHA_name = &quot;sun/security/provider/SHA2&quot;;
6870       stub_name = &quot;sha256_implCompressMB&quot;;
6871       stub_addr = StubRoutines::sha256_implCompressMB();
6872     }
6873     break;
6874   case 2:
6875     if (UseSHA512Intrinsics) {
6876       klass_SHA_name = &quot;sun/security/provider/SHA5&quot;;
6877       stub_name = &quot;sha512_implCompressMB&quot;;
6878       stub_addr = StubRoutines::sha512_implCompressMB();
6879       long_state = true;
6880     }
6881     break;
6882   default:
6883     fatal(&quot;unknown SHA intrinsic predicate: %d&quot;, predicate);
6884   }
6885   if (klass_SHA_name != NULL) {
6886     assert(stub_addr != NULL, &quot;Stub is generated&quot;);
6887     if (stub_addr == NULL) return false;
6888 
6889     // get DigestBase klass to lookup for SHA klass
6890     const TypeInstPtr* tinst = _gvn.type(digestBase_obj)-&gt;isa_instptr();
6891     assert(tinst != NULL, &quot;digestBase_obj is not instance???&quot;);
6892     assert(tinst-&gt;klass()-&gt;is_loaded(), &quot;DigestBase is not loaded&quot;);
6893 
6894     ciKlass* klass_SHA = tinst-&gt;klass()-&gt;as_instance_klass()-&gt;find_klass(ciSymbol::make(klass_SHA_name));
6895     assert(klass_SHA-&gt;is_loaded(), &quot;predicate checks that this class is loaded&quot;);
6896     ciInstanceKlass* instklass_SHA = klass_SHA-&gt;as_instance_klass();
6897     return inline_sha_implCompressMB(digestBase_obj, instklass_SHA, long_state, stub_addr, stub_name, src_start, ofs, limit);
6898   }
6899   return false;
6900 }
6901 //------------------------------inline_sha_implCompressMB-----------------------
6902 bool LibraryCallKit::inline_sha_implCompressMB(Node* digestBase_obj, ciInstanceKlass* instklass_SHA,
6903                                                bool long_state, address stubAddr, const char *stubName,
6904                                                Node* src_start, Node* ofs, Node* limit) {
6905   const TypeKlassPtr* aklass = TypeKlassPtr::make(instklass_SHA);
6906   const TypeOopPtr* xtype = aklass-&gt;as_instance_type();
6907   Node* sha_obj = new CheckCastPPNode(control(), digestBase_obj, xtype);
6908   sha_obj = _gvn.transform(sha_obj);
6909 
6910   Node* state;
6911   if (long_state) {
6912     state = get_state_from_sha5_object(sha_obj);
6913   } else {
6914     state = get_state_from_sha_object(sha_obj);
6915   }
6916   if (state == NULL) return false;
6917 
6918   // Call the stub.
6919   Node* call = make_runtime_call(RC_LEAF|RC_NO_FP,
6920                                  OptoRuntime::digestBase_implCompressMB_Type(),
6921                                  stubAddr, stubName, TypePtr::BOTTOM,
6922                                  src_start, state, ofs, limit);
6923   // return ofs (int)
6924   Node* result = _gvn.transform(new ProjNode(call, TypeFunc::Parms));
6925   set_result(result);
6926 
6927   return true;
6928 }
6929 
6930 //------------------------------get_state_from_sha_object-----------------------
6931 Node * LibraryCallKit::get_state_from_sha_object(Node *sha_object) {
6932   Node* sha_state = load_field_from_object(sha_object, &quot;state&quot;, &quot;[I&quot;, /*is_exact*/ false);
6933   assert (sha_state != NULL, &quot;wrong version of sun.security.provider.SHA/SHA2&quot;);
6934   if (sha_state == NULL) return (Node *) NULL;
6935 
6936   // now have the array, need to get the start address of the state array
6937   Node* state = array_element_address(sha_state, intcon(0), T_INT);
6938   return state;
6939 }
6940 
6941 //------------------------------get_state_from_sha5_object-----------------------
6942 Node * LibraryCallKit::get_state_from_sha5_object(Node *sha_object) {
6943   Node* sha_state = load_field_from_object(sha_object, &quot;state&quot;, &quot;[J&quot;, /*is_exact*/ false);
6944   assert (sha_state != NULL, &quot;wrong version of sun.security.provider.SHA5&quot;);
6945   if (sha_state == NULL) return (Node *) NULL;
6946 
6947   // now have the array, need to get the start address of the state array
6948   Node* state = array_element_address(sha_state, intcon(0), T_LONG);
6949   return state;
6950 }
6951 
6952 //----------------------------inline_digestBase_implCompressMB_predicate----------------------------
6953 // Return node representing slow path of predicate check.
6954 // the pseudo code we want to emulate with this predicate is:
6955 //    if (digestBaseObj instanceof SHA/SHA2/SHA5) do_intrinsic, else do_javapath
6956 //
6957 Node* LibraryCallKit::inline_digestBase_implCompressMB_predicate(int predicate) {
6958   assert(UseSHA1Intrinsics || UseSHA256Intrinsics || UseSHA512Intrinsics,
6959          &quot;need SHA1/SHA256/SHA512 instruction support&quot;);
6960   assert((uint)predicate &lt; 3, &quot;sanity&quot;);
6961 
6962   // The receiver was checked for NULL already.
6963   Node* digestBaseObj = argument(0);
6964 
6965   // get DigestBase klass for instanceOf check
6966   const TypeInstPtr* tinst = _gvn.type(digestBaseObj)-&gt;isa_instptr();
6967   assert(tinst != NULL, &quot;digestBaseObj is null&quot;);
6968   assert(tinst-&gt;klass()-&gt;is_loaded(), &quot;DigestBase is not loaded&quot;);
6969 
6970   const char* klass_SHA_name = NULL;
6971   switch (predicate) {
6972   case 0:
6973     if (UseSHA1Intrinsics) {
6974       // we want to do an instanceof comparison against the SHA class
6975       klass_SHA_name = &quot;sun/security/provider/SHA&quot;;
6976     }
6977     break;
6978   case 1:
6979     if (UseSHA256Intrinsics) {
6980       // we want to do an instanceof comparison against the SHA2 class
6981       klass_SHA_name = &quot;sun/security/provider/SHA2&quot;;
6982     }
6983     break;
6984   case 2:
6985     if (UseSHA512Intrinsics) {
6986       // we want to do an instanceof comparison against the SHA5 class
6987       klass_SHA_name = &quot;sun/security/provider/SHA5&quot;;
6988     }
6989     break;
6990   default:
6991     fatal(&quot;unknown SHA intrinsic predicate: %d&quot;, predicate);
6992   }
6993 
6994   ciKlass* klass_SHA = NULL;
6995   if (klass_SHA_name != NULL) {
6996     klass_SHA = tinst-&gt;klass()-&gt;as_instance_klass()-&gt;find_klass(ciSymbol::make(klass_SHA_name));
6997   }
6998   if ((klass_SHA == NULL) || !klass_SHA-&gt;is_loaded()) {
6999     // if none of SHA/SHA2/SHA5 is loaded, we never take the intrinsic fast path
7000     Node* ctrl = control();
7001     set_control(top()); // no intrinsic path
7002     return ctrl;
7003   }
7004   ciInstanceKlass* instklass_SHA = klass_SHA-&gt;as_instance_klass();
7005 
7006   Node* instofSHA = gen_instanceof(digestBaseObj, makecon(TypeKlassPtr::make(instklass_SHA)));
7007   Node* cmp_instof = _gvn.transform(new CmpINode(instofSHA, intcon(1)));
7008   Node* bool_instof = _gvn.transform(new BoolNode(cmp_instof, BoolTest::ne));
7009   Node* instof_false = generate_guard(bool_instof, NULL, PROB_MIN);
7010 
7011   return instof_false;  // even if it is NULL
7012 }
7013 
7014 //-------------inline_fma-----------------------------------
7015 bool LibraryCallKit::inline_fma(vmIntrinsics::ID id) {
7016   Node *a = NULL;
7017   Node *b = NULL;
7018   Node *c = NULL;
7019   Node* result = NULL;
7020   switch (id) {
7021   case vmIntrinsics::_fmaD:
7022     assert(callee()-&gt;signature()-&gt;size() == 6, &quot;fma has 3 parameters of size 2 each.&quot;);
7023     // no receiver since it is static method
7024     a = round_double_node(argument(0));
7025     b = round_double_node(argument(2));
7026     c = round_double_node(argument(4));
7027     result = _gvn.transform(new FmaDNode(control(), a, b, c));
7028     break;
7029   case vmIntrinsics::_fmaF:
7030     assert(callee()-&gt;signature()-&gt;size() == 3, &quot;fma has 3 parameters of size 1 each.&quot;);
7031     a = argument(0);
7032     b = argument(1);
7033     c = argument(2);
7034     result = _gvn.transform(new FmaFNode(control(), a, b, c));
7035     break;
7036   default:
7037     fatal_unexpected_iid(id);  break;
7038   }
7039   set_result(result);
7040   return true;
7041 }
7042 
7043 bool LibraryCallKit::inline_character_compare(vmIntrinsics::ID id) {
7044   // argument(0) is receiver
7045   Node* codePoint = argument(1);
7046   Node* n = NULL;
7047 
7048   switch (id) {
7049     case vmIntrinsics::_isDigit :
7050       n = new DigitNode(control(), codePoint);
7051       break;
7052     case vmIntrinsics::_isLowerCase :
7053       n = new LowerCaseNode(control(), codePoint);
7054       break;
7055     case vmIntrinsics::_isUpperCase :
7056       n = new UpperCaseNode(control(), codePoint);
7057       break;
7058     case vmIntrinsics::_isWhitespace :
7059       n = new WhitespaceNode(control(), codePoint);
7060       break;
7061     default:
7062       fatal_unexpected_iid(id);
7063   }
7064 
7065   set_result(_gvn.transform(n));
7066   return true;
7067 }
7068 
7069 //------------------------------inline_fp_min_max------------------------------
7070 bool LibraryCallKit::inline_fp_min_max(vmIntrinsics::ID id) {
7071 /* DISABLED BECAUSE METHOD DATA ISN&#39;T COLLECTED PER CALL-SITE, SEE JDK-8015416.
7072 
7073   // The intrinsic should be used only when the API branches aren&#39;t predictable,
7074   // the last one performing the most important comparison. The following heuristic
7075   // uses the branch statistics to eventually bail out if necessary.
7076 
7077   ciMethodData *md = callee()-&gt;method_data();
7078 
7079   if ( md != NULL &amp;&amp; md-&gt;is_mature() &amp;&amp; md-&gt;invocation_count() &gt; 0 ) {
7080     ciCallProfile cp = caller()-&gt;call_profile_at_bci(bci());
7081 
7082     if ( ((double)cp.count()) / ((double)md-&gt;invocation_count()) &lt; 0.8 ) {
7083       // Bail out if the call-site didn&#39;t contribute enough to the statistics.
7084       return false;
7085     }
7086 
7087     uint taken = 0, not_taken = 0;
7088 
7089     for (ciProfileData *p = md-&gt;first_data(); md-&gt;is_valid(p); p = md-&gt;next_data(p)) {
7090       if (p-&gt;is_BranchData()) {
7091         taken = ((ciBranchData*)p)-&gt;taken();
7092         not_taken = ((ciBranchData*)p)-&gt;not_taken();
7093       }
7094     }
7095 
7096     double balance = (((double)taken) - ((double)not_taken)) / ((double)md-&gt;invocation_count());
7097     balance = balance &lt; 0 ? -balance : balance;
7098     if ( balance &gt; 0.2 ) {
7099       // Bail out if the most important branch is predictable enough.
7100       return false;
7101     }
7102   }
7103 */
7104 
7105   Node *a = NULL;
7106   Node *b = NULL;
7107   Node *n = NULL;
7108   switch (id) {
7109   case vmIntrinsics::_maxF:
7110   case vmIntrinsics::_minF:
7111     assert(callee()-&gt;signature()-&gt;size() == 2, &quot;minF/maxF has 2 parameters of size 1 each.&quot;);
7112     a = argument(0);
7113     b = argument(1);
7114     break;
7115   case vmIntrinsics::_maxD:
7116   case vmIntrinsics::_minD:
7117     assert(callee()-&gt;signature()-&gt;size() == 4, &quot;minD/maxD has 2 parameters of size 2 each.&quot;);
7118     a = round_double_node(argument(0));
7119     b = round_double_node(argument(2));
7120     break;
7121   default:
7122     fatal_unexpected_iid(id);
7123     break;
7124   }
7125   switch (id) {
7126   case vmIntrinsics::_maxF:  n = new MaxFNode(a, b);  break;
7127   case vmIntrinsics::_minF:  n = new MinFNode(a, b);  break;
7128   case vmIntrinsics::_maxD:  n = new MaxDNode(a, b);  break;
7129   case vmIntrinsics::_minD:  n = new MinDNode(a, b);  break;
7130   default:  fatal_unexpected_iid(id);  break;
7131   }
7132   set_result(_gvn.transform(n));
7133   return true;
7134 }
7135 
7136 bool LibraryCallKit::inline_profileBoolean() {
7137   Node* counts = argument(1);
7138   const TypeAryPtr* ary = NULL;
7139   ciArray* aobj = NULL;
7140   if (counts-&gt;is_Con()
7141       &amp;&amp; (ary = counts-&gt;bottom_type()-&gt;isa_aryptr()) != NULL
7142       &amp;&amp; (aobj = ary-&gt;const_oop()-&gt;as_array()) != NULL
7143       &amp;&amp; (aobj-&gt;length() == 2)) {
7144     // Profile is int[2] where [0] and [1] correspond to false and true value occurrences respectively.
7145     jint false_cnt = aobj-&gt;element_value(0).as_int();
7146     jint  true_cnt = aobj-&gt;element_value(1).as_int();
7147 
7148     if (C-&gt;log() != NULL) {
7149       C-&gt;log()-&gt;elem(&quot;observe source=&#39;profileBoolean&#39; false=&#39;%d&#39; true=&#39;%d&#39;&quot;,
7150                      false_cnt, true_cnt);
7151     }
7152 
7153     if (false_cnt + true_cnt == 0) {
7154       // According to profile, never executed.
7155       uncommon_trap_exact(Deoptimization::Reason_intrinsic,
7156                           Deoptimization::Action_reinterpret);
7157       return true;
7158     }
7159 
7160     // result is a boolean (0 or 1) and its profile (false_cnt &amp; true_cnt)
7161     // is a number of each value occurrences.
7162     Node* result = argument(0);
7163     if (false_cnt == 0 || true_cnt == 0) {
7164       // According to profile, one value has been never seen.
7165       int expected_val = (false_cnt == 0) ? 1 : 0;
7166 
7167       Node* cmp  = _gvn.transform(new CmpINode(result, intcon(expected_val)));
7168       Node* test = _gvn.transform(new BoolNode(cmp, BoolTest::eq));
7169 
7170       IfNode* check = create_and_map_if(control(), test, PROB_ALWAYS, COUNT_UNKNOWN);
7171       Node* fast_path = _gvn.transform(new IfTrueNode(check));
7172       Node* slow_path = _gvn.transform(new IfFalseNode(check));
7173 
7174       { // Slow path: uncommon trap for never seen value and then reexecute
7175         // MethodHandleImpl::profileBoolean() to bump the count, so JIT knows
7176         // the value has been seen at least once.
7177         PreserveJVMState pjvms(this);
7178         PreserveReexecuteState preexecs(this);
7179         jvms()-&gt;set_should_reexecute(true);
7180 
7181         set_control(slow_path);
7182         set_i_o(i_o());
7183 
7184         uncommon_trap_exact(Deoptimization::Reason_intrinsic,
7185                             Deoptimization::Action_reinterpret);
7186       }
7187       // The guard for never seen value enables sharpening of the result and
7188       // returning a constant. It allows to eliminate branches on the same value
7189       // later on.
7190       set_control(fast_path);
7191       result = intcon(expected_val);
7192     }
7193     // Stop profiling.
7194     // MethodHandleImpl::profileBoolean() has profiling logic in its bytecode.
7195     // By replacing method body with profile data (represented as ProfileBooleanNode
7196     // on IR level) we effectively disable profiling.
7197     // It enables full speed execution once optimized code is generated.
7198     Node* profile = _gvn.transform(new ProfileBooleanNode(result, false_cnt, true_cnt));
7199     C-&gt;record_for_igvn(profile);
7200     set_result(profile);
7201     return true;
7202   } else {
7203     // Continue profiling.
7204     // Profile data isn&#39;t available at the moment. So, execute method&#39;s bytecode version.
7205     // Usually, when GWT LambdaForms are profiled it means that a stand-alone nmethod
7206     // is compiled and counters aren&#39;t available since corresponding MethodHandle
7207     // isn&#39;t a compile-time constant.
7208     return false;
7209   }
7210 }
7211 
7212 bool LibraryCallKit::inline_isCompileConstant() {
7213   Node* n = argument(0);
7214   set_result(n-&gt;is_Con() ? intcon(1) : intcon(0));
7215   return true;
7216 }
    </pre>
  </body>
</html>