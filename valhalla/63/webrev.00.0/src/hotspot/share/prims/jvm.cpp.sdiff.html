<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/prims/jvm.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../opto/node.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmtiEnv.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/prims/jvm.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 974   Handle class_loader (THREAD, JNIHandles::resolve(loader));
 975   if (UsePerfData) {
 976     is_lock_held_by_thread(class_loader,
 977                            ClassLoader::sync_JVMDefineClassLockFreeCounter(),
 978                            THREAD);
 979   }
 980   Handle protection_domain (THREAD, JNIHandles::resolve(pd));
 981   Klass* k = SystemDictionary::resolve_from_stream(class_name,
 982                                                    class_loader,
 983                                                    protection_domain,
 984                                                    &amp;st,
 985                                                    CHECK_NULL);
 986 
 987   if (log_is_enabled(Debug, class, resolve) &amp;&amp; k != NULL) {
 988     trace_class_resolution(k);
 989   }
 990 
 991   return (jclass) JNIHandles::make_local(env, k-&gt;java_mirror());
 992 }
 993 




















































































































































 994 
 995 JVM_ENTRY(jclass, JVM_DefineClass(JNIEnv *env, const char *name, jobject loader, const jbyte *buf, jsize len, jobject pd))
 996   JVMWrapper(&quot;JVM_DefineClass&quot;);
 997 
 998   return jvm_define_class_common(env, name, loader, buf, len, pd, NULL, THREAD);
 999 JVM_END
1000 























1001 
1002 JVM_ENTRY(jclass, JVM_DefineClassWithSource(JNIEnv *env, const char *name, jobject loader, const jbyte *buf, jsize len, jobject pd, const char *source))
1003   JVMWrapper(&quot;JVM_DefineClassWithSource&quot;);
1004 
1005   return jvm_define_class_common(env, name, loader, buf, len, pd, source, THREAD);
1006 JVM_END
1007 
1008 JVM_ENTRY(jclass, JVM_FindLoadedClass(JNIEnv *env, jobject loader, jstring name))
1009   JVMWrapper(&quot;JVM_FindLoadedClass&quot;);
1010   ResourceMark rm(THREAD);
1011 
1012   Handle h_name (THREAD, JNIHandles::resolve_non_null(name));
1013   char* str = java_lang_String::as_utf8_string(h_name());
1014 
1015   // Sanity check, don&#39;t expect null
1016   if (str == NULL) return NULL;
1017 
1018   // Internalize the string, converting &#39;.&#39; to &#39;/&#39; in string.
1019   char* p = (char*)str;
1020   while (*p != &#39;\0&#39;) {
</pre>
<hr />
<pre>
1043   }
1044 
1045   Klass* k = SystemDictionary::find_instance_or_array_klass(klass_name,
1046                                                               h_loader,
1047                                                               Handle(),
1048                                                               CHECK_NULL);
1049 #if INCLUDE_CDS
1050   if (k == NULL) {
1051     // If the class is not already loaded, try to see if it&#39;s in the shared
1052     // archive for the current classloader (h_loader).
1053     k = SystemDictionaryShared::find_or_load_shared_class(klass_name, h_loader, CHECK_NULL);
1054   }
1055 #endif
1056   return (k == NULL) ? NULL :
1057             (jclass) JNIHandles::make_local(env, k-&gt;java_mirror());
1058 JVM_END
1059 
1060 // Module support //////////////////////////////////////////////////////////////////////////////
1061 
1062 JVM_ENTRY(void, JVM_DefineModule(JNIEnv *env, jobject module, jboolean is_open, jstring version,
<span class="line-modified">1063                                  jstring location, const char* const* packages, jsize num_packages))</span>
1064   JVMWrapper(&quot;JVM_DefineModule&quot;);
<span class="line-modified">1065   Modules::define_module(module, is_open, version, location, packages, num_packages, CHECK);</span>
1066 JVM_END
1067 
1068 JVM_ENTRY(void, JVM_SetBootLoaderUnnamedModule(JNIEnv *env, jobject module))
1069   JVMWrapper(&quot;JVM_SetBootLoaderUnnamedModule&quot;);
1070   Modules::set_bootloader_unnamed_module(module, CHECK);
1071 JVM_END
1072 
<span class="line-modified">1073 JVM_ENTRY(void, JVM_AddModuleExports(JNIEnv *env, jobject from_module, const char* package, jobject to_module))</span>
1074   JVMWrapper(&quot;JVM_AddModuleExports&quot;);
1075   Modules::add_module_exports_qualified(from_module, package, to_module, CHECK);
1076 JVM_END
1077 
<span class="line-modified">1078 JVM_ENTRY(void, JVM_AddModuleExportsToAllUnnamed(JNIEnv *env, jobject from_module, const char* package))</span>
1079   JVMWrapper(&quot;JVM_AddModuleExportsToAllUnnamed&quot;);
1080   Modules::add_module_exports_to_all_unnamed(from_module, package, CHECK);
1081 JVM_END
1082 
<span class="line-modified">1083 JVM_ENTRY(void, JVM_AddModuleExportsToAll(JNIEnv *env, jobject from_module, const char* package))</span>
1084   JVMWrapper(&quot;JVM_AddModuleExportsToAll&quot;);
1085   Modules::add_module_exports(from_module, package, NULL, CHECK);
1086 JVM_END
1087 
1088 JVM_ENTRY (void, JVM_AddReadsModule(JNIEnv *env, jobject from_module, jobject source_module))
1089   JVMWrapper(&quot;JVM_AddReadsModule&quot;);
1090   Modules::add_reads_module(from_module, source_module, CHECK);
1091 JVM_END
1092 
1093 // Reflection support //////////////////////////////////////////////////////////////////////////////
1094 
1095 JVM_ENTRY(jstring, JVM_InitClassName(JNIEnv *env, jclass cls))
1096   assert (cls != NULL, &quot;illegal class&quot;);
1097   JVMWrapper(&quot;JVM_InitClassName&quot;);
1098   JvmtiVMObjectAllocEventCollector oam;
1099   ResourceMark rm(THREAD);
1100   HandleMark hm(THREAD);
1101   Handle java_class(THREAD, JNIHandles::resolve(cls));
1102   oop result = java_lang_Class::name(java_class, CHECK_NULL);
1103   return (jstring) JNIHandles::make_local(env, result);
</pre>
<hr />
<pre>
1152   }
1153   return (jobjectArray) JNIHandles::make_local(env, result());
1154 JVM_END
1155 
1156 
1157 JVM_ENTRY(jboolean, JVM_IsInterface(JNIEnv *env, jclass cls))
1158   JVMWrapper(&quot;JVM_IsInterface&quot;);
1159   oop mirror = JNIHandles::resolve_non_null(cls);
1160   if (java_lang_Class::is_primitive(mirror)) {
1161     return JNI_FALSE;
1162   }
1163   Klass* k = java_lang_Class::as_Klass(mirror);
1164   jboolean result = k-&gt;is_interface();
1165   assert(!result || k-&gt;is_instance_klass(),
1166          &quot;all interfaces are instance types&quot;);
1167   // The compiler intrinsic for isInterface tests the
1168   // Klass::_access_flags bits in the same way.
1169   return result;
1170 JVM_END
1171 









1172 
1173 JVM_ENTRY(jobjectArray, JVM_GetClassSigners(JNIEnv *env, jclass cls))
1174   JVMWrapper(&quot;JVM_GetClassSigners&quot;);
1175   JvmtiVMObjectAllocEventCollector oam;
1176   if (java_lang_Class::is_primitive(JNIHandles::resolve_non_null(cls))) {
1177     // There are no signers for primitive types
1178     return NULL;
1179   }
1180 
1181   objArrayHandle signers(THREAD, java_lang_Class::signers(JNIHandles::resolve_non_null(cls)));
1182 
1183   // If there are no signers set in the class, or if the class
1184   // is an array, return NULL.
1185   if (signers == NULL) return NULL;
1186 
1187   // copy of the signers array
1188   Klass* element = ObjArrayKlass::cast(signers-&gt;klass())-&gt;element_klass();
1189   objArrayOop signers_copy = oopFactory::new_objArray(element, signers-&gt;length(), CHECK_NULL);
1190   for (int index = 0; index &lt; signers-&gt;length(); index++) {
1191     signers_copy-&gt;obj_at_put(index, signers-&gt;obj_at(index));
</pre>
<hr />
<pre>
1419     return (jobjectArray)JNIHandles::make_local(env, res);
1420   }
1421 
1422   return (jobjectArray)JNIHandles::make_local(env, result());
1423 JVM_END
1424 
1425 
1426 JVM_ENTRY(jclass, JVM_GetDeclaringClass(JNIEnv *env, jclass ofClass))
1427 {
1428   // ofClass is a reference to a java_lang_Class object.
1429   if (java_lang_Class::is_primitive(JNIHandles::resolve_non_null(ofClass)) ||
1430       ! java_lang_Class::as_Klass(JNIHandles::resolve_non_null(ofClass))-&gt;is_instance_klass()) {
1431     return NULL;
1432   }
1433 
1434   bool inner_is_member = false;
1435   Klass* outer_klass
1436     = InstanceKlass::cast(java_lang_Class::as_Klass(JNIHandles::resolve_non_null(ofClass))
1437                           )-&gt;compute_enclosing_class(&amp;inner_is_member, CHECK_NULL);
1438   if (outer_klass == NULL)  return NULL;  // already a top-level class
<span class="line-modified">1439   if (!inner_is_member)  return NULL;     // an anonymous class (inside a method)</span>
1440   return (jclass) JNIHandles::make_local(env, outer_klass-&gt;java_mirror());
1441 }
1442 JVM_END
1443 
1444 JVM_ENTRY(jstring, JVM_GetSimpleBinaryName(JNIEnv *env, jclass cls))
1445 {
1446   oop mirror = JNIHandles::resolve_non_null(cls);
1447   if (java_lang_Class::is_primitive(mirror) ||
1448       !java_lang_Class::as_Klass(mirror)-&gt;is_instance_klass()) {
1449     return NULL;
1450   }
1451   InstanceKlass* k = InstanceKlass::cast(java_lang_Class::as_Klass(mirror));
1452   int ooff = 0, noff = 0;
1453   if (k-&gt;find_inner_classes_attr(&amp;ooff, &amp;noff, THREAD)) {
1454     if (noff != 0) {
1455       constantPoolHandle i_cp(thread, k-&gt;constants());
1456       Symbol* name = i_cp-&gt;symbol_at(noff);
1457       Handle str = java_lang_String::create_from_symbol(name, CHECK_NULL);
1458       return (jstring) JNIHandles::make_local(env, str());
1459     }
</pre>
<hr />
<pre>
1875 JVM_ENTRY(jboolean, JVM_AreNestMates(JNIEnv *env, jclass current, jclass member))
1876 {
1877   JVMWrapper(&quot;JVM_AreNestMates&quot;);
1878   Klass* c = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(current));
1879   assert(c-&gt;is_instance_klass(), &quot;must be&quot;);
1880   InstanceKlass* ck = InstanceKlass::cast(c);
1881   Klass* m = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(member));
1882   assert(m-&gt;is_instance_klass(), &quot;must be&quot;);
1883   InstanceKlass* mk = InstanceKlass::cast(m);
1884   return ck-&gt;has_nestmate_access_to(mk, THREAD);
1885 }
1886 JVM_END
1887 
1888 JVM_ENTRY(jclass, JVM_GetNestHost(JNIEnv* env, jclass current))
1889 {
1890   // current is not a primitive or array class
1891   JVMWrapper(&quot;JVM_GetNestHost&quot;);
1892   Klass* c = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(current));
1893   assert(c-&gt;is_instance_klass(), &quot;must be&quot;);
1894   InstanceKlass* ck = InstanceKlass::cast(c);
<span class="line-modified">1895   // Don&#39;t post exceptions if validation fails</span>
<span class="line-removed">1896   InstanceKlass* host = ck-&gt;nest_host(NULL, THREAD);</span>
1897   return (jclass) (host == NULL ? NULL :
1898                    JNIHandles::make_local(THREAD, host-&gt;java_mirror()));
1899 }
1900 JVM_END
1901 
1902 JVM_ENTRY(jobjectArray, JVM_GetNestMembers(JNIEnv* env, jclass current))
1903 {
1904   // current is not a primitive or array class
1905   JVMWrapper(&quot;JVM_GetNestMembers&quot;);

1906   Klass* c = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(current));
1907   assert(c-&gt;is_instance_klass(), &quot;must be&quot;);
1908   InstanceKlass* ck = InstanceKlass::cast(c);
<span class="line-modified">1909   // Get the nest host for this nest - throw ICCE if validation fails</span>
<span class="line-removed">1910   Symbol* icce = vmSymbols::java_lang_IncompatibleClassChangeError();</span>
<span class="line-removed">1911   InstanceKlass* host = ck-&gt;nest_host(icce, CHECK_NULL);</span>
1912 


1913   {
1914     JvmtiVMObjectAllocEventCollector oam;
1915     Array&lt;u2&gt;* members = host-&gt;nest_members();
1916     int length = members == NULL ? 0 : members-&gt;length();



1917     // nest host is first in the array so make it one bigger
1918     objArrayOop r = oopFactory::new_objArray(SystemDictionary::Class_klass(),
1919                                              length + 1, CHECK_NULL);
<span class="line-modified">1920     objArrayHandle result (THREAD, r);</span>
1921     result-&gt;obj_at_put(0, host-&gt;java_mirror());
1922     if (length != 0) {
<span class="line-modified">1923       int i;</span>
<span class="line-modified">1924       for (i = 0; i &lt; length; i++) {</span>
<span class="line-modified">1925          int cp_index = members-&gt;at(i);</span>
<span class="line-modified">1926          Klass* k = host-&gt;constants()-&gt;klass_at(cp_index, CHECK_NULL);</span>
<span class="line-modified">1927          if (k-&gt;is_instance_klass()) {</span>
<span class="line-modified">1928            InstanceKlass* nest_host_k =</span>
<span class="line-modified">1929              InstanceKlass::cast(k)-&gt;nest_host(icce, CHECK_NULL);</span>
<span class="line-modified">1930            if (nest_host_k == host) {</span>
<span class="line-modified">1931              result-&gt;obj_at_put(i+1, k-&gt;java_mirror());</span>
<span class="line-modified">1932            }</span>
<span class="line-modified">1933            else {</span>
<span class="line-modified">1934              // k&#39;s nest host is legal but it isn&#39;t our host so</span>
<span class="line-modified">1935              // throw ICCE</span>
<span class="line-modified">1936              ResourceMark rm(THREAD);</span>
<span class="line-modified">1937              Exceptions::fthrow(THREAD_AND_LOCATION,</span>
<span class="line-modified">1938                                 icce,</span>
<span class="line-modified">1939                                 &quot;Nest member %s in %s declares a different nest host of %s&quot;,</span>
<span class="line-modified">1940                                 k-&gt;external_name(),</span>
<span class="line-modified">1941                                 host-&gt;external_name(),</span>
<span class="line-modified">1942                                 nest_host_k-&gt;external_name()</span>
<span class="line-modified">1943                            );</span>
<span class="line-modified">1944              return NULL;</span>
<span class="line-modified">1945            }</span>
<span class="line-modified">1946          }</span>
<span class="line-modified">1947          else {</span>
<span class="line-modified">1948            // we have a bad nest member entry - throw ICCE</span>
<span class="line-modified">1949            ResourceMark rm(THREAD);</span>
<span class="line-modified">1950            Exceptions::fthrow(THREAD_AND_LOCATION,</span>
<span class="line-modified">1951                               icce,</span>
<span class="line-modified">1952                               &quot;Class %s can not be a nest member of %s&quot;,</span>
<span class="line-modified">1953                               k-&gt;external_name(),</span>
<span class="line-modified">1954                               host-&gt;external_name()</span>
<span class="line-modified">1955                               );</span>
<span class="line-modified">1956            return NULL;</span>
<span class="line-modified">1957          }</span>











1958       }
1959     }
1960     else {
<span class="line-modified">1961       assert(host == ck, &quot;must be singleton nest&quot;);</span>
1962     }
1963     return (jobjectArray)JNIHandles::make_local(THREAD, result());
1964   }
1965 }
1966 JVM_END
1967 
1968 // Constant pool access //////////////////////////////////////////////////////////
1969 
1970 JVM_ENTRY(jobject, JVM_GetClassConstantPool(JNIEnv *env, jclass cls))
1971 {
1972   JVMWrapper(&quot;JVM_GetClassConstantPool&quot;);
1973   JvmtiVMObjectAllocEventCollector oam;
1974 
1975   // Return null for primitives and arrays
1976   if (!java_lang_Class::is_primitive(JNIHandles::resolve_non_null(cls))) {
1977     Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(cls));
1978     if (k-&gt;is_instance_klass()) {
1979       InstanceKlass* k_h = InstanceKlass::cast(k);
1980       Handle jcp = reflect_ConstantPool::create(CHECK_NULL);
1981       reflect_ConstantPool::set_cp(jcp(), k_h-&gt;constants());
</pre>
</td>
<td>
<hr />
<pre>
 974   Handle class_loader (THREAD, JNIHandles::resolve(loader));
 975   if (UsePerfData) {
 976     is_lock_held_by_thread(class_loader,
 977                            ClassLoader::sync_JVMDefineClassLockFreeCounter(),
 978                            THREAD);
 979   }
 980   Handle protection_domain (THREAD, JNIHandles::resolve(pd));
 981   Klass* k = SystemDictionary::resolve_from_stream(class_name,
 982                                                    class_loader,
 983                                                    protection_domain,
 984                                                    &amp;st,
 985                                                    CHECK_NULL);
 986 
 987   if (log_is_enabled(Debug, class, resolve) &amp;&amp; k != NULL) {
 988     trace_class_resolution(k);
 989   }
 990 
 991   return (jclass) JNIHandles::make_local(env, k-&gt;java_mirror());
 992 }
 993 
<span class="line-added"> 994 enum {</span>
<span class="line-added"> 995   NESTMATE              = java_lang_invoke_MemberName::MN_NESTMATE_CLASS,</span>
<span class="line-added"> 996   HIDDEN_CLASS          = java_lang_invoke_MemberName::MN_HIDDEN_CLASS,</span>
<span class="line-added"> 997   STRONG_LOADER_LINK    = java_lang_invoke_MemberName::MN_STRONG_LOADER_LINK,</span>
<span class="line-added"> 998   ACCESS_VM_ANNOTATIONS = java_lang_invoke_MemberName::MN_ACCESS_VM_ANNOTATIONS</span>
<span class="line-added"> 999 };</span>
<span class="line-added">1000 </span>
<span class="line-added">1001 /*</span>
<span class="line-added">1002  * Define a class with the specified flags that indicates if it&#39;s a nestmate,</span>
<span class="line-added">1003  * hidden, or strongly referenced from class loader.</span>
<span class="line-added">1004  */</span>
<span class="line-added">1005 static jclass jvm_lookup_define_class(JNIEnv *env, jclass lookup, const char *name,</span>
<span class="line-added">1006                                       const jbyte *buf, jsize len, jobject pd,</span>
<span class="line-added">1007                                       jboolean init, int flags, jobject classData, TRAPS) {</span>
<span class="line-added">1008   assert(THREAD-&gt;is_Java_thread(), &quot;must be a JavaThread&quot;);</span>
<span class="line-added">1009   JavaThread* jt = (JavaThread*) THREAD;</span>
<span class="line-added">1010   ResourceMark rm(THREAD);</span>
<span class="line-added">1011 </span>
<span class="line-added">1012   Klass* lookup_k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(lookup));</span>
<span class="line-added">1013   // Lookup class must be a non-null instance</span>
<span class="line-added">1014   if (lookup_k == NULL) {</span>
<span class="line-added">1015     THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;Lookup class is null&quot;);</span>
<span class="line-added">1016   }</span>
<span class="line-added">1017   assert(lookup_k-&gt;is_instance_klass(), &quot;Lookup class must be an instance klass&quot;);</span>
<span class="line-added">1018 </span>
<span class="line-added">1019   Handle class_loader (THREAD, lookup_k-&gt;class_loader());</span>
<span class="line-added">1020 </span>
<span class="line-added">1021   bool is_nestmate = (flags &amp; NESTMATE) == NESTMATE;</span>
<span class="line-added">1022   bool is_hidden = (flags &amp; HIDDEN_CLASS) == HIDDEN_CLASS;</span>
<span class="line-added">1023   bool is_strong = (flags &amp; STRONG_LOADER_LINK) == STRONG_LOADER_LINK;</span>
<span class="line-added">1024   bool vm_annotations = (flags &amp; ACCESS_VM_ANNOTATIONS) == ACCESS_VM_ANNOTATIONS;</span>
<span class="line-added">1025 </span>
<span class="line-added">1026   InstanceKlass* host_class = NULL;</span>
<span class="line-added">1027   if (is_nestmate) {</span>
<span class="line-added">1028     host_class = InstanceKlass::cast(lookup_k)-&gt;nest_host(CHECK_NULL);</span>
<span class="line-added">1029   }</span>
<span class="line-added">1030 </span>
<span class="line-added">1031   log_info(class, nestmates)(&quot;LookupDefineClass: %s - %s%s, %s, %s, %s&quot;,</span>
<span class="line-added">1032                              name,</span>
<span class="line-added">1033                              is_nestmate ? &quot;with dynamic nest-host &quot; : &quot;non-nestmate&quot;,</span>
<span class="line-added">1034                              is_nestmate ? host_class-&gt;external_name() : &quot;&quot;,</span>
<span class="line-added">1035                              is_hidden ? &quot;hidden&quot; : &quot;not hidden&quot;,</span>
<span class="line-added">1036                              is_strong ? &quot;strong&quot; : &quot;weak&quot;,</span>
<span class="line-added">1037                              vm_annotations ? &quot;with vm annotations&quot; : &quot;without vm annotation&quot;);</span>
<span class="line-added">1038 </span>
<span class="line-added">1039   if (!is_hidden) {</span>
<span class="line-added">1040     // classData is only applicable for hidden classes</span>
<span class="line-added">1041     if (classData != NULL) {</span>
<span class="line-added">1042       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;classData is only applicable for hidden classes&quot;);</span>
<span class="line-added">1043     }</span>
<span class="line-added">1044     if (is_nestmate) {</span>
<span class="line-added">1045       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;dynamic nestmate is only applicable for hidden classes&quot;);</span>
<span class="line-added">1046     }</span>
<span class="line-added">1047     if (!is_strong) {</span>
<span class="line-added">1048       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;an ordinary class must be strongly referenced by its defining loader&quot;);</span>
<span class="line-added">1049     }</span>
<span class="line-added">1050     if (vm_annotations) {</span>
<span class="line-added">1051       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;vm annotations only allowed for hidden classes&quot;);</span>
<span class="line-added">1052     }</span>
<span class="line-added">1053     if (flags != STRONG_LOADER_LINK) {</span>
<span class="line-added">1054       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(),</span>
<span class="line-added">1055                   err_msg(&quot;invalid flag 0x%x&quot;, flags));</span>
<span class="line-added">1056     }</span>
<span class="line-added">1057   }</span>
<span class="line-added">1058 </span>
<span class="line-added">1059 </span>
<span class="line-added">1060   // Since exceptions can be thrown, class initialization can take place</span>
<span class="line-added">1061   // if name is NULL no check for class name in .class stream has to be made.</span>
<span class="line-added">1062   TempNewSymbol class_name = NULL;</span>
<span class="line-added">1063   if (name != NULL) {</span>
<span class="line-added">1064     const int str_len = (int)strlen(name);</span>
<span class="line-added">1065     if (str_len &gt; Symbol::max_length()) {</span>
<span class="line-added">1066       // It&#39;s impossible to create this class;  the name cannot fit</span>
<span class="line-added">1067       // into the constant pool.</span>
<span class="line-added">1068       Exceptions::fthrow(THREAD_AND_LOCATION,</span>
<span class="line-added">1069                          vmSymbols::java_lang_NoClassDefFoundError(),</span>
<span class="line-added">1070                          &quot;Class name exceeds maximum length of %d: %s&quot;,</span>
<span class="line-added">1071                          Symbol::max_length(),</span>
<span class="line-added">1072                          name);</span>
<span class="line-added">1073       return 0;</span>
<span class="line-added">1074     }</span>
<span class="line-added">1075     class_name = SymbolTable::new_symbol(name, str_len);</span>
<span class="line-added">1076   }</span>
<span class="line-added">1077 </span>
<span class="line-added">1078   Handle protection_domain (THREAD, JNIHandles::resolve(pd));</span>
<span class="line-added">1079   const char* source = is_nestmate ? host_class-&gt;external_name() : &quot;__JVM_LookupDefineClass__&quot;;</span>
<span class="line-added">1080   ClassFileStream st((u1*)buf, len, source, ClassFileStream::verify);</span>
<span class="line-added">1081 </span>
<span class="line-added">1082   Klass* defined_k;</span>
<span class="line-added">1083   InstanceKlass* ik = NULL;</span>
<span class="line-added">1084   if (!is_hidden) {</span>
<span class="line-added">1085     defined_k = SystemDictionary::resolve_from_stream(class_name,</span>
<span class="line-added">1086                                                       class_loader,</span>
<span class="line-added">1087                                                       protection_domain,</span>
<span class="line-added">1088                                                       &amp;st,</span>
<span class="line-added">1089                                                       CHECK_NULL);</span>
<span class="line-added">1090 </span>
<span class="line-added">1091     if (log_is_enabled(Debug, class, resolve) &amp;&amp; defined_k != NULL) {</span>
<span class="line-added">1092       trace_class_resolution(defined_k);</span>
<span class="line-added">1093     }</span>
<span class="line-added">1094     ik = InstanceKlass::cast(defined_k);</span>
<span class="line-added">1095   } else { // hidden</span>
<span class="line-added">1096     Handle classData_h(THREAD, JNIHandles::resolve(classData));</span>
<span class="line-added">1097     ClassLoadInfo cl_info(protection_domain,</span>
<span class="line-added">1098                           NULL, // unsafe_anonymous_host</span>
<span class="line-added">1099                           NULL, // cp_patches</span>
<span class="line-added">1100                           host_class,</span>
<span class="line-added">1101                           classData_h,</span>
<span class="line-added">1102                           is_hidden,</span>
<span class="line-added">1103                           is_strong,</span>
<span class="line-added">1104                           vm_annotations);</span>
<span class="line-added">1105     defined_k = SystemDictionary::parse_stream(class_name,</span>
<span class="line-added">1106                                                class_loader,</span>
<span class="line-added">1107                                                &amp;st,</span>
<span class="line-added">1108                                                cl_info,</span>
<span class="line-added">1109                                                CHECK_NULL);</span>
<span class="line-added">1110     if (defined_k == NULL) {</span>
<span class="line-added">1111       THROW_MSG_0(vmSymbols::java_lang_Error(), &quot;Failure to define a hidden class&quot;);</span>
<span class="line-added">1112     }</span>
<span class="line-added">1113 </span>
<span class="line-added">1114     ik = InstanceKlass::cast(defined_k);</span>
<span class="line-added">1115 </span>
<span class="line-added">1116     // The hidden class loader data has been artificially been kept alive to</span>
<span class="line-added">1117     // this point. The mirror and any instances of this class have to keep</span>
<span class="line-added">1118     // it alive afterwards.</span>
<span class="line-added">1119     ik-&gt;class_loader_data()-&gt;dec_keep_alive();</span>
<span class="line-added">1120 </span>
<span class="line-added">1121     if (is_nestmate &amp;&amp; log_is_enabled(Debug, class, nestmates)) {</span>
<span class="line-added">1122       ModuleEntry* module = ik-&gt;module();</span>
<span class="line-added">1123       const char * module_name = module-&gt;is_named() ? module-&gt;name()-&gt;as_C_string() : UNNAMED_MODULE;</span>
<span class="line-added">1124       log_debug(class, nestmates)(&quot;Dynamic nestmate: %s/%s, nest_host %s, %s&quot;,</span>
<span class="line-added">1125                                   module_name,</span>
<span class="line-added">1126                                   ik-&gt;external_name(),</span>
<span class="line-added">1127                                   host_class-&gt;external_name(),</span>
<span class="line-added">1128                                   ik-&gt;is_hidden() ? &quot;is hidden&quot; : &quot;is not hidden&quot;);</span>
<span class="line-added">1129     }</span>
<span class="line-added">1130   }</span>
<span class="line-added">1131   assert(Reflection::is_same_class_package(lookup_k, defined_k),</span>
<span class="line-added">1132          &quot;lookup class and defined class are in different packages&quot;);</span>
<span class="line-added">1133 </span>
<span class="line-added">1134   if (init) {</span>
<span class="line-added">1135     ik-&gt;initialize(CHECK_NULL);</span>
<span class="line-added">1136   } else {</span>
<span class="line-added">1137     ik-&gt;link_class(CHECK_NULL);</span>
<span class="line-added">1138   }</span>
<span class="line-added">1139 </span>
<span class="line-added">1140   return (jclass) JNIHandles::make_local(env, defined_k-&gt;java_mirror());</span>
<span class="line-added">1141 }</span>
1142 
1143 JVM_ENTRY(jclass, JVM_DefineClass(JNIEnv *env, const char *name, jobject loader, const jbyte *buf, jsize len, jobject pd))
1144   JVMWrapper(&quot;JVM_DefineClass&quot;);
1145 
1146   return jvm_define_class_common(env, name, loader, buf, len, pd, NULL, THREAD);
1147 JVM_END
1148 
<span class="line-added">1149 /*</span>
<span class="line-added">1150  * Define a class with the specified lookup class.</span>
<span class="line-added">1151  *  lookup:  Lookup class</span>
<span class="line-added">1152  *  name:    the name of the class</span>
<span class="line-added">1153  *  buf:     class bytes</span>
<span class="line-added">1154  *  len:     length of class bytes</span>
<span class="line-added">1155  *  pd:      protection domain</span>
<span class="line-added">1156  *  init:    initialize the class</span>
<span class="line-added">1157  *  flags:   properties of the class</span>
<span class="line-added">1158  *  classData: private static pre-initialized field</span>
<span class="line-added">1159  */</span>
<span class="line-added">1160 JVM_ENTRY(jclass, JVM_LookupDefineClass(JNIEnv *env, jclass lookup, const char *name, const jbyte *buf,</span>
<span class="line-added">1161           jsize len, jobject pd, jboolean initialize, int flags, jobject classData))</span>
<span class="line-added">1162   JVMWrapper(&quot;JVM_LookupDefineClass&quot;);</span>
<span class="line-added">1163 </span>
<span class="line-added">1164   if (lookup == NULL) {</span>
<span class="line-added">1165     THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;Lookup class is null&quot;);</span>
<span class="line-added">1166   }</span>
<span class="line-added">1167 </span>
<span class="line-added">1168   assert(buf != NULL, &quot;buf must not be NULL&quot;);</span>
<span class="line-added">1169 </span>
<span class="line-added">1170   return jvm_lookup_define_class(env, lookup, name, buf, len, pd, initialize, flags, classData, THREAD);</span>
<span class="line-added">1171 JVM_END</span>
1172 
1173 JVM_ENTRY(jclass, JVM_DefineClassWithSource(JNIEnv *env, const char *name, jobject loader, const jbyte *buf, jsize len, jobject pd, const char *source))
1174   JVMWrapper(&quot;JVM_DefineClassWithSource&quot;);
1175 
1176   return jvm_define_class_common(env, name, loader, buf, len, pd, source, THREAD);
1177 JVM_END
1178 
1179 JVM_ENTRY(jclass, JVM_FindLoadedClass(JNIEnv *env, jobject loader, jstring name))
1180   JVMWrapper(&quot;JVM_FindLoadedClass&quot;);
1181   ResourceMark rm(THREAD);
1182 
1183   Handle h_name (THREAD, JNIHandles::resolve_non_null(name));
1184   char* str = java_lang_String::as_utf8_string(h_name());
1185 
1186   // Sanity check, don&#39;t expect null
1187   if (str == NULL) return NULL;
1188 
1189   // Internalize the string, converting &#39;.&#39; to &#39;/&#39; in string.
1190   char* p = (char*)str;
1191   while (*p != &#39;\0&#39;) {
</pre>
<hr />
<pre>
1214   }
1215 
1216   Klass* k = SystemDictionary::find_instance_or_array_klass(klass_name,
1217                                                               h_loader,
1218                                                               Handle(),
1219                                                               CHECK_NULL);
1220 #if INCLUDE_CDS
1221   if (k == NULL) {
1222     // If the class is not already loaded, try to see if it&#39;s in the shared
1223     // archive for the current classloader (h_loader).
1224     k = SystemDictionaryShared::find_or_load_shared_class(klass_name, h_loader, CHECK_NULL);
1225   }
1226 #endif
1227   return (k == NULL) ? NULL :
1228             (jclass) JNIHandles::make_local(env, k-&gt;java_mirror());
1229 JVM_END
1230 
1231 // Module support //////////////////////////////////////////////////////////////////////////////
1232 
1233 JVM_ENTRY(void, JVM_DefineModule(JNIEnv *env, jobject module, jboolean is_open, jstring version,
<span class="line-modified">1234                                  jstring location, jobjectArray packages))</span>
1235   JVMWrapper(&quot;JVM_DefineModule&quot;);
<span class="line-modified">1236   Modules::define_module(module, is_open, version, location, packages, CHECK);</span>
1237 JVM_END
1238 
1239 JVM_ENTRY(void, JVM_SetBootLoaderUnnamedModule(JNIEnv *env, jobject module))
1240   JVMWrapper(&quot;JVM_SetBootLoaderUnnamedModule&quot;);
1241   Modules::set_bootloader_unnamed_module(module, CHECK);
1242 JVM_END
1243 
<span class="line-modified">1244 JVM_ENTRY(void, JVM_AddModuleExports(JNIEnv *env, jobject from_module, jstring package, jobject to_module))</span>
1245   JVMWrapper(&quot;JVM_AddModuleExports&quot;);
1246   Modules::add_module_exports_qualified(from_module, package, to_module, CHECK);
1247 JVM_END
1248 
<span class="line-modified">1249 JVM_ENTRY(void, JVM_AddModuleExportsToAllUnnamed(JNIEnv *env, jobject from_module, jstring package))</span>
1250   JVMWrapper(&quot;JVM_AddModuleExportsToAllUnnamed&quot;);
1251   Modules::add_module_exports_to_all_unnamed(from_module, package, CHECK);
1252 JVM_END
1253 
<span class="line-modified">1254 JVM_ENTRY(void, JVM_AddModuleExportsToAll(JNIEnv *env, jobject from_module, jstring package))</span>
1255   JVMWrapper(&quot;JVM_AddModuleExportsToAll&quot;);
1256   Modules::add_module_exports(from_module, package, NULL, CHECK);
1257 JVM_END
1258 
1259 JVM_ENTRY (void, JVM_AddReadsModule(JNIEnv *env, jobject from_module, jobject source_module))
1260   JVMWrapper(&quot;JVM_AddReadsModule&quot;);
1261   Modules::add_reads_module(from_module, source_module, CHECK);
1262 JVM_END
1263 
1264 // Reflection support //////////////////////////////////////////////////////////////////////////////
1265 
1266 JVM_ENTRY(jstring, JVM_InitClassName(JNIEnv *env, jclass cls))
1267   assert (cls != NULL, &quot;illegal class&quot;);
1268   JVMWrapper(&quot;JVM_InitClassName&quot;);
1269   JvmtiVMObjectAllocEventCollector oam;
1270   ResourceMark rm(THREAD);
1271   HandleMark hm(THREAD);
1272   Handle java_class(THREAD, JNIHandles::resolve(cls));
1273   oop result = java_lang_Class::name(java_class, CHECK_NULL);
1274   return (jstring) JNIHandles::make_local(env, result);
</pre>
<hr />
<pre>
1323   }
1324   return (jobjectArray) JNIHandles::make_local(env, result());
1325 JVM_END
1326 
1327 
1328 JVM_ENTRY(jboolean, JVM_IsInterface(JNIEnv *env, jclass cls))
1329   JVMWrapper(&quot;JVM_IsInterface&quot;);
1330   oop mirror = JNIHandles::resolve_non_null(cls);
1331   if (java_lang_Class::is_primitive(mirror)) {
1332     return JNI_FALSE;
1333   }
1334   Klass* k = java_lang_Class::as_Klass(mirror);
1335   jboolean result = k-&gt;is_interface();
1336   assert(!result || k-&gt;is_instance_klass(),
1337          &quot;all interfaces are instance types&quot;);
1338   // The compiler intrinsic for isInterface tests the
1339   // Klass::_access_flags bits in the same way.
1340   return result;
1341 JVM_END
1342 
<span class="line-added">1343 JVM_ENTRY(jboolean, JVM_IsHiddenClass(JNIEnv *env, jclass cls))</span>
<span class="line-added">1344   JVMWrapper(&quot;JVM_IsHiddenClass&quot;);</span>
<span class="line-added">1345   oop mirror = JNIHandles::resolve_non_null(cls);</span>
<span class="line-added">1346   if (java_lang_Class::is_primitive(mirror)) {</span>
<span class="line-added">1347     return JNI_FALSE;</span>
<span class="line-added">1348   }</span>
<span class="line-added">1349   Klass* k = java_lang_Class::as_Klass(mirror);</span>
<span class="line-added">1350   return k-&gt;is_hidden();</span>
<span class="line-added">1351 JVM_END</span>
1352 
1353 JVM_ENTRY(jobjectArray, JVM_GetClassSigners(JNIEnv *env, jclass cls))
1354   JVMWrapper(&quot;JVM_GetClassSigners&quot;);
1355   JvmtiVMObjectAllocEventCollector oam;
1356   if (java_lang_Class::is_primitive(JNIHandles::resolve_non_null(cls))) {
1357     // There are no signers for primitive types
1358     return NULL;
1359   }
1360 
1361   objArrayHandle signers(THREAD, java_lang_Class::signers(JNIHandles::resolve_non_null(cls)));
1362 
1363   // If there are no signers set in the class, or if the class
1364   // is an array, return NULL.
1365   if (signers == NULL) return NULL;
1366 
1367   // copy of the signers array
1368   Klass* element = ObjArrayKlass::cast(signers-&gt;klass())-&gt;element_klass();
1369   objArrayOop signers_copy = oopFactory::new_objArray(element, signers-&gt;length(), CHECK_NULL);
1370   for (int index = 0; index &lt; signers-&gt;length(); index++) {
1371     signers_copy-&gt;obj_at_put(index, signers-&gt;obj_at(index));
</pre>
<hr />
<pre>
1599     return (jobjectArray)JNIHandles::make_local(env, res);
1600   }
1601 
1602   return (jobjectArray)JNIHandles::make_local(env, result());
1603 JVM_END
1604 
1605 
1606 JVM_ENTRY(jclass, JVM_GetDeclaringClass(JNIEnv *env, jclass ofClass))
1607 {
1608   // ofClass is a reference to a java_lang_Class object.
1609   if (java_lang_Class::is_primitive(JNIHandles::resolve_non_null(ofClass)) ||
1610       ! java_lang_Class::as_Klass(JNIHandles::resolve_non_null(ofClass))-&gt;is_instance_klass()) {
1611     return NULL;
1612   }
1613 
1614   bool inner_is_member = false;
1615   Klass* outer_klass
1616     = InstanceKlass::cast(java_lang_Class::as_Klass(JNIHandles::resolve_non_null(ofClass))
1617                           )-&gt;compute_enclosing_class(&amp;inner_is_member, CHECK_NULL);
1618   if (outer_klass == NULL)  return NULL;  // already a top-level class
<span class="line-modified">1619   if (!inner_is_member)  return NULL;     // a hidden or unsafe anonymous class (inside a method)</span>
1620   return (jclass) JNIHandles::make_local(env, outer_klass-&gt;java_mirror());
1621 }
1622 JVM_END
1623 
1624 JVM_ENTRY(jstring, JVM_GetSimpleBinaryName(JNIEnv *env, jclass cls))
1625 {
1626   oop mirror = JNIHandles::resolve_non_null(cls);
1627   if (java_lang_Class::is_primitive(mirror) ||
1628       !java_lang_Class::as_Klass(mirror)-&gt;is_instance_klass()) {
1629     return NULL;
1630   }
1631   InstanceKlass* k = InstanceKlass::cast(java_lang_Class::as_Klass(mirror));
1632   int ooff = 0, noff = 0;
1633   if (k-&gt;find_inner_classes_attr(&amp;ooff, &amp;noff, THREAD)) {
1634     if (noff != 0) {
1635       constantPoolHandle i_cp(thread, k-&gt;constants());
1636       Symbol* name = i_cp-&gt;symbol_at(noff);
1637       Handle str = java_lang_String::create_from_symbol(name, CHECK_NULL);
1638       return (jstring) JNIHandles::make_local(env, str());
1639     }
</pre>
<hr />
<pre>
2055 JVM_ENTRY(jboolean, JVM_AreNestMates(JNIEnv *env, jclass current, jclass member))
2056 {
2057   JVMWrapper(&quot;JVM_AreNestMates&quot;);
2058   Klass* c = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(current));
2059   assert(c-&gt;is_instance_klass(), &quot;must be&quot;);
2060   InstanceKlass* ck = InstanceKlass::cast(c);
2061   Klass* m = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(member));
2062   assert(m-&gt;is_instance_klass(), &quot;must be&quot;);
2063   InstanceKlass* mk = InstanceKlass::cast(m);
2064   return ck-&gt;has_nestmate_access_to(mk, THREAD);
2065 }
2066 JVM_END
2067 
2068 JVM_ENTRY(jclass, JVM_GetNestHost(JNIEnv* env, jclass current))
2069 {
2070   // current is not a primitive or array class
2071   JVMWrapper(&quot;JVM_GetNestHost&quot;);
2072   Klass* c = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(current));
2073   assert(c-&gt;is_instance_klass(), &quot;must be&quot;);
2074   InstanceKlass* ck = InstanceKlass::cast(c);
<span class="line-modified">2075   InstanceKlass* host = ck-&gt;nest_host(THREAD);</span>

2076   return (jclass) (host == NULL ? NULL :
2077                    JNIHandles::make_local(THREAD, host-&gt;java_mirror()));
2078 }
2079 JVM_END
2080 
2081 JVM_ENTRY(jobjectArray, JVM_GetNestMembers(JNIEnv* env, jclass current))
2082 {
2083   // current is not a primitive or array class
2084   JVMWrapper(&quot;JVM_GetNestMembers&quot;);
<span class="line-added">2085   ResourceMark rm(THREAD);</span>
2086   Klass* c = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(current));
2087   assert(c-&gt;is_instance_klass(), &quot;must be&quot;);
2088   InstanceKlass* ck = InstanceKlass::cast(c);
<span class="line-modified">2089   InstanceKlass* host = ck-&gt;nest_host(THREAD);</span>


2090 
<span class="line-added">2091   log_trace(class, nestmates)(&quot;Calling GetNestMembers for type %s with nest-host %s&quot;,</span>
<span class="line-added">2092                               ck-&gt;external_name(), host-&gt;external_name());</span>
2093   {
2094     JvmtiVMObjectAllocEventCollector oam;
2095     Array&lt;u2&gt;* members = host-&gt;nest_members();
2096     int length = members == NULL ? 0 : members-&gt;length();
<span class="line-added">2097 </span>
<span class="line-added">2098     log_trace(class, nestmates)(&quot; - host has %d listed nest members&quot;, length);</span>
<span class="line-added">2099 </span>
2100     // nest host is first in the array so make it one bigger
2101     objArrayOop r = oopFactory::new_objArray(SystemDictionary::Class_klass(),
2102                                              length + 1, CHECK_NULL);
<span class="line-modified">2103     objArrayHandle result(THREAD, r);</span>
2104     result-&gt;obj_at_put(0, host-&gt;java_mirror());
2105     if (length != 0) {
<span class="line-modified">2106       int count = 0;</span>
<span class="line-modified">2107       for (int i = 0; i &lt; length; i++) {</span>
<span class="line-modified">2108         int cp_index = members-&gt;at(i);</span>
<span class="line-modified">2109         Klass* k = host-&gt;constants()-&gt;klass_at(cp_index, THREAD);</span>
<span class="line-modified">2110         if (HAS_PENDING_EXCEPTION) {</span>
<span class="line-modified">2111           if (PENDING_EXCEPTION-&gt;is_a(SystemDictionary::VirtualMachineError_klass())) {</span>
<span class="line-modified">2112             return NULL; // propagate VMEs</span>
<span class="line-modified">2113           }</span>
<span class="line-modified">2114           if (log_is_enabled(Trace, class, nestmates)) {</span>
<span class="line-modified">2115             stringStream ss;</span>
<span class="line-modified">2116             char* target_member_class = host-&gt;constants()-&gt;klass_name_at(cp_index)-&gt;as_C_string();</span>
<span class="line-modified">2117             ss.print(&quot; - resolution of nest member %s failed: &quot;, target_member_class);</span>
<span class="line-modified">2118             java_lang_Throwable::print(PENDING_EXCEPTION, &amp;ss);</span>
<span class="line-modified">2119             log_trace(class, nestmates)(&quot;%s&quot;, ss.as_string());</span>
<span class="line-modified">2120           }</span>
<span class="line-modified">2121           CLEAR_PENDING_EXCEPTION;</span>
<span class="line-modified">2122           continue;</span>
<span class="line-modified">2123         }</span>
<span class="line-modified">2124         if (k-&gt;is_instance_klass()) {</span>
<span class="line-modified">2125           InstanceKlass* ik = InstanceKlass::cast(k);</span>
<span class="line-modified">2126           InstanceKlass* nest_host_k = ik-&gt;nest_host(CHECK_NULL);</span>
<span class="line-modified">2127           if (nest_host_k == host) {</span>
<span class="line-modified">2128             result-&gt;obj_at_put(count+1, k-&gt;java_mirror());</span>
<span class="line-modified">2129             count++;</span>
<span class="line-modified">2130             log_trace(class, nestmates)(&quot; - [%d] = %s&quot;, count, ik-&gt;external_name());</span>
<span class="line-modified">2131           } else {</span>
<span class="line-modified">2132             log_trace(class, nestmates)(&quot; - skipping member %s with different host %s&quot;,</span>
<span class="line-modified">2133                                         ik-&gt;external_name(), nest_host_k-&gt;external_name());</span>
<span class="line-modified">2134           }</span>
<span class="line-modified">2135         } else {</span>
<span class="line-modified">2136           log_trace(class, nestmates)(&quot; - skipping member %s that is not an instance class&quot;,</span>
<span class="line-modified">2137                                       k-&gt;external_name());</span>
<span class="line-modified">2138         }</span>
<span class="line-modified">2139       }</span>
<span class="line-modified">2140       if (count &lt; length) {</span>
<span class="line-added">2141         // we had invalid entries so we need to compact the array</span>
<span class="line-added">2142         log_trace(class, nestmates)(&quot; - compacting array from length %d to %d&quot;,</span>
<span class="line-added">2143                                     length + 1, count + 1);</span>
<span class="line-added">2144 </span>
<span class="line-added">2145         objArrayOop r2 = oopFactory::new_objArray(SystemDictionary::Class_klass(),</span>
<span class="line-added">2146                                                   count + 1, CHECK_NULL);</span>
<span class="line-added">2147         objArrayHandle result2(THREAD, r2);</span>
<span class="line-added">2148         for (int i = 0; i &lt; count + 1; i++) {</span>
<span class="line-added">2149           result2-&gt;obj_at_put(i, result-&gt;obj_at(i));</span>
<span class="line-added">2150         }</span>
<span class="line-added">2151         return (jobjectArray)JNIHandles::make_local(THREAD, result2());</span>
2152       }
2153     }
2154     else {
<span class="line-modified">2155       assert(host == ck || ck-&gt;is_hidden(), &quot;must be singleton nest or dynamic nestmate&quot;);</span>
2156     }
2157     return (jobjectArray)JNIHandles::make_local(THREAD, result());
2158   }
2159 }
2160 JVM_END
2161 
2162 // Constant pool access //////////////////////////////////////////////////////////
2163 
2164 JVM_ENTRY(jobject, JVM_GetClassConstantPool(JNIEnv *env, jclass cls))
2165 {
2166   JVMWrapper(&quot;JVM_GetClassConstantPool&quot;);
2167   JvmtiVMObjectAllocEventCollector oam;
2168 
2169   // Return null for primitives and arrays
2170   if (!java_lang_Class::is_primitive(JNIHandles::resolve_non_null(cls))) {
2171     Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(cls));
2172     if (k-&gt;is_instance_klass()) {
2173       InstanceKlass* k_h = InstanceKlass::cast(k);
2174       Handle jcp = reflect_ConstantPool::create(CHECK_NULL);
2175       reflect_ConstantPool::set_cp(jcp(), k_h-&gt;constants());
</pre>
</td>
</tr>
</table>
<center><a href="../opto/node.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmtiEnv.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>