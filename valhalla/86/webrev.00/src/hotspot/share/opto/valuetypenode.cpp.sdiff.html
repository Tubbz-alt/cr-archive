<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/opto/valuetypenode.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="macro.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/hotspot/share/opto/valuetypenode.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
802 
803   if (!is_allocated(phase)) {
804     // Save base oop if fields are loaded from memory and the value
805     // type is not buffered (in this case we should not use the oop).
806     Node* base = is_loaded(phase);
807     if (base != NULL) {
808       set_oop(base);
809       assert(is_allocated(phase), &quot;should now be allocated&quot;);
810       return this;
811     }
812   }
813 
814   if (can_reshape) {
815     PhaseIterGVN* igvn = phase-&gt;is_IterGVN();
816 
817     if (is_default(*phase)) {
818       // Search for users of the default value type
819       for (DUIterator_Fast imax, i = fast_outs(imax); i &lt; imax; i++) {
820         Node* user = fast_out(i);
821         AllocateNode* alloc = user-&gt;isa_Allocate();
<span class="line-modified">822         if (alloc != NULL &amp;&amp; alloc-&gt;result_cast() != NULL &amp;&amp; alloc-&gt;in(AllocateNode::ValueNode) == this) {</span>
823           // Found an allocation of the default value type.
<span class="line-removed">824           // If the code in StoreNode::Identity() that removes useless stores was not yet</span>
<span class="line-removed">825           // executed or ReduceFieldZeroing is disabled, there can still be initializing</span>
<span class="line-removed">826           // stores (only zero-type or default value stores, because value types are immutable).</span>
827           Node* res = alloc-&gt;result_cast();
<span class="line-modified">828           for (DUIterator_Fast jmax, j = res-&gt;fast_outs(jmax); j &lt; jmax; j++) {</span>
<span class="line-modified">829             AddPNode* addp = res-&gt;fast_out(j)-&gt;isa_AddP();</span>
<span class="line-modified">830             if (addp != NULL) {</span>
<span class="line-modified">831               for (DUIterator_Fast kmax, k = addp-&gt;fast_outs(kmax); k &lt; kmax; k++) {</span>
<span class="line-modified">832                 StoreNode* store = addp-&gt;fast_out(k)-&gt;isa_Store();</span>
<span class="line-modified">833                 if (store != NULL &amp;&amp; store-&gt;outcnt() != 0) {</span>
<span class="line-modified">834                   // Remove the useless store</span>
<span class="line-modified">835                   igvn-&gt;replace_in_uses(store, store-&gt;in(MemNode::Memory));</span>





836                 }
837               }
838             }


839           }
<span class="line-modified">840           // Replace allocation by pre-allocated oop</span>
<span class="line-modified">841           igvn-&gt;replace_node(res, default_oop(*phase, value_klass()));</span>

842         } else if (user-&gt;is_ValueType()) {
843           // Add value type user to worklist to give it a chance to get optimized as well
844           igvn-&gt;_worklist.push(user);
845         }
846       }
847     }
848 
849     if (is_allocated(igvn)) {
850       // Value type is heap allocated, search for safepoint uses
851       for (DUIterator_Fast imax, i = fast_outs(imax); i &lt; imax; i++) {
852         Node* out = fast_out(i);
853         if (out-&gt;is_SafePoint()) {
854           // Let SafePointNode::Ideal() take care of re-wiring the
855           // safepoint to the oop input instead of the value type node.
856           igvn-&gt;rehash_node_delayed(out);
857         }
858       }
859     }
860   }
861   return NULL;
</pre>
<hr />
<pre>
890                 phase-&gt;is_dominator(res_other-&gt;in(0), res_dom-&gt;in(0))) {
891               res_dom = res_other;
892             }
893           }
894         }
895       }
896       if (res_dom != res) {
897         // Move users to dominating allocation
898         igvn-&gt;replace_node(res, res_dom);
899         // The result of the dominated allocation is now unused and will be removed
900         // later in PhaseMacroExpand::eliminate_allocate_node to not confuse loop opts.
901         igvn-&gt;record_for_igvn(alloc);
902       }
903     }
904   }
905 
906   // Process users
907   for (DUIterator_Fast imax, i = fast_outs(imax); i &lt; imax; i++) {
908     Node* out = fast_out(i);
909     if (out-&gt;is_ValueType()) {
<span class="line-modified">910       // Recursively process value type users</span>


911       out-&gt;as_ValueType()-&gt;remove_redundant_allocations(igvn, phase);
<span class="line-modified">912       --i; --imax;</span>
913     } else if (out-&gt;isa_Allocate() != NULL) {
914       // Unlink AllocateNode
915       assert(out-&gt;in(AllocateNode::ValueNode) == this, &quot;should be linked&quot;);
916       igvn-&gt;replace_input_of(out, AllocateNode::ValueNode, igvn-&gt;C-&gt;top());
917       --i; --imax;
918     } else {
919 #ifdef ASSERT
920       // The value type should not have any other users at this time
921       out-&gt;dump();
922       assert(false, &quot;unexpected user of value type&quot;);
923 #endif
924     }
925   }
926   igvn-&gt;remove_dead_node(this);
927 }
</pre>
</td>
<td>
<hr />
<pre>
802 
803   if (!is_allocated(phase)) {
804     // Save base oop if fields are loaded from memory and the value
805     // type is not buffered (in this case we should not use the oop).
806     Node* base = is_loaded(phase);
807     if (base != NULL) {
808       set_oop(base);
809       assert(is_allocated(phase), &quot;should now be allocated&quot;);
810       return this;
811     }
812   }
813 
814   if (can_reshape) {
815     PhaseIterGVN* igvn = phase-&gt;is_IterGVN();
816 
817     if (is_default(*phase)) {
818       // Search for users of the default value type
819       for (DUIterator_Fast imax, i = fast_outs(imax); i &lt; imax; i++) {
820         Node* user = fast_out(i);
821         AllocateNode* alloc = user-&gt;isa_Allocate();
<span class="line-modified">822         if (alloc != NULL &amp;&amp; alloc-&gt;in(AllocateNode::ValueNode) == this) {</span>
823           // Found an allocation of the default value type.



824           Node* res = alloc-&gt;result_cast();
<span class="line-modified">825           if (res != NULL) {</span>
<span class="line-modified">826             // If the code in StoreNode::Identity() that removes useless stores was not yet</span>
<span class="line-modified">827             // executed or ReduceFieldZeroing is disabled, there can still be initializing</span>
<span class="line-modified">828             // stores (only zero-type or default value stores, because value types are immutable).</span>
<span class="line-modified">829             for (DUIterator_Fast jmax, j = res-&gt;fast_outs(jmax); j &lt; jmax; j++) {</span>
<span class="line-modified">830               AddPNode* addp = res-&gt;fast_out(j)-&gt;isa_AddP();</span>
<span class="line-modified">831               if (addp != NULL) {</span>
<span class="line-modified">832                 for (DUIterator_Fast kmax, k = addp-&gt;fast_outs(kmax); k &lt; kmax; k++) {</span>
<span class="line-added">833                   StoreNode* store = addp-&gt;fast_out(k)-&gt;isa_Store();</span>
<span class="line-added">834                   if (store != NULL &amp;&amp; store-&gt;outcnt() != 0) {</span>
<span class="line-added">835                     // Remove the useless store</span>
<span class="line-added">836                     igvn-&gt;replace_in_uses(store, store-&gt;in(MemNode::Memory));</span>
<span class="line-added">837                   }</span>
838                 }
839               }
840             }
<span class="line-added">841             // Replace allocation by pre-allocated oop</span>
<span class="line-added">842             igvn-&gt;replace_node(res, default_oop(*phase, value_klass()));</span>
843           }
<span class="line-modified">844           // Unlink AllocateNode</span>
<span class="line-modified">845           igvn-&gt;replace_input_of(alloc, AllocateNode::ValueNode, igvn-&gt;C-&gt;top());</span>
<span class="line-added">846           --i; --imax;</span>
847         } else if (user-&gt;is_ValueType()) {
848           // Add value type user to worklist to give it a chance to get optimized as well
849           igvn-&gt;_worklist.push(user);
850         }
851       }
852     }
853 
854     if (is_allocated(igvn)) {
855       // Value type is heap allocated, search for safepoint uses
856       for (DUIterator_Fast imax, i = fast_outs(imax); i &lt; imax; i++) {
857         Node* out = fast_out(i);
858         if (out-&gt;is_SafePoint()) {
859           // Let SafePointNode::Ideal() take care of re-wiring the
860           // safepoint to the oop input instead of the value type node.
861           igvn-&gt;rehash_node_delayed(out);
862         }
863       }
864     }
865   }
866   return NULL;
</pre>
<hr />
<pre>
895                 phase-&gt;is_dominator(res_other-&gt;in(0), res_dom-&gt;in(0))) {
896               res_dom = res_other;
897             }
898           }
899         }
900       }
901       if (res_dom != res) {
902         // Move users to dominating allocation
903         igvn-&gt;replace_node(res, res_dom);
904         // The result of the dominated allocation is now unused and will be removed
905         // later in PhaseMacroExpand::eliminate_allocate_node to not confuse loop opts.
906         igvn-&gt;record_for_igvn(alloc);
907       }
908     }
909   }
910 
911   // Process users
912   for (DUIterator_Fast imax, i = fast_outs(imax); i &lt; imax; i++) {
913     Node* out = fast_out(i);
914     if (out-&gt;is_ValueType()) {
<span class="line-modified">915       // Unlink and recursively process value type users</span>
<span class="line-added">916       igvn-&gt;hash_delete(out);</span>
<span class="line-added">917       int nb = out-&gt;replace_edge(this, igvn-&gt;C-&gt;top());</span>
918       out-&gt;as_ValueType()-&gt;remove_redundant_allocations(igvn, phase);
<span class="line-modified">919       --i; imax -= nb;</span>
920     } else if (out-&gt;isa_Allocate() != NULL) {
921       // Unlink AllocateNode
922       assert(out-&gt;in(AllocateNode::ValueNode) == this, &quot;should be linked&quot;);
923       igvn-&gt;replace_input_of(out, AllocateNode::ValueNode, igvn-&gt;C-&gt;top());
924       --i; --imax;
925     } else {
926 #ifdef ASSERT
927       // The value type should not have any other users at this time
928       out-&gt;dump();
929       assert(false, &quot;unexpected user of value type&quot;);
930 #endif
931     }
932   }
933   igvn-&gt;remove_dead_node(this);
934 }
</pre>
</td>
</tr>
</table>
<center><a href="macro.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>