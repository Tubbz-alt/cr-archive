<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/prims/jni.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../opto/subnode.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="unsafe.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/prims/jni.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 47,11 ***</span>
  #include &quot;memory/oopFactory.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;memory/universe.hpp&quot;
  #include &quot;oops/access.inline.hpp&quot;
  #include &quot;oops/arrayOop.inline.hpp&quot;
<span class="line-modified">! #include &quot;oops/instanceKlass.hpp&quot;</span>
  #include &quot;oops/instanceOop.hpp&quot;
  #include &quot;oops/markWord.hpp&quot;
  #include &quot;oops/method.hpp&quot;
  #include &quot;oops/objArrayKlass.hpp&quot;
  #include &quot;oops/objArrayOop.inline.hpp&quot;
<span class="line-new-header">--- 47,11 ---</span>
  #include &quot;memory/oopFactory.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;memory/universe.hpp&quot;
  #include &quot;oops/access.inline.hpp&quot;
  #include &quot;oops/arrayOop.inline.hpp&quot;
<span class="line-modified">! #include &quot;oops/instanceKlass.inline.hpp&quot;</span>
  #include &quot;oops/instanceOop.hpp&quot;
  #include &quot;oops/markWord.hpp&quot;
  #include &quot;oops/method.hpp&quot;
  #include &quot;oops/objArrayKlass.hpp&quot;
  #include &quot;oops/objArrayOop.inline.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1066,23 ***</span>
    if (is_reference_type(result-&gt;get_type())) {
      result-&gt;set_jobject(JNIHandles::make_local(env, (oop) result-&gt;get_jobject()));
    }
  }
  
<span class="line-removed">- </span>
<span class="line-removed">- static instanceOop alloc_object(jclass clazz, TRAPS) {</span>
<span class="line-removed">-   Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz));</span>
<span class="line-removed">-   if (k == NULL) {</span>
<span class="line-removed">-     ResourceMark rm(THREAD);</span>
<span class="line-removed">-     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);</span>
<span class="line-removed">-   }</span>
<span class="line-removed">-   k-&gt;check_valid_for_instantiation(false, CHECK_NULL);</span>
<span class="line-removed">-   k-&gt;initialize(CHECK_NULL);</span>
<span class="line-removed">-   instanceOop ih = InstanceKlass::cast(k)-&gt;allocate_instance(THREAD);</span>
<span class="line-removed">-   return ih;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  DT_RETURN_MARK_DECL(AllocObject, jobject
                      , HOTSPOT_JNI_ALLOCOBJECT_RETURN(_ret_ref));
  
  JNI_ENTRY(jobject, jni_AllocObject(JNIEnv *env, jclass clazz))
    JNIWrapper(&quot;AllocObject&quot;);
<span class="line-new-header">--- 1066,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1090,11 ***</span>
    HOTSPOT_JNI_ALLOCOBJECT_ENTRY(env, clazz);
  
    jobject ret = NULL;
    DT_RETURN_MARK(AllocObject, jobject, (const jobject&amp;)ret);
  
<span class="line-modified">!   instanceOop i = alloc_object(clazz, CHECK_NULL);</span>
    ret = JNIHandles::make_local(env, i);
    return ret;
  JNI_END
  
  DT_RETURN_MARK_DECL(NewObjectA, jobject
<span class="line-new-header">--- 1077,11 ---</span>
    HOTSPOT_JNI_ALLOCOBJECT_ENTRY(env, clazz);
  
    jobject ret = NULL;
    DT_RETURN_MARK(AllocObject, jobject, (const jobject&amp;)ret);
  
<span class="line-modified">!   instanceOop i = InstanceKlass::allocate_instance(JNIHandles::resolve_non_null(clazz), CHECK_NULL);</span>
    ret = JNIHandles::make_local(env, i);
    return ret;
  JNI_END
  
  DT_RETURN_MARK_DECL(NewObjectA, jobject
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1106,18 ***</span>
    HOTSPOT_JNI_NEWOBJECTA_ENTRY(env, clazz, (uintptr_t) methodID);
  
    jobject obj = NULL;
    DT_RETURN_MARK(NewObjectA, jobject, (const jobject)obj);
  
<span class="line-modified">!   Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz));</span>
    if (k == NULL) {
      ResourceMark rm(THREAD);
      THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
    }
  
    if (!k-&gt;is_value()) {
<span class="line-modified">!     instanceOop i = alloc_object(clazz, CHECK_NULL);</span>
      obj = JNIHandles::make_local(env, i);
      JavaValue jvalue(T_VOID);
      JNI_ArgumentPusherArray ap(methodID, args);
      jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
    } else {
<span class="line-new-header">--- 1093,19 ---</span>
    HOTSPOT_JNI_NEWOBJECTA_ENTRY(env, clazz, (uintptr_t) methodID);
  
    jobject obj = NULL;
    DT_RETURN_MARK(NewObjectA, jobject, (const jobject)obj);
  
<span class="line-modified">!   oop clazzoop = JNIHandles::resolve_non_null(clazz);</span>
<span class="line-added">+   Klass* k = java_lang_Class::as_Klass(clazzoop);</span>
    if (k == NULL) {
      ResourceMark rm(THREAD);
      THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
    }
  
    if (!k-&gt;is_value()) {
<span class="line-modified">!     instanceOop i = InstanceKlass::allocate_instance(clazzoop, CHECK_NULL);</span>
      obj = JNIHandles::make_local(env, i);
      JavaValue jvalue(T_VOID);
      JNI_ArgumentPusherArray ap(methodID, args);
      jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
    } else {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1139,18 ***</span>
    HOTSPOT_JNI_NEWOBJECTV_ENTRY(env, clazz, (uintptr_t) methodID);
  
    jobject obj = NULL;
    DT_RETURN_MARK(NewObjectV, jobject, (const jobject&amp;)obj);
  
<span class="line-modified">!   Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz));</span>
    if (k == NULL) {
      ResourceMark rm(THREAD);
      THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
    }
  
    if (!k-&gt;is_value()) {
<span class="line-modified">!     instanceOop i = alloc_object(clazz, CHECK_NULL);</span>
      obj = JNIHandles::make_local(env, i);
      JavaValue jvalue(T_VOID);
      JNI_ArgumentPusherVaArg ap(methodID, args);
      jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
    } else {
<span class="line-new-header">--- 1127,19 ---</span>
    HOTSPOT_JNI_NEWOBJECTV_ENTRY(env, clazz, (uintptr_t) methodID);
  
    jobject obj = NULL;
    DT_RETURN_MARK(NewObjectV, jobject, (const jobject&amp;)obj);
  
<span class="line-modified">!   oop clazzoop = JNIHandles::resolve_non_null(clazz);</span>
<span class="line-added">+   Klass* k = java_lang_Class::as_Klass(clazzoop);</span>
    if (k == NULL) {
      ResourceMark rm(THREAD);
      THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
    }
  
    if (!k-&gt;is_value()) {
<span class="line-modified">!     instanceOop i = InstanceKlass::allocate_instance(clazzoop, CHECK_NULL);</span>
      obj = JNIHandles::make_local(env, i);
      JavaValue jvalue(T_VOID);
      JNI_ArgumentPusherVaArg ap(methodID, args);
      jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
    } else {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1172,18 ***</span>
    HOTSPOT_JNI_NEWOBJECT_ENTRY(env, clazz, (uintptr_t) methodID);
  
    jobject obj = NULL;
    DT_RETURN_MARK(NewObject, jobject, (const jobject&amp;)obj);
  
<span class="line-modified">!   Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz));</span>
    if (k == NULL) {
      ResourceMark rm(THREAD);
      THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
    }
  
    if (!k-&gt;is_value()) {
<span class="line-modified">!     instanceOop i = alloc_object(clazz, CHECK_NULL);</span>
      obj = JNIHandles::make_local(env, i);
      va_list args;
      va_start(args, methodID);
      JavaValue jvalue(T_VOID);
      JNI_ArgumentPusherVaArg ap(methodID, args);
<span class="line-new-header">--- 1161,19 ---</span>
    HOTSPOT_JNI_NEWOBJECT_ENTRY(env, clazz, (uintptr_t) methodID);
  
    jobject obj = NULL;
    DT_RETURN_MARK(NewObject, jobject, (const jobject&amp;)obj);
  
<span class="line-modified">!   oop clazzoop = JNIHandles::resolve_non_null(clazz);</span>
<span class="line-added">+   Klass* k = java_lang_Class::as_Klass(clazzoop);</span>
    if (k == NULL) {
      ResourceMark rm(THREAD);
      THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
    }
  
    if (!k-&gt;is_value()) {
<span class="line-modified">!     instanceOop i = InstanceKlass::allocate_instance(clazzoop, CHECK_NULL);</span>
      obj = JNIHandles::make_local(env, i);
      va_list args;
      va_start(args, methodID);
      JavaValue jvalue(T_VOID);
      JNI_ArgumentPusherVaArg ap(methodID, args);
</pre>
<center><a href="../opto/subnode.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="unsafe.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>