<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/prims/jni.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../opto/subnode.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="unsafe.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/prims/jni.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  32 #include &quot;classfile/classLoader.hpp&quot;
  33 #include &quot;classfile/javaClasses.hpp&quot;
  34 #include &quot;classfile/javaClasses.inline.hpp&quot;
  35 #include &quot;classfile/moduleEntry.hpp&quot;
  36 #include &quot;classfile/modules.hpp&quot;
  37 #include &quot;classfile/symbolTable.hpp&quot;
  38 #include &quot;classfile/systemDictionary.hpp&quot;
  39 #include &quot;classfile/vmSymbols.hpp&quot;
  40 #include &quot;gc/shared/gcLocker.inline.hpp&quot;
  41 #include &quot;interpreter/linkResolver.hpp&quot;
  42 #include &quot;jfr/jfrEvents.hpp&quot;
  43 #include &quot;jfr/support/jfrThreadId.hpp&quot;
  44 #include &quot;logging/log.hpp&quot;
  45 #include &quot;memory/allocation.hpp&quot;
  46 #include &quot;memory/allocation.inline.hpp&quot;
  47 #include &quot;memory/oopFactory.hpp&quot;
  48 #include &quot;memory/resourceArea.hpp&quot;
  49 #include &quot;memory/universe.hpp&quot;
  50 #include &quot;oops/access.inline.hpp&quot;
  51 #include &quot;oops/arrayOop.inline.hpp&quot;
<span class="line-modified">  52 #include &quot;oops/instanceKlass.hpp&quot;</span>
  53 #include &quot;oops/instanceOop.hpp&quot;
  54 #include &quot;oops/markWord.hpp&quot;
  55 #include &quot;oops/method.hpp&quot;
  56 #include &quot;oops/objArrayKlass.hpp&quot;
  57 #include &quot;oops/objArrayOop.inline.hpp&quot;
  58 #include &quot;oops/oop.inline.hpp&quot;
  59 #include &quot;oops/symbol.hpp&quot;
  60 #include &quot;oops/typeArrayKlass.hpp&quot;
  61 #include &quot;oops/typeArrayOop.inline.hpp&quot;
  62 #include &quot;oops/valueArrayOop.inline.hpp&quot;
  63 #include &quot;oops/valueKlass.inline.hpp&quot;
  64 #include &quot;prims/jniCheck.hpp&quot;
  65 #include &quot;prims/jniExport.hpp&quot;
  66 #include &quot;prims/jniFastGetField.hpp&quot;
  67 #include &quot;prims/jvm_misc.hpp&quot;
  68 #include &quot;prims/jvmtiExport.hpp&quot;
  69 #include &quot;prims/jvmtiThreadState.hpp&quot;
  70 #include &quot;runtime/atomic.hpp&quot;
  71 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  72 #include &quot;runtime/handles.inline.hpp&quot;
</pre>
<hr />
<pre>
1051   JavaCallArguments java_args(number_of_parameters);
1052 
1053   // handle arguments
1054   assert(!method-&gt;is_static(), &quot;method %s should not be static&quot;, method-&gt;name_and_sig_as_C_string());
1055   java_args.push_oop(h_recv); // Push jobject handle
1056 
1057   // Fill out JavaCallArguments object
1058   args-&gt;push_arguments_on(&amp;java_args);
1059   // Initialize result type
1060   result-&gt;set_type(args-&gt;return_type());
1061 
1062   // Invoke the method. Result is returned as oop.
1063   JavaCalls::call(result, method, &amp;java_args, CHECK);
1064 
1065   // Convert result
1066   if (is_reference_type(result-&gt;get_type())) {
1067     result-&gt;set_jobject(JNIHandles::make_local(env, (oop) result-&gt;get_jobject()));
1068   }
1069 }
1070 
<span class="line-removed">1071 </span>
<span class="line-removed">1072 static instanceOop alloc_object(jclass clazz, TRAPS) {</span>
<span class="line-removed">1073   Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz));</span>
<span class="line-removed">1074   if (k == NULL) {</span>
<span class="line-removed">1075     ResourceMark rm(THREAD);</span>
<span class="line-removed">1076     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);</span>
<span class="line-removed">1077   }</span>
<span class="line-removed">1078   k-&gt;check_valid_for_instantiation(false, CHECK_NULL);</span>
<span class="line-removed">1079   k-&gt;initialize(CHECK_NULL);</span>
<span class="line-removed">1080   instanceOop ih = InstanceKlass::cast(k)-&gt;allocate_instance(THREAD);</span>
<span class="line-removed">1081   return ih;</span>
<span class="line-removed">1082 }</span>
<span class="line-removed">1083 </span>
1084 DT_RETURN_MARK_DECL(AllocObject, jobject
1085                     , HOTSPOT_JNI_ALLOCOBJECT_RETURN(_ret_ref));
1086 
1087 JNI_ENTRY(jobject, jni_AllocObject(JNIEnv *env, jclass clazz))
1088   JNIWrapper(&quot;AllocObject&quot;);
1089 
1090   HOTSPOT_JNI_ALLOCOBJECT_ENTRY(env, clazz);
1091 
1092   jobject ret = NULL;
1093   DT_RETURN_MARK(AllocObject, jobject, (const jobject&amp;)ret);
1094 
<span class="line-modified">1095   instanceOop i = alloc_object(clazz, CHECK_NULL);</span>
1096   ret = JNIHandles::make_local(env, i);
1097   return ret;
1098 JNI_END
1099 
1100 DT_RETURN_MARK_DECL(NewObjectA, jobject
1101                     , HOTSPOT_JNI_NEWOBJECTA_RETURN(_ret_ref));
1102 
1103 JNI_ENTRY(jobject, jni_NewObjectA(JNIEnv *env, jclass clazz, jmethodID methodID, const jvalue *args))
1104   JNIWrapper(&quot;NewObjectA&quot;);
1105 
1106   HOTSPOT_JNI_NEWOBJECTA_ENTRY(env, clazz, (uintptr_t) methodID);
1107 
1108   jobject obj = NULL;
1109   DT_RETURN_MARK(NewObjectA, jobject, (const jobject)obj);
1110 
<span class="line-modified">1111   Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz));</span>

1112   if (k == NULL) {
1113     ResourceMark rm(THREAD);
1114     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
1115   }
1116 
1117   if (!k-&gt;is_value()) {
<span class="line-modified">1118     instanceOop i = alloc_object(clazz, CHECK_NULL);</span>
1119     obj = JNIHandles::make_local(env, i);
1120     JavaValue jvalue(T_VOID);
1121     JNI_ArgumentPusherArray ap(methodID, args);
1122     jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
1123   } else {
1124     JavaValue jvalue(T_VALUETYPE);
1125     JNI_ArgumentPusherArray ap(methodID, args);
1126     jni_invoke_static(env, &amp;jvalue, NULL, JNI_STATIC, methodID, &amp;ap, CHECK_NULL);
1127     obj = jvalue.get_jobject();
1128   }
1129   return obj;
1130   JNI_END
1131 
1132 
1133 DT_RETURN_MARK_DECL(NewObjectV, jobject
1134                     , HOTSPOT_JNI_NEWOBJECTV_RETURN(_ret_ref));
1135 
1136 JNI_ENTRY(jobject, jni_NewObjectV(JNIEnv *env, jclass clazz, jmethodID methodID, va_list args))
1137   JNIWrapper(&quot;NewObjectV&quot;);
1138 
1139   HOTSPOT_JNI_NEWOBJECTV_ENTRY(env, clazz, (uintptr_t) methodID);
1140 
1141   jobject obj = NULL;
1142   DT_RETURN_MARK(NewObjectV, jobject, (const jobject&amp;)obj);
1143 
<span class="line-modified">1144   Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz));</span>

1145   if (k == NULL) {
1146     ResourceMark rm(THREAD);
1147     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
1148   }
1149 
1150   if (!k-&gt;is_value()) {
<span class="line-modified">1151     instanceOop i = alloc_object(clazz, CHECK_NULL);</span>
1152     obj = JNIHandles::make_local(env, i);
1153     JavaValue jvalue(T_VOID);
1154     JNI_ArgumentPusherVaArg ap(methodID, args);
1155     jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
1156   } else {
1157     JavaValue jvalue(T_VALUETYPE);
1158     JNI_ArgumentPusherVaArg ap(methodID, args);
1159     jni_invoke_static(env, &amp;jvalue, NULL, JNI_STATIC, methodID, &amp;ap, CHECK_NULL);
1160     obj = jvalue.get_jobject();
1161   }
1162   return obj;
1163 JNI_END
1164 
1165 
1166 DT_RETURN_MARK_DECL(NewObject, jobject
1167                     , HOTSPOT_JNI_NEWOBJECT_RETURN(_ret_ref));
1168 
1169 JNI_ENTRY(jobject, jni_NewObject(JNIEnv *env, jclass clazz, jmethodID methodID, ...))
1170   JNIWrapper(&quot;NewObject&quot;);
1171 
1172   HOTSPOT_JNI_NEWOBJECT_ENTRY(env, clazz, (uintptr_t) methodID);
1173 
1174   jobject obj = NULL;
1175   DT_RETURN_MARK(NewObject, jobject, (const jobject&amp;)obj);
1176 
<span class="line-modified">1177   Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz));</span>

1178   if (k == NULL) {
1179     ResourceMark rm(THREAD);
1180     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
1181   }
1182 
1183   if (!k-&gt;is_value()) {
<span class="line-modified">1184     instanceOop i = alloc_object(clazz, CHECK_NULL);</span>
1185     obj = JNIHandles::make_local(env, i);
1186     va_list args;
1187     va_start(args, methodID);
1188     JavaValue jvalue(T_VOID);
1189     JNI_ArgumentPusherVaArg ap(methodID, args);
1190     jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
1191     va_end(args);
1192   } else {
1193     va_list args;
1194     va_start(args, methodID);
1195     JavaValue jvalue(T_VALUETYPE);
1196     JNI_ArgumentPusherVaArg ap(methodID, args);
1197     jni_invoke_static(env, &amp;jvalue, NULL, JNI_STATIC, methodID, &amp;ap, CHECK_NULL);
1198     va_end(args);
1199     obj = jvalue.get_jobject();
1200   }
1201   return obj;
1202 JNI_END
1203 
1204 
</pre>
</td>
<td>
<hr />
<pre>
  32 #include &quot;classfile/classLoader.hpp&quot;
  33 #include &quot;classfile/javaClasses.hpp&quot;
  34 #include &quot;classfile/javaClasses.inline.hpp&quot;
  35 #include &quot;classfile/moduleEntry.hpp&quot;
  36 #include &quot;classfile/modules.hpp&quot;
  37 #include &quot;classfile/symbolTable.hpp&quot;
  38 #include &quot;classfile/systemDictionary.hpp&quot;
  39 #include &quot;classfile/vmSymbols.hpp&quot;
  40 #include &quot;gc/shared/gcLocker.inline.hpp&quot;
  41 #include &quot;interpreter/linkResolver.hpp&quot;
  42 #include &quot;jfr/jfrEvents.hpp&quot;
  43 #include &quot;jfr/support/jfrThreadId.hpp&quot;
  44 #include &quot;logging/log.hpp&quot;
  45 #include &quot;memory/allocation.hpp&quot;
  46 #include &quot;memory/allocation.inline.hpp&quot;
  47 #include &quot;memory/oopFactory.hpp&quot;
  48 #include &quot;memory/resourceArea.hpp&quot;
  49 #include &quot;memory/universe.hpp&quot;
  50 #include &quot;oops/access.inline.hpp&quot;
  51 #include &quot;oops/arrayOop.inline.hpp&quot;
<span class="line-modified">  52 #include &quot;oops/instanceKlass.inline.hpp&quot;</span>
  53 #include &quot;oops/instanceOop.hpp&quot;
  54 #include &quot;oops/markWord.hpp&quot;
  55 #include &quot;oops/method.hpp&quot;
  56 #include &quot;oops/objArrayKlass.hpp&quot;
  57 #include &quot;oops/objArrayOop.inline.hpp&quot;
  58 #include &quot;oops/oop.inline.hpp&quot;
  59 #include &quot;oops/symbol.hpp&quot;
  60 #include &quot;oops/typeArrayKlass.hpp&quot;
  61 #include &quot;oops/typeArrayOop.inline.hpp&quot;
  62 #include &quot;oops/valueArrayOop.inline.hpp&quot;
  63 #include &quot;oops/valueKlass.inline.hpp&quot;
  64 #include &quot;prims/jniCheck.hpp&quot;
  65 #include &quot;prims/jniExport.hpp&quot;
  66 #include &quot;prims/jniFastGetField.hpp&quot;
  67 #include &quot;prims/jvm_misc.hpp&quot;
  68 #include &quot;prims/jvmtiExport.hpp&quot;
  69 #include &quot;prims/jvmtiThreadState.hpp&quot;
  70 #include &quot;runtime/atomic.hpp&quot;
  71 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  72 #include &quot;runtime/handles.inline.hpp&quot;
</pre>
<hr />
<pre>
1051   JavaCallArguments java_args(number_of_parameters);
1052 
1053   // handle arguments
1054   assert(!method-&gt;is_static(), &quot;method %s should not be static&quot;, method-&gt;name_and_sig_as_C_string());
1055   java_args.push_oop(h_recv); // Push jobject handle
1056 
1057   // Fill out JavaCallArguments object
1058   args-&gt;push_arguments_on(&amp;java_args);
1059   // Initialize result type
1060   result-&gt;set_type(args-&gt;return_type());
1061 
1062   // Invoke the method. Result is returned as oop.
1063   JavaCalls::call(result, method, &amp;java_args, CHECK);
1064 
1065   // Convert result
1066   if (is_reference_type(result-&gt;get_type())) {
1067     result-&gt;set_jobject(JNIHandles::make_local(env, (oop) result-&gt;get_jobject()));
1068   }
1069 }
1070 













1071 DT_RETURN_MARK_DECL(AllocObject, jobject
1072                     , HOTSPOT_JNI_ALLOCOBJECT_RETURN(_ret_ref));
1073 
1074 JNI_ENTRY(jobject, jni_AllocObject(JNIEnv *env, jclass clazz))
1075   JNIWrapper(&quot;AllocObject&quot;);
1076 
1077   HOTSPOT_JNI_ALLOCOBJECT_ENTRY(env, clazz);
1078 
1079   jobject ret = NULL;
1080   DT_RETURN_MARK(AllocObject, jobject, (const jobject&amp;)ret);
1081 
<span class="line-modified">1082   instanceOop i = InstanceKlass::allocate_instance(JNIHandles::resolve_non_null(clazz), CHECK_NULL);</span>
1083   ret = JNIHandles::make_local(env, i);
1084   return ret;
1085 JNI_END
1086 
1087 DT_RETURN_MARK_DECL(NewObjectA, jobject
1088                     , HOTSPOT_JNI_NEWOBJECTA_RETURN(_ret_ref));
1089 
1090 JNI_ENTRY(jobject, jni_NewObjectA(JNIEnv *env, jclass clazz, jmethodID methodID, const jvalue *args))
1091   JNIWrapper(&quot;NewObjectA&quot;);
1092 
1093   HOTSPOT_JNI_NEWOBJECTA_ENTRY(env, clazz, (uintptr_t) methodID);
1094 
1095   jobject obj = NULL;
1096   DT_RETURN_MARK(NewObjectA, jobject, (const jobject)obj);
1097 
<span class="line-modified">1098   oop clazzoop = JNIHandles::resolve_non_null(clazz);</span>
<span class="line-added">1099   Klass* k = java_lang_Class::as_Klass(clazzoop);</span>
1100   if (k == NULL) {
1101     ResourceMark rm(THREAD);
1102     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
1103   }
1104 
1105   if (!k-&gt;is_value()) {
<span class="line-modified">1106     instanceOop i = InstanceKlass::allocate_instance(clazzoop, CHECK_NULL);</span>
1107     obj = JNIHandles::make_local(env, i);
1108     JavaValue jvalue(T_VOID);
1109     JNI_ArgumentPusherArray ap(methodID, args);
1110     jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
1111   } else {
1112     JavaValue jvalue(T_VALUETYPE);
1113     JNI_ArgumentPusherArray ap(methodID, args);
1114     jni_invoke_static(env, &amp;jvalue, NULL, JNI_STATIC, methodID, &amp;ap, CHECK_NULL);
1115     obj = jvalue.get_jobject();
1116   }
1117   return obj;
1118   JNI_END
1119 
1120 
1121 DT_RETURN_MARK_DECL(NewObjectV, jobject
1122                     , HOTSPOT_JNI_NEWOBJECTV_RETURN(_ret_ref));
1123 
1124 JNI_ENTRY(jobject, jni_NewObjectV(JNIEnv *env, jclass clazz, jmethodID methodID, va_list args))
1125   JNIWrapper(&quot;NewObjectV&quot;);
1126 
1127   HOTSPOT_JNI_NEWOBJECTV_ENTRY(env, clazz, (uintptr_t) methodID);
1128 
1129   jobject obj = NULL;
1130   DT_RETURN_MARK(NewObjectV, jobject, (const jobject&amp;)obj);
1131 
<span class="line-modified">1132   oop clazzoop = JNIHandles::resolve_non_null(clazz);</span>
<span class="line-added">1133   Klass* k = java_lang_Class::as_Klass(clazzoop);</span>
1134   if (k == NULL) {
1135     ResourceMark rm(THREAD);
1136     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
1137   }
1138 
1139   if (!k-&gt;is_value()) {
<span class="line-modified">1140     instanceOop i = InstanceKlass::allocate_instance(clazzoop, CHECK_NULL);</span>
1141     obj = JNIHandles::make_local(env, i);
1142     JavaValue jvalue(T_VOID);
1143     JNI_ArgumentPusherVaArg ap(methodID, args);
1144     jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
1145   } else {
1146     JavaValue jvalue(T_VALUETYPE);
1147     JNI_ArgumentPusherVaArg ap(methodID, args);
1148     jni_invoke_static(env, &amp;jvalue, NULL, JNI_STATIC, methodID, &amp;ap, CHECK_NULL);
1149     obj = jvalue.get_jobject();
1150   }
1151   return obj;
1152 JNI_END
1153 
1154 
1155 DT_RETURN_MARK_DECL(NewObject, jobject
1156                     , HOTSPOT_JNI_NEWOBJECT_RETURN(_ret_ref));
1157 
1158 JNI_ENTRY(jobject, jni_NewObject(JNIEnv *env, jclass clazz, jmethodID methodID, ...))
1159   JNIWrapper(&quot;NewObject&quot;);
1160 
1161   HOTSPOT_JNI_NEWOBJECT_ENTRY(env, clazz, (uintptr_t) methodID);
1162 
1163   jobject obj = NULL;
1164   DT_RETURN_MARK(NewObject, jobject, (const jobject&amp;)obj);
1165 
<span class="line-modified">1166   oop clazzoop = JNIHandles::resolve_non_null(clazz);</span>
<span class="line-added">1167   Klass* k = java_lang_Class::as_Klass(clazzoop);</span>
1168   if (k == NULL) {
1169     ResourceMark rm(THREAD);
1170     THROW_(vmSymbols::java_lang_InstantiationException(), NULL);
1171   }
1172 
1173   if (!k-&gt;is_value()) {
<span class="line-modified">1174     instanceOop i = InstanceKlass::allocate_instance(clazzoop, CHECK_NULL);</span>
1175     obj = JNIHandles::make_local(env, i);
1176     va_list args;
1177     va_start(args, methodID);
1178     JavaValue jvalue(T_VOID);
1179     JNI_ArgumentPusherVaArg ap(methodID, args);
1180     jni_invoke_nonstatic(env, &amp;jvalue, obj, JNI_NONVIRTUAL, methodID, &amp;ap, CHECK_NULL);
1181     va_end(args);
1182   } else {
1183     va_list args;
1184     va_start(args, methodID);
1185     JavaValue jvalue(T_VALUETYPE);
1186     JNI_ArgumentPusherVaArg ap(methodID, args);
1187     jni_invoke_static(env, &amp;jvalue, NULL, JNI_STATIC, methodID, &amp;ap, CHECK_NULL);
1188     va_end(args);
1189     obj = jvalue.get_jobject();
1190   }
1191   return obj;
1192 JNI_END
1193 
1194 
</pre>
</td>
</tr>
</table>
<center><a href="../opto/subnode.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="unsafe.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>