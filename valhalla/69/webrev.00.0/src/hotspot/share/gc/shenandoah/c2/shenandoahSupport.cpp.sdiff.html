<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/gc/shenandoah/c2/shenandoahSupport.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahBarrierSetC2.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../jvmci/jvmciCodeInstaller.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/c2/shenandoahSupport.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  51     PhaseIdealLoop ideal_loop(igvn, LoopOptsShenandoahExpand);
  52     if (C-&gt;failing()) return false;
  53     PhaseIdealLoop::verify(igvn);
  54     DEBUG_ONLY(verify_raw_mem(C-&gt;root());)
  55     if (attempt_more_loopopts) {
  56       C-&gt;set_major_progress();
  57       if (!C-&gt;optimize_loops(igvn, LoopOptsShenandoahPostExpand)) {
  58         return false;
  59       }
  60       C-&gt;clear_major_progress();
  61       if (C-&gt;range_check_cast_count() &gt; 0) {
  62         // No more loop optimizations. Remove all range check dependent CastIINodes.
  63         C-&gt;remove_range_check_casts(igvn);
  64         igvn.optimize();
  65       }
  66     }
  67   }
  68   return true;
  69 }
  70 
<span class="line-modified">  71 bool ShenandoahBarrierC2Support::is_heap_state_test(Node* iff, int mask) {</span>
  72   if (!UseShenandoahGC) {
  73     return false;
  74   }
  75   assert(iff-&gt;is_If(), &quot;bad input&quot;);
  76   if (iff-&gt;Opcode() != Op_If) {
  77     return false;
  78   }
  79   Node* bol = iff-&gt;in(1);
  80   if (!bol-&gt;is_Bool() || bol-&gt;as_Bool()-&gt;_test._test != BoolTest::ne) {
  81     return false;
  82   }
  83   Node* cmp = bol-&gt;in(1);
  84   if (cmp-&gt;Opcode() != Op_CmpI) {
  85     return false;
  86   }
  87   Node* in1 = cmp-&gt;in(1);
  88   Node* in2 = cmp-&gt;in(2);
  89   if (in2-&gt;find_int_con(-1) != 0) {
  90     return false;
  91   }
  92   if (in1-&gt;Opcode() != Op_AndI) {
  93     return false;
  94   }
  95   in2 = in1-&gt;in(2);
  96   if (in2-&gt;find_int_con(-1) != mask) {
  97     return false;
  98   }
  99   in1 = in1-&gt;in(1);
 100 
 101   return is_gc_state_load(in1);
 102 }
 103 
 104 bool ShenandoahBarrierC2Support::is_heap_stable_test(Node* iff) {
<span class="line-modified"> 105   return is_heap_state_test(iff, ShenandoahHeap::HAS_FORWARDED);</span>
 106 }
 107 
 108 bool ShenandoahBarrierC2Support::is_gc_state_load(Node *n) {
 109   if (!UseShenandoahGC) {
 110     return false;
 111   }
 112   if (n-&gt;Opcode() != Op_LoadB &amp;&amp; n-&gt;Opcode() != Op_LoadUB) {
 113     return false;
 114   }
 115   Node* addp = n-&gt;in(MemNode::Address);
 116   if (!addp-&gt;is_AddP()) {
 117     return false;
 118   }
 119   Node* base = addp-&gt;in(AddPNode::Address);
 120   Node* off = addp-&gt;in(AddPNode::Offset);
 121   if (base-&gt;Opcode() != Op_ThreadLocal) {
 122     return false;
 123   }
 124   if (off-&gt;find_intptr_t_con(-1) != in_bytes(ShenandoahThreadLocalData::gc_state_offset())) {
 125     return false;
</pre>
<hr />
<pre>
 842 void ShenandoahBarrierC2Support::follow_barrier_uses(Node* n, Node* ctrl, Unique_Node_List&amp; uses, PhaseIdealLoop* phase) {
 843   for (DUIterator_Fast imax, i = n-&gt;fast_outs(imax); i &lt; imax; i++) {
 844     Node* u = n-&gt;fast_out(i);
 845     if (!u-&gt;is_CFG() &amp;&amp; phase-&gt;get_ctrl(u) == ctrl &amp;&amp; (!u-&gt;is_Phi() || !u-&gt;in(0)-&gt;is_Loop() || u-&gt;in(LoopNode::LoopBackControl) != n)) {
 846       uses.push(u);
 847     }
 848   }
 849 }
 850 
 851 static void hide_strip_mined_loop(OuterStripMinedLoopNode* outer, CountedLoopNode* inner, PhaseIdealLoop* phase) {
 852   OuterStripMinedLoopEndNode* le = inner-&gt;outer_loop_end();
 853   Node* new_outer = new LoopNode(outer-&gt;in(LoopNode::EntryControl), outer-&gt;in(LoopNode::LoopBackControl));
 854   phase-&gt;register_control(new_outer, phase-&gt;get_loop(outer), outer-&gt;in(LoopNode::EntryControl));
 855   Node* new_le = new IfNode(le-&gt;in(0), le-&gt;in(1), le-&gt;_prob, le-&gt;_fcnt);
 856   phase-&gt;register_control(new_le, phase-&gt;get_loop(le), le-&gt;in(0));
 857   phase-&gt;lazy_replace(outer, new_outer);
 858   phase-&gt;lazy_replace(le, new_le);
 859   inner-&gt;clear_strip_mined();
 860 }
 861 
<span class="line-modified"> 862 void ShenandoahBarrierC2Support::test_heap_state(Node*&amp; ctrl, Node* raw_mem, Node*&amp; heap_stable_ctrl,</span>
<span class="line-modified"> 863                                                  PhaseIdealLoop* phase, int flags) {</span>
<span class="line-modified"> 864   IdealLoopTree* loop = phase-&gt;get_loop(ctrl);</span>
<span class="line-modified"> 865   Node* thread = new ThreadLocalNode();</span>
<span class="line-modified"> 866   phase-&gt;register_new_node(thread, ctrl);</span>
<span class="line-modified"> 867   Node* offset = phase-&gt;igvn().MakeConX(in_bytes(ShenandoahThreadLocalData::gc_state_offset()));</span>
<span class="line-modified"> 868   phase-&gt;set_ctrl(offset, phase-&gt;C-&gt;root());</span>
<span class="line-modified"> 869   Node* gc_state_addr = new AddPNode(phase-&gt;C-&gt;top(), thread, offset);</span>
<span class="line-modified"> 870   phase-&gt;register_new_node(gc_state_addr, ctrl);</span>
<span class="line-modified"> 871   uint gc_state_idx = Compile::AliasIdxRaw;</span>
<span class="line-modified"> 872   const TypePtr* gc_state_adr_type = NULL; // debug-mode-only argument</span>
<span class="line-modified"> 873   debug_only(gc_state_adr_type = phase-&gt;C-&gt;get_adr_type(gc_state_idx));</span>
<span class="line-modified"> 874 </span>
<span class="line-modified"> 875   Node* gc_state = new LoadBNode(ctrl, raw_mem, gc_state_addr, gc_state_adr_type, TypeInt::BYTE, MemNode::unordered);</span>
<span class="line-modified"> 876   phase-&gt;register_new_node(gc_state, ctrl);</span>
<span class="line-modified"> 877   Node* heap_stable_and = new AndINode(gc_state, phase-&gt;igvn().intcon(flags));</span>
<span class="line-modified"> 878   phase-&gt;register_new_node(heap_stable_and, ctrl);</span>
<span class="line-modified"> 879   Node* heap_stable_cmp = new CmpINode(heap_stable_and, phase-&gt;igvn().zerocon(T_INT));</span>
<span class="line-modified"> 880   phase-&gt;register_new_node(heap_stable_cmp, ctrl);</span>
<span class="line-modified"> 881   Node* heap_stable_test = new BoolNode(heap_stable_cmp, BoolTest::ne);</span>
<span class="line-modified"> 882   phase-&gt;register_new_node(heap_stable_test, ctrl);</span>
<span class="line-modified"> 883   IfNode* heap_stable_iff = new IfNode(ctrl, heap_stable_test, PROB_UNLIKELY(0.999), COUNT_UNKNOWN);</span>
<span class="line-modified"> 884   phase-&gt;register_control(heap_stable_iff, loop, ctrl);</span>
<span class="line-modified"> 885 </span>
<span class="line-modified"> 886   heap_stable_ctrl = new IfFalseNode(heap_stable_iff);</span>
<span class="line-modified"> 887   phase-&gt;register_control(heap_stable_ctrl, loop, heap_stable_iff);</span>
<span class="line-modified"> 888   ctrl = new IfTrueNode(heap_stable_iff);</span>
<span class="line-modified"> 889   phase-&gt;register_control(ctrl, loop, heap_stable_iff);</span>
<span class="line-modified"> 890 </span>
<span class="line-modified"> 891   assert(is_heap_state_test(heap_stable_iff, flags), &quot;Should match the shape&quot;);</span>




 892 }
 893 
 894 void ShenandoahBarrierC2Support::test_null(Node*&amp; ctrl, Node* val, Node*&amp; null_ctrl, PhaseIdealLoop* phase) {
<span class="line-modified"> 895   const Type* val_t = phase-&gt;igvn().type(val);</span>



 896   if (val_t-&gt;meet(TypePtr::NULL_PTR) == val_t) {
<span class="line-modified"> 897     IdealLoopTree* loop = phase-&gt;get_loop(ctrl);</span>
<span class="line-modified"> 898     Node* null_cmp = new CmpPNode(val, phase-&gt;igvn().zerocon(T_OBJECT));</span>
<span class="line-modified"> 899     phase-&gt;register_new_node(null_cmp, ctrl);</span>
<span class="line-modified"> 900     Node* null_test = new BoolNode(null_cmp, BoolTest::ne);</span>
<span class="line-modified"> 901     phase-&gt;register_new_node(null_test, ctrl);</span>
<span class="line-modified"> 902     IfNode* null_iff = new IfNode(ctrl, null_test, PROB_LIKELY(0.999), COUNT_UNKNOWN);</span>
<span class="line-modified"> 903     phase-&gt;register_control(null_iff, loop, ctrl);</span>
<span class="line-modified"> 904     ctrl = new IfTrueNode(null_iff);</span>
<span class="line-modified"> 905     phase-&gt;register_control(ctrl, loop, null_iff);</span>
<span class="line-modified"> 906     null_ctrl = new IfFalseNode(null_iff);</span>
 907     phase-&gt;register_control(null_ctrl, loop, null_iff);



 908   }
 909 }
 910 
 911 Node* ShenandoahBarrierC2Support::clone_null_check(Node*&amp; c, Node* val, Node* unc_ctrl, PhaseIdealLoop* phase) {
 912   IdealLoopTree *loop = phase-&gt;get_loop(c);
 913   Node* iff = unc_ctrl-&gt;in(0);
 914   assert(iff-&gt;is_If(), &quot;broken&quot;);
 915   Node* new_iff = iff-&gt;clone();
 916   new_iff-&gt;set_req(0, c);
 917   phase-&gt;register_control(new_iff, loop, c);
 918   Node* iffalse = new IfFalseNode(new_iff-&gt;as_If());
 919   phase-&gt;register_control(iffalse, loop, new_iff);
 920   Node* iftrue = new IfTrueNode(new_iff-&gt;as_If());
 921   phase-&gt;register_control(iftrue, loop, new_iff);
 922   c = iftrue;
 923   const Type *t = phase-&gt;igvn().type(val);
 924   assert(val-&gt;Opcode() == Op_CastPP, &quot;expect cast to non null here&quot;);
 925   Node* uncasted_val = val-&gt;in(1);
 926   val = new CastPPNode(uncasted_val, t);
 927   val-&gt;init_req(0, c);
</pre>
<hr />
<pre>
 961   for(uint next = 0; next &lt; uses.size(); next++ ) {
 962     Node *n = uses.at(next);
 963     assert(phase-&gt;get_ctrl(n) == proj, &quot;bad control&quot;);
 964     phase-&gt;set_ctrl_and_loop(n, new_unc_ctrl);
 965     if (n-&gt;in(0) == proj) {
 966       phase-&gt;igvn().replace_input_of(n, 0, new_unc_ctrl);
 967     }
 968     for (uint i = 0; i &lt; n-&gt;req(); i++) {
 969       Node* m = n-&gt;in(i);
 970       if (m != NULL &amp;&amp; phase-&gt;has_ctrl(m) &amp;&amp; phase-&gt;get_ctrl(m) == proj) {
 971         uses.push(m);
 972       }
 973     }
 974   }
 975 
 976   phase-&gt;igvn().rehash_node_delayed(use);
 977   int nb = use-&gt;replace_edge(proj, new_unc_ctrl);
 978   assert(nb == 1, &quot;only use expected&quot;);
 979 }
 980 
<span class="line-modified"> 981 void ShenandoahBarrierC2Support::in_cset_fast_test(Node*&amp; ctrl, Node*&amp; not_cset_ctrl, Node* val, Node* raw_mem, PhaseIdealLoop* phase) {</span>
<span class="line-modified"> 982   IdealLoopTree *loop = phase-&gt;get_loop(ctrl);</span>
<span class="line-modified"> 983   Node* raw_rbtrue = new CastP2XNode(ctrl, val);</span>
<span class="line-modified"> 984   phase-&gt;register_new_node(raw_rbtrue, ctrl);</span>
<span class="line-modified"> 985   Node* cset_offset = new URShiftXNode(raw_rbtrue, phase-&gt;igvn().intcon(ShenandoahHeapRegion::region_size_bytes_shift_jint()));</span>
<span class="line-modified"> 986   phase-&gt;register_new_node(cset_offset, ctrl);</span>
<span class="line-modified"> 987   Node* in_cset_fast_test_base_addr = phase-&gt;igvn().makecon(TypeRawPtr::make(ShenandoahHeap::in_cset_fast_test_addr()));</span>
<span class="line-modified"> 988   phase-&gt;set_ctrl(in_cset_fast_test_base_addr, phase-&gt;C-&gt;root());</span>
<span class="line-modified"> 989   Node* in_cset_fast_test_adr = new AddPNode(phase-&gt;C-&gt;top(), in_cset_fast_test_base_addr, cset_offset);</span>
<span class="line-modified"> 990   phase-&gt;register_new_node(in_cset_fast_test_adr, ctrl);</span>
<span class="line-modified"> 991   uint in_cset_fast_test_idx = Compile::AliasIdxRaw;</span>
<span class="line-modified"> 992   const TypePtr* in_cset_fast_test_adr_type = NULL; // debug-mode-only argument</span>
<span class="line-modified"> 993   debug_only(in_cset_fast_test_adr_type = phase-&gt;C-&gt;get_adr_type(in_cset_fast_test_idx));</span>
<span class="line-modified"> 994   Node* in_cset_fast_test_load = new LoadBNode(ctrl, raw_mem, in_cset_fast_test_adr, in_cset_fast_test_adr_type, TypeInt::BYTE, MemNode::unordered);</span>
<span class="line-modified"> 995   phase-&gt;register_new_node(in_cset_fast_test_load, ctrl);</span>
<span class="line-modified"> 996   Node* in_cset_fast_test_cmp = new CmpINode(in_cset_fast_test_load, phase-&gt;igvn().zerocon(T_INT));</span>
<span class="line-modified"> 997   phase-&gt;register_new_node(in_cset_fast_test_cmp, ctrl);</span>
<span class="line-modified"> 998   Node* in_cset_fast_test_test = new BoolNode(in_cset_fast_test_cmp, BoolTest::eq);</span>
<span class="line-modified"> 999   phase-&gt;register_new_node(in_cset_fast_test_test, ctrl);</span>
<span class="line-modified">1000   IfNode* in_cset_fast_test_iff = new IfNode(ctrl, in_cset_fast_test_test, PROB_UNLIKELY(0.999), COUNT_UNKNOWN);</span>
<span class="line-modified">1001   phase-&gt;register_control(in_cset_fast_test_iff, loop, ctrl);</span>
<span class="line-modified">1002 </span>
<span class="line-modified">1003   not_cset_ctrl = new IfTrueNode(in_cset_fast_test_iff);</span>
<span class="line-modified">1004   phase-&gt;register_control(not_cset_ctrl, loop, in_cset_fast_test_iff);</span>
<span class="line-modified">1005 </span>
<span class="line-modified">1006   ctrl = new IfFalseNode(in_cset_fast_test_iff);</span>
<span class="line-modified">1007   phase-&gt;register_control(ctrl, loop, in_cset_fast_test_iff);</span>




1008 }
1009 
1010 void ShenandoahBarrierC2Support::call_lrb_stub(Node*&amp; ctrl, Node*&amp; val, Node* load_addr, Node*&amp; result_mem, Node* raw_mem, bool is_native, PhaseIdealLoop* phase) {
1011   IdealLoopTree*loop = phase-&gt;get_loop(ctrl);
1012   const TypePtr* obj_type = phase-&gt;igvn().type(val)-&gt;is_oopptr();
1013 
1014   // The slow path stub consumes and produces raw memory in addition
1015   // to the existing memory edges
1016   Node* base = find_bottom_mem(ctrl, phase);
1017   MergeMemNode* mm = MergeMemNode::make(base);
1018   mm-&gt;set_memory_at(Compile::AliasIdxRaw, raw_mem);
1019   phase-&gt;register_new_node(mm, ctrl);
1020 
1021   address target = LP64_ONLY(UseCompressedOops) NOT_LP64(false) ?
1022           CAST_FROM_FN_PTR(address, ShenandoahRuntime::load_reference_barrier_narrow) :
1023           CAST_FROM_FN_PTR(address, ShenandoahRuntime::load_reference_barrier);
1024 
1025   address calladdr = is_native ? CAST_FROM_FN_PTR(address, ShenandoahRuntime::load_reference_barrier_native)
1026                                : target;
1027   const char* name = is_native ? &quot;load_reference_barrier_native&quot; : &quot;load_reference_barrier&quot;;
</pre>
<hr />
<pre>
1417       }
1418     }
1419 
1420     Node* uncasted_val = val;
1421     if (unc != NULL) {
1422       uncasted_val = val-&gt;in(1);
1423     }
1424 
1425     Node* heap_stable_ctrl = NULL;
1426     Node* null_ctrl = NULL;
1427 
1428     assert(val-&gt;bottom_type()-&gt;make_oopptr(), &quot;need oop&quot;);
1429     assert(val-&gt;bottom_type()-&gt;make_oopptr()-&gt;const_oop() == NULL, &quot;expect non-constant&quot;);
1430 
1431     enum { _heap_stable = 1, _not_cset, _evac_path, _null_path, PATH_LIMIT };
1432     Node* region = new RegionNode(PATH_LIMIT);
1433     Node* val_phi = new PhiNode(region, uncasted_val-&gt;bottom_type()-&gt;is_oopptr());
1434     Node* raw_mem_phi = PhiNode::make(region, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
1435 
1436     // Stable path.
<span class="line-modified">1437     test_heap_state(ctrl, raw_mem, heap_stable_ctrl, phase, ShenandoahHeap::HAS_FORWARDED);</span>
1438     IfNode* heap_stable_iff = heap_stable_ctrl-&gt;in(0)-&gt;as_If();
1439 
1440     // Heap stable case
1441     region-&gt;init_req(_heap_stable, heap_stable_ctrl);
1442     val_phi-&gt;init_req(_heap_stable, uncasted_val);
1443     raw_mem_phi-&gt;init_req(_heap_stable, raw_mem);
1444 
1445     Node* reg2_ctrl = NULL;
1446     // Null case
1447     test_null(ctrl, val, null_ctrl, phase);
1448     if (null_ctrl != NULL) {
1449       reg2_ctrl = null_ctrl-&gt;in(0);
1450       region-&gt;init_req(_null_path, null_ctrl);
1451       val_phi-&gt;init_req(_null_path, uncasted_val);
1452       raw_mem_phi-&gt;init_req(_null_path, raw_mem);
1453     } else {
1454       region-&gt;del_req(_null_path);
1455       val_phi-&gt;del_req(_null_path);
1456       raw_mem_phi-&gt;del_req(_null_path);
1457     }
1458 
1459     // Test for in-cset.
1460     // Wires !in_cset(obj) to slot 2 of region and phis
1461     Node* not_cset_ctrl = NULL;
<span class="line-modified">1462     in_cset_fast_test(ctrl, not_cset_ctrl, uncasted_val, raw_mem, phase);</span>
1463     if (not_cset_ctrl != NULL) {
1464       if (reg2_ctrl == NULL) reg2_ctrl = not_cset_ctrl-&gt;in(0);
1465       region-&gt;init_req(_not_cset, not_cset_ctrl);
1466       val_phi-&gt;init_req(_not_cset, uncasted_val);
1467       raw_mem_phi-&gt;init_req(_not_cset, raw_mem);
1468     }
1469 
1470     // Resolve object when orig-value is in cset.
1471     // Make the unconditional resolve for fwdptr.
1472     Node* new_val = uncasted_val;
1473     if (unc_ctrl != NULL) {
1474       // Clone the null check in this branch to allow implicit null check
1475       new_val = clone_null_check(ctrl, val, unc_ctrl, phase);
1476       fix_null_check(unc, unc_ctrl, ctrl-&gt;in(0)-&gt;as_If()-&gt;proj_out(0), uses, phase);
1477 
1478       IfNode* iff = unc_ctrl-&gt;in(0)-&gt;as_If();
1479       phase-&gt;igvn().replace_input_of(iff, 1, phase-&gt;igvn().intcon(1));
1480     }
1481 
1482     // Call lrb-stub and wire up that path in slots 4
</pre>
<hr />
<pre>
1588     }
1589 
1590     Node* init_ctrl = ctrl;
1591     IdealLoopTree* loop = phase-&gt;get_loop(ctrl);
1592     Node* raw_mem = fixer.find_mem(ctrl, barrier);
1593     Node* init_raw_mem = raw_mem;
1594     Node* raw_mem_for_ctrl = fixer.find_mem(ctrl, NULL);
1595     Node* heap_stable_ctrl = NULL;
1596     Node* null_ctrl = NULL;
1597     uint last = phase-&gt;C-&gt;unique();
1598 
1599     enum { _heap_stable = 1, _heap_unstable, PATH_LIMIT };
1600     Node* region = new RegionNode(PATH_LIMIT);
1601     Node* phi = PhiNode::make(region, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
1602 
1603     enum { _fast_path = 1, _slow_path, _null_path, PATH_LIMIT2 };
1604     Node* region2 = new RegionNode(PATH_LIMIT2);
1605     Node* phi2 = PhiNode::make(region2, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
1606 
1607     // Stable path.
<span class="line-modified">1608     test_heap_state(ctrl, raw_mem, heap_stable_ctrl, phase, ShenandoahHeap::MARKING);</span>
1609     region-&gt;init_req(_heap_stable, heap_stable_ctrl);
1610     phi-&gt;init_req(_heap_stable, raw_mem);
1611 
1612     // Null path
1613     Node* reg2_ctrl = NULL;
1614     test_null(ctrl, pre_val, null_ctrl, phase);
1615     if (null_ctrl != NULL) {
1616       reg2_ctrl = null_ctrl-&gt;in(0);
1617       region2-&gt;init_req(_null_path, null_ctrl);
1618       phi2-&gt;init_req(_null_path, raw_mem);
1619     } else {
1620       region2-&gt;del_req(_null_path);
1621       phi2-&gt;del_req(_null_path);
1622     }
1623 
1624     const int index_offset = in_bytes(ShenandoahThreadLocalData::satb_mark_queue_index_offset());
1625     const int buffer_offset = in_bytes(ShenandoahThreadLocalData::satb_mark_queue_buffer_offset());
1626     Node* thread = new ThreadLocalNode();
1627     phase-&gt;register_new_node(thread, ctrl);
1628     Node* buffer_adr = new AddPNode(phase-&gt;C-&gt;top(), thread, phase-&gt;igvn().MakeConX(buffer_offset));
</pre>
<hr />
<pre>
1770       return get_load_addr(phase, visited, in-&gt;in(ShenandoahLoadReferenceBarrierNode::ValueIn));
1771     case Op_ShenandoahEnqueueBarrier:
1772       return get_load_addr(phase, visited, in-&gt;in(1));
1773     case Op_CallDynamicJava:
1774     case Op_CallLeaf:
1775     case Op_CallStaticJava:
1776     case Op_ConN:
1777     case Op_ConP:
1778     case Op_Parm:
1779     case Op_CreateEx:
1780       return phase-&gt;igvn().zerocon(T_OBJECT);
1781     default:
1782 #ifdef ASSERT
1783       fatal(&quot;Unknown node in get_load_addr: %s&quot;, NodeClassNames[in-&gt;Opcode()]);
1784 #endif
1785       return phase-&gt;igvn().zerocon(T_OBJECT);
1786   }
1787 
1788 }
1789 
<span class="line-modified">1790 void ShenandoahBarrierC2Support::move_heap_stable_test_out_of_loop(IfNode* iff, PhaseIdealLoop* phase) {</span>
1791   IdealLoopTree *loop = phase-&gt;get_loop(iff);
1792   Node* loop_head = loop-&gt;_head;
1793   Node* entry_c = loop_head-&gt;in(LoopNode::EntryControl);
1794 
1795   Node* bol = iff-&gt;in(1);
1796   Node* cmp = bol-&gt;in(1);
1797   Node* andi = cmp-&gt;in(1);
1798   Node* load = andi-&gt;in(1);
1799 
1800   assert(is_gc_state_load(load), &quot;broken&quot;);
1801   if (!phase-&gt;is_dominator(load-&gt;in(0), entry_c)) {
1802     Node* mem_ctrl = NULL;
1803     Node* mem = dom_mem(load-&gt;in(MemNode::Memory), loop_head, Compile::AliasIdxRaw, mem_ctrl, phase);
1804     load = load-&gt;clone();
1805     load-&gt;set_req(MemNode::Memory, mem);
1806     load-&gt;set_req(0, entry_c);
1807     phase-&gt;register_new_node(load, entry_c);
1808     andi = andi-&gt;clone();
1809     andi-&gt;set_req(1, load);
1810     phase-&gt;register_new_node(andi, entry_c);
</pre>
<hr />
<pre>
1964   }
1965 
1966   if (!phase-&gt;C-&gt;major_progress()) {
1967     VectorSet seen(Thread::current()-&gt;resource_area());
1968     for (uint i = 0; i &lt; heap_stable_tests.size(); i++) {
1969       Node* n = heap_stable_tests.at(i);
1970       IdealLoopTree* loop = phase-&gt;get_loop(n);
1971       if (loop != phase-&gt;ltree_root() &amp;&amp;
1972           loop-&gt;_child == NULL &amp;&amp;
1973           !loop-&gt;_irreducible) {
1974         Node* head = loop-&gt;_head;
1975         if (head-&gt;is_Loop() &amp;&amp;
1976             (!head-&gt;is_CountedLoop() || head-&gt;as_CountedLoop()-&gt;is_main_loop() || head-&gt;as_CountedLoop()-&gt;is_normal_loop()) &amp;&amp;
1977             !seen.test_set(head-&gt;_idx)) {
1978           IfNode* iff = find_unswitching_candidate(loop, phase);
1979           if (iff != NULL) {
1980             Node* bol = iff-&gt;in(1);
1981             if (head-&gt;as_Loop()-&gt;is_strip_mined()) {
1982               head-&gt;as_Loop()-&gt;verify_strip_mined(0);
1983             }
<span class="line-modified">1984             move_heap_stable_test_out_of_loop(iff, phase);</span>
1985 
1986             AutoNodeBudget node_budget(phase);
1987 
1988             if (loop-&gt;policy_unswitching(phase)) {
1989               if (head-&gt;as_Loop()-&gt;is_strip_mined()) {
1990                 OuterStripMinedLoopNode* outer = head-&gt;as_CountedLoop()-&gt;outer_loop();
1991                 hide_strip_mined_loop(outer, head-&gt;as_CountedLoop(), phase);
1992               }
1993               phase-&gt;do_unswitching(loop, old_new);
1994             } else {
1995               // Not proceeding with unswitching. Move load back in
1996               // the loop.
1997               phase-&gt;igvn().replace_input_of(iff, 1, bol);
1998             }
1999           }
2000         }
2001       }
2002     }
2003   }
2004 }
</pre>
</td>
<td>
<hr />
<pre>
  51     PhaseIdealLoop ideal_loop(igvn, LoopOptsShenandoahExpand);
  52     if (C-&gt;failing()) return false;
  53     PhaseIdealLoop::verify(igvn);
  54     DEBUG_ONLY(verify_raw_mem(C-&gt;root());)
  55     if (attempt_more_loopopts) {
  56       C-&gt;set_major_progress();
  57       if (!C-&gt;optimize_loops(igvn, LoopOptsShenandoahPostExpand)) {
  58         return false;
  59       }
  60       C-&gt;clear_major_progress();
  61       if (C-&gt;range_check_cast_count() &gt; 0) {
  62         // No more loop optimizations. Remove all range check dependent CastIINodes.
  63         C-&gt;remove_range_check_casts(igvn);
  64         igvn.optimize();
  65       }
  66     }
  67   }
  68   return true;
  69 }
  70 
<span class="line-modified">  71 bool ShenandoahBarrierC2Support::is_gc_state_test(Node* iff, int mask) {</span>
  72   if (!UseShenandoahGC) {
  73     return false;
  74   }
  75   assert(iff-&gt;is_If(), &quot;bad input&quot;);
  76   if (iff-&gt;Opcode() != Op_If) {
  77     return false;
  78   }
  79   Node* bol = iff-&gt;in(1);
  80   if (!bol-&gt;is_Bool() || bol-&gt;as_Bool()-&gt;_test._test != BoolTest::ne) {
  81     return false;
  82   }
  83   Node* cmp = bol-&gt;in(1);
  84   if (cmp-&gt;Opcode() != Op_CmpI) {
  85     return false;
  86   }
  87   Node* in1 = cmp-&gt;in(1);
  88   Node* in2 = cmp-&gt;in(2);
  89   if (in2-&gt;find_int_con(-1) != 0) {
  90     return false;
  91   }
  92   if (in1-&gt;Opcode() != Op_AndI) {
  93     return false;
  94   }
  95   in2 = in1-&gt;in(2);
  96   if (in2-&gt;find_int_con(-1) != mask) {
  97     return false;
  98   }
  99   in1 = in1-&gt;in(1);
 100 
 101   return is_gc_state_load(in1);
 102 }
 103 
 104 bool ShenandoahBarrierC2Support::is_heap_stable_test(Node* iff) {
<span class="line-modified"> 105   return is_gc_state_test(iff, ShenandoahHeap::HAS_FORWARDED);</span>
 106 }
 107 
 108 bool ShenandoahBarrierC2Support::is_gc_state_load(Node *n) {
 109   if (!UseShenandoahGC) {
 110     return false;
 111   }
 112   if (n-&gt;Opcode() != Op_LoadB &amp;&amp; n-&gt;Opcode() != Op_LoadUB) {
 113     return false;
 114   }
 115   Node* addp = n-&gt;in(MemNode::Address);
 116   if (!addp-&gt;is_AddP()) {
 117     return false;
 118   }
 119   Node* base = addp-&gt;in(AddPNode::Address);
 120   Node* off = addp-&gt;in(AddPNode::Offset);
 121   if (base-&gt;Opcode() != Op_ThreadLocal) {
 122     return false;
 123   }
 124   if (off-&gt;find_intptr_t_con(-1) != in_bytes(ShenandoahThreadLocalData::gc_state_offset())) {
 125     return false;
</pre>
<hr />
<pre>
 842 void ShenandoahBarrierC2Support::follow_barrier_uses(Node* n, Node* ctrl, Unique_Node_List&amp; uses, PhaseIdealLoop* phase) {
 843   for (DUIterator_Fast imax, i = n-&gt;fast_outs(imax); i &lt; imax; i++) {
 844     Node* u = n-&gt;fast_out(i);
 845     if (!u-&gt;is_CFG() &amp;&amp; phase-&gt;get_ctrl(u) == ctrl &amp;&amp; (!u-&gt;is_Phi() || !u-&gt;in(0)-&gt;is_Loop() || u-&gt;in(LoopNode::LoopBackControl) != n)) {
 846       uses.push(u);
 847     }
 848   }
 849 }
 850 
 851 static void hide_strip_mined_loop(OuterStripMinedLoopNode* outer, CountedLoopNode* inner, PhaseIdealLoop* phase) {
 852   OuterStripMinedLoopEndNode* le = inner-&gt;outer_loop_end();
 853   Node* new_outer = new LoopNode(outer-&gt;in(LoopNode::EntryControl), outer-&gt;in(LoopNode::LoopBackControl));
 854   phase-&gt;register_control(new_outer, phase-&gt;get_loop(outer), outer-&gt;in(LoopNode::EntryControl));
 855   Node* new_le = new IfNode(le-&gt;in(0), le-&gt;in(1), le-&gt;_prob, le-&gt;_fcnt);
 856   phase-&gt;register_control(new_le, phase-&gt;get_loop(le), le-&gt;in(0));
 857   phase-&gt;lazy_replace(outer, new_outer);
 858   phase-&gt;lazy_replace(le, new_le);
 859   inner-&gt;clear_strip_mined();
 860 }
 861 
<span class="line-modified"> 862 void ShenandoahBarrierC2Support::test_gc_state(Node*&amp; ctrl, Node* raw_mem, Node*&amp; test_fail_ctrl,</span>
<span class="line-modified"> 863                                                PhaseIdealLoop* phase, int flags) {</span>
<span class="line-modified"> 864   PhaseIterGVN&amp; igvn = phase-&gt;igvn();</span>
<span class="line-modified"> 865   Node* old_ctrl = ctrl;</span>
<span class="line-modified"> 866 </span>
<span class="line-modified"> 867   Node* thread          = new ThreadLocalNode();</span>
<span class="line-modified"> 868   Node* gc_state_offset = igvn.MakeConX(in_bytes(ShenandoahThreadLocalData::gc_state_offset()));</span>
<span class="line-modified"> 869   Node* gc_state_addr   = new AddPNode(phase-&gt;C-&gt;top(), thread, gc_state_offset);</span>
<span class="line-modified"> 870   Node* gc_state        = new LoadBNode(old_ctrl, raw_mem, gc_state_addr,</span>
<span class="line-modified"> 871                                         DEBUG_ONLY(phase-&gt;C-&gt;get_adr_type(Compile::AliasIdxRaw)) NOT_DEBUG(NULL),</span>
<span class="line-modified"> 872                                         TypeInt::BYTE, MemNode::unordered);</span>
<span class="line-modified"> 873   Node* gc_state_and    = new AndINode(gc_state, igvn.intcon(flags));</span>
<span class="line-modified"> 874   Node* gc_state_cmp    = new CmpINode(gc_state_and, igvn.zerocon(T_INT));</span>
<span class="line-modified"> 875   Node* gc_state_bool   = new BoolNode(gc_state_cmp, BoolTest::ne);</span>
<span class="line-modified"> 876 </span>
<span class="line-modified"> 877   IfNode* gc_state_iff  = new IfNode(old_ctrl, gc_state_bool, PROB_UNLIKELY(0.999), COUNT_UNKNOWN);</span>
<span class="line-modified"> 878   ctrl                  = new IfTrueNode(gc_state_iff);</span>
<span class="line-modified"> 879   test_fail_ctrl        = new IfFalseNode(gc_state_iff);</span>
<span class="line-modified"> 880 </span>
<span class="line-modified"> 881   IdealLoopTree* loop = phase-&gt;get_loop(old_ctrl);</span>
<span class="line-modified"> 882   phase-&gt;register_control(gc_state_iff,   loop, old_ctrl);</span>
<span class="line-modified"> 883   phase-&gt;register_control(ctrl,           loop, gc_state_iff);</span>
<span class="line-modified"> 884   phase-&gt;register_control(test_fail_ctrl, loop, gc_state_iff);</span>
<span class="line-modified"> 885 </span>
<span class="line-modified"> 886   phase-&gt;register_new_node(thread,        old_ctrl);</span>
<span class="line-modified"> 887   phase-&gt;register_new_node(gc_state_addr, old_ctrl);</span>
<span class="line-modified"> 888   phase-&gt;register_new_node(gc_state,      old_ctrl);</span>
<span class="line-modified"> 889   phase-&gt;register_new_node(gc_state_and,  old_ctrl);</span>
<span class="line-modified"> 890   phase-&gt;register_new_node(gc_state_cmp,  old_ctrl);</span>
<span class="line-modified"> 891   phase-&gt;register_new_node(gc_state_bool, old_ctrl);</span>
<span class="line-added"> 892 </span>
<span class="line-added"> 893   phase-&gt;set_ctrl(gc_state_offset, phase-&gt;C-&gt;root());</span>
<span class="line-added"> 894 </span>
<span class="line-added"> 895   assert(is_gc_state_test(gc_state_iff, flags), &quot;Should match the shape&quot;);</span>
 896 }
 897 
 898 void ShenandoahBarrierC2Support::test_null(Node*&amp; ctrl, Node* val, Node*&amp; null_ctrl, PhaseIdealLoop* phase) {
<span class="line-modified"> 899   Node* old_ctrl = ctrl;</span>
<span class="line-added"> 900   PhaseIterGVN&amp; igvn = phase-&gt;igvn();</span>
<span class="line-added"> 901 </span>
<span class="line-added"> 902   const Type* val_t = igvn.type(val);</span>
 903   if (val_t-&gt;meet(TypePtr::NULL_PTR) == val_t) {
<span class="line-modified"> 904     Node* null_cmp   = new CmpPNode(val, igvn.zerocon(T_OBJECT));</span>
<span class="line-modified"> 905     Node* null_test  = new BoolNode(null_cmp, BoolTest::ne);</span>
<span class="line-modified"> 906 </span>
<span class="line-modified"> 907     IfNode* null_iff = new IfNode(old_ctrl, null_test, PROB_LIKELY(0.999), COUNT_UNKNOWN);</span>
<span class="line-modified"> 908     ctrl             = new IfTrueNode(null_iff);</span>
<span class="line-modified"> 909     null_ctrl        = new IfFalseNode(null_iff);</span>
<span class="line-modified"> 910 </span>
<span class="line-modified"> 911     IdealLoopTree* loop = phase-&gt;get_loop(old_ctrl);</span>
<span class="line-modified"> 912     phase-&gt;register_control(null_iff,  loop, old_ctrl);</span>
<span class="line-modified"> 913     phase-&gt;register_control(ctrl,      loop, null_iff);</span>
 914     phase-&gt;register_control(null_ctrl, loop, null_iff);
<span class="line-added"> 915 </span>
<span class="line-added"> 916     phase-&gt;register_new_node(null_cmp,  old_ctrl);</span>
<span class="line-added"> 917     phase-&gt;register_new_node(null_test, old_ctrl);</span>
 918   }
 919 }
 920 
 921 Node* ShenandoahBarrierC2Support::clone_null_check(Node*&amp; c, Node* val, Node* unc_ctrl, PhaseIdealLoop* phase) {
 922   IdealLoopTree *loop = phase-&gt;get_loop(c);
 923   Node* iff = unc_ctrl-&gt;in(0);
 924   assert(iff-&gt;is_If(), &quot;broken&quot;);
 925   Node* new_iff = iff-&gt;clone();
 926   new_iff-&gt;set_req(0, c);
 927   phase-&gt;register_control(new_iff, loop, c);
 928   Node* iffalse = new IfFalseNode(new_iff-&gt;as_If());
 929   phase-&gt;register_control(iffalse, loop, new_iff);
 930   Node* iftrue = new IfTrueNode(new_iff-&gt;as_If());
 931   phase-&gt;register_control(iftrue, loop, new_iff);
 932   c = iftrue;
 933   const Type *t = phase-&gt;igvn().type(val);
 934   assert(val-&gt;Opcode() == Op_CastPP, &quot;expect cast to non null here&quot;);
 935   Node* uncasted_val = val-&gt;in(1);
 936   val = new CastPPNode(uncasted_val, t);
 937   val-&gt;init_req(0, c);
</pre>
<hr />
<pre>
 971   for(uint next = 0; next &lt; uses.size(); next++ ) {
 972     Node *n = uses.at(next);
 973     assert(phase-&gt;get_ctrl(n) == proj, &quot;bad control&quot;);
 974     phase-&gt;set_ctrl_and_loop(n, new_unc_ctrl);
 975     if (n-&gt;in(0) == proj) {
 976       phase-&gt;igvn().replace_input_of(n, 0, new_unc_ctrl);
 977     }
 978     for (uint i = 0; i &lt; n-&gt;req(); i++) {
 979       Node* m = n-&gt;in(i);
 980       if (m != NULL &amp;&amp; phase-&gt;has_ctrl(m) &amp;&amp; phase-&gt;get_ctrl(m) == proj) {
 981         uses.push(m);
 982       }
 983     }
 984   }
 985 
 986   phase-&gt;igvn().rehash_node_delayed(use);
 987   int nb = use-&gt;replace_edge(proj, new_unc_ctrl);
 988   assert(nb == 1, &quot;only use expected&quot;);
 989 }
 990 
<span class="line-modified"> 991 void ShenandoahBarrierC2Support::test_in_cset(Node*&amp; ctrl, Node*&amp; not_cset_ctrl, Node* val, Node* raw_mem, PhaseIdealLoop* phase) {</span>
<span class="line-modified"> 992   Node* old_ctrl = ctrl;</span>
<span class="line-modified"> 993   PhaseIterGVN&amp; igvn = phase-&gt;igvn();</span>
<span class="line-modified"> 994 </span>
<span class="line-modified"> 995   Node* raw_val        = new CastP2XNode(old_ctrl, val);</span>
<span class="line-modified"> 996   Node* cset_idx       = new URShiftXNode(raw_val, igvn.intcon(ShenandoahHeapRegion::region_size_bytes_shift_jint()));</span>
<span class="line-modified"> 997   Node* cset_addr      = igvn.makecon(TypeRawPtr::make(ShenandoahHeap::in_cset_fast_test_addr()));</span>
<span class="line-modified"> 998   Node* cset_load_addr = new AddPNode(phase-&gt;C-&gt;top(), cset_addr, cset_idx);</span>
<span class="line-modified"> 999   Node* cset_load      = new LoadBNode(old_ctrl, raw_mem, cset_load_addr,</span>
<span class="line-modified">1000                                        DEBUG_ONLY(phase-&gt;C-&gt;get_adr_type(Compile::AliasIdxRaw)) NOT_DEBUG(NULL),</span>
<span class="line-modified">1001                                        TypeInt::BYTE, MemNode::unordered);</span>
<span class="line-modified">1002   Node* cset_cmp       = new CmpINode(cset_load, igvn.zerocon(T_INT));</span>
<span class="line-modified">1003   Node* cset_bool      = new BoolNode(cset_cmp, BoolTest::ne);</span>
<span class="line-modified">1004 </span>
<span class="line-modified">1005   IfNode* cset_iff     = new IfNode(old_ctrl, cset_bool, PROB_UNLIKELY(0.999), COUNT_UNKNOWN);</span>
<span class="line-modified">1006   ctrl                 = new IfTrueNode(cset_iff);</span>
<span class="line-modified">1007   not_cset_ctrl        = new IfFalseNode(cset_iff);</span>
<span class="line-modified">1008 </span>
<span class="line-modified">1009   IdealLoopTree *loop = phase-&gt;get_loop(old_ctrl);</span>
<span class="line-modified">1010   phase-&gt;register_control(cset_iff,      loop, old_ctrl);</span>
<span class="line-modified">1011   phase-&gt;register_control(ctrl,          loop, cset_iff);</span>
<span class="line-modified">1012   phase-&gt;register_control(not_cset_ctrl, loop, cset_iff);</span>
<span class="line-modified">1013 </span>
<span class="line-modified">1014   phase-&gt;set_ctrl(cset_addr, phase-&gt;C-&gt;root());</span>
<span class="line-modified">1015 </span>
<span class="line-modified">1016   phase-&gt;register_new_node(raw_val,        old_ctrl);</span>
<span class="line-modified">1017   phase-&gt;register_new_node(cset_idx,       old_ctrl);</span>
<span class="line-added">1018   phase-&gt;register_new_node(cset_load_addr, old_ctrl);</span>
<span class="line-added">1019   phase-&gt;register_new_node(cset_load,      old_ctrl);</span>
<span class="line-added">1020   phase-&gt;register_new_node(cset_cmp,       old_ctrl);</span>
<span class="line-added">1021   phase-&gt;register_new_node(cset_bool,      old_ctrl);</span>
1022 }
1023 
1024 void ShenandoahBarrierC2Support::call_lrb_stub(Node*&amp; ctrl, Node*&amp; val, Node* load_addr, Node*&amp; result_mem, Node* raw_mem, bool is_native, PhaseIdealLoop* phase) {
1025   IdealLoopTree*loop = phase-&gt;get_loop(ctrl);
1026   const TypePtr* obj_type = phase-&gt;igvn().type(val)-&gt;is_oopptr();
1027 
1028   // The slow path stub consumes and produces raw memory in addition
1029   // to the existing memory edges
1030   Node* base = find_bottom_mem(ctrl, phase);
1031   MergeMemNode* mm = MergeMemNode::make(base);
1032   mm-&gt;set_memory_at(Compile::AliasIdxRaw, raw_mem);
1033   phase-&gt;register_new_node(mm, ctrl);
1034 
1035   address target = LP64_ONLY(UseCompressedOops) NOT_LP64(false) ?
1036           CAST_FROM_FN_PTR(address, ShenandoahRuntime::load_reference_barrier_narrow) :
1037           CAST_FROM_FN_PTR(address, ShenandoahRuntime::load_reference_barrier);
1038 
1039   address calladdr = is_native ? CAST_FROM_FN_PTR(address, ShenandoahRuntime::load_reference_barrier_native)
1040                                : target;
1041   const char* name = is_native ? &quot;load_reference_barrier_native&quot; : &quot;load_reference_barrier&quot;;
</pre>
<hr />
<pre>
1431       }
1432     }
1433 
1434     Node* uncasted_val = val;
1435     if (unc != NULL) {
1436       uncasted_val = val-&gt;in(1);
1437     }
1438 
1439     Node* heap_stable_ctrl = NULL;
1440     Node* null_ctrl = NULL;
1441 
1442     assert(val-&gt;bottom_type()-&gt;make_oopptr(), &quot;need oop&quot;);
1443     assert(val-&gt;bottom_type()-&gt;make_oopptr()-&gt;const_oop() == NULL, &quot;expect non-constant&quot;);
1444 
1445     enum { _heap_stable = 1, _not_cset, _evac_path, _null_path, PATH_LIMIT };
1446     Node* region = new RegionNode(PATH_LIMIT);
1447     Node* val_phi = new PhiNode(region, uncasted_val-&gt;bottom_type()-&gt;is_oopptr());
1448     Node* raw_mem_phi = PhiNode::make(region, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
1449 
1450     // Stable path.
<span class="line-modified">1451     test_gc_state(ctrl, raw_mem, heap_stable_ctrl, phase, ShenandoahHeap::HAS_FORWARDED);</span>
1452     IfNode* heap_stable_iff = heap_stable_ctrl-&gt;in(0)-&gt;as_If();
1453 
1454     // Heap stable case
1455     region-&gt;init_req(_heap_stable, heap_stable_ctrl);
1456     val_phi-&gt;init_req(_heap_stable, uncasted_val);
1457     raw_mem_phi-&gt;init_req(_heap_stable, raw_mem);
1458 
1459     Node* reg2_ctrl = NULL;
1460     // Null case
1461     test_null(ctrl, val, null_ctrl, phase);
1462     if (null_ctrl != NULL) {
1463       reg2_ctrl = null_ctrl-&gt;in(0);
1464       region-&gt;init_req(_null_path, null_ctrl);
1465       val_phi-&gt;init_req(_null_path, uncasted_val);
1466       raw_mem_phi-&gt;init_req(_null_path, raw_mem);
1467     } else {
1468       region-&gt;del_req(_null_path);
1469       val_phi-&gt;del_req(_null_path);
1470       raw_mem_phi-&gt;del_req(_null_path);
1471     }
1472 
1473     // Test for in-cset.
1474     // Wires !in_cset(obj) to slot 2 of region and phis
1475     Node* not_cset_ctrl = NULL;
<span class="line-modified">1476     test_in_cset(ctrl, not_cset_ctrl, uncasted_val, raw_mem, phase);</span>
1477     if (not_cset_ctrl != NULL) {
1478       if (reg2_ctrl == NULL) reg2_ctrl = not_cset_ctrl-&gt;in(0);
1479       region-&gt;init_req(_not_cset, not_cset_ctrl);
1480       val_phi-&gt;init_req(_not_cset, uncasted_val);
1481       raw_mem_phi-&gt;init_req(_not_cset, raw_mem);
1482     }
1483 
1484     // Resolve object when orig-value is in cset.
1485     // Make the unconditional resolve for fwdptr.
1486     Node* new_val = uncasted_val;
1487     if (unc_ctrl != NULL) {
1488       // Clone the null check in this branch to allow implicit null check
1489       new_val = clone_null_check(ctrl, val, unc_ctrl, phase);
1490       fix_null_check(unc, unc_ctrl, ctrl-&gt;in(0)-&gt;as_If()-&gt;proj_out(0), uses, phase);
1491 
1492       IfNode* iff = unc_ctrl-&gt;in(0)-&gt;as_If();
1493       phase-&gt;igvn().replace_input_of(iff, 1, phase-&gt;igvn().intcon(1));
1494     }
1495 
1496     // Call lrb-stub and wire up that path in slots 4
</pre>
<hr />
<pre>
1602     }
1603 
1604     Node* init_ctrl = ctrl;
1605     IdealLoopTree* loop = phase-&gt;get_loop(ctrl);
1606     Node* raw_mem = fixer.find_mem(ctrl, barrier);
1607     Node* init_raw_mem = raw_mem;
1608     Node* raw_mem_for_ctrl = fixer.find_mem(ctrl, NULL);
1609     Node* heap_stable_ctrl = NULL;
1610     Node* null_ctrl = NULL;
1611     uint last = phase-&gt;C-&gt;unique();
1612 
1613     enum { _heap_stable = 1, _heap_unstable, PATH_LIMIT };
1614     Node* region = new RegionNode(PATH_LIMIT);
1615     Node* phi = PhiNode::make(region, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
1616 
1617     enum { _fast_path = 1, _slow_path, _null_path, PATH_LIMIT2 };
1618     Node* region2 = new RegionNode(PATH_LIMIT2);
1619     Node* phi2 = PhiNode::make(region2, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
1620 
1621     // Stable path.
<span class="line-modified">1622     test_gc_state(ctrl, raw_mem, heap_stable_ctrl, phase, ShenandoahHeap::MARKING);</span>
1623     region-&gt;init_req(_heap_stable, heap_stable_ctrl);
1624     phi-&gt;init_req(_heap_stable, raw_mem);
1625 
1626     // Null path
1627     Node* reg2_ctrl = NULL;
1628     test_null(ctrl, pre_val, null_ctrl, phase);
1629     if (null_ctrl != NULL) {
1630       reg2_ctrl = null_ctrl-&gt;in(0);
1631       region2-&gt;init_req(_null_path, null_ctrl);
1632       phi2-&gt;init_req(_null_path, raw_mem);
1633     } else {
1634       region2-&gt;del_req(_null_path);
1635       phi2-&gt;del_req(_null_path);
1636     }
1637 
1638     const int index_offset = in_bytes(ShenandoahThreadLocalData::satb_mark_queue_index_offset());
1639     const int buffer_offset = in_bytes(ShenandoahThreadLocalData::satb_mark_queue_buffer_offset());
1640     Node* thread = new ThreadLocalNode();
1641     phase-&gt;register_new_node(thread, ctrl);
1642     Node* buffer_adr = new AddPNode(phase-&gt;C-&gt;top(), thread, phase-&gt;igvn().MakeConX(buffer_offset));
</pre>
<hr />
<pre>
1784       return get_load_addr(phase, visited, in-&gt;in(ShenandoahLoadReferenceBarrierNode::ValueIn));
1785     case Op_ShenandoahEnqueueBarrier:
1786       return get_load_addr(phase, visited, in-&gt;in(1));
1787     case Op_CallDynamicJava:
1788     case Op_CallLeaf:
1789     case Op_CallStaticJava:
1790     case Op_ConN:
1791     case Op_ConP:
1792     case Op_Parm:
1793     case Op_CreateEx:
1794       return phase-&gt;igvn().zerocon(T_OBJECT);
1795     default:
1796 #ifdef ASSERT
1797       fatal(&quot;Unknown node in get_load_addr: %s&quot;, NodeClassNames[in-&gt;Opcode()]);
1798 #endif
1799       return phase-&gt;igvn().zerocon(T_OBJECT);
1800   }
1801 
1802 }
1803 
<span class="line-modified">1804 void ShenandoahBarrierC2Support::move_gc_state_test_out_of_loop(IfNode* iff, PhaseIdealLoop* phase) {</span>
1805   IdealLoopTree *loop = phase-&gt;get_loop(iff);
1806   Node* loop_head = loop-&gt;_head;
1807   Node* entry_c = loop_head-&gt;in(LoopNode::EntryControl);
1808 
1809   Node* bol = iff-&gt;in(1);
1810   Node* cmp = bol-&gt;in(1);
1811   Node* andi = cmp-&gt;in(1);
1812   Node* load = andi-&gt;in(1);
1813 
1814   assert(is_gc_state_load(load), &quot;broken&quot;);
1815   if (!phase-&gt;is_dominator(load-&gt;in(0), entry_c)) {
1816     Node* mem_ctrl = NULL;
1817     Node* mem = dom_mem(load-&gt;in(MemNode::Memory), loop_head, Compile::AliasIdxRaw, mem_ctrl, phase);
1818     load = load-&gt;clone();
1819     load-&gt;set_req(MemNode::Memory, mem);
1820     load-&gt;set_req(0, entry_c);
1821     phase-&gt;register_new_node(load, entry_c);
1822     andi = andi-&gt;clone();
1823     andi-&gt;set_req(1, load);
1824     phase-&gt;register_new_node(andi, entry_c);
</pre>
<hr />
<pre>
1978   }
1979 
1980   if (!phase-&gt;C-&gt;major_progress()) {
1981     VectorSet seen(Thread::current()-&gt;resource_area());
1982     for (uint i = 0; i &lt; heap_stable_tests.size(); i++) {
1983       Node* n = heap_stable_tests.at(i);
1984       IdealLoopTree* loop = phase-&gt;get_loop(n);
1985       if (loop != phase-&gt;ltree_root() &amp;&amp;
1986           loop-&gt;_child == NULL &amp;&amp;
1987           !loop-&gt;_irreducible) {
1988         Node* head = loop-&gt;_head;
1989         if (head-&gt;is_Loop() &amp;&amp;
1990             (!head-&gt;is_CountedLoop() || head-&gt;as_CountedLoop()-&gt;is_main_loop() || head-&gt;as_CountedLoop()-&gt;is_normal_loop()) &amp;&amp;
1991             !seen.test_set(head-&gt;_idx)) {
1992           IfNode* iff = find_unswitching_candidate(loop, phase);
1993           if (iff != NULL) {
1994             Node* bol = iff-&gt;in(1);
1995             if (head-&gt;as_Loop()-&gt;is_strip_mined()) {
1996               head-&gt;as_Loop()-&gt;verify_strip_mined(0);
1997             }
<span class="line-modified">1998             move_gc_state_test_out_of_loop(iff, phase);</span>
1999 
2000             AutoNodeBudget node_budget(phase);
2001 
2002             if (loop-&gt;policy_unswitching(phase)) {
2003               if (head-&gt;as_Loop()-&gt;is_strip_mined()) {
2004                 OuterStripMinedLoopNode* outer = head-&gt;as_CountedLoop()-&gt;outer_loop();
2005                 hide_strip_mined_loop(outer, head-&gt;as_CountedLoop(), phase);
2006               }
2007               phase-&gt;do_unswitching(loop, old_new);
2008             } else {
2009               // Not proceeding with unswitching. Move load back in
2010               // the loop.
2011               phase-&gt;igvn().replace_input_of(iff, 1, bol);
2012             }
2013           }
2014         }
2015       }
2016     }
2017   }
2018 }
</pre>
</td>
</tr>
</table>
<center><a href="shenandoahBarrierSetC2.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../jvmci/jvmciCodeInstaller.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>