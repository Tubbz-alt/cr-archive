<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shenandoah/c2/shenandoahSupport.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahBarrierSetC2.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../jvmci/jvmciCodeInstaller.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/c2/shenandoahSupport.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -66,11 +66,11 @@</span>
      }
    }
    return true;
  }
  
<span class="udiff-line-modified-removed">- bool ShenandoahBarrierC2Support::is_heap_state_test(Node* iff, int mask) {</span>
<span class="udiff-line-modified-added">+ bool ShenandoahBarrierC2Support::is_gc_state_test(Node* iff, int mask) {</span>
    if (!UseShenandoahGC) {
      return false;
    }
    assert(iff-&gt;is_If(), &quot;bad input&quot;);
    if (iff-&gt;Opcode() != Op_If) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -100,11 +100,11 @@</span>
  
    return is_gc_state_load(in1);
  }
  
  bool ShenandoahBarrierC2Support::is_heap_stable_test(Node* iff) {
<span class="udiff-line-modified-removed">-   return is_heap_state_test(iff, ShenandoahHeap::HAS_FORWARDED);</span>
<span class="udiff-line-modified-added">+   return is_gc_state_test(iff, ShenandoahHeap::HAS_FORWARDED);</span>
  }
  
  bool ShenandoahBarrierC2Support::is_gc_state_load(Node *n) {
    if (!UseShenandoahGC) {
      return false;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -857,56 +857,66 @@</span>
    phase-&gt;lazy_replace(outer, new_outer);
    phase-&gt;lazy_replace(le, new_le);
    inner-&gt;clear_strip_mined();
  }
  
<span class="udiff-line-modified-removed">- void ShenandoahBarrierC2Support::test_heap_state(Node*&amp; ctrl, Node* raw_mem, Node*&amp; heap_stable_ctrl,</span>
<span class="udiff-line-modified-removed">-                                                  PhaseIdealLoop* phase, int flags) {</span>
<span class="udiff-line-modified-removed">-   IdealLoopTree* loop = phase-&gt;get_loop(ctrl);</span>
<span class="udiff-line-modified-removed">-   Node* thread = new ThreadLocalNode();</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_new_node(thread, ctrl);</span>
<span class="udiff-line-modified-removed">-   Node* offset = phase-&gt;igvn().MakeConX(in_bytes(ShenandoahThreadLocalData::gc_state_offset()));</span>
<span class="udiff-line-modified-removed">-   phase-&gt;set_ctrl(offset, phase-&gt;C-&gt;root());</span>
<span class="udiff-line-modified-removed">-   Node* gc_state_addr = new AddPNode(phase-&gt;C-&gt;top(), thread, offset);</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_new_node(gc_state_addr, ctrl);</span>
<span class="udiff-line-modified-removed">-   uint gc_state_idx = Compile::AliasIdxRaw;</span>
<span class="udiff-line-modified-removed">-   const TypePtr* gc_state_adr_type = NULL; // debug-mode-only argument</span>
<span class="udiff-line-modified-removed">-   debug_only(gc_state_adr_type = phase-&gt;C-&gt;get_adr_type(gc_state_idx));</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   Node* gc_state = new LoadBNode(ctrl, raw_mem, gc_state_addr, gc_state_adr_type, TypeInt::BYTE, MemNode::unordered);</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_new_node(gc_state, ctrl);</span>
<span class="udiff-line-modified-removed">-   Node* heap_stable_and = new AndINode(gc_state, phase-&gt;igvn().intcon(flags));</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_new_node(heap_stable_and, ctrl);</span>
<span class="udiff-line-modified-removed">-   Node* heap_stable_cmp = new CmpINode(heap_stable_and, phase-&gt;igvn().zerocon(T_INT));</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_new_node(heap_stable_cmp, ctrl);</span>
<span class="udiff-line-modified-removed">-   Node* heap_stable_test = new BoolNode(heap_stable_cmp, BoolTest::ne);</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_new_node(heap_stable_test, ctrl);</span>
<span class="udiff-line-modified-removed">-   IfNode* heap_stable_iff = new IfNode(ctrl, heap_stable_test, PROB_UNLIKELY(0.999), COUNT_UNKNOWN);</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_control(heap_stable_iff, loop, ctrl);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   heap_stable_ctrl = new IfFalseNode(heap_stable_iff);</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_control(heap_stable_ctrl, loop, heap_stable_iff);</span>
<span class="udiff-line-modified-removed">-   ctrl = new IfTrueNode(heap_stable_iff);</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_control(ctrl, loop, heap_stable_iff);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   assert(is_heap_state_test(heap_stable_iff, flags), &quot;Should match the shape&quot;);</span>
<span class="udiff-line-modified-added">+ void ShenandoahBarrierC2Support::test_gc_state(Node*&amp; ctrl, Node* raw_mem, Node*&amp; test_fail_ctrl,</span>
<span class="udiff-line-modified-added">+                                                PhaseIdealLoop* phase, int flags) {</span>
<span class="udiff-line-modified-added">+   PhaseIterGVN&amp; igvn = phase-&gt;igvn();</span>
<span class="udiff-line-modified-added">+   Node* old_ctrl = ctrl;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   Node* thread          = new ThreadLocalNode();</span>
<span class="udiff-line-modified-added">+   Node* gc_state_offset = igvn.MakeConX(in_bytes(ShenandoahThreadLocalData::gc_state_offset()));</span>
<span class="udiff-line-modified-added">+   Node* gc_state_addr   = new AddPNode(phase-&gt;C-&gt;top(), thread, gc_state_offset);</span>
<span class="udiff-line-modified-added">+   Node* gc_state        = new LoadBNode(old_ctrl, raw_mem, gc_state_addr,</span>
<span class="udiff-line-modified-added">+                                         DEBUG_ONLY(phase-&gt;C-&gt;get_adr_type(Compile::AliasIdxRaw)) NOT_DEBUG(NULL),</span>
<span class="udiff-line-modified-added">+                                         TypeInt::BYTE, MemNode::unordered);</span>
<span class="udiff-line-modified-added">+   Node* gc_state_and    = new AndINode(gc_state, igvn.intcon(flags));</span>
<span class="udiff-line-modified-added">+   Node* gc_state_cmp    = new CmpINode(gc_state_and, igvn.zerocon(T_INT));</span>
<span class="udiff-line-modified-added">+   Node* gc_state_bool   = new BoolNode(gc_state_cmp, BoolTest::ne);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   IfNode* gc_state_iff  = new IfNode(old_ctrl, gc_state_bool, PROB_UNLIKELY(0.999), COUNT_UNKNOWN);</span>
<span class="udiff-line-modified-added">+   ctrl                  = new IfTrueNode(gc_state_iff);</span>
<span class="udiff-line-modified-added">+   test_fail_ctrl        = new IfFalseNode(gc_state_iff);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   IdealLoopTree* loop = phase-&gt;get_loop(old_ctrl);</span>
<span class="udiff-line-modified-added">+   phase-&gt;register_control(gc_state_iff,   loop, old_ctrl);</span>
<span class="udiff-line-modified-added">+   phase-&gt;register_control(ctrl,           loop, gc_state_iff);</span>
<span class="udiff-line-modified-added">+   phase-&gt;register_control(test_fail_ctrl, loop, gc_state_iff);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   phase-&gt;register_new_node(thread,        old_ctrl);</span>
<span class="udiff-line-modified-added">+   phase-&gt;register_new_node(gc_state_addr, old_ctrl);</span>
<span class="udiff-line-modified-added">+   phase-&gt;register_new_node(gc_state,      old_ctrl);</span>
<span class="udiff-line-modified-added">+   phase-&gt;register_new_node(gc_state_and,  old_ctrl);</span>
<span class="udiff-line-modified-added">+   phase-&gt;register_new_node(gc_state_cmp,  old_ctrl);</span>
<span class="udiff-line-modified-added">+   phase-&gt;register_new_node(gc_state_bool, old_ctrl);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   phase-&gt;set_ctrl(gc_state_offset, phase-&gt;C-&gt;root());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   assert(is_gc_state_test(gc_state_iff, flags), &quot;Should match the shape&quot;);</span>
  }
  
  void ShenandoahBarrierC2Support::test_null(Node*&amp; ctrl, Node* val, Node*&amp; null_ctrl, PhaseIdealLoop* phase) {
<span class="udiff-line-modified-removed">-   const Type* val_t = phase-&gt;igvn().type(val);</span>
<span class="udiff-line-modified-added">+   Node* old_ctrl = ctrl;</span>
<span class="udiff-line-added">+   PhaseIterGVN&amp; igvn = phase-&gt;igvn();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   const Type* val_t = igvn.type(val);</span>
    if (val_t-&gt;meet(TypePtr::NULL_PTR) == val_t) {
<span class="udiff-line-modified-removed">-     IdealLoopTree* loop = phase-&gt;get_loop(ctrl);</span>
<span class="udiff-line-modified-removed">-     Node* null_cmp = new CmpPNode(val, phase-&gt;igvn().zerocon(T_OBJECT));</span>
<span class="udiff-line-modified-removed">-     phase-&gt;register_new_node(null_cmp, ctrl);</span>
<span class="udiff-line-modified-removed">-     Node* null_test = new BoolNode(null_cmp, BoolTest::ne);</span>
<span class="udiff-line-modified-removed">-     phase-&gt;register_new_node(null_test, ctrl);</span>
<span class="udiff-line-modified-removed">-     IfNode* null_iff = new IfNode(ctrl, null_test, PROB_LIKELY(0.999), COUNT_UNKNOWN);</span>
<span class="udiff-line-modified-removed">-     phase-&gt;register_control(null_iff, loop, ctrl);</span>
<span class="udiff-line-modified-removed">-     ctrl = new IfTrueNode(null_iff);</span>
<span class="udiff-line-modified-removed">-     phase-&gt;register_control(ctrl, loop, null_iff);</span>
<span class="udiff-line-modified-removed">-     null_ctrl = new IfFalseNode(null_iff);</span>
<span class="udiff-line-modified-added">+     Node* null_cmp   = new CmpPNode(val, igvn.zerocon(T_OBJECT));</span>
<span class="udiff-line-modified-added">+     Node* null_test  = new BoolNode(null_cmp, BoolTest::ne);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     IfNode* null_iff = new IfNode(old_ctrl, null_test, PROB_LIKELY(0.999), COUNT_UNKNOWN);</span>
<span class="udiff-line-modified-added">+     ctrl             = new IfTrueNode(null_iff);</span>
<span class="udiff-line-modified-added">+     null_ctrl        = new IfFalseNode(null_iff);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     IdealLoopTree* loop = phase-&gt;get_loop(old_ctrl);</span>
<span class="udiff-line-modified-added">+     phase-&gt;register_control(null_iff,  loop, old_ctrl);</span>
<span class="udiff-line-modified-added">+     phase-&gt;register_control(ctrl,      loop, null_iff);</span>
      phase-&gt;register_control(null_ctrl, loop, null_iff);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     phase-&gt;register_new_node(null_cmp,  old_ctrl);</span>
<span class="udiff-line-added">+     phase-&gt;register_new_node(null_test, old_ctrl);</span>
    }
  }
  
  Node* ShenandoahBarrierC2Support::clone_null_check(Node*&amp; c, Node* val, Node* unc_ctrl, PhaseIdealLoop* phase) {
    IdealLoopTree *loop = phase-&gt;get_loop(c);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -976,37 +986,41 @@</span>
    phase-&gt;igvn().rehash_node_delayed(use);
    int nb = use-&gt;replace_edge(proj, new_unc_ctrl);
    assert(nb == 1, &quot;only use expected&quot;);
  }
  
<span class="udiff-line-modified-removed">- void ShenandoahBarrierC2Support::in_cset_fast_test(Node*&amp; ctrl, Node*&amp; not_cset_ctrl, Node* val, Node* raw_mem, PhaseIdealLoop* phase) {</span>
<span class="udiff-line-modified-removed">-   IdealLoopTree *loop = phase-&gt;get_loop(ctrl);</span>
<span class="udiff-line-modified-removed">-   Node* raw_rbtrue = new CastP2XNode(ctrl, val);</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_new_node(raw_rbtrue, ctrl);</span>
<span class="udiff-line-modified-removed">-   Node* cset_offset = new URShiftXNode(raw_rbtrue, phase-&gt;igvn().intcon(ShenandoahHeapRegion::region_size_bytes_shift_jint()));</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_new_node(cset_offset, ctrl);</span>
<span class="udiff-line-modified-removed">-   Node* in_cset_fast_test_base_addr = phase-&gt;igvn().makecon(TypeRawPtr::make(ShenandoahHeap::in_cset_fast_test_addr()));</span>
<span class="udiff-line-modified-removed">-   phase-&gt;set_ctrl(in_cset_fast_test_base_addr, phase-&gt;C-&gt;root());</span>
<span class="udiff-line-modified-removed">-   Node* in_cset_fast_test_adr = new AddPNode(phase-&gt;C-&gt;top(), in_cset_fast_test_base_addr, cset_offset);</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_new_node(in_cset_fast_test_adr, ctrl);</span>
<span class="udiff-line-modified-removed">-   uint in_cset_fast_test_idx = Compile::AliasIdxRaw;</span>
<span class="udiff-line-modified-removed">-   const TypePtr* in_cset_fast_test_adr_type = NULL; // debug-mode-only argument</span>
<span class="udiff-line-modified-removed">-   debug_only(in_cset_fast_test_adr_type = phase-&gt;C-&gt;get_adr_type(in_cset_fast_test_idx));</span>
<span class="udiff-line-modified-removed">-   Node* in_cset_fast_test_load = new LoadBNode(ctrl, raw_mem, in_cset_fast_test_adr, in_cset_fast_test_adr_type, TypeInt::BYTE, MemNode::unordered);</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_new_node(in_cset_fast_test_load, ctrl);</span>
<span class="udiff-line-modified-removed">-   Node* in_cset_fast_test_cmp = new CmpINode(in_cset_fast_test_load, phase-&gt;igvn().zerocon(T_INT));</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_new_node(in_cset_fast_test_cmp, ctrl);</span>
<span class="udiff-line-modified-removed">-   Node* in_cset_fast_test_test = new BoolNode(in_cset_fast_test_cmp, BoolTest::eq);</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_new_node(in_cset_fast_test_test, ctrl);</span>
<span class="udiff-line-modified-removed">-   IfNode* in_cset_fast_test_iff = new IfNode(ctrl, in_cset_fast_test_test, PROB_UNLIKELY(0.999), COUNT_UNKNOWN);</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_control(in_cset_fast_test_iff, loop, ctrl);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   not_cset_ctrl = new IfTrueNode(in_cset_fast_test_iff);</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_control(not_cset_ctrl, loop, in_cset_fast_test_iff);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   ctrl = new IfFalseNode(in_cset_fast_test_iff);</span>
<span class="udiff-line-modified-removed">-   phase-&gt;register_control(ctrl, loop, in_cset_fast_test_iff);</span>
<span class="udiff-line-modified-added">+ void ShenandoahBarrierC2Support::test_in_cset(Node*&amp; ctrl, Node*&amp; not_cset_ctrl, Node* val, Node* raw_mem, PhaseIdealLoop* phase) {</span>
<span class="udiff-line-modified-added">+   Node* old_ctrl = ctrl;</span>
<span class="udiff-line-modified-added">+   PhaseIterGVN&amp; igvn = phase-&gt;igvn();</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   Node* raw_val        = new CastP2XNode(old_ctrl, val);</span>
<span class="udiff-line-modified-added">+   Node* cset_idx       = new URShiftXNode(raw_val, igvn.intcon(ShenandoahHeapRegion::region_size_bytes_shift_jint()));</span>
<span class="udiff-line-modified-added">+   Node* cset_addr      = igvn.makecon(TypeRawPtr::make(ShenandoahHeap::in_cset_fast_test_addr()));</span>
<span class="udiff-line-modified-added">+   Node* cset_load_addr = new AddPNode(phase-&gt;C-&gt;top(), cset_addr, cset_idx);</span>
<span class="udiff-line-modified-added">+   Node* cset_load      = new LoadBNode(old_ctrl, raw_mem, cset_load_addr,</span>
<span class="udiff-line-modified-added">+                                        DEBUG_ONLY(phase-&gt;C-&gt;get_adr_type(Compile::AliasIdxRaw)) NOT_DEBUG(NULL),</span>
<span class="udiff-line-modified-added">+                                        TypeInt::BYTE, MemNode::unordered);</span>
<span class="udiff-line-modified-added">+   Node* cset_cmp       = new CmpINode(cset_load, igvn.zerocon(T_INT));</span>
<span class="udiff-line-modified-added">+   Node* cset_bool      = new BoolNode(cset_cmp, BoolTest::ne);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   IfNode* cset_iff     = new IfNode(old_ctrl, cset_bool, PROB_UNLIKELY(0.999), COUNT_UNKNOWN);</span>
<span class="udiff-line-modified-added">+   ctrl                 = new IfTrueNode(cset_iff);</span>
<span class="udiff-line-modified-added">+   not_cset_ctrl        = new IfFalseNode(cset_iff);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   IdealLoopTree *loop = phase-&gt;get_loop(old_ctrl);</span>
<span class="udiff-line-modified-added">+   phase-&gt;register_control(cset_iff,      loop, old_ctrl);</span>
<span class="udiff-line-modified-added">+   phase-&gt;register_control(ctrl,          loop, cset_iff);</span>
<span class="udiff-line-modified-added">+   phase-&gt;register_control(not_cset_ctrl, loop, cset_iff);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   phase-&gt;set_ctrl(cset_addr, phase-&gt;C-&gt;root());</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   phase-&gt;register_new_node(raw_val,        old_ctrl);</span>
<span class="udiff-line-modified-added">+   phase-&gt;register_new_node(cset_idx,       old_ctrl);</span>
<span class="udiff-line-added">+   phase-&gt;register_new_node(cset_load_addr, old_ctrl);</span>
<span class="udiff-line-added">+   phase-&gt;register_new_node(cset_load,      old_ctrl);</span>
<span class="udiff-line-added">+   phase-&gt;register_new_node(cset_cmp,       old_ctrl);</span>
<span class="udiff-line-added">+   phase-&gt;register_new_node(cset_bool,      old_ctrl);</span>
  }
  
  void ShenandoahBarrierC2Support::call_lrb_stub(Node*&amp; ctrl, Node*&amp; val, Node* load_addr, Node*&amp; result_mem, Node* raw_mem, bool is_native, PhaseIdealLoop* phase) {
    IdealLoopTree*loop = phase-&gt;get_loop(ctrl);
    const TypePtr* obj_type = phase-&gt;igvn().type(val)-&gt;is_oopptr();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1432,11 +1446,11 @@</span>
      Node* region = new RegionNode(PATH_LIMIT);
      Node* val_phi = new PhiNode(region, uncasted_val-&gt;bottom_type()-&gt;is_oopptr());
      Node* raw_mem_phi = PhiNode::make(region, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
  
      // Stable path.
<span class="udiff-line-modified-removed">-     test_heap_state(ctrl, raw_mem, heap_stable_ctrl, phase, ShenandoahHeap::HAS_FORWARDED);</span>
<span class="udiff-line-modified-added">+     test_gc_state(ctrl, raw_mem, heap_stable_ctrl, phase, ShenandoahHeap::HAS_FORWARDED);</span>
      IfNode* heap_stable_iff = heap_stable_ctrl-&gt;in(0)-&gt;as_If();
  
      // Heap stable case
      region-&gt;init_req(_heap_stable, heap_stable_ctrl);
      val_phi-&gt;init_req(_heap_stable, uncasted_val);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1457,11 +1471,11 @@</span>
      }
  
      // Test for in-cset.
      // Wires !in_cset(obj) to slot 2 of region and phis
      Node* not_cset_ctrl = NULL;
<span class="udiff-line-modified-removed">-     in_cset_fast_test(ctrl, not_cset_ctrl, uncasted_val, raw_mem, phase);</span>
<span class="udiff-line-modified-added">+     test_in_cset(ctrl, not_cset_ctrl, uncasted_val, raw_mem, phase);</span>
      if (not_cset_ctrl != NULL) {
        if (reg2_ctrl == NULL) reg2_ctrl = not_cset_ctrl-&gt;in(0);
        region-&gt;init_req(_not_cset, not_cset_ctrl);
        val_phi-&gt;init_req(_not_cset, uncasted_val);
        raw_mem_phi-&gt;init_req(_not_cset, raw_mem);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1603,11 +1617,11 @@</span>
      enum { _fast_path = 1, _slow_path, _null_path, PATH_LIMIT2 };
      Node* region2 = new RegionNode(PATH_LIMIT2);
      Node* phi2 = PhiNode::make(region2, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
  
      // Stable path.
<span class="udiff-line-modified-removed">-     test_heap_state(ctrl, raw_mem, heap_stable_ctrl, phase, ShenandoahHeap::MARKING);</span>
<span class="udiff-line-modified-added">+     test_gc_state(ctrl, raw_mem, heap_stable_ctrl, phase, ShenandoahHeap::MARKING);</span>
      region-&gt;init_req(_heap_stable, heap_stable_ctrl);
      phi-&gt;init_req(_heap_stable, raw_mem);
  
      // Null path
      Node* reg2_ctrl = NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1785,11 +1799,11 @@</span>
        return phase-&gt;igvn().zerocon(T_OBJECT);
    }
  
  }
  
<span class="udiff-line-modified-removed">- void ShenandoahBarrierC2Support::move_heap_stable_test_out_of_loop(IfNode* iff, PhaseIdealLoop* phase) {</span>
<span class="udiff-line-modified-added">+ void ShenandoahBarrierC2Support::move_gc_state_test_out_of_loop(IfNode* iff, PhaseIdealLoop* phase) {</span>
    IdealLoopTree *loop = phase-&gt;get_loop(iff);
    Node* loop_head = loop-&gt;_head;
    Node* entry_c = loop_head-&gt;in(LoopNode::EntryControl);
  
    Node* bol = iff-&gt;in(1);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1979,11 +1993,11 @@</span>
            if (iff != NULL) {
              Node* bol = iff-&gt;in(1);
              if (head-&gt;as_Loop()-&gt;is_strip_mined()) {
                head-&gt;as_Loop()-&gt;verify_strip_mined(0);
              }
<span class="udiff-line-modified-removed">-             move_heap_stable_test_out_of_loop(iff, phase);</span>
<span class="udiff-line-modified-added">+             move_gc_state_test_out_of_loop(iff, phase);</span>
  
              AutoNodeBudget node_budget(phase);
  
              if (loop-&gt;policy_unswitching(phase)) {
                if (head-&gt;as_Loop()-&gt;is_strip_mined()) {
</pre>
<center><a href="shenandoahBarrierSetC2.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../jvmci/jvmciCodeInstaller.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>